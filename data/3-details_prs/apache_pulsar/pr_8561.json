{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNDc3MDU4", "number": 8561, "title": "[broker] Close topics that remain fenced forcefully", "bodyText": "Motivation\nThe other day, we faced a problem where a topic remained fenced and unavailable. This topic remained unavailable until it was unloaded. The following is the broker log at that time.\n11:37:55.905 [bookkeeper-ml-workers-OrderedExecutor-77-0] INFO  o.a.b.mledger.impl.OpAddEntry        - [tenant/ns/persistent/topic] Closing ledger 40891546 for being full\n11:37:56.208 [pulsar-ordered-OrderedExecutor-0-0-EventThread] ERROR o.a.b.client.MetadataUpdateLoop      - UpdateLoop(ledgerId=40891546,loopId=6ce63876) Error writing metadata to store\n11:37:56.209 [pulsar-ordered-OrderedExecutor-0-0-EventThread] WARN  o.a.b.mledger.impl.OpAddEntry        - Error when closing ledger 40891546. Status=Error while using ZooKeeper\n11:37:56.359 [pulsar-ordered-OrderedExecutor-0-0-EventThread] ERROR o.a.b.mledger.impl.ManagedLedgerImpl - [tenant/ns/persistent/topic] Error creating ledger rc=-9 Error while using ZooKeeper\n11:37:56.359 [pulsar-ordered-OrderedExecutor-0-0-EventThread] INFO  o.a.pulsar.broker.service.Producer   - Disconnecting producer: Producer{topic=PersistentTopic{topic=persistent://tenant/ns/topic}, client=/xxx.xxx.xxx.xxx:40646, producerName=pulsar.repl.jp-west, producerId=668}\n11:37:56.360 [pulsar-ordered-OrderedExecutor-0-0-EventThread] WARN  o.a.p.b.s.persistent.PersistentTopic - [persistent://tenant/ns/topic] Failed to persist msg in store: Error while using ZooKeeper\n11:37:56.360 [pulsar-ordered-OrderedExecutor-0-0-EventThread] INFO  o.a.pulsar.broker.service.Producer   - Disconnecting producer: Producer{topic=PersistentTopic{topic=persistent://tenant/ns/topic}, client=/xxx.xxx.xxx.xxx:40646, producerName=pulsar.repl.jp-west, producerId=668}\n11:37:56.360 [pulsar-ordered-OrderedExecutor-0-0-EventThread] WARN  o.a.p.b.s.persistent.PersistentTopic - [persistent://tenant/ns/topic] Failed to persist msg in store: Error while using ZooKeeper\n11:37:56.360 [pulsar-ordered-OrderedExecutor-0-0-EventThread] INFO  o.a.pulsar.broker.service.Producer   - Disconnecting producer: Producer{topic=PersistentTopic{topic=persistent://tenant/ns/topic}, client=/xxx.xxx.xxx.xxx:40646, producerName=pulsar.repl.jp-west, producerId=668}\n11:37:56.360 [pulsar-ordered-OrderedExecutor-0-0-EventThread] WARN  o.a.p.b.s.persistent.PersistentTopic - [persistent://tenant/ns/topic] Failed to persist msg in store: Error while using ZooKeeper\n11:37:56.360 [pulsar-ordered-OrderedExecutor-0-0-EventThread] WARN  o.a.p.b.s.persistent.PersistentTopic - [persistent://tenant/ns/topic] Failed to persist msg in store: Error while using ZooKeeper\n11:37:56.360 [pulsar-ordered-OrderedExecutor-0-0-EventThread] WARN  o.a.p.b.s.persistent.PersistentTopic - [persistent://tenant/ns/topic] Failed to persist msg in store: Error while using ZooKeeper\n11:37:56.360 [pulsar-ordered-OrderedExecutor-0-0-EventThread] WARN  o.a.p.b.s.persistent.PersistentTopic - [persistent://tenant/ns/topic] Failed to persist msg in store: Error while using ZooKeeper\n11:37:57.495 [ForkJoinPool.commonPool-worker-51] INFO  o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40256][persistent://tenant/ns/topic] Creating producer. producerId=668\n11:37:58.291 [bookkeeper-ml-workers-OrderedExecutor-77-0] INFO  o.a.b.mledger.impl.ManagedLedgerImpl - [tenant/ns/persistent/topic] End TrimConsumedLedgers. ledgers=2 totalSize=162868668\n11:37:58.291 [bookkeeper-ml-workers-OrderedExecutor-77-0] INFO  o.a.b.mledger.impl.ManagedLedgerImpl - [tenant/ns/persistent/topic] Removing ledger 40880508 - size: 82183409\n11:37:58.292 [ForkJoinPool.commonPool-worker-20] INFO  o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40256]-668 persistent://tenant/ns/topic configured with schema false\n11:37:58.292 [ForkJoinPool.commonPool-worker-20] WARN  o.a.p.b.s.persistent.PersistentTopic - [persistent://tenant/ns/topic] Attempting to add producer to a fenced topic\n11:37:58.292 [ForkJoinPool.commonPool-worker-20] ERROR o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40256] Failed to add producer to topic persistent://tenant/ns/topic: Topic is temporarily unavailable\n11:37:58.728 [ForkJoinPool.commonPool-worker-75] INFO  o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40330][persistent://tenant/ns/topic] Creating producer. producerId=668\n11:37:58.729 [ForkJoinPool.commonPool-worker-75] INFO  o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40330]-668 persistent://tenant/ns/topic configured with schema false\n11:37:58.729 [ForkJoinPool.commonPool-worker-75] WARN  o.a.p.b.s.persistent.PersistentTopic - [persistent://tenant/ns/topic] Attempting to add producer to a fenced topic\n11:37:58.729 [ForkJoinPool.commonPool-worker-75] ERROR o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40330] Failed to add producer to topic persistent://tenant/ns/topic: Topic is temporarily unavailable\n11:37:59.489 [ForkJoinPool.commonPool-worker-106] INFO  o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40260][persistent://tenant/ns/topic] Creating producer. producerId=668\n11:37:59.489 [ForkJoinPool.commonPool-worker-106] INFO  o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40260]-668 persistent://tenant/ns/topic configured with schema false\n11:37:59.489 [ForkJoinPool.commonPool-worker-106] WARN  o.a.p.b.s.persistent.PersistentTopic - [persistent://tenant/ns/topic] Attempting to add producer to a fenced topic\n11:37:59.489 [ForkJoinPool.commonPool-worker-106] ERROR o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40260] Failed to add producer to topic persistent://tenant/ns/topic: Topic is temporarily unavailable\n11:38:01.062 [ForkJoinPool.commonPool-worker-51] INFO  o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40248][persistent://tenant/ns/topic] Creating producer. producerId=668\n11:38:01.062 [ForkJoinPool.commonPool-worker-51] INFO  o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40248]-668 persistent://tenant/ns/topic configured with schema false\n11:38:01.063 [ForkJoinPool.commonPool-worker-51] WARN  o.a.p.b.s.persistent.PersistentTopic - [persistent://tenant/ns/topic] Attempting to add producer to a fenced topic\n11:38:01.063 [ForkJoinPool.commonPool-worker-51] ERROR o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40248] Failed to add producer to topic persistent://tenant/ns/topic: Topic is temporarily unavailable\n11:38:04.103 [ForkJoinPool.commonPool-worker-90] INFO  o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40338][persistent://tenant/ns/topic] Creating producer. producerId=668\n11:38:04.104 [ForkJoinPool.commonPool-worker-102] INFO  o.a.pulsar.broker.service.ServerCnx  - [/xxx.xxx.xxx.xxx:40338]-668 persistent://tenant/ns/topic configured with schema false\n\nWe were maintaining the ZooKeeper servers, so I think this phenomenon was caused by the shutdown of some ZK servers. However, the causal relationship has not been clarified.\nModifications\nAs a workaround, close the topic if it remains fenced for a period of time. Reconnecting from the clients will instantiate a new PersistentTopic topic and the topic will back to normal.", "createdAt": "2020-11-13T09:57:37Z", "url": "https://github.com/apache/pulsar/pull/8561", "merged": true, "mergeCommit": {"oid": "0df5f6f111a9d435deabdba78f48a49e23078f6a"}, "closed": true, "closedAt": "2020-11-18T00:59:50Z", "author": {"login": "massakam"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcIVCYAFqTUzMDEyMTczOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddjAcWAFqTUzMjkyMjQzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMTIxNzM4", "url": "https://github.com/apache/pulsar/pull/8561#pullrequestreview-530121738", "createdAt": "2020-11-13T14:47:24Z", "commit": {"oid": "a7a1c4616e6f27ac9fb6950088da0d9f55ebdeed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDo0NzoyNFrOHyxKlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDo0NzoyNFrOHyxKlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk5NjM3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # If it is 0 or less, the fenced topic will not be closed.\n          \n          \n            \n            # If it is set to 0 or a negative number, the fenced topic will not be closed.", "url": "https://github.com/apache/pulsar/pull/8561#discussion_r522996374", "createdAt": "2020-11-13T14:47:24Z", "author": {"login": "Huanli-Meng"}, "path": "conf/broker.conf", "diffHunk": "@@ -452,6 +452,10 @@ systemTopicEnabled=false\n # Please enable the system topic first.\n topicLevelPoliciesEnabled=false\n \n+# If a topic remains fenced for this number of seconds, it will be closed forcefully.\n+# If it is 0 or less, the fenced topic will not be closed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7a1c4616e6f27ac9fb6950088da0d9f55ebdeed"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMjQyMjg0", "url": "https://github.com/apache/pulsar/pull/8561#pullrequestreview-531242284", "createdAt": "2020-11-16T11:38:31Z", "commit": {"oid": "ef5b71067709c4ee49da31809fb0c05ce4dfaad9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTg0MjEz", "url": "https://github.com/apache/pulsar/pull/8561#pullrequestreview-531584213", "createdAt": "2020-11-16T18:16:40Z", "commit": {"oid": "ef5b71067709c4ee49da31809fb0c05ce4dfaad9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODoxNjo0MVrOH0LfrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODoxNjo0MVrOH0LfrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3NjMzMw==", "bodyText": "Do we need to put close in the synchronized block?", "url": "https://github.com/apache/pulsar/pull/8561#discussion_r524476333", "createdAt": "2020-11-16T18:16:41Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -2384,6 +2387,40 @@ public boolean isSystemTopic() {\n         return false;\n     }\n \n+    private synchronized void fence() {\n+        isFenced = true;\n+        ScheduledFuture<?> monitoringTask = this.fencedTopicMonitoringTask;\n+        if (monitoringTask == null || monitoringTask.isDone()) {\n+            final int timeout = brokerService.pulsar().getConfiguration().getTopicFencingTimeoutSeconds();\n+            if (timeout > 0) {\n+                this.fencedTopicMonitoringTask = brokerService.executor().schedule(this::closeFencedTopicForcefully,\n+                        timeout, TimeUnit.SECONDS);\n+            }\n+        }\n+    }\n+\n+    private synchronized void unfence() {\n+        isFenced = false;\n+        ScheduledFuture<?> monitoringTask = this.fencedTopicMonitoringTask;\n+        if (monitoringTask != null && !monitoringTask.isDone()) {\n+            monitoringTask.cancel(false);\n+        }\n+    }\n+\n+    private synchronized void closeFencedTopicForcefully() {\n+        if (isFenced) {\n+            final int timeout = brokerService.pulsar().getConfiguration().getTopicFencingTimeoutSeconds();\n+            if (isClosingOrDeleting) {\n+                log.warn(\"[{}] Topic remained fenced for {} seconds and is already closed (pendingWriteOps: {})\", topic,\n+                        timeout, pendingWriteOps.get());\n+            } else {\n+                log.error(\"[{}] Topic remained fenced for {} seconds, so close it (pendingWriteOps: {})\", topic,\n+                        timeout, pendingWriteOps.get());\n+                close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef5b71067709c4ee49da31809fb0c05ce4dfaad9"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2255cffc331f49cb13081b8ba82464aa0f0e20b4", "author": {"user": {"login": "massakam", "name": "Masahiro Sakamoto"}}, "url": "https://github.com/apache/pulsar/commit/2255cffc331f49cb13081b8ba82464aa0f0e20b4", "committedDate": "2020-11-17T02:12:21Z", "message": "Close topics that remain fenced forcefully"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c495685d1028c01bf79cf11ae90e1aef687533b", "author": {"user": {"login": "massakam", "name": "Masahiro Sakamoto"}}, "url": "https://github.com/apache/pulsar/commit/5c495685d1028c01bf79cf11ae90e1aef687533b", "committedDate": "2020-11-17T02:12:21Z", "message": "Fix comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2032c994af7ff9d84256c0605a85d42b2ad7c706", "author": {"user": {"login": "massakam", "name": "Masahiro Sakamoto"}}, "url": "https://github.com/apache/pulsar/commit/2032c994af7ff9d84256c0605a85d42b2ad7c706", "committedDate": "2020-11-17T02:33:12Z", "message": "Remove synchronized from closeFencedTopicForcefully method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef5b71067709c4ee49da31809fb0c05ce4dfaad9", "author": {"user": {"login": "massakam", "name": "Masahiro Sakamoto"}}, "url": "https://github.com/apache/pulsar/commit/ef5b71067709c4ee49da31809fb0c05ce4dfaad9", "committedDate": "2020-11-13T15:24:17Z", "message": "Fix comments"}, "afterCommit": {"oid": "2032c994af7ff9d84256c0605a85d42b2ad7c706", "author": {"user": {"login": "massakam", "name": "Masahiro Sakamoto"}}, "url": "https://github.com/apache/pulsar/commit/2032c994af7ff9d84256c0605a85d42b2ad7c706", "committedDate": "2020-11-17T02:33:12Z", "message": "Remove synchronized from closeFencedTopicForcefully method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTIyNDM0", "url": "https://github.com/apache/pulsar/pull/8561#pullrequestreview-532922434", "createdAt": "2020-11-18T00:28:12Z", "commit": {"oid": "2032c994af7ff9d84256c0605a85d42b2ad7c706"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1059, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}