{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NjUzNDA0", "number": 8686, "title": "Support HAProxy proxy protocol for broker and proxy", "bodyText": "Motivation\nCurrently, if enable the proxy in the pulsar cluster and client connect to the cluster through the proxy, when we get topic stats, the consumer address and producer address are not the real client address. This PR fix this problem by leverage HAProxy proxy protocol since this is a more general approach.  more details about the proxy protocol see\nhttps://www.haproxy.com/blog/haproxy/proxy-protocol/\nhttps://docs.aws.amazon.com/elasticloadbalancing/latest/classic/enable-proxy-protocol.html\nhttp://www.haproxy.org/download/1.8/doc/proxy-protocol.txt\nModifications\nAllow enable proxy protocol on proxy or broker.\nVerifying this change\nTests added\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (no)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes)", "createdAt": "2020-11-24T17:45:13Z", "url": "https://github.com/apache/pulsar/pull/8686", "merged": true, "mergeCommit": {"oid": "625627c8cc2915974a55c5fa7ae02fe33dd2e4c8"}, "closed": true, "closedAt": "2020-11-30T03:26:38Z", "author": {"login": "codelipenghui"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdftXUQgH2gAyNTI2NjUzNDA0OjFhNDdiM2NhNTM1YjRjYzQxZWQ2Zjk3ZTk4ZmQwZmJjNGY1OWQ4ZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgL1PLgFqTUzODk5Nzg3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a47b3ca535b4cc41ed6f97e98fd0fbc4f59d8fb", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/1a47b3ca535b4cc41ed6f97e98fd0fbc4f59d8fb", "committedDate": "2020-11-24T17:40:05Z", "message": "Support HAProxy proxy protocol."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3Nzc0OTQw", "url": "https://github.com/apache/pulsar/pull/8686#pullrequestreview-537774940", "createdAt": "2020-11-24T18:02:38Z", "commit": {"oid": "1a47b3ca535b4cc41ed6f97e98fd0fbc4f59d8fb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODowMjozOFrOH5O53w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODowMjozOFrOH5O53w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc3NTA3MQ==", "bodyText": "remove this?", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r529775071", "createdAt": "2020-11-24T18:02:38Z", "author": {"login": "sijie"}, "path": "pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/ProxyConnection.java", "diffHunk": "@@ -169,6 +171,11 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws E\n \n     @Override\n     public void channelRead(final ChannelHandlerContext ctx, Object msg) throws Exception {\n+        System.out.println(haProxyMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a47b3ca535b4cc41ed6f97e98fd0fbc4f59d8fb"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89532cd2735ead88f180d60c80c47369d9065719", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/89532cd2735ead88f180d60c80c47369d9065719", "committedDate": "2020-11-25T00:48:47Z", "message": "Fix comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDk4NjU3", "url": "https://github.com/apache/pulsar/pull/8686#pullrequestreview-538098657", "createdAt": "2020-11-25T01:51:32Z", "commit": {"oid": "89532cd2735ead88f180d60c80c47369d9065719"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMTo1MTozMlrOH5gEsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMTo1MTozMlrOH5gEsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA1NjM2OQ==", "bodyText": "This naming can be confusing since we already have a \"proxy\" for Pulsar protocol", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530056369", "createdAt": "2020-11-25T01:51:32Z", "author": {"login": "merlimat"}, "path": "conf/broker.conf", "diffHunk": "@@ -55,6 +55,9 @@ advertisedAddress=\n # The Default value is absent, the broker uses the first listener as the internal listener.\n # internalListenerName=\n \n+# Enable or disable the proxy protocol.\n+proxyProtocolEnabled=false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89532cd2735ead88f180d60c80c47369d9065719"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "836beed879856b27be88d3a1059ab9e6c5e2c44d", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/836beed879856b27be88d3a1059ab9e6c5e2c44d", "committedDate": "2020-11-25T02:01:56Z", "message": "Fix license check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dfdfe0bd99ef521744fe535e284729eae65aaf0", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/0dfdfe0bd99ef521744fe535e284729eae65aaf0", "committedDate": "2020-11-25T07:16:27Z", "message": "Change configuration param name."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjY1NDA4", "url": "https://github.com/apache/pulsar/pull/8686#pullrequestreview-538265408", "createdAt": "2020-11-25T08:43:35Z", "commit": {"oid": "0dfdfe0bd99ef521744fe535e284729eae65aaf0"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwODo0MzozNVrOH5ojnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTowNjoxM1rOH5pcBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5NTM1Ng==", "bodyText": "Actually maximum record size is 107 by spec:\n\n\nworst case (optional fields set to 0xff) :```\n\"PROXY UNKNOWN ffff:f...f:ffff ffff:f...f:ffff 65535 65535\\r\\n\"\n=> 5 + 1 + 7 + 1 + 39 + 1 + 39 + 1 + 5 + 1 + 5 + 2 = 107 chars\n\n\n[...]\nThe receiver must wait for the CRLF sequence before starting to decode the\naddresses in order to ensure they are complete and properly parsed. If the CRLF\nsequence is not found in the first 107 characters, the receiver should declare\nthe line invalid.", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530195356", "createdAt": "2020-11-25T08:43:35Z", "author": {"login": "diegosalvi"}, "path": "pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/DirectProxyHandler.java", "diffHunk": "@@ -143,10 +150,56 @@ protected void initChannel(SocketChannel ch) throws Exception {\n                 inboundOutboundChannelMap.put(outboundChannel.id() , inboundChannel.id());\n             }\n \n-\n+            if (config.isHaProxyProtocolEnabled()) {\n+                if (proxyConnection.hasHAProxyMessage()) {\n+                    outboundChannel.writeAndFlush(encodeProxyProtocolMessage(proxyConnection.getHAProxyMessage()));\n+                } else {\n+                    if (inboundChannel.remoteAddress() instanceof InetSocketAddress) {\n+                        InetSocketAddress clientAddress = (InetSocketAddress) inboundChannel.remoteAddress();\n+                        String sourceAddress = clientAddress.getAddress().getHostAddress();\n+                        int sourcePort = clientAddress.getPort();\n+                        if (outboundChannel.localAddress() instanceof InetSocketAddress) {\n+                            InetSocketAddress proxyAddress = (InetSocketAddress) inboundChannel.remoteAddress();\n+                            String destinationAddress = proxyAddress.getAddress().getHostAddress();\n+                            int destinationPort = proxyAddress.getPort();\n+                            HAProxyMessage msg = new HAProxyMessage(HAProxyProtocolVersion.V1, HAProxyCommand.PROXY,\n+                                    HAProxyProxiedProtocol.TCP4, sourceAddress, destinationAddress, sourcePort, destinationPort);\n+                            outboundChannel.writeAndFlush(encodeProxyProtocolMessage(msg));\n+                            msg.release();\n+                        }\n+                    }\n+                }\n+            }\n         });\n     }\n \n+    private ByteBuf encodeProxyProtocolMessage(HAProxyMessage msg) {\n+        // Max length of v1 version proxy protocol message is 108\n+        ByteBuf out = Unpooled.buffer(108);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dfdfe0bd99ef521744fe535e284729eae65aaf0"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE5ODMzMQ==", "bodyText": "I think we should have the possibilitiy to require proxy headers instead of handle them as optional.\nSpecification itself states:\nThe receiver MUST be configured to only receive the protocol described in this\nspecification and MUST not try to guess whether the protocol header is present\nor not. This means that the protocol explicitly prevents port sharing between\npublic and private access.", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530198331", "createdAt": "2020-11-25T08:48:29Z", "author": {"login": "diegosalvi"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/PulsarChannelInitializer.java", "diffHunk": "@@ -118,6 +119,9 @@ protected void initChannel(SocketChannel ch) throws Exception {\n             ch.pipeline().addLast(\"ByteBufPairEncoder\", ByteBufPair.ENCODER);\n         }\n \n+        if (pulsar.getConfiguration().isHaProxyProtocolEnabled()) {\n+            ch.pipeline().addLast(OptionalProxyProtocolDecoder.NAME, new OptionalProxyProtocolDecoder());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dfdfe0bd99ef521744fe535e284729eae65aaf0"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwOTc5OA==", "bodyText": "netty-haproxy can decode binary v2 version too (but doesn't implements encoding).\nWe could add another encoding method for v2 protocol and let the configurer choose which use.\nFor the encoding implementation I've done one for subethamail if you want take a peek. It has been done for testing purposes (so it permits some strange behaviour to check various edge cases and \"wrong\" headers and can surely be simplified): https://github.com/davidmoten/subethasmtp/blob/master/src/test/java/org/subethamail/smtp/internal/proxy/ProxyProtocolV2HandlerTest.java", "url": "https://github.com/apache/pulsar/pull/8686#discussion_r530209798", "createdAt": "2020-11-25T09:06:13Z", "author": {"login": "diegosalvi"}, "path": "pulsar-proxy/src/main/java/org/apache/pulsar/proxy/server/DirectProxyHandler.java", "diffHunk": "@@ -143,10 +150,56 @@ protected void initChannel(SocketChannel ch) throws Exception {\n                 inboundOutboundChannelMap.put(outboundChannel.id() , inboundChannel.id());\n             }\n \n-\n+            if (config.isHaProxyProtocolEnabled()) {\n+                if (proxyConnection.hasHAProxyMessage()) {\n+                    outboundChannel.writeAndFlush(encodeProxyProtocolMessage(proxyConnection.getHAProxyMessage()));\n+                } else {\n+                    if (inboundChannel.remoteAddress() instanceof InetSocketAddress) {\n+                        InetSocketAddress clientAddress = (InetSocketAddress) inboundChannel.remoteAddress();\n+                        String sourceAddress = clientAddress.getAddress().getHostAddress();\n+                        int sourcePort = clientAddress.getPort();\n+                        if (outboundChannel.localAddress() instanceof InetSocketAddress) {\n+                            InetSocketAddress proxyAddress = (InetSocketAddress) inboundChannel.remoteAddress();\n+                            String destinationAddress = proxyAddress.getAddress().getHostAddress();\n+                            int destinationPort = proxyAddress.getPort();\n+                            HAProxyMessage msg = new HAProxyMessage(HAProxyProtocolVersion.V1, HAProxyCommand.PROXY,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dfdfe0bd99ef521744fe535e284729eae65aaf0"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4OTk3ODc0", "url": "https://github.com/apache/pulsar/pull/8686#pullrequestreview-538997874", "createdAt": "2020-11-26T05:09:55Z", "commit": {"oid": "0dfdfe0bd99ef521744fe535e284729eae65aaf0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 969, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}