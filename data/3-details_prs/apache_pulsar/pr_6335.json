{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1ODcxNTQ0", "number": 6335, "title": "Refactored JCloud Tiered Storage", "bodyText": "Motivation\nIn order to facilitate the support of additional JClouds-supported providers, we first needed to clean up the existing code, as there were a lot of if/then/else constructs throughout the code that were based on the assumption that we either supported AWS S3 or Google Cloud Storage. I didn't want to keep adding else if's to these code blocks for every new provider we add, so I decided to refactor the code to make it a bit cleaner\nModifications\nin addition to being home for most of the aforementioned if/then/else blocks, the BlobStoreManagedLedgerOffloader class had multiple responsibilities in addition to providing an implementation for the LedgerOffloader interface. My goal was to simplify this class such that its only responsibility was to implement the LedgerOffloader interface.\nThe other major change was the addition of the JCloudBlobStoreProvider enum, which implements 3 interfaces that allow for it to handle the provider specific logic for things such as acquiring the credentials, validating the configuration, and creating a provider-specific instance of BlobStore.\nResult\nAfter this change, we will be able to easily add support for additional JClouds-supported providers by simply adding new elements to the JCloudBlobStoreProvider Enums since the other logic has been isolated and is not vendor specific.\nSee #2865 for more details", "createdAt": "2020-02-16T20:55:11Z", "url": "https://github.com/apache/pulsar/pull/6335", "merged": true, "mergeCommit": {"oid": "d3a5233b2a0d469d7d2e676a3e23258e50ea1685"}, "closed": true, "closedAt": "2020-10-19T01:56:25Z", "author": {"login": "david-streamlio"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcE_G3jAH2gAyMzc1ODcxNTQ0OmY1NTdmMjdhM2JjMWI1NDlmYzgyNWJmYjBmZmI0ZGNjYTI0MWIzZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdT6Q7lgFqTUxMTM2NzM4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f557f27a3bc1b549fc825bfb0ffb4dcca241b3d3", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/f557f27a3bc1b549fc825bfb0ffb4dcca241b3d3", "committedDate": "2020-02-16T20:53:18Z", "message": "Refactored JCloud Tiered Storage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODQzMzM3", "url": "https://github.com/apache/pulsar/pull/6335#pullrequestreview-391843337", "createdAt": "2020-04-12T10:32:53Z", "commit": {"oid": "f557f27a3bc1b549fc825bfb0ffb4dcca241b3d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxMDozMjo1M1rOGEUOvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxMDozMjo1M1rOGEUOvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3ODk0MQ==", "bodyText": "Currently, the Pulsar support independent offload policy for each namespace, the userMetadata param contains the global offload configs and the offloadPolicies param contains the Namespace level offload configs. If the namespace has its own offload policy, we should use the independent offload policy, otherwise, we should use the global offload policy.\nThe OffloadPolicies has independent config for S3 and GCS, such as s3ManagedLedgerOffloadRegion and gcsManagedLedgerOffloadRegion, follow your way, we could combine them as the region.", "url": "https://github.com/apache/pulsar/pull/6335#discussion_r407178941", "createdAt": "2020-04-12T10:32:53Z", "author": {"login": "gaoran10"}, "path": "tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/JCloudLedgerOffloaderFactory.java", "diffHunk": "@@ -38,13 +40,14 @@ public static JCloudLedgerOffloaderFactory of() {\n \n     @Override\n     public boolean isDriverSupported(String driverName) {\n-        return BlobStoreManagedLedgerOffloader.driverSupported(driverName);\n+        return JCloudBlobStoreProvider.driverSupported(driverName);\n     }\n \n     @Override\n-    public BlobStoreManagedLedgerOffloader create(OffloadPolicies offloadPolicies,\n-                                                  Map<String, String> userMetadata,\n-                                                  OrderedScheduler scheduler) throws IOException  {\n-        return BlobStoreManagedLedgerOffloader.create(offloadPolicies, userMetadata, scheduler);\n+    public BlobStoreManagedLedgerOffloader create(OffloadPolicies offloadPolicies, Map<String, String> userMetadata,\n+            OrderedScheduler scheduler) throws IOException {\n+        \n+        TieredStorageConfiguration config = TieredStorageConfiguration.create(userMetadata);\n+        return BlobStoreManagedLedgerOffloader.create(config, userMetadata, scheduler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f557f27a3bc1b549fc825bfb0ffb4dcca241b3d3"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODQ0MDQy", "url": "https://github.com/apache/pulsar/pull/6335#pullrequestreview-391844042", "createdAt": "2020-04-12T10:42:46Z", "commit": {"oid": "f557f27a3bc1b549fc825bfb0ffb4dcca241b3d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxMDo0Mjo0N1rOGEUStA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxMDo0Mjo0N1rOGEUStA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3OTk1Ng==", "bodyText": "Currently, when the LedgerOffloader is generated by the PulsarService, the PulsarService will check the namespace's OffloadPolicies, if the new OffloadPolicies is same as the existing OffloadPolicies, the PulsarService will reuse the existing LedgerOffloader, so we should provide the OffloadPolicies of the LedgerOffloader.", "url": "https://github.com/apache/pulsar/pull/6335#discussion_r407179956", "createdAt": "2020-04-12T10:42:47Z", "author": {"login": "gaoran10"}, "path": "tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/impl/BlobStoreManagedLedgerOffloader.java", "diffHunk": "@@ -589,26 +299,17 @@ BlobStore getReadBlobStore(Map<String, String> offloadDriverMetadata) {\n         return promise;\n     }\n \n-    public interface VersionCheck {\n-        void check(String key, Blob blob) throws IOException;\n-    }\n-\n+    \n     @Override\n     public OffloadPolicies getOffloadPolicies() {\n-        return offloadPolicies;\n+        // TODO Auto-generated method stub\n+        return null;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f557f27a3bc1b549fc825bfb0ffb4dcca241b3d3"}, "originalPosition": 631}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe10712f08a42832224a5f59476a086c7b39a63e", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/fe10712f08a42832224a5f59476a086c7b39a63e", "committedDate": "2020-09-21T16:03:38Z", "message": "Refactored JCloud Tiered Storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "119e348709adb9023e6e2c8f1e2249c5b92539f8", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/119e348709adb9023e6e2c8f1e2249c5b92539f8", "committedDate": "2020-09-21T16:04:31Z", "message": "Rebased"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11f4c7039321abdc001a1ee585716da83e8ff52b", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/11f4c7039321abdc001a1ee585716da83e8ff52b", "committedDate": "2020-09-21T16:47:39Z", "message": "Added missing import statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dec6557b8a07a9fa628dd99aeb0b0b3b3d2c675", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/3dec6557b8a07a9fa628dd99aeb0b0b3b3d2c675", "committedDate": "2020-09-23T03:28:00Z", "message": "Merge branch 'master' into jcloud-take2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42fe9ce1ddbf75daeb068daa2144f1aedf6857b1", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/42fe9ce1ddbf75daeb068daa2144f1aedf6857b1", "committedDate": "2020-10-03T16:25:17Z", "message": "Refactored JCloud Tiered Storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f325c5e979e19d91d6f7c74db7820379a4568d7", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/2f325c5e979e19d91d6f7c74db7820379a4568d7", "committedDate": "2020-10-03T16:27:24Z", "message": "Refactored JCloud Tiered Storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2058624376e77a65db36f1486de4a9020f936a7b", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/2058624376e77a65db36f1486de4a9020f936a7b", "committedDate": "2020-10-03T16:27:24Z", "message": "Added missing import statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "624e82dea34bccbe22b59f31615e246284142e34", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/624e82dea34bccbe22b59f31615e246284142e34", "committedDate": "2020-10-03T16:29:22Z", "message": "Fixed merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0091374d4172ff1c52d99e99a31efab1819e2627", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/0091374d4172ff1c52d99e99a31efab1819e2627", "committedDate": "2020-10-11T16:45:23Z", "message": "Refactored JCloud Tiered Storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "599eeca864ce421339f394da8c54699be47e1440", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/599eeca864ce421339f394da8c54699be47e1440", "committedDate": "2020-10-11T16:45:23Z", "message": "Refactored JCloud Tiered Storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77ddd425aaf2389c23ab3a18e4bbdd4fc9e48df5", "author": {"user": {"login": "david-streamlio", "name": "David Kjerrumgaard"}}, "url": "https://github.com/apache/pulsar/commit/77ddd425aaf2389c23ab3a18e4bbdd4fc9e48df5", "committedDate": "2020-10-11T16:45:23Z", "message": "Added missing import statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3e2e4cc26709b271064172c7e2be26c323810c8", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/a3e2e4cc26709b271064172c7e2be26c323810c8", "committedDate": "2020-10-11T16:45:23Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7611e0c9cbe1f55dddaa251a8ce8a6be7edb161", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/f7611e0c9cbe1f55dddaa251a8ce8a6be7edb161", "committedDate": "2020-10-11T16:45:23Z", "message": "add test logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92537b2f3d62b04eacf328acc9c63beaa9366cfb", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/92537b2f3d62b04eacf328acc9c63beaa9366cfb", "committedDate": "2020-10-11T16:45:23Z", "message": "fix logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578ce220d1bb5300d1d653a36de97fb8411e95a5", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/578ce220d1bb5300d1d653a36de97fb8411e95a5", "committedDate": "2020-10-11T16:45:23Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b60d65ccba09f53d637505d789130c615a4e7171", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/b60d65ccba09f53d637505d789130c615a4e7171", "committedDate": "2020-10-11T16:45:23Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70f3d25da38904cf5307d0661a3719fd71518a3b", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/70f3d25da38904cf5307d0661a3719fd71518a3b", "committedDate": "2020-10-11T16:45:23Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6efaefc2bc69c2e49d3b4d1055d45d60fc94261", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/f6efaefc2bc69c2e49d3b4d1055d45d60fc94261", "committedDate": "2020-10-11T16:45:23Z", "message": "fix broker log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "453307cef6177af81d32cfee9dee53d296718610", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/453307cef6177af81d32cfee9dee53d296718610", "committedDate": "2020-10-11T16:45:23Z", "message": "fix configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53fb5a68b67ba80f6757c33a8b01a73391c82609", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/53fb5a68b67ba80f6757c33a8b01a73391c82609", "committedDate": "2020-10-11T16:45:23Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4e07c0c23c81db1cdd244b5aa318705ccf5e416", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/b4e07c0c23c81db1cdd244b5aa318705ccf5e416", "committedDate": "2020-10-11T16:45:23Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c38acac7ab77afc3d049758e8c6aeb3cbf094949", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/c38acac7ab77afc3d049758e8c6aeb3cbf094949", "committedDate": "2020-10-11T16:45:23Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "654b96ea5173e466298e607414539fcee22b7825", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/654b96ea5173e466298e607414539fcee22b7825", "committedDate": "2020-10-11T16:45:23Z", "message": "fix get BlobStore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0de001c99e8b0ec7f828e07eed181f39fd82d66b", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/0de001c99e8b0ec7f828e07eed181f39fd82d66b", "committedDate": "2020-10-11T16:48:05Z", "message": "repair test presto query tiered storage data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e28258a4b6904d4edb1f9b7f705a1c26cb488277", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/e28258a4b6904d4edb1f9b7f705a1c26cb488277", "committedDate": "2020-10-11T18:22:08Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f14ac6413f3927fb28f2ba5ebe70f5c5948842b0", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/f14ac6413f3927fb28f2ba5ebe70f5c5948842b0", "committedDate": "2020-10-12T01:09:03Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52857fa6a14c30e29a498f727ffa0c3bef345115", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/52857fa6a14c30e29a498f727ffa0c3bef345115", "committedDate": "2020-10-16T03:44:54Z", "message": "fix test TestPrestoQueryTieredStorage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0190678b843d5f4ed29be51aa3dea05e7c2d1c0", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/f0190678b843d5f4ed29be51aa3dea05e7c2d1c0", "committedDate": "2020-10-16T05:24:17Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41d44dab10448df6535d45350caae3f30b5041e9", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/41d44dab10448df6535d45350caae3f30b5041e9", "committedDate": "2020-10-16T05:28:25Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ca1d46bc8330cc2672357f8a040a046372392d7", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/2ca1d46bc8330cc2672357f8a040a046372392d7", "committedDate": "2020-10-18T05:58:13Z", "message": "merge gaoran branch to david jcloud-take2\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMzY3Mzgw", "url": "https://github.com/apache/pulsar/pull/6335#pullrequestreview-511367380", "createdAt": "2020-10-19T01:54:47Z", "commit": {"oid": "2ca1d46bc8330cc2672357f8a040a046372392d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 60, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}