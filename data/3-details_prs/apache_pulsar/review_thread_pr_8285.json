{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MjU4NDY1", "number": 8285, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozMDowOFrOEvjVmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNzo0NzoyM1rOEwHcVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4Mjk3NDk5OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozMDowOFrOHkmS2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozMDowOFrOHkmS2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzODIwMw==", "bodyText": "Avoid use import .* here.", "url": "https://github.com/apache/pulsar/pull/8285#discussion_r508138203", "createdAt": "2020-10-20T00:30:08Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -36,10 +36,7 @@\n import io.netty.handler.ssl.SslHandler;\n \n import java.net.SocketAddress;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.NoSuchElementException;\n-import java.util.Set;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f0cad6d01347c687ad81769749b3588444239a3"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4Mjk3NjEzOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/SubscriptionSeekTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozMDo0NVrOHkmThQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozMDo0NVrOHkmThQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzODM3Mw==", "bodyText": "Avoid use import .* here.", "url": "https://github.com/apache/pulsar/pull/8285#discussion_r508138373", "createdAt": "2020-10-20T00:30:45Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/SubscriptionSeekTest.java", "diffHunk": "@@ -25,20 +25,21 @@\n import static org.testng.Assert.fail;\n \n import com.google.common.collect.Lists;\n+\n import java.util.ArrayList;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n import java.util.concurrent.TimeUnit;\n \n import lombok.extern.slf4j.Slf4j;\n import org.apache.pulsar.broker.service.persistent.PersistentSubscription;\n import org.apache.pulsar.broker.service.persistent.PersistentTopic;\n import org.apache.pulsar.client.admin.PulsarAdminException;\n-import org.apache.pulsar.client.api.MessageId;\n+import org.apache.pulsar.client.api.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f0cad6d01347c687ad81769749b3588444239a3"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4Mjk4ODc2OnYy", "diffSide": "RIGHT", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/protocol/Commands.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozNzozN1rOHkmarg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozNzozN1rOHkmarg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MDIwNg==", "bodyText": "The batchIndex of the MessageIdData is an optional field, we shouldn't always use '0' here. It better to change the params type of the batchIndex to Integer. If the the batchIndex no a null value, set the value for the MessageIdBuilder", "url": "https://github.com/apache/pulsar/pull/8285#discussion_r508140206", "createdAt": "2020-10-20T00:37:37Z", "author": {"login": "codelipenghui"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/protocol/Commands.java", "diffHunk": "@@ -770,14 +770,15 @@ public static ByteBuf newActiveConsumerChange(long consumerId, boolean isActive)\n         return res;\n     }\n \n-    public static ByteBuf newSeek(long consumerId, long requestId, long ledgerId, long entryId) {\n+    public static ByteBuf newSeek(long consumerId, long requestId, long ledgerId, long entryId, int batchIndex) {\n         CommandSeek.Builder seekBuilder = CommandSeek.newBuilder();\n         seekBuilder.setConsumerId(consumerId);\n         seekBuilder.setRequestId(requestId);\n \n         MessageIdData.Builder messageIdBuilder = MessageIdData.newBuilder();\n         messageIdBuilder.setLedgerId(ledgerId);\n         messageIdBuilder.setEntryId(entryId);\n+        messageIdBuilder.setBatchIndex(batchIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f0cad6d01347c687ad81769749b3588444239a3"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4Mjk5Mjk2OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozOTo1MFrOHkmdNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozOTo1MFrOHkmdNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MDg1NA==", "bodyText": "It's better tot check msgIdData.hasBatchIndex() first, If the conditions are not met, we don't need to create the BitSet instance.", "url": "https://github.com/apache/pulsar/pull/8285#discussion_r508140854", "createdAt": "2020-10-20T00:39:50Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1349,8 +1347,14 @@ protected void handleSeek(CommandSeek seek) {\n             Consumer consumer = consumerFuture.getNow(null);\n             Subscription subscription = consumer.getSubscription();\n             MessageIdData msgIdData = seek.getMessageId();\n+            BitSetRecyclable ackSet = BitSetRecyclable.create();\n+            if (msgIdData.hasBatchIndex()) {\n+                ackSet.set(0, Math.max(msgIdData.getBatchIndex(), 0));\n+            }\n \n-            Position position = new PositionImpl(msgIdData.getLedgerId(), msgIdData.getEntryId());\n+            Position position = new PositionImpl(msgIdData.getLedgerId(),\n+                    msgIdData.getEntryId(), ackSet.toLongArray());\n+            ackSet.recycle();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f0cad6d01347c687ad81769749b3588444239a3"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NDkyNDU4OnYy", "diffSide": "RIGHT", "path": "pulsar-common/src/main/java/org/apache/pulsar/common/protocol/Commands.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMTo1NDoxOVrOHk4kdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMTo1NDoxOVrOHk4kdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQzNzYyMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (long l : ackSet) {\n          \n          \n            \n                        messageIdBuilder.addAckSet(l);\n          \n          \n            \n                    }\n          \n          \n            \n                 messageIdBuilder.addAllAckSet(SafeCollectionUtils.longArrayToList(ackSet);", "url": "https://github.com/apache/pulsar/pull/8285#discussion_r508437620", "createdAt": "2020-10-20T11:54:19Z", "author": {"login": "codelipenghui"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/protocol/Commands.java", "diffHunk": "@@ -760,24 +760,30 @@ public static ByteBuf newUnsubscribe(long consumerId, long requestId) {\n     public static ByteBuf newActiveConsumerChange(long consumerId, boolean isActive) {\n         CommandActiveConsumerChange.Builder changeBuilder = CommandActiveConsumerChange.newBuilder()\n             .setConsumerId(consumerId)\n-            .setIsActive(isActive);\n+                .setIsActive(isActive);\n \n         CommandActiveConsumerChange change = changeBuilder.build();\n         ByteBuf res = serializeWithSize(\n-            BaseCommand.newBuilder().setType(Type.ACTIVE_CONSUMER_CHANGE).setActiveConsumerChange(change));\n+                BaseCommand.newBuilder().setType(Type.ACTIVE_CONSUMER_CHANGE).setActiveConsumerChange(change));\n         changeBuilder.recycle();\n         change.recycle();\n         return res;\n     }\n \n-    public static ByteBuf newSeek(long consumerId, long requestId, long ledgerId, long entryId) {\n+    public static ByteBuf newSeek(long consumerId, long requestId,\n+                                  long ledgerId, long entryId, long[] ackSet) {\n         CommandSeek.Builder seekBuilder = CommandSeek.newBuilder();\n         seekBuilder.setConsumerId(consumerId);\n         seekBuilder.setRequestId(requestId);\n \n         MessageIdData.Builder messageIdBuilder = MessageIdData.newBuilder();\n         messageIdBuilder.setLedgerId(ledgerId);\n         messageIdBuilder.setEntryId(entryId);\n+\n+        for (long l : ackSet) {\n+            messageIdBuilder.addAckSet(l);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "200d3f98c932ee12f457469e9c24e97424134e39"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NDkzMTc3OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMTo1NjoyNVrOHk4pBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMTo1NjoyNVrOHk4pBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQzODc4OA==", "bodyText": "It's better to check the msgIdData.hasAckSetList() first rather than create a long[] first", "url": "https://github.com/apache/pulsar/pull/8285#discussion_r508438788", "createdAt": "2020-10-20T11:56:25Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1350,7 +1351,11 @@ protected void handleSeek(CommandSeek seek) {\n             Subscription subscription = consumer.getSubscription();\n             MessageIdData msgIdData = seek.getMessageId();\n \n-            Position position = new PositionImpl(msgIdData.getLedgerId(), msgIdData.getEntryId());\n+            long[] ackSet = msgIdData.getAckSetList().stream().mapToLong(x -> x).toArray();\n+            if (ackSet == null) ackSet = new long[0];\n+\n+            Position position = new PositionImpl(msgIdData.getLedgerId(),\n+                    msgIdData.getEntryId(), ackSet);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "200d3f98c932ee12f457469e9c24e97424134e39"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NDk0MjAyOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/SubscriptionSeekTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMTo1OToxOVrOHk4vRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMTo1OToxOVrOHk4vRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ0MDM5MA==", "bodyText": "The consumer uses a durable cursor no a non-durable cursor.", "url": "https://github.com/apache/pulsar/pull/8285#discussion_r508440390", "createdAt": "2020-10-20T11:59:19Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/SubscriptionSeekTest.java", "diffHunk": "@@ -116,6 +122,93 @@ public void testSeek() throws Exception {\n         assertEquals(sub.getNumberOfEntriesInBacklog(false), 0);\n     }\n \n+    @Test\n+    public void testSeekForBatch() throws Exception {\n+        final String topicName = \"persistent://prop/use/ns-abcd/testSeekForBatch\";\n+        String subscriptionName = \"my-subscription-batch\";\n+\n+        Producer<String> producer = pulsarClient.newProducer(Schema.STRING)\n+                .enableBatching(true)\n+                .batchingMaxMessages(3)\n+                .topic(topicName).create();\n+\n+\n+        List<MessageId> messageIds = new ArrayList<>();\n+        List<CompletableFuture<MessageId>> futureMessageIds = new ArrayList<>();\n+\n+        List<String> messages = new ArrayList<>();\n+        for (int i = 0; i < 10; i++) {\n+            String message = \"my-message-\" + i;\n+            messages.add(message);\n+            CompletableFuture<MessageId> messageIdCompletableFuture = producer.sendAsync(message);\n+            futureMessageIds.add(messageIdCompletableFuture);\n+        }\n+\n+        futureMessageIds.forEach(future -> {\n+            MessageId messageId = null;\n+            try {\n+                messageId = future.get();\n+                messageIds.add(messageId);\n+            } catch (InterruptedException | ExecutionException e) {\n+                e.printStackTrace();\n+            }\n+        });\n+        producer.flush();\n+        producer.close();\n+\n+\n+        org.apache.pulsar.client.api.Consumer<String> consumer = pulsarClient.newConsumer(Schema.STRING)\n+                .topic(topicName)\n+                .subscriptionName(subscriptionName)\n+                .subscribe();\n+\n+        PersistentTopic topicRef = (PersistentTopic) pulsar.getBrokerService().getTopicReference(topicName).get();\n+        assertNotNull(topicRef);\n+\n+        assertEquals(topicRef.getSubscriptions().size(), 1);\n+\n+        MessageId resetId = messageIds.get(4);\n+        consumer.seek(resetId);\n+        // Wait for consumer to reconnect\n+        Thread.sleep(500);\n+\n+        Message<String> nextMessage = consumer.receive();\n+        MessageId nextId = nextMessage.getMessageId();\n+        consumer.acknowledge(nextId);\n+        // For non-durable we are going to restart from the next entry", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "200d3f98c932ee12f457469e9c24e97424134e39"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4ODg3MTg0OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/SubscriptionSeekTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNzo0Mjo0MlrOHleaNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNzo0Mjo0MlrOHleaNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA1NzU4OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    futureMessageIds.forEach(future -> {\n          \n          \n            \n                        MessageId messageId = null;\n          \n          \n            \n                        try {\n          \n          \n            \n                            messageId = future.get();\n          \n          \n            \n                            messageIds.add(messageId);\n          \n          \n            \n                        } catch (InterruptedException | ExecutionException e) {\n          \n          \n            \n                            e.printStackTrace();\n          \n          \n            \n                        }\n          \n          \n            \n                    });\n          \n          \n            \n                    FutureUtil.waitForAll(futureMessageIds).get()", "url": "https://github.com/apache/pulsar/pull/8285#discussion_r509057589", "createdAt": "2020-10-21T07:42:42Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/SubscriptionSeekTest.java", "diffHunk": "@@ -116,6 +122,91 @@ public void testSeek() throws Exception {\n         assertEquals(sub.getNumberOfEntriesInBacklog(false), 0);\n     }\n \n+    @Test\n+    public void testSeekForBatch() throws Exception {\n+        final String topicName = \"persistent://prop/use/ns-abcd/testSeekForBatch\";\n+        String subscriptionName = \"my-subscription-batch\";\n+\n+        Producer<String> producer = pulsarClient.newProducer(Schema.STRING)\n+                .enableBatching(true)\n+                .batchingMaxMessages(3)\n+                .topic(topicName).create();\n+\n+\n+        List<MessageId> messageIds = new ArrayList<>();\n+        List<CompletableFuture<MessageId>> futureMessageIds = new ArrayList<>();\n+\n+        List<String> messages = new ArrayList<>();\n+        for (int i = 0; i < 10; i++) {\n+            String message = \"my-message-\" + i;\n+            messages.add(message);\n+            CompletableFuture<MessageId> messageIdCompletableFuture = producer.sendAsync(message);\n+            futureMessageIds.add(messageIdCompletableFuture);\n+        }\n+\n+        futureMessageIds.forEach(future -> {\n+            MessageId messageId = null;\n+            try {\n+                messageId = future.get();\n+                messageIds.add(messageId);\n+            } catch (InterruptedException | ExecutionException e) {\n+                e.printStackTrace();\n+            }\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d356ac8e5627eef1451ce84698de89d50b37aee"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4ODg3MzYzOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/SubscriptionSeekTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNzo0MzowOFrOHlebPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNzo0MzowOFrOHlebPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA1Nzg1Mw==", "bodyText": "Since the messageId is returned, we don't need to flush here.", "url": "https://github.com/apache/pulsar/pull/8285#discussion_r509057853", "createdAt": "2020-10-21T07:43:08Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/SubscriptionSeekTest.java", "diffHunk": "@@ -116,6 +122,91 @@ public void testSeek() throws Exception {\n         assertEquals(sub.getNumberOfEntriesInBacklog(false), 0);\n     }\n \n+    @Test\n+    public void testSeekForBatch() throws Exception {\n+        final String topicName = \"persistent://prop/use/ns-abcd/testSeekForBatch\";\n+        String subscriptionName = \"my-subscription-batch\";\n+\n+        Producer<String> producer = pulsarClient.newProducer(Schema.STRING)\n+                .enableBatching(true)\n+                .batchingMaxMessages(3)\n+                .topic(topicName).create();\n+\n+\n+        List<MessageId> messageIds = new ArrayList<>();\n+        List<CompletableFuture<MessageId>> futureMessageIds = new ArrayList<>();\n+\n+        List<String> messages = new ArrayList<>();\n+        for (int i = 0; i < 10; i++) {\n+            String message = \"my-message-\" + i;\n+            messages.add(message);\n+            CompletableFuture<MessageId> messageIdCompletableFuture = producer.sendAsync(message);\n+            futureMessageIds.add(messageIdCompletableFuture);\n+        }\n+\n+        futureMessageIds.forEach(future -> {\n+            MessageId messageId = null;\n+            try {\n+                messageId = future.get();\n+                messageIds.add(messageId);\n+            } catch (InterruptedException | ExecutionException e) {\n+                e.printStackTrace();\n+            }\n+        });\n+        producer.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d356ac8e5627eef1451ce84698de89d50b37aee"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4ODg5MDQ2OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/SubscriptionSeekTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNzo0NzoyM1rOHlel3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNzo0NzoyM1rOHlel3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA2MDU3Mw==", "bodyText": "Could you please also add some corner case test? such as reset to the last message to check the consumer can't receive any message?", "url": "https://github.com/apache/pulsar/pull/8285#discussion_r509060573", "createdAt": "2020-10-21T07:47:23Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/SubscriptionSeekTest.java", "diffHunk": "@@ -116,6 +122,91 @@ public void testSeek() throws Exception {\n         assertEquals(sub.getNumberOfEntriesInBacklog(false), 0);\n     }\n \n+    @Test\n+    public void testSeekForBatch() throws Exception {\n+        final String topicName = \"persistent://prop/use/ns-abcd/testSeekForBatch\";\n+        String subscriptionName = \"my-subscription-batch\";\n+\n+        Producer<String> producer = pulsarClient.newProducer(Schema.STRING)\n+                .enableBatching(true)\n+                .batchingMaxMessages(3)\n+                .topic(topicName).create();\n+\n+\n+        List<MessageId> messageIds = new ArrayList<>();\n+        List<CompletableFuture<MessageId>> futureMessageIds = new ArrayList<>();\n+\n+        List<String> messages = new ArrayList<>();\n+        for (int i = 0; i < 10; i++) {\n+            String message = \"my-message-\" + i;\n+            messages.add(message);\n+            CompletableFuture<MessageId> messageIdCompletableFuture = producer.sendAsync(message);\n+            futureMessageIds.add(messageIdCompletableFuture);\n+        }\n+\n+        futureMessageIds.forEach(future -> {\n+            MessageId messageId = null;\n+            try {\n+                messageId = future.get();\n+                messageIds.add(messageId);\n+            } catch (InterruptedException | ExecutionException e) {\n+                e.printStackTrace();\n+            }\n+        });\n+        producer.flush();\n+        producer.close();\n+\n+\n+        org.apache.pulsar.client.api.Consumer<String> consumer = pulsarClient.newConsumer(Schema.STRING)\n+                .topic(topicName)\n+                .subscriptionName(subscriptionName)\n+                .startMessageIdInclusive()\n+                .subscribe();\n+\n+        PersistentTopic topicRef = (PersistentTopic) pulsar.getBrokerService().getTopicReference(topicName).get();\n+        assertNotNull(topicRef);\n+\n+        assertEquals(topicRef.getSubscriptions().size(), 1);\n+\n+        MessageId resetId = messageIds.get(4);\n+        consumer.seek(resetId);\n+        // Wait for consumer to reconnect\n+        Thread.sleep(500);\n+\n+        Message<String> nextMessage = consumer.receive();\n+        MessageId nextId = nextMessage.getMessageId();\n+        consumer.acknowledge(nextId);\n+        String expectedMessage = messages.get(4);\n+        log.info(\"\\nexpected next message: {}, next message {}\", expectedMessage, nextMessage.getValue());\n+        assertEquals(nextMessage.getValue(), expectedMessage);\n+\n+        resetId = messageIds.get(3);\n+        consumer.seek(resetId);\n+        // Wait for consumer to reconnect\n+        Thread.sleep(500);\n+\n+        nextMessage = consumer.receive();\n+        nextId = nextMessage.getMessageId();\n+        consumer.acknowledge(nextId);\n+        expectedMessage = messages.get(3);\n+        log.info(\"expected next message2: {}, next message2 {}\", expectedMessage, nextMessage.getValue());\n+\n+        assertEquals(nextMessage.getValue(), expectedMessage);\n+\n+        resetId = messageIds.get(2);\n+        consumer.seek(resetId);\n+        // Wait for consumer to reconnect\n+        Thread.sleep(500);\n+\n+        nextMessage = consumer.receive();\n+        nextId = nextMessage.getMessageId();\n+        consumer.acknowledge(nextId);\n+        expectedMessage = messages.get(2);\n+        log.info(\"expected next message3: {}, next message3 {}\", expectedMessage, nextMessage.getValue());\n+        assertEquals(nextMessage.getValue(), expectedMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d356ac8e5627eef1451ce84698de89d50b37aee"}, "originalPosition": 118}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2935, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}