{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMTQ4MTcz", "number": 6717, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQwNzozMTozM1rODw6_lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwODo0OTo0NVrODxi4Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNjI0NzkwOnYy", "diffSide": "RIGHT", "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQwNzozMTozM1rOGELLFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMDozNzoyMVrOGEMN0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzAzMDU1MA==", "bodyText": "chooseTread(leaderId) make sure the second time write will not be executed, so the task meaningless. I don't think it is a good idea to fix the issue.", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r407030550", "createdAt": "2020-04-11T07:31:33Z", "author": {"login": "congbobo184"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -188,12 +191,15 @@ public void run() {\n                 AtomicLong haveOffloadEntryNumber = new AtomicLong(0);\n                 long needToOffloadFirstEntryNumber = 0;\n                 CountDownLatch countDownLatch;\n+                //avoid prefetch too much data into memory\n+                ArrayBlockingQueue<Boolean> tasks = new ArrayBlockingQueue<>(PREFETCH_ROUNDS);\n                 do {\n                     long end = Math.min(needToOffloadFirstEntryNumber + ENTRIES_PER_READ - 1, readHandle.getLastAddConfirmed());\n                     log.debug(\"read ledger entries. start: {}, end: {}\", needToOffloadFirstEntryNumber, end);\n                     LedgerEntries ledgerEntriesOnce = readHandle.readAsync(needToOffloadFirstEntryNumber, end).get();\n+                    tasks.put(true);\n                     countDownLatch = new CountDownLatch(1);\n-                    assignmentScheduler.chooseThread(ledgerId).submit(new FileSystemWriter(ledgerEntriesOnce, dataWriter,\n+                    assignmentScheduler.chooseThread(ledgerId).submit(FileSystemWriter.create(ledgerEntriesOnce, dataWriter, tasks,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "def4a94ad3e03cf0d032634fb91004bb8c5a5f38"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0NzYzMw==", "bodyText": "I made a comment below @congbobo184", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r407047633", "createdAt": "2020-04-11T10:37:21Z", "author": {"login": "pheecian"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -188,12 +191,15 @@ public void run() {\n                 AtomicLong haveOffloadEntryNumber = new AtomicLong(0);\n                 long needToOffloadFirstEntryNumber = 0;\n                 CountDownLatch countDownLatch;\n+                //avoid prefetch too much data into memory\n+                ArrayBlockingQueue<Boolean> tasks = new ArrayBlockingQueue<>(PREFETCH_ROUNDS);\n                 do {\n                     long end = Math.min(needToOffloadFirstEntryNumber + ENTRIES_PER_READ - 1, readHandle.getLastAddConfirmed());\n                     log.debug(\"read ledger entries. start: {}, end: {}\", needToOffloadFirstEntryNumber, end);\n                     LedgerEntries ledgerEntriesOnce = readHandle.readAsync(needToOffloadFirstEntryNumber, end).get();\n+                    tasks.put(true);\n                     countDownLatch = new CountDownLatch(1);\n-                    assignmentScheduler.chooseThread(ledgerId).submit(new FileSystemWriter(ledgerEntriesOnce, dataWriter,\n+                    assignmentScheduler.chooseThread(ledgerId).submit(FileSystemWriter.create(ledgerEntriesOnce, dataWriter, tasks,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzAzMDU1MA=="}, "originalCommit": {"oid": "def4a94ad3e03cf0d032634fb91004bb8c5a5f38"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNjM4ODg3OnYy", "diffSide": "RIGHT", "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxMDozNjoxNlrOGEMNeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwNzo0OTozMlrOGETKhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0NzU0NQ==", "bodyText": "the blockingQueue is to block the whole do while loop(to be precisely, the read and submit) Here, not try to limit fileSystemWriter. I understand that the FileSystemWriter will be executed orderly. My intention is to limit the whole do while loop because the do while loop((readAsync().get()) read data from ledger in advance too much too quickly(and lead to consume much memory), more than  FileSystemWriter Threads can handle timely. So read in advance, or put in other words, prefetch, should be controlled to some degree. So I introduce a blocking queue and hence a producer-consumer mock-up. the do while loop(read and submit) acts like a producer, the FileSystemWriter acts as a consumer. @congbobo184", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r407047545", "createdAt": "2020-04-11T10:36:16Z", "author": {"login": "pheecian"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -188,12 +191,15 @@ public void run() {\n                 AtomicLong haveOffloadEntryNumber = new AtomicLong(0);\n                 long needToOffloadFirstEntryNumber = 0;\n                 CountDownLatch countDownLatch;\n+                //avoid prefetch too much data into memory\n+                ArrayBlockingQueue<Boolean> tasks = new ArrayBlockingQueue<>(PREFETCH_ROUNDS);\n                 do {\n                     long end = Math.min(needToOffloadFirstEntryNumber + ENTRIES_PER_READ - 1, readHandle.getLastAddConfirmed());\n                     log.debug(\"read ledger entries. start: {}, end: {}\", needToOffloadFirstEntryNumber, end);\n                     LedgerEntries ledgerEntriesOnce = readHandle.readAsync(needToOffloadFirstEntryNumber, end).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "def4a94ad3e03cf0d032634fb91004bb8c5a5f38"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE1OTE5Nw==", "bodyText": "I have  understood your min, I look up the code context, I think you can use Semaphore to fix it :)", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r407159197", "createdAt": "2020-04-12T07:26:58Z", "author": {"login": "congbobo184"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -188,12 +191,15 @@ public void run() {\n                 AtomicLong haveOffloadEntryNumber = new AtomicLong(0);\n                 long needToOffloadFirstEntryNumber = 0;\n                 CountDownLatch countDownLatch;\n+                //avoid prefetch too much data into memory\n+                ArrayBlockingQueue<Boolean> tasks = new ArrayBlockingQueue<>(PREFETCH_ROUNDS);\n                 do {\n                     long end = Math.min(needToOffloadFirstEntryNumber + ENTRIES_PER_READ - 1, readHandle.getLastAddConfirmed());\n                     log.debug(\"read ledger entries. start: {}, end: {}\", needToOffloadFirstEntryNumber, end);\n                     LedgerEntries ledgerEntriesOnce = readHandle.readAsync(needToOffloadFirstEntryNumber, end).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0NzU0NQ=="}, "originalCommit": {"oid": "def4a94ad3e03cf0d032634fb91004bb8c5a5f38"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE2MTQ3Nw==", "bodyText": "nice idea! I will change the code to implement the idea @congbobo184", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r407161477", "createdAt": "2020-04-12T07:49:32Z", "author": {"login": "pheecian"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -188,12 +191,15 @@ public void run() {\n                 AtomicLong haveOffloadEntryNumber = new AtomicLong(0);\n                 long needToOffloadFirstEntryNumber = 0;\n                 CountDownLatch countDownLatch;\n+                //avoid prefetch too much data into memory\n+                ArrayBlockingQueue<Boolean> tasks = new ArrayBlockingQueue<>(PREFETCH_ROUNDS);\n                 do {\n                     long end = Math.min(needToOffloadFirstEntryNumber + ENTRIES_PER_READ - 1, readHandle.getLastAddConfirmed());\n                     log.debug(\"read ledger entries. start: {}, end: {}\", needToOffloadFirstEntryNumber, end);\n                     LedgerEntries ledgerEntriesOnce = readHandle.readAsync(needToOffloadFirstEntryNumber, end).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0NzU0NQ=="}, "originalCommit": {"oid": "def4a94ad3e03cf0d032634fb91004bb8c5a5f38"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNzYzMzI5OnYy", "diffSide": "RIGHT", "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxMzo0MTozOFrOGEVg1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxNDo1MTozMlrOGEWEDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE5OTk1Ng==", "bodyText": "One per reading is ok, the PREFETCH_ROUNDS unnecessary to big.", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r407199956", "createdAt": "2020-04-12T13:41:38Z", "author": {"login": "congbobo184"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -62,12 +65,14 @@\n     private final FileSystem fileSystem;\n     private OrderedScheduler scheduler;\n     private static final long ENTRIES_PER_READ = 100;\n+    private static final int PREFETCH_ROUNDS = 100;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc7294cf0b3525090e38d7175d4f03a7f0963026"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIwODk3NQ==", "bodyText": "ok", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r407208975", "createdAt": "2020-04-12T14:51:32Z", "author": {"login": "pheecian"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -62,12 +65,14 @@\n     private final FileSystem fileSystem;\n     private OrderedScheduler scheduler;\n     private static final long ENTRIES_PER_READ = 100;\n+    private static final int PREFETCH_ROUNDS = 100;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE5OTk1Ng=="}, "originalCommit": {"oid": "bc7294cf0b3525090e38d7175d4f03a7f0963026"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNzYzNTA2OnYy", "diffSide": "RIGHT", "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxMzo0MzoxNFrOGEVhuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxNDo1MTo0MFrOGEWEHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIwMDE4Nw==", "bodyText": "this format should not be modified", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r407200187", "createdAt": "2020-04-12T13:43:14Z", "author": {"login": "congbobo184"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -132,8 +138,8 @@ public FileSystemManagedLedgerOffloader(OffloadPolicies conf, OrderedScheduler s\n     }\n \n     /*\n-    * ledgerMetadata stored in an index of -1\n-    * */\n+     * ledgerMetadata stored in an index of -1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc7294cf0b3525090e38d7175d4f03a7f0963026"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIwODk5MQ==", "bodyText": "ok", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r407208991", "createdAt": "2020-04-12T14:51:40Z", "author": {"login": "pheecian"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -132,8 +138,8 @@ public FileSystemManagedLedgerOffloader(OffloadPolicies conf, OrderedScheduler s\n     }\n \n     /*\n-    * ledgerMetadata stored in an index of -1\n-    * */\n+     * ledgerMetadata stored in an index of -1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIwMDE4Nw=="}, "originalCommit": {"oid": "bc7294cf0b3525090e38d7175d4f03a7f0963026"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjc4MzExOnYy", "diffSide": "RIGHT", "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwODo0OTo0NVrOGFEilQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMzowMTo1M1rOGFNglA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk3MDQ1Mw==", "bodyText": "Can we make this configurable? I am worried about this will cause performance problems.", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r407970453", "createdAt": "2020-04-14T08:49:45Z", "author": {"login": "sijie"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -188,13 +192,17 @@ public void run() {\n                 AtomicLong haveOffloadEntryNumber = new AtomicLong(0);\n                 long needToOffloadFirstEntryNumber = 0;\n                 CountDownLatch countDownLatch;\n+                //avoid prefetch too much data into memory\n+                Semaphore semaphore = new Semaphore(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e3a7929de7415d2ac3c1a870087b3440e7156a3"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExNzM5Ng==", "bodyText": "sure", "url": "https://github.com/apache/pulsar/pull/6717#discussion_r408117396", "createdAt": "2020-04-14T13:01:53Z", "author": {"login": "pheecian"}, "path": "tiered-storage/file-system/src/main/java/org/apache/bookkeeper/mledger/offload/filesystem/impl/FileSystemManagedLedgerOffloader.java", "diffHunk": "@@ -188,13 +192,17 @@ public void run() {\n                 AtomicLong haveOffloadEntryNumber = new AtomicLong(0);\n                 long needToOffloadFirstEntryNumber = 0;\n                 CountDownLatch countDownLatch;\n+                //avoid prefetch too much data into memory\n+                Semaphore semaphore = new Semaphore(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk3MDQ1Mw=="}, "originalCommit": {"oid": "4e3a7929de7415d2ac3c1a870087b3440e7156a3"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1889, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}