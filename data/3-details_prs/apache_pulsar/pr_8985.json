{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNjcwNjM3", "number": 8985, "title": "[Issue 8887][tiered-storage-jcloud] support tiered-storage provider by aliyun OSS", "bodyText": "Fixes #8887\nMotivation\nsupport tiered storage by aliyun oss.\nModifications\nAliyun OSS is compatible with the S3 API.\nFor security reasons, OSS supports only virtual hosted style access.\nSo I use S3ApiMetadata to connect OSS, and set jclouds.s3.virtual-host-buckets=true.\ndocuments:\nChina: https://help.aliyun.com/document_detail/64919.html\nInternationale: https://www.alibabacloud.com/help/doc-detail/64919.htm\nVerifying this change\ntest with local\nDocumentation\n\nDoes this pull request introduce a new feature? yes\nIf yes, how is the feature documented? more tiered-storage provider\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-12-17T07:37:27Z", "url": "https://github.com/apache/pulsar/pull/8985", "merged": true, "mergeCommit": {"oid": "98ad39ffa51239e389c73411dfb8df7f5592a5aa"}, "closed": true, "closedAt": "2020-12-29T09:08:17Z", "author": {"login": "yufan022"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm-R6NAH2gAyNTQxNjcwNjM3OjQ1NmY1ZDIzMWRmZmIzMzg5MDEyZGZkOTY1MjZkMzE3ODU1ZmI0ZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdq3ApCAFqTU1OTQ0MDE1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "456f5d231dffb3389012dfd96526d317855fb4d8", "author": {"user": {"login": "yufan022", "name": "wangyufan"}}, "url": "https://github.com/apache/pulsar/commit/456f5d231dffb3389012dfd96526d317855fb4d8", "committedDate": "2020-12-17T07:20:02Z", "message": "support tiered-storage provider by aliyun OSS (#8887)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MjY0OTcw", "url": "https://github.com/apache/pulsar/pull/8985#pullrequestreview-555264970", "createdAt": "2020-12-18T08:09:29Z", "commit": {"oid": "456f5d231dffb3389012dfd96526d317855fb4d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwODowOTozMFrOIIXBCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwODowOTozMFrOIIXBCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYzNjYxNw==", "bodyText": "I think it's better to define a new constant like here \n  \n    \n      pulsar/tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/provider/JCloudBlobStoreProvider.java\n    \n    \n         Line 258\n      in\n      bf9f619\n    \n    \n    \n    \n\n        \n          \n           static final BlobStoreBuilder BLOB_STORE_BUILDER = (TieredStorageConfiguration config) -> {", "url": "https://github.com/apache/pulsar/pull/8985#discussion_r545636617", "createdAt": "2020-12-18T08:09:30Z", "author": {"login": "Renkai"}, "path": "tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/provider/JCloudBlobStoreProvider.java", "diffHunk": "@@ -162,6 +165,48 @@ public void buildCredentials(TieredStorageConfiguration config) {\n         }\n     },\n \n+\n+    /**\n+     * Aliyun OSS is compatible with the S3 API\n+     * https://www.alibabacloud.com/help/doc-detail/64919.htm\n+     */\n+    ALIYUN_OSS(\"aliyun-oss\", new AnonymousProviderMetadata(new S3ApiMetadata(), \"\")) {\n+        @Override\n+        public void validate(TieredStorageConfiguration config) throws IllegalArgumentException {\n+            VALIDATION.validate(config);\n+        }\n+\n+        @Override\n+        public BlobStore getBlobStore(TieredStorageConfiguration config) {\n+            ContextBuilder contextBuilder = ContextBuilder.newBuilder(config.getProviderMetadata());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456f5d231dffb3389012dfd96526d317855fb4d8"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f7000433ad9ae0401e646be64f05ab67032640d", "author": {"user": {"login": "yufan022", "name": "wangyufan"}}, "url": "https://github.com/apache/pulsar/commit/5f7000433ad9ae0401e646be64f05ab67032640d", "committedDate": "2020-12-18T08:44:23Z", "message": "support tiered-storage provider by aliyun OSS (#8887)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NDMyNzQz", "url": "https://github.com/apache/pulsar/pull/8985#pullrequestreview-555432743", "createdAt": "2020-12-18T12:05:58Z", "commit": {"oid": "5f7000433ad9ae0401e646be64f05ab67032640d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMjowNTo1OVrOIIgXLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMjoyMzoyN1rOIIg11Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc4OTc0Mg==", "bodyText": "S3_STANDARD_BLOB_STORE_BUILDER, S3_COMMENT_BLOB_STORE_BUILDER or other names? It seems that oss is a universal name.", "url": "https://github.com/apache/pulsar/pull/8985#discussion_r545789742", "createdAt": "2020-12-18T12:05:59Z", "author": {"login": "gaoran10"}, "path": "tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/provider/JCloudBlobStoreProvider.java", "diffHunk": "@@ -162,6 +165,28 @@ public void buildCredentials(TieredStorageConfiguration config) {\n         }\n     },\n \n+\n+    /**\n+     * Aliyun OSS is compatible with the S3 API\n+     * https://www.alibabacloud.com/help/doc-detail/64919.htm\n+     */\n+    ALIYUN_OSS(\"aliyun-oss\", new AnonymousProviderMetadata(new S3ApiMetadata(), \"\")) {\n+        @Override\n+        public void validate(TieredStorageConfiguration config) throws IllegalArgumentException {\n+            VALIDATION.validate(config);\n+        }\n+\n+        @Override\n+        public BlobStore getBlobStore(TieredStorageConfiguration config) {\n+            return OSS_BLOB_STORE_BUILDER.getBlobStore(config);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7000433ad9ae0401e646be64f05ab67032640d"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc5MzExMg==", "bodyText": "Does the serviceEndpoint is a necessary configuration? If necessary it's better to add a configuration validationcheck.", "url": "https://github.com/apache/pulsar/pull/8985#discussion_r545793112", "createdAt": "2020-12-18T12:13:21Z", "author": {"login": "gaoran10"}, "path": "tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/provider/JCloudBlobStoreProvider.java", "diffHunk": "@@ -162,6 +165,28 @@ public void buildCredentials(TieredStorageConfiguration config) {\n         }\n     },\n \n+\n+    /**\n+     * Aliyun OSS is compatible with the S3 API\n+     * https://www.alibabacloud.com/help/doc-detail/64919.htm\n+     */\n+    ALIYUN_OSS(\"aliyun-oss\", new AnonymousProviderMetadata(new S3ApiMetadata(), \"\")) {\n+        @Override\n+        public void validate(TieredStorageConfiguration config) throws IllegalArgumentException {\n+            VALIDATION.validate(config);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7000433ad9ae0401e646be64f05ab67032640d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc5NzU4OQ==", "bodyText": "Does the Aliyun security validate is the same as AWS? Do we need to add environment configurations for the Aliyun service? Currently, the AWS security configurations could refer to doc.", "url": "https://github.com/apache/pulsar/pull/8985#discussion_r545797589", "createdAt": "2020-12-18T12:23:27Z", "author": {"login": "gaoran10"}, "path": "tiered-storage/jcloud/src/main/java/org/apache/bookkeeper/mledger/offload/jcloud/provider/JCloudBlobStoreProvider.java", "diffHunk": "@@ -162,6 +165,28 @@ public void buildCredentials(TieredStorageConfiguration config) {\n         }\n     },\n \n+\n+    /**\n+     * Aliyun OSS is compatible with the S3 API\n+     * https://www.alibabacloud.com/help/doc-detail/64919.htm\n+     */\n+    ALIYUN_OSS(\"aliyun-oss\", new AnonymousProviderMetadata(new S3ApiMetadata(), \"\")) {\n+        @Override\n+        public void validate(TieredStorageConfiguration config) throws IllegalArgumentException {\n+            VALIDATION.validate(config);\n+        }\n+\n+        @Override\n+        public BlobStore getBlobStore(TieredStorageConfiguration config) {\n+            return OSS_BLOB_STORE_BUILDER.getBlobStore(config);\n+        }\n+\n+        @Override\n+        public void buildCredentials(TieredStorageConfiguration config) {\n+            AWS_CREDENTIAL_BUILDER.buildCredentials(config);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7000433ad9ae0401e646be64f05ab67032640d"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aa5a0083079e97aec2fa18b3eac4a30b1953e7c", "author": {"user": {"login": "yufan022", "name": "wangyufan"}}, "url": "https://github.com/apache/pulsar/commit/2aa5a0083079e97aec2fa18b3eac4a30b1953e7c", "committedDate": "2020-12-20T13:30:33Z", "message": "add new validator by aliyun-oss"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83493cc8fc50e154d3c843a0810fb5cad5c17cd4", "author": {"user": {"login": "yufan022", "name": "wangyufan"}}, "url": "https://github.com/apache/pulsar/commit/83493cc8fc50e154d3c843a0810fb5cad5c17cd4", "committedDate": "2020-12-20T13:27:19Z", "message": "add new validator by aliyun-oss"}, "afterCommit": {"oid": "2aa5a0083079e97aec2fa18b3eac4a30b1953e7c", "author": {"user": {"login": "yufan022", "name": "wangyufan"}}, "url": "https://github.com/apache/pulsar/commit/2aa5a0083079e97aec2fa18b3eac4a30b1953e7c", "committedDate": "2020-12-20T13:30:33Z", "message": "add new validator by aliyun-oss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cae7456e45c41fb8eabb4934e7e11499f9e43ead", "author": {"user": {"login": "yufan022", "name": "wangyufan"}}, "url": "https://github.com/apache/pulsar/commit/cae7456e45c41fb8eabb4934e7e11499f9e43ead", "committedDate": "2020-12-21T04:10:11Z", "message": "add environment variable by aliyun-oss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7528903fb5b39ca2d921c42d5f3fbd652a5d938", "author": {"user": {"login": "yufan022", "name": "wangyufan"}}, "url": "https://github.com/apache/pulsar/commit/f7528903fb5b39ca2d921c42d5f3fbd652a5d938", "committedDate": "2020-12-21T04:11:11Z", "message": "extract constant"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDM4MzE1", "url": "https://github.com/apache/pulsar/pull/8985#pullrequestreview-559438315", "createdAt": "2020-12-29T09:02:44Z", "commit": {"oid": "f7528903fb5b39ca2d921c42d5f3fbd652a5d938"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDM5MTk5", "url": "https://github.com/apache/pulsar/pull/8985#pullrequestreview-559439199", "createdAt": "2020-12-29T09:05:04Z", "commit": {"oid": "f7528903fb5b39ca2d921c42d5f3fbd652a5d938"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDQwMTUx", "url": "https://github.com/apache/pulsar/pull/8985#pullrequestreview-559440151", "createdAt": "2020-12-29T09:07:32Z", "commit": {"oid": "f7528903fb5b39ca2d921c42d5f3fbd652a5d938"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 786, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}