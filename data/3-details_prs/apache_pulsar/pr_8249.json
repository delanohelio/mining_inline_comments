{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyNjA4NTQz", "number": 8249, "title": "Nack support in WS", "bodyText": "Contribution Checklist\nFixes #8247\nMotivation\nNack support in WS API.\nModifications\nhandleNack method in ConsumerHandler and additional parameter for consumer negativeAckRedeliveryDelay.\nCurrent WS API test is ok.", "createdAt": "2020-10-13T17:29:41Z", "url": "https://github.com/apache/pulsar/pull/8249", "merged": true, "mergeCommit": {"oid": "2be05fb18a34aae78b2955ad85f173eed50fd5c4"}, "closed": true, "closedAt": "2021-05-21T12:39:41Z", "author": {"login": "yrsh"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSL9IcAH2gAyNTAyNjA4NTQzOjkwOWZhYzNjYTZlMDU2YzRkNjBmMjA5ZTU4ZTMzZGNjMmRiMDNiNjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeY3HhfAH2gAyNTAyNjA4NTQzOjlmM2I1NGMzNDA1N2JjYTEyMmNjMzYzNzgzNjhkYmIxOWI0NjA1ZDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "909fac3ca6e056c4d60f209e58e33dcc2db03b67", "author": {"user": {"login": "yrsh", "name": "Anton K"}}, "url": "https://github.com/apache/pulsar/commit/909fac3ca6e056c4d60f209e58e33dcc2db03b67", "committedDate": "2020-10-13T17:23:36Z", "message": "Negative acknowledging for WS API"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNTE2Nzg5", "url": "https://github.com/apache/pulsar/pull/8249#pullrequestreview-510516789", "createdAt": "2020-10-16T14:20:05Z", "commit": {"oid": "909fac3ca6e056c4d60f209e58e33dcc2db03b67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNDoyMDowNlrOHjA6Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNDoyMDowNlrOHjA6Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ3NzA3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #### Negative acknowledging the message\n          \n          \n            \n            #### Negatively acknowledging messages", "url": "https://github.com/apache/pulsar/pull/8249#discussion_r506477078", "createdAt": "2020-10-16T14:20:06Z", "author": {"login": "Huanli-Meng"}, "path": "site2/website/versioned_docs/version-2.2.0/client-libraries-websocket.md", "diffHunk": "@@ -180,6 +181,17 @@ Key | Type | Required? | Explanation\n :---|:-----|:----------|:-----------\n `messageId`| string | yes | Message ID of the processed message\n \n+#### Negative acknowledging the message", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "909fac3ca6e056c4d60f209e58e33dcc2db03b67"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f02c48e3b019ddde8da7216c8f7a998df790be14", "author": {"user": {"login": "yrsh", "name": "Anton K"}}, "url": "https://github.com/apache/pulsar/commit/f02c48e3b019ddde8da7216c8f7a998df790be14", "committedDate": "2020-10-17T07:26:24Z", "message": "Update site2/website/versioned_docs/version-2.2.0/client-libraries-websocket.md\n\nCo-authored-by: HuanliMeng <48120384+Huanli-Meng@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be74ad6f5c10098ccebb67fcc92d68947eb0d378", "author": {"user": {"login": "yrsh", "name": "Anton K"}}, "url": "https://github.com/apache/pulsar/commit/be74ad6f5c10098ccebb67fcc92d68947eb0d378", "committedDate": "2020-10-18T08:26:30Z", "message": "WS docs update (only latest)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMTQ2NjQ0", "url": "https://github.com/apache/pulsar/pull/8249#pullrequestreview-511146644", "createdAt": "2020-10-18T13:48:55Z", "commit": {"oid": "be74ad6f5c10098ccebb67fcc92d68947eb0d378"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQxMzo0ODo1NVrOHjqWpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOFQxMzo0ODo1NVrOHjqWpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzE1NjEzNQ==", "bodyText": "Change this sentence \"When a negative acked message will be redelivered to DLQ.\" to \"A negatively-acknowledged message will be redelivered to the DLQ.\" or \"When a message is negatively acknowledged, it will be redelivered to the DLQ.\" Does this make sense? Thanks", "url": "https://github.com/apache/pulsar/pull/8249#discussion_r507156135", "createdAt": "2020-10-18T13:48:55Z", "author": {"login": "Huanli-Meng"}, "path": "site2/docs/client-libraries-websocket.md", "diffHunk": "@@ -145,6 +145,8 @@ Key | Type | Required? | Explanation\n `maxRedeliverCount` | int | no | Define a [maxRedeliverCount](http://pulsar.apache.org/api/client/org/apache/pulsar/client/api/ConsumerBuilder.html#deadLetterPolicy-org.apache.pulsar.client.api.DeadLetterPolicy-) for the consumer (default: 0). Activates [Dead Letter Topic](https://github.com/apache/pulsar/wiki/PIP-22%3A-Pulsar-Dead-Letter-Topic) feature.\n `deadLetterTopic` | string | no | Define a [deadLetterTopic](http://pulsar.apache.org/api/client/org/apache/pulsar/client/api/ConsumerBuilder.html#deadLetterPolicy-org.apache.pulsar.client.api.DeadLetterPolicy-) for the consumer (default: {topic}-{subscription}-DLQ). Activates [Dead Letter Topic](https://github.com/apache/pulsar/wiki/PIP-22%3A-Pulsar-Dead-Letter-Topic) feature.\n `pullMode` | boolean | no | Enable pull mode (default: false). See \"Flow Control\" below.\n+`negativeAckRedeliveryDelay` | int | no | When a negative acked message will be redelivered to DLQ.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be74ad6f5c10098ccebb67fcc92d68947eb0d378"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d204bd484e0a2f560c26bf696a158a398b02db4d", "author": {"user": {"login": "yrsh", "name": "Anton K"}}, "url": "https://github.com/apache/pulsar/commit/d204bd484e0a2f560c26bf696a158a398b02db4d", "committedDate": "2020-10-18T15:12:47Z", "message": "Update client-libraries-websocket.md\n\ndocs update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMTU0NTQy", "url": "https://github.com/apache/pulsar/pull/8249#pullrequestreview-511154542", "createdAt": "2020-10-18T15:19:31Z", "commit": {"oid": "d204bd484e0a2f560c26bf696a158a398b02db4d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMzIxNzEx", "url": "https://github.com/apache/pulsar/pull/8249#pullrequestreview-513321711", "createdAt": "2020-10-21T05:42:07Z", "commit": {"oid": "d204bd484e0a2f560c26bf696a158a398b02db4d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dd2d260473ff6a4efca7b5dd90e92e89c5e9b7a", "author": {"user": {"login": "yrsh", "name": "Anton K"}}, "url": "https://github.com/apache/pulsar/commit/2dd2d260473ff6a4efca7b5dd90e92e89c5e9b7a", "committedDate": "2020-11-10T11:20:39Z", "message": "functional test for ws nack added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "241629b865c2d66d9f2d34cfdc6ffac2ea0a3da4", "author": {"user": {"login": "yrsh", "name": "Anton K"}}, "url": "https://github.com/apache/pulsar/commit/241629b865c2d66d9f2d34cfdc6ffac2ea0a3da4", "committedDate": "2020-11-10T11:40:45Z", "message": "functional test for ws nack added (additional assert)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8320463788b55c03e1999865520221fab30ec04", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/d8320463788b55c03e1999865520221fab30ec04", "committedDate": "2020-11-17T03:12:57Z", "message": "Merge remote-tracking branch 'apache/master' into feature/ws-nack"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTkyMjM5", "url": "https://github.com/apache/pulsar/pull/8249#pullrequestreview-531992239", "createdAt": "2020-11-17T03:16:01Z", "commit": {"oid": "d8320463788b55c03e1999865520221fab30ec04"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMzoxNjowMVrOH0iy9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMzoxNjowMVrOH0iy9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg1ODEwMw==", "bodyText": "I think you can refine the test as #8557 does. Sleep also introduces too much flaky tests.", "url": "https://github.com/apache/pulsar/pull/8249#discussion_r524858103", "createdAt": "2020-11-17T03:16:01Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/websocket/proxy/ProxyPublishConsumeTest.java", "diffHunk": "@@ -564,6 +566,76 @@ public void socketPullModeTest() throws Exception {\n         }\n     }\n \n+    @Test(timeOut = 10000)\n+    public void nackMessageTest() throws Exception {\n+        final String subscription = \"my-sub\";\n+        final String dlqTopic = \"my-property/my-ns/my-topic10\";\n+        final String consumerTopic = \"my-property/my-ns/my-topic9\";\n+\n+        final String dlqUri = \"ws://localhost:\" + proxyServer.getListenPortHTTP().get() +\n+          \"/ws/v2/consumer/persistent/\" +\n+          dlqTopic + \"/\" + subscription +\n+          \"?subscriptionType=Shared\";\n+\n+        final String consumerUri = \"ws://localhost:\" + proxyServer.getListenPortHTTP().get() +\n+          \"/ws/v2/consumer/persistent/\" +\n+          consumerTopic + \"/\" + subscription +\n+          \"?deadLetterTopic=\" + dlqTopic +\n+          \"&maxRedeliverCount=0&subscriptionType=Shared&ackTimeoutMillis=1000&negativeAckRedeliveryDelay=1000\";\n+\n+        final String producerUri = \"ws://localhost:\" + proxyServer.getListenPortHTTP().get() +\n+          \"/ws/v2/producer/persistent/\" + consumerTopic;\n+\n+        WebSocketClient consumeClient1 = new WebSocketClient();\n+        SimpleConsumerSocket consumeSocket1 = new SimpleConsumerSocket();\n+        WebSocketClient consumeClient2 = new WebSocketClient();\n+        SimpleConsumerSocket consumeSocket2 = new SimpleConsumerSocket();\n+        WebSocketClient produceClient = new WebSocketClient();\n+        SimpleProducerSocket produceSocket = new SimpleProducerSocket();\n+\n+        consumeSocket1.setMessageHandler((id, data) -> {\n+            JsonObject nack = new JsonObject();\n+            nack.add(\"messageId\", new JsonPrimitive(id));\n+            nack.add(\"type\", new JsonPrimitive(\"negativeAcknowledge\"));\n+            return nack.toString();\n+        });\n+\n+        try {\n+            consumeClient1.start();\n+            consumeClient2.start();\n+            ClientUpgradeRequest consumeRequest1 = new ClientUpgradeRequest();\n+            ClientUpgradeRequest consumeRequest2 = new ClientUpgradeRequest();\n+            Future<Session> consumerFuture1 = consumeClient1.connect(consumeSocket1, URI.create(consumerUri), consumeRequest1);\n+            Future<Session> consumerFuture2 = consumeClient2.connect(consumeSocket2, URI.create(dlqUri), consumeRequest2);\n+\n+            assertTrue(consumerFuture1.get().isOpen());\n+            assertTrue(consumerFuture2.get().isOpen());\n+\n+            ClientUpgradeRequest produceRequest = new ClientUpgradeRequest();\n+            produceClient.start();\n+            Future<Session> producerFuture = produceClient.connect(produceSocket, URI.create(producerUri), produceRequest);\n+            assertTrue(producerFuture.get().isOpen());\n+\n+            assertEquals(consumeSocket1.getReceivedMessagesCount(), 0);\n+            assertEquals(consumeSocket2.getReceivedMessagesCount(), 0);\n+\n+            produceSocket.sendMessage(1);\n+\n+            Thread.sleep(500);\n+\n+            //assertEquals(consumeSocket1.getReceivedMessagesCount(), 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8320463788b55c03e1999865520221fab30ec04"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyMjI2NDc0", "url": "https://github.com/apache/pulsar/pull/8249#pullrequestreview-572226474", "createdAt": "2021-01-20T13:38:41Z", "commit": {"oid": "d8320463788b55c03e1999865520221fab30ec04"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxMzozODo0MVrOIW-nIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxMzozODo0MVrOIW-nIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDk2NTQwOQ==", "bodyText": "Miss license header here.", "url": "https://github.com/apache/pulsar/pull/8249#discussion_r560965409", "createdAt": "2021-01-20T13:38:41Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/websocket/proxy/SimpleConsumerMessageHandler.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package org.apache.pulsar.websocket.proxy;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8320463788b55c03e1999865520221fab30ec04"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c19e1c28d731f68ffa6fc5b9f43df40408c4e2bf", "author": {"user": {"login": "yrsh", "name": "Anton K"}}, "url": "https://github.com/apache/pulsar/commit/c19e1c28d731f68ffa6fc5b9f43df40408c4e2bf", "committedDate": "2021-01-20T14:37:09Z", "message": "license header added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fe4c15bc70feb691737f3e271b23ddca5b2ade4", "author": {"user": {"login": "yrsh", "name": "Anton K"}}, "url": "https://github.com/apache/pulsar/commit/3fe4c15bc70feb691737f3e271b23ddca5b2ade4", "committedDate": "2021-01-20T14:37:58Z", "message": "Merge branch 'feature/ws-nack' of github.com:yrsh/pulsar into feature/ws-nack"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7804b03d19c3b78c6f99842c5ab37b67d182d2e2", "author": {"user": {"login": "yrsh", "name": "Anton K"}}, "url": "https://github.com/apache/pulsar/commit/7804b03d19c3b78c6f99842c5ab37b67d182d2e2", "committedDate": "2021-03-12T09:24:19Z", "message": "Merge branch 'master' into feature/ws-nack"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38520fb0e1189ae0efc856f339ba4d7dfc6853d8", "author": {"user": {"login": "yrsh", "name": "Anton K"}}, "url": "https://github.com/apache/pulsar/commit/38520fb0e1189ae0efc856f339ba4d7dfc6853d8", "committedDate": "2021-03-16T10:41:10Z", "message": "Merge branch 'master' into feature/ws-nack"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f3b54c34057bca122cc36378368dbb19b4605d4", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/9f3b54c34057bca122cc36378368dbb19b4605d4", "committedDate": "2021-05-21T07:15:34Z", "message": "Merge remote-tracking branch 'apache/master' into feature/ws-nack"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1219, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}