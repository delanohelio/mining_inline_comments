{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNTY3NTMy", "number": 8563, "title": "[Transaction] Guarantee transaction metadata handlers connect", "bodyText": "Motivation\nCurrently, the transaction metadata handlers start with pulsar client start, but the handlers connect with the broker asynchronously, if the client restart, the metadata handler may not be available.\nModifications\nAdd the connection future for the metadata handler.\nVerifying this change\nThis change added tests and can be verified as follows:\n\norg.apache.pulsar.client.impl.TransactionEndToEndTest#txnMetadataHandlerRecoverTest\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (no)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)", "createdAt": "2020-11-13T13:00:45Z", "url": "https://github.com/apache/pulsar/pull/8563", "merged": true, "mergeCommit": {"oid": "8394dcadd348d8b73be2301e7d31bbef91091c6d"}, "closed": true, "closedAt": "2020-11-14T08:02:22Z", "author": {"login": "gaoran10"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcGlpeAH2gAyNTIwNTY3NTMyOjg3OTMxNTQ2YmUwZWRmMjE3NDM3ZjliNjg4NDYxMzY4MmU3MGRlZTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcHqcygFqTUzMDA4NTE2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "87931546be0edf217437f9b6884613682e70dee4", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/87931546be0edf217437f9b6884613682e70dee4", "committedDate": "2020-11-13T12:47:40Z", "message": "guarantee all transaction metadata handlers connect finished."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMDYxNDg3", "url": "https://github.com/apache/pulsar/pull/8563#pullrequestreview-530061487", "createdAt": "2020-11-13T13:30:19Z", "commit": {"oid": "87931546be0edf217437f9b6884613682e70dee4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMzozMDoyMFrOHyuXXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMzozMDoyMFrOHyuXXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk1MDQ5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (partition > 0) {\n          \n          \n            \n                    if (partition >= 0) {", "url": "https://github.com/apache/pulsar/pull/8563#discussion_r522950492", "createdAt": "2020-11-13T13:30:20Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/transaction/TransactionCoordinatorClientImpl.java", "diffHunk": "@@ -75,34 +76,48 @@ public void start() throws TransactionCoordinatorClientException {\n     public CompletableFuture<Void> startAsync() {\n         if (STATE_UPDATER.compareAndSet(this, State.NONE, State.STARTING)) {\n             return pulsarClient.getLookup().getPartitionedTopicMetadata(TopicName.TRANSACTION_COORDINATOR_ASSIGN)\n-                .thenAccept(partitionMeta -> {\n+                .thenCompose(partitionMeta -> {\n+                    List<CompletableFuture<Void>> connectFutureList = new ArrayList<>();\n                     if (LOG.isDebugEnabled()) {\n                         LOG.debug(\"Transaction meta store assign partition is {}.\", partitionMeta.partitions);\n                     }\n                     if (partitionMeta.partitions > 0) {\n                         handlers = new TransactionMetaStoreHandler[partitionMeta.partitions];\n                         for (int i = 0; i < partitionMeta.partitions; i++) {\n-                            TransactionMetaStoreHandler handler = new TransactionMetaStoreHandler(i, pulsarClient,\n-                                    TopicName.TRANSACTION_COORDINATOR_ASSIGN.toString() + TopicName.PARTITIONED_TOPIC_SUFFIX + i);\n+                            CompletableFuture<Void> connectFuture = new CompletableFuture<>();\n+                            connectFutureList.add(connectFuture);\n+                            TransactionMetaStoreHandler handler = new TransactionMetaStoreHandler(\n+                                    i, pulsarClient, getTCAssignTopicName(i), connectFuture);\n                             handlers[i] = handler;\n                             handlerMap.put(i, handler);\n                         }\n                     } else {\n                         handlers = new TransactionMetaStoreHandler[1];\n+                        CompletableFuture<Void> connectFuture = new CompletableFuture<>();\n+                        connectFutureList.add(connectFuture);\n                         TransactionMetaStoreHandler handler = new TransactionMetaStoreHandler(0, pulsarClient,\n-                                TopicName.TRANSACTION_COORDINATOR_ASSIGN.toString());\n+                                getTCAssignTopicName(-1), connectFuture);\n                         handlers[0] = handler;\n                         handlerMap.put(0, handler);\n                     }\n \n                     STATE_UPDATER.set(TransactionCoordinatorClientImpl.this, State.READY);\n \n+                    return FutureUtil.waitForAll(connectFutureList);\n                 });\n         } else {\n             return FutureUtil.failedFuture(new CoordinatorClientStateException(\"Can not start while current state is \" + state));\n         }\n     }\n \n+    private String getTCAssignTopicName(int partition) {\n+        if (partition > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87931546be0edf217437f9b6884613682e70dee4"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2511ba693b083f5b4fd7c4613ad595e0d217d35", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/e2511ba693b083f5b4fd7c4613ad595e0d217d35", "committedDate": "2020-11-13T13:35:30Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMDg1MTY4", "url": "https://github.com/apache/pulsar/pull/8563#pullrequestreview-530085168", "createdAt": "2020-11-13T14:02:49Z", "commit": {"oid": "e2511ba693b083f5b4fd7c4613ad595e0d217d35"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1063, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}