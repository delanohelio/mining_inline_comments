{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNzA3MzEz", "number": 8101, "title": "[Issue 8093]Fix client lookup hangs when broker restarts", "bodyText": "Fixes #8093\nMotivation\nClient hangs forever when all brokers stop and then restart.\nThere are several steps need to be finished before the broker can be fully started, as illustrated in the pseudo code below:\nPulsarService#start():\n    broker.start(); // Step 1\n    webService.start(); // Step 2\n    leaderElectionService.start(); //Step 3\n\nIf a lookup request gets in between Step 2 and Step 3, a NPE would be thrown, which will block all other coming requests from getting processed properly.\nModifications\nClient can only connect to the broker after the election service started successfully\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\nThis change added tests and can be verified as follows:\n\n\n\nAdded 2 test cases under LeaderElectionServiceTest", "createdAt": "2020-09-22T05:54:01Z", "url": "https://github.com/apache/pulsar/pull/8101", "merged": true, "mergeCommit": {"oid": "65cf9c095ea20c0a546e77458274848094131163"}, "closed": true, "closedAt": "2020-09-24T07:04:00Z", "author": {"login": "4onni"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLRIqZgH2gAyNDkwNzA3MzEzOmNjZGU4ZjVjN2FiNTk4NjdiZTg5ODlkMThiMWU2MDVjOTFmNTZiODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL4ebHgH2gAyNDkwNzA3MzEzOjc0NTdlZWNjMmUxNTM4Y2VkMTk2NzQxMWJjOTdlNDY2ODVmMzA4NjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ccde8f5c7ab59867be8989d18b1e605c91f56b85", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/ccde8f5c7ab59867be8989d18b1e605c91f56b85", "committedDate": "2020-09-22T05:28:15Z", "message": "fixed client hangs in lookup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc2cdf08662bbb78cdc9d71892955247487cf936", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/fc2cdf08662bbb78cdc9d71892955247487cf936", "committedDate": "2020-09-22T05:34:30Z", "message": "added apache license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTkxMTEy", "url": "https://github.com/apache/pulsar/pull/8101#pullrequestreview-493191112", "createdAt": "2020-09-22T07:32:04Z", "commit": {"oid": "fc2cdf08662bbb78cdc9d71892955247487cf936"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzozMjowNFrOHVtedQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzozMjowNFrOHVtedQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyNzIyMQ==", "bodyText": "Thanks for the great contribution, I think it's better to return a retryable exception to the client? So that the client can reconnect later. Does this make sense?", "url": "https://github.com/apache/pulsar/pull/8101#discussion_r492527221", "createdAt": "2020-09-22T07:32:04Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/namespace/NamespaceService.java", "diffHunk": "@@ -400,6 +400,11 @@ public boolean registerNamespace(String namespace, boolean ensureOwned) throws P\n     private void searchForCandidateBroker(NamespaceBundle bundle,\n                                           CompletableFuture<Optional<LookupResult>> lookupFuture,\n                                           LookupOptions options) {\n+        if( null == pulsar.getLeaderElectionService() || ! pulsar.getLeaderElectionService().isElected()) {\n+            LOG.warn(\"The leader election has not yet been completed! NamespaceBundle[{}]\", bundle);\n+            lookupFuture.completeExceptionally(new IllegalStateException(\"The leader election has not yet been completed!\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc2cdf08662bbb78cdc9d71892955247487cf936"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMzEwMTg4", "url": "https://github.com/apache/pulsar/pull/8101#pullrequestreview-493310188", "createdAt": "2020-09-22T10:10:40Z", "commit": {"oid": "fc2cdf08662bbb78cdc9d71892955247487cf936"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNjExMDk2", "url": "https://github.com/apache/pulsar/pull/8101#pullrequestreview-493611096", "createdAt": "2020-09-22T15:52:27Z", "commit": {"oid": "fc2cdf08662bbb78cdc9d71892955247487cf936"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b77ee1d9a4afaff65856d1fc89753849080c810", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/7b77ee1d9a4afaff65856d1fc89753849080c810", "committedDate": "2020-09-23T03:11:29Z", "message": "Merge remote-tracking branch 'apache/master' into fix-lookup-hangs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7457eecc2e1538ced1967411bc97e46685f30866", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/7457eecc2e1538ced1967411bc97e46685f30866", "committedDate": "2020-09-24T03:18:19Z", "message": "Merge remote-tracking branch 'apache/master' into fix-lookup-hangs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 103, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}