{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMTQwNTY5", "number": 6716, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzo0MzoyNlrODw9-1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzo0NTo0NVrODw9_nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNjczNzUwOnYy", "diffSide": "RIGHT", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzo0MzoyN1rOGEO14w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQyMToxMzo0N1rOGEYv9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA5MDY1OQ==", "bodyText": "I think we need to move the configuration validation logic to right after line 86. Since it indicates iellgall configuration settings.", "url": "https://github.com/apache/pulsar/pull/6716#discussion_r407090659", "createdAt": "2020-04-11T17:43:27Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "diffHunk": "@@ -126,9 +137,40 @@ private static String validateToken(final String token) throws AuthenticationExc\n     @SuppressWarnings(\"unchecked\")\n     private Jwt<?, Claims> authenticateToken(final String token) throws AuthenticationException {\n         try {\n-            return Jwts.parser()\n+            Jwt<?, Claims> jwt = Jwts.parser()\n                     .setSigningKey(validationKey)\n                     .parse(token);\n+\n+            if (audienceClaim != null) {\n+                if (audience == null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI1Mjk4Mw==", "bodyText": "I think the check here should be moved to initialize method.", "url": "https://github.com/apache/pulsar/pull/6716#discussion_r407252983", "createdAt": "2020-04-12T21:13:47Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "diffHunk": "@@ -126,9 +137,40 @@ private static String validateToken(final String token) throws AuthenticationExc\n     @SuppressWarnings(\"unchecked\")\n     private Jwt<?, Claims> authenticateToken(final String token) throws AuthenticationException {\n         try {\n-            return Jwts.parser()\n+            Jwt<?, Claims> jwt = Jwts.parser()\n                     .setSigningKey(validationKey)\n                     .parse(token);\n+\n+            if (audienceClaim != null) {\n+                if (audience == null){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA5MDY1OQ=="}, "originalCommit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNjczOTAwOnYy", "diffSide": "RIGHT", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzo0NDo1N1rOGEO2kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxNDo1Mjo0OFrOGEWEwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA5MDgzMw==", "bodyText": "If the broker configures the audience claim and receives a token that doesn't contain the audience claim, we should throw AuthenticationException.", "url": "https://github.com/apache/pulsar/pull/6716#discussion_r407090833", "createdAt": "2020-04-11T17:44:57Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "diffHunk": "@@ -126,9 +137,40 @@ private static String validateToken(final String token) throws AuthenticationExc\n     @SuppressWarnings(\"unchecked\")\n     private Jwt<?, Claims> authenticateToken(final String token) throws AuthenticationException {\n         try {\n-            return Jwts.parser()\n+            Jwt<?, Claims> jwt = Jwts.parser()\n                     .setSigningKey(validationKey)\n                     .parse(token);\n+\n+            if (audienceClaim != null) {\n+                if (audience == null){\n+                    throw new JwtException(\"Token Audience Claim [\" + audienceClaim\n+                                           + \"] configured, but Audience stands for this broker not.\");\n+                }\n+\n+                Object object = jwt.getBody().get(audienceClaim);\n+                if (object == null) {\n+                    throw new JwtException(\"Found null Audience in token, for claimed field: \" + audienceClaim);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzIwOTE1Mw==", "bodyText": "Right. currently, the JwtException will be wrapped into a AuthenticationException in line 174 below.", "url": "https://github.com/apache/pulsar/pull/6716#discussion_r407209153", "createdAt": "2020-04-12T14:52:48Z", "author": {"login": "jiazhai"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "diffHunk": "@@ -126,9 +137,40 @@ private static String validateToken(final String token) throws AuthenticationExc\n     @SuppressWarnings(\"unchecked\")\n     private Jwt<?, Claims> authenticateToken(final String token) throws AuthenticationException {\n         try {\n-            return Jwts.parser()\n+            Jwt<?, Claims> jwt = Jwts.parser()\n                     .setSigningKey(validationKey)\n                     .parse(token);\n+\n+            if (audienceClaim != null) {\n+                if (audience == null){\n+                    throw new JwtException(\"Token Audience Claim [\" + audienceClaim\n+                                           + \"] configured, but Audience stands for this broker not.\");\n+                }\n+\n+                Object object = jwt.getBody().get(audienceClaim);\n+                if (object == null) {\n+                    throw new JwtException(\"Found null Audience in token, for claimed field: \" + audienceClaim);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA5MDgzMw=="}, "originalCommit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNjczOTQ4OnYy", "diffSide": "RIGHT", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzo0NTo0NVrOGEO20Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzo0NTo0NVrOGEO20Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA5MDg5Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                throw new AuthenticationException(\"Audiences in token is not in String format: \" + object);\n          \n          \n            \n                                throw new AuthenticationException(\"Audiences in token is not in expected format: \" + object);", "url": "https://github.com/apache/pulsar/pull/6716#discussion_r407090897", "createdAt": "2020-04-11T17:45:45Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "diffHunk": "@@ -126,9 +137,40 @@ private static String validateToken(final String token) throws AuthenticationExc\n     @SuppressWarnings(\"unchecked\")\n     private Jwt<?, Claims> authenticateToken(final String token) throws AuthenticationException {\n         try {\n-            return Jwts.parser()\n+            Jwt<?, Claims> jwt = Jwts.parser()\n                     .setSigningKey(validationKey)\n                     .parse(token);\n+\n+            if (audienceClaim != null) {\n+                if (audience == null){\n+                    throw new JwtException(\"Token Audience Claim [\" + audienceClaim\n+                                           + \"] configured, but Audience stands for this broker not.\");\n+                }\n+\n+                Object object = jwt.getBody().get(audienceClaim);\n+                if (object == null) {\n+                    throw new JwtException(\"Found null Audience in token, for claimed field: \" + audienceClaim);\n+                }\n+\n+                if (object instanceof List) {\n+                    List<String> audiences = (List<String>) object;\n+                    // audience not contains this broker, throw exception.\n+                    if (!audiences.stream().anyMatch(audienceInToken -> audienceInToken.equals(audience))) {\n+                        throw new AuthenticationException(\"Audiences in token: [\" + String.join(\", \", audiences)\n+                                                          + \"] not contains this broker: \" + audience);\n+                    }\n+                } else if (object instanceof String) {\n+                    if (!object.equals(audience)) {\n+                        throw new AuthenticationException(\"Audiences in token: [\" + object\n+                                                          + \"] not contains this broker: \" + audience);\n+                    }\n+                } else {\n+                    // should not reach here.\n+                    throw new AuthenticationException(\"Audiences in token is not in String format: \" + object);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1886, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}