{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MzI4NzM2", "number": 8635, "title": "Fix the pulsar sql can not query the last message issue", "bodyText": "Fixes #7811\nMotivation\nCurrently, the bookkeeper client gets the LAC is the piggyback lac which is carried by the next message. This causes the pulsar SQL connector will always get the message number -1 messages. If we want to query all messages, we need to use the explicit LAC to get the total number of entries.\nBookKeeper 4.12.0 makes us can use the useV2Protocol to enable using v3 protocol which will get the explicit LAC.\nModifications\n\nAdd the properties for the pulsar SQL.\nUpdate the integration test to query the last message.", "createdAt": "2020-11-20T00:25:20Z", "url": "https://github.com/apache/pulsar/pull/8635", "merged": true, "mergeCommit": {"oid": "50a81b22e97fa3717bf4753ec9e52aad9aaa6109"}, "closed": true, "closedAt": "2020-11-20T12:19:17Z", "author": {"login": "zymap"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdU_84HAH2gAyNTI0MzI4NzM2OjA1ODMzYTM4ZDNiNmM1MmUwZDc5YzUwYzM5ZjRjMTFkYjQxYWQ2ZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeMhcMgFqTUzNDk5NTA3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "05833a38d3b6c52e0d79c50c39f4c11db41ad6fa", "author": {"user": {"login": "zymap", "name": "Yong Zhang"}}, "url": "https://github.com/apache/pulsar/commit/05833a38d3b6c52e0d79c50c39f4c11db41ad6fa", "committedDate": "2020-10-22T11:06:14Z", "message": "Fix the presto sql integration test to let it query the last message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da18f630b7235efa97cd6c6b42601491feadec6a", "author": {"user": {"login": "zymap", "name": "Yong Zhang"}}, "url": "https://github.com/apache/pulsar/commit/da18f630b7235efa97cd6c6b42601491feadec6a", "committedDate": "2020-11-13T10:35:51Z", "message": "Update bookkeeper version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3044c8b50beac172e8ced8e2166e21d4cfe45b69", "author": {"user": {"login": "zymap", "name": "Yong Zhang"}}, "url": "https://github.com/apache/pulsar/commit/3044c8b50beac172e8ced8e2166e21d4cfe45b69", "committedDate": "2020-11-13T10:40:03Z", "message": "Merge branch 'master' into presto-last-message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3de49ff3b73dc4765d2606e7416a015d7bd04f2", "author": {"user": {"login": "zymap", "name": "Yong Zhang"}}, "url": "https://github.com/apache/pulsar/commit/a3de49ff3b73dc4765d2606e7416a015d7bd04f2", "committedDate": "2020-11-18T05:05:07Z", "message": "Merge remote-tracking branch 'apache/master' into presto-last-message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad138d7cccddc9fea84ba386093a7b7046ae3aa4", "author": {"user": {"login": "zymap", "name": "Yong Zhang"}}, "url": "https://github.com/apache/pulsar/commit/ad138d7cccddc9fea84ba386093a7b7046ae3aa4", "committedDate": "2020-11-18T05:18:55Z", "message": "Update the presto tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff77567c16221262f304719ca2d2ccc6ea1f7f47", "author": {"user": {"login": "zymap", "name": "Yong Zhang"}}, "url": "https://github.com/apache/pulsar/commit/ff77567c16221262f304719ca2d2ccc6ea1f7f47", "committedDate": "2020-11-18T05:22:25Z", "message": "Update the bkclient configuration in presto connector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "338f3ea64cc4536fa99bc4f9d620029aae2e2fb6", "author": {"user": {"login": "zymap", "name": "Yong Zhang"}}, "url": "https://github.com/apache/pulsar/commit/338f3ea64cc4536fa99bc4f9d620029aae2e2fb6", "committedDate": "2020-11-20T00:15:20Z", "message": "Fix the sql tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTg2Nzg3", "url": "https://github.com/apache/pulsar/pull/8635#pullrequestreview-534986787", "createdAt": "2020-11-20T00:27:41Z", "commit": {"oid": "338f3ea64cc4536fa99bc4f9d620029aae2e2fb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTkwNDI1", "url": "https://github.com/apache/pulsar/pull/8635#pullrequestreview-534990425", "createdAt": "2020-11-20T00:37:29Z", "commit": {"oid": "338f3ea64cc4536fa99bc4f9d620029aae2e2fb6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMDozNzozMFrOH24aWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMDo0MTo1OFrOH24pqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMwOTQwMw==", "bodyText": "I think we already have this config in the broker.conf https://github.com/apache/pulsar/blob/master/conf/broker.conf#L680", "url": "https://github.com/apache/pulsar/pull/8635#discussion_r527309403", "createdAt": "2020-11-20T00:37:30Z", "author": {"login": "codelipenghui"}, "path": "conf/broker.conf", "diffHunk": "@@ -774,6 +774,9 @@ bookkeeperDiskWeightBasedPlacementEnabled=false\n # A value of '0' disables sending any explicit LACs. Default is 0.\n bookkeeperExplicitLacIntervalInMills=0\n \n+  # Use older Bookkeeper wire protocol with bookie\n+bookkeeperUseV2WireProtocol=true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "338f3ea64cc4536fa99bc4f9d620029aae2e2fb6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMxMzA4NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private boolean useV2Protocol = true;\n          \n          \n            \n                private boolean bookkeeperUseV2Protocol = true;", "url": "https://github.com/apache/pulsar/pull/8635#discussion_r527313085", "createdAt": "2020-11-20T00:41:43Z", "author": {"login": "codelipenghui"}, "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarConnectorConfig.java", "diffHunk": "@@ -72,6 +72,8 @@\n     private int bookkeeperThrottleValue = 0;\n     private int bookkeeperNumIOThreads = 2 * Runtime.getRuntime().availableProcessors();\n     private int bookkeeperNumWorkerThreads = Runtime.getRuntime().availableProcessors();\n+    private boolean useV2Protocol = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "338f3ea64cc4536fa99bc4f9d620029aae2e2fb6"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMxMzMyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private int explicitInterval = 0;\n          \n          \n            \n                private int bookkeeperExplicitInterval = 0;", "url": "https://github.com/apache/pulsar/pull/8635#discussion_r527313322", "createdAt": "2020-11-20T00:41:58Z", "author": {"login": "codelipenghui"}, "path": "pulsar-sql/presto-pulsar/src/main/java/org/apache/pulsar/sql/presto/PulsarConnectorConfig.java", "diffHunk": "@@ -72,6 +72,8 @@\n     private int bookkeeperThrottleValue = 0;\n     private int bookkeeperNumIOThreads = 2 * Runtime.getRuntime().availableProcessors();\n     private int bookkeeperNumWorkerThreads = Runtime.getRuntime().availableProcessors();\n+    private boolean useV2Protocol = true;\n+    private int explicitInterval = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "338f3ea64cc4536fa99bc4f9d620029aae2e2fb6"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d0d4a3eee4ae3c3ef6842f29a699f57bf35ba8b", "author": {"user": {"login": "zymap", "name": "Yong Zhang"}}, "url": "https://github.com/apache/pulsar/commit/6d0d4a3eee4ae3c3ef6842f29a699f57bf35ba8b", "committedDate": "2020-11-20T00:46:59Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTk1MDcy", "url": "https://github.com/apache/pulsar/pull/8635#pullrequestreview-534995072", "createdAt": "2020-11-20T00:50:21Z", "commit": {"oid": "6d0d4a3eee4ae3c3ef6842f29a699f57bf35ba8b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1111, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}