{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNDc3MDU4", "number": 8561, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDo0NzoyNFrOE4saNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODoxNjo0MFrOE5nbgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3ODgzMzE5OnYy", "diffSide": "RIGHT", "path": "conf/broker.conf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNDo0NzoyNFrOHyxKlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNToyNTo0NlrOHyyt2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk5NjM3NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # If it is 0 or less, the fenced topic will not be closed.\n          \n          \n            \n            # If it is set to 0 or a negative number, the fenced topic will not be closed.", "url": "https://github.com/apache/pulsar/pull/8561#discussion_r522996374", "createdAt": "2020-11-13T14:47:24Z", "author": {"login": "Huanli-Meng"}, "path": "conf/broker.conf", "diffHunk": "@@ -452,6 +452,10 @@ systemTopicEnabled=false\n # Please enable the system topic first.\n topicLevelPoliciesEnabled=false\n \n+# If a topic remains fenced for this number of seconds, it will be closed forcefully.\n+# If it is 0 or less, the fenced topic will not be closed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7a1c4616e6f27ac9fb6950088da0d9f55ebdeed"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAyMTc4NA==", "bodyText": "Fixed.", "url": "https://github.com/apache/pulsar/pull/8561#discussion_r523021784", "createdAt": "2020-11-13T15:25:46Z", "author": {"login": "massakam"}, "path": "conf/broker.conf", "diffHunk": "@@ -452,6 +452,10 @@ systemTopicEnabled=false\n # Please enable the system topic first.\n topicLevelPoliciesEnabled=false\n \n+# If a topic remains fenced for this number of seconds, it will be closed forcefully.\n+# If it is 0 or less, the fenced topic will not be closed.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk5NjM3NA=="}, "originalCommit": {"oid": "a7a1c4616e6f27ac9fb6950088da0d9f55ebdeed"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4ODUwMzA1OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODoxNjo0MVrOH0LfrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjozNDo1N1rOH0iE7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3NjMzMw==", "bodyText": "Do we need to put close in the synchronized block?", "url": "https://github.com/apache/pulsar/pull/8561#discussion_r524476333", "createdAt": "2020-11-16T18:16:41Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -2384,6 +2387,40 @@ public boolean isSystemTopic() {\n         return false;\n     }\n \n+    private synchronized void fence() {\n+        isFenced = true;\n+        ScheduledFuture<?> monitoringTask = this.fencedTopicMonitoringTask;\n+        if (monitoringTask == null || monitoringTask.isDone()) {\n+            final int timeout = brokerService.pulsar().getConfiguration().getTopicFencingTimeoutSeconds();\n+            if (timeout > 0) {\n+                this.fencedTopicMonitoringTask = brokerService.executor().schedule(this::closeFencedTopicForcefully,\n+                        timeout, TimeUnit.SECONDS);\n+            }\n+        }\n+    }\n+\n+    private synchronized void unfence() {\n+        isFenced = false;\n+        ScheduledFuture<?> monitoringTask = this.fencedTopicMonitoringTask;\n+        if (monitoringTask != null && !monitoringTask.isDone()) {\n+            monitoringTask.cancel(false);\n+        }\n+    }\n+\n+    private synchronized void closeFencedTopicForcefully() {\n+        if (isFenced) {\n+            final int timeout = brokerService.pulsar().getConfiguration().getTopicFencingTimeoutSeconds();\n+            if (isClosingOrDeleting) {\n+                log.warn(\"[{}] Topic remained fenced for {} seconds and is already closed (pendingWriteOps: {})\", topic,\n+                        timeout, pendingWriteOps.get());\n+            } else {\n+                log.error(\"[{}] Topic remained fenced for {} seconds, so close it (pendingWriteOps: {})\", topic,\n+                        timeout, pendingWriteOps.get());\n+                close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef5b71067709c4ee49da31809fb0c05ce4dfaad9"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0NjMxOQ==", "bodyText": "I removed \"synchronized\" because there was no clear reason to make this method synchronized.", "url": "https://github.com/apache/pulsar/pull/8561#discussion_r524846319", "createdAt": "2020-11-17T02:34:57Z", "author": {"login": "massakam"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -2384,6 +2387,40 @@ public boolean isSystemTopic() {\n         return false;\n     }\n \n+    private synchronized void fence() {\n+        isFenced = true;\n+        ScheduledFuture<?> monitoringTask = this.fencedTopicMonitoringTask;\n+        if (monitoringTask == null || monitoringTask.isDone()) {\n+            final int timeout = brokerService.pulsar().getConfiguration().getTopicFencingTimeoutSeconds();\n+            if (timeout > 0) {\n+                this.fencedTopicMonitoringTask = brokerService.executor().schedule(this::closeFencedTopicForcefully,\n+                        timeout, TimeUnit.SECONDS);\n+            }\n+        }\n+    }\n+\n+    private synchronized void unfence() {\n+        isFenced = false;\n+        ScheduledFuture<?> monitoringTask = this.fencedTopicMonitoringTask;\n+        if (monitoringTask != null && !monitoringTask.isDone()) {\n+            monitoringTask.cancel(false);\n+        }\n+    }\n+\n+    private synchronized void closeFencedTopicForcefully() {\n+        if (isFenced) {\n+            final int timeout = brokerService.pulsar().getConfiguration().getTopicFencingTimeoutSeconds();\n+            if (isClosingOrDeleting) {\n+                log.warn(\"[{}] Topic remained fenced for {} seconds and is already closed (pendingWriteOps: {})\", topic,\n+                        timeout, pendingWriteOps.get());\n+            } else {\n+                log.error(\"[{}] Topic remained fenced for {} seconds, so close it (pendingWriteOps: {})\", topic,\n+                        timeout, pendingWriteOps.get());\n+                close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3NjMzMw=="}, "originalCommit": {"oid": "ef5b71067709c4ee49da31809fb0c05ce4dfaad9"}, "originalPosition": 68}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2790, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}