{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3OTQ2MjM4", "number": 8493, "title": "[Transaction] Register transaction metadata before send or ack messages", "bodyText": "Fixes streamnative#1659\nMotivation\nThe transaction metadata registration should be the precondition of send or ack transaction messages, this guarantees TC could notify all related topic partitions and subscriptions successfully.\nModifications\n\nRegister topic partition info to TC before sending transaction messages.\nRegister subscription info to TC before ack transaction messages.\n\nVerifying this change\nThis change is already covered by existing tests.\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (no)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)", "createdAt": "2020-11-09T18:12:00Z", "url": "https://github.com/apache/pulsar/pull/8493", "merged": true, "mergeCommit": {"oid": "812166b9d82ca1ce8261b557e58c93191e34cf1c"}, "closed": true, "closedAt": "2020-11-13T01:31:32Z", "author": {"login": "gaoran10"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbE9ApgFqTUyNjk1MjQ2Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb0K-5gH2gAyNTE3OTQ2MjM4OmQ1ODE4MmZkN2RmYTQzNDhlM2VlY2VjYzhlMWNjNjQ2NzU0YWU1ZTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2OTUyNDYz", "url": "https://github.com/apache/pulsar/pull/8493#pullrequestreview-526952463", "createdAt": "2020-11-10T08:19:22Z", "commit": {"oid": "5649d3408992d00fec302cb48771fed0494ce89f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwODoxOToyM1rOHwQ0mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwODoxOToyM1rOHwQ0mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM2OTMwNQ==", "bodyText": "Should we handle the exception here? If the metadata register failed, we can't send message or ack", "url": "https://github.com/apache/pulsar/pull/8493#discussion_r520369305", "createdAt": "2020-11-10T08:19:23Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerBase.java", "diffHunk": "@@ -473,30 +473,34 @@ public void negativeAcknowledge(Message<?> message) {\n     protected CompletableFuture<Void> doAcknowledgeWithTxn(List<MessageId> messageIdList, AckType ackType,\n                                                            Map<String,Long> properties,\n                                                            TransactionImpl txn) {\n-        CompletableFuture<Void> ackFuture = doAcknowledge(messageIdList, ackType, properties, txn);\n+        CompletableFuture<Void> ackFuture;\n         if (txn != null) {\n-            txn.registerAckedTopic(getTopic(), subscription);\n-            return txn.registerAckOp(ackFuture);\n+            ackFuture = txn.registerAckedTopic(getTopic(), subscription)\n+                    .thenCompose(ignored -> doAcknowledge(messageIdList, ackType, properties, txn));\n+            txn.registerAckOp(ackFuture);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5649d3408992d00fec302cb48771fed0494ce89f"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Mjg3NTY2", "url": "https://github.com/apache/pulsar/pull/8493#pullrequestreview-527287566", "createdAt": "2020-11-10T14:57:10Z", "commit": {"oid": "5649d3408992d00fec302cb48771fed0494ce89f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4f1f6326e752cae1b8f9cbdd0f1eb868e0159ba", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/d4f1f6326e752cae1b8f9cbdd0f1eb868e0159ba", "committedDate": "2020-11-10T15:36:55Z", "message": "fix test"}, "afterCommit": {"oid": "522489bac39a84b9af7391d2b2ea045b8d37567e", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/522489bac39a84b9af7391d2b2ea045b8d37567e", "committedDate": "2020-11-11T07:42:57Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2e7f438477ca3081ad9d05c7eb59d1ad03759fe", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/a2e7f438477ca3081ad9d05c7eb59d1ad03759fe", "committedDate": "2020-11-12T03:56:35Z", "message": "register transaction metadata before send transaction messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40e637eceb6d8056521679133b3421c85305e5b4", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/40e637eceb6d8056521679133b3421c85305e5b4", "committedDate": "2020-11-12T03:56:35Z", "message": "register transaction metadata before ack transaction messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd1fc52a5ec65a9cca2186a3d588e11ed9a9d53c", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/dd1fc52a5ec65a9cca2186a3d588e11ed9a9d53c", "committedDate": "2020-11-12T03:56:35Z", "message": "fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a18f29dee46d353f6f89bdf9364a08f28e7942a3", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/a18f29dee46d353f6f89bdf9364a08f28e7942a3", "committedDate": "2020-11-11T09:17:56Z", "message": "fix checkstyle"}, "afterCommit": {"oid": "dd1fc52a5ec65a9cca2186a3d588e11ed9a9d53c", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/dd1fc52a5ec65a9cca2186a3d588e11ed9a9d53c", "committedDate": "2020-11-12T03:56:35Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d58182fd7dfa4348e3eececc8e1cc646754ae5e4", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/d58182fd7dfa4348e3eececc8e1cc646754ae5e4", "committedDate": "2020-11-12T15:20:15Z", "message": "fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1187, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}