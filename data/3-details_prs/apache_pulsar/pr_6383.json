{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3ODMwMzgz", "number": 6383, "title": "[Issue 6043] Support force deleting subscription", "bodyText": "Motivation\nFixes #6043\nModifications\nAdd method deleteForcefully to support force deleting subscription.", "createdAt": "2020-02-20T15:45:12Z", "url": "https://github.com/apache/pulsar/pull/6383", "merged": true, "mergeCommit": {"oid": "525f9e9a0bc53b1282447e50f0fa93570d2af32b"}, "closed": true, "closedAt": "2020-03-25T01:42:21Z", "author": {"login": "murong00"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGtxeqAFqTM2MzAxMTg3Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ9adlgFqTM4MDgwODU2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDExODcz", "url": "https://github.com/apache/pulsar/pull/6383#pullrequestreview-363011873", "createdAt": "2020-02-22T05:44:04Z", "commit": {"oid": "09e62b47cc0a2cb5a3d100d26200a13a75922e46"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwNTo0NDowNFrOFtJrtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwNTo0NDowNFrOFtJrtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4ODg4NQ==", "bodyText": "This will be a flaky test since the consumer can create a subscription when they reconnect to the broker.", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r382888885", "createdAt": "2020-02-22T05:44:04Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java", "diffHunk": "@@ -1304,6 +1304,46 @@ public void testNamespaceBundleUnload(Integer numBundles) throws Exception {\n         admin.topics().delete(\"persistent://prop-xyz/ns1-bundles/ds2\");\n     }\n \n+    @Test(dataProvider = \"topicName\")\n+    public void testDeleteSubscription(String topicName) throws Exception {\n+        final String subName = topicName;\n+        final String persistentTopicName = \"persistent://prop-xyz/ns1/\" + topicName;\n+\n+        // create a topic and produce some messages\n+        publishMessagesOnPersistentTopic(\"persistent://prop-xyz/ns1/\" + topicName, 5);\n+        assertEquals(admin.topics().getList(\"prop-xyz/ns1\"),\n+            Lists.newArrayList(\"persistent://prop-xyz/ns1/\" + topicName));\n+\n+        // create consumer and subscription\n+        PulsarClient client = PulsarClient.builder()\n+            .serviceUrl(pulsar.getWebServiceAddress())\n+            .statsInterval(0, TimeUnit.SECONDS)\n+            .build();\n+        Consumer<byte[]> consumer = client.newConsumer().topic(persistentTopicName).subscriptionName(subName)\n+            .subscriptionType(SubscriptionType.Exclusive).subscribe();\n+\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName), Lists.newArrayList(subName));\n+\n+        // try to delete the subscription with a connected consumer\n+        try {\n+            admin.topics().deleteSubscription(persistentTopicName, subName);\n+            fail(\"should have failed\");\n+        } catch (PulsarAdminException.PreconditionFailedException e) {\n+            assertEquals(e.getStatusCode(), Status.PRECONDITION_FAILED.getStatusCode());\n+        }\n+\n+        // failed to delete the subscription\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName), Lists.newArrayList(subName));\n+\n+        // try to delete the subscription with a connected consumer forcefully\n+        admin.topics().deleteSubscription(persistentTopicName, subName, true);\n+\n+        // delete the subscription successfully\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName).size(), 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09e62b47cc0a2cb5a3d100d26200a13a75922e46"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09e62b47cc0a2cb5a3d100d26200a13a75922e46", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/09e62b47cc0a2cb5a3d100d26200a13a75922e46", "committedDate": "2020-02-22T05:35:46Z", "message": "Merge remote-tracking branch 'apache/master' into branch-6383"}, "afterCommit": {"oid": "f3265040817ac985410292ee55e86567e1f90cfc", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/f3265040817ac985410292ee55e86567e1f90cfc", "committedDate": "2020-02-25T07:13:00Z", "message": "Fix a flaky test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3265040817ac985410292ee55e86567e1f90cfc", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/f3265040817ac985410292ee55e86567e1f90cfc", "committedDate": "2020-02-25T07:13:00Z", "message": "Fix a flaky test"}, "afterCommit": {"oid": "7ec207d019ef687e6d5540d42380635ecfa94809", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/7ec207d019ef687e6d5540d42380635ecfa94809", "committedDate": "2020-03-05T03:55:00Z", "message": "Improve the unit test to cover force deleting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTQ4Mjk3", "url": "https://github.com/apache/pulsar/pull/6383#pullrequestreview-369548297", "createdAt": "2020-03-05T13:02:17Z", "commit": {"oid": "7ec207d019ef687e6d5540d42380635ecfa94809"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzowNTowNlrOFySt-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzoxMjo1M1rOFyS8iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI3OTgwMw==", "bodyText": "Should handle exception here since we need to resume the asyncResponse", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r388279803", "createdAt": "2020-03-05T13:05:06Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -1032,6 +1040,73 @@ private void internalDeleteSubscriptionForNonPartitionedTopic(AsyncResponse asyn\n         }\n     }\n \n+    protected void internalDeleteSubscriptionForcefully(AsyncResponse asyncResponse, String subName, boolean authoritative) {\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        // If the topic name is a partition name, no need to get partition topic metadata again\n+        if (topicName.isPartitioned()) {\n+            internalDeleteSubscriptionForNonPartitionedTopicForcefully(asyncResponse, subName, authoritative);\n+        } else {\n+            PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);\n+            if (partitionMetadata.partitions > 0) {\n+                final List<CompletableFuture<Void>> futures = Lists.newArrayList();\n+\n+                for (int i = 0; i < partitionMetadata.partitions; i++) {\n+                    TopicName topicNamePartition = topicName.getPartition(i);\n+                    try {\n+                        futures.add(pulsar().getAdminClient().topics()\n+                            .deleteSubscriptionAsync(topicNamePartition.toString(), subName, true));\n+                    } catch (Exception e) {\n+                        log.error(\"[{}] Failed to delete subscription forcefully {} {}\", clientAppId(), topicNamePartition, subName,\n+                            e);\n+                        asyncResponse.resume(new RestException(e));\n+                        return;\n+                    }\n+                }\n+\n+                FutureUtil.waitForAll(futures).handle((result, exception) -> {\n+                    if (exception != null) {\n+                        Throwable t = exception.getCause();\n+                        if (t instanceof NotFoundException) {\n+                            asyncResponse.resume(new RestException(Status.NOT_FOUND, \"Subscription not found\"));\n+                            return null;\n+                        } else {\n+                            log.error(\"[{}] Failed to delete subscription forcefully {} {}\", clientAppId(), topicName, subName, t);\n+                            asyncResponse.resume(new RestException(t));\n+                            return null;\n+                        }\n+                    }\n+\n+                    asyncResponse.resume(Response.noContent().build());\n+                    return null;\n+                });\n+            } else {\n+                internalDeleteSubscriptionForNonPartitionedTopicForcefully(asyncResponse, subName, authoritative);\n+            }\n+        }\n+    }\n+\n+    private void internalDeleteSubscriptionForNonPartitionedTopicForcefully(AsyncResponse asyncResponse, String subName, boolean authoritative) {\n+        validateAdminAccessForSubscriber(subName, authoritative);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ec207d019ef687e6d5540d42380635ecfa94809"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4MzUyOQ==", "bodyText": "Should handle exception here since we need to resume the asyncResponse", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r388283529", "createdAt": "2020-03-05T13:12:53Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -1032,6 +1040,73 @@ private void internalDeleteSubscriptionForNonPartitionedTopic(AsyncResponse asyn\n         }\n     }\n \n+    protected void internalDeleteSubscriptionForcefully(AsyncResponse asyncResponse, String subName, boolean authoritative) {\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        // If the topic name is a partition name, no need to get partition topic metadata again\n+        if (topicName.isPartitioned()) {\n+            internalDeleteSubscriptionForNonPartitionedTopicForcefully(asyncResponse, subName, authoritative);\n+        } else {\n+            PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ec207d019ef687e6d5540d42380635ecfa94809"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9b461cc771cfe485959ba8ada764858eda7a65e", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/d9b461cc771cfe485959ba8ada764858eda7a65e", "committedDate": "2020-03-08T06:57:40Z", "message": "Support force deleting subscription."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62924a18d4f273bb4618c4fc69376028e5f120a3", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/62924a18d4f273bb4618c4fc69376028e5f120a3", "committedDate": "2020-03-08T06:58:52Z", "message": "Fix a unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de4eb0fe429361d983366cbc26312f4c4aa606be", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/de4eb0fe429361d983366cbc26312f4c4aa606be", "committedDate": "2020-03-08T06:58:52Z", "message": "Fix a flaky test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7452bcab9cbc77e5dc877d22a0ea158de4ce9715", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/7452bcab9cbc77e5dc877d22a0ea158de4ce9715", "committedDate": "2020-03-08T06:58:53Z", "message": "Improve the unit test to cover force deleting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07a222ed9e5b9a5411325f3a30b032fe2a20c737", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/07a222ed9e5b9a5411325f3a30b032fe2a20c737", "committedDate": "2020-03-08T07:32:16Z", "message": "Address penghui's comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ec207d019ef687e6d5540d42380635ecfa94809", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/7ec207d019ef687e6d5540d42380635ecfa94809", "committedDate": "2020-03-05T03:55:00Z", "message": "Improve the unit test to cover force deleting"}, "afterCommit": {"oid": "07a222ed9e5b9a5411325f3a30b032fe2a20c737", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/07a222ed9e5b9a5411325f3a30b032fe2a20c737", "committedDate": "2020-03-08T07:32:16Z", "message": "Address penghui's comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwODE1OTg5", "url": "https://github.com/apache/pulsar/pull/6383#pullrequestreview-370815989", "createdAt": "2020-03-08T09:23:09Z", "commit": {"oid": "07a222ed9e5b9a5411325f3a30b032fe2a20c737"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwOTYzODQw", "url": "https://github.com/apache/pulsar/pull/6383#pullrequestreview-370963840", "createdAt": "2020-03-09T07:48:13Z", "commit": {"oid": "07a222ed9e5b9a5411325f3a30b032fe2a20c737"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNzo0ODoxNFrOFzdU5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNzo0ODoxNFrOFzdU5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUwMjE4Mw==", "bodyText": "This is an API breaking change. You can't directly change the method signature. Please add an override method.", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r389502183", "createdAt": "2020-03-09T07:48:14Z", "author": {"login": "sijie"}, "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java", "diffHunk": "@@ -801,10 +825,12 @@ PartitionedTopicInternalStats getPartitionedInternalStats(String topic)\n      *            topic name\n      * @param subName\n      *            Subscription name\n+     * @param force\n+     *            Delete topic forcefully\n      *\n      * @return a future that can be used to track when the subscription is deleted\n      */\n-    CompletableFuture<Void> deleteSubscriptionAsync(String topic, String subName);\n+    CompletableFuture<Void> deleteSubscriptionAsync(String topic, String subName, boolean force);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07a222ed9e5b9a5411325f3a30b032fe2a20c737"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "221b91f97b5e88d83356e74c3c9c9215705d10de", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/221b91f97b5e88d83356e74c3c9c9215705d10de", "committedDate": "2020-03-09T11:27:51Z", "message": "Add an override method to avoid API breaking change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwODA4NTY4", "url": "https://github.com/apache/pulsar/pull/6383#pullrequestreview-380808568", "createdAt": "2020-03-25T01:41:59Z", "commit": {"oid": "221b91f97b5e88d83356e74c3c9c9215705d10de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 84, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}