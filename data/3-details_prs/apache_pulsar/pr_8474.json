{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MDgzNzEz", "number": 8474, "title": "Support taking de-duplication snapshots based on time", "bodyText": "Master Issue: #8237\nMotivation\nCurrently we take de-duplication snapshots based on size. If the topic has relatively low traffic, the de-duplication cursor will not move. This can cause messages that are not able to be deleted based on the retention policy. We should add a policy to take de-duplication snapshots based on time.\nModifications\nadd a monitor to take snapshot base on time\nVerifying this change\nTopicDuplicationTest#testDuplicationSnapshot", "createdAt": "2020-11-07T04:38:19Z", "url": "https://github.com/apache/pulsar/pull/8474", "merged": true, "mergeCommit": {"oid": "c989661503e08b3704627368ffa386ff2eef84f4"}, "closed": true, "closedAt": "2020-11-09T03:22:14Z", "author": {"login": "315157973"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaD-_XgH2gAyNTE3MDgzNzEzOmI5MjBkMGIxN2Y1MmQ2MzgzNTg0ODY4OGE1MjkxNTRkZGU0ZDE5YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdapmkVAFqTUyNTg2NDA0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b920d0b17f52d63835848688a529154dde4d19a5", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/b920d0b17f52d63835848688a529154dde4d19a5", "committedDate": "2020-11-07T04:37:47Z", "message": "support check deduplication snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b969a135a47947be86c6f56a508d8696872fa66d", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/b969a135a47947be86c6f56a508d8696872fa66d", "committedDate": "2020-11-07T04:40:43Z", "message": "change spell"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab07b76d7b48aa47c90f5ea6c6c70c9af2313b7b", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/ab07b76d7b48aa47c90f5ea6c6c70c9af2313b7b", "committedDate": "2020-11-07T06:38:30Z", "message": "add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1b2b2f028b31c3fb94d9663f8dc9b55e9f3bd9", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/1d1b2b2f028b31c3fb94d9663f8dc9b55e9f3bd9", "committedDate": "2020-11-07T19:28:40Z", "message": "use LAC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b81743f7cb566ddc709ccdd43fbe7e5c088fd23e", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/b81743f7cb566ddc709ccdd43fbe7e5c088fd23e", "committedDate": "2020-11-08T05:24:22Z", "message": "fix npe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Nzk3MTEy", "url": "https://github.com/apache/pulsar/pull/8474#pullrequestreview-525797112", "createdAt": "2020-11-08T11:08:46Z", "commit": {"oid": "b81743f7cb566ddc709ccdd43fbe7e5c088fd23e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQxMTowODo0NlrOHvSzxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQxMToxMjoxNVrOHvS4qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1MzI4NQ==", "bodyText": "Can we save creating the pool if the feature is disabled", "url": "https://github.com/apache/pulsar/pull/8474#discussion_r519353285", "createdAt": "2020-11-08T11:08:46Z", "author": {"login": "eolivelli"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -297,6 +298,8 @@ public BrokerService(PulsarService pulsar) throws Exception {\n                 .newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"consumed-Ledgers-monitor\"));\n         this.ledgerFullMonitor =\n                 Executors.newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"ledger-full-monitor\"));\n+        this.deduplicationSnapshotMonitor =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81743f7cb566ddc709ccdd43fbe7e5c088fd23e"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1MzczMA==", "bodyText": "It looks like we are not shutting down the pool, leaking threads", "url": "https://github.com/apache/pulsar/pull/8474#discussion_r519353730", "createdAt": "2020-11-08T11:10:03Z", "author": {"login": "eolivelli"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -297,6 +298,8 @@ public BrokerService(PulsarService pulsar) throws Exception {\n                 .newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"consumed-Ledgers-monitor\"));\n         this.ledgerFullMonitor =\n                 Executors.newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"ledger-full-monitor\"));\n+        this.deduplicationSnapshotMonitor =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1MzI4NQ=="}, "originalCommit": {"oid": "b81743f7cb566ddc709ccdd43fbe7e5c088fd23e"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1NDUzNw==", "bodyText": "Why Integer and not int?", "url": "https://github.com/apache/pulsar/pull/8474#discussion_r519354537", "createdAt": "2020-11-08T11:12:15Z", "author": {"login": "eolivelli"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -413,6 +413,18 @@\n     )\n     private int brokerDeduplicationMaxNumberOfProducers = 10000;\n \n+    @FieldContext(\n+        category = CATEGORY_POLICIES,\n+        doc = \"How often is the thread pool scheduled to check whether a snapshot needs to be taken.(disable with value 0)\"\n+    )\n+    private int brokerDeduplicationSnapshotFrequencyInSeconds = 120;\n+    @FieldContext(\n+        category = CATEGORY_POLICIES,\n+        doc = \"If this time interval is exceeded, a snapshot will be taken.\"\n+            + \"It will run simultaneously with `brokerDeduplicationEntriesInterval`\"\n+    )\n+    private Integer brokerDeduplicationSnapshotIntervalSeconds = 120;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81743f7cb566ddc709ccdd43fbe7e5c088fd23e"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70a1c83edda4a779785175ada4029b9b58c71a9a", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/70a1c83edda4a779785175ada4029b9b58c71a9a", "committedDate": "2020-11-08T11:20:43Z", "message": "fix npe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODY0MDQ0", "url": "https://github.com/apache/pulsar/pull/8474#pullrequestreview-525864044", "createdAt": "2020-11-09T00:27:30Z", "commit": {"oid": "70a1c83edda4a779785175ada4029b9b58c71a9a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1182, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}