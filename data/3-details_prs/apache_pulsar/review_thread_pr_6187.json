{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwMDk4NTY1", "number": 6187, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNDowNDozMFrODcg78Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDozODoyOVrODd4L_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMjI2MzUzOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNDowNDozMFrOFkl8cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMToyMzoxM1rOFkuLSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkxNDczOQ==", "bodyText": "Are these codes to be deleted?", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r373914739", "createdAt": "2020-02-03T04:04:30Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,65 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+//    protected void internalUnloadTopic(boolean authoritative) {\n+//        log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n+//        if (topicName.isGlobal()) {\n+//            validateGlobalNamespaceOwnership(namespaceName);\n+//        }\n+//        unloadTopic(topicName, authoritative);\n+//    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98dfd5d3348a1d26e10716052209157ec0d8db7e"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA0OTYwOQ==", "bodyText": "Yes, I will fix it.", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r374049609", "createdAt": "2020-02-03T11:23:13Z", "author": {"login": "ltamber"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,65 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+//    protected void internalUnloadTopic(boolean authoritative) {\n+//        log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n+//        if (topicName.isGlobal()) {\n+//            validateGlobalNamespaceOwnership(namespaceName);\n+//        }\n+//        unloadTopic(topicName, authoritative);\n+//    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkxNDczOQ=="}, "originalCommit": {"oid": "98dfd5d3348a1d26e10716052209157ec0d8db7e"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMjg3NTcwOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo1MTowMFrOFkrlaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMToyMzozNlrOFkuMAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAwNzE0NQ==", "bodyText": "validateAdminAccessForTenant or lower validate maybe better?", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r374007145", "createdAt": "2020-02-03T09:51:00Z", "author": {"login": "jiazhai"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,65 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+//    protected void internalUnloadTopic(boolean authoritative) {\n+//        log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n+//        if (topicName.isGlobal()) {\n+//            validateGlobalNamespaceOwnership(namespaceName);\n+//        }\n+//        unloadTopic(topicName, authoritative);\n+//    }\n+\n+    protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {\n         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n         }\n-        unloadTopic(topicName, authoritative);\n+\n+        PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);\n+        if (partitionMetadata.partitions > 0) {\n+            final List<CompletableFuture<Void>> futures = Lists.newArrayList();\n+\n+            for (int i = 0; i < partitionMetadata.partitions; i++) {\n+                TopicName topicNamePartition = topicName.getPartition(i);\n+                try {\n+                    futures.add(pulsar().getAdminClient().topics().unloadAsync(topicNamePartition.toString()));\n+                } catch (Exception e) {\n+                    log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicNamePartition, e);\n+                    asyncResponse.resume(new RestException(e));\n+                    return;\n+                }\n+            }\n+\n+            FutureUtil.waitForAll(futures).handle((result, exception) -> {\n+                if (exception != null) {\n+                    Throwable t = exception.getCause();\n+                    if (t instanceof NotFoundException) {\n+                        asyncResponse.resume(new RestException(Status.NOT_FOUND, t.getMessage()));\n+                        return null;\n+                    } else {\n+                        log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicName, exception);\n+                        asyncResponse.resume(new RestException(exception));\n+                        return null;\n+                    }\n+                }\n+\n+                asyncResponse.resume(Response.noContent().build());\n+                return null;\n+            });\n+        } else {\n+            validateSuperUserAccess();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c690c4773efa6b07323e73c3b858849901cd3c97"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA0OTc5Mg==", "bodyText": "ok", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r374049792", "createdAt": "2020-02-03T11:23:36Z", "author": {"login": "ltamber"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,65 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+//    protected void internalUnloadTopic(boolean authoritative) {\n+//        log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n+//        if (topicName.isGlobal()) {\n+//            validateGlobalNamespaceOwnership(namespaceName);\n+//        }\n+//        unloadTopic(topicName, authoritative);\n+//    }\n+\n+    protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {\n         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n         }\n-        unloadTopic(topicName, authoritative);\n+\n+        PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);\n+        if (partitionMetadata.partitions > 0) {\n+            final List<CompletableFuture<Void>> futures = Lists.newArrayList();\n+\n+            for (int i = 0; i < partitionMetadata.partitions; i++) {\n+                TopicName topicNamePartition = topicName.getPartition(i);\n+                try {\n+                    futures.add(pulsar().getAdminClient().topics().unloadAsync(topicNamePartition.toString()));\n+                } catch (Exception e) {\n+                    log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicNamePartition, e);\n+                    asyncResponse.resume(new RestException(e));\n+                    return;\n+                }\n+            }\n+\n+            FutureUtil.waitForAll(futures).handle((result, exception) -> {\n+                if (exception != null) {\n+                    Throwable t = exception.getCause();\n+                    if (t instanceof NotFoundException) {\n+                        asyncResponse.resume(new RestException(Status.NOT_FOUND, t.getMessage()));\n+                        return null;\n+                    } else {\n+                        log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicName, exception);\n+                        asyncResponse.resume(new RestException(exception));\n+                        return null;\n+                    }\n+                }\n+\n+                asyncResponse.resume(Response.noContent().build());\n+                return null;\n+            });\n+        } else {\n+            validateSuperUserAccess();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAwNzE0NQ=="}, "originalCommit": {"oid": "c690c4773efa6b07323e73c3b858849901cd3c97"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODQxNjU3OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOTozMjoyNVrOFlgv0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwODozMDo0MVrOFndXww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3ODE2Mg==", "bodyText": "AsyncResponse indicates that this method is an async operation. So can we implement this method in an async way?", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r374878162", "createdAt": "2020-02-04T19:32:25Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,56 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+    protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {\n         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n         }\n-        unloadTopic(topicName, authoritative);\n+\n+        PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8a5c65abfb20a74622aaef3503a11996242a290"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY3MDM5NA==", "bodyText": "Does it seem that my comment here was not addressed?", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r376670394", "createdAt": "2020-02-08T00:51:16Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,56 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+    protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {\n         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n         }\n-        unloadTopic(topicName, authoritative);\n+\n+        PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3ODE2Mg=="}, "originalCommit": {"oid": "d8a5c65abfb20a74622aaef3503a11996242a290"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1NDIyOA==", "bodyText": "implement getPartitionedTopicMetadata in an async way?", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r376754228", "createdAt": "2020-02-09T04:33:40Z", "author": {"login": "ltamber"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,56 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+    protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {\n         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n         }\n-        unloadTopic(topicName, authoritative);\n+\n+        PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3ODE2Mg=="}, "originalCommit": {"oid": "d8a5c65abfb20a74622aaef3503a11996242a290"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkyMDAwMw==", "bodyText": "Yes. we need to make sure this method is also implemented in an async way.", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r376920003", "createdAt": "2020-02-10T08:30:41Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,56 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+    protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {\n         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n         }\n-        unloadTopic(topicName, authoritative);\n+\n+        PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3ODE2Mg=="}, "originalCommit": {"oid": "d8a5c65abfb20a74622aaef3503a11996242a290"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODQyMDUxOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOTozMzo0MVrOFlgyOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOTozMzo0MVrOFlgyOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg3ODc3OQ==", "bodyText": "If this is already an async method, can you put the logic in the callback?", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r374878779", "createdAt": "2020-02-04T19:33:41Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,56 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+    protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {\n         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n         }\n-        unloadTopic(topicName, authoritative);\n+\n+        PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);\n+        if (partitionMetadata.partitions > 0) {\n+            final List<CompletableFuture<Void>> futures = Lists.newArrayList();\n+\n+            for (int i = 0; i < partitionMetadata.partitions; i++) {\n+                TopicName topicNamePartition = topicName.getPartition(i);\n+                try {\n+                    futures.add(pulsar().getAdminClient().topics().unloadAsync(topicNamePartition.toString()));\n+                } catch (Exception e) {\n+                    log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicNamePartition, e);\n+                    asyncResponse.resume(new RestException(e));\n+                    return;\n+                }\n+            }\n+\n+            FutureUtil.waitForAll(futures).handle((result, exception) -> {\n+                if (exception != null) {\n+                    Throwable t = exception.getCause();\n+                    if (t instanceof NotFoundException) {\n+                        asyncResponse.resume(new RestException(Status.NOT_FOUND, t.getMessage()));\n+                    } else {\n+                        log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicName, exception);\n+                        asyncResponse.resume(new RestException(exception));\n+                    }\n+                    return null;\n+                }\n+\n+                asyncResponse.resume(Response.noContent().build());\n+                return null;\n+            });\n+        } else {\n+            validateAdminAccessForTenant(topicName.getTenant());\n+            validateTopicOwnership(topicName, authoritative);\n+\n+            Topic topic = getTopicReference(topicName);\n+            try {\n+                topic.close(false).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8a5c65abfb20a74622aaef3503a11996242a290"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNjU1MTc3OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDozNDo0MlrOFmu6HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDozNDo0MlrOFmu6HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE1ODc0OQ==", "bodyText": "Don't we need to return here?", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r376158749", "createdAt": "2020-02-07T00:34:42Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -552,6 +552,36 @@ protected ZooKeeperChildrenCache failureDomainListCache() {\n         return pulsar().getConfigurationCache().failureDomainListCache();\n     }\n \n+    protected CompletableFuture<PartitionedTopicMetadata> getPartitionedTopicMetadataAsync(\n+            TopicName topicName, boolean authoritative, boolean checkAllowAutoCreation) {\n+        validateClusterOwnership(topicName.getCluster());\n+        // validates global-namespace contains local/peer cluster: if peer/local cluster present then lookup can\n+        // serve/redirect request else fail partitioned-metadata-request so, client fails while creating\n+        // producer/consumer\n+        validateGlobalNamespaceOwnership(topicName.getNamespaceObject());\n+\n+        CompletableFuture<PartitionedTopicMetadata> future = new CompletableFuture<>();\n+\n+        try {\n+            checkConnect(topicName);\n+        } catch (WebApplicationException e) {\n+            validateAdminAccessForTenant(topicName.getTenant());\n+        } catch (Exception e) {\n+            // unknown error marked as internal server error\n+            log.warn(\"Unexpected error while authorizing lookup. topic={}, role={}. Error: {}\", topicName,\n+                    clientAppId(), e.getMessage(), e);\n+            future.completeExceptionally(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53e49dc320d915b97d9f275d6030dbbc734e84d5"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNjU1MzAyOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDozNTozMlrOFmu62A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDozNTozMlrOFmu62A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE1ODkzNg==", "bodyText": "line 577 and line 579 reinitialize a completable future. so I don't think we need to initialize here.", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r376158936", "createdAt": "2020-02-07T00:35:32Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -552,6 +552,36 @@ protected ZooKeeperChildrenCache failureDomainListCache() {\n         return pulsar().getConfigurationCache().failureDomainListCache();\n     }\n \n+    protected CompletableFuture<PartitionedTopicMetadata> getPartitionedTopicMetadataAsync(\n+            TopicName topicName, boolean authoritative, boolean checkAllowAutoCreation) {\n+        validateClusterOwnership(topicName.getCluster());\n+        // validates global-namespace contains local/peer cluster: if peer/local cluster present then lookup can\n+        // serve/redirect request else fail partitioned-metadata-request so, client fails while creating\n+        // producer/consumer\n+        validateGlobalNamespaceOwnership(topicName.getNamespaceObject());\n+\n+        CompletableFuture<PartitionedTopicMetadata> future = new CompletableFuture<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53e49dc320d915b97d9f275d6030dbbc734e84d5"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNjU1ODIxOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDozODoxMFrOFmu92Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNDo0MDo1OFrOFm_IuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE1OTcwNQ==", "bodyText": "this should be implemented in an async way.", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r376159705", "createdAt": "2020-02-07T00:38:10Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,67 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+    protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {\n         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n         }\n-        unloadTopic(topicName, authoritative);\n+\n+        getPartitionedTopicMetadataAsync(topicName, authoritative, false)\n+                .whenComplete((metadata, ex) -> {\n+                    if (ex != null) {\n+                        log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicName);\n+                        asyncResponse.resume(new RestException(ex));\n+                    } else {\n+                        if (metadata.partitions > 0) {\n+                            final List<CompletableFuture<Void>> futures = Lists.newArrayList();\n+\n+                            for (int i = 0; i < metadata.partitions; i++) {\n+                                TopicName topicNamePartition = topicName.getPartition(i);\n+                                try {\n+                                    futures.add(pulsar().getAdminClient().topics().unloadAsync(topicNamePartition.toString()));\n+                                } catch (Exception e) {\n+                                    log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicNamePartition, e);\n+                                    asyncResponse.resume(new RestException(e));\n+                                    return;\n+                                }\n+                            }\n+\n+                            FutureUtil.waitForAll(futures).handle((result, exception) -> {\n+                                if (exception != null) {\n+                                    Throwable t = exception.getCause();\n+                                    if (t instanceof NotFoundException) {\n+                                        asyncResponse.resume(new RestException(Status.NOT_FOUND, t.getMessage()));\n+                                    } else {\n+                                        log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicName, exception);\n+                                        asyncResponse.resume(new RestException(exception));\n+                                    }\n+                                    return null;\n+                                }\n+\n+                                asyncResponse.resume(Response.noContent().build());\n+                                return null;\n+                            });\n+                        } else {\n+                            validateAdminAccessForTenant(topicName.getTenant());\n+                            validateTopicOwnership(topicName, authoritative);\n+\n+                            Topic topic = getTopicReference(topicName);\n+                            try {\n+                                topic.close(false).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53e49dc320d915b97d9f275d6030dbbc734e84d5"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQyNDYzMg==", "bodyText": "OK", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r376424632", "createdAt": "2020-02-07T14:40:58Z", "author": {"login": "ltamber"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,67 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+    protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {\n         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n         }\n-        unloadTopic(topicName, authoritative);\n+\n+        getPartitionedTopicMetadataAsync(topicName, authoritative, false)\n+                .whenComplete((metadata, ex) -> {\n+                    if (ex != null) {\n+                        log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicName);\n+                        asyncResponse.resume(new RestException(ex));\n+                    } else {\n+                        if (metadata.partitions > 0) {\n+                            final List<CompletableFuture<Void>> futures = Lists.newArrayList();\n+\n+                            for (int i = 0; i < metadata.partitions; i++) {\n+                                TopicName topicNamePartition = topicName.getPartition(i);\n+                                try {\n+                                    futures.add(pulsar().getAdminClient().topics().unloadAsync(topicNamePartition.toString()));\n+                                } catch (Exception e) {\n+                                    log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicNamePartition, e);\n+                                    asyncResponse.resume(new RestException(e));\n+                                    return;\n+                                }\n+                            }\n+\n+                            FutureUtil.waitForAll(futures).handle((result, exception) -> {\n+                                if (exception != null) {\n+                                    Throwable t = exception.getCause();\n+                                    if (t instanceof NotFoundException) {\n+                                        asyncResponse.resume(new RestException(Status.NOT_FOUND, t.getMessage()));\n+                                    } else {\n+                                        log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicName, exception);\n+                                        asyncResponse.resume(new RestException(exception));\n+                                    }\n+                                    return null;\n+                                }\n+\n+                                asyncResponse.resume(Response.noContent().build());\n+                                return null;\n+                            });\n+                        } else {\n+                            validateAdminAccessForTenant(topicName.getTenant());\n+                            validateTopicOwnership(topicName, authoritative);\n+\n+                            Topic topic = getTopicReference(topicName);\n+                            try {\n+                                topic.close(false).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE1OTcwNQ=="}, "originalCommit": {"oid": "53e49dc320d915b97d9f275d6030dbbc734e84d5"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNjU1ODcxOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDozODoyOVrOFmu-MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDozODoyOVrOFmu-MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE1OTc5Mw==", "bodyText": "Fix indention", "url": "https://github.com/apache/pulsar/pull/6187#discussion_r376159793", "createdAt": "2020-02-07T00:38:29Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -655,12 +655,67 @@ protected void internalDeletePartitionedTopic(AsyncResponse asyncResponse, boole\n         });\n     }\n \n-    protected void internalUnloadTopic(boolean authoritative) {\n+    protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {\n         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);\n         if (topicName.isGlobal()) {\n             validateGlobalNamespaceOwnership(namespaceName);\n         }\n-        unloadTopic(topicName, authoritative);\n+\n+        getPartitionedTopicMetadataAsync(topicName, authoritative, false)\n+                .whenComplete((metadata, ex) -> {\n+                    if (ex != null) {\n+                        log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicName);\n+                        asyncResponse.resume(new RestException(ex));\n+                    } else {\n+                        if (metadata.partitions > 0) {\n+                            final List<CompletableFuture<Void>> futures = Lists.newArrayList();\n+\n+                            for (int i = 0; i < metadata.partitions; i++) {\n+                                TopicName topicNamePartition = topicName.getPartition(i);\n+                                try {\n+                                    futures.add(pulsar().getAdminClient().topics().unloadAsync(topicNamePartition.toString()));\n+                                } catch (Exception e) {\n+                                    log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicNamePartition, e);\n+                                    asyncResponse.resume(new RestException(e));\n+                                    return;\n+                                }\n+                            }\n+\n+                            FutureUtil.waitForAll(futures).handle((result, exception) -> {\n+                                if (exception != null) {\n+                                    Throwable t = exception.getCause();\n+                                    if (t instanceof NotFoundException) {\n+                                        asyncResponse.resume(new RestException(Status.NOT_FOUND, t.getMessage()));\n+                                    } else {\n+                                        log.error(\"[{}] Failed to unload topic {}\", clientAppId(), topicName, exception);\n+                                        asyncResponse.resume(new RestException(exception));\n+                                    }\n+                                    return null;\n+                                }\n+\n+                                asyncResponse.resume(Response.noContent().build());\n+                                return null;\n+                            });\n+                        } else {\n+                            validateAdminAccessForTenant(topicName.getTenant());\n+                            validateTopicOwnership(topicName, authoritative);\n+\n+                            Topic topic = getTopicReference(topicName);\n+                            try {\n+                                topic.close(false).get();\n+                                asyncResponse.resume(Response.noContent().build());\n+                                log.info(\"[{}] Successfully unloaded topic {}\", clientAppId(), topicName);\n+                            } catch (Exception e) {\n+                                log.error(\"[{}] Failed to unload topic {}, {}\", clientAppId(), topicName, e.getMessage(), e);\n+                                asyncResponse.resume(new RestException(e));\n+                            }\n+                        }\n+                    }\n+                }).exceptionally(t -> {\n+                    Throwable th = t.getCause();\n+                    asyncResponse.resume(new RestException(th));\n+                    return null;\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53e49dc320d915b97d9f275d6030dbbc734e84d5"}, "originalPosition": 66}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2024, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}