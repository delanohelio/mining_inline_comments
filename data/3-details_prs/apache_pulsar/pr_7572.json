{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNzg0NTg5", "number": 7572, "title": "[CPP] Fix segment crashes that caused by race condition of timer in cpp client", "bodyText": "Fixes #7565\nSegment Crashes happens in a race condition:\n\n\n\nclose operation called the keepAliveTimer_.reset(),keepAliveTimer_.reset().\n\n\n\n\nwhile at the same time, timer is accessed in method startConsumerStatsTimer and handleKeepAliveTimeout.\nthis Pr is trying to fix this issue.", "createdAt": "2020-07-17T05:11:48Z", "url": "https://github.com/apache/pulsar/pull/7572", "merged": true, "mergeCommit": {"oid": "15d5254e49b96719638f9efec391a6beeed00bb9"}, "closed": true, "closedAt": "2020-07-28T14:22:09Z", "author": {"login": "irairdon"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1tFAiAFqTQ1MDM4MjgzMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5VxKMAH2gAyNDUwNzg0NTg5OjQxNzRkYjU1NTU4ZTE1ZWY5Yjk0NjMxYzNkMzNmOWE5MzUyYjUwZmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzgyODMz", "url": "https://github.com/apache/pulsar/pull/7572#pullrequestreview-450382833", "createdAt": "2020-07-17T05:32:40Z", "commit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNTozMjo0MFrOGzF5Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNTozNTowOFrOGzF7vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyNzE1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (consumerStatsRequestTimer_.use_count() > 0) {\n          \n          \n            \n                if (consumerStatsRequestTimer_) {", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456227158", "createdAt": "2020-07-17T05:32:40Z", "author": {"login": "merlimat"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -289,13 +286,14 @@ void ClientConnection::startConsumerStatsTimer(std::vector<uint64_t> consumerSta\n         consumerStatsRequests.push_back(it->first);\n     }\n \n-    DeadlineTimerPtr timer = consumerStatsRequestTimer_;\n-    if (timer) {\n-        timer->expires_from_now(operationsTimeout_);\n-        timer->async_wait(std::bind(&ClientConnection::handleConsumerStatsTimeout, shared_from_this(),\n-                                    std::placeholders::_1, consumerStatsRequests));\n+    // If the close operation has reset the consumerStatsRequestTimer_ then the use_count will be zero\n+    // Check if we have a timer still before we set the request timer to pop again.\n+    if (consumerStatsRequestTimer_.use_count() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyNzc3Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (keepAliveTimer_.use_count() > 0) {\n          \n          \n            \n                    if (keepAliveTimer_) {", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456227773", "createdAt": "2020-07-17T05:35:08Z", "author": {"login": "merlimat"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -1344,8 +1324,12 @@ void ClientConnection::handleKeepAliveTimeout() {\n         havePendingPingRequest_ = true;\n         sendCommand(Commands::newPing());\n \n-        keepAliveTimer_->expires_from_now(boost::posix_time::seconds(KeepAliveIntervalInSeconds));\n-        keepAliveTimer_->async_wait(std::bind(&ClientConnection::handleKeepAliveTimeout, shared_from_this()));\n+        // If the close operation has already called the keepAliveTimer_.reset() then the use_count will be zero And we do not attempt\n+        // to dereference the pointer.\n+        if (keepAliveTimer_.use_count() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDU4NDQx", "url": "https://github.com/apache/pulsar/pull/7572#pullrequestreview-451058441", "createdAt": "2020-07-18T13:52:46Z", "commit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1Mjo0NlrOGzoYsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1Mjo0NlrOGzoYsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjI0MA==", "bodyText": "Could we remove this?", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792240", "createdAt": "2020-07-18T13:52:46Z", "author": {"login": "jiazhai"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -25,6 +25,7 @@\n #include <boost/date_time/posix_time/posix_time.hpp>\n #include <boost/date_time/gregorian/gregorian.hpp>\n #include <climits>\n+// #include <unistd.h>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDU4NTYz", "url": "https://github.com/apache/pulsar/pull/7572#pullrequestreview-451058563", "createdAt": "2020-07-18T13:54:44Z", "commit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NDo0NFrOGzoZPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NDo0NFrOGzoZPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjM4MQ==", "bodyText": "The changes in this file seems removed some of the latest change in master. This will cause regressions.", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792381", "createdAt": "2020-07-18T13:54:44Z", "author": {"login": "jiazhai"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -117,9 +118,6 @@ static Result getResult(ServerError serverError) {\n \n         case InvalidTxnStatus:\n             return ResultInvalidTxnStatusError;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDU4NjAx", "url": "https://github.com/apache/pulsar/pull/7572#pullrequestreview-451058601", "createdAt": "2020-07-18T13:55:25Z", "commit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NToyNVrOGzoZjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NToyNVrOGzoZjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjQ2MA==", "bodyText": "same as the above comments. this change is not needed for this fix?", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792460", "createdAt": "2020-07-18T13:55:25Z", "author": {"login": "jiazhai"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -417,15 +415,6 @@ void ClientConnection::handleSentPulsarConnect(const boost::system::error_code&\n     readNextCommand();\n }\n \n-void ClientConnection::handleSentAuthResponse(const boost::system::error_code& err,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDU4NjEx", "url": "https://github.com/apache/pulsar/pull/7572#pullrequestreview-451058611", "createdAt": "2020-07-18T13:55:38Z", "commit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NTozOFrOGzoZog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NTozOFrOGzoZog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjQ4Mg==", "bodyText": "same as above comments. this change is not needed for this fix?", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792482", "createdAt": "2020-07-18T13:55:38Z", "author": {"login": "jiazhai"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -1038,15 +1027,6 @@ void ClientConnection::handleIncomingCommand() {\n                     break;\n                 }\n \n-                case BaseCommand::AUTH_CHALLENGE: {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/c47e4546f46fae8b5d60982b5821b5d9bc301b4f", "committedDate": "2020-07-17T05:07:37Z", "message": "Kevin Wilson changes to fix segment crashes in pulsar"}, "afterCommit": {"oid": "600a667efe6270cb309d539b111d4e038dec734a", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/600a667efe6270cb309d539b111d4e038dec734a", "committedDate": "2020-07-22T08:33:30Z", "message": "Kevin Wilson changes to fix segment crashes in pulsar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eeffe428869823a1cececed2d25255bf356bd757", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/eeffe428869823a1cececed2d25255bf356bd757", "committedDate": "2020-07-23T07:19:23Z", "message": "Kevin Wilson changes to fix segment crashes in pulsar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b34837671becfdf138b266df21d26b67d326be05", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/b34837671becfdf138b266df21d26b67d326be05", "committedDate": "2020-07-23T07:19:23Z", "message": "after merge with master, change following comments: ptr, unnecessary change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fe0e5a2f753c625014850155e420546cb603af3", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/6fe0e5a2f753c625014850155e420546cb603af3", "committedDate": "2020-07-23T07:19:23Z", "message": "add lock to avoid concurrent access"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a4f0e90a54f1380a5f6f2b22d50eb1b7ff71fc4", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/7a4f0e90a54f1380a5f6f2b22d50eb1b7ff71fc4", "committedDate": "2020-07-22T09:58:28Z", "message": "add lock to avoid concurrent access"}, "afterCommit": {"oid": "6fe0e5a2f753c625014850155e420546cb603af3", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/6fe0e5a2f753c625014850155e420546cb603af3", "committedDate": "2020-07-23T07:19:23Z", "message": "add lock to avoid concurrent access"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0OTE3Nzkw", "url": "https://github.com/apache/pulsar/pull/7572#pullrequestreview-454917790", "createdAt": "2020-07-24T14:09:57Z", "commit": {"oid": "6fe0e5a2f753c625014850155e420546cb603af3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDowOTo1OFrOG2w1Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDowOTo1OFrOG2w1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3NjM0Mw==", "bodyText": "Please remove comment", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r460076343", "createdAt": "2020-07-24T14:09:58Z", "author": {"login": "merlimat"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -1363,6 +1375,8 @@ void ClientConnection::close() {\n     if (isClosed()) {\n         return;\n     }\n+    // Use a sleep to stress the timers when the pop to find the race conditions with close().\n+    // sleep(30);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fe0e5a2f753c625014850155e420546cb603af3"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e41f5305eaf14edbddfd8b45e133bf361ed71a7", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/5e41f5305eaf14edbddfd8b45e133bf361ed71a7", "committedDate": "2020-07-27T04:29:53Z", "message": "Remove comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MjgxMjg2", "url": "https://github.com/apache/pulsar/pull/7572#pullrequestreview-456281286", "createdAt": "2020-07-28T03:43:31Z", "commit": {"oid": "5e41f5305eaf14edbddfd8b45e133bf361ed71a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4174db55558e15ef9b94631c3d33f9a9352b50fa", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/4174db55558e15ef9b94631c3d33f9a9352b50fa", "committedDate": "2020-07-28T12:41:28Z", "message": "Merge branch 'master' into MicroFocusCrashFix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 639, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}