{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MTY1Njc2", "number": 8446, "title": "add rest api: unsetOffloadPolicies", "bodyText": "Signed-off-by: Renkai gaelookair@gmail.com\n\nFix: streamnative#1638\nAdd a unset mirror of setOffloadPolicies\nMotivation\nCurrently we don't have a way to unset offload policies for namespaces, we may need one.\nModifications\nAdd a rest API\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\n(Please pick either of the following options)\nThis change is a trivial rework / code cleanup without any test coverage.\n(or)\nThis change is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end deployment with large payloads (10MB)\nExtended integration test for recovery after broker failure\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (yes)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (yes)\nThe admin cli options: (yes)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)\nIf a feature is not applicable for documentation, explain why?\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-11-04T06:31:10Z", "url": "https://github.com/apache/pulsar/pull/8446", "merged": true, "mergeCommit": {"oid": "24cd557fd77a8084d6cf775afaa9d393d3359972"}, "closed": true, "closedAt": "2020-11-06T00:43:33Z", "author": {"login": "Renkai"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZHsIkgH2gAyNTE1MTY1Njc2OjUyNzRjMmIyNWM3YjAwMTM0NTIyZDQ3OTg1MWFhNWNkMjlhMjdmYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZkR4FgFqTUyNDM5MzE2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5274c2b25c7b00134522d479851aa5cd29a27fa4", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/5274c2b25c7b00134522d479851aa5cd29a27fa4", "committedDate": "2020-11-04T06:22:53Z", "message": "add rest api: unsetOffloadPolicies\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49aeeae7d412d816440398df59b97cafacd77136", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/49aeeae7d412d816440398df59b97cafacd77136", "committedDate": "2020-11-04T07:04:26Z", "message": "rename to remove\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffdfc76c1093143151aaeab277c69e1120bd304c", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/ffdfc76c1093143151aaeab277c69e1120bd304c", "committedDate": "2020-11-04T08:09:32Z", "message": "add admin tool api\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/ccbb32ff25f0b46f59975882ec396a5b0375b209", "committedDate": "2020-11-04T08:39:19Z", "message": "add admin tool api\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDEyNjUx", "url": "https://github.com/apache/pulsar/pull/8446#pullrequestreview-523412651", "createdAt": "2020-11-04T14:28:28Z", "commit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDoyODoyOFrOHtakIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDoyODoyOFrOHtakIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4MzIwMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                \"[%s] Failed to update offload configuration for namespace %s\",\n          \n          \n            \n                                                \"[%s] Failed to remove offload configuration for namespace %s\",", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517383201", "createdAt": "2020-11-04T14:28:28Z", "author": {"login": "gaoran10"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -3000,6 +3001,47 @@ protected void internalSetOffloadPolicies(AsyncResponse asyncResponse, OffloadPo\n         }\n     }\n \n+    protected void internalRemoveOffloadPolicies(AsyncResponse asyncResponse) {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.OFFLOAD, PolicyOperation.WRITE);\n+        validatePoliciesReadOnlyAccess();\n+\n+        try {\n+            Stat nodeStat = new Stat();\n+            final String path = path(POLICIES, namespaceName.toString());\n+            byte[] content = globalZk().getData(path, null, nodeStat);\n+            Policies policies = jsonMapper().readValue(content, Policies.class);\n+\n+            policies.offload_policies = null;\n+            String updatedOffloadPolicies = jsonMapper().writeValueAsString(policies.offload_policies);\n+            globalZk().setData(path, jsonMapper().writeValueAsBytes(policies), nodeStat.getVersion(),\n+                    (rc, path1, ctx, stat) -> {\n+                        if (rc == KeeperException.Code.OK.intValue()) {\n+                            policiesCache().invalidate(path(POLICIES, namespaceName.toString()));\n+                            log.info(\"[{}] Successfully updated offload configuration: namespace={}, map={}\", clientAppId(),\n+                                    namespaceName, updatedOffloadPolicies);\n+                            asyncResponse.resume(Response.noContent().build());\n+                        } else {\n+                            String errorMsg = String.format(\n+                                    \"[%s] Failed to update offload configuration for namespace %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDEyOTQz", "url": "https://github.com/apache/pulsar/pull/8446#pullrequestreview-523412943", "createdAt": "2020-11-04T14:28:46Z", "commit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDoyODo0NlrOHtak7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDoyODo0NlrOHtak7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4MzQwNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.error(\"[{}] Failed to update offload configuration for namespace {}\", clientAppId(), namespaceName,\n          \n          \n            \n                        log.error(\"[{}] Failed to remove offload configuration for namespace {}\", clientAppId(), namespaceName,", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517383406", "createdAt": "2020-11-04T14:28:46Z", "author": {"login": "gaoran10"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -3000,6 +3001,47 @@ protected void internalSetOffloadPolicies(AsyncResponse asyncResponse, OffloadPo\n         }\n     }\n \n+    protected void internalRemoveOffloadPolicies(AsyncResponse asyncResponse) {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.OFFLOAD, PolicyOperation.WRITE);\n+        validatePoliciesReadOnlyAccess();\n+\n+        try {\n+            Stat nodeStat = new Stat();\n+            final String path = path(POLICIES, namespaceName.toString());\n+            byte[] content = globalZk().getData(path, null, nodeStat);\n+            Policies policies = jsonMapper().readValue(content, Policies.class);\n+\n+            policies.offload_policies = null;\n+            String updatedOffloadPolicies = jsonMapper().writeValueAsString(policies.offload_policies);\n+            globalZk().setData(path, jsonMapper().writeValueAsBytes(policies), nodeStat.getVersion(),\n+                    (rc, path1, ctx, stat) -> {\n+                        if (rc == KeeperException.Code.OK.intValue()) {\n+                            policiesCache().invalidate(path(POLICIES, namespaceName.toString()));\n+                            log.info(\"[{}] Successfully updated offload configuration: namespace={}, map={}\", clientAppId(),\n+                                    namespaceName, updatedOffloadPolicies);\n+                            asyncResponse.resume(Response.noContent().build());\n+                        } else {\n+                            String errorMsg = String.format(\n+                                    \"[%s] Failed to update offload configuration for namespace %s\",\n+                                    clientAppId(), namespaceName);\n+                            if (rc == KeeperException.Code.NONODE.intValue()) {\n+                                log.warn(\"{} : does not exist\", errorMsg);\n+                                asyncResponse.resume(new RestException(Status.NOT_FOUND, \"Namespace does not exist\"));\n+                            } else if (rc == KeeperException.Code.BADVERSION.intValue()) {\n+                                log.warn(\"{} : concurrent modification\", errorMsg);\n+                                asyncResponse.resume(new RestException(Status.CONFLICT, \"Concurrent modification\"));\n+                            } else {\n+                                asyncResponse.resume(KeeperException.create(KeeperException.Code.get(rc), errorMsg));\n+                            }\n+                        }\n+                    }, null);\n+        } catch (Exception e) {\n+            log.error(\"[{}] Failed to update offload configuration for namespace {}\", clientAppId(), namespaceName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDIwNTQ2", "url": "https://github.com/apache/pulsar/pull/8446#pullrequestreview-523420546", "createdAt": "2020-11-04T14:36:37Z", "commit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozNjozOFrOHta7XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozNjozOFrOHta7XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4OTE0OA==", "bodyText": "Maybe this is not exactly. Removing the namespace offload policies not represents to remove the topic offload policies, if the topic has its own offload policies, it will not be affected.", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517389148", "createdAt": "2020-11-04T14:36:38Z", "author": {"login": "gaoran10"}, "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Namespaces.java", "diffHunk": "@@ -3263,6 +3263,20 @@ void setIsAllowAutoUpdateSchema(String namespace, boolean isAllowAutoUpdateSchem\n      */\n     void setOffloadPolicies(String namespace, OffloadPolicies offloadPolicies) throws PulsarAdminException;\n \n+    /**\n+     * Remove the offload configuration for all the topics in a namespace.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDIzMTY3", "url": "https://github.com/apache/pulsar/pull/8446#pullrequestreview-523423167", "createdAt": "2020-11-04T14:39:23Z", "commit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozOToyM1rOHtbDeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDozOToyM1rOHtbDeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MTIyNQ==", "bodyText": "Same as above.", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517391225", "createdAt": "2020-11-04T14:39:23Z", "author": {"login": "gaoran10"}, "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Namespaces.java", "diffHunk": "@@ -3290,6 +3304,20 @@ void setIsAllowAutoUpdateSchema(String namespace, boolean isAllowAutoUpdateSchem\n      */\n     CompletableFuture<Void> setOffloadPoliciesAsync(String namespace, OffloadPolicies offloadPolicies);\n \n+    /**\n+     * Remove the offload configuration for all the topics in a namespace asynchronously.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDI2NTUz", "url": "https://github.com/apache/pulsar/pull/8446#pullrequestreview-523426553", "createdAt": "2020-11-04T14:42:52Z", "commit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0Mjo1MlrOHtbNbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0Mjo1MlrOHtbNbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5Mzc3Mw==", "bodyText": "It's better to use the DELETE method.", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517393773", "createdAt": "2020-11-04T14:42:52Z", "author": {"login": "gaoran10"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/Namespaces.java", "diffHunk": "@@ -1335,14 +1334,34 @@ public void setOffloadPolicies(@PathParam(\"tenant\") String tenant, @PathParam(\"n\n         }\n     }\n \n+    @POST", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDMzMzAy", "url": "https://github.com/apache/pulsar/pull/8446#pullrequestreview-523433302", "createdAt": "2020-11-04T14:49:44Z", "commit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0OTo0NVrOHtbhIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNDo0OTo0NVrOHtbhIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5ODgxNw==", "bodyText": "String updatedOffloadPolicies = jsonMapper().writeValueAsString(policies.offload_policies);\nMaybe this is not necessary? The log could be just like Successfully remove the namespace offload policies.", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517398817", "createdAt": "2020-11-04T14:49:45Z", "author": {"login": "gaoran10"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -3000,6 +3001,47 @@ protected void internalSetOffloadPolicies(AsyncResponse asyncResponse, OffloadPo\n         }\n     }\n \n+    protected void internalRemoveOffloadPolicies(AsyncResponse asyncResponse) {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.OFFLOAD, PolicyOperation.WRITE);\n+        validatePoliciesReadOnlyAccess();\n+\n+        try {\n+            Stat nodeStat = new Stat();\n+            final String path = path(POLICIES, namespaceName.toString());\n+            byte[] content = globalZk().getData(path, null, nodeStat);\n+            Policies policies = jsonMapper().readValue(content, Policies.class);\n+\n+            policies.offload_policies = null;\n+            String updatedOffloadPolicies = jsonMapper().writeValueAsString(policies.offload_policies);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39718280677b79051f88d70fe5d74549eb24a0ae", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/39718280677b79051f88d70fe5d74549eb24a0ae", "committedDate": "2020-11-05T02:44:56Z", "message": "Update pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java\n\nCo-authored-by: ran <gaoran_10@126.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7778f9e79dae0f1f3891e6c04e2e5bdb910d8e3", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/f7778f9e79dae0f1f3891e6c04e2e5bdb910d8e3", "committedDate": "2020-11-05T02:45:06Z", "message": "Update pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java\n\nCo-authored-by: ran <gaoran_10@126.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9312562e8dfdd63be0772131f0caed6d3784e5d", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/f9312562e8dfdd63be0772131f0caed6d3784e5d", "committedDate": "2020-11-05T02:47:06Z", "message": "post to delete\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2130902ea209f089eae9b20a7505ac4bdd005908", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/2130902ea209f089eae9b20a7505ac4bdd005908", "committedDate": "2020-11-05T02:51:08Z", "message": "post to delete\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c0a1089736e27467bf8419da3122c56cdb89651", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/3c0a1089736e27467bf8419da3122c56cdb89651", "committedDate": "2020-11-05T02:57:15Z", "message": "post to delete\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTI3MTky", "url": "https://github.com/apache/pulsar/pull/8446#pullrequestreview-523927192", "createdAt": "2020-11-05T05:02:30Z", "commit": {"oid": "3c0a1089736e27467bf8419da3122c56cdb89651"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37f84c23298decd5742610c9857437f4c7aa891b", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/37f84c23298decd5742610c9857437f4c7aa891b", "committedDate": "2020-11-05T06:04:09Z", "message": "use delete request instead of post\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTU2MDAw", "url": "https://github.com/apache/pulsar/pull/8446#pullrequestreview-523956000", "createdAt": "2020-11-05T06:27:15Z", "commit": {"oid": "37f84c23298decd5742610c9857437f4c7aa891b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MzkzMTY2", "url": "https://github.com/apache/pulsar/pull/8446#pullrequestreview-524393166", "createdAt": "2020-11-05T15:41:27Z", "commit": {"oid": "37f84c23298decd5742610c9857437f4c7aa891b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1167, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}