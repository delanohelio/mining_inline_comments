{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNTIxNDY1", "number": 7738, "title": "Support set message TTL on topic level.", "bodyText": "Motivation\nMaster Issue: #2688\nAdd Topic level policy support for message TTL.\nModifications\nSupport set/get/remove Message TTL on topic level.\nVerifying this change\nThis change added tests and can be verified as follows:\n\nAdded Unit test to verify set/get/remove message TTL at Topic level work as expected when Topic level policy is enabled/disabled\nAdded test case in PersistentTopicE2ETest to verify Topic level message TTL is used when set and will fall back to namespace message TTL if Topic level message TTL is removed.\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (no )\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (yes)\nThe admin cli options: (yes)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes)\nIf yes, how is the feature documented? (JavaDocs)", "createdAt": "2020-08-04T04:30:24Z", "url": "https://github.com/apache/pulsar/pull/7738", "merged": true, "mergeCommit": {"oid": "8a763abc4cff878f4765d5f0a806750b9e9998a5"}, "closed": true, "closedAt": "2020-08-06T02:09:28Z", "author": {"login": "MarvinCai"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7eoTJgH2gAyNDYyNTIxNDY1OjAyODhkYzQ3ZjUzMjlhMDY1ZjJkNWMxYjZjMDIyNGE5MjU3ZDRmNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc79hB5AH2gAyNDYyNTIxNDY1OjNlOGM1MmY1MzE4ZjJjODRkN2VhMTNhY2EyYTdhOWQyMWQyYzlhMTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0288dc47f5329a065f2d5c1b6c0224a9257d4f48", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/0288dc47f5329a065f2d5c1b6c0224a9257d4f48", "committedDate": "2020-08-04T04:08:47Z", "message": "Add support for message TTL at Topic level.\n\nAdd support for message TTL at Topic level using System Topic backed Topic policy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a1ee6a5132d47c3cf6c954adbf2f6d2bb5a833d", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/6a1ee6a5132d47c3cf6c954adbf2f6d2bb5a833d", "committedDate": "2020-08-04T04:22:39Z", "message": "Add CLI command for set/get/remove Topic Message TTL."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2922739a5534f5a6fccc57850a84bfbb107f9b2c", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/2922739a5534f5a6fccc57850a84bfbb107f9b2c", "committedDate": "2020-08-04T23:40:44Z", "message": "Merge remote-tracking branch 'apache-pulsar/master' into zxc-add-topic-level-ttl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b11252a01b83f7e0121510cb793b6abc6b6c59cb", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/b11252a01b83f7e0121510cb793b6abc6b6c59cb", "committedDate": "2020-08-05T01:04:38Z", "message": "Improve stability for Topic message ttl test.\n\nImprove test stability by trigger namespace bundle load to make sure topic initialized when test case is ran\nSimilar to what we do for TopicBacklogQuotaTest.\n\nAlso added wait time after setup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzE1NzM1", "url": "https://github.com/apache/pulsar/pull/7738#pullrequestreview-461315735", "createdAt": "2020-08-05T03:33:45Z", "commit": {"oid": "b11252a01b83f7e0121510cb793b6abc6b6c59cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMzozMzo0NVrOG745sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMzozMzo0NVrOG745sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1MTQ0MQ==", "bodyText": "Remove message TTL in seconds for a topic", "url": "https://github.com/apache/pulsar/pull/7738#discussion_r465451441", "createdAt": "2020-08-05T03:33:45Z", "author": {"login": "jianyun8023"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/PersistentTopics.java", "diffHunk": "@@ -1032,6 +1032,53 @@ public void removeBacklogQuota(@Suspended final AsyncResponse asyncResponse, @Pa\n         internalRemoveBacklogQuota(asyncResponse, backlogQuotaType);\n     }\n \n+    @GET\n+    @Path(\"/{tenant}/{namespace}/{topic}/messageTTL\")\n+    @ApiOperation(value = \"Get message TTL in seconds for a topic\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+                            @ApiResponse(code = 404, message = \"Topic does not exist\"),\n+                            @ApiResponse(code = 405, message = \"Topic level policy is disabled, enable the topic level policy and retry\")})\n+    public int getMessageTTL(@PathParam(\"tenant\") String tenant,\n+                             @PathParam(\"namespace\") String namespace,\n+                             @PathParam(\"topic\") @Encoded String encodedTopic) {\n+        validateTopicName(tenant, namespace, encodedTopic);\n+        return getTopicPolicies(topicName)\n+                .map(TopicPolicies::getMessageTTLInSeconds)\n+                .orElse(0);  //same as default ttl at namespace level\n+    }\n+\n+    @POST\n+    @Path(\"/{tenant}/{namespace}/{topic}/messageTTL\")\n+    @ApiOperation(value = \"Set message TTL in seconds for a topic\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Not authenticate to perform the request or policy is read only\"),\n+                            @ApiResponse(code = 404, message = \"Topic does not exist\"),\n+                            @ApiResponse(code = 405, message = \"Topic level policy is disabled, enable the topic level policy and retry\"),\n+                            @ApiResponse(code = 412, message = \"Invalid message TTL value\") })\n+    public void setMessageTTL(@Suspended final AsyncResponse asyncResponse,\n+                              @PathParam(\"tenant\") String tenant,\n+                              @PathParam(\"namespace\") String namespace,\n+                              @PathParam(\"topic\") @Encoded String encodedTopic,\n+                              @ApiParam(value = \"TTL in seconds for the specified namespace\", required = true)\n+                              @QueryParam(\"messageTTL\") int messageTTL) {\n+        validateTopicName(tenant, namespace, encodedTopic);\n+        internalSetMessageTTL(asyncResponse, messageTTL);\n+    }\n+\n+    @DELETE\n+    @Path(\"/{tenant}/{namespace}/{topic}/messageTTL\")\n+    @ApiOperation(value = \"Set message TTL in seconds for a topic\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b11252a01b83f7e0121510cb793b6abc6b6c59cb"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNTEwNjAw", "url": "https://github.com/apache/pulsar/pull/7738#pullrequestreview-461510600", "createdAt": "2020-08-05T09:51:46Z", "commit": {"oid": "b11252a01b83f7e0121510cb793b6abc6b6c59cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e8c52f5318f2c84d7ea13aca2a7a9d21d2c9a14", "author": {"user": {"login": "MarvinCai", "name": "Marvin Cai"}}, "url": "https://github.com/apache/pulsar/commit/3e8c52f5318f2c84d7ea13aca2a7a9d21d2c9a14", "committedDate": "2020-08-05T16:07:54Z", "message": "Update description for removeMessageTTL REST endpoint to reflect what it does."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 468, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}