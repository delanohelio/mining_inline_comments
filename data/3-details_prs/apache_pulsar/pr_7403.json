{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMjE2MzUx", "number": 7403, "title": "Avoid NPEs at ledger creation when DNS failures happen", "bodyText": "Motivation\nAs a followup to the fix in #7401, also use try/catch in all places where we're creating new ledgers to cover against NPEs triggered by DNS errors.", "createdAt": "2020-06-30T18:22:46Z", "url": "https://github.com/apache/pulsar/pull/7403", "merged": true, "mergeCommit": {"oid": "a230427f78e7cc844b2a22ababd05d217d9164bf"}, "closed": true, "closedAt": "2020-07-01T01:39:03Z", "author": {"login": "merlimat"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwZ1FDgH2gAyNDQyMjE2MzUxOmE2MTJlYmEwNmVjYTM5OGU0YmY0OTllMTVlNDFkZDFiOTBhNmJjMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwdbMmAH2gAyNDQyMjE2MzUxOjczNTQ4NzdkZjUwNjYzMWVjNjNlOWE4YzA1ZWIwNWFkMmE1YWJkMTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a612eba06eca398e4bf499e15e41dd1b90a6bc04", "author": {"user": {"login": "merlimat", "name": "Matteo Merli"}}, "url": "https://github.com/apache/pulsar/commit/a612eba06eca398e4bf499e15e41dd1b90a6bc04", "committedDate": "2020-06-30T18:20:03Z", "message": "Avoid NPEs at ledger creation when DNS failures happen"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDAwNTgw", "url": "https://github.com/apache/pulsar/pull/7403#pullrequestreview-440400580", "createdAt": "2020-06-30T21:30:39Z", "commit": {"oid": "a612eba06eca398e4bf499e15e41dd1b90a6bc04"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDA0ODcz", "url": "https://github.com/apache/pulsar/pull/7403#pullrequestreview-440404873", "createdAt": "2020-06-30T21:38:14Z", "commit": {"oid": "a612eba06eca398e4bf499e15e41dd1b90a6bc04"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMTozODoxNVrOGrPZoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMTozODoxNVrOGrPZoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5NDI3Mg==", "bodyText": "actually I don't think we need this change here. The exception is already handled in ledger.asyncCreateLedger", "url": "https://github.com/apache/pulsar/pull/7403#discussion_r447994272", "createdAt": "2020-06-30T21:38:15Z", "author": {"login": "sijie"}, "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorImpl.java", "diffHunk": "@@ -2283,73 +2283,78 @@ void internalFlushPendingMarkDeletes() {\n \n     void createNewMetadataLedger(final VoidCallback callback) {\n         ledger.mbean.startCursorLedgerCreateOp();\n-        ledger.asyncCreateLedger(bookkeeper, config, digestType, (rc, lh, ctx) -> {\n \n-            if (ledger.checkAndCompleteLedgerOpTask(rc, lh, ctx)) {\n-                return;\n-            }\n+        try {\n+            ledger.asyncCreateLedger(bookkeeper, config, digestType, (rc, lh, ctx) -> {\n \n-            ledger.getExecutor().execute(safeRun(() -> {\n-                ledger.mbean.endCursorLedgerCreateOp();\n-                if (rc != BKException.Code.OK) {\n-                    log.warn(\"[{}] Error creating ledger for cursor {}: {}\", ledger.getName(), name,\n-                            BKException.getMessage(rc));\n-                    callback.operationFailed(new ManagedLedgerException(BKException.getMessage(rc)));\n+                if (ledger.checkAndCompleteLedgerOpTask(rc, lh, ctx)) {\n                     return;\n                 }\n \n-                if (log.isDebugEnabled()) {\n-                    log.debug(\"[{}] Created ledger {} for cursor {}\", ledger.getName(), lh.getId(), name);\n-                }\n-                // Created the ledger, now write the last position\n-                // content\n-                MarkDeleteEntry mdEntry = lastMarkDeleteEntry;\n-                persistPositionToLedger(lh, mdEntry, new VoidCallback() {\n-                    @Override\n-                    public void operationComplete() {\n-                        if (log.isDebugEnabled()) {\n-                            log.debug(\"[{}] Persisted position {} for cursor {}\", ledger.getName(),\n-                                    mdEntry.newPosition, name);\n-                        }\n-                        switchToNewLedger(lh, new VoidCallback() {\n-                            @Override\n-                            public void operationComplete() {\n-                                callback.operationComplete();\n-                            }\n-\n-                            @Override\n-                            public void operationFailed(ManagedLedgerException exception) {\n-                                // it means it failed to switch the newly created ledger so, it should be\n-                                // deleted to prevent leak\n-                                bookkeeper.asyncDeleteLedger(lh.getId(), (int rc, Object ctx) -> {\n-                                    if (rc != BKException.Code.OK) {\n-                                        log.warn(\"[{}] Failed to delete orphan ledger {}\", ledger.getName(),\n-                                                lh.getId());\n-                                    }\n-                                }, null);\n-                                callback.operationFailed(exception);\n-                            }\n-                        });\n+                ledger.getExecutor().execute(safeRun(() -> {\n+                    ledger.mbean.endCursorLedgerCreateOp();\n+                    if (rc != BKException.Code.OK) {\n+                        log.warn(\"[{}] Error creating ledger for cursor {}: {}\", ledger.getName(), name,\n+                                BKException.getMessage(rc));\n+                        callback.operationFailed(new ManagedLedgerException(BKException.getMessage(rc)));\n+                        return;\n                     }\n \n-                    @Override\n-                    public void operationFailed(ManagedLedgerException exception) {\n-                        log.warn(\"[{}] Failed to persist position {} for cursor {}\", ledger.getName(),\n-                                mdEntry.newPosition, name);\n-\n-                        ledger.mbean.startCursorLedgerDeleteOp();\n-                        bookkeeper.asyncDeleteLedger(lh.getId(), new DeleteCallback() {\n-                            @Override\n-                            public void deleteComplete(int rc, Object ctx) {\n-                                ledger.mbean.endCursorLedgerDeleteOp();\n-                            }\n-                        }, null);\n-                        callback.operationFailed(exception);\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"[{}] Created ledger {} for cursor {}\", ledger.getName(), lh.getId(), name);\n                     }\n-                });\n-            }));\n-        }, LedgerMetadataUtils.buildAdditionalMetadataForCursor(name));\n+                    // Created the ledger, now write the last position\n+                    // content\n+                    MarkDeleteEntry mdEntry = lastMarkDeleteEntry;\n+                    persistPositionToLedger(lh, mdEntry, new VoidCallback() {\n+                        @Override\n+                        public void operationComplete() {\n+                            if (log.isDebugEnabled()) {\n+                                log.debug(\"[{}] Persisted position {} for cursor {}\", ledger.getName(),\n+                                        mdEntry.newPosition, name);\n+                            }\n+                            switchToNewLedger(lh, new VoidCallback() {\n+                                @Override\n+                                public void operationComplete() {\n+                                    callback.operationComplete();\n+                                }\n+\n+                                @Override\n+                                public void operationFailed(ManagedLedgerException exception) {\n+                                    // it means it failed to switch the newly created ledger so, it should be\n+                                    // deleted to prevent leak\n+                                    bookkeeper.asyncDeleteLedger(lh.getId(), (int rc, Object ctx) -> {\n+                                        if (rc != BKException.Code.OK) {\n+                                            log.warn(\"[{}] Failed to delete orphan ledger {}\", ledger.getName(),\n+                                                    lh.getId());\n+                                        }\n+                                    }, null);\n+                                    callback.operationFailed(exception);\n+                                }\n+                            });\n+                        }\n+\n+                        @Override\n+                        public void operationFailed(ManagedLedgerException exception) {\n+                            log.warn(\"[{}] Failed to persist position {} for cursor {}\", ledger.getName(),\n+                                    mdEntry.newPosition, name);\n \n+                            ledger.mbean.startCursorLedgerDeleteOp();\n+                            bookkeeper.asyncDeleteLedger(lh.getId(), new DeleteCallback() {\n+                                @Override\n+                                public void deleteComplete(int rc, Object ctx) {\n+                                    ledger.mbean.endCursorLedgerDeleteOp();\n+                                }\n+                            }, null);\n+                            callback.operationFailed(exception);\n+                        }\n+                    });\n+                }));\n+            }, LedgerMetadataUtils.buildAdditionalMetadataForCursor(name));\n+        } catch (Throwable t) {\n+            log.error(\"[{}] Encountered unexpected error when creating cursor ledger\", name, t);\n+            callback.operationFailed(new ManagedLedgerException(t));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a612eba06eca398e4bf499e15e41dd1b90a6bc04"}, "originalPosition": 132}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7354877df506631ec63e9a8c05eb05ad2a5abd12", "author": {"user": {"login": "merlimat", "name": "Matteo Merli"}}, "url": "https://github.com/apache/pulsar/commit/7354877df506631ec63e9a8c05eb05ad2a5abd12", "committedDate": "2020-06-30T22:31:24Z", "message": "Removed unnecessary try/catch"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 782, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}