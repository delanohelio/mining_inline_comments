{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNDM3ODEy", "number": 7211, "title": "Have metadata tailer use its own thread for processing", "bodyText": "(If this PR fixes a github issue, please add Fixes #<xyz>.)\nFixes #\n(or if this PR is one task of a github issue, please add Master Issue: #<xyz> to link to the master issue.)\nMaster Issue: #\nMotivation\nFollowing up on #7180, this pr does the same thing for function metadata tailer.\nModifications\nDescribe the modifications you've done.\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\n(Please pick either of the following options)\nThis change is a trivial rework / code cleanup without any test coverage.\n(or)\nThis change is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end deployment with large payloads (10MB)\nExtended integration test for recovery after broker failure\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API: (yes / no)\nThe schema: (yes / no / don't know)\nThe default values of configurations: (yes / no)\nThe wire protocol: (yes / no)\nThe rest endpoints: (yes / no)\nThe admin cli options: (yes / no)\nAnything that affects deployment: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)\nIf a feature is not applicable for documentation, explain why?\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-06-08T22:52:25Z", "url": "https://github.com/apache/pulsar/pull/7211", "merged": true, "mergeCommit": {"oid": "e64d951bb6002e07a64674a7373d945d3e224bb6"}, "closed": true, "closedAt": "2020-06-09T23:58:34Z", "author": {"login": "srkukarni"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpYgt1AH2gAyNDMxNDM3ODEyOjViODU0ODBjN2U0NzgwOTYwYTNkYzNkNmMyY2IwOWM5OGUyZDc3OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcprU9HgFqTQyNzUzMTg0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5b85480c7e4780960a3dc3d6c2cb09c98e2d7791", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/5b85480c7e4780960a3dc3d6c2cb09c98e2d7791", "committedDate": "2020-06-08T22:50:26Z", "message": "Have metadata tailer use its own thread for processing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9abea6679a59d76070f6dd19ca901e64b51f0ee", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/b9abea6679a59d76070f6dd19ca901e64b51f0ee", "committedDate": "2020-06-09T04:08:39Z", "message": "Merge branch 'master' into metadata_tailer_thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dd8c3ade97bf9436e0d985d57b3c800498f7d79", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/4dd8c3ade97bf9436e0d985d57b3c800498f7d79", "committedDate": "2020-06-09T04:20:31Z", "message": "Merged with master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3Mzc1MDcz", "url": "https://github.com/apache/pulsar/pull/7211#pullrequestreview-427375073", "createdAt": "2020-06-09T17:14:01Z", "commit": {"oid": "4dd8c3ade97bf9436e0d985d57b3c800498f7d79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNzoxNDowMVrOGhUaPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNzoxNDowMVrOGhUaPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU5MDU4OQ==", "bodyText": "Should we just remove the try-catch and let the method throw an exception? Everything is caught in the thread anyways.", "url": "https://github.com/apache/pulsar/pull/7211#discussion_r437590589", "createdAt": "2020-06-09T17:14:01Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/FunctionMetaDataTopicTailer.java", "diffHunk": "@@ -69,28 +106,13 @@ public void processRequest(Message<byte[]> msg) {\n             serviceRequest = ServiceRequest.parseFrom(msg.getData());\n         } catch (IOException e) {\n             log.error(\"Received bad service request at message {}\", msg.getMessageId(), e);\n-            // TODO: find a better way to handle bad request\n-            throw new RuntimeException(e);\n+            errorNotifier.triggerError(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dd8c3ade97bf9436e0d985d57b3c800498f7d79"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3Mzc2NDI3", "url": "https://github.com/apache/pulsar/pull/7211#pullrequestreview-427376427", "createdAt": "2020-06-09T17:15:48Z", "commit": {"oid": "4dd8c3ade97bf9436e0d985d57b3c800498f7d79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNzoxNTo0OFrOGhUePA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNzoxNTo0OFrOGhUePA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU5MTYxMg==", "bodyText": "Can you also set the subscription prefix:\nsubscriptionRolePrefix(workerConfig.getWorkerId() + \"-function-metadata-manager\")", "url": "https://github.com/apache/pulsar/pull/7211#discussion_r437591612", "createdAt": "2020-06-09T17:15:48Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/FunctionMetaDataTopicTailer.java", "diffHunk": "@@ -19,47 +19,84 @@\n package org.apache.pulsar.functions.worker;\n \n import java.io.IOException;\n-import java.util.function.Function;\n \n+import lombok.Getter;\n import lombok.extern.slf4j.Slf4j;\n import org.apache.pulsar.client.api.Message;\n-import org.apache.pulsar.client.api.PulsarClientException;\n+import org.apache.pulsar.client.api.MessageId;\n import org.apache.pulsar.client.api.Reader;\n+import org.apache.pulsar.client.api.ReaderBuilder;\n+import org.apache.pulsar.client.api.PulsarClientException;\n import org.apache.pulsar.functions.proto.Request.ServiceRequest;\n \n @Slf4j\n public class FunctionMetaDataTopicTailer\n-        implements java.util.function.Consumer<Message<byte[]>>, Function<Throwable, Void>, AutoCloseable {\n+        implements Runnable, AutoCloseable {\n \n     private final FunctionMetaDataManager functionMetaDataManager;\n+    @Getter\n     private final Reader<byte[]> reader;\n+    private final Thread readerThread;\n+    private volatile boolean running;\n+    private ErrorNotifier errorNotifier;\n \n     public FunctionMetaDataTopicTailer(FunctionMetaDataManager functionMetaDataManager,\n-                                       Reader<byte[]> reader)\n+                                       ReaderBuilder readerBuilder, WorkerConfig workerConfig,\n+                                       ErrorNotifier errorNotifier)\n             throws PulsarClientException {\n         this.functionMetaDataManager = functionMetaDataManager;\n-        this.reader = reader;\n+        this.reader = readerBuilder\n+                .topic(workerConfig.getFunctionMetadataTopic())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dd8c3ade97bf9436e0d985d57b3c800498f7d79"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d688da891f3aed76d00677db5bf28d1fac83dfb", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/7d688da891f3aed76d00677db5bf28d1fac83dfb", "committedDate": "2020-06-09T17:32:14Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1beab6a25bc90795624b0317bd8490a1a22ae89e", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/1beab6a25bc90795624b0317bd8490a1a22ae89e", "committedDate": "2020-06-09T18:52:07Z", "message": "Merge branch 'master' into metadata_tailer_thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d783b87c616152bb53a9b8fed6993b3768985ed2", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/d783b87c616152bb53a9b8fed6993b3768985ed2", "committedDate": "2020-06-09T18:56:35Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTMxODQw", "url": "https://github.com/apache/pulsar/pull/7211#pullrequestreview-427531840", "createdAt": "2020-06-09T20:45:47Z", "commit": {"oid": "d783b87c616152bb53a9b8fed6993b3768985ed2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2801, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}