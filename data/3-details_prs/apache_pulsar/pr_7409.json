{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNTI2MTUx", "number": 7409, "title": "Fix batch ackset recycled multiple times.", "bodyText": "Fixes #7384\nMotivation\nFix batch ackset recycled multiple times. The root cause is a race condition in group ack flush and cumulative Ack. So add recycled state check for the ackset.\nVerifying this change\nNew unit test added.\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (no)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)", "createdAt": "2020-07-01T08:19:30Z", "url": "https://github.com/apache/pulsar/pull/7409", "merged": true, "mergeCommit": {"oid": "25a690734f278299bfdaae118a2c02ecc25c125e"}, "closed": true, "closedAt": "2020-07-06T16:40:34Z", "author": {"login": "codelipenghui"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwlyF_gH2gAyNDQyNTI2MTUxOjRhNjMyY2RiYTBmNzhhZmI4YWRmNDk3ZWI5NmU4NzMzNzY0MDI4YzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyT__NgFqTQ0MzI0MDAzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4a632cdba0f78afb8adf497eb96e8733764028c4", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/4a632cdba0f78afb8adf497eb96e8733764028c4", "committedDate": "2020-07-01T08:15:39Z", "message": "Fix batch ackset recycled multiple times."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODIyNzA4", "url": "https://github.com/apache/pulsar/pull/7409#pullrequestreview-440822708", "createdAt": "2020-07-01T12:28:57Z", "commit": {"oid": "4a632cdba0f78afb8adf497eb96e8733764028c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoyODo1N1rOGrjzwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjoyODo1N1rOGrjzwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMyODY0MA==", "bodyText": "This is still not safe. There cannot be a race condition to resolve the recycling.\nIn this case it can happen:\n\nthread-1 calls recycle and CAS succeeds\nthread-2 gets a the object from pool\nthread-3 sees recycled==false and does the CAS again, recycle a different object that is in use.\n\nYou cannot use Recyclable for objects with a shared ownership. Either change the logic to avoid race conditions, or use ref-counting.", "url": "https://github.com/apache/pulsar/pull/7409#discussion_r448328640", "createdAt": "2020-07-01T12:28:57Z", "author": {"login": "merlimat"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/util/collections/BitSetRecyclable.java", "diffHunk": "@@ -1197,11 +1199,13 @@ private BitSetRecyclable(Handle<BitSetRecyclable> recyclerHandle) {\n     }\n \n     public static BitSetRecyclable create() {\n-        return RECYCLER.get();\n+        BitSetRecyclable instance = RECYCLER.get();\n+        instance.recycled.set(false);\n+        return instance;\n     }\n \n     public void recycle() {\n-        if (recyclerHandle != null) {\n+        if (recyclerHandle != null && recycled.compareAndSet(false, true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a632cdba0f78afb8adf497eb96e8733764028c4"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "067c4509dc9615c969557178180cb44bf47cc15b", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/067c4509dc9615c969557178180cb44bf47cc15b", "committedDate": "2020-07-02T07:37:25Z", "message": "Apply comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMDkyNDkx", "url": "https://github.com/apache/pulsar/pull/7409#pullrequestreview-442092491", "createdAt": "2020-07-03T01:06:48Z", "commit": {"oid": "067c4509dc9615c969557178180cb44bf47cc15b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMTowNjo0OFrOGsg36w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMTowNjo0OFrOGsg36w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMyOTEzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.util.concurrent.atomic.AtomicBoolean;", "url": "https://github.com/apache/pulsar/pull/7409#discussion_r449329131", "createdAt": "2020-07-03T01:06:48Z", "author": {"login": "codelipenghui"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/util/collections/BitSetRecyclable.java", "diffHunk": "@@ -27,6 +27,7 @@\n import java.nio.LongBuffer;\n import java.util.Arrays;\n import java.util.BitSet;\n+import java.util.concurrent.atomic.AtomicBoolean;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "067c4509dc9615c969557178180cb44bf47cc15b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b72bf7880c3b9c000d74ff8bdda1ff892e0c6dc", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/7b72bf7880c3b9c000d74ff8bdda1ff892e0c6dc", "committedDate": "2020-07-03T01:06:54Z", "message": "Update pulsar-common/src/main/java/org/apache/pulsar/common/util/collections/BitSetRecyclable.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjQwMDMx", "url": "https://github.com/apache/pulsar/pull/7409#pullrequestreview-443240031", "createdAt": "2020-07-06T16:40:23Z", "commit": {"oid": "7b72bf7880c3b9c000d74ff8bdda1ff892e0c6dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 506, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}