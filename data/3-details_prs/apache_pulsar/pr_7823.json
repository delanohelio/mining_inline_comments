{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NDgyNjM0", "number": 7823, "title": "[pulsar-client] Avoid subscribing the same topic again", "bodyText": "Motivation\nThe current key of MultiTopicsConsumerImpl.topics is the topic name passed by user. The topicNameValid method checks if the name is valid and topics doesn't contain the key.\nHowever, if a multi topics consumer subscribed a partition of a subscribed partitioned topic,  subscribeAsync succeed and a new ConsumerImpl of the same partition was created, which is redundant.\nAlso, if a multi topics consumer subscribed public/default/topic or persistent://public/default/topic, while the initial subscribed topic is topic, the redundant consumers would be created.\nModifications\n\nUse full topic name as key of MultiTopicsConsumerImpl.topics\nCheck both full topic name and full partitioned topic name not exist in MultiTopicsConsumerImpl.topics when subscribeAsync is called\nThrow a different exception to differ topic is invalid and topic is already subscribed\nAdd a unit test for subscribing a partition of a subscribed partitioned topic or the same topic with prefix", "createdAt": "2020-08-16T19:01:31Z", "url": "https://github.com/apache/pulsar/pull/7823", "merged": true, "mergeCommit": {"oid": "e1b76a32ea810cecd515b1fc1aab5d280cfacd3f"}, "closed": true, "closedAt": "2020-08-17T12:49:54Z", "author": {"login": "BewareMyPower"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-ydE8AH2gAyNDY4NDgyNjM0OjVlYTY2NmYwYTBhZWUxNGY4NmRjOWUzOWFhMmM3NTc1NGNjMjE3YzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_vWS0AFqTQ2ODMyNDA0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ea666f0a0aee14f86dc9e39aa2c75754cc217c2", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/5ea666f0a0aee14f86dc9e39aa2c75754cc217c2", "committedDate": "2020-08-14T10:56:24Z", "message": "Use full topic name as key of topics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64dc38a3512ddbd5de5558796f577aa8b9a0d0d1", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/64dc38a3512ddbd5de5558796f577aa8b9a0d0d1", "committedDate": "2020-08-16T17:41:15Z", "message": "Fix unit tests error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30d5c2b61a61168d387056cad8cafc2cb59ca10d", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/30d5c2b61a61168d387056cad8cafc2cb59ca10d", "committedDate": "2020-08-16T18:40:00Z", "message": "Add unit tests of resubscribing the same topic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MTE5OTYw", "url": "https://github.com/apache/pulsar/pull/7823#pullrequestreview-468119960", "createdAt": "2020-08-17T01:29:58Z", "commit": {"oid": "30d5c2b61a61168d387056cad8cafc2cb59ca10d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwMToyOTo1OFrOHBXJxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwMTo0NDoxM1rOHBXT3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4OTk1OA==", "bodyText": "Why remove !topicNameValid(topicName) ? I think we should return Topic name not valid when the topic name does not valid and return Already subscribe to {} for the duplicate topic name.", "url": "https://github.com/apache/pulsar/pull/7823#discussion_r471189958", "createdAt": "2020-08-17T01:29:58Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/MultiTopicsConsumerImpl.java", "diffHunk": "@@ -720,16 +720,36 @@ private void removeExpiredMessagesFromQueue(Set<MessageId> messageIds) {\n         }\n     }\n \n-    private boolean topicNameValid(String topicName) {\n-        return TopicName.isValid(topicName) && !topics.containsKey(topicName);\n+    private TopicName getTopicName(String topic) {\n+        try {\n+            return TopicName.get(topic);\n+        } catch (Exception ignored) {\n+            return null;\n+        }\n+    }\n+\n+    private String getFullTopicName(String topic) {\n+        TopicName topicName = getTopicName(topic);\n+        return (topicName != null) ? topicName.toString() : null;\n+    }\n+\n+    private void removeTopic(String topic) {\n+        String fullTopicName = getFullTopicName(topic);\n+        if (fullTopicName != null) {\n+            topics.remove(topic);\n+        }\n     }\n \n     // subscribe one more given topic\n     public CompletableFuture<Void> subscribeAsync(String topicName, boolean createTopicIfDoesNotExist) {\n-        if (!topicNameValid(topicName)) {\n+        TopicName topicNameInstance = getTopicName(topicName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d5c2b61a61168d387056cad8cafc2cb59ca10d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE5MjU0MQ==", "bodyText": "It seems that we do not need to add these methods?", "url": "https://github.com/apache/pulsar/pull/7823#discussion_r471192541", "createdAt": "2020-08-17T01:44:13Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/MultiTopicsConsumerImpl.java", "diffHunk": "@@ -720,16 +720,36 @@ private void removeExpiredMessagesFromQueue(Set<MessageId> messageIds) {\n         }\n     }\n \n-    private boolean topicNameValid(String topicName) {\n-        return TopicName.isValid(topicName) && !topics.containsKey(topicName);\n+    private TopicName getTopicName(String topic) {\n+        try {\n+            return TopicName.get(topic);\n+        } catch (Exception ignored) {\n+            return null;\n+        }\n+    }\n+\n+    private String getFullTopicName(String topic) {\n+        TopicName topicName = getTopicName(topic);\n+        return (topicName != null) ? topicName.toString() : null;\n+    }\n+\n+    private void removeTopic(String topic) {\n+        String fullTopicName = getFullTopicName(topic);\n+        if (fullTopicName != null) {\n+            topics.remove(topic);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30d5c2b61a61168d387056cad8cafc2cb59ca10d"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MjAxMjg1", "url": "https://github.com/apache/pulsar/pull/7823#pullrequestreview-468201285", "createdAt": "2020-08-17T06:47:49Z", "commit": {"oid": "30d5c2b61a61168d387056cad8cafc2cb59ca10d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "325de4e75ff9f2f471c328aa346741a346913ace", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/325de4e75ff9f2f471c328aa346741a346913ace", "committedDate": "2020-08-17T08:54:55Z", "message": "Return already subscribed error for duplicated topic name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75401f42481e07b8244375f73c3266e27840195b", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/75401f42481e07b8244375f73c3266e27840195b", "committedDate": "2020-08-17T09:29:36Z", "message": "Add unit tests for subscribing the same topic with prefix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "733281ebd17fa427debade07dad1d4fc30ffbedc", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/733281ebd17fa427debade07dad1d4fc30ffbedc", "committedDate": "2020-08-17T09:47:02Z", "message": "Change topic name to be consistent with test name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MzI0MDQ4", "url": "https://github.com/apache/pulsar/pull/7823#pullrequestreview-468324048", "createdAt": "2020-08-17T09:53:12Z", "commit": {"oid": "733281ebd17fa427debade07dad1d4fc30ffbedc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 281, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}