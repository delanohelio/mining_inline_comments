{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMTgxNzMw", "number": 7010, "title": "Fix null pointer when getting function instance metrics.", "bodyText": "(If this PR fixes a github issue, please add Fixes #<xyz>.)\nFixes #\n(or if this PR is one task of a github issue, please add Master Issue: #<xyz> to link to the master issue.)\nMaster Issue: #\nMotivation\nstats is an internal variable inside JavaInstanceRunnable that shouldn't be needlessly exposed.\nThis pr fixes its access(as well as a couple of other exposed variables which are never accessed outside the class).\nModifications\nDescribe the modifications you've done.\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\n(Please pick either of the following options)\nThis change is a trivial rework / code cleanup without any test coverage.\n(or)\nThis change is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end deployment with large payloads (10MB)\nExtended integration test for recovery after broker failure\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API: (yes / no)\nThe schema: (yes / no / don't know)\nThe default values of configurations: (yes / no)\nThe wire protocol: (yes / no)\nThe rest endpoints: (yes / no)\nThe admin cli options: (yes / no)\nAnything that affects deployment: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)\nIf a feature is not applicable for documentation, explain why?\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-05-21T06:46:21Z", "url": "https://github.com/apache/pulsar/pull/7010", "merged": true, "mergeCommit": {"oid": "20320c7ca15498f5655668e99cce286be381c76d"}, "closed": true, "closedAt": "2020-05-22T18:32:18Z", "author": {"login": "srkukarni"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjX4mMAH2gAyNDIxMTgxNzMwOjhjYzEyMGM1MzM4YzEyNGMxZDc0Mjg5ODJlOGZjOTc1ZDEwODZhMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjxnR4gH2gAyNDIxMTgxNzMwOmVkNTEwOGE2OWJlMjU4ZThlMTRiYTZjYTVmZGQzOTBiNTI2YjUyNzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8cc120c5338c124c1d7428982e8fc975d1086a26", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/8cc120c5338c124c1d7428982e8fc975d1086a26", "committedDate": "2020-05-21T06:43:04Z", "message": "Fix null pointer when getting function instance metrics."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8828accf43c48c42f229fcb326bc76b9e69c1e37", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/8828accf43c48c42f229fcb326bc76b9e69c1e37", "committedDate": "2020-05-21T07:20:48Z", "message": "Made more functions sync"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTM2NDUx", "url": "https://github.com/apache/pulsar/pull/7010#pullrequestreview-415936451", "createdAt": "2020-05-21T07:30:34Z", "commit": {"oid": "8828accf43c48c42f229fcb326bc76b9e69c1e37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MjUwMDcw", "url": "https://github.com/apache/pulsar/pull/7010#pullrequestreview-416250070", "createdAt": "2020-05-21T15:29:27Z", "commit": {"oid": "8828accf43c48c42f229fcb326bc76b9e69c1e37"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNToyOToyN1rOGY3hKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNToyOToyN1rOGY3hKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyODYxNw==", "bodyText": "We should synchronize this method as well?\nAlso line 241 (run() method) accesses the stats variable and the close() method does too. Difference threads access these methods and change the stats variable. It's the same for other variables in this class.", "url": "https://github.com/apache/pulsar/pull/7010#discussion_r428728617", "createdAt": "2020-05-21T15:29:27Z", "author": {"login": "cckellogg"}, "path": "pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java", "diffHunk": "@@ -801,4 +810,12 @@ public void setupOutput(ContextImpl contextImpl) throws Exception {\n             Thread.currentThread().setContextClassLoader(this.instanceClassLoader);\n         }\n     }\n+\n+    public String getStatsAsString() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8828accf43c48c42f229fcb326bc76b9e69c1e37"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0e8c980cfc7e62af19a71c58a1698de5ba2af55", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/b0e8c980cfc7e62af19a71c58a1698de5ba2af55", "committedDate": "2020-05-21T15:34:22Z", "message": "Made the remaining public interface synchronized"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MzUzMDIw", "url": "https://github.com/apache/pulsar/pull/7010#pullrequestreview-416353020", "createdAt": "2020-05-21T17:37:14Z", "commit": {"oid": "b0e8c980cfc7e62af19a71c58a1698de5ba2af55"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1341ad8b529559b2c2021cc57dae5c870b069862", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/1341ad8b529559b2c2021cc57dae5c870b069862", "committedDate": "2020-05-21T18:53:22Z", "message": "Made stats class public method synchronized so they are thread safe."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5edf17c0ea4ed017ea3ffbc42088e6fb5951b7b5", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/5edf17c0ea4ed017ea3ffbc42088e6fb5951b7b5", "committedDate": "2020-05-21T18:58:55Z", "message": "Made setup synchronized so that it and close won't run together"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NDEzMDE4", "url": "https://github.com/apache/pulsar/pull/7010#pullrequestreview-416413018", "createdAt": "2020-05-21T19:04:07Z", "commit": {"oid": "5edf17c0ea4ed017ea3ffbc42088e6fb5951b7b5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf04dc78f73951c993d289786d166496b17a51f8", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/bf04dc78f73951c993d289786d166496b17a51f8", "committedDate": "2020-05-21T21:00:59Z", "message": "Undo making stats sync until we resolve differences"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTA1MDI1", "url": "https://github.com/apache/pulsar/pull/7010#pullrequestreview-416505025", "createdAt": "2020-05-21T21:27:12Z", "commit": {"oid": "bf04dc78f73951c993d289786d166496b17a51f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToyNzoxMlrOGZDeUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToyNzoxMlrOGZDeUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkyNDQ5OQ==", "bodyText": "Even though synchronized methods are re-entrant in Java, it still appears a little weird that a synchronized getMetrics() be called inside another synchronized method \"getAndResetMetrics()\".  Maybe have another \"base\" private method that gets called by both that is not synchronized?\nA side note, I think in the future, we might want to define more interfaces for \"modules\" in functions, so that it is more clear on what methods should be exposed.", "url": "https://github.com/apache/pulsar/pull/7010#discussion_r428924499", "createdAt": "2020-05-21T21:27:12Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/instance/JavaInstanceRunnable.java", "diffHunk": "@@ -546,13 +547,17 @@ synchronized public void close() {\n         }\n     }\n \n-    public InstanceCommunication.MetricsData getAndResetMetrics() {\n+    // This method is synchronized because it is using the stats variable\n+    synchronized public InstanceCommunication.MetricsData getAndResetMetrics() {\n         InstanceCommunication.MetricsData metricsData = getMetrics();\n-        stats.reset();\n+        if (stats != null) {\n+            stats.reset();\n+        }\n         return metricsData;\n     }\n \n-    public InstanceCommunication.MetricsData getMetrics() {\n+    // This method is synchronized because it is using the stats and javaInstance variables\n+    synchronized public InstanceCommunication.MetricsData getMetrics() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf04dc78f73951c993d289786d166496b17a51f8"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1574f8ee1857a7598f6ecfed4dfd2fd4070c5282", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/1574f8ee1857a7598f6ecfed4dfd2fd4070c5282", "committedDate": "2020-05-21T23:31:52Z", "message": "Incorporated feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NjQ3MjQx", "url": "https://github.com/apache/pulsar/pull/7010#pullrequestreview-416647241", "createdAt": "2020-05-22T04:56:17Z", "commit": {"oid": "bf04dc78f73951c993d289786d166496b17a51f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed5108a69be258e8e14ba6ca5fdd390b526b5277", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/ed5108a69be258e8e14ba6ca5fdd390b526b5277", "committedDate": "2020-05-22T12:41:41Z", "message": "Merge branch 'master' into nullptr_exception"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3535, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}