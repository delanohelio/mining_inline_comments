{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzODQ4Mjgy", "number": 6471, "title": "[Issue #5395][broker] Implement AutoTopicCreation by namespace override", "bodyText": "Fixes #5395\nMotivation\nThis change introduces a new namespace policy autoTopicCreationOverride, which will enable an override of broker autoTopicCreation settings on the namespace level. You may keep autoTopicCreation disabled for the broker and allow it on a specific namespace using this feature.\nModifications\n\nAdd new namespace policy: autoTopicCreationOverride and associated API / CLI interface for setting and removing. Defaults to non-partitioned type, but also allows partitioned topics.\nModifies BrokerService: when checking autoTopicCreation configuration, the broker first retrieves namespace policies from zookeeper. If the autoTopicCreationOverride policy exists for that namespace then it uses those settings. If not, falls back to broker configuration.\nSlight refactor to move TopicType enum to pulsar-common and add autoTopicCreationOverride to pulsar-common.\n\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\n(Please pick either of the following options)\nThis change added tests and can be verified as follows:\n\nExtended BrokerServiceAutoTopicCreationTest to test the overriding behavior of the namespace policy including both non-partitioned & partitioned topics.\nCreated AutoTopicCreationOverrideTest to ensure policy validation only allows valid policies.\n\nDoes this pull request potentially affect one of the following parts:\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (yes: new POST and DELETE for /{tenant}/{namespace}/allowAutoTopicCreationOverride in order to set new namespace policy)\nThe schema: (don't know)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (yes: new POST and DELETE for /{tenant}/{namespace}/allowAutoTopicCreationOverride in order to set new namespace policy)\nThe admin cli options: (yes: new set-allow-auto-topic-creation-override and delete-allow-auto-topic-creation-override)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes)\nIf yes, how is the feature documented? (JavaDocs)", "createdAt": "2020-03-04T20:18:26Z", "url": "https://github.com/apache/pulsar/pull/6471", "merged": true, "mergeCommit": {"oid": "fdc3a9bc8f04c4e424fec90a636a4aa25b35dcd8"}, "closed": true, "closedAt": "2020-03-26T06:59:44Z", "author": {"login": "klevy-toast"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDdtg-gH2gAyMzgzODQ4MjgyOjllNmVlMjUyY2QwYWExZDM3NTcwZDg3NGIxM2YyNWJhMjg5MzY0MWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRJYwjgH2gAyMzgzODQ4MjgyOmYyMzdiMjIxMDRjOTNjOWZkZWVlYjNhNGU5MDY2ZDY4NTM4ODE3NDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9e6ee252cd0aa1d37570d874b13f25ba2893641c", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/9e6ee252cd0aa1d37570d874b13f25ba2893641c", "committedDate": "2020-02-12T03:24:49Z", "message": "Add allowAutoTopicCreation option to policies and CLI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f60eeae6a970513f00ba05c96c1170291cd98ef1", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/f60eeae6a970513f00ba05c96c1170291cd98ef1", "committedDate": "2020-02-12T05:46:59Z", "message": "Auto-create by namespace MVP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e960426c69cf8ea5ee402eecd6baae5d894bd809", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/e960426c69cf8ea5ee402eecd6baae5d894bd809", "committedDate": "2020-02-22T02:04:07Z", "message": "Refactor to allow partitioned topics, added tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb50b3b35817257cb0fbfd10e969d469622193e2", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/bb50b3b35817257cb0fbfd10e969d469622193e2", "committedDate": "2020-02-22T02:06:01Z", "message": "Merge branch 'master' into feature/autocreate-by-namespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a92e59423ce88686ec43056cf377a3f67139182", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/0a92e59423ce88686ec43056cf377a3f67139182", "committedDate": "2020-02-22T02:19:52Z", "message": "Cleanup commented code, imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bd458f2eab3c0b4025e1b2655999c9f144caea4", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/8bd458f2eab3c0b4025e1b2655999c9f144caea4", "committedDate": "2020-02-22T02:48:10Z", "message": "Tweak override validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49f443c02565aa5510cfab0395677b71e05fb626", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/49f443c02565aa5510cfab0395677b71e05fb626", "committedDate": "2020-02-22T03:09:03Z", "message": "More cleanup, documentation, tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0752ccf2e8da69f13a7bf045e7e679278702fe5d", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/0752ccf2e8da69f13a7bf045e7e679278702fe5d", "committedDate": "2020-02-27T16:53:21Z", "message": "Add default partition type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee3a3dc37734bbd8b8243cb31c26f7f3424eac19", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/ee3a3dc37734bbd8b8243cb31c26f7f3424eac19", "committedDate": "2020-02-27T22:03:00Z", "message": "Add license to new pulsar-common files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "454b8c03ca5457a022451f7b28ef16d2387d06eb", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/454b8c03ca5457a022451f7b28ef16d2387d06eb", "committedDate": "2020-03-03T16:13:25Z", "message": "Remove null check that could cause silent failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f31397884a0ba5fc8c671c9cb0b89d61745ecd3", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/4f31397884a0ba5fc8c671c9cb0b89d61745ecd3", "committedDate": "2020-03-03T22:57:10Z", "message": "Switch back to synchronous policy retreival"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5aa45f870d879e80240be50b0775bbec892d6de", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/d5aa45f870d879e80240be50b0775bbec892d6de", "committedDate": "2020-03-04T19:28:09Z", "message": "Merge branch 'master' into feature/autocreate-by-namespace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzE5NDIy", "url": "https://github.com/apache/pulsar/pull/6471#pullrequestreview-370719422", "createdAt": "2020-03-07T03:37:43Z", "commit": {"oid": "d5aa45f870d879e80240be50b0775bbec892d6de"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMzozNzo0M1rOFzMW6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMzozODowMFrOFzMW9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyNDE2OA==", "bodyText": "It's better to leverage with AsyncResponse, you can take a look https://github.com/apache/pulsar/blob/master/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/PersistentTopics.java#L198.", "url": "https://github.com/apache/pulsar/pull/6471#discussion_r389224168", "createdAt": "2020-03-07T03:37:43Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/Namespaces.java", "diffHunk": "@@ -298,6 +299,28 @@ public void modifyDeduplication(@PathParam(\"tenant\") String tenant, @PathParam(\"\n         internalModifyDeduplication(enableDeduplication);\n     }\n \n+    @POST\n+    @Path(\"/{tenant}/{namespace}/allowAutoTopicCreationOverride\")\n+    @ApiOperation(value = \"Override broker's allowAutoTopicCreation setting for a namespace\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Tenant or cluster or namespace doesn't exist\"),\n+            @ApiResponse(code = 400, message = \"Invalid autoTopicCreation override\") })\n+    public void setAllowAutoTopicCreationOverride(@PathParam(\"tenant\") String tenant, @PathParam(\"namespace\") String namespace,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa45f870d879e80240be50b0775bbec892d6de"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyNDE4Mw==", "bodyText": "Same as above comment.", "url": "https://github.com/apache/pulsar/pull/6471#discussion_r389224183", "createdAt": "2020-03-07T03:38:00Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/Namespaces.java", "diffHunk": "@@ -298,6 +299,28 @@ public void modifyDeduplication(@PathParam(\"tenant\") String tenant, @PathParam(\"\n         internalModifyDeduplication(enableDeduplication);\n     }\n \n+    @POST\n+    @Path(\"/{tenant}/{namespace}/allowAutoTopicCreationOverride\")\n+    @ApiOperation(value = \"Override broker's allowAutoTopicCreation setting for a namespace\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Tenant or cluster or namespace doesn't exist\"),\n+            @ApiResponse(code = 400, message = \"Invalid autoTopicCreation override\") })\n+    public void setAllowAutoTopicCreationOverride(@PathParam(\"tenant\") String tenant, @PathParam(\"namespace\") String namespace,\n+                                                  AutoTopicCreationOverride autoTopicCreationOverride) {\n+        validateNamespaceName(tenant, namespace);\n+        internalSetAllowAutoTopicCreationOverride(autoTopicCreationOverride);\n+    }\n+\n+    @DELETE\n+    @Path(\"/{tenant}/{namespace}/allowAutoTopicCreationOverride\")\n+    @ApiOperation(value = \"Remove override of broker's allowAutoTopicCreation in a namespace\")\n+    @ApiResponses(value = { @ApiResponse(code = 403, message = \"Don't have admin permission\"),\n+            @ApiResponse(code = 404, message = \"Tenant or cluster or namespace doesn't exist\") })\n+    public void removeAllowAutoTopicCreationOverride(@PathParam(\"tenant\") String tenant, @PathParam(\"namespace\") String namespace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5aa45f870d879e80240be50b0775bbec892d6de"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bee6179510f56e347259e45d2fd07ff67c689325", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/bee6179510f56e347259e45d2fd07ff67c689325", "committedDate": "2020-03-09T16:59:24Z", "message": "Merge branch 'master' into feature/autocreate-by-namespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "423562b873fd7370756e01c94553311db282646b", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/423562b873fd7370756e01c94553311db282646b", "committedDate": "2020-03-10T18:46:02Z", "message": "Make API async, renaming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Nzg0NzE5", "url": "https://github.com/apache/pulsar/pull/6471#pullrequestreview-374784719", "createdAt": "2020-03-15T09:48:08Z", "commit": {"oid": "423562b873fd7370756e01c94553311db282646b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQwOTo0ODowOVrOF2d6gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQwOTo0ODoyNlrOF2d6lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY1NzUzNg==", "bodyText": "We'd better complete the asyncResponse when there are RunTimeException occurs. Otherwise, the client just can get a 500 response but can't get any error messages.", "url": "https://github.com/apache/pulsar/pull/6471#discussion_r392657536", "createdAt": "2020-03-15T09:48:09Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -554,6 +555,105 @@ protected void internalSetNamespaceMessageTTL(int messageTTL) {\n         }\n     }\n \n+    protected void internalSetAutoTopicCreationOverride(AsyncResponse asyncResponse, AutoTopicCreationOverride autoTopicCreationOverride) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+\n+        if (!AutoTopicCreationOverride.isValidOverride(autoTopicCreationOverride)) {\n+            throw new RestException(Status.PRECONDITION_FAILED, \"Invalid configuration for autoTopicCreationOverride\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "423562b873fd7370756e01c94553311db282646b"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY1NzU1Nw==", "bodyText": "Same as above comment.", "url": "https://github.com/apache/pulsar/pull/6471#discussion_r392657557", "createdAt": "2020-03-15T09:48:26Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -554,6 +555,105 @@ protected void internalSetNamespaceMessageTTL(int messageTTL) {\n         }\n     }\n \n+    protected void internalSetAutoTopicCreationOverride(AsyncResponse asyncResponse, AutoTopicCreationOverride autoTopicCreationOverride) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+\n+        if (!AutoTopicCreationOverride.isValidOverride(autoTopicCreationOverride)) {\n+            throw new RestException(Status.PRECONDITION_FAILED, \"Invalid configuration for autoTopicCreationOverride\");\n+        }\n+\n+        // Force to read the data s.t. the watch to the cache content is setup.\n+        policiesCache().getWithStatAsync(path(POLICIES, namespaceName.toString())).thenApply(\n+                policies -> {\n+                    if (policies.isPresent()) {\n+                        Entry<Policies, Stat> policiesNode = policies.get();\n+                        policiesNode.getKey().autoTopicCreationOverride = autoTopicCreationOverride;\n+                        try {\n+                            // Write back the new policies into zookeeper\n+                            globalZk().setData(path(POLICIES, namespaceName.toString()),\n+                                    jsonMapper().writeValueAsBytes(policiesNode.getKey()), policiesNode.getValue().getVersion());\n+                            policiesCache().invalidate(path(POLICIES, namespaceName.toString()));\n+                            asyncResponse.resume(Response.noContent().build());\n+                            log.info(\"[{}] Successfully {} on namespace {}\", clientAppId(),\n+                                    autoTopicCreationOverride.allowAutoTopicCreation ? \"enabled\" : \"disabled\", namespaceName);\n+                            return null;\n+                        } catch (KeeperException.NoNodeException e) {\n+                            log.error(\"[{}] Failed to modify autoTopicCreation status for namespace {}: does not exist\", clientAppId(),\n+                                    namespaceName);\n+                            asyncResponse.resume(new RestException(Status.NOT_FOUND, \"Namespace does not exist\"));\n+                            return null;\n+                        } catch (KeeperException.BadVersionException e) {\n+                            log.error(\n+                                    \"[{}] Failed to modify autoTopicCreation status on namespace {} expected policy node version={} : concurrent modification\",\n+                                    clientAppId(), namespaceName, policiesNode.getValue().getVersion());\n+\n+                            asyncResponse.resume(new RestException(Status.CONFLICT, \"Concurrent modification\"));\n+                            return null;\n+                        } catch (Exception e) {\n+                            log.error(\"[{}] Failed to modify autoTopicCreation status on namespace {}\", clientAppId(), namespaceName, e);\n+                            asyncResponse.resume(new RestException(e));\n+                            return null;\n+                        }\n+                    } else {\n+                        asyncResponse.resume(new RestException(Status.NOT_FOUND, \"Namespace \" + namespaceName + \" does not exist\"));\n+                        return null;\n+                    }\n+                }\n+        ).exceptionally(e -> {\n+            log.error(\"[{}] Failed to modify autoTopicCreation status on namespace {}\", clientAppId(), namespaceName, e);\n+            asyncResponse.resume(new RestException(e));\n+            return null;\n+        });\n+    }\n+\n+    protected void internalRemoveAutoTopicCreationOverride(AsyncResponse asyncResponse) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "423562b873fd7370756e01c94553311db282646b"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "163811add3f869b4e0aca6f820ac0f32eb787961", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/163811add3f869b4e0aca6f820ac0f32eb787961", "committedDate": "2020-03-16T16:30:36Z", "message": "Add clause to resume async response on exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5897a8dea36bc2556659e3058c30aa0d2e966bb0", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/5897a8dea36bc2556659e3058c30aa0d2e966bb0", "committedDate": "2020-03-17T17:22:55Z", "message": "Merge branch 'master' into feature/autocreate-by-namespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9957a3b51ca484693dd553857538c6996e9222a4", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/9957a3b51ca484693dd553857538c6996e9222a4", "committedDate": "2020-03-17T18:06:43Z", "message": "Remove override from method names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MzY1OTEw", "url": "https://github.com/apache/pulsar/pull/6471#pullrequestreview-377365910", "createdAt": "2020-03-19T01:41:48Z", "commit": {"oid": "9957a3b51ca484693dd553857538c6996e9222a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NjcxMjQz", "url": "https://github.com/apache/pulsar/pull/6471#pullrequestreview-378671243", "createdAt": "2020-03-20T17:17:41Z", "commit": {"oid": "9957a3b51ca484693dd553857538c6996e9222a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84f4e4a92e9002faffeec9ab780f71445b49a8de", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/84f4e4a92e9002faffeec9ab780f71445b49a8de", "committedDate": "2020-03-20T21:28:08Z", "message": "Merge branch 'master' into feature/autocreate-by-namespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "102ccfe85239d0b1889a6181fa18501e689e5cc9", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/102ccfe85239d0b1889a6181fa18501e689e5cc9", "committedDate": "2020-03-20T21:43:06Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bafdb7045e344d14de5ffe34ee3e5ca7c9a224a1", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/bafdb7045e344d14de5ffe34ee3e5ca7c9a224a1", "committedDate": "2020-03-23T16:58:55Z", "message": "Merge branch 'master' into feature/autocreate-by-namespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "221ddabfa8d50b39f0b7375dcfb36593379e8158", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/221ddabfa8d50b39f0b7375dcfb36593379e8158", "committedDate": "2020-03-25T01:41:06Z", "message": "Merge branch 'master' into feature/autocreate-by-namespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f237b22104c93c9fdeeeb3a4e9066d6853881748", "author": {"user": {"login": "klevy-toast", "name": "Kai"}}, "url": "https://github.com/apache/pulsar/commit/f237b22104c93c9fdeeeb3a4e9066d6853881748", "committedDate": "2020-03-25T15:38:59Z", "message": "Fix pulsar-client-admin style"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4981, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}