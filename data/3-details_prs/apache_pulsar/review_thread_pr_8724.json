{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTAyOTY5", "number": 8724, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwMDoyMToyM1rOE9ySfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwMDoyMToyM1rOE9ySfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMjIyNTI1OnYy", "diffSide": "RIGHT", "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "isResolved": true, "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwMDoyMToyM1rOH6plSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNDowNjo0NFrOH6wZ0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ==", "bodyText": "Add a test for getProducerBuilder methods? We can verify the producer applied all we gave configurations.", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531260745", "createdAt": "2020-11-27T00:21:23Z", "author": {"login": "zymap"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM0OTY1Mw==", "bodyText": "The getProducerBuilder cannot be tested simply. The parameter validation happens in ProducerBuilder#create. However the PulsarClient's service url cannot be mocked because it retrieves the url related params from ZK, see WebSocketService#getPulsarClient for details.\nTherefore, it needs an integration test which may be beyond this PR's scope of work. Also I found there's no WebSocket related integration tests. If you think it's proper to add an WebSocket integration test in this PR, I'll take some time to do it.", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531349653", "createdAt": "2020-11-27T02:19:26Z", "author": {"login": "BewareMyPower"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM1NjEwNA==", "bodyText": "We don't need to validate the params. We can simply mock the queryParams which is a hashmap and put the arguments into the map. Then when we can get the values in the getProducerBuilder. We can make sure the ProducerBuilder contains the configurations which we pass to the hashmap.\nCurrently, the getProducerBuilder can not get the right builder with the queryParams, so we can make sure it can get the right builder with the given params.", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531356104", "createdAt": "2020-11-27T02:47:08Z", "author": {"login": "zymap"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM1OTE3NA==", "bodyText": "I mean something like this:\n    @Test\n    public void testGetTheRightBuilder() {\n        HttpServletRequest request = mock(HttpServletRequest.class);\n        when(request.getParameterMap()).thenReturn(mockedmap)\n        ProducerHandler producerHandler = new ProducerHandler(null, request, null);\n        ProducerBuilderImpl<byte[]> builder = (ProducerBuilderImpl<byte[]>) producerHandler.getProducerBuilder(null);\n        builder.getConf().getProducerName();\n    }", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531359174", "createdAt": "2020-11-27T03:00:59Z", "author": {"login": "zymap"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM1OTYxMg==", "bodyText": "But ProducerBuilder just provides getters but not setters. So we need to call create and it will fail if PulsarClient's service url is not correct.", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531359612", "createdAt": "2020-11-27T03:03:20Z", "author": {"login": "BewareMyPower"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MDQ5OQ==", "bodyText": "In addition, getProducerBuilder is private. Even if change it to public, it must be called after ProducerHandler is constructed. However, the constructor calls getProducerBuilder and ProducerBuilder#create. This behavior cannot be changed even with a mocked WebSocketService and HttpServletRequest.", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531360499", "createdAt": "2020-11-27T03:07:16Z", "author": {"login": "BewareMyPower"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MTIzNg==", "bodyText": "I am not sure can we cast ProduceBuilder to ProducerBuilderImpl to get some properties?\n        ProducerBuilderImpl<byte[]> builder = (ProducerBuilderImpl<byte[]>) producerHandler.getProducerBuilder(null);\n        builder.getConf().getProducerName();", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531361236", "createdAt": "2020-11-27T03:10:34Z", "author": {"login": "zymap"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MTU3Mw==", "bodyText": "Since the exception is thrown by getProducerBuilder, I think I can add a test to check if any NumberFormatException or IllegalArgumentException was thrown by the ProducerHandler's constructor and treat other exceptions as right behavior.", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531361573", "createdAt": "2020-11-27T03:12:02Z", "author": {"login": "BewareMyPower"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MTg0OA==", "bodyText": "You can usemock to get every behavior you want.", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531361848", "createdAt": "2020-11-27T03:13:42Z", "author": {"login": "zymap"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM2MjM4NQ==", "bodyText": "If you need to use the getProducerBuilder method, I think it's ok to make it to package private not public.", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531362385", "createdAt": "2020-11-27T03:15:59Z", "author": {"login": "zymap"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM3MjQ5Ng==", "bodyText": "Ok, I'll add a test soon.", "url": "https://github.com/apache/pulsar/pull/8724#discussion_r531372496", "createdAt": "2020-11-27T04:06:44Z", "author": {"login": "BewareMyPower"}, "path": "pulsar-websocket/src/main/java/org/apache/pulsar/websocket/ProducerHandler.java", "diffHunk": "@@ -298,7 +298,7 @@ private void updateSentMsgStats(long msgSize, long latencyUsec) {\n         }\n \n         if (queryParams.containsKey(\"initialSequenceId\")) {\n-            builder.initialSequenceId(Long.parseLong(\"initialSequenceId\"));\n+            builder.initialSequenceId(Long.parseLong(queryParams.get(\"initialSequenceId\")));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI2MDc0NQ=="}, "originalCommit": {"oid": "23dc7057730557d574adf4cf4b7e175aef23adc8"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2736, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}