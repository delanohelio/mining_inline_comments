{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzMzUyNzU1", "number": 7605, "title": "Support partitioned topic lookup", "bodyText": "Fixes #7571\nMotivation\nSupport look up for partitioned topic.\nModifications\nAdd look up  support for partitioned topic.", "createdAt": "2020-07-20T11:31:27Z", "url": "https://github.com/apache/pulsar/pull/7605", "merged": true, "mergeCommit": {"oid": "9eead7dddfa8b6300bbff056824e658915726b0d"}, "closed": true, "closedAt": "2020-10-26T13:13:46Z", "author": {"login": "aloyszhang"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc2wHeYABqjM1NjUzNzczNTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWUJfNAFqTUxNjc1OTcwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f2485b4bacd3f19a0c6b4358353c604c8c5d767a", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/f2485b4bacd3f19a0c6b4358353c604c8c5d767a", "committedDate": "2020-07-20T11:26:16Z", "message": "Support partitioned topic lookup"}, "afterCommit": {"oid": "409e3afb60f2cd6d1d466c8fc776e97e205a363e", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/409e3afb60f2cd6d1d466c8fc776e97e205a363e", "committedDate": "2020-07-20T11:40:38Z", "message": "Support partitioned topic lookup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "409e3afb60f2cd6d1d466c8fc776e97e205a363e", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/409e3afb60f2cd6d1d466c8fc776e97e205a363e", "committedDate": "2020-07-20T11:40:38Z", "message": "Support partitioned topic lookup"}, "afterCommit": {"oid": "c212af8cf5e9648a81cfb6f1a4295b281729f6c7", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/c212af8cf5e9648a81cfb6f1a4295b281729f6c7", "committedDate": "2020-07-20T12:05:17Z", "message": "Support partitioned topic lookup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNTA1ODk4", "url": "https://github.com/apache/pulsar/pull/7605#pullrequestreview-452505898", "createdAt": "2020-07-21T14:19:35Z", "commit": {"oid": "c212af8cf5e9648a81cfb6f1a4295b281729f6c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDoxOTozNlrOG06RCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDoxOTozNlrOG06RCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEzMzc3MA==", "bodyText": "If redirect the partitioned topic lookup requests, the target broker will handle the partitioned topic lookup request right? So this may lead to redirect back again, the request can't complete.", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r458133770", "createdAt": "2020-07-21T14:19:36Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/lookup/TopicLookupBase.java", "diffHunk": "@@ -127,6 +131,113 @@ protected void internalLookupTopicAsync(TopicName topicName, boolean authoritati\n         });\n     }\n \n+    protected void internalLookupPartitionedTopicAsync(TopicName topicName, boolean authoritative, AsyncResponse asyncResponse) {\n+        if (!pulsar().getBrokerService().getLookupRequestSemaphore().tryAcquire()) {\n+            log.warn(\"No broker was found available for topic {}\", topicName);\n+            asyncResponse.resume(new WebApplicationException(Response.Status.SERVICE_UNAVAILABLE));\n+            return;\n+        }\n+\n+        try {\n+            validateClusterOwnership(topicName.getCluster());\n+            checkConnect(topicName);\n+            validateGlobalNamespaceOwnership(topicName.getNamespaceObject());\n+        } catch (WebApplicationException we) {\n+            // Validation checks failed\n+            log.error(\"Validation check failed: {}\", we.getMessage());\n+            completeLookupResponseExceptionally(asyncResponse, we);\n+            return;\n+        } catch (Throwable t) {\n+            // Validation checks failed with unknown error\n+            log.error(\"Validation check failed: {}\", t.getMessage(), t);\n+            completeLookupResponseExceptionally(asyncResponse, new RestException(t));\n+            return;\n+        }\n+\n+        pulsar().getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).whenComplete(\n+                (metadata, t) -> {\n+                    if (t != null) {\n+                        log.error(\" Can't find partitioned metadata for {}\", topicName);\n+                        completeLookupResponseExceptionally(asyncResponse, new RestException(t));\n+                        return ;\n+                    }\n+\n+                    String domain = topicName.getDomain().value();\n+                    NamespaceName namespace = topicName.getNamespaceObject();\n+                    String topicLocalName = topicName.getLocalName();\n+                    LookupOptions lookupOptions =  LookupOptions.builder().authoritative(authoritative).loadTopicsInBundle(false).build();\n+\n+                    List<CompletableFuture<Optional<LookupResult>>> futureList = new ArrayList<>();\n+                    if (metadata != null && metadata.partitions > 1) {\n+                        for (int i = 0 ; i < metadata.partitions; i ++) {\n+                            TopicName partitionedTopicName = TopicName.get(domain, namespace, topicLocalName + \"-partition-\" + i);\n+                            futureList.add(pulsar().getNamespaceService().getBrokerServiceUrlAsync(partitionedTopicName, lookupOptions));\n+                        }\n+                    } else {\n+                        futureList.add(pulsar().getNamespaceService().getBrokerServiceUrlAsync(topicName, lookupOptions));\n+                    }\n+\n+                    FutureUtil.waitForAll(futureList).whenComplete(\n+                            (ignore, te) -> {\n+                                if (te != null) {\n+                                    log.warn(\"Failed to lookup broker for topic {}: {}\", topicName, te.getMessage(), te);\n+                                    completeLookupResponseExceptionally(asyncResponse, te);\n+                                    return;\n+                                }\n+                                List<LookupData> lookupDataList = new ArrayList<>();\n+                                for (CompletableFuture<Optional<LookupResult>> partitionFuture : futureList) {\n+                                    partitionFuture.thenAccept(optionalResult -> {\n+                                        if (optionalResult == null || !optionalResult.isPresent()) {\n+                                            log.warn(\"No broker was found available for topic {}\", topicName);\n+                                            completeLookupResponseExceptionally(asyncResponse,\n+                                                    new WebApplicationException(Response.Status.SERVICE_UNAVAILABLE));\n+                                            return;\n+                                        }\n+\n+                                        LookupResult result = optionalResult.get();\n+                                        // We have found either a broker that owns the topic, or a broker to which we should redirect the client to\n+                                        if (result.isRedirect()) {\n+                                            boolean newAuthoritative = result.isAuthoritativeRedirect();\n+                                            URI redirect;\n+                                            try {\n+                                                String redirectUrl = isRequestHttps() ? result.getLookupData().getHttpUrlTls()\n+                                                        : result.getLookupData().getHttpUrl();\n+                                                checkNotNull(redirectUrl, \"Redirected cluster's service url is not configured\");\n+                                                String lookupPath = topicName.isV2() ? LOOKUP_PATH_V2 : LOOKUP_PATH_V1;\n+                                                redirect = new URI(String.format(\"%s%s%s?authoritative=%s\", redirectUrl, lookupPath,\n+                                                        topicName.getLookupName(), newAuthoritative));\n+                                            } catch (URISyntaxException | NullPointerException e) {\n+                                                log.error(\"Error in preparing redirect url for {}: {}\", topicName, e.getMessage(), e);\n+                                                completeLookupResponseExceptionally(asyncResponse, e);\n+                                                return;\n+                                            }\n+                                            if (log.isDebugEnabled()) {\n+                                                log.debug(\"Redirect lookup for topic {} to {}\", topicName, redirect);\n+                                            }\n+                                            completeLookupResponseExceptionally(asyncResponse,\n+                                                    new WebApplicationException(Response.temporaryRedirect(redirect).build()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c212af8cf5e9648a81cfb6f1a4295b281729f6c7"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2422b848dd18f9b0a6fa50ad6a539b9a3775a0a", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/a2422b848dd18f9b0a6fa50ad6a539b9a3775a0a", "committedDate": "2020-10-04T07:01:34Z", "message": "Support partitioned topic lookup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c212af8cf5e9648a81cfb6f1a4295b281729f6c7", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/c212af8cf5e9648a81cfb6f1a4295b281729f6c7", "committedDate": "2020-07-20T12:05:17Z", "message": "Support partitioned topic lookup"}, "afterCommit": {"oid": "a2422b848dd18f9b0a6fa50ad6a539b9a3775a0a", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/a2422b848dd18f9b0a6fa50ad6a539b9a3775a0a", "committedDate": "2020-10-04T07:01:34Z", "message": "Support partitioned topic lookup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e714d9decb6acdf3938848256e536cfc0d79c6d6", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/e714d9decb6acdf3938848256e536cfc0d79c6d6", "committedDate": "2020-10-04T07:57:27Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjAxODUz", "url": "https://github.com/apache/pulsar/pull/7605#pullrequestreview-501601853", "createdAt": "2020-10-04T08:31:30Z", "commit": {"oid": "e714d9decb6acdf3938848256e536cfc0d79c6d6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwODozMTozMFrOHcF-cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQwODozMTo0M1rOHcF-fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMDA4Mw==", "bodyText": "This method should return a CompletableFuture as the method above", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499220083", "createdAt": "2020-10-04T08:31:30Z", "author": {"login": "eolivelli"}, "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Lookup.java", "diffHunk": "@@ -41,6 +42,14 @@\n      */\n     CompletableFuture<String> lookupTopicAsync(String topic);\n \n+    /**\n+     * Lookup a partitioned topic.\n+     *\n+     * @param topic\n+     * @return the broker URL that serves the topic\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e714d9decb6acdf3938848256e536cfc0d79c6d6"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTIyMDA5NA==", "bodyText": "This method should return a CompletableFuture as the method above", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499220094", "createdAt": "2020-10-04T08:31:43Z", "author": {"login": "eolivelli"}, "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Lookup.java", "diffHunk": "@@ -41,6 +42,14 @@\n      */\n     CompletableFuture<String> lookupTopicAsync(String topic);\n \n+    /**\n+     * Lookup a partitioned topic.\n+     *\n+     * @param topic\n+     * @return the broker URL that serves the topic\n+     */\n+    Map<String, String> lookupPartitionedTopic(String topic) throws PulsarAdminException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e714d9decb6acdf3938848256e536cfc0d79c6d6"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02a4f08613879a916385a37481dca96434a2cf1a", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/02a4f08613879a916385a37481dca96434a2cf1a", "committedDate": "2020-10-05T09:30:54Z", "message": "add async method and test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa544431042700c4dd3c5552c1b368affdd0b9ff", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/fa544431042700c4dd3c5552c1b368affdd0b9ff", "committedDate": "2020-10-05T09:43:11Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODk3MTEz", "url": "https://github.com/apache/pulsar/pull/7605#pullrequestreview-501897113", "createdAt": "2020-10-05T09:55:55Z", "commit": {"oid": "fa544431042700c4dd3c5552c1b368affdd0b9ff"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwOTo1NTo1NlrOHcV0fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwOTo1NTo1NlrOHcV0fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ3OTY3OA==", "bodyText": "is this line needed ?", "url": "https://github.com/apache/pulsar/pull/7605#discussion_r499479678", "createdAt": "2020-10-05T09:55:56Z", "author": {"login": "eolivelli"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/lookup/TopicLookupBase.java", "diffHunk": "@@ -26,6 +26,7 @@\n \n import java.net.URI;\n import java.net.URISyntaxException;\n+import java.util.List;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa544431042700c4dd3c5552c1b368affdd0b9ff"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a403af32bec0264386c3a944683cb9e31255874", "author": {"user": {"login": "aloyszhang", "name": "Aloys"}}, "url": "https://github.com/apache/pulsar/commit/4a403af32bec0264386c3a944683cb9e31255874", "committedDate": "2020-10-05T10:01:40Z", "message": "remove un-used import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NzU5NzAz", "url": "https://github.com/apache/pulsar/pull/7605#pullrequestreview-516759703", "createdAt": "2020-10-26T13:12:02Z", "commit": {"oid": "4a403af32bec0264386c3a944683cb9e31255874"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 386, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}