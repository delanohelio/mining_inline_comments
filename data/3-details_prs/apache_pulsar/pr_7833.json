{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5MTcwMTU4", "number": 7833, "title": "[Transaction] Consume transaction message logic optimized", "bodyText": "Motivation\nThe transaction message consuming logic needs to be optimized. One transaction commit marker in the topic partition consists of many Entries in the TransactionBuffer, so one transaction could be seen as one batch.\nModifications\n\n\nWhen sending messages to consumers use the batchIndex in the MessageIdData to present the startBatchIndex of the Entry.\n\n\nCalculate the transaction messages number.\n\n\nWhen the first reading one transaction init it's batchDeletedIndexes in the ManagedCursorImpl.\n\n\nVerifying this change\nThis change can be verified as follows:\n\norg.apache.pulsar.broker.transaction.TransactionConsumeTest\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (no)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)", "createdAt": "2020-08-18T03:03:51Z", "url": "https://github.com/apache/pulsar/pull/7833", "merged": true, "mergeCommit": {"oid": "b4b77be519408fcecff66dc2354b6843fd17c607"}, "closed": true, "closedAt": "2020-08-31T02:34:41Z", "author": {"login": "gaoran10"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAwsaFgBqjM2NzU0MTUyNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEJdk5gFqTQ3ODI3NDAwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d8df6930ab7b2ef5c467534ff4d6d195bce75f3", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/0d8df6930ab7b2ef5c467534ff4d6d195bce75f3", "committedDate": "2020-08-19T05:32:43Z", "message": "fix test"}, "afterCommit": {"oid": "010d77540cac885b8af814b1552a2dc5aa82163e", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/010d77540cac885b8af814b1552a2dc5aa82163e", "committedDate": "2020-08-20T14:00:35Z", "message": "fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "010d77540cac885b8af814b1552a2dc5aa82163e", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/010d77540cac885b8af814b1552a2dc5aa82163e", "committedDate": "2020-08-20T14:00:35Z", "message": "fix test"}, "afterCommit": {"oid": "ea9bbafe5dedcc51e0ebeb5560690f133c3313d4", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/ea9bbafe5dedcc51e0ebeb5560690f133c3313d4", "committedDate": "2020-08-21T02:04:11Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NDc5ODM4", "url": "https://github.com/apache/pulsar/pull/7833#pullrequestreview-476479838", "createdAt": "2020-08-27T08:04:14Z", "commit": {"oid": "b19df42411233d9717160a6e6024a4d29382f0e1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwODowNDoxNFrOHIFAPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwODoyMzozOFrOHIFsYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzMjYzNw==", "bodyText": "batchDeletedIndexes.computeIfAbsent().", "url": "https://github.com/apache/pulsar/pull/7833#discussion_r478232637", "createdAt": "2020-08-27T08:04:14Z", "author": {"login": "codelipenghui"}, "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedCursorImpl.java", "diffHunk": "@@ -2857,5 +2857,14 @@ private int applyMaxSizeCap(int maxEntries, long maxSizeBytes) {\n \n         return Math.min(maxEntriesBasedOnSize, maxEntries);\n     }\n+\n+    public void internalInitBatchDeletedIndex(PositionImpl position, int totalNumMessageInBatch) {\n+        if (!batchDeletedIndexes.containsKey(position)) {\n+            BitSetRecyclable bitSetRecyclable = BitSetRecyclable.create();\n+            bitSetRecyclable.set(0, totalNumMessageInBatch);\n+            batchDeletedIndexes.put(position, bitSetRecyclable);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19df42411233d9717160a6e6024a4d29382f0e1"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI0MzkzOQ==", "bodyText": "Shall we need this change?", "url": "https://github.com/apache/pulsar/pull/7833#discussion_r478243939", "createdAt": "2020-08-27T08:23:38Z", "author": {"login": "codelipenghui"}, "path": ".github/workflows/ci-unit-broker-broker-gp1.yaml", "diffHunk": "@@ -65,13 +65,13 @@ jobs:\n         if: steps.docs.outputs.changed_only == 'no'\n         run: ./build/retry.sh mvn -B -ntp test -pl pulsar-broker -Dinclude='**/AdminApiOffloadTest.java' -DtestForkCount=1 -DtestReuseFork=true\n \n-      - name: run flaky test '**/TransactionProduceTest.java'\n+      - name: run transaction test\n         if: steps.docs.outputs.changed_only == 'no'\n-        run: ./build/retry.sh mvn -B -ntp test -pl pulsar-broker -Dinclude='**/TransactionProduceTest.java' -DtestForkCount=1 -DtestReuseFork=true\n+        run: ./build/retry.sh mvn -B -ntp test -pl pulsar-broker -Dinclude='org/apache/pulsar/broker/transaction/**/*.java,org/apache/pulsar/client/transaction/**/*.java' -DfailIfNoTests=false -DtestForkCount=1 -DtestReuseFork=true\n \n       - name: run unit tests for pulsar-broker\n         if: steps.docs.outputs.changed_only == 'no'\n-        run: ./build/retry.sh mvn -B -ntp test -pl pulsar-broker -Dinclude='org/apache/pulsar/broker/**/*.java' -Dexclude='org/apache/pulsar/broker/zookeeper/**/*.java,org/apache/pulsar/broker/loadbalance/**/*.java,org/apache/pulsar/broker/service/**/*.java,**/AdminApiOffloadTest.java,**/TransactionProduceTest.java'\n+        run: ./build/retry.sh mvn -B -ntp test -pl pulsar-broker -Dinclude='org/apache/pulsar/broker/**/*.java' -Dexclude='org/apache/pulsar/broker/zookeeper/**/*.java,org/apache/pulsar/broker/loadbalance/**/*.java,org/apache/pulsar/broker/service/**/*.java,**/AdminApiOffloadTest.java,org/apache/pulsar/broker/transaction/**/*.java,org/apache/pulsar/client/transaction/**/*.java'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19df42411233d9717160a6e6024a4d29382f0e1"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f05a7c877af57de78b6122f2fd4aea87e38f64", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/d7f05a7c877af57de78b6122f2fd4aea87e38f64", "committedDate": "2020-08-27T12:14:54Z", "message": "adjust consume transaction message logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61696baa027baebb8623d104154e3f6a910994e5", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/61696baa027baebb8623d104154e3f6a910994e5", "committedDate": "2020-08-27T12:14:55Z", "message": "change the way to get the Entry startBatchIndex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36c1a2ac9751742f14718e86b14670329a04bfc1", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/36c1a2ac9751742f14718e86b14670329a04bfc1", "committedDate": "2020-08-27T12:14:55Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d211a07ec5bc0cdd7ee5ba4c14d604cf72a72bb7", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/d211a07ec5bc0cdd7ee5ba4c14d604cf72a72bb7", "committedDate": "2020-08-27T12:14:55Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19daadbd89e8f771e15fd85456bec016e80218de", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/19daadbd89e8f771e15fd85456bec016e80218de", "committedDate": "2020-08-27T12:14:55Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "889c920501bcef60617b714dfbbffec2c5af7784", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/889c920501bcef60617b714dfbbffec2c5af7784", "committedDate": "2020-08-27T12:14:55Z", "message": "make the TransactionEntry extends Entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fd58bdaa0a4d8218c7919bb99aed4e83163415b", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/7fd58bdaa0a4d8218c7919bb99aed4e83163415b", "committedDate": "2020-08-27T12:14:55Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65a305a9a69221d54b786b3d867f807a6ee4e39d", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/65a305a9a69221d54b786b3d867f807a6ee4e39d", "committedDate": "2020-08-27T12:14:55Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fde7cd4438b81ed781c9fefa56f12633e3c7b1da", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/fde7cd4438b81ed781c9fefa56f12633e3c7b1da", "committedDate": "2020-08-27T13:46:10Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b19df42411233d9717160a6e6024a4d29382f0e1", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/b19df42411233d9717160a6e6024a4d29382f0e1", "committedDate": "2020-08-22T19:42:39Z", "message": "fix test"}, "afterCommit": {"oid": "fde7cd4438b81ed781c9fefa56f12633e3c7b1da", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/fde7cd4438b81ed781c9fefa56f12633e3c7b1da", "committedDate": "2020-08-27T13:46:10Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bd33d0b87b23f4f56361fb433b8e3093660c0da", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/8bd33d0b87b23f4f56361fb433b8e3093660c0da", "committedDate": "2020-08-27T17:51:58Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e28fe9a9af353ceb4cf8ade92000d78b6cba93d1", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/e28fe9a9af353ceb4cf8ade92000d78b6cba93d1", "committedDate": "2020-08-27T17:55:17Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "322656d020f66fe4d6df67b5b4868e49fc76162e", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/322656d020f66fe4d6df67b5b4868e49fc76162e", "committedDate": "2020-08-27T17:57:35Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9438a53aae5e14df58c0534bc61d83c44794c95e", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/9438a53aae5e14df58c0534bc61d83c44794c95e", "committedDate": "2020-08-27T18:04:45Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4Mjc0MDA3", "url": "https://github.com/apache/pulsar/pull/7833#pullrequestreview-478274007", "createdAt": "2020-08-31T02:34:23Z", "commit": {"oid": "9438a53aae5e14df58c0534bc61d83c44794c95e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 286, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}