{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MDYyNTAy", "number": 6102, "title": " [Websocket] Websocket doesn't set the correct cluster data", "bodyText": "Motivation\nFixes #5997\nFixes #6079\nA regression was introduced in #5486. If websocket service as running as part of\npulsar standalone, the cluster data is set with null service urls. This causes\nservice url is not set correctly in the pulsar client and an illegal argument exception\n(\"Param serviceUrl must not be blank.\") will be thrown.\nModifications\n\nPass null when constructing the websocket service. So the local cluster data can\nbe refreshed when creating pulsar client.\nSet the cluster data after both broker service and web service started and ports are allocated.\n\nTest\nVerified locally and need to figure out how to automate this in integration tests", "createdAt": "2020-01-21T02:02:56Z", "url": "https://github.com/apache/pulsar/pull/6102", "merged": true, "mergeCommit": {"oid": "49a98972bd2aa8deef2f9a95cf7678bd1e6033a4"}, "closed": true, "closedAt": "2020-01-24T07:02:36Z", "author": {"login": "sijie"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8UQL9AH2gAyMzY1MDYyNTAyOjhiNzE5NTE3MGYxMDZjNjIzYTA1MDA2NWNmYTZmMTcxNDBhMjdhMGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8yUywgH2gAyMzY1MDYyNTAyOmFkYzljY2I0ZmJhMzBlMzgyMTJlMjFmMzQ5NTI2MTNjMGNhM2ZlYTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8b7195170f106c623a050065cfa6f17140a27a0e", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/8b7195170f106c623a050065cfa6f17140a27a0e", "committedDate": "2020-01-20T22:26:10Z", "message": "[Functions] The argument and description for dead letter topic is wrong\n\n*Motivation*\n\n #5400 introduces `customRuntimeOptions` in function details. But the description\n was wrong. The mistake was probably introduced by bad merges.\n\n*Modification*\n\nFix the argument and description for `deadletterTopic` and `customRuntimeOptions`.\n\n*Tests*\n\nAdd a unit test to ensure the parameters are set correctly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e479065e87e5130f4beca535af155c8b7c885d2", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/0e479065e87e5130f4beca535af155c8b7c885d2", "committedDate": "2020-01-21T01:52:51Z", "message": "[Websocket] Websocket doesn't set the correct cluster data\n\n*Motivation*\n\nA regression was introduced in #5486. If websocket service as running as part of\npulsar standalone, the cluster data is set with null service urls. This causes\nservice url is not set correctly in the pulsar client and an illegal argument exception\n(\"Param serviceUrl must not be blank.\") will be thrown.\n\n*Modifications*\n\n1. Pass `null` when constructing the websocket service. So the local cluster data can\n   be refreshed when creating pulsar client.\n2. Set the cluster data after both broker service and web service started and ports are allocated.\n\n*Test*\n\nVerified locally and need to figure out how to automate this in integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bba788f7287e16c80e58a00dfb6bd1a81e551a5b", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/bba788f7287e16c80e58a00dfb6bd1a81e551a5b", "committedDate": "2020-01-21T01:58:49Z", "message": "Merge remote-tracking branch 'apache/master' into fix_websocket_regressino"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NjEwNTAw", "url": "https://github.com/apache/pulsar/pull/6102#pullrequestreview-345610500", "createdAt": "2020-01-21T02:52:02Z", "commit": {"oid": "bba788f7287e16c80e58a00dfb6bd1a81e551a5b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1OTM2MDA4", "url": "https://github.com/apache/pulsar/pull/6102#pullrequestreview-345936008", "createdAt": "2020-01-21T14:51:42Z", "commit": {"oid": "bba788f7287e16c80e58a00dfb6bd1a81e551a5b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDo1MTo0M1rOFf8ybg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDo1MTo0M1rOFf8ybg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA0NjEyNg==", "bodyText": "The variable this.webSocketService may not have been properly initialized?", "url": "https://github.com/apache/pulsar/pull/6102#discussion_r369046126", "createdAt": "2020-01-21T14:51:43Z", "author": {"login": "tuteng"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -466,6 +464,10 @@ public Boolean get() {\n             this.brokerServiceUrl = brokerUrl(config);\n             this.brokerServiceUrlTls = brokerUrlTls(config);\n \n+            ClusterData clusterData =\n+                new ClusterData(webServiceAddress, webServiceAddressTls, brokerServiceUrl, brokerServiceUrlTls);\n+            this.webSocketService.setLocalCluster(clusterData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bba788f7287e16c80e58a00dfb6bd1a81e551a5b"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MzIyMzIy", "url": "https://github.com/apache/pulsar/pull/6102#pullrequestreview-346322322", "createdAt": "2020-01-22T03:01:27Z", "commit": {"oid": "bba788f7287e16c80e58a00dfb6bd1a81e551a5b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adc9ccb4fba30e38212e21f34952613c0ca3fea6", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/adc9ccb4fba30e38212e21f34952613c0ca3fea6", "committedDate": "2020-01-22T09:28:21Z", "message": "Check if webSocketService is set"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1312, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}