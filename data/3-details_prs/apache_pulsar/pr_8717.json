{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3ODYyNTMz", "number": 8717, "title": "Configurable data source for offloaded messages", "bodyText": "Fix issue: #8591\nThis PR include:\n\nAPI change in command tools\nRelated implementation with tests\nRelated docs in cookbook\n\nBy the way  log4j dependency is removed for module managed-ledger because now the whole project use log4j2 as the default logger framework.", "createdAt": "2020-11-26T06:43:20Z", "url": "https://github.com/apache/pulsar/pull/8717", "merged": true, "mergeCommit": {"oid": "7c09f5ce649edcca0be792198d97573197c5a272"}, "closed": true, "closedAt": "2021-01-08T05:01:18Z", "author": {"login": "Renkai"}, "timelineItems": {"totalCount": 42, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiFpFwABqjQwNjAxODg0NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABduBeQJAFqTU2NDAwMzY4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d14cec73fe6e0c93da51b84aad46bf5dec73537", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/2d14cec73fe6e0c93da51b84aad46bf5dec73537", "committedDate": "2020-11-26T07:01:16Z", "message": "add test\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}, "afterCommit": {"oid": "6a071f78b96a8e5c6d8cc4410b4f040f5ac6426f", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/6a071f78b96a8e5c6d8cc4410b4f040f5ac6426f", "committedDate": "2020-12-02T03:04:43Z", "message": "add test\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b654e80fbb59e3907f41691065c2403585239da", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/2b654e80fbb59e3907f41691065c2403585239da", "committedDate": "2020-12-03T00:30:14Z", "message": "add configuration for read priority\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f8ebffa6c35693123e2ed5699e5afbcb4c18ddd", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/7f8ebffa6c35693123e2ed5699e5afbcb4c18ddd", "committedDate": "2020-12-03T00:30:14Z", "message": "add read priority to offload policy\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a6942d364a7dbaedcd98c7044a2518fbdc8791e", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/7a6942d364a7dbaedcd98c7044a2518fbdc8791e", "committedDate": "2020-12-03T00:30:14Z", "message": "add read priority to offload policy\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec43abe85850b50fc4e808529894267023fd078c", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/ec43abe85850b50fc4e808529894267023fd078c", "committedDate": "2020-12-03T00:30:14Z", "message": "add read priority to offload policy\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cd6b87d8bbea515b58da3d51490958c2ccb416e", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/9cd6b87d8bbea515b58da3d51490958c2ccb416e", "committedDate": "2020-12-03T00:30:14Z", "message": "add read priority to offload policy\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a697370f1568bf7d78387893afaa30ea37239564", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/a697370f1568bf7d78387893afaa30ea37239564", "committedDate": "2020-12-03T00:30:14Z", "message": "for bookkeeper first read priority read bookkeeper first\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61a9561c0ce0781a67a16cfec2171cc54ed6cde8", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/61a9561c0ce0781a67a16cfec2171cc54ed6cde8", "committedDate": "2020-12-03T00:30:14Z", "message": "nightly commit\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "969d164be01a8ce9414908bd827c5545f12b2461", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/969d164be01a8ce9414908bd827c5545f12b2461", "committedDate": "2020-12-03T00:30:14Z", "message": "drop log pom\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ba829c15d4399cb442dd0ca623ba0fe01cbf9df", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/0ba829c15d4399cb442dd0ca623ba0fe01cbf9df", "committedDate": "2020-12-03T00:30:14Z", "message": "add test\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d70bd00dfefc44adc6d4e2055f3457a7cc6c09d0", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/d70bd00dfefc44adc6d4e2055f3457a7cc6c09d0", "committedDate": "2020-12-03T00:30:14Z", "message": "add test\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1031a675c44b07a5f088fe05e7b70a9a866260d", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/a1031a675c44b07a5f088fe05e7b70a9a866260d", "committedDate": "2020-12-03T00:30:14Z", "message": "add test\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd224e1b3bb3b9f945e28bfb1cc61b3ba6547c89", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/fd224e1b3bb3b9f945e28bfb1cc61b3ba6547c89", "committedDate": "2020-12-03T00:30:14Z", "message": "add broker conf managedLedgerDataReadPriority\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cb61da7f4665b3824cc7fd277a4f054f179074a", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/1cb61da7f4665b3824cc7fd277a4f054f179074a", "committedDate": "2020-12-03T00:30:14Z", "message": "read broker configuration\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "578727a87992d3d9165377d0b225627d954b7ea6", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/578727a87992d3d9165377d0b225627d954b7ea6", "committedDate": "2020-12-02T13:35:01Z", "message": "Merge branch 'master' into read_priority_full"}, "afterCommit": {"oid": "1cb61da7f4665b3824cc7fd277a4f054f179074a", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/1cb61da7f4665b3824cc7fd277a4f054f179074a", "committedDate": "2020-12-03T00:30:14Z", "message": "read broker configuration\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3148f4ec31a9d76952e363505bdf71b0d744b02", "author": {"user": {"login": "zymap", "name": "Yong Zhang"}}, "url": "https://github.com/apache/pulsar/commit/d3148f4ec31a9d76952e363505bdf71b0d744b02", "committedDate": "2020-12-03T06:36:06Z", "message": "The package management module failed to build\n---\n\n*Motivation*\n\nThe pakcage management module build failed by the spotbugs check.\nThat will block the project build."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ee26cbbb0149c9f21193795d34e4c283afabfea", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/7ee26cbbb0149c9f21193795d34e4c283afabfea", "committedDate": "2020-12-03T07:11:44Z", "message": "bug fix\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fe3a3d52f85f300ba9f35bed7c9fc660ef19fdc", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/1fe3a3d52f85f300ba9f35bed7c9fc660ef19fdc", "committedDate": "2020-12-03T07:55:57Z", "message": "Merge branch 'fix-spotbugs-issue' into read_priority_full"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad5c187b6353b0e51be791abf35a6cb9beeef6e0", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/ad5c187b6353b0e51be791abf35a6cb9beeef6e0", "committedDate": "2020-12-04T01:57:01Z", "message": "Merge branch 'master' into read_priority_full"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eeafb49e57456d396699b9786daa835bdd25c26", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/5eeafb49e57456d396699b9786daa835bdd25c26", "committedDate": "2020-12-04T09:56:38Z", "message": "Merge branch 'master' into read_priority_full"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b6a92e60acac97bc838466806f4c820a916fc5e", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/0b6a92e60acac97bc838466806f4c820a916fc5e", "committedDate": "2020-12-05T01:34:22Z", "message": "check null before set\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "369d48c07bc6879e35d8c3d76411da11c8f48d17", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/369d48c07bc6879e35d8c3d76411da11c8f48d17", "committedDate": "2020-12-05T03:37:36Z", "message": "reduce unnecessary configuration set\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52db96e167fb9bf676affd94c157037b01c66432", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/52db96e167fb9bf676affd94c157037b01c66432", "committedDate": "2020-12-05T03:50:43Z", "message": "set with null check\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MjgyNzMx", "url": "https://github.com/apache/pulsar/pull/8717#pullrequestreview-546282731", "createdAt": "2020-12-07T15:52:41Z", "commit": {"oid": "52db96e167fb9bf676affd94c157037b01c66432"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNTo1Mjo0MVrOIAtclg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNTo1MzoyOFrOIAtezQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxNTUxMA==", "bodyText": "The OffloadPolicies you get from config may not be updated as namespace or topic policy update.", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r537615510", "createdAt": "2020-12-07T15:52:41Z", "author": {"login": "hangc0276"}, "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java", "diffHunk": "@@ -1536,7 +1537,18 @@ void asyncReadEntries(OpReadEntry opReadEntry) {\n \n             LedgerInfo info = ledgers.get(ledgerId);\n             CompletableFuture<ReadHandle> openFuture = new CompletableFuture<>();\n-            if (info != null && info.hasOffloadContext() && info.getOffloadContext().getComplete()) {\n+\n+            if (config.getLedgerOffloader() != null\n+                    && config.getLedgerOffloader().getOffloadPolicies() != null\n+                    && config.getLedgerOffloader().getOffloadPolicies()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52db96e167fb9bf676affd94c157037b01c66432"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxNjA3Nw==", "bodyText": "not suggest to use var", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r537616077", "createdAt": "2020-12-07T15:53:28Z", "author": {"login": "hangc0276"}, "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "diffHunk": "@@ -1336,11 +1335,35 @@ void run() throws PulsarAdminException {\n                 , description = \"ManagedLedger offload deletion lag in bytes\")\n         private Long offloadDeletionLagInMillis;\n \n+        @Parameter(\n+                names = {\"--offloadedReadPriority\", \"-orp\"},\n+                description = \"read priority for offloaded messages\",\n+                required = false\n+        )\n+        private String offloadReadPriorityStr;\n+\n         @Override\n         void run() throws PulsarAdminException {\n             String persistentTopic = validatePersistentTopic(params);\n+\n+            var offloadedReadPriority = OffloadPolicies.DEFAULT_OFFLOADED_READ_PRIORITY;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52db96e167fb9bf676affd94c157037b01c66432"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38d071ff910c0f07d722ac1aa9c729bf4e946f06", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/38d071ff910c0f07d722ac1aa9c729bf4e946f06", "committedDate": "2020-12-08T09:15:49Z", "message": "use explicit type instead of var\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a118a203e90b1acccb10c4c2a2d7894ab5edaea4", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/a118a203e90b1acccb10c4c2a2d7894ab5edaea4", "committedDate": "2020-12-10T02:52:28Z", "message": "Merge branch 'master' into read_priority_full\n\n# Conflicts:\n#\tpulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/d9f08b2a286de4f915fa12fa7d96815d20f21473", "committedDate": "2020-12-14T01:55:05Z", "message": "Merge branch 'master' into read_priority_full\n\n# Conflicts:\n#\tmanaged-ledger/pom.xml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4NTk4Nzcw", "url": "https://github.com/apache/pulsar/pull/8717#pullrequestreview-558598770", "createdAt": "2020-12-24T14:43:07Z", "commit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxNDo0MzowN1rOILIvcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxNTowMzo0MVrOILJCdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0ODQ2Nw==", "bodyText": "please remove this import", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548548467", "createdAt": "2020-12-24T14:43:07Z", "author": {"login": "hangc0276"}, "path": "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/OffloadPrefixReadTest.java", "diffHunk": "@@ -39,7 +40,7 @@\n import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.TimeUnit;\n-\n+import lombok.val;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0ODYzNA==", "bodyText": "Assert.assertTrue may sync with assertEquals", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548548634", "createdAt": "2020-12-24T14:43:48Z", "author": {"login": "hangc0276"}, "path": "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/OffloadPrefixReadTest.java", "diffHunk": "@@ -69,53 +71,140 @@ public void testOffloadRead() throws Exception {\n         config.setRetentionTime(10, TimeUnit.MINUTES);\n         config.setRetentionSizeInMB(10);\n         config.setLedgerOffloader(offloader);\n-        ManagedLedgerImpl ledger = (ManagedLedgerImpl)factory.open(\"my_test_ledger\", config);\n+        ManagedLedgerImpl ledger = (ManagedLedgerImpl) factory.open(\"my_test_ledger\", config);\n \n         for (int i = 0; i < 25; i++) {\n             String content = \"entry-\" + i;\n             ledger.addEntry(content.getBytes());\n         }\n-        Assert.assertEquals(ledger.getLedgersInfoAsList().size(), 3);\n+        assertEquals(ledger.getLedgersInfoAsList().size(), 3);\n \n         ledger.offloadPrefix(ledger.getLastConfirmedEntry());\n \n-        Assert.assertEquals(ledger.getLedgersInfoAsList().size(), 3);\n-        Assert.assertEquals(ledger.getLedgersInfoAsList().stream()\n-                            .filter(e -> e.getOffloadContext().getComplete()).count(), 2);\n+        assertEquals(ledger.getLedgersInfoAsList().size(), 3);\n+        assertEquals(ledger.getLedgersInfoAsList().stream()\n+                .filter(e -> e.getOffloadContext().getComplete()).count(), 2);\n         Assert.assertTrue(ledger.getLedgersInfoAsList().get(0).getOffloadContext().getComplete());\n         Assert.assertTrue(ledger.getLedgersInfoAsList().get(1).getOffloadContext().getComplete());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0ODkxMw==", "bodyText": "the blank line may not delete.", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548548913", "createdAt": "2020-12-24T14:45:04Z", "author": {"login": "hangc0276"}, "path": "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/OffloadPrefixTest.java", "diffHunk": "@@ -23,22 +23,19 @@\n import static org.testng.Assert.assertNotEquals;\n import static org.testng.Assert.assertTrue;\n import static org.testng.Assert.fail;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0OTAxNQ==", "bodyText": "the blank line may not delete.", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548549015", "createdAt": "2020-12-24T14:45:19Z", "author": {"login": "hangc0276"}, "path": "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/OffloadPrefixTest.java", "diffHunk": "@@ -23,22 +23,19 @@\n import static org.testng.Assert.assertNotEquals;\n import static org.testng.Assert.assertTrue;\n import static org.testng.Assert.fail;\n-\n import com.google.common.collect.ImmutableSet;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0OTIwOQ==", "bodyText": "same with upper.", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548549209", "createdAt": "2020-12-24T14:45:54Z", "author": {"login": "hangc0276"}, "path": "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/OffloadPrefixTest.java", "diffHunk": "@@ -23,22 +23,19 @@\n import static org.testng.Assert.assertNotEquals;\n import static org.testng.Assert.assertTrue;\n import static org.testng.Assert.fail;\n-\n import com.google.common.collect.ImmutableSet;\n-\n import java.lang.reflect.Field;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Set;\n import java.util.UUID;\n-import java.util.concurrent.CompletionException;\n import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.TimeUnit;\n import java.util.function.BooleanSupplier;\n import java.util.stream.Collectors;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0OTM4NQ==", "bodyText": "may not delete the new line.", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548549385", "createdAt": "2020-12-24T14:46:29Z", "author": {"login": "hangc0276"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -21,9 +21,7 @@\n \n import com.google.common.collect.Lists;\n import com.google.common.collect.Sets;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU0OTcwMA==", "bodyText": "no blank", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548549700", "createdAt": "2020-12-24T14:47:38Z", "author": {"login": "hangc0276"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -1434,15 +1433,19 @@\n                     + \"Of course, this may degrade consumption throughput. Default is 10ms.\")\n     private int managedLedgerNewEntriesCheckDelayInMillis = 10;\n \n+    @FieldContext(category = CATEGORY_STORAGE_ML,\n+            doc = \"Read priority when ledgers exists in both bookkeeper and the second layer storage.\")\n+    private String managedLedgerDataReadPriority = OffloadPolicies.OffloadedReadPriority.OFFLOADED_FIRST.getValue();\n+\n     /*** --- Load balancer --- ****/\n     @FieldContext(\n-        category = CATEGORY_LOAD_BALANCER,\n-        doc = \"Enable load balancer\"\n+            category = CATEGORY_LOAD_BALANCER,\n+            doc = \"Enable load balancer\"\n     )\n     private boolean loadBalancerEnabled = true;\n     @Deprecated\n     @FieldContext(\n-        category = CATEGORY_LOAD_BALANCER,\n+            category = CATEGORY_LOAD_BALANCER,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MDkzNQ==", "bodyText": "add new blank", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548550935", "createdAt": "2020-12-24T14:53:08Z", "author": {"login": "hangc0276"}, "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdNamespaces.java", "diffHunk": "@@ -25,13 +25,12 @@\n import com.google.common.base.Strings;\n import com.google.common.collect.Lists;\n import com.google.common.collect.Sets;\n-\n import java.io.IOException;\n import java.util.Arrays;\n import java.util.HashSet;\n import java.util.List;\n import java.util.concurrent.TimeUnit;\n-\n+import java.util.stream.Collectors;\n import org.apache.commons.lang3.StringUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU1MzMzMg==", "bodyText": "Maybe we should check whether offloadPolicies already have ManagedLedgerOffloadedReadPriority value.", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r548553332", "createdAt": "2020-12-24T15:03:41Z", "author": {"login": "hangc0276"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -1262,6 +1263,12 @@ public void openLedgerFailed(ManagedLedgerException exception, Object ctx) {\n                     topicLevelOffloadPolicies,\n                     OffloadPolicies.oldPoliciesCompatible(nsLevelOffloadPolicies, policies.orElse(null)),\n                     getPulsar().getConfig().getProperties());\n+\n+            if (offloadPolicies != null && serviceConfig.getManagedLedgerDataReadPriority() != null) {\n+                offloadPolicies.setManagedLedgerOffloadedReadPriority(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9f08b2a286de4f915fa12fa7d96815d20f21473"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0505bf81593b11f76f745a2ba0d065d35057b86", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/d0505bf81593b11f76f745a2ba0d065d35057b86", "committedDate": "2020-12-27T07:44:18Z", "message": "small fix\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32658b61d7ab8772bb6f010e2f2953a872d36b5d", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/32658b61d7ab8772bb6f010e2f2953a872d36b5d", "committedDate": "2020-12-27T07:50:42Z", "message": "small fix\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4860800d5c3b08142e16ede27a26aa2566ad6b5", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/a4860800d5c3b08142e16ede27a26aa2566ad6b5", "committedDate": "2020-12-27T08:01:51Z", "message": "small fix\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d22a472aecd3634d234cd1958ea4213009da808", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/4d22a472aecd3634d234cd1958ea4213009da808", "committedDate": "2020-12-27T08:07:47Z", "message": "Merge branch 'master' into read_priority_full"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNzQ0Mjgy", "url": "https://github.com/apache/pulsar/pull/8717#pullrequestreview-561744282", "createdAt": "2021-01-05T12:20:16Z", "commit": {"oid": "4d22a472aecd3634d234cd1958ea4213009da808"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c99302a8e236c48a7d563deb48c314bb53da5ff", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/9c99302a8e236c48a7d563deb48c314bb53da5ff", "committedDate": "2021-01-06T01:16:50Z", "message": "Merge branch 'master' into read_priority_full\n\n# Conflicts:\n#\tmanaged-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "142e1ed5a77813d7e3014c5fda4da2578511ed72", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/142e1ed5a77813d7e3014c5fda4da2578511ed72", "committedDate": "2021-01-06T01:38:20Z", "message": "fix conflict\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abf10abbc8b44ea63364c023c3e6a99b95a6df94", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/abf10abbc8b44ea63364c023c3e6a99b95a6df94", "committedDate": "2021-01-06T01:57:41Z", "message": "change driver names to immutable for bugspots\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMzQ5MTQy", "url": "https://github.com/apache/pulsar/pull/8717#pullrequestreview-562349142", "createdAt": "2021-01-06T06:17:02Z", "commit": {"oid": "abf10abbc8b44ea63364c023c3e6a99b95a6df94"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwNjoxNzowMlrOIOzOPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwNjoxNzo1N1rOIOzPQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIwNw==", "bodyText": "@Renkai Can we avoid using System.out.println?", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552390207", "createdAt": "2021-01-06T06:17:02Z", "author": {"login": "sijie"}, "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "diffHunk": "@@ -1336,11 +1338,35 @@ void run() throws PulsarAdminException {\n                 , description = \"ManagedLedger offload deletion lag in bytes\")\n         private Long offloadDeletionLagInMillis;\n \n+        @Parameter(\n+                names = {\"--offloadedReadPriority\", \"-orp\"},\n+                description = \"read priority for offloaded messages\",\n+                required = false\n+        )\n+        private String offloadReadPriorityStr;\n+\n         @Override\n         void run() throws PulsarAdminException {\n             String persistentTopic = validatePersistentTopic(params);\n+\n+            OffloadedReadPriority offloadedReadPriority = OffloadPolicies.DEFAULT_OFFLOADED_READ_PRIORITY;\n+\n+            if (this.offloadReadPriorityStr != null) {\n+                try {\n+                    offloadedReadPriority = OffloadedReadPriority.fromString(this.offloadReadPriorityStr);\n+                    System.out.println(\"offloadedReadPriority = \" + offloadedReadPriority);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abf10abbc8b44ea63364c023c3e6a99b95a6df94"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIxOQ==", "bodyText": "@Renkai Can we avoid using System.out.println?", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552390219", "createdAt": "2021-01-06T06:17:06Z", "author": {"login": "sijie"}, "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdNamespaces.java", "diffHunk": "@@ -1788,10 +1796,25 @@ void run() throws PulsarAdminException {\n                     offloadAfterThresholdInBytes = offloadAfterThreshold;\n                 }\n             }\n+            OffloadedReadPriority offloadedReadPriority = OffloadPolicies.DEFAULT_OFFLOADED_READ_PRIORITY;\n+\n+            if (this.offloadReadPriorityStr != null) {\n+                try {\n+                    offloadedReadPriority = OffloadedReadPriority.fromString(this.offloadReadPriorityStr);\n+                    System.out.println(\"offloadedReadPriority = \" + offloadedReadPriority);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abf10abbc8b44ea63364c023c3e6a99b95a6df94"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDQ2Ng==", "bodyText": "I would suggest renaming OFFLOADED_FIRST to TIERED_STORAGE_FIRST.", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552390466", "createdAt": "2021-01-06T06:17:57Z", "author": {"login": "sijie"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/policies/data/OffloadPolicies.java", "diffHunk": "@@ -42,9 +46,58 @@\n @Data\n public class OffloadPolicies implements Serializable {\n \n+    @InterfaceAudience.Public\n+    @InterfaceStability.Stable\n+    public enum OffloadedReadPriority {\n+        /**\n+         * For offloaded messages, readers will try to read from bookkeeper at first,\n+         * if messages not exist at bookkeeper then read from offloaded storage.\n+         */\n+        BOOKKEEPER_FIRST(\"bookkeeper-first\"),\n+        /**\n+         * For offloaded messages, readers will try to read from offloaded storage first,\n+         * even they are still exist in bookkeeper.\n+         */\n+        OFFLOADED_FIRST(\"offloaded-first\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abf10abbc8b44ea63364c023c3e6a99b95a6df94"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbd54c81b0ffac80bd0cc2b079d046757185f8c2", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/bbd54c81b0ffac80bd0cc2b079d046757185f8c2", "committedDate": "2021-01-06T07:25:53Z", "message": "rename to tiered storage first\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "750600026d04f477739742a17b7e4927d37f7ddb", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/750600026d04f477739742a17b7e4927d37f7ddb", "committedDate": "2021-01-06T07:27:29Z", "message": "rename to tiered storage first\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMzgxOTgx", "url": "https://github.com/apache/pulsar/pull/8717#pullrequestreview-562381981", "createdAt": "2021-01-06T07:45:43Z", "commit": {"oid": "750600026d04f477739742a17b7e4927d37f7ddb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwNzo0NTo0M1rOIO02tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwNzo0NTo1NFrOIO02-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQxNjk1MQ==", "bodyText": "But this is a set command, no? Why people need this information when setting the offloaded priority?", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552416951", "createdAt": "2021-01-06T07:45:43Z", "author": {"login": "sijie"}, "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdNamespaces.java", "diffHunk": "@@ -1788,10 +1796,25 @@ void run() throws PulsarAdminException {\n                     offloadAfterThresholdInBytes = offloadAfterThreshold;\n                 }\n             }\n+            OffloadedReadPriority offloadedReadPriority = OffloadPolicies.DEFAULT_OFFLOADED_READ_PRIORITY;\n+\n+            if (this.offloadReadPriorityStr != null) {\n+                try {\n+                    offloadedReadPriority = OffloadedReadPriority.fromString(this.offloadReadPriorityStr);\n+                    System.out.println(\"offloadedReadPriority = \" + offloadedReadPriority);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIxOQ=="}, "originalCommit": {"oid": "abf10abbc8b44ea63364c023c3e6a99b95a6df94"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQxNzAxOA==", "bodyText": "This is a set command, no?", "url": "https://github.com/apache/pulsar/pull/8717#discussion_r552417018", "createdAt": "2021-01-06T07:45:54Z", "author": {"login": "sijie"}, "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "diffHunk": "@@ -1336,11 +1338,35 @@ void run() throws PulsarAdminException {\n                 , description = \"ManagedLedger offload deletion lag in bytes\")\n         private Long offloadDeletionLagInMillis;\n \n+        @Parameter(\n+                names = {\"--offloadedReadPriority\", \"-orp\"},\n+                description = \"read priority for offloaded messages\",\n+                required = false\n+        )\n+        private String offloadReadPriorityStr;\n+\n         @Override\n         void run() throws PulsarAdminException {\n             String persistentTopic = validatePersistentTopic(params);\n+\n+            OffloadedReadPriority offloadedReadPriority = OffloadPolicies.DEFAULT_OFFLOADED_READ_PRIORITY;\n+\n+            if (this.offloadReadPriorityStr != null) {\n+                try {\n+                    offloadedReadPriority = OffloadedReadPriority.fromString(this.offloadReadPriorityStr);\n+                    System.out.println(\"offloadedReadPriority = \" + offloadedReadPriority);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM5MDIwNw=="}, "originalCommit": {"oid": "abf10abbc8b44ea63364c023c3e6a99b95a6df94"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "280715ce456ba9faa4ee6d06ba9740f984b07498", "author": {"user": {"login": "Renkai", "name": "Renkai Ge"}}, "url": "https://github.com/apache/pulsar/commit/280715ce456ba9faa4ee6d06ba9740f984b07498", "committedDate": "2021-01-06T08:35:05Z", "message": "rename to tiered storage first\n\nSigned-off-by: Renkai <gaelookair@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0MDAzNjg0", "url": "https://github.com/apache/pulsar/pull/8717#pullrequestreview-564003684", "createdAt": "2021-01-08T05:00:42Z", "commit": {"oid": "280715ce456ba9faa4ee6d06ba9740f984b07498"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 980, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}