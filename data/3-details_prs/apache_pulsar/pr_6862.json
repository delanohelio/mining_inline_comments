{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNDY3Njg3", "number": 6862, "title": "fix consumer stuck when batchReceivePolicy maxNumMessages > maxReceiverQueueSize", "bodyText": "Fix #6854\nBug description\nThe consumer stuck due to hasEnoughMessagesForBatchReceive checking:\nprotected boolean hasEnoughMessagesForBatchReceive() {\n        if (batchReceivePolicy.getMaxNumMessages() <= 0 && batchReceivePolicy.getMaxNumBytes() <= 0) {\n            return false;\n        }\n        return (batchReceivePolicy.getMaxNumMessages() > 0 && incomingMessages.size() >= batchReceivePolicy.getMaxNumMessages())\n                || (batchReceivePolicy.getMaxNumBytes() > 0 && INCOMING_MESSAGES_SIZE_UPDATER.get(this) >= batchReceivePolicy.getMaxNumBytes());\n    }\n\nChanges\nWhen batchReceivePolicy maxNumMessages > maxReceiverQueueSize, we force batch receivePolicy maxNumMessages to maxReceiverQueueSize to avoid consumer stuck when checking hasEnoughMessagesForBatchReceive", "createdAt": "2020-05-02T15:34:23Z", "url": "https://github.com/apache/pulsar/pull/6862", "merged": true, "mergeCommit": {"oid": "561868d4c441d654ab795a9386d8e9a5e28f03dd"}, "closed": true, "closedAt": "2020-05-11T00:41:12Z", "author": {"login": "hangc0276"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdX8XJAH2gAyNDEyNDY3Njg3OmJiNDNmYzZmMzMwMGU3ODQ0YjkwMDk1NGJmY2VlNTJhMGIxNTIzYWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcf1OVzAFqTQwODcxMTkxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bb43fc6f3300e7844b900954bfcee52a0b1523ab", "author": {"user": {"login": "hangc0276", "name": "Hang Chen"}}, "url": "https://github.com/apache/pulsar/commit/bb43fc6f3300e7844b900954bfcee52a0b1523ab", "committedDate": "2020-05-02T15:23:38Z", "message": "fix consumer stuck when batchReceivePolicy maxNumMessages > maxReceiverQueueSize"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTkxODc2", "url": "https://github.com/apache/pulsar/pull/6862#pullrequestreview-404591876", "createdAt": "2020-05-03T07:59:32Z", "commit": {"oid": "bb43fc6f3300e7844b900954bfcee52a0b1523ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QwNzo1OTozMlrOGPptVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QwNzo1OTozMlrOGPptVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA2NTE3NA==", "bodyText": "We also need to add a check for DEFAULT_POLICY since users may specify the queue size that lower that maxNumMessages of the DEFAULT_POLICY.", "url": "https://github.com/apache/pulsar/pull/6862#discussion_r419065174", "createdAt": "2020-05-03T07:59:32Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerBase.java", "diffHunk": "@@ -95,7 +95,16 @@ protected ConsumerBase(PulsarClientImpl client, String topic, ConsumerConfigurat\n         this.schema = schema;\n         this.interceptors = interceptors;\n         if (conf.getBatchReceivePolicy() != null) {\n-            this.batchReceivePolicy = conf.getBatchReceivePolicy();\n+            if (conf.getBatchReceivePolicy().getMaxNumMessages() > this.maxReceiverQueueSize) {\n+                BatchReceivePolicy batchReceivePolicy = conf.getBatchReceivePolicy();\n+                this.batchReceivePolicy = BatchReceivePolicy.builder()\n+                        .maxNumMessages(this.maxReceiverQueueSize)\n+                        .maxNumBytes(batchReceivePolicy.getMaxNumBytes())\n+                        .timeout((int)batchReceivePolicy.getTimeoutMs()/1000, TimeUnit.SECONDS)\n+                        .build();\n+            } else {\n+                this.batchReceivePolicy = conf.getBatchReceivePolicy();\n+            }\n         } else {\n             this.batchReceivePolicy = BatchReceivePolicy.DEFAULT_POLICY;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb43fc6f3300e7844b900954bfcee52a0b1523ab"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjQ4NjQ4", "url": "https://github.com/apache/pulsar/pull/6862#pullrequestreview-404648648", "createdAt": "2020-05-03T19:13:37Z", "commit": {"oid": "bb43fc6f3300e7844b900954bfcee52a0b1523ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxOToxMzozOFrOGPuq3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxOToxMzozOFrOGPuq3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0NjQ2MQ==", "bodyText": "can we also add unit tests with the desired behaviour ?", "url": "https://github.com/apache/pulsar/pull/6862#discussion_r419146461", "createdAt": "2020-05-03T19:13:38Z", "author": {"login": "psilos"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerBase.java", "diffHunk": "@@ -95,7 +95,16 @@ protected ConsumerBase(PulsarClientImpl client, String topic, ConsumerConfigurat\n         this.schema = schema;\n         this.interceptors = interceptors;\n         if (conf.getBatchReceivePolicy() != null) {\n-            this.batchReceivePolicy = conf.getBatchReceivePolicy();\n+            if (conf.getBatchReceivePolicy().getMaxNumMessages() > this.maxReceiverQueueSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb43fc6f3300e7844b900954bfcee52a0b1523ab"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a220c033d1d9d839ff68347a2bee5497027697", "author": {"user": {"login": "hangc0276", "name": "Hang Chen"}}, "url": "https://github.com/apache/pulsar/commit/f9a220c033d1d9d839ff68347a2bee5497027697", "committedDate": "2020-05-07T14:20:24Z", "message": "throw log warn and add test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTY2MjQ2", "url": "https://github.com/apache/pulsar/pull/6862#pullrequestreview-407566246", "createdAt": "2020-05-07T15:06:05Z", "commit": {"oid": "f9a220c033d1d9d839ff68347a2bee5497027697"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzExOTEy", "url": "https://github.com/apache/pulsar/pull/6862#pullrequestreview-408711912", "createdAt": "2020-05-10T06:38:22Z", "commit": {"oid": "f9a220c033d1d9d839ff68347a2bee5497027697"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3625, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}