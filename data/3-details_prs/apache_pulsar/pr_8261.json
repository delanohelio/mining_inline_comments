{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMjU5MzA3", "number": 8261, "title": "Support limits the max tenants of the Pulsar cluster", "bodyText": "Fixes #8223\nMotivation\nSupport limits the max tenants of the Pulsar cluster. When the tenants reach the max tenants of the cluster, the broker should reject the new tenant request.\nModifications\nAdd maxTenants=0 in the broker.conf and don't limit by default.\nVerifying this change\nTenantTest#testMaxTenant", "createdAt": "2020-10-14T10:05:38Z", "url": "https://github.com/apache/pulsar/pull/8261", "merged": true, "mergeCommit": {"oid": "682ceb44e7cde5ed8fa5bb79dd13ba05d66f27e7"}, "closed": true, "closedAt": "2020-10-16T16:54:09Z", "author": {"login": "315157973"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSZqrhgH2gAyNTAzMjU5MzA3OmFiMWM2NGMyZDEyNWJlNWMyNzkzMGEyNGRiOWY4MTY5M2MwZjUxZjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTJUeDAFqTUxMDY0MjQ2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ab1c64c2d125be5c27930a24db9f81693c0f51f7", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/ab1c64c2d125be5c27930a24db9f81693c0f51f7", "committedDate": "2020-10-14T09:22:07Z", "message": "support max tenants of the Pulsar cluster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "630272f69af2cd26fa9bcd612dd35f95899fec5b", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/630272f69af2cd26fa9bcd612dd35f95899fec5b", "committedDate": "2020-10-14T10:04:37Z", "message": "add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37c75909d62e472ba5fbe827d19e338b2cef0f5b", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/37c75909d62e472ba5fbe827d19e338b2cef0f5b", "committedDate": "2020-10-14T10:09:32Z", "message": "change comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTk0NzMy", "url": "https://github.com/apache/pulsar/pull/8261#pullrequestreview-508194732", "createdAt": "2020-10-14T10:10:00Z", "commit": {"oid": "630272f69af2cd26fa9bcd612dd35f95899fec5b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDoxMDowMFrOHhL5oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDoxMDowMFrOHhL5oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2MDAzMw==", "bodyText": "So we can have a race and see that this limit is not enforced.\nprobably this is not a big deal (and enforcing it would be very costly) but we should state it clearly at least in the description of this pull request", "url": "https://github.com/apache/pulsar/pull/8261#discussion_r504560033", "createdAt": "2020-10-14T10:10:00Z", "author": {"login": "eolivelli"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java", "diffHunk": "@@ -105,6 +105,12 @@ public void createTenant(\n \n         try {\n             NamedEntity.checkName(tenant);\n+            List<String> tenants = globalZk().getChildren(path(POLICIES), false);\n+            int maxTenants = pulsar().getConfiguration().getMaxTenants();\n+            //No locks for precise control", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "630272f69af2cd26fa9bcd612dd35f95899fec5b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccceecf63bb58dbe101e9ad4ed80d9acd66b3fc2", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/ccceecf63bb58dbe101e9ad4ed80d9acd66b3fc2", "committedDate": "2020-10-14T13:51:15Z", "message": " add unit test and comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c076f596813750056f2e9c61544552980241be81", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/c076f596813750056f2e9c61544552980241be81", "committedDate": "2020-10-14T13:53:43Z", "message": " add doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25b34d68451644a9ede9cd813c3ef3cfcf92b25c", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/25b34d68451644a9ede9cd813c3ef3cfcf92b25c", "committedDate": "2020-10-15T02:21:41Z", "message": "remove unstable unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4OTA2NDk2", "url": "https://github.com/apache/pulsar/pull/8261#pullrequestreview-508906496", "createdAt": "2020-10-15T03:10:19Z", "commit": {"oid": "25b34d68451644a9ede9cd813c3ef3cfcf92b25c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0137f54e6ce70e95327d8b738bc23f324fd0118", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/a0137f54e6ce70e95327d8b738bc23f324fd0118", "committedDate": "2020-10-15T07:41:34Z", "message": "add cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTI1Nzk1", "url": "https://github.com/apache/pulsar/pull/8261#pullrequestreview-509525795", "createdAt": "2020-10-15T15:49:37Z", "commit": {"oid": "a0137f54e6ce70e95327d8b738bc23f324fd0118"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo0OTozN1rOHiOiqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo0OTozN1rOHiOiqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY1MTg4MQ==", "bodyText": "You shouldn't get the list of tenants from zookeeper first. You should check maxTenants first. If maxTenants is larger than 0, this feature is enabled. Then you get the list of tenants.", "url": "https://github.com/apache/pulsar/pull/8261#discussion_r505651881", "createdAt": "2020-10-15T15:49:37Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/TenantsBase.java", "diffHunk": "@@ -105,6 +105,13 @@ public void createTenant(\n \n         try {\n             NamedEntity.checkName(tenant);\n+            List<String> tenants = globalZk().getChildren(path(POLICIES), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0137f54e6ce70e95327d8b738bc23f324fd0118"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "356731f9c9d3a6f7f94b8d0125cdcfc3aa1665d7", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/356731f9c9d3a6f7f94b8d0125cdcfc3aa1665d7", "committedDate": "2020-10-15T16:02:52Z", "message": "Judge first before reading zk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNjQyNDY1", "url": "https://github.com/apache/pulsar/pull/8261#pullrequestreview-510642465", "createdAt": "2020-10-16T16:53:18Z", "commit": {"oid": "356731f9c9d3a6f7f94b8d0125cdcfc3aa1665d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1234, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}