{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MzM3NzEw", "number": 8208, "title": "Use ThreadPoolExecutor instead of EventLoop", "bodyText": "Motivation\nWhen Netty's EventLoop receives a new task\uff0cit will call eventFdWrite, and then trigger system calls, such as: system_call_fastpath, eventfd_write\nAfter we replaced EventLoop with a native jdk thread pool, the performance improved\nModifications\nUse ThreadPoolExecutor instead of EventLoop\nVerifying this change\nWe use pulsar perf for testing\nbefore\uff1a\nAggregated throughput stats --- 11715556 records received --- 68813.420 msg/s --- 537.605 Mbit/s\nafter\uff1a\nAggregated throughput stats --- 18392800 records received --- 133314.602 msg/s --- 1041.520 Mbit/s", "createdAt": "2020-10-06T07:41:02Z", "url": "https://github.com/apache/pulsar/pull/8208", "merged": true, "mergeCommit": {"oid": "3a298f3404d597e6a94de981c5fbe570264dcba1"}, "closed": true, "closedAt": "2020-10-14T01:03:40Z", "author": {"login": "315157973"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPzF6dgH2gAyNDk4MzM3NzEwOmUzYmYwMzBjZGY5Njk1MmE0OGMyNWJhOTNhZjk1ZjlhNzk1MDYxZDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRsBQ0gH2gAyNDk4MzM3NzEwOjk2Nzk5YzY3NDUxZjJjOGY3NzM4NDRlOGQ1MjQ1MzhiYzA1ZjMxNjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e3bf030cdf96952a48c25ba93af95f9a795061d6", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/e3bf030cdf96952a48c25ba93af95f9a795061d6", "committedDate": "2020-10-06T07:17:43Z", "message": "use ThreadPoolExecutor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNjY0Mzcy", "url": "https://github.com/apache/pulsar/pull/8208#pullrequestreview-502664372", "createdAt": "2020-10-06T07:42:49Z", "commit": {"oid": "e3bf030cdf96952a48c25ba93af95f9a795061d6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNzo0Mjo1MFrOHc5yrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNzo0Mjo1MFrOHc5yrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA2OTAzOA==", "bodyText": "we must shutdown this executor, otherwise we are leaking threads", "url": "https://github.com/apache/pulsar/pull/8208#discussion_r500069038", "createdAt": "2020-10-06T07:42:50Z", "author": {"login": "eolivelli"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java", "diffHunk": "@@ -145,6 +147,8 @@ public PulsarClientImpl(ClientConfigurationData conf, EventLoopGroup eventLoopGr\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n+        ioExecutorService = new ThreadPoolExecutor(conf.getNumIoThreads(), conf.getNumIoThreads(), 0L, TimeUnit.MILLISECONDS,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3bf030cdf96952a48c25ba93af95f9a795061d6"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8612e46e11d617bddfe7268d57b5a3b3b9250aa4", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/8612e46e11d617bddfe7268d57b5a3b3b9250aa4", "committedDate": "2020-10-06T07:46:57Z", "message": "add shutdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTAyMDY4", "url": "https://github.com/apache/pulsar/pull/8208#pullrequestreview-503902068", "createdAt": "2020-10-07T13:51:58Z", "commit": {"oid": "8612e46e11d617bddfe7268d57b5a3b3b9250aa4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzo1MTo1OVrOHd0bfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMzo1MTo1OVrOHd0bfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAyOTc1OA==", "bodyText": "Now we already have threads named pulsar-client-io, so it's better to use a different name for the new threads. And I noticed some internal tasks of the client also uses the externalExecutorProvider for executing the internal task of the Pulsar client. Maybe we can add an internalExecutorService for handing the internal tasks of the client.", "url": "https://github.com/apache/pulsar/pull/8208#discussion_r501029758", "createdAt": "2020-10-07T13:51:59Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java", "diffHunk": "@@ -145,6 +147,8 @@ public PulsarClientImpl(ClientConfigurationData conf, EventLoopGroup eventLoopGr\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n+        ioExecutorService = new ThreadPoolExecutor(conf.getNumIoThreads(), conf.getNumIoThreads(), 0L, TimeUnit.MILLISECONDS,\n+                new LinkedBlockingQueue<>(), getThreadFactory(\"pulsar-io-thread\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8612e46e11d617bddfe7268d57b5a3b3b9250aa4"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b19536ba52067d72a2378d83fa3eb2a057c72932", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/b19536ba52067d72a2378d83fa3eb2a057c72932", "committedDate": "2020-10-07T16:49:47Z", "message": "use ExecutorProvider instead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzgxNjUx", "url": "https://github.com/apache/pulsar/pull/8208#pullrequestreview-504781651", "createdAt": "2020-10-08T13:28:13Z", "commit": {"oid": "b19536ba52067d72a2378d83fa3eb2a057c72932"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzoyODoxM1rOHeekUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzoyODoxM1rOHeekUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcyMDE0NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-io\"));\n          \n          \n            \n                    internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-internal\"));", "url": "https://github.com/apache/pulsar/pull/8208#discussion_r501720145", "createdAt": "2020-10-08T13:28:13Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java", "diffHunk": "@@ -145,6 +147,7 @@ public PulsarClientImpl(ClientConfigurationData conf, EventLoopGroup eventLoopGr\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n+        internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-io\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19536ba52067d72a2378d83fa3eb2a057c72932"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64daa07e801579c6d83b5fcb0b2a596ba2faf198", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/64daa07e801579c6d83b5fcb0b2a596ba2faf198", "committedDate": "2020-10-11T13:39:50Z", "message": "Update pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\n\nCo-authored-by: lipenghui <penghui@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjM0NjU3", "url": "https://github.com/apache/pulsar/pull/8208#pullrequestreview-506234657", "createdAt": "2020-10-12T00:27:43Z", "commit": {"oid": "64daa07e801579c6d83b5fcb0b2a596ba2faf198"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96799c67451f2c8f773844e8d524538bc05f3161", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/96799c67451f2c8f773844e8d524538bc05f3161", "committedDate": "2020-10-12T04:11:09Z", "message": "merge master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 147, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}