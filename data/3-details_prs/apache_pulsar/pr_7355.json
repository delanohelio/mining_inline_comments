{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5NTc5MTA0", "number": 7355, "title": "Handling error in creation of non-durable cursor", "bodyText": "Motivation\nWe're getting an NPE when the creation of a non-durable cursor fails.\n2020-06-20 00:00:23.872000+00:00 [WARN ] [he.pulsar.broker.service.ServerCnx]  [/127.0.0.1:47412][persistent://TOPIC][reader-7369753eb6] Failed to create consumer: null\n        java.util.concurrent.CompletionException: java.lang.NullPointerException\n        at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:314) [?:?]\n        at java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1113) [?:?]\n        at java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2235) [?:?]\n        at org.apache.pulsar.broker.service.ServerCnx.lambda$null$14(ServerCnx.java:802) [org.apache.pulsar-pulsar-broker-2.5.0.SPLK.6584581.jar:2.5.0.SPLK.6584581]\n        at java.util.concurrent.CompletableFuture$UniApply.tryFire(CompletableFuture.java:642) [?:?]\n        at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) [?:?]\n        at java.util.concurrent.CompletableFuture.postFire(CompletableFuture.java:610) [?:?]\n        at java.util.concurrent.CompletableFuture$UniCompose.tryFire(CompletableFuture.java:1085) [?:?]\n        at java.util.concurrent.CompletableFuture$Completion.run(CompletableFuture.java:478) [?:?]\n        at java.lang.Thread.run(Thread.java:834) [?:?]\nCaused by: java.lang.NullPointerException\n        at org.apache.pulsar.broker.service.persistent.PersistentMessageExpiryMonitor.<init>(PersistentMessageExpiryMonitor.java:56) ~[org.apache.pulsar-pulsar-broker-2.5.0.SPLK.6584581.jar:2.5.0.SPLK.6584581]\n        at org.apache.pulsar.broker.service.persistent.PersistentSubscription.<init>(PersistentSubscription.java:148) ~[org.apache.pulsar-pulsar-broker-2.5.0.SPLK.6584581.jar:2.5.0.SPLK.6584581]\n        at org.apache.pulsar.broker.service.persistent.PersistentTopic.lambda$getNonDurableSubscription$13(PersistentTopic.java:695) ~[org.apache.pulsar-pulsar-broker-2.5.0.SPLK.6584581.jar:2.5.0.SPLK.6584581]\n        at org.apache.pulsar.common.util.collections.ConcurrentOpenHashMap$Section.put(ConcurrentOpenHashMap.java:274) ~[org.apache.pulsar-pulsar-common-2.5.0.SPLK.6584581.jar:2.5.0.SPLK.6584581]\n        at org.apache.pulsar.common.util.collections.ConcurrentOpenHashMap.computeIfAbsent(ConcurrentOpenHashMap.java:129) ~[org.apache.pulsar-pulsar-common-2.5.0.SPLK.6584581.jar:2.5.0.SPLK.6584581]\n        at org.apache.pulsar.broker.service.persistent.PersistentTopic.getNonDurableSubscription(PersistentTopic.java:673) ~[org.apache.pulsar-pulsar-broker-2.5.0.SPLK.6584581.jar:2.5.0.SPLK.6584581]\n        at org.apache.pulsar.broker.service.persistent.PersistentTopic.subscribe(PersistentTopic.java:581) ~[org.apache.pulsar-pulsar-broker-2.5.0.SPLK.6584581.jar:2.5.0.SPLK.6584581]\n        at org.apache.pulsar.broker.service.ServerCnx.lambda$null$11(ServerCnx.java:817) [org.apache.pulsar-pulsar-broker-2.5.0.SPLK.6584581.jar:2.5.0.SPLK.6584581]\n        at java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1106) ~[?:?]\n        ... 8 more\n\nThe reason is that, we fail the future but we go on in creating the subscription instance:\ntry {\n    cursor = ledger.newNonDurableCursor(startPosition, subscriptionName);\n} catch (ManagedLedgerException e) {\n    subscriptionFuture.completeExceptionally(e);\n}\n\nreturn new PersistentSubscription(this, subscriptionName, cursor, false);\nAdditionally, the NPE leads to the topic usage count to not be decremented, leaking 1 usage increment. At the time of deletion, this will prevent the topic from being deleted, even when using the force flag.", "createdAt": "2020-06-24T23:59:03Z", "url": "https://github.com/apache/pulsar/pull/7355", "merged": true, "mergeCommit": {"oid": "0a5f0a065e76fd6dff6243441d2cfbf25f0ee3dc"}, "closed": true, "closedAt": "2020-06-27T04:11:41Z", "author": {"login": "merlimat"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcujA9-AH2gAyNDM5NTc5MTA0OjdmODRmZjRlMTU3OTM2MDM4ZTE1MjZhYjk3NGIyYjQwMDNjZTk4MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeamvXigFqTY2OTMzMzE3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7f84ff4e157936038e1526ab974b2b4003ce9822", "author": {"user": {"login": "merlimat", "name": "Matteo Merli"}}, "url": "https://github.com/apache/pulsar/commit/7f84ff4e157936038e1526ab974b2b4003ce9822", "committedDate": "2020-06-24T23:54:20Z", "message": "Handling error in creation of non-durable cursor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2216dd1cfc1f9c53346414305413f49c1957ac10", "author": {"user": {"login": "merlimat", "name": "Matteo Merli"}}, "url": "https://github.com/apache/pulsar/commit/2216dd1cfc1f9c53346414305413f49c1957ac10", "committedDate": "2020-06-25T04:44:25Z", "message": "Fixed tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjYzOTY2", "url": "https://github.com/apache/pulsar/pull/7355#pullrequestreview-438663966", "createdAt": "2020-06-27T02:08:08Z", "commit": {"oid": "2216dd1cfc1f9c53346414305413f49c1957ac10"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjY5MzMzMTcx", "url": "https://github.com/apache/pulsar/pull/7355#pullrequestreview-669333171", "createdAt": "2021-05-26T17:18:32Z", "commit": {"oid": "2216dd1cfc1f9c53346414305413f49c1957ac10"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0yNlQxNzoxODozM1rOJiTpTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0yNlQxNzoxODozM1rOJiTpTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzOTk1MzIzMQ==", "bodyText": "@merlimat - I know this has been merged for a while, but I was reading through this class today, and I am concerned about a possible race condition that would lead to an incorrect update to the subscriptions map.\nWith this PR, the subscriptions map is no longer updated using the computeIfAbsent method here, but is instead modified with a get and then a subsequent put. The getDurableSubscription updates the subscriptions map concurrently as well. I believe this opens us up to a race under the following conditions:\n\nWe call get for a subscription on line 695, and get null.\nThen, a durable subscription with the same name is added to the subscriptions map on line 665.\nThen, the non durable subscription is put into the subscriptions map on new line 722, and in doing so, overwrites the durable subscription of the same name.\n\nDo you agree this is a risk here? If so, I will work on contributing a fix. I wanted to check first though, just in case there is context I'm missing. Thanks!", "url": "https://github.com/apache/pulsar/pull/7355#discussion_r639953231", "createdAt": "2021-05-26T17:18:33Z", "author": {"login": "michaeljmarshall"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -688,12 +688,13 @@ public void openCursorFailed(ManagedLedgerException exception, Object ctx) {\n \n     private CompletableFuture<? extends Subscription> getNonDurableSubscription(String subscriptionName,\n             MessageId startMessageId, long startMessageRollbackDurationSec) {\n-        CompletableFuture<Subscription> subscriptionFuture = new CompletableFuture<>();\n         log.info(\"[{}][{}] Creating non-durable subscription at msg id {}\", topic, subscriptionName, startMessageId);\n \n         synchronized (ledger) {\n             // Create a new non-durable cursor only for the first consumer that connects\n-            Subscription subscription = subscriptions.computeIfAbsent(subscriptionName, name -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2216dd1cfc1f9c53346414305413f49c1957ac10"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 745, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}