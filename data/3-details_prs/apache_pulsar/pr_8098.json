{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNjc4Njg1", "number": 8098, "title": "Add ability to specify EnvironmentBasedSecretsProvider in LocalRunner", "bodyText": "(If this PR fixes a github issue, please add Fixes #<xyz>.)\nFixes #\n(or if this PR is one task of a github issue, please add Master Issue: #<xyz> to link to the master issue.)\nMaster Issue: #\nMotivation\nAdded ability to specify environment based secrets provider for sources/sinks/functions localrunner.\nModifications\nDescribe the modifications you've done.\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\n(Please pick either of the following options)\nThis change is a trivial rework / code cleanup without any test coverage.\n(or)\nThis change is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end deployment with large payloads (10MB)\nExtended integration test for recovery after broker failure\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API: (yes / no)\nThe schema: (yes / no / don't know)\nThe default values of configurations: (yes / no)\nThe wire protocol: (yes / no)\nThe rest endpoints: (yes / no)\nThe admin cli options: (yes / no)\nAnything that affects deployment: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)\nIf a feature is not applicable for documentation, explain why?\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-09-22T04:07:44Z", "url": "https://github.com/apache/pulsar/pull/8098", "merged": true, "mergeCommit": {"oid": "fefaf52a30e89f82079f095e4bddad39f6c17e52"}, "closed": true, "closedAt": "2020-09-23T14:32:38Z", "author": {"login": "srkukarni"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLP9pngH2gAyNDkwNjc4Njg1OmU0OTI2MWM2ZTQyNDE5ZGMyZjk2Y2RkYmI3ZjkwMWFjMzRjZjNlNWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLl7QmgFqTQ5NDE2Mzc2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e49261c6e42419dc2f96cddbb7f901ac34cf3e5e", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/e49261c6e42419dc2f96cddbb7f901ac34cf3e5e", "committedDate": "2020-09-22T04:06:19Z", "message": "Add ability to specify EnvironmentBasedSecretsProvider in LocalRunner"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNjUzMjYw", "url": "https://github.com/apache/pulsar/pull/8098#pullrequestreview-493653260", "createdAt": "2020-09-22T16:40:14Z", "commit": {"oid": "e49261c6e42419dc2f96cddbb7f901ac34cf3e5e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNjY0NzMz", "url": "https://github.com/apache/pulsar/pull/8098#pullrequestreview-493664733", "createdAt": "2020-09-22T16:54:36Z", "commit": {"oid": "e49261c6e42419dc2f96cddbb7f901ac34cf3e5e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjo1NDozNlrOHWDpoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNjo1NDozNlrOHWDpoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg5MDUyOA==", "bodyText": "I think there is already too arguments for the CLI.  Lets try to create something more generic.  Instead of creating an argument for a specific provider, can we create an argument to allow users to specify the secret provider type?  In the future, if we add more providers, I don't want to keep add one-of arguments.  For example, can we create a enum?\nEnum SecretsProviderType {\nENV,\nDEFAULT,\n...\n}\nbased on the enum determine", "url": "https://github.com/apache/pulsar/pull/8098#discussion_r492890528", "createdAt": "2020-09-22T16:54:36Z", "author": {"login": "jerrypeng"}, "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdFunctions.java", "diffHunk": "@@ -627,6 +627,8 @@ protected void validateFunctionConfigs(FunctionConfig functionConfig) {\n         protected Integer instanceIdOffset = 0;\n         @Parameter(names = \"--runtime\", description = \"either THREAD or PROCESS. Only applies for Java functions\")\n         protected String runtime;\n+        @Parameter(names = \"--environment-based-secrets-provider\", description = \"Should we use environment based secret provider\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e49261c6e42419dc2f96cddbb7f901ac34cf3e5e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba7a381ee15bbff4b2210de5fc28f372b068e411", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/ba7a381ee15bbff4b2210de5fc28f372b068e411", "committedDate": "2020-09-22T17:43:00Z", "message": "Addressed feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fcfdde0e25121f28e71f9ae76b60a23a4b8ef63", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/2fcfdde0e25121f28e71f9ae76b60a23a4b8ef63", "committedDate": "2020-09-22T17:45:32Z", "message": "Took out wildcard"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41434775b3ca4fae735f5f037585c95279729ed9", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/41434775b3ca4fae735f5f037585c95279729ed9", "committedDate": "2020-09-22T17:46:08Z", "message": "Fix build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzEyNzQ1", "url": "https://github.com/apache/pulsar/pull/8098#pullrequestreview-493712745", "createdAt": "2020-09-22T17:56:56Z", "commit": {"oid": "41434775b3ca4fae735f5f037585c95279729ed9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo1Njo1NlrOHWF9qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo1Njo1NlrOHWF9qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyODQyNQ==", "bodyText": "Just create an instance using the class name. Use method:\nhttps://github.com/apache/pulsar/blob/master/pulsar-common/src/main/java/org/apache/pulsar/common/util/Reflections.java#L64", "url": "https://github.com/apache/pulsar/pull/8098#discussion_r492928425", "createdAt": "2020-09-22T17:56:56Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/localrun/src/main/java/org/apache/pulsar/functions/LocalRunner.java", "diffHunk": "@@ -418,11 +428,24 @@ private void startThreadedMode(org.apache.pulsar.functions.proto.Function.Functi\n                                            int parallelism, int instanceIdOffset, String serviceUrl,\n                                            String stateStorageServiceUrl, AuthenticationConfig authConfig,\n                                            String userCodeFile) throws Exception {\n+        SecretsProvider secretsProvider;\n+        if (secretsProviderClassName != null) {\n+            if (secretsProviderClassName.equals(ClearTextSecretsProvider.class.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41434775b3ca4fae735f5f037585c95279729ed9"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzEzNjM2", "url": "https://github.com/apache/pulsar/pull/8098#pullrequestreview-493713636", "createdAt": "2020-09-22T17:58:03Z", "commit": {"oid": "41434775b3ca4fae735f5f037585c95279729ed9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo1ODowM1rOHWGATQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo1ODowM1rOHWGATQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyOTEwMQ==", "bodyText": "These comments don't make sense for this class", "url": "https://github.com/apache/pulsar/pull/8098#discussion_r492929101", "createdAt": "2020-09-22T17:58:03Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/secrets/src/main/java/org/apache/pulsar/functions/secretsproviderconfigurator/NameAndConfigBasedSecretsProviderConfigurator.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.functions.secretsproviderconfigurator;\n+\n+import com.google.gson.reflect.TypeToken;\n+import io.kubernetes.client.openapi.models.V1PodSpec;\n+import org.apache.pulsar.functions.proto.Function;\n+import org.apache.pulsar.functions.secretsprovider.EnvironmentBasedSecretsProvider;\n+\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+\n+/**\n+ * This file defines the SecretsProviderConfigurator that will be used by default for running in Kubernetes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41434775b3ca4fae735f5f037585c95279729ed9"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzI0ODgz", "url": "https://github.com/apache/pulsar/pull/8098#pullrequestreview-493724883", "createdAt": "2020-09-22T18:12:48Z", "commit": {"oid": "41434775b3ca4fae735f5f037585c95279729ed9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODoxMjo0OFrOHWGiVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODoxMjo0OFrOHWGiVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkzNzgxMg==", "bodyText": "There is not really point to have this class. Just refactor ProcessRuntime to take in a SecretsProvider like ThreadRuntime", "url": "https://github.com/apache/pulsar/pull/8098#discussion_r492937812", "createdAt": "2020-09-22T18:12:48Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/secrets/src/main/java/org/apache/pulsar/functions/secretsproviderconfigurator/NameAndConfigBasedSecretsProviderConfigurator.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.functions.secretsproviderconfigurator;\n+\n+import com.google.gson.reflect.TypeToken;\n+import io.kubernetes.client.openapi.models.V1PodSpec;\n+import org.apache.pulsar.functions.proto.Function;\n+import org.apache.pulsar.functions.secretsprovider.EnvironmentBasedSecretsProvider;\n+\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+\n+/**\n+ * This file defines the SecretsProviderConfigurator that will be used by default for running in Kubernetes.\n+ * As such this implementation is strictly when workers are configured to use kubernetes runtime.\n+ * We use kubernetes in built secrets and bind them as environment variables within the function container\n+ * to ensure that the secrets are available to the function at runtime. Then we plug in the\n+ * EnvironmentBasedSecretsConfig as the secrets provider who knows how to read these environment variables.\n+ */\n+public class NameAndConfigBasedSecretsProviderConfigurator implements SecretsProviderConfigurator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41434775b3ca4fae735f5f037585c95279729ed9"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f1717dac772bf198b7d8b691e95a24e770292f7", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/2f1717dac772bf198b7d8b691e95a24e770292f7", "committedDate": "2020-09-23T05:25:02Z", "message": "Address feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MTYxMjI2", "url": "https://github.com/apache/pulsar/pull/8098#pullrequestreview-494161226", "createdAt": "2020-09-23T05:40:02Z", "commit": {"oid": "2f1717dac772bf198b7d8b691e95a24e770292f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNTo0MDowMlrOHWXHqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNTo0MDowMlrOHWXHqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIwOTUxNQ==", "bodyText": "nit not sure why we mention kubernetes here in the comment.  SecretsProviderConfigurator are not kubernetes specific", "url": "https://github.com/apache/pulsar/pull/8098#discussion_r493209515", "createdAt": "2020-09-23T05:40:02Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/secrets/src/main/java/org/apache/pulsar/functions/secretsproviderconfigurator/NameAndConfigBasedSecretsProviderConfigurator.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.functions.secretsproviderconfigurator;\n+\n+import com.google.gson.reflect.TypeToken;\n+import io.kubernetes.client.openapi.models.V1PodSpec;\n+import org.apache.pulsar.functions.proto.Function;\n+\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+\n+/**\n+ * This is a very simple secrets provider which wires in a given secrets provider classname/config\n+ * to the function instances/containers. This does not do any special kubernetes specific wiring.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f1717dac772bf198b7d8b691e95a24e770292f7"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MTYxNTI2", "url": "https://github.com/apache/pulsar/pull/8098#pullrequestreview-494161526", "createdAt": "2020-09-23T05:40:13Z", "commit": {"oid": "2f1717dac772bf198b7d8b691e95a24e770292f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNTo0MDoxNFrOHWXH7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNTo0MDoxNFrOHWXH7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIwOTU4MA==", "bodyText": "nit remove this comment", "url": "https://github.com/apache/pulsar/pull/8098#discussion_r493209580", "createdAt": "2020-09-23T05:40:14Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/secrets/src/main/java/org/apache/pulsar/functions/secretsproviderconfigurator/NameAndConfigBasedSecretsProviderConfigurator.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.functions.secretsproviderconfigurator;\n+\n+import com.google.gson.reflect.TypeToken;\n+import io.kubernetes.client.openapi.models.V1PodSpec;\n+import org.apache.pulsar.functions.proto.Function;\n+\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+\n+/**\n+ * This is a very simple secrets provider which wires in a given secrets provider classname/config\n+ * to the function instances/containers. This does not do any special kubernetes specific wiring.\n+ */\n+public class NameAndConfigBasedSecretsProviderConfigurator implements SecretsProviderConfigurator {\n+    private String className;\n+    private Map<String, String> config;\n+    public NameAndConfigBasedSecretsProviderConfigurator(String className, Map<String, String> config) {\n+        this.className = className;\n+        this.config = config;\n+    }\n+    @Override\n+    public String getSecretsProviderClassName(Function.FunctionDetails functionDetails) {\n+        return className;\n+    }\n+\n+    @Override\n+    public Map<String, String> getSecretsProviderConfig(Function.FunctionDetails functionDetails) {\n+        return config;\n+    }\n+\n+    // Kubernetes secrets can be exposed as volume mounts or as environment variables in the pods. We are currently using the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f1717dac772bf198b7d8b691e95a24e770292f7"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MTYzNzY5", "url": "https://github.com/apache/pulsar/pull/8098#pullrequestreview-494163769", "createdAt": "2020-09-23T05:41:37Z", "commit": {"oid": "2f1717dac772bf198b7d8b691e95a24e770292f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 100, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}