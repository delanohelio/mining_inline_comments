{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxMDc4ODE4", "number": 8234, "title": "Modify the occasion of triggering listeners", "bodyText": "Motivation\nWhen we use SystemTopicBasedTopicPoliciesService#updateTopicPoliciesAsync to update Topic-level policies, Listener.onUpdate() will be triggered;\nNow this approach will cause 2 problems:\n\nBecause updateTopicPoliciesAsync only sends the message to the system topic, it has not been consumed yet. Therefore, the policy data in the cache is still old. When listeners are triggered, they cannot get the policies directly through the cache. They have to modify the existing interface and pass the policies through parameters.\nWhen the broker restarts, some topic-level policies will no longer take effect, because they rely on the onUpdate method to take effect\n\nModifications\n1)The trigger occasion of listener.onUpdate is changed to when the reader consumes the event\n2)fix some npe\nVerifying this change\nTopicPoliciesTest#testRestart", "createdAt": "2020-10-11T04:47:20Z", "url": "https://github.com/apache/pulsar/pull/8234", "merged": true, "mergeCommit": {"oid": "3539992442ac9f355f8011d2524b0142fc80f6ad"}, "closed": true, "closedAt": "2020-10-14T01:02:09Z", "author": {"login": "315157973"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRV3yEgH2gAyNTAxMDc4ODE4OmRhZWZjZGJjMjQ1MDIzM2FjMzhlOTg0M2E4OTU3MTlkNmY2NTk3M2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRZWl1gFqTUwNjE0NzY1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "daefcdbc2450233ac38e9843a895719d6f65973c", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/daefcdbc2450233ac38e9843a895719d6f65973c", "committedDate": "2020-10-11T02:22:53Z", "message": "fix policies lost"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca1a7c4df1736f33b380442eb22bc1c2ecd58482", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/ca1a7c4df1736f33b380442eb22bc1c2ecd58482", "committedDate": "2020-10-11T03:35:32Z", "message": "fix npe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56080e71ff836cc31aa755d6d06ec2ddb69209ec", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/56080e71ff836cc31aa755d6d06ec2ddb69209ec", "committedDate": "2020-10-11T04:06:38Z", "message": "fix get namespace policies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b68a739ba27516b294c8a0413a72128ea189bfb2", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/b68a739ba27516b294c8a0413a72128ea189bfb2", "committedDate": "2020-10-11T06:18:37Z", "message": "fix unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTQ3MzE4", "url": "https://github.com/apache/pulsar/pull/8234#pullrequestreview-506147318", "createdAt": "2020-10-11T06:19:41Z", "commit": {"oid": "b68a739ba27516b294c8a0413a72128ea189bfb2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQwNjoxOTo0MVrOHfk2bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQwNjoxOTo0MVrOHfk2bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg3MTY2MQ==", "bodyText": "Why do we need to get the namespace policy from the DispatchRateLimiter? If we don't enable the dispatch rate limiter, is it possible to get the namespace policy?", "url": "https://github.com/apache/pulsar/pull/8234#discussion_r502871661", "createdAt": "2020-10-11T06:19:41Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -2427,14 +2427,8 @@ public void onUpdate(TopicPolicies policies) {\n         }\n     }\n \n-    private Optional<Policies> getNamespacePolicies(){\n-        try {\n-            return Optional.ofNullable(brokerService.pulsar().getAdminClient().namespaces()\n-                    .getPolicies(TopicName.get(topic).getNamespace()));\n-        } catch (Exception e) {\n-            log.error(\"get namespace policies fail\", e);\n-        }\n-        return Optional.empty();\n+    private Optional<Policies> getNamespacePolicies() {\n+        return DispatchRateLimiter.getPolicies(brokerService, topic);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b68a739ba27516b294c8a0413a72128ea189bfb2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTQ3NjUx", "url": "https://github.com/apache/pulsar/pull/8234#pullrequestreview-506147651", "createdAt": "2020-10-11T06:26:15Z", "commit": {"oid": "b68a739ba27516b294c8a0413a72128ea189bfb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1212, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}