{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNjcxMTcz", "number": 7416, "title": "Decompression payload if needed in KeyShared subscription", "bodyText": "Fixes #7414\nMotivation\nDecompression payload if needed in KeyShared subscription\nVerifying this change\nUnit test added\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (no)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)", "createdAt": "2020-07-01T12:37:05Z", "url": "https://github.com/apache/pulsar/pull/7416", "merged": true, "mergeCommit": {"oid": "ed3583a5bd750661f8643617fc618151f87019b2"}, "closed": true, "closedAt": "2020-07-16T01:25:02Z", "author": {"login": "codelipenghui"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwpWPjgH2gAyNDQyNjcxMTczOmI3Yjc2OTZlZjg3ZGY5MjQ2N2QwZjgwZWNlODVjNmRhY2Y2ZWY5YWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0jRMUAH2gAyNDQyNjcxMTczOjQ2MDczMWM4NjJiYWQwY2M4MzcxN2NjNWRlOTg0NzU4NjQyODYxMWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b7b7696ef87df92467d0f80ece85c6dacf6ef9ab", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/b7b7696ef87df92467d0f80ece85c6dacf6ef9ab", "committedDate": "2020-07-01T12:24:51Z", "message": "Decompression the payload if need for single batch message in KeyShared subscription."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f853896be924a063ba8b6d5482804d222e0ac8a1", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/f853896be924a063ba8b6d5482804d222e0ac8a1", "committedDate": "2020-07-01T12:34:59Z", "message": "decompression only no key in the metadata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODM3Nzc2", "url": "https://github.com/apache/pulsar/pull/7416#pullrequestreview-440837776", "createdAt": "2020-07-01T12:49:32Z", "commit": {"oid": "f853896be924a063ba8b6d5482804d222e0ac8a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjo0OTozMlrOGrkfBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMjo0OTozMlrOGrkfBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMzOTcxOQ==", "bodyText": "We should avoid decompressing in the broker in any case. This is very dangerous from a CPU usage point of view.", "url": "https://github.com/apache/pulsar/pull/7416#discussion_r448339719", "createdAt": "2020-07-01T12:49:32Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractBaseDispatcher.java", "diffHunk": "@@ -153,13 +155,18 @@ public void resetCloseFuture() {\n         PulsarApi.MessageMetadata metadata = Commands.parseMessageMetadata(metadataAndPayload);\n \n         try {\n-            if (metadata.hasNumMessagesInBatch()) {\n+            if (!metadata.hasOrderingKey() && !metadata.hasPartitionKey() && metadata.hasNumMessagesInBatch()) {\n                 // If the message was part of a batch (eg: a batch of 1 message), we need\n                 // to read the key from the first single-message-metadata entry\n+                PulsarApi.CompressionType compressionType = metadata.getCompression();\n+                CompressionCodec codec = CompressionCodecProvider.getCompressionCodec(compressionType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f853896be924a063ba8b6d5482804d222e0ac8a1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb7439e54640e30203b489c70d1c67c43ed573a9", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/cb7439e54640e30203b489c70d1c67c43ed573a9", "committedDate": "2020-07-02T08:26:39Z", "message": "Apply comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzY5NDQ1", "url": "https://github.com/apache/pulsar/pull/7416#pullrequestreview-445769445", "createdAt": "2020-07-09T16:14:59Z", "commit": {"oid": "cb7439e54640e30203b489c70d1c67c43ed573a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "460731c862bad0cc83717cc5de9847586428611c", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/460731c862bad0cc83717cc5de9847586428611c", "committedDate": "2020-07-13T15:35:36Z", "message": "Fix tests."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 510, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}