{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxODM1NDkx", "number": 8818, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzoyNToxOFrOFI7qjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wM1QwMzowNjo0MFrOFKoQIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0OTEwNDc4OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzoyNToxOFrOILHm3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwMDo1Nzo0OFrOILvglA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyOTg4NA==", "bodyText": "Could you please clarify why throw (RestException) e.getCause() does not work here? If e.getCause is instance of RestException, I think we can throw it directly. I might be missing something here.", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548529884", "createdAt": "2020-12-24T13:25:18Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -702,6 +702,11 @@ protected static PartitionedTopicMetadata fetchPartitionedTopicMetadata(PulsarSe\n             return pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n         } catch (Exception e) {\n             if (e.getCause() instanceof RestException) {\n+                // Since CompletableFuture wrappers exception, so we will lost the Status\n+                // rebuild the Status if exception message contains \"Topic not exist.\"\n+                if (e.getCause().getMessage().contains(\"Topic not exist.\")) {\n+                    throw new org.apache.pulsar.broker.web.RestException(Response.Status.NOT_FOUND, \"Topic not exist.\");\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9ab2f97c9e8a05902f93ea440f8297bf604361"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODgyMzk2Nw==", "bodyText": "I'll check this PR and push later.", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548823967", "createdAt": "2020-12-25T07:35:02Z", "author": {"login": "aloyszhang"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -702,6 +702,11 @@ protected static PartitionedTopicMetadata fetchPartitionedTopicMetadata(PulsarSe\n             return pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n         } catch (Exception e) {\n             if (e.getCause() instanceof RestException) {\n+                // Since CompletableFuture wrappers exception, so we will lost the Status\n+                // rebuild the Status if exception message contains \"Topic not exist.\"\n+                if (e.getCause().getMessage().contains(\"Topic not exist.\")) {\n+                    throw new org.apache.pulsar.broker.web.RestException(Response.Status.NOT_FOUND, \"Topic not exist.\");\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyOTg4NA=="}, "originalCommit": {"oid": "6e9ab2f97c9e8a05902f93ea440f8297bf604361"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE4MzYzNg==", "bodyText": "Thanks @aloyszhang", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r549183636", "createdAt": "2020-12-28T00:57:48Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -702,6 +702,11 @@ protected static PartitionedTopicMetadata fetchPartitionedTopicMetadata(PulsarSe\n             return pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n         } catch (Exception e) {\n             if (e.getCause() instanceof RestException) {\n+                // Since CompletableFuture wrappers exception, so we will lost the Status\n+                // rebuild the Status if exception message contains \"Topic not exist.\"\n+                if (e.getCause().getMessage().contains(\"Topic not exist.\")) {\n+                    throw new org.apache.pulsar.broker.web.RestException(Response.Status.NOT_FOUND, \"Topic not exist.\");\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyOTg4NA=="}, "originalCommit": {"oid": "6e9ab2f97c9e8a05902f93ea440f8297bf604361"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0OTEwNTQ3OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzoyNTozNFrOILHnKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzoyNTozNFrOILHnKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUyOTk2Mw==", "bodyText": "Same as the above comment.", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548529963", "createdAt": "2020-12-24T13:25:34Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -715,6 +720,11 @@ protected static PartitionedTopicMetadata fetchPartitionedTopicMetadataCheckAllo\n                     .get();\n         } catch (Exception e) {\n             if (e.getCause() instanceof RestException) {\n+                // Since CompletableFuture wrappers exception, so we will lost the Status\n+                // rebuild the Status if exception message contains \"Topic not exist.\"\n+                if (e.getCause().getMessage().contains(\"Topic not exist.\")) {\n+                    throw new org.apache.pulsar.broker.web.RestException(Response.Status.NOT_FOUND, \"Topic not exist.\");\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9ab2f97c9e8a05902f93ea440f8297bf604361"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0OTExODAyOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozMjo0NFrOILHtxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozMjo0NFrOILHtxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUzMTY1Mg==", "bodyText": "I think it's not correct handling here, If got 404 here, it means the partitioned metadata does not exist right? If the partitioned metadata does exist, why should we prevent the non-partitioned topic creation?", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548531652", "createdAt": "2020-12-24T13:32:44Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -456,10 +456,17 @@ protected void internalCreateNonPartitionedTopic(boolean authoritative) {\n \n         validateTopicOwnership(topicName, authoritative);\n \n-        PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);\n-        if (partitionMetadata.partitions > 0) {\n-            log.warn(\"[{}] Partitioned topic with the same name already exists {}\", clientAppId(), topicName);\n-            throw new RestException(Status.CONFLICT, \"This topic already exists\");\n+        PartitionedTopicMetadata partitionMetadata = null;\n+        try {\n+            partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);\n+            if (partitionMetadata.partitions > 0) {\n+                log.warn(\"[{}] Partitioned topic with the same name already exists {}\", clientAppId(), topicName);\n+                throw new RestException(Status.CONFLICT, \"This topic already exists\");\n+            }\n+        } catch (RestException restException) {\n+            if (Status.NOT_FOUND.getStatusCode() != restException.getResponse().getStatus()) {\n+                throw restException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9ab2f97c9e8a05902f93ea440f8297bf604361"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0OTEyMjgzOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/namespace/NamespaceService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozNTozNlrOILHwbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozNTozNlrOILHwbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUzMjMzNQ==", "bodyText": "What is the difference between these changes? Why we change the thenCompose to whenComplete?", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548532335", "createdAt": "2020-12-24T13:35:36Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/namespace/NamespaceService.java", "diffHunk": "@@ -1174,13 +1174,19 @@ public ServiceUnitId getServiceUnitId(TopicName topicName) throws Exception {\n     }\n \n     private CompletableFuture<List<String>> getPartitionsForTopic(TopicName topicName) {\n-        return pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).thenCompose(meta -> {\n+        CompletableFuture<List<String>> future = new CompletableFuture<>();\n+        pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).whenComplete((meta, t) -> {\n+            if (t != null) {\n+                future.completeExceptionally(t);\n+                return;\n+            }\n             List<String> result = Lists.newArrayList();\n             for (int i = 0; i < meta.partitions; i++) {\n                 result.add(topicName.getPartition(i).toString());\n             }\n-            return CompletableFuture.completedFuture(result);\n+            future.complete(result);\n         });\n+        return future;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9ab2f97c9e8a05902f93ea440f8297bf604361"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1MTg1MjAxOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQyMjo1Nzo0MVrOILfZog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQxMDoyMTo0OFrOILiV_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxOTcxNA==", "bodyText": "Please do not rely on strings, can we test the actual class?", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548919714", "createdAt": "2020-12-25T22:57:41Z", "author": {"login": "eolivelli"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -702,6 +702,11 @@ protected static PartitionedTopicMetadata fetchPartitionedTopicMetadata(PulsarSe\n             return pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n         } catch (Exception e) {\n             if (e.getCause() instanceof RestException) {\n+                // Since CompletableFuture wrappers exception, so we will lost the Status\n+                // rebuild the Status if exception message contains \"Topic not exist.\"\n+                if (e.getCause().getMessage().contains(\"Topic not exist.\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e9ab2f97c9e8a05902f93ea440f8297bf604361"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2NzkzNQ==", "bodyText": "Yes, I'll change this PR and push again.", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r548967935", "createdAt": "2020-12-26T10:21:48Z", "author": {"login": "aloyszhang"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -702,6 +702,11 @@ protected static PartitionedTopicMetadata fetchPartitionedTopicMetadata(PulsarSe\n             return pulsar.getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n         } catch (Exception e) {\n             if (e.getCause() instanceof RestException) {\n+                // Since CompletableFuture wrappers exception, so we will lost the Status\n+                // rebuild the Status if exception message contains \"Topic not exist.\"\n+                if (e.getCause().getMessage().contains(\"Topic not exist.\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxOTcxNA=="}, "originalCommit": {"oid": "6e9ab2f97c9e8a05902f93ea440f8297bf604361"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2Njg5NTcxOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wM1QwMzowNjo0MFrOINbPXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNTowMDoxM1rOIN01Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDk0ODcwMA==", "bodyText": "Here is not covered by tests? I noticed the tests only cover the checkAllowAutoCreation=false, could you please help add a test for cover checkAllowAutoCreation=true?", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r550948700", "createdAt": "2021-01-03T03:06:40Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -376,6 +377,25 @@ protected void validatePartitionedTopicMetadata(String tenant, String namespace,\n         }\n     }\n \n+    protected void validateTopicExistedAndCheckAllowAutoCreation(String tenant, String namespace,\n+                                                                 String encodedTopic, boolean checkAllowAutoCreation) {\n+        try {\n+            PartitionedTopicMetadata partitionedTopicMetadata =\n+                    pulsar().getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n+            if (partitionedTopicMetadata.partitions < 1) {\n+                if (!pulsar().getNamespaceService().checkTopicExists(topicName).get()\n+                        && checkAllowAutoCreation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6196592cf4eb2d59ac6f08caac9ccf56efe2143"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA4MTExMQ==", "bodyText": "I'll add test case to protect this part of code.", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r551081111", "createdAt": "2021-01-04T01:16:25Z", "author": {"login": "aloyszhang"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -376,6 +377,25 @@ protected void validatePartitionedTopicMetadata(String tenant, String namespace,\n         }\n     }\n \n+    protected void validateTopicExistedAndCheckAllowAutoCreation(String tenant, String namespace,\n+                                                                 String encodedTopic, boolean checkAllowAutoCreation) {\n+        try {\n+            PartitionedTopicMetadata partitionedTopicMetadata =\n+                    pulsar().getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n+            if (partitionedTopicMetadata.partitions < 1) {\n+                if (!pulsar().getNamespaceService().checkTopicExists(topicName).get()\n+                        && checkAllowAutoCreation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDk0ODcwMA=="}, "originalCommit": {"oid": "c6196592cf4eb2d59ac6f08caac9ccf56efe2143"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM2ODAwMw==", "bodyText": "Thanks", "url": "https://github.com/apache/pulsar/pull/8818#discussion_r551368003", "createdAt": "2021-01-04T15:00:13Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -376,6 +377,25 @@ protected void validatePartitionedTopicMetadata(String tenant, String namespace,\n         }\n     }\n \n+    protected void validateTopicExistedAndCheckAllowAutoCreation(String tenant, String namespace,\n+                                                                 String encodedTopic, boolean checkAllowAutoCreation) {\n+        try {\n+            PartitionedTopicMetadata partitionedTopicMetadata =\n+                    pulsar().getBrokerService().fetchPartitionedTopicMetadataAsync(topicName).get();\n+            if (partitionedTopicMetadata.partitions < 1) {\n+                if (!pulsar().getNamespaceService().checkTopicExists(topicName).get()\n+                        && checkAllowAutoCreation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDk0ODcwMA=="}, "originalCommit": {"oid": "c6196592cf4eb2d59ac6f08caac9ccf56efe2143"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2771, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}