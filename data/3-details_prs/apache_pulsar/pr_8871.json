{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0OTI1MjE4", "number": 8871, "title": "Export Prometheus metric for messageTTL", "bodyText": "Fixes #8573\nMotivation\nSome users who want to know how many messages are expired at what time? Currently, these metrics are too few, so that TTL looks like a black box, unobservable\nModifications\nadd  totalMsgExpired\u3001lastExpireTimestamp\u3001msgRateExpired for Prometheus metric\nVerifying this change\nPrometheusMetricsTest.java", "createdAt": "2020-12-09T05:56:30Z", "url": "https://github.com/apache/pulsar/pull/8871", "merged": true, "mergeCommit": {"oid": "060e35b587beaf74484ecc58fe7e0b91d4cf630e"}, "closed": true, "closedAt": "2020-12-11T18:12:12Z", "author": {"login": "315157973"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkYPrGgH2gAyNTM0OTI1MjE4OjkxNGE2Y2RmZWFhZDkzNjg0YWMwNDc0MjFlZWMxMWNkZTA2OGY4MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkuRnbgFqTU0ODkxODA3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "914a6cdfeaad93684ac047421eec11cde068f816", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/914a6cdfeaad93684ac047421eec11cde068f816", "committedDate": "2020-12-09T05:53:21Z", "message": "Export Prometheus metric for messageTTL"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3ODYyNzkz", "url": "https://github.com/apache/pulsar/pull/8871#pullrequestreview-547862793", "createdAt": "2020-12-09T05:59:12Z", "commit": {"oid": "914a6cdfeaad93684ac047421eec11cde068f816"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNTo1OToxMlrOICD3yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNTo1OToxMlrOICD3yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMTQ5OQ==", "bodyText": "Can we find a different way to trigger message expiry task?\nIt is not a good idea to call Thread.sleep.", "url": "https://github.com/apache/pulsar/pull/8871#discussion_r539031499", "createdAt": "2020-12-09T05:59:12Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java", "diffHunk": "@@ -185,6 +192,95 @@ public void testPerTopicStats() throws Exception {\n         c2.close();\n     }\n \n+    @Test\n+    public void testPerTopicExpiredStat() throws Exception {\n+        String ns = \"prop/ns-abc1\";\n+        admin.namespaces().createNamespace(ns);\n+        String topic1 = \"persistent://\" + ns + \"/testPerTopicExpiredStat1\";\n+        String topic2 = \"persistent://\" + ns + \"/testPerTopicExpiredStat2\";\n+        List<String> topicList = Arrays.asList(topic2,topic1);\n+        Producer<byte[]> p1 = pulsarClient.newProducer().topic(topic1).create();\n+        Producer<byte[]> p2 = pulsarClient.newProducer().topic(topic2).create();\n+        admin.namespaces().setNamespaceMessageTTL(ns,1);\n+        final String subName = \"test\";\n+        for (String topic : topicList) {\n+            pulsarClient.newConsumer()\n+                    .topic(topic)\n+                    .subscriptionName(subName)\n+                    .subscribe().close();\n+        }\n+\n+        final int messages = 10;\n+\n+        for (int i = 0; i < messages; i++) {\n+            String message = \"my-message-\" + i;\n+            p1.send(message.getBytes());\n+            p2.send(message.getBytes());\n+        }\n+\n+        p1.close();\n+        p2.close();\n+        // make sure message is expired\n+        Thread.sleep(2000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "914a6cdfeaad93684ac047421eec11cde068f816"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "620b887e6e7b4271b213eddc8bebff82651f61b3", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/620b887e6e7b4271b213eddc8bebff82651f61b3", "committedDate": "2020-12-09T06:36:44Z", "message": "Avoid sleep"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adc8c0eb3f046bfd78d74e516dba8ac30f250229", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/adc8c0eb3f046bfd78d74e516dba8ac30f250229", "committedDate": "2020-12-09T08:24:20Z", "message": "Merge branch 'master' into metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b25e25101a9d6705264f0e376868ff573418326", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/4b25e25101a9d6705264f0e376868ff573418326", "committedDate": "2020-12-09T10:24:23Z", "message": "Avoid sleep"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bc7638275593ccd061ce047fa3d118df0951ee5", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/3bc7638275593ccd061ce047fa3d118df0951ee5", "committedDate": "2020-12-09T10:26:54Z", "message": "restore import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec3b2a80399710488211d474bab0bc17d8eda728", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/ec3b2a80399710488211d474bab0bc17d8eda728", "committedDate": "2020-12-10T04:11:56Z", "message": "Merge branch 'master' into metric\n\n# Conflicts:\n#\tpulsar-broker/src/main/java/org/apache/pulsar/broker/stats/prometheus/TopicStats.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "912fd97a3f71ca6905f966e7a0e7d7ebdfe88b7e", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/912fd97a3f71ca6905f966e7a0e7d7ebdfe88b7e", "committedDate": "2020-12-10T04:26:24Z", "message": "code style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTE4MDcz", "url": "https://github.com/apache/pulsar/pull/8871#pullrequestreview-548918073", "createdAt": "2020-12-10T07:33:23Z", "commit": {"oid": "912fd97a3f71ca6905f966e7a0e7d7ebdfe88b7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 890, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}