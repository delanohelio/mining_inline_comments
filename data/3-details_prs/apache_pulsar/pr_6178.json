{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5Njc2Njk4", "number": 6178, "title": "Introduce maxMessagePublishBufferSizeInMB configuration to avoid broker OOM", "bodyText": "Master Issue: #5751\nMotivation\nIntroduce maxMessagePublishBufferSizeInMB configuration to avoid broker OOM.\nModifications\nIf the processing message size exceed this value, broker will stop read data from the connection. When available size > half of the maxMessagePublishBufferSizeInMB, start auto read data from the connection.\nVerifying this change\nUnit tests added\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (no)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)", "createdAt": "2020-01-31T17:01:06Z", "url": "https://github.com/apache/pulsar/pull/6178", "merged": true, "mergeCommit": {"oid": "91dfa1a9648e8f24a649d06ce96f38ef933a3c15"}, "closed": true, "closedAt": "2020-02-16T14:55:07Z", "author": {"login": "codelipenghui"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_0iTCgFqTM1MTczNTM5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcE5B5_gH2gAyMzY5Njc2Njk4OmY3NTJhNmNlNTRjYmQ1OGRmYzRjYjg3M2NjY2EzYTZmZGNkYzc4OTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNzM1Mzkw", "url": "https://github.com/apache/pulsar/pull/6178#pullrequestreview-351735390", "createdAt": "2020-01-31T19:44:41Z", "commit": {"oid": "7ce1f44ccfdca31ef473aaac5a09484d2caeeeac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxOTo0NDo0MVrOFkWBSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxOTo0NDo0MVrOFkWBSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY1MzgzNQ==", "bodyText": "This would become a contention point across all the threads in the broker", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r373653835", "createdAt": "2020-01-31T19:44:41Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -2009,4 +2025,49 @@ public ConfigField(Field field) {\n             return Optional.empty();\n         }\n     }\n+\n+    private void enableTopicsAutoRead() {\n+        topics.values().forEach(future -> {\n+            if (future.isDone() && !future.isCompletedExceptionally()) {\n+                try {\n+                    future.get().ifPresent(Topic::enableProducerRead);\n+                } catch (InterruptedException | ExecutionException e) {\n+                   // no-op\n+                }\n+            }\n+        });\n+    }\n+\n+    @VisibleForTesting\n+    boolean increasePublishBufferSizeAndCheckStopRead(int msgSize) {\n+        if (maxMessagePublishBufferSize < 0) {\n+            return false;\n+        }\n+        if (currentMessagePublishBufferSize.addAndGet(msgSize) >= maxMessagePublishBufferSize &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ce1f44ccfdca31ef473aaac5a09484d2caeeeac"}, "originalPosition": 66}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83c7cb35bfa59beec97e269afc7c22b43bc9be85", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/83c7cb35bfa59beec97e269afc7c22b43bc9be85", "committedDate": "2020-02-11T15:32:25Z", "message": "Apply comments"}, "afterCommit": {"oid": "f92ed4e4f072319e185365c285522c1b5debe0a9", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/f92ed4e4f072319e185365c285522c1b5debe0a9", "committedDate": "2020-02-11T15:34:18Z", "message": "Apply comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDU4ODI1", "url": "https://github.com/apache/pulsar/pull/6178#pullrequestreview-358058825", "createdAt": "2020-02-13T09:18:40Z", "commit": {"oid": "b4be922c38e62054ae0c4270bdc09df1df579d3e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjEyNDgy", "url": "https://github.com/apache/pulsar/pull/6178#pullrequestreview-358612482", "createdAt": "2020-02-13T22:58:30Z", "commit": {"oid": "b4be922c38e62054ae0c4270bdc09df1df579d3e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMjo1ODozMVrOFpmfTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMzowOTozM1rOFpmtXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NjU0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            messagePublishBufferCheckIntervalInMills=100\n          \n          \n            \n            messagePublishBufferCheckIntervalInMillis=100", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379166541", "createdAt": "2020-02-13T22:58:31Z", "author": {"login": "sijie"}, "path": "conf/broker.conf", "diffHunk": "@@ -324,6 +324,18 @@ replicatedSubscriptionsSnapshotTimeoutSeconds=30\n # Max number of snapshot to be cached per subscription.\n replicatedSubscriptionsSnapshotMaxCachedPerSubscription=10\n \n+# Max memory size for broker handling messages sending from producers.\n+# If the processing message size exceed this value, broker will stop read data\n+# from the connection. The processing messages means messages are sends to broker\n+# but broker have not send response to client, usually waiting to write to bookies.\n+# It's shared across all the topics running in the same broker.\n+# Use -1 to disable the memory limitation. Default is 1/5 of direct memory.\n+maxMessagePublishBufferSizeInMB=\n+\n+# Interval between checks to see if message publish buffer size is exceed the max message publish buffer size\n+# Use 0 or negative number to disable the max publish buffer limiting.\n+messagePublishBufferCheckIntervalInMills=100", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4be922c38e62054ae0c4270bdc09df1df579d3e"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NzczMQ==", "bodyText": "The default value should be a value that makes the broker behave as close to the behavior without this code change. I understand we want to enable the rate-limiting feature. So we should try to make the default value as 60% and 70% of max direct memory? Otherwise, people might experience unexpected performance issues when they upgrade a broker from an old version to a newer version.", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379167731", "createdAt": "2020-02-13T23:01:58Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -603,6 +603,23 @@\n             doc = \"Max number of snapshot to be cached per subscription.\")\n     private int replicatedSubscriptionsSnapshotMaxCachedPerSubscription = 10;\n \n+    @FieldContext(\n+        category = CATEGORY_SERVER,\n+        doc = \"Max memory size for broker handling messages sending from producers.\\n\\n\"\n+            + \" If the processing message size exceed this value, broker will stop read data\"\n+            + \" from the connection. The processing messages means messages are sends to broker\"\n+            + \" but broker have not send response to client, usually waiting to write to bookies.\\n\\n\"\n+            + \" It's shared across all the topics running in the same broker.\\n\\n\"\n+            + \" Use -1 to disable the memory limitation. Default is 1/5 of direct memory.\\n\\n\")\n+    private int maxMessagePublishBufferSizeInMB = Math.max(64,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4be922c38e62054ae0c4270bdc09df1df579d3e"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2ODM1Ng==", "bodyText": "We should create this executor only when the feature is enabled.\nAlso I see we are creating more and more schedulers. Can we consider reusing some of the executors?", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379168356", "createdAt": "2020-02-13T23:03:59Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -257,6 +268,8 @@ public BrokerService(PulsarService pulsar) throws Exception {\n                 .newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"pulsar-msg-expiry-monitor\"));\n         this.compactionMonitor =\n             Executors.newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"pulsar-compaction-monitor\"));\n+        this.messagePublishBufferMonitor =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4be922c38e62054ae0c4270bdc09df1df579d3e"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2OTI4Mg==", "bodyText": "It seems to me that this variable doesn't have to be a class variable of BrokerService. It can just be a local variable, right?", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379169282", "createdAt": "2020-02-13T23:06:53Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -2011,4 +2033,34 @@ public ConfigField(Field field) {\n             return Optional.empty();\n         }\n     }\n+\n+    private void checkMessagePublishBuffer() {\n+        currentMessagePublishBufferSize = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4be922c38e62054ae0c4270bdc09df1df579d3e"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3MDAwNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private volatile boolean isMessagePublishBufferThreshold;\n          \n          \n            \n                private volatile boolean reachMessagePublishBufferThreshold;", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379170006", "createdAt": "2020-02-13T23:09:07Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -216,8 +218,17 @@\n     private Channel listenChannel;\n     private Channel listenChannelTls;\n \n+    private final long maxMessagePublishBufferSize;\n+    private final long resumeProducerReadMessagePublishBufferSize;\n+    private volatile long currentMessagePublishBufferSize;\n+    private volatile boolean isMessagePublishBufferThreshold;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4be922c38e62054ae0c4270bdc09df1df579d3e"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3MDE0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private volatile long currentMessagePublishBufferSize;\n          \n          \n            \n                private volatile long currentMessagePublishBufferBytes;\n          \n      \n    \n    \n  \n\nI prefer using bytes rather than size to make the unit more explicit.", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379170140", "createdAt": "2020-02-13T23:09:33Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -216,8 +218,17 @@\n     private Channel listenChannel;\n     private Channel listenChannelTls;\n \n+    private final long maxMessagePublishBufferSize;\n+    private final long resumeProducerReadMessagePublishBufferSize;\n+    private volatile long currentMessagePublishBufferSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4be922c38e62054ae0c4270bdc09df1df579d3e"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68d15b5822e16d245ed8ffff7b5197795157d570", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/68d15b5822e16d245ed8ffff7b5197795157d570", "committedDate": "2020-02-16T02:34:32Z", "message": "Add maxMessagePublishBufferSizeInMB configuration to avoid broker OOM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3bbbb02cf5704c82041c2d8398506dff1d5c9ca", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/c3bbbb02cf5704c82041c2d8398506dff1d5c9ca", "committedDate": "2020-02-16T02:34:33Z", "message": "Apply comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bbc7a283a68f8e88d9ccfb273c1e87a18a21da9", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/7bbc7a283a68f8e88d9ccfb273c1e87a18a21da9", "committedDate": "2020-02-16T02:34:33Z", "message": "Clean code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "917f29b45d5392d71270ab290266df232201c09b", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/917f29b45d5392d71270ab290266df232201c09b", "committedDate": "2020-02-16T02:34:33Z", "message": "Fix unit test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4be922c38e62054ae0c4270bdc09df1df579d3e", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/b4be922c38e62054ae0c4270bdc09df1df579d3e", "committedDate": "2020-02-12T02:46:20Z", "message": "Fix unit test"}, "afterCommit": {"oid": "917f29b45d5392d71270ab290266df232201c09b", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/917f29b45d5392d71270ab290266df232201c09b", "committedDate": "2020-02-16T02:34:33Z", "message": "Fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47923d17fecde87a9017924828577be66c1e6b43", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/47923d17fecde87a9017924828577be66c1e6b43", "committedDate": "2020-02-16T02:57:07Z", "message": "Apply comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzgxMzMy", "url": "https://github.com/apache/pulsar/pull/6178#pullrequestreview-359381332", "createdAt": "2020-02-16T05:35:52Z", "commit": {"oid": "47923d17fecde87a9017924828577be66c1e6b43"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f752a6ce54cbd58dfc4cb873ccca3a6fdcdc7890", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/f752a6ce54cbd58dfc4cb873ccca3a6fdcdc7890", "committedDate": "2020-02-16T13:48:27Z", "message": "Fix unit tests."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1355, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}