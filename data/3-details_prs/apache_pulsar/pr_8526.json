{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MzExMDc4", "number": 8526, "title": "Reduce memory leaks in pulsar-broker tests", "bodyText": "Motivation\nThe tests in pulsar-broker are full of memory leaks, especially about thread spawned by non closed instances of:\n\nPulsarService\nBrokerService\nManagedLedgerFactoryImpl\nExecutors in general\n\nI am also changing a few tests in order not to close more than once the instances of such classes because it makes it very hard to look for unclosed instances (I have a local utility to count and track unclosed objects)\nThis is the second part of a series of fixes, with this change it looks like the suite is able to use at max 1GB of head and there is a huge reduction of the number of threads.\nUnfortunately there are still leaks of Bookies and ZooKeeper server instances to be fixed\nModifications\n\nfix the tests\nuse \"alwaysRun=true\" in order to ensure that resources are called (the default is \"false\" and if some test is skipped resources are not released)\n\nVerifying this change\nThis change is a trivial rework / code cleanup without any test coverage.", "createdAt": "2020-11-11T16:30:08Z", "url": "https://github.com/apache/pulsar/pull/8526", "merged": true, "mergeCommit": {"oid": "c4da921e6ccee46fdfd3e8a59cbb1374eae173dd"}, "closed": true, "closedAt": "2020-11-12T14:44:11Z", "author": {"login": "eolivelli"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda037UgH2gAyNTE5MzExMDc4OmMzYjkyOWVkYjUxYWRjNGRiZDI1YjlkYWI3ZGM1YjM2NWE5ZGZiNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbzpOvgFqTUyOTE1NDc0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c3b929edb51adc4dbd25b9dab7dc5b365a9dfb48", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/c3b929edb51adc4dbd25b9dab7dc5b365a9dfb48", "committedDate": "2020-11-09T13:35:25Z", "message": "Transaction - fix TransactionBuffer thread leak in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d9660e769b61801654cdf86617ef4fb6ea6feef", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/3d9660e769b61801654cdf86617ef4fb6ea6feef", "committedDate": "2020-11-09T14:57:54Z", "message": "Close TransactionMetaStoreTestBase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e8b662f4e5da67d345f0af7dc4e0b9ccc133090", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/5e8b662f4e5da67d345f0af7dc4e0b9ccc133090", "committedDate": "2020-11-10T17:12:10Z", "message": "Close more resources and add debug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fb2677f422c0bf6edf9c12210b19c3e9f72e5ce", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/9fb2677f422c0bf6edf9c12210b19c3e9f72e5ce", "committedDate": "2020-11-11T14:09:10Z", "message": "alwaysRun"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ae63d2b7488125bc2801012901ff9edf2bfbc3f", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/7ae63d2b7488125bc2801012901ff9edf2bfbc3f", "committedDate": "2020-11-11T16:22:23Z", "message": "more fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "286007b892adcd73f840536cdb302dae19d3eb06", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/286007b892adcd73f840536cdb302dae19d3eb06", "committedDate": "2020-11-11T16:24:11Z", "message": "Merge remote-tracking branch 'origin/master' into fix/close-more-resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5642f66ed1dc5de464a8c4dc26dba806ebf3c113", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/5642f66ed1dc5de464a8c4dc26dba806ebf3c113", "committedDate": "2020-11-11T16:26:34Z", "message": "revert debug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aad724c313ac1b485b6f56030881aa17f4b649eb", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/aad724c313ac1b485b6f56030881aa17f4b649eb", "committedDate": "2020-11-11T16:33:07Z", "message": "remove file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd203c7816ec3e6fec4c930d64ac47903412e635", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/cd203c7816ec3e6fec4c930d64ac47903412e635", "committedDate": "2020-11-11T16:34:59Z", "message": "remove debug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee2ae70d76c99192f6fd894bea3a81785031ed81", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/ee2ae70d76c99192f6fd894bea3a81785031ed81", "committedDate": "2020-11-11T16:49:46Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NDMwMjgx", "url": "https://github.com/apache/pulsar/pull/8526#pullrequestreview-528430281", "createdAt": "2020-11-11T18:27:41Z", "commit": {"oid": "ee2ae70d76c99192f6fd894bea3a81785031ed81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxODoyNzo0MVrOHxZQ9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxODoyNzo0MVrOHxZQ9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU1NjIxMg==", "bodyText": "is there any reason to remove timeout here?", "url": "https://github.com/apache/pulsar/pull/8526#discussion_r521556212", "createdAt": "2020-11-11T18:27:41Z", "author": {"login": "rdhabalia"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiOffloadTest.java", "diffHunk": "@@ -178,7 +178,7 @@ public void testOffloadPolicies() throws Exception {\n         assertNull(offload3);\n     }\n \n-    @Test(timeOut = 20000)\n+    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee2ae70d76c99192f6fd894bea3a81785031ed81"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NDMwMzk5", "url": "https://github.com/apache/pulsar/pull/8526#pullrequestreview-528430399", "createdAt": "2020-11-11T18:27:51Z", "commit": {"oid": "ee2ae70d76c99192f6fd894bea3a81785031ed81"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NjQ2MDY5", "url": "https://github.com/apache/pulsar/pull/8526#pullrequestreview-528646069", "createdAt": "2020-11-12T00:15:17Z", "commit": {"oid": "ee2ae70d76c99192f6fd894bea3a81785031ed81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NjUyMTcw", "url": "https://github.com/apache/pulsar/pull/8526#pullrequestreview-528652170", "createdAt": "2020-11-12T00:32:58Z", "commit": {"oid": "ee2ae70d76c99192f6fd894bea3a81785031ed81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4Njc0NDEy", "url": "https://github.com/apache/pulsar/pull/8526#pullrequestreview-528674412", "createdAt": "2020-11-12T01:40:54Z", "commit": {"oid": "ee2ae70d76c99192f6fd894bea3a81785031ed81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9c47600827b1c7e5d68dee100c382578283c625", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/e9c47600827b1c7e5d68dee100c382578283c625", "committedDate": "2020-11-12T07:18:39Z", "message": "Merge remote-tracking branch 'origin/master' into fix/close-more-resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10f239a4742f42f9f1faaf592b0527cdede0046c", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/10f239a4742f42f9f1faaf592b0527cdede0046c", "committedDate": "2020-11-12T08:31:34Z", "message": "fix test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43c82b9d407ecabdbfc552923a5c507e22e12be6", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/apache/pulsar/commit/43c82b9d407ecabdbfc552923a5c507e22e12be6", "committedDate": "2020-11-12T11:35:08Z", "message": "fix test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTU0NzQx", "url": "https://github.com/apache/pulsar/pull/8526#pullrequestreview-529154741", "createdAt": "2020-11-12T14:43:23Z", "commit": {"oid": "43c82b9d407ecabdbfc552923a5c507e22e12be6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1040, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}