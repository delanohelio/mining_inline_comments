{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MjExOTkz", "number": 6345, "title": "[Java Reader Client] Start reader inside batch result in read first message in batch.", "bodyText": "Fixes #6344\nFixes #6350\nThe bug was brought in #5622 by changing the skip logic wrongly.", "createdAt": "2020-02-17T16:00:35Z", "url": "https://github.com/apache/pulsar/pull/6345", "merged": true, "mergeCommit": {"oid": "63ccd43e1a3294d696a4af37c76261eed1bb3124"}, "closed": true, "closedAt": "2020-02-24T04:27:09Z", "author": {"login": "yjshen"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFPcRzAH2gAyMzc2MjExOTkzOjg2YjUxM2NmMTM3MDcyZGI1NGM2ZTczYTc0NmI1ZWY2MGM0NWY4ZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO00r9AFqTM3NjczOTE3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "86b513cf137072db54c6e73a746b5ef60c45f8e5", "author": {"user": {"login": "yjshen", "name": "Yijie Shen"}}, "url": "https://github.com/apache/pulsar/commit/86b513cf137072db54c6e73a746b5ef60c45f8e5", "committedDate": "2020-02-17T15:55:10Z", "message": "test case to reproduce the bug first"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a17c1cd8faedd2ef884d6b61c107d1245efc6210", "author": {"user": {"login": "yjshen", "name": "Yijie Shen"}}, "url": "https://github.com/apache/pulsar/commit/a17c1cd8faedd2ef884d6b61c107d1245efc6210", "committedDate": "2020-02-18T04:12:32Z", "message": "fix consumer impl skip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60af2b326663a82abfa7ec70973a568d08bd2b73", "author": {"user": {"login": "yjshen", "name": "Yijie Shen"}}, "url": "https://github.com/apache/pulsar/commit/60af2b326663a82abfa7ec70973a568d08bd2b73", "committedDate": "2020-02-18T06:54:06Z", "message": "fix consumer test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMTI2MjM5", "url": "https://github.com/apache/pulsar/pull/6345#pullrequestreview-360126239", "createdAt": "2020-02-18T07:52:33Z", "commit": {"oid": "60af2b326663a82abfa7ec70973a568d08bd2b73"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwNzo1MjozNFrOFq4L-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwNzo1MjozNFrOFq4L-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUwNTA4MA==", "bodyText": "Due to this method does not only support for non-durable subscription, so is it better to named isSameEntry()?", "url": "https://github.com/apache/pulsar/pull/6345#discussion_r380505080", "createdAt": "2020-02-18T07:52:34Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerImpl.java", "diffHunk": "@@ -1091,8 +1091,8 @@ private boolean isPriorBatchIndex(long idx) {\n         return resetIncludeHead ? idx < startMessageId.getBatchIndex() : idx <= startMessageId.getBatchIndex();\n     }\n \n-    private boolean isResetIncludedAndSameEntryLedger(MessageIdData messageId) {\n-        return !resetIncludeHead && startMessageId != null\n+    private boolean isNonDurableAndSameEntryAndLedger(MessageIdData messageId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60af2b326663a82abfa7ec70973a568d08bd2b73"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2ab1b4ca66cffdd9516e7dde90a07c96ca90ba1", "author": {"user": {"login": "yjshen", "name": "Yijie Shen"}}, "url": "https://github.com/apache/pulsar/commit/c2ab1b4ca66cffdd9516e7dde90a07c96ca90ba1", "committedDate": "2020-02-18T07:57:34Z", "message": "rename method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91f75d86246d80591cc14bd5fdf273ad58bc2724", "author": {"user": {"login": "yjshen", "name": "Yijie Shen"}}, "url": "https://github.com/apache/pulsar/commit/91f75d86246d80591cc14bd5fdf273ad58bc2724", "committedDate": "2020-02-20T12:16:33Z", "message": "fix seek logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c2d6b836919b97b3483aa0714afd350abcf2cc3", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/9c2d6b836919b97b3483aa0714afd350abcf2cc3", "committedDate": "2020-02-21T01:18:26Z", "message": "Merge remote-tracking branch 'apache/master' into reader_seek_inside_batch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "669f78763f6cc02e62d22b4269efb63ff5b488a5", "author": {"user": {"login": "yjshen", "name": "Yijie Shen"}}, "url": "https://github.com/apache/pulsar/commit/669f78763f6cc02e62d22b4269efb63ff5b488a5", "committedDate": "2020-02-21T04:19:28Z", "message": "Merge remote-tracking branch 'apache/master' into reader_seek_inside_batch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDE5NDQz", "url": "https://github.com/apache/pulsar/pull/6345#pullrequestreview-363019443", "createdAt": "2020-02-22T09:15:07Z", "commit": {"oid": "91f75d86246d80591cc14bd5fdf273ad58bc2724"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwOToxNTowN1rOFtKUAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwOToxNTowN1rOFtKUAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5OTIwMg==", "bodyText": "Is it possible only add seekMessageId to achieve the seek logic?", "url": "https://github.com/apache/pulsar/pull/6345#discussion_r382899202", "createdAt": "2020-02-22T09:15:07Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerImpl.java", "diffHunk": "@@ -122,6 +123,9 @@\n     private final SubscriptionMode subscriptionMode;\n     private volatile BatchMessageIdImpl startMessageId;\n \n+    private volatile BatchMessageIdImpl seekMessageId;\n+    private final AtomicBoolean duringSeek;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91f75d86246d80591cc14bd5fdf273ad58bc2724"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9320b6e892f3d5d864129b098b306def13080005", "author": {"user": {"login": "yjshen", "name": "Yijie Shen"}}, "url": "https://github.com/apache/pulsar/commit/9320b6e892f3d5d864129b098b306def13080005", "committedDate": "2020-02-22T13:16:45Z", "message": "Merge remote-tracking branch 'apache/master' into reader_seek_inside_batch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTY1NDA3", "url": "https://github.com/apache/pulsar/pull/6345#pullrequestreview-363165407", "createdAt": "2020-02-24T04:26:54Z", "commit": {"oid": "9320b6e892f3d5d864129b098b306def13080005"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NzM5MTcw", "url": "https://github.com/apache/pulsar/pull/6345#pullrequestreview-376739170", "createdAt": "2020-03-18T10:33:37Z", "commit": {"oid": "9320b6e892f3d5d864129b098b306def13080005"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDozMzozN1rOF3-9tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDozMzozN1rOF3-9tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI0NzYwNg==", "bodyText": "Hi! Looks like this commit is a breaking change, it broke my integration test for Reader. The logic of unit test is as follows\n\nRead 10 messages\nSeek back to the first\nRead 10 messages again\nEarlier hasMessageAvailableAsync returned true on this line because lastDequeuedMessage was reset, but now it returns false which leads to getLastMessageIdAsync execution. And because seek drops connection, getLastMessageIdAsync fails for me with server error \"Error: MetadataError. Message: Consumer not found\", sot the test fails", "url": "https://github.com/apache/pulsar/pull/6345#discussion_r394247606", "createdAt": "2020-03-18T10:33:37Z", "author": {"login": "Lanayx"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerImpl.java", "diffHunk": "@@ -1520,7 +1536,10 @@ public void seek(long timestamp) throws PulsarClientException {\n         cnx.sendRequestWithId(seek, requestId).thenRun(() -> {\n             log.info(\"[{}][{}] Successfully reset subscription to message id {}\", topic, subscription, messageId);\n             acknowledgmentsGroupingTracker.flushAndClean();\n-            lastDequeuedMessage = messageId;\n+\n+            seekMessageId = new BatchMessageIdImpl((MessageIdImpl) messageId);\n+            duringSeek.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9320b6e892f3d5d864129b098b306def13080005"}, "originalPosition": 89}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 63, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}