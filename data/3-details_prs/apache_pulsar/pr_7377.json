{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwOTQ0NDc5", "number": 7377, "title": "Functions metadata compaction", "bodyText": "(If this PR fixes a github issue, please add Fixes #<xyz>.)\nFixes #\n(or if this PR is one task of a github issue, please add Master Issue: #<xyz> to link to the master issue.)\nMaster Issue: #\nMotivation\nCurrently we do not compact FunctionMetadata topic. This pr adds the ability to do that\nModifications\nDescribe the modifications you've done.\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\n(Please pick either of the following options)\nThis change is a trivial rework / code cleanup without any test coverage.\n(or)\nThis change is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end deployment with large payloads (10MB)\nExtended integration test for recovery after broker failure\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API: (yes / no)\nThe schema: (yes / no / don't know)\nThe default values of configurations: (yes / no)\nThe wire protocol: (yes / no)\nThe rest endpoints: (yes / no)\nThe admin cli options: (yes / no)\nAnything that affects deployment: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)\nIf a feature is not applicable for documentation, explain why?\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-06-27T18:15:12Z", "url": "https://github.com/apache/pulsar/pull/7377", "merged": true, "mergeCommit": {"oid": "3d94553fe7f1f6ed17d3e115e1d08a02585c7a77"}, "closed": true, "closedAt": "2020-07-01T04:27:26Z", "author": {"login": "srkukarni"}, "timelineItems": {"totalCount": 45, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqEBjUgH2gAyNDQwOTQ0NDc5OmJmMTFmMGNhNjUzMmVlM2ExNzZiZGUyN2I5NDRiOGI0YmM3YTZmZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcweqjsgFqTQ0MDQ2MjE1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bf11f0ca6532ee3a176bde27b944b8b4bc7a6ff3", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/bf11f0ca6532ee3a176bde27b944b8b4bc7a6ff3", "committedDate": "2020-06-11T01:32:13Z", "message": "Function workers re-direct call update requests to the leader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "691d0548ee9552ddef23298a3ce5d00bda022037", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/691d0548ee9552ddef23298a3ce5d00bda022037", "committedDate": "2020-06-11T01:45:22Z", "message": "Fixed test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfb203d011dcded6248c8d33e414d519fa955b1a", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/cfb203d011dcded6248c8d33e414d519fa955b1a", "committedDate": "2020-06-11T05:18:25Z", "message": "tests pass"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8145443b49957898144cd9ec1f2b76b0b1f6f09", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/f8145443b49957898144cd9ec1f2b76b0b1f6f09", "committedDate": "2020-06-11T07:44:32Z", "message": "Working version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0a7f284351f58810e8c962221413bcf6578db02", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/b0a7f284351f58810e8c962221413bcf6578db02", "committedDate": "2020-06-11T15:42:44Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e612318f8ad1b0b7356d1fb885b4723eca7c6afd", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/e612318f8ad1b0b7356d1fb885b4723eca7c6afd", "committedDate": "2020-06-11T15:43:08Z", "message": "Merge remote-tracking branch 'apache/master' into functions_leader_executor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea53753ec173eff15fd4223f634bc31e658fad74", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/ea53753ec173eff15fd4223f634bc31e658fad74", "committedDate": "2020-06-12T02:36:27Z", "message": "Merge branch 'master' into functions_leader_executor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c02274ab17fed9c3d85a98c1ff4a90201bfb3a88", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/c02274ab17fed9c3d85a98c1ff4a90201bfb3a88", "committedDate": "2020-06-12T18:57:03Z", "message": "Short circuit update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93c54e1b4083107010a90fc162a1a7039c2e64b8", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/93c54e1b4083107010a90fc162a1a7039c2e64b8", "committedDate": "2020-06-12T19:15:07Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd8766e46f22329c831b9141a05d1a90b8e3146e", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/fd8766e46f22329c831b9141a05d1a90b8e3146e", "committedDate": "2020-06-12T19:35:03Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5b17528eea66df0d94fad47616f901f53a42473", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/b5b17528eea66df0d94fad47616f901f53a42473", "committedDate": "2020-06-12T23:03:34Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3403c7ae8129f12a3f0e982e3372ad5d4ad5d7a", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/d3403c7ae8129f12a3f0e982e3372ad5d4ad5d7a", "committedDate": "2020-06-12T23:05:19Z", "message": "Added one more catch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc3646ebaae59d683462b240478fae3319aeac7a", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/cc3646ebaae59d683462b240478fae3319aeac7a", "committedDate": "2020-06-12T23:05:42Z", "message": "Added one more catch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b8d6d251bbeac1ad565aaebd0b4629794258c82", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/6b8d6d251bbeac1ad565aaebd0b4629794258c82", "committedDate": "2020-06-12T23:06:35Z", "message": "Seperated internal and external errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeb51ca4c44bb0cdf83904dcb8b2bbe9446a0da4", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/aeb51ca4c44bb0cdf83904dcb8b2bbe9446a0da4", "committedDate": "2020-06-13T00:04:06Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "527aea2affed67ca9bda71831c9fa615be9529c5", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/527aea2affed67ca9bda71831c9fa615be9529c5", "committedDate": "2020-06-18T16:24:20Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc4cd2ceb555366c4ce54ffd32979be4c6c99a6", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/dcc4cd2ceb555366c4ce54ffd32979be4c6c99a6", "committedDate": "2020-06-18T17:00:37Z", "message": "Do not expose updateOnLeader to functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8f2d345af3630f651ab5ac0c39c229df8d6d5c5", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/f8f2d345af3630f651ab5ac0c39c229df8d6d5c5", "committedDate": "2020-06-18T17:15:37Z", "message": "hide api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "476b692bdc9b7a2aece1e4ccad597dca30391b27", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/476b692bdc9b7a2aece1e4ccad597dca30391b27", "committedDate": "2020-06-18T17:15:55Z", "message": "hide api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad7309946d060252bf19aabc589f152bb93d1423", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/ad7309946d060252bf19aabc589f152bb93d1423", "committedDate": "2020-06-20T22:25:04Z", "message": "Merge branch 'master' into functions_leader_executor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acd999f81b21f73e78ec951df9a81e93c541666e", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/acd999f81b21f73e78ec951df9a81e93c541666e", "committedDate": "2020-06-20T22:31:49Z", "message": "removed duplicate comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a256bc987bca5a8cc61c2b95b0103b3c159d4399", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/a256bc987bca5a8cc61c2b95b0103b3c159d4399", "committedDate": "2020-06-20T22:49:27Z", "message": "Do leadership changes in function metadata manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fc89c35e9752682a70540510447764639ed5fbe", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/8fc89c35e9752682a70540510447764639ed5fbe", "committedDate": "2020-06-21T00:00:17Z", "message": "make the function sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f21176c62a23df0df7b327778b4ce81d3ea8dbe", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/6f21176c62a23df0df7b327778b4ce81d3ea8dbe", "committedDate": "2020-06-23T15:56:51Z", "message": "Added more comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f381eeeca5da48123d2d034de374919a0734cbd4", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/f381eeeca5da48123d2d034de374919a0734cbd4", "committedDate": "2020-06-23T17:31:44Z", "message": "Merge branch 'master' into functions_leader_executor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43eaf86d1a503ee7aa7eead8772b878dc4652379", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/43eaf86d1a503ee7aa7eead8772b878dc4652379", "committedDate": "2020-06-23T20:46:07Z", "message": "Throw error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c28e1224402c8a51a2eca0e93602b0f753ff2b03", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/c28e1224402c8a51a2eca0e93602b0f753ff2b03", "committedDate": "2020-06-23T20:47:29Z", "message": "Changed name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb86d0a49fa92eff08726a399db825e4783fc3b9", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/fb86d0a49fa92eff08726a399db825e4783fc3b9", "committedDate": "2020-06-23T22:58:06Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a61e6748bda039235b1d95b34367468d7a4135aa", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/a61e6748bda039235b1d95b34367468d7a4135aa", "committedDate": "2020-06-24T05:49:11Z", "message": "Deleted unused classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7196264acd6f6e6995726b9a0a4aa11abe26678", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/d7196264acd6f6e6995726b9a0a4aa11abe26678", "committedDate": "2020-06-24T18:33:23Z", "message": "Rework metadata manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b824e9e881c90902787290475416a6b9076f54b", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/3b824e9e881c90902787290475416a6b9076f54b", "committedDate": "2020-06-24T21:24:53Z", "message": "Working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5328d14af689f3763344f5c7642ec1957cbc6ea", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/c5328d14af689f3763344f5c7642ec1957cbc6ea", "committedDate": "2020-06-24T22:07:06Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abed1f756f6abb92b718a1ce7aea733d14413272", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/abed1f756f6abb92b718a1ce7aea733d14413272", "committedDate": "2020-06-24T22:50:04Z", "message": "A better way for test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bb5bc0222903b30aeeb7c01afadf6a390925bab", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/7bb5bc0222903b30aeeb7c01afadf6a390925bab", "committedDate": "2020-06-25T17:45:06Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25f0c6711b5113a4f3cced59d29e53685f1e00ad", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/25f0c6711b5113a4f3cced59d29e53685f1e00ad", "committedDate": "2020-06-25T21:55:06Z", "message": "Merge branch 'master' into functions_metadata_compaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62ea7503e1b9e83def184a2ed178df1967631d76", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/62ea7503e1b9e83def184a2ed178df1967631d76", "committedDate": "2020-06-26T14:49:46Z", "message": "Merge branch 'master' into functions_metadata_compaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "198aca273e4c12011ca3b9d749692789361c7aed", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/198aca273e4c12011ca3b9d749692789361c7aed", "committedDate": "2020-06-27T18:13:29Z", "message": "Added an option to compact function metadata topic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5Mzg1MDAw", "url": "https://github.com/apache/pulsar/pull/7377#pullrequestreview-439385000", "createdAt": "2020-06-29T18:10:48Z", "commit": {"oid": "198aca273e4c12011ca3b9d749692789361c7aed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODoxMDo0OVrOGqcbJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODoxMDo0OVrOGqcbJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1OTA3OA==", "bodyText": "Or should we just check if the message has a data or not?", "url": "https://github.com/apache/pulsar/pull/7377#discussion_r447159078", "createdAt": "2020-06-29T18:10:49Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/FunctionMetaDataManager.java", "diffHunk": "@@ -290,26 +307,48 @@ public synchronized void giveupLeadership() {\n      */\n     public void processMetaDataTopicMessage(Message<byte[]> message) throws IOException {\n         try {\n-            Request.ServiceRequest serviceRequest = Request.ServiceRequest.parseFrom(message.getData());\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Received Service Request: {}\", serviceRequest);\n-            }\n-            switch (serviceRequest.getServiceRequestType()) {\n-                case UPDATE:\n-                    this.processUpdate(serviceRequest.getFunctionMetaData());\n-                    break;\n-                case DELETE:\n-                    this.proccessDeregister(serviceRequest.getFunctionMetaData());\n-                    break;\n-                default:\n-                    log.warn(\"Received request with unrecognized type: {}\", serviceRequest);\n+            if (workerConfig.getCompactMetadataTopic()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "198aca273e4c12011ca3b9d749692789361c7aed"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTk2OTMy", "url": "https://github.com/apache/pulsar/pull/7377#pullrequestreview-439596932", "createdAt": "2020-06-30T00:55:13Z", "commit": {"oid": "198aca273e4c12011ca3b9d749692789361c7aed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo1NToxM1rOGqntfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo1NToxM1rOGqntfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0Mzk5OQ==", "bodyText": "Given the current approach, this is a dangerous flag. If a user mistakenly flips the flag on.  It could render their cluster corrupt. We should perhaps add more warnings for what this config with do.  Instead of \"compactMetadataTopic\" maybe we can rename it to \"useCompactedMetadataTopic\"?  So that what it does is more clear.", "url": "https://github.com/apache/pulsar/pull/7377#discussion_r447343999", "createdAt": "2020-06-30T00:55:13Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/worker/WorkerConfig.java", "diffHunk": "@@ -168,6 +168,11 @@\n         doc = \"The pulsar topic used for storing function metadata\"\n     )\n     private String functionMetadataTopicName;\n+    @FieldContext(\n+            category = CATEGORY_FUNC_METADATA_MNG,\n+            doc = \"Should the metadata topic be compacted?\"\n+    )\n+    private Boolean compactMetadataTopic = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "198aca273e4c12011ca3b9d749692789361c7aed"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTk4Mjkz", "url": "https://github.com/apache/pulsar/pull/7377#pullrequestreview-439598293", "createdAt": "2020-06-30T00:59:48Z", "commit": {"oid": "198aca273e4c12011ca3b9d749692789361c7aed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo1OTo0OFrOGqnysA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMDo1OTo0OFrOGqnysA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0NTMyOA==", "bodyText": "lets use a\nprivate const final String\n\nvariable for \"version\"", "url": "https://github.com/apache/pulsar/pull/7377#discussion_r447345328", "createdAt": "2020-06-30T00:59:48Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/FunctionMetaDataManager.java", "diffHunk": "@@ -206,14 +208,29 @@ public synchronized void updateFunctionOnLeader(FunctionMetaData functionMetaDat\n         } else {\n             needsScheduling = processUpdate(functionMetaData);\n         }\n-        Request.ServiceRequest serviceRequest = Request.ServiceRequest.newBuilder()\n-                .setServiceRequestType(delete ? Request.ServiceRequest.ServiceRequestType.DELETE : Request.ServiceRequest.ServiceRequestType.UPDATE)\n-                .setFunctionMetaData(functionMetaData)\n-                .setWorkerId(workerConfig.getWorkerId())\n-                .setRequestId(UUID.randomUUID().toString())\n-                .build();\n+        String key = FunctionCommon.getFullyQualifiedName(functionMetaData.getFunctionDetails());\n+        byte[] toWrite;\n+        if (workerConfig.getCompactMetadataTopic()) {\n+            if (delete) {\n+                toWrite = \"\".getBytes();\n+            } else {\n+                toWrite = functionMetaData.toByteArray();\n+            }\n+        } else {\n+            Request.ServiceRequest serviceRequest = Request.ServiceRequest.newBuilder()\n+                    .setServiceRequestType(delete ? Request.ServiceRequest.ServiceRequestType.DELETE : Request.ServiceRequest.ServiceRequestType.UPDATE)\n+                    .setFunctionMetaData(functionMetaData)\n+                    .setWorkerId(workerConfig.getWorkerId())\n+                    .setRequestId(UUID.randomUUID().toString())\n+                    .build();\n+            toWrite = serviceRequest.toByteArray();\n+        }\n         try {\n-            lastMessageSeen = exclusiveLeaderProducer.send(serviceRequest.toByteArray());\n+            lastMessageSeen = exclusiveLeaderProducer.newMessage()\n+                    .key(key)\n+                    .value(toWrite)\n+                    .property(\"version\", Long.toString(functionMetaData.getVersion()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "198aca273e4c12011ca3b9d749692789361c7aed"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a84866db5e7669dfe97432b8145ce45cf4b5e742", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/a84866db5e7669dfe97432b8145ce45cf4b5e742", "committedDate": "2020-06-30T04:25:28Z", "message": "Address feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMjIwNjg1", "url": "https://github.com/apache/pulsar/pull/7377#pullrequestreview-440220685", "createdAt": "2020-06-30T17:07:37Z", "commit": {"oid": "a84866db5e7669dfe97432b8145ce45cf4b5e742"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzowNzozN1rOGrGRhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzowNzozN1rOGrGRhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NDc0MA==", "bodyText": "This will add a key for both the old format and new format right? Not sure we should add a key for the old format.  Perhaps, whether checking whether the message has a key or not can be used to determine whether its the old format or new format.", "url": "https://github.com/apache/pulsar/pull/7377#discussion_r447844740", "createdAt": "2020-06-30T17:07:37Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/FunctionMetaDataManager.java", "diffHunk": "@@ -206,14 +210,29 @@ public synchronized void updateFunctionOnLeader(FunctionMetaData functionMetaDat\n         } else {\n             needsScheduling = processUpdate(functionMetaData);\n         }\n-        Request.ServiceRequest serviceRequest = Request.ServiceRequest.newBuilder()\n-                .setServiceRequestType(delete ? Request.ServiceRequest.ServiceRequestType.DELETE : Request.ServiceRequest.ServiceRequestType.UPDATE)\n-                .setFunctionMetaData(functionMetaData)\n-                .setWorkerId(workerConfig.getWorkerId())\n-                .setRequestId(UUID.randomUUID().toString())\n-                .build();\n+        String key = FunctionCommon.getFullyQualifiedName(functionMetaData.getFunctionDetails());\n+        byte[] toWrite;\n+        if (workerConfig.getUseCompactedMetadataTopic()) {\n+            if (delete) {\n+                toWrite = \"\".getBytes();\n+            } else {\n+                toWrite = functionMetaData.toByteArray();\n+            }\n+        } else {\n+            Request.ServiceRequest serviceRequest = Request.ServiceRequest.newBuilder()\n+                    .setServiceRequestType(delete ? Request.ServiceRequest.ServiceRequestType.DELETE : Request.ServiceRequest.ServiceRequestType.UPDATE)\n+                    .setFunctionMetaData(functionMetaData)\n+                    .setWorkerId(workerConfig.getWorkerId())\n+                    .setRequestId(UUID.randomUUID().toString())\n+                    .build();\n+            toWrite = serviceRequest.toByteArray();\n+        }\n         try {\n-            lastMessageSeen = exclusiveLeaderProducer.send(serviceRequest.toByteArray());\n+            lastMessageSeen = exclusiveLeaderProducer.newMessage()\n+                    .key(key)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a84866db5e7669dfe97432b8145ce45cf4b5e742"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be0936f17df99a92c3b33964a094700e2d3553ea", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/be0936f17df99a92c3b33964a094700e2d3553ea", "committedDate": "2020-06-30T19:17:44Z", "message": "Incorporate feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDMzNTc4", "url": "https://github.com/apache/pulsar/pull/7377#pullrequestreview-440433578", "createdAt": "2020-06-30T22:38:37Z", "commit": {"oid": "be0936f17df99a92c3b33964a094700e2d3553ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMjozODozN1rOGrQ2nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMjozODozN1rOGrQ2nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxODA3OQ==", "bodyText": "Should we change this check to if a key exists or not?  This creates an avenue in which a existing cluster can transition to use a compacted metadata topic", "url": "https://github.com/apache/pulsar/pull/7377#discussion_r448018079", "createdAt": "2020-06-30T22:38:37Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/worker/src/main/java/org/apache/pulsar/functions/worker/FunctionMetaDataManager.java", "diffHunk": "@@ -290,26 +310,48 @@ public synchronized void giveupLeadership() {\n      */\n     public void processMetaDataTopicMessage(Message<byte[]> message) throws IOException {\n         try {\n-            Request.ServiceRequest serviceRequest = Request.ServiceRequest.parseFrom(message.getData());\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Received Service Request: {}\", serviceRequest);\n-            }\n-            switch (serviceRequest.getServiceRequestType()) {\n-                case UPDATE:\n-                    this.processUpdate(serviceRequest.getFunctionMetaData());\n-                    break;\n-                case DELETE:\n-                    this.proccessDeregister(serviceRequest.getFunctionMetaData());\n-                    break;\n-                default:\n-                    log.warn(\"Received request with unrecognized type: {}\", serviceRequest);\n+            if (workerConfig.getUseCompactedMetadataTopic()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be0936f17df99a92c3b33964a094700e2d3553ea"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDYyMTU0", "url": "https://github.com/apache/pulsar/pull/7377#pullrequestreview-440462154", "createdAt": "2020-06-30T23:58:05Z", "commit": {"oid": "be0936f17df99a92c3b33964a094700e2d3553ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 759, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}