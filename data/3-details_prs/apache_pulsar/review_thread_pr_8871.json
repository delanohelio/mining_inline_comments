{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0OTI1MjE4", "number": 8871, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNTo1OToxMlrOFCv00g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNTo1OToxMlrOFCv00g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4NDI1MDQyOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNTo1OToxMlrOICD3yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNTo1OToxMlrOICD3yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAzMTQ5OQ==", "bodyText": "Can we find a different way to trigger message expiry task?\nIt is not a good idea to call Thread.sleep.", "url": "https://github.com/apache/pulsar/pull/8871#discussion_r539031499", "createdAt": "2020-12-09T05:59:12Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/stats/PrometheusMetricsTest.java", "diffHunk": "@@ -185,6 +192,95 @@ public void testPerTopicStats() throws Exception {\n         c2.close();\n     }\n \n+    @Test\n+    public void testPerTopicExpiredStat() throws Exception {\n+        String ns = \"prop/ns-abc1\";\n+        admin.namespaces().createNamespace(ns);\n+        String topic1 = \"persistent://\" + ns + \"/testPerTopicExpiredStat1\";\n+        String topic2 = \"persistent://\" + ns + \"/testPerTopicExpiredStat2\";\n+        List<String> topicList = Arrays.asList(topic2,topic1);\n+        Producer<byte[]> p1 = pulsarClient.newProducer().topic(topic1).create();\n+        Producer<byte[]> p2 = pulsarClient.newProducer().topic(topic2).create();\n+        admin.namespaces().setNamespaceMessageTTL(ns,1);\n+        final String subName = \"test\";\n+        for (String topic : topicList) {\n+            pulsarClient.newConsumer()\n+                    .topic(topic)\n+                    .subscriptionName(subName)\n+                    .subscribe().close();\n+        }\n+\n+        final int messages = 10;\n+\n+        for (int i = 0; i < messages; i++) {\n+            String message = \"my-message-\" + i;\n+            p1.send(message.getBytes());\n+            p2.send(message.getBytes());\n+        }\n+\n+        p1.close();\n+        p2.close();\n+        // make sure message is expired\n+        Thread.sleep(2000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "914a6cdfeaad93684ac047421eec11cde068f816"}, "originalPosition": 54}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2664, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}