{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NTUzMTA2", "number": 7143, "title": "Add broker interceptor for Intercepting all Pulsar command and REST API requests", "bodyText": "Motivation\nBroker Interceptors\nModifications\nDescribe the modifications you've done.\nVerifying this change\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (no)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)\nIf a feature is not applicable for documentation, explain why?\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-06-02T12:30:19Z", "url": "https://github.com/apache/pulsar/pull/7143", "merged": true, "mergeCommit": {"oid": "dbc064928fed1b41c4d7cb4c785395271210cefe"}, "closed": true, "closedAt": "2020-06-09T05:16:38Z", "author": {"login": "codelipenghui"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnrJikAH2gAyNDI2NTUzMTA2OmM4M2RkNDZkYWNjMjNmNTE0NzUyNzZlNTU3NTk4Y2E2ZWM4ZGMwYjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpY2J5gH2gAyNDI2NTUzMTA2OjVkMDE3N2JkZmUyODJhMTgwZTU5ZGU4NDYyZWEzY2U1MDhhNGYxZTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c83dd46dacc23f51475276e557598ca6ec8dc0b3", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/c83dd46dacc23f51475276e557598ca6ec8dc0b3", "committedDate": "2020-06-03T15:25:28Z", "message": "Add interceptor definition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0f7bf19c361408bf1f4a7884a324949b06866c7", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/d0f7bf19c361408bf1f4a7884a324949b06866c7", "committedDate": "2020-06-03T15:25:28Z", "message": "Merge branch 'server_interceptors' of /Users/lipenghui/Github/incubator-pulsar with conflicts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0513eb4681d257b7d9fc2d94fa60ceeebcc66fa", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/f0513eb4681d257b7d9fc2d94fa60ceeebcc66fa", "committedDate": "2020-06-03T15:25:28Z", "message": "Add broker event listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdc292df44533bb2bdd3b537bff0b97badce6fad", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/cdc292df44533bb2bdd3b537bff0b97badce6fad", "committedDate": "2020-06-03T15:25:28Z", "message": "Fix merge issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35d3ebd0d2d142a359cf600e94ace34eb14a38a2", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/35d3ebd0d2d142a359cf600e94ace34eb14a38a2", "committedDate": "2020-06-03T15:25:28Z", "message": "Revert un-related changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc88318a1e0ce1c1c98d73f62f5f5a71738f6d48", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/cc88318a1e0ce1c1c98d73f62f5f5a71738f6d48", "committedDate": "2020-06-03T15:25:28Z", "message": "Revert un-related changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45c201dd72936b89fb6acac7a3b70242bcceb98a", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/45c201dd72936b89fb6acac7a3b70242bcceb98a", "committedDate": "2020-06-03T15:25:28Z", "message": "Fix nar extract directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f72bef46b0cef747fb85b70199f6a49a4d8a093", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/3f72bef46b0cef747fb85b70199f6a49a4d8a093", "committedDate": "2020-06-03T15:25:28Z", "message": "Listen all commands."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdea8b8627f6fe1538d8c7ae8ba9fc55398ac8f6", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/bdea8b8627f6fe1538d8c7ae8ba9fc55398ac8f6", "committedDate": "2020-06-03T15:25:28Z", "message": "Cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5d7f64fbc06de4b6c86ef57b26e5b8822e37a9e", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/b5d7f64fbc06de4b6c86ef57b26e5b8822e37a9e", "committedDate": "2020-06-03T06:26:13Z", "message": "Cleanup"}, "afterCommit": {"oid": "bdea8b8627f6fe1538d8c7ae8ba9fc55398ac8f6", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/bdea8b8627f6fe1538d8c7ae8ba9fc55398ac8f6", "committedDate": "2020-06-03T15:25:28Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d55d6fc396a793f274dada0a744ae9946eafe13e", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/d55d6fc396a793f274dada0a744ae9946eafe13e", "committedDate": "2020-06-04T00:26:14Z", "message": "Fix check style."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dbf1b9b9faac6c6a3b50117c00f899761e9a2f1", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/3dbf1b9b9faac6c6a3b50117c00f899761e9a2f1", "committedDate": "2020-06-05T07:16:18Z", "message": "Merge remote-tracking branch 'apache/master' into server_interceptors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f5b87b68e3a89417ae4ad1cc70ea4c04b56465b", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/4f5b87b68e3a89417ae4ad1cc70ea4c04b56465b", "committedDate": "2020-06-05T10:21:33Z", "message": "Add WebService request listener."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89440cbf507e41b0c3f05e2d6fafca996fda39fd", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/89440cbf507e41b0c3f05e2d6fafca996fda39fd", "committedDate": "2020-06-06T01:50:38Z", "message": "Merge remote-tracking branch 'apache/master' into server_interceptors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1ODczNjM3", "url": "https://github.com/apache/pulsar/pull/7143#pullrequestreview-425873637", "createdAt": "2020-06-08T01:25:30Z", "commit": {"oid": "89440cbf507e41b0c3f05e2d6fafca996fda39fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMToyNTozMFrOGgNHdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMToyNTozMFrOGgNHdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyMjUxNg==", "bodyText": "overall looks good to me. I see there are two sets of settings here, one is for listeners and the other one is for interceptors? I think we should just rename the listener interfaces to Interceptors. So it is consistent with client-side interceptor.", "url": "https://github.com/apache/pulsar/pull/7143#discussion_r436422516", "createdAt": "2020-06-08T01:25:30Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -1769,6 +1783,20 @@\n     )\n     private Set<String> brokerClientTlsProtocols = Sets.newTreeSet();\n \n+    /**** --- Interceptor variables --- ****/\n+\n+    @FieldContext(\n+        category = CATEGORY_INTERCEPTORS,\n+        doc = \"The directory to locate interceptors\"\n+    )\n+    private String interceptorDirectory = \"./interceptors\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89440cbf507e41b0c3f05e2d6fafca996fda39fd"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afae533551c287e4189ce84ea232d93d66e7a821", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/afae533551c287e4189ce84ea232d93d66e7a821", "committedDate": "2020-06-08T05:28:23Z", "message": "Merge remote-tracking branch 'apache/master' into server_interceptors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9a75e0e3cbdafd7509004e1a9ff1a5bc991f3d1", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/b9a75e0e3cbdafd7509004e1a9ff1a5bc991f3d1", "committedDate": "2020-06-08T06:42:37Z", "message": "Rename to broker interceptor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0e776b48f8dcce4251f2da0a375a1afaef1df10", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/d0e776b48f8dcce4251f2da0a375a1afaef1df10", "committedDate": "2020-06-08T06:48:26Z", "message": "remove unused configurations."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MDI1MzQ3", "url": "https://github.com/apache/pulsar/pull/7143#pullrequestreview-426025347", "createdAt": "2020-06-08T08:45:02Z", "commit": {"oid": "d0e776b48f8dcce4251f2da0a375a1afaef1df10"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwODo0NTowM1rOGgUa2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwODo0NTowM1rOGgUa2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU0MjE2OQ==", "bodyText": "We should support multiple broker interceptors.  Can you add a broker interceptor implementation that wraps a list of interceptors into one interceptor?", "url": "https://github.com/apache/pulsar/pull/7143#discussion_r436542169", "createdAt": "2020-06-08T08:45:03Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -450,7 +453,9 @@ public void start() throws PulsarServerException {\n \n             this.defaultOffloader = createManagedLedgerOffloader(\n                     OffloadPolicies.create(this.getConfiguration().getProperties()));\n-\n+            this.brokerInterceptor = BrokerInterceptors.load(config);\n+            brokerService.setInterceptor(getBrokerInterceptor());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0e776b48f8dcce4251f2da0a375a1afaef1df10"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72e0d381c315f7d91dc5bd0b6cb9578e42a4f769", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/72e0d381c315f7d91dc5bd0b6cb9578e42a4f769", "committedDate": "2020-06-08T12:09:35Z", "message": "Fix unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDI0MzE5", "url": "https://github.com/apache/pulsar/pull/7143#pullrequestreview-426424319", "createdAt": "2020-06-08T16:45:25Z", "commit": {"oid": "72e0d381c315f7d91dc5bd0b6cb9578e42a4f769"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d0177bdfe282a180e59de8462ea3ce508a4f1e5", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/5d0177bdfe282a180e59de8462ea3ce508a4f1e5", "committedDate": "2020-06-08T23:13:51Z", "message": "Add get method for auth related methods."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2755, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}