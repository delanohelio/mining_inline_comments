{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NzYzOTU0", "number": 9042, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNDoxMTowMFrOFIlr4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMjo1NToxMVrOFI0Ztg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NTUwMzcxOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNDoxMTowMFrOIKl2sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMToxMTo0OFrOIK78XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk3Njg4Mg==", "bodyText": "When setting the value, it must be greater than or equal to 0, so there should be no case of <0.", "url": "https://github.com/apache/pulsar/pull/9042#discussion_r547976882", "createdAt": "2020-12-23T14:11:00Z", "author": {"login": "315157973"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -811,9 +811,14 @@ protected boolean isNamespaceReplicated(NamespaceName namespaceName) {\n     }\n \n     protected void internalCreatePartitionedTopic(AsyncResponse asyncResponse, int numPartitions) {\n-        final int maxTopicsPerNamespace = pulsar().getConfig().getMaxTopicsPerNamespace();\n-        if (maxTopicsPerNamespace > 0) {\n-            try {\n+        Integer maxTopicsPerNamespace;\n+        try {\n+            maxTopicsPerNamespace = getNamespacePolicies(namespaceName).max_topics_per_namespace;\n+            if (maxTopicsPerNamespace == null || maxTopicsPerNamespace < 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66905d53bb9afc1fd5a2697de9b6775eade1073"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzODc4MA==", "bodyText": "OK, maxTopicsPerNamespace is get from namespace policy, it must be greater than 0, i update the code.", "url": "https://github.com/apache/pulsar/pull/9042#discussion_r548338780", "createdAt": "2020-12-24T01:11:48Z", "author": {"login": "hangc0276"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java", "diffHunk": "@@ -811,9 +811,14 @@ protected boolean isNamespaceReplicated(NamespaceName namespaceName) {\n     }\n \n     protected void internalCreatePartitionedTopic(AsyncResponse asyncResponse, int numPartitions) {\n-        final int maxTopicsPerNamespace = pulsar().getConfig().getMaxTopicsPerNamespace();\n-        if (maxTopicsPerNamespace > 0) {\n-            try {\n+        Integer maxTopicsPerNamespace;\n+        try {\n+            maxTopicsPerNamespace = getNamespacePolicies(namespaceName).max_topics_per_namespace;\n+            if (maxTopicsPerNamespace == null || maxTopicsPerNamespace < 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk3Njg4Mg=="}, "originalCommit": {"oid": "b66905d53bb9afc1fd5a2697de9b6775eade1073"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NTUwNDIwOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNDoxMToxMFrOIKl2-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMToxNDoxOFrOIK7-LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk3Njk1NA==", "bodyText": "When setting the value, it must be greater than or equal to 0, so there should be no case of <0.", "url": "https://github.com/apache/pulsar/pull/9042#discussion_r547976954", "createdAt": "2020-12-23T14:11:10Z", "author": {"login": "315157973"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -3182,5 +3182,26 @@ protected OffloadPolicies internalGetOffloadPolicies() {\n         return policies.offload_policies;\n     }\n \n-    private static final Logger log = LoggerFactory.getLogger(NamespacesBase.class);\n+    protected int internalGetMaxTopicsPerNamespace() {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.MAX_TOPICS, PolicyOperation.READ);\n+        return getNamespacePolicies(namespaceName).max_topics_per_namespace;\n+    }\n+\n+   protected void internalRemoveMaxTopicsPerNamespace() {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.MAX_TOPICS, PolicyOperation.WRITE);\n+        internalSetMaxTopicsPerNamespace(null);\n+   }\n+\n+   protected void internalSetMaxTopicsPerNamespace(Integer maxTopicsPerNamespace) {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.MAX_TOPICS, PolicyOperation.WRITE);\n+        validatePoliciesReadOnlyAccess();\n+\n+        if (maxTopicsPerNamespace != null && maxTopicsPerNamespace < 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66905d53bb9afc1fd5a2697de9b6775eade1073"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzOTI0NQ==", "bodyText": "The maxTopicsPerNamespace is passed by user, we should forbid user set the value < 0, so the check must be added.", "url": "https://github.com/apache/pulsar/pull/9042#discussion_r548339245", "createdAt": "2020-12-24T01:14:18Z", "author": {"login": "hangc0276"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -3182,5 +3182,26 @@ protected OffloadPolicies internalGetOffloadPolicies() {\n         return policies.offload_policies;\n     }\n \n-    private static final Logger log = LoggerFactory.getLogger(NamespacesBase.class);\n+    protected int internalGetMaxTopicsPerNamespace() {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.MAX_TOPICS, PolicyOperation.READ);\n+        return getNamespacePolicies(namespaceName).max_topics_per_namespace;\n+    }\n+\n+   protected void internalRemoveMaxTopicsPerNamespace() {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.MAX_TOPICS, PolicyOperation.WRITE);\n+        internalSetMaxTopicsPerNamespace(null);\n+   }\n+\n+   protected void internalSetMaxTopicsPerNamespace(Integer maxTopicsPerNamespace) {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.MAX_TOPICS, PolicyOperation.WRITE);\n+        validatePoliciesReadOnlyAccess();\n+\n+        if (maxTopicsPerNamespace != null && maxTopicsPerNamespace < 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk3Njk1NA=="}, "originalCommit": {"oid": "b66905d53bb9afc1fd5a2697de9b6775eade1073"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NTUwNjQ5OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/NamespacesTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNDoxMTo1NlrOIKl4VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMToxNDozNVrOIK7-cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk3NzMwMQ==", "bodyText": "Will there be a problem if the created producer is not closed?", "url": "https://github.com/apache/pulsar/pull/9042#discussion_r547977301", "createdAt": "2020-12-23T14:11:56Z", "author": {"login": "315157973"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/NamespacesTest.java", "diffHunk": "@@ -1413,6 +1414,132 @@ public void testRetentionPolicyValidation() throws Exception {\n         admin.namespaces().deleteNamespace(namespace);\n     }\n \n+    @Test(timeOut = 30000)\n+    public void testMaxTopicsPerNamespace() throws Exception {\n+        super.internalCleanup();\n+        conf.setMaxTopicsPerNamespace(15);\n+        super.internalSetup();\n+\n+        String namespace = \"testTenant/ns1\";\n+        admin.clusters().createCluster(\"use\", new ClusterData(brokerUrl.toString()));\n+        TenantInfo tenantInfo = new TenantInfo(Sets.newHashSet(\"role1\", \"role2\"),\n+                Sets.newHashSet(\"use\"));\n+        admin.tenants().createTenant(\"testTenant\", tenantInfo);\n+        admin.namespaces().createNamespace(namespace, Sets.newHashSet(\"use\"));\n+\n+        admin.namespaces().setMaxTopicsPerNamespace(namespace, 10);\n+        assertEquals(10, admin.namespaces().getMaxTopicsPerNamespace(namespace));\n+\n+        // check create partitioned/non-partitioned topics using namespace policy\n+        String topic = \"persistent://testTenant/ns1/test_create_topic_v\";\n+        admin.topics().createPartitionedTopic(topic + \"1\", 2);\n+        admin.topics().createPartitionedTopic(topic + \"2\", 3);\n+        admin.topics().createPartitionedTopic(topic + \"3\", 4);\n+        admin.topics().createNonPartitionedTopic(topic + \"4\");\n+\n+        try {\n+            admin.topics().createPartitionedTopic(topic + \"5\", 2);\n+            fail();\n+        } catch (PulsarAdminException e) {\n+            assertEquals(e.getStatusCode(), 412);\n+            assertEquals(e.getHttpError(), \"Exceed maximum number of topics in namespace.\");\n+        }\n+\n+        // remove namespace policy limit, use broker configuration instead.\n+        admin.namespaces().removeMaxTopicsPerNamespace(namespace);\n+        admin.topics().createPartitionedTopic(topic + \"6\", 4);\n+        try {\n+            admin.topics().createPartitionedTopic(topic + \"7\", 3);\n+            fail();\n+        } catch (PulsarAdminException e) {\n+            assertEquals(e.getStatusCode(), 412);\n+            assertEquals(e.getHttpError(), \"Exceed maximum number of topics in namespace.\");\n+        }\n+\n+        admin.namespaces().setMaxTopicsPerNamespace(namespace, 0);\n+        // set namespace policy to no limit\n+        for (int i = 0; i< 10; ++i) {\n+            admin.topics().createPartitionedTopic(topic + \"_v\" + i, 2);\n+            admin.topics().createNonPartitionedTopic(topic + \"_vn\" + i);\n+        }\n+\n+\n+        // check producer/consumer auto create partitioned topic\n+        super.internalCleanup();\n+        conf.setMaxTopicsPerNamespace(0);\n+        conf.setDefaultNumPartitions(3);\n+        conf.setAllowAutoTopicCreationType(\"partitioned\");\n+        super.internalSetup();\n+\n+        admin.clusters().createCluster(\"use\", new ClusterData(brokerUrl.toString()));\n+        admin.tenants().createTenant(\"testTenant\", tenantInfo);\n+        admin.namespaces().createNamespace(namespace, Sets.newHashSet(\"use\"));\n+        admin.namespaces().setMaxTopicsPerNamespace(namespace, 10);\n+\n+        pulsarClient.newProducer().topic(topic + \"1\").create();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66905d53bb9afc1fd5a2697de9b6775eade1073"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzOTMxMg==", "bodyText": "OK, i will close them.", "url": "https://github.com/apache/pulsar/pull/9042#discussion_r548339312", "createdAt": "2020-12-24T01:14:35Z", "author": {"login": "hangc0276"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/NamespacesTest.java", "diffHunk": "@@ -1413,6 +1414,132 @@ public void testRetentionPolicyValidation() throws Exception {\n         admin.namespaces().deleteNamespace(namespace);\n     }\n \n+    @Test(timeOut = 30000)\n+    public void testMaxTopicsPerNamespace() throws Exception {\n+        super.internalCleanup();\n+        conf.setMaxTopicsPerNamespace(15);\n+        super.internalSetup();\n+\n+        String namespace = \"testTenant/ns1\";\n+        admin.clusters().createCluster(\"use\", new ClusterData(brokerUrl.toString()));\n+        TenantInfo tenantInfo = new TenantInfo(Sets.newHashSet(\"role1\", \"role2\"),\n+                Sets.newHashSet(\"use\"));\n+        admin.tenants().createTenant(\"testTenant\", tenantInfo);\n+        admin.namespaces().createNamespace(namespace, Sets.newHashSet(\"use\"));\n+\n+        admin.namespaces().setMaxTopicsPerNamespace(namespace, 10);\n+        assertEquals(10, admin.namespaces().getMaxTopicsPerNamespace(namespace));\n+\n+        // check create partitioned/non-partitioned topics using namespace policy\n+        String topic = \"persistent://testTenant/ns1/test_create_topic_v\";\n+        admin.topics().createPartitionedTopic(topic + \"1\", 2);\n+        admin.topics().createPartitionedTopic(topic + \"2\", 3);\n+        admin.topics().createPartitionedTopic(topic + \"3\", 4);\n+        admin.topics().createNonPartitionedTopic(topic + \"4\");\n+\n+        try {\n+            admin.topics().createPartitionedTopic(topic + \"5\", 2);\n+            fail();\n+        } catch (PulsarAdminException e) {\n+            assertEquals(e.getStatusCode(), 412);\n+            assertEquals(e.getHttpError(), \"Exceed maximum number of topics in namespace.\");\n+        }\n+\n+        // remove namespace policy limit, use broker configuration instead.\n+        admin.namespaces().removeMaxTopicsPerNamespace(namespace);\n+        admin.topics().createPartitionedTopic(topic + \"6\", 4);\n+        try {\n+            admin.topics().createPartitionedTopic(topic + \"7\", 3);\n+            fail();\n+        } catch (PulsarAdminException e) {\n+            assertEquals(e.getStatusCode(), 412);\n+            assertEquals(e.getHttpError(), \"Exceed maximum number of topics in namespace.\");\n+        }\n+\n+        admin.namespaces().setMaxTopicsPerNamespace(namespace, 0);\n+        // set namespace policy to no limit\n+        for (int i = 0; i< 10; ++i) {\n+            admin.topics().createPartitionedTopic(topic + \"_v\" + i, 2);\n+            admin.topics().createNonPartitionedTopic(topic + \"_vn\" + i);\n+        }\n+\n+\n+        // check producer/consumer auto create partitioned topic\n+        super.internalCleanup();\n+        conf.setMaxTopicsPerNamespace(0);\n+        conf.setDefaultNumPartitions(3);\n+        conf.setAllowAutoTopicCreationType(\"partitioned\");\n+        super.internalSetup();\n+\n+        admin.clusters().createCluster(\"use\", new ClusterData(brokerUrl.toString()));\n+        admin.tenants().createTenant(\"testTenant\", tenantInfo);\n+        admin.namespaces().createNamespace(namespace, Sets.newHashSet(\"use\"));\n+        admin.namespaces().setMaxTopicsPerNamespace(namespace, 10);\n+\n+        pulsarClient.newProducer().topic(topic + \"1\").create();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk3NzMwMQ=="}, "originalCommit": {"oid": "b66905d53bb9afc1fd5a2697de9b6775eade1073"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NzkxNDc4OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMjo1NToxMVrOIK9NDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwMzoxMzoxMVrOIK9bDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM1OTQzOA==", "bodyText": "Will there be no <0\uff1f", "url": "https://github.com/apache/pulsar/pull/9042#discussion_r548359438", "createdAt": "2020-12-24T02:55:11Z", "author": {"login": "315157973"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -2517,9 +2517,18 @@ private void checkTopicLevelPolicyEnable() {\n \n     private <T> boolean checkMaxTopicsPerNamespace(TopicName topicName, int numPartitions,\n                                             CompletableFuture<T> topicFuture) {\n-        final int maxTopicsPerNamespace = pulsar().getConfig().getMaxTopicsPerNamespace();\n-        if (maxTopicsPerNamespace > 0) {\n-            try {\n+        Integer maxTopicsPerNamespace;\n+        try {\n+            maxTopicsPerNamespace = pulsar.getConfigurationCache().policiesCache()\n+                    .get(AdminResource.path(POLICIES, topicName.getNamespace()))\n+                    .map(p -> p.max_topics_per_namespace)\n+                    .orElse(null);\n+\n+            if (maxTopicsPerNamespace == null || maxTopicsPerNamespace < 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9159b16b36cfc683b6b37f67f8a85cf77c879648"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM2MzAyMA==", "bodyText": "I remove it.", "url": "https://github.com/apache/pulsar/pull/9042#discussion_r548363020", "createdAt": "2020-12-24T03:13:11Z", "author": {"login": "hangc0276"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -2517,9 +2517,18 @@ private void checkTopicLevelPolicyEnable() {\n \n     private <T> boolean checkMaxTopicsPerNamespace(TopicName topicName, int numPartitions,\n                                             CompletableFuture<T> topicFuture) {\n-        final int maxTopicsPerNamespace = pulsar().getConfig().getMaxTopicsPerNamespace();\n-        if (maxTopicsPerNamespace > 0) {\n-            try {\n+        Integer maxTopicsPerNamespace;\n+        try {\n+            maxTopicsPerNamespace = pulsar.getConfigurationCache().policiesCache()\n+                    .get(AdminResource.path(POLICIES, topicName.getNamespace()))\n+                    .map(p -> p.max_topics_per_namespace)\n+                    .orElse(null);\n+\n+            if (maxTopicsPerNamespace == null || maxTopicsPerNamespace < 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM1OTQzOA=="}, "originalCommit": {"oid": "9159b16b36cfc683b6b37f67f8a85cf77c879648"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2615, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}