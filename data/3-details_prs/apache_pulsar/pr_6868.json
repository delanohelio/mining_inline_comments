{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyODY0MTc2", "number": 6868, "title": "[issue #6765]  Expose definition flags to function ", "bodyText": "Fixes #6765\nMotivation\nModifications\n1\uff09\nChange the value of the CLI tool parameter \"--custom-schema-input\" from\n\"TopicName-> schemaType\"\nto\n\"topicName-> {\" schemaType \":\" type\",\" jsr310ConversionEnabled \": true,\" alwaysAllowNull \": true}\"\n2\uff09\nModify Function.proto, add properties \"jsr310ConversionEnabled\", \"alwaysAllowNull\"\u3002So that we can receive the above 2 parameters\n3\uff09\nModify the \"FunctionConfigUtils#convert\" method \uff0c put the two parameters in \"CustomSchemaInputs\" into ConsumerSpec\n4\uff09\nIn \u201cJavaInstanceRunnable#setupInput\u201d method, put the above 2 parameters into \"ConsumerConfig\" and pass it to \"PulsarSource\", let it set the parameters into \"schema\" when creating the consumer of Source\u3002\nSo that\uff0cThe \u201cfunction\u201d can get these 2 parameters from the message of\n\u201dcurrentRecord\u201c\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API: (yes / no)\nThe schema: (yes / no / don't know)\nThe default values of configurations: (yes / no)\nThe wire protocol: (yes / no)\nThe rest endpoints: (yes / no)\nThe admin cli options: (yes / no)\nAnything that affects deployment: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? ( no)\nIf yes, how is the feature documented? (docs)\nIf a feature is not applicable for documentation, explain why?\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-05-04T10:23:37Z", "url": "https://github.com/apache/pulsar/pull/6868", "merged": true, "mergeCommit": {"oid": "2aff473e598fe5e8ba9f8ed0860de35a67718725"}, "closed": true, "closedAt": "2020-06-09T08:11:27Z", "author": {"login": "315157973"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcd7aJvgH2gAyNDEyODY0MTc2OjUzYTEwM2NkMDA5NDBkODM4NGI5MTdjZTZmNTc0NTM0NmM0OTQwZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpgenngFqTQyNjg4NzM2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "53a103cd00940d8384b917ce6f5745346c4940e6", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/53a103cd00940d8384b917ce6f5745346c4940e6", "committedDate": "2020-05-04T08:42:51Z", "message": "Definition flags expose to function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f29f7e679a8ca78745765152b35f5c8152be866e", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/f29f7e679a8ca78745765152b35f5c8152be866e", "committedDate": "2020-05-04T10:20:31Z", "message": "remove function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTkyNjI2", "url": "https://github.com/apache/pulsar/pull/6868#pullrequestreview-413992626", "createdAt": "2020-05-18T22:59:49Z", "commit": {"oid": "f29f7e679a8ca78745765152b35f5c8152be866e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMjo1OTo0OVrOGXKLJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMzowMDozOFrOGXKMZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzNzEyNQ==", "bodyText": "I don't think it is a good design to add these two settings directly. Because these two settings are only applied to AVRO or Struct schemas. It doesn't provide any extensibility to the framework of Pulsar functions. We should provide the ability to allow specifying properties for the schema for the input topic and properties for the schema for the output topic.\nSo ideally, it should be:\nmap<string, string> schemaProperties = 6;.", "url": "https://github.com/apache/pulsar/pull/6868#discussion_r426937125", "createdAt": "2020-05-18T22:59:49Z", "author": {"login": "sijie"}, "path": "pulsar-functions/proto/src/main/proto/Function.proto", "diffHunk": "@@ -91,6 +91,8 @@ message ConsumerSpec {\n         int32 value = 1;\n     }\n     ReceiverQueueSize receiverQueueSize = 4;\n+    bool jsr310ConversionEnabled = 5;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f29f7e679a8ca78745765152b35f5c8152be866e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzNzQ0NA==", "bodyText": "We should also add the schemaProperties to both SourceSpec and SinkSpec.", "url": "https://github.com/apache/pulsar/pull/6868#discussion_r426937444", "createdAt": "2020-05-18T23:00:38Z", "author": {"login": "sijie"}, "path": "pulsar-functions/proto/src/main/proto/Function.proto", "diffHunk": "@@ -91,6 +91,8 @@ message ConsumerSpec {\n         int32 value = 1;\n     }\n     ReceiverQueueSize receiverQueueSize = 4;\n+    bool jsr310ConversionEnabled = 5;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzNzEyNQ=="}, "originalCommit": {"oid": "f29f7e679a8ca78745765152b35f5c8152be866e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c7ee88e260f6ea579d27317d80a74c1e6118d60", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/8c7ee88e260f6ea579d27317d80a74c1e6118d60", "committedDate": "2020-05-20T19:04:03Z", "message": "merge properties into SchemaProperties and add the schemaProperties to both SourceSpec and SinkSpec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "891b1411b351c7e1a934831ae40d2c327976ef17", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/891b1411b351c7e1a934831ae40d2c327976ef17", "committedDate": "2020-05-21T03:18:38Z", "message": "Merge branch 'master' into fix\n\n# Conflicts:\n#\tpulsar-functions/utils/src/main/java/org/apache/pulsar/functions/utils/FunctionConfigUtils.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41776a1909bea318720e6494fc5bb4dad3dd7a42", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/41776a1909bea318720e6494fc5bb4dad3dd7a42", "committedDate": "2020-05-21T03:42:47Z", "message": "change code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2ef705553b233736a56d3ad93feebe33b7b4086", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/c2ef705553b233736a56d3ad93feebe33b7b4086", "committedDate": "2020-05-25T05:12:33Z", "message": "Merge branch 'master' into fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52b2e9a15bb1b098f31154ba4f3ba8c62f158ae2", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/52b2e9a15bb1b098f31154ba4f3ba8c62f158ae2", "committedDate": "2020-05-25T16:11:44Z", "message": "Adapt the default value of protobuf serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f6f610e5243c02a0a284a79bcf8153466fae273", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/1f6f610e5243c02a0a284a79bcf8153466fae273", "committedDate": "2020-06-04T05:26:39Z", "message": "Merge remote-tracking branch 'apache/master' into fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9022d8421ec0a527c47cac0e126e17667b9031e", "author": {"user": {"login": "codelipenghui", "name": "lipenghui"}}, "url": "https://github.com/apache/pulsar/commit/d9022d8421ec0a527c47cac0e126e17667b9031e", "committedDate": "2020-06-05T00:07:43Z", "message": "Merge remote-tracking branch 'apache/master' into fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTQ1NzU0", "url": "https://github.com/apache/pulsar/pull/6868#pullrequestreview-424945754", "createdAt": "2020-06-05T01:50:14Z", "commit": {"oid": "d9022d8421ec0a527c47cac0e126e17667b9031e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1ODY5MDUx", "url": "https://github.com/apache/pulsar/pull/6868#pullrequestreview-425869051", "createdAt": "2020-06-08T00:50:12Z", "commit": {"oid": "d9022d8421ec0a527c47cac0e126e17667b9031e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMDo1MDoxMlrOGgM4XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMDo1MDoxMlrOGgM4XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQxODY1Mg==", "bodyText": "Please use SchemaDefinitionBuilder#withProperties to construct the schema definition and avoid adding this kind of customization code. Also, the schema properties should be passed to other schemas as well.", "url": "https://github.com/apache/pulsar/pull/6868#discussion_r436418652", "createdAt": "2020-06-08T00:50:12Z", "author": {"login": "sijie"}, "path": "pulsar-functions/instance/src/main/java/org/apache/pulsar/functions/source/TopicSchema.java", "diffHunk": "@@ -158,6 +173,20 @@ private static SchemaType getDefaultSchemaType(Class<?> clazz) {\n         }\n     }\n \n+    private static <T> AvroSchema<T> buildAvroSchema(Class<T> clazz, ConsumerConfig conf) {\n+        String jsr310ConversionEnabled = null;\n+        String alwaysAllowNull = null;\n+        if (conf.getSchemaProperties() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9022d8421ec0a527c47cac0e126e17667b9031e"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbc49266fd1257460863e178cfa5f5e903f53406", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/bbc49266fd1257460863e178cfa5f5e903f53406", "committedDate": "2020-06-08T09:44:27Z", "message": "build Schema with SchemaDefinitionBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "338d72c38a9e968140fe960e4c76fc2c220a0cb6", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/338d72c38a9e968140fe960e4c76fc2c220a0cb6", "committedDate": "2020-06-08T09:46:18Z", "message": "Merge remote-tracking branch 'origin/fix' into fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDE5MjU0", "url": "https://github.com/apache/pulsar/pull/6868#pullrequestreview-426419254", "createdAt": "2020-06-08T16:38:48Z", "commit": {"oid": "338d72c38a9e968140fe960e4c76fc2c220a0cb6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjozODo0OFrOGgmzTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjozOTo0NVrOGgm1fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MzM0MQ==", "bodyText": "Can you explain why do you introduce two new settings without underscores?", "url": "https://github.com/apache/pulsar/pull/6868#discussion_r436843341", "createdAt": "2020-06-08T16:38:48Z", "author": {"login": "sijie"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/SchemaDefinitionBuilderImpl.java", "diffHunk": "@@ -35,7 +35,9 @@\n public class SchemaDefinitionBuilderImpl<T> implements SchemaDefinitionBuilder<T> {\n \n     public static final String ALWAYS_ALLOW_NULL = \"__alwaysAllowNull\";\n+    public static final String ALWAYS_ALLOW_NULL_NO_UNDERLINED = \"alwaysAllowNull\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "338d72c38a9e968140fe960e4c76fc2c220a0cb6"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MzkwMA==", "bodyText": "Why can't we use the existing settings?", "url": "https://github.com/apache/pulsar/pull/6868#discussion_r436843900", "createdAt": "2020-06-08T16:39:45Z", "author": {"login": "sijie"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/schema/SchemaDefinitionBuilderImpl.java", "diffHunk": "@@ -35,7 +35,9 @@\n public class SchemaDefinitionBuilderImpl<T> implements SchemaDefinitionBuilder<T> {\n \n     public static final String ALWAYS_ALLOW_NULL = \"__alwaysAllowNull\";\n+    public static final String ALWAYS_ALLOW_NULL_NO_UNDERLINED = \"alwaysAllowNull\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MzM0MQ=="}, "originalCommit": {"oid": "338d72c38a9e968140fe960e4c76fc2c220a0cb6"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec4f9adaf734e03659596ea1f2c11ed4d20d3b68", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/ec4f9adaf734e03659596ea1f2c11ed4d20d3b68", "committedDate": "2020-06-09T02:37:43Z", "message": "remove param without underscores"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef619525ae3fbcc8e23323fe4f2f1fa5eec98481", "author": {"user": {"login": "315157973", "name": "feynmanlin"}}, "url": "https://github.com/apache/pulsar/commit/ef619525ae3fbcc8e23323fe4f2f1fa5eec98481", "committedDate": "2020-06-09T03:17:48Z", "message": "remove param without underscores"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODg3MzYx", "url": "https://github.com/apache/pulsar/pull/6868#pullrequestreview-426887361", "createdAt": "2020-06-09T08:07:23Z", "commit": {"oid": "ef619525ae3fbcc8e23323fe4f2f1fa5eec98481"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3629, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}