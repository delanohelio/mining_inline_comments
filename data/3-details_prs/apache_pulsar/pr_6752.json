{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MDU4NTc2", "number": 6752, "title": "Support different docker images in Kubernetes runtime of Pulsar Functions", "bodyText": "Signed-off-by: xiaolong.ran rxl@apache.org\nMaster Issue: #6520\nMotivation\nProvide support to configure different docker images for go, python, java function\nModifications\n\nAdd javaFunctionDockerImageName, pythonFunctionDockerImageName, and goFunctionDockerImageName in KubernetesRuntimeFactoryConfig.\nAdd unit test case\nUpdate docs of functions-runtime.md", "createdAt": "2020-04-17T10:41:18Z", "url": "https://github.com/apache/pulsar/pull/6752", "merged": true, "mergeCommit": {"oid": "3c5a4232461720b657c6be16f3d789d410da243b"}, "closed": true, "closedAt": "2020-07-17T12:45:59Z", "author": {"login": "wolfstudy"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYe1MTgH2gAyNDA1MDU4NTc2OmExZmQwZGEwNzMxZWQ5ODE0OWM3NTViNGMwMmY0NTE0NjhiOWI2Y2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1tgy2gH2gAyNDA1MDU4NTc2OmIzN2ZlZjg5OTY0MjM0MDc3MjM1OGMxZmY5N2NhZGYwZTNlNDcwMGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a1fd0da0731ed98149c755b4c02f451468b9b6ce", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/a1fd0da0731ed98149c755b4c02f451468b9b6ce", "committedDate": "2020-04-17T10:35:31Z", "message": "Support different docker images in Kubernetes runtime of Pulsar Functions\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb892a0023c1dfd5f097e1dedd2eb62d4f1e8046", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/eb892a0023c1dfd5f097e1dedd2eb62d4f1e8046", "committedDate": "2020-04-17T20:07:00Z", "message": "Fix default behavior\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTE1NDU1", "url": "https://github.com/apache/pulsar/pull/6752#pullrequestreview-395915455", "createdAt": "2020-04-18T13:48:06Z", "commit": {"oid": "eb892a0023c1dfd5f097e1dedd2eb62d4f1e8046"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxMzo0ODowNlrOGHrLGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxMzo0ODowNlrOGHrLGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDcwMDU3MA==", "bodyText": "If these three image name is to overwrite pulsarDockerImageName, we'd better tell users uses pulsarDockerImageName to run function instance if value of javaFunctionDockerImageName is absent.", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r410700570", "createdAt": "2020-04-18T13:48:06Z", "author": {"login": "codelipenghui"}, "path": "site2/docs/functions-runtime.md", "diffHunk": "@@ -53,6 +53,12 @@ kubernetesContainerFactory:\n   jobNamespace:\n   # the docker image to run function instance. by default it is `apachepulsar/pulsar`\n   pulsarDockerImageName:\n+  # the docker image to run java function instance. by default it is `null`\n+  javaFunctionDockerImageName:\n+  # the docker image to run python function instance. by default it is `null`\n+  pythonFunctionDockerImageName:\n+  # the docker image to run go function instance. by default it is `null`\n+  goFunctionDockerImageName:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb892a0023c1dfd5f097e1dedd2eb62d4f1e8046"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTQyNzA0", "url": "https://github.com/apache/pulsar/pull/6752#pullrequestreview-395942704", "createdAt": "2020-04-18T19:11:40Z", "commit": {"oid": "eb892a0023c1dfd5f097e1dedd2eb62d4f1e8046"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToxMTo0MVrOGHtfQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQxOToxMTo0MVrOGHtfQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczODQ5OA==", "bodyText": "This can already be achieved with no code changes by implementing your own https://github.com/apache/pulsar/blob/master/pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesManifestCustomizer.java\nThis class allows you to do anything to the function spec so you can set whatever image you want.\nIs there another patch coming with this? The kubernetes runtime only supports one docker image right?. So, If I configured a python image I would only be able to run python functions.\nI'm not sure this is the right approach and think the design needs to be thought through more. Maybe a more generic structure like a map. That way you could have images for specific runtime version java8, java11, python3.7, python3.8, etc..\nOr provide another implementation of the KubernetesManifestCustomizer.java that supports images for each runtime (java, python, go, etc..)", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r410738498", "createdAt": "2020-04-18T19:11:41Z", "author": {"login": "cckellogg"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java", "diffHunk": "@@ -155,6 +158,9 @@\n                       String pythonDependencyRepository,\n                       String pythonExtraDependencyRepository,\n                       String pulsarDockerImageName,\n+                      String javaFunctionDockerImageName,\n+                      String pythonFunctionDockerImageName,\n+                      String goFunctionDockerImageName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb892a0023c1dfd5f097e1dedd2eb62d4f1e8046"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c87c20ee9ed248ded79abc3b07dfd9126f6f48d", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/7c87c20ee9ed248ded79abc3b07dfd9126f6f48d", "committedDate": "2020-04-19T05:12:23Z", "message": "fix comments\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjM0Mzgy", "url": "https://github.com/apache/pulsar/pull/6752#pullrequestreview-397634382", "createdAt": "2020-04-21T20:04:36Z", "commit": {"oid": "7c87c20ee9ed248ded79abc3b07dfd9126f6f48d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMDowNDozNlrOGJWONg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMDowNjoyN1rOGJWSsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1NDQ1NA==", "bodyText": "@cckellogg I think the idea is to create different instance images for different language runtime. So we can start making the language runtime pluggable.", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r412454454", "createdAt": "2020-04-21T20:04:36Z", "author": {"login": "sijie"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java", "diffHunk": "@@ -155,6 +158,9 @@\n                       String pythonDependencyRepository,\n                       String pythonExtraDependencyRepository,\n                       String pulsarDockerImageName,\n+                      String javaFunctionDockerImageName,\n+                      String pythonFunctionDockerImageName,\n+                      String goFunctionDockerImageName,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDczODQ5OA=="}, "originalCommit": {"oid": "eb892a0023c1dfd5f097e1dedd2eb62d4f1e8046"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ1NTYwMg==", "bodyText": "I think the logic here is completely wrong. You should set the correct docker image name based on the language runtime, not based on whether this configuration is set or not.", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r412455602", "createdAt": "2020-04-21T20:06:27Z", "author": {"login": "sijie"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java", "diffHunk": "@@ -973,8 +982,19 @@ private V1PodSpec getPodSpec(List<String> instanceCommand, Function.Resources re\n     V1Container getFunctionContainer(List<String> instanceCommand, Function.Resources resource) {\n         final V1Container container = new V1Container().name(PULSARFUNCTIONS_CONTAINER_NAME);\n \n-        // set up the container images\n-        container.setImage(pulsarDockerImageName);\n+        // By default, if we do not use the function image of a specific language, then we will support all languages.\n+        if (javaFunctionDockerImageName == null && pythonFunctionDockerImageName == null && goFunctionDockerImageName == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c87c20ee9ed248ded79abc3b07dfd9126f6f48d"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05f63912e288bc9d3e8077639f35e16fc308f6f7", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/05f63912e288bc9d3e8077639f35e16fc308f6f7", "committedDate": "2020-05-14T03:51:07Z", "message": "fix comments\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDE0ODM1", "url": "https://github.com/apache/pulsar/pull/6752#pullrequestreview-427414835", "createdAt": "2020-06-09T18:06:16Z", "commit": {"oid": "05f63912e288bc9d3e8077639f35e16fc308f6f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODowNjoxNlrOGhWRhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxODowNjoxNlrOGhWRhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYyMTEyNw==", "bodyText": "I don't think this is a backwards compatible change.  Existing users would still be using \"pulsarDockerImageName\" and only that config will be set.  \"pulsarDockerImageName\" should still be the default config used for image name and the new configs can override it if set.", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r437621127", "createdAt": "2020-06-09T18:06:16Z", "author": {"login": "jerrypeng"}, "path": "pulsar-functions/runtime/src/main/java/org/apache/pulsar/functions/runtime/kubernetes/KubernetesRuntime.java", "diffHunk": "@@ -973,8 +982,18 @@ private V1PodSpec getPodSpec(List<String> instanceCommand, Function.Resources re\n     V1Container getFunctionContainer(List<String> instanceCommand, Function.Resources resource) {\n         final V1Container container = new V1Container().name(PULSARFUNCTIONS_CONTAINER_NAME);\n \n-        // set up the container images\n-        container.setImage(pulsarDockerImageName);\n+        Function.FunctionDetails.Runtime runtime = instanceConfig.getFunctionDetails().getRuntime();\n+\n+        if (runtime == Function.FunctionDetails.Runtime.JAVA){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05f63912e288bc9d3e8077639f35e16fc308f6f7"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcc49de92a42208b31026d20c6e0e88d380335f8", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/fcc49de92a42208b31026d20c6e0e88d380335f8", "committedDate": "2020-06-16T02:31:21Z", "message": "fix comments\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NjYxMjUw", "url": "https://github.com/apache/pulsar/pull/6752#pullrequestreview-448661250", "createdAt": "2020-07-15T06:26:06Z", "commit": {"oid": "fcc49de92a42208b31026d20c6e0e88d380335f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNjoyNjowNlrOGxv_iA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNjoyNjowNlrOGxv_iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgxOTcyMA==", "bodyText": "If the eventual goal is to make language runtimes pluggable, can we organize this into a map, something like:\nfunctionDockerImages:\nJAVA: apache/pulsar:java\nPYTHON: apache/pulsar:python\nFOO: apache/pulsar:foo\nDEFAULT: apache/pulsar:default\nSince language runtimes will be pluggable it doesn't make sense to have concrete configs for a specific language.", "url": "https://github.com/apache/pulsar/pull/6752#discussion_r454819720", "createdAt": "2020-07-15T06:26:06Z", "author": {"login": "jerrypeng"}, "path": "conf/functions_worker.yml", "diffHunk": "@@ -125,6 +125,15 @@ functionRuntimeFactoryConfigs:\n #  jobNamespace:\n #  # the docker image to run function instance. by default it is `apachepulsar/pulsar`\n #  pulsarDockerImageName:\n+#  # the docker image to run java function instance, we will uses `pulsarDockerImageName` to run function instance", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcc49de92a42208b31026d20c6e0e88d380335f8"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7b4e023c3f0a141ad2800f6a928696bb78b5705", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/a7b4e023c3f0a141ad2800f6a928696bb78b5705", "committedDate": "2020-07-15T09:17:25Z", "message": "Merge branch 'master' into xiaolong/supprot-different-images-for-function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2634bb2030b66c1b8661d91ded5242224020dac", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/d2634bb2030b66c1b8661d91ded5242224020dac", "committedDate": "2020-07-16T01:13:57Z", "message": "fix comments\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3972eeb3fe9f9d5424216fd6dd6c00f71c1a44c6", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/3972eeb3fe9f9d5424216fd6dd6c00f71c1a44c6", "committedDate": "2020-07-16T01:28:40Z", "message": "add docs and fix test case\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5ODM2NTkx", "url": "https://github.com/apache/pulsar/pull/6752#pullrequestreview-449836591", "createdAt": "2020-07-16T13:17:26Z", "commit": {"oid": "3972eeb3fe9f9d5424216fd6dd6c00f71c1a44c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMDg1MjIy", "url": "https://github.com/apache/pulsar/pull/6752#pullrequestreview-450085222", "createdAt": "2020-07-16T17:58:15Z", "commit": {"oid": "3972eeb3fe9f9d5424216fd6dd6c00f71c1a44c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzQ0NTg0", "url": "https://github.com/apache/pulsar/pull/6752#pullrequestreview-450344584", "createdAt": "2020-07-17T03:06:37Z", "commit": {"oid": "3972eeb3fe9f9d5424216fd6dd6c00f71c1a44c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71dad317f980a05647ab4f470cb6d05a8d2e636f", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/71dad317f980a05647ab4f470cb6d05a8d2e636f", "committedDate": "2020-07-17T03:48:40Z", "message": "fix ci error\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b37fef899642340772358c1ff97cadf0e3e4700f", "author": {"user": {"login": "wolfstudy", "name": "xiaolong ran"}}, "url": "https://github.com/apache/pulsar/commit/b37fef899642340772358c1ff97cadf0e3e4700f", "committedDate": "2020-07-17T06:05:37Z", "message": "fix ci error\n\nSigned-off-by: xiaolong.ran <rxl@apache.org>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3558, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}