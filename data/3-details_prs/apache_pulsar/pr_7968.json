{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NTY3NDcy", "number": 7968, "title": "[Issue 7759] Support set Max Consumer on topic level.", "bodyText": "Fix #7759, and master issue #2688\nMotivation\nSupport set/get/remove maxConsumers on a topic level.\nVerifying this change\nnew unit test added.", "createdAt": "2020-09-03T11:36:51Z", "url": "https://github.com/apache/pulsar/pull/7968", "merged": true, "mergeCommit": {"oid": "6eefee7b6876a01e0e000cc1733b674551ee3818"}, "closed": true, "closedAt": "2020-09-08T00:50:06Z", "author": {"login": "zhanghaou"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDLPnMgH2gAyNDc4NTY3NDcyOjI1MjJhMDg0MzBkYzVlYzhmZGQwZjUzNDAzOGUzMTgzYWVhNGRjOGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGi7K7gFqTQ4MzU1MTUzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2522a08430dc5ec8fdd0f534038e3183aea4dc8c", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/2522a08430dc5ec8fdd0f534038e3183aea4dc8c", "committedDate": "2020-08-28T02:05:01Z", "message": "Merge pull request #1 from apache/master\n\nmerge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3880bb4ab7d82b4f58efeca351a9ebb1b601147", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/a3880bb4ab7d82b4f58efeca351a9ebb1b601147", "committedDate": "2020-08-31T01:04:34Z", "message": "Merge pull request #2 from apache/master\n\nmerge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13df37f3e29e3c4f1696ed92405940c2405aab85", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/13df37f3e29e3c4f1696ed92405940c2405aab85", "committedDate": "2020-09-03T00:03:30Z", "message": "Merge pull request #3 from apache/master\n\nmerge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c535605d9355fcfe96cdcc9f5c0aa8575fff4489", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/c535605d9355fcfe96cdcc9f5c0aa8575fff4489", "committedDate": "2020-09-03T09:07:18Z", "message": "Merge pull request #4 from apache/master\n\nmerge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "550963be7652a6c428b80e17b11e99184adf8233", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/550963be7652a6c428b80e17b11e99184adf8233", "committedDate": "2020-09-03T11:33:40Z", "message": "[ISSUE 7759] Support set Max Consumer on topic level."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNTg3MTAz", "url": "https://github.com/apache/pulsar/pull/7968#pullrequestreview-482587103", "createdAt": "2020-09-04T11:51:18Z", "commit": {"oid": "550963be7652a6c428b80e17b11e99184adf8233"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxMTo1MToxOFrOHNKnkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxMTo1NDoyMVrOHNKstg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzUwNg==", "bodyText": "It is not recommended to use AsyncResponse, just return the value directly.\nmore info to see #7884", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r483567506", "createdAt": "2020-09-04T11:51:18Z", "author": {"login": "jianyun8023"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -2417,6 +2417,53 @@ protected void internalGetMaxProducers(AsyncResponse asyncResponse) {\n         return pulsar().getTopicPoliciesService().updateTopicPoliciesAsync(topicName, topicPolicies.get());\n     }\n \n+    protected void internalGetMaxConsumers(AsyncResponse asyncResponse) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();\n+        Optional<Integer> maxConsumers = getTopicPolicies(topicName)\n+                .map(TopicPolicies::getMaxConsumerPerTopic);\n+        if (!maxConsumers.isPresent()) {\n+            asyncResponse.resume(Response.noContent().build());\n+        } else {\n+            asyncResponse.resume(maxConsumers.get());\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "550963be7652a6c428b80e17b11e99184adf8233"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2ODgyMg==", "bodyText": "remove admin.topics().deletePartitionedTopic(testTopic, true);", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r483568822", "createdAt": "2020-09-04T11:54:21Z", "author": {"login": "jianyun8023"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicPoliciesTest.java", "diffHunk": "@@ -590,4 +591,121 @@ public void testRemovePublishRate() throws Exception {\n \n         admin.topics().deletePartitionedTopic(testTopic, true);\n     }\n+\n+    @Test\n+    public void testCheckMaxConsumers() throws Exception {\n+        Integer maxProducers = new Integer(-1);\n+        log.info(\"MaxConsumers: {} will set to the topic: {}\", maxProducers, testTopic);\n+        try {\n+            admin.topics().setMaxConsumers(testTopic, maxProducers);\n+            Assert.fail();\n+        } catch (PulsarAdminException e) {\n+            Assert.assertEquals(e.getStatusCode(), 412);\n+        }\n+\n+        admin.topics().deletePartitionedTopic(testTopic, true);\n+    }\n+\n+    @Test\n+    public void testSetMaxConsumers() throws Exception {\n+        admin.namespaces().setMaxConsumersPerTopic(myNamespace, 1);\n+        log.info(\"MaxConsumers: {} will set to the namespace: {}\", 1, myNamespace);\n+        Integer maxConsumers = 2;\n+        log.info(\"MaxConsumers: {} will set to the topic: {}\", maxConsumers, persistenceTopic);\n+        admin.topics().setMaxConsumers(persistenceTopic, maxConsumers);\n+        Thread.sleep(3000);\n+\n+        admin.topics().createPartitionedTopic(persistenceTopic, 2);\n+        Consumer consumer1 = null;\n+        Consumer consumer2 = null;\n+        Consumer consumer3 = null;\n+        try {\n+            consumer1 = pulsarClient.newConsumer().subscriptionName(\"sub1\").topic(persistenceTopic).subscribe();\n+        } catch (PulsarClientException e) {\n+            Assert.fail();\n+        }\n+        try {\n+            consumer2 = pulsarClient.newConsumer().subscriptionName(\"sub2\").topic(persistenceTopic).subscribe();\n+        } catch (PulsarClientException e) {\n+            Assert.fail();\n+        }\n+        try {\n+            consumer3 = pulsarClient.newConsumer().subscriptionName(\"sub3\").topic(persistenceTopic).subscribe();\n+            Assert.fail();\n+        } catch (PulsarClientException e) {\n+            log.info(\"Topic reached max consumers limit\");\n+        }\n+        Assert.assertNotNull(consumer1);\n+        Assert.assertNotNull(consumer2);\n+        Assert.assertNull(consumer3);\n+        consumer1.close();\n+        consumer2.close();\n+\n+        Integer getMaxConsumers = admin.topics().getMaxConsumers(persistenceTopic);\n+        log.info(\"MaxConsumers {} get on topic: {}\", getMaxConsumers, persistenceTopic);\n+        Assert.assertEquals(getMaxConsumers, maxConsumers);\n+\n+        admin.topics().deletePartitionedTopic(persistenceTopic, true);\n+        admin.topics().deletePartitionedTopic(testTopic, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "550963be7652a6c428b80e17b11e99184adf8233"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80bbe5a82cfbfc0136b300099bb7352d4fcec583", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/80bbe5a82cfbfc0136b300099bb7352d4fcec583", "committedDate": "2020-09-07T07:11:33Z", "message": "Merge pull request #5 from apache/master\n\nmerge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd91059134454ea67fe0ae66903b98ca71ea20a5", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/bd91059134454ea67fe0ae66903b98ca71ea20a5", "committedDate": "2020-09-07T07:24:29Z", "message": "Merge remote-tracking branch 'origin/master' into set-max-consumer\n\n# Conflicts:\n#\tpulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916", "committedDate": "2020-09-07T07:48:49Z", "message": "bug fix."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDg5Mjk1", "url": "https://github.com/apache/pulsar/pull/7968#pullrequestreview-483489295", "createdAt": "2020-09-07T11:40:39Z", "commit": {"oid": "f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMTo0MDozOVrOHN8HbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxMTo0MTozMFrOHN8JNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODQ3Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    jcommander.addCommand(\"get-maxConsumers\", new GetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"set-maxConsumers\", new SetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"remove-maxConsumers\", new RemoveMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"get-max-consumers\", new GetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"set-max-consumers\", new SetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"remove-max-consumers\", new RemoveMaxConsumers());", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484378476", "createdAt": "2020-09-07T11:40:39Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "diffHunk": "@@ -153,6 +153,9 @@ public CmdTopics(PulsarAdmin admin) {\n         jcommander.addCommand(\"get-inactive-topic-policies\", new GetInactiveTopicPolicies());\n         jcommander.addCommand(\"set-inactive-topic-policies\", new SetInactiveTopicPolicies());\n         jcommander.addCommand(\"remove-inactive-topic-policies\", new RemoveInactiveTopicPolicies());\n+        jcommander.addCommand(\"get-maxConsumers\", new GetMaxConsumers());\n+        jcommander.addCommand(\"set-maxConsumers\", new SetMaxConsumers());\n+        jcommander.addCommand(\"remove-maxConsumers\", new RemoveMaxConsumers());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODkzNA==", "bodyText": "And please also update the max producers as the above pattern.", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484378934", "createdAt": "2020-09-07T11:41:30Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "diffHunk": "@@ -153,6 +153,9 @@ public CmdTopics(PulsarAdmin admin) {\n         jcommander.addCommand(\"get-inactive-topic-policies\", new GetInactiveTopicPolicies());\n         jcommander.addCommand(\"set-inactive-topic-policies\", new SetInactiveTopicPolicies());\n         jcommander.addCommand(\"remove-inactive-topic-policies\", new RemoveInactiveTopicPolicies());\n+        jcommander.addCommand(\"get-maxConsumers\", new GetMaxConsumers());\n+        jcommander.addCommand(\"set-maxConsumers\", new SetMaxConsumers());\n+        jcommander.addCommand(\"remove-maxConsumers\", new RemoveMaxConsumers());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODQ3Ng=="}, "originalCommit": {"oid": "f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a45400dfdfb56734a055db309815bde216ef3e1d", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/a45400dfdfb56734a055db309815bde216ef3e1d", "committedDate": "2020-09-07T12:41:21Z", "message": "rename command name."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNTUxNTM2", "url": "https://github.com/apache/pulsar/pull/7968#pullrequestreview-483551536", "createdAt": "2020-09-07T13:22:11Z", "commit": {"oid": "a45400dfdfb56734a055db309815bde216ef3e1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 170, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}