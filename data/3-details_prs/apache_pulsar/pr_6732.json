{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNjg3NDI5", "number": 6732, "title": "[C++] Auto update topic partitions", "bodyText": "Motivation\nWe need to increase producers or consumers when partitions updated.\nJava client has implemented this feature, see #3513. This PR trys to implement the same feature in C++ client.\nModifications\n\nAdd a boost::asio::deadline_timer to PartitionedConsumerImpl and PartitionedProducerImpl to register lookup task to detect partitions changes periodly;\nAdd an unsigned int configuration parameter to indicate the period seconds of detecting partitions change (default: 60 seconds);\nUnlock the mutex_ in PartitionedConsumerImpl::receive after state_ were checked.\n\n\nExplain: When new consumers are created, handleSinglePartitionConsumerCreated will be called finally, which tried to lock the mutex_. It may happen that receive acquire the lock again and again so that handleSinglePartitionConsumerCreated\nare blocked in lock.lock() for a long time.\n\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\nThis change added tests and can be verified as follows:\nRun  PartitionsUpdateTest test suite after the cmake build.\nDocumentation\n\nDoes this pull request introduce a new feature? (yes)\nIf yes, how is the feature documented? (docs)", "createdAt": "2020-04-13T15:07:23Z", "url": "https://github.com/apache/pulsar/pull/6732", "merged": true, "mergeCommit": {"oid": "30934e16eacb83c34a6691db3d9ad294d260599e"}, "closed": true, "closedAt": "2020-05-10T05:45:47Z", "author": {"login": "BewareMyPower"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV8f2VgH2gAyNDAyNjg3NDI5OjUwNmYwODA5ZmRiNjFhODEwZDg4MjkxN2NhYWM1MTFkZTViNDNiNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcf0dgzAFqTQwODcwNzI5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "506f0809fdb61a810d882917caac511de5b43b54", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/506f0809fdb61a810d882917caac511de5b43b54", "committedDate": "2020-04-09T13:27:35Z", "message": "auto update topic partitions extend for consumer and producer in c++ client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09451aec81e7c56393ed23b518d199a7edbb53b9", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/09451aec81e7c56393ed23b518d199a7edbb53b9", "committedDate": "2020-04-13T14:51:27Z", "message": "add c++ unit test for partitions update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1748bb61f163bf41aebee6070532eebadbac678d", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/1748bb61f163bf41aebee6070532eebadbac678d", "committedDate": "2020-04-14T03:09:16Z", "message": "format code with clang-format-5.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4d2a92939197bbf1fa6319eb578135de3006cb1", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/b4d2a92939197bbf1fa6319eb578135de3006cb1", "committedDate": "2020-04-15T06:35:19Z", "message": "stop partitions update timer after producer/consumer called closeAsync()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89ba47132685846f59cceeeb510868069392638e", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/89ba47132685846f59cceeeb510868069392638e", "committedDate": "2020-04-15T16:32:19Z", "message": "fix bugs when running gtest-parallel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a0b23e4f0372cd2d52f731bd9685c645fb198a3", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/6a0b23e4f0372cd2d52f731bd9685c645fb198a3", "committedDate": "2020-04-14T15:30:11Z", "message": "stop partitions update timer after producer/consumer called closeAsync()"}, "afterCommit": {"oid": "89ba47132685846f59cceeeb510868069392638e", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/89ba47132685846f59cceeeb510868069392638e", "committedDate": "2020-04-15T16:32:19Z", "message": "fix bugs when running gtest-parallel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NzYzMzAy", "url": "https://github.com/apache/pulsar/pull/6732#pullrequestreview-394763302", "createdAt": "2020-04-16T15:42:58Z", "commit": {"oid": "6b2e55ef9d074a86a9ff619b71ae0ca24b187dd6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo0Mjo1OFrOGGrlxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo0Mjo1OFrOGGrlxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY1ODgyMQ==", "bodyText": "Could this change be avoid? Seems brings in lot of un-needed changes, also a little confusing to made numPartitions_ and numPartitions mix-used together in this file.", "url": "https://github.com/apache/pulsar/pull/6732#discussion_r409658821", "createdAt": "2020-04-16T15:42:58Z", "author": {"login": "jiazhai"}, "path": "pulsar-client-cpp/lib/PartitionedConsumerImpl.cc", "diffHunk": "@@ -162,14 +174,17 @@ void PartitionedConsumerImpl::handleUnsubscribeAsync(Result result, unsigned int\n         callback(ResultUnknownError);\n         return;\n     }\n-    assert(unsubscribedSoFar_ <= numPartitions_);\n-    assert(consumerIndex <= numPartitions_);\n+    Lock consumersLock(consumersMutex_);\n+    const auto numPartitions = numPartitions_;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b2e55ef9d074a86a9ff619b71ae0ca24b187dd6"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9de457a44fdf4c3369069b1f81fd01a9d5978c48", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/9de457a44fdf4c3369069b1f81fd01a9d5978c48", "committedDate": "2020-04-17T14:23:16Z", "message": "fix bug: Producer::flush() may cause deadlock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3", "committedDate": "2020-04-17T17:58:02Z", "message": "use getters to read `numPartitions` with or without lock"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b2e55ef9d074a86a9ff619b71ae0ca24b187dd6", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/6b2e55ef9d074a86a9ff619b71ae0ca24b187dd6", "committedDate": "2020-04-16T13:32:33Z", "message": "disable partitions update by default"}, "afterCommit": {"oid": "657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3", "committedDate": "2020-04-17T17:58:02Z", "message": "use getters to read `numPartitions` with or without lock"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3", "committedDate": "2020-04-17T17:58:02Z", "message": "use getters to read `numPartitions` with or without lock"}, "afterCommit": {"oid": "9de457a44fdf4c3369069b1f81fd01a9d5978c48", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/9de457a44fdf4c3369069b1f81fd01a9d5978c48", "committedDate": "2020-04-17T14:23:16Z", "message": "fix bug: Producer::flush() may cause deadlock"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9de457a44fdf4c3369069b1f81fd01a9d5978c48", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/9de457a44fdf4c3369069b1f81fd01a9d5978c48", "committedDate": "2020-04-17T14:23:16Z", "message": "fix bug: Producer::flush() may cause deadlock"}, "afterCommit": {"oid": "89ba47132685846f59cceeeb510868069392638e", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/89ba47132685846f59cceeeb510868069392638e", "committedDate": "2020-04-15T16:32:19Z", "message": "fix bugs when running gtest-parallel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzA3Mjkx", "url": "https://github.com/apache/pulsar/pull/6732#pullrequestreview-408707291", "createdAt": "2020-05-10T05:45:02Z", "commit": {"oid": "657269cdc651c5ffe4cfd0ab4bf5b44dfabffdd3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4934, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}