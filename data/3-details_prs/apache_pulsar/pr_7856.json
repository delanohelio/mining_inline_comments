{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNjA0MzQx", "number": 7856, "title": "[Transaction] Handle Acknowledge In The Transaction", "bodyText": "Fix streamnative#1307\nMaster Issue: #2664\nMotivation\nHandle acknowledge in the transaction.\nModifications\n\nRegister subscription to the transaction metadata store.\nMake the ack command carry the transaction information.\nWhen committing a transaction, commit every subscription in the transaction.\n\nVerifying this change\nThis change added tests and can be verified as follows:\n\norg.apache.pulsar.broker.transaction.TransactionProduceTest.ackCommitTest\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (yes)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)\nIf a feature is not applicable for documentation, explain why?\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-08-20T03:01:42Z", "url": "https://github.com/apache/pulsar/pull/7856", "merged": true, "mergeCommit": {"oid": "1fdffe753bcc6ebe2c7888234cdd7ccd12766250"}, "closed": true, "closedAt": "2020-09-04T06:07:20Z", "author": {"login": "gaoran10"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAxnSpABqjM2NzU3MTk0OTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFc_75AFqTQ4MjMzOTE5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "429d5aecb09175244e6bbe1366fdb44e952ee350", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/429d5aecb09175244e6bbe1366fdb44e952ee350", "committedDate": "2020-08-20T03:36:29Z", "message": "fix test"}, "afterCommit": {"oid": "40bb0803a3d2c49a0125a821d41f8ae1a88bf172", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/40bb0803a3d2c49a0125a821d41f8ae1a88bf172", "committedDate": "2020-08-20T15:04:46Z", "message": "fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b7d11fe2ebe8aa79efffc495129ef5f2a89ba36", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/3b7d11fe2ebe8aa79efffc495129ef5f2a89ba36", "committedDate": "2020-08-24T10:19:55Z", "message": "fix"}, "afterCommit": {"oid": "048cf9eceea2be60fa9afe0d823d36e2a780b50e", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/048cf9eceea2be60fa9afe0d823d36e2a780b50e", "committedDate": "2020-08-31T13:28:22Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwODUzNTM0", "url": "https://github.com/apache/pulsar/pull/7856#pullrequestreview-480853534", "createdAt": "2020-09-02T14:03:57Z", "commit": {"oid": "7e070703af2a8c713001cae746de50612c42d00b"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNDowMzo1N1rOHLwuDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNDoyNToyOVrOHLxt4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5NDYwNQ==", "bodyText": "The method will return before processing the add subscription to the txn, is this an expected behavior?", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482094605", "createdAt": "2020-09-02T14:03:57Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/transaction/TransactionCoordinatorClientImpl.java", "diffHunk": "@@ -176,6 +178,30 @@ public void addPublishPartitionToTxn(TxnID txnID, List<String> partitions) throw\n         return handler.addPublishPartitionToTxnAsync(txnID, partitions);\n     }\n \n+    @Override\n+    public void addSubscriptionToTxn(TxnID txnID, String topic, String subscription)\n+            throws TransactionCoordinatorClientException {\n+        try {\n+            addSubscriptionToTxnAsync(txnID, topic, subscription);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e070703af2a8c713001cae746de50612c42d00b"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5NTMzMA==", "bodyText": "The Singleton list is more suitable here. Or maybe you add a thread-local list to avoid introduce many list instance", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482095330", "createdAt": "2020-09-02T14:04:57Z", "author": {"login": "codelipenghui"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/transaction/TransactionCoordinatorClientImpl.java", "diffHunk": "@@ -176,6 +178,30 @@ public void addPublishPartitionToTxn(TxnID txnID, List<String> partitions) throw\n         return handler.addPublishPartitionToTxnAsync(txnID, partitions);\n     }\n \n+    @Override\n+    public void addSubscriptionToTxn(TxnID txnID, String topic, String subscription)\n+            throws TransactionCoordinatorClientException {\n+        try {\n+            addSubscriptionToTxnAsync(txnID, topic, subscription);\n+        } catch (Exception e) {\n+            throw TransactionCoordinatorClientException.unwrap(e);\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<Void> addSubscriptionToTxnAsync(TxnID txnID, String topic, String subscription) {\n+        TransactionMetaStoreHandler handler = handlerMap.get(txnID.getMostSigBits());\n+        if (handler == null) {\n+            return FutureUtil.failedFuture(\n+                    new TransactionCoordinatorClientException.MetaStoreHandlerNotExistsException(txnID.getMostSigBits()));\n+        }\n+        PulsarApi.Subscription sub = PulsarApi.Subscription.newBuilder()\n+                .setTopic(topic)\n+                .setSubscription(subscription)\n+                .build();\n+        return handler.addSubscriptionToTxn(txnID, Lists.newArrayList(sub));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e070703af2a8c713001cae746de50612c42d00b"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5OTc2Ng==", "bodyText": "Why remove this branch?", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482099766", "createdAt": "2020-09-02T14:10:45Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/TransactionMetadataStoreService.java", "diffHunk": "@@ -207,26 +208,39 @@ public void removeTransactionMetadataStore(TransactionCoordinatorID tcId) {\n \n     private CompletableFuture<Void> endToTB(TxnID txnID, TxnStatus newStatus) {\n         CompletableFuture<Void> resultFuture = new CompletableFuture<>();\n-        List<CompletableFuture<TxnID>> commitFutureList = new ArrayList<>();\n+        List<CompletableFuture<TxnID>> completableFutureList = new ArrayList<>();\n         this.getTxnMeta(txnID).whenComplete((txnMeta, throwable) -> {\n             if (throwable != null) {\n                 resultFuture.completeExceptionally(throwable);\n                 return;\n             }\n+\n+            txnMeta.ackedPartitions().forEach(tbSub -> {\n+                CompletableFuture<TxnID> commitFuture = new CompletableFuture<>();\n+                if (TxnStatus.COMMITTING.equals(newStatus)) {\n+                    commitFuture = tbClient.commitTxnOnSubscription(\n+                            tbSub.getTopic(), tbSub.getSubscription(), txnID.getMostSigBits(), txnID.getLeastSigBits());\n+                } else if (TxnStatus.ABORTING.equals(newStatus)) {\n+                    commitFuture = tbClient.abortTxnOnSubscription(\n+                            tbSub.getTopic(), tbSub.getSubscription(), txnID.getMostSigBits(), txnID.getLeastSigBits());\n+                }\n+                completableFutureList.add(commitFuture);\n+            });\n+\n             txnMeta.producedPartitions().forEach(partition -> {\n                 CompletableFuture<TxnID> commitFuture = new CompletableFuture<>();\n                 if (TxnStatus.COMMITTING.equals(newStatus)) {\n                     commitFuture = tbClient.commitTxnOnTopic(partition, txnID.getMostSigBits(), txnID.getLeastSigBits());\n+                    // TODO commitTxnOnSubscription\n                 } else if (TxnStatus.ABORTING.equals(newStatus)) {\n+                    // TODO abortTxnOnTopic\n                     commitFuture.completeExceptionally(new Throwable(\"Unsupported operation.\"));\n-                } else {\n-                    // Unsupported txnStatus\n-                    commitFuture.completeExceptionally(new Throwable(\"Unsupported txnStatus.\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e070703af2a8c713001cae746de50612c42d00b"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjEwNDExMg==", "bodyText": "Is this a useful change?", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482104112", "createdAt": "2020-09-02T14:16:34Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentSubscription.java", "diffHunk": "@@ -1197,8 +1207,8 @@ public void deleteFailed(ManagedLedgerException exception, Object ctx) {\n         // Reset txdID and position for cumulative ack.\n         PENDING_CUMULATIVE_ACK_TXNID_UPDATER.set(this, null);\n         POSITION_UPDATER.set(this, null);\n-        dispatcher.redeliverUnacknowledgedMessages(consumer, (List<PositionImpl>)\n-                                                                    (List<?>)pendingAckMessageForCurrentTxn.values());\n+//        dispatcher.redeliverUnacknowledgedMessages(consumer, (List<PositionImpl>)\n+//                                                                    (List<?>)pendingAckMessageForCurrentTxn.values());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e070703af2a8c713001cae746de50612c42d00b"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjExMDk0Ng==", "bodyText": "There is the same struct in PulsarApi.proto named Subscription, maybe you can use that one directly.", "url": "https://github.com/apache/pulsar/pull/7856#discussion_r482110946", "createdAt": "2020-09-02T14:25:29Z", "author": {"login": "codelipenghui"}, "path": "pulsar-transaction/coordinator/src/main/java/org/apache/pulsar/transaction/coordinator/TransactionSubscription.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.transaction.coordinator;\n+\n+import com.google.common.base.Objects;\n+import lombok.Builder;\n+import lombok.Data;\n+\n+/**\n+ * A class for representing acked topic subscription info.\n+ */\n+@Data\n+@Builder\n+public class TransactionSubscription implements Comparable<TransactionSubscription> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e070703af2a8c713001cae746de50612c42d00b"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b2bfacca0225c09b36fe690e95a0b16a48dab0a", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/8b2bfacca0225c09b36fe690e95a0b16a48dab0a", "committedDate": "2020-09-03T02:35:47Z", "message": "handle acknowledge in transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bbefc1178d3eebfa73d8ad310d9a98fee283273", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/1bbefc1178d3eebfa73d8ad310d9a98fee283273", "committedDate": "2020-09-03T02:35:48Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78d6ccdae776b918590b5f6001e264b112d46d2f", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/78d6ccdae776b918590b5f6001e264b112d46d2f", "committedDate": "2020-09-03T02:35:48Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3f6995bdc21989210cb8ef2e73158cdc4c084b0", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/e3f6995bdc21989210cb8ef2e73158cdc4c084b0", "committedDate": "2020-09-03T02:35:48Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44c2872c86a26c36c4bc5fa2989cd41dfcd507d5", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/44c2872c86a26c36c4bc5fa2989cd41dfcd507d5", "committedDate": "2020-09-03T02:39:30Z", "message": "change ack subscriptions in MetaImpl from `String` to `TransactionSubscription`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aed77c3a2209f6abfb41759abe1feb72cda5d812", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/aed77c3a2209f6abfb41759abe1feb72cda5d812", "committedDate": "2020-09-03T02:40:40Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abb3fccc992f9c891c80f60c2d03bd69ef4da023", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/abb3fccc992f9c891c80f60c2d03bd69ef4da023", "committedDate": "2020-09-03T02:40:40Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fee6b363f8ba6a43eb64b3f55ce67806d572626", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/8fee6b363f8ba6a43eb64b3f55ce67806d572626", "committedDate": "2020-09-03T02:40:40Z", "message": "fix check style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "105b064b4737569a82a1591c464b45ef73fd1b9d", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/105b064b4737569a82a1591c464b45ef73fd1b9d", "committedDate": "2020-09-03T02:40:40Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb9ddf0f3e48dec97e7035e9478b187ec280b7cf", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/fb9ddf0f3e48dec97e7035e9478b187ec280b7cf", "committedDate": "2020-09-03T10:39:51Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e070703af2a8c713001cae746de50612c42d00b", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/7e070703af2a8c713001cae746de50612c42d00b", "committedDate": "2020-08-31T17:44:42Z", "message": "fix test"}, "afterCommit": {"oid": "fb9ddf0f3e48dec97e7035e9478b187ec280b7cf", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/fb9ddf0f3e48dec97e7035e9478b187ec280b7cf", "committedDate": "2020-09-03T10:39:51Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzM5MTkz", "url": "https://github.com/apache/pulsar/pull/7856#pullrequestreview-482339193", "createdAt": "2020-09-04T03:54:02Z", "commit": {"oid": "fb9ddf0f3e48dec97e7035e9478b187ec280b7cf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 321, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}