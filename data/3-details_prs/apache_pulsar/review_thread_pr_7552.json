{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5ODU4NzEx", "number": 7552, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMzoxMjo0NlrOEP7bJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMzozMDo1M1rOETQUFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MTM3NzAxOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMzoxMjo0NlrOGz1lxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOToxNTo1OFrOG4a06w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAwODU4MA==", "bodyText": "It's better to config in the broker.conf.", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r457008580", "createdAt": "2020-07-20T03:12:46Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -549,6 +552,9 @@ public Boolean get() {\n                 transactionMetadataStoreService = new TransactionMetadataStoreService(TransactionMetadataStoreProvider\n                         .newProvider(config.getTransactionMetadataStoreProviderClassName()), this);\n                 transactionMetadataStoreService.start();\n+\n+                transactionBufferProvider = TransactionBufferProvider.newProvider(\n+                        PersistentTransactionBufferProvider.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd4bdb16433a3c4a44da08387b773cb867a99e3e"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgxMjk3MQ==", "bodyText": "Ok, I'll fix it.", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r461812971", "createdAt": "2020-07-28T19:15:58Z", "author": {"login": "gaoran10"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -549,6 +552,9 @@ public Boolean get() {\n                 transactionMetadataStoreService = new TransactionMetadataStoreService(TransactionMetadataStoreProvider\n                         .newProvider(config.getTransactionMetadataStoreProviderClassName()), this);\n                 transactionMetadataStoreService.start();\n+\n+                transactionBufferProvider = TransactionBufferProvider.newProvider(\n+                        PersistentTransactionBufferProvider.class.getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAwODU4MA=="}, "originalCommit": {"oid": "cd4bdb16433a3c4a44da08387b773cb867a99e3e"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTc1ODU3OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDowMToxMVrOG4OCFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOToxNzowNVrOG4a46Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwMzM0OQ==", "bodyText": "It's better to handle the transaction message in the topic, not the server cnx.", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r461603349", "createdAt": "2020-07-28T14:01:11Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1212,6 +1221,33 @@ protected void handleSend(CommandSend send, ByteBuf headersAndPayload) {\n \n         startSendOperation(producer, headersAndPayload.readableBytes(), send.getNumMessages());\n \n+        final long produceId = producer.getProducerId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce460c90dddd9da8b4aa44ea03a700de0e27fa82"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgxMzk5Mw==", "bodyText": "Yes, that's more reasonable.", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r461813993", "createdAt": "2020-07-28T19:17:05Z", "author": {"login": "gaoran10"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1212,6 +1221,33 @@ protected void handleSend(CommandSend send, ByteBuf headersAndPayload) {\n \n         startSendOperation(producer, headersAndPayload.readableBytes(), send.getNumMessages());\n \n+        final long produceId = producer.getProducerId();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwMzM0OQ=="}, "originalCommit": {"oid": "ce460c90dddd9da8b4aa44ea03a700de0e27fa82"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NjI1Njg2OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMzozMDo1M1rOG44hlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNzoxMzoxMlrOG5CI2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5OTU0Mg==", "bodyText": "We should handle it in the TC and TC should retry to make sure the TB can handle success.", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r462299542", "createdAt": "2020-07-29T13:30:53Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1674,40 +1687,134 @@ protected void handleAddPartitionToTxn(PulsarApi.CommandAddPartitionToTxn comman\n \n     @Override\n     protected void handleEndTxn(PulsarApi.CommandEndTxn command) {\n-        TxnStatus newStatus = null;\n+        TxnID txnID = new TxnID(command.getTxnidMostBits(), command.getTxnidLeastBits());\n+        final TxnStatus newStatus;\n         switch (command.getTxnAction()) {\n             case COMMIT:\n                 newStatus = TxnStatus.COMMITTING;\n                 break;\n             case ABORT:\n                 newStatus = TxnStatus.ABORTING;\n                 break;\n+            default:\n+                UnsupportedTxnActionException exception =\n+                        new UnsupportedTxnActionException(txnID, command.getTxnAction());\n+                log.error(exception.getMessage());\n+                ctx.writeAndFlush(Commands.newEndTxnResponse(command.getRequestId(), txnID.getMostSigBits(),\n+                        BrokerServiceException.getClientErrorCode(exception), exception.getMessage()));\n+                return;\n         }\n-        TxnID txnID = new TxnID(command.getTxnidMostBits(), command.getTxnidLeastBits());\n         if (log.isDebugEnabled()) {\n             log.debug(\"Receive end txn by {} request {} from {} with txnId {}\", newStatus, command.getRequestId(), remoteAddress, txnID);\n         }\n+        final long requestId = command.getRequestId();\n         service.pulsar().getTransactionMetadataStoreService().updateTxnStatus(txnID, newStatus, TxnStatus.OPEN)\n-            .whenComplete((v, ex) -> {\n-                if (ex == null) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(\"Send response success for end txn request {}\", command.getRequestId());\n-                    }\n-                    ctx.writeAndFlush(Commands.newEndTxnResponse(command.getRequestId(),\n+            .thenRun(() -> {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Send response success for end txn request {}\", command.getRequestId());\n+                }\n+                updateTBStatus(txnID, newStatus).thenRun(() -> {\n+                    service.pulsar().getTransactionMetadataStoreService()\n+                            .updateTxnStatus(txnID, TxnStatus.COMMITTED, TxnStatus.COMMITTING);\n+                    ctx.writeAndFlush(Commands.newEndTxnResponse(requestId,\n                             txnID.getLeastSigBits(), txnID.getMostSigBits()));\n+                }).exceptionally(throwable -> {\n+                    log.error(\"Failed to get txn `\" + txnID + \"` txnMeta.\", throwable);\n+                    ctx.writeAndFlush(Commands.newEndTxnResponse(requestId, txnID.getMostSigBits(),\n+                            BrokerServiceException.getClientErrorCode(throwable), throwable.getMessage()));\n+                    return null;\n+                });\n+            }).exceptionally(throwable -> {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Send response error for end txn request {}\", command.getRequestId());\n+                }\n+                ctx.writeAndFlush(Commands.newEndTxnResponse(command.getRequestId(), txnID.getMostSigBits(),\n+                        BrokerServiceException.getClientErrorCode(throwable), throwable.getMessage()));\n+                return null;\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00ea5fbc17e40a98f459d820998c608b3540c895"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ1NzA1MQ==", "bodyText": "Yes, I'll fix this.", "url": "https://github.com/apache/pulsar/pull/7552#discussion_r462457051", "createdAt": "2020-07-29T17:13:12Z", "author": {"login": "gaoran10"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1674,40 +1687,134 @@ protected void handleAddPartitionToTxn(PulsarApi.CommandAddPartitionToTxn comman\n \n     @Override\n     protected void handleEndTxn(PulsarApi.CommandEndTxn command) {\n-        TxnStatus newStatus = null;\n+        TxnID txnID = new TxnID(command.getTxnidMostBits(), command.getTxnidLeastBits());\n+        final TxnStatus newStatus;\n         switch (command.getTxnAction()) {\n             case COMMIT:\n                 newStatus = TxnStatus.COMMITTING;\n                 break;\n             case ABORT:\n                 newStatus = TxnStatus.ABORTING;\n                 break;\n+            default:\n+                UnsupportedTxnActionException exception =\n+                        new UnsupportedTxnActionException(txnID, command.getTxnAction());\n+                log.error(exception.getMessage());\n+                ctx.writeAndFlush(Commands.newEndTxnResponse(command.getRequestId(), txnID.getMostSigBits(),\n+                        BrokerServiceException.getClientErrorCode(exception), exception.getMessage()));\n+                return;\n         }\n-        TxnID txnID = new TxnID(command.getTxnidMostBits(), command.getTxnidLeastBits());\n         if (log.isDebugEnabled()) {\n             log.debug(\"Receive end txn by {} request {} from {} with txnId {}\", newStatus, command.getRequestId(), remoteAddress, txnID);\n         }\n+        final long requestId = command.getRequestId();\n         service.pulsar().getTransactionMetadataStoreService().updateTxnStatus(txnID, newStatus, TxnStatus.OPEN)\n-            .whenComplete((v, ex) -> {\n-                if (ex == null) {\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(\"Send response success for end txn request {}\", command.getRequestId());\n-                    }\n-                    ctx.writeAndFlush(Commands.newEndTxnResponse(command.getRequestId(),\n+            .thenRun(() -> {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Send response success for end txn request {}\", command.getRequestId());\n+                }\n+                updateTBStatus(txnID, newStatus).thenRun(() -> {\n+                    service.pulsar().getTransactionMetadataStoreService()\n+                            .updateTxnStatus(txnID, TxnStatus.COMMITTED, TxnStatus.COMMITTING);\n+                    ctx.writeAndFlush(Commands.newEndTxnResponse(requestId,\n                             txnID.getLeastSigBits(), txnID.getMostSigBits()));\n+                }).exceptionally(throwable -> {\n+                    log.error(\"Failed to get txn `\" + txnID + \"` txnMeta.\", throwable);\n+                    ctx.writeAndFlush(Commands.newEndTxnResponse(requestId, txnID.getMostSigBits(),\n+                            BrokerServiceException.getClientErrorCode(throwable), throwable.getMessage()));\n+                    return null;\n+                });\n+            }).exceptionally(throwable -> {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"Send response error for end txn request {}\", command.getRequestId());\n+                }\n+                ctx.writeAndFlush(Commands.newEndTxnResponse(command.getRequestId(), txnID.getMostSigBits(),\n+                        BrokerServiceException.getClientErrorCode(throwable), throwable.getMessage()));\n+                return null;\n+        });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI5OTU0Mg=="}, "originalCommit": {"oid": "00ea5fbc17e40a98f459d820998c608b3540c895"}, "originalPosition": 154}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2479, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}