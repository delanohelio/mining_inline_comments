{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MzQ3MzQ0", "number": 7319, "title": "Fix producer stucks on creating ledger timeout", "bodyText": "Motivation\nThe ledgerCreated flag is passed as ctx to the createLedger callback.\nThe callback already had the logic on handling ledgerCreated flag. But we set the flag to false\nwhen timeout happens. It will trigger the following race condition:\na) The createComplete callback is triggered when timeout. But the pending add requests are not error'd out.\nb) If the createComplete callback eventually completes, it will see ledgerCreated flag is set to true,\nso it will cause checkAndCompleteLedgerOpTask returns false and exist too early without processing the\npending add requests.\nThis race condition only happens when creating ledger times out.\n    public synchronized void createComplete(int rc, final LedgerHandle lh, Object ctx) {\n        if (log.isDebugEnabled()) {\n            log.debug(\"[{}] createComplete rc={} ledger={}\", name, rc, lh != null ? lh.getId() : -1);\n        }\n\n        if (checkAndCompleteLedgerOpTask(rc, lh, ctx)) {\n            return;\n        }\n\nModification\nThe timeout logic shouldn't modify the ledgerCreated context. It should let the callback itself to process\nthe ledgerCreated context.", "createdAt": "2020-06-20T01:33:36Z", "url": "https://github.com/apache/pulsar/pull/7319", "merged": true, "mergeCommit": {"oid": "a34f6939f0aa639c37192ea0c9bc7b927a245664"}, "closed": true, "closedAt": "2020-06-22T20:32:29Z", "author": {"login": "sijie"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcs9asdgH2gAyNDM3MzQ3MzQ0OjhkYzZiNTRiZTA1NGI1YTUwZDQzYTA0MWZlMjc4OTZiYmQ1YmU5MjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABct1-UtgFqTQzNTIxMDMyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8dc6b54be054b5a50d43a041fe27896bbd5be924", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/8dc6b54be054b5a50d43a041fe27896bbd5be924", "committedDate": "2020-06-20T01:32:07Z", "message": "Fix producer stucks on creating ledger timeout\n\n*Motivation*\n\nThe `ledgerCreated` flag is passed as ctx to the createLedger callback.\nThe callback already had the logic on handling `ledgerCreated` flag. But we set the flag to `false`\nwhen timeout happens. It will trigger the following race condition:\n\na) The createComplete callback is triggered when timeout. But the pending add requests are not error'd out.\nb) If the createComplete callback eventually completes, it will see `ledgerCreated` flag is set to true,\nso it will cause `checkAndCompleteLedgerOpTask` returns false and exist too early without processing the\npending add requests.\n\nThis race condition only happens when creating ledger times out.\n\n```\n    public synchronized void createComplete(int rc, final LedgerHandle lh, Object ctx) {\n        if (log.isDebugEnabled()) {\n            log.debug(\"[{}] createComplete rc={} ledger={}\", name, rc, lh != null ? lh.getId() : -1);\n        }\n\n        if (checkAndCompleteLedgerOpTask(rc, lh, ctx)) {\n            return;\n        }\n```\n\n*Modification*\n\nThe timeout logic shouldn't modify the `ledgerCreated` context. It should let the callback itself to process\nthe `ledgerCreated` context."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0Mzk2NzY3", "url": "https://github.com/apache/pulsar/pull/7319#pullrequestreview-434396767", "createdAt": "2020-06-20T02:41:07Z", "commit": {"oid": "8dc6b54be054b5a50d43a041fe27896bbd5be924"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDAyNTk4", "url": "https://github.com/apache/pulsar/pull/7319#pullrequestreview-434402598", "createdAt": "2020-06-20T04:41:44Z", "commit": {"oid": "8dc6b54be054b5a50d43a041fe27896bbd5be924"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQwNDo0MTo0NFrOGmkvAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQwNDo0MTo0NFrOGmkvAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwMDkzMQ==", "bodyText": "Wouldn't there be a race condition here (also in existing code) if the creation completes at the same time that the timeout is triggered?", "url": "https://github.com/apache/pulsar/pull/7319#discussion_r443100931", "createdAt": "2020-06-20T04:41:44Z", "author": {"login": "merlimat"}, "path": "managed-ledger/src/main/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerImpl.java", "diffHunk": "@@ -3177,8 +3177,7 @@ protected void asyncCreateLedger(BookKeeper bookKeeper, ManagedLedgerConfig conf\n                 digestType, config.getPassword(), cb, ledgerCreated, finalMetadata);\n         scheduledExecutor.schedule(() -> {\n             if (!ledgerCreated.get()) {\n-                ledgerCreated.set(true);\n-                cb.createComplete(BKException.Code.TimeoutException, null, null);\n+                cb.createComplete(BKException.Code.TimeoutException, null, ledgerCreated);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dc6b54be054b5a50d43a041fe27896bbd5be924"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDA0Mjcx", "url": "https://github.com/apache/pulsar/pull/7319#pullrequestreview-434404271", "createdAt": "2020-06-20T05:21:25Z", "commit": {"oid": "8dc6b54be054b5a50d43a041fe27896bbd5be924"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "705dba0bef4a5a6f26b9dea2405dd9dbc2859681", "author": {"user": {"login": "sijie", "name": "Sijie Guo"}}, "url": "https://github.com/apache/pulsar/commit/705dba0bef4a5a6f26b9dea2405dd9dbc2859681", "committedDate": "2020-06-22T06:06:07Z", "message": "Change to use CAS"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MjAzODQ2", "url": "https://github.com/apache/pulsar/pull/7319#pullrequestreview-435203846", "createdAt": "2020-06-22T19:15:09Z", "commit": {"oid": "705dba0bef4a5a6f26b9dea2405dd9dbc2859681"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MjEwMzIx", "url": "https://github.com/apache/pulsar/pull/7319#pullrequestreview-435210321", "createdAt": "2020-06-22T19:25:43Z", "commit": {"oid": "705dba0bef4a5a6f26b9dea2405dd9dbc2859681"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 715, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}