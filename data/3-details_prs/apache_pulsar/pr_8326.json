{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NDAyMDgy", "number": 8326, "title": "[Issue 8300][Java client] Support cancelling message & batch futures returned from Reader & Consumer", "bodyText": "Fixes #8300, #8307\nMotivation\nExplained in #8300\nModifications\nThe futures returned by org.apache.pulsar.client.api.Reader.readNextAsync, org.apache.pulsar.client.api.Consumer.receiveAsync and org.apache.pulsar.client.api.Consumer.batchReceiveAsync methods\nreturn a CompletableFuture that contains a \"whenComplete\" callback which handles CancellationException & TimeoutException . The callback action will remove the registered futures from the internal \"pendingReceives\" and \"pendingBatchReceives\" futures.\nThe changes attempt to also against possible race conditions that could happen when cancellation and a message get received at the exactly same moment and the future removed from the queue has already been cancelled.\nWhile adding unit tests, some minor refactoring was made to start adding a ClientTestFixtures class that would make it easier to share some test mocks that are used in the client internal unit tests. The intention of this change was to start lowering the barrier for adding better test coverage for further changes.\nVerifying this change\nUnit tests have been added to verify that cancelling message & batch futures remove the future from the internal \"pendingReceives\" and \"pendingBatchReceives\" queues.\nDocumentation\n\nDoes this pull request introduce a new feature? yes\nIf yes, how is the feature documented? JavaDocs", "createdAt": "2020-10-21T09:46:50Z", "url": "https://github.com/apache/pulsar/pull/8326", "merged": true, "mergeCommit": {"oid": "11d4d077f5bb009297b32e19b3eb1ace3660d0c5"}, "closed": true, "closedAt": "2020-10-26T08:13:17Z", "author": {"login": "lhotari"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUqAkIgH2gAyNTA3NDAyMDgyOjhjMmMzNDJmMmI0MTc4ZWQ4ZDUxOWViNmI4ZDJiYjFlYzU4ZTkzZmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVtDw2gFqTUxNjI4NjQ0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8c2c342f2b4178ed8d519eb6b8d2bb1ec58e93fe", "author": {"user": {"login": "lhotari", "name": "Lari Hotari"}}, "url": "https://github.com/apache/pulsar/commit/8c2c342f2b4178ed8d519eb6b8d2bb1ec58e93fe", "committedDate": "2020-10-21T09:32:21Z", "message": "Support cancelling message & batch futures returned from Reader & Consumer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e930cbab8ed9ab2e99178be63158127dfe37d71d", "author": {"user": {"login": "lhotari", "name": "Lari Hotari"}}, "url": "https://github.com/apache/pulsar/commit/e930cbab8ed9ab2e99178be63158127dfe37d71d", "committedDate": "2020-10-21T11:36:26Z", "message": "Add javadocs for message/batch future cancellation support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed75728419e6c957a16cb7782843e70ddbaa254e", "author": {"user": {"login": "lhotari", "name": "Lari Hotari"}}, "url": "https://github.com/apache/pulsar/commit/ed75728419e6c957a16cb7782843e70ddbaa254e", "committedDate": "2020-10-21T10:07:03Z", "message": "Add javadocs for message/batch future cancellation support"}, "afterCommit": {"oid": "e930cbab8ed9ab2e99178be63158127dfe37d71d", "author": {"user": {"login": "lhotari", "name": "Lari Hotari"}}, "url": "https://github.com/apache/pulsar/commit/e930cbab8ed9ab2e99178be63158127dfe37d71d", "committedDate": "2020-10-21T11:36:26Z", "message": "Add javadocs for message/batch future cancellation support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68e9fe9daae857b82dfc00379092426ff0816087", "author": {"user": {"login": "lhotari", "name": "Lari Hotari"}}, "url": "https://github.com/apache/pulsar/commit/68e9fe9daae857b82dfc00379092426ff0816087", "committedDate": "2020-10-21T11:54:29Z", "message": "Fix license headers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNzUwMDA3", "url": "https://github.com/apache/pulsar/pull/8326#pullrequestreview-513750007", "createdAt": "2020-10-21T14:27:30Z", "commit": {"oid": "68e9fe9daae857b82dfc00379092426ff0816087"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDoyNzozMFrOHlvX-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDoyNzozMFrOHlvX-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzNTU0NA==", "bodyText": "this seems to fix #8307", "url": "https://github.com/apache/pulsar/pull/8326#discussion_r509335544", "createdAt": "2020-10-21T14:27:30Z", "author": {"login": "lhotari"}, "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/ConsumerBase.java", "diffHunk": "@@ -733,9 +821,11 @@ private void pendingBatchReceiveTask(Timeout timeout) throws Exception {\n                 if (diff <= 0) {\n                     // The diff is less than or equal to zero, meaning that the batch receive has been timed out.\n                     // complete the OpBatchReceive and continue to check the next OpBatchReceive in pendingBatchReceives.\n-                    OpBatchReceive<T> op = pendingBatchReceives.poll();\n-                    completeOpBatchReceive(op);\n-                    firstOpBatchReceive = pendingBatchReceives.peek();\n+                    OpBatchReceive<T> op = pollNextBatchReceive();\n+                    if (op != null) {\n+                        completeOpBatchReceive(op);\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68e9fe9daae857b82dfc00379092426ff0816087"}, "originalPosition": 168}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NjE5NTI5", "url": "https://github.com/apache/pulsar/pull/8326#pullrequestreview-515619529", "createdAt": "2020-10-23T12:28:57Z", "commit": {"oid": "68e9fe9daae857b82dfc00379092426ff0816087"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2Mjg2NDQx", "url": "https://github.com/apache/pulsar/pull/8326#pullrequestreview-516286441", "createdAt": "2020-10-24T15:39:29Z", "commit": {"oid": "68e9fe9daae857b82dfc00379092426ff0816087"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1274, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}