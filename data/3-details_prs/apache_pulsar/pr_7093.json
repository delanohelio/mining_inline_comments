{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0OTA1MjU5", "number": 7093, "title": "Add control of single topic gc in inactive state.", "bodyText": "Motivation\nThe brokerDeleteInactiveTopicsEnabled parameter is effect to all Topics, but in some cases like topic created by protocol handler, we need keep some topics not be deleted even if they're in inactive state.\nModifications\nAdd deleteWhileInactive parameter in AbstractTopic, and when create a new topic,  we can call topic.setDeleteWhileInactive(false) to keep the topic not be deleted by GC.", "createdAt": "2020-05-29T06:07:32Z", "url": "https://github.com/apache/pulsar/pull/7093", "merged": true, "mergeCommit": {"oid": "88babcc8331508b5c8becc6e216d7c293b4cb86e"}, "closed": true, "closedAt": "2020-06-04T05:05:07Z", "author": {"login": "zhanghaou"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcl56-SgH2gAyNDI0OTA1MjU5OmQ4NjAzZDc1YjcxNGI5YTNhODdiY2YzN2QwOTFkOGViOTk4ZWZiMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn0qp9gFqTQyNDA2MDEwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d8603d75b714b9a3a87bcf37d091d8eb998efb2f", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/d8603d75b714b9a3a87bcf37d091d8eb998efb2f", "committedDate": "2020-05-29T03:30:17Z", "message": "Add control of single topic gc in inactive state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f0fc6a549a8bfbf1ff03aa68b5355149f22cd18", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/6f0fc6a549a8bfbf1ff03aa68b5355149f22cd18", "committedDate": "2020-05-29T10:26:22Z", "message": "use original name of parameter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478fb75c18ed95c25acf571988a81c01c2c852b1", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/478fb75c18ed95c25acf571988a81c01c2c852b1", "committedDate": "2020-05-29T10:28:51Z", "message": "add getter and setter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "committedDate": "2020-05-29T10:33:12Z", "message": "change notes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMjQzNzMw", "url": "https://github.com/apache/pulsar/pull/7093#pullrequestreview-421243730", "createdAt": "2020-05-29T19:47:24Z", "commit": {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMzU0NDc5", "url": "https://github.com/apache/pulsar/pull/7093#pullrequestreview-421354479", "createdAt": "2020-05-30T00:01:08Z", "commit": {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDowMTowOFrOGcvO6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQwMDowMTowOFrOGcvO6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NzE3OQ==", "bodyText": "How is this supposed to be activated?\nInstead, we need a namespace policy, attached to https://pulsar.apache.org/admin-rest-api/?version=2.5.2#operation/setAutoTopicCreation that adds the auto-deletion override configuration, on top of the auto-creation", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432787179", "createdAt": "2020-05-30T00:01:08Z", "author": {"login": "merlimat"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -423,5 +428,13 @@ public long getBytesOutCounter() {\n         return getStats(false).bytesOutCounter;\n     }\n \n+    public boolean isBrokerDeleteInactiveTopicsEnabled() {\n+        return brokerDeleteInactiveTopicsEnabled;\n+    }\n+\n+    public void setBrokerDeleteInactiveTopicsEnabled(boolean brokerDeleteInactiveTopicsEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNDU1OTQy", "url": "https://github.com/apache/pulsar/pull/7093#pullrequestreview-421455942", "createdAt": "2020-05-31T02:12:12Z", "commit": {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQwMjoxMjoxMlrOGc2Sfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQwMjoxNzozN1rOGc2Tew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMjc4Mw==", "bodyText": "@merlimat This is used by the protocol handlers who want to ensure some topics under the namespace does not delete by the broker. But do not want to change the namespace level policy. Now, we don't have a topic level policy, without this change, we must create a virtual producer or consume.", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432902783", "createdAt": "2020-05-31T02:12:12Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -423,5 +428,13 @@ public long getBytesOutCounter() {\n         return getStats(false).bytesOutCounter;\n     }\n \n+    public boolean isBrokerDeleteInactiveTopicsEnabled() {\n+        return brokerDeleteInactiveTopicsEnabled;\n+    }\n+\n+    public void setBrokerDeleteInactiveTopicsEnabled(boolean brokerDeleteInactiveTopicsEnabled) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NzE3OQ=="}, "originalCommit": {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMjkxMA==", "bodyText": "I think it's better to named deleteWhileInactive.", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432902910", "createdAt": "2020-05-31T02:14:55Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -63,6 +63,9 @@\n \n     protected volatile boolean isFenced;\n \n+    // When set to false, this inactive topic can not be deleted\n+    protected boolean brokerDeleteInactiveTopicsEnabled;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMzAxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (brokerDeleteInactiveTopicsEnabled) {\n          \n          \n            \n                    if (! brokerDeleteInactiveTopicsEnabled) {", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432903012", "createdAt": "2020-05-31T02:17:01Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/nonpersistent/NonPersistentTopic.java", "diffHunk": "@@ -830,6 +830,10 @@ public boolean isActive() {\n \n     @Override\n     public void checkGC(int maxInactiveDurationInSec, InactiveTopicDeleteMode deleteMode) {\n+        if (brokerDeleteInactiveTopicsEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMzAzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (brokerDeleteInactiveTopicsEnabled) {\n          \n          \n            \n                    if (!brokerDeleteInactiveTopicsEnabled) {", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432903035", "createdAt": "2020-05-31T02:17:37Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -1636,6 +1629,10 @@ private boolean hasBacklogs() {\n \n     @Override\n     public void checkGC(int maxInactiveDurationInSec, InactiveTopicDeleteMode deleteMode) {\n+        if (brokerDeleteInactiveTopicsEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0dc906f26842b0949b344e03b0f8462d51342de", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/e0dc906f26842b0949b344e03b0f8462d51342de", "committedDate": "2020-05-31T11:44:59Z", "message": "rename to deleteWhileInactive and logic fix."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTQzNTgx", "url": "https://github.com/apache/pulsar/pull/7093#pullrequestreview-421543581", "createdAt": "2020-06-01T00:29:35Z", "commit": {"oid": "e0dc906f26842b0949b344e03b0f8462d51342de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1efb772a467c93296dfd82ef21eef673a480ebc7", "author": {"user": {"login": "zhanghaou", "name": "Hao Zhang"}}, "url": "https://github.com/apache/pulsar/commit/1efb772a467c93296dfd82ef21eef673a480ebc7", "committedDate": "2020-06-04T02:14:46Z", "message": "Merge pull request #2 from apache/master\n\nMerge from Pulsar's master branch."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDYwMTA2", "url": "https://github.com/apache/pulsar/pull/7093#pullrequestreview-424060106", "createdAt": "2020-06-04T02:30:47Z", "commit": {"oid": "1efb772a467c93296dfd82ef21eef673a480ebc7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2733, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}