{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3ODMwMzgz", "number": 6383, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwNTo0NDowNFrODiENuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNzo0ODoxNFrODmL4IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MDQ3MjI1OnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwNTo0NDowNFrOFtJrtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwMzo1NzozMlrOFyFuRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4ODg4NQ==", "bodyText": "This will be a flaky test since the consumer can create a subscription when they reconnect to the broker.", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r382888885", "createdAt": "2020-02-22T05:44:04Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java", "diffHunk": "@@ -1304,6 +1304,46 @@ public void testNamespaceBundleUnload(Integer numBundles) throws Exception {\n         admin.topics().delete(\"persistent://prop-xyz/ns1-bundles/ds2\");\n     }\n \n+    @Test(dataProvider = \"topicName\")\n+    public void testDeleteSubscription(String topicName) throws Exception {\n+        final String subName = topicName;\n+        final String persistentTopicName = \"persistent://prop-xyz/ns1/\" + topicName;\n+\n+        // create a topic and produce some messages\n+        publishMessagesOnPersistentTopic(\"persistent://prop-xyz/ns1/\" + topicName, 5);\n+        assertEquals(admin.topics().getList(\"prop-xyz/ns1\"),\n+            Lists.newArrayList(\"persistent://prop-xyz/ns1/\" + topicName));\n+\n+        // create consumer and subscription\n+        PulsarClient client = PulsarClient.builder()\n+            .serviceUrl(pulsar.getWebServiceAddress())\n+            .statsInterval(0, TimeUnit.SECONDS)\n+            .build();\n+        Consumer<byte[]> consumer = client.newConsumer().topic(persistentTopicName).subscriptionName(subName)\n+            .subscriptionType(SubscriptionType.Exclusive).subscribe();\n+\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName), Lists.newArrayList(subName));\n+\n+        // try to delete the subscription with a connected consumer\n+        try {\n+            admin.topics().deleteSubscription(persistentTopicName, subName);\n+            fail(\"should have failed\");\n+        } catch (PulsarAdminException.PreconditionFailedException e) {\n+            assertEquals(e.getStatusCode(), Status.PRECONDITION_FAILED.getStatusCode());\n+        }\n+\n+        // failed to delete the subscription\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName), Lists.newArrayList(subName));\n+\n+        // try to delete the subscription with a connected consumer forcefully\n+        admin.topics().deleteSubscription(persistentTopicName, subName, true);\n+\n+        // delete the subscription successfully\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName).size(), 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09e62b47cc0a2cb5a3d100d26200a13a75922e46"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkwMDYxOQ==", "bodyText": "yes, maybe we can disable this line in this pr first and then refine it later when the ability to disable the subscription auto-creation is available?", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r382900619", "createdAt": "2020-02-22T09:45:31Z", "author": {"login": "murong00"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java", "diffHunk": "@@ -1304,6 +1304,46 @@ public void testNamespaceBundleUnload(Integer numBundles) throws Exception {\n         admin.topics().delete(\"persistent://prop-xyz/ns1-bundles/ds2\");\n     }\n \n+    @Test(dataProvider = \"topicName\")\n+    public void testDeleteSubscription(String topicName) throws Exception {\n+        final String subName = topicName;\n+        final String persistentTopicName = \"persistent://prop-xyz/ns1/\" + topicName;\n+\n+        // create a topic and produce some messages\n+        publishMessagesOnPersistentTopic(\"persistent://prop-xyz/ns1/\" + topicName, 5);\n+        assertEquals(admin.topics().getList(\"prop-xyz/ns1\"),\n+            Lists.newArrayList(\"persistent://prop-xyz/ns1/\" + topicName));\n+\n+        // create consumer and subscription\n+        PulsarClient client = PulsarClient.builder()\n+            .serviceUrl(pulsar.getWebServiceAddress())\n+            .statsInterval(0, TimeUnit.SECONDS)\n+            .build();\n+        Consumer<byte[]> consumer = client.newConsumer().topic(persistentTopicName).subscriptionName(subName)\n+            .subscriptionType(SubscriptionType.Exclusive).subscribe();\n+\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName), Lists.newArrayList(subName));\n+\n+        // try to delete the subscription with a connected consumer\n+        try {\n+            admin.topics().deleteSubscription(persistentTopicName, subName);\n+            fail(\"should have failed\");\n+        } catch (PulsarAdminException.PreconditionFailedException e) {\n+            assertEquals(e.getStatusCode(), Status.PRECONDITION_FAILED.getStatusCode());\n+        }\n+\n+        // failed to delete the subscription\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName), Lists.newArrayList(subName));\n+\n+        // try to delete the subscription with a connected consumer forcefully\n+        admin.topics().deleteSubscription(persistentTopicName, subName, true);\n+\n+        // delete the subscription successfully\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName).size(), 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4ODg4NQ=="}, "originalCommit": {"oid": "09e62b47cc0a2cb5a3d100d26200a13a75922e46"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA2Njg4NA==", "bodyText": "I hava fixed the unit test to cover this.", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r388066884", "createdAt": "2020-03-05T03:57:32Z", "author": {"login": "murong00"}, "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiTest.java", "diffHunk": "@@ -1304,6 +1304,46 @@ public void testNamespaceBundleUnload(Integer numBundles) throws Exception {\n         admin.topics().delete(\"persistent://prop-xyz/ns1-bundles/ds2\");\n     }\n \n+    @Test(dataProvider = \"topicName\")\n+    public void testDeleteSubscription(String topicName) throws Exception {\n+        final String subName = topicName;\n+        final String persistentTopicName = \"persistent://prop-xyz/ns1/\" + topicName;\n+\n+        // create a topic and produce some messages\n+        publishMessagesOnPersistentTopic(\"persistent://prop-xyz/ns1/\" + topicName, 5);\n+        assertEquals(admin.topics().getList(\"prop-xyz/ns1\"),\n+            Lists.newArrayList(\"persistent://prop-xyz/ns1/\" + topicName));\n+\n+        // create consumer and subscription\n+        PulsarClient client = PulsarClient.builder()\n+            .serviceUrl(pulsar.getWebServiceAddress())\n+            .statsInterval(0, TimeUnit.SECONDS)\n+            .build();\n+        Consumer<byte[]> consumer = client.newConsumer().topic(persistentTopicName).subscriptionName(subName)\n+            .subscriptionType(SubscriptionType.Exclusive).subscribe();\n+\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName), Lists.newArrayList(subName));\n+\n+        // try to delete the subscription with a connected consumer\n+        try {\n+            admin.topics().deleteSubscription(persistentTopicName, subName);\n+            fail(\"should have failed\");\n+        } catch (PulsarAdminException.PreconditionFailedException e) {\n+            assertEquals(e.getStatusCode(), Status.PRECONDITION_FAILED.getStatusCode());\n+        }\n+\n+        // failed to delete the subscription\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName), Lists.newArrayList(subName));\n+\n+        // try to delete the subscription with a connected consumer forcefully\n+        admin.topics().deleteSubscription(persistentTopicName, subName, true);\n+\n+        // delete the subscription successfully\n+        assertEquals(admin.topics().getSubscriptions(persistentTopicName).size(), 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4ODg4NQ=="}, "originalCommit": {"oid": "09e62b47cc0a2cb5a3d100d26200a13a75922e46"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTU4NDUzOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzowNTowNlrOFySt-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwNzo0MDoxM1rOFzTrRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI3OTgwMw==", "bodyText": "Should handle exception here since we need to resume the asyncResponse", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r388279803", "createdAt": "2020-03-05T13:05:06Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -1032,6 +1040,73 @@ private void internalDeleteSubscriptionForNonPartitionedTopic(AsyncResponse asyn\n         }\n     }\n \n+    protected void internalDeleteSubscriptionForcefully(AsyncResponse asyncResponse, String subName, boolean authoritative) {\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        // If the topic name is a partition name, no need to get partition topic metadata again\n+        if (topicName.isPartitioned()) {\n+            internalDeleteSubscriptionForNonPartitionedTopicForcefully(asyncResponse, subName, authoritative);\n+        } else {\n+            PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);\n+            if (partitionMetadata.partitions > 0) {\n+                final List<CompletableFuture<Void>> futures = Lists.newArrayList();\n+\n+                for (int i = 0; i < partitionMetadata.partitions; i++) {\n+                    TopicName topicNamePartition = topicName.getPartition(i);\n+                    try {\n+                        futures.add(pulsar().getAdminClient().topics()\n+                            .deleteSubscriptionAsync(topicNamePartition.toString(), subName, true));\n+                    } catch (Exception e) {\n+                        log.error(\"[{}] Failed to delete subscription forcefully {} {}\", clientAppId(), topicNamePartition, subName,\n+                            e);\n+                        asyncResponse.resume(new RestException(e));\n+                        return;\n+                    }\n+                }\n+\n+                FutureUtil.waitForAll(futures).handle((result, exception) -> {\n+                    if (exception != null) {\n+                        Throwable t = exception.getCause();\n+                        if (t instanceof NotFoundException) {\n+                            asyncResponse.resume(new RestException(Status.NOT_FOUND, \"Subscription not found\"));\n+                            return null;\n+                        } else {\n+                            log.error(\"[{}] Failed to delete subscription forcefully {} {}\", clientAppId(), topicName, subName, t);\n+                            asyncResponse.resume(new RestException(t));\n+                            return null;\n+                        }\n+                    }\n+\n+                    asyncResponse.resume(Response.noContent().build());\n+                    return null;\n+                });\n+            } else {\n+                internalDeleteSubscriptionForNonPartitionedTopicForcefully(asyncResponse, subName, authoritative);\n+            }\n+        }\n+    }\n+\n+    private void internalDeleteSubscriptionForNonPartitionedTopicForcefully(AsyncResponse asyncResponse, String subName, boolean authoritative) {\n+        validateAdminAccessForSubscriber(subName, authoritative);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ec207d019ef687e6d5540d42380635ecfa94809"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0NDA3MQ==", "bodyText": "done.", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r389344071", "createdAt": "2020-03-08T07:40:13Z", "author": {"login": "murong00"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -1032,6 +1040,73 @@ private void internalDeleteSubscriptionForNonPartitionedTopic(AsyncResponse asyn\n         }\n     }\n \n+    protected void internalDeleteSubscriptionForcefully(AsyncResponse asyncResponse, String subName, boolean authoritative) {\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        // If the topic name is a partition name, no need to get partition topic metadata again\n+        if (topicName.isPartitioned()) {\n+            internalDeleteSubscriptionForNonPartitionedTopicForcefully(asyncResponse, subName, authoritative);\n+        } else {\n+            PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);\n+            if (partitionMetadata.partitions > 0) {\n+                final List<CompletableFuture<Void>> futures = Lists.newArrayList();\n+\n+                for (int i = 0; i < partitionMetadata.partitions; i++) {\n+                    TopicName topicNamePartition = topicName.getPartition(i);\n+                    try {\n+                        futures.add(pulsar().getAdminClient().topics()\n+                            .deleteSubscriptionAsync(topicNamePartition.toString(), subName, true));\n+                    } catch (Exception e) {\n+                        log.error(\"[{}] Failed to delete subscription forcefully {} {}\", clientAppId(), topicNamePartition, subName,\n+                            e);\n+                        asyncResponse.resume(new RestException(e));\n+                        return;\n+                    }\n+                }\n+\n+                FutureUtil.waitForAll(futures).handle((result, exception) -> {\n+                    if (exception != null) {\n+                        Throwable t = exception.getCause();\n+                        if (t instanceof NotFoundException) {\n+                            asyncResponse.resume(new RestException(Status.NOT_FOUND, \"Subscription not found\"));\n+                            return null;\n+                        } else {\n+                            log.error(\"[{}] Failed to delete subscription forcefully {} {}\", clientAppId(), topicName, subName, t);\n+                            asyncResponse.resume(new RestException(t));\n+                            return null;\n+                        }\n+                    }\n+\n+                    asyncResponse.resume(Response.noContent().build());\n+                    return null;\n+                });\n+            } else {\n+                internalDeleteSubscriptionForNonPartitionedTopicForcefully(asyncResponse, subName, authoritative);\n+            }\n+        }\n+    }\n+\n+    private void internalDeleteSubscriptionForNonPartitionedTopicForcefully(AsyncResponse asyncResponse, String subName, boolean authoritative) {\n+        validateAdminAccessForSubscriber(subName, authoritative);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI3OTgwMw=="}, "originalCommit": {"oid": "7ec207d019ef687e6d5540d42380635ecfa94809"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTYwOTEwOnYy", "diffSide": "RIGHT", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzoxMjo1M1rOFyS8iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwNzo0MDoyMFrOFzTrSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4MzUyOQ==", "bodyText": "Should handle exception here since we need to resume the asyncResponse", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r388283529", "createdAt": "2020-03-05T13:12:53Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -1032,6 +1040,73 @@ private void internalDeleteSubscriptionForNonPartitionedTopic(AsyncResponse asyn\n         }\n     }\n \n+    protected void internalDeleteSubscriptionForcefully(AsyncResponse asyncResponse, String subName, boolean authoritative) {\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        // If the topic name is a partition name, no need to get partition topic metadata again\n+        if (topicName.isPartitioned()) {\n+            internalDeleteSubscriptionForNonPartitionedTopicForcefully(asyncResponse, subName, authoritative);\n+        } else {\n+            PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ec207d019ef687e6d5540d42380635ecfa94809"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0NDA3NQ==", "bodyText": "done.", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r389344075", "createdAt": "2020-03-08T07:40:20Z", "author": {"login": "murong00"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -1032,6 +1040,73 @@ private void internalDeleteSubscriptionForNonPartitionedTopic(AsyncResponse asyn\n         }\n     }\n \n+    protected void internalDeleteSubscriptionForcefully(AsyncResponse asyncResponse, String subName, boolean authoritative) {\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        // If the topic name is a partition name, no need to get partition topic metadata again\n+        if (topicName.isPartitioned()) {\n+            internalDeleteSubscriptionForNonPartitionedTopicForcefully(asyncResponse, subName, authoritative);\n+        } else {\n+            PartitionedTopicMetadata partitionMetadata = getPartitionedTopicMetadata(topicName, authoritative, false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4MzUyOQ=="}, "originalCommit": {"oid": "7ec207d019ef687e6d5540d42380635ecfa94809"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMzY3MDczOnYy", "diffSide": "RIGHT", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNzo0ODoxNFrOFzdU5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMTozMTozNVrOFzjiLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUwMjE4Mw==", "bodyText": "This is an API breaking change. You can't directly change the method signature. Please add an override method.", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r389502183", "createdAt": "2020-03-09T07:48:14Z", "author": {"login": "sijie"}, "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java", "diffHunk": "@@ -801,10 +825,12 @@ PartitionedTopicInternalStats getPartitionedInternalStats(String topic)\n      *            topic name\n      * @param subName\n      *            Subscription name\n+     * @param force\n+     *            Delete topic forcefully\n      *\n      * @return a future that can be used to track when the subscription is deleted\n      */\n-    CompletableFuture<Void> deleteSubscriptionAsync(String topic, String subName);\n+    CompletableFuture<Void> deleteSubscriptionAsync(String topic, String subName, boolean force);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07a222ed9e5b9a5411325f3a30b032fe2a20c737"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYwMzg4NA==", "bodyText": "Added, thanks.", "url": "https://github.com/apache/pulsar/pull/6383#discussion_r389603884", "createdAt": "2020-03-09T11:31:35Z", "author": {"login": "murong00"}, "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Topics.java", "diffHunk": "@@ -801,10 +825,12 @@ PartitionedTopicInternalStats getPartitionedInternalStats(String topic)\n      *            topic name\n      * @param subName\n      *            Subscription name\n+     * @param force\n+     *            Delete topic forcefully\n      *\n      * @return a future that can be used to track when the subscription is deleted\n      */\n-    CompletableFuture<Void> deleteSubscriptionAsync(String topic, String subName);\n+    CompletableFuture<Void> deleteSubscriptionAsync(String topic, String subName, boolean force);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUwMjE4Mw=="}, "originalCommit": {"oid": "07a222ed9e5b9a5411325f3a30b032fe2a20c737"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1983, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}