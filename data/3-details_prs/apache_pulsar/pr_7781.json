{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NDQ3NDkw", "number": 7781, "title": "[Transaction] Support consume transaction messages.", "bodyText": "Master Issue: #2664\nFix streamnative#1304\nMotivation\nCurrently, the consumer can't receive transaction messages.\nModifications\nSupport process the commit marker in the topic partition and fetch transaction messages from TransactionBuffer.\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\nThis change added tests and can be verified as follows:\n\nAdded unit test for consuming transaction messages\norg.apache.pulsar.broker.transaction.TransactionConsumeTest\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (no)\nThe public API: (yes)\nThe schema: (no)\nThe default values of configurations: (no)\nThe wire protocol: (no)\nThe rest endpoints: (no)\nThe admin cli options: (no)\nAnything that affects deployment: (no)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (no)", "createdAt": "2020-08-07T07:39:02Z", "url": "https://github.com/apache/pulsar/pull/7781", "merged": true, "mergeCommit": {"oid": "6e7d1a83c3c2737610f01cb372f61e2b830a62f7"}, "closed": true, "closedAt": "2020-08-14T01:21:45Z", "author": {"login": "gaoran10"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9OpjLgFqTQ2Mzg3OTM3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-qOmmgFqTQ2NzI1MTgwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODc5Mzcy", "url": "https://github.com/apache/pulsar/pull/7781#pullrequestreview-463879372", "createdAt": "2020-08-09T14:39:31Z", "commit": {"oid": "22f4c01a0c786b08de356d050f0f24589d514f29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MTk5MzY1", "url": "https://github.com/apache/pulsar/pull/7781#pullrequestreview-464199365", "createdAt": "2020-08-10T12:52:26Z", "commit": {"oid": "22f4c01a0c786b08de356d050f0f24589d514f29"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMjo1MjoyNlrOG-NNXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMjo1NjowMlrOG-NU7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg4MTMwOA==", "bodyText": "It's might peek null here.", "url": "https://github.com/apache/pulsar/pull/7781#discussion_r467881308", "createdAt": "2020-08-10T12:52:26Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/TransactionReader.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.broker.service.persistent;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.bookkeeper.mledger.AsyncCallbacks;\n+import org.apache.bookkeeper.mledger.Entry;\n+import org.apache.bookkeeper.mledger.ManagedLedgerException;\n+import org.apache.pulsar.broker.service.Consumer;\n+import org.apache.pulsar.broker.service.Topic;\n+import org.apache.pulsar.broker.transaction.buffer.TransactionBuffer;\n+import org.apache.pulsar.client.api.transaction.TxnID;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+@Slf4j\n+public class TransactionReader {\n+\n+    private TransactionBuffer transactionBuffer;\n+    private volatile long startSequenceId = 0;\n+\n+    public void read(Topic topic, ConcurrentLinkedQueue<TxnID> transactionQueue,\n+                     int readMessageNum, Object ctx,\n+                     AsyncCallbacks.ReadEntriesCallback readEntriesCallback) {\n+        if (transactionBuffer == null) {\n+            topic.getTransactionBuffer(false).whenComplete((tb, throwable) -> {\n+                if (throwable != null) {\n+                    log.error(\"Get transactionBuffer failed.\", throwable);\n+                    readEntriesCallback.readEntriesFailed(\n+                            ManagedLedgerException.getManagedLedgerException(throwable), ctx);\n+                    return;\n+                }\n+                transactionBuffer = tb;\n+                read(transactionQueue, readMessageNum, ctx, readEntriesCallback);\n+            });\n+        } else {\n+            read(transactionQueue, readMessageNum, ctx, readEntriesCallback);\n+        }\n+    }\n+\n+    private void read(ConcurrentLinkedQueue<TxnID> transactionQueue,\n+                     int readMessageNum, Object ctx,\n+                     AsyncCallbacks.ReadEntriesCallback readEntriesCallback) {\n+        final TxnID txnID = transactionQueue.peek();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22f4c01a0c786b08de356d050f0f24589d514f29"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg4MzI0NQ==", "bodyText": "Is the read txn message count is the size of the transactionQueue ?  I did not understand this method, is the transactionQueue only stores the first txn ID?  I noticed you have only peek one item from this queue.", "url": "https://github.com/apache/pulsar/pull/7781#discussion_r467883245", "createdAt": "2020-08-10T12:56:02Z", "author": {"login": "codelipenghui"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/TransactionReader.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pulsar.broker.service.persistent;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.bookkeeper.mledger.AsyncCallbacks;\n+import org.apache.bookkeeper.mledger.Entry;\n+import org.apache.bookkeeper.mledger.ManagedLedgerException;\n+import org.apache.pulsar.broker.service.Consumer;\n+import org.apache.pulsar.broker.service.Topic;\n+import org.apache.pulsar.broker.transaction.buffer.TransactionBuffer;\n+import org.apache.pulsar.client.api.transaction.TxnID;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+@Slf4j\n+public class TransactionReader {\n+\n+    private TransactionBuffer transactionBuffer;\n+    private volatile long startSequenceId = 0;\n+\n+    public void read(Topic topic, ConcurrentLinkedQueue<TxnID> transactionQueue,\n+                     int readMessageNum, Object ctx,\n+                     AsyncCallbacks.ReadEntriesCallback readEntriesCallback) {\n+        if (transactionBuffer == null) {\n+            topic.getTransactionBuffer(false).whenComplete((tb, throwable) -> {\n+                if (throwable != null) {\n+                    log.error(\"Get transactionBuffer failed.\", throwable);\n+                    readEntriesCallback.readEntriesFailed(\n+                            ManagedLedgerException.getManagedLedgerException(throwable), ctx);\n+                    return;\n+                }\n+                transactionBuffer = tb;\n+                read(transactionQueue, readMessageNum, ctx, readEntriesCallback);\n+            });\n+        } else {\n+            read(transactionQueue, readMessageNum, ctx, readEntriesCallback);\n+        }\n+    }\n+\n+    private void read(ConcurrentLinkedQueue<TxnID> transactionQueue,\n+                     int readMessageNum, Object ctx,\n+                     AsyncCallbacks.ReadEntriesCallback readEntriesCallback) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22f4c01a0c786b08de356d050f0f24589d514f29"}, "originalPosition": 62}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87cb7ddb764f0c0ad1e6e134f2faf30cf2561925", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/87cb7ddb764f0c0ad1e6e134f2faf30cf2561925", "committedDate": "2020-08-10T14:33:13Z", "message": "Hold a dispatcher in TransactionReader."}, "afterCommit": {"oid": "9f213b756cd4158d5068d3684f919bb72346fc25", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/9f213b756cd4158d5068d3684f919bb72346fc25", "committedDate": "2020-08-10T14:36:46Z", "message": "Hold a dispatcher in TransactionReader."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b17e8f43b3fdab89a26582da30e14342a5bd61d6", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/b17e8f43b3fdab89a26582da30e14342a5bd61d6", "committedDate": "2020-08-13T05:49:06Z", "message": "Support consume transaction messages."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95fcde794fa7b60629b448a37d3dc85a2ae6e150", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/95fcde794fa7b60629b448a37d3dc85a2ae6e150", "committedDate": "2020-08-13T05:49:06Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d078f8d485c95488a9917a2afe95fccddd28192b", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/d078f8d485c95488a9917a2afe95fccddd28192b", "committedDate": "2020-08-13T05:49:06Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "150f8e727f4d63bc41acaf28cb6af4bd618d4618", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/150f8e727f4d63bc41acaf28cb6af4bd618d4618", "committedDate": "2020-08-13T05:49:06Z", "message": "Hold a dispatcher in TransactionReader."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6a6f81b84c5a55bdacb3bad7f1a05919efb64aa", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/f6a6f81b84c5a55bdacb3bad7f1a05919efb64aa", "committedDate": "2020-08-13T05:49:06Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05174fda42db6dde014d694745128967607a9e09", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/05174fda42db6dde014d694745128967607a9e09", "committedDate": "2020-08-13T05:49:06Z", "message": "Make the TransactionEntry hold the Entry instead of the Entry's DataBuffer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c516179b676cb1c9c6c62e442d10c352a06edf72", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/c516179b676cb1c9c6c62e442d10c352a06edf72", "committedDate": "2020-08-13T05:49:06Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a83e749ed2f2470fc770f8eba66b8679309c12c", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/8a83e749ed2f2470fc770f8eba66b8679309c12c", "committedDate": "2020-08-13T05:49:06Z", "message": "fix license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5007a2a4308c8a3647def18768b74d266fab06e4", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/5007a2a4308c8a3647def18768b74d266fab06e4", "committedDate": "2020-08-13T05:49:06Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8bd38d91b21156da95d184ed15ab1668eb4db678", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/8bd38d91b21156da95d184ed15ab1668eb4db678", "committedDate": "2020-08-12T02:24:03Z", "message": "fix license"}, "afterCommit": {"oid": "5007a2a4308c8a3647def18768b74d266fab06e4", "author": {"user": {"login": "gaoran10", "name": "ran"}}, "url": "https://github.com/apache/pulsar/commit/5007a2a4308c8a3647def18768b74d266fab06e4", "committedDate": "2020-08-13T05:49:06Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MjUxODAy", "url": "https://github.com/apache/pulsar/pull/7781#pullrequestreview-467251802", "createdAt": "2020-08-14T01:21:21Z", "commit": {"oid": "5007a2a4308c8a3647def18768b74d266fab06e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 247, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}