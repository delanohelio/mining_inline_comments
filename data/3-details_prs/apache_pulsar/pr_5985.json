{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4OTU2Nzcy", "number": 5985, "title": "[Issue 5935] Support multi pulsar clusters to use the same bk cluster", "bodyText": "Motivation\nFixes #5935\nSupport multi pulsar clusters to use the specified bookkeeper cluster by pointing BookKeeper Client to the zookeeper connection string of bookkeeper cluster.\nModifications\n\nAdd a config bookkeeperServiceUri to discover bookkeeper cluster metadata store.\nUse metadata service uri to init bookkeeper client.", "createdAt": "2020-01-03T11:22:27Z", "url": "https://github.com/apache/pulsar/pull/5985", "merged": true, "mergeCommit": {"oid": "188d8961dde02a860f875c5bb520b849476b56cf"}, "closed": true, "closedAt": "2020-04-21T20:18:38Z", "author": {"login": "murong00"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7qT_3gFqTM0NDk2MzY0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZZ-l7gFqTM5NjIwMzU2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTYzNjQ0", "url": "https://github.com/apache/pulsar/pull/5985#pullrequestreview-344963644", "createdAt": "2020-01-18T21:32:09Z", "commit": {"oid": "c45aa699ece48f88dec5dc06134c3524bed83a35"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQyMTozMjowOVrOFfMLNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQyMTozNDowNlrOFfMLnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI0OTY1Mw==", "bodyText": "why do we remove this logic?", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r368249653", "createdAt": "2020-01-18T21:32:09Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/PulsarClusterMetadataSetup.java", "diffHunk": "@@ -170,16 +170,11 @@ public static void main(String[] args) throws Exception {\n         ZooKeeper localZk = initZk(arguments.zookeeper, arguments.zkSessionTimeoutMillis);\n         ZooKeeper configStoreZk = initZk(arguments.configurationStore, arguments.zkSessionTimeoutMillis);\n \n-        // Format BookKeeper ledger storage metadata\n+        // Format BookKeeper stream storage metadata\n         ServerConfiguration bkConf = new ServerConfiguration();\n         bkConf.setZkServers(arguments.zookeeper);\n         bkConf.setZkTimeout(arguments.zkSessionTimeoutMillis);\n-        if (localZk.exists(\"/ledgers\", false) == null // only format if /ledgers doesn't exist", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c45aa699ece48f88dec5dc06134c3524bed83a35"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI0OTc1Ng==", "bodyText": "in bookkeeper we deprecated using two separate settings. we are encouraging people to use metadata service uri to connect to a zookeeper cluster. we should try to adopt it in Pulsar. Thus if we are adding the support for a separate bookkeeper cluster, let's try to use metadata service uri.", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r368249756", "createdAt": "2020-01-18T21:34:06Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -743,6 +743,18 @@\n     private String kinitCommand = \"/usr/bin/kinit\";\n \n     /**** --- BookKeeper Client --- ****/\n+    @FieldContext(\n+        category = CATEGORY_STORAGE_BK,\n+        doc = \"BookKeeper ledgers storage connection string when using a separated BookKeeper cluster.\"\n+            + \" If not set it will use local zookeeper quorum of Pulsar cluster\"\n+    )\n+    private String bookkeeperLedgersStore;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c45aa699ece48f88dec5dc06134c3524bed83a35"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzgyNzA2", "url": "https://github.com/apache/pulsar/pull/5985#pullrequestreview-359382706", "createdAt": "2020-02-16T06:22:38Z", "commit": {"oid": "f9acd2592aae9cd7b507fd46003719ff0842c888"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQwNjoyMjozOFrOFqR8UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQwNjoyMjozOFrOFqR8UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg3ODQ4MQ==", "bodyText": "I don't think we should try to construct PulsarService. because the constructor also does a lot of unrelated things.\nI would suggest adding a util function to generate metadata service url from the configuration.", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r379878481", "createdAt": "2020-02-16T06:22:38Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/BookKeeperClientFactoryImpl.java", "diffHunk": "@@ -106,6 +106,14 @@ ClientConfiguration createBkClientConfiguration(ServiceConfiguration conf) {\n         bkConf.setNettyMaxFrameSizeBytes(conf.getMaxMessageSize() + Commands.MESSAGE_SIZE_FRAME_PADDING);\n         bkConf.setDiskWeightBasedPlacementEnabled(conf.isBookkeeperDiskWeightBasedPlacementEnabled());\n \n+        if (StringUtils.isNotBlank(conf.getBookkeeperServiceUri())) {\n+            bkConf.setMetadataServiceUri(conf.getBookkeeperServiceUri());\n+        } else {\n+            PulsarService pulsar = new PulsarService(conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9acd2592aae9cd7b507fd46003719ff0842c888"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9acd2592aae9cd7b507fd46003719ff0842c888", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/f9acd2592aae9cd7b507fd46003719ff0842c888", "committedDate": "2020-01-19T12:30:52Z", "message": "Use metadata service uri to init bookkeeper client"}, "afterCommit": {"oid": "786b310561ba626a9c41d438ecf00383c9754ae9", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/786b310561ba626a9c41d438ecf00383c9754ae9", "committedDate": "2020-02-25T04:06:00Z", "message": "Add a util function to generate metadata service url"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NTI4NzM3", "url": "https://github.com/apache/pulsar/pull/5985#pullrequestreview-386528737", "createdAt": "2020-04-02T15:15:16Z", "commit": {"oid": "7de91fa7113dabfbf9ad4213f6f206d41c7cccbe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNToxNToxNlrOF_wNKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNToxNToxNlrOF_wNKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM5NDQwOA==", "bodyText": "It seems ledgersRootPath is much more direct than metadataServiceUri. metadata may lead developer think of \"zookeeper\". How about change this back\uff1f", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r402394408", "createdAt": "2020-04-02T15:15:16Z", "author": {"login": "jiazhai"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/conf/InternalConfigurationData.java", "diffHunk": "@@ -28,19 +28,19 @@\n \n     private String zookeeperServers;\n     private String configurationStoreServers;\n-    private String ledgersRootPath;\n+    private String metadataServiceUri;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de91fa7113dabfbf9ad4213f6f206d41c7cccbe"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NTM3NDkw", "url": "https://github.com/apache/pulsar/pull/5985#pullrequestreview-386537490", "createdAt": "2020-04-02T15:24:37Z", "commit": {"oid": "7de91fa7113dabfbf9ad4213f6f206d41c7cccbe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNToyNDozN1rOF_wodQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNToyNDozN1rOF_wodQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQwMTM5Nw==", "bodyText": "how about bkLedgerRootPath? This seems be more directly.\nbookkeeperServiceUri may be easy confused with the bookie service url(e.g. \"localhost:3181\").", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r402401397", "createdAt": "2020-04-02T15:24:37Z", "author": {"login": "jiazhai"}, "path": "conf/broker.conf", "diffHunk": "@@ -461,6 +461,10 @@ httpMaxRequestSize=-1\n \n ### --- BookKeeper Client --- ###\n \n+# Metadata service uri that bookkeeper is used for loading corresponding metadata driver\n+# and resolving its metadata service location.\n+bookkeeperServiceUri=", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de91fa7113dabfbf9ad4213f6f206d41c7cccbe"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7de91fa7113dabfbf9ad4213f6f206d41c7cccbe", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/7de91fa7113dabfbf9ad4213f6f206d41c7cccbe", "committedDate": "2020-02-25T05:58:25Z", "message": "Fix a unit test"}, "afterCommit": {"oid": "e2d7c4b21a2021dbee657dee6bc508ea9c7031a7", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/e2d7c4b21a2021dbee657dee6bc508ea9c7031a7", "committedDate": "2020-04-03T07:10:15Z", "message": "Rename var names and add a test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bbae7d33e4fcb89a08b2a0e84162a5d348a6d6f6", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/bbae7d33e4fcb89a08b2a0e84162a5d348a6d6f6", "committedDate": "2020-04-03T07:19:25Z", "message": "Fix checkstyle"}, "afterCommit": {"oid": "4764ebf963627e73d792abedb637111d0f2fd346", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/4764ebf963627e73d792abedb637111d0f2fd346", "committedDate": "2020-04-09T02:01:50Z", "message": "Rename var names and add a test\n\nFix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4e87bd693df6bd679d699a32fd8e46edd3ae256", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/e4e87bd693df6bd679d699a32fd8e46edd3ae256", "committedDate": "2020-04-14T01:19:20Z", "message": "Support multi pulsar clusters to use the same bk cluster.\n\nRebuild some logic\n\nRebuild some logic\n\nAdded missing changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5062f945f70226121cb40b373a29b5d4ca464f8", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/c5062f945f70226121cb40b373a29b5d4ca464f8", "committedDate": "2020-04-14T01:19:20Z", "message": "Use metadata service uri to init bookkeeper client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0673e7d4c9f28e75befe8eb3671a13a470f10492", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/0673e7d4c9f28e75befe8eb3671a13a470f10492", "committedDate": "2020-04-14T01:19:21Z", "message": "Add a util function to generate metadata service url\n\nFix a unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b348adfcbe077bc87aa541349b620b5f255f69fd", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/b348adfcbe077bc87aa541349b620b5f255f69fd", "committedDate": "2020-04-14T01:19:21Z", "message": "Rename var names and add a test\n\nFix checkstyle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4764ebf963627e73d792abedb637111d0f2fd346", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/4764ebf963627e73d792abedb637111d0f2fd346", "committedDate": "2020-04-09T02:01:50Z", "message": "Rename var names and add a test\n\nFix checkstyle"}, "afterCommit": {"oid": "b348adfcbe077bc87aa541349b620b5f255f69fd", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/b348adfcbe077bc87aa541349b620b5f255f69fd", "committedDate": "2020-04-14T01:19:21Z", "message": "Rename var names and add a test\n\nFix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTgyNzQ5", "url": "https://github.com/apache/pulsar/pull/5985#pullrequestreview-392582749", "createdAt": "2020-04-14T03:39:52Z", "commit": {"oid": "b348adfcbe077bc87aa541349b620b5f255f69fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MDE3Njgx", "url": "https://github.com/apache/pulsar/pull/5985#pullrequestreview-395017681", "createdAt": "2020-04-16T21:38:12Z", "commit": {"oid": "b348adfcbe077bc87aa541349b620b5f255f69fd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMTozODoxMlrOGG4FoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMTo0MDowNFrOGG4JiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MzU4NQ==", "bodyText": "I don't think we should add this logic here. We should reply on the logic that bookkeeper already provides. You can do this by using the following code snippet.\nClientConfiguration bkConf = new ClientConfiguration();\nbkConf.setZkServers(config.getZooKeeperServers());\nreturn bkConf.getMetadataServiceUri();", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r409863585", "createdAt": "2020-04-16T21:38:12Z", "author": {"login": "sijie"}, "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/PulsarService.java", "diffHunk": "@@ -1064,6 +1087,27 @@ public String getSafeBrokerServiceUrl() {\n         return brokerServiceUrl != null ? brokerServiceUrl : brokerServiceUrlTls;\n     }\n \n+    /**\n+     * Get bookkeeper metadata service uri.\n+     *\n+     * @param config broker configuration\n+     * @return the metadata service uri that bookkeeper is used\n+     */\n+    public static String bookieMetadataServiceUri(ServiceConfiguration config) {\n+        ClientConfiguration bkConf = new ClientConfiguration();\n+        // init bookkeeper metadata service uri\n+        String metadataServiceUri = null;\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b348adfcbe077bc87aa541349b620b5f255f69fd"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2NDU4NQ==", "bodyText": "for backward compatibility, you shouldn't change the field directly.\nYou can add a new field bookkeeperMetadataServiceUri and deprecate the old field ledgersRootPath .", "url": "https://github.com/apache/pulsar/pull/5985#discussion_r409864585", "createdAt": "2020-04-16T21:40:04Z", "author": {"login": "sijie"}, "path": "pulsar-common/src/main/java/org/apache/pulsar/common/conf/InternalConfigurationData.java", "diffHunk": "@@ -28,19 +28,19 @@\n \n     private String zookeeperServers;\n     private String configurationStoreServers;\n-    private String ledgersRootPath;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b348adfcbe077bc87aa541349b620b5f255f69fd"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8e874851a968c61436d8289e0b34da474cf29e4", "author": {"user": {"login": "murong00", "name": "Fangbin Sun"}}, "url": "https://github.com/apache/pulsar/commit/e8e874851a968c61436d8289e0b34da474cf29e4", "committedDate": "2020-04-17T02:00:43Z", "message": "Deprecated ledgersRootPath and use the logic of bkConf"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MjAzNTY5", "url": "https://github.com/apache/pulsar/pull/5985#pullrequestreview-396203569", "createdAt": "2020-04-20T07:30:11Z", "commit": {"oid": "e8e874851a968c61436d8289e0b34da474cf29e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1407, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}