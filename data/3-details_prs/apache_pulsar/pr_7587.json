{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxNTM3MjEy", "number": 7587, "title": "Use Consume/Produce/Lookup interfaces for specific operations in allowTopicOperation", "bodyText": "(If this PR fixes a github issue, please add Fixes #<xyz>.)\nFixes #\n(or if this PR is one task of a github issue, please add Master Issue: #<xyz> to link to the master issue.)\nMaster Issue: #\nMotivation\nSeveral parts of the code use allowTopicOperation while others use canConsume/canProduce/canLookup for those specific operations. This mr makes the former use the latter calls for specific operataions\nModifications\nDescribe the modifications you've done.\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\n(Please pick either of the following options)\nThis change is a trivial rework / code cleanup without any test coverage.\n(or)\nThis change is already covered by existing tests, such as (please describe tests).\n(or)\nThis change added tests and can be verified as follows:\n(example:)\n\nAdded integration tests for end-to-end deployment with large payloads (10MB)\nExtended integration test for recovery after broker failure\n\nDoes this pull request potentially affect one of the following parts:\nIf yes was chosen, please highlight the changes\n\nDependencies (does it add or upgrade a dependency): (yes / no)\nThe public API: (yes / no)\nThe schema: (yes / no / don't know)\nThe default values of configurations: (yes / no)\nThe wire protocol: (yes / no)\nThe rest endpoints: (yes / no)\nThe admin cli options: (yes / no)\nAnything that affects deployment: (yes / no / don't know)\n\nDocumentation\n\nDoes this pull request introduce a new feature? (yes / no)\nIf yes, how is the feature documented? (not applicable / docs / JavaDocs / not documented)\nIf a feature is not applicable for documentation, explain why?\nIf a feature is not documented yet in this PR, please create a followup issue for adding the documentation", "createdAt": "2020-07-17T23:12:48Z", "url": "https://github.com/apache/pulsar/pull/7587", "merged": true, "mergeCommit": {"oid": "516bad1079830b3f5f5046b4237e12861f9ec3a9"}, "closed": true, "closedAt": "2020-07-27T04:35:32Z", "author": {"login": "srkukarni"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyqm03gH2gAyNDUxNTM3MjEyOmNkN2NiZTVmMTJkMzU5Yzk1OGE1ZTY2MTEyNDVkMWYxM2Q3ZTA5M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc46NSfgFqTQ1NTQ2NTcxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cd7cbe5f12d359c958a5e6611245d1f13d7e093d", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/cd7cbe5f12d359c958a5e6611245d1f13d7e093d", "committedDate": "2020-07-07T19:00:43Z", "message": "Added upgrade notes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83b4c58c8466a402229de9f1ad4fcdeb4e0b83ef", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/83b4c58c8466a402229de9f1ad4fcdeb4e0b83ef", "committedDate": "2020-07-08T20:35:54Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3ba7f344b8056adb759c040f529094f5ca9d67f", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/a3ba7f344b8056adb759c040f529094f5ca9d67f", "committedDate": "2020-07-12T16:17:19Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89c8048f57e46a0a336d6b59a73aa19fd9bcfe94", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/89c8048f57e46a0a336d6b59a73aa19fd9bcfe94", "committedDate": "2020-07-12T22:43:18Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0728460c11e7babb09d47427818bda7092846cd", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/b0728460c11e7babb09d47427818bda7092846cd", "committedDate": "2020-07-13T20:40:54Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77bb46778d1ef87c5c14694b634ba9d14e945b74", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/77bb46778d1ef87c5c14694b634ba9d14e945b74", "committedDate": "2020-07-13T23:47:34Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "000336c993a9c92871470b5ded18724d94cd41c6", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/000336c993a9c92871470b5ded18724d94cd41c6", "committedDate": "2020-07-14T18:53:11Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9231d29d8ec4dc3e4451436ec6f7eaa3aae6cb4", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/f9231d29d8ec4dc3e4451436ec6f7eaa3aae6cb4", "committedDate": "2020-07-15T15:39:38Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee44e3ba01e6793331134ac43e7ca636d49a03ab", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/ee44e3ba01e6793331134ac43e7ca636d49a03ab", "committedDate": "2020-07-16T23:33:16Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b02b546faad21540133e66b63d9e691561f4c45", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/4b02b546faad21540133e66b63d9e691561f4c45", "committedDate": "2020-07-17T05:44:01Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edb2f412a5c025c43d122cb34762402070850b1d", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/edb2f412a5c025c43d122cb34762402070850b1d", "committedDate": "2020-07-17T21:01:04Z", "message": "Merge remote-tracking branch 'apache/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2173c64e531e3a783e077f038942c4ec7107b12", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/c2173c64e531e3a783e077f038942c4ec7107b12", "committedDate": "2020-07-17T23:09:55Z", "message": "For the generic allowTopicOperations use Consume/Produce/Lookup interfaces"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDAwNTM4", "url": "https://github.com/apache/pulsar/pull/7587#pullrequestreview-451000538", "createdAt": "2020-07-17T23:20:12Z", "commit": {"oid": "c2173c64e531e3a783e077f038942c4ec7107b12"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QyMzoyMDoxMlrOGzjfKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QyMzoyMDoxMlrOGzjfKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjcxMTk3OQ==", "bodyText": "I think it is better to change the default implementation in the AuthorizationProvider interface instead of here.\n    /**\n     * Grant authorization-action permission on a topic to the given client\n     * @param topic\n     * @param originalRole role not overriden by proxy role if request do pass through proxy\n     * @param role originalRole | proxyRole if the request didn't pass through proxy\n     * @param operation\n     * @param authData\n     * @return CompletableFuture<Boolean>\n     */\n    default CompletableFuture<Boolean> allowTopicOperationAsync(TopicName topic, String originalRole, String role,\n                                                             TopicOperation operation,\n                                                             AuthenticationDataSource authData) {\nswitch (operation) {\n                case PRODUCE:\n                    return canProduceAsync(topicName, role, authData);\n                case CONSUME:\n                    return canConsumeAsync(topicName, role, authData, null);\n                case LOOKUP:\n                    return canLookupAsync(topicName, role, authData);\n                default:\n                     return FutureUtil.failedFuture(new IllegalStateException(\"TopicOperation is not supported by the Authorization provider you are using.\"));\n    }", "url": "https://github.com/apache/pulsar/pull/7587#discussion_r456711979", "createdAt": "2020-07-17T23:20:12Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/AuthorizationService.java", "diffHunk": "@@ -486,7 +486,16 @@ public Boolean allowNamespacePolicyOperation(NamespaceName namespaceName, Policy\n         }\n \n         if (provider != null) {\n-            return provider.allowTopicOperationAsync(topicName, originalRole, role, operation, authData);\n+            switch (operation) {\n+                case PRODUCE:\n+                    return canProduceAsync(topicName, role, authData);\n+                case CONSUME:\n+                    return canConsumeAsync(topicName, role, authData, null);\n+                case LOOKUP:\n+                    return canLookupAsync(topicName, role, authData);\n+                default:\n+                    return provider.allowTopicOperationAsync(topicName, originalRole, role, operation, authData);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2173c64e531e3a783e077f038942c4ec7107b12"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f72caa29b4e322959be8b02010ea116b6cf8cef1", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/f72caa29b4e322959be8b02010ea116b6cf8cef1", "committedDate": "2020-07-17T23:24:16Z", "message": "Simplify PulsarAuthProvider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aff0cf25648c183864dab1c44c92b1d989c176e", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/1aff0cf25648c183864dab1c44c92b1d989c176e", "committedDate": "2020-07-17T23:34:37Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e87dedf082d45e272e15c8ae28e2067dc4637da", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/5e87dedf082d45e272e15c8ae28e2067dc4637da", "committedDate": "2020-07-17T23:40:34Z", "message": "revert changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDA4Njc4", "url": "https://github.com/apache/pulsar/pull/7587#pullrequestreview-451008678", "createdAt": "2020-07-17T23:59:19Z", "commit": {"oid": "5e87dedf082d45e272e15c8ae28e2067dc4637da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDYxMDQw", "url": "https://github.com/apache/pulsar/pull/7587#pullrequestreview-451061040", "createdAt": "2020-07-18T14:36:43Z", "commit": {"oid": "5e87dedf082d45e272e15c8ae28e2067dc4637da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60e05d1337dede6ee949cc214db3cb699126d508", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/60e05d1337dede6ee949cc214db3cb699126d508", "committedDate": "2020-07-19T05:24:12Z", "message": "much saner impl for allowTenantOperation as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d658b9d5e1bbf1be2062e08689bbfa632b36109f", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/d658b9d5e1bbf1be2062e08689bbfa632b36109f", "committedDate": "2020-07-19T06:24:43Z", "message": "saner default for allow namespace policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02344476062115e20a5d09920200eed35a67028e", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/02344476062115e20a5d09920200eed35a67028e", "committedDate": "2020-07-19T07:56:45Z", "message": "internal calls already check auth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afdcc9287ef0a8f631c4af930b00595c7003deec", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/afdcc9287ef0a8f631c4af930b00595c7003deec", "committedDate": "2020-07-21T06:27:35Z", "message": "For the generic allowTopicOperations use Consume/Produce/Lookup interfaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf7512342714c5d7d21a6a6b295c2c642ffa164f", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/bf7512342714c5d7d21a6a6b295c2c642ffa164f", "committedDate": "2020-07-21T06:27:35Z", "message": "Simplify PulsarAuthProvider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fd03029035f69c518e2653e0e3c542843dccdc0", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/6fd03029035f69c518e2653e0e3c542843dccdc0", "committedDate": "2020-07-21T06:27:35Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8aec26623534e2ea4232c77520c789c1565dac8", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/f8aec26623534e2ea4232c77520c789c1565dac8", "committedDate": "2020-07-21T06:27:35Z", "message": "revert changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14ef995cd73a2990fab80826212b6711085b209d", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/14ef995cd73a2990fab80826212b6711085b209d", "committedDate": "2020-07-21T06:27:35Z", "message": "much saner impl for allowTenantOperation as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a24601f89cc44f1869ca20f38e30dd9099389cd", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/1a24601f89cc44f1869ca20f38e30dd9099389cd", "committedDate": "2020-07-21T06:27:35Z", "message": "saner default for allow namespace policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6170dca1b7a389c931f44e6c6848c2c91350b370", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/6170dca1b7a389c931f44e6c6848c2c91350b370", "committedDate": "2020-07-21T06:27:35Z", "message": "internal calls already check auth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc08834d8572af52575862a6477926354e3a41ba", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/dc08834d8572af52575862a6477926354e3a41ba", "committedDate": "2020-07-21T06:27:45Z", "message": "Merge branch 'auth_haul3' of github.com:srkukarni/incubator-pulsar into auth_haul3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "725337c2c67f59de31cb212cf0bce71bc347f438", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/725337c2c67f59de31cb212cf0bce71bc347f438", "committedDate": "2020-07-23T08:51:20Z", "message": "Merge branch 'master' into auth_haul3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "775198b492eaa6d5490c91259f60f4d3b29f9593", "author": {"user": null}, "url": "https://github.com/apache/pulsar/commit/775198b492eaa6d5490c91259f60f4d3b29f9593", "committedDate": "2020-07-24T16:29:38Z", "message": "Merge branch 'master' into auth_haul3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NDY1NzE1", "url": "https://github.com/apache/pulsar/pull/7587#pullrequestreview-455465715", "createdAt": "2020-07-27T04:34:51Z", "commit": {"oid": "775198b492eaa6d5490c91259f60f4d3b29f9593"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 361, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}