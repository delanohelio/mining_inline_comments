{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMTQwNTY5", "number": 6716, "title": "[Issue #6711]: add audience verify in AuthenticationProviderToken", "bodyText": "Fixes #6711\nMotivation\nUser like to be able to configure the JWT authentication provider to verify the audience on incoming tokens.  I believe this will improve security because it would prevent a spoofer from reusing a token that was intended for another purpose (yet signed by the same issuer).  RFC 6749 section 4.1.3 has some guidance on this.  In my scenario, the token is an OAuth 2.0 token, and OAuth 2.0 makes extensive use of the audience claim (ref).\n\na configurable audience claim name (e.g. aud).\nif audience isn't configured, do not validate the audience (for back-compatibility).\nif audience is configured, validate that the value is present in the token.\n\nModifications\n\nAdd the logic in AuthenticationProviderToken.\nAdd related tests.\n\nVerifying this change\n\nUt passed", "createdAt": "2020-04-11T04:55:20Z", "url": "https://github.com/apache/pulsar/pull/6716", "merged": true, "mergeCommit": {"oid": "d6709ae987c37ca1bde3305d0bd2662d1e7a8c38"}, "closed": true, "closedAt": "2020-04-16T06:50:18Z", "author": {"login": "jiazhai"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWpZJ8AFqTM5MTc4NjI3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYBxqigBqjMyMzc3NTU1Mzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzg2Mjcw", "url": "https://github.com/apache/pulsar/pull/6716#pullrequestreview-391786270", "createdAt": "2020-04-11T17:43:26Z", "commit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzo0MzoyN1rOGEO14w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzo0NTo0NVrOGEO20Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA5MDY1OQ==", "bodyText": "I think we need to move the configuration validation logic to right after line 86. Since it indicates iellgall configuration settings.", "url": "https://github.com/apache/pulsar/pull/6716#discussion_r407090659", "createdAt": "2020-04-11T17:43:27Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "diffHunk": "@@ -126,9 +137,40 @@ private static String validateToken(final String token) throws AuthenticationExc\n     @SuppressWarnings(\"unchecked\")\n     private Jwt<?, Claims> authenticateToken(final String token) throws AuthenticationException {\n         try {\n-            return Jwts.parser()\n+            Jwt<?, Claims> jwt = Jwts.parser()\n                     .setSigningKey(validationKey)\n                     .parse(token);\n+\n+            if (audienceClaim != null) {\n+                if (audience == null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA5MDgzMw==", "bodyText": "If the broker configures the audience claim and receives a token that doesn't contain the audience claim, we should throw AuthenticationException.", "url": "https://github.com/apache/pulsar/pull/6716#discussion_r407090833", "createdAt": "2020-04-11T17:44:57Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "diffHunk": "@@ -126,9 +137,40 @@ private static String validateToken(final String token) throws AuthenticationExc\n     @SuppressWarnings(\"unchecked\")\n     private Jwt<?, Claims> authenticateToken(final String token) throws AuthenticationException {\n         try {\n-            return Jwts.parser()\n+            Jwt<?, Claims> jwt = Jwts.parser()\n                     .setSigningKey(validationKey)\n                     .parse(token);\n+\n+            if (audienceClaim != null) {\n+                if (audience == null){\n+                    throw new JwtException(\"Token Audience Claim [\" + audienceClaim\n+                                           + \"] configured, but Audience stands for this broker not.\");\n+                }\n+\n+                Object object = jwt.getBody().get(audienceClaim);\n+                if (object == null) {\n+                    throw new JwtException(\"Found null Audience in token, for claimed field: \" + audienceClaim);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA5MDg5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                throw new AuthenticationException(\"Audiences in token is not in String format: \" + object);\n          \n          \n            \n                                throw new AuthenticationException(\"Audiences in token is not in expected format: \" + object);", "url": "https://github.com/apache/pulsar/pull/6716#discussion_r407090897", "createdAt": "2020-04-11T17:45:45Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "diffHunk": "@@ -126,9 +137,40 @@ private static String validateToken(final String token) throws AuthenticationExc\n     @SuppressWarnings(\"unchecked\")\n     private Jwt<?, Claims> authenticateToken(final String token) throws AuthenticationException {\n         try {\n-            return Jwts.parser()\n+            Jwt<?, Claims> jwt = Jwts.parser()\n                     .setSigningKey(validationKey)\n                     .parse(token);\n+\n+            if (audienceClaim != null) {\n+                if (audience == null){\n+                    throw new JwtException(\"Token Audience Claim [\" + audienceClaim\n+                                           + \"] configured, but Audience stands for this broker not.\");\n+                }\n+\n+                Object object = jwt.getBody().get(audienceClaim);\n+                if (object == null) {\n+                    throw new JwtException(\"Found null Audience in token, for claimed field: \" + audienceClaim);\n+                }\n+\n+                if (object instanceof List) {\n+                    List<String> audiences = (List<String>) object;\n+                    // audience not contains this broker, throw exception.\n+                    if (!audiences.stream().anyMatch(audienceInToken -> audienceInToken.equals(audience))) {\n+                        throw new AuthenticationException(\"Audiences in token: [\" + String.join(\", \", audiences)\n+                                                          + \"] not contains this broker: \" + audience);\n+                    }\n+                } else if (object instanceof String) {\n+                    if (!object.equals(audience)) {\n+                        throw new AuthenticationException(\"Audiences in token: [\" + object\n+                                                          + \"] not contains this broker: \" + audience);\n+                    }\n+                } else {\n+                    // should not reach here.\n+                    throw new AuthenticationException(\"Audiences in token is not in String format: \" + object);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/fcc34938a5c4e0765e4daa9393c30ae0322618de", "committedDate": "2020-04-11T09:48:06Z", "message": "fix licencecheck for jjwt version update"}, "afterCommit": {"oid": "1c63f199f9a0707792bbdc023b7b208922be21d9", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/1c63f199f9a0707792bbdc023b7b208922be21d9", "committedDate": "2020-04-12T14:54:49Z", "message": "rebase master, chanage following comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODk1NTc5", "url": "https://github.com/apache/pulsar/pull/6716#pullrequestreview-391895579", "createdAt": "2020-04-12T21:13:47Z", "commit": {"oid": "1c63f199f9a0707792bbdc023b7b208922be21d9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQyMToxMzo0N1rOGEYv9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQyMToxMzo0N1rOGEYv9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI1Mjk4Mw==", "bodyText": "I think the check here should be moved to initialize method.", "url": "https://github.com/apache/pulsar/pull/6716#discussion_r407252983", "createdAt": "2020-04-12T21:13:47Z", "author": {"login": "sijie"}, "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authentication/AuthenticationProviderToken.java", "diffHunk": "@@ -126,9 +137,40 @@ private static String validateToken(final String token) throws AuthenticationExc\n     @SuppressWarnings(\"unchecked\")\n     private Jwt<?, Claims> authenticateToken(final String token) throws AuthenticationException {\n         try {\n-            return Jwts.parser()\n+            Jwt<?, Claims> jwt = Jwts.parser()\n                     .setSigningKey(validationKey)\n                     .parse(token);\n+\n+            if (audienceClaim != null) {\n+                if (audience == null){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA5MDY1OQ=="}, "originalCommit": {"oid": "fcc34938a5c4e0765e4daa9393c30ae0322618de"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxOTczNzgz", "url": "https://github.com/apache/pulsar/pull/6716#pullrequestreview-391973783", "createdAt": "2020-04-13T06:06:42Z", "commit": {"oid": "51724308bf51d78201cde6b717075ae068b2eead"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67d0627188d5221ce64f4b5527eb9fb349225c03", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/67d0627188d5221ce64f4b5527eb9fb349225c03", "committedDate": "2020-04-16T00:44:09Z", "message": "add audience verify in AuthenticationProviderToken"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5891a7087ffe4f22e0ffe9d8b1b88030eb69a6b1", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/5891a7087ffe4f22e0ffe9d8b1b88030eb69a6b1", "committedDate": "2020-04-16T00:44:09Z", "message": "change doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9c81c1f37bb54e57abb6f6c4a8ff9c1674bcdaf", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/b9c81c1f37bb54e57abb6f6c4a8ff9c1674bcdaf", "committedDate": "2020-04-16T00:44:09Z", "message": "fix licencecheck for jjwt version update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c538e01da3812bcea6c2d70998582db060b7a4c", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/8c538e01da3812bcea6c2d70998582db060b7a4c", "committedDate": "2020-04-16T00:44:09Z", "message": "rebase master, chanage following comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c63891a8593de303be257c5a65499070355244b5", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/c63891a8593de303be257c5a65499070355244b5", "committedDate": "2020-04-16T00:44:09Z", "message": "change following comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e99bc7618c7a2caa491072c6419cc773a62061c5", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/e99bc7618c7a2caa491072c6419cc773a62061c5", "committedDate": "2020-04-16T00:44:09Z", "message": "change ut"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51724308bf51d78201cde6b717075ae068b2eead", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/51724308bf51d78201cde6b717075ae068b2eead", "committedDate": "2020-04-13T05:44:50Z", "message": "change following comments"}, "afterCommit": {"oid": "e99bc7618c7a2caa491072c6419cc773a62061c5", "author": {"user": {"login": "jiazhai", "name": "Jia Zhai"}}, "url": "https://github.com/apache/pulsar/commit/e99bc7618c7a2caa491072c6419cc773a62061c5", "committedDate": "2020-04-16T00:44:09Z", "message": "change ut"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4921, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}