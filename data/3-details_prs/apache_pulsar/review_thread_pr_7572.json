{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNzg0NTg5", "number": 7572, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNTozMjo0MFrOEPZrww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDowOTo1OFrOER1mpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTg0ODk5OnYy", "diffSide": "RIGHT", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNTozMjo0MFrOGzF5Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNTozMjo0MFrOGzF5Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyNzE1OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (consumerStatsRequestTimer_.use_count() > 0) {\n          \n          \n            \n                if (consumerStatsRequestTimer_) {", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456227158", "createdAt": "2020-07-17T05:32:40Z", "author": {"login": "merlimat"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -289,13 +286,14 @@ void ClientConnection::startConsumerStatsTimer(std::vector<uint64_t> consumerSta\n         consumerStatsRequests.push_back(it->first);\n     }\n \n-    DeadlineTimerPtr timer = consumerStatsRequestTimer_;\n-    if (timer) {\n-        timer->expires_from_now(operationsTimeout_);\n-        timer->async_wait(std::bind(&ClientConnection::handleConsumerStatsTimeout, shared_from_this(),\n-                                    std::placeholders::_1, consumerStatsRequests));\n+    // If the close operation has reset the consumerStatsRequestTimer_ then the use_count will be zero\n+    // Check if we have a timer still before we set the request timer to pop again.\n+    if (consumerStatsRequestTimer_.use_count() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTg1MzMwOnYy", "diffSide": "RIGHT", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNTozNTowOFrOGzF7vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNTozNTowOFrOGzF7vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyNzc3Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (keepAliveTimer_.use_count() > 0) {\n          \n          \n            \n                    if (keepAliveTimer_) {", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456227773", "createdAt": "2020-07-17T05:35:08Z", "author": {"login": "merlimat"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -1344,8 +1324,12 @@ void ClientConnection::handleKeepAliveTimeout() {\n         havePendingPingRequest_ = true;\n         sendCommand(Commands::newPing());\n \n-        keepAliveTimer_->expires_from_now(boost::posix_time::seconds(KeepAliveIntervalInSeconds));\n-        keepAliveTimer_->async_wait(std::bind(&ClientConnection::handleKeepAliveTimeout, shared_from_this()));\n+        // If the close operation has already called the keepAliveTimer_.reset() then the use_count will be zero And we do not attempt\n+        // to dereference the pointer.\n+        if (keepAliveTimer_.use_count() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0OTYzMDY2OnYy", "diffSide": "RIGHT", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1Mjo0NlrOGzoYsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1Mjo0NlrOGzoYsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjI0MA==", "bodyText": "Could we remove this?", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792240", "createdAt": "2020-07-18T13:52:46Z", "author": {"login": "jiazhai"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -25,6 +25,7 @@\n #include <boost/date_time/posix_time/posix_time.hpp>\n #include <boost/date_time/gregorian/gregorian.hpp>\n #include <climits>\n+// #include <unistd.h>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0OTYzMTc5OnYy", "diffSide": "LEFT", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NDo0NFrOGzoZPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NDo0NFrOGzoZPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjM4MQ==", "bodyText": "The changes in this file seems removed some of the latest change in master. This will cause regressions.", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792381", "createdAt": "2020-07-18T13:54:44Z", "author": {"login": "jiazhai"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -117,9 +118,6 @@ static Result getResult(ServerError serverError) {\n \n         case InvalidTxnStatus:\n             return ResultInvalidTxnStatusError;\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0OTYzMjUyOnYy", "diffSide": "LEFT", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NToyNVrOGzoZjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NToyNVrOGzoZjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjQ2MA==", "bodyText": "same as the above comments. this change is not needed for this fix?", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792460", "createdAt": "2020-07-18T13:55:25Z", "author": {"login": "jiazhai"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -417,15 +415,6 @@ void ClientConnection::handleSentPulsarConnect(const boost::system::error_code&\n     readNextCommand();\n }\n \n-void ClientConnection::handleSentAuthResponse(const boost::system::error_code& err,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0OTYzMjczOnYy", "diffSide": "LEFT", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NTozOFrOGzoZog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxMzo1NTozOFrOGzoZog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc5MjQ4Mg==", "bodyText": "same as above comments. this change is not needed for this fix?", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r456792482", "createdAt": "2020-07-18T13:55:38Z", "author": {"login": "jiazhai"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -1038,15 +1027,6 @@ void ClientConnection::handleIncomingCommand() {\n                     break;\n                 }\n \n-                case BaseCommand::AUTH_CHALLENGE: {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c47e4546f46fae8b5d60982b5821b5d9bc301b4f"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MTM5NDkyOnYy", "diffSide": "RIGHT", "path": "pulsar-client-cpp/lib/ClientConnection.cc", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDowOTo1OFrOG2w1Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDowOTo1OFrOG2w1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA3NjM0Mw==", "bodyText": "Please remove comment", "url": "https://github.com/apache/pulsar/pull/7572#discussion_r460076343", "createdAt": "2020-07-24T14:09:58Z", "author": {"login": "merlimat"}, "path": "pulsar-client-cpp/lib/ClientConnection.cc", "diffHunk": "@@ -1363,6 +1375,8 @@ void ClientConnection::close() {\n     if (isClosed()) {\n         return;\n     }\n+    // Use a sleep to stress the timers when the pop to find the race conditions with close().\n+    // sleep(30);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fe0e5a2f753c625014850155e420546cb603af3"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2483, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}