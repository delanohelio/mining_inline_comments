{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MzAwNzU3", "number": 6812, "title": "[C++] Fix message id is always the default value in send callback", "bodyText": "Motivation\nAfter commit of #4817, the send callback's 2nd argument became MessageId, but the MessageId in callback is always the default value (-1, -1, -1, -1). We need the message id in send callback if messages were sent successfully.\nThe problem is that the correct message id has been retrieved in ProducerImpl::ackReceived but not passed to the user provided callback. Because after messages were sent to BatchMessageContainer, the wrapper of user provided callback used the MessageId of user constructed Message as the 2nd argument, which is always (-1, -1, -1, -1).\nModifications\n\nRemove useless field messageId of BatchMessageContainer::MessageContainer. Then add const MessageId& argument to batchMessageCallBack instead.\nAdd tests for message id in send callback. Specially, for a batched message, each internal message's batch index was verified.\n\nVerifying this change\n\n Make sure that the change passes the CI checks.\n\nThis change added tests and can be verified as follows:\nRun BasicEndToEndTest.testSendCallback and BatchMessageTest.testSendCallback.", "createdAt": "2020-04-24T02:57:37Z", "url": "https://github.com/apache/pulsar/pull/6812", "merged": true, "mergeCommit": {"oid": "fc69a628abb92e3b5ecd8e98b8b00cc3738f4603"}, "closed": true, "closedAt": "2020-04-25T06:57:27Z", "author": {"login": "BewareMyPower"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcag-XsAH2gAyNDA4MzAwNzU3OjUyYWNkNTcxNTIzOGJlNTQ2OGQ5ZDRhNzY2ZTZhNTc2NmUwZjc0ZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABca28jyAFqTQwMDIyNzIzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "52acd5715238be5468d9d4a766e6a5766e0f74ff", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/52acd5715238be5468d9d4a766e6a5766e0f74ff", "committedDate": "2020-04-23T18:13:12Z", "message": "Fix bug: sendCallback's 2nd argument was always the default MessageId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94870e5948a095f8618a5428541b5644880d0c0f", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/94870e5948a095f8618a5428541b5644880d0c0f", "committedDate": "2020-04-23T18:21:24Z", "message": "Set batch index for each message's callback of batch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b710b985a469343501db8d019d910a1041974dc2", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/b710b985a469343501db8d019d910a1041974dc2", "committedDate": "2020-04-24T02:33:20Z", "message": "Add test for message id in send callback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NjMwMjg5", "url": "https://github.com/apache/pulsar/pull/6812#pullrequestreview-399630289", "createdAt": "2020-04-24T04:23:38Z", "commit": {"oid": "b710b985a469343501db8d019d910a1041974dc2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNDoyMzozOVrOGLFxxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNDoyMzozOVrOGLFxxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI4MjE4Mg==", "bodyText": "There's no hard guarantee that this callback will be executed before the receive loop is done.", "url": "https://github.com/apache/pulsar/pull/6812#discussion_r414282182", "createdAt": "2020-04-24T04:23:39Z", "author": {"login": "merlimat"}, "path": "pulsar-client-cpp/tests/BatchMessageTest.cc", "diffHunk": "@@ -982,4 +982,48 @@ TEST(BatchMessageTest, testPraseMessageBatchEntry) {\n         ASSERT_EQ(message.getDataAsString(), expected.content);\n         ASSERT_EQ(message.getProperty(expected.propKey), expected.propValue);\n     }\n-}\n\\ No newline at end of file\n+}\n+\n+TEST(BatchMessageTest, testSendCallback) {\n+    const std::string topicName = \"persistent://public/default/BasicMessageTest-testSendCallback\";\n+\n+    Client client(lookupUrl);\n+\n+    constexpr int numMessagesOfBatch = 3;\n+\n+    ProducerConfiguration producerConfig;\n+    producerConfig.setBatchingEnabled(5);\n+    producerConfig.setBatchingMaxMessages(numMessagesOfBatch);\n+    producerConfig.setBatchingMaxPublishDelayMs(1000);  // 1 s, it's long enough for 3 messages batched\n+    producerConfig.setMaxPendingMessages(numMessagesOfBatch);\n+\n+    Producer producer;\n+    ASSERT_EQ(ResultOk, client.createProducer(topicName, producerConfig, producer));\n+\n+    Consumer consumer;\n+    ASSERT_EQ(ResultOk, client.subscribe(topicName, \"SubscriptionName\", consumer));\n+\n+    std::set<MessageId> sentIdSet;\n+    for (int i = 0; i < numMessagesOfBatch; i++) {\n+        const auto msg = MessageBuilder().setContent(\"a\").build();\n+        producer.sendAsync(msg, [&sentIdSet, i](Result result, const MessageId& id) {\n+            ASSERT_EQ(ResultOk, result);\n+            ASSERT_EQ(i, id.batchIndex());\n+            sentIdSet.emplace(id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b710b985a469343501db8d019d910a1041974dc2"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a76dd84cd572ac4bcd2a4e2126ab08a94dcb0e4", "author": {"user": {"login": "BewareMyPower", "name": "Yunze Xu"}}, "url": "https://github.com/apache/pulsar/commit/1a76dd84cd572ac4bcd2a4e2126ab08a94dcb0e4", "committedDate": "2020-04-24T17:09:49Z", "message": "Ensure all send callbacks completed before ASSERT_EQ"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMjI3MjM2", "url": "https://github.com/apache/pulsar/pull/6812#pullrequestreview-400227236", "createdAt": "2020-04-24T19:49:08Z", "commit": {"oid": "1a76dd84cd572ac4bcd2a4e2126ab08a94dcb0e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3613, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}