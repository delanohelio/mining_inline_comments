{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1ODI3NzE2", "number": 8810, "title": "Fix valueType array flags", "bodyText": "For arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\nGiven inline class Point { ... } //value type\n[LPoint; is an array of valuetype elements, this means that if Point is flattened then [LPoint; is a flattened array. It also means that [LPoint; can never contain a null element. However, [LPoint; itself is not a valuetype it has identity (it can be locked), a field of this type can be NULL, etc.\nA two dimensional array of Point ([[LPoint;) is an array where its element type is [LPoint;. Therefore [[LPoint; is not an array of valuetype elements, it is just a regular reference array.\nThis PR ensures that the following is true:\n\nFor a given array, if it contains the J9ClassIsFlattened flag in the array classFlags then all the elements are flattened, and the size of each element can be retrieved by using J9ARRAYCLASS_GET_STRIDE(arrayClass).\nFor a given array, if it contains the J9ClassLargestAlignmentConstraintReference or J9ClassLargestAlignmentConstraintReference flag and the  J9ClassIsFlattened is also set then each element requires either reference (compressedRefs size) or double (64bit) alignment. If neither J9ClassLargestAlignmentConstraintReference or J9ClassLargestAlignmentConstraintReference is present then it requires single (32bit) alginment.\n\nFrom a GC perspective, valuetype or not valuetype isn't relevant, all that matters is flattened or unflattened. With this change there should be no reason to fetch the element class, all the data should be in the array class.", "createdAt": "2020-03-09T21:28:20Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8810", "merged": true, "mergeCommit": {"oid": "a1ed808a53bf98faaa1b4883829757d62746f4b9"}, "closed": true, "closedAt": "2020-03-10T21:16:15Z", "author": {"login": "tajila"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMEz-jABqjMxMTI0NzMzNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMWkrkgFqTM3MjIwMzAwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de99694b6df934a03cf690f0e21ad7982704150c", "author": {"user": {"login": "tajila", "name": "Tobi"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/de99694b6df934a03cf690f0e21ad7982704150c", "committedDate": "2020-03-09T21:26:25Z", "message": "Fix valueType array flags\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>"}, "afterCommit": {"oid": "31febb0efaef6a8814d1ecb6bc4f1c18a618a931", "author": {"user": {"login": "tajila", "name": "Tobi"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/31febb0efaef6a8814d1ecb6bc4f1c18a618a931", "committedDate": "2020-03-09T21:29:27Z", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31febb0efaef6a8814d1ecb6bc4f1c18a618a931", "author": {"user": {"login": "tajila", "name": "Tobi"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/31febb0efaef6a8814d1ecb6bc4f1c18a618a931", "committedDate": "2020-03-09T21:29:27Z", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>"}, "afterCommit": {"oid": "d0b41490b46492d31f910db22dab031637500175", "author": {"user": {"login": "tajila", "name": "Tobi"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d0b41490b46492d31f910db22dab031637500175", "committedDate": "2020-03-09T21:47:06Z", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0b41490b46492d31f910db22dab031637500175", "author": {"user": {"login": "tajila", "name": "Tobi"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d0b41490b46492d31f910db22dab031637500175", "committedDate": "2020-03-09T21:47:06Z", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>"}, "afterCommit": {"oid": "cbfbe2979a0e29c78c5369adf5f1e189b9ded037", "author": {"user": {"login": "tajila", "name": "Tobi"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/cbfbe2979a0e29c78c5369adf5f1e189b9ded037", "committedDate": "2020-03-09T21:48:07Z", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMDgzMTI0", "url": "https://github.com/eclipse-openj9/openj9/pull/8810#pullrequestreview-372083124", "createdAt": "2020-03-10T15:49:51Z", "commit": {"oid": "cbfbe2979a0e29c78c5369adf5f1e189b9ded037"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTo0OTo1MVrOF0VMaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTo0OTo1MVrOF0VMaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxNzUxMw==", "bodyText": "Please invert the & operands - this is why I was confused thinking you were adding flags.", "url": "https://github.com/eclipse-openj9/openj9/pull/8810#discussion_r390417513", "createdAt": "2020-03-10T15:49:51Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2894,12 +2894,19 @@ internalCreateRAMClassFromROMClassImpl(J9VMThread *vmThread, J9ClassLoader *clas\n \t\t\t\t} else {\n \t\t\t\t\tarity = 1;\n \t\t\t\t\tleafComponentType = elementClass;\n+\t\t\t\t\t/* For arrays of valueType elements (where componentType is a valuetype), the arrays themselves are not\n+\t\t\t\t\t * valuetypes but they should inherit the layout characteristics (ie. flattenable, etc.)\n+\t\t\t\t\t * of the valuetype elements. A 2D (or more) array of valuetype elements (where leafComponentType is a Valuetype but\n+\t\t\t\t\t * componentType is not) is not direct array array of valuetype elements, therefore it should not inherit any layout\n+\t\t\t\t\t * properties from the leafComponentType. A 2D array is an array of references so it can never be flattened, however, its\n+\t\t\t\t\t * elements may be flattened arrays.\n+\t\t\t\t\t */\n+\t\t\t\t\tramArrayClass->classFlags |= (J9ClassIsFlattened | J9ClassLargestAlignmentConstraintReference | J9ClassLargestAlignmentConstraintDouble) & elementClass->classFlags;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbfbe2979a0e29c78c5369adf5f1e189b9ded037"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22bde10d61a6b250f2a4b8969eb0206f624d9bfb", "author": {"user": {"login": "tajila", "name": "Tobi"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/22bde10d61a6b250f2a4b8969eb0206f624d9bfb", "committedDate": "2020-03-10T16:34:50Z", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbfbe2979a0e29c78c5369adf5f1e189b9ded037", "author": {"user": {"login": "tajila", "name": "Tobi"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/cbfbe2979a0e29c78c5369adf5f1e189b9ded037", "committedDate": "2020-03-09T21:48:07Z", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>"}, "afterCommit": {"oid": "22bde10d61a6b250f2a4b8969eb0206f624d9bfb", "author": {"user": {"login": "tajila", "name": "Tobi"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/22bde10d61a6b250f2a4b8969eb0206f624d9bfb", "committedDate": "2020-03-10T16:34:50Z", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjAzMDA3", "url": "https://github.com/eclipse-openj9/openj9/pull/8810#pullrequestreview-372203007", "createdAt": "2020-03-10T18:11:09Z", "commit": {"oid": "22bde10d61a6b250f2a4b8969eb0206f624d9bfb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 443, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}