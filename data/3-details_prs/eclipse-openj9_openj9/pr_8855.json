{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3NzY5NTU2", "number": 8855, "title": "JDK15 : Add loadLibraryWithPath package access APIs & Invoke registerBootstrapLibrary() in JVM_LoadLibrary", "bodyText": "JDK15 : Add loadLibraryWithPath package access APIs & Invoke registerBootstrapLibrary() in JVM_LoadLibrary\nstatic void loadLibrary(Class<?> caller, File file) is added which calls loadLibraryWithPath(String libName, ClassLoade loader, String libraryPath);\nstatic void loadLibrary(Class<?> caller, String libName) is added which calls loadLibraryWithClassLoader(String libName, ClassLoader loader);\nInvoke registerBootstrapLibrary() in JVM_LoadLibrary.\nVerified in a local build.\nAdditional note:\n\nJVM_LoadLibrary() is not used before JDK15;\nIt is only invoked by jdk.internal.loader.BootLoader.loadLibrary();\nOpenJ9 has its own implementation of java.lang.ClassLoader which invokes loadLibraryWithPath() and its friends, not JVM_LoadLibrary().\n\nFixes #8853\nReviewer: @pshipton\nFYI: @DanHeidinga @andrew-m-leonard\nSigned-off-by: Jason Feng fengj@ca.ibm.com", "createdAt": "2020-03-13T13:12:36Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8855", "merged": true, "mergeCommit": {"oid": "1b4de6137550b28a231a666c71d61e9dd970f7ca"}, "closed": true, "closedAt": "2020-03-18T12:25:00Z", "author": {"login": "JasonFengJ9"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNSGTAAFqTM3NDM5NzI5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO2aZuAFqTM3NjgxMzAwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Mzk3Mjky", "url": "https://github.com/eclipse-openj9/openj9/pull/8855#pullrequestreview-374397292", "createdAt": "2020-03-13T15:32:16Z", "commit": {"oid": "002da6266225ef76f9844b0151308668a68d5ec0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNTozMjoxNlrOF2IMfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNTozMjoxNlrOF2IMfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwMTY5Mg==", "bodyText": "Perhaps this should call loadLibraryWithClassLoader(), which might fix the UnsatisfiedLinkError.", "url": "https://github.com/eclipse-openj9/openj9/pull/8855#discussion_r392301692", "createdAt": "2020-03-13T15:32:16Z", "author": {"login": "pshipton"}, "path": "jcl/src/java.base/share/classes/java/lang/ClassLoader.java", "diffHunk": "@@ -1957,6 +1957,15 @@ static void loadLibrary(Class<?> caller, String name, boolean fullPath) {\n \t\tloadLibraryWithClassLoader(name, caller.getClassLoaderImpl());\n }\n \n+/*[IF Java15]*/\n+static void loadLibrary(Class<?> caller, File file) {\n+\tloadLibraryWithPath(file.getAbsolutePath(), caller.getClassLoaderImpl(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "002da6266225ef76f9844b0151308668a68d5ec0"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "002da6266225ef76f9844b0151308668a68d5ec0", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/002da6266225ef76f9844b0151308668a68d5ec0", "committedDate": "2020-03-13T12:50:18Z", "message": "Add loadLibraryWithPath package access APIs for JDK15\n\nstatic void loadLibrary(Class<?> caller, File file) is added which calls\nloadLibraryWithPath(String libName, ClassLoade loader, String\nlibraryPath);\nstatic void loadLibrary(Class<?> caller, String libName) is added which\ncalls loadLibraryWithClassLoader(String libName, ClassLoader loader).\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}, "afterCommit": {"oid": "9eb61512b390d4f225066c8f7e557c9b99e8fbf4", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9eb61512b390d4f225066c8f7e557c9b99e8fbf4", "committedDate": "2020-03-17T20:51:27Z", "message": "Add loadLibraryWithPath package access APIs for JDK15\nInvoke registerBootstrapLibrary() in JVM_LoadLibrary\n\nstatic void loadLibrary(Class<?> caller, File file) is added which calls\nloadLibraryWithPath(String libName, ClassLoade loader, String\nlibraryPath);\nstatic void loadLibrary(Class<?> caller, String libName) is added which\ncalls loadLibraryWithClassLoader(String libName, ClassLoader loader);\nInvoke registerBootstrapLibrary() in JVM_LoadLibrary.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTEwMTMy", "url": "https://github.com/eclipse-openj9/openj9/pull/8855#pullrequestreview-376510132", "createdAt": "2020-03-18T01:36:41Z", "commit": {"oid": "9eb61512b390d4f225066c8f7e557c9b99e8fbf4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTozNjo0MVrOF3zjbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTozNjo0MVrOF3zjbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MDY1NA==", "bodyText": "This line can be removed since OpenJ9 doesn't support Java 1.4", "url": "https://github.com/eclipse-openj9/openj9/pull/8855#discussion_r394060654", "createdAt": "2020-03-18T01:36:41Z", "author": {"login": "pshipton"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -3577,69 +3577,25 @@ JVM_LoadSystemLibrary(const char *libName)\n  *\tDLL: jvm\n  */\n \n-/* NOTE THIS IS NOT REQUIRED FOR 1.4 */\n+/* NOTE THIS IS NOT REQUIRED FOR 1.4", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb61512b390d4f225066c8f7e557c9b99e8fbf4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTEzMTEw", "url": "https://github.com/eclipse-openj9/openj9/pull/8855#pullrequestreview-376513110", "createdAt": "2020-03-18T01:47:28Z", "commit": {"oid": "9eb61512b390d4f225066c8f7e557c9b99e8fbf4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTo0NzoyOFrOF3ztoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTo0NzoyOFrOF3ztoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MzI2NQ==", "bodyText": "The tracepoints should remain.", "url": "https://github.com/eclipse-openj9/openj9/pull/8855#discussion_r394063265", "createdAt": "2020-03-18T01:47:28Z", "author": {"login": "pshipton"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -3577,69 +3577,25 @@ JVM_LoadSystemLibrary(const char *libName)\n  *\tDLL: jvm\n  */\n \n-/* NOTE THIS IS NOT REQUIRED FOR 1.4 */\n+/* NOTE THIS IS NOT REQUIRED FOR 1.4\n+ * Additional note: this is required by JDK15+ jdk.internal.loader.NativeLibraries.load().\n+ *  it is only invoked by jdk.internal.loader.BootLoader.loadLibrary(),\n+ */\n \n void* JNICALL\n-JVM_LoadLibrary(const char *libName)\n+JVM_LoadLibrary(const char* libName)\n {\n-\tJNIEnv *env;\n-\tJavaVM *vm = (JavaVM *) BFUjavaVM;\n-\tchar errMsg[512];\n+\tvoid* result = NULL;\n+\tJ9NativeLibrary* nativeLibrary = NULL;\n+\tJ9JavaVM* javaVM = (J9JavaVM*)BFUjavaVM;\n+\tJ9InternalVMFunctions* vmFuncs = javaVM->internalVMFunctions;\n+\tJ9VMThread* currentThread = vmFuncs->currentVMThread(javaVM);\n \n-#ifdef WIN32\n-\tHINSTANCE dllHandle;\n-\tUINT prevMode;\n-\n-\tTrc_SC_LoadLibrary_Entry(libName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb61512b390d4f225066c8f7e557c9b99e8fbf4"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dabcea0becf5df783960a8b2abdb1e65f8a94c8e", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/dabcea0becf5df783960a8b2abdb1e65f8a94c8e", "committedDate": "2020-03-18T02:19:20Z", "message": "Add loadLibraryWithPath package access APIs for JDK15\nInvoke registerBootstrapLibrary() in JVM_LoadLibrary\n\nstatic void loadLibrary(Class<?> caller, File file) is added which calls\nloadLibraryWithPath(String libName, ClassLoade loader, String\nlibraryPath);\nstatic void loadLibrary(Class<?> caller, String libName) is added which\ncalls loadLibraryWithClassLoader(String libName, ClassLoader loader);\nInvoke registerBootstrapLibrary() in JVM_LoadLibrary.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9eb61512b390d4f225066c8f7e557c9b99e8fbf4", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9eb61512b390d4f225066c8f7e557c9b99e8fbf4", "committedDate": "2020-03-17T20:51:27Z", "message": "Add loadLibraryWithPath package access APIs for JDK15\nInvoke registerBootstrapLibrary() in JVM_LoadLibrary\n\nstatic void loadLibrary(Class<?> caller, File file) is added which calls\nloadLibraryWithPath(String libName, ClassLoade loader, String\nlibraryPath);\nstatic void loadLibrary(Class<?> caller, String libName) is added which\ncalls loadLibraryWithClassLoader(String libName, ClassLoader loader);\nInvoke registerBootstrapLibrary() in JVM_LoadLibrary.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}, "afterCommit": {"oid": "dabcea0becf5df783960a8b2abdb1e65f8a94c8e", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/dabcea0becf5df783960a8b2abdb1e65f8a94c8e", "committedDate": "2020-03-18T02:19:20Z", "message": "Add loadLibraryWithPath package access APIs for JDK15\nInvoke registerBootstrapLibrary() in JVM_LoadLibrary\n\nstatic void loadLibrary(Class<?> caller, File file) is added which calls\nloadLibraryWithPath(String libName, ClassLoade loader, String\nlibraryPath);\nstatic void loadLibrary(Class<?> caller, String libName) is added which\ncalls loadLibraryWithClassLoader(String libName, ClassLoader loader);\nInvoke registerBootstrapLibrary() in JVM_LoadLibrary.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODEzMDAw", "url": "https://github.com/eclipse-openj9/openj9/pull/8855#pullrequestreview-376813000", "createdAt": "2020-03-18T12:24:44Z", "commit": {"oid": "dabcea0becf5df783960a8b2abdb1e65f8a94c8e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 480, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}