{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNjUwNzQw", "number": 8976, "title": "Implement monitor enter/exit for valuetypes", "bodyText": "Valuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\nMonitor operation assembly sequence are the following 3 forms:\n\nfor monitor whose type is known to be value type call the VM helper\ndirectly\nfor monitor whose type is known to be identity type use the existing\nassembly sequence\nfor monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang yizhang@ca.ibm.com\nCo-Authored-By: Leonardo2718 leonardo2718@protonmail.com", "createdAt": "2020-03-25T15:18:43Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8976", "merged": true, "mergeCommit": {"oid": "c21ef3a99189365766a9ebaccc1d7084ec4f4492"}, "closed": true, "closedAt": "2020-04-21T12:42:34Z", "author": {"login": "cathyzhyi"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRJJpwgBqjMxNjQ0NjIxMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV9j6yABqjMyMTg2MDc2Nzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "482fd09bafdc7c7c18c8beef6090b3d20013e88c", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/482fd09bafdc7c7c18c8beef6090b3d20013e88c", "committedDate": "2020-03-25T15:17:52Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}, "afterCommit": {"oid": "6aeba4761a8ab9a9ea83b560291f24d46a6a7fe3", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/6aeba4761a8ab9a9ea83b560291f24d46a6a7fe3", "committedDate": "2020-03-25T15:22:21Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6aeba4761a8ab9a9ea83b560291f24d46a6a7fe3", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/6aeba4761a8ab9a9ea83b560291f24d46a6a7fe3", "committedDate": "2020-03-25T15:22:21Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}, "afterCommit": {"oid": "c062fc3cf0a5e052405283c8e39ba2aef20c6d24", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/c062fc3cf0a5e052405283c8e39ba2aef20c6d24", "committedDate": "2020-04-01T18:28:34Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c062fc3cf0a5e052405283c8e39ba2aef20c6d24", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/c062fc3cf0a5e052405283c8e39ba2aef20c6d24", "committedDate": "2020-04-01T18:28:34Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}, "afterCommit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "committedDate": "2020-04-01T19:29:26Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1OTI5MzI2", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#pullrequestreview-385929326", "createdAt": "2020-04-01T20:35:15Z", "commit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMDozNToxNVrOF_Rmvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMDozNToxNVrOF_Rmvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5MzA1NA==", "bodyText": "Wouldn't it be safer to say == TR_no?", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r401893054", "createdAt": "2020-04-01T20:35:15Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4508,6 +4511,25 @@ void J9::X86::TreeEvaluator::transactionalMemoryJITMonitorEntry(TR::Node\n       cg->stopUsingRegister(counterReg);\n    }\n \n+void\n+J9::X86::TreeEvaluator::monitorEnterOrExitForValueTypeClass(\n+      TR::Node *node,\n+      TR::LabelSymbol *snippetLabel,\n+      TR::CodeGenerator *cg)\n+   {\n+   if (cg->isMonitorValueType(node) != TR_maybe)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MjM2ODQ0", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#pullrequestreview-387236844", "createdAt": "2020-04-03T13:06:20Z", "commit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMzowNjoyMFrOGAUnOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMzowNjoyMFrOGAUnOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MDkwNw==", "bodyText": "Wouldn't this be better phrased as get the most abstract type the monitor may be operating on?", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r402990907", "createdAt": "2020-04-03T13:06:20Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/codegen/J9CodeGenerator.hpp", "diffHunk": "@@ -298,21 +298,41 @@ class OMR_EXTENSIBLE CodeGenerator : public OMR::CodeGeneratorConnector\n    TR_BitVector *setLiveMonitors(TR_BitVector *v) {return (_liveMonitors = v);}\n \n public:\n+   /*\n+    * \\brief\n+    *    Get the class or the superclass of the monitor object.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MjM3OTkx", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#pullrequestreview-387237991", "createdAt": "2020-04-03T13:07:49Z", "commit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMzowNzo1MFrOGAUqrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMzowNzo1MFrOGAUqrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MTc5MA==", "bodyText": "Why is this unconditional? It is only true if value types are enabled right?", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r402991790", "createdAt": "2020-04-03T13:07:50Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -132,14 +132,17 @@ inline void generateLoadJ9Class(TR::Node* node, TR::Register* j9class, TR::Regis\n       switch (opValue)\n          {\n          case TR::checkcastAndNULLCHK:\n+         case TR::monent:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MjM5MDM1", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#pullrequestreview-387239035", "createdAt": "2020-04-03T13:09:08Z", "commit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMzowOTowOFrOGAUtzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMzowOTowOFrOGAUtzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MjU5MA==", "bodyText": "Shouldn't this have the verb generate in the name?", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r402992590", "createdAt": "2020-04-03T13:09:08Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4508,6 +4511,25 @@ void J9::X86::TreeEvaluator::transactionalMemoryJITMonitorEntry(TR::Node\n       cg->stopUsingRegister(counterReg);\n    }\n \n+void\n+J9::X86::TreeEvaluator::monitorEnterOrExitForValueTypeClass(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MjM5NTk2", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#pullrequestreview-387239596", "createdAt": "2020-04-03T13:09:50Z", "commit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMzowOTo1MFrOGAUvhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMzowOTo1MFrOGAUvhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MzAzMQ==", "bodyText": "Why did this move?", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r402993031", "createdAt": "2020-04-03T13:09:50Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4518,20 +4540,22 @@ J9::X86::TreeEvaluator::VMmonentEvaluator(\n    // appropriate excepting instruction we must make sure to reset the\n    // excepting instruction since our children may have set it.\n    //\n+   TR::Compilation *comp = cg->comp();\n+   TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());\n    static const char *noInline = feGetEnv(\"TR_NoInlineMonitor\");\n-   static int32_t monEntCount = 0;\n    static const char *firstMonEnt = feGetEnv(\"TR_FirstMonEnt\");\n-   static const char *doCmpFirst = feGetEnv(\"TR_AddCMPBeforeCMPXCHG\");\n+   static int32_t monEntCount = 0;\n    bool reservingLock = false;\n    bool normalLockPreservingReservation = false;\n    bool dummyMethodMonitor = false;\n-   TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());\n-   TR::Compilation *comp = cg->comp();\n+\n+   static const char *doCmpFirst = feGetEnv(\"TR_AddCMPBeforeCMPXCHG\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "committedDate": "2020-04-01T19:29:26Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}, "afterCommit": {"oid": "67d252222c68be3cd6ad852cdcaec61ad750f68a", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/67d252222c68be3cd6ad852cdcaec61ad750f68a", "committedDate": "2020-04-03T14:38:35Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67d252222c68be3cd6ad852cdcaec61ad750f68a", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/67d252222c68be3cd6ad852cdcaec61ad750f68a", "committedDate": "2020-04-03T14:38:35Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}, "afterCommit": {"oid": "a11446a1baed9a11eaec0fd1376a92ed0a0bd3f3", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/a11446a1baed9a11eaec0fd1376a92ed0a0bd3f3", "committedDate": "2020-04-03T21:02:50Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a11446a1baed9a11eaec0fd1376a92ed0a0bd3f3", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/a11446a1baed9a11eaec0fd1376a92ed0a0bd3f3", "committedDate": "2020-04-03T21:02:50Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}, "afterCommit": {"oid": "b2849f7fbe0e88a7cbedf81e0191b8e68f074a7a", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/b2849f7fbe0e88a7cbedf81e0191b8e68f074a7a", "committedDate": "2020-04-03T21:28:08Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2849f7fbe0e88a7cbedf81e0191b8e68f074a7a", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/b2849f7fbe0e88a7cbedf81e0191b8e68f074a7a", "committedDate": "2020-04-03T21:28:08Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}, "afterCommit": {"oid": "7b6017f73376fa3b529780f47f39597e10cc4e9d", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/7b6017f73376fa3b529780f47f39597e10cc4e9d", "committedDate": "2020-04-03T21:33:00Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b6017f73376fa3b529780f47f39597e10cc4e9d", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/7b6017f73376fa3b529780f47f39597e10cc4e9d", "committedDate": "2020-04-03T21:33:00Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}, "afterCommit": {"oid": "ad67a9270d262397e4e4ccb9f1b0f13836851c1a", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/ad67a9270d262397e4e4ccb9f1b0f13836851c1a", "committedDate": "2020-04-05T02:46:03Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad67a9270d262397e4e4ccb9f1b0f13836851c1a", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/ad67a9270d262397e4e4ccb9f1b0f13836851c1a", "committedDate": "2020-04-05T02:46:03Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}, "afterCommit": {"oid": "f9b7fd08ed6af62604f8b307341196ecc615296a", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/f9b7fd08ed6af62604f8b307341196ecc615296a", "committedDate": "2020-04-07T01:49:21Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9b7fd08ed6af62604f8b307341196ecc615296a", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/f9b7fd08ed6af62604f8b307341196ecc615296a", "committedDate": "2020-04-07T01:49:21Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}, "afterCommit": {"oid": "f146f439b2e196c5ad946a905143bf956afcb9ff", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/f146f439b2e196c5ad946a905143bf956afcb9ff", "committedDate": "2020-04-07T01:51:16Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTIwOTI0", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#pullrequestreview-389120924", "createdAt": "2020-04-07T13:34:53Z", "commit": {"oid": "f146f439b2e196c5ad946a905143bf956afcb9ff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzozNDo1M1rOGCD06Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzo0OToxNFrOGCEd-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMzAzMw==", "bodyText": "I don't think you need to call the MonitorTypeMap constructor explicitly here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               _monitorMapping(MonitorTypeMap(std::less<ncount_t>(), MonitorMapAllocator(self()->comp()->trMemory()->heapMemoryRegion()))),\n          \n          \n            \n               _monitorMapping(std::less<ncount_t>(), MonitorMapAllocator(self()->comp()->trMemory()->heapMemoryRegion())),", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404813033", "createdAt": "2020-04-07T13:34:53Z", "author": {"login": "Leonardo2718"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -78,7 +78,7 @@ J9::CodeGenerator::CodeGenerator() :\n    _liveMonitors(NULL),\n    _nodesSpineCheckedList(getTypedAllocator<TR::Node*>(TR::comp()->allocator())),\n    _jniCallSites(getTypedAllocator<TR_Pair<TR_ResolvedMethod,TR::Instruction> *>(TR::comp()->allocator())),\n-   _monitorMapping(self()->comp()->trMemory(), 256),\n+   _monitorMapping(MonitorTypeMap(std::less<ncount_t>(), MonitorMapAllocator(self()->comp()->trMemory()->heapMemoryRegion()))),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f146f439b2e196c5ad946a905143bf956afcb9ff"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNTI3OA==", "bodyText": "I think it would cleaner to have\nauto monIt = _monitorMapping.find(monNode->getGlobalIndex());\nreturn monIt != _monitorMapping.end() ? (TR_OpaqueClassBlock *)*monIt : NULL", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404815278", "createdAt": "2020-04-07T13:38:05Z", "author": {"login": "Leonardo2718"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -4980,15 +4978,36 @@ J9::CodeGenerator::generatePoisonNode(TR::Block *currentBlock, TR::SymbolReferen\n void\n J9::CodeGenerator::addMonClass(TR::Node* monNode, TR_OpaqueClassBlock* clazz)\n    {\n-   _monitorMapping.add(monNode);\n-   _monitorMapping.add(clazz);\n+   _monitorMapping[monNode->getGlobalIndex()] = clazz;\n    }\n \n TR_OpaqueClassBlock *\n J9::CodeGenerator::getMonClass(TR::Node* monNode)\n    {\n-   for (int i = 0; i < _monitorMapping.size(); i += 2)\n-      if (_monitorMapping[i] == monNode)\n-         return (TR_OpaqueClassBlock *) _monitorMapping[i+1];\n-   return 0;\n+   return _monitorMapping.find(monNode->getGlobalIndex()) != _monitorMapping.end() ?\n+            (TR_OpaqueClassBlock *) _monitorMapping[monNode->getGlobalIndex()] :\n+            NULL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f146f439b2e196c5ad946a905143bf956afcb9ff"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNzYyNw==", "bodyText": "For consistency\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                *    whether a monitor object is of value type\n          \n          \n            \n                *    Whether a monitor object is of value type", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404817627", "createdAt": "2020-04-07T13:41:20Z", "author": {"login": "Leonardo2718"}, "path": "runtime/compiler/codegen/J9CodeGenerator.hpp", "diffHunk": "@@ -298,21 +298,41 @@ class OMR_EXTENSIBLE CodeGenerator : public OMR::CodeGeneratorConnector\n    TR_BitVector *setLiveMonitors(TR_BitVector *v) {return (_liveMonitors = v);}\n \n public:\n+   /*\n+    * \\brief\n+    *    Get the most abstract type the monitor may be operating on.\n+    *\n+    * \\note\n+    *    java.lang.Object is only returned when the monitor object is of type java.lang.Object but not any subclasses\n+    */\n+   TR_OpaqueClassBlock* getMonClass(TR::Node* monNode);\n \n-TR_OpaqueClassBlock* getMonClass(TR::Node* monNode);\n+   /*\n+    * \\brief\n+    *    whether a monitor object is of value type", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f146f439b2e196c5ad946a905143bf956afcb9ff"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxOTU0MA==", "bodyText": "Would it be possible to make this a TR_ASSERT_FATAL?", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404819540", "createdAt": "2020-04-07T13:43:59Z", "author": {"login": "Leonardo2718"}, "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -131,15 +131,19 @@ inline void generateLoadJ9Class(TR::Node* node, TR::Register* j9class, TR::Regis\n       {\n       switch (opValue)\n          {\n+         case TR::monent:\n+         case TR::monexit:\n+            TR_ASSERT_FATAL(TR::Compiler->om.areValueTypesEnabled(), \"monent and monexit evaluators should only call generateLoadJ9Class when value type is enabled\");\n          case TR::checkcastAndNULLCHK:\n             needsNULLCHK = true;\n             break;\n          case TR::icall: // TR_checkAssignable\n             return; // j9class register already holds j9class\n+         case TR::checkcast:\n+         case TR::instanceof:\n+            break;\n          default:\n-            TR_ASSERT(opValue == TR::checkcast ||\n-                      opValue == TR::instanceof,\n-                     \"Unexpected opCode for generateLoadJ9Class %s.\", node->getOpCode().getName());\n+            TR_ASSERT(false, \"Unexpected opCode for generateLoadJ9Class %s.\", node->getOpCode().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f146f439b2e196c5ad946a905143bf956afcb9ff"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMjMxMw==", "bodyText": "This could really be an auto, since it's clear what the type should be from the cast.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());\n          \n          \n            \n               auto fej9 = (TR_J9VMBase *)(cg->fe());", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404822313", "createdAt": "2020-04-07T13:47:38Z", "author": {"login": "Leonardo2718"}, "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4508,6 +4512,25 @@ void J9::X86::TreeEvaluator::transactionalMemoryJITMonitorEntry(TR::Node\n       cg->stopUsingRegister(counterReg);\n    }\n \n+void\n+J9::X86::TreeEvaluator::generateCheckForValueTypeMonitorEnterOrExit(\n+      TR::Node *node,\n+      TR::LabelSymbol *snippetLabel,\n+      TR::CodeGenerator *cg)\n+   {\n+   if (cg->isMonitorValueType(node) != TR_maybe)\n+      return;\n+   TR::Register *objectReg = cg->evaluate(node->getFirstChild());\n+   auto j9classReg = cg->allocateRegister();\n+   generateLoadJ9Class(node, j9classReg, objectReg, cg);\n+   TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f146f439b2e196c5ad946a905143bf956afcb9ff"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMzU0Ng==", "bodyText": "This static assert seems out of place.", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404823546", "createdAt": "2020-04-07T13:49:14Z", "author": {"login": "Leonardo2718"}, "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4508,6 +4512,25 @@ void J9::X86::TreeEvaluator::transactionalMemoryJITMonitorEntry(TR::Node\n       cg->stopUsingRegister(counterReg);\n    }\n \n+void\n+J9::X86::TreeEvaluator::generateCheckForValueTypeMonitorEnterOrExit(\n+      TR::Node *node,\n+      TR::LabelSymbol *snippetLabel,\n+      TR::CodeGenerator *cg)\n+   {\n+   if (cg->isMonitorValueType(node) != TR_maybe)\n+      return;\n+   TR::Register *objectReg = cg->evaluate(node->getFirstChild());\n+   auto j9classReg = cg->allocateRegister();\n+   generateLoadJ9Class(node, j9classReg, objectReg, cg);\n+   TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());\n+   auto classFlagsMR = generateX86MemoryReference(j9classReg, (uintptr_t)(fej9->getOffsetOfClassFlags()), cg);\n+   static_assert((uint32_t) J9ClassIsValueType < USHRT_MAX, \"J9ClassIsValueType must be less than 16bits\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f146f439b2e196c5ad946a905143bf956afcb9ff"}, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d0b15b8cac60737a8949f0e06252c8f8d8abc56", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/5d0b15b8cac60737a8949f0e06252c8f8d8abc56", "committedDate": "2020-04-07T14:37:44Z", "message": "Apply suggestions from code review\n\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}, "afterCommit": {"oid": "63c2ef5742f3d86cc594db6a5d79d951071a10c2", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/63c2ef5742f3d86cc594db6a5d79d951071a10c2", "committedDate": "2020-04-07T14:53:09Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "63c2ef5742f3d86cc594db6a5d79d951071a10c2", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/63c2ef5742f3d86cc594db6a5d79d951071a10c2", "committedDate": "2020-04-07T14:53:09Z", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}, "afterCommit": {"oid": "f537291299dabbd758d73b944515282930d0ac8c", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/f537291299dabbd758d73b944515282930d0ac8c", "committedDate": "2020-04-07T14:53:57Z", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f537291299dabbd758d73b944515282930d0ac8c", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/f537291299dabbd758d73b944515282930d0ac8c", "committedDate": "2020-04-07T14:53:57Z", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}, "afterCommit": {"oid": "9b8c7785ec1e3b6284743be1ee918ef02b6bfadc", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/9b8c7785ec1e3b6284743be1ee918ef02b6bfadc", "committedDate": "2020-04-07T16:10:44Z", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NDIxNjQ2", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#pullrequestreview-389421646", "createdAt": "2020-04-07T19:24:04Z", "commit": {"oid": "9b8c7785ec1e3b6284743be1ee918ef02b6bfadc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOToyNDowNFrOGCSq_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOToyNDowNFrOGCSq_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NjI1Mw==", "bodyText": "Sorry, I missed this earlier: you should avoid calling self() in constructors because it relies on undefined behaviour. You can use TR::comp() instead as is done to initialize other fields.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               _monitorMapping(std::less<ncount_t>(), MonitorMapAllocator(self()->comp()->trMemory()->heapMemoryRegion())),\n          \n          \n            \n               _monitorMapping(std::less<ncount_t>(), MonitorMapAllocator(TR::comp()->trMemory()->heapMemoryRegion())),", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r405056253", "createdAt": "2020-04-07T19:24:04Z", "author": {"login": "Leonardo2718"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -78,7 +78,7 @@ J9::CodeGenerator::CodeGenerator() :\n    _liveMonitors(NULL),\n    _nodesSpineCheckedList(getTypedAllocator<TR::Node*>(TR::comp()->allocator())),\n    _jniCallSites(getTypedAllocator<TR_Pair<TR_ResolvedMethod,TR::Instruction> *>(TR::comp()->allocator())),\n-   _monitorMapping(self()->comp()->trMemory(), 256),\n+   _monitorMapping(std::less<ncount_t>(), MonitorMapAllocator(self()->comp()->trMemory()->heapMemoryRegion())),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b8c7785ec1e3b6284743be1ee918ef02b6bfadc"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b8c7785ec1e3b6284743be1ee918ef02b6bfadc", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/9b8c7785ec1e3b6284743be1ee918ef02b6bfadc", "committedDate": "2020-04-07T16:10:44Z", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}, "afterCommit": {"oid": "ac2a0a19731c9d7aee31e2a0abcf98eb30e6f122", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/ac2a0a19731c9d7aee31e2a0abcf98eb30e6f122", "committedDate": "2020-04-07T19:40:46Z", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNzc5NDU4", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#pullrequestreview-390779458", "createdAt": "2020-04-09T13:14:18Z", "commit": {"oid": "ac2a0a19731c9d7aee31e2a0abcf98eb30e6f122"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzoxNDoxOVrOGDYHng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzoxNDoxOVrOGDYHng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE5NDA3OA==", "bodyText": "Can you make these auto types explicit where reasonable eg TR:Register TR_J9VMBase etc", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r406194078", "createdAt": "2020-04-09T13:14:19Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4508,6 +4512,25 @@ void J9::X86::TreeEvaluator::transactionalMemoryJITMonitorEntry(TR::Node\n       cg->stopUsingRegister(counterReg);\n    }\n \n+void\n+J9::X86::TreeEvaluator::generateCheckForValueTypeMonitorEnterOrExit(\n+      TR::Node *node,\n+      TR::LabelSymbol *snippetLabel,\n+      TR::CodeGenerator *cg)\n+   {\n+   if (cg->isMonitorValueType(node) != TR_maybe)\n+      return;\n+   TR::Register *objectReg = cg->evaluate(node->getFirstChild());\n+   auto j9classReg = cg->allocateRegister();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2a0a19731c9d7aee31e2a0abcf98eb30e6f122"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNzgwMjk0", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#pullrequestreview-390780294", "createdAt": "2020-04-09T13:15:26Z", "commit": {"oid": "ac2a0a19731c9d7aee31e2a0abcf98eb30e6f122"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b7c96a1ec294e3655365c59b5ccb3d9c030ef1b", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/3b7c96a1ec294e3655365c59b5ccb3d9c030ef1b", "committedDate": "2020-04-09T14:40:56Z", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac2a0a19731c9d7aee31e2a0abcf98eb30e6f122", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/ac2a0a19731c9d7aee31e2a0abcf98eb30e6f122", "committedDate": "2020-04-07T19:40:46Z", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}, "afterCommit": {"oid": "3b7c96a1ec294e3655365c59b5ccb3d9c030ef1b", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/3b7c96a1ec294e3655365c59b5ccb3d9c030ef1b", "committedDate": "2020-04-09T14:40:56Z", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1324, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}