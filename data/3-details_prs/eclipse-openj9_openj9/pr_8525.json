{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMTg4MDIz", "number": 8525, "title": "Set estimate when encoding per-CC helper snippets", "bodyText": "Previously, when performing binary encoding for the per-CC helper\nsnippets on Power, binary length estimates were not being set on the\ninstructions being encoded. While this was fine in the past, since these\nestimates were not being used in this case, an impending refactor to the\nPower binary encoder will be adding asserts to ensure that these values\nwere set correctly initially. As a result of this, it is now necessary\nto ensure that estimateBinaryLength is called on an instruction prior to\ncalling generateBinaryEncoding on it.\nSigned-off-by: Ben Thomas ben@benthomas.ca", "createdAt": "2020-02-07T01:11:38Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8525", "merged": true, "mergeCommit": {"oid": "a7697ae4ea06e37b7bc4ae44bb65c29a58bde430"}, "closed": true, "closedAt": "2020-03-13T20:41:53Z", "author": {"login": "aviansie-ben"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBtDpVgH2gAyMzcyMTg4MDIzOjNlOGUzM2I5Y2RkZDlhY2Q1N2NlMDYzYjIwM2JkMDAzMWRlZGM3YzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNWhXNgFqTM3NDYwNzc1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3e8e33b9cddd9acd57ce063b203bd0031dedc7c5", "author": {"user": {"login": "aviansie-ben", "name": "Ben Thomas (Aviansie Ben)"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3e8e33b9cddd9acd57ce063b203bd0031dedc7c5", "committedDate": "2020-02-06T16:09:43Z", "message": "Set estimate when encoding per-CC helper snippets\n\nPreviously, when performing binary encoding for the per-CC helper\nsnippets on Power, binary length estimates were not being set on the\ninstructions being encoded. While this was fine in the past, since these\nestimates were not being used in this case, an impending refactor to the\nPower binary encoder will be adding asserts to ensure that these values\nwere set correctly initially. As a result of this, it is now necessary\nto ensure that estimateBinaryLength is called on an instruction prior to\ncalling generateBinaryEncoding on it.\n\nSigned-off-by: Ben Thomas <ben@benthomas.ca>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MDMxMjcw", "url": "https://github.com/eclipse-openj9/openj9/pull/8525#pullrequestreview-356031270", "createdAt": "2020-02-10T15:31:33Z", "commit": {"oid": "3e8e33b9cddd9acd57ce063b203bd0031dedc7c5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNTozMTozM1rOFnqeeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNTozMTozM1rOFnqeeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEzNDcxNA==", "bodyText": "There is only one BinaryBufferStart value (at least for a logical encoding unit such as a specific compilation). The way i->estimateBinaryLength is done looks wrong to me.  The next instruction will see longer estimated length. Reversing the two lines above and fixing using cg->getBinaryBufferStart would make more senses.", "url": "https://github.com/eclipse-openj9/openj9/pull/8525#discussion_r377134714", "createdAt": "2020-02-10T15:31:33Z", "author": {"login": "zl-wang"}, "path": "runtime/compiler/p/codegen/J9PPCSnippet.cpp", "diffHunk": "@@ -1879,6 +1879,17 @@ uint32_t TR::getCCPreLoadedCodeSize()\n #define CCEYECATCHER(a, b, c, d) (((a) << 24) | ((b) << 16) | ((c) << 8) | ((d) << 0))\n #endif\n \n+static void performCCPreLoadedBinaryEncoding(uint8_t *buffer, TR::CodeGenerator *cg)\n+   {\n+   cg->setBinaryBufferStart(buffer);\n+   cg->setBinaryBufferCursor(buffer);\n+   for (TR::Instruction *i = cg->getFirstInstruction(); i != NULL; i = i->getNext())\n+      {\n+      i->estimateBinaryLength(cg->getBinaryBufferCursor() - cg->getBinaryBufferStart());\n+      cg->setBinaryBufferCursor(i->generateBinaryEncoding());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e8e33b9cddd9acd57ce063b203bd0031dedc7c5"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjA3NzU3", "url": "https://github.com/eclipse-openj9/openj9/pull/8525#pullrequestreview-374607757", "createdAt": "2020-03-13T20:41:27Z", "commit": {"oid": "3e8e33b9cddd9acd57ce063b203bd0031dedc7c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 767, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}