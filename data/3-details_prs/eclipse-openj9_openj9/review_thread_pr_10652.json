{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5OTgyNjcw", "number": 10652, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxOTowMToyM1rOEmOYdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMjo1MzoyN1rOEpBDSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTE2OTgzOnYy", "diffSide": "RIGHT", "path": "runtime/vm/createramclass.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxOTowMToyM1rOHWIVCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxOTowMToyM1rOHWIVCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2NzE3Ng==", "bodyText": "I would move this comment (merge it with the one above) since this is in the not NULL path.", "url": "https://github.com/eclipse-openj9/openj9/pull/10652#discussion_r492967176", "createdAt": "2020-09-22T19:01:23Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -1995,6 +1995,13 @@ internalCreateRAMClassDone(J9VMThread *vmThread, J9ClassLoader *classLoader, J9R\n \t\t\t}\n \t\t}\n \n+\t\t/* link classes in segment */\n+\t\tif (NULL != segment) {\n+\t\t\t/* segment is NULL in failure paths */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "384c85680c1015e456521b6ab159ad00accf8684"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTM5NjE3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/createramclass.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDowODo0OFrOHWKhGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDowODo0OFrOHWKhGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMzAzNA==", "bodyText": "With this change, is the code above that handles the \"already loaded\" case still valid / required?  I think it can be removed now as there's no reason to link the abandoned class into anything as it won't be part of the list until this point\nhttps://github.com/eclipse/openj9/blob/384c85680c1015e456521b6ab159ad00accf8684/runtime/vm/createramclass.cpp#L1974-L1980", "url": "https://github.com/eclipse-openj9/openj9/pull/10652#discussion_r493003034", "createdAt": "2020-09-22T20:08:48Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -1995,6 +1995,13 @@ internalCreateRAMClassDone(J9VMThread *vmThread, J9ClassLoader *classLoader, J9R\n \t\t\t}\n \t\t}\n \n+\t\t/* link classes in segment */\n+\t\tif (NULL != segment) {\n+\t\t\t/* segment is NULL in failure paths */\n+\t\t\tstate->ramClass->nextClassInSegment = *(J9Class **) segment->heapBase;\n+\t\t\t*(J9Class **)segment->heapBase = state->ramClass;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "384c85680c1015e456521b6ab159ad00accf8684"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMTY0NzI5OnYy", "diffSide": "RIGHT", "path": "runtime/vm/createramclass.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMDo1Mjo1N1rOHaBU1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMDo1Mjo1N1rOHaBU1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA0Njc0Mg==", "bodyText": "{ on new line.", "url": "https://github.com/eclipse-openj9/openj9/pull/10652#discussion_r497046742", "createdAt": "2020-09-29T20:52:57Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2142,6 +2142,30 @@ trcModulesSettingPackage(J9VMThread *vmThread, J9Class *ramClass, J9ClassLoader\n \t\t}\n \t}\n }\n+static void\n+initializeClassLinks(J9Class *ramClass, J9Class *superclass, J9MemorySegment *segment, UDATA options) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4850bfbc4f668674a523bb3709fd64bc0908b38"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMTY1Mzk2OnYy", "diffSide": "RIGHT", "path": "runtime/vm/createramclass.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMDo1Mzo1OFrOHaBZHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMDo1Mzo1OFrOHaBZHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA0NzgzNw==", "bodyText": "Extra line.", "url": "https://github.com/eclipse-openj9/openj9/pull/10652#discussion_r497047837", "createdAt": "2020-09-29T20:53:58Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2142,6 +2142,30 @@ trcModulesSettingPackage(J9VMThread *vmThread, J9Class *ramClass, J9ClassLoader\n \t\t}\n \t}\n }\n+static void\n+initializeClassLinks(J9Class *ramClass, J9Class *superclass, J9MemorySegment *segment, UDATA options) {\n+\tramClass->nextClassInSegment = *(J9Class **) segment->heapBase;\n+\t*(J9Class **)segment->heapBase = ramClass;\n+\n+\tif (superclass == NULL) {\n+\t\tramClass->subclassTraversalLink = ramClass;\n+\t\tramClass->subclassTraversalReverseLink = ramClass;\n+\t} else {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4850bfbc4f668674a523bb3709fd64bc0908b38"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMTY1NjA3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/createramclass.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMDo1NDoxOVrOHaBaoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMDo1NDoxOVrOHaBaoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA0ODIyNQ==", "bodyText": "Please use bit macro.", "url": "https://github.com/eclipse-openj9/openj9/pull/10652#discussion_r497048225", "createdAt": "2020-09-29T20:54:19Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2142,6 +2142,30 @@ trcModulesSettingPackage(J9VMThread *vmThread, J9Class *ramClass, J9ClassLoader\n \t\t}\n \t}\n }\n+static void\n+initializeClassLinks(J9Class *ramClass, J9Class *superclass, J9MemorySegment *segment, UDATA options) {\n+\tramClass->nextClassInSegment = *(J9Class **) segment->heapBase;\n+\t*(J9Class **)segment->heapBase = ramClass;\n+\n+\tif (superclass == NULL) {\n+\t\tramClass->subclassTraversalLink = ramClass;\n+\t\tramClass->subclassTraversalReverseLink = ramClass;\n+\t} else {\n+\n+\t\tif ((options & J9_FINDCLASS_FLAG_NO_SUBCLASS_LINK) == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4850bfbc4f668674a523bb3709fd64bc0908b38"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjUzNTY2OnYy", "diffSide": "RIGHT", "path": "runtime/vm/createramclass.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwMToxMDo0MlrOHaKBdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwMToxMDo0MlrOHaKBdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE4OTIzNw==", "bodyText": "Can you document the function parameters and what it does?", "url": "https://github.com/eclipse-openj9/openj9/pull/10652#discussion_r497189237", "createdAt": "2020-09-30T01:10:42Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2142,6 +2142,30 @@ trcModulesSettingPackage(J9VMThread *vmThread, J9Class *ramClass, J9ClassLoader\n \t\t}\n \t}\n }\n+static void", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4850bfbc4f668674a523bb3709fd64bc0908b38"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMjU2MzA2OnYy", "diffSide": "RIGHT", "path": "runtime/vm/createramclass.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwMToyNzo0NFrOHaKRUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwMTo0MToyNVrOHaKeSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE5MzI5Nw==", "bodyText": "Since we hold the mutex over this operation, we can assign the ramClass to subclassTraversalLink & subclassTraversalReverseLink always, and overwrite in the one case:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tif (superclass == NULL) {\n          \n          \n            \n            \t\tramClass->subclassTraversalLink = ramClass;\n          \n          \n            \n            \t\tramClass->subclassTraversalReverseLink = ramClass;\n          \n          \n            \n            \t} else {\n          \n          \n            \n            \n          \n          \n            \n            \t\tif ((options & J9_FINDCLASS_FLAG_NO_SUBCLASS_LINK) == 0) {\n          \n          \n            \n            \t\t\tJ9Class* nextLink = superclass->subclassTraversalLink;\n          \n          \n            \n            \n          \n          \n            \n            \t\t\tramClass->subclassTraversalLink = nextLink;\n          \n          \n            \n            \t\t\tnextLink->subclassTraversalReverseLink = ramClass;\n          \n          \n            \n            \t\t\tsuperclass->subclassTraversalLink = ramClass;\n          \n          \n            \n            \t\t\tramClass->subclassTraversalReverseLink = superclass;\n          \n          \n            \n            \t\t} else {\n          \n          \n            \n            \t\t\tramClass->subclassTraversalLink = ramClass;\n          \n          \n            \n            \t\t\tramClass->subclassTraversalReverseLink = ramClass;\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \tramClass->subclassTraversalLink = ramClass;\n          \n          \n            \n            \tramClass->subclassTraversalReverseLink = ramClass;\n          \n          \n            \n            \tif ((options & J9_FINDCLASS_FLAG_NO_SUBCLASS_LINK) == 0) {\n          \n          \n            \n            \t\tJ9Class* nextLink = superclass->subclassTraversalLink;\n          \n          \n            \n            \n          \n          \n            \n            \t\tramClass->subclassTraversalLink = nextLink;\n          \n          \n            \n            \t\tnextLink->subclassTraversalReverseLink = ramClass;\n          \n          \n            \n            \t\tsuperclass->subclassTraversalLink = ramClass;\n          \n          \n            \n            \t\tramClass->subclassTraversalReverseLink = superclass;\n          \n          \n            \n            \t}", "url": "https://github.com/eclipse-openj9/openj9/pull/10652#discussion_r497193297", "createdAt": "2020-09-30T01:27:44Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2142,6 +2142,30 @@ trcModulesSettingPackage(J9VMThread *vmThread, J9Class *ramClass, J9ClassLoader\n \t\t}\n \t}\n }\n+static void\n+initializeClassLinks(J9Class *ramClass, J9Class *superclass, J9MemorySegment *segment, UDATA options) {\n+\tramClass->nextClassInSegment = *(J9Class **) segment->heapBase;\n+\t*(J9Class **)segment->heapBase = ramClass;\n+\n+\tif (superclass == NULL) {\n+\t\tramClass->subclassTraversalLink = ramClass;\n+\t\tramClass->subclassTraversalReverseLink = ramClass;\n+\t} else {\n+\n+\t\tif ((options & J9_FINDCLASS_FLAG_NO_SUBCLASS_LINK) == 0) {\n+\t\t\tJ9Class* nextLink = superclass->subclassTraversalLink;\n+\n+\t\t\tramClass->subclassTraversalLink = nextLink;\n+\t\t\tnextLink->subclassTraversalReverseLink = ramClass;\n+\t\t\tsuperclass->subclassTraversalLink = ramClass;\n+\t\t\tramClass->subclassTraversalReverseLink = superclass;\n+\t\t} else {\n+\t\t\tramClass->subclassTraversalLink = ramClass;\n+\t\t\tramClass->subclassTraversalReverseLink = ramClass;\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4850bfbc4f668674a523bb3709fd64bc0908b38"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE5NjYxOA==", "bodyText": "This won't work if superclass is NULL. I agree about assigning the defaults first - just need to add the NULL check in the if.", "url": "https://github.com/eclipse-openj9/openj9/pull/10652#discussion_r497196618", "createdAt": "2020-09-30T01:41:25Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2142,6 +2142,30 @@ trcModulesSettingPackage(J9VMThread *vmThread, J9Class *ramClass, J9ClassLoader\n \t\t}\n \t}\n }\n+static void\n+initializeClassLinks(J9Class *ramClass, J9Class *superclass, J9MemorySegment *segment, UDATA options) {\n+\tramClass->nextClassInSegment = *(J9Class **) segment->heapBase;\n+\t*(J9Class **)segment->heapBase = ramClass;\n+\n+\tif (superclass == NULL) {\n+\t\tramClass->subclassTraversalLink = ramClass;\n+\t\tramClass->subclassTraversalReverseLink = ramClass;\n+\t} else {\n+\n+\t\tif ((options & J9_FINDCLASS_FLAG_NO_SUBCLASS_LINK) == 0) {\n+\t\t\tJ9Class* nextLink = superclass->subclassTraversalLink;\n+\n+\t\t\tramClass->subclassTraversalLink = nextLink;\n+\t\t\tnextLink->subclassTraversalReverseLink = ramClass;\n+\t\t\tsuperclass->subclassTraversalLink = ramClass;\n+\t\t\tramClass->subclassTraversalReverseLink = superclass;\n+\t\t} else {\n+\t\t\tramClass->subclassTraversalLink = ramClass;\n+\t\t\tramClass->subclassTraversalReverseLink = ramClass;\n+\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE5MzI5Nw=="}, "originalCommit": {"oid": "a4850bfbc4f668674a523bb3709fd64bc0908b38"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNDQ0Mjk3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/createramclass.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMjo1MzoyN1rOHacErA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMjo1MzoyN1rOHacErA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ4NDk3Mg==", "bodyText": "Can you add a comment like:\n\nCaller must hold the classTableMutex.", "url": "https://github.com/eclipse-openj9/openj9/pull/10652#discussion_r497484972", "createdAt": "2020-09-30T12:53:27Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2142,6 +2142,34 @@ trcModulesSettingPackage(J9VMThread *vmThread, J9Class *ramClass, J9ClassLoader\n \t\t}\n \t}\n }\n+\n+/**\n+ * This function initializes the subclass traversal links in the ramclass and the\n+ * next class link in the j9segment", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ccd20dd9d92a9a6c0000a4acff9664cc63f8bb8"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4637, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}