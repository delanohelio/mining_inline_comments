{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNzM0NDM5", "number": 8912, "title": "JVM_LoadLibrary releases VM Access before invoking registerBootstrapLibrary()", "bodyText": "JVM_LoadLibrary releases VM Access before invoking registerBootstrapLibrary()\nInvoking internalReleaseVMAccess() before registerBootstrapLibrary().\nVerified in a personal build with openj9-staging branch.\ncloses: #8909\nReviewer: @gacholio @pshipton\nFYI: @DanHeidinga\nSigned-off-by: Jason Feng fengj@ca.ibm.com", "createdAt": "2020-03-19T00:37:59Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8912", "merged": true, "mergeCommit": {"oid": "181fabed167b4c005aff13010aae0e44fd40d651"}, "closed": true, "closedAt": "2020-03-19T15:37:25Z", "author": {"login": "JasonFengJ9"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPMaClgFqTM3Nzc0NzcxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPNWewAFqTM3NzgxMjIzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NzQ3NzE0", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#pullrequestreview-377747714", "createdAt": "2020-03-19T14:02:14Z", "commit": {"oid": "ee489697ccb944cc9d9a18800c2e27eb633dd7c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDowMjoxNVrOF4vzJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDowMjoxNVrOF4vzJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0NzcxNg==", "bodyText": "After entering the VM, you will certainly have VM access, so there's no need to test here.", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#discussion_r395047716", "createdAt": "2020-03-19T14:02:15Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -3589,13 +3589,24 @@ JVM_LoadLibrary(const char* libName)\n \tJ9JavaVM* javaVM = (J9JavaVM*)BFUjavaVM;\n \tJ9InternalVMFunctions* vmFuncs = javaVM->internalVMFunctions;\n \tJ9VMThread* currentThread = vmFuncs->currentVMThread(javaVM);\n+\tUDATA flagVMAccess = 0;\n \n-\tTrc_SC_LoadLibrary_Entry(libName);\n+\tTrc_SC_LoadLibrary_Entry(currentThread, libName);\n+\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\tflagVMAccess = currentThread->publicFlags & J9_PUBLIC_FLAGS_VM_ACCESS;\n+\tTrc_SC_LoadLibrary_FlagVMAccess(currentThread, flagVMAccess);\n+\tif (0 != flagVMAccess) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee489697ccb944cc9d9a18800c2e27eb633dd7c8"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NzQ4NTY0", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#pullrequestreview-377748564", "createdAt": "2020-03-19T14:03:07Z", "commit": {"oid": "ee489697ccb944cc9d9a18800c2e27eb633dd7c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDowMzowN1rOF4v1zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDowMzowN1rOF4v1zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0ODM5Ng==", "bodyText": "I thought we weren't supposed to change tracepoint parameters. Given how infrequently this code will be used, I suggest leaving them as noEnv.", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#discussion_r395048396", "createdAt": "2020-03-19T14:03:07Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -3589,13 +3589,24 @@ JVM_LoadLibrary(const char* libName)\n \tJ9JavaVM* javaVM = (J9JavaVM*)BFUjavaVM;\n \tJ9InternalVMFunctions* vmFuncs = javaVM->internalVMFunctions;\n \tJ9VMThread* currentThread = vmFuncs->currentVMThread(javaVM);\n+\tUDATA flagVMAccess = 0;\n \n-\tTrc_SC_LoadLibrary_Entry(libName);\n+\tTrc_SC_LoadLibrary_Entry(currentThread, libName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee489697ccb944cc9d9a18800c2e27eb633dd7c8"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NzQ4OTY5", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#pullrequestreview-377748969", "createdAt": "2020-03-19T14:03:37Z", "commit": {"oid": "ee489697ccb944cc9d9a18800c2e27eb633dd7c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDowMzozN1rOF4v3Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDowMzozN1rOF4v3Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0ODcyMg==", "bodyText": "No need to acquire here - exit will work regardless.", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#discussion_r395048722", "createdAt": "2020-03-19T14:03:37Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -3589,13 +3589,24 @@ JVM_LoadLibrary(const char* libName)\n \tJ9JavaVM* javaVM = (J9JavaVM*)BFUjavaVM;\n \tJ9InternalVMFunctions* vmFuncs = javaVM->internalVMFunctions;\n \tJ9VMThread* currentThread = vmFuncs->currentVMThread(javaVM);\n+\tUDATA flagVMAccess = 0;\n \n-\tTrc_SC_LoadLibrary_Entry(libName);\n+\tTrc_SC_LoadLibrary_Entry(currentThread, libName);\n+\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\tflagVMAccess = currentThread->publicFlags & J9_PUBLIC_FLAGS_VM_ACCESS;\n+\tTrc_SC_LoadLibrary_FlagVMAccess(currentThread, flagVMAccess);\n+\tif (0 != flagVMAccess) {\n+\t\tvmFuncs->internalReleaseVMAccess(currentThread);\n+\t}\n \tif (vmFuncs->registerBootstrapLibrary(currentThread, libName, &nativeLibrary, FALSE) == J9NATIVELIB_LOAD_OK) {\n \t\tresult = (void*)nativeLibrary->handle;\n \t}\n+\tif (0 != flagVMAccess) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee489697ccb944cc9d9a18800c2e27eb633dd7c8"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21c0cdf21bc5a12a2b89db1db1341c6268e3ca35", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/21c0cdf21bc5a12a2b89db1db1341c6268e3ca35", "committedDate": "2020-03-19T14:42:20Z", "message": "JVM_LoadLibrary release VM Access\n\nInvoking internalReleaseVMAccess() before registerBootstrapLibrary().\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee489697ccb944cc9d9a18800c2e27eb633dd7c8", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ee489697ccb944cc9d9a18800c2e27eb633dd7c8", "committedDate": "2020-03-18T21:17:57Z", "message": "JVM_LoadLibrary release VM Access\n\nInvoking internalReleaseVMAccess() before registerBootstrapLibrary();\nAdded a trace point.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}, "afterCommit": {"oid": "21c0cdf21bc5a12a2b89db1db1341c6268e3ca35", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/21c0cdf21bc5a12a2b89db1db1341c6268e3ca35", "committedDate": "2020-03-19T14:42:20Z", "message": "JVM_LoadLibrary release VM Access\n\nInvoking internalReleaseVMAccess() before registerBootstrapLibrary().\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODEyMjM4", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#pullrequestreview-377812238", "createdAt": "2020-03-19T15:08:16Z", "commit": {"oid": "21c0cdf21bc5a12a2b89db1db1341c6268e3ca35"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 527, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}