{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MjM4OTM3", "number": 11233, "title": "Enable Value Type support for JITServer", "bodyText": "This commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n\nTR_ResolvedJ9JITServerMethod::isFieldQType\nTR_ResolvedJ9JITServerMethod::isFieldFlattened\nModified for JITServer:\nJ9::ClassEnv::enumerateFields", "createdAt": "2020-11-19T21:21:13Z", "url": "https://github.com/eclipse-openj9/openj9/pull/11233", "merged": true, "mergeCommit": {"oid": "23868ce311355eb05b01eb4e79392be1241a41f3"}, "closed": true, "closedAt": "2020-11-26T09:07:59Z", "author": {"login": "dmitry-ten"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeJu2ggBqjQwMTgwMDM2MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgB9ZrgBqjQwMzkyMDg2ODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ca2469ec015622fb99b61b0c7094f03341ffaaf", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/1ca2469ec015622fb99b61b0c7094f03341ffaaf", "committedDate": "2020-11-19T21:20:16Z", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206", "committedDate": "2020-11-19T21:34:58Z", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3OTU3NzU5", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#pullrequestreview-537957759", "createdAt": "2020-11-24T21:26:49Z", "commit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMToyNjo0OVrOH5V1Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMToyODo1MVrOH5fqdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4ODUxOA==", "bodyText": "Maybe create a fieldOrStaticSignature that returns an UTF8here so that we avoid the conversion to char * and then back to UTF8", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r529888518", "createdAt": "2020-11-24T21:26:49Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/j9methodServer.cpp", "diffHunk": "@@ -2054,6 +2054,33 @@ TR_ResolvedJ9JITServerMethod::archetypeArgPlaceholderSlot()\n    return paramSlots;\n    }\n \n+bool\n+TR_ResolvedJ9JITServerMethod::isFieldQType(int32_t cpIndex)\n+   {\n+   if (!TR::Compiler->om.areValueTypesEnabled() ||\n+      (-1 == cpIndex))\n+      return false;\n+\n+   auto comp = _fe->_compInfoPT->getCompilation();\n+   int32_t sigLen;\n+   char *sig = fieldOrStaticSignatureChars(cpIndex, sigLen);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0OTY1Mg==", "bodyText": "In J9::ClassEnv::enumerateFields when we retrieve the data from the client there is an assumption that the strings are null terminated. I was under the impression that the string constructor does not copy the null terminating character. Maybe some implementations do that so that they can optimize the c_str() function, but I don't think it's guaranteed.", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530049652", "createdAt": "2020-11-25T01:28:51Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -2162,6 +2172,28 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, TR::Compiler->cls.isClassRefValueType(comp, clazz, cpIndex));\n          }\n          break;\n+      case MessageType::ClassEnv_enumerateFields:\n+         {\n+         auto recv = client->getRecvData<TR_OpaqueClassBlock *>();\n+         const TR::TypeLayout* layout = comp->typeLayout(std::get<0>(recv));\n+\n+         std::vector<TR::TypeLayoutEntry> entries;\n+         std::vector<std::string> fieldNames;\n+         std::vector<std::string> typeSignatures;\n+         entries.reserve(layout->count());\n+         fieldNames.reserve(layout->count());\n+         typeSignatures.reserve(layout->count());\n+         for (int32_t idx = 0; idx < layout->count(); ++idx)\n+            {\n+            const TR::TypeLayoutEntry &entry = layout->entry(idx);\n+            entries.push_back(entry);\n+            // both strings are null-terminated so we don't need to know length\n+            fieldNames.push_back(std::string(entry._fieldname));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206"}, "originalPosition": 44}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206", "committedDate": "2020-11-19T21:34:58Z", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "15aeddf156ab0adaeb26464830bfee51b1cc9fdf", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/15aeddf156ab0adaeb26464830bfee51b1cc9fdf", "committedDate": "2020-11-25T16:41:15Z", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15aeddf156ab0adaeb26464830bfee51b1cc9fdf", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/15aeddf156ab0adaeb26464830bfee51b1cc9fdf", "committedDate": "2020-11-25T16:41:15Z", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "3446382f354b89ebd2de3d1fedf0aab372b498e7", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3446382f354b89ebd2de3d1fedf0aab372b498e7", "committedDate": "2020-11-25T17:06:20Z", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7b362f8e8b5a5bad8f3296a0d06e15167cfd517", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c7b362f8e8b5a5bad8f3296a0d06e15167cfd517", "committedDate": "2020-11-25T17:39:40Z", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3446382f354b89ebd2de3d1fedf0aab372b498e7", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3446382f354b89ebd2de3d1fedf0aab372b498e7", "committedDate": "2020-11-25T17:06:20Z", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "c7b362f8e8b5a5bad8f3296a0d06e15167cfd517", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c7b362f8e8b5a5bad8f3296a0d06e15167cfd517", "committedDate": "2020-11-25T17:39:40Z", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1615, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}