{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNjMzNTM5", "number": 8277, "title": "Retrieve constant dynamic info from the JITClient", "bodyText": "Dynamic constant is not stored at the JITServer. It needs to be retrieved from the client side. This PR has dependency on the new dynamicConstant API defined in eclipse/omr#4726.\nAlso increased the JITServer MINOR_NUMBER to 3 since the new message types have to be handled at the client as well.\nThis commit fixes the server crash when running Java 11 sanity test CondyPrimitive_1.\nRelated to #7567.\nSigned-off-by: Annabelle Huo Annabelle.Huo@ibm.com", "createdAt": "2020-01-10T21:43:16Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8277", "merged": true, "mergeCommit": {"oid": "68b3c4930cfb59521230232ba1c085503d45d0bc"}, "closed": true, "closedAt": "2020-01-31T16:42:37Z", "author": {"login": "a7ehuo"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5Fq18ABqjI5Mzk5NTc1Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_LbumABqjI5OTA4NjUxMDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ef2a125b3707dc949a291b14b6e9c88df5f9205", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3ef2a125b3707dc949a291b14b6e9c88df5f9205", "committedDate": "2020-01-10T21:39:15Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer. It needs\nto be retrieved from the client side. It will fix the server\ncrash when running Java 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "608773cf740c7b4eb81947706aacf443c441471f", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/608773cf740c7b4eb81947706aacf443c441471f", "committedDate": "2020-01-10T21:44:42Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer. It needs\nto be retrieved from the client side. It will fix the server\ncrash when running Java 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "608773cf740c7b4eb81947706aacf443c441471f", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/608773cf740c7b4eb81947706aacf443c441471f", "committedDate": "2020-01-10T21:44:42Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer. It needs\nto be retrieved from the client side. It will fix the server\ncrash when running Java 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "9e7c2340312c5edb7a89e3127ee262fe8c88e5d7", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9e7c2340312c5edb7a89e3127ee262fe8c88e5d7", "committedDate": "2020-01-10T21:55:21Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer. It needs\nto be retrieved from the client side. It will fix the server\ncrash when running Java 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e7c2340312c5edb7a89e3127ee262fe8c88e5d7", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9e7c2340312c5edb7a89e3127ee262fe8c88e5d7", "committedDate": "2020-01-10T21:55:21Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer. It needs\nto be retrieved from the client side. It will fix the server\ncrash when running Java 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "c55e7d4e3138840c0c421bb0f475d954bfa027f4", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c55e7d4e3138840c0c421bb0f475d954bfa027f4", "committedDate": "2020-01-10T21:59:40Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer. It needs\nto be retrieved from the client side. It will fix the server\ncrash when running Java 11 sanity test `CondyPrimitive_1`.\nRelated to #7567.\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c55e7d4e3138840c0c421bb0f475d954bfa027f4", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c55e7d4e3138840c0c421bb0f475d954bfa027f4", "committedDate": "2020-01-10T21:59:40Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer. It needs\nto be retrieved from the client side. It will fix the server\ncrash when running Java 11 sanity test `CondyPrimitive_1`.\nRelated to #7567.\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "85803e31def91a2d421da8f89c74ccd893ec154e", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/85803e31def91a2d421da8f89c74ccd893ec154e", "committedDate": "2020-01-10T22:13:49Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the `JITServer`. It needs\nto be retrieved from the client side. It will fix the server\ncrash when running Java 11 sanity test `CondyPrimitive_1`.\nRelated to #7567.\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85803e31def91a2d421da8f89c74ccd893ec154e", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/85803e31def91a2d421da8f89c74ccd893ec154e", "committedDate": "2020-01-10T22:13:49Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the `JITServer`. It needs\nto be retrieved from the client side. It will fix the server\ncrash when running Java 11 sanity test `CondyPrimitive_1`.\nRelated to #7567.\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "bc89bcd414135a32636da2e577e97c3180fb7f3c", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/bc89bcd414135a32636da2e577e97c3180fb7f3c", "committedDate": "2020-01-10T22:26:45Z", "message": "Retrieve constant dynamic info from the JITClient\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc89bcd414135a32636da2e577e97c3180fb7f3c", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/bc89bcd414135a32636da2e577e97c3180fb7f3c", "committedDate": "2020-01-10T22:26:45Z", "message": "Retrieve constant dynamic info from the JITClient\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "83041a511e699927bdeea18b59b08a50df01c34d", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/83041a511e699927bdeea18b59b08a50df01c34d", "committedDate": "2020-01-14T15:13:43Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83041a511e699927bdeea18b59b08a50df01c34d", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/83041a511e699927bdeea18b59b08a50df01c34d", "committedDate": "2020-01-14T15:13:43Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "ec633b36847f780a8e4813392d39c7aced744e1d", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ec633b36847f780a8e4813392d39c7aced744e1d", "committedDate": "2020-01-14T15:17:12Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec633b36847f780a8e4813392d39c7aced744e1d", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ec633b36847f780a8e4813392d39c7aced744e1d", "committedDate": "2020-01-14T15:17:12Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "7dc03c174470f1931a7256394d9cdcd83ebb3858", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/7dc03c174470f1931a7256394d9cdcd83ebb3858", "committedDate": "2020-01-14T16:50:31Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7dc03c174470f1931a7256394d9cdcd83ebb3858", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/7dc03c174470f1931a7256394d9cdcd83ebb3858", "committedDate": "2020-01-14T16:50:31Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/1c2a03a167a55647ca2ae2f3e427e9030ecee41e", "committedDate": "2020-01-15T16:52:10Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNDMwOTMz", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#pullrequestreview-343430933", "createdAt": "2020-01-15T18:31:11Z", "commit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODozMToxMVrOFeCMvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMDowNToxOFrOFeE1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzNzYzMA==", "bodyText": "Maybe have an assert saying that we must have VM access when calling this API", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367037630", "createdAt": "2020-01-15T18:31:11Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/j9method.cpp", "diffHunk": "@@ -6040,10 +6040,12 @@ TR_ResolvedJ9Method::isUnresolvedConstantDynamic(I_32 cpIndex)\n    }\n \n void *\n-TR_ResolvedJ9Method::dynamicConstant(I_32 cpIndex)\n+TR_ResolvedJ9Method::dynamicConstant(I_32 cpIndex, uintptrj_t &obj)\n    {\n    TR_ASSERT_FATAL(cpIndex != -1, \"ConstantDynamic cpIndex shouldn't be -1\");\n-   return &((J9RAMConstantDynamicRef *) literals())[cpIndex].value;\n+   uintptrj_t *objLocation = (uintptrj_t *)&(((J9RAMConstantDynamicRef *) literals())[cpIndex].value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0MzIxMw==", "bodyText": "Maybe just describe what the function does without a mention to JITServer", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367043213", "createdAt": "2020-01-15T18:43:29Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/j9method.h", "diffHunk": "@@ -397,10 +397,16 @@ class TR_ResolvedJ9Method : public TR_J9Method, public TR_ResolvedJ9MethodBase\n     *  \\param cpIndex\n     *     The constant pool index of the constant dynamic.\n     *\n+    *  \\param obj\n+    *     Return the resolved constant dynamic value.\n+    *\n     *  \\return\n     *     Opaque pointer to the slot containing the resolved constant dynamic value.\n+    *     In the JITServer mode, the returned pointer should always be dereferenced", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0MzkyMA==", "bodyText": "I think you can make this a reference", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367043920", "createdAt": "2020-01-15T18:45:12Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/j9methodServer.cpp", "diffHunk": "@@ -231,6 +239,18 @@ TR_ResolvedJ9JITServerMethod::classOfStatic(I_32 cpIndex, bool returnClassForAOT\n    return classOfStatic;\n    }\n \n+void *\n+TR_ResolvedJ9JITServerMethod::getConstantDynamicTypeFromCP(I_32 cpIndex)\n+   {\n+   TR_ASSERT_FATAL(cpIndex != -1, \"ConstantDynamic cpIndex shouldn't be -1\");\n+   _stream->write(JITServer::MessageType::ResolvedMethod_getConstantDynamicTypeFromCP, _remoteMirror, cpIndex);\n+\n+   const std::string retConstantDynamicTypeStr = std::get<0>(_stream->read<std::string>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0NjY1MQ==", "bodyText": "Inside there is an object dereference which needs to be protected with VM access, just like the non-jitserver code does.", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367046651", "createdAt": "2020-01-15T18:51:09Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -1775,6 +1775,39 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, ramMethods, vTableOffsets, methodInfos);\n          }\n          break;\n+      case MessageType::ResolvedMethod_getConstantDynamicTypeFromCP:\n+         {\n+         auto recv = client->getRecvData<TR_ResolvedJ9Method *, int32_t>();\n+         auto mirror = std::get<0>(recv);\n+         auto cpIndex = std::get<1>(recv);\n+\n+         J9UTF8 *constantDynamicTypeUtf8 = (J9UTF8 *)mirror->getConstantDynamicTypeFromCP(cpIndex);\n+         int constantDynamicTypeUtf8Length = J9UTF8_LENGTH(constantDynamicTypeUtf8);\n+         char* constantDynamicTypeUtf8Data = (char *)J9UTF8_DATA(constantDynamicTypeUtf8);\n+\n+         client->write(response, std::string(constantDynamicTypeUtf8Data, constantDynamicTypeUtf8Length));\n+         }\n+         break;\n+      case MessageType::ResolvedMethod_isUnresolvedConstantDynamic:\n+         {\n+         auto recv = client->getRecvData<TR_ResolvedJ9Method *, int32_t>();\n+         auto mirror = std::get<0>(recv);\n+         auto cpIndex = std::get<1>(recv);\n+\n+         client->write(response, mirror->isUnresolvedConstantDynamic(cpIndex));\n+         }\n+         break;\n+      case MessageType::ResolvedMethod_dynamicConstant:\n+         {\n+         auto recv = client->getRecvData<TR_ResolvedJ9Method *, int32_t>();\n+         auto mirror = std::get<0>(recv);\n+         auto cpIndex = std::get<1>(recv);\n+\n+         uintptrj_t obj = 0;\n+         uintptrj_t *objLocation = (uintptrj_t*)mirror->dynamicConstant(cpIndex, obj);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4MDc1NQ==", "bodyText": "Below, when doing loadConstant(TR::iconst, *(int32_t*)(obj+valueOffset)); we can run into trouble for JITServer. Maybe that tryToAcquireVMAccess is implemented such that it always fails on JITServer", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367080755", "createdAt": "2020-01-15T20:05:18Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/ilgen/Walker.cpp", "diffHunk": "@@ -5568,8 +5568,8 @@ TR_J9ByteCodeIlGenerator::loadFromCP(TR::DataType type, int32_t cpIndex)\n                                                             comp());\n                   if (primitiveCondyCriticalSection.hasVMAccess())\n                      {\n-                     uintptrj_t* objLocation = (uintptrj_t*)_methodSymbol->getResolvedMethod()->dynamicConstant(cpIndex);\n-                     uintptrj_t obj = *objLocation;\n+                     uintptrj_t obj = 0;\n+                     uintptrj_t* objLocation = (uintptrj_t*)_methodSymbol->getResolvedMethod()->dynamicConstant(cpIndex, obj);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/1c2a03a167a55647ca2ae2f3e427e9030ecee41e", "committedDate": "2020-01-15T16:52:10Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "872b3662a579bc16e991677bcc383f3ef086c97e", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/872b3662a579bc16e991677bcc383f3ef086c97e", "committedDate": "2020-01-16T02:58:19Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "872b3662a579bc16e991677bcc383f3ef086c97e", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/872b3662a579bc16e991677bcc383f3ef086c97e", "committedDate": "2020-01-16T02:58:19Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "4e10bcd41beaa44431a93b0b0634313a4eecb124", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/4e10bcd41beaa44431a93b0b0634313a4eecb124", "committedDate": "2020-01-16T03:01:21Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTc5NjUx", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#pullrequestreview-343979651", "createdAt": "2020-01-16T15:05:11Z", "commit": {"oid": "4e10bcd41beaa44431a93b0b0634313a4eecb124"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTowNToxMlrOFecgvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTowNToxMlrOFecgvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2ODczNA==", "bodyText": "This is a change in behavior; previously the compilation thread acquired VM access and potentially waited to do so. With the new code the compilation thread attempts to acquire VM access, but if it cannot get it right away, it bails out.\nI would like some confirmation from the optimizer team that this new behavior is ok (may have performance implications) and that there is a safe path if we don't wait for VM access.", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367468734", "createdAt": "2020-01-16T15:05:12Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/ilgen/Walker.cpp", "diffHunk": "@@ -5465,13 +5465,19 @@ TR_J9ByteCodeIlGenerator::loadFromCP(TR::DataType type, int32_t cpIndex)\n             // Use aconst for null object\n             if (!isCondyPrimitive && !isCondyUnresolved)\n                {\n-               TR::VMAccessCriticalSection condyCriticalSection(comp()->fej9());\n-               uintptrj_t* objLocation = (uintptrj_t*)_methodSymbol->getResolvedMethod()->dynamicConstant(cpIndex);\n-               uintptrj_t obj = *objLocation;\n-               if (obj == 0)\n+               TR::VMAccessCriticalSection condyCriticalSection(comp()->fej9(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e10bcd41beaa44431a93b0b0634313a4eecb124"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTk0MDE1", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#pullrequestreview-343994015", "createdAt": "2020-01-16T15:23:33Z", "commit": {"oid": "4e10bcd41beaa44431a93b0b0634313a4eecb124"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNToyMzozNFrOFedLoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNToyMzozNFrOFedLoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3OTcxMw==", "bodyText": "I see this piece of code:\nbool\nTR_J9VMBase::tryToAcquireAccess(TR::Compilation * comp, bool *haveAcquiredVMAccess)\n   {\n   bool hasVMAccess;\n   *haveAcquiredVMAccess = false;\n\n#if defined(JITSERVER_SUPPORT)\n   // JITServer TODO: For now, we always take the \"safe path\" on the server\n   if (comp->isOutOfProcessCompilation())\n      return false;\n#endif /* defined(JITSERVER_SUPPORT) */\n\nso even today we'll set _hasVMAccess = false and _acquiredVMAccess = false\nDo you think the new code is needed?", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367479713", "createdAt": "2020-01-16T15:23:34Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/J9VMAccessCriticalSection.hpp", "diffHunk": "@@ -64,7 +64,17 @@ class OMR_EXTENSIBLE VMAccessCriticalSection : public OMR::VMAccessCriticalSecti\n             break;\n \n          case tryToAcquireVMAccess:\n-            _hasVMAccess = TR::Compiler->vm.tryToAcquireAccess(comp, &_acquiredVMAccess);\n+#if defined(JITSERVER_SUPPORT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e10bcd41beaa44431a93b0b0634313a4eecb124"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e10bcd41beaa44431a93b0b0634313a4eecb124", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/4e10bcd41beaa44431a93b0b0634313a4eecb124", "committedDate": "2020-01-16T03:01:21Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "62cb7de388e6755a78e470f299ded81e38ff75c7", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/62cb7de388e6755a78e470f299ded81e38ff75c7", "committedDate": "2020-01-16T16:48:51Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62cb7de388e6755a78e470f299ded81e38ff75c7", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/62cb7de388e6755a78e470f299ded81e38ff75c7", "committedDate": "2020-01-16T16:48:51Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "f38a3193d0b0755a8c0667a07f702f66eaee2e8b", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f38a3193d0b0755a8c0667a07f702f66eaee2e8b", "committedDate": "2020-01-16T20:06:23Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726. Also increased the JITServer `MINOR_NUMBER`\nto `2`.\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f38a3193d0b0755a8c0667a07f702f66eaee2e8b", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f38a3193d0b0755a8c0667a07f702f66eaee2e8b", "committedDate": "2020-01-16T20:06:23Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726. Also increased the JITServer `MINOR_NUMBER`\nto `2`.\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "4dab423ae36074c85b9ea31614e1d9b222bb2108", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/4dab423ae36074c85b9ea31614e1d9b222bb2108", "committedDate": "2020-01-16T21:04:32Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\n\nAlso increased the JITServer `MINOR_NUMBER` to `2` since\nthe new message types have to be handled at the client as well.\n\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4dab423ae36074c85b9ea31614e1d9b222bb2108", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/4dab423ae36074c85b9ea31614e1d9b222bb2108", "committedDate": "2020-01-16T21:04:32Z", "message": "Retrieve constant dynamic info from the JITClient\n\n[skip ci]\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\n\nAlso increased the JITServer `MINOR_NUMBER` to `2` since\nthe new message types have to be handled at the client as well.\n\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "b135870d0781687e77bbe37caa69caee4e3f4510", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b135870d0781687e77bbe37caa69caee4e3f4510", "committedDate": "2020-01-21T15:52:30Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\n\nAlso increased the JITServer `MINOR_NUMBER` to `3` since\nthe new message types have to be handled at the client as well.\n\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MDYwMzY5", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#pullrequestreview-346060369", "createdAt": "2020-01-21T17:31:19Z", "commit": {"oid": "b135870d0781687e77bbe37caa69caee4e3f4510"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b135870d0781687e77bbe37caa69caee4e3f4510", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b135870d0781687e77bbe37caa69caee4e3f4510", "committedDate": "2020-01-21T15:52:30Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\n\nAlso increased the JITServer `MINOR_NUMBER` to `3` since\nthe new message types have to be handled at the client as well.\n\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "44d7d1fe51efe91f140e12f44f6cb757d736d511", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/44d7d1fe51efe91f140e12f44f6cb757d736d511", "committedDate": "2020-01-24T19:20:34Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\n\nAlso increased the JITServer `MINOR_NUMBER` to `3` since\nthe new message types have to be handled at the client as well.\n\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b525b74dc16b073175d57c3d213616ad658a0fb", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5b525b74dc16b073175d57c3d213616ad658a0fb", "committedDate": "2020-01-29T19:50:53Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\n\nAlso increased the JITServer `MINOR_NUMBER` to `3` since\nthe new message types have to be handled at the client as well.\n\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44d7d1fe51efe91f140e12f44f6cb757d736d511", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/44d7d1fe51efe91f140e12f44f6cb757d736d511", "committedDate": "2020-01-24T19:20:34Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\n\nAlso increased the JITServer `MINOR_NUMBER` to `3` since\nthe new message types have to be handled at the client as well.\n\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "5b525b74dc16b073175d57c3d213616ad658a0fb", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5b525b74dc16b073175d57c3d213616ad658a0fb", "committedDate": "2020-01-29T19:50:53Z", "message": "Retrieve constant dynamic info from the JITClient\n\nDynamic constant is not stored at the JITServer.\nThe server will send one message to retrieve both the pointer\nand the object values in `TR_ResolvedJ9JITServerMethod::dynamicConstant()`.\nIt has dependency on the new `dynamicConstant` API\ndefined in eclipse/omr#4726.\n\nAlso increased the JITServer `MINOR_NUMBER` to `3` since\nthe new message types have to be handled at the client as well.\n\nThis commit fixes the server crash when running\nJava 11 sanity test `CondyPrimitive_1`.\n\nRelated to #7567\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 834, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}