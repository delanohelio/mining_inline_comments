{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NjU5MzYx", "number": 9752, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNDo0ODowN1rOEBY8ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzowMTozMFrOEC8lxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5ODkyNzMxOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/net/CommunicationStream.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNDo0ODowN1rOGdNQvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNDo0ODowN1rOGdNQvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3OTE2NA==", "bodyText": "This implementation prints something for every message that is received.\nWhat we want is to collect these stats and print them once, at shutdown, much like we print stats about the number of messages by type", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r433279164", "createdAt": "2020-06-01T14:48:07Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/net/CommunicationStream.cpp", "diffHunk": "@@ -73,6 +73,13 @@ CommunicationStream::readMessage(Message &msg)\n \n    // rebuild the message\n    msg.deserialize();\n+\n+   // collect message size\n+#ifdef STATS\n+   static TR_Stats statMsgSize[MessageType_ARRAYSIZE];\n+   statMsgSize[int(msg.type())].update(messageSize);\n+   statMsgSize[int(msg.type())].report(stderr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f3f1d5d39903586e8b89fafd0af8b794277ede4"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc0MjcxOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/CompilationRuntime.hpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyNToxOVrOGej0QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjoyNToxOVrOGej0QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5NzI4MQ==", "bodyText": "better called updateMsgSizeStats", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434697281", "createdAt": "2020-06-03T16:25:19Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -744,6 +744,9 @@ class CompilationInfo\n \n    int32_t getQueueWeight() const { return _queueWeight; }\n    void increaseQueueWeightBy(uint8_t w) { _queueWeight += (int32_t)w; }\n+   TR_Stats *getStatMsgSize() {return _statMsgSize; }\n+   //void setStatMsgSize(TR_Stats *msgSizeArray){ for(int i = 0; i < 243; i++{ _statMsgSize[i] = msgSizeArray[i];}\n+   void setMsgSize(int typeVal, double val){ _statMsgSize[typeVal].update(val); }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47a3acd443a250b23946234cc5695a133130bea5"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc4MTUwOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/CompilationRuntime.hpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjozNToyN1rOGekNgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjozNzowNVrOGekRlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMzc0NQ==", "bodyText": "Avoid hardcoded numbers. I think this should be JITServer::MessageType_ARRAYSIZE", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434703745", "createdAt": "2020-06-03T16:35:27Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -1142,6 +1145,7 @@ class CompilationInfo\n    uint64_t               _lastCompilationsShouldBeInterruptedTime; // RAS\n // statistics\n    int32_t                _statsOptLevels[numHotnessLevels]; // will be zeroed with memset\n+   TR_Stats               _statMsgSize[243];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47a3acd443a250b23946234cc5695a133130bea5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNDc4OQ==", "bodyText": "Also, since this takes quite a bit of space we probably want some #ifdef to not include the code by default.", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434704789", "createdAt": "2020-06-03T16:37:05Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -1142,6 +1145,7 @@ class CompilationInfo\n    uint64_t               _lastCompilationsShouldBeInterruptedTime; // RAS\n // statistics\n    int32_t                _statsOptLevels[numHotnessLevels]; // will be zeroed with memset\n+   TR_Stats               _statMsgSize[243];", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMzc0NQ=="}, "originalCommit": {"oid": "47a3acd443a250b23946234cc5695a133130bea5"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzc5OTMzOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/JITServerHelpers.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjo0MDoyMFrOGekZYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjo0MDoyMFrOGekZYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNjc4NQ==", "bodyText": "These two lines can be combined into one.", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434706785", "createdAt": "2020-06-03T16:40:20Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITServerHelpers.cpp", "diffHunk": "@@ -118,18 +120,22 @@ JITServerHelpers::insertIntoOOSequenceEntryList(ClientSessionData *clientData, T\n    }\n \n void\n-JITServerHelpers::printJITServerMsgStats(J9JITConfig *jitConfig)\n+JITServerHelpers::printJITServerMsgStats(J9JITConfig *jitConfig, TR::CompilationInfo *compInfo)\n    {\n+   //TR::CompilationInfo *compInfo;   \n+   TR_Stats *receiveStatMsg;\n+   receiveStatMsg = compInfo->getStatMsgSize();   ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47a3acd443a250b23946234cc5695a133130bea5"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODAxMTg1OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/net/CommunicationStream.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzozOToxMVrOGemi5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODowNToyNlrOGenehQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc0MTk4OA==", "bodyText": "compInfo is not initialized here. This could lead to crashes", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434741988", "createdAt": "2020-06-03T17:39:11Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/net/CommunicationStream.cpp", "diffHunk": "@@ -73,6 +73,20 @@ CommunicationStream::readMessage(Message &msg)\n \n    // rebuild the message\n    msg.deserialize();\n+\n+   // collect message size\n+/*#ifdef STATS\n+   static TR_Stats statMsgSize[MessageType_ARRAYSIZE];\n+   statMsgSize[int(msg.type())].update(messageSize);\n+   statMsgSize[int(msg.type())].report(stderr);\n+#endif*/\n+   TR::CompilationInfo *compInfo;\n+   static TR_Stats collectMsgStat[MessageType_ARRAYSIZE];\n+   collectMsgStat[int(msg.type())].update(messageSize); //I dont need it anymore since I pass the type and size\n+   //compInfo->setStatMsgSize(collectMsgStat);\n+   compInfo->setMsgSize(int(msg.type()), messageSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47a3acd443a250b23946234cc5695a133130bea5"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc1NzI1Mw==", "bodyText": "Since you don't have easy access to compInfo from communicationStream it may be better to define that TR_Stats collectMsgStat[MessageType_ARRAYSIZE]; as a static field in CommunicationStream class.", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434757253", "createdAt": "2020-06-03T18:05:26Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/net/CommunicationStream.cpp", "diffHunk": "@@ -73,6 +73,20 @@ CommunicationStream::readMessage(Message &msg)\n \n    // rebuild the message\n    msg.deserialize();\n+\n+   // collect message size\n+/*#ifdef STATS\n+   static TR_Stats statMsgSize[MessageType_ARRAYSIZE];\n+   statMsgSize[int(msg.type())].update(messageSize);\n+   statMsgSize[int(msg.type())].report(stderr);\n+#endif*/\n+   TR::CompilationInfo *compInfo;\n+   static TR_Stats collectMsgStat[MessageType_ARRAYSIZE];\n+   collectMsgStat[int(msg.type())].update(messageSize); //I dont need it anymore since I pass the type and size\n+   //compInfo->setStatMsgSize(collectMsgStat);\n+   compInfo->setMsgSize(int(msg.type()), messageSize);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc0MTk4OA=="}, "originalCommit": {"oid": "47a3acd443a250b23946234cc5695a133130bea5"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwODAxNjMxOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/net/CommunicationStream.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzo0MDozMVrOGeml5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzo0MDozMVrOGeml5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc0Mjc1OA==", "bodyText": "These two lines have no purpose now that you moved the stats into compInfo", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434742758", "createdAt": "2020-06-03T17:40:31Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/net/CommunicationStream.cpp", "diffHunk": "@@ -73,6 +73,20 @@ CommunicationStream::readMessage(Message &msg)\n \n    // rebuild the message\n    msg.deserialize();\n+\n+   // collect message size\n+/*#ifdef STATS\n+   static TR_Stats statMsgSize[MessageType_ARRAYSIZE];\n+   statMsgSize[int(msg.type())].update(messageSize);\n+   statMsgSize[int(msg.type())].report(stderr);\n+#endif*/\n+   TR::CompilationInfo *compInfo;\n+   static TR_Stats collectMsgStat[MessageType_ARRAYSIZE];\n+   collectMsgStat[int(msg.type())].update(messageSize); //I dont need it anymore since I pass the type and size", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47a3acd443a250b23946234cc5695a133130bea5"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTI1MTMzOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/CompilationThread.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzowMDo1M1rOGftilA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzowMDo1M1rOGftilA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkwNTE3Mg==", "bodyText": "Let's eliminate this extra line", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r435905172", "createdAt": "2020-06-05T13:00:53Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -3195,6 +3195,7 @@ void TR::CompilationInfo::stopCompilationThreads()\n \n       fprintf(stderr, \"Compilation queue peak size = %d\\n\", getPeakMethodQueueSize());\n       fprintf(stderr, \"Compilation queue size at shutdown = %d\\n\", getMethodQueueSize());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "015cf33de7d99a594133d3b0ba5c212ef2e872d5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTI1MzE4OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/JITServerHelpers.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzowMTozMFrOGftjvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzowMTozMFrOGftjvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkwNTQ2OA==", "bodyText": "Let's eliminate these extra spaces after the curly bracket", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r435905468", "createdAt": "2020-06-05T13:01:30Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITServerHelpers.cpp", "diffHunk": "@@ -119,16 +122,18 @@ JITServerHelpers::insertIntoOOSequenceEntryList(ClientSessionData *clientData, T\n \n void\n JITServerHelpers::printJITServerMsgStats(J9JITConfig *jitConfig)\n-   {\n+   {     ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "015cf33de7d99a594133d3b0ba5c212ef2e872d5"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 99, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}