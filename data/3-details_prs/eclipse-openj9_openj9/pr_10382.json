{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MDE2NDQw", "number": 10382, "title": "Add host class package to anon class name for 11+", "bodyText": "Reflection fails for anonymous classes with a host class in a module which\nexports only certain packages, since in OpenJ9, the anonymous class name does\nnot include package info. In the reference implementation, anonymous classes\ndo have package info in their name, so this commit changes OpenJ9 behaviour to\nmatch that.\nSigned-off-by: Mike Zhang mike.h.zhang@ibm.com\nPart of #7354\nfyi @DanHeidinga", "createdAt": "2020-08-12T21:25:40Z", "url": "https://github.com/eclipse-openj9/openj9/pull/10382", "merged": true, "mergeCommit": {"oid": "86f018783a126a87e79880e7dd072b1a2d3a41bd"}, "closed": true, "closedAt": "2020-08-28T13:23:00Z", "author": {"login": "mikezhang1234567890"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-Shd7ABqjM2NDk1NjQzODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDU8N8gFqTQ3NzcyMzYyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28102c94a1bd19b32b9c42d22f5819e8491a783f", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/28102c94a1bd19b32b9c42d22f5819e8491a783f", "committedDate": "2020-08-12T21:11:41Z", "message": "Add host class package to anon class name for 11+\n\nReflection fails for anonymous classes with a host class in a module which\nexports only certain packages, since in OpenJ9, the anonymous class name does\nnot include package info. In the reference implementation, anonymous classes\ndo have package info in their name, so this commit changes OpenJ9 behaviour to\nmatch that.\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}, "afterCommit": {"oid": "5c9efd601ee2c64f4b133a35e295d46d828b05d0", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5c9efd601ee2c64f4b133a35e295d46d828b05d0", "committedDate": "2020-08-12T21:28:22Z", "message": "Add host class package to anon class name for 11+\n\nReflection fails for anonymous classes with a host class in a module which\nexports only certain packages, since in OpenJ9, the anonymous class name does\nnot include package info. In the reference implementation, anonymous classes\ndo have package info in their name, so this commit changes OpenJ9 behaviour to\nmatch that.\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c9efd601ee2c64f4b133a35e295d46d828b05d0", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5c9efd601ee2c64f4b133a35e295d46d828b05d0", "committedDate": "2020-08-12T21:28:22Z", "message": "Add host class package to anon class name for 11+\n\nReflection fails for anonymous classes with a host class in a module which\nexports only certain packages, since in OpenJ9, the anonymous class name does\nnot include package info. In the reference implementation, anonymous classes\ndo have package info in their name, so this commit changes OpenJ9 behaviour to\nmatch that.\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}, "afterCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3", "committedDate": "2020-08-20T18:05:39Z", "message": "Add host class package to anon class name for 11+\n\nReflection fails for anonymous classes with a host class in a module which\nexports only certain packages, since in OpenJ9, the anonymous class name does\nnot include package info. In the reference implementation, anonymous classes\ndo have package info in their name, so this commit changes OpenJ9 behaviour to\nmatch that.\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODQwMDEx", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#pullrequestreview-475840011", "createdAt": "2020-08-26T20:36:51Z", "commit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozNjo1MVrOHHczrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozNjo1MVrOHHczrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3NDA2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif ((J2SE_VERSION(vm) >= J2SE_V11) && J9_ARE_ALL_BITS_SET(originalRAMClass->classFlags, J9ClassIsAnonymous)) {\n          \n          \n            \n            \t\t\tJ9ROMClass *hostROMClass = originalRAMClass->hostClass->romClass;\n          \n          \n            \n            \t\t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));;\n          \n          \n            \n            \t\t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n          \n          \n            \n            \t\t} else {\n          \n          \n            \n            \t\t\tloadData.hostPackageName = NULL;\n          \n          \n            \n            \t\t\tloadData.hostPackageLength = 0;\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \t\tloadData.hostPackageName = NULL;\n          \n          \n            \n            \t\tloadData.hostPackageLength = 0;\n          \n          \n            \n            \t\tif ((J2SE_VERSION(vm) >= J2SE_V11) && J9_ARE_ALL_BITS_SET(originalRAMClass->classFlags, J9ClassIsAnonymous)) {\n          \n          \n            \n            \t\t\tJ9ROMClass *hostROMClass = originalRAMClass->hostClass->romClass;\n          \n          \n            \n            \t\t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));;\n          \n          \n            \n            \t\t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n          \n          \n            \n            \t\t}", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#discussion_r477574063", "createdAt": "2020-08-26T20:36:51Z", "author": {"login": "DanHeidinga"}, "path": "runtime/util/hshelp.c", "diffHunk": "@@ -3531,6 +3531,15 @@ reloadROMClasses(J9VMThread * currentThread, jint class_count, const jvmtiClassD\n \t\tloadData.protectionDomain = J9VMJAVALANGCLASS_PROTECTIONDOMAIN(currentThread, heapClass);\n \t\tloadData.options = options;\n \n+\t\tif ((J2SE_VERSION(vm) >= J2SE_V11) && J9_ARE_ALL_BITS_SET(originalRAMClass->classFlags, J9ClassIsAnonymous)) {\n+\t\t\tJ9ROMClass *hostROMClass = originalRAMClass->hostClass->romClass;\n+\t\t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));;\n+\t\t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n+\t\t} else {\n+\t\t\tloadData.hostPackageName = NULL;\n+\t\t\tloadData.hostPackageLength = 0;\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODQwMDg0", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#pullrequestreview-475840084", "createdAt": "2020-08-26T20:36:58Z", "commit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozNjo1OFrOHHcz5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozNjo1OFrOHHcz5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3NDExOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tif (isAnonFlagSet && (J2SE_VERSION(vm) >= J2SE_V11)) {\n          \n          \n            \n            \t\tJ9ROMClass *hostROMClass = hostClass->romClass;\n          \n          \n            \n            \t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));\n          \n          \n            \n            \t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n          \n          \n            \n            \t} else {\n          \n          \n            \n            \t\tloadData.hostPackageName = NULL;\n          \n          \n            \n            \t\tloadData.hostPackageLength = 0;\n          \n          \n            \n            \t}\n          \n          \n            \n            \tloadData.hostPackageName = NULL;\n          \n          \n            \n            \tloadData.hostPackageLength = 0;\n          \n          \n            \n            \tif (isAnonFlagSet && (J2SE_VERSION(vm) >= J2SE_V11)) {\n          \n          \n            \n            \t\tJ9ROMClass *hostROMClass = hostClass->romClass;\n          \n          \n            \n            \t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));\n          \n          \n            \n            \t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n          \n          \n            \n            \t}", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#discussion_r477574118", "createdAt": "2020-08-26T20:36:58Z", "author": {"login": "DanHeidinga"}, "path": "runtime/bcutil/defineclass.c", "diffHunk": "@@ -107,6 +107,15 @@ internalDefineClass(\n \tloadData.freeFunction = NULL;\n \tloadData.romClass = existingROMClass;\n \n+\tif (isAnonFlagSet && (J2SE_VERSION(vm) >= J2SE_V11)) {\n+\t\tJ9ROMClass *hostROMClass = hostClass->romClass;\n+\t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));\n+\t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n+\t} else {\n+\t\tloadData.hostPackageName = NULL;\n+\t\tloadData.hostPackageLength = 0;\n+\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODQ4ODI3", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#pullrequestreview-475848827", "createdAt": "2020-08-26T20:50:28Z", "commit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDo1MDoyOFrOHHdPdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDo1MDoyOFrOHHdPdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4MTE3NQ==", "bodyText": "I see for hidden classes tests, package name is already there. So I think package name should only be added for classes defined by Unsafe.defineAnonymous().  Hidden class can be anonymous, so package name should be added for non-hidden anon classes, i.e. isClassAnon() && !isClassHidden. You can change handleAnonClassName() to take an addition parameter like bool isHidden, and check this parameter to decide whether to add package name.", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#discussion_r477581175", "createdAt": "2020-08-26T20:50:28Z", "author": {"login": "hangshao0"}, "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -430,7 +440,7 @@ ROMClassBuilder::prepareAndLaydown( BufferManager *bufferManager, ClassFileParse\n \n \tbool isLambda = false;\n \tif (context->isClassAnon() || context->isClassHidden()) {\n-\t\tBuildResult res = handleAnonClassName(classFileParser->getParsedClassFile(), &isLambda);\n+\t\tBuildResult res = handleAnonClassName(classFileParser->getParsedClassFile(), &isLambda, context->hostPackageName(), context->hostPackageLength());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3de508ae78bcd1050e4697c7c7587be77136383b", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3de508ae78bcd1050e4697c7c7587be77136383b", "committedDate": "2020-08-27T18:56:31Z", "message": "Add host class package to anon class name for 11+\n\nReflection fails for anonymous classes with a host class in a module which\nexports only certain packages, since in OpenJ9, the anonymous class name does\nnot include package info. In the reference implementation, anonymous classes\ndo have package info in their name, so this commit changes OpenJ9 behaviour to\nmatch that.\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3", "committedDate": "2020-08-20T18:05:39Z", "message": "Add host class package to anon class name for 11+\n\nReflection fails for anonymous classes with a host class in a module which\nexports only certain packages, since in OpenJ9, the anonymous class name does\nnot include package info. In the reference implementation, anonymous classes\ndo have package info in their name, so this commit changes OpenJ9 behaviour to\nmatch that.\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}, "afterCommit": {"oid": "3de508ae78bcd1050e4697c7c7587be77136383b", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3de508ae78bcd1050e4697c7c7587be77136383b", "committedDate": "2020-08-27T18:56:31Z", "message": "Add host class package to anon class name for 11+\n\nReflection fails for anonymous classes with a host class in a module which\nexports only certain packages, since in OpenJ9, the anonymous class name does\nnot include package info. In the reference implementation, anonymous classes\ndo have package info in their name, so this commit changes OpenJ9 behaviour to\nmatch that.\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NzIzNjI0", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#pullrequestreview-477723624", "createdAt": "2020-08-28T13:22:53Z", "commit": {"oid": "3de508ae78bcd1050e4697c7c7587be77136383b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 145, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}