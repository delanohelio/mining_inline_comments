{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NzEwMDQx", "number": 8445, "title": "Recognize fma method on Z", "bodyText": "Using vector form fma Instruction Opcode: VFMA to generate a customized sequence of any calls to the Math.fma() method.\nNote that if the method is of the type float, it will recognize the method only if VectorFacilityEnhancement1 is installed.\nIssue:#7474\nSigned-off-by: Bohao(Aaron) Wang aaronwang0407@gmail.com", "createdAt": "2020-01-29T18:46:56Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8445", "merged": true, "mergeCommit": {"oid": "71081ebf0b78fd01a285fb0a253398f3d9d49f77"}, "closed": true, "closedAt": "2020-02-12T21:32:38Z", "author": {"login": "wbh123456"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_x_fHgBqjI5OTc3NjEzNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDYtCPAFqTM1NzAxMjgyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0929ceb179a0d84a0b29bd473ad9068194c7ba51", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/0929ceb179a0d84a0b29bd473ad9068194c7ba51", "committedDate": "2020-01-29T16:03:19Z", "message": "Recognize fma method on Z\n\nRecognized java math/strict math fma double/float methods\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}, "afterCommit": {"oid": "27a72104007e24371d19f496a8d3e3068ee6f1fb", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/27a72104007e24371d19f496a8d3e3068ee6f1fb", "committedDate": "2020-01-31T16:36:53Z", "message": "Recognize fma method on Z\n\nRecognized java math/strict math fma double/float methods\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27a72104007e24371d19f496a8d3e3068ee6f1fb", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/27a72104007e24371d19f496a8d3e3068ee6f1fb", "committedDate": "2020-01-31T16:36:53Z", "message": "Recognize fma method on Z\n\nRecognized java math/strict math fma double/float methods\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}, "afterCommit": {"oid": "989360f69940f6848010f40269b2618c0e5a695d", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/989360f69940f6848010f40269b2618c0e5a695d", "committedDate": "2020-01-31T18:29:00Z", "message": "Recognize fma method on Z\n\nRecognized java math/strict math fma double/float methods\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "989360f69940f6848010f40269b2618c0e5a695d", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/989360f69940f6848010f40269b2618c0e5a695d", "committedDate": "2020-01-31T18:29:00Z", "message": "Recognize fma method on Z\n\nRecognized java math/strict math fma double/float methods\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}, "afterCommit": {"oid": "39463eaad36c7dd49c871afb921ce25ac99e6be7", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/39463eaad36c7dd49c871afb921ce25ac99e6be7", "committedDate": "2020-02-03T15:34:30Z", "message": "Recognize fma method on Z\n\nRecognized java math/strict math fma double/float methods\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39463eaad36c7dd49c871afb921ce25ac99e6be7", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/39463eaad36c7dd49c871afb921ce25ac99e6be7", "committedDate": "2020-02-03T15:34:30Z", "message": "Recognize fma method on Z\n\nRecognized java math/strict math fma double/float methods\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}, "afterCommit": {"oid": "e7b0ac34de6314979d0077929ea8558d2c6aa4ad", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e7b0ac34de6314979d0077929ea8558d2c6aa4ad", "committedDate": "2020-02-03T16:29:57Z", "message": "Suppress inlining of math.fma functions\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7b0ac34de6314979d0077929ea8558d2c6aa4ad", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e7b0ac34de6314979d0077929ea8558d2c6aa4ad", "committedDate": "2020-02-03T16:29:57Z", "message": "Suppress inlining of math.fma functions\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}, "afterCommit": {"oid": "2170387b6af9c2873949fc7ae06d8d72bbb6a1df", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2170387b6af9c2873949fc7ae06d8d72bbb6a1df", "committedDate": "2020-02-03T17:10:35Z", "message": "Suppress inlining of math.fma functions\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMDExOTY5", "url": "https://github.com/eclipse-openj9/openj9/pull/8445#pullrequestreview-353011969", "createdAt": "2020-02-04T14:22:40Z", "commit": {"oid": "2170387b6af9c2873949fc7ae06d8d72bbb6a1df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNDoyMjo0MFrOFlVwuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNDoyMjo0MFrOFlVwuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY5ODE3MQ==", "bodyText": "Is this what we want here since it would stop it being recognized later? Would it make more sense to follow the convention an inner if with another switch for these two methods where the resultReg would be set and return true would happen so that if it does not match or the capability is not enabled evaluation will continue like for most other matchers?", "url": "https://github.com/eclipse-openj9/openj9/pull/8445#discussion_r374698171", "createdAt": "2020-02-04T14:22:40Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/z/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -4107,6 +4123,32 @@ J9::Z::CodeGenerator::inlineDirectCall(\n                break;\n             }\n          }\n+      if (cg->getSupportsVectorRegisters())\n+         {\n+         switch (methodSymbol->getRecognizedMethod())\n+            {\n+            case TR::java_lang_Math_fma_D:\n+            case TR::java_lang_StrictMath_fma_D:\n+               resultReg = inlineMathFma(node, cg);\n+               return true;\n+\n+            case TR::java_lang_Math_fma_F:\n+            case TR::java_lang_StrictMath_fma_F:\n+               if (comp->target().cpu.getSupportsVectorFacilityEnhancement1())\n+                  {\n+                  resultReg = inlineMathFma(node, cg);\n+                  return true;\n+                  }\n+               else ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2170387b6af9c2873949fc7ae06d8d72bbb6a1df"}, "originalPosition": 50}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2170387b6af9c2873949fc7ae06d8d72bbb6a1df", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2170387b6af9c2873949fc7ae06d8d72bbb6a1df", "committedDate": "2020-02-03T17:10:35Z", "message": "Suppress inlining of math.fma functions\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}, "afterCommit": {"oid": "1b9aa33c254f815b5ddb0b429ef0f118970368b3", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/1b9aa33c254f815b5ddb0b429ef0f118970368b3", "committedDate": "2020-02-04T20:58:10Z", "message": "Suppress inlining of math.fma functions\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMjk2OTEw", "url": "https://github.com/eclipse-openj9/openj9/pull/8445#pullrequestreview-353296910", "createdAt": "2020-02-04T20:59:31Z", "commit": {"oid": "2170387b6af9c2873949fc7ae06d8d72bbb6a1df"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMTowMDozOVrOFljSzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMTowMDozOVrOFljSzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkxOTg4Nw==", "bodyText": "This is a bug. It will prematurely kill the registers associated with the node. If the children of the call are commoned somewhere then this could result in a garbage value being held in the corresponding register at runtime. We need to remove these three lines. In general we only call stopUsingRegister on registers which were allocated within the evaluator or helper (i.e. registers created via allocateRegister API).\nCan we add some unit tests for this API? I'd like to see a commoning test in there which would have caught this bug.", "url": "https://github.com/eclipse-openj9/openj9/pull/8445#discussion_r374919887", "createdAt": "2020-02-04T21:00:39Z", "author": {"login": "fjeremic"}, "path": "runtime/compiler/z/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -1101,6 +1101,33 @@ inlineDoubleMin(TR::Node *node, TR::CodeGenerator *cg)\n    return doubleMaxMinHelper(node, cg, false);\n    }\n \n+extern TR::Register * \n+inlineMathFma(TR::Node *node, TR::CodeGenerator *cg)\n+   {\n+   TR_ASSERT_FATAL(node->getNumChildren() == 3, \n+   \"In function inlineMathFma, the node at address %p should have exactly 3 children, but got %u instead\", node, node->getNumChildren());\n+\n+   TR::Register      * targetRegister      = cg->allocateRegister(TR_VRF);  \n+\n+   TR::Register      * v1      = cg->evaluate(node->getFirstChild());\n+   TR::Register      * v2      = cg->evaluate(node->getSecondChild());\n+   TR::Register      * v3      = cg->evaluate(node->getThirdChild());\n+\n+   uint8_t mask6 = getVectorElementSizeMask(TR::DataType::getSize(node->getDataType()));\n+   generateVRReInstruction(cg, TR::InstOpCode::VFMA, node, targetRegister, v1, v2, v3, mask6, 0);\n+\n+   cg->stopUsingRegister(v1);\n+   cg->stopUsingRegister(v2);\n+   cg->stopUsingRegister(v3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9aa33c254f815b5ddb0b429ef0f118970368b3"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b9aa33c254f815b5ddb0b429ef0f118970368b3", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/1b9aa33c254f815b5ddb0b429ef0f118970368b3", "committedDate": "2020-02-04T20:58:10Z", "message": "Suppress inlining of math.fma functions\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}, "afterCommit": {"oid": "c57c0597e2b42e02fb1fccac0da61f3cfb532a74", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c57c0597e2b42e02fb1fccac0da61f3cfb532a74", "committedDate": "2020-02-11T18:49:25Z", "message": "Suppress inlining of math.fma functions\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTEyMzI5", "url": "https://github.com/eclipse-openj9/openj9/pull/8445#pullrequestreview-356912329", "createdAt": "2020-02-11T18:59:35Z", "commit": {"oid": "c57c0597e2b42e02fb1fccac0da61f3cfb532a74"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxODo1OTozNVrOFoVLPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxODo1OTozNVrOFoVLPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgzNDMwMw==", "bodyText": "I don't think the result should be stored in a vector register. The data type of node is a double or a float, so the result should live in an FPR. I think we could run into a scenario here where the register allocator chooses to allocate VRF26 for example, then if the result of the FMA call gets used again for example to feed into an argument to another call we would fail.\nI think you should be able to construct a test case for this as well. What happens if the result of one FMA call is used as an argument to another method?", "url": "https://github.com/eclipse-openj9/openj9/pull/8445#discussion_r377834303", "createdAt": "2020-02-11T18:59:35Z", "author": {"login": "fjeremic"}, "path": "runtime/compiler/z/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -1101,6 +1101,29 @@ inlineDoubleMin(TR::Node *node, TR::CodeGenerator *cg)\n    return doubleMaxMinHelper(node, cg, false);\n    }\n \n+extern TR::Register * \n+inlineMathFma(TR::Node *node, TR::CodeGenerator *cg)\n+   {\n+   TR_ASSERT_FATAL(node->getNumChildren() == 3, \n+   \"In function inlineMathFma, the node at address %p should have exactly 3 children, but got %u instead\", node, node->getNumChildren());\n+\n+   TR::Register      * targetRegister      = cg->allocateRegister(TR_VRF);  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c57c0597e2b42e02fb1fccac0da61f3cfb532a74"}, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e8c9b2ac20d625eb235cfb423e4f03128d203c2", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/6e8c9b2ac20d625eb235cfb423e4f03128d203c2", "committedDate": "2020-02-11T19:07:23Z", "message": "Add test cases where children of fma call is commoned\n\nThe purpose of this commit is to expose bugs cause by inproperly using\nstopUsingRegister().\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}, "afterCommit": {"oid": "56e35b74109ae63bd24c0c6f4460f1f69f0dfc3c", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/56e35b74109ae63bd24c0c6f4460f1f69f0dfc3c", "committedDate": "2020-02-11T20:25:33Z", "message": "Add test cases where children of fma call is commoned\n\nThe purpose of this commit is to expose bugs cause by inproperly using\nstopUsingRegister().\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56e35b74109ae63bd24c0c6f4460f1f69f0dfc3c", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/56e35b74109ae63bd24c0c6f4460f1f69f0dfc3c", "committedDate": "2020-02-11T20:25:33Z", "message": "Add test cases where children of fma call is commoned\n\nThe purpose of this commit is to expose bugs cause by inproperly using\nstopUsingRegister().\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}, "afterCommit": {"oid": "7343132b15a5a2ff4aa7fe8b382cc3db1934240a", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/7343132b15a5a2ff4aa7fe8b382cc3db1934240a", "committedDate": "2020-02-11T20:29:56Z", "message": "Add test cases where children of fma call is commoned\n\nThe purpose of this commit is to expose bugs cause by inproperly using\nstopUsingRegister().\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab73869d9b8e3db30d559c436d7869169062b119", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ab73869d9b8e3db30d559c436d7869169062b119", "committedDate": "2020-02-11T21:04:02Z", "message": "Recognize fma method on Z\n\nRecognized java math/strict math fma double/float methods\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cccef74f3c82ca0f51d7869e34da87891551bf0b", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/cccef74f3c82ca0f51d7869e34da87891551bf0b", "committedDate": "2020-02-11T21:04:04Z", "message": "Suppress inlining of math.fma functions\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebcff195a8604fbbd2ff996ea686f6cc272eb278", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ebcff195a8604fbbd2ff996ea686f6cc272eb278", "committedDate": "2020-02-11T21:04:04Z", "message": "Add test cases where children of fma call is commoned\n\nThe purpose of this commit is to expose bugs cause by inproperly using\nstopUsingRegister().\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7343132b15a5a2ff4aa7fe8b382cc3db1934240a", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/7343132b15a5a2ff4aa7fe8b382cc3db1934240a", "committedDate": "2020-02-11T20:29:56Z", "message": "Add test cases where children of fma call is commoned\n\nThe purpose of this commit is to expose bugs cause by inproperly using\nstopUsingRegister().\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}, "afterCommit": {"oid": "ebcff195a8604fbbd2ff996ea686f6cc272eb278", "author": {"user": {"login": "wbh123456", "name": "Bohao (Aaron) Wang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ebcff195a8604fbbd2ff996ea686f6cc272eb278", "committedDate": "2020-02-11T21:04:04Z", "message": "Add test cases where children of fma call is commoned\n\nThe purpose of this commit is to expose bugs cause by inproperly using\nstopUsingRegister().\n\nSigned-off-by: Bohao(Aaron) Wang <aaronwang0407@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MDEyODIy", "url": "https://github.com/eclipse-openj9/openj9/pull/8445#pullrequestreview-357012822", "createdAt": "2020-02-11T21:34:46Z", "commit": {"oid": "ebcff195a8604fbbd2ff996ea686f6cc272eb278"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 701, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}