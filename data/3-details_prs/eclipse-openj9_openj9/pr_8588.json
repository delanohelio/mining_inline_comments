{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NjAxNjQx", "number": 8588, "title": "Runtime compressed refs work", "bodyText": "Get balanced going in mixed mode.\n[ci skip]\nSigned-off-by: Graham Chapman graham_chapman@ca.ibm.com", "createdAt": "2020-02-14T22:36:36Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8588", "merged": true, "mergeCommit": {"oid": "02c5280da058ada57477a4bb1d7bf0613a155b1c"}, "closed": true, "closedAt": "2020-02-25T03:11:01Z", "author": {"login": "gacholio"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEXbl4ABqjMwNDAzNDYzMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHmf_MgH2gAyMzc1NjAxNjQxOjQ1MmRmYWY2ZWVlZTBiOTZkMDFjY2NjZjI0OWVjMDk3MTJlY2MzNzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73e866ef3a8617d4cd896230a63c6c90acd76d09", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/73e866ef3a8617d4cd896230a63c6c90acd76d09", "committedDate": "2020-02-14T22:39:18Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "2dd02470c80341f97a7885e9afe5797660f96885", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2dd02470c80341f97a7885e9afe5797660f96885", "committedDate": "2020-02-14T22:39:57Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2dd02470c80341f97a7885e9afe5797660f96885", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2dd02470c80341f97a7885e9afe5797660f96885", "committedDate": "2020-02-14T22:39:57Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "3a13e3216cb5d34c987df3baa23f7d221f936cc3", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3a13e3216cb5d34c987df3baa23f7d221f936cc3", "committedDate": "2020-02-18T16:09:18Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a13e3216cb5d34c987df3baa23f7d221f936cc3", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3a13e3216cb5d34c987df3baa23f7d221f936cc3", "committedDate": "2020-02-18T16:09:18Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "3eeb9fe31ce95041be9a81385d4784a84e5120f7", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3eeb9fe31ce95041be9a81385d4784a84e5120f7", "committedDate": "2020-02-18T16:22:32Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDkxNDg4", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-360491488", "createdAt": "2020-02-18T16:35:47Z", "commit": {"oid": "3eeb9fe31ce95041be9a81385d4784a84e5120f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjozNTo0N1rOFrJqGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjozNTo0N1rOFrJqGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc5MTMyMQ==", "bodyText": "How it suppose to work for run-time selected CR? For all other cases Remembered Set Cards is an array of MM_RememberedSetCard[]. So I would assume for run-time selected CR it is U_32 used in each U_64. But code below (add and subtract) suggests cards located contiguously and my assumption is wrong. Did I miss something?\nLooks like Remembered Set Cards memory is used like an array of U_32 for CR and array of U_64 and for run-time CR it is not an array of MM_RememberedSetCard[] any more. Technically it would work but it is confusing for me slightly. Any opinions on this?", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#discussion_r380791321", "createdAt": "2020-02-18T16:35:47Z", "author": {"login": "dmitripivkine"}, "path": "runtime/gc_base/modron.h", "diffHunk": "@@ -171,5 +171,13 @@ extern \"C\" fj9object_t j9gc_objaccess_tokenFromPointer(J9VMThread *vmThread, mm_\n \n /** @} */\n \n+#if defined (OMR_GC_FULL_POINTERS)\n+/* Enough space to hold a heap address, compressed or not */\n+typedef UDATA MM_RememberedSetCard;\n+#else /* OMR_GC_FULL_POINTERS */\n+/* Compresses a heap address by shifting right by CARD_SIZE_SHIFT */\n+typedef U_32 MM_RememberedSetCard; \n+#endif /* OMR_GC_FULL_POINTERS */\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eeb9fe31ce95041be9a81385d4784a84e5120f7"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjY4NzI2", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-360668726", "createdAt": "2020-02-18T21:00:25Z", "commit": {"oid": "3eeb9fe31ce95041be9a81385d4784a84e5120f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTowMDoyNVrOFrSPHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTowMDoyNVrOFrSPHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkzMTg2OQ==", "bodyText": "I might have had been ok with this, but thinking now if these 4 methods (read/write/sub/add) could be statics in RSCard (which obviously needs to upgrade from typedef to class)?\nThat would be at least consistent with GC_SlotObject story.", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#discussion_r380931869", "createdAt": "2020-02-18T21:00:25Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/EnvironmentVLHGC.hpp", "diffHunk": "@@ -100,6 +99,84 @@ class MM_EnvironmentVLHGC : public MM_EnvironmentBase\n \tMMINLINE static MM_EnvironmentVLHGC *getEnvironment(OMR_VMThread *omrVMThread) { return static_cast<MM_EnvironmentVLHGC*>(omrVMThread->_gcOmrVMThreadExtensions); }\n \tMMINLINE static MM_EnvironmentVLHGC *getEnvironment(MM_EnvironmentBase* env) { return static_cast<MM_EnvironmentVLHGC*>(env); }\n \n+\tMMINLINE static uintptr_t rsCardSize(bool compressed) { return compressed ? sizeof(uint32_t) : sizeof(uintptr_t); }\n+\n+\tMMINLINE uintptr_t rsCardSize() { return rsCardSize(compressObjectReferences()); }\n+\n+\t/**\n+\t * Read the value of a card.\n+\t *\n+\t * @param[in] addr the card address\n+\t * @return the card value\n+\t */\n+\tMMINLINE MM_RememberedSetCard readCard(MM_RememberedSetCard *addr)\n+\t{\n+\t\treturn compressObjectReferences() ? (MM_RememberedSetCard)*(uint32_t*)addr : (MM_RememberedSetCard)*(uintptr_t*)addr;\n+\t}\n+\n+\t/**\n+\t * Write the value of a card.\n+\t *\n+\t * @param[in] addr the card address\n+\t * @param[in] card the card value\n+\t */\n+\tMMINLINE void writeCard(MM_RememberedSetCard *addr, MM_RememberedSetCard card)\n+\t{\n+\t\tif (compressObjectReferences()) {\n+\t\t\t*(uint32_t*)addr = (uint32_t)card;\n+\t\t} else {\n+\t\t\t*(uintptr_t*)addr = (uintptr_t)card;\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Calculate the addition of an integer to a card address\n+\t *\n+\t * @param[in] base the base card address\n+\t * @param[in] index the index to add\n+\t * @return the adjusted address\n+\t */\n+\tMMINLINE MM_RememberedSetCard* addToCardAddress(MM_RememberedSetCard *base, intptr_t index)\n+\t{\n+\t\tif (compressObjectReferences()) {\n+\t\t\treturn (MM_RememberedSetCard*)((uint32_t*)base + index);\n+\t\t} else {\n+\t\t\treturn (MM_RememberedSetCard*)((uintptr_t*)base + index);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Calculate the subtraction of an integer from a card address\n+\t *\n+\t * @param[in] base the base card address\n+\t * @param[in] index the index to subtract\n+\t * @return the adjusted address\n+\t */\n+\tMMINLINE MM_RememberedSetCard* subtractFromCardAddress(MM_RememberedSetCard *base, intptr_t index)\n+\t{\n+\t\tif (compressObjectReferences()) {\n+\t\t\treturn (MM_RememberedSetCard*)((uint32_t*)base - index);\n+\t\t} else {\n+\t\t\treturn (MM_RememberedSetCard*)((uintptr_t*)base - index);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Calculate the difference between two card addresses, in slots\n+\t *\n+\t * @param[in] p1 the value to be subtracted from\n+\t * @param[in] p2 the value to be subtracted\n+\t * @return p1 - p2 in slots\n+\t */\n+\tMMINLINE intptr_t subtractCardAddresses(MM_RememberedSetCard *p1, MM_RememberedSetCard *p2)\n+\t{\n+\t\tif (compressObjectReferences()) {\n+\t\t\treturn (uint32_t*)p1 - (uint32_t*)p2;\n+\t\t} else {\n+\t\t\treturn (uintptr_t*)p1 - (uintptr_t*)p2;\n+\t\t}\n+\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eeb9fe31ce95041be9a81385d4784a84e5120f7"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjcxMTE3", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-360671117", "createdAt": "2020-02-18T21:04:19Z", "commit": {"oid": "3eeb9fe31ce95041be9a81385d4784a84e5120f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTowNDoyMFrOFrSWRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTowNDoyMFrOFrSWRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkzMzcwMw==", "bodyText": "I said this before, but there should be a helper like EnvBase::getReferenceSize(). You've just introduced similar one for RS Card size. But this being an OpenJ9 change and EnvBase being in OMR, of course, this is not the right moment to introduce it.", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#discussion_r380933703", "createdAt": "2020-02-18T21:04:20Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/RememberedSetCardBucket.cpp", "diffHunk": "@@ -184,10 +184,11 @@ MM_RememberedSetCardBucket::getSize(MM_EnvironmentVLHGC *env)\n \tUDATA size = _bufferCount * MAX_BUFFER_SIZE;\n \tif (_bufferCount > 0) {\n \t\tAssert_MM_true(NULL != _current);\n-\t\tUDATA offset = (UDATA)_current & OFFSET_MASK;\n+\t\tUDATA offset = (UDATA)_current & offsetMask(env);\n \t\tif (0 != offset) {\n \t\t\t/* subtract the unused portion of the current buffer */\n-\t\t\tsize -= MAX_BUFFER_SIZE - (offset / sizeof (MM_RememberedSetCard));\n+\t\t\tuintptr_t const referenceSize = env->compressObjectReferences() ? sizeof(uint32_t) : sizeof(uintptr_t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eeb9fe31ce95041be9a81385d4784a84e5120f7"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjcxOTA1", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-360671905", "createdAt": "2020-02-18T21:05:43Z", "commit": {"oid": "3eeb9fe31ce95041be9a81385d4784a84e5120f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTowNTo0NFrOFrSYnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTowNTo0NFrOFrSYnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkzNDMwMw==", "bodyText": "Sooner or later tight loops like this should be optimized so that 'is CR' check done ideally only once per iteration. I can see 4 hidden checks here.", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#discussion_r380934303", "createdAt": "2020-02-18T21:05:44Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/RememberedSetCardBucket.cpp", "diffHunk": "@@ -213,13 +214,14 @@ MM_RememberedSetCardBucket::compact(MM_EnvironmentVLHGC *env)\n \n \t\t\t/* find top index for this buffer */\n \t\t\tUDATA fromIndexTop = MAX_BUFFER_SIZE;\n-\t\t\tif (isCurrentSlotWithinBuffer(fromBufferCardList)) {\n-\t\t\t\tfromIndexTop = _current -  fromBufferCardList;\n+\t\t\tif (isCurrentSlotWithinBuffer(env, fromBufferCardList)) {\n+\t\t\t\tfromIndexTop = env->subtractCardAddresses(_current, fromBufferCardList);\n \t\t\t}\n \n \t\t\tfor (UDATA fromIndex = 0; fromIndex < fromIndexTop; fromIndex++) {\n-\t\t\t\tif (0 != fromBufferCardList[fromIndex]) {\n-\t\t\t\t\ttoBufferCardList[toIndex++] = fromBufferCardList[fromIndex];\n+\t\t\t\tMM_RememberedSetCard card = env->readCard(env->addToCardAddress(fromBufferCardList, fromIndex));\n+\t\t\t\tif (0 != card) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eeb9fe31ce95041be9a81385d4784a84e5120f7"}, "originalPosition": 62}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c373e09e9d42e3f0b44fb8a6d38a1b8d44172640", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c373e09e9d42e3f0b44fb8a6d38a1b8d44172640", "committedDate": "2020-02-21T17:38:28Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "4c0d7613b70708309c0dd8627d95a3a1c6c63b2d", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/4c0d7613b70708309c0dd8627d95a3a1c6c63b2d", "committedDate": "2020-02-21T17:38:47Z", "message": "new rscard\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c156cff57098da11e2e8b3e8e87c1c0d642a4ed0", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c156cff57098da11e2e8b3e8e87c1c0d642a4ed0", "committedDate": "2020-02-21T17:41:35Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "3fd134f2bf87c0310fdee9db4a4cafca2e9f6020", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3fd134f2bf87c0310fdee9db4a4cafca2e9f6020", "committedDate": "2020-02-21T17:41:51Z", "message": "new rscard\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "655b432315e66722bf83872884712b80fb769756", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/655b432315e66722bf83872884712b80fb769756", "committedDate": "2020-02-21T17:46:24Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "5c8de07dc76981f40ff617a3341c3a8b2eee84c8", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5c8de07dc76981f40ff617a3341c3a8b2eee84c8", "committedDate": "2020-02-21T17:46:42Z", "message": "new rscard\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c8de07dc76981f40ff617a3341c3a8b2eee84c8", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5c8de07dc76981f40ff617a3341c3a8b2eee84c8", "committedDate": "2020-02-21T17:46:42Z", "message": "new rscard\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "90907ba102fb7ceab1dd8a3c3adb051803edd2c9", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/90907ba102fb7ceab1dd8a3c3adb051803edd2c9", "committedDate": "2020-02-21T17:59:36Z", "message": "new rscard\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODIxMTE2", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-362821116", "createdAt": "2020-02-21T18:15:47Z", "commit": {"oid": "6e2b2a4721854b6cce68cb1e267b14ba4ce4da7b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODoxNjo0NFrOFtAFNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxODoxNjo0NFrOFtAFNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjczMTU3NQ==", "bodyText": "This is cleaner, but I getting greedy and I'll suggest more (but if you feel it's excessive requirement, no problem - we can go with this as-is and I can re-eval my thinking at a later point with fresh brain)\nI'd like to see a field uintptr_t/uint_32 (same as you had with typedef orignal) inside this class. Field name could be 'address' (or 'value'). We would have a constructor and allow instantiation. We could even have  getter/setter to access address field, although it's probably excessive - the field could just simple be a public.\nThen,\nUDATA card = 0;\nwould turn into\nCard card(0);\nreadCard would return instance of Card, and since  operator '=' would work, code like\nUDATA card = readCard(); would revert back to\nCard card = readCard(...).\nPassing card as parameter (of type Card)  in a method would also work since there is default copy operator.\nOperator == is unfortunately not defined by default so it should be defined or a method isEqual should be introduced.\nVarious spots in the code that do arithmetic operations under card will have to access it with\ncard.address rather than just using card. For example class methods substruct/add would than have to do something like:\n(uint32_t*)base.address + index\nFinally, the 4 methods (all except cardSize()) could even turn into non-statics.", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#discussion_r382731575", "createdAt": "2020-02-21T18:16:44Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/RememberedSetCard.hpp", "diffHunk": "@@ -0,0 +1,118 @@\n+/*******************************************************************************\n+ * Copyright (c) 1991, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+/**\n+ * @file\n+ * @ingroup gc_vlhgc\n+ */\n+\n+#if !defined(REMEMBEREDSETCARD_HPP)\n+#define REMEMBEREDSETCARD_HPP\n+\n+#include \"modron.h\"\n+\n+class MM_RememberedSetCard", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90907ba102fb7ceab1dd8a3c3adb051803edd2c9"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d3112e52fb3fe80e05b589c70fd282219b0395e", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2d3112e52fb3fe80e05b589c70fd282219b0395e", "committedDate": "2020-02-21T19:04:31Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "02ff2732053546c5e04d5f0fe695c4b322a27137", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/02ff2732053546c5e04d5f0fe695c4b322a27137", "committedDate": "2020-02-21T19:04:57Z", "message": "new rscard\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87a16f7a0ba464edeb318b747d1b9fa78bde065c", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/87a16f7a0ba464edeb318b747d1b9fa78bde065c", "committedDate": "2020-02-22T01:39:11Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "cf8c8aea3cdac4b24c8ec0a78c21a294783ad220", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/cf8c8aea3cdac4b24c8ec0a78c21a294783ad220", "committedDate": "2020-02-22T01:40:03Z", "message": "new rscard\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1e231d1fb5c7e5f601e3cbd4b4b23bbaa6aa4d4", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c1e231d1fb5c7e5f601e3cbd4b4b23bbaa6aa4d4", "committedDate": "2020-02-22T01:50:15Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "11ce4408982ddce8620fac9d8b58e3d5bc5b428a", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/11ce4408982ddce8620fac9d8b58e3d5bc5b428a", "committedDate": "2020-02-22T01:50:43Z", "message": "new rscard\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "397f0da671eb68e7426a8998176b2fc176412a3f", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/397f0da671eb68e7426a8998176b2fc176412a3f", "committedDate": "2020-02-22T02:43:28Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "f761663ca17e3eb37841b8a0531e10dfd445257c", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f761663ca17e3eb37841b8a0531e10dfd445257c", "committedDate": "2020-02-22T03:37:00Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNDUxODIz", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-363451823", "createdAt": "2020-02-24T14:59:44Z", "commit": {"oid": "f761663ca17e3eb37841b8a0531e10dfd445257c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNDo1OTo0NVrOFtjrMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNDo1OTo0NVrOFtjrMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMxNDczNw==", "bodyText": "These 2 lines could be more concise by using GC_SlotObject::readReferenceFromSlot() instead of readSlot&mmPointerFromToken", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#discussion_r383314737", "createdAt": "2020-02-24T14:59:45Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/IncrementalGenerationalGC.cpp", "diffHunk": "@@ -2254,13 +2255,15 @@ MM_IncrementalGenerationalGC::exportStats(MM_EnvironmentVLHGC *env, MM_Collectio\n \t\t\t\tif (classesPotentiallyUnloaded && !isMarked((J9Object *)spine)) {\n \t\t\t\t\tstats->_arrayletUnknownLeaves += 1;\n \t\t\t\t\t/* is this first arraylet leaf? */\n-\t\t\t\t\tif (region->getLowAddress() == mmPointerFromToken((J9VMThread*)env->getLanguageVMThread(), _extensions->indexableObjectModel.getArrayoidPointer(spine)[0])) {\n+\t\t\t\t\tfj9object_t firstArrayletLeaf = GC_SlotObject::readSlot(_extensions->indexableObjectModel.getArrayoidPointer(spine), compressed);\n+\t\t\t\t\tif (region->getLowAddress() == mmPointerFromToken((J9VMThread*)env->getLanguageVMThread(), firstArrayletLeaf)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f761663ca17e3eb37841b8a0531e10dfd445257c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNTE4NDc4", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-363518478", "createdAt": "2020-02-24T16:21:43Z", "commit": {"oid": "6dafab052cbd0bce74229dd6950de26b617d0d1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNjoyMTo0NFrOFtm3ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNjoyMTo0NFrOFtm3ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM2NzA3NQ==", "bodyText": "please use MAX_BUFFER_SIZE * MM_RememberedSetCard::cardSize(env->compressObjectReferences())\nas-is is unclear if it's relying on card size or obj ref size", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#discussion_r383367075", "createdAt": "2020-02-24T16:21:44Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/RememberedSetCardBucket.hpp", "diffHunk": "@@ -70,6 +62,11 @@ class MM_RememberedSetCardBucket : public MM_BaseNonVirtual {\n public:\n \t/* function members */\n private:\n+\tMMINLINE uintptr_t offsetMask(MM_EnvironmentVLHGC *env)\n+\t{\n+\t\treturn (MAX_BUFFER_SIZE * (env->compressObjectReferences() ? sizeof(uint32_t) : sizeof(uintptr_t))) - 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dafab052cbd0bce74229dd6950de26b617d0d1b"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50044e7dd31d60d9e67f13574891fa9fc74297d6", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/50044e7dd31d60d9e67f13574891fa9fc74297d6", "committedDate": "2020-02-24T16:40:52Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "72091ae6c5b6cd0db2378594915efe9535397a9c", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/72091ae6c5b6cd0db2378594915efe9535397a9c", "committedDate": "2020-02-24T16:46:47Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNTQ0MzI4", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-363544328", "createdAt": "2020-02-24T16:54:25Z", "commit": {"oid": "72091ae6c5b6cd0db2378594915efe9535397a9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f93ba175e2f2731252f6f61d623d67bff1a6a162", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f93ba175e2f2731252f6f61d623d67bff1a6a162", "committedDate": "2020-02-24T17:03:36Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "711312c0f870cf927bf82fbdc953619bfba2d90e", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/711312c0f870cf927bf82fbdc953619bfba2d90e", "committedDate": "2020-02-24T17:03:54Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf5848fb240cf8a25c2cbc442ca06a0a0de70b22", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/cf5848fb240cf8a25c2cbc442ca06a0a0de70b22", "committedDate": "2020-02-24T17:39:19Z", "message": "Signed-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "dff0e3d527ce775ab44fcdb2b28d44efdbf23c9b", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/dff0e3d527ce775ab44fcdb2b28d44efdbf23c9b", "committedDate": "2020-02-24T17:39:36Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjc0MDY0", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-363674064", "createdAt": "2020-02-24T20:20:22Z", "commit": {"oid": "dff0e3d527ce775ab44fcdb2b28d44efdbf23c9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDoyMDoyMlrOFtuiyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDoyMDoyMlrOFtuiyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5MjgwOA==", "bodyText": "Would you please remove ++ from toIndex++ but add toIndex += 1; after write?", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#discussion_r383492808", "createdAt": "2020-02-24T20:20:22Z", "author": {"login": "dmitripivkine"}, "path": "runtime/gc_vlhgc/RememberedSetCardBucket.cpp", "diffHunk": "@@ -213,13 +217,16 @@ MM_RememberedSetCardBucket::compact(MM_EnvironmentVLHGC *env)\n \n \t\t\t/* find top index for this buffer */\n \t\t\tUDATA fromIndexTop = MAX_BUFFER_SIZE;\n-\t\t\tif (isCurrentSlotWithinBuffer(fromBufferCardList)) {\n-\t\t\t\tfromIndexTop = _current -  fromBufferCardList;\n+\t\t\tif (isCurrentSlotWithinBuffer(env, fromBufferCardList)) {\n+\t\t\t\tfromIndexTop = MM_RememberedSetCard::subtractCardAddresses(_current, fromBufferCardList, compressed);\n \t\t\t}\n \n \t\t\tfor (UDATA fromIndex = 0; fromIndex < fromIndexTop; fromIndex++) {\n-\t\t\t\tif (0 != fromBufferCardList[fromIndex]) {\n-\t\t\t\t\ttoBufferCardList[toIndex++] = fromBufferCardList[fromIndex];\n+\t\t\t\tMM_RememberedSetCard *fromAddress = MM_RememberedSetCard::addToCardAddress(fromBufferCardList, fromIndex, compressed);\n+\t\t\t\tUDATA card = MM_RememberedSetCard::readCard(fromAddress, compressed);\n+\t\t\t\tif (0 != card) {\n+\t\t\t\t\tMM_RememberedSetCard *toAddress = MM_RememberedSetCard::addToCardAddress(toBufferCardList, toIndex++, compressed);\n+\t\t\t\t\tMM_RememberedSetCard::writeCard(toAddress, card, compressed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dff0e3d527ce775ab44fcdb2b28d44efdbf23c9b"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjc5MTQw", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-363679140", "createdAt": "2020-02-24T20:29:31Z", "commit": {"oid": "dff0e3d527ce775ab44fcdb2b28d44efdbf23c9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDoyOTozMVrOFtuyyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDoyOTozMVrOFtuyyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5NjkwNA==", "bodyText": "Same here: could _cardIndex be incremented in separate line please?", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#discussion_r383496904", "createdAt": "2020-02-24T20:29:31Z", "author": {"login": "dmitripivkine"}, "path": "runtime/gc_vlhgc/RememberedSetCardListCardIterator.cpp", "diffHunk": "@@ -68,14 +69,16 @@ GC_RememberedSetCardListCardIterator::nextBucket(MM_EnvironmentBase* env)\n \treturn true;\n }\n \n-MM_RememberedSetCard\n-GC_RememberedSetCardListCardIterator::nextReferencingCard(MM_EnvironmentBase* env)\n+UDATA\n+GC_RememberedSetCardListCardIterator::nextReferencingCard(MM_EnvironmentBase *env)\n {\n+\tbool const compressed = env->compressObjectReferences();\n \tdo {\n \t\tdo {\n \t\t\t/* next card within the buffer */\n \t\t\tif (_cardIndex < _cardIndexTop) {\n-\t\t\t\treturn _bufferCardList[_cardIndex++];\n+\t\t\t\tMM_RememberedSetCard *cardAddress = MM_RememberedSetCard::addToCardAddress(_bufferCardList, _cardIndex++, compressed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dff0e3d527ce775ab44fcdb2b28d44efdbf23c9b"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjgwMTY3", "url": "https://github.com/eclipse-openj9/openj9/pull/8588#pullrequestreview-363680167", "createdAt": "2020-02-24T20:31:20Z", "commit": {"oid": "dff0e3d527ce775ab44fcdb2b28d44efdbf23c9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dff0e3d527ce775ab44fcdb2b28d44efdbf23c9b", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/dff0e3d527ce775ab44fcdb2b28d44efdbf23c9b", "committedDate": "2020-02-24T17:39:36Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}, "afterCommit": {"oid": "452dfaf6eeee0b96d01ccccf249ec09712ecc375", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/452dfaf6eeee0b96d01ccccf249ec09712ecc375", "committedDate": "2020-02-24T23:54:53Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "452dfaf6eeee0b96d01ccccf249ec09712ecc375", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/452dfaf6eeee0b96d01ccccf249ec09712ecc375", "committedDate": "2020-02-24T23:54:53Z", "message": "Runtime compressed refs work\n\nGet balanced going in mixed mode.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 539, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}