{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NTk4MDUy", "number": 9330, "title": "String table read barrier", "bodyText": "Replacing Collector (Scavenge) specific code in a middle of StringTable\ncode, with more generic barrier API.\nBesides, the original code was not fully correct, since it was using\nForwardedHeader variant that is used for Partial GC in Balanced, that\nis not aware of:\n\nself forwarded pointer.\nlarge object parallel copy protocol\n\nAll other code is just renaming various ReadBarrier APIs, giving them\nmore generic name that serves the same purpose for any kind of Weak\n(Clearable) Root: just updates the slot in case object is already\nforwarded, but does trigger a copy (keep it alive), even if in Evacuate\nspace.\nThis code has several more suspicious spots needing further scrutiny:\n\nreferring directly to Metronome and\nreading object slots directly without using Read Barrier API\n(currently, probably benign because those are pre=tenured objects not\nsubject to movement, but obviously not future-proof),\nbut the change does the bare minimum to fix a known problem.\n\nSigned-off-by: Aleksandar Micic amicic@ca.ibm.com", "createdAt": "2020-04-22T23:26:51Z", "url": "https://github.com/eclipse-openj9/openj9/pull/9330", "merged": true, "mergeCommit": {"oid": "63586490c4875042bea88b3c7393799881eddfb7"}, "closed": true, "closedAt": "2020-04-23T21:00:41Z", "author": {"login": "amicic"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaQ0--AH2gAyNDA3NTk4MDUyOjFiYmIzZGQxNTE0YjJjZDY3ZTE5MGExZTE1ZDA4NmU5NjQ3ZWIyMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcagUgAAFqTM5OTMyMDE4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1bbb3dd1514b2cd67e190a1e15d086e9647eb239", "author": {"user": {"login": "amicic", "name": "Aleksandar Micic"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/1bbb3dd1514b2cd67e190a1e15d086e9647eb239", "committedDate": "2020-04-22T23:24:28Z", "message": "String table read barrier\n\nReplacing Collector (Scavenge) specific code in a middle of StringTable\ncode, with more generic barrier API.\n\nBesides, the original code was not fully correct, since it was using\nForwardedHeader variant that is used for Partial GC in Balanced, that\nis not aware of:\n1) self forwarded pointer.\n2) large object parallel copy protocol\n\nAll other code is just renaming various ReadBarrier APIs, giving them\nmore generic name that serves the same purpose for any kind of Weak\n(Clearable) Root: just updates the slot in case object is already\nforwarded, but does trigger a copy (keep it alive), even if in Evacuate\nspace.\n\nThis code has several more suspicious spots needing further scrutiny:\n1) referring directly to Metronome and\n2) reading object slots directly without using Read Barrier API\n(currently, probably benign because those are pre=tenured objects not\nsubject to movement, but obviously not future-proof),\nbut the change does the bare minimum to fix a known problem.\n\nSigned-off-by: Aleksandar Micic <amicic@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NzcyNTU4", "url": "https://github.com/eclipse-openj9/openj9/pull/9330#pullrequestreview-398772558", "createdAt": "2020-04-23T05:38:40Z", "commit": {"oid": "1bbb3dd1514b2cd67e190a1e15d086e9647eb239"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNTozODo0MFrOGKXcfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNTozODo0MFrOGKXcfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUyMzA2OA==", "bodyText": "I'm slightly concerned about the performance implications of this change as this will now call thru:\n MM_ReadBarrierVerifier::preWeakRootSlotRead(J9VMThread *vmThread, j9object_t *srcAddress)\n {\n \tAssert_MM_true(vmThread->javaVM->internalVMFunctions->currentVMThread(vmThread->javaVM) == vmThread);\nand that assert isn't free.\nWhat performance testing do you plan to do for this?", "url": "https://github.com/eclipse-openj9/openj9/pull/9330#discussion_r413523068", "createdAt": "2020-04-23T05:38:40Z", "author": {"login": "DanHeidinga"}, "path": "runtime/gc_base/StringTable.cpp", "diffHunk": "@@ -224,16 +224,7 @@ stringComparatorFn(struct J9AVLTree *tree, struct J9AVLTreeNode *leftNode, struc\n \tstu8Ptr = *((UDATA*) (leftNode+1)); \n \n \t/* Get at the String information  */\n-\tright_s = *(j9object_t *)(rightNode+1);\n-\n-\tif (!isMetronome) {\n-\t\t/* Check if string was copy-forwarded.  Only do this on non-metronome since metronome re-uses the FORWARDED bit */\n-\t\tMM_ScavengerForwardedHeader forwardedHeader(right_s, extensions);\n-\t\tJ9Object* forwardedPtr = forwardedHeader.getForwardedObject();\n-\t\tif (NULL != forwardedPtr) {\n-\t\t\tright_s = forwardedPtr;\n-\t\t}\n-\t}\n+\tright_s = J9WEAKROOT_OBJECT_LOAD_VM(javaVM, (j9object_t *)(rightNode+1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bbb3dd1514b2cd67e190a1e15d086e9647eb239"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MjI0NjMz", "url": "https://github.com/eclipse-openj9/openj9/pull/9330#pullrequestreview-399224633", "createdAt": "2020-04-23T15:36:44Z", "commit": {"oid": "1bbb3dd1514b2cd67e190a1e15d086e9647eb239"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MzEwOTU4", "url": "https://github.com/eclipse-openj9/openj9/pull/9330#pullrequestreview-399310958", "createdAt": "2020-04-23T17:15:48Z", "commit": {"oid": "1bbb3dd1514b2cd67e190a1e15d086e9647eb239"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MzIwMTgx", "url": "https://github.com/eclipse-openj9/openj9/pull/9330#pullrequestreview-399320181", "createdAt": "2020-04-23T17:27:28Z", "commit": {"oid": "1bbb3dd1514b2cd67e190a1e15d086e9647eb239"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1054, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}