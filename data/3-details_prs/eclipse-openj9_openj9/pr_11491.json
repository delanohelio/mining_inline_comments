{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxMzM5NzM1", "number": 11491, "title": "Handle monitor enter/exit on value based instances in Power", "bodyText": "Depends on\n\n #11358\n\nRelated to JEP390\nSigned-off-by: Annabelle Huo Annabelle.Huo@ibm.com", "createdAt": "2020-12-16T17:53:08Z", "url": "https://github.com/eclipse-openj9/openj9/pull/11491", "merged": true, "mergeCommit": {"oid": "b981493d215c29b078f3044dfd8b6370207771ae"}, "closed": true, "closedAt": "2021-01-18T15:23:41Z", "author": {"login": "a7ehuo"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnFvQ_AH2gAyNTQxMzM5NzM1OjgxYWY2MWFmZTM2MzQ3NjQwMzI1YTA0YzAwODRkNDg3MzYyNGFhZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtQrQEgFqTU2MjA5NjcwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "81af61afe36347640325a04c0084d4873624aae6", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/81af61afe36347640325a04c0084d4873624aae6", "committedDate": "2020-12-17T16:01:26Z", "message": "Power: Handle monitor enter/exit on value based instances\n\nRelated to JEP390\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a04e303696d084671fc09f6dc55e8259f851675", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9a04e303696d084671fc09f6dc55e8259f851675", "committedDate": "2020-12-16T17:50:50Z", "message": "Power: Handle monitor enter/exit on value based instances\n\nRelated to JEP390\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "81af61afe36347640325a04c0084d4873624aae6", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/81af61afe36347640325a04c0084d4873624aae6", "committedDate": "2020-12-17T16:01:26Z", "message": "Power: Handle monitor enter/exit on value based instances\n\nRelated to JEP390\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNTIxNTY2", "url": "https://github.com/eclipse-openj9/openj9/pull/11491#pullrequestreview-561521566", "createdAt": "2021-01-05T05:24:07Z", "commit": {"oid": "81af61afe36347640325a04c0084d4873624aae6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwNToyNDowOFrOIOKgwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwNToyNDowOFrOIOKgwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTcyMzIwMA==", "bodyText": "The fact that the new flag is outside of the immediate value range for Power is a bit concerning but I guess we ran out of smaller flags? @tajila", "url": "https://github.com/eclipse-openj9/openj9/pull/11491#discussion_r551723200", "createdAt": "2021-01-05T05:24:08Z", "author": {"login": "gita-omr"}, "path": "runtime/compiler/p/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -7727,11 +7729,13 @@ void J9::Power::TreeEvaluator::generateCheckForValueTypeMonitorEnterOrExit(TR::N\n    TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());\n    TR::MemoryReference *classFlagsMemRef = TR::MemoryReference::createWithDisplacement(cg, objectClassReg, static_cast<uintptr_t>(fej9->getOffsetOfClassFlags()), 4);\n \n-   //check J9ClassIsValueType flag\n-   generateTrg1MemInstruction(cg,TR::InstOpCode::lwz, node, tempReg, classFlagsMemRef);\n-   generateTrg1Src1ImmInstruction(cg, TR::InstOpCode::andi_r, node, tempReg, tempReg, condReg, J9ClassIsValueType);\n+   //check J9_CLASS_DISALLOWS_LOCKING_FLAGS (J9ClassIsValueType | J9ClassIsValueBased)\n+   generateTrg1MemInstruction(cg, TR::InstOpCode::lwz, node, temp1Reg, classFlagsMemRef);\n \n-   //If obj is value type, call VM helper and throw IllegalMonitorState exception, else continue as usual\n+   loadConstant(cg, node, classFlag, temp2Reg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81af61afe36347640325a04c0084d4873624aae6"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxOTU3ODI3", "url": "https://github.com/eclipse-openj9/openj9/pull/11491#pullrequestreview-561957827", "createdAt": "2021-01-05T16:52:10Z", "commit": {"oid": "81af61afe36347640325a04c0084d4873624aae6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNjo1MjoxMVrOIOe-8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNjo1MjoxMVrOIOe-8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA1ODYwOQ==", "bodyText": "Was there a reason for adding the int32_t classFlag parameter? It looks like the constant J9_CLASS_DISALLOWS_LOCKING_FLAGS is the only value that is ever passed in.", "url": "https://github.com/eclipse-openj9/openj9/pull/11491#discussion_r552058609", "createdAt": "2021-01-05T16:52:11Z", "author": {"login": "IBMJimmyk"}, "path": "runtime/compiler/p/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -7718,7 +7720,7 @@ static bool simpleReadMonitor(TR::Node *node, TR::CodeGenerator *cg, TR::Node *o\n    return true;\n    }\n \n-void J9::Power::TreeEvaluator::generateCheckForValueTypeMonitorEnterOrExit(TR::Node *node, TR::LabelSymbol *helperCallLabel, TR::Register *objReg, TR::Register *objectClassReg, TR::Register *tempReg, TR::Register *condReg, TR::CodeGenerator *cg)\n+void J9::Power::TreeEvaluator::generateCheckForValueMonitorEnterOrExit(TR::Node *node, TR::LabelSymbol *helperCallLabel, TR::Register *objReg, TR::Register *objectClassReg, TR::Register *temp1Reg, TR::Register *temp2Reg, TR::Register *condReg, TR::CodeGenerator *cg, int32_t classFlag)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81af61afe36347640325a04c0084d4873624aae6"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMDk2NzA4", "url": "https://github.com/eclipse-openj9/openj9/pull/11491#pullrequestreview-562096708", "createdAt": "2021-01-05T20:09:33Z", "commit": {"oid": "81af61afe36347640325a04c0084d4873624aae6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1520, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}