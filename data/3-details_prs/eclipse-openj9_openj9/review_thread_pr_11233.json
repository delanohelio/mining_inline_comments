{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MjM4OTM3", "number": 11233, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMToyNjo0OVrOE87c3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMToyODo1MVrOE9BnLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMzI0MDYzOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/env/j9methodServer.cpp", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMToyNjo0OVrOH5V1Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxODozNzo1OVrOH5_xEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4ODUxOA==", "bodyText": "Maybe create a fieldOrStaticSignature that returns an UTF8here so that we avoid the conversion to char * and then back to UTF8", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r529888518", "createdAt": "2020-11-24T21:26:49Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/j9methodServer.cpp", "diffHunk": "@@ -2054,6 +2054,33 @@ TR_ResolvedJ9JITServerMethod::archetypeArgPlaceholderSlot()\n    return paramSlots;\n    }\n \n+bool\n+TR_ResolvedJ9JITServerMethod::isFieldQType(int32_t cpIndex)\n+   {\n+   if (!TR::Compiler->om.areValueTypesEnabled() ||\n+      (-1 == cpIndex))\n+      return false;\n+\n+   auto comp = _fe->_compInfoPT->getCompilation();\n+   int32_t sigLen;\n+   char *sig = fieldOrStaticSignatureChars(cpIndex, sigLen);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU1MjU3MQ==", "bodyText": "Doing that would require also adding versions of getROMString and getRemoteROMString that return UTF8, since fieldOrStaticSignature uses them to get the signature.\nIf that's something worth doing maybe it's better to do it in a separate PR?", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530552571", "createdAt": "2020-11-25T17:52:41Z", "author": {"login": "dmitry-ten"}, "path": "runtime/compiler/env/j9methodServer.cpp", "diffHunk": "@@ -2054,6 +2054,33 @@ TR_ResolvedJ9JITServerMethod::archetypeArgPlaceholderSlot()\n    return paramSlots;\n    }\n \n+bool\n+TR_ResolvedJ9JITServerMethod::isFieldQType(int32_t cpIndex)\n+   {\n+   if (!TR::Compiler->om.areValueTypesEnabled() ||\n+      (-1 == cpIndex))\n+      return false;\n+\n+   auto comp = _fe->_compInfoPT->getCompilation();\n+   int32_t sigLen;\n+   char *sig = fieldOrStaticSignatureChars(cpIndex, sigLen);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4ODUxOA=="}, "originalCommit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3NTYzNA==", "bodyText": "I think it's worth doing, so let's open another PR for that", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530575634", "createdAt": "2020-11-25T18:37:59Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/j9methodServer.cpp", "diffHunk": "@@ -2054,6 +2054,33 @@ TR_ResolvedJ9JITServerMethod::archetypeArgPlaceholderSlot()\n    return paramSlots;\n    }\n \n+bool\n+TR_ResolvedJ9JITServerMethod::isFieldQType(int32_t cpIndex)\n+   {\n+   if (!TR::Compiler->om.areValueTypesEnabled() ||\n+      (-1 == cpIndex))\n+      return false;\n+\n+   auto comp = _fe->_compInfoPT->getCompilation();\n+   int32_t sigLen;\n+   char *sig = fieldOrStaticSignatureChars(cpIndex, sigLen);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4ODUxOA=="}, "originalCommit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDI1MDA0OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMToyODo1MVrOH5fqdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNzowMToxMFrOH58hQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0OTY1Mg==", "bodyText": "In J9::ClassEnv::enumerateFields when we retrieve the data from the client there is an assumption that the strings are null terminated. I was under the impression that the string constructor does not copy the null terminating character. Maybe some implementations do that so that they can optimize the c_str() function, but I don't think it's guaranteed.", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530049652", "createdAt": "2020-11-25T01:28:51Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -2162,6 +2172,28 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, TR::Compiler->cls.isClassRefValueType(comp, clazz, cpIndex));\n          }\n          break;\n+      case MessageType::ClassEnv_enumerateFields:\n+         {\n+         auto recv = client->getRecvData<TR_OpaqueClassBlock *>();\n+         const TR::TypeLayout* layout = comp->typeLayout(std::get<0>(recv));\n+\n+         std::vector<TR::TypeLayoutEntry> entries;\n+         std::vector<std::string> fieldNames;\n+         std::vector<std::string> typeSignatures;\n+         entries.reserve(layout->count());\n+         fieldNames.reserve(layout->count());\n+         typeSignatures.reserve(layout->count());\n+         for (int32_t idx = 0; idx < layout->count(); ++idx)\n+            {\n+            const TR::TypeLayoutEntry &entry = layout->entry(idx);\n+            entries.push_back(entry);\n+            // both strings are null-terminated so we don't need to know length\n+            fieldNames.push_back(std::string(entry._fieldname));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA1NDg0MQ==", "bodyText": "Apparently, starting with C++11 it is guaranteed to have a null terminator:\nThe returned array is null-terminated, that is, data() and c_str() perform the same function.", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530054841", "createdAt": "2020-11-25T01:46:28Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -2162,6 +2172,28 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, TR::Compiler->cls.isClassRefValueType(comp, clazz, cpIndex));\n          }\n          break;\n+      case MessageType::ClassEnv_enumerateFields:\n+         {\n+         auto recv = client->getRecvData<TR_OpaqueClassBlock *>();\n+         const TR::TypeLayout* layout = comp->typeLayout(std::get<0>(recv));\n+\n+         std::vector<TR::TypeLayoutEntry> entries;\n+         std::vector<std::string> fieldNames;\n+         std::vector<std::string> typeSignatures;\n+         entries.reserve(layout->count());\n+         fieldNames.reserve(layout->count());\n+         typeSignatures.reserve(layout->count());\n+         for (int32_t idx = 0; idx < layout->count(); ++idx)\n+            {\n+            const TR::TypeLayoutEntry &entry = layout->entry(idx);\n+            entries.push_back(entry);\n+            // both strings are null-terminated so we don't need to know length\n+            fieldNames.push_back(std::string(entry._fieldname));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0OTY1Mg=="}, "originalCommit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUyMjQzMw==", "bodyText": "Yeah, I used c_str() under the assumption that the result would have a null-terminator", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530522433", "createdAt": "2020-11-25T17:01:10Z", "author": {"login": "dmitry-ten"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -2162,6 +2172,28 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, TR::Compiler->cls.isClassRefValueType(comp, clazz, cpIndex));\n          }\n          break;\n+      case MessageType::ClassEnv_enumerateFields:\n+         {\n+         auto recv = client->getRecvData<TR_OpaqueClassBlock *>();\n+         const TR::TypeLayout* layout = comp->typeLayout(std::get<0>(recv));\n+\n+         std::vector<TR::TypeLayoutEntry> entries;\n+         std::vector<std::string> fieldNames;\n+         std::vector<std::string> typeSignatures;\n+         entries.reserve(layout->count());\n+         fieldNames.reserve(layout->count());\n+         typeSignatures.reserve(layout->count());\n+         for (int32_t idx = 0; idx < layout->count(); ++idx)\n+            {\n+            const TR::TypeLayoutEntry &entry = layout->entry(idx);\n+            entries.push_back(entry);\n+            // both strings are null-terminated so we don't need to know length\n+            fieldNames.push_back(std::string(entry._fieldname));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0OTY1Mg=="}, "originalCommit": {"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 948, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}