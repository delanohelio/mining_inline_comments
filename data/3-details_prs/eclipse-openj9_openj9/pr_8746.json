{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzNzI5NTcz", "number": 8746, "title": "Fix computation of flush bounds", "bodyText": "don't assume pointers are 64-bits or platform is little-endian\nmore carefully compute first and last cache lines to flush", "createdAt": "2020-03-04T17:33:47Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8746", "merged": true, "mergeCommit": {"oid": "a38cb4cb977ff47f0389fd7c5fe0455299f05f39"}, "closed": true, "closedAt": "2020-03-04T19:54:23Z", "author": {"login": "keithc-ca"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKa6nkgFqTM2OTAwMzI1Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKcWVsAFqTM2OTA3MTk5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDAzMjUy", "url": "https://github.com/eclipse-openj9/openj9/pull/8746#pullrequestreview-369003252", "createdAt": "2020-03-04T18:06:52Z", "commit": {"oid": "8bef0d914c3bfd3fa9d4177ef589ef468ddd6b5f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxODowNjo1MlrOFx36vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxODowNjo1MlrOFx36vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg0MDcwMg==", "bodyText": "Please put the whiles on the brace line.", "url": "https://github.com/eclipse-openj9/openj9/pull/8746#discussion_r387840702", "createdAt": "2020-03-04T18:06:52Z", "author": {"login": "gacholio"}, "path": "runtime/jcl/common/sun_misc_Unsafe.cpp", "diffHunk": "@@ -844,58 +844,65 @@ Java_jdk_internal_misc_Unsafe_objectFieldOffset1(JNIEnv *env, jobject receiver,\n \t\t}\n \t}\n \tvmFuncs->internalExitVMToJNI(currentThread);\n-\t\n+\n \treturn offset;\n }\n \n /**\n  * Writes modified memory in an address range from cache to main memory.\n  * Uses memory barriers before and after writeback to ensure ordering.\n- * \n+ *\n  * On x86, the writeback is done using the CLWB instruction if available\n  * for performance, falling back to CLFLUSHOPT then CLFLUSH otherwise.\n- * \n+ *\n  * @param addr address of block to write back to memory\n  * @param len length of block being written\n  */\n void JNICALL\n Java_jdk_internal_misc_Unsafe_writebackMemory(JNIEnv *env, jobject receiver, jlong addr, jlong len)\n {\n /* Exclude Windows since it does not support GCC assembly syntax,\n- * and Linux is the only target actually specified in JEP 352\n+ * and Linux is the only target actually specified in JEP 352.\n  */\n-#if ((defined(J9X86) || defined(J9HAMMER)) && !defined(WIN32))\n-\tJ9VMThread *currentThread = (J9VMThread*)env;\n+#if (defined(J9X86) || defined(J9HAMMER)) && !defined(WIN32)\n+\tJ9VMThread *currentThread = (J9VMThread *)env;\n \tJ9JavaVM *vm = currentThread->javaVM;\n \tuintptr_t cacheLineSize = vm->dCacheLineSize;\n \n \tif (cacheLineSize > 0) {\n-\t\tU_8 *endAddr = (*(U_8 **) &addr) + (*(uintptr_t *) &len) - 1;\n-\t\tU_8 *ptr = (U_8 *)((*(uintptr_t *) &addr) & ~(cacheLineSize - 1));\n+\t\tuintptr_t const uaddr = (uintptr_t)(U_64)addr;\n+\t\tuintptr_t const ulen = (uintptr_t)(U_64)len;\n+\t\tuintptr_t const firstCacheLine = uaddr & ~(cacheLineSize - 1);\n+\t\tuintptr_t const lastCacheLine = (uaddr + ((0 == ulen) ? 0 : (ulen - 1))) & ~(cacheLineSize - 1);\n+\n+\t\t/* adjust for pre-increment in the loops below */\n+\t\tuintptr_t cacheLine = firstCacheLine - cacheLineSize;\n \n \t\tVM_AtomicSupport::readWriteBarrier();\n-\t\tswitch(vm->cpuCacheWritebackCapabilities) {\n-\t\t\tcase J9PORT_X86_FEATURE_CLWB:\n-\t\t\t\tfor (; ptr < endAddr; ptr += cacheLineSize) {\n-\t\t\t\t\tasm volatile(\"clwb %0\" : \"+m\" (*ptr));\n-\t\t\t\t}\n-\t\t\t\t/* writeback any partial cache line at the end */\n-\t\t\t\tasm volatile(\"clwb %0\" : \"+m\" (*endAddr));\n-\t\t\t\tbreak;\n-\t\t\tcase J9PORT_X86_FEATURE_CLFLUSHOPT:\n-\t\t\t\tfor (; ptr < endAddr; ptr += cacheLineSize) {\n-\t\t\t\t\tasm volatile(\"clflushopt %0\" : \"+m\" (*ptr));\n-\t\t\t\t}\n-\t\t\t\tasm volatile(\"clflushopt %0\" : \"+m\" (*endAddr));\n-\t\t\t\tbreak;\n-\t\t\tcase J9PORT_X86_FEATURE_CLFSH:\n-\t\t\t\tfor (; ptr < endAddr; ptr += cacheLineSize) {\n-\t\t\t\t\tasm volatile(\"clflush %0\" : \"+m\" (*ptr));\n-\t\t\t\t}\n-\t\t\t\tasm volatile(\"clflush %0\" : \"+m\" (*endAddr));\n-\t\t\t\tbreak;\n-\t\t\tdefault:\n-\t\t\t\tgoto error;\n+\t\tswitch (vm->cpuCacheWritebackCapabilities) {\n+\t\tcase J9PORT_X86_FEATURE_CLWB:\n+\t\t\tdo {\n+\t\t\t\tcacheLine += cacheLineSize;\n+\t\t\t\tasm volatile(\"clwb %0\" : \"+m\" (*(U_8 *)cacheLine));\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bef0d914c3bfd3fa9d4177ef589ef468ddd6b5f"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c37996e0ddd02a5f82e1c9ac9b8c563684a0a02", "author": {"user": {"login": "keithc-ca", "name": "Keith W. Campbell"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/1c37996e0ddd02a5f82e1c9ac9b8c563684a0a02", "committedDate": "2020-03-04T19:05:24Z", "message": "Fix computation of flush bounds\n\n* don't assume pointers are 64-bits or platform is little-endian\n* more carefully compute first and last cache lines to flush\n\nSigned-off-by: Keith W. Campbell <keithc@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8bef0d914c3bfd3fa9d4177ef589ef468ddd6b5f", "author": {"user": {"login": "keithc-ca", "name": "Keith W. Campbell"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8bef0d914c3bfd3fa9d4177ef589ef468ddd6b5f", "committedDate": "2020-03-04T16:01:38Z", "message": "Fix computation of flush bounds\n\n* don't assume pointers are 64-bits or platform is little-endian\n* more carefully compute first and last cache lines to flush\n\nSigned-off-by: Keith W. Campbell <keithc@ca.ibm.com>"}, "afterCommit": {"oid": "1c37996e0ddd02a5f82e1c9ac9b8c563684a0a02", "author": {"user": {"login": "keithc-ca", "name": "Keith W. Campbell"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/1c37996e0ddd02a5f82e1c9ac9b8c563684a0a02", "committedDate": "2020-03-04T19:05:24Z", "message": "Fix computation of flush bounds\n\n* don't assume pointers are 64-bits or platform is little-endian\n* more carefully compute first and last cache lines to flush\n\nSigned-off-by: Keith W. Campbell <keithc@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDcxOTk0", "url": "https://github.com/eclipse-openj9/openj9/pull/8746#pullrequestreview-369071994", "createdAt": "2020-03-04T19:47:04Z", "commit": {"oid": "1c37996e0ddd02a5f82e1c9ac9b8c563684a0a02"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 658, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}