{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MDkwMzAx", "number": 9918, "title": "Assign getStackTrace result to a local variable to avoid refetching", "bodyText": "Assigned J9VMInternals.getStackTrace(this, true) result to a local variable to avoid refetching the instance variable and any memory ordering issues.\nA few notes:\nThe NPE reported in #9663 usually can be reproduced in 1 or 2 runs with JIT on, with this PR, 50 runs succeeded.\nAs per investigation #9663 (comment), the native J9VMInternals.getStackTrace(this, true) returned non-null value when the NPE was thrown.\nSubmitting this PR since it is good thing to do. Will continue the investigation how a null value was returned from getInternalStackTrace().\nrelated #9663\nSigned-off-by: Jason Feng fengj@ca.ibm.com", "createdAt": "2020-06-17T20:53:36Z", "url": "https://github.com/eclipse-openj9/openj9/pull/9918", "merged": true, "mergeCommit": {"oid": "79566c78790af7e391524b4cf33fcafcec22dccf"}, "closed": true, "closedAt": "2020-06-18T12:49:45Z", "author": {"login": "JasonFengJ9"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsTwlmgFqTQzMjg3MTQ0OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsUnI0ABqjM0NTYwMzIyMzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODcxNDQ4", "url": "https://github.com/eclipse-openj9/openj9/pull/9918#pullrequestreview-432871448", "createdAt": "2020-06-18T01:00:00Z", "commit": {"oid": "44a9dfeed41e0dd4cc6d72989c98a92640def313"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMTowMDowMVrOGlcHsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMTowMDowMVrOGlcHsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkxMTIxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t// Assign the result to a local variable to avoid race condition\n          \n          \n            \n            \t\t// that stackTrace might be set back to null.\n          \n          \n            \n            \t\t// Assign the result to a local variable to avoid refetching\n          \n          \n            \n            \t\t// the instance variable and any memory ordering issues", "url": "https://github.com/eclipse-openj9/openj9/pull/9918#discussion_r441911218", "createdAt": "2020-06-18T01:00:01Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/Throwable.java", "diffHunk": "@@ -283,16 +283,19 @@ private static int countDuplicates(StackTraceElement[] currentStack, StackTraceE\n  * @return an array of StackTraceElement representing the stack\n  */\n StackTraceElement[] getInternalStackTrace() {\n-\n \tif (disableWritableStackTrace) {\n \t\treturn\tZeroStackTraceElementArray;\n \t}\n \n-\tif (stackTrace == null) {\n-\t\tstackTrace = J9VMInternals.getStackTrace(this, true);\n+\tStackTraceElement[] localstackTrace = stackTrace;\n+\tif (localstackTrace == null) {\n+\t\t// Assign the result to a local variable to avoid race condition\n+\t\t// that stackTrace might be set back to null.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44a9dfeed41e0dd4cc6d72989c98a92640def313"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODcyMTY0", "url": "https://github.com/eclipse-openj9/openj9/pull/9918#pullrequestreview-432872164", "createdAt": "2020-06-18T01:02:14Z", "commit": {"oid": "44a9dfeed41e0dd4cc6d72989c98a92640def313"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44a9dfeed41e0dd4cc6d72989c98a92640def313", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/44a9dfeed41e0dd4cc6d72989c98a92640def313", "committedDate": "2020-06-17T20:45:13Z", "message": "Assign getStackTrace result to a local variable to avoid race condition\n\nAssigned J9VMInternals.getStackTrace(this, true) result to a local\nvariable to avoid a race condition that a null value could be set back\nto stackTrace and returned to the caller.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}, "afterCommit": {"oid": "182adb12d1dafdf5422ee3b66206fd2d1dc8d0ce", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/182adb12d1dafdf5422ee3b66206fd2d1dc8d0ce", "committedDate": "2020-06-18T01:33:34Z", "message": "Assign getStackTrace result to a local variable to avoid refectching\n\nAssigned J9VMInternals.getStackTrace(this, true) result to a local\nvariable to avoid refetching the instance variable and any memory\nordering issues.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6e88704d4b551793c7cf7bf8f3348e628a48264", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e6e88704d4b551793c7cf7bf8f3348e628a48264", "committedDate": "2020-06-18T01:59:01Z", "message": "Assign getStackTrace result to a local variable to avoid refetching\n\nAssigned J9VMInternals.getStackTrace(this, true) result to a local\nvariable to avoid refetching the instance variable and any memory\nordering issues.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "182adb12d1dafdf5422ee3b66206fd2d1dc8d0ce", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/182adb12d1dafdf5422ee3b66206fd2d1dc8d0ce", "committedDate": "2020-06-18T01:33:34Z", "message": "Assign getStackTrace result to a local variable to avoid refectching\n\nAssigned J9VMInternals.getStackTrace(this, true) result to a local\nvariable to avoid refetching the instance variable and any memory\nordering issues.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}, "afterCommit": {"oid": "e6e88704d4b551793c7cf7bf8f3348e628a48264", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e6e88704d4b551793c7cf7bf8f3348e628a48264", "committedDate": "2020-06-18T01:59:01Z", "message": "Assign getStackTrace result to a local variable to avoid refetching\n\nAssigned J9VMInternals.getStackTrace(this, true) result to a local\nvariable to avoid refetching the instance variable and any memory\nordering issues.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 716, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}