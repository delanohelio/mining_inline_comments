{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDA2NjU3", "number": 8780, "title": "Transform indexOf call node when receiver is known string", "bodyText": "Based on my benchmarking, this optimization caused a 10-20% increase in performance on power, a 40-50% increase on Z, and a 30-40% increase on x when measured against the following bumblebench benchmark:\nimport net.adoptopenjdk.bumblebench.core.MicroBench;\npublic final class URIParseIntenseBench extends MicroBench {\n        public volatile String  uri = \"http://192.168.90.176:8080/ping/simple\";\n        //public volatile String  uri = \"http://jones@example.com:98?name=Fred#1\";\n        public static java.net.URI uriResult = null;\n        protected long doBatch(long numIterations) throws InterruptedException {\n                long i = 0;\n                try {\n                        for (i = 0; i < numIterations; ++i) {\n                                uriResult = new java.net.URI(uri);\n                        }\n                } catch (Exception e) {\n                        throw new AssertionError(\"Unexpected exception \" + e.toString());\n                }\n                return i;\n        }\n}\nThis PR in omr will further simplify the trees generated by this transformation:\neclipse/omr#4904\nThe above omr PR should be merged first so that the transformations done in this code can have the most benefit.\n\n\nAdd new method J9::ValuePropagation::transformIndexOfKnownString which\nchecks if the receiver has a KnownObject or ConstString constraint.\nIf so, the call node is replaced by an equivalent constant, icmpeq, or iselect\nnode or tree of nodes.\n\n\nAdd indexOf(I)I as a recognized method so that the above transformations can\nbe applied to it.\n\n\nThese changes were originally authored by Andrew Craik who is listed as a\nco-author below.\nCo-authored-by: Andrew Craik ajcraik@ca.ibm.com\nSigned-off-by: Ryan Shukla ryans@ibm.com", "createdAt": "2020-03-06T20:25:46Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8780", "merged": true, "mergeCommit": {"oid": "5b74354ac99af5bd650a153fe20910215c764cbe"}, "closed": true, "closedAt": "2020-04-30T12:34:37Z", "author": {"login": "rpshukla"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOOVHAgBqjMxMzMyNDQzNTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccsRFrgFqTQwMzQ3MjMwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94c32857b410b67039d77f3dcfec11a6a0552c16", "author": {"user": {"login": "rpshukla", "name": "May Shukla"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/94c32857b410b67039d77f3dcfec11a6a0552c16", "committedDate": "2020-03-06T20:10:54Z", "message": "Transform indexOf call node when receiver is known string\n\n- Add new method `J9::ValuePropagation::transformIndexOfKnownString` which\n  checks if the receiver has a KnownObject or ConstString constraint.\n  If so, the call node is replaced by an equivalent constant, icmpeq, or iselect\n  node or tree of nodes.\n\n- Add indexOf(I)I as a recognized method so that the above transformations can\n  be applied to it.\n\nThese changes were originally authored by Andrew Craik who is listed as a\nco-author below.\n\nCo-authored-by: Andrew Craik <ajcraik@ca.ibm.com>\n\nSigned-off-by: Ryan Shukla <ryans@ibm.com>"}, "afterCommit": {"oid": "8b8aab7f5aaeaedeab5aa959f4420c150043bcdc", "author": {"user": {"login": "rpshukla", "name": "May Shukla"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8b8aab7f5aaeaedeab5aa959f4420c150043bcdc", "committedDate": "2020-03-16T13:42:32Z", "message": "Transform indexOf call node when receiver is known string\n\n- Add new method `J9::ValuePropagation::transformIndexOfKnownString` which\n  checks if the receiver has a KnownObject or ConstString constraint.\n  If so, the call node is replaced by an equivalent constant, icmpeq, or iselect\n  node or tree of nodes.\n\n- Add indexOf(I)I as a recognized method so that the above transformations can\n  be applied to it.\n\nThese changes were originally authored by Andrew Craik who is listed as a\nco-author below.\n\nCo-authored-by: Andrew Craik <ajcraik@ca.ibm.com>\n\nSigned-off-by: Ryan Shukla <ryans@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzI2ODM5", "url": "https://github.com/eclipse-openj9/openj9/pull/8780#pullrequestreview-397726839", "createdAt": "2020-04-21T22:43:16Z", "commit": {"oid": "8b8aab7f5aaeaedeab5aa959f4420c150043bcdc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo0MzoxNlrOGJbiBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo0MzoxNlrOGJbiBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0MTQ0NA==", "bodyText": "Can we get here since we are presumably dealing with a char ? If so, maybe targetChar should be declared as 32-bit ?", "url": "https://github.com/eclipse-openj9/openj9/pull/8780#discussion_r412541444", "createdAt": "2020-04-21T22:43:16Z", "author": {"login": "vijaysun-omr"}, "path": "runtime/compiler/optimizer/J9ValuePropagation.cpp", "diffHunk": "@@ -250,6 +261,228 @@ J9::ValuePropagation::isKnownStringObject(TR::VPConstraint *constraint)\n           && (constraint->isConstString() || constraint->getKnownObject());\n    }\n \n+bool J9::ValuePropagation::transformIndexOfKnownString(\n+   TR::Node *indexOfNode,\n+   TR::Node *sourceStringNode,\n+   TR::Node *targetCharNode,\n+   TR::Node *startNode,\n+   TR::Node *lengthNode,\n+   bool is16Bit)\n+   {\n+   // Keep track of whether or not all constraints are global.\n+   bool isGlobal = true;\n+   bool isGlobalQuery;\n+\n+   TR::VPConstraint *sourceConstraint = getConstraint(sourceStringNode, isGlobalQuery);\n+   isGlobal &= isGlobalQuery;\n+   if (!sourceConstraint)\n+      return false;\n+   TR::VPKnownObject *knownObject = sourceConstraint->getKnownObject();\n+   // The source string must either be a KnownObject or a ConstString.\n+   // Otherwise, do not attempt transformations.\n+   if (!knownObject && !sourceConstraint->isConstString())\n+      return false;\n+   TR::KnownObjectTable *knot;\n+   if (knownObject)\n+      {\n+      knot = comp()->getOrCreateKnownObjectTable();\n+      if (!knot)\n+         return false;\n+      TR_OpaqueClassBlock *klazz = knownObject->getClass();\n+      if (!comp()->fej9()->isPrimitiveArray(klazz))\n+         return false;\n+      }\n+\n+   TR::VPConstraint *targetConstraint = getConstraint(targetCharNode, isGlobal) ;\n+   bool targetIsConstChar = false;\n+   uint16_t targetChar = -1;\n+   if (!targetConstraint)\n+      {\n+      targetIsConstChar = false;\n+      }\n+   else if (targetConstraint->asIntConst())\n+      {\n+      targetIsConstChar = true;\n+      targetChar = targetConstraint->asIntConst()->getInt();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b8aab7f5aaeaedeab5aa959f4420c150043bcdc"}, "originalPosition": 113}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6589fcd2b8a576d48b602961b0ce7f3b4b13f2a6", "author": {"user": {"login": "rpshukla", "name": "May Shukla"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/6589fcd2b8a576d48b602961b0ce7f3b4b13f2a6", "committedDate": "2020-04-23T14:01:34Z", "message": "Transform indexOf call node when receiver is known string\n\n- Add new method `J9::ValuePropagation::transformIndexOfKnownString` which\n  checks if the receiver has a KnownObject or ConstString constraint.\n  If so, the call node is replaced by an equivalent constant, icmpeq, or iselect\n  node or tree of nodes.\n\n- Add indexOf(I)I as a recognized method so that the above transformations can\n  be applied to it.\n\nThese changes were originally authored by Andrew Craik who is listed as a\nco-author below.\n\nCo-authored-by: Andrew Craik <ajcraik@ca.ibm.com>\n\nSigned-off-by: Ryan Shukla <ryans@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b8aab7f5aaeaedeab5aa959f4420c150043bcdc", "author": {"user": {"login": "rpshukla", "name": "May Shukla"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8b8aab7f5aaeaedeab5aa959f4420c150043bcdc", "committedDate": "2020-03-16T13:42:32Z", "message": "Transform indexOf call node when receiver is known string\n\n- Add new method `J9::ValuePropagation::transformIndexOfKnownString` which\n  checks if the receiver has a KnownObject or ConstString constraint.\n  If so, the call node is replaced by an equivalent constant, icmpeq, or iselect\n  node or tree of nodes.\n\n- Add indexOf(I)I as a recognized method so that the above transformations can\n  be applied to it.\n\nThese changes were originally authored by Andrew Craik who is listed as a\nco-author below.\n\nCo-authored-by: Andrew Craik <ajcraik@ca.ibm.com>\n\nSigned-off-by: Ryan Shukla <ryans@ibm.com>"}, "afterCommit": {"oid": "6589fcd2b8a576d48b602961b0ce7f3b4b13f2a6", "author": {"user": {"login": "rpshukla", "name": "May Shukla"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/6589fcd2b8a576d48b602961b0ce7f3b4b13f2a6", "committedDate": "2020-04-23T14:01:34Z", "message": "Transform indexOf call node when receiver is known string\n\n- Add new method `J9::ValuePropagation::transformIndexOfKnownString` which\n  checks if the receiver has a KnownObject or ConstString constraint.\n  If so, the call node is replaced by an equivalent constant, icmpeq, or iselect\n  node or tree of nodes.\n\n- Add indexOf(I)I as a recognized method so that the above transformations can\n  be applied to it.\n\nThese changes were originally authored by Andrew Craik who is listed as a\nco-author below.\n\nCo-authored-by: Andrew Craik <ajcraik@ca.ibm.com>\n\nSigned-off-by: Ryan Shukla <ryans@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNDcyMzAz", "url": "https://github.com/eclipse-openj9/openj9/pull/8780#pullrequestreview-403472303", "createdAt": "2020-04-30T12:30:27Z", "commit": {"oid": "6589fcd2b8a576d48b602961b0ce7f3b4b13f2a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 414, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}