{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNjg1ODc0", "number": 10893, "reviewThreads": {"totalCount": 51, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDoxMzo1OVrOE1YYtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTowMToxMFrOE4TgSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDA5NTI1OnYy", "diffSide": "RIGHT", "path": "runtime/bcutil/ConstantPoolMap.hpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDoxMzo1OVrOHtoFPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjo1Mzo1MlrOHuZzLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwNDY2OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _invokeCacheCount++;\n          \n          \n            \n            \tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _invokeCacheCount++; }", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517604668", "createdAt": "2020-11-04T20:13:59Z", "author": {"login": "babsingh"}, "path": "runtime/bcutil/ConstantPoolMap.hpp", "diffHunk": "@@ -287,8 +291,14 @@ class ConstantPoolMap\n \tvoid markMethodRefAsUsedByInvokeSpecial(U_16 methodRefCfrCPIndex)       { mark(methodRefCfrCPIndex, INVOKE_SPECIAL); }\n \tvoid markMethodRefAsUsedByInvokeStatic(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_STATIC); }\n \tvoid markMethodRefAsUsedByInvokeInterface(U_16 methodRefCfrCPIndex)     { mark(methodRefCfrCPIndex, INVOKE_INTERFACE); }\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); _invokeCacheCount++; }\n+\tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _invokeCacheCount++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQxOTI0Ng==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518419246", "createdAt": "2020-11-05T22:53:52Z", "author": {"login": "fengxue-IS"}, "path": "runtime/bcutil/ConstantPoolMap.hpp", "diffHunk": "@@ -287,8 +291,14 @@ class ConstantPoolMap\n \tvoid markMethodRefAsUsedByInvokeSpecial(U_16 methodRefCfrCPIndex)       { mark(methodRefCfrCPIndex, INVOKE_SPECIAL); }\n \tvoid markMethodRefAsUsedByInvokeStatic(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_STATIC); }\n \tvoid markMethodRefAsUsedByInvokeInterface(U_16 methodRefCfrCPIndex)     { mark(methodRefCfrCPIndex, INVOKE_INTERFACE); }\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); _invokeCacheCount++; }\n+\tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _invokeCacheCount++;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwNDY2OA=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDEyMTkxOnYy", "diffSide": "RIGHT", "path": "runtime/bcutil/ConstantPoolMap.hpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDoyMjoxMFrOHtoVkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjowNjozMFrOHuYicQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwODg1MA==", "bodyText": "Should it be an #elif instead of an #else in case both opt_openjdkMethodhandle and opt_methodHandle flags are disabled? Reference to the coding standard. If this change is accepted, then it should be applied to all ifdefs.\n#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n...\n#elif defined(J9VM_OPT_METHOD_HANDLE) /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n...\n#else /* defined(J9VM_OPT_METHOD_HANDLE) */\n    /* JSR292 completely disabled. */\n    ASSERT if possible since this code shouldn't be executed when the flags are disabled;\n#endif /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517608850", "createdAt": "2020-11-04T20:22:10Z", "author": {"login": "babsingh"}, "path": "runtime/bcutil/ConstantPoolMap.hpp", "diffHunk": "@@ -287,8 +291,14 @@ class ConstantPoolMap\n \tvoid markMethodRefAsUsedByInvokeSpecial(U_16 methodRefCfrCPIndex)       { mark(methodRefCfrCPIndex, INVOKE_SPECIAL); }\n \tvoid markMethodRefAsUsedByInvokeStatic(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_STATIC); }\n \tvoid markMethodRefAsUsedByInvokeInterface(U_16 methodRefCfrCPIndex)     { mark(methodRefCfrCPIndex, INVOKE_INTERFACE); }\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); _invokeCacheCount++; }\n+\tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _invokeCacheCount++;\n+#else /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM5ODU3Nw==", "bodyText": "The original code isn't ifdef-ed under any tag, so I considered the code as default.\nThe J9VM_OPT_METHOD_HANDLE flag is not very consistent through the vm code, I think this is mostly due to method handle need to be supported by default since Java7/8", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518398577", "createdAt": "2020-11-05T22:06:30Z", "author": {"login": "fengxue-IS"}, "path": "runtime/bcutil/ConstantPoolMap.hpp", "diffHunk": "@@ -287,8 +291,14 @@ class ConstantPoolMap\n \tvoid markMethodRefAsUsedByInvokeSpecial(U_16 methodRefCfrCPIndex)       { mark(methodRefCfrCPIndex, INVOKE_SPECIAL); }\n \tvoid markMethodRefAsUsedByInvokeStatic(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_STATIC); }\n \tvoid markMethodRefAsUsedByInvokeInterface(U_16 methodRefCfrCPIndex)     { mark(methodRefCfrCPIndex, INVOKE_INTERFACE); }\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); _invokeCacheCount++; }\n+\tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _invokeCacheCount++;\n+#else /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwODg1MA=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDE0MjE5OnYy", "diffSide": "RIGHT", "path": "runtime/codert_vm/cnathelp.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDoyODowMFrOHtoh2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjo1NDowMVrOHuZzXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxMTk5NA==", "bodyText": "Correct the formatting for the multi-line comment, and add missing full-stops. Reference to the coding standard.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517611994", "createdAt": "2020-11-04T20:28:00Z", "author": {"login": "babsingh"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -2325,6 +2325,25 @@ old_slow_jitResolveHandleMethod(J9VMThread *currentThread)\n \tDECLARE_JIT_PARM(void*, jitEIP, 3);\n \tvoid *addr = NULL;\n \tJ9JavaVM *vm = currentThread->javaVM;\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tJ9RAMMethodRef *ramMethodRef = ((J9RAMMethodRef*)ramConstantPool) + cpIndex;\n+\tUDATA invokeCacheIndex = ramMethodRef->methodIndexAndArgCount >> 8;\n+retry:\n+\tj9object_t invokeCacheArray = (J9_CLASS_FROM_CP(ramConstantPool)->invokeCache)[invokeCacheIndex];\n+\tif (NULL == invokeCacheArray) {\n+\t\tbuildJITResolveFrameWithPC(currentThread, J9_SSF_JIT_RESOLVE_DATA, parmCount, true, 0, jitEIP);\n+\t\t// add new resolve code which calls sendResolveInvokeHandle -> MHN.linkMethod()\n+\t\t// store the memberName/appendix values in invokeCache[invokeCacheIndex]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQxOTI5NA==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518419294", "createdAt": "2020-11-05T22:54:01Z", "author": {"login": "fengxue-IS"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -2325,6 +2325,25 @@ old_slow_jitResolveHandleMethod(J9VMThread *currentThread)\n \tDECLARE_JIT_PARM(void*, jitEIP, 3);\n \tvoid *addr = NULL;\n \tJ9JavaVM *vm = currentThread->javaVM;\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tJ9RAMMethodRef *ramMethodRef = ((J9RAMMethodRef*)ramConstantPool) + cpIndex;\n+\tUDATA invokeCacheIndex = ramMethodRef->methodIndexAndArgCount >> 8;\n+retry:\n+\tj9object_t invokeCacheArray = (J9_CLASS_FROM_CP(ramConstantPool)->invokeCache)[invokeCacheIndex];\n+\tif (NULL == invokeCacheArray) {\n+\t\tbuildJITResolveFrameWithPC(currentThread, J9_SSF_JIT_RESOLVE_DATA, parmCount, true, 0, jitEIP);\n+\t\t// add new resolve code which calls sendResolveInvokeHandle -> MHN.linkMethod()\n+\t\t// store the memberName/appendix values in invokeCache[invokeCacheIndex]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxMTk5NA=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDE0NTIxOnYy", "diffSide": "RIGHT", "path": "runtime/codert_vm/cnathelp.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDoyOTowMFrOHtoj3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjoxNzozMlrOHu0dzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxMjUxMA==", "bodyText": "Is there an extra pair of unneeded brackets?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tJ9RAMMethodRef *ramMethodRef = ((J9RAMMethodRef*)ramConstantPool) + cpIndex;\n          \n          \n            \n            \tJ9RAMMethodRef *ramMethodRef = (J9RAMMethodRef*)ramConstantPool + cpIndex;", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517612510", "createdAt": "2020-11-04T20:29:00Z", "author": {"login": "babsingh"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -2325,6 +2325,25 @@ old_slow_jitResolveHandleMethod(J9VMThread *currentThread)\n \tDECLARE_JIT_PARM(void*, jitEIP, 3);\n \tvoid *addr = NULL;\n \tJ9JavaVM *vm = currentThread->javaVM;\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tJ9RAMMethodRef *ramMethodRef = ((J9RAMMethodRef*)ramConstantPool) + cpIndex;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg1NjE0Mw==", "bodyText": "The extra brackets remove any ambiguity from the order of operations.  It's clear that the + is pointer arithmetic on J9RAMMethodRef*.  Otherwise you need to know which order of operations occurs first:  casting vs addition\nMy vote is keep them", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518856143", "createdAt": "2020-11-06T16:17:32Z", "author": {"login": "DanHeidinga"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -2325,6 +2325,25 @@ old_slow_jitResolveHandleMethod(J9VMThread *currentThread)\n \tDECLARE_JIT_PARM(void*, jitEIP, 3);\n \tvoid *addr = NULL;\n \tJ9JavaVM *vm = currentThread->javaVM;\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tJ9RAMMethodRef *ramMethodRef = ((J9RAMMethodRef*)ramConstantPool) + cpIndex;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxMjUxMA=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDE3MDY5OnYy", "diffSide": "RIGHT", "path": "runtime/vm/BytecodeInterpreter.hpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDozNjoxOVrOHtozGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjo1NDoxNFrOHuZzwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNjQxMQ==", "bodyText": "Avoid nested calls.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (J9CLASS_IS_ARRAY(J9OBJECT_CLAZZ(_currentThread, invokeCacheArray))) {\n          \n          \n            \n            \t\t\tJ9Class *clazz = J9OBJECT_CLAZZ(_currentThread, invokeCacheArray);\n          \n          \n            \n            \t\t\tif (J9CLASS_IS_ARRAY(clazz)) {", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517616411", "createdAt": "2020-11-04T20:36:19Z", "author": {"login": "babsingh"}, "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -8017,23 +8017,22 @@ class INTERPRETER_CLASS\n \t\tU_16 index = *(U_16 *)(_pc + 1);\n \n \t\tJ9ConstantPool *ramConstantPool = J9_CP_FROM_METHOD(_literals);\n-\t\tJ9InvokeCacheEntry *invokeCache = ((J9InvokeCacheEntry *)ramConstantPool->ramClass->callSites) + index;\n+\t\tj9object_t invokeCacheArray = (ramConstantPool->ramClass->callSites)[index];\n \n-\t\tj9object_t memberName = invokeCache->target;\n-\n-\t\tif (J9_EXPECTED(NULL != memberName)) {\n-\t\t\tif (J9OBJECT_CLAZZ(_currentThread, memberName) == J9VMJAVALANGINVOKEMEMBERNAME_OR_NULL(_vm)) {\n+\t\tif (J9_EXPECTED(NULL != invokeCacheArray)) {\n+\t\t\tif (J9CLASS_IS_ARRAY(J9OBJECT_CLAZZ(_currentThread, invokeCacheArray))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQxOTM5Mw==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518419393", "createdAt": "2020-11-05T22:54:14Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -8017,23 +8017,22 @@ class INTERPRETER_CLASS\n \t\tU_16 index = *(U_16 *)(_pc + 1);\n \n \t\tJ9ConstantPool *ramConstantPool = J9_CP_FROM_METHOD(_literals);\n-\t\tJ9InvokeCacheEntry *invokeCache = ((J9InvokeCacheEntry *)ramConstantPool->ramClass->callSites) + index;\n+\t\tj9object_t invokeCacheArray = (ramConstantPool->ramClass->callSites)[index];\n \n-\t\tj9object_t memberName = invokeCache->target;\n-\n-\t\tif (J9_EXPECTED(NULL != memberName)) {\n-\t\t\tif (J9OBJECT_CLAZZ(_currentThread, memberName) == J9VMJAVALANGINVOKEMEMBERNAME_OR_NULL(_vm)) {\n+\t\tif (J9_EXPECTED(NULL != invokeCacheArray)) {\n+\t\t\tif (J9CLASS_IS_ARRAY(J9OBJECT_CLAZZ(_currentThread, invokeCacheArray))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNjQxMQ=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDE3NjIxOnYy", "diffSide": "RIGHT", "path": "runtime/vm/callin.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDozODoxNVrOHto2kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDozODoxNVrOHto2kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNzI5Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            sendResolveOpenJDKInvokeHandle(J9VMThread *currentThread, J9ConstantPool *ramCP, UDATA cpIndex, I_32 refKind, J9Class *resolvedClass, J9ROMNameAndSignature* nameAndSig)\n          \n          \n            \n            sendResolveOpenJDKInvokeHandle(J9VMThread *currentThread, J9ConstantPool *ramCP, UDATA cpIndex, I_32 refKind, J9Class *resolvedClass, J9ROMNameAndSignature *nameAndSig)", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517617297", "createdAt": "2020-11-04T20:38:15Z", "author": {"login": "babsingh"}, "path": "runtime/vm/callin.cpp", "diffHunk": "@@ -942,6 +942,43 @@ sendForGenericInvoke(J9VMThread *currentThread, j9object_t methodHandle, j9objec\n \tTrc_VM_sendForGenericInvoke_Exit(currentThread);\n }\n \n+void JNICALL\n+sendResolveOpenJDKInvokeHandle(J9VMThread *currentThread, J9ConstantPool *ramCP, UDATA cpIndex, I_32 refKind, J9Class *resolvedClass, J9ROMNameAndSignature* nameAndSig)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDE3NjU5OnYy", "diffSide": "RIGHT", "path": "runtime/vm/callin.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDozODoyN1rOHto24A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjoxMDoxNFrOHuYo-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNzM3Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t/* Convert name and signature to String objects */\n          \n          \n            \n            \t\t/* Convert name and signature to String objects. */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517617376", "createdAt": "2020-11-04T20:38:27Z", "author": {"login": "babsingh"}, "path": "runtime/vm/callin.cpp", "diffHunk": "@@ -942,6 +942,43 @@ sendForGenericInvoke(J9VMThread *currentThread, j9object_t methodHandle, j9objec\n \tTrc_VM_sendForGenericInvoke_Exit(currentThread);\n }\n \n+void JNICALL\n+sendResolveOpenJDKInvokeHandle(J9VMThread *currentThread, J9ConstantPool *ramCP, UDATA cpIndex, I_32 refKind, J9Class *resolvedClass, J9ROMNameAndSignature* nameAndSig)\n+{\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tTrc_VM_sendResolveOpenJDKInvokeHandle_Entry(currentThread);\n+\tJ9VMEntryLocalStorage newELS;\n+\tif (buildCallInStackFrame(currentThread, &newELS, true, false)) {\n+\t\t/* Convert name and signature to String objects */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQwMDI1MQ==", "bodyText": "keeping existing format for consistency within the file", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518400251", "createdAt": "2020-11-05T22:10:14Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/callin.cpp", "diffHunk": "@@ -942,6 +942,43 @@ sendForGenericInvoke(J9VMThread *currentThread, j9object_t methodHandle, j9objec\n \tTrc_VM_sendForGenericInvoke_Exit(currentThread);\n }\n \n+void JNICALL\n+sendResolveOpenJDKInvokeHandle(J9VMThread *currentThread, J9ConstantPool *ramCP, UDATA cpIndex, I_32 refKind, J9Class *resolvedClass, J9ROMNameAndSignature* nameAndSig)\n+{\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tTrc_VM_sendResolveOpenJDKInvokeHandle_Entry(currentThread);\n+\tJ9VMEntryLocalStorage newELS;\n+\tif (buildCallInStackFrame(currentThread, &newELS, true, false)) {\n+\t\t/* Convert name and signature to String objects */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNzM3Ng=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDE3NzQ5OnYy", "diffSide": "RIGHT", "path": "runtime/vm/callin.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDozODo0NlrOHto3dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjoxMDoyNVrOHuYpbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNzUyNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t/* Run the method */\n          \n          \n            \n            \t\t\t\t/* Run the method. */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517617525", "createdAt": "2020-11-04T20:38:46Z", "author": {"login": "babsingh"}, "path": "runtime/vm/callin.cpp", "diffHunk": "@@ -942,6 +942,43 @@ sendForGenericInvoke(J9VMThread *currentThread, j9object_t methodHandle, j9objec\n \tTrc_VM_sendForGenericInvoke_Exit(currentThread);\n }\n \n+void JNICALL\n+sendResolveOpenJDKInvokeHandle(J9VMThread *currentThread, J9ConstantPool *ramCP, UDATA cpIndex, I_32 refKind, J9Class *resolvedClass, J9ROMNameAndSignature* nameAndSig)\n+{\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tTrc_VM_sendResolveOpenJDKInvokeHandle_Entry(currentThread);\n+\tJ9VMEntryLocalStorage newELS;\n+\tif (buildCallInStackFrame(currentThread, &newELS, true, false)) {\n+\t\t/* Convert name and signature to String objects */\n+\t\tJ9JavaVM *vm = currentThread->javaVM;\n+\t\tJ9MemoryManagerFunctions const * const mmFuncs = vm->memoryManagerFunctions;\n+\t\tJ9UTF8 *nameUTF = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);\n+\t\tj9object_t nameString = mmFuncs->j9gc_createJavaLangString(currentThread, J9UTF8_DATA(nameUTF), J9UTF8_LENGTH(nameUTF), 0);\n+\t\tif (NULL != nameString) {\n+\t\t\tJ9UTF8 *sigUTF = J9ROMNAMEANDSIGNATURE_SIGNATURE(nameAndSig);\n+\t\t\tPUSH_OBJECT_IN_SPECIAL_FRAME(currentThread, nameString);\n+\t\t\tj9object_t sigString = mmFuncs->j9gc_createJavaLangString(currentThread, J9UTF8_DATA(sigUTF), J9UTF8_LENGTH(sigUTF), 0);\n+\t\t\tnameString = POP_OBJECT_IN_SPECIAL_FRAME(currentThread);\n+\t\t\tif (NULL != sigString) {\n+\t\t\t\t/* Run the method */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQwMDM2NA==", "bodyText": "keeping existing format for consistency within the file", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518400364", "createdAt": "2020-11-05T22:10:25Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/callin.cpp", "diffHunk": "@@ -942,6 +942,43 @@ sendForGenericInvoke(J9VMThread *currentThread, j9object_t methodHandle, j9objec\n \tTrc_VM_sendForGenericInvoke_Exit(currentThread);\n }\n \n+void JNICALL\n+sendResolveOpenJDKInvokeHandle(J9VMThread *currentThread, J9ConstantPool *ramCP, UDATA cpIndex, I_32 refKind, J9Class *resolvedClass, J9ROMNameAndSignature* nameAndSig)\n+{\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tTrc_VM_sendResolveOpenJDKInvokeHandle_Entry(currentThread);\n+\tJ9VMEntryLocalStorage newELS;\n+\tif (buildCallInStackFrame(currentThread, &newELS, true, false)) {\n+\t\t/* Convert name and signature to String objects */\n+\t\tJ9JavaVM *vm = currentThread->javaVM;\n+\t\tJ9MemoryManagerFunctions const * const mmFuncs = vm->memoryManagerFunctions;\n+\t\tJ9UTF8 *nameUTF = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);\n+\t\tj9object_t nameString = mmFuncs->j9gc_createJavaLangString(currentThread, J9UTF8_DATA(nameUTF), J9UTF8_LENGTH(nameUTF), 0);\n+\t\tif (NULL != nameString) {\n+\t\t\tJ9UTF8 *sigUTF = J9ROMNAMEANDSIGNATURE_SIGNATURE(nameAndSig);\n+\t\t\tPUSH_OBJECT_IN_SPECIAL_FRAME(currentThread, nameString);\n+\t\t\tj9object_t sigString = mmFuncs->j9gc_createJavaLangString(currentThread, J9UTF8_DATA(sigUTF), J9UTF8_LENGTH(sigUTF), 0);\n+\t\t\tnameString = POP_OBJECT_IN_SPECIAL_FRAME(currentThread);\n+\t\t\tif (NULL != sigString) {\n+\t\t\t\t/* Run the method */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNzUyNQ=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDE4NDYxOnYy", "diffSide": "RIGHT", "path": "runtime/vm/j9vm.tdf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo0MTowMFrOHto74A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjo1NDozN1rOHuZ0Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxODY1Ng==", "bodyText": "If I recollect correctly, new tracepoints should always be added to the end of file.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517618656", "createdAt": "2020-11-04T20:41:00Z", "author": {"login": "babsingh"}, "path": "runtime/vm/j9vm.tdf", "diffHunk": "@@ -222,6 +222,13 @@ TraceExit=Trc_VM_resolveStaticFieldRef_Exit Overhead=1 Level=3 Template=\"resolve\n TraceEntry=Trc_VM_resolveInstanceFieldRef_Entry_old Obsolete Overhead=1 Level=3 Template=\"resolveInstanceFieldRef(ramCP=%p, cpIndex=%zu, flags=%zx, returnAddress=%p)\"\n TraceExit=Trc_VM_resolveInstanceFieldRef_Exit Overhead=1 Level=3 Template=\"resolveInstanceFieldRef --> result=%d\"\n \n+TraceEntry=Trc_VM_resolveInvokeHandle_Entry Overhead=1 Level=3 Template=\"resolveInvokeHandle(ramCP=%p, cpIndex=%zu, flags=%zx)\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQxOTU1OA==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518419558", "createdAt": "2020-11-05T22:54:37Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/j9vm.tdf", "diffHunk": "@@ -222,6 +222,13 @@ TraceExit=Trc_VM_resolveStaticFieldRef_Exit Overhead=1 Level=3 Template=\"resolve\n TraceEntry=Trc_VM_resolveInstanceFieldRef_Entry_old Obsolete Overhead=1 Level=3 Template=\"resolveInstanceFieldRef(ramCP=%p, cpIndex=%zu, flags=%zx, returnAddress=%p)\"\n TraceExit=Trc_VM_resolveInstanceFieldRef_Exit Overhead=1 Level=3 Template=\"resolveInstanceFieldRef --> result=%d\"\n \n+TraceEntry=Trc_VM_resolveInvokeHandle_Entry Overhead=1 Level=3 Template=\"resolveInvokeHandle(ramCP=%p, cpIndex=%zu, flags=%zx)\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxODY1Ng=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDE4NTkyOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo0MToyN1rOHto8ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo0MToyN1rOHto8ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxODg1MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            isMethodHandleINL(U_8* methodName, U_16 methodNameLength)\n          \n          \n            \n            isMethodHandleINL(U_8 *methodName, U_16 methodNameLength)", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517618851", "createdAt": "2020-11-04T20:41:27Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -116,6 +116,40 @@ checkForDecompile(J9VMThread *currentThread, J9ROMMethodRef *romMethodRef, bool\n \t}\n }\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+static BOOLEAN\n+isMethodHandleINL(U_8* methodName, U_16 methodNameLength)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDE4OTUxOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo0MjozMVrOHto-rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjo1MzoxM1rOHuZyRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTM3Mw==", "bodyText": "missing default. Coding standard: Switch statements should always include a default:.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517619373", "createdAt": "2020-11-04T20:42:31Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -116,6 +116,40 @@ checkForDecompile(J9VMThread *currentThread, J9ROMMethodRef *romMethodRef, bool\n \t}\n }\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+static BOOLEAN\n+isMethodHandleINL(U_8* methodName, U_16 methodNameLength)\n+{\n+\tBOOLEAN isMethodHandle = FALSE;\n+\n+\tswitch (methodNameLength) {\n+\tcase 11:\n+\t\tif (J9UTF8_LITERAL_EQUALS(methodName, methodNameLength, \"invokeBasic\")) {\n+\t\t\tisMethodHandle = TRUE;\n+\t\t}\n+\t\tbreak;\n+\tcase 12:\n+\t\tif (J9UTF8_LITERAL_EQUALS(methodName, methodNameLength, \"linkToStatic\")) {\n+\t\t\tisMethodHandle = TRUE;\n+\t\t}\n+\t\tbreak;\n+\tcase 13:\n+\t\tif (J9UTF8_LITERAL_EQUALS(methodName, methodNameLength, \"linkToSpecial\")\n+\t\t||  J9UTF8_LITERAL_EQUALS(methodName, methodNameLength, \"linkToVirtual\")) {\n+\t\t\tisMethodHandle = TRUE;\n+\t\t}\n+\t\tbreak;\n+\tcase 15:\n+\t\tif (J9UTF8_LITERAL_EQUALS(methodName, methodNameLength, \"linkToInterface\")) {\n+\t\t\tisMethodHandle = TRUE;\n+\t\t}\n+\t\tbreak;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQxOTAxMw==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518419013", "createdAt": "2020-11-05T22:53:13Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -116,6 +116,40 @@ checkForDecompile(J9VMThread *currentThread, J9ROMMethodRef *romMethodRef, bool\n \t}\n }\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+static BOOLEAN\n+isMethodHandleINL(U_8* methodName, U_16 methodNameLength)\n+{\n+\tBOOLEAN isMethodHandle = FALSE;\n+\n+\tswitch (methodNameLength) {\n+\tcase 11:\n+\t\tif (J9UTF8_LITERAL_EQUALS(methodName, methodNameLength, \"invokeBasic\")) {\n+\t\t\tisMethodHandle = TRUE;\n+\t\t}\n+\t\tbreak;\n+\tcase 12:\n+\t\tif (J9UTF8_LITERAL_EQUALS(methodName, methodNameLength, \"linkToStatic\")) {\n+\t\t\tisMethodHandle = TRUE;\n+\t\t}\n+\t\tbreak;\n+\tcase 13:\n+\t\tif (J9UTF8_LITERAL_EQUALS(methodName, methodNameLength, \"linkToSpecial\")\n+\t\t||  J9UTF8_LITERAL_EQUALS(methodName, methodNameLength, \"linkToVirtual\")) {\n+\t\t\tisMethodHandle = TRUE;\n+\t\t}\n+\t\tbreak;\n+\tcase 15:\n+\t\tif (J9UTF8_LITERAL_EQUALS(methodName, methodNameLength, \"linkToInterface\")) {\n+\t\t\tisMethodHandle = TRUE;\n+\t\t}\n+\t\tbreak;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTM3Mw=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDE5MDk0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo0MzowM1rOHto_mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo0MzowM1rOHto_mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTYxMA==", "bodyText": "This shouldn't be indented.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n          \n          \n            \n            #if defined(J9VM_OPT_OPENJDK_METHODHANDLE)", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517619610", "createdAt": "2020-11-04T20:43:03Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -496,7 +532,47 @@ resolveStaticMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA cp\n \tif (isResolvedClassAnInterface) {\n \t\tlookupOptions |= J9_LOOK_INTERFACE;\n \t}\n-\tmethod = (J9Method *)javaLookupMethod(vmStruct, resolvedClass, J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef), cpClass, lookupOptions);\n+\n+\t#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIwMjM4OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo0NjozMlrOHtpGsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNjo1OToxMFrOHyEaVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMTQyNg==", "bodyText": "We should also disable the above VarHandle (VH) code since OpenJDK VHs are rewritten to the invokehandle bytecode and the above code won't be used.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #endif /* defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n          \n          \n            \n            #else /* defined(J9VM_OPT_METHOD_HANDLE) */\n          \n          \n            \n                ASSERT(...);\n          \n          \n            \n            #endif /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517621426", "createdAt": "2020-11-04T20:46:32Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1611,7 +1716,7 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\t\t}\n \t\t\t}\n \t\t}\n-#endif /* J9VM_OPT_METHOD_HANDLE */\n+#endif /* defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 189}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg5MDQ4OA==", "bodyText": "VM_Assert_\nBut yes, totally agree!", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518890488", "createdAt": "2020-11-06T17:15:10Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1611,7 +1716,7 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\t\t}\n \t\t\t}\n \t\t}\n-#endif /* J9VM_OPT_METHOD_HANDLE */\n+#endif /* defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMTQyNg=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 189}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2MzEyNg==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522263126", "createdAt": "2020-11-12T16:59:10Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1611,7 +1716,7 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\t\t}\n \t\t\t}\n \t\t}\n-#endif /* J9VM_OPT_METHOD_HANDLE */\n+#endif /* defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMTQyNg=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 189}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIxMDEzOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo0OTowMFrOHtpLaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo0OTowMFrOHtpLaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMjYzNQ==", "bodyText": "Not needed since we are also disabling the else if for VarHandles since it is not needed for the OpenJDK implementation.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #endif /* defined(J9VM_OPT_METHOD_HANDLE) */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517622635", "createdAt": "2020-11-04T20:49:00Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1443,6 +1547,7 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \n \t\t\t\tgoto done;\n \t\t\t}\n+#endif /* defined(J9VM_OPT_METHOD_HANDLE) */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 180}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIxNjc0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1MTowN1rOHtpPdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1MTowN1rOHtpPdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMzY2OA==", "bodyText": "Don't share this if statement between the two implementations since it makes code difficult to read:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #elif defined(J9VM_OPT_METHOD_HANDLE) /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n          \n          \n            \n            #elif defined(J9VM_OPT_METHOD_HANDLE) /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n          \n          \n            \n            \t\tif ((NULL != cpShapeDescription) && (resolvedClass == J9VMJAVALANGINVOKEMETHODHANDLE(vm))) {", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517623668", "createdAt": "2020-11-04T20:51:07Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1368,18 +1444,46 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\tcpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(cpClass->romClass);\n \t\t\tlookupOptions |= J9_LOOK_CLCONSTRAINTS;\n \t\t}\n-\t\t\n-#if defined(J9VM_OPT_METHOD_HANDLE)\n-\t\t/*\n-\t\t * Check for MH.invoke and MH.invokeExact.\n-\t\t *\n-\t\t * Methodrefs corresponding to those methods already have their methodIndex set to index into\n-\t\t * cpClass->methodTypes. We resolve them by calling into MethodType.fromMethodDescriptorString()\n-\t\t * and storing the result into the cpClass->methodTypes table.\n-\t\t */\n+\n+#if defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t\tif ((NULL != cpShapeDescription)\n \t\t&& (resolvedClass == J9VMJAVALANGINVOKEMETHODHANDLE(vm))\n \t\t) {\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t\t\t/**\n+\t\t\t * Check for MH intrinsic methods\n+\t\t\t *\n+\t\t\t * Modify the signature to avoid signature mismatch due to varargs\n+\t\t\t * These methods have special INL send targets\n+\t\t\t */\n+\t\t\tJ9UTF8 *nameUTF = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);\n+\t\t\tU_8* initialMethodName = J9UTF8_DATA(nameUTF);\n+\t\t\tU_16 initialMethodNameLength = J9UTF8_LENGTH(nameUTF);\n+\n+\t\t\tif (isMethodHandleINL(initialMethodName, initialMethodNameLength)) {\n+\t\t\t\tJ9UTF8 *modifiedMethodName = (J9UTF8 *)(nameAndNAS + sizeof(J9ROMNameAndSignature));\n+\t\t\t\tJ9UTF8 *modifiedMethodSig = (J9UTF8 *)(nameAndNAS + sizeof(nameAndNAS) - sizeof(J9UTF8));\n+\t\t\t\tmemset(nameAndNAS, 0, sizeof(nameAndNAS));\n+\n+\t\t\t\t/* Create new J9ROMNameAndSignature */\n+\t\t\t\tnameAndSig = (J9ROMNameAndSignature *)nameAndNAS;\n+\t\t\t\tNNSRP_SET(nameAndSig->name, modifiedMethodName);\n+\t\t\t\tNNSRP_SET(nameAndSig->signature, modifiedMethodSig);\n+\n+\t\t\t\tmodifiedMethodName->length = initialMethodNameLength;\n+\t\t\t\tmemcpy(modifiedMethodName->data, initialMethodName, initialMethodNameLength);\n+\n+\t\t\t\t/* Set flag for partial signature lookup. Signature length is already initialized to 0. */\n+\t\t\t\tlookupOptions |= J9_LOOK_PARTIAL_SIGNATURE;\n+\t\t\t}\n+#elif defined(J9VM_OPT_METHOD_HANDLE) /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 165}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIxNzU1OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1MToyNFrOHtpP9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1MToyNFrOHtpP9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMzc5Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t}\n          \n          \n            \n            \t\t\t}\n          \n          \n            \n            \t\t}", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517623796", "createdAt": "2020-11-04T20:51:24Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1368,18 +1444,46 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\tcpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(cpClass->romClass);\n \t\t\tlookupOptions |= J9_LOOK_CLCONSTRAINTS;\n \t\t}\n-\t\t\n-#if defined(J9VM_OPT_METHOD_HANDLE)\n-\t\t/*\n-\t\t * Check for MH.invoke and MH.invokeExact.\n-\t\t *\n-\t\t * Methodrefs corresponding to those methods already have their methodIndex set to index into\n-\t\t * cpClass->methodTypes. We resolve them by calling into MethodType.fromMethodDescriptorString()\n-\t\t * and storing the result into the cpClass->methodTypes table.\n-\t\t */\n+\n+#if defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t\tif ((NULL != cpShapeDescription)\n \t\t&& (resolvedClass == J9VMJAVALANGINVOKEMETHODHANDLE(vm))\n \t\t) {\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t\t\t/**\n+\t\t\t * Check for MH intrinsic methods\n+\t\t\t *\n+\t\t\t * Modify the signature to avoid signature mismatch due to varargs\n+\t\t\t * These methods have special INL send targets\n+\t\t\t */\n+\t\t\tJ9UTF8 *nameUTF = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);\n+\t\t\tU_8* initialMethodName = J9UTF8_DATA(nameUTF);\n+\t\t\tU_16 initialMethodNameLength = J9UTF8_LENGTH(nameUTF);\n+\n+\t\t\tif (isMethodHandleINL(initialMethodName, initialMethodNameLength)) {\n+\t\t\t\tJ9UTF8 *modifiedMethodName = (J9UTF8 *)(nameAndNAS + sizeof(J9ROMNameAndSignature));\n+\t\t\t\tJ9UTF8 *modifiedMethodSig = (J9UTF8 *)(nameAndNAS + sizeof(nameAndNAS) - sizeof(J9UTF8));\n+\t\t\t\tmemset(nameAndNAS, 0, sizeof(nameAndNAS));\n+\n+\t\t\t\t/* Create new J9ROMNameAndSignature */\n+\t\t\t\tnameAndSig = (J9ROMNameAndSignature *)nameAndNAS;\n+\t\t\t\tNNSRP_SET(nameAndSig->name, modifiedMethodName);\n+\t\t\t\tNNSRP_SET(nameAndSig->signature, modifiedMethodSig);\n+\n+\t\t\t\tmodifiedMethodName->length = initialMethodNameLength;\n+\t\t\t\tmemcpy(modifiedMethodName->data, initialMethodName, initialMethodNameLength);\n+\n+\t\t\t\t/* Set flag for partial signature lookup. Signature length is already initialized to 0. */\n+\t\t\t\tlookupOptions |= J9_LOOK_PARTIAL_SIGNATURE;\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 164}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIxOTc0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1MjowMlrOHtpRVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1MjowMlrOHtpRVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNDE0OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n          \n          \n            \n            #if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n          \n          \n            \n            \t\tif ((NULL != cpShapeDescription) && (resolvedClass == J9VMJAVALANGINVOKEMETHODHANDLE(vm))) {", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517624149", "createdAt": "2020-11-04T20:52:02Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1368,18 +1444,46 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\tcpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(cpClass->romClass);\n \t\t\tlookupOptions |= J9_LOOK_CLCONSTRAINTS;\n \t\t}\n-\t\t\n-#if defined(J9VM_OPT_METHOD_HANDLE)\n-\t\t/*\n-\t\t * Check for MH.invoke and MH.invokeExact.\n-\t\t *\n-\t\t * Methodrefs corresponding to those methods already have their methodIndex set to index into\n-\t\t * cpClass->methodTypes. We resolve them by calling into MethodType.fromMethodDescriptorString()\n-\t\t * and storing the result into the cpClass->methodTypes table.\n-\t\t */\n+\n+#if defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t\tif ((NULL != cpShapeDescription)\n \t\t&& (resolvedClass == J9VMJAVALANGINVOKEMETHODHANDLE(vm))\n \t\t) {\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 138}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIyNDU3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1MzoyN1rOHtpUJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1MzoyN1rOHtpUJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNDg3MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #if defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE)", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517624870", "createdAt": "2020-11-04T20:53:27Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1368,18 +1444,46 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\tcpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(cpClass->romClass);\n \t\t\tlookupOptions |= J9_LOOK_CLCONSTRAINTS;\n \t\t}\n-\t\t\n-#if defined(J9VM_OPT_METHOD_HANDLE)\n-\t\t/*\n-\t\t * Check for MH.invoke and MH.invokeExact.\n-\t\t *\n-\t\t * Methodrefs corresponding to those methods already have their methodIndex set to index into\n-\t\t * cpClass->methodTypes. We resolve them by calling into MethodType.fromMethodDescriptorString()\n-\t\t * and storing the result into the cpClass->methodTypes table.\n-\t\t */\n+\n+#if defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIyNTAwOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1MzozNlrOHtpUdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1MzozNlrOHtpUdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNDk0OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif ((NULL != cpShapeDescription)", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517624949", "createdAt": "2020-11-04T20:53:36Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1368,18 +1444,46 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\tcpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(cpClass->romClass);\n \t\t\tlookupOptions |= J9_LOOK_CLCONSTRAINTS;\n \t\t}\n-\t\t\n-#if defined(J9VM_OPT_METHOD_HANDLE)\n-\t\t/*\n-\t\t * Check for MH.invoke and MH.invokeExact.\n-\t\t *\n-\t\t * Methodrefs corresponding to those methods already have their methodIndex set to index into\n-\t\t * cpClass->methodTypes. We resolve them by calling into MethodType.fromMethodDescriptorString()\n-\t\t * and storing the result into the cpClass->methodTypes table.\n-\t\t */\n+\n+#if defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t\tif ((NULL != cpShapeDescription)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 135}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIyNTUxOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1Mzo0NVrOHtpUug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1Mzo0NVrOHtpUug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNTAxOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t&& (resolvedClass == J9VMJAVALANGINVOKEMETHODHANDLE(vm))", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517625018", "createdAt": "2020-11-04T20:53:45Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1368,18 +1444,46 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\tcpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(cpClass->romClass);\n \t\t\tlookupOptions |= J9_LOOK_CLCONSTRAINTS;\n \t\t}\n-\t\t\n-#if defined(J9VM_OPT_METHOD_HANDLE)\n-\t\t/*\n-\t\t * Check for MH.invoke and MH.invokeExact.\n-\t\t *\n-\t\t * Methodrefs corresponding to those methods already have their methodIndex set to index into\n-\t\t * cpClass->methodTypes. We resolve them by calling into MethodType.fromMethodDescriptorString()\n-\t\t * and storing the result into the cpClass->methodTypes table.\n-\t\t */\n+\n+#if defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t\tif ((NULL != cpShapeDescription)\n \t\t&& (resolvedClass == J9VMJAVALANGINVOKEMETHODHANDLE(vm))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 136}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIyNjA5OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1Mzo1NFrOHtpVBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1Mzo1NFrOHtpVBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNTA5NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t) {", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517625094", "createdAt": "2020-11-04T20:53:54Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1368,18 +1444,46 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\tcpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(cpClass->romClass);\n \t\t\tlookupOptions |= J9_LOOK_CLCONSTRAINTS;\n \t\t}\n-\t\t\n-#if defined(J9VM_OPT_METHOD_HANDLE)\n-\t\t/*\n-\t\t * Check for MH.invoke and MH.invokeExact.\n-\t\t *\n-\t\t * Methodrefs corresponding to those methods already have their methodIndex set to index into\n-\t\t * cpClass->methodTypes. We resolve them by calling into MethodType.fromMethodDescriptorString()\n-\t\t * and storing the result into the cpClass->methodTypes table.\n-\t\t */\n+\n+#if defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t\tif ((NULL != cpShapeDescription)\n \t\t&& (resolvedClass == J9VMJAVALANGINVOKEMETHODHANDLE(vm))\n \t\t) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 137}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIzNzE4OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1NzoxM1rOHtpbwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNjo1OToyOFrOHyEbXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNjgxNw==", "bodyText": "The entry tracepoint should be invoked before the above return statements. The exit tracepoint should also be invoked before the above return _statements.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517626817", "createdAt": "2020-11-04T20:57:13Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2084,56 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;\n+\t}\n+\n+\tTrc_VM_resolveInvokeHandle_Entry(vmThread, ramCP, cpIndex, resolveFlags);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 227}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2MzM5MQ==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522263391", "createdAt": "2020-11-12T16:59:28Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2084,56 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;\n+\t}\n+\n+\tTrc_VM_resolveInvokeHandle_Entry(vmThread, ramCP, cpIndex, resolveFlags);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNjgxNw=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 227}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIzODE4OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1NzozMVrOHtpcXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjoxNjoxMlrOHuYz7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNjk3Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t/* Already a pending exception */\n          \n          \n            \n            \t\t\t/* Already a pending exception. */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517626973", "createdAt": "2020-11-04T20:57:31Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2084,56 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;\n+\t}\n+\n+\tTrc_VM_resolveInvokeHandle_Entry(vmThread, ramCP, cpIndex, resolveFlags);\n+\n+\tJ9ROMMethodRef *romMethodRef = (J9ROMMethodRef *)&ramCP->romConstantPool[cpIndex];\n+\tJ9ROMNameAndSignature *nameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\n+\t/* Resolve the class. */\n+\tJ9Class *resolvedClass = resolveClassRef(vmThread, ramCP, romMethodRef->classRefCPIndex, resolveFlags);\n+\tif (resolvedClass != NULL) {\n+\t\tsendResolveOpenJDKInvokeHandle(vmThread, ramCP, cpIndex, MH_REF_INVOKEVIRTUAL, resolvedClass, nameAndSig);\n+\t\tresult = (j9object_t)vmThread->returnValue;\n+\n+\t\tif (vmThread->currentException != NULL) {\n+\t\t\t/* Already a pending exception */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 239}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQwMzA1NA==", "bodyText": "keeping existing format for consistency within the file", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518403054", "createdAt": "2020-11-05T22:16:12Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2084,56 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;\n+\t}\n+\n+\tTrc_VM_resolveInvokeHandle_Entry(vmThread, ramCP, cpIndex, resolveFlags);\n+\n+\tJ9ROMMethodRef *romMethodRef = (J9ROMMethodRef *)&ramCP->romConstantPool[cpIndex];\n+\tJ9ROMNameAndSignature *nameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\n+\t/* Resolve the class. */\n+\tJ9Class *resolvedClass = resolveClassRef(vmThread, ramCP, romMethodRef->classRefCPIndex, resolveFlags);\n+\tif (resolvedClass != NULL) {\n+\t\tsendResolveOpenJDKInvokeHandle(vmThread, ramCP, cpIndex, MH_REF_INVOKEVIRTUAL, resolvedClass, nameAndSig);\n+\t\tresult = (j9object_t)vmThread->returnValue;\n+\n+\t\tif (vmThread->currentException != NULL) {\n+\t\t\t/* Already a pending exception */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNjk3Mw=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 239}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI0Mzc2OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1OToyM1rOHtpgAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjo1NToxOVrOHuZ1kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNzkwNg==", "bodyText": "if (result != NULL) is equivalent to the else block in the previous if/else block.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517627906", "createdAt": "2020-11-04T20:59:23Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2084,56 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;\n+\t}\n+\n+\tTrc_VM_resolveInvokeHandle_Entry(vmThread, ramCP, cpIndex, resolveFlags);\n+\n+\tJ9ROMMethodRef *romMethodRef = (J9ROMMethodRef *)&ramCP->romConstantPool[cpIndex];\n+\tJ9ROMNameAndSignature *nameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\n+\t/* Resolve the class. */\n+\tJ9Class *resolvedClass = resolveClassRef(vmThread, ramCP, romMethodRef->classRefCPIndex, resolveFlags);\n+\tif (resolvedClass != NULL) {\n+\t\tsendResolveOpenJDKInvokeHandle(vmThread, ramCP, cpIndex, MH_REF_INVOKEVIRTUAL, resolvedClass, nameAndSig);\n+\t\tresult = (j9object_t)vmThread->returnValue;\n+\n+\t\tif (vmThread->currentException != NULL) {\n+\t\t\t/* Already a pending exception */\n+\t\t\tresult = NULL;\n+\t\t} else if (result == NULL) {\n+\t\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t\t}\n+\n+\t\tif (result != NULL) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 245}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQxOTg1Ng==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518419856", "createdAt": "2020-11-05T22:55:19Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2084,56 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;\n+\t}\n+\n+\tTrc_VM_resolveInvokeHandle_Entry(vmThread, ramCP, cpIndex, resolveFlags);\n+\n+\tJ9ROMMethodRef *romMethodRef = (J9ROMMethodRef *)&ramCP->romConstantPool[cpIndex];\n+\tJ9ROMNameAndSignature *nameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\n+\t/* Resolve the class. */\n+\tJ9Class *resolvedClass = resolveClassRef(vmThread, ramCP, romMethodRef->classRefCPIndex, resolveFlags);\n+\tif (resolvedClass != NULL) {\n+\t\tsendResolveOpenJDKInvokeHandle(vmThread, ramCP, cpIndex, MH_REF_INVOKEVIRTUAL, resolvedClass, nameAndSig);\n+\t\tresult = (j9object_t)vmThread->returnValue;\n+\n+\t\tif (vmThread->currentException != NULL) {\n+\t\t\t/* Already a pending exception */\n+\t\t\tresult = NULL;\n+\t\t} else if (result == NULL) {\n+\t\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t\t}\n+\n+\t\tif (result != NULL) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNzkwNg=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 245}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI0NDk0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1OTo0NVrOHtpguA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1OTo0NVrOHtpguA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyODA4OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t}\n          \n          \n            \n            \t\t} else { /* (result != NULL) */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517628088", "createdAt": "2020-11-04T20:59:45Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2084,56 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;\n+\t}\n+\n+\tTrc_VM_resolveInvokeHandle_Entry(vmThread, ramCP, cpIndex, resolveFlags);\n+\n+\tJ9ROMMethodRef *romMethodRef = (J9ROMMethodRef *)&ramCP->romConstantPool[cpIndex];\n+\tJ9ROMNameAndSignature *nameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\n+\t/* Resolve the class. */\n+\tJ9Class *resolvedClass = resolveClassRef(vmThread, ramCP, romMethodRef->classRefCPIndex, resolveFlags);\n+\tif (resolvedClass != NULL) {\n+\t\tsendResolveOpenJDKInvokeHandle(vmThread, ramCP, cpIndex, MH_REF_INVOKEVIRTUAL, resolvedClass, nameAndSig);\n+\t\tresult = (j9object_t)vmThread->returnValue;\n+\n+\t\tif (vmThread->currentException != NULL) {\n+\t\t\t/* Already a pending exception */\n+\t\t\tresult = NULL;\n+\t\t} else if (result == NULL) {\n+\t\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 243}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI1MDgxOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowMTozOFrOHtpkTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowMTozOFrOHtpkTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyOTAwNg==", "bodyText": "The entry tracepoint should be invoked before the above return statement. The exit tracepoint should also be invoked before the above return statement.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517629006", "createdAt": "2020-11-04T21:01:38Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;\n \t}\n \n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 285}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI1Njg3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowMzo0N1rOHtpoRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNjo1OTo0NVrOHyEcag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMDAyMQ==", "bodyText": "The code can be rewritten to have only one return statement. This will allow entry and exit tracepoints to be correctly located.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517630021", "createdAt": "2020-11-04T21:03:47Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2084,56 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 224}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2MzY1OA==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522263658", "createdAt": "2020-11-12T16:59:45Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2084,56 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMDAyMQ=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 224}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI1ODA5OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNDowNFrOHtpo7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNDowNFrOHtpo7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMDE4OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t/* store result */\n          \n          \n            \n            \t\t\t/* Store result. */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517630188", "createdAt": "2020-11-04T21:04:04Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2084,56 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;\n+\t}\n+\n+\tTrc_VM_resolveInvokeHandle_Entry(vmThread, ramCP, cpIndex, resolveFlags);\n+\n+\tJ9ROMMethodRef *romMethodRef = (J9ROMMethodRef *)&ramCP->romConstantPool[cpIndex];\n+\tJ9ROMNameAndSignature *nameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\n+\t/* Resolve the class. */\n+\tJ9Class *resolvedClass = resolveClassRef(vmThread, ramCP, romMethodRef->classRefCPIndex, resolveFlags);\n+\tif (resolvedClass != NULL) {\n+\t\tsendResolveOpenJDKInvokeHandle(vmThread, ramCP, cpIndex, MH_REF_INVOKEVIRTUAL, resolvedClass, nameAndSig);\n+\t\tresult = (j9object_t)vmThread->returnValue;\n+\n+\t\tif (vmThread->currentException != NULL) {\n+\t\t\t/* Already a pending exception */\n+\t\t\tresult = NULL;\n+\t\t} else if (result == NULL) {\n+\t\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t\t}\n+\n+\t\tif (result != NULL) {\n+\t\t\t/* store result */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 246}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI2MDQ1OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNDo1MFrOHtpqcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNDo1MFrOHtpqcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMDU3OQ==", "bodyText": "If possible, avoid multiple return statements. This will make it easier to position entry and exit tracepoints.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517630579", "createdAt": "2020-11-04T21:04:50Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 282}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI2NDA3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNTo1OFrOHtpsnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNTo1OFrOHtpsnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMTEzMw==", "bodyText": "The below if (result != NULL) can be replaced with an else block here.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t}\n          \n          \n            \n            \t} else { // (result != NULL)", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517631133", "createdAt": "2020-11-04T21:05:58Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;\n \t}\n \n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);\n+\n \t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n \tfor (i = 0; i < bsmIndex; i++) {\n \t\t/* increment by size of bsm data plus header */\n \t\tbsmData += bsmData[1] + 2;\n \t}\n \n \tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n-\tmethodHandle = (j9object_t) vmThread->returnValue;\n+\tresult = (j9object_t) vmThread->returnValue;\n+\n+\tTrc_VM_resolveInvokeDynamic_Resolved(vmThread, callSiteIndex, result);\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t/* check if an exception is already pending */\n \tif (vmThread->currentException != NULL) {\n \t\t/* Already a pending exception */\n-\t\tmethodHandle = NULL;\n-\t} else if (methodHandle == NULL) {\n+\t\tresult = vmThread->currentException;\n+\t} else if (result == NULL) {\n+\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 308}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI2NDg3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNjoxMVrOHtptGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNjoxMVrOHtptGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMTI1Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t/* check if an exception is already pending */\n          \n          \n            \n            \t/* Check if an exception is already pending. */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517631256", "createdAt": "2020-11-04T21:06:11Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;\n \t}\n \n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);\n+\n \t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n \tfor (i = 0; i < bsmIndex; i++) {\n \t\t/* increment by size of bsm data plus header */\n \t\tbsmData += bsmData[1] + 2;\n \t}\n \n \tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n-\tmethodHandle = (j9object_t) vmThread->returnValue;\n+\tresult = (j9object_t) vmThread->returnValue;\n+\n+\tTrc_VM_resolveInvokeDynamic_Resolved(vmThread, callSiteIndex, result);\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t/* check if an exception is already pending */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 300}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI2NTI2OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNjoxOVrOHtptTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjoxNjozN1rOHuY0pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMTMxMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t/* Already a pending exception */\n          \n          \n            \n            \t\t/* Already a pending exception. */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517631310", "createdAt": "2020-11-04T21:06:19Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;\n \t}\n \n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);\n+\n \t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n \tfor (i = 0; i < bsmIndex; i++) {\n \t\t/* increment by size of bsm data plus header */\n \t\tbsmData += bsmData[1] + 2;\n \t}\n \n \tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n-\tmethodHandle = (j9object_t) vmThread->returnValue;\n+\tresult = (j9object_t) vmThread->returnValue;\n+\n+\tTrc_VM_resolveInvokeDynamic_Resolved(vmThread, callSiteIndex, result);\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t/* check if an exception is already pending */\n \tif (vmThread->currentException != NULL) {\n \t\t/* Already a pending exception */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 302}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQwMzIzOA==", "bodyText": "keeping existing format for consistency within the file", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518403238", "createdAt": "2020-11-05T22:16:37Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;\n \t}\n \n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);\n+\n \t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n \tfor (i = 0; i < bsmIndex; i++) {\n \t\t/* increment by size of bsm data plus header */\n \t\tbsmData += bsmData[1] + 2;\n \t}\n \n \tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n-\tmethodHandle = (j9object_t) vmThread->returnValue;\n+\tresult = (j9object_t) vmThread->returnValue;\n+\n+\tTrc_VM_resolveInvokeDynamic_Resolved(vmThread, callSiteIndex, result);\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t/* check if an exception is already pending */\n \tif (vmThread->currentException != NULL) {\n \t\t/* Already a pending exception */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMTMxMA=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 302}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI2NTg2OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNjozM1rOHtptqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNjozM1rOHtptqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMTQwMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t/* store result */\n          \n          \n            \n            \t\t/* Store result. */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517631403", "createdAt": "2020-11-04T21:06:33Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;\n \t}\n \n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);\n+\n \t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n \tfor (i = 0; i < bsmIndex; i++) {\n \t\t/* increment by size of bsm data plus header */\n \t\tbsmData += bsmData[1] + 2;\n \t}\n \n \tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n-\tmethodHandle = (j9object_t) vmThread->returnValue;\n+\tresult = (j9object_t) vmThread->returnValue;\n+\n+\tTrc_VM_resolveInvokeDynamic_Resolved(vmThread, callSiteIndex, result);\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t/* check if an exception is already pending */\n \tif (vmThread->currentException != NULL) {\n \t\t/* Already a pending exception */\n-\t\tmethodHandle = NULL;\n-\t} else if (methodHandle == NULL) {\n+\t\tresult = vmThread->currentException;\n+\t} else if (result == NULL) {\n+\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t}\n+\n+\tif (result != NULL) {\n+\t\t/* store result */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 311}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI2NjY0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNjo0NlrOHtpuHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNjo0NlrOHtpuHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMTUxNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t/* check if an exception is already pending */\n          \n          \n            \n            \t/* Check if an exception is already pending. */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517631517", "createdAt": "2020-11-04T21:06:46Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;\n \t}\n \n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);\n+\n \t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n \tfor (i = 0; i < bsmIndex; i++) {\n \t\t/* increment by size of bsm data plus header */\n \t\tbsmData += bsmData[1] + 2;\n \t}\n \n \tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n-\tmethodHandle = (j9object_t) vmThread->returnValue;\n+\tresult = (j9object_t) vmThread->returnValue;\n+\n+\tTrc_VM_resolveInvokeDynamic_Resolved(vmThread, callSiteIndex, result);\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t/* check if an exception is already pending */\n \tif (vmThread->currentException != NULL) {\n \t\t/* Already a pending exception */\n-\t\tmethodHandle = NULL;\n-\t} else if (methodHandle == NULL) {\n+\t\tresult = vmThread->currentException;\n+\t} else if (result == NULL) {\n+\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t}\n+\n+\tif (result != NULL) {\n+\t\t/* store result */\n+\t\tJ9MemoryManagerFunctions *gcFuncs = vmThread->javaVM->memoryManagerFunctions;\n+\t\tJ9Class *j9class = J9_CLASS_FROM_CP(ramCP);\n+\t\tif (0 == gcFuncs->j9gc_objaccess_staticCompareAndSwapObject(vmThread, j9class, callSite, NULL, result)) {\n+\t\t\t/* Another thread beat this thread to updating the call site, ensure both threads return the same method handle. */\n+\t\t\tresult = *callSite;\n+\t\t}\n+\t}\n+#else /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n+\t/* check if an exception is already pending */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 320}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI2NzExOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNjo1OFrOHtpucQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjoxNzowMFrOHuY1TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMTYwMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t/* Already a pending exception */\n          \n          \n            \n            \t\t/* Already a pending exception. */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517631601", "createdAt": "2020-11-04T21:06:58Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;\n \t}\n \n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);\n+\n \t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n \tfor (i = 0; i < bsmIndex; i++) {\n \t\t/* increment by size of bsm data plus header */\n \t\tbsmData += bsmData[1] + 2;\n \t}\n \n \tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n-\tmethodHandle = (j9object_t) vmThread->returnValue;\n+\tresult = (j9object_t) vmThread->returnValue;\n+\n+\tTrc_VM_resolveInvokeDynamic_Resolved(vmThread, callSiteIndex, result);\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t/* check if an exception is already pending */\n \tif (vmThread->currentException != NULL) {\n \t\t/* Already a pending exception */\n-\t\tmethodHandle = NULL;\n-\t} else if (methodHandle == NULL) {\n+\t\tresult = vmThread->currentException;\n+\t} else if (result == NULL) {\n+\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t}\n+\n+\tif (result != NULL) {\n+\t\t/* store result */\n+\t\tJ9MemoryManagerFunctions *gcFuncs = vmThread->javaVM->memoryManagerFunctions;\n+\t\tJ9Class *j9class = J9_CLASS_FROM_CP(ramCP);\n+\t\tif (0 == gcFuncs->j9gc_objaccess_staticCompareAndSwapObject(vmThread, j9class, callSite, NULL, result)) {\n+\t\t\t/* Another thread beat this thread to updating the call site, ensure both threads return the same method handle. */\n+\t\t\tresult = *callSite;\n+\t\t}\n+\t}\n+#else /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n+\t/* check if an exception is already pending */\n+\tif (vmThread->currentException != NULL) {\n+\t\t/* Already a pending exception */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 322}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQwMzQwNQ==", "bodyText": "keeping existing format for consistency within the file", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518403405", "createdAt": "2020-11-05T22:17:00Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;\n \t}\n \n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);\n+\n \t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n \tfor (i = 0; i < bsmIndex; i++) {\n \t\t/* increment by size of bsm data plus header */\n \t\tbsmData += bsmData[1] + 2;\n \t}\n \n \tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n-\tmethodHandle = (j9object_t) vmThread->returnValue;\n+\tresult = (j9object_t) vmThread->returnValue;\n+\n+\tTrc_VM_resolveInvokeDynamic_Resolved(vmThread, callSiteIndex, result);\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t/* check if an exception is already pending */\n \tif (vmThread->currentException != NULL) {\n \t\t/* Already a pending exception */\n-\t\tmethodHandle = NULL;\n-\t} else if (methodHandle == NULL) {\n+\t\tresult = vmThread->currentException;\n+\t} else if (result == NULL) {\n+\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t}\n+\n+\tif (result != NULL) {\n+\t\t/* store result */\n+\t\tJ9MemoryManagerFunctions *gcFuncs = vmThread->javaVM->memoryManagerFunctions;\n+\t\tJ9Class *j9class = J9_CLASS_FROM_CP(ramCP);\n+\t\tif (0 == gcFuncs->j9gc_objaccess_staticCompareAndSwapObject(vmThread, j9class, callSite, NULL, result)) {\n+\t\t\t/* Another thread beat this thread to updating the call site, ensure both threads return the same method handle. */\n+\t\t\tresult = *callSite;\n+\t\t}\n+\t}\n+#else /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n+\t/* check if an exception is already pending */\n+\tif (vmThread->currentException != NULL) {\n+\t\t/* Already a pending exception */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMTYwMQ=="}, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 322}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI2ODI0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNzoyM1rOHtpvLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowNzoyM1rOHtpvLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMTc5MA==", "bodyText": "The below if (result != NULL) can be replaced with an else block here.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t}\n          \n          \n            \n            \t} else { // (result != NULL)", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r517631790", "createdAt": "2020-11-04T21:07:23Z", "author": {"login": "babsingh"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2105,56 +2260,80 @@ resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSite\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n+\tif (result != NULL) {\n+\t\treturn result;\n \t}\n \n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);\n+\n \t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n \tfor (i = 0; i < bsmIndex; i++) {\n \t\t/* increment by size of bsm data plus header */\n \t\tbsmData += bsmData[1] + 2;\n \t}\n \n \tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n-\tmethodHandle = (j9object_t) vmThread->returnValue;\n+\tresult = (j9object_t) vmThread->returnValue;\n+\n+\tTrc_VM_resolveInvokeDynamic_Resolved(vmThread, callSiteIndex, result);\n \n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t/* check if an exception is already pending */\n \tif (vmThread->currentException != NULL) {\n \t\t/* Already a pending exception */\n-\t\tmethodHandle = NULL;\n-\t} else if (methodHandle == NULL) {\n+\t\tresult = vmThread->currentException;\n+\t} else if (result == NULL) {\n+\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t}\n+\n+\tif (result != NULL) {\n+\t\t/* store result */\n+\t\tJ9MemoryManagerFunctions *gcFuncs = vmThread->javaVM->memoryManagerFunctions;\n+\t\tJ9Class *j9class = J9_CLASS_FROM_CP(ramCP);\n+\t\tif (0 == gcFuncs->j9gc_objaccess_staticCompareAndSwapObject(vmThread, j9class, callSite, NULL, result)) {\n+\t\t\t/* Another thread beat this thread to updating the call site, ensure both threads return the same method handle. */\n+\t\t\tresult = *callSite;\n+\t\t}\n+\t}\n+#else /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n+\t/* check if an exception is already pending */\n+\tif (vmThread->currentException != NULL) {\n+\t\t/* Already a pending exception */\n+\t\tresult = NULL;\n+\t} else if (result == NULL) {\n \t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n \t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95bd6ed99881668882b4e5a6dda478ad2b124a4b"}, "originalPosition": 326}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjE0MTU4OnYy", "diffSide": "RIGHT", "path": "runtime/bcutil/ConstantPoolMap.hpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjoxNDo1NlrOHu0X3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzowMDowMVrOHyEdVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg1NDYyMg==", "bodyText": "Rather than duplicating the functions, can you ifdef just the count changes?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            #if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n          \n          \n            \n            \tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); _invokeCacheCount++; }\n          \n          \n            \n            \tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _invokeCacheCount++; }\n          \n          \n            \n            #else /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n          \n          \n            \n            \tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); _methodTypeCount++; }\n          \n          \n            \n            \tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _methodTypeCount++; }\n          \n          \n            \n            #endif /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n          \n          \n            \n            \n          \n          \n            \n            \tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex) { \n          \n          \n            \n            \t\tmark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); \n          \n          \n            \n            #if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n          \n          \n            \n            \t\t_invokeCacheCount++; \n          \n          \n            \n            #else\n          \n          \n            \n            \t\t_methodTypeCount++;\n          \n          \n            \n            #endif\n          \n          \n            \n            \t}\n          \n          \n            \n            \tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) {\n          \n          \n            \n            \t\tmark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); \n          \n          \n            \n            #if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n          \n          \n            \n            \t\t_invokeCacheCount++; \n          \n          \n            \n            #else\n          \n          \n            \n            \t\t_methodTypeCount++;\n          \n          \n            \n            #endif\n          \n          \n            \n            \t}", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518854622", "createdAt": "2020-11-06T16:14:56Z", "author": {"login": "DanHeidinga"}, "path": "runtime/bcutil/ConstantPoolMap.hpp", "diffHunk": "@@ -287,8 +291,14 @@ class ConstantPoolMap\n \tvoid markMethodRefAsUsedByInvokeSpecial(U_16 methodRefCfrCPIndex)       { mark(methodRefCfrCPIndex, INVOKE_SPECIAL); }\n \tvoid markMethodRefAsUsedByInvokeStatic(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_STATIC); }\n \tvoid markMethodRefAsUsedByInvokeInterface(U_16 methodRefCfrCPIndex)     { mark(methodRefCfrCPIndex, INVOKE_INTERFACE); }\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); _invokeCacheCount++; }\n+\tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _invokeCacheCount++; }\n+#else /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n \tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); _methodTypeCount++; }\n \tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _methodTypeCount++; }\n+#endif /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2Mzg5NA==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522263894", "createdAt": "2020-11-12T17:00:01Z", "author": {"login": "fengxue-IS"}, "path": "runtime/bcutil/ConstantPoolMap.hpp", "diffHunk": "@@ -287,8 +291,14 @@ class ConstantPoolMap\n \tvoid markMethodRefAsUsedByInvokeSpecial(U_16 methodRefCfrCPIndex)       { mark(methodRefCfrCPIndex, INVOKE_SPECIAL); }\n \tvoid markMethodRefAsUsedByInvokeStatic(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_STATIC); }\n \tvoid markMethodRefAsUsedByInvokeInterface(U_16 methodRefCfrCPIndex)     { mark(methodRefCfrCPIndex, INVOKE_INTERFACE); }\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); _invokeCacheCount++; }\n+\tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _invokeCacheCount++; }\n+#else /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n \tvoid markMethodRefAsUsedByInvokeHandle(U_16 methodRefCfrCPIndex)        { mark(methodRefCfrCPIndex, INVOKE_HANDLEEXACT); _methodTypeCount++; }\n \tvoid markMethodRefAsUsedByInvokeHandleGeneric(U_16 methodRefCfrCPIndex) { mark(methodRefCfrCPIndex, INVOKE_HANDLEGENERIC); _methodTypeCount++; }\n+#endif /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg1NDYyMg=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjE3ODI1OnYy", "diffSide": "RIGHT", "path": "runtime/codert_vm/cnathelp.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjoyNDo1N1rOHu0vWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzowMTowMFrOHyEgPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2MDYzMw==", "bodyText": "the code on the old path used to handle resolving the targetClass here.  Is this not needed anymore?", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518860633", "createdAt": "2020-11-06T16:24:57Z", "author": {"login": "DanHeidinga"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -2325,6 +2325,26 @@ old_slow_jitResolveHandleMethod(J9VMThread *currentThread)\n \tDECLARE_JIT_PARM(void*, jitEIP, 3);\n \tvoid *addr = NULL;\n \tJ9JavaVM *vm = currentThread->javaVM;\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tJ9RAMMethodRef *ramMethodRef = ((J9RAMMethodRef*)ramConstantPool) + cpIndex;\n+\tUDATA invokeCacheIndex = ramMethodRef->methodIndexAndArgCount >> 8;\n+retry:\n+\tj9object_t invokeCacheArray = (J9_CLASS_FROM_CP(ramConstantPool)->invokeCache)[invokeCacheIndex];\n+\tif (NULL == invokeCacheArray) {\n+\t\tbuildJITResolveFrameWithPC(currentThread, J9_SSF_JIT_RESOLVE_DATA, parmCount, true, 0, jitEIP);\n+\t\t/* add new resolve code which calls sendResolveInvokeHandle -> MHN.linkMethod()\n+\t\t * store the memberName/appendix values in invokeCache[invokeCacheIndex]\n+\t\t */\n+\t\tvm->internalVMFunctions->resolveInvokeHandle(currentThread, ramConstantPool, cpIndex, J9_RESOLVE_FLAG_RUNTIME_RESOLVE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2NDYzOQ==", "bodyText": "the targetClass is resolved as part of the resolveInvokeHandle call", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522264639", "createdAt": "2020-11-12T17:01:00Z", "author": {"login": "fengxue-IS"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -2325,6 +2325,26 @@ old_slow_jitResolveHandleMethod(J9VMThread *currentThread)\n \tDECLARE_JIT_PARM(void*, jitEIP, 3);\n \tvoid *addr = NULL;\n \tJ9JavaVM *vm = currentThread->javaVM;\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tJ9RAMMethodRef *ramMethodRef = ((J9RAMMethodRef*)ramConstantPool) + cpIndex;\n+\tUDATA invokeCacheIndex = ramMethodRef->methodIndexAndArgCount >> 8;\n+retry:\n+\tj9object_t invokeCacheArray = (J9_CLASS_FROM_CP(ramConstantPool)->invokeCache)[invokeCacheIndex];\n+\tif (NULL == invokeCacheArray) {\n+\t\tbuildJITResolveFrameWithPC(currentThread, J9_SSF_JIT_RESOLVE_DATA, parmCount, true, 0, jitEIP);\n+\t\t/* add new resolve code which calls sendResolveInvokeHandle -> MHN.linkMethod()\n+\t\t * store the memberName/appendix values in invokeCache[invokeCacheIndex]\n+\t\t */\n+\t\tvm->internalVMFunctions->resolveInvokeHandle(currentThread, ramConstantPool, cpIndex, J9_RESOLVE_FLAG_RUNTIME_RESOLVE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2MDYzMw=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjE4OTk0OnYy", "diffSide": "RIGHT", "path": "runtime/gc_structs/ClassIterator.hpp", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjoyNzo1NFrOHu02tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTo0NTo1NlrOHyLXTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2MjUxNg==", "bodyText": "Shouldn't this iterator be renamed given it's 1) not iterating MTs anymore, 2) it's now dealing with the invokeCache?\n@amicic opinions?", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518862516", "createdAt": "2020-11-06T16:27:54Z", "author": {"login": "DanHeidinga"}, "path": "runtime/gc_structs/ClassIterator.hpp", "diffHunk": "@@ -85,7 +85,11 @@ class GC_ClassIterator {\n \t\t, _classStaticsIterator(env, clazz)\n \t\t, _constantPoolObjectSlotIterator((J9JavaVM *)env->getLanguageVM(), clazz)\n \t\t, _callSitesIterator(clazz)\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t\t, _methodTypesIterator(clazz->romClass->invokeCacheCount, clazz->invokeCache)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTAwNjU4Mg==", "bodyText": "seems reasonable, but since I don't fully understand relationship between MH and invokeCache,  I'll add @dmitripivkine", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r519006582", "createdAt": "2020-11-06T21:10:00Z", "author": {"login": "amicic"}, "path": "runtime/gc_structs/ClassIterator.hpp", "diffHunk": "@@ -85,7 +85,11 @@ class GC_ClassIterator {\n \t\t, _classStaticsIterator(env, clazz)\n \t\t, _constantPoolObjectSlotIterator((J9JavaVM *)env->getLanguageVM(), clazz)\n \t\t, _callSitesIterator(clazz)\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t\t, _methodTypesIterator(clazz->romClass->invokeCacheCount, clazz->invokeCache)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2MjUxNg=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTAwOTk0NA==", "bodyText": "(from my narrow perspective) I'm wondering why the ifdef build flag has METHODHANDLE in the name, and should it be INVOKECACHE ?", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r519009944", "createdAt": "2020-11-06T21:18:40Z", "author": {"login": "amicic"}, "path": "runtime/gc_structs/ClassIterator.hpp", "diffHunk": "@@ -85,7 +85,11 @@ class GC_ClassIterator {\n \t\t, _classStaticsIterator(env, clazz)\n \t\t, _constantPoolObjectSlotIterator((J9JavaVM *)env->getLanguageVM(), clazz)\n \t\t, _callSitesIterator(clazz)\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t\t, _methodTypesIterator(clazz->romClass->invokeCacheCount, clazz->invokeCache)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2MjUxNg=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5NzUyNw==", "bodyText": "The ifdef is for the other all feature which is using the OpenJDK MH implementation.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r520597527", "createdAt": "2020-11-10T14:20:19Z", "author": {"login": "DanHeidinga"}, "path": "runtime/gc_structs/ClassIterator.hpp", "diffHunk": "@@ -85,7 +85,11 @@ class GC_ClassIterator {\n \t\t, _classStaticsIterator(env, clazz)\n \t\t, _constantPoolObjectSlotIterator((J9JavaVM *)env->getLanguageVM(), clazz)\n \t\t, _callSitesIterator(clazz)\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t\t, _methodTypesIterator(clazz->romClass->invokeCacheCount, clazz->invokeCache)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2MjUxNg=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMjQ2OA==", "bodyText": "@fengxue-IS Can you open an issue to track renaming the GC_MethodTypesIterator to something like GC_InvokeCacheIterator?  We need to track it as a cleanup task that should be done before the final cutover but doesn't need to be included in this PR", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522332468", "createdAt": "2020-11-12T18:42:01Z", "author": {"login": "DanHeidinga"}, "path": "runtime/gc_structs/ClassIterator.hpp", "diffHunk": "@@ -85,7 +85,11 @@ class GC_ClassIterator {\n \t\t, _classStaticsIterator(env, clazz)\n \t\t, _constantPoolObjectSlotIterator((J9JavaVM *)env->getLanguageVM(), clazz)\n \t\t, _callSitesIterator(clazz)\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t\t, _methodTypesIterator(clazz->romClass->invokeCacheCount, clazz->invokeCache)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2MjUxNg=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3NzAzNw==", "bodyText": "created #11168 to track this cleanup work", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522377037", "createdAt": "2020-11-12T19:45:56Z", "author": {"login": "fengxue-IS"}, "path": "runtime/gc_structs/ClassIterator.hpp", "diffHunk": "@@ -85,7 +85,11 @@ class GC_ClassIterator {\n \t\t, _classStaticsIterator(env, clazz)\n \t\t, _constantPoolObjectSlotIterator((J9JavaVM *)env->getLanguageVM(), clazz)\n \t\t, _callSitesIterator(clazz)\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t\t, _methodTypesIterator(clazz->romClass->invokeCacheCount, clazz->invokeCache)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2MjUxNg=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjE5NDQwOnYy", "diffSide": "RIGHT", "path": "runtime/oti/j9nonbuilder.h", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjoyOTowMFrOHu05eQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzowMToyNVrOHyEhWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2MzIyNQ==", "bodyText": "Why both resolveInvokeHandle and sendResolveOpenJDKInvokeHandle?  If they are related, shouldn't the names both include OpenJDK?", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518863225", "createdAt": "2020-11-06T16:29:00Z", "author": {"login": "DanHeidinga"}, "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -4559,8 +4575,10 @@ typedef struct J9InternalVMFunctions {\n \tvoid  (JNICALL *sendForGenericInvoke)(struct J9VMThread *vmThread, j9object_t methodHandle, j9object_t methodType, UDATA dropFirstArg) ;\n \tvoid  (JNICALL *jitFillOSRBuffer)(struct J9VMThread *vmContext, void *osrBlock) ;\n \tvoid  (JNICALL *sendResolveMethodHandle)(struct J9VMThread *vmThread, UDATA cpIndex, J9ConstantPool *ramCP, J9Class *definingClass, J9ROMNameAndSignature* nameAndSig) ;\n+\tj9object_t ( *resolveInvokeHandle)(struct J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags) ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2NDkyMQ==", "bodyText": "fixed naming to both include OpenJDK", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522264921", "createdAt": "2020-11-12T17:01:25Z", "author": {"login": "fengxue-IS"}, "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -4559,8 +4575,10 @@ typedef struct J9InternalVMFunctions {\n \tvoid  (JNICALL *sendForGenericInvoke)(struct J9VMThread *vmThread, j9object_t methodHandle, j9object_t methodType, UDATA dropFirstArg) ;\n \tvoid  (JNICALL *jitFillOSRBuffer)(struct J9VMThread *vmContext, void *osrBlock) ;\n \tvoid  (JNICALL *sendResolveMethodHandle)(struct J9VMThread *vmThread, UDATA cpIndex, J9ConstantPool *ramCP, J9Class *definingClass, J9ROMNameAndSignature* nameAndSig) ;\n+\tj9object_t ( *resolveInvokeHandle)(struct J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags) ;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2MzIyNQ=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjIyOTc3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/BytecodeInterpreter.hpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjozODowNlrOHu1Pkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzowMTo0OFrOHyEiaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2ODg4Mg==", "bodyText": "Can you add a comment like this to the code?  It makes it clear what the data we're working with is\n/* Fetch the method to call and add the \"appendix\" arg from the invokeCacheArray.\n * The stack transition looks like:\n * args  <- SP\n * MH\n *\n * and becomes:\n * invokeCacheArray[1] \"appendix\" <- SP\n * args\n * MH\n *\n * and sendMethod is ((j.l.MemberName)invokeCacheArray[0]).vmtargetOffset\n */", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518868882", "createdAt": "2020-11-06T16:38:06Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -8017,23 +8017,23 @@ class INTERPRETER_CLASS\n \t\tU_16 index = *(U_16 *)(_pc + 1);\n \n \t\tJ9ConstantPool *ramConstantPool = J9_CP_FROM_METHOD(_literals);\n-\t\tJ9InvokeCacheEntry *invokeCache = ((J9InvokeCacheEntry *)ramConstantPool->ramClass->callSites) + index;\n+\t\tj9object_t invokeCacheArray = (ramConstantPool->ramClass->callSites)[index];\n \n-\t\tj9object_t memberName = invokeCache->target;\n-\n-\t\tif (J9_EXPECTED(NULL != memberName)) {\n-\t\t\tif (J9OBJECT_CLAZZ(_currentThread, memberName) == J9VMJAVALANGINVOKEMEMBERNAME_OR_NULL(_vm)) {\n+\t\tif (J9_EXPECTED(NULL != invokeCacheArray)) {\n+\t\t\tJ9Class *clazz = J9OBJECT_CLAZZ(_currentThread, invokeCacheArray);\n+\t\t\tif (J9CLASS_IS_ARRAY(clazz)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2NTE5Mg==", "bodyText": "added comments", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522265192", "createdAt": "2020-11-12T17:01:48Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -8017,23 +8017,23 @@ class INTERPRETER_CLASS\n \t\tU_16 index = *(U_16 *)(_pc + 1);\n \n \t\tJ9ConstantPool *ramConstantPool = J9_CP_FROM_METHOD(_literals);\n-\t\tJ9InvokeCacheEntry *invokeCache = ((J9InvokeCacheEntry *)ramConstantPool->ramClass->callSites) + index;\n+\t\tj9object_t invokeCacheArray = (ramConstantPool->ramClass->callSites)[index];\n \n-\t\tj9object_t memberName = invokeCache->target;\n-\n-\t\tif (J9_EXPECTED(NULL != memberName)) {\n-\t\t\tif (J9OBJECT_CLAZZ(_currentThread, memberName) == J9VMJAVALANGINVOKEMEMBERNAME_OR_NULL(_vm)) {\n+\t\tif (J9_EXPECTED(NULL != invokeCacheArray)) {\n+\t\t\tJ9Class *clazz = J9OBJECT_CLAZZ(_currentThread, invokeCacheArray);\n+\t\t\tif (J9CLASS_IS_ARRAY(clazz)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg2ODg4Mg=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjI0MjE3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjo0MToyM1rOHu1XGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzowMjoyM1rOHyEkHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3MDgxMA==", "bodyText": "This should TrcAssert in the non OJDK MH case rather than return a nonsense (null) value", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518870810", "createdAt": "2020-11-06T16:41:23Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2086,54 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;\n+\t}\n+\n+\tTrc_VM_resolveInvokeHandle_Entry(vmThread, ramCP, cpIndex, resolveFlags);\n+\n+\tJ9ROMMethodRef *romMethodRef = (J9ROMMethodRef *)&ramCP->romConstantPool[cpIndex];\n+\tJ9ROMNameAndSignature *nameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\n+\t/* Resolve the class. */\n+\tJ9Class *resolvedClass = resolveClassRef(vmThread, ramCP, romMethodRef->classRefCPIndex, resolveFlags);\n+\tif (resolvedClass != NULL) {\n+\t\tsendResolveOpenJDKInvokeHandle(vmThread, ramCP, cpIndex, MH_REF_INVOKEVIRTUAL, resolvedClass, nameAndSig);\n+\t\tresult = (j9object_t)vmThread->returnValue;\n+\n+\t\tif (vmThread->currentException != NULL) {\n+\t\t\t/* Already a pending exception */\n+\t\t\tresult = NULL;\n+\t\t} else if (result == NULL) {\n+\t\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t\t} else {\n+\t\t\t/* Only write the value in if it is not null */\n+\t\t\tJ9MemoryManagerFunctions *gcFuncs = vmThread->javaVM->memoryManagerFunctions;\n+\t\t\tif (0 == gcFuncs->j9gc_objaccess_staticCompareAndSwapObject(vmThread, ramClass, invokeCache, NULL, result)) {\n+\t\t\t\t/* Another thread beat this thread to updating the call site, ensure both threads return the same method handle. */\n+\t\t\t\tresult = *invokeCache;\n+\t\t\t}\n+\t\t}\n+\t}\n+\tTrc_VM_resolveInvokeHandle_Exit(vmThread, result);\n+#endif /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 255}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2NTYzMQ==", "bodyText": "added Trc_VM_Assert_ShouldNeverHappen", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522265631", "createdAt": "2020-11-12T17:02:23Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2086,54 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+\tj9object_t result = NULL;\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;\n+\n+\tif (NULL != result) {\n+\t\treturn result;\n+\t} else if (!canRunJavaCode) {\n+\t\treturn NULL;\n+\t}\n+\n+\tTrc_VM_resolveInvokeHandle_Entry(vmThread, ramCP, cpIndex, resolveFlags);\n+\n+\tJ9ROMMethodRef *romMethodRef = (J9ROMMethodRef *)&ramCP->romConstantPool[cpIndex];\n+\tJ9ROMNameAndSignature *nameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\n+\t/* Resolve the class. */\n+\tJ9Class *resolvedClass = resolveClassRef(vmThread, ramCP, romMethodRef->classRefCPIndex, resolveFlags);\n+\tif (resolvedClass != NULL) {\n+\t\tsendResolveOpenJDKInvokeHandle(vmThread, ramCP, cpIndex, MH_REF_INVOKEVIRTUAL, resolvedClass, nameAndSig);\n+\t\tresult = (j9object_t)vmThread->returnValue;\n+\n+\t\tif (vmThread->currentException != NULL) {\n+\t\t\t/* Already a pending exception */\n+\t\t\tresult = NULL;\n+\t\t} else if (result == NULL) {\n+\t\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t\t} else {\n+\t\t\t/* Only write the value in if it is not null */\n+\t\t\tJ9MemoryManagerFunctions *gcFuncs = vmThread->javaVM->memoryManagerFunctions;\n+\t\t\tif (0 == gcFuncs->j9gc_objaccess_staticCompareAndSwapObject(vmThread, ramClass, invokeCache, NULL, result)) {\n+\t\t\t\t/* Another thread beat this thread to updating the call site, ensure both threads return the same method handle. */\n+\t\t\t\tresult = *invokeCache;\n+\t\t\t}\n+\t\t}\n+\t}\n+\tTrc_VM_resolveInvokeHandle_Exit(vmThread, result);\n+#endif /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3MDgxMA=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 255}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjI4NDQyOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjo1MjowNlrOHu1wwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjo1MjowNlrOHu1wwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3NzM3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tU_8 nameAndNAS[sizeof(J9ROMNameAndSignature) + (sizeof(U_16) + 16) + sizeof(J9UTF8)];\n          \n          \n            \n            \tU_8 nameAndNAS[sizeof(J9ROMNameAndSignature) + (sizeof(J9UTF8) * 2) + 16];", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518877377", "createdAt": "2020-11-06T16:52:06Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -496,7 +534,47 @@ resolveStaticMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA cp\n \tif (isResolvedClassAnInterface) {\n \t\tlookupOptions |= J9_LOOK_INTERFACE;\n \t}\n-\tmethod = (J9Method *)javaLookupMethod(vmStruct, resolvedClass, J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef), cpClass, lookupOptions);\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t/* Stack allocate a byte array for MethodHandle method name and signature. The array size is:\n+\t*  - J9ROMNameAndSignature\n+\t*  - Modified method name\n+\t*      - U_16 for J9UTF8 length\n+\t*      - 16 bytes for the original method name (\"linkToInterface\" is the longest)\n+\t*  - J9UTF8 for empty signature\n+\t*/\n+\tU_8 nameAndNAS[sizeof(J9ROMNameAndSignature) + (sizeof(U_16) + 16) + sizeof(J9UTF8)];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjI5NDI4OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjo1NDozOFrOHu125A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjo1NDozOFrOHu125A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3ODk0OA==", "bodyText": "Should this be 15?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t*      - 16 bytes for the original method name (\"linkToInterface\" is the longest)\n          \n          \n            \n            \t*      - 15 bytes for the original method name (\"linkToInterface\" is the longest)", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518878948", "createdAt": "2020-11-06T16:54:38Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -496,7 +534,47 @@ resolveStaticMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA cp\n \tif (isResolvedClassAnInterface) {\n \t\tlookupOptions |= J9_LOOK_INTERFACE;\n \t}\n-\tmethod = (J9Method *)javaLookupMethod(vmStruct, resolvedClass, J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef), cpClass, lookupOptions);\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t/* Stack allocate a byte array for MethodHandle method name and signature. The array size is:\n+\t*  - J9ROMNameAndSignature\n+\t*  - Modified method name\n+\t*      - U_16 for J9UTF8 length\n+\t*      - 16 bytes for the original method name (\"linkToInterface\" is the longest)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjMyNTcxOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzowMzo0M1rOHu2K7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzowMjozOVrOHyEk5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NDA3Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tU_8 nameAndNAS[sizeof(J9ROMNameAndSignature) + (sizeof(U_16) + 16) + sizeof(J9UTF8)];\n          \n          \n            \n            \tU_8 onStackNAS[sizeof(J9ROMNameAndSignature) + (sizeof(U_16) + 16) + sizeof(J9UTF8)];\n          \n      \n    \n    \n  \n\nnameAndNAS expands to nameAndNameAndSiguture which doesn't make sense.  Better to use the name to indicate why it's special", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518884076", "createdAt": "2020-11-06T17:03:43Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -496,7 +534,47 @@ resolveStaticMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA cp\n \tif (isResolvedClassAnInterface) {\n \t\tlookupOptions |= J9_LOOK_INTERFACE;\n \t}\n-\tmethod = (J9Method *)javaLookupMethod(vmStruct, resolvedClass, J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef), cpClass, lookupOptions);\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t/* Stack allocate a byte array for MethodHandle method name and signature. The array size is:\n+\t*  - J9ROMNameAndSignature\n+\t*  - Modified method name\n+\t*      - U_16 for J9UTF8 length\n+\t*      - 16 bytes for the original method name (\"linkToInterface\" is the longest)\n+\t*  - J9UTF8 for empty signature\n+\t*/\n+\tU_8 nameAndNAS[sizeof(J9ROMNameAndSignature) + (sizeof(U_16) + 16) + sizeof(J9UTF8)];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2NTgzMA==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522265830", "createdAt": "2020-11-12T17:02:39Z", "author": {"login": "fengxue-IS"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -496,7 +534,47 @@ resolveStaticMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA cp\n \tif (isResolvedClassAnInterface) {\n \t\tlookupOptions |= J9_LOOK_INTERFACE;\n \t}\n-\tmethod = (J9Method *)javaLookupMethod(vmStruct, resolvedClass, J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef), cpClass, lookupOptions);\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t/* Stack allocate a byte array for MethodHandle method name and signature. The array size is:\n+\t*  - J9ROMNameAndSignature\n+\t*  - Modified method name\n+\t*      - U_16 for J9UTF8 length\n+\t*      - 16 bytes for the original method name (\"linkToInterface\" is the longest)\n+\t*  - J9UTF8 for empty signature\n+\t*/\n+\tU_8 nameAndNAS[sizeof(J9ROMNameAndSignature) + (sizeof(U_16) + 16) + sizeof(J9UTF8)];", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NDA3Ng=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjM1NTk1OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzoxMjoxM1rOHu2dhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzoxMjoxM1rOHu2dhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4ODgzOQ==", "bodyText": "Have you looked at the J9_LOOK_DIRECT_NAS lookupOption?  It allows passing direct pointers which would be much simpler:\nThen the onStackNAS becomes\nU_8 onStackNAS[sizeof(J9NameAndSignature)];\nJ9UTF8 nullSignature = {0};\n\nand the assignment becomes:\nonStackNAS->name = nameAndSig->name;\nonStackNAS->signature = nullSignature;", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518888839", "createdAt": "2020-11-06T17:12:13Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -496,7 +534,47 @@ resolveStaticMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA cp\n \tif (isResolvedClassAnInterface) {\n \t\tlookupOptions |= J9_LOOK_INTERFACE;\n \t}\n-\tmethod = (J9Method *)javaLookupMethod(vmStruct, resolvedClass, J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef), cpClass, lookupOptions);\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t/* Stack allocate a byte array for MethodHandle method name and signature. The array size is:\n+\t*  - J9ROMNameAndSignature\n+\t*  - Modified method name\n+\t*      - U_16 for J9UTF8 length\n+\t*      - 16 bytes for the original method name (\"linkToInterface\" is the longest)\n+\t*  - J9UTF8 for empty signature\n+\t*/\n+\tU_8 nameAndNAS[sizeof(J9ROMNameAndSignature) + (sizeof(U_16) + 16) + sizeof(J9UTF8)];\n+\n+\tif (resolvedClass == J9VMJAVALANGINVOKEMETHODHANDLE(vmStruct->javaVM)) {\n+\t\tJ9UTF8 *nameUTF = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);\n+\t\t/**\n+\t\t * Check for MH intrinsic methods\n+\t\t *\n+\t\t * Modify the signature to avoid signature mismatch due to varargs\n+\t\t * These methods have special INL send targets\n+\t\t */\n+\t\tU_8* initialMethodName = J9UTF8_DATA(nameUTF);\n+\t\tU_16 initialMethodNameLength = J9UTF8_LENGTH(nameUTF);\n+\n+\t\tif (isMethodHandleINL(initialMethodName, initialMethodNameLength)) {\n+\t\t\tJ9UTF8 *modifiedMethodName = (J9UTF8 *)(nameAndNAS + sizeof(J9ROMNameAndSignature));\n+\t\t\tJ9UTF8 *modifiedMethodSig = (J9UTF8 *)(nameAndNAS + sizeof(nameAndNAS) - sizeof(J9UTF8));\n+\t\t\tmemset(nameAndNAS, 0, sizeof(nameAndNAS));\n+\n+\t\t\t/* Create new J9ROMNameAndSignature */\n+\t\t\tnameAndSig = (J9ROMNameAndSignature *)nameAndNAS;\n+\t\t\tNNSRP_SET(nameAndSig->name, modifiedMethodName);\n+\t\t\tNNSRP_SET(nameAndSig->signature, modifiedMethodSig);\n+\n+\t\t\tmodifiedMethodName->length = initialMethodNameLength;\n+\t\t\tmemcpy(modifiedMethodName->data, initialMethodName, initialMethodNameLength);\n+\n+\t\t\t/* Set flag for partial signature lookup. Signature length is already initialized to 0. */\n+\t\t\tlookupOptions |= J9_LOOK_PARTIAL_SIGNATURE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MjM2NDI3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzoxNDozNVrOHu2iqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzoxNDozNVrOHu2iqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg5MDE1NQ==", "bodyText": "Similar comment applies here as well about using DIRECT option.\nAlso, names like \"modifiedX\" should in some way, modify X.  Otherwise the code is confusing", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r518890155", "createdAt": "2020-11-06T17:14:35Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1368,18 +1446,46 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\tcpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(cpClass->romClass);\n \t\t\tlookupOptions |= J9_LOOK_CLCONSTRAINTS;\n \t\t}\n-\t\t\n-#if defined(J9VM_OPT_METHOD_HANDLE)\n-\t\t/*\n-\t\t * Check for MH.invoke and MH.invokeExact.\n-\t\t *\n-\t\t * Methodrefs corresponding to those methods already have their methodIndex set to index into\n-\t\t * cpClass->methodTypes. We resolve them by calling into MethodType.fromMethodDescriptorString()\n-\t\t * and storing the result into the cpClass->methodTypes table.\n-\t\t */\n+\n+#if defined(J9VM_OPT_METHOD_HANDLE) || defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n \t\tif ((NULL != cpShapeDescription)\n \t\t&& (resolvedClass == J9VMJAVALANGINVOKEMETHODHANDLE(vm))\n \t\t) {\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t\t\t/**\n+\t\t\t * Check for MH intrinsic methods\n+\t\t\t *\n+\t\t\t * Modify the signature to avoid signature mismatch due to varargs\n+\t\t\t * These methods have special INL send targets\n+\t\t\t */\n+\t\t\tJ9UTF8 *nameUTF = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);\n+\t\t\tU_8* initialMethodName = J9UTF8_DATA(nameUTF);\n+\t\t\tU_16 initialMethodNameLength = J9UTF8_LENGTH(nameUTF);\n+\n+\t\t\tif (isMethodHandleINL(initialMethodName, initialMethodNameLength)) {\n+\t\t\t\tJ9UTF8 *modifiedMethodName = (J9UTF8 *)(nameAndNAS + sizeof(J9ROMNameAndSignature));\n+\t\t\t\tJ9UTF8 *modifiedMethodSig = (J9UTF8 *)(nameAndNAS + sizeof(nameAndNAS) - sizeof(J9UTF8));\n+\t\t\t\tmemset(nameAndNAS, 0, sizeof(nameAndNAS));\n+\n+\t\t\t\t/* Create new J9ROMNameAndSignature */\n+\t\t\t\tnameAndSig = (J9ROMNameAndSignature *)nameAndNAS;\n+\t\t\t\tNNSRP_SET(nameAndSig->name, modifiedMethodName);\n+\t\t\t\tNNSRP_SET(nameAndSig->signature, modifiedMethodSig);\n+\n+\t\t\t\tmodifiedMethodName->length = initialMethodNameLength;\n+\t\t\t\tmemcpy(modifiedMethodName->data, initialMethodName, initialMethodNameLength);\n+\n+\t\t\t\t/* Set flag for partial signature lookup. Signature length is already initialized to 0. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 164}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MzcxNzIxOnYy", "diffSide": "RIGHT", "path": "runtime/codert_vm/cnathelp.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMzo0ODoyOFrOHvDC4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNzowMjo1NFrOHyElug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA5NTAwOQ==", "bodyText": "JIT expects this helper to return the address of the entry, not the content of the entry. See the current implementation.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r519095009", "createdAt": "2020-11-07T03:48:28Z", "author": {"login": "liqunl"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -2325,6 +2325,26 @@ old_slow_jitResolveHandleMethod(J9VMThread *currentThread)\n \tDECLARE_JIT_PARM(void*, jitEIP, 3);\n \tvoid *addr = NULL;\n \tJ9JavaVM *vm = currentThread->javaVM;\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tJ9RAMMethodRef *ramMethodRef = ((J9RAMMethodRef*)ramConstantPool) + cpIndex;\n+\tUDATA invokeCacheIndex = ramMethodRef->methodIndexAndArgCount >> 8;\n+retry:\n+\tj9object_t invokeCacheArray = (J9_CLASS_FROM_CP(ramConstantPool)->invokeCache)[invokeCacheIndex];\n+\tif (NULL == invokeCacheArray) {\n+\t\tbuildJITResolveFrameWithPC(currentThread, J9_SSF_JIT_RESOLVE_DATA, parmCount, true, 0, jitEIP);\n+\t\t/* add new resolve code which calls sendResolveInvokeHandle -> MHN.linkMethod()\n+\t\t * store the memberName/appendix values in invokeCache[invokeCacheIndex]\n+\t\t */\n+\t\tvm->internalVMFunctions->resolveInvokeHandle(currentThread, ramConstantPool, cpIndex, J9_RESOLVE_FLAG_RUNTIME_RESOLVE);\n+\t\taddr = restoreJITResolveFrame(currentThread, jitEIP);\n+\t\tif (NULL != addr) {\n+\t\t\tgoto done;\n+\t\t}\n+\t\tgoto retry;\n+\t}\n+\tJIT_RETURN_UDATA(invokeCacheArray);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2NjA0Mg==", "bodyText": "fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522266042", "createdAt": "2020-11-12T17:02:54Z", "author": {"login": "fengxue-IS"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -2325,6 +2325,26 @@ old_slow_jitResolveHandleMethod(J9VMThread *currentThread)\n \tDECLARE_JIT_PARM(void*, jitEIP, 3);\n \tvoid *addr = NULL;\n \tJ9JavaVM *vm = currentThread->javaVM;\n+\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tJ9RAMMethodRef *ramMethodRef = ((J9RAMMethodRef*)ramConstantPool) + cpIndex;\n+\tUDATA invokeCacheIndex = ramMethodRef->methodIndexAndArgCount >> 8;\n+retry:\n+\tj9object_t invokeCacheArray = (J9_CLASS_FROM_CP(ramConstantPool)->invokeCache)[invokeCacheIndex];\n+\tif (NULL == invokeCacheArray) {\n+\t\tbuildJITResolveFrameWithPC(currentThread, J9_SSF_JIT_RESOLVE_DATA, parmCount, true, 0, jitEIP);\n+\t\t/* add new resolve code which calls sendResolveInvokeHandle -> MHN.linkMethod()\n+\t\t * store the memberName/appendix values in invokeCache[invokeCacheIndex]\n+\t\t */\n+\t\tvm->internalVMFunctions->resolveInvokeHandle(currentThread, ramConstantPool, cpIndex, J9_RESOLVE_FLAG_RUNTIME_RESOLVE);\n+\t\taddr = restoreJITResolveFrame(currentThread, jitEIP);\n+\t\tif (NULL != addr) {\n+\t\t\tgoto done;\n+\t\t}\n+\t\tgoto retry;\n+\t}\n+\tJIT_RETURN_UDATA(invokeCacheArray);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA5NTAwOQ=="}, "originalCommit": {"oid": "8e73fef7ab57e3a2dcfc5db142f359db0017110d"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDcyNjMyOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo1NDowN1rOHyJFsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo1NDowN1rOHyJFsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzOTc2MA==", "bodyText": "Does this need to be indented 1 more level to match the surrounding code?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tTrc_VM_Assert_ShouldNeverHappen();\n          \n          \n            \n            \t\tTrc_VM_Assert_ShouldNeverHappen();", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522339760", "createdAt": "2020-11-12T18:54:07Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1611,7 +1700,9 @@ resolveVirtualMethodRefInto(J9VMThread *vmStruct, J9ConstantPool *ramCP, UDATA c\n \t\t\t\t}\n \t\t\t}\n \t\t}\n-#endif /* J9VM_OPT_METHOD_HANDLE */\n+#else /* defined(J9VM_OPT_METHOD_HANDLE) */\n+\tTrc_VM_Assert_ShouldNeverHappen();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "391f18782ef6e527650df5ea53b59748555d082e"}, "originalPosition": 195}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDcyOTY0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo1NDo1NlrOHyJHwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo1NTozNFrOHyJJPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0MDI4OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tresult = *invokeCache;\n          \n          \n            \n            \tj9object_t result = *invokeCache;", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522340288", "createdAt": "2020-11-12T18:54:56Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2070,55 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveOpenJDKInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tj9object_t result = NULL;\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "391f18782ef6e527650df5ea53b59748555d082e"}, "originalPosition": 223}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0MDY3MQ==", "bodyText": "Declare the local here and it only has 1 value - no need to reason about where the original NULL leaks to", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522340671", "createdAt": "2020-11-12T18:55:34Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -1979,6 +2070,55 @@ resolveMethodHandleRef(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \n }\n \n+j9object_t\n+resolveOpenJDKInvokeHandle(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpIndex, UDATA resolveFlags)\n+{\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\tj9object_t result = NULL;\n+\tbool canRunJavaCode = J9_ARE_NO_BITS_SET(resolveFlags, J9_RESOLVE_FLAG_JIT_COMPILE_TIME | J9_RESOLVE_FLAG_REDEFINE_CLASS);\n+\tJ9RAMMethodRef *ramCPEntry = (J9RAMMethodRef*)ramCP + cpIndex;\n+\tUDATA invokeCacheIndex = ramCPEntry->methodIndexAndArgCount >> 8;\n+\tJ9Class *ramClass = J9_CLASS_FROM_CP(ramCP);\n+\tj9object_t *invokeCache = ramClass->invokeCache + invokeCacheIndex;\n+\tresult = *invokeCache;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0MDI4OA=="}, "originalCommit": {"oid": "391f18782ef6e527650df5ea53b59748555d082e"}, "originalPosition": 223}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDc1MjczOnYy", "diffSide": "RIGHT", "path": "runtime/vm/resolvesupport.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTowMToxMFrOHyJWCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTowMToxMFrOHyJWCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0Mzk0Nw==", "bodyText": "Is there a } missing here?  The indentation doesn't match the if (NULL == result) { statement.", "url": "https://github.com/eclipse-openj9/openj9/pull/10893#discussion_r522343947", "createdAt": "2020-11-12T19:01:10Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/resolvesupport.cpp", "diffHunk": "@@ -2100,61 +2240,81 @@ resolveConstantDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA cpInde\n \treturn value;\n }\n \n-j9object_t   \n+j9object_t\n resolveInvokeDynamic(J9VMThread *vmThread, J9ConstantPool *ramCP, UDATA callSiteIndex, UDATA resolveFlags)\n {\n \tAssert_VM_true(J9_RESOLVE_FLAG_RUNTIME_RESOLVE == resolveFlags);\n \tj9object_t *callSite = ramCP->ramClass->callSites + callSiteIndex;\n-\tj9object_t methodHandle = *callSite;\n+\tj9object_t result = *callSite;\n \n \tJ9ROMClass *romClass = ramCP->ramClass->romClass;\n \tJ9SRP *callSiteData = (J9SRP *) J9ROMCLASS_CALLSITEDATA(romClass);\n \tU_16 *bsmIndices = (U_16 *) (callSiteData + romClass->callSiteCount);\n \tU_16 *bsmData = bsmIndices + romClass->callSiteCount;\n \tJ9ROMNameAndSignature* nameAndSig = SRP_PTR_GET(callSiteData + callSiteIndex, J9ROMNameAndSignature*);\n \tU_16 bsmIndex = bsmIndices[callSiteIndex];\n-\tU_16 i;\n+\tU_16 i = 0;\n+\n+\tTrc_VM_resolveInvokeDynamic_Entry(vmThread, callSiteIndex, bsmIndex, resolveFlags);\n \n \t/* Check if already resolved */\n-\tif (methodHandle != NULL) {\n-\t\treturn methodHandle;\n-\t}\n+\tif (NULL == result) {\n+\t\t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n+\t\tfor (i = 0; i < bsmIndex; i++) {\n+\t\t\t/* increment by size of bsm data plus header */\n+\t\t\tbsmData += bsmData[1] + 2;\n+\t\t}\n \n-\t/* Walk bsmData - skip all bootstrap methods before bsmIndex */\n-\tfor (i = 0; i < bsmIndex; i++) {\n-\t\t/* increment by size of bsm data plus header */\n-\t\tbsmData += bsmData[1] + 2;\n-\t}\n+\t\tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n+\t\tresult = (j9object_t) vmThread->returnValue;\n \n-\tsendResolveInvokeDynamic(vmThread, ramCP, callSiteIndex, nameAndSig, bsmData);\n-\tmethodHandle = (j9object_t) vmThread->returnValue;\n+\t\tTrc_VM_resolveInvokeDynamic_Resolved(vmThread, callSiteIndex, result);\n \n-\t/* check if an exception is already pending */\n-\tif (vmThread->currentException != NULL) {\n-\t\t/* Already a pending exception */\n-\t\tmethodHandle = NULL;\n-\t} else if (methodHandle == NULL) {\n-\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n-\t}\n-\n-\t/* Only write the value in if its not null */\n-\tif (NULL != methodHandle) {\n-\t\tJ9MemoryManagerFunctions *gcFuncs = vmThread->javaVM->memoryManagerFunctions;\n-\t\tmethodHandle = gcFuncs->j9gc_objaccess_asConstantPoolObject(\n-\t\t\t\t\t\t\t\t\tvmThread,\n-\t\t\t\t\t\t\t\t\tmethodHandle,\n-\t\t\t\t\t\t\t\t\tJ9_GC_ALLOCATE_OBJECT_TENURED | J9_GC_ALLOCATE_OBJECT_NON_INSTRUMENTABLE | J9_GC_ALLOCATE_OBJECT_HASHED);\n-\n-\t\tif (NULL == methodHandle) {\n-\t\t\tsetHeapOutOfMemoryError(vmThread);\n-\t\t} else {\n+#if defined(J9VM_OPT_OPENJDK_METHODHANDLE)\n+\t\t/* Check if an exception is already pending */\n+\t\tif (vmThread->currentException != NULL) {\n+\t\t\t/* Already a pending exception */\n+\t\t\tresult = vmThread->currentException;\n+\t\t} else if (result == NULL) {\n+\t\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t\t} else { /* (result != NULL) */\n+\t\t\t/* Only write the value in if it is not null */\n+\t\t\tJ9MemoryManagerFunctions *gcFuncs = vmThread->javaVM->memoryManagerFunctions;\n \t\t\tJ9Class *j9class = J9_CLASS_FROM_CP(ramCP);\n-\t\t\tif (0 == gcFuncs->j9gc_objaccess_staticCompareAndSwapObject(vmThread, j9class, callSite, NULL, methodHandle)) {\n+\n+\t\t\t/* Ensure that result array elements are written before the array reference is stored */\n+\t\t\tVM_AtomicSupport::writeBarrier();\n+\t\t\tif (0 == gcFuncs->j9gc_objaccess_staticCompareAndSwapObject(vmThread, j9class, callSite, NULL, result)) {\n \t\t\t\t/* Another thread beat this thread to updating the call site, ensure both threads return the same method handle. */\n-\t\t\t\tmethodHandle = *callSite;\n+\t\t\t\tresult = *callSite;\n \t\t\t}\n \t\t}\n-\t}\n-\n-\treturn methodHandle;\n+#else /* defined(J9VM_OPT_OPENJDK_METHODHANDLE) */\n+\t\t/* Check if an exception is already pending */\n+\t\tif (vmThread->currentException != NULL) {\n+\t\t\t/* Already a pending exception */\n+\t\t\tresult = NULL;\n+\t\t} else if (result == NULL) {\n+\t\t\tsetCurrentExceptionUTF(vmThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t\t} else { /* (result != NULL) */\n+\t\t\t/* Only write the value in if it is not null */\n+\t\t\tJ9MemoryManagerFunctions *gcFuncs = vmThread->javaVM->memoryManagerFunctions;\n+\t\t\tresult = gcFuncs->j9gc_objaccess_asConstantPoolObject(\n+\t\t\t\t\t\t\t\t\t\tvmThread,\n+\t\t\t\t\t\t\t\t\t\tresult,\n+\t\t\t\t\t\t\t\t\t\tJ9_GC_ALLOCATE_OBJECT_TENURED | J9_GC_ALLOCATE_OBJECT_NON_INSTRUMENTABLE | J9_GC_ALLOCATE_OBJECT_HASHED);\n+\n+\t\t\tif (NULL == result) {\n+\t\t\t\tsetHeapOutOfMemoryError(vmThread);\n+\t\t\t} else {\n+\t\t\t\tJ9Class *j9class = J9_CLASS_FROM_CP(ramCP);\n+\t\t\t\tif (0 == gcFuncs->j9gc_objaccess_staticCompareAndSwapObject(vmThread, j9class, callSite, NULL, result)) {\n+\t\t\t\t\t/* Another thread beat this thread to updating the call site, ensure both threads return the same method handle. */\n+\t\t\t\t\tresult = *callSite;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "391f18782ef6e527650df5ea53b59748555d082e"}, "originalPosition": 379}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1156, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}