{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NjI2ODM2", "number": 9885, "title": "Close timing hole in System.exit", "bodyText": "#9867 introduced a very small window where user daemon threads would\nillegally be allowed to call System.exit while the VM is being\ndestroyed.\n[ci skip]\nSigned-off-by: Graham Chapman graham_chapman@ca.ibm.com", "createdAt": "2020-06-15T15:50:05Z", "url": "https://github.com/eclipse-openj9/openj9/pull/9885", "merged": true, "mergeCommit": {"oid": "ac6141ad13bd9bfa990c1c34a149bd64f33c1673"}, "closed": true, "closedAt": "2020-06-16T16:31:46Z", "author": {"login": "gacholio"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr2LwAAFqTQzMTU2ODY5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr2wZtAFqTQzMTYxMTI2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNTY4Njk1", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#pullrequestreview-431568695", "createdAt": "2020-06-16T14:32:32Z", "commit": {"oid": "17661d574ccce5be8e7bfc5253ae77e76c5b3527"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozMjozMlrOGkeSLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozMjozMlrOGkeSLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODA5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t * so setting the flag again below is harmless.\n          \n          \n            \n            \t\t\t * so setting the `J9_RUNTIME_EXIT_STARTED` flag again below is harmless.", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440898093", "createdAt": "2020-06-16T14:32:32Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -506,22 +506,30 @@ void OMRNORETURN exitJavaVM(J9VMThread * vmThread, IDATA rc)\n \t\t\tomrthread_monitor_enter(mutex);\n \t\t}\n \n-\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers on exit - exit\n-\t\t * must be allowed in this case. CLEANUP will only ever be set once EXIT_STARTED has\n-\t\t * been set, so setting the flag again below is harmless.\n-\t\t */\n-\t\tif (J9_RUNTIME_EXIT_STARTED == (vm->runtimeFlags & (J9_RUNTIME_EXIT_STARTED | J9_RUNTIME_CLEANUP))) {\n-\t\t\tif (NULL != mutex) {\n-\t\t\t\tomrthread_monitor_exit(mutex);\n-\t\t\t}\n+\t\tif (J9_ARE_ANY_BITS_SET(vm->runtimeFlags, J9_RUNTIME_EXIT_STARTED)) {\n+\t\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers\n+\t\t\t * on exit - exit must be allowed in this case, but only from a finalizer\n+\t\t\t * thread (for simplicity, just check for a system thread as no other\n+\t\t\t * VM-owned threads will be attempting exit).\n+\t\t\t *\n+\t\t\t * CLEANUP will only ever be set once EXIT_STARTED has been set,\n+\t\t\t * so setting the flag again below is harmless.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17661d574ccce5be8e7bfc5253ae77e76c5b3527"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNTY5MTky", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#pullrequestreview-431569192", "createdAt": "2020-06-16T14:33:02Z", "commit": {"oid": "17661d574ccce5be8e7bfc5253ae77e76c5b3527"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozMzowMlrOGkeTug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozMzozMFrOGkeVLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODQ5MA==", "bodyText": "Mostly nitpick:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD) ||\n          \n          \n            \n            \t\t\t    J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)\n          \n          \n            \n            \t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD)\n          \n          \n            \n            \t\t\t|| J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440898490", "createdAt": "2020-06-16T14:33:02Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -506,22 +506,30 @@ void OMRNORETURN exitJavaVM(J9VMThread * vmThread, IDATA rc)\n \t\t\tomrthread_monitor_enter(mutex);\n \t\t}\n \n-\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers on exit - exit\n-\t\t * must be allowed in this case. CLEANUP will only ever be set once EXIT_STARTED has\n-\t\t * been set, so setting the flag again below is harmless.\n-\t\t */\n-\t\tif (J9_RUNTIME_EXIT_STARTED == (vm->runtimeFlags & (J9_RUNTIME_EXIT_STARTED | J9_RUNTIME_CLEANUP))) {\n-\t\t\tif (NULL != mutex) {\n-\t\t\t\tomrthread_monitor_exit(mutex);\n-\t\t\t}\n+\t\tif (J9_ARE_ANY_BITS_SET(vm->runtimeFlags, J9_RUNTIME_EXIT_STARTED)) {\n+\t\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers\n+\t\t\t * on exit - exit must be allowed in this case, but only from a finalizer\n+\t\t\t * thread (for simplicity, just check for a system thread as no other\n+\t\t\t * VM-owned threads will be attempting exit).\n+\t\t\t *\n+\t\t\t * CLEANUP will only ever be set once EXIT_STARTED has been set,\n+\t\t\t * so setting the flag again below is harmless.\n+\t\t\t */\n+\t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD) ||\n+\t\t\t    J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17661d574ccce5be8e7bfc5253ae77e76c5b3527"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODg2Mg==", "bodyText": "Do we not have a better way to ID finalizer threads?", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440898862", "createdAt": "2020-06-16T14:33:30Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -506,22 +506,30 @@ void OMRNORETURN exitJavaVM(J9VMThread * vmThread, IDATA rc)\n \t\t\tomrthread_monitor_enter(mutex);\n \t\t}\n \n-\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers on exit - exit\n-\t\t * must be allowed in this case. CLEANUP will only ever be set once EXIT_STARTED has\n-\t\t * been set, so setting the flag again below is harmless.\n-\t\t */\n-\t\tif (J9_RUNTIME_EXIT_STARTED == (vm->runtimeFlags & (J9_RUNTIME_EXIT_STARTED | J9_RUNTIME_CLEANUP))) {\n-\t\t\tif (NULL != mutex) {\n-\t\t\t\tomrthread_monitor_exit(mutex);\n-\t\t\t}\n+\t\tif (J9_ARE_ANY_BITS_SET(vm->runtimeFlags, J9_RUNTIME_EXIT_STARTED)) {\n+\t\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers\n+\t\t\t * on exit - exit must be allowed in this case, but only from a finalizer\n+\t\t\t * thread (for simplicity, just check for a system thread as no other\n+\t\t\t * VM-owned threads will be attempting exit).\n+\t\t\t *\n+\t\t\t * CLEANUP will only ever be set once EXIT_STARTED has been set,\n+\t\t\t * so setting the flag again below is harmless.\n+\t\t\t */\n+\t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD) ||\n+\t\t\t    J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODQ5MA=="}, "originalCommit": {"oid": "17661d574ccce5be8e7bfc5253ae77e76c5b3527"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "682594114f166e68f54da493915aba72b1bd02dc", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/682594114f166e68f54da493915aba72b1bd02dc", "committedDate": "2020-06-16T15:05:48Z", "message": "Close timing hole in System.exit\n\nillegally be allowed to call System.exit while the VM is being\ndestroyed.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7bc6c27ef2b55020ef5dc8c6b93371db95311262", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/7bc6c27ef2b55020ef5dc8c6b93371db95311262", "committedDate": "2020-06-16T14:59:32Z", "message": "Update runtime/vm/jvminit.c\n\nCo-authored-by: Dan Heidinga <daniel_heidinga@ca.ibm.com>"}, "afterCommit": {"oid": "682594114f166e68f54da493915aba72b1bd02dc", "author": {"user": {"login": "gacholio", "name": "Graham Chapman"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/682594114f166e68f54da493915aba72b1bd02dc", "committedDate": "2020-06-16T15:05:48Z", "message": "Close timing hole in System.exit\n\nillegally be allowed to call System.exit while the VM is being\ndestroyed.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNjExMjYw", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#pullrequestreview-431611260", "createdAt": "2020-06-16T15:12:34Z", "commit": {"oid": "682594114f166e68f54da493915aba72b1bd02dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 685, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}