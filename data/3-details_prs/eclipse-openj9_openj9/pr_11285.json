{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTg4OTA3", "number": 11285, "title": "Remove invalid shrc asserts during shutdown", "bodyText": "The asserts are accessing _readWriteProtectCntr without holding the\nappropriate mutex, the value can be modified by other threads. The value\ncan be greater than zero (or 1 in the z/OS case) if another thread has\nunprotected the read write area. Checking for equality with a particular\nvalue is invalid.\nRemoving the assert for _headerProtectCntr at the same time since it's\nnot providing much value.\nTesting shows _readWriteProtectCntr had a value of 1 before\nunprotectHeaderReadWriteArea(currentThread, false) was called, and\nreverts to zero after a delay.\nThe asserts occur during VM shutdown, which for the shared classes\ncomponent happens after the trace engine is shut down. The normal\nassertion behavior does not occur. If an assert fails the VM exits with\nreturn code 255 (-1) instead of zero.\nFixes #6361\nThe following grinder with the assert removed shows the cmdline tester is no longer failing the test due to a non-zero return code. It also shows the assert would have failed since_readWriteProtectCntr had a value of 1 before unprotectHeaderReadWriteArea(currentThread, false) was called, and later a value of zero after sleep(1), indicating another thread changed the value.\n\torgCntr = _readWriteProtectCntr;\n\tunprotectHeaderReadWriteArea(currentThread, false);\n\tif (_readWriteProtectCntr != 0) {\n\t\tj9tty_printf(PORTLIB, \"Assert _readWriteProtectCntr 0, org %zx _runtimeFlags %llx mprotect all %llx\\n\", orgCntr, *_runtimeFlags, *_runtimeFlags & J9SHR_RUNTIMEFLAG_ENABLE_MPROTECT_ALL);\n\t\tsleep(1);\n\t\tj9tty_printf(PORTLIB, \"_readWriteProtectCntr %zx\\n\", _readWriteProtectCntr);\n\t}\n\n10:30:19  Assert _readWriteProtectCntr 0, org 1 _runtimeFlags 80102001eca6229b mprotect all 0\n10:30:21  _readWriteProtectCntr 0\n\nhttps://ci.eclipse.org/openj9/view/Test/job/Grinder/1221", "createdAt": "2020-11-26T16:53:14Z", "url": "https://github.com/eclipse-openj9/openj9/pull/11285", "merged": true, "mergeCommit": {"oid": "2f4ea25a94c3d7792ff31ee26f05d0f2ae363118"}, "closed": true, "closedAt": "2020-11-26T21:29:00Z", "author": {"login": "pshipton"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgWPFcAFqTUzOTQ3NTg1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgYIAsgFqTUzOTUyMzMzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDc1ODU4", "url": "https://github.com/eclipse-openj9/openj9/pull/11285#pullrequestreview-539475858", "createdAt": "2020-11-26T17:17:06Z", "commit": {"oid": "8c06099a2c4f8b3d403bd7d8be52e4b8dbbaefbb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNzoxNzowN1rOH6jREQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNzoxNzowN1rOH6jREQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE1NzI2NQ==", "bodyText": "We may want to remove Trc_SHR_Assert_Equals(_headerProtectCntr, 1) 2 lines below as well.", "url": "https://github.com/eclipse-openj9/openj9/pull/11285#discussion_r531157265", "createdAt": "2020-11-26T17:17:07Z", "author": {"login": "hangshao0"}, "path": "runtime/shared_common/CompositeCache.cpp", "diffHunk": "@@ -3710,15 +3710,8 @@ SH_CompositeCacheImpl::runExitCode(J9VMThread *currentThread)\n \t * If not unprotected here, subsequent JVMs will not be able to write to readwrite area.\n \t */\n \tunprotectHeaderReadWriteArea(currentThread, true);\n-\tif (0 != (*_runtimeFlags & J9SHR_RUNTIMEFLAG_ENABLE_MPROTECT_ALL)) {\n-\t\t/* If mprotect=all is set, above call to unprotectHeaderReadWriteArea() will set _readWriteProtectCntr to 1. */\n-\t\tTrc_SHR_Assert_Equals(_readWriteProtectCntr, 1);\n-\t} else {\n-\t\tTrc_SHR_Assert_Equals(_readWriteProtectCntr, 0);\n-\t}\n #else\n \tunprotectHeaderReadWriteArea(currentThread, false);\n-\tTrc_SHR_Assert_Equals(_readWriteProtectCntr, 0);\n #endif\n \t/* If mprotect=all is not set, then final value of _headerProtectCntr should be same is its initial value (= 1).\n \t * If mprotect=all is set, then above call to unprotectHeaderReadWriteArea() will set it to 1.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c06099a2c4f8b3d403bd7d8be52e4b8dbbaefbb"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c06099a2c4f8b3d403bd7d8be52e4b8dbbaefbb", "author": {"user": {"login": "pshipton", "name": "Peter Shipton"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8c06099a2c4f8b3d403bd7d8be52e4b8dbbaefbb", "committedDate": "2020-11-26T15:56:40Z", "message": "Remove invalid shrc asserts during shutdown\n\nThe asserts are accessing _readWriteProtectCntr without holding the\nappropriate mutex, the value can be modified by other threads. The value\nof _readWriteProtectCntr can be greater than zero (or 1 in the z/OS\ncase) if another thread has unprotected the read write area. Checking\nfor equality with a particular value is invalid.\n\nTesting shows _readWriteProtectCntr had a value of 1 before\n`unprotectHeaderReadWriteArea(currentThread, false)` was called, and\nreverts to zero after a delay.\n\nThe asserts occur during VM shutdown, which for the shared classes\ncomponent happens after the trace engine is shut down. The normal\nassertion behavior does not occur. If an assert fails the VM exits with\nreturn code 255 (-1) instead of zero.\n\nIssue https://github.com/eclipse/openj9/issues/6361\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>"}, "afterCommit": {"oid": "b811aadeed608ddc297b73c0e38170b8a5121632", "author": {"user": {"login": "pshipton", "name": "Peter Shipton"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b811aadeed608ddc297b73c0e38170b8a5121632", "committedDate": "2020-11-26T17:23:16Z", "message": "Remove invalid shrc asserts during shutdown\n\nThe asserts are accessing _readWriteProtectCntr without holding the\nappropriate mutex, the value can be modified by other threads. The value\nof _readWriteProtectCntr can be greater than zero (or 1 in the z/OS\ncase) if another thread has unprotected the read write area. Checking\nfor equality with a particular value is invalid.\n\nTesting shows _readWriteProtectCntr had a value of 1 before\n`unprotectHeaderReadWriteArea(currentThread, false)` was called, and\nreverts to zero after a delay.\n\nThe asserts occur during VM shutdown, which for the shared classes\ncomponent happens after the trace engine is shut down. The normal\nassertion behavior does not occur. If an assert fails the VM exits with\nreturn code 255 (-1) instead of zero.\n\nIssue https://github.com/eclipse/openj9/issues/6361\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b811aadeed608ddc297b73c0e38170b8a5121632", "author": {"user": {"login": "pshipton", "name": "Peter Shipton"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b811aadeed608ddc297b73c0e38170b8a5121632", "committedDate": "2020-11-26T17:23:16Z", "message": "Remove invalid shrc asserts during shutdown\n\nThe asserts are accessing _readWriteProtectCntr without holding the\nappropriate mutex, the value can be modified by other threads. The value\nof _readWriteProtectCntr can be greater than zero (or 1 in the z/OS\ncase) if another thread has unprotected the read write area. Checking\nfor equality with a particular value is invalid.\n\nTesting shows _readWriteProtectCntr had a value of 1 before\n`unprotectHeaderReadWriteArea(currentThread, false)` was called, and\nreverts to zero after a delay.\n\nThe asserts occur during VM shutdown, which for the shared classes\ncomponent happens after the trace engine is shut down. The normal\nassertion behavior does not occur. If an assert fails the VM exits with\nreturn code 255 (-1) instead of zero.\n\nIssue https://github.com/eclipse/openj9/issues/6361\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>"}, "afterCommit": {"oid": "d9cd2c6261acaff8d300e711712b9183dcad8275", "author": {"user": {"login": "pshipton", "name": "Peter Shipton"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d9cd2c6261acaff8d300e711712b9183dcad8275", "committedDate": "2020-11-26T17:48:56Z", "message": "Remove invalid shrc asserts during shutdown\n\nThe asserts are accessing _readWriteProtectCntr or _headerProtectCntr\nwithout holding the appropriate mutex, the value can be modified by\nother threads. The value of these variables can be greater than zero (or\n1 in the z/OS case) if another thread has unprotected the read write\narea or header. Checking for equality with a particular value is\ninvalid.\n\nTesting shows _readWriteProtectCntr had a value of 1 before\n`unprotectHeaderReadWriteArea(currentThread, false)` was called, and\nreverts to zero after a delay.\n\nThe asserts occur during VM shutdown, which for the shared classes\ncomponent happens after the trace engine is shut down. The normal\nassertion behavior does not occur. If an assert fails the VM exits with\nreturn code 255 (-1) instead of zero.\n\nIssue https://github.com/eclipse/openj9/issues/6361\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f61c8c2ad5647430f8e453b76ea40225f84cd91", "author": {"user": {"login": "pshipton", "name": "Peter Shipton"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3f61c8c2ad5647430f8e453b76ea40225f84cd91", "committedDate": "2020-11-26T17:53:50Z", "message": "Remove invalid shrc asserts during shutdown\n\nThe asserts are accessing _readWriteProtectCntr without holding the\nappropriate mutex, the value can be modified by other threads. The value\ncan be greater than zero (or 1 in the z/OS case) if another thread has\nunprotected the read write area. Checking for equality with a particular\nvalue is invalid.\n\nRemoving the assert for _headerProtectCntr at the same time since it's\nnot providing much value.\n\nTesting shows _readWriteProtectCntr had a value of 1 before\n`unprotectHeaderReadWriteArea(currentThread, false)` was called, and\nreverts to zero after a delay.\n\nThe asserts occur during VM shutdown, which for the shared classes\ncomponent happens after the trace engine is shut down. The normal\nassertion behavior does not occur. If an assert fails the VM exits with\nreturn code 255 (-1) instead of zero.\n\nIssue https://github.com/eclipse/openj9/issues/6361\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9cd2c6261acaff8d300e711712b9183dcad8275", "author": {"user": {"login": "pshipton", "name": "Peter Shipton"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d9cd2c6261acaff8d300e711712b9183dcad8275", "committedDate": "2020-11-26T17:48:56Z", "message": "Remove invalid shrc asserts during shutdown\n\nThe asserts are accessing _readWriteProtectCntr or _headerProtectCntr\nwithout holding the appropriate mutex, the value can be modified by\nother threads. The value of these variables can be greater than zero (or\n1 in the z/OS case) if another thread has unprotected the read write\narea or header. Checking for equality with a particular value is\ninvalid.\n\nTesting shows _readWriteProtectCntr had a value of 1 before\n`unprotectHeaderReadWriteArea(currentThread, false)` was called, and\nreverts to zero after a delay.\n\nThe asserts occur during VM shutdown, which for the shared classes\ncomponent happens after the trace engine is shut down. The normal\nassertion behavior does not occur. If an assert fails the VM exits with\nreturn code 255 (-1) instead of zero.\n\nIssue https://github.com/eclipse/openj9/issues/6361\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>"}, "afterCommit": {"oid": "3f61c8c2ad5647430f8e453b76ea40225f84cd91", "author": {"user": {"login": "pshipton", "name": "Peter Shipton"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3f61c8c2ad5647430f8e453b76ea40225f84cd91", "committedDate": "2020-11-26T17:53:50Z", "message": "Remove invalid shrc asserts during shutdown\n\nThe asserts are accessing _readWriteProtectCntr without holding the\nappropriate mutex, the value can be modified by other threads. The value\ncan be greater than zero (or 1 in the z/OS case) if another thread has\nunprotected the read write area. Checking for equality with a particular\nvalue is invalid.\n\nRemoving the assert for _headerProtectCntr at the same time since it's\nnot providing much value.\n\nTesting shows _readWriteProtectCntr had a value of 1 before\n`unprotectHeaderReadWriteArea(currentThread, false)` was called, and\nreverts to zero after a delay.\n\nThe asserts occur during VM shutdown, which for the shared classes\ncomponent happens after the trace engine is shut down. The normal\nassertion behavior does not occur. If an assert fails the VM exits with\nreturn code 255 (-1) instead of zero.\n\nIssue https://github.com/eclipse/openj9/issues/6361\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTA4MjE4", "url": "https://github.com/eclipse-openj9/openj9/pull/11285#pullrequestreview-539508218", "createdAt": "2020-11-26T18:40:53Z", "commit": {"oid": "3f61c8c2ad5647430f8e453b76ea40225f84cd91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTIzMzMw", "url": "https://github.com/eclipse-openj9/openj9/pull/11285#pullrequestreview-539523330", "createdAt": "2020-11-26T19:29:17Z", "commit": {"oid": "3f61c8c2ad5647430f8e453b76ea40225f84cd91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1664, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}