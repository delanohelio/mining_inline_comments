{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwOTEzNjAw", "number": 8495, "reviewThreads": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNjoxMzoxM1rODdCY2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMjo0MzozNlrOD8dfmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNzc0NDI2OnYy", "diffSide": "RIGHT", "path": "runtime/vm/BytecodeInterpreter.hpp", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNjoxMzoxM1rOFlaIag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwMjo0Mjo1NVrOFpqJBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc2OTc3MA==", "bodyText": "Might be better to simply pass _currentThread to the message helper and let it fetch the data that's required.\nAlso need to verify that every path here has not incremented the pc (I suspect this is already true).", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r374769770", "createdAt": "2020-02-04T16:13:13Z", "author": {"login": "gacholio"}, "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -9621,6 +9623,13 @@ runMethodHandle: {\n \tVMStructHasBeenUpdated(REGISTER_ARGS);\n \tgoto throwCurrentException;\n \n+nullPointerWithExtendedMsg:\n+\tupdateVMStruct(REGISTER_ARGS);\n+\tprepareForExceptionThrow(_currentThread);\n+\tsetCurrentExceptionUTF(_currentThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, getExtendedNPEMessage(_currentThread, *_pc, *(U_16*)(_pc + 1), J9_CP_FROM_METHOD(_literals)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c712e3c2b3cffafe3a085eb8defac7879b87325"}, "originalPosition": 284}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1OTcwNw==", "bodyText": "prepareForExceptionThrow(_currentThread) could update _currentThread->_pc, hence getExtendedNPEMessage() can't retrieve current _pc value via _currentThread.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r374859707", "createdAt": "2020-02-04T18:56:14Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -9621,6 +9623,13 @@ runMethodHandle: {\n \tVMStructHasBeenUpdated(REGISTER_ARGS);\n \tgoto throwCurrentException;\n \n+nullPointerWithExtendedMsg:\n+\tupdateVMStruct(REGISTER_ARGS);\n+\tprepareForExceptionThrow(_currentThread);\n+\tsetCurrentExceptionUTF(_currentThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, getExtendedNPEMessage(_currentThread, *_pc, *(U_16*)(_pc + 1), J9_CP_FROM_METHOD(_literals)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc2OTc3MA=="}, "originalCommit": {"oid": "6c712e3c2b3cffafe3a085eb8defac7879b87325"}, "originalPosition": 284}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyNjM3NQ==", "bodyText": "@gacholio @DanHeidinga this is ready for review.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r379226375", "createdAt": "2020-02-14T02:42:55Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -9621,6 +9623,13 @@ runMethodHandle: {\n \tVMStructHasBeenUpdated(REGISTER_ARGS);\n \tgoto throwCurrentException;\n \n+nullPointerWithExtendedMsg:\n+\tupdateVMStruct(REGISTER_ARGS);\n+\tprepareForExceptionThrow(_currentThread);\n+\tsetCurrentExceptionUTF(_currentThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, getExtendedNPEMessage(_currentThread, *_pc, *(U_16*)(_pc + 1), J9_CP_FROM_METHOD(_literals)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc2OTc3MA=="}, "originalCommit": {"oid": "6c712e3c2b3cffafe3a085eb8defac7879b87325"}, "originalPosition": 284}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzI5ODc3OnYy", "diffSide": "LEFT", "path": "runtime/j9vm/j7vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo0MjoxOFrOFrN-Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMzo0NTozMFrOFraPLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MjAyNw==", "bodyText": "The benefit of this being a local var is that we knew what it meant.  Better than seeing 0, 1.  Can you restore this as and make it const?", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380862027", "createdAt": "2020-02-18T18:42:18Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/j7vmi.c", "diffHunk": "@@ -1358,13 +1358,11 @@ jint JNICALL\n JVM_GetStackTraceDepth(JNIEnv* env, jobject throwable)\n {\n \tJ9VMThread* currentThread = (J9VMThread*) env;\n-\tJ9JavaVM * vm = currentThread->javaVM;\n-\tJ9InternalVMFunctions * vmfns = vm->internalVMFunctions;\n-\tjint numberOfFrames;\n-\tUDATA pruneConstructors = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2Mjk1OQ==", "bodyText": "Got it, restored and made it const.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381062959", "createdAt": "2020-02-19T03:45:30Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/j7vmi.c", "diffHunk": "@@ -1358,13 +1358,11 @@ jint JNICALL\n JVM_GetStackTraceDepth(JNIEnv* env, jobject throwable)\n {\n \tJ9VMThread* currentThread = (J9VMThread*) env;\n-\tJ9JavaVM * vm = currentThread->javaVM;\n-\tJ9InternalVMFunctions * vmfns = vm->internalVMFunctions;\n-\tjint numberOfFrames;\n-\tUDATA pruneConstructors = 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MjAyNw=="}, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzMwMTY4OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/j9scar.tdf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo0MzoxNVrOFrOAOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMzo0NTo0NVrOFraPYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MjUyMQ==", "bodyText": "please add a new line to the end of the file", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380862521", "createdAt": "2020-02-18T18:43:15Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/j9scar.tdf", "diffHunk": "@@ -338,3 +338,8 @@ TraceEvent=Trc_SC_LoadSystemLibrary_LoadFailed NoEnv Overhead=1 Level=1 Template\n TraceEntry=Trc_SC_RegisterSignal_Entry Overhead=1 Level=1 Template=\"JVM_RegisterSignal(signal=%d, handler=%p)\"\n TraceExit=Trc_SC_RegisterSignal_Exit Overhead=1 Level=1 Template=\"JVM_RegisterSignal -- return old OS handler = %p\"\n TraceException=Trc_SC_RegisterSignal_FailedToRegisterHandler Overhead=1 Level=1 Template=\"Failed to register handler: OS signal value = %d, new signal handler = %p, old signal handler = %p\"\n+\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry2 Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEvent=Trc_SC_GetExtendedNPEMessage_NULLMETHODPC Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage iterateStackTrace returns a NULL methodPC.\"\n+TraceExit=Trc_SC_GetExtendedNPEMessage_Exit Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage returns msgObjectRef(%p)\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MzAxMA==", "bodyText": "Yeah, fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381063010", "createdAt": "2020-02-19T03:45:45Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/j9scar.tdf", "diffHunk": "@@ -338,3 +338,8 @@ TraceEvent=Trc_SC_LoadSystemLibrary_LoadFailed NoEnv Overhead=1 Level=1 Template\n TraceEntry=Trc_SC_RegisterSignal_Entry Overhead=1 Level=1 Template=\"JVM_RegisterSignal(signal=%d, handler=%p)\"\n TraceExit=Trc_SC_RegisterSignal_Exit Overhead=1 Level=1 Template=\"JVM_RegisterSignal -- return old OS handler = %p\"\n TraceException=Trc_SC_RegisterSignal_FailedToRegisterHandler Overhead=1 Level=1 Template=\"Failed to register handler: OS signal value = %d, new signal handler = %p, old signal handler = %p\"\n+\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry2 Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEvent=Trc_SC_GetExtendedNPEMessage_NULLMETHODPC Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage iterateStackTrace returns a NULL methodPC.\"\n+TraceExit=Trc_SC_GetExtendedNPEMessage_Exit Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage returns msgObjectRef(%p)\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MjUyMQ=="}, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzMwNzc0OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/j9scar.tdf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo0NTowM1rOFrOD8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMzo1MTo0NFrOFraUAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MzQ3Mw==", "bodyText": "Why are some of these level 3 vs 1?", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380863473", "createdAt": "2020-02-18T18:45:03Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/j9scar.tdf", "diffHunk": "@@ -338,3 +338,8 @@ TraceEvent=Trc_SC_LoadSystemLibrary_LoadFailed NoEnv Overhead=1 Level=1 Template\n TraceEntry=Trc_SC_RegisterSignal_Entry Overhead=1 Level=1 Template=\"JVM_RegisterSignal(signal=%d, handler=%p)\"\n TraceExit=Trc_SC_RegisterSignal_Exit Overhead=1 Level=1 Template=\"JVM_RegisterSignal -- return old OS handler = %p\"\n TraceException=Trc_SC_RegisterSignal_FailedToRegisterHandler Overhead=1 Level=1 Template=\"Failed to register handler: OS signal value = %d, new signal handler = %p, old signal handler = %p\"\n+\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry2 Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2NDE5Mw==", "bodyText": "Trc_SC_GetExtendedNPEMessage_Entry  is invoked for each JVM_GetExtendedNPEMessage(),\nTrc_SC_GetExtendedNPEMessage_Entry2 is invoked only when -XX:+ShowCodeDetailsInExceptionMessages is specified.\nThe thought was that Trc_SC_GetExtendedNPEMessage_Entry is the higher frequency tracepoint than Trc_SC_GetExtendedNPEMessage_Entry2.  The hot tracepoint is assigned with higher level, i.e., 3 while the lower frequency one is 1.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381064193", "createdAt": "2020-02-19T03:51:44Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/j9scar.tdf", "diffHunk": "@@ -338,3 +338,8 @@ TraceEvent=Trc_SC_LoadSystemLibrary_LoadFailed NoEnv Overhead=1 Level=1 Template\n TraceEntry=Trc_SC_RegisterSignal_Entry Overhead=1 Level=1 Template=\"JVM_RegisterSignal(signal=%d, handler=%p)\"\n TraceExit=Trc_SC_RegisterSignal_Exit Overhead=1 Level=1 Template=\"JVM_RegisterSignal -- return old OS handler = %p\"\n TraceException=Trc_SC_RegisterSignal_FailedToRegisterHandler Overhead=1 Level=1 Template=\"Failed to register handler: OS signal value = %d, new signal handler = %p, old signal handler = %p\"\n+\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry2 Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MzQ3Mw=="}, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzMwODk2OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/j9scar.tdf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo0NToyNVrOFrOErQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMzo0NjoxOFrOFraPyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MzY2MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            TraceEvent=Trc_SC_GetExtendedNPEMessage_NULLMETHODPC Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage iterateStackTrace returns a NULL methodPC.\"\n          \n          \n            \n            TraceEvent=Trc_SC_GetExtendedNPEMessage_NullMethodPC Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage iterateStackTrace returns a NULL methodPC.\"", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380863661", "createdAt": "2020-02-18T18:45:25Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/j9scar.tdf", "diffHunk": "@@ -338,3 +338,8 @@ TraceEvent=Trc_SC_LoadSystemLibrary_LoadFailed NoEnv Overhead=1 Level=1 Template\n TraceEntry=Trc_SC_RegisterSignal_Entry Overhead=1 Level=1 Template=\"JVM_RegisterSignal(signal=%d, handler=%p)\"\n TraceExit=Trc_SC_RegisterSignal_Exit Overhead=1 Level=1 Template=\"JVM_RegisterSignal -- return old OS handler = %p\"\n TraceException=Trc_SC_RegisterSignal_FailedToRegisterHandler Overhead=1 Level=1 Template=\"Failed to register handler: OS signal value = %d, new signal handler = %p, old signal handler = %p\"\n+\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry2 Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEvent=Trc_SC_GetExtendedNPEMessage_NULLMETHODPC Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage iterateStackTrace returns a NULL methodPC.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MzExMg==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381063112", "createdAt": "2020-02-19T03:46:18Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/j9scar.tdf", "diffHunk": "@@ -338,3 +338,8 @@ TraceEvent=Trc_SC_LoadSystemLibrary_LoadFailed NoEnv Overhead=1 Level=1 Template\n TraceEntry=Trc_SC_RegisterSignal_Entry Overhead=1 Level=1 Template=\"JVM_RegisterSignal(signal=%d, handler=%p)\"\n TraceExit=Trc_SC_RegisterSignal_Exit Overhead=1 Level=1 Template=\"JVM_RegisterSignal -- return old OS handler = %p\"\n TraceException=Trc_SC_RegisterSignal_FailedToRegisterHandler Overhead=1 Level=1 Template=\"Failed to register handler: OS signal value = %d, new signal handler = %p, old signal handler = %p\"\n+\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry2 Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEvent=Trc_SC_GetExtendedNPEMessage_NULLMETHODPC Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage iterateStackTrace returns a NULL methodPC.\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MzY2MQ=="}, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzM0NTYwOnYy", "diffSide": "RIGHT", "path": "runtime/nls/j9vm/j9vm.nls", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo1NjoxMFrOFrObCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMzo0Njo1MlrOFraQPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2OTM4NQ==", "bodyText": "I don't think these messages should be documented and we wouldn't want to use the message codes in the messages", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380869385", "createdAt": "2020-02-18T18:56:10Z", "author": {"login": "DanHeidinga"}, "path": "runtime/nls/j9vm/j9vm.nls", "diffHunk": "@@ -1953,3 +1953,94 @@ J9NLS_VM_CLASS_RELATIONSHIP_INVALID.explanation=The specified child class fails\n J9NLS_VM_CLASS_RELATIONSHIP_INVALID.system_action=The JVM will throw a java/lang/VerifyError.\n J9NLS_VM_CLASS_RELATIONSHIP_INVALID.user_response=Ensure that all class relationships are valid.\n # END NON-TRANSLATABLE\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MzIyOA==", "bodyText": "Sure, removed these NLS messages and put them directly in exceptionsupport.c.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381063228", "createdAt": "2020-02-19T03:46:52Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/nls/j9vm/j9vm.nls", "diffHunk": "@@ -1953,3 +1953,94 @@ J9NLS_VM_CLASS_RELATIONSHIP_INVALID.explanation=The specified child class fails\n J9NLS_VM_CLASS_RELATIONSHIP_INVALID.system_action=The JVM will throw a java/lang/VerifyError.\n J9NLS_VM_CLASS_RELATIONSHIP_INVALID.user_response=Ensure that all class relationships are valid.\n # END NON-TRANSLATABLE\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2OTM4NQ=="}, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzM0OTg1OnYy", "diffSide": "RIGHT", "path": "runtime/oti/vm_api.h", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxODo1NzoxN1rOFrOdkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMToyNzoyN1rOFr4O6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3MDAzNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, U_8 *methodPC, J9ConstantPool *constantPool, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors, U_32 nbrCacheItems);\n          \n          \n            \n            iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, U_8 *methodPC, J9ConstantPool *constantPool, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors, U_32 numCacheItems);", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380870034", "createdAt": "2020-02-18T18:57:17Z", "author": {"login": "DanHeidinga"}, "path": "runtime/oti/vm_api.h", "diffHunk": "@@ -554,10 +554,11 @@ internalExceptionDescribe(J9VMThread *vmThread);\n * @param lineNumber)\n * @param userData\n * @param pruneConstructors\n+* @param nbrCacheItems\n * @return UDATA\n */\n UDATA\n-iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors);\n+iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, U_8 *methodPC, J9ConstantPool *constantPool, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors, U_32 nbrCacheItems);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2NDI3MA==", "bodyText": "Fixed.\n@DanHeidinga please have another look.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381064270", "createdAt": "2020-02-19T03:52:10Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/oti/vm_api.h", "diffHunk": "@@ -554,10 +554,11 @@ internalExceptionDescribe(J9VMThread *vmThread);\n * @param lineNumber)\n * @param userData\n * @param pruneConstructors\n+* @param nbrCacheItems\n * @return UDATA\n */\n UDATA\n-iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors);\n+iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, U_8 *methodPC, J9ConstantPool *constantPool, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors, U_32 nbrCacheItems);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3MDAzNA=="}, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1NDQxMA==", "bodyText": "Just realized that iterateStackTrace() can't depend on the incoming numCacheItems to find the cached constantPool, otherwise there is a possibility that some iterateStackTrace() calls might not correctly iterate the walkback when NPE extended message is enabled with additional J9_STACKWALK_CACHE_CPS.\nAdded a helper method isNPEMsgEnabled() to determine if the constantPool entry presents or not.\nPlease review.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381554410", "createdAt": "2020-02-19T21:27:27Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/oti/vm_api.h", "diffHunk": "@@ -554,10 +554,11 @@ internalExceptionDescribe(J9VMThread *vmThread);\n * @param lineNumber)\n * @param userData\n * @param pruneConstructors\n+* @param nbrCacheItems\n * @return UDATA\n */\n UDATA\n-iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors);\n+iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, U_8 *methodPC, J9ConstantPool *constantPool, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors, U_32 nbrCacheItems);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3MDAzNA=="}, "originalCommit": {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4OTY5ODIzOnYy", "diffSide": "RIGHT", "path": "runtime/bcverify/bcverify.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwMToyOToyNlrOGM-lew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwMToyOTo0NlrOGM-lxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MTQ5OQ==", "bodyText": "Do not use ! on non-booleans - do the compare properly please, or create a boolean local.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r416261499", "createdAt": "2020-04-28T01:29:26Z", "author": {"login": "gacholio"}, "path": "runtime/bcverify/bcverify.c", "diffHunk": "@@ -2404,15 +2397,20 @@ j9bcv_verifyBytecodes (J9PortLibrary * portLib, J9Class * clazz, J9ROMClass * ro\n \n \tromMethod = (J9ROMMethod *) J9ROMCLASS_ROMMETHODS(romClass);\n \n-\tif (verboseVerification) {\n+\tif (verboseVerification && !isNPEMsg) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MTU3NA==", "bodyText": "Nevermind, I can't read.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r416261574", "createdAt": "2020-04-28T01:29:46Z", "author": {"login": "gacholio"}, "path": "runtime/bcverify/bcverify.c", "diffHunk": "@@ -2404,15 +2397,20 @@ j9bcv_verifyBytecodes (J9PortLibrary * portLib, J9Class * clazz, J9ROMClass * ro\n \n \tromMethod = (J9ROMMethod *) J9ROMCLASS_ROMMETHODS(romClass);\n \n-\tif (verboseVerification) {\n+\tif (verboseVerification && !isNPEMsg) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MTQ5OQ=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5Njk3OTY3OnYy", "diffSide": "RIGHT", "path": "runtime/bcverify/rtverify.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDo1NzozNFrOGODBTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowNzo1NVrOGOIoCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4MjczMw==", "bodyText": "returning -> returned", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417382733", "createdAt": "2020-04-29T14:57:34Z", "author": {"login": "gacholio"}, "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -401,17 +400,187 @@ matchStack(J9BytecodeVerificationData * verifyData, J9BranchTargetStack *liveSta\n \tgoto _finished;\n }\n \n-\n-/* \n-\tWalk the bytecodes linearly and verify that the recorded stack maps match.\n-\n-\treturns BCV_SUCCESS on success\n-\treturns BCV_ERR_INTERNAL_ERROR on verification error\n-\treturns BCV_ERR_INSUFFICIENT_MEMORY on OOM\n+/**\n+* Return an extended NPE message.\n+*\n+* Note: the caller is responsible for freeing the returning string if it is not NULL.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDU3MA==", "bodyText": "fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417474570", "createdAt": "2020-04-29T17:07:55Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -401,17 +400,187 @@ matchStack(J9BytecodeVerificationData * verifyData, J9BranchTargetStack *liveSta\n \tgoto _finished;\n }\n \n-\n-/* \n-\tWalk the bytecodes linearly and verify that the recorded stack maps match.\n-\n-\treturns BCV_SUCCESS on success\n-\treturns BCV_ERR_INTERNAL_ERROR on verification error\n-\treturns BCV_ERR_INSUFFICIENT_MEMORY on OOM\n+/**\n+* Return an extended NPE message.\n+*\n+* Note: the caller is responsible for freeing the returning string if it is not NULL.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4MjczMw=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5Njk4MzA1OnYy", "diffSide": "RIGHT", "path": "runtime/bcverify/rtverify.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDo1ODoxM1rOGODDbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowODowNlrOGOIoZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4MzI3Ng==", "bodyText": "The \"part 2\" is confusing, and please don't mention \"another PR\".", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417383276", "createdAt": "2020-04-29T14:58:13Z", "author": {"login": "gacholio"}, "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -401,17 +400,187 @@ matchStack(J9BytecodeVerificationData * verifyData, J9BranchTargetStack *liveSta\n \tgoto _finished;\n }\n \n-\n-/* \n-\tWalk the bytecodes linearly and verify that the recorded stack maps match.\n-\n-\treturns BCV_SUCCESS on success\n-\treturns BCV_ERR_INTERNAL_ERROR on verification error\n-\treturns BCV_ERR_INSUFFICIENT_MEMORY on OOM\n+/**\n+* Return an extended NPE message.\n+*\n+* Note: the caller is responsible for freeing the returning string if it is not NULL.\n+*\n+* @param vmThread The current J9VMThread\n+* @param bcCurrentPtr The pointer to the bytecode being executed and caused the NPE\n+* @param romClass The romClass of the bytecode\n+* @param constantPool The J9RomClass constant pool for the romClass\n+* @param npeCauseMsg The extended NPE message part 2 (to be provided by another PR)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDY2MQ==", "bodyText": "fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417474661", "createdAt": "2020-04-29T17:08:06Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -401,17 +400,187 @@ matchStack(J9BytecodeVerificationData * verifyData, J9BranchTargetStack *liveSta\n \tgoto _finished;\n }\n \n-\n-/* \n-\tWalk the bytecodes linearly and verify that the recorded stack maps match.\n-\n-\treturns BCV_SUCCESS on success\n-\treturns BCV_ERR_INTERNAL_ERROR on verification error\n-\treturns BCV_ERR_INSUFFICIENT_MEMORY on OOM\n+/**\n+* Return an extended NPE message.\n+*\n+* Note: the caller is responsible for freeing the returning string if it is not NULL.\n+*\n+* @param vmThread The current J9VMThread\n+* @param bcCurrentPtr The pointer to the bytecode being executed and caused the NPE\n+* @param romClass The romClass of the bytecode\n+* @param constantPool The J9RomClass constant pool for the romClass\n+* @param npeCauseMsg The extended NPE message part 2 (to be provided by another PR)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4MzI3Ng=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NzAxMjEwOnYy", "diffSide": "LEFT", "path": "runtime/bcverify/rtverify.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTowNDozNlrOGODWKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNToxMTowOFrOGODpEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4ODA3Mg==", "bodyText": "Looks like you've lost the comment for verifyBytecodes.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417388072", "createdAt": "2020-04-29T15:04:36Z", "author": {"login": "gacholio"}, "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -401,17 +400,187 @@ matchStack(J9BytecodeVerificationData * verifyData, J9BranchTargetStack *liveSta\n \tgoto _finished;\n }\n \n-\n-/* \n-\tWalk the bytecodes linearly and verify that the recorded stack maps match.\n-\n-\treturns BCV_SUCCESS on success\n-\treturns BCV_ERR_INTERNAL_ERROR on verification error\n-\treturns BCV_ERR_INSUFFICIENT_MEMORY on OOM", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5MjkxMg==", "bodyText": "Nevermind, I see it in the header now.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417392912", "createdAt": "2020-04-29T15:11:08Z", "author": {"login": "gacholio"}, "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -401,17 +400,187 @@ matchStack(J9BytecodeVerificationData * verifyData, J9BranchTargetStack *liveSta\n \tgoto _finished;\n }\n \n-\n-/* \n-\tWalk the bytecodes linearly and verify that the recorded stack maps match.\n-\n-\treturns BCV_SUCCESS on success\n-\treturns BCV_ERR_INTERNAL_ERROR on verification error\n-\treturns BCV_ERR_INSUFFICIENT_MEMORY on OOM", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4ODA3Mg=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NzAxNjYzOnYy", "diffSide": "RIGHT", "path": "runtime/bcverify/rtverify.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTowNTo0NVrOGODZOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNjoxODoxNFrOGOGopw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4ODg1OQ==", "bodyText": "Why >= ? Should this not be == ?", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417388859", "createdAt": "2020-04-29T15:05:45Z", "author": {"login": "gacholio"}, "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -526,6 +714,11 @@ verifyBytecodes (J9BytecodeVerificationData * verifyData)\n \n \t/* walk the bytecodes linearly */\n \twhile (pc < length) {\n+\t\tif (isNPEMsg && pc >= npePC) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 337}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ0MTk1OQ==", "bodyText": "There are cases that the pc might be increased beyond npePC such as the case of JBinvokeinterface2 right before the bytecode at npePC. https://github.com/eclipse/openj9/blob/9edff1b76ed55c0e40efb801dc83bc0a5b7c0a24/runtime/bcverify/rtverify.c#L623 increases current pc by 5 hence more than npePC.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417441959", "createdAt": "2020-04-29T16:18:14Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -526,6 +714,11 @@ verifyBytecodes (J9BytecodeVerificationData * verifyData)\n \n \t/* walk the bytecodes linearly */\n \twhile (pc < length) {\n+\t\tif (isNPEMsg && pc >= npePC) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4ODg1OQ=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 337}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NzAyMjc0OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/javanextvmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTowNzowMlrOGODc6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowODoxN1rOGOIo4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTgwMg==", "bodyText": "Blank line please.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417389802", "createdAt": "2020-04-29T15:07:02Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDc4Nw==", "bodyText": "added.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417474787", "createdAt": "2020-04-29T17:08:17Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTgwMg=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NzAyMjk5OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/javanextvmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTowNzowOVrOGODdJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowODoyOVrOGOIpXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTg2MA==", "bodyText": "Blank line please.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417389860", "createdAt": "2020-04-29T15:07:09Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDkwOQ==", "bodyText": "Added.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417474909", "createdAt": "2020-04-29T17:08:29Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTg2MA=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NzAyODc1OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/javanextvmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTowODozMVrOGODg2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowOToyM1rOGOIrtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5MDgxMQ==", "bodyText": "Comment seems misplaced.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417390811", "createdAt": "2020-04-29T15:08:31Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0}; /* only first frame is needed */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NTUwOA==", "bodyText": "Removed. (there is already such a comment in getStackTraceElementIterator)", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417475508", "createdAt": "2020-04-29T17:09:23Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0}; /* only first frame is needed */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5MDgxMQ=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NzAzNDQxOnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/javanextvmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTowOTo0MlrOGODkgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowOTozNlrOGOIsMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5MTc0Ng==", "bodyText": "This needs to be null-checked.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417391746", "createdAt": "2020-04-29T15:09:42Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0}; /* only first frame is needed */\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass) && (NULL != userData.romMethod) && (UDATA_MAX != userData.bytecodeOffset)) {\n+\t\t\tJ9BytecodeVerificationData *bcvd = vm->bytecodeVerificationData;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NTYzMw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417475633", "createdAt": "2020-04-29T17:09:36Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0}; /* only first frame is needed */\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass) && (NULL != userData.romMethod) && (UDATA_MAX != userData.bytecodeOffset)) {\n+\t\t\tJ9BytecodeVerificationData *bcvd = vm->bytecodeVerificationData;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5MTc0Ng=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NzA2OTAxOnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/javanextvmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNToxNjo0OVrOGOD51A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowOTo1MVrOGOIs4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5NzIwNA==", "bodyText": "This should move a bit further out - if the internal string allocation fails, you should also set this. Suggest moving to after the memory free.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417397204", "createdAt": "2020-04-29T15:16:49Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0}; /* only first frame is needed */\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass) && (NULL != userData.romMethod) && (UDATA_MAX != userData.bytecodeOffset)) {\n+\t\t\tJ9BytecodeVerificationData *bcvd = vm->bytecodeVerificationData;\n+\n+\t\t\tif (TrcEnabled_Trc_SC_GetExtendedNPEMessage_Dump_Bytecode) {\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tU_8 *bytecodes = J9_BYTECODE_START_FROM_ROM_METHOD(userData.romMethod);\n+\t\t\t\tU_32 flags = 0;\n+\n+#ifdef J9VM_ENV_LITTLE_ENDIAN\n+\t\t\t\tflags |= BCT_LittleEndianOutput;\n+#else\n+\t\t\t\tflags |= BCT_BigEndianOutput;\n+#endif\n+\t\t\t\tj9bcutil_dumpBytecodes(PORTLIB, userData.romClass, bytecodes, 0, userData.bytecodeOffset, flags, (void *)cfdumpBytecodePrintFunction, PORTLIB, \"\");\n+\t\t\t}\n+\t\t\tbcvd->vmStruct = vmThread;\n+\t\t\tj9bcv_verifyBytecodes(vm->portLibrary, NULL, userData.romClass, bcvd, userData.romMethod, userData.bytecodeOffset, &npeMsg);\n+\t\t\tif (NULL != npeMsg) {\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tj9object_t msgObject = vm->memoryManagerFunctions->j9gc_createJavaLangString(vmThread, (U_8 *)npeMsg, strlen(npeMsg), 0);\n+\t\t\t\tif (NULL != msgObject) {\n+\t\t\t\t\tmsgObjectRef = vmFuncs->j9jni_createLocalRef(env, msgObject);\n+\t\t\t\t\tif (NULL == msgObjectRef) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NTgwOQ==", "bodyText": "Agreed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417475809", "createdAt": "2020-04-29T17:09:51Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0}; /* only first frame is needed */\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass) && (NULL != userData.romMethod) && (UDATA_MAX != userData.bytecodeOffset)) {\n+\t\t\tJ9BytecodeVerificationData *bcvd = vm->bytecodeVerificationData;\n+\n+\t\t\tif (TrcEnabled_Trc_SC_GetExtendedNPEMessage_Dump_Bytecode) {\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tU_8 *bytecodes = J9_BYTECODE_START_FROM_ROM_METHOD(userData.romMethod);\n+\t\t\t\tU_32 flags = 0;\n+\n+#ifdef J9VM_ENV_LITTLE_ENDIAN\n+\t\t\t\tflags |= BCT_LittleEndianOutput;\n+#else\n+\t\t\t\tflags |= BCT_BigEndianOutput;\n+#endif\n+\t\t\t\tj9bcutil_dumpBytecodes(PORTLIB, userData.romClass, bytecodes, 0, userData.bytecodeOffset, flags, (void *)cfdumpBytecodePrintFunction, PORTLIB, \"\");\n+\t\t\t}\n+\t\t\tbcvd->vmStruct = vmThread;\n+\t\t\tj9bcv_verifyBytecodes(vm->portLibrary, NULL, userData.romClass, bcvd, userData.romMethod, userData.bytecodeOffset, &npeMsg);\n+\t\t\tif (NULL != npeMsg) {\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tj9object_t msgObject = vm->memoryManagerFunctions->j9gc_createJavaLangString(vmThread, (U_8 *)npeMsg, strlen(npeMsg), 0);\n+\t\t\t\tif (NULL != msgObject) {\n+\t\t\t\t\tmsgObjectRef = vmFuncs->j9jni_createLocalRef(env, msgObject);\n+\t\t\t\t\tif (NULL == msgObjectRef) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5NzIwNA=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NzA4Mjk3OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/javanextvmi.c", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNToxOTo0OFrOGOECng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowNzozNlrOGOInRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5OTQ1NA==", "bodyText": "What is the purpose of this? It's controlled by a tracepoint, which is very odd.\nIf this was just debug, I suggest you remove it as it's going to link in unnecessary code.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417399454", "createdAt": "2020-04-29T15:19:48Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ0NDY5Nw==", "bodyText": "It is used by the trace point to dump the bytecode. Removing it won't compile unless the trace point is removed as well.\nI can decorate the trace point along with this function with a debug define if the extra code is a concern.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417444697", "createdAt": "2020-04-29T16:22:14Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5OTQ1NA=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ1MDUwNQ==", "bodyText": "Please eliminate the tracepoint - this isn't the way to do debug.\nAlso please do wrap this in a debug define (I would just output the stuff always if debug is defined, no need for tracepoint).", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417450505", "createdAt": "2020-04-29T16:31:10Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5OTQ1NA=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDM3Mw==", "bodyText": "Sure, removed the tracepoint and wrapped it with DEBUG_BCV (reuse the one in bcverify.c).", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417474373", "createdAt": "2020-04-29T17:07:36Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5OTQ1NA=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NzUzNTQ2OnYy", "diffSide": "RIGHT", "path": "runtime/bcverify/rtverify.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzowNjoyMVrOGOIkEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzoxMzoxN1rOGOI1Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MzU1NQ==", "bodyText": "Please bracket the >=", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417473555", "createdAt": "2020-04-29T17:06:21Z", "author": {"login": "gacholio"}, "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -526,6 +714,11 @@ verifyBytecodes (J9BytecodeVerificationData * verifyData)\n \n \t/* walk the bytecodes linearly */\n \twhile (pc < length) {\n+\t\tif (isNPEMsg && pc >= npePC) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 337}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NzkwNw==", "bodyText": "Added.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417477907", "createdAt": "2020-04-29T17:13:17Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -526,6 +714,11 @@ verifyBytecodes (J9BytecodeVerificationData * verifyData)\n \n \t/* walk the bytecodes linearly */\n \twhile (pc < length) {\n+\t\tif (isNPEMsg && pc >= npePC) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MzU1NQ=="}, "originalCommit": {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29"}, "originalPosition": 337}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5Nzc2MjMxOnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/javanextvmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxODowNTo0MlrOGOK0nQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxODoyODoxMlrOGOLnsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUxMDU1Nw==", "bodyText": "Please use #if defined rather than #ifdef, and please comment the else and endif directives (for all ifdefs in this file and any others you may have added).", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417510557", "createdAt": "2020-04-29T18:05:42Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +40,96 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+\n+#ifdef DEBUG_BCV\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+#endif\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0};\n+\t\tJ9BytecodeVerificationData *bcvd = vm->bytecodeVerificationData;\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass)\n+\t\t\t&& (NULL != userData.romMethod)\n+\t\t\t&& (UDATA_MAX != userData.bytecodeOffset)\n+\t\t\t&& (NULL != bcvd)\n+\t\t) {\n+#ifdef DEBUG_BCV", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5537048efbeb7c497be079f933a740562f7c454"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUyMzYzNQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417523635", "createdAt": "2020-04-29T18:28:12Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +40,96 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+\n+#ifdef DEBUG_BCV\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+#endif\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0};\n+\t\tJ9BytecodeVerificationData *bcvd = vm->bytecodeVerificationData;\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass)\n+\t\t\t&& (NULL != userData.romMethod)\n+\t\t\t&& (UDATA_MAX != userData.bytecodeOffset)\n+\t\t\t&& (NULL != bcvd)\n+\t\t) {\n+#ifdef DEBUG_BCV", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUxMDU1Nw=="}, "originalCommit": {"oid": "c5537048efbeb7c497be079f933a740562f7c454"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTg4NTA0OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/javanextvmi.c", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNTo1MzoxOVrOGVM-yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMjozNzowM1rOGVaLLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NTk2Mg==", "bodyText": "I thought we had a macro for unwrapping jobjects but I can't find it now.  @gacholio do you know what I'm looking for?", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424885962", "createdAt": "2020-05-14T05:53:19Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +40,93 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader, J9Class* ramClass)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+\n+#if defined(DEBUG_BCV)\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+#endif /* defined(DEBUG_BCV) */\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0};\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MjQxOQ==", "bodyText": "@DanHeidinga is it #define J9_JNI_UNWRAP_REFERENCE(o)  (*(j9object_t*)(o))? iterateStackTrace() expects j9object_t* exception though.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425062419", "createdAt": "2020-05-14T11:22:09Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +40,93 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader, J9Class* ramClass)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+\n+#if defined(DEBUG_BCV)\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+#endif /* defined(DEBUG_BCV) */\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0};\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NTk2Mg=="}, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwMjEyNA==", "bodyText": "Thanks @DanHeidinga, the PR has been updated, please have another look.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425102124", "createdAt": "2020-05-14T12:37:03Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +40,93 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader, J9Class* ramClass)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+\n+#if defined(DEBUG_BCV)\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+#endif /* defined(DEBUG_BCV) */\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0};\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NTk2Mg=="}, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTg5MDkwOnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/javanextvmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNTo1NjoyMlrOGVNCeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMToyMjozMVrOGVXwzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NjkwNQ==", "bodyText": "I'd rather keep throwing the NPE without the extra message here.  It's the application error that's the root cause.\nOtherwise, the OOM should have the NPE as its cause", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424886905", "createdAt": "2020-05-14T05:56:22Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +40,93 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader, J9Class* ramClass)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+\n+#if defined(DEBUG_BCV)\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+#endif /* defined(DEBUG_BCV) */\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0};\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass)\n+\t\t\t&& (NULL != userData.romMethod)\n+\t\t\t&& (UDATA_MAX != userData.bytecodeOffset)\n+\t\t) {\n+#if defined(DEBUG_BCV)\n+\t\t\t{\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tU_8 *bytecodes = J9_BYTECODE_START_FROM_ROM_METHOD(userData.romMethod);\n+\t\t\t\tU_32 flags = 0;\n+\n+#if defined(J9VM_ENV_LITTLE_ENDIAN)\n+\t\t\t\tflags |= BCT_LittleEndianOutput;\n+#else /* defined(J9VM_ENV_LITTLE_ENDIAN) */\n+\t\t\t\tflags |= BCT_BigEndianOutput;\n+#endif /* defined(J9VM_ENV_LITTLE_ENDIAN) */\n+\t\t\t\tj9bcutil_dumpBytecodes(PORTLIB, userData.romClass, bytecodes, 0, userData.bytecodeOffset, flags, (void *)cfdumpBytecodePrintFunction, PORTLIB, \"\");\n+\t\t\t}\n+#endif /* defined(DEBUG_BCV) */\n+\t\t\tnpeMsg = vmFuncs->getCompleteNPEMessage(vmThread, J9_BYTECODE_START_FROM_ROM_METHOD(userData.romMethod) + userData.bytecodeOffset, userData.romClass, npeMsg);\n+\t\t\tif (NULL != npeMsg) {\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tj9object_t msgObject = vm->memoryManagerFunctions->j9gc_createJavaLangString(vmThread, (U_8 *)npeMsg, strlen(npeMsg), 0);\n+\t\t\t\tif (NULL != msgObject) {\n+\t\t\t\t\tmsgObjectRef = vmFuncs->j9jni_createLocalRef(env, msgObject);\n+\t\t\t\t}\n+\t\t\t\tj9mem_free_memory(npeMsg);\n+\t\t\t\tif (NULL == msgObjectRef) {\n+\t\t\t\t\tvmFuncs->setNativeOutOfMemoryError(vmThread, 0, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MjYwNA==", "bodyText": "Agreed, throwing the NPE instead and removed OOM.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425062604", "createdAt": "2020-05-14T11:22:31Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +40,93 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader, J9Class* ramClass)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+\n+#if defined(DEBUG_BCV)\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+#endif /* defined(DEBUG_BCV) */\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0};\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass)\n+\t\t\t&& (NULL != userData.romMethod)\n+\t\t\t&& (UDATA_MAX != userData.bytecodeOffset)\n+\t\t) {\n+#if defined(DEBUG_BCV)\n+\t\t\t{\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tU_8 *bytecodes = J9_BYTECODE_START_FROM_ROM_METHOD(userData.romMethod);\n+\t\t\t\tU_32 flags = 0;\n+\n+#if defined(J9VM_ENV_LITTLE_ENDIAN)\n+\t\t\t\tflags |= BCT_LittleEndianOutput;\n+#else /* defined(J9VM_ENV_LITTLE_ENDIAN) */\n+\t\t\t\tflags |= BCT_BigEndianOutput;\n+#endif /* defined(J9VM_ENV_LITTLE_ENDIAN) */\n+\t\t\t\tj9bcutil_dumpBytecodes(PORTLIB, userData.romClass, bytecodes, 0, userData.bytecodeOffset, flags, (void *)cfdumpBytecodePrintFunction, PORTLIB, \"\");\n+\t\t\t}\n+#endif /* defined(DEBUG_BCV) */\n+\t\t\tnpeMsg = vmFuncs->getCompleteNPEMessage(vmThread, J9_BYTECODE_START_FROM_ROM_METHOD(userData.romMethod) + userData.bytecodeOffset, userData.romClass, npeMsg);\n+\t\t\tif (NULL != npeMsg) {\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tj9object_t msgObject = vm->memoryManagerFunctions->j9gc_createJavaLangString(vmThread, (U_8 *)npeMsg, strlen(npeMsg), 0);\n+\t\t\t\tif (NULL != msgObject) {\n+\t\t\t\t\tmsgObjectRef = vmFuncs->j9jni_createLocalRef(env, msgObject);\n+\t\t\t\t}\n+\t\t\t\tj9mem_free_memory(npeMsg);\n+\t\t\t\tif (NULL == msgObjectRef) {\n+\t\t\t\t\tvmFuncs->setNativeOutOfMemoryError(vmThread, 0, 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NjkwNQ=="}, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTg5NTQ0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/ExtendedMessageNPE.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNTo1ODo0OVrOGVNFYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMToyMjo0MVrOGVXxIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NzY0OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            {\n          \n          \n            \n            \n          \n          \n            \n            \tchar *npeMsg = NULL;\n          \n          \n            \n            {\n          \n          \n            \n            \tchar *npeMsg = NULL;", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424887648", "createdAt": "2020-05-14T05:58:49Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MjY5MA==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425062690", "createdAt": "2020-05-14T11:22:41Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NzY0OA=="}, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTg5OTM0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/ExtendedMessageNPE.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjowMDozOFrOGVNHtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMToyMjo1OVrOGVXxsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4ODI0Ng==", "bodyText": "I'm not clear why this is using defines rather than the string directly?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #define VM_NPE_ALOAD \"Cannot load from %s array\"\n          \n          \n            \n            \t\t\tnlsMessage = VM_NPE_ALOAD;\n          \n          \n            \n            #undef VM_NPE_ALOAD\n          \n          \n            \n            \t\t\tnlsMessage = \"Cannot load from %s array\";", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424888246", "createdAt": "2020-05-14T06:00:38Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MjgzNA==", "bodyText": "It was from an earlier commit in which there were multiple references to the string.\nFixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425062834", "createdAt": "2020-05-14T11:22:59Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4ODI0Ng=="}, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTkwMDUyOnYy", "diffSide": "RIGHT", "path": "runtime/vm/ExtendedMessageNPE.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjowMDo1OVrOGVNIYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMToyMzowOFrOGVXyBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4ODQxOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #define VM_NPE_ASTORE \"Cannot store to %s array\"\n          \n          \n            \n            \t\t\tnlsMessage = VM_NPE_ASTORE;\n          \n          \n            \n            #undef VM_NPE_ASTORE\n          \n          \n            \n            \t\t\tnlsMessage = \"Cannot store to %s array\";", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424888419", "createdAt": "2020-05-14T06:00:59Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD\n+\t\t} else {\n+#define VM_NPE_ASTORE \"Cannot store to %s array\"\n+\t\t\tnlsMessage = VM_NPE_ASTORE;\n+#undef VM_NPE_ASTORE", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MjkxNg==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425062916", "createdAt": "2020-05-14T11:23:08Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD\n+\t\t} else {\n+#define VM_NPE_ASTORE \"Cannot store to %s array\"\n+\t\t\tnlsMessage = VM_NPE_ASTORE;\n+#undef VM_NPE_ASTORE", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4ODQxOQ=="}, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTkwNjEwOnYy", "diffSide": "RIGHT", "path": "runtime/vm/ExtendedMessageNPE.cpp", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjowMzo0OFrOGVNLuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMjozNzowNlrOGVaLSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4OTI3Mg==", "bodyText": "I'm unclear on why a define is preferable to local variable here.  The local seems to have less \"noise\" when reading the code\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tcase JBarraylength:\n          \n          \n            \n            #define VM_NPE_ARRAYLENGTH \"Cannot read the array length\"\n          \n          \n            \n            \t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n          \n          \n            \n            \t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n          \n          \n            \n            \t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);\n          \n          \n            \n            #undef VM_NPE_ARRAYLENGTH\n          \n          \n            \n            \t\tcase JBarraylength:\n          \n          \n            \n            \t\t\tconst char *VM_NPE_ARRAYLENGTH = \"Cannot read the array length\";\n          \n          \n            \n            \t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n          \n          \n            \n            \t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n          \n          \n            \n            \t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424889272", "createdAt": "2020-05-14T06:03:48Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD\n+\t\t} else {\n+#define VM_NPE_ASTORE \"Cannot store to %s array\"\n+\t\t\tnlsMessage = VM_NPE_ASTORE;\n+#undef VM_NPE_ASTORE\n+\t\t}\n+\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, nlsMessage, elementType);\n+\t\t/* msg NULL check omitted since str_printf accepts NULL (as above) */\n+\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\tj9str_printf(PORTLIB, npeMsg, msgLen, nlsMessage, elementType);\n+\t} else {\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBarraylength:\n+#define VM_NPE_ARRAYLENGTH \"Cannot read the array length\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);\n+#undef VM_NPE_ARRAYLENGTH", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MzU2Ng==", "bodyText": "This comes from the thought (and becomes a habit later) in early days that the defines save the memory defining local variables. It is negligible and probably covered by compiler optimization already.\nAgreed, the local reads better.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425063566", "createdAt": "2020-05-14T11:24:34Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD\n+\t\t} else {\n+#define VM_NPE_ASTORE \"Cannot store to %s array\"\n+\t\t\tnlsMessage = VM_NPE_ASTORE;\n+#undef VM_NPE_ASTORE\n+\t\t}\n+\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, nlsMessage, elementType);\n+\t\t/* msg NULL check omitted since str_printf accepts NULL (as above) */\n+\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\tj9str_printf(PORTLIB, npeMsg, msgLen, nlsMessage, elementType);\n+\t} else {\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBarraylength:\n+#define VM_NPE_ARRAYLENGTH \"Cannot read the array length\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);\n+#undef VM_NPE_ARRAYLENGTH", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4OTI3Mg=="}, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwMjE1NQ==", "bodyText": "Make the local const and it shouldn't matter", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425102155", "createdAt": "2020-05-14T12:37:06Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD\n+\t\t} else {\n+#define VM_NPE_ASTORE \"Cannot store to %s array\"\n+\t\t\tnlsMessage = VM_NPE_ASTORE;\n+#undef VM_NPE_ASTORE\n+\t\t}\n+\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, nlsMessage, elementType);\n+\t\t/* msg NULL check omitted since str_printf accepts NULL (as above) */\n+\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\tj9str_printf(PORTLIB, npeMsg, msgLen, nlsMessage, elementType);\n+\t} else {\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBarraylength:\n+#define VM_NPE_ARRAYLENGTH \"Cannot read the array length\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);\n+#undef VM_NPE_ARRAYLENGTH", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4OTI3Mg=="}, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTkxMzA4OnYy", "diffSide": "RIGHT", "path": "runtime/vm/ExtendedMessageNPE.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjowNzozMlrOGVNQKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMToyOToyNVrOGVX-Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MDQwOQ==", "bodyText": "The locals can be declared at first use as this is a cpp file.  Saves initializing them to null and shortens the life time they need to be reasoned about", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424890409", "createdAt": "2020-05-14T06:07:32Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD\n+\t\t} else {\n+#define VM_NPE_ASTORE \"Cannot store to %s array\"\n+\t\t\tnlsMessage = VM_NPE_ASTORE;\n+#undef VM_NPE_ASTORE\n+\t\t}\n+\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, nlsMessage, elementType);\n+\t\t/* msg NULL check omitted since str_printf accepts NULL (as above) */\n+\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\tj9str_printf(PORTLIB, npeMsg, msgLen, nlsMessage, elementType);\n+\t} else {\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBarraylength:\n+#define VM_NPE_ARRAYLENGTH \"Cannot read the array length\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);\n+#undef VM_NPE_ARRAYLENGTH\n+\t\t\tbreak;\n+\t\tcase JBathrow:\n+#define VM_NPE_ATHROW \"Cannot throw exception\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ATHROW);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ATHROW);\n+#undef VM_NPE_ATHROW\n+\t\t\tbreak;\n+\t\tcase JBmonitorenter:\n+#define VM_NPE_MONITORENTER \"Cannot enter synchronized block\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_MONITORENTER);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen+ 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_MONITORENTER);\n+#undef VM_NPE_MONITORENTER\n+\t\t\tbreak;\n+\t\tcase JBmonitorexit:\n+#define VM_NPE_MONITOREXIT \"Cannot exit synchronized block\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_MONITOREXIT);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_MONITOREXIT);\n+#undef VM_NPE_MONITOREXIT\n+\t\t\tbreak;\n+\t\tcase JBgetfield: /* FALLTHROUGH */\n+\t\tcase JBputfield:\n+\t\t\t{\n+\t\t\t\tU_16 index = PARAM_16(bcCurrentPtr, 1);\n+\t\t\t\tUDATA cpType = J9_CP_TYPE(J9ROMCLASS_CPSHAPEDESCRIPTION(romClass), index);\n+\n+\t\t\t\tTrc_VM_GetCompleteNPEMessage_Field_Index(vmThread, index);\n+\t\t\t\tif (J9CPTYPE_FIELD == cpType) {\n+\t\t\t\t\tJ9ROMConstantPoolItem *constantPool = J9_ROM_CP_FROM_ROM_CLASS(romClass);\n+\t\t\t\t\tJ9ROMConstantPoolItem *cpItem = constantPool + index;\n+\t\t\t\t\tJ9ROMNameAndSignature *nameAndSig = J9ROMFIELDREF_NAMEANDSIGNATURE((J9ROMFieldRef *) cpItem);\n+\t\t\t\t\tJ9UTF8 *name = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);\n+\n+\t\t\t\t\tif (JBputfield == bcCurrent) {\n+#define VM_NPE_PUTFIELD \"Cannot assign field \\\"%2$.*1$s\\\"\"\n+\t\t\t\t\t\tnlsMessage = VM_NPE_PUTFIELD;\n+#undef VM_NPE_PUTFIELD\n+\t\t\t\t\t} else {\n+#define VM_NPE_GETFIELD \"Cannot read field \\\"%2$.*1$s\\\"\"\n+\t\t\t\t\t\tnlsMessage = VM_NPE_GETFIELD;\n+#undef VM_NPE_GETFIELD\n+\t\t\t\t\t}\n+\t\t\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, nlsMessage, J9UTF8_LENGTH(name), J9UTF8_DATA(name));\n+\t\t\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, nlsMessage, J9UTF8_LENGTH(name), J9UTF8_DATA(name));\n+\t\t\t\t} else {\n+\t\t\t\t\tTrc_VM_GetCompleteNPEMessage_UnexpectedCPType(vmThread, cpType, bcCurrent);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tbreak;\n+\t\tcase JBinvokehandle: /* FALLTHROUGH */\n+\t\tcase JBinvokehandlegeneric: /* FALLTHROUGH */\n+\t\tcase JBinvokeinterface2: /* FALLTHROUGH */\n+\t\tcase JBinvokeinterface: /* FALLTHROUGH */\n+\t\tcase JBinvokespecial: /* FALLTHROUGH */\n+\t\tcase JBinvokedynamic: /* FALLTHROUGH */\n+\t\tcase JBinvokevirtual: /* FALLTHROUGH */\n+\t\tcase JBinvokestatic:\n+\t\t\t{\n+\t\t\t\tU_16 index = 0;\n+\t\t\t\tJ9ROMNameAndSignature *nameAndSig = NULL;\n+\t\t\t\tJ9UTF8 *sig = NULL;\n+\t\t\t\tJ9UTF8 *name = NULL;\n+\t\t\t\tJ9UTF8 *definingUTF = NULL;\n+\t\t\t\tJ9ROMMethodRef *romMethodRef = NULL;\n+\t\t\t\tJ9ROMConstantPoolItem *constantPool = J9_ROM_CP_FROM_ROM_CLASS(romClass);\n+\n+\t\t\t\tif (JBinvokeinterface2 == bcCurrent) {\n+\t\t\t\t\tindex = PARAM_16(bcCurrentPtr + 2, 1); /* get JBinvokeinterface instead */\n+\t\t\t\t} else {\n+\t\t\t\t\tindex = PARAM_16(bcCurrentPtr, 1);\n+\t\t\t\t}\n+\t\t\t\tTrc_VM_GetCompleteNPEMessage_Invoke_Index(vmThread, index);\n+\t\t\t\tromMethodRef = (J9ROMMethodRef *)&constantPool[index];\n+\t\t\t\tnameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\t\t\t\tsig = J9ROMNAMEANDSIGNATURE_SIGNATURE(nameAndSig);\n+\t\t\t\tname = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 179}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2NjA3OQ==", "bodyText": "Yeah, should use this advantage, updated.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425066079", "createdAt": "2020-05-14T11:29:25Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD\n+\t\t} else {\n+#define VM_NPE_ASTORE \"Cannot store to %s array\"\n+\t\t\tnlsMessage = VM_NPE_ASTORE;\n+#undef VM_NPE_ASTORE\n+\t\t}\n+\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, nlsMessage, elementType);\n+\t\t/* msg NULL check omitted since str_printf accepts NULL (as above) */\n+\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\tj9str_printf(PORTLIB, npeMsg, msgLen, nlsMessage, elementType);\n+\t} else {\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBarraylength:\n+#define VM_NPE_ARRAYLENGTH \"Cannot read the array length\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);\n+#undef VM_NPE_ARRAYLENGTH\n+\t\t\tbreak;\n+\t\tcase JBathrow:\n+#define VM_NPE_ATHROW \"Cannot throw exception\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ATHROW);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ATHROW);\n+#undef VM_NPE_ATHROW\n+\t\t\tbreak;\n+\t\tcase JBmonitorenter:\n+#define VM_NPE_MONITORENTER \"Cannot enter synchronized block\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_MONITORENTER);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen+ 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_MONITORENTER);\n+#undef VM_NPE_MONITORENTER\n+\t\t\tbreak;\n+\t\tcase JBmonitorexit:\n+#define VM_NPE_MONITOREXIT \"Cannot exit synchronized block\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_MONITOREXIT);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_MONITOREXIT);\n+#undef VM_NPE_MONITOREXIT\n+\t\t\tbreak;\n+\t\tcase JBgetfield: /* FALLTHROUGH */\n+\t\tcase JBputfield:\n+\t\t\t{\n+\t\t\t\tU_16 index = PARAM_16(bcCurrentPtr, 1);\n+\t\t\t\tUDATA cpType = J9_CP_TYPE(J9ROMCLASS_CPSHAPEDESCRIPTION(romClass), index);\n+\n+\t\t\t\tTrc_VM_GetCompleteNPEMessage_Field_Index(vmThread, index);\n+\t\t\t\tif (J9CPTYPE_FIELD == cpType) {\n+\t\t\t\t\tJ9ROMConstantPoolItem *constantPool = J9_ROM_CP_FROM_ROM_CLASS(romClass);\n+\t\t\t\t\tJ9ROMConstantPoolItem *cpItem = constantPool + index;\n+\t\t\t\t\tJ9ROMNameAndSignature *nameAndSig = J9ROMFIELDREF_NAMEANDSIGNATURE((J9ROMFieldRef *) cpItem);\n+\t\t\t\t\tJ9UTF8 *name = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);\n+\n+\t\t\t\t\tif (JBputfield == bcCurrent) {\n+#define VM_NPE_PUTFIELD \"Cannot assign field \\\"%2$.*1$s\\\"\"\n+\t\t\t\t\t\tnlsMessage = VM_NPE_PUTFIELD;\n+#undef VM_NPE_PUTFIELD\n+\t\t\t\t\t} else {\n+#define VM_NPE_GETFIELD \"Cannot read field \\\"%2$.*1$s\\\"\"\n+\t\t\t\t\t\tnlsMessage = VM_NPE_GETFIELD;\n+#undef VM_NPE_GETFIELD\n+\t\t\t\t\t}\n+\t\t\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, nlsMessage, J9UTF8_LENGTH(name), J9UTF8_DATA(name));\n+\t\t\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, nlsMessage, J9UTF8_LENGTH(name), J9UTF8_DATA(name));\n+\t\t\t\t} else {\n+\t\t\t\t\tTrc_VM_GetCompleteNPEMessage_UnexpectedCPType(vmThread, cpType, bcCurrent);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tbreak;\n+\t\tcase JBinvokehandle: /* FALLTHROUGH */\n+\t\tcase JBinvokehandlegeneric: /* FALLTHROUGH */\n+\t\tcase JBinvokeinterface2: /* FALLTHROUGH */\n+\t\tcase JBinvokeinterface: /* FALLTHROUGH */\n+\t\tcase JBinvokespecial: /* FALLTHROUGH */\n+\t\tcase JBinvokedynamic: /* FALLTHROUGH */\n+\t\tcase JBinvokevirtual: /* FALLTHROUGH */\n+\t\tcase JBinvokestatic:\n+\t\t\t{\n+\t\t\t\tU_16 index = 0;\n+\t\t\t\tJ9ROMNameAndSignature *nameAndSig = NULL;\n+\t\t\t\tJ9UTF8 *sig = NULL;\n+\t\t\t\tJ9UTF8 *name = NULL;\n+\t\t\t\tJ9UTF8 *definingUTF = NULL;\n+\t\t\t\tJ9ROMMethodRef *romMethodRef = NULL;\n+\t\t\t\tJ9ROMConstantPoolItem *constantPool = J9_ROM_CP_FROM_ROM_CLASS(romClass);\n+\n+\t\t\t\tif (JBinvokeinterface2 == bcCurrent) {\n+\t\t\t\t\tindex = PARAM_16(bcCurrentPtr + 2, 1); /* get JBinvokeinterface instead */\n+\t\t\t\t} else {\n+\t\t\t\t\tindex = PARAM_16(bcCurrentPtr, 1);\n+\t\t\t\t}\n+\t\t\t\tTrc_VM_GetCompleteNPEMessage_Invoke_Index(vmThread, index);\n+\t\t\t\tromMethodRef = (J9ROMMethodRef *)&constantPool[index];\n+\t\t\t\tnameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\t\t\t\tsig = J9ROMNAMEANDSIGNATURE_SIGNATURE(nameAndSig);\n+\t\t\t\tname = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MDQwOQ=="}, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 179}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTkyNTg3OnYy", "diffSide": "RIGHT", "path": "runtime/vm/exceptiondescribe.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNjoxMzoyOFrOGVNYQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMToyOToxMFrOGVX96A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MjQ4MQ==", "bodyText": "Can you set methodPC = UDATA_MAX; here or before this if statement so the else clauses aren't needed?", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424892481", "createdAt": "2020-05-14T06:13:28Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/exceptiondescribe.c", "diffHunk": "@@ -319,7 +319,7 @@ iterateStackTrace(J9VMThread * vmThread, j9object_t* exception, callback_func_t\n \t\t\t\t\t}\n \t\t\t\t\tif (inlineDepth == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2NTk2MA==", "bodyText": "There are still a few references of methodPC expecting a valid value:\nLine 346\nromClass = findROMClassFromPC(vmThread, methodPC, &classLoader);,\nLine 370\nif ((methodPC >= (UDATA)possibleMethod) && (methodPC < (UDATA)J9_BYTECODE_END_FROM_ROM_METHOD(possibleMethod))) {\nLine 381\nromMethod = findROMMethodInROMClass(vmThread, romClass, methodPC);\nIt doesn't seem there is a good place to set methodPC = UDATA_MAX; beforehand and save later duplicates.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425065960", "createdAt": "2020-05-14T11:29:10Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/vm/exceptiondescribe.c", "diffHunk": "@@ -319,7 +319,7 @@ iterateStackTrace(J9VMThread * vmThread, j9object_t* exception, callback_func_t\n \t\t\t\t\t}\n \t\t\t\t\tif (inlineDepth == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MjQ4MQ=="}, "originalCommit": {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NzI0Mzc4OnYy", "diffSide": "RIGHT", "path": "runtime/oti/vm_api.h", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMjo0MzozNlrOGVaZ_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjoxOToxMlrOGVkCwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwNTkxNw==", "bodyText": "Can you add the new parameter to the @param list above?", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425105917", "createdAt": "2020-05-14T12:43:36Z", "author": {"login": "DanHeidinga"}, "path": "runtime/oti/vm_api.h", "diffHunk": "@@ -558,7 +558,7 @@ internalExceptionDescribe(J9VMThread *vmThread);\n * @return UDATA\n */\n UDATA\n-iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader, J9Class* ramClass), void * userData, UDATA pruneConstructors);\n+iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, UDATA bytecodeOffset, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader, J9Class* ramClass), void * userData, UDATA pruneConstructors);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45c650feaffe8a8b2fce83fcef41a366a031fd19"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI1MzM3MQ==", "bodyText": "Oops, missed this, will add it.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425253371", "createdAt": "2020-05-14T16:04:18Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/oti/vm_api.h", "diffHunk": "@@ -558,7 +558,7 @@ internalExceptionDescribe(J9VMThread *vmThread);\n * @return UDATA\n */\n UDATA\n-iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader, J9Class* ramClass), void * userData, UDATA pruneConstructors);\n+iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, UDATA bytecodeOffset, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader, J9Class* ramClass), void * userData, UDATA pruneConstructors);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwNTkxNw=="}, "originalCommit": {"oid": "45c650feaffe8a8b2fce83fcef41a366a031fd19"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI2MzgwOQ==", "bodyText": "Renamed method to romMethod, added bytecodeOffset, romClass, and classLoader.", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425263809", "createdAt": "2020-05-14T16:19:12Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/oti/vm_api.h", "diffHunk": "@@ -558,7 +558,7 @@ internalExceptionDescribe(J9VMThread *vmThread);\n * @return UDATA\n */\n UDATA\n-iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader, J9Class* ramClass), void * userData, UDATA pruneConstructors);\n+iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, UDATA bytecodeOffset, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader, J9Class* ramClass), void * userData, UDATA pruneConstructors);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwNTkxNw=="}, "originalCommit": {"oid": "45c650feaffe8a8b2fce83fcef41a366a031fd19"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 689, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}