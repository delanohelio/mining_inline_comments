{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MjAyMjQx", "number": 9476, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODoxNzo0NFrOD58Dqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODoxNzo0NFrOD58Dqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMDc5NDAzOnYy", "diffSide": "RIGHT", "path": "runtime/vm/createramclass.cpp", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODoxNzo0NFrOGRfl2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxOToxOToxMFrOGRh1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ==", "bodyText": "What's the consequence of this change? Is this a bug fix rolled into this PR?", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r420996571", "createdAt": "2020-05-06T18:17:44Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2901,14 +2907,15 @@ internalCreateRAMClassFromROMClassImpl(J9VMThread *vmThread, J9ClassLoader *clas\n \t\t\t\t\t * properties from the leafComponentType. A 2D array is an array of references so it can never be flattened, however, its\n \t\t\t\t\t * elements may be flattened arrays.\n \t\t\t\t\t */\n-\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & (J9ClassIsFlattened | J9ClassLargestAlignmentConstraintReference | J9ClassLargestAlignmentConstraintDouble));\n+\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & arrayFlags);\n+\n \t\t\t\t}\n \t\t\t\tramArrayClass->leafComponentType = leafComponentType;\n \t\t\t\tramArrayClass->arity = arity;\n \t\t\t\tramArrayClass->componentType = elementClass;\n \t\t\t\tramArrayClass->module = leafComponentType->module;\n \n-\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(elementClass)) {\n+\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(ramArrayClass)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5445466a75e5817a15a7c7962d1722ca4e4cdf4d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAwMjIwNQ==", "bodyText": "I think I see - previously the element determined if the array was flattened.", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421002205", "createdAt": "2020-05-06T18:27:16Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2901,14 +2907,15 @@ internalCreateRAMClassFromROMClassImpl(J9VMThread *vmThread, J9ClassLoader *clas\n \t\t\t\t\t * properties from the leafComponentType. A 2D array is an array of references so it can never be flattened, however, its\n \t\t\t\t\t * elements may be flattened arrays.\n \t\t\t\t\t */\n-\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & (J9ClassIsFlattened | J9ClassLargestAlignmentConstraintReference | J9ClassLargestAlignmentConstraintDouble));\n+\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & arrayFlags);\n+\n \t\t\t\t}\n \t\t\t\tramArrayClass->leafComponentType = leafComponentType;\n \t\t\t\tramArrayClass->arity = arity;\n \t\t\t\tramArrayClass->componentType = elementClass;\n \t\t\t\tramArrayClass->module = leafComponentType->module;\n \n-\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(elementClass)) {\n+\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(ramArrayClass)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, "originalCommit": {"oid": "5445466a75e5817a15a7c7962d1722ca4e4cdf4d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAwNDEyNg==", "bodyText": "Does there need to be a check for the element type being a VT?", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421004126", "createdAt": "2020-05-06T18:30:32Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2901,14 +2907,15 @@ internalCreateRAMClassFromROMClassImpl(J9VMThread *vmThread, J9ClassLoader *clas\n \t\t\t\t\t * properties from the leafComponentType. A 2D array is an array of references so it can never be flattened, however, its\n \t\t\t\t\t * elements may be flattened arrays.\n \t\t\t\t\t */\n-\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & (J9ClassIsFlattened | J9ClassLargestAlignmentConstraintReference | J9ClassLargestAlignmentConstraintDouble));\n+\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & arrayFlags);\n+\n \t\t\t\t}\n \t\t\t\tramArrayClass->leafComponentType = leafComponentType;\n \t\t\t\tramArrayClass->arity = arity;\n \t\t\t\tramArrayClass->componentType = elementClass;\n \t\t\t\tramArrayClass->module = leafComponentType->module;\n \n-\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(elementClass)) {\n+\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(ramArrayClass)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, "originalCommit": {"oid": "5445466a75e5817a15a7c7962d1722ca4e4cdf4d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAxNjUxMw==", "bodyText": "previously the element determined if the array was flattened.\n\nYes this code was technically wrong before but there was no impact since prior to this change the element determined if the array is flattened or not.\nSince flattening or array/element will now be done independently, one must only look at the array flags.\n\nDoes there need to be a check for the element type being a VT?\n\nFor a singleton type, being a VT is a prerequisite of flattening. So J9_IS_J9CLASS_FLATTENED(elementClass) == TRUE implies VT. Arrays cannot be VTs, only singleton types, so J9_IS_J9CLASS_FLATTENED(ramArrayClass) == TRUE implies that elementType is flattened and also a VT.", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421016513", "createdAt": "2020-05-06T18:50:52Z", "author": {"login": "tajila"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2901,14 +2907,15 @@ internalCreateRAMClassFromROMClassImpl(J9VMThread *vmThread, J9ClassLoader *clas\n \t\t\t\t\t * properties from the leafComponentType. A 2D array is an array of references so it can never be flattened, however, its\n \t\t\t\t\t * elements may be flattened arrays.\n \t\t\t\t\t */\n-\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & (J9ClassIsFlattened | J9ClassLargestAlignmentConstraintReference | J9ClassLargestAlignmentConstraintDouble));\n+\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & arrayFlags);\n+\n \t\t\t\t}\n \t\t\t\tramArrayClass->leafComponentType = leafComponentType;\n \t\t\t\tramArrayClass->arity = arity;\n \t\t\t\tramArrayClass->componentType = elementClass;\n \t\t\t\tramArrayClass->module = leafComponentType->module;\n \n-\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(elementClass)) {\n+\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(ramArrayClass)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, "originalCommit": {"oid": "5445466a75e5817a15a7c7962d1722ca4e4cdf4d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyODE2NA==", "bodyText": "Short answer is I dont think there needs to be a VT check here, since its implied with the flattening check", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421028164", "createdAt": "2020-05-06T19:10:08Z", "author": {"login": "tajila"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2901,14 +2907,15 @@ internalCreateRAMClassFromROMClassImpl(J9VMThread *vmThread, J9ClassLoader *clas\n \t\t\t\t\t * properties from the leafComponentType. A 2D array is an array of references so it can never be flattened, however, its\n \t\t\t\t\t * elements may be flattened arrays.\n \t\t\t\t\t */\n-\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & (J9ClassIsFlattened | J9ClassLargestAlignmentConstraintReference | J9ClassLargestAlignmentConstraintDouble));\n+\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & arrayFlags);\n+\n \t\t\t\t}\n \t\t\t\tramArrayClass->leafComponentType = leafComponentType;\n \t\t\t\tramArrayClass->arity = arity;\n \t\t\t\tramArrayClass->componentType = elementClass;\n \t\t\t\tramArrayClass->module = leafComponentType->module;\n \n-\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(elementClass)) {\n+\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(ramArrayClass)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, "originalCommit": {"oid": "5445466a75e5817a15a7c7962d1722ca4e4cdf4d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMDk2OA==", "bodyText": "I wasn't clear - it looks like all arrays will get the flattened flag if the new option is set, which seems incorrect.", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421030968", "createdAt": "2020-05-06T19:15:01Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2901,14 +2907,15 @@ internalCreateRAMClassFromROMClassImpl(J9VMThread *vmThread, J9ClassLoader *clas\n \t\t\t\t\t * properties from the leafComponentType. A 2D array is an array of references so it can never be flattened, however, its\n \t\t\t\t\t * elements may be flattened arrays.\n \t\t\t\t\t */\n-\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & (J9ClassIsFlattened | J9ClassLargestAlignmentConstraintReference | J9ClassLargestAlignmentConstraintDouble));\n+\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & arrayFlags);\n+\n \t\t\t\t}\n \t\t\t\tramArrayClass->leafComponentType = leafComponentType;\n \t\t\t\tramArrayClass->arity = arity;\n \t\t\t\tramArrayClass->componentType = elementClass;\n \t\t\t\tramArrayClass->module = leafComponentType->module;\n \n-\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(elementClass)) {\n+\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(ramArrayClass)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, "originalCommit": {"oid": "5445466a75e5817a15a7c7962d1722ca4e4cdf4d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMzI3MA==", "bodyText": "Ah, arrayFlags is a mask - I read it as being assigned to the flags.", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421033270", "createdAt": "2020-05-06T19:19:10Z", "author": {"login": "gacholio"}, "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2901,14 +2907,15 @@ internalCreateRAMClassFromROMClassImpl(J9VMThread *vmThread, J9ClassLoader *clas\n \t\t\t\t\t * properties from the leafComponentType. A 2D array is an array of references so it can never be flattened, however, its\n \t\t\t\t\t * elements may be flattened arrays.\n \t\t\t\t\t */\n-\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & (J9ClassIsFlattened | J9ClassLargestAlignmentConstraintReference | J9ClassLargestAlignmentConstraintDouble));\n+\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & arrayFlags);\n+\n \t\t\t\t}\n \t\t\t\tramArrayClass->leafComponentType = leafComponentType;\n \t\t\t\tramArrayClass->arity = arity;\n \t\t\t\tramArrayClass->componentType = elementClass;\n \t\t\t\tramArrayClass->module = leafComponentType->module;\n \n-\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(elementClass)) {\n+\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(ramArrayClass)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, "originalCommit": {"oid": "5445466a75e5817a15a7c7962d1722ca4e4cdf4d"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 124, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}