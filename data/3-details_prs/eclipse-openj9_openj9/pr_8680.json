{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMTI1NzA2", "number": 8680, "title": "Reduce number of VM_stackWalkerMaySkipFrames messages", "bodyText": "Cache values on JITServer to reduce number of messages send between client and jitserver.\nIssue: #8544\nSigned-off-by: Chris Chong Zichun.Chong@ibm.com", "createdAt": "2020-02-27T23:32:34Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8680", "merged": true, "mergeCommit": {"oid": "fd0d23e641bb4f5c439ff6bd60ea1dad29ab7746"}, "closed": true, "closedAt": "2020-03-12T16:06:39Z", "author": {"login": "chrisc66"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcInzkXAFqTM2NjEzNTQ2NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMYMn6gFqTM3MjI4MTM3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTM1NDY1", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#pullrequestreview-366135465", "createdAt": "2020-02-28T03:00:04Z", "commit": {"oid": "b36f6b2b1805466b7799f6a0bc99b369bb52a403"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMzowMDowNFrOFvoKHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMzoxMDowM1rOFvoSHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4NTM0Mw==", "bodyText": "vmThread is available at the beginning of this method. Use that instead.", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385485343", "createdAt": "2020-02-28T03:00:04Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -500,6 +500,19 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          vmInfo._floatInvokeExactThunkHelper = comp->getSymRefTab()->findOrCreateRuntimeHelper(TR_icallVMprJavaSendInvokeExactF, false, false, false)->getMethodAddress();\n          vmInfo._doubleInvokeExactThunkHelper = comp->getSymRefTab()->findOrCreateRuntimeHelper(TR_icallVMprJavaSendInvokeExactD, false, false, false)->getMethodAddress();\n          vmInfo._interpreterVTableOffset = TR::Compiler->vm.getInterpreterVTableOffset();\n+         vmInfo._jlrMethodInvoke = fe->_vmThread->javaVM->jlrMethodInvoke;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b36f6b2b1805466b7799f6a0bc99b369bb52a403"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4NTUwNw==", "bodyText": "Since javaVM is used in several places you could store to a local and use that instead.", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385485507", "createdAt": "2020-02-28T03:00:49Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -500,6 +500,19 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          vmInfo._floatInvokeExactThunkHelper = comp->getSymRefTab()->findOrCreateRuntimeHelper(TR_icallVMprJavaSendInvokeExactF, false, false, false)->getMethodAddress();\n          vmInfo._doubleInvokeExactThunkHelper = comp->getSymRefTab()->findOrCreateRuntimeHelper(TR_icallVMprJavaSendInvokeExactD, false, false, false)->getMethodAddress();\n          vmInfo._interpreterVTableOffset = TR::Compiler->vm.getInterpreterVTableOffset();\n+         vmInfo._jlrMethodInvoke = fe->_vmThread->javaVM->jlrMethodInvoke;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4NTM0Mw=="}, "originalCommit": {"oid": "b36f6b2b1805466b7799f6a0bc99b369bb52a403"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4NTgyOA==", "bodyText": "I think you need to acquire VMAccess because you are working with objects which can be changed by GC", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385485828", "createdAt": "2020-02-28T03:02:27Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -500,6 +500,19 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          vmInfo._floatInvokeExactThunkHelper = comp->getSymRefTab()->findOrCreateRuntimeHelper(TR_icallVMprJavaSendInvokeExactF, false, false, false)->getMethodAddress();\n          vmInfo._doubleInvokeExactThunkHelper = comp->getSymRefTab()->findOrCreateRuntimeHelper(TR_icallVMprJavaSendInvokeExactD, false, false, false)->getMethodAddress();\n          vmInfo._interpreterVTableOffset = TR::Compiler->vm.getInterpreterVTableOffset();\n+         vmInfo._jlrMethodInvoke = fe->_vmThread->javaVM->jlrMethodInvoke;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4NTM0Mw=="}, "originalCommit": {"oid": "b36f6b2b1805466b7799f6a0bc99b369bb52a403"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4NjI5NA==", "bodyText": "getOrCacheVMInfo is called several times. better to call it once and store the answer in a local reference.", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385486294", "createdAt": "2020-02-28T03:04:50Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -692,7 +692,44 @@ TR_J9ServerVM::getStaticReferenceFieldAtAddress(uintptrj_t fieldAddress)\n bool\n TR_J9ServerVM::stackWalkerMaySkipFrames(TR_OpaqueMethodBlock *method, TR_OpaqueClassBlock *clazz)\n    {\n+   if(!method)\n+      {\n+      return false;\n+      }\n+   \n    JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n+\n+   if (_compInfoPT->getClientData()->getOrCacheVMInfo(stream)->_jlrMethodInvoke == NULL || ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b36f6b2b1805466b7799f6a0bc99b369bb52a403"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4NzA1NA==", "bodyText": "If _jlrMethodInvoke is NULL you have to send a message because it may have became non-null since the last time we checked.", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385487054", "createdAt": "2020-02-28T03:08:18Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -692,7 +692,44 @@ TR_J9ServerVM::getStaticReferenceFieldAtAddress(uintptrj_t fieldAddress)\n bool\n TR_J9ServerVM::stackWalkerMaySkipFrames(TR_OpaqueMethodBlock *method, TR_OpaqueClassBlock *clazz)\n    {\n+   if(!method)\n+      {\n+      return false;\n+      }\n+   \n    JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n+\n+   if (_compInfoPT->getClientData()->getOrCacheVMInfo(stream)->_jlrMethodInvoke == NULL || ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4NjI5NA=="}, "originalCommit": {"oid": "b36f6b2b1805466b7799f6a0bc99b369bb52a403"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4NzM4OA==", "bodyText": "I don't see _jlrAccessibleObjectClass set anywhere in the VM. We need to ask about this and maybe we can remove it completely", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385487388", "createdAt": "2020-02-28T03:10:03Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -692,7 +692,44 @@ TR_J9ServerVM::getStaticReferenceFieldAtAddress(uintptrj_t fieldAddress)\n bool\n TR_J9ServerVM::stackWalkerMaySkipFrames(TR_OpaqueMethodBlock *method, TR_OpaqueClassBlock *clazz)\n    {\n+   if(!method)\n+      {\n+      return false;\n+      }\n+   \n    JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n+\n+   if (_compInfoPT->getClientData()->getOrCacheVMInfo(stream)->_jlrMethodInvoke == NULL || \n+         _compInfoPT->getClientData()->getOrCacheVMInfo(stream)->_jlrMethodInvoke == ((J9Method *) method))\n+      {\n+      return true;\n+      }\n+\n+   if(!clazz)\n+      {\n+      return false;\n+      }\n+\n+   TR_OpaqueClassBlock * jlrAccessibleObjectClass = _compInfoPT->getClientData()->getOrCacheVMInfo(stream)->_jlrAccessibleObjectClass;\n+   if (jlrAccessibleObjectClass != NULL && TR_J9ServerVM::isInstanceOf( clazz, jlrAccessibleObjectClass ,false))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b36f6b2b1805466b7799f6a0bc99b369bb52a403"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b36f6b2b1805466b7799f6a0bc99b369bb52a403", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b36f6b2b1805466b7799f6a0bc99b369bb52a403", "committedDate": "2020-02-27T23:29:26Z", "message": "Reduce JITServer VM_stackWalkerMaySkipFrames messages\n\nAdd checks in TR_J9ServerVM::stackWalkerMaySkipFrames function\nReduce messages by caching required values to VMInfo\nAdd message handling in JITServer messageType::VM_getVMInfo\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}, "afterCommit": {"oid": "e4b2766f2d58e2105ec45a91eedb27ffd4ef0e86", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e4b2766f2d58e2105ec45a91eedb27ffd4ef0e86", "committedDate": "2020-02-28T16:16:55Z", "message": "\\Reduce JITServer VM_stackWalkerMaySkipFrames messages\n\nAdd checks in TR_J9ServerVM::stackWalkerMaySkipFrames function\nReduce messages by caching required values to VMInfo\nAdd message handling in JITServer messageType::VM_getVMInfo\nRemove javaVM->jlrAccessibleObject in JITServer functions since it is depriciated\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4b2766f2d58e2105ec45a91eedb27ffd4ef0e86", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e4b2766f2d58e2105ec45a91eedb27ffd4ef0e86", "committedDate": "2020-02-28T16:16:55Z", "message": "\\Reduce JITServer VM_stackWalkerMaySkipFrames messages\n\nAdd checks in TR_J9ServerVM::stackWalkerMaySkipFrames function\nReduce messages by caching required values to VMInfo\nAdd message handling in JITServer messageType::VM_getVMInfo\nRemove javaVM->jlrAccessibleObject in JITServer functions since it is depriciated\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}, "afterCommit": {"oid": "f604cad07a52f020487fb7cbe033dbbbdd8a421c", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f604cad07a52f020487fb7cbe033dbbbdd8a421c", "committedDate": "2020-02-28T16:31:43Z", "message": "Reduce JITServer VM_stackWalkerMaySkipFrames messages\n\nAdd checks in TR_J9ServerVM::stackWalkerMaySkipFrames function\nReduce messages by caching required values to VMInfo\nAdd message handling in JITServer messageType::VM_getVMInfo\nRemove javaVM->jlrAccessibleObject in JITServer functions since it is depriciated\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NTQxMTA5", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#pullrequestreview-366541109", "createdAt": "2020-02-28T16:51:40Z", "commit": {"oid": "f604cad07a52f020487fb7cbe033dbbbdd8a421c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNjo1MTo0MFrOFv7vzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzowMTozMVrOFv8D6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNjI4NA==", "bodyText": "You need to create a block here with { } so that we leave the critical section as soon as possible", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385806284", "createdAt": "2020-02-28T16:51:40Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -500,6 +501,18 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          vmInfo._floatInvokeExactThunkHelper = comp->getSymRefTab()->findOrCreateRuntimeHelper(TR_icallVMprJavaSendInvokeExactF, false, false, false)->getMethodAddress();\n          vmInfo._doubleInvokeExactThunkHelper = comp->getSymRefTab()->findOrCreateRuntimeHelper(TR_icallVMprJavaSendInvokeExactD, false, false, false)->getMethodAddress();\n          vmInfo._interpreterVTableOffset = TR::Compiler->vm.getInterpreterVTableOffset();\n+         TR::VMAccessCriticalSection getVMInfo(fe);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f604cad07a52f020487fb7cbe033dbbbdd8a421c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxMDc4NQ==", "bodyText": "If vmInfo->jlrMethodInvoke is null you have to send a message to the client to get updated information. This message is actually JITServer::MessageType::VM_stackWalkerMaySkipFrames, but change it such that it returns the value of vmInfo->jlrMethodInvoke as well so that we can update at the server.", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385810785", "createdAt": "2020-02-28T17:00:12Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -692,7 +692,33 @@ TR_J9ServerVM::getStaticReferenceFieldAtAddress(uintptrj_t fieldAddress)\n bool\n TR_J9ServerVM::stackWalkerMaySkipFrames(TR_OpaqueMethodBlock *method, TR_OpaqueClassBlock *clazz)\n    {\n+   if(!method)\n+      {\n+      return false;\n+      }\n+\n    JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n+   auto *vmInfo = _compInfoPT->getClientData()->getOrCacheVMInfo(stream);\n+   \n+   if (vmInfo->_jlrMethodInvoke == ((J9Method *) method))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f604cad07a52f020487fb7cbe033dbbbdd8a421c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxMTQzNQ==", "bodyText": "Here we just return false, we don't need to send another message.", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385811435", "createdAt": "2020-02-28T17:01:31Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -692,7 +692,33 @@ TR_J9ServerVM::getStaticReferenceFieldAtAddress(uintptrj_t fieldAddress)\n bool\n TR_J9ServerVM::stackWalkerMaySkipFrames(TR_OpaqueMethodBlock *method, TR_OpaqueClassBlock *clazz)\n    {\n+   if(!method)\n+      {\n+      return false;\n+      }\n+\n    JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n+   auto *vmInfo = _compInfoPT->getClientData()->getOrCacheVMInfo(stream);\n+   \n+   if (vmInfo->_jlrMethodInvoke == ((J9Method *) method))\n+      {\n+      return true;\n+      }\n+   if(!clazz)\n+      {\n+      return false;\n+      }\n+#if defined(J9VM_OPT_SIDECAR)\n+   if (vmInfo->_srMethodAccessorClass != NULL && TR_J9ServerVM::isInstanceOf( clazz, vmInfo->_srMethodAccessorClass ,false))\n+      {\n+      return true;\n+      }\n+   if (vmInfo->_srConstructorAccessorClass != NULL && TR_J9ServerVM::isInstanceOf( clazz, vmInfo->_srConstructorAccessorClass ,false))\n+      {\n+      return true;\n+      }\n+#endif // J9VM_OPT_SIDECAR\n+\n    stream->write(JITServer::MessageType::VM_stackWalkerMaySkipFrames, method, clazz);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f604cad07a52f020487fb7cbe033dbbbdd8a421c"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f39cfa46ed101f87b91df0b54fb4202ffcffcce", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/0f39cfa46ed101f87b91df0b54fb4202ffcffcce", "committedDate": "2020-02-28T20:38:22Z", "message": "Reduce JITServer VM_stackWalkerMaySkipFrames messages\n\nAdd checks in TR_J9ServerVM::stackWalkerMaySkipFrames function\nReduce messages by caching required values to VMInfo\nAdd message handling in JITServer messageType::VM_getVMInfo\nRemove javaVM->jlrAccessibleObject in JITServer functions since it is depriciated\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f604cad07a52f020487fb7cbe033dbbbdd8a421c", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f604cad07a52f020487fb7cbe033dbbbdd8a421c", "committedDate": "2020-02-28T16:31:43Z", "message": "Reduce JITServer VM_stackWalkerMaySkipFrames messages\n\nAdd checks in TR_J9ServerVM::stackWalkerMaySkipFrames function\nReduce messages by caching required values to VMInfo\nAdd message handling in JITServer messageType::VM_getVMInfo\nRemove javaVM->jlrAccessibleObject in JITServer functions since it is depriciated\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}, "afterCommit": {"oid": "7645f503f1b6bc7ca7f2b28039786c76701fc96e", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/7645f503f1b6bc7ca7f2b28039786c76701fc96e", "committedDate": "2020-02-28T21:36:06Z", "message": "Change JITServer VM_stackWalkerMaySkipFrames message to return value of javaVM->jlrMethodInvoke\n\nJITServer stackWalkerMaySkipFrames functions are mostly done on the server VM, since VMInfo is caced at the server\nOnly need to query client for javaVM->jlrMethodInvoke method\nUsing VM_stackWalkerMaySkipFrames message to transfer jlrMethodInvoke value between server and client\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzE5NzY0", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#pullrequestreview-366719764", "createdAt": "2020-02-28T22:20:45Z", "commit": {"oid": "cdb4ca7ea05e3e1259f9997f46adaae8efe44eaa"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMjoyMDo0NVrOFwEd3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMjo1MDo0MlrOFwFBEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk0OTE0OA==", "bodyText": "You still need to receive a message from the server.", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385949148", "createdAt": "2020-02-28T22:20:45Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -551,10 +566,11 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          break;\n       case MessageType::VM_stackWalkerMaySkipFrames:\n          {\n-         auto recv = client->getRecvData<TR_OpaqueMethodBlock *, TR_OpaqueClassBlock *>();\n-         TR_OpaqueMethodBlock *method = std::get<0>(recv);\n-         TR_OpaqueClassBlock *clazz = std::get<1>(recv);\n-         client->write(response, fe->stackWalkerMaySkipFrames(method, clazz));\n+         // auto recv = client->getRecvData<TR_OpaqueMethodBlock *, TR_OpaqueClassBlock *>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdb4ca7ea05e3e1259f9997f46adaae8efe44eaa"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk1ODE2Mg==", "bodyText": "After asking the client about the value of vmInfo->jlrMethodInvoke you need another check against NULL. According to the original code if vmInfo->jlrMethodInvoke == NULL  you can return true", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r385958162", "createdAt": "2020-02-28T22:50:42Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -692,9 +692,41 @@ TR_J9ServerVM::getStaticReferenceFieldAtAddress(uintptrj_t fieldAddress)\n bool\n TR_J9ServerVM::stackWalkerMaySkipFrames(TR_OpaqueMethodBlock *method, TR_OpaqueClassBlock *clazz)\n    {\n+   if(!method)\n+      {\n+      return false;\n+      }\n+\n    JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n-   stream->write(JITServer::MessageType::VM_stackWalkerMaySkipFrames, method, clazz);\n-   return std::get<0>(stream->read<bool>());\n+   auto *vmInfo = _compInfoPT->getClientData()->getOrCacheVMInfo(stream);\n+   \n+   if (vmInfo->_jlrMethodInvoke == NULL)\n+      {\n+      stream->write(JITServer::MessageType::VM_stackWalkerMaySkipFrames, JITServer::Void());\n+      vmInfo->_jlrMethodInvoke = std::get<0>(stream->read<J9Method*>());\n+      // stream->write(JITServer::MessageType::VM_stackWalkerMaySkipFrames, method, clazz);\n+      // return std::get<0>(stream->read<bool>());\n+      }\n+   if (vmInfo->_jlrMethodInvoke == ((J9Method *) method))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdb4ca7ea05e3e1259f9997f46adaae8efe44eaa"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdb4ca7ea05e3e1259f9997f46adaae8efe44eaa", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/cdb4ca7ea05e3e1259f9997f46adaae8efe44eaa", "committedDate": "2020-02-28T21:58:17Z", "message": "Remove javaVM->jlrAccessibleObject\n\njlrAccessibleObject is depriciated, thus removed from J9JavaVM\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}, "afterCommit": {"oid": "9edde168759c2a0b56b64b8f34b24f912039fb15", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9edde168759c2a0b56b64b8f34b24f912039fb15", "committedDate": "2020-03-02T15:27:02Z", "message": "Remove javaVM->jlrAccessibleObject\n\njlrAccessibleObject is depriciated, thus removed from J9JavaVM\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MzQ5NjE4", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#pullrequestreview-367349618", "createdAt": "2020-03-02T16:40:20Z", "commit": {"oid": "9edde168759c2a0b56b64b8f34b24f912039fb15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNjo0MDoyMFrOFwmqfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNjo0MDoyMFrOFwmqfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwOTQzOQ==", "bodyText": "Ideally the test vmInfo->_jlrMethodInvoke == NULL is performed before vmInfo->_jlrMethodInvoke == ((J9Method *) method). Lets push that vmInfo->_jlrMethodInvoke == NULL test above like this:\nif (vmInfo->_jlrMethodInvoke == NULL)\n      {\n      // Cached information could be outdated. Ask the client again.\n      stream->write(JITServer::MessageType::VM_stackWalkerMaySkipFrames, JITServer::Void());\n      vmInfo->_jlrMethodInvoke = std::get<0>(stream->read<J9Method*>());\n      if (vmInfo->_jlrMethodInvoke == NULL)\n         return true;\n      }\nif (vmInfo->_jlrMethodInvoke == ((J9Method *) method)\n    return true;", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r386509439", "createdAt": "2020-03-02T16:40:20Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -692,9 +692,40 @@ TR_J9ServerVM::getStaticReferenceFieldAtAddress(uintptrj_t fieldAddress)\n bool\n TR_J9ServerVM::stackWalkerMaySkipFrames(TR_OpaqueMethodBlock *method, TR_OpaqueClassBlock *clazz)\n    {\n+   if(!method)\n+      {\n+      return false;\n+      }\n+\n    JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n-   stream->write(JITServer::MessageType::VM_stackWalkerMaySkipFrames, method, clazz);\n-   return std::get<0>(stream->read<bool>());\n+   auto *vmInfo = _compInfoPT->getClientData()->getOrCacheVMInfo(stream);\n+   \n+   if (vmInfo->_jlrMethodInvoke == NULL)\n+      {\n+      stream->write(JITServer::MessageType::VM_stackWalkerMaySkipFrames, JITServer::Void());\n+      vmInfo->_jlrMethodInvoke = std::get<0>(stream->read<J9Method*>());\n+      }\n+   // If _jlrMethodInvoke is NULL at the client, return true\n+   if (vmInfo->_jlrMethodInvoke == ((J9Method *) method) || vmInfo->_jlrMethodInvoke == NULL)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9edde168759c2a0b56b64b8f34b24f912039fb15"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9edde168759c2a0b56b64b8f34b24f912039fb15", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9edde168759c2a0b56b64b8f34b24f912039fb15", "committedDate": "2020-03-02T15:27:02Z", "message": "Remove javaVM->jlrAccessibleObject\n\njlrAccessibleObject is depriciated, thus removed from J9JavaVM\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}, "afterCommit": {"oid": "3b4afbfc72e42ed3af4c77263eabae98afadbf9e", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3b4afbfc72e42ed3af4c77263eabae98afadbf9e", "committedDate": "2020-03-02T17:01:10Z", "message": "Remove javaVM->jlrAccessibleObject\n\njlrAccessibleObject is depriciated, thus removed from J9JavaVM\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd5eda47f9b920337f497227c9bfe2d9b4bd0220", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/dd5eda47f9b920337f497227c9bfe2d9b4bd0220", "committedDate": "2020-03-02T18:03:04Z", "message": "Change JITServer VM_stackWalkerMaySkipFrames message to return value of javaVM->jlrMethodInvoke\n\nJITServer stackWalkerMaySkipFrames functions are mostly done on the server VM, since VMInfo is caced at the server\nOnly need to query client for javaVM->jlrMethodInvoke method\nUsing VM_stackWalkerMaySkipFrames message to transfer jlrMethodInvoke value between server and client\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da20109214ddcb881edb45b95869b322752b1cab", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/da20109214ddcb881edb45b95869b322752b1cab", "committedDate": "2020-03-02T18:03:11Z", "message": "Remove javaVM->jlrAccessibleObject\n\njlrAccessibleObject is depriciated, thus removed from J9JavaVM\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b4afbfc72e42ed3af4c77263eabae98afadbf9e", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3b4afbfc72e42ed3af4c77263eabae98afadbf9e", "committedDate": "2020-03-02T17:01:10Z", "message": "Remove javaVM->jlrAccessibleObject\n\njlrAccessibleObject is depriciated, thus removed from J9JavaVM\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}, "afterCommit": {"oid": "da20109214ddcb881edb45b95869b322752b1cab", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/da20109214ddcb881edb45b95869b322752b1cab", "committedDate": "2020-03-02T18:03:11Z", "message": "Remove javaVM->jlrAccessibleObject\n\njlrAccessibleObject is depriciated, thus removed from J9JavaVM\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MDYwMjQ2", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#pullrequestreview-368060246", "createdAt": "2020-03-03T15:10:30Z", "commit": {"oid": "da20109214ddcb881edb45b95869b322752b1cab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTc3MDY4", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#pullrequestreview-371977068", "createdAt": "2020-03-10T14:00:36Z", "commit": {"oid": "0fe41d824311d3ad383b07d5dac7e4e919910602"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDowMDozN1rOF0QDyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDowMDozN1rOF0QDyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMzMzM4NA==", "bodyText": "I see that the VM sets srConstructorAccessor and srMethodAccessor in succession, so if one can be null the other one can be too.\nI also suggest getting all 3 fields that we need from the client in one message, rather than sending separate messages.", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#discussion_r390333384", "createdAt": "2020-03-10T14:00:37Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -692,9 +692,48 @@ TR_J9ServerVM::getStaticReferenceFieldAtAddress(uintptrj_t fieldAddress)\n bool\n TR_J9ServerVM::stackWalkerMaySkipFrames(TR_OpaqueMethodBlock *method, TR_OpaqueClassBlock *clazz)\n    {\n+   if(!method)\n+      {\n+      return false;\n+      }\n+\n    JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n-   stream->write(JITServer::MessageType::VM_stackWalkerMaySkipFrames, method, clazz);\n-   return std::get<0>(stream->read<bool>());\n+   auto *vmInfo = _compInfoPT->getClientData()->getOrCacheVMInfo(stream);\n+   \n+   if (vmInfo->_jlrMethodInvoke == NULL)\n+      {\n+      // Cached information could be outdated. Ask the client again.\n+      stream->write(JITServer::MessageType::VM_stackWalkerMaySkipFrames, JITServer::Void());\n+      vmInfo->_jlrMethodInvoke = std::get<0>(stream->read<J9Method*, TR_OpaqueClassBlock*>());\n+      if (vmInfo->_jlrMethodInvoke == NULL)\n+         return true;\n+      }\n+   if (vmInfo->_jlrMethodInvoke == ((J9Method *) method))\n+      {\n+      return true;\n+      }\n+   if(!clazz)\n+      {\n+      return false;\n+      }\n+#if defined(J9VM_OPT_SIDECAR)\n+   if (vmInfo->_srMethodAccessorClass == NULL)\n+      {\n+      // Cached information could be outdated. Ask the client again.\n+      stream->write(JITServer::MessageType::VM_stackWalkerMaySkipFrames, JITServer::Void());\n+      vmInfo->_srMethodAccessorClass = std::get<1>(stream->read<J9Method*, TR_OpaqueClassBlock*>());\n+      }\n+   if (vmInfo->_srMethodAccessorClass != NULL && TR_J9ServerVM::isInstanceOf( clazz, vmInfo->_srMethodAccessorClass ,false))\n+      {\n+      return true;\n+      }\n+   if (vmInfo->_srConstructorAccessorClass != NULL && TR_J9ServerVM::isInstanceOf( clazz, vmInfo->_srConstructorAccessorClass ,false))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fe41d824311d3ad383b07d5dac7e4e919910602"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0fe41d824311d3ad383b07d5dac7e4e919910602", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/0fe41d824311d3ad383b07d5dac7e4e919910602", "committedDate": "2020-03-09T22:28:06Z", "message": "Add javaVM->srMethodAccessor to JITServer VM_stackWalkerMaySkipFrames message to return values\n\njavaVM->srMethodAccessor might be unset at the begining and set later on\nJITServer should query client for this value if undefined\nAdd relative checks into JITServer stackWalkerMaySkipFrames functions\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}, "afterCommit": {"oid": "ecf35beae490542aa3a53ee8295ab32572f36641", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ecf35beae490542aa3a53ee8295ab32572f36641", "committedDate": "2020-03-10T15:26:30Z", "message": "Add javaVM->srMethodAccessor and srConstructorAccessor to JITServer VM_stackWalkerMaySkipFrames message to return values\n\njavaVM->srMethodAccessor and javaVM->srConstructorAccessor might be unset at the begining and set later on\nJITServer should query client for this value if undefined\nAdd relative checks into JITServer stackWalkerMaySkipFrames functions\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b276e247c86b225aea04be9d3a330dd54880abc", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8b276e247c86b225aea04be9d3a330dd54880abc", "committedDate": "2020-03-10T19:10:29Z", "message": "Add javaVM->srMethodAccessor and srConstructorAccessor to JITServer VM_stackWalkerMaySkipFrames message to return values\n\njavaVM->srMethodAccessor and javaVM->srConstructorAccessor might be unset at the begining and set later on\nJITServer should query client for this value if undefined\nAdd relative checks into JITServer stackWalkerMaySkipFrames functions\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e50bd9a579485bc933d1425523550e54fdc71f5", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5e50bd9a579485bc933d1425523550e54fdc71f5", "committedDate": "2020-03-10T16:02:44Z", "message": "Merge branch 'master' into dev_reduce_num_of_VM_stackWalkerMaySkipFrames_msg"}, "afterCommit": {"oid": "8b276e247c86b225aea04be9d3a330dd54880abc", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8b276e247c86b225aea04be9d3a330dd54880abc", "committedDate": "2020-03-10T19:10:29Z", "message": "Add javaVM->srMethodAccessor and srConstructorAccessor to JITServer VM_stackWalkerMaySkipFrames message to return values\n\njavaVM->srMethodAccessor and javaVM->srConstructorAccessor might be unset at the begining and set later on\nJITServer should query client for this value if undefined\nAdd relative checks into JITServer stackWalkerMaySkipFrames functions\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61a3164b2788a2991175cd0afa9410949d9efee3", "author": {"user": {"login": "chrisc66", "name": "Zichun (Chris) Chong"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/61a3164b2788a2991175cd0afa9410949d9efee3", "committedDate": "2020-03-10T19:17:22Z", "message": "Merge branch 'master' into dev_reduce_num_of_VM_stackWalkerMaySkipFrames_msg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjgxMzc3", "url": "https://github.com/eclipse-openj9/openj9/pull/8680#pullrequestreview-372281377", "createdAt": "2020-03-10T20:04:41Z", "commit": {"oid": "61a3164b2788a2991175cd0afa9410949d9efee3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 619, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}