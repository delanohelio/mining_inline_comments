{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMjA4OTM5", "number": 11061, "title": "Support surrogate pairs in case insensitive string comparison", "bodyText": "Changed for the following methods:\nequalsIgnoreCase\ncompareToIgnoreCase\nregionMatches with ignoreCase parameter set to true\nSigned-off-by: Mike Zhang mike.h.zhang@ibm.com\nFixes #10758\nfyi: @tajila", "createdAt": "2020-10-30T18:35:02Z", "url": "https://github.com/eclipse-openj9/openj9/pull/11061", "merged": true, "mergeCommit": {"oid": "f9c7b61808abbcbd9ec218f6ee7bcda660f9d866"}, "closed": true, "closedAt": "2020-11-13T18:42:41Z", "author": {"login": "mikezhang1234567890"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXsGCvgFqTUyMDk4Mzg2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcLqZpgFqTUzMDMxNzMyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTgzODY3", "url": "https://github.com/eclipse-openj9/openj9/pull/11061#pullrequestreview-520983867", "createdAt": "2020-10-30T19:39:54Z", "commit": {"oid": "6f5c2fdec582bcf352041c912c5c999028ba5596"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOTozOTo1NFrOHrdjJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOTozOTo1NFrOHrdjJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMzNDk0OA==", "bodyText": "I expect the compareValue(int codepoint) code should be the same logic as compareValue(char c). It should either compare with 128, or the check against 128 should be removed here.\n@fjeremic  any JIT opinions?", "url": "https://github.com/eclipse-openj9/openj9/pull/11061#discussion_r515334948", "createdAt": "2020-10-30T19:39:54Z", "author": {"login": "pshipton"}, "path": "jcl/src/java.base/share/classes/java/lang/String.java", "diffHunk": "@@ -1429,6 +1429,14 @@ public int compareTo(String string) {\n \t\treturn s1len - s2len;\n \t}\n \n+\tprivate int compareValue(int codepoint) {\n+\t\tif ('A' <= codepoint && codepoint <= 'Z') {\n+\t\t\treturn codepoint + ('a' - 'A');\n+\t\t}\n+\n+\t\treturn Character.toLowerCase(Character.toUpperCase(codepoint));\n+\t}\n+\n \tprivate char compareValue(char c) {\n \t\tif (c < 128) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f5c2fdec582bcf352041c912c5c999028ba5596"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTkwMzg1", "url": "https://github.com/eclipse-openj9/openj9/pull/11061#pullrequestreview-520990385", "createdAt": "2020-10-30T19:51:31Z", "commit": {"oid": "6f5c2fdec582bcf352041c912c5c999028ba5596"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOTo1MTozMlrOHreFjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOTo1MTozMlrOHreFjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM0Mzc1Ng==", "bodyText": "Shouldn't this be doing Character.toUpperCase(Character.toLowerCase(codepoint)) similarly to compareValue()?", "url": "https://github.com/eclipse-openj9/openj9/pull/11061#discussion_r515343756", "createdAt": "2020-10-30T19:51:32Z", "author": {"login": "pshipton"}, "path": "jcl/src/java.base/share/classes/java/lang/String.java", "diffHunk": "@@ -1771,14 +1793,25 @@ public boolean equalsIgnoreCase(String string) {\n \n \t\t\tif (charAtO1Last != charAtO2Last &&\n \t\t\t\t\ttoUpperCase(charAtO1Last) != toUpperCase(charAtO2Last) &&\n-\t\t\t\t\t((charAtO1Last <= 255 && charAtO2Last <= 255) || Character.toLowerCase(charAtO1Last) != Character.toLowerCase(charAtO2Last))) {\n+\t\t\t\t\t((charAtO1Last <= 255 && charAtO2Last <= 255) || Character.toLowerCase(charAtO1Last) != Character.toLowerCase(charAtO2Last)) &&\n+\t\t\t\t\t(!Character.isLowSurrogate(charAtO1Last) || !Character.isLowSurrogate(charAtO2Last))) {\n \t\t\t\treturn false;\n \t\t\t}\n \n \t\t\twhile (o1 < end - 1) {\n \t\t\t\tchar charAtO1 = s1.charAtInternal(o1++, s1Value);\n \t\t\t\tchar charAtO2 = s2.charAtInternal(o2++, s2Value);\n \n+\t\t\t\t/*[IF Java16]*/\n+\t\t\t\tif (Character.isHighSurrogate(charAtO1) && Character.isHighSurrogate(charAtO2)) {\n+\t\t\t\t\tint codepointAtO1 = Character.toCodePoint(charAtO1, s1.charAtInternal(o1++, s1Value));\n+\t\t\t\t\tint codepointAtO2 = Character.toCodePoint(charAtO2, s2.charAtInternal(o2++, s2Value));\n+\t\t\t\t\tif ((codepointAtO1 != codepointAtO2) && (Character.toUpperCase(codepointAtO1) != Character.toUpperCase(codepointAtO2))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f5c2fdec582bcf352041c912c5c999028ba5596"}, "originalPosition": 61}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f5c2fdec582bcf352041c912c5c999028ba5596", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/6f5c2fdec582bcf352041c912c5c999028ba5596", "committedDate": "2020-10-30T18:09:57Z", "message": "Support surrogate pairs in case insensitive string comparison\n\nChanged for the following methods:\nequalsIgnoreCase\ncompareToIgnoreCase\nregionMatches with ignoreCase parameter set to true\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}, "afterCommit": {"oid": "ccc0a3b35910433db36cd5f026d065dd661ec84d", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ccc0a3b35910433db36cd5f026d065dd661ec84d", "committedDate": "2020-11-02T17:55:52Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ccc0a3b35910433db36cd5f026d065dd661ec84d", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ccc0a3b35910433db36cd5f026d065dd661ec84d", "committedDate": "2020-11-02T17:55:52Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}, "afterCommit": {"oid": "786adc3dadc562610b03f8426315a8b5b78cb594", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/786adc3dadc562610b03f8426315a8b5b78cb594", "committedDate": "2020-11-02T18:41:01Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "786adc3dadc562610b03f8426315a8b5b78cb594", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/786adc3dadc562610b03f8426315a8b5b78cb594", "committedDate": "2020-11-02T18:41:01Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}, "afterCommit": {"oid": "7eda4861d5f4c2766d45337a102d43f7afeebf89", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/7eda4861d5f4c2766d45337a102d43f7afeebf89", "committedDate": "2020-11-02T18:44:31Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\n[ci skip]\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NjAwNjY1", "url": "https://github.com/eclipse-openj9/openj9/pull/11061#pullrequestreview-528600665", "createdAt": "2020-11-11T23:09:42Z", "commit": {"oid": "7eda4861d5f4c2766d45337a102d43f7afeebf89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMzowOTo0M1rOHxhkUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMzowOTo0M1rOHxhkUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5MjI0MQ==", "bodyText": "I think this should be included for Java16+ only.", "url": "https://github.com/eclipse-openj9/openj9/pull/11061#discussion_r521692241", "createdAt": "2020-11-11T23:09:43Z", "author": {"login": "pshipton"}, "path": "jcl/src/java.base/share/classes/java/lang/String.java", "diffHunk": "@@ -1771,14 +1791,25 @@ public boolean equalsIgnoreCase(String string) {\n \n \t\t\tif (charAtO1Last != charAtO2Last &&\n \t\t\t\t\ttoUpperCase(charAtO1Last) != toUpperCase(charAtO2Last) &&\n-\t\t\t\t\t((charAtO1Last <= 255 && charAtO2Last <= 255) || Character.toLowerCase(charAtO1Last) != Character.toLowerCase(charAtO2Last))) {\n+\t\t\t\t\t((charAtO1Last <= 255 && charAtO2Last <= 255) || Character.toLowerCase(charAtO1Last) != Character.toLowerCase(charAtO2Last)) &&\n+\t\t\t\t\t(!Character.isLowSurrogate(charAtO1Last) || !Character.isLowSurrogate(charAtO2Last))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7eda4861d5f4c2766d45337a102d43f7afeebf89"}, "originalPosition": 56}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7eda4861d5f4c2766d45337a102d43f7afeebf89", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/7eda4861d5f4c2766d45337a102d43f7afeebf89", "committedDate": "2020-11-02T18:44:31Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\n[ci skip]\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}, "afterCommit": {"oid": "c68d088304674e09400e60cd798fead3de0668db", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c68d088304674e09400e60cd798fead3de0668db", "committedDate": "2020-11-12T20:40:36Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\n[ci skip]\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDg5MjY3", "url": "https://github.com/eclipse-openj9/openj9/pull/11061#pullrequestreview-529489267", "createdAt": "2020-11-12T20:54:36Z", "commit": {"oid": "c68d088304674e09400e60cd798fead3de0668db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDo1NDozNlrOHyN_fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDo1NDozNlrOHyN_fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQyMDA5Mw==", "bodyText": "Pls make the change for jdk16 only to avoid changing perf for older versions.", "url": "https://github.com/eclipse-openj9/openj9/pull/11061#discussion_r522420093", "createdAt": "2020-11-12T20:54:36Z", "author": {"login": "pshipton"}, "path": "jcl/src/java.base/share/classes/java/lang/String.java", "diffHunk": "@@ -1769,16 +1789,32 @@ public boolean equalsIgnoreCase(String string) {\n \t\t\tchar charAtO1Last = s1.charAtInternal(s1len - 1, s1Value);\n \t\t\tchar charAtO2Last = s2.charAtInternal(s1len - 1, s2Value);\n \n-\t\t\tif (charAtO1Last != charAtO2Last &&\n-\t\t\t\t\ttoUpperCase(charAtO1Last) != toUpperCase(charAtO2Last) &&\n-\t\t\t\t\t((charAtO1Last <= 255 && charAtO2Last <= 255) || Character.toLowerCase(charAtO1Last) != Character.toLowerCase(charAtO2Last))) {\n+\t\t\tif (charAtO1Last != charAtO2Last\n+\t\t\t\t\t&& toUpperCase(charAtO1Last) != toUpperCase(charAtO2Last)\n+\t\t\t\t\t&& ((charAtO1Last <= 255 && charAtO2Last <= 255) || Character.toLowerCase(charAtO1Last) != Character.toLowerCase(charAtO2Last))\n+\t\t\t\t\t/*[IF Java16]*/\n+\t\t\t\t\t&& (!Character.isLowSurrogate(charAtO1Last) || !Character.isLowSurrogate(charAtO2Last))\n+\t\t\t\t\t/*[ENDIF] Java16 */\n+\t\t\t) {\n \t\t\t\treturn false;\n \t\t\t}\n \n-\t\t\twhile (o1 < end - 1) {\n+\t\t\twhile (o1 < end) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c68d088304674e09400e60cd798fead3de0668db"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "493d12e61f28131f1919c6f33294064ccf165894", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/493d12e61f28131f1919c6f33294064ccf165894", "committedDate": "2020-11-12T21:23:42Z", "message": "Support surrogate pairs in case insensitive string comparison\n\nChanged for the following methods:\nequalsIgnoreCase\ncompareToIgnoreCase\nregionMatches with ignoreCase parameter set to true\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c68d088304674e09400e60cd798fead3de0668db", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c68d088304674e09400e60cd798fead3de0668db", "committedDate": "2020-11-12T20:40:36Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\n[ci skip]\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}, "afterCommit": {"oid": "727d232565d6554f4fb73e098733ee0b694a4f02", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/727d232565d6554f4fb73e098733ee0b694a4f02", "committedDate": "2020-11-12T21:23:42Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\n[ci skip]\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "727d232565d6554f4fb73e098733ee0b694a4f02", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/727d232565d6554f4fb73e098733ee0b694a4f02", "committedDate": "2020-11-12T21:23:42Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\n[ci skip]\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}, "afterCommit": {"oid": "62e882a392ebad0b63b757e8b3e99e56d40649b7", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/62e882a392ebad0b63b757e8b3e99e56d40649b7", "committedDate": "2020-11-13T15:22:06Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\n[ci skip]\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fd6050326e3eeca457a7f82f97d2e1c8b58c2d2", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/0fd6050326e3eeca457a7f82f97d2e1c8b58c2d2", "committedDate": "2020-11-13T18:06:01Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\n[ci skip]\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62e882a392ebad0b63b757e8b3e99e56d40649b7", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/62e882a392ebad0b63b757e8b3e99e56d40649b7", "committedDate": "2020-11-13T15:22:06Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\n[ci skip]\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}, "afterCommit": {"oid": "0fd6050326e3eeca457a7f82f97d2e1c8b58c2d2", "author": {"user": {"login": "mikezhang1234567890", "name": "Mike Zhang"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/0fd6050326e3eeca457a7f82f97d2e1c8b58c2d2", "committedDate": "2020-11-13T18:06:01Z", "message": "Tests for case insensitive string comparison on surrogate pairs\n\n[ci skip]\n\nSigned-off-by: Mike Zhang <mike.h.zhang@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMzE3MzI3", "url": "https://github.com/eclipse-openj9/openj9/pull/11061#pullrequestreview-530317327", "createdAt": "2020-11-13T18:42:23Z", "commit": {"oid": "0fd6050326e3eeca457a7f82f97d2e1c8b58c2d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 65, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}