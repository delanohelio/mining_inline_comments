{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNjMzNTM5", "number": 8277, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODozMToxMVrODYRXPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNToyMzozNFrODYilqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2Nzc2ODk1OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/env/j9method.cpp", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODozMToxMVrOFeCMvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMToyNzozN1rOFeLkJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzNzYzMA==", "bodyText": "Maybe have an assert saying that we must have VM access when calling this API", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367037630", "createdAt": "2020-01-15T18:31:11Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/j9method.cpp", "diffHunk": "@@ -6040,10 +6040,12 @@ TR_ResolvedJ9Method::isUnresolvedConstantDynamic(I_32 cpIndex)\n    }\n \n void *\n-TR_ResolvedJ9Method::dynamicConstant(I_32 cpIndex)\n+TR_ResolvedJ9Method::dynamicConstant(I_32 cpIndex, uintptrj_t &obj)\n    {\n    TR_ASSERT_FATAL(cpIndex != -1, \"ConstantDynamic cpIndex shouldn't be -1\");\n-   return &((J9RAMConstantDynamicRef *) literals())[cpIndex].value;\n+   uintptrj_t *objLocation = (uintptrj_t *)&(((J9RAMConstantDynamicRef *) literals())[cpIndex].value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzMzU3MA==", "bodyText": "The assert check will fail with J9::SymbolReferenceTable::findOrCreateConstantDynamicSymbol() which doesn't acquire VM access before calling dynamicConstant(). It doesn't dereference the pointer.", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367133570", "createdAt": "2020-01-15T22:09:47Z", "author": {"login": "a7ehuo"}, "path": "runtime/compiler/env/j9method.cpp", "diffHunk": "@@ -6040,10 +6040,12 @@ TR_ResolvedJ9Method::isUnresolvedConstantDynamic(I_32 cpIndex)\n    }\n \n void *\n-TR_ResolvedJ9Method::dynamicConstant(I_32 cpIndex)\n+TR_ResolvedJ9Method::dynamicConstant(I_32 cpIndex, uintptrj_t &obj)\n    {\n    TR_ASSERT_FATAL(cpIndex != -1, \"ConstantDynamic cpIndex shouldn't be -1\");\n-   return &((J9RAMConstantDynamicRef *) literals())[cpIndex].value;\n+   uintptrj_t *objLocation = (uintptrj_t *)&(((J9RAMConstantDynamicRef *) literals())[cpIndex].value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzNzYzMA=="}, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE5MTA3OQ==", "bodyText": "ok", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367191079", "createdAt": "2020-01-16T01:27:37Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/j9method.cpp", "diffHunk": "@@ -6040,10 +6040,12 @@ TR_ResolvedJ9Method::isUnresolvedConstantDynamic(I_32 cpIndex)\n    }\n \n void *\n-TR_ResolvedJ9Method::dynamicConstant(I_32 cpIndex)\n+TR_ResolvedJ9Method::dynamicConstant(I_32 cpIndex, uintptrj_t &obj)\n    {\n    TR_ASSERT_FATAL(cpIndex != -1, \"ConstantDynamic cpIndex shouldn't be -1\");\n-   return &((J9RAMConstantDynamicRef *) literals())[cpIndex].value;\n+   uintptrj_t *objLocation = (uintptrj_t *)&(((J9RAMConstantDynamicRef *) literals())[cpIndex].value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzNzYzMA=="}, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzgwMzI0OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/env/j9method.h", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODo0MzoyOVrOFeCijQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODo0MzoyOVrOFeCijQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0MzIxMw==", "bodyText": "Maybe just describe what the function does without a mention to JITServer", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367043213", "createdAt": "2020-01-15T18:43:29Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/j9method.h", "diffHunk": "@@ -397,10 +397,16 @@ class TR_ResolvedJ9Method : public TR_J9Method, public TR_ResolvedJ9MethodBase\n     *  \\param cpIndex\n     *     The constant pool index of the constant dynamic.\n     *\n+    *  \\param obj\n+    *     Return the resolved constant dynamic value.\n+    *\n     *  \\return\n     *     Opaque pointer to the slot containing the resolved constant dynamic value.\n+    *     In the JITServer mode, the returned pointer should always be dereferenced", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzgwNzU2OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/env/j9methodServer.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODo0NToxMlrOFeClUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODo0NToxMlrOFeClUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0MzkyMA==", "bodyText": "I think you can make this a reference", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367043920", "createdAt": "2020-01-15T18:45:12Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/j9methodServer.cpp", "diffHunk": "@@ -231,6 +239,18 @@ TR_ResolvedJ9JITServerMethod::classOfStatic(I_32 cpIndex, bool returnClassForAOT\n    return classOfStatic;\n    }\n \n+void *\n+TR_ResolvedJ9JITServerMethod::getConstantDynamicTypeFromCP(I_32 cpIndex)\n+   {\n+   TR_ASSERT_FATAL(cpIndex != -1, \"ConstantDynamic cpIndex shouldn't be -1\");\n+   _stream->write(JITServer::MessageType::ResolvedMethod_getConstantDynamicTypeFromCP, _remoteMirror, cpIndex);\n+\n+   const std::string retConstantDynamicTypeStr = std::get<0>(_stream->read<std::string>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzgyNDQwOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODo1MTowOVrOFeCv-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODo1MTowOVrOFeCv-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0NjY1MQ==", "bodyText": "Inside there is an object dereference which needs to be protected with VM access, just like the non-jitserver code does.", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367046651", "createdAt": "2020-01-15T18:51:09Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -1775,6 +1775,39 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, ramMethods, vTableOffsets, methodInfos);\n          }\n          break;\n+      case MessageType::ResolvedMethod_getConstantDynamicTypeFromCP:\n+         {\n+         auto recv = client->getRecvData<TR_ResolvedJ9Method *, int32_t>();\n+         auto mirror = std::get<0>(recv);\n+         auto cpIndex = std::get<1>(recv);\n+\n+         J9UTF8 *constantDynamicTypeUtf8 = (J9UTF8 *)mirror->getConstantDynamicTypeFromCP(cpIndex);\n+         int constantDynamicTypeUtf8Length = J9UTF8_LENGTH(constantDynamicTypeUtf8);\n+         char* constantDynamicTypeUtf8Data = (char *)J9UTF8_DATA(constantDynamicTypeUtf8);\n+\n+         client->write(response, std::string(constantDynamicTypeUtf8Data, constantDynamicTypeUtf8Length));\n+         }\n+         break;\n+      case MessageType::ResolvedMethod_isUnresolvedConstantDynamic:\n+         {\n+         auto recv = client->getRecvData<TR_ResolvedJ9Method *, int32_t>();\n+         auto mirror = std::get<0>(recv);\n+         auto cpIndex = std::get<1>(recv);\n+\n+         client->write(response, mirror->isUnresolvedConstantDynamic(cpIndex));\n+         }\n+         break;\n+      case MessageType::ResolvedMethod_dynamicConstant:\n+         {\n+         auto recv = client->getRecvData<TR_ResolvedJ9Method *, int32_t>();\n+         auto mirror = std::get<0>(recv);\n+         auto cpIndex = std::get<1>(recv);\n+\n+         uintptrj_t obj = 0;\n+         uintptrj_t *objLocation = (uintptrj_t*)mirror->dynamicConstant(cpIndex, obj);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2ODAzNDMzOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/ilgen/Walker.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMDowNToxOFrOFeE1Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMDowNToxOFrOFeE1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4MDc1NQ==", "bodyText": "Below, when doing loadConstant(TR::iconst, *(int32_t*)(obj+valueOffset)); we can run into trouble for JITServer. Maybe that tryToAcquireVMAccess is implemented such that it always fails on JITServer", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367080755", "createdAt": "2020-01-15T20:05:18Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/ilgen/Walker.cpp", "diffHunk": "@@ -5568,8 +5568,8 @@ TR_J9ByteCodeIlGenerator::loadFromCP(TR::DataType type, int32_t cpIndex)\n                                                             comp());\n                   if (primitiveCondyCriticalSection.hasVMAccess())\n                      {\n-                     uintptrj_t* objLocation = (uintptrj_t*)_methodSymbol->getResolvedMethod()->dynamicConstant(cpIndex);\n-                     uintptrj_t obj = *objLocation;\n+                     uintptrj_t obj = 0;\n+                     uintptrj_t* objLocation = (uintptrj_t*)_methodSymbol->getResolvedMethod()->dynamicConstant(cpIndex, obj);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2a03a167a55647ca2ae2f3e427e9030ecee41e"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDUyMjUxOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/ilgen/Walker.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTowNToxMlrOFecgvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNjo0MDozMlrOFegDrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2ODczNA==", "bodyText": "This is a change in behavior; previously the compilation thread acquired VM access and potentially waited to do so. With the new code the compilation thread attempts to acquire VM access, but if it cannot get it right away, it bails out.\nI would like some confirmation from the optimizer team that this new behavior is ok (may have performance implications) and that there is a safe path if we don't wait for VM access.", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367468734", "createdAt": "2020-01-16T15:05:12Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/ilgen/Walker.cpp", "diffHunk": "@@ -5465,13 +5465,19 @@ TR_J9ByteCodeIlGenerator::loadFromCP(TR::DataType type, int32_t cpIndex)\n             // Use aconst for null object\n             if (!isCondyPrimitive && !isCondyUnresolved)\n                {\n-               TR::VMAccessCriticalSection condyCriticalSection(comp()->fej9());\n-               uintptrj_t* objLocation = (uintptrj_t*)_methodSymbol->getResolvedMethod()->dynamicConstant(cpIndex);\n-               uintptrj_t obj = *objLocation;\n-               if (obj == 0)\n+               TR::VMAccessCriticalSection condyCriticalSection(comp()->fej9(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e10bcd41beaa44431a93b0b0634313a4eecb124"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUyNjgzMA==", "bodyText": "Shouldn't change it to tryToAcquireVMAccess since we're not dereferencing the obj. Will update the code.", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367526830", "createdAt": "2020-01-16T16:40:32Z", "author": {"login": "a7ehuo"}, "path": "runtime/compiler/ilgen/Walker.cpp", "diffHunk": "@@ -5465,13 +5465,19 @@ TR_J9ByteCodeIlGenerator::loadFromCP(TR::DataType type, int32_t cpIndex)\n             // Use aconst for null object\n             if (!isCondyPrimitive && !isCondyUnresolved)\n                {\n-               TR::VMAccessCriticalSection condyCriticalSection(comp()->fej9());\n-               uintptrj_t* objLocation = (uintptrj_t*)_methodSymbol->getResolvedMethod()->dynamicConstant(cpIndex);\n-               uintptrj_t obj = *objLocation;\n-               if (obj == 0)\n+               TR::VMAccessCriticalSection condyCriticalSection(comp()->fej9(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2ODczNA=="}, "originalCommit": {"oid": "4e10bcd41beaa44431a93b0b0634313a4eecb124"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDU5MTEzOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/env/J9VMAccessCriticalSection.hpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNToyMzozNFrOFedLoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNTo0MjowNFrOFed2hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3OTcxMw==", "bodyText": "I see this piece of code:\nbool\nTR_J9VMBase::tryToAcquireAccess(TR::Compilation * comp, bool *haveAcquiredVMAccess)\n   {\n   bool hasVMAccess;\n   *haveAcquiredVMAccess = false;\n\n#if defined(JITSERVER_SUPPORT)\n   // JITServer TODO: For now, we always take the \"safe path\" on the server\n   if (comp->isOutOfProcessCompilation())\n      return false;\n#endif /* defined(JITSERVER_SUPPORT) */\n\nso even today we'll set _hasVMAccess = false and _acquiredVMAccess = false\nDo you think the new code is needed?", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367479713", "createdAt": "2020-01-16T15:23:34Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/J9VMAccessCriticalSection.hpp", "diffHunk": "@@ -64,7 +64,17 @@ class OMR_EXTENSIBLE VMAccessCriticalSection : public OMR::VMAccessCriticalSecti\n             break;\n \n          case tryToAcquireVMAccess:\n-            _hasVMAccess = TR::Compiler->vm.tryToAcquireAccess(comp, &_acquiredVMAccess);\n+#if defined(JITSERVER_SUPPORT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e10bcd41beaa44431a93b0b0634313a4eecb124"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ5MDY5Mw==", "bodyText": "The existing code in TR_J9VMBase::tryToAcquireAccess() does what's required at the server. The new code is not needed. Will be removed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8277#discussion_r367490693", "createdAt": "2020-01-16T15:42:04Z", "author": {"login": "a7ehuo"}, "path": "runtime/compiler/env/J9VMAccessCriticalSection.hpp", "diffHunk": "@@ -64,7 +64,17 @@ class OMR_EXTENSIBLE VMAccessCriticalSection : public OMR::VMAccessCriticalSecti\n             break;\n \n          case tryToAcquireVMAccess:\n-            _hasVMAccess = TR::Compiler->vm.tryToAcquireAccess(comp, &_acquiredVMAccess);\n+#if defined(JITSERVER_SUPPORT)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3OTcxMw=="}, "originalCommit": {"oid": "4e10bcd41beaa44431a93b0b0634313a4eecb124"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 741, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}