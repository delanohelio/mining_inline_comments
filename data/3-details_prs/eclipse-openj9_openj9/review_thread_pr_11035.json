{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNzk0NzA4", "number": 11035, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMzo0MDozOFrOEzTXNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMDoxMzo0M1rOE09wZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMjMwMDY5OnYy", "diffSide": "RIGHT", "path": "runtime/oti/jvminit.h", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMzo0MDozOFrOHqcS8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNTo1NzowNFrOHqi13Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2NTg0MA==", "bodyText": "Are we matching the Hotspot option here?   It would be best if we can use the same option so users get a consistent experience.\nIf not, our -XX options start with capital letters (mostly).  Renaming to something like -XX:ValueBasedClassCheck=[exception|warn] would be clearer?\nOr handled with multiple options like:\n-XX[+-]EnableValueBasedClassChecks to enable the checks\n-XX:[+-]ThrowForValueBasedClassChecks to throw an exception\n-XX:[+-]WarnForValueBasedClassChecks to warn", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514265840", "createdAt": "2020-10-29T13:40:38Z", "author": {"login": "DanHeidinga"}, "path": "runtime/oti/jvminit.h", "diffHunk": "@@ -391,6 +391,9 @@ enum INIT_STAGE {\n #define VMOPT_XXDISABLEVALHALLA \"-XX:-EnableValhalla\"\n #endif /* defined(J9VM_OPT_VALHALLA_VALUE_TYPES) */\n \n+#define VMOPT_XXADDVALUEBASEDCLASSCHECKSEXCEPTION \"-XX:addValueBasedClassChecks=exception\"\n+#define VMOPT_XXADDVALUEBASEDCLASSCHECKSWARN \"-XX:addValueBasedClassChecks=warn\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26e696a6224e1eff156e561495bba638c47e592b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM0NDYzMA==", "bodyText": "Are we matching the Hotspot option here? It would be best if we can use the same option so users get a consistent experience.\n\nI agree to use the same CML as RI. Seems that RI has not finished implementing this JEP yet. We can change this CML to match RI once we know what they use.", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514344630", "createdAt": "2020-10-29T15:21:54Z", "author": {"login": "hangshao0"}, "path": "runtime/oti/jvminit.h", "diffHunk": "@@ -391,6 +391,9 @@ enum INIT_STAGE {\n #define VMOPT_XXDISABLEVALHALLA \"-XX:-EnableValhalla\"\n #endif /* defined(J9VM_OPT_VALHALLA_VALUE_TYPES) */\n \n+#define VMOPT_XXADDVALUEBASEDCLASSCHECKSEXCEPTION \"-XX:addValueBasedClassChecks=exception\"\n+#define VMOPT_XXADDVALUEBASEDCLASSCHECKSWARN \"-XX:addValueBasedClassChecks=warn\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2NTg0MA=="}, "originalCommit": {"oid": "26e696a6224e1eff156e561495bba638c47e592b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM3MzA4NQ==", "bodyText": "Updated the CML to -XX:ValueBasedClassCheck=[exception|warn]", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514373085", "createdAt": "2020-10-29T15:57:04Z", "author": {"login": "hangshao0"}, "path": "runtime/oti/jvminit.h", "diffHunk": "@@ -391,6 +391,9 @@ enum INIT_STAGE {\n #define VMOPT_XXDISABLEVALHALLA \"-XX:-EnableValhalla\"\n #endif /* defined(J9VM_OPT_VALHALLA_VALUE_TYPES) */\n \n+#define VMOPT_XXADDVALUEBASEDCLASSCHECKSEXCEPTION \"-XX:addValueBasedClassChecks=exception\"\n+#define VMOPT_XXADDVALUEBASEDCLASSCHECKSWARN \"-XX:addValueBasedClassChecks=warn\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2NTg0MA=="}, "originalCommit": {"oid": "26e696a6224e1eff156e561495bba638c47e592b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzM0MTg2OnYy", "diffSide": "RIGHT", "path": "runtime/oti/j9.h", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzoxODo1NVrOHqme4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDoyNjozNFrOHqtWEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzMjczNw==", "bodyText": "I would add a new macro\n#define J9_CLASS_DISALLOWS_LOCKING (J9ClassIsValueType | J9ClassIsValueBased)\n#define J9_DOES_CLASS_DISALLOW_LOCKING(clazz) J9_ARE_ALL_BITS_SET((clazz)->classFlags, J9_CLASS_DISALLOWS_LOCKING)", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514432737", "createdAt": "2020-10-29T17:18:55Z", "author": {"login": "tajila"}, "path": "runtime/oti/j9.h", "diffHunk": "@@ -309,6 +309,7 @@ static const struct { \\\n \t((NULL != (interfaceClass)) && ((J9_ITABLE_INDEX_UNRESOLVED != ((methodIndexAndArgCount) & ~255))))\n \n /* Macros for ValueTypes */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ1Mjc1Mg==", "bodyText": "The JIT will be able to use the J9_CLASS_DISALLOWS_LOCKING mask instead of the existing isValueType check", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514452752", "createdAt": "2020-10-29T17:49:04Z", "author": {"login": "tajila"}, "path": "runtime/oti/j9.h", "diffHunk": "@@ -309,6 +309,7 @@ static const struct { \\\n \t((NULL != (interfaceClass)) && ((J9_ITABLE_INDEX_UNRESOLVED != ((methodIndexAndArgCount) & ~255))))\n \n /* Macros for ValueTypes */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzMjczNw=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0NTE2OA==", "bodyText": "Added new marcos, but naming them as J9_CLASS_DISALLOWS_LOCKING_FLAGS and J9_CLASS_ALLOW_LOCKING", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514545168", "createdAt": "2020-10-29T20:26:34Z", "author": {"login": "hangshao0"}, "path": "runtime/oti/j9.h", "diffHunk": "@@ -309,6 +309,7 @@ static const struct { \\\n \t((NULL != (interfaceClass)) && ((J9_ITABLE_INDEX_UNRESOLVED != ((methodIndexAndArgCount) & ~255))))\n \n /* Macros for ValueTypes */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzMjczNw=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzM0NTMxOnYy", "diffSide": "RIGHT", "path": "runtime/oti/ObjectMonitor.hpp", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzoxOTozOVrOHqmg8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDoyNjo1MFrOHqtWrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzMzI2Nw==", "bodyText": "this should just be !J9_DOES_CLASS_DISALLOW_LOCKING(clazz) no need to add the exception code to the fast path as if this fails it will call the slow path", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514433267", "createdAt": "2020-10-29T17:19:39Z", "author": {"login": "tajila"}, "path": "runtime/oti/ObjectMonitor.hpp", "diffHunk": "@@ -279,10 +280,22 @@ class VM_ObjectMonitor\n \t\tbool locked = false;\n \t\tif (LN_HAS_LOCKWORD(currentThread, object)\n #if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n-\t\t&& !J9_IS_J9CLASS_VALUETYPE(J9OBJECT_CLAZZ(currentThread, object))\n+\t\t&& !J9_IS_J9CLASS_VALUETYPE(J9OBJECT_CLAZZ(currentThread, object)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzMzU2Nw==", "bodyText": "all the exception code can be put in the slow path", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514433567", "createdAt": "2020-10-29T17:20:05Z", "author": {"login": "tajila"}, "path": "runtime/oti/ObjectMonitor.hpp", "diffHunk": "@@ -279,10 +280,22 @@ class VM_ObjectMonitor\n \t\tbool locked = false;\n \t\tif (LN_HAS_LOCKWORD(currentThread, object)\n #if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n-\t\t&& !J9_IS_J9CLASS_VALUETYPE(J9OBJECT_CLAZZ(currentThread, object))\n+\t\t&& !J9_IS_J9CLASS_VALUETYPE(J9OBJECT_CLAZZ(currentThread, object)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzMzI2Nw=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0NTMyNQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514545325", "createdAt": "2020-10-29T20:26:50Z", "author": {"login": "hangshao0"}, "path": "runtime/oti/ObjectMonitor.hpp", "diffHunk": "@@ -279,10 +280,22 @@ class VM_ObjectMonitor\n \t\tbool locked = false;\n \t\tif (LN_HAS_LOCKWORD(currentThread, object)\n #if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n-\t\t&& !J9_IS_J9CLASS_VALUETYPE(J9OBJECT_CLAZZ(currentThread, object))\n+\t\t&& !J9_IS_J9CLASS_VALUETYPE(J9OBJECT_CLAZZ(currentThread, object)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzMzI2Nw=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzQwOTE4OnYy", "diffSide": "LEFT", "path": "runtime/codert_vm/cnathelp.cpp", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozNTowOVrOHqnJNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDoyNDo1NVrOHqtSpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MzU3Mg==", "bodyText": "you can keep the original macro guards, but instead of the VT check it can be a JDK16+ check.", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514443572", "createdAt": "2020-10-29T17:35:09Z", "author": {"login": "tajila"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -1616,12 +1616,16 @@ slow_jitMonitorEnterImpl(J9VMThread *currentThread, bool forMethod)\n \t\t\t\tresolveFrame->specialFrameFlags = (resolveFrame->specialFrameFlags & ~J9_STACK_FLAGS_JIT_FRAME_SUB_TYPE_MASK) | J9_STACK_FLAGS_JIT_FAILED_METHOD_MONITOR_ENTER_RESOLVE;\n \t\t\t}\n \t\t}\n-#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3Njc1NA==", "bodyText": "If it is changed to a JDK16+ check, does it affect the current internal Valhalla builds that is JDK15 and lower ?", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514476754", "createdAt": "2020-10-29T18:26:57Z", "author": {"login": "hangshao0"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -1616,12 +1616,16 @@ slow_jitMonitorEnterImpl(J9VMThread *currentThread, bool forMethod)\n \t\t\t\tresolveFrame->specialFrameFlags = (resolveFrame->specialFrameFlags & ~J9_STACK_FLAGS_JIT_FRAME_SUB_TYPE_MASK) | J9_STACK_FLAGS_JIT_FAILED_METHOD_MONITOR_ENTER_RESOLVE;\n \t\t\t}\n \t\t}\n-#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MzU3Mg=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4MDA0MQ==", "bodyText": "VT builds should be running on JDKnext. I believe that is currently JDK16 @JasonFengJ9 can you confirm", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514480041", "createdAt": "2020-10-29T18:32:11Z", "author": {"login": "tajila"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -1616,12 +1616,16 @@ slow_jitMonitorEnterImpl(J9VMThread *currentThread, bool forMethod)\n \t\t\t\tresolveFrame->specialFrameFlags = (resolveFrame->specialFrameFlags & ~J9_STACK_FLAGS_JIT_FRAME_SUB_TYPE_MASK) | J9_STACK_FLAGS_JIT_FAILED_METHOD_MONITOR_ENTER_RESOLVE;\n \t\t\t}\n \t\t}\n-#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MzU3Mg=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ4Nzk0NQ==", "bodyText": "@tajila that's correct, Pipeline_Build_Test_JDKnext_x86-64_linux_valhalla is built on OpenJDK head stream git@github.com:ibmruntimes/openj9-openjdk-jdk.git which is called JDKnext and currently is JDK16.", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514487945", "createdAt": "2020-10-29T18:46:08Z", "author": {"login": "JasonFengJ9"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -1616,12 +1616,16 @@ slow_jitMonitorEnterImpl(J9VMThread *currentThread, bool forMethod)\n \t\t\t\tresolveFrame->specialFrameFlags = (resolveFrame->specialFrameFlags & ~J9_STACK_FLAGS_JIT_FRAME_SUB_TYPE_MASK) | J9_STACK_FLAGS_JIT_FAILED_METHOD_MONITOR_ENTER_RESOLVE;\n \t\t\t}\n \t\t}\n-#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MzU3Mg=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0NDI5Mg==", "bodyText": "Changed to JAVA_SPEC_VERSION >= 16.", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514544292", "createdAt": "2020-10-29T20:24:55Z", "author": {"login": "hangshao0"}, "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -1616,12 +1616,16 @@ slow_jitMonitorEnterImpl(J9VMThread *currentThread, bool forMethod)\n \t\t\t\tresolveFrame->specialFrameFlags = (resolveFrame->specialFrameFlags & ~J9_STACK_FLAGS_JIT_FRAME_SUB_TYPE_MASK) | J9_STACK_FLAGS_JIT_FAILED_METHOD_MONITOR_ENTER_RESOLVE;\n \t\t\t}\n \t\t}\n-#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MzU3Mg=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzQxNTY0OnYy", "diffSide": "LEFT", "path": "runtime/vm/BytecodeAction.hpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozNjo0NFrOHqnNGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDoyNTowNFrOHqtS5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NDU3MA==", "bodyText": "same here, if jdk16+", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514444570", "createdAt": "2020-10-29T17:36:44Z", "author": {"login": "tajila"}, "path": "runtime/vm/BytecodeAction.hpp", "diffHunk": "@@ -54,9 +54,7 @@ typedef enum {\n \tRUN_METHOD_INTERPRETED,\n \tRUN_JNI_NATIVE,\n \tRUN_METHOD_COMPILED,\n-#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0NDM1Nw==", "bodyText": "Changed to JAVA_SPEC_VERSION >= 16.", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514544357", "createdAt": "2020-10-29T20:25:04Z", "author": {"login": "hangshao0"}, "path": "runtime/vm/BytecodeAction.hpp", "diffHunk": "@@ -54,9 +54,7 @@ typedef enum {\n \tRUN_METHOD_INTERPRETED,\n \tRUN_JNI_NATIVE,\n \tRUN_METHOD_COMPILED,\n-#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NDU3MA=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzQxNjgxOnYy", "diffSide": "LEFT", "path": "runtime/vm/BytecodeInterpreter.hpp", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozNzowMlrOHqnN3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDoyNToxMlrOHqtTLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NDc2Ng==", "bodyText": "here as well", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514444766", "createdAt": "2020-10-29T17:37:02Z", "author": {"login": "tajila"}, "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -1557,13 +1557,10 @@ class INTERPRETER_CLASS\n \t\t\t\t\t} else {\n \t\t\t\t\t\t((UDATA*)(((J9SFStackFrame*)_sp) + 1))[-1] |= J9SF_A0_INVISIBLE_TAG;\n \t\t\t\t\t}\n-#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NTE1OQ==", "bodyText": "and other places in this file too. Essentially we want JDK15 and earlier to remain unaffected", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514445159", "createdAt": "2020-10-29T17:37:42Z", "author": {"login": "tajila"}, "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -1557,13 +1557,10 @@ class INTERPRETER_CLASS\n \t\t\t\t\t} else {\n \t\t\t\t\t\t((UDATA*)(((J9SFStackFrame*)_sp) + 1))[-1] |= J9SF_A0_INVISIBLE_TAG;\n \t\t\t\t\t}\n-#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NDc2Ng=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0NDQzMQ==", "bodyText": "Fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514544431", "createdAt": "2020-10-29T20:25:12Z", "author": {"login": "hangshao0"}, "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -1557,13 +1557,10 @@ class INTERPRETER_CLASS\n \t\t\t\t\t} else {\n \t\t\t\t\t\t((UDATA*)(((J9SFStackFrame*)_sp) + 1))[-1] |= J9SF_A0_INVISIBLE_TAG;\n \t\t\t\t\t}\n-#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NDc2Ng=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzQyMTg0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/ObjectMonitor.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozODoyNFrOHqnRUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMDoyNToyNVrOHqtTtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NTY0OA==", "bodyText": "needs ifdef jdk16+", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514445648", "createdAt": "2020-10-29T17:38:24Z", "author": {"login": "tajila"}, "path": "runtime/vm/ObjectMonitor.cpp", "diffHunk": "@@ -309,14 +309,26 @@ objectMonitorEnterNonBlocking(J9VMThread *currentThread, j9object_t object)\n {\n \tUDATA result = (UDATA)object;\n \tj9objectmonitor_t volatile *lwEA = VM_ObjectMonitor::inlineGetLockAddress(currentThread, object);\n+\tJ9Class * objClass = J9OBJECT_CLAZZ(currentThread, object);\n \n #if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n-\tJ9Class * objClass = J9OBJECT_CLAZZ(currentThread, object);\n \tif (J9_IS_J9CLASS_VALUETYPE(objClass)) {\n \t\tresult = J9_OBJECT_MONITOR_VALUE_TYPE_IMSE;\n \t\tgoto done;\n \t}\n #endif /* J9VM_OPT_VALHALLA_VALUE_TYPES */\t\n+\tif (J9_IS_J9CLASS_VALUEBASED(objClass)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU0NDU2Ng==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r514544566", "createdAt": "2020-10-29T20:25:25Z", "author": {"login": "hangshao0"}, "path": "runtime/vm/ObjectMonitor.cpp", "diffHunk": "@@ -309,14 +309,26 @@ objectMonitorEnterNonBlocking(J9VMThread *currentThread, j9object_t object)\n {\n \tUDATA result = (UDATA)object;\n \tj9objectmonitor_t volatile *lwEA = VM_ObjectMonitor::inlineGetLockAddress(currentThread, object);\n+\tJ9Class * objClass = J9OBJECT_CLAZZ(currentThread, object);\n \n #if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n-\tJ9Class * objClass = J9OBJECT_CLAZZ(currentThread, object);\n \tif (J9_IS_J9CLASS_VALUETYPE(objClass)) {\n \t\tresult = J9_OBJECT_MONITOR_VALUE_TYPE_IMSE;\n \t\tgoto done;\n \t}\n #endif /* J9VM_OPT_VALHALLA_VALUE_TYPES */\t\n+\tif (J9_IS_J9CLASS_VALUEBASED(objClass)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NTY0OA=="}, "originalCommit": {"oid": "5418baab5f05d628de054a776c0f87fe4d73dce4"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzODM0ODA2OnYy", "diffSide": "RIGHT", "path": "runtime/vm/jvminit.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNDozMToyOFrOHsxaZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjo1MTowNFrOHs3wsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjcwODk2NA==", "bodyText": "this should be a JDK 16 check as well", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r516708964", "createdAt": "2020-11-03T14:31:28Z", "author": {"login": "tajila"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2358,6 +2364,12 @@ IDATA VMInitStages(J9JavaVM *vm, IDATA stage, void* reserved) {\n \t\t\t\t\tvm->extendedRuntimeFlags2 |= J9_EXTENDED_RUNTIME2_ENABLE_VT_ARRAY_FLATTENING;\n \t\t\t\t}\n \t\t\t}\n+#else /* defined(J9VM_OPT_VALHALLA_VALUE_TYPES) */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "583facbd6a9ffcde6935f44095903d67013da6ce"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgxMjk3Nw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r516812977", "createdAt": "2020-11-03T16:51:04Z", "author": {"login": "hangshao0"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2358,6 +2364,12 @@ IDATA VMInitStages(J9JavaVM *vm, IDATA stage, void* reserved) {\n \t\t\t\t\tvm->extendedRuntimeFlags2 |= J9_EXTENDED_RUNTIME2_ENABLE_VT_ARRAY_FLATTENING;\n \t\t\t\t}\n \t\t\t}\n+#else /* defined(J9VM_OPT_VALHALLA_VALUE_TYPES) */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjcwODk2NA=="}, "originalCommit": {"oid": "583facbd6a9ffcde6935f44095903d67013da6ce"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzODM1MDI2OnYy", "diffSide": "RIGHT", "path": "runtime/vm/jvminit.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNDozMTo1NlrOHsxbtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjo0ODowMFrOHs3ooQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjcwOTMwMg==", "bodyText": "you can define this in valuetypehelpers.cpp", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r516709302", "createdAt": "2020-11-03T14:31:56Z", "author": {"login": "tajila"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -602,6 +602,12 @@ areValueTypesEnabled(J9JavaVM *vm)\n \treturn J9_ARE_ALL_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_ENABLE_VALHALLA);\n }\n \n+BOOLEAN\n+areValueBasedMonitorChecksEnabled(J9JavaVM *vm)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "583facbd6a9ffcde6935f44095903d67013da6ce"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgxMDkxMw==", "bodyText": "Moved to valuetypehelpers.cpp.", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r516810913", "createdAt": "2020-11-03T16:48:00Z", "author": {"login": "hangshao0"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -602,6 +602,12 @@ areValueTypesEnabled(J9JavaVM *vm)\n \treturn J9_ARE_ALL_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_ENABLE_VALHALLA);\n }\n \n+BOOLEAN\n+areValueBasedMonitorChecksEnabled(J9JavaVM *vm)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjcwOTMwMg=="}, "originalCommit": {"oid": "583facbd6a9ffcde6935f44095903d67013da6ce"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzOTczMjIxOnYy", "diffSide": "RIGHT", "path": "runtime/oti/j9.h", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMDoxMzo0M1rOHs-40A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMTo0NjozNlrOHtBl7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkyOTc0NA==", "bodyText": "nitpick \"allows\"", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r516929744", "createdAt": "2020-11-03T20:13:43Z", "author": {"login": "tajila"}, "path": "runtime/oti/j9.h", "diffHunk": "@@ -309,6 +309,9 @@ static const struct { \\\n \t((NULL != (interfaceClass)) && ((J9_ITABLE_INDEX_UNRESOLVED != ((methodIndexAndArgCount) & ~255))))\n \n /* Macros for ValueTypes */\n+#define J9_CLASS_DISALLOWS_LOCKING_FLAGS (J9ClassIsValueType | J9ClassIsValueBased)\n+#define J9_CLASS_ALLOW_LOCKING(clazz) J9_ARE_NO_BITS_SET((clazz)->classFlags, J9_CLASS_DISALLOWS_LOCKING_FLAGS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac95aa0f2681a85cc74d2e547f04aeab63d61cf1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk3NDA2Mg==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/11035#discussion_r516974062", "createdAt": "2020-11-03T21:46:36Z", "author": {"login": "hangshao0"}, "path": "runtime/oti/j9.h", "diffHunk": "@@ -309,6 +309,9 @@ static const struct { \\\n \t((NULL != (interfaceClass)) && ((J9_ITABLE_INDEX_UNRESOLVED != ((methodIndexAndArgCount) & ~255))))\n \n /* Macros for ValueTypes */\n+#define J9_CLASS_DISALLOWS_LOCKING_FLAGS (J9ClassIsValueType | J9ClassIsValueBased)\n+#define J9_CLASS_ALLOW_LOCKING(clazz) J9_ARE_NO_BITS_SET((clazz)->classFlags, J9_CLASS_DISALLOWS_LOCKING_FLAGS)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkyOTc0NA=="}, "originalCommit": {"oid": "ac95aa0f2681a85cc74d2e547f04aeab63d61cf1"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1037, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}