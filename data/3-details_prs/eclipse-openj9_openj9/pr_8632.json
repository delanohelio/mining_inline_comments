{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NDM0Mjg5", "number": 8632, "title": "Resolve the race condition setting/reading _theca->cacheFullFlags", "bodyText": "Compare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\nMove the setting of _cacheFullFlags and its comparison against\n_theca->cacheFullFlags inside _runtimeFlagsProtectMutex.\nFixes #8628\nSigned-off-by: Hang Shao hangshao@ca.ibm.com", "createdAt": "2020-02-21T19:22:44Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8632", "merged": true, "mergeCommit": {"oid": "63775c17d219580784bacdeebba96f5fe7c74213"}, "closed": true, "closedAt": "2020-02-25T03:26:22Z", "author": {"login": "hangshao0"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGk0vYgBqjMwNjE2MzQzOTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHphg8AFqTM2Mzg0OTE0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d6159693cb4566d23c781d7391336e10fd7fef9d", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d6159693cb4566d23c781d7391336e10fd7fef9d", "committedDate": "2020-02-21T19:19:44Z", "message": "Minimize the race condition time window setting/reading cacheFullFlags\n\nRead _theca->cacheFullFlags into local variable cacheFullFlags right\nbefore it is used. \n\nFixes #8626\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}, "afterCommit": {"oid": "f4a407996d1365f83f01a34645a87e781f68cf06", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f4a407996d1365f83f01a34645a87e781f68cf06", "committedDate": "2020-02-21T19:23:31Z", "message": "Minimize the race condition time window setting/reading cacheFullFlags\n\nRead _theca->cacheFullFlags into local variable cacheFullFlags right\nbefore it is used. \n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4a407996d1365f83f01a34645a87e781f68cf06", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f4a407996d1365f83f01a34645a87e781f68cf06", "committedDate": "2020-02-21T19:23:31Z", "message": "Minimize the race condition time window setting/reading cacheFullFlags\n\nRead _theca->cacheFullFlags into local variable cacheFullFlags right\nbefore it is used. \n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}, "afterCommit": {"oid": "c95e1a463684c0c70c6b1994422326dcb38a908f", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c95e1a463684c0c70c6b1994422326dcb38a908f", "committedDate": "2020-02-21T19:38:51Z", "message": "Minimize the race condition time window setting/reading cacheFullFlags\n\nRead _theca->cacheFullFlags into local variable cacheFullFlags right\nbefore it is used. \n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODg1ODA0", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#pullrequestreview-362885804", "createdAt": "2020-02-21T20:06:31Z", "commit": {"oid": "c95e1a463684c0c70c6b1994422326dcb38a908f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMDowNjozMVrOFtDIvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMDowNjozMVrOFtDIvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTYyOQ==", "bodyText": "This isn't a fix, you can use compare and swap to fix it.", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r382781629", "createdAt": "2020-02-21T20:06:31Z", "author": {"login": "pshipton"}, "path": "runtime/shared_common/CompositeCache.cpp", "diffHunk": "@@ -6813,7 +6813,7 @@ SH_CompositeCacheImpl::updateRuntimeFullFlags(J9VMThread *currentThread)\n \tif (_readOnlyOSCache || J9_ARE_ALL_BITS_SET(*_runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_READONLY)) {\n \t\tgoto done;\n \t}\n-\n+\tcacheFullFlags = _theca->cacheFullFlags;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95e1a463684c0c70c6b1994422326dcb38a908f"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c95e1a463684c0c70c6b1994422326dcb38a908f", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c95e1a463684c0c70c6b1994422326dcb38a908f", "committedDate": "2020-02-21T19:38:51Z", "message": "Minimize the race condition time window setting/reading cacheFullFlags\n\nRead _theca->cacheFullFlags into local variable cacheFullFlags right\nbefore it is used. \n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}, "afterCommit": {"oid": "ac58876496792333251e977fc1401b419807728a", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ac58876496792333251e977fc1401b419807728a", "committedDate": "2020-02-24T17:07:23Z", "message": "Resolve the race condition setting/reading _theca->cacheFullFlags\n\nCompare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac58876496792333251e977fc1401b419807728a", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ac58876496792333251e977fc1401b419807728a", "committedDate": "2020-02-24T17:07:23Z", "message": "Resolve the race condition setting/reading _theca->cacheFullFlags\n\nCompare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}, "afterCommit": {"oid": "5a0ea7a171e8ec94b4bb7394ac9940cd0c9f6398", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5a0ea7a171e8ec94b4bb7394ac9940cd0c9f6398", "committedDate": "2020-02-24T21:29:29Z", "message": "Resolve the race condition setting/reading _theca->cacheFullFlags\n\nCompare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b4d136b98813a83276c6f2a5e6a612003d55a71", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5b4d136b98813a83276c6f2a5e6a612003d55a71", "committedDate": "2020-02-24T21:39:49Z", "message": "Resolve the race condition setting/reading _theca->cacheFullFlags\n\nCompare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\n\nMove the setting of _cacheFullFlags and its comparison against\n_theca->cacheFullFlags inside _runtimeFlagsProtectMutex.\n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a0ea7a171e8ec94b4bb7394ac9940cd0c9f6398", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5a0ea7a171e8ec94b4bb7394ac9940cd0c9f6398", "committedDate": "2020-02-24T21:29:29Z", "message": "Resolve the race condition setting/reading _theca->cacheFullFlags\n\nCompare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}, "afterCommit": {"oid": "5b4d136b98813a83276c6f2a5e6a612003d55a71", "author": {"user": {"login": "hangshao0", "name": "Hang Shao"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5b4d136b98813a83276c6f2a5e6a612003d55a71", "committedDate": "2020-02-24T21:39:49Z", "message": "Resolve the race condition setting/reading _theca->cacheFullFlags\n\nCompare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\n\nMove the setting of _cacheFullFlags and its comparison against\n_theca->cacheFullFlags inside _runtimeFlagsProtectMutex.\n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzQyMzgy", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#pullrequestreview-363742382", "createdAt": "2020-02-24T22:18:56Z", "commit": {"oid": "5b4d136b98813a83276c6f2a5e6a612003d55a71"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMjoxODo1NlrOFtx8TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMjoxODo1NlrOFtx8TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0ODQ5Mw==", "bodyText": "I don't see the corresponding omrthread_monitor_exit()", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r383548493", "createdAt": "2020-02-24T22:18:56Z", "author": {"login": "pshipton"}, "path": "runtime/shared_common/CompositeCache.cpp", "diffHunk": "@@ -6813,16 +6813,19 @@ SH_CompositeCacheImpl::updateRuntimeFullFlags(J9VMThread *currentThread)\n \tif (_readOnlyOSCache || J9_ARE_ALL_BITS_SET(*_runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_READONLY)) {\n \t\tgoto done;\n \t}\n-\n-\tif (_cacheFullFlags == cacheFullFlags) {\n+\t\n+\t/* It is possible we take _headerProtectMutex inside _runtimeFlagsProtectMutex.\n+\t * So assert we do not hold _headerProtectMutex before taking _runtimeFlagsProtectMutex.\n+\t */\n+\tTrc_SHR_Assert_True(1 != omrthread_monitor_owned_by_self(_headerProtectMutex));\n+\tomrthread_monitor_enter(_runtimeFlagsProtectMutex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b4d136b98813a83276c6f2a5e6a612003d55a71"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODQ5MTQx", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#pullrequestreview-363849141", "createdAt": "2020-02-25T03:26:16Z", "commit": {"oid": "5b4d136b98813a83276c6f2a5e6a612003d55a71"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 587, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}