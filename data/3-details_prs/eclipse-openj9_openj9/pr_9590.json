{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4ODQ0ODgw", "number": 9590, "title": "Support for serialization of TR_BlockFrequencyInfo", "bodyText": "Added code for serialization of TR_BlockFrequencyInfo.\nSigned-off-by: Ashutosh Mehra asmehra@redhat.com", "createdAt": "2020-05-15T21:57:50Z", "url": "https://github.com/eclipse-openj9/openj9/pull/9590", "merged": true, "mergeCommit": {"oid": "ce3c56c81abcd08bd9ec28629670bca1888a8036"}, "closed": true, "closedAt": "2020-12-16T00:35:15Z", "author": {"login": "ashu-mehra"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchpdJyABqjMzNDI3ODI5MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmeOwxAFqTU1MjcyNDYyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a7fc87e562a26dcd5cb35e648b8d24462c81272", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/5a7fc87e562a26dcd5cb35e648b8d24462c81272", "committedDate": "2020-05-15T21:39:36Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <mehra.ashutosh@ibm.com>"}, "afterCommit": {"oid": "2bcc3a9899c8584f25d66838b28dce96093e502d", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/2bcc3a9899c8584f25d66838b28dce96093e502d", "committedDate": "2020-05-15T22:03:20Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <mehra.ashutosh@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NDI0ODEy", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#pullrequestreview-414424812", "createdAt": "2020-05-19T13:07:12Z", "commit": {"oid": "2bcc3a9899c8584f25d66838b28dce96093e502d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMzowNzoxMlrOGXfgZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMzoxMToxMVrOGXfrcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI4NjYyOA==", "bodyText": "Can you explain why this is ifdef'd out? Ordinarily we wouldn't accept ifdef'd out code since it is likely to rot and isn't tested or compiled....", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r427286628", "createdAt": "2020-05-19T13:07:12Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/runtime/J9Profiler.hpp", "diffHunk": "@@ -422,6 +433,32 @@ class TR_ValueProfileInfo\n    TR_PERSISTENT_ALLOC(TR_Memory::ValueProfileInfo)\n \n    TR_ValueProfileInfo(TR_CallSiteInfo *info);\n+\n+#if 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bcc3a9899c8584f25d66838b28dce96093e502d"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI4NzI4MQ==", "bodyText": "same as above ifdef", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r427287281", "createdAt": "2020-05-19T13:08:05Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/runtime/J9Profiler.hpp", "diffHunk": "@@ -443,6 +480,39 @@ class TR_ValueProfileInfo\n \n    void dumpInfo(TR::FILE *);\n \n+#if 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bcc3a9899c8584f25d66838b28dce96093e502d"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI4OTE1OQ==", "bodyText": "Making this public seems suboptimal - the isolation provided by the previous private declaration helps to prevent accidental corruption of the profiling data. Is there an overall design for this work that explains this design choice?", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r427289159", "createdAt": "2020-05-19T13:10:44Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/runtime/J9Profiler.hpp", "diffHunk": "@@ -174,8 +177,16 @@ class TR_PersistentProfileInfo\n \n    void dumpInfo(TR::FILE *);\n \n-   private:\n+   void setCallSiteInfo(TR::Compilation *comp, uint32_t numCallSites, TR_InlinedCallSite *inlinedCallSite);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bcc3a9899c8584f25d66838b28dce96093e502d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI4OTQ1OA==", "bodyText": "Can you please add doxygen for newly added APIs to explain what they do, their requirements, results and side-effects?", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r427289458", "createdAt": "2020-05-19T13:11:11Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/runtime/J9Profiler.hpp", "diffHunk": "@@ -174,8 +177,16 @@ class TR_PersistentProfileInfo\n \n    void dumpInfo(TR::FILE *);\n \n-   private:\n+   void setCallSiteInfo(TR::Compilation *comp, uint32_t numCallSites, TR_InlinedCallSite *inlinedCallSite);\n+   void getSerializedSize(TR_Serializer &serializer) const;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bcc3a9899c8584f25d66838b28dce96093e502d"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bcc3a9899c8584f25d66838b28dce96093e502d", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/2bcc3a9899c8584f25d66838b28dce96093e502d", "committedDate": "2020-05-15T22:03:20Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <mehra.ashutosh@ibm.com>"}, "afterCommit": {"oid": "419a555cc77bd22f887719b071be588ee8b14eef", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/419a555cc77bd22f887719b071be588ee8b14eef", "committedDate": "2020-08-19T00:24:22Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <mehra.ashutosh@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "419a555cc77bd22f887719b071be588ee8b14eef", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/419a555cc77bd22f887719b071be588ee8b14eef", "committedDate": "2020-08-19T00:24:22Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <mehra.ashutosh@ibm.com>"}, "afterCommit": {"oid": "03ca2149c34fc493b37de4c4b0670efe1b341dae", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/03ca2149c34fc493b37de4c4b0670efe1b341dae", "committedDate": "2020-09-10T21:06:48Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <mehra.ashutosh@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03ca2149c34fc493b37de4c4b0670efe1b341dae", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/03ca2149c34fc493b37de4c4b0670efe1b341dae", "committedDate": "2020-09-10T21:06:48Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <mehra.ashutosh@ibm.com>"}, "afterCommit": {"oid": "7d8ab507f7c644dd4fd717fdee6cb7aae2381510", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/7d8ab507f7c644dd4fd717fdee6cb7aae2381510", "committedDate": "2020-11-04T00:40:57Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <mehra.ashutosh@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d8ab507f7c644dd4fd717fdee6cb7aae2381510", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/7d8ab507f7c644dd4fd717fdee6cb7aae2381510", "committedDate": "2020-11-04T00:40:57Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <mehra.ashutosh@ibm.com>"}, "afterCommit": {"oid": "32228349745a55fea698aa5206c4a9b7e8b6a24a", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/32228349745a55fea698aa5206c4a9b7e8b6a24a", "committedDate": "2020-11-04T14:50:30Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32228349745a55fea698aa5206c4a9b7e8b6a24a", "author": {"user": null}, "url": "https://github.com/eclipse-openj9/openj9/commit/32228349745a55fea698aa5206c4a9b7e8b6a24a", "committedDate": "2020-11-04T14:50:30Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}, "afterCommit": {"oid": "bb0c35d5bbaaf127bf901fa22af6c7e27972f94d", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/bb0c35d5bbaaf127bf901fa22af6c7e27972f94d", "committedDate": "2020-11-04T15:07:33Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb0c35d5bbaaf127bf901fa22af6c7e27972f94d", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/bb0c35d5bbaaf127bf901fa22af6c7e27972f94d", "committedDate": "2020-11-04T15:07:33Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}, "afterCommit": {"oid": "f32146ba9ee69eb49a1ef5334638cd2d7b7dfaee", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f32146ba9ee69eb49a1ef5334638cd2d7b7dfaee", "committedDate": "2020-11-04T15:27:22Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f32146ba9ee69eb49a1ef5334638cd2d7b7dfaee", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f32146ba9ee69eb49a1ef5334638cd2d7b7dfaee", "committedDate": "2020-11-04T15:27:22Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}, "afterCommit": {"oid": "b8bd453987b84e97ba74914e2fdd3db34db3ba6d", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b8bd453987b84e97ba74914e2fdd3db34db3ba6d", "committedDate": "2020-11-04T19:24:17Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8bd453987b84e97ba74914e2fdd3db34db3ba6d", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b8bd453987b84e97ba74914e2fdd3db34db3ba6d", "committedDate": "2020-11-04T19:24:17Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}, "afterCommit": {"oid": "c01c8eed8ebe94d02e33d8c7370852f13ccafbda", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c01c8eed8ebe94d02e33d8c7370852f13ccafbda", "committedDate": "2020-11-04T20:21:46Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c01c8eed8ebe94d02e33d8c7370852f13ccafbda", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c01c8eed8ebe94d02e33d8c7370852f13ccafbda", "committedDate": "2020-11-04T20:21:46Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}, "afterCommit": {"oid": "f8895674ec0f10b789a94e221697ded566c78c4b", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f8895674ec0f10b789a94e221697ded566c78c4b", "committedDate": "2020-12-03T15:57:54Z", "message": "Use structs to club together members of the class to be serialized\n\nUse structs to club together members of the class to be serialized.\nIt helps in mainitaining the order of fields. Also the presence of\npointer types is indicated by using a bool instead of storing the\nraw address.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89918662a2016bce78b40aa6794c81b61ba4deea", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/89918662a2016bce78b40aa6794c81b61ba4deea", "committedDate": "2020-12-03T16:02:37Z", "message": "Remove unnecessary change to copyright year in RecompilationInfo.hpp\n\nRemove unnecessary change to copyright year in RecompilationInfo.hpp.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}, "afterCommit": {"oid": "2abf19352ff1ae6a634589d9a019f8fa437d8cf2", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2abf19352ff1ae6a634589d9a019f8fa437d8cf2", "committedDate": "2020-12-03T16:07:41Z", "message": "Remove unnecessary changes\n\nRemove unnecessary change to the files.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2abf19352ff1ae6a634589d9a019f8fa437d8cf2", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2abf19352ff1ae6a634589d9a019f8fa437d8cf2", "committedDate": "2020-12-03T16:07:41Z", "message": "Remove unnecessary changes\n\nRemove unnecessary change to the files.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}, "afterCommit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5e880443328e9fa44d547be81aa56f9ea7ae7f19", "committedDate": "2020-12-03T16:21:31Z", "message": "Use structs to club together members of the class to be serialized\n\nUse structs to club together members of the class to be serialized.\nIt helps in mainitaining the order of fields. Also the presence of\npointer types is indicated by using a bool instead of storing the\nraw address.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjE2NDA0", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#pullrequestreview-547616404", "createdAt": "2020-12-08T20:48:06Z", "commit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDo0ODowNlrOIB1bHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMTozNjozN1rOIB3Ssg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5NDc4Mw==", "bodyText": "Tab needed here", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r538794783", "createdAt": "2020-12-08T20:48:06Z", "author": {"login": "r30shah"}, "path": "runtime/compiler/runtime/J9Profiler.cpp", "diffHunk": "@@ -2275,9 +2275,112 @@ int32_t TR_BlockFrequencyInfo::getMaxRawCount()\n    return maxCount;\n    }\n \n+uint32_t TR_BlockFrequencyInfo::getSizeForSerialization() const\n+   {\n+   uint32_t size = sizeof(SerializedBFI);\n+   if (_numBlocks > 0)\n+      {\n+      size += (_numBlocks * sizeof(*_blocks));\n+      size += (_numBlocks * sizeof(*_frequencies));\n+      size += (_numBlocks * 2 * sizeof(*_counterDerivationInfo));\n+      for (int32_t i = 0; i < (_numBlocks * 2); i++)\n+         {\n+         if (_counterDerivationInfo[i] && IS_VALID_BIT_VECTOR(_counterDerivationInfo[i]))\n+            {\n+            size += _counterDerivationInfo[i]->getSizeForSerialization();\n+            }\n+         }\n+      }\n+   return size;\n+   }\n \n-const uint32_t TR_CatchBlockProfileInfo::EDOThreshold = 50;\n+void TR_BlockFrequencyInfo::serialize(uint8_t * &buffer) const\n+   {\n+   SerializedBFI *serializedData = reinterpret_cast<SerializedBFI *>(buffer);\n+   serializedData->numBlocks = _numBlocks;\n+   buffer += sizeof(SerializedBFI);\n+   if (_numBlocks > 0)\n+      {\n+      size_t blocksSize = _numBlocks * sizeof(*_blocks);\n+      memcpy(buffer, _blocks, blocksSize);\n+      buffer += blocksSize;\n+\n+      size_t frequenciesSize = _numBlocks * sizeof(*_frequencies);\n+      memcpy(buffer, _frequencies, frequenciesSize);\n+      buffer += frequenciesSize;\n+\n+      size_t counterSize = _numBlocks * 2 * sizeof(*_counterDerivationInfo);\n+      memcpy(buffer, _counterDerivationInfo, counterSize);\n+      buffer += counterSize;\n+      for (int32_t i = 0; i < (_numBlocks * 2); i++)\n+         {\n+         if (_counterDerivationInfo[i] && IS_VALID_BIT_VECTOR(_counterDerivationInfo[i]))\n+            {\n+            // write the bit vector\n+\t    _counterDerivationInfo[i]->serialize(buffer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5NTUzOA==", "bodyText": "Typo here", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r538795538", "createdAt": "2020-12-08T20:49:29Z", "author": {"login": "r30shah"}, "path": "runtime/compiler/runtime/J9Profiler.cpp", "diffHunk": "@@ -2275,9 +2275,112 @@ int32_t TR_BlockFrequencyInfo::getMaxRawCount()\n    return maxCount;\n    }\n \n+uint32_t TR_BlockFrequencyInfo::getSizeForSerialization() const\n+   {\n+   uint32_t size = sizeof(SerializedBFI);\n+   if (_numBlocks > 0)\n+      {\n+      size += (_numBlocks * sizeof(*_blocks));\n+      size += (_numBlocks * sizeof(*_frequencies));\n+      size += (_numBlocks * 2 * sizeof(*_counterDerivationInfo));\n+      for (int32_t i = 0; i < (_numBlocks * 2); i++)\n+         {\n+         if (_counterDerivationInfo[i] && IS_VALID_BIT_VECTOR(_counterDerivationInfo[i]))\n+            {\n+            size += _counterDerivationInfo[i]->getSizeForSerialization();\n+            }\n+         }\n+      }\n+   return size;\n+   }\n \n-const uint32_t TR_CatchBlockProfileInfo::EDOThreshold = 50;\n+void TR_BlockFrequencyInfo::serialize(uint8_t * &buffer) const\n+   {\n+   SerializedBFI *serializedData = reinterpret_cast<SerializedBFI *>(buffer);\n+   serializedData->numBlocks = _numBlocks;\n+   buffer += sizeof(SerializedBFI);\n+   if (_numBlocks > 0)\n+      {\n+      size_t blocksSize = _numBlocks * sizeof(*_blocks);\n+      memcpy(buffer, _blocks, blocksSize);\n+      buffer += blocksSize;\n+\n+      size_t frequenciesSize = _numBlocks * sizeof(*_frequencies);\n+      memcpy(buffer, _frequencies, frequenciesSize);\n+      buffer += frequenciesSize;\n+\n+      size_t counterSize = _numBlocks * 2 * sizeof(*_counterDerivationInfo);\n+      memcpy(buffer, _counterDerivationInfo, counterSize);\n+      buffer += counterSize;\n+      for (int32_t i = 0; i < (_numBlocks * 2); i++)\n+         {\n+         if (_counterDerivationInfo[i] && IS_VALID_BIT_VECTOR(_counterDerivationInfo[i]))\n+            {\n+            // write the bit vector\n+\t    _counterDerivationInfo[i]->serialize(buffer);\n+            }\n+         }\n+      }\n+   }\n+\n+TR_BlockFrequencyInfo::TR_BlockFrequencyInfo(const SerializedBFI *serializedData, uint8_t * &buffer, TR_PersistentProfileInfo *currentProfile) :\n+   _callSiteInfo(currentProfile->getCallSiteInfo()),\n+   _numBlocks(serializedData->numBlocks),\n+   _blocks(\n+      _numBlocks ?\n+      new (PERSISTENT_NEW) TR_ByteCodeInfo[_numBlocks] :\n+      0\n+      ),\n+   _frequencies(\n+      _numBlocks ?\n+      /*\n+       * The explicit parens value initialize the array,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5NzMwOQ==", "bodyText": "This seems like, it is doing same as part of the code couple of lines before in TR_BlockFrequencyInfo::serialize(uint8_t * &buffer) const , is it possible to refactor the common part out to a function?", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r538797309", "createdAt": "2020-12-08T20:52:26Z", "author": {"login": "r30shah"}, "path": "runtime/compiler/runtime/J9Profiler.cpp", "diffHunk": "@@ -2275,9 +2275,112 @@ int32_t TR_BlockFrequencyInfo::getMaxRawCount()\n    return maxCount;\n    }\n \n+uint32_t TR_BlockFrequencyInfo::getSizeForSerialization() const\n+   {\n+   uint32_t size = sizeof(SerializedBFI);\n+   if (_numBlocks > 0)\n+      {\n+      size += (_numBlocks * sizeof(*_blocks));\n+      size += (_numBlocks * sizeof(*_frequencies));\n+      size += (_numBlocks * 2 * sizeof(*_counterDerivationInfo));\n+      for (int32_t i = 0; i < (_numBlocks * 2); i++)\n+         {\n+         if (_counterDerivationInfo[i] && IS_VALID_BIT_VECTOR(_counterDerivationInfo[i]))\n+            {\n+            size += _counterDerivationInfo[i]->getSizeForSerialization();\n+            }\n+         }\n+      }\n+   return size;\n+   }\n \n-const uint32_t TR_CatchBlockProfileInfo::EDOThreshold = 50;\n+void TR_BlockFrequencyInfo::serialize(uint8_t * &buffer) const\n+   {\n+   SerializedBFI *serializedData = reinterpret_cast<SerializedBFI *>(buffer);\n+   serializedData->numBlocks = _numBlocks;\n+   buffer += sizeof(SerializedBFI);\n+   if (_numBlocks > 0)\n+      {\n+      size_t blocksSize = _numBlocks * sizeof(*_blocks);\n+      memcpy(buffer, _blocks, blocksSize);\n+      buffer += blocksSize;\n+\n+      size_t frequenciesSize = _numBlocks * sizeof(*_frequencies);\n+      memcpy(buffer, _frequencies, frequenciesSize);\n+      buffer += frequenciesSize;\n+\n+      size_t counterSize = _numBlocks * 2 * sizeof(*_counterDerivationInfo);\n+      memcpy(buffer, _counterDerivationInfo, counterSize);\n+      buffer += counterSize;\n+      for (int32_t i = 0; i < (_numBlocks * 2); i++)\n+         {\n+         if (_counterDerivationInfo[i] && IS_VALID_BIT_VECTOR(_counterDerivationInfo[i]))\n+            {\n+            // write the bit vector\n+\t    _counterDerivationInfo[i]->serialize(buffer);\n+            }\n+         }\n+      }\n+   }\n+\n+TR_BlockFrequencyInfo::TR_BlockFrequencyInfo(const SerializedBFI *serializedData, uint8_t * &buffer, TR_PersistentProfileInfo *currentProfile) :\n+   _callSiteInfo(currentProfile->getCallSiteInfo()),\n+   _numBlocks(serializedData->numBlocks),\n+   _blocks(\n+      _numBlocks ?\n+      new (PERSISTENT_NEW) TR_ByteCodeInfo[_numBlocks] :\n+      0\n+      ),\n+   _frequencies(\n+      _numBlocks ?\n+      /*\n+       * The explicit parens value initialize the array,\n+       * which in turn value initializes each array member,\n+       * which for ints is zero initialization.\n+       */\n+      new (PERSISTENT_NEW) int32_t[_numBlocks]() :\n+      NULL\n+      ),\n+   _counterDerivationInfo(\n+      _numBlocks ?\n+      (TR_BitVector**) new (PERSISTENT_NEW) void**[_numBlocks*2]() :\n+      NULL),\n+   _entryBlockNumber(-1),\n+   _isQueuedForRecompilation(0)\n+   {\n+   if (_numBlocks > 0)\n+      {\n+      size_t blocksSize = _numBlocks * sizeof(*_blocks);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgyNTM5NA==", "bodyText": "I do not think so IS_VALID_BIT_VECTOR is the correct name here.\nIIRC low tagged entry means we need to just get the counter from single block to either add or subtract, otherwise, it should hold the array of bit vector representing counters from blocks added and subtracted together to get the frequency. I am not sure if this is the correct check. Take a look at the comment here,\nhttps://github.com/eclipse/openj9/blob/b2400f9240b80a0a41d314ddc5768a42915a69ca/runtime/compiler/runtime/J9Profiler.hpp#L660-L663", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r538825394", "createdAt": "2020-12-08T21:36:37Z", "author": {"login": "r30shah"}, "path": "runtime/compiler/runtime/J9Profiler.hpp", "diffHunk": "@@ -612,6 +663,9 @@ class TR_MethodBranchProfileInfo\n    uint32_t _initialBlockFrequency;\n    };\n \n+// To be used for checking if _counterDerivationInfo[i] is a bit vector or not\n+#define IS_VALID_BIT_VECTOR(cdi) (!((uintptr_t)cdi & 0x1))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NDA3MTU5", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#pullrequestreview-549407159", "createdAt": "2020-12-10T16:57:02Z", "commit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNjo1NzowMlrOIDTdkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNjo1OTozOFrOIDTl3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMzNTUwNw==", "bodyText": "typo agains", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r540335507", "createdAt": "2020-12-10T16:57:02Z", "author": {"login": "dsouzai"}, "path": "runtime/compiler/runtime/J9Profiler.hpp", "diffHunk": "@@ -753,8 +861,58 @@ class TR_CallSiteInfo\n \n    void dumpInfo(TR::FILE *);\n \n+   /**\n+    * @brief Determines the size of the serialized data for this object\n+    *\n+    * @return Number of bytes required for serializing this object\n+    */\n+   uint32_t getSizeForSerialization() const;\n+\n+   /**\n+    * @brief Serialize this object and store it in the memory buffer\n+    *\n+    * @param buffer Memory buffer where serialized data is to be stored\n+    *\n+    * @note The caller should ensure buffer is large enough to accommodate the serialized data.\n+    * On return the buffer gets updated to point to the location past the serialized data.\n+    * Also see getSizeForSerialization(), deserialize(uint8_t * &).\n+    */\n+   void serialize(uint8_t * &buffer) const;\n+\n+   /**\n+    * @brief Method for creating TR_CallSiteInfo from serialized data\n+    *\n+    * @param buffer Memory buffer where the serialized data is stored\n+    *\n+    * @return Pointer to TR_CallSiteInfo created from serialized data\n+    *\n+    * @note This method does not check agains buffer over-reads. The caller should ensure that the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19"}, "originalPosition": 169}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMzNzM1Ng==", "bodyText": "typo agains", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r540337356", "createdAt": "2020-12-10T16:59:19Z", "author": {"login": "dsouzai"}, "path": "runtime/compiler/runtime/J9Profiler.hpp", "diffHunk": "@@ -647,7 +701,61 @@ class TR_BlockFrequencyInfo\n    int32_t getCallCount();\n    int32_t getMaxRawCount(int32_t callerIndex);\n    int32_t getMaxRawCount();\n+\n+   /**\n+    * @brief Determines the size of the serialized data for this object\n+    *\n+    * @return Number of bytes required for serializing this object\n+    */\n+   uint32_t getSizeForSerialization() const;\n+\n+   /**\n+    * @brief serialize this object and store it in the memory buffer\n+    *\n+    * @param buffer Memory buffer where serialized data is to be stored\n+    *\n+    * @note The caller should ensure buffer is large enough to accommodate the serialized data.\n+    * On return the buffer gets updated to point to the location past the serialized data.\n+    * Also see getSizeForSerialization(), deserialize(uint8_t * &).\n+    */\n+   void serialize(uint8_t * &buffer) const;\n+\n+   /**\n+    * @brief Method for creating TR_BlockFrequencyInfo from serialized data\n+    *\n+    * @param buffer Memory buffer where serialized data is stored\n+    * @param currentProfile Pointer to TR_PersistentProfileInfo object at which TR_BlockFrequencyInfo object is anchored at\n+    *\n+    * @return Pointer to TR_BlockFrequencyInfo created from serialized data\n+    *\n+    * @note This method does not check agains buffer over-reads. The caller should ensure that the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMzNzYyOA==", "bodyText": "typo agains", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#discussion_r540337628", "createdAt": "2020-12-10T16:59:38Z", "author": {"login": "dsouzai"}, "path": "runtime/compiler/runtime/J9Profiler.hpp", "diffHunk": "@@ -174,7 +173,59 @@ class TR_PersistentProfileInfo\n \n    void dumpInfo(TR::FILE *);\n \n+   /**\n+    * @brief Determines the size of the serialized data for this object\n+    *\n+    * @return Number of bytes required for serializing this object\n+    */\n+   uint32_t getSizeForSerialization() const;\n+\n+   /**\n+    * @brief Serialize this object and store it in the memory buffer\n+    *\n+    * @param buffer Memory buffer where serialized data is to be stored\n+    *\n+    * @note The caller should ensure buffer is large enough to accommodate the serialized data.\n+    * On return the buffer gets updated to point to the location past the serialized data.\n+    * Also see getSizeForSerialization(), deserialize(uint8_t * &).\n+    */\n+   void serialize(uint8_t * &buffer) const;\n+\n+   /**\n+    * @brief Method for creating TR_PersistentProfileInfo from serialized data\n+    *\n+    * @param buffer Memory buffer where serialized data is stored\n+    *\n+    * @return Pointer to TR_PersistentProfileInfo created from serialized data\n+    *\n+    * @note This method does not check agains buffer over-reads. The caller should ensure that the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e880443328e9fa44d547be81aa56f9ea7ae7f19", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5e880443328e9fa44d547be81aa56f9ea7ae7f19", "committedDate": "2020-12-03T16:21:31Z", "message": "Use structs to club together members of the class to be serialized\n\nUse structs to club together members of the class to be serialized.\nIt helps in mainitaining the order of fields. Also the presence of\npointer types is indicated by using a bool instead of storing the\nraw address.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}, "afterCommit": {"oid": "526d6529382b70226f8bb2a6b64ae90f2b160b42", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/526d6529382b70226f8bb2a6b64ae90f2b160b42", "committedDate": "2020-12-13T23:04:20Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "526d6529382b70226f8bb2a6b64ae90f2b160b42", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/526d6529382b70226f8bb2a6b64ae90f2b160b42", "committedDate": "2020-12-13T23:04:20Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}, "afterCommit": {"oid": "b732aa56e320a549c5c4b00d955d48e0108d927b", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b732aa56e320a549c5c4b00d955d48e0108d927b", "committedDate": "2020-12-14T00:09:59Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b56b26c8f4179595aedde4f7bb38cd9790207625", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b56b26c8f4179595aedde4f7bb38cd9790207625", "committedDate": "2020-12-14T00:19:10Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b732aa56e320a549c5c4b00d955d48e0108d927b", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b732aa56e320a549c5c4b00d955d48e0108d927b", "committedDate": "2020-12-14T00:09:59Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}, "afterCommit": {"oid": "b56b26c8f4179595aedde4f7bb38cd9790207625", "author": {"user": {"login": "ashu-mehra", "name": "Ashutosh Mehra"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b56b26c8f4179595aedde4f7bb38cd9790207625", "committedDate": "2020-12-14T00:19:10Z", "message": "Support for serialization of TR_BlockFrequencyInfo\n\nAdded code for serialization of TR_BlockFrequencyInfo.\n\nSigned-off-by: Ashutosh Mehra <asmehra@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNTYzODM1", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#pullrequestreview-552563835", "createdAt": "2020-12-15T15:14:45Z", "commit": {"oid": "b56b26c8f4179595aedde4f7bb38cd9790207625"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNzI0NjIz", "url": "https://github.com/eclipse-openj9/openj9/pull/9590#pullrequestreview-552724623", "createdAt": "2020-12-15T17:59:38Z", "commit": {"oid": "b56b26c8f4179595aedde4f7bb38cd9790207625"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 967, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}