{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0Mzk2ODM1", "number": 8561, "title": "Fix '-XXjitdirectory' option on Linux on Z", "bodyText": "On Linux on Z, libj9jit library dynamically links the libj9zlib library available in OpenJ9. In regular world, both library sits in the same directory and when it need to load libj9zlib which is required by libj9jit it finds it from the previously set path. When we specify the -XXjitdirectory option it overwrites the path to load dynamically linked libraries from and JVM fails to start as it can not find libj9zlib needed by JIT library. In order to fix this issue, we need to preload libj9zlib library before it loads libj9jit similarly as we preload other libraries such as libjvm .\nSigned-off-by: simonameng simonameng97@gmail.com", "createdAt": "2020-02-12T16:14:31Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8561", "merged": true, "mergeCommit": {"oid": "336b612dbbfea378c8d31ad05a626d08704f13b5"}, "closed": true, "closedAt": "2020-03-03T20:40:19Z", "author": {"login": "simonameng"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDo_uqAFqTM1NzYwMzUzNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKIUGNgFqTM2ODI5OTA5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NjAzNTM2", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-357603536", "createdAt": "2020-02-12T16:33:39Z", "commit": {"oid": "f49f5589860ec427e57197894499ece4c1087393"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNjozMzo0MFrOFo1xJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNjozMzo0MFrOFo1xJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2ODI5Mw==", "bodyText": "We can delay declaring this void* to the point we use it.", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r378368293", "createdAt": "2020-02-12T16:33:40Z", "author": {"login": "r30shah"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -984,7 +984,7 @@ removeSuffix(char *string, const char *suffix)\n static BOOLEAN\n preloadLibraries(void)\n {\n-\tvoid *vmDLL, *threadDLL, *portDLL;\n+\tvoid *vmDLL, *threadDLL, *portDLL, *zlibDLL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f49f5589860ec427e57197894499ece4c1087393"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NjAzOTE0", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-357603914", "createdAt": "2020-02-12T16:34:05Z", "commit": {"oid": "f49f5589860ec427e57197894499ece4c1087393"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f49f5589860ec427e57197894499ece4c1087393", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f49f5589860ec427e57197894499ece4c1087393", "committedDate": "2020-02-12T15:59:29Z", "message": "Preload 'zlib'\n\nPreload 'zlib' in order to find the rpath.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "85bd6d109d17b12760185cd638d20d1afc4021fd", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/85bd6d109d17b12760185cd638d20d1afc4021fd", "committedDate": "2020-02-12T16:34:54Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library available in OpenJ9. In regular world, both library sits in the same directory and when it need to load `libj9zlib` which is required by `libj9jit` it finds it from the previously set path. When we specify the `-XXjitdirectory` option it overwrites the path to load dynamically linked libraries from and JVM fails to start as it can not find `libj9zlib` needed by JIT library. In order to fix this issue, we need to preload `libj9zlib` library before it loads `libj9jit` similarly as we preload other libraries such as `libjvm` .\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85bd6d109d17b12760185cd638d20d1afc4021fd", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/85bd6d109d17b12760185cd638d20d1afc4021fd", "committedDate": "2020-02-12T16:34:54Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library available in OpenJ9. In regular world, both library sits in the same directory and when it need to load `libj9zlib` which is required by `libj9jit` it finds it from the previously set path. When we specify the `-XXjitdirectory` option it overwrites the path to load dynamically linked libraries from and JVM fails to start as it can not find `libj9zlib` needed by JIT library. In order to fix this issue, we need to preload `libj9zlib` library before it loads `libj9jit` similarly as we preload other libraries such as `libjvm` .\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "e1e6a18ee288c9de2428acfc694e22f0ffd2761c", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e1e6a18ee288c9de2428acfc694e22f0ffd2761c", "committedDate": "2020-02-12T16:53:57Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm` .\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NjU1ODcz", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-357655873", "createdAt": "2020-02-12T17:43:00Z", "commit": {"oid": "e1e6a18ee288c9de2428acfc694e22f0ffd2761c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNzo0MzowMFrOFo4SvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNzo0MzowMFrOFo4SvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQwOTY2MQ==", "bodyText": "This should be void *", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r378409661", "createdAt": "2020-02-12T17:43:00Z", "author": {"login": "r30shah"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1189,6 +1189,11 @@ preloadLibraries(void)\n \t * location if not preloaded. */\n \tpreloadLibrary(J9_HARMONY_PORT_LIBRARY_SHIM_DLL_NAME, TRUE);\n #endif /* J9VM_OPT_HARMONY */\n+\tvoid zlibDLL = preloadLibrary(J9_ZIP_DLL_NAME, TRUE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1e6a18ee288c9de2428acfc694e22f0ffd2761c"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1e6a18ee288c9de2428acfc694e22f0ffd2761c", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e1e6a18ee288c9de2428acfc694e22f0ffd2761c", "committedDate": "2020-02-12T16:53:57Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm` .\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "8cb98240907a757a84c78e370eb99933e5cc75da", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8cb98240907a757a84c78e370eb99933e5cc75da", "committedDate": "2020-02-12T18:33:02Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cb98240907a757a84c78e370eb99933e5cc75da", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8cb98240907a757a84c78e370eb99933e5cc75da", "committedDate": "2020-02-12T18:33:02Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "8f626392f40240db9ffe4e48a86f896989cfcd24", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8f626392f40240db9ffe4e48a86f896989cfcd24", "committedDate": "2020-02-12T18:34:29Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f626392f40240db9ffe4e48a86f896989cfcd24", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8f626392f40240db9ffe4e48a86f896989cfcd24", "committedDate": "2020-02-12T18:34:29Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "c1229e123c2cfcb4442175c3ea3ca6c656d0db3a", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c1229e123c2cfcb4442175c3ea3ca6c656d0db3a", "committedDate": "2020-02-14T14:51:34Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MDI0OTE2", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-359024916", "createdAt": "2020-02-14T15:33:30Z", "commit": {"oid": "c1229e123c2cfcb4442175c3ea3ca6c656d0db3a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNTozMzozMFrOFp6iKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNTozMzozMFrOFp6iKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ5NDk1Mw==", "bodyText": "libj9zlib29.so shouldn't be hard coded, use j9zlib or is J9_ZIP_DLL_NAME sufficient?", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r379494953", "createdAt": "2020-02-14T15:33:30Z", "author": {"login": "pshipton"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1189,6 +1189,14 @@ preloadLibraries(void)\n \t * location if not preloaded. */\n \tpreloadLibrary(J9_HARMONY_PORT_LIBRARY_SHIM_DLL_NAME, TRUE);\n #endif /* J9VM_OPT_HARMONY */\n+\n+#if (defined(S390) && defined(LINUX))\n+\tvoid *zlibDLL = preloadLibrary(J9_ZIP_DLL_NAME, TRUE);\n+\tif (NULL == zlibDLL) {\n+\t\tfprintf(stderr,\"libj9zlib29.so failed to load: %s\\n\", J9_ZIP_DLL_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1229e123c2cfcb4442175c3ea3ca6c656d0db3a"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1229e123c2cfcb4442175c3ea3ca6c656d0db3a", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c1229e123c2cfcb4442175c3ea3ca6c656d0db3a", "committedDate": "2020-02-14T14:51:34Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "d0103a6e4b665f5e614e1b20b65c92d2e336d514", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d0103a6e4b665f5e614e1b20b65c92d2e336d514", "committedDate": "2020-02-14T16:06:42Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MDk1MzEy", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-359095312", "createdAt": "2020-02-14T17:16:18Z", "commit": {"oid": "d0103a6e4b665f5e614e1b20b65c92d2e336d514"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNzoxNjoxOFrOFp90wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNzoxNjoxOFrOFp90wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU0ODg2NA==", "bodyText": "It would be useful to document why this is only done on Linux on Z and why we are preloading this DLL in the first place as the reason is non-obvious.", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r379548864", "createdAt": "2020-02-14T17:16:18Z", "author": {"login": "fjeremic"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1189,6 +1189,14 @@ preloadLibraries(void)\n \t * location if not preloaded. */\n \tpreloadLibrary(J9_HARMONY_PORT_LIBRARY_SHIM_DLL_NAME, TRUE);\n #endif /* J9VM_OPT_HARMONY */\n+\n+#if (defined(S390) && defined(LINUX))\n+\tvoid *zlibDLL = preloadLibrary(J9_ZIP_DLL_NAME, TRUE);\n+\tif (NULL == zlibDLL) {\n+\t\tfprintf(stderr,\"Failed to load: %s\\n\", J9_ZIP_DLL_NAME);\n+\t\texit( -1 );\t/* failed */\n+\t}\n+#endif /* defined(S390) && defined(LINUX) */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0103a6e4b665f5e614e1b20b65c92d2e336d514"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0103a6e4b665f5e614e1b20b65c92d2e336d514", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d0103a6e4b665f5e614e1b20b65c92d2e336d514", "committedDate": "2020-02-14T16:06:42Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "909027c6d2d2b55fb7bf4a1c31505d8523b9dd9a", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/909027c6d2d2b55fb7bf4a1c31505d8523b9dd9a", "committedDate": "2020-02-14T21:38:07Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "909027c6d2d2b55fb7bf4a1c31505d8523b9dd9a", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/909027c6d2d2b55fb7bf4a1c31505d8523b9dd9a", "committedDate": "2020-02-14T21:38:07Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/530d10b8fa2143e0ad268d5b5e5274121f65318c", "committedDate": "2020-02-25T22:16:25Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0OTg3ODQ1", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-364987845", "createdAt": "2020-02-26T15:20:35Z", "commit": {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNToyMDozNVrOFuvxfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNToyMjowNFrOFuv1mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2MTUzMw==", "bodyText": "Multi-line comments should be consistent with the rest of the codebase. I've also amended the comment slightly to improve the grammar:\n\t\t\t/*\n\t\t\t * On Linux on Z libj9jit dynamically loads libj9zlib as it is used for AOT method data compression\n\t\t\t * which is currently only enabled on Z platform. We want to ensure that when the JVM loads libj9jit,\n\t\t\t * libj9zlib is already loaded. See eclipse/openj9#8561 for more details.\n\t\t\t */", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384561533", "createdAt": "2020-02-26T15:20:35Z", "author": {"login": "fjeremic"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2MTkzMA==", "bodyText": "Ifdefs should begin at column 0 (no indentation) to be consistent with other ifdefs.", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384561930", "createdAt": "2020-02-26T15:21:08Z", "author": {"login": "fjeremic"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/\n+\t\t\t#if (defined(S390) && defined(LINUX))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2MjU4NQ==", "bodyText": "Are we able to use j9str_printf here? See an example 6 lines below. Let's try to be safe by passing the length of the temporary buffer so we don't have buffer overflows here.", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384562585", "createdAt": "2020-02-26T15:22:04Z", "author": {"login": "fjeremic"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/\n+\t\t\t#if (defined(S390) && defined(LINUX))\n+\t\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\t\tstrcpy(zlibDllDir, vm->j9libvmDirectory);\n+\t\t\t\tstrncat(zlibDllDir, DIR_SEPARATOR_STR, sizeof(DIR_SEPARATOR_STR)-1);\n+\t\t\t\tstrncat(zlibDllDir, J9_ZIP_DLL_NAME, sizeof(J9_ZIP_DLL_NAME)-1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0OTk2OTUy", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-364996952", "createdAt": "2020-02-26T15:30:18Z", "commit": {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTozMDoxOVrOFuwNzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTozMjoxNVrOFuwTBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2ODc4MQ==", "bodyText": "please introduce a scope as c89 requires that variables are defined at the top of a scope", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384568781", "createdAt": "2020-02-26T15:30:19Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/\n+\t\t\t#if (defined(S390) && defined(LINUX))\n+\t\t\t\tchar zlibDll[EsMaxPath];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2OTcwNg==", "bodyText": "Please always use opening and closing { & } curly braces for control flow.  It's too easy to indent code that looks like it should be part of the if and isn't if the braces aren't there.", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384569706", "createdAt": "2020-02-26T15:31:36Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/\n+\t\t\t#if (defined(S390) && defined(LINUX))\n+\t\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\t\tstrcpy(zlibDllDir, vm->j9libvmDirectory);\n+\t\t\t\tstrncat(zlibDllDir, DIR_SEPARATOR_STR, sizeof(DIR_SEPARATOR_STR)-1);\n+\t\t\t\tstrncat(zlibDllDir, J9_ZIP_DLL_NAME, sizeof(J9_ZIP_DLL_NAME)-1);\n+\t\t\t\tif (0 != j9sl_open_shared_library(zlibDllDir, &(entry->descriptor), openFlags))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3MDExOQ==", "bodyText": "If the preload fails, shouldn't this return an error and prevent the VM from starting?", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384570119", "createdAt": "2020-02-26T15:32:15Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/\n+\t\t\t#if (defined(S390) && defined(LINUX))\n+\t\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\t\tstrcpy(zlibDllDir, vm->j9libvmDirectory);\n+\t\t\t\tstrncat(zlibDllDir, DIR_SEPARATOR_STR, sizeof(DIR_SEPARATOR_STR)-1);\n+\t\t\t\tstrncat(zlibDllDir, J9_ZIP_DLL_NAME, sizeof(J9_ZIP_DLL_NAME)-1);\n+\t\t\t\tif (0 != j9sl_open_shared_library(zlibDllDir, &(entry->descriptor), openFlags))\n+ \t\t\t\t\tj9tty_printf(PORTLIB, \"Error: Failed to open zlib DLL %s (%s)\\n\", zlibDllDir, j9error_last_error_message());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/530d10b8fa2143e0ad268d5b5e5274121f65318c", "committedDate": "2020-02-25T22:16:25Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "407d2b7bfff8c149fc48a0b04a5297828c87a1b5", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/407d2b7bfff8c149fc48a0b04a5297828c87a1b5", "committedDate": "2020-02-26T15:43:46Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "407d2b7bfff8c149fc48a0b04a5297828c87a1b5", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/407d2b7bfff8c149fc48a0b04a5297828c87a1b5", "committedDate": "2020-02-26T15:43:46Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "986aa314b060cef51709e4fd8949dad95861a2ef", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/986aa314b060cef51709e4fd8949dad95861a2ef", "committedDate": "2020-02-26T21:12:18Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NDQwNzM5", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-365440739", "createdAt": "2020-02-27T06:32:49Z", "commit": {"oid": "986aa314b060cef51709e4fd8949dad95861a2ef"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjozMjo0OVrOFvGmCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjozODoyN1rOFvGslA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzNTQzNA==", "bodyText": "where does this memory get freed?  Likely needs to be added at the end of the scope", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384935434", "createdAt": "2020-02-27T06:32:49Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2843,8 +2843,41 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\t* On Linux on Z libj9jit dynamically loads libj9zlib as it is used for AOT method data compression\n+\t\t\t* which is currently only enabled on Z platform. We want to ensure that when the JVM loads libj9jit,\n+\t\t\t* libj9zlib is already loaded. See eclipse/openj9#8561 for more details.\n+\t\t\t*/\n+#if (defined(S390) && defined(LINUX))\n+\t\t\t{\n+\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\tUDATA expectedZlibPathLength = 0;\n+\t\t\tUDATA zlibDllLength = 0;\n+\t\t\tUDATA zlibFileHandle = 0;\n+\t\t\t\n+\t\t\tzlibDllLength = strlen(vm->j9libvmDirectory);\n+\t\t\texpectedZlibPathLength = zlibDllLength + (sizeof(DIR_SEPARATOR_STR) - 1) + strlen(J9_ZIP_DLL_NAME) + 1;\n+\t\t\tif (expectedZlibPathLength > EsMaxPath) {\n+\t\t\t\tzlibDllDir = j9mem_allocate_memory(expectedZlibPathLength, OMRMEM_CATEGORY_VM);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "986aa314b060cef51709e4fd8949dad95861a2ef"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzNTk0Ng==", "bodyText": "Vaguely this code to do the free\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t}\n          \n          \n            \n            \t\t\t}\n          \n          \n            \n            \t\t\tif (zlibDllDir != zlibDll) {\n          \n          \n            \n            \t\t\t\tj9_mem_free_memory(zlibDllDir);\n          \n          \n            \n            \t\t\t\tzlibDllDir = NULL;\n          \n          \n            \n            \t\t\t}", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384935946", "createdAt": "2020-02-27T06:34:22Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2843,8 +2843,41 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\t* On Linux on Z libj9jit dynamically loads libj9zlib as it is used for AOT method data compression\n+\t\t\t* which is currently only enabled on Z platform. We want to ensure that when the JVM loads libj9jit,\n+\t\t\t* libj9zlib is already loaded. See eclipse/openj9#8561 for more details.\n+\t\t\t*/\n+#if (defined(S390) && defined(LINUX))\n+\t\t\t{\n+\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\tUDATA expectedZlibPathLength = 0;\n+\t\t\tUDATA zlibDllLength = 0;\n+\t\t\tUDATA zlibFileHandle = 0;\n+\t\t\t\n+\t\t\tzlibDllLength = strlen(vm->j9libvmDirectory);\n+\t\t\texpectedZlibPathLength = zlibDllLength + (sizeof(DIR_SEPARATOR_STR) - 1) + strlen(J9_ZIP_DLL_NAME) + 1;\n+\t\t\tif (expectedZlibPathLength > EsMaxPath) {\n+\t\t\t\tzlibDllDir = j9mem_allocate_memory(expectedZlibPathLength, OMRMEM_CATEGORY_VM);\n+\t\t\t\tif (NULL == zlibDllDir) {\n+\t\t\t\t\treturn JNI_ERR;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tj9str_printf(PORTLIB, zlibDllDir, expectedZlibPathLength, \"%s%s%s\",\n+\t\t\t\t\tvm->j9libvmDirectory, DIR_SEPARATOR_STR, J9_ZIP_DLL_NAME);\n+\t\t\tzlibFileHandle = j9sl_open_shared_library(zlibDllDir, &(entry->descriptor), openFlags);\n+\t\t\tif (0 != zlibFileHandle) {\n+\t\t\t\tj9tty_printf(PORTLIB, \"Error: Failed to open zlib DLL %s (%s)\\n\", zlibDllDir, j9error_last_error_message());\n+\t\t\t\treturn JNI_ERR;\n+\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "986aa314b060cef51709e4fd8949dad95861a2ef"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzNzEwOA==", "bodyText": "This block of code splits the existing code to calculate the dllCheckPathPtr in half.  It would be better to put the new code immediately after the openFlags = 0 line so the rest of the existing code is kept in a logical block", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384937108", "createdAt": "2020-02-27T06:38:27Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2843,8 +2843,41 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "986aa314b060cef51709e4fd8949dad95861a2ef"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "986aa314b060cef51709e4fd8949dad95861a2ef", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/986aa314b060cef51709e4fd8949dad95861a2ef", "committedDate": "2020-02-26T21:12:18Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "f64513e69ec8f8883698e30e01730323d525d247", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f64513e69ec8f8883698e30e01730323d525d247", "committedDate": "2020-02-27T21:17:35Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f64513e69ec8f8883698e30e01730323d525d247", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f64513e69ec8f8883698e30e01730323d525d247", "committedDate": "2020-02-27T21:17:35Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "a89449f2f40886f87f752cd1906190c63fb59c9c", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/a89449f2f40886f87f752cd1906190c63fb59c9c", "committedDate": "2020-02-27T21:19:55Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTU2ODkx", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-366156891", "createdAt": "2020-02-28T04:37:20Z", "commit": {"oid": "a89449f2f40886f87f752cd1906190c63fb59c9c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNDozNzoyMFrOFvpTnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNDozNzo1NVrOFvpT-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwNDE1Nw==", "bodyText": "Shouldn't this be checking and freeing zlibDllDir?", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r385504157", "createdAt": "2020-02-28T04:37:20Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2827,6 +2827,45 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\tUDATA openFlags = (entry->loadFlags & XRUN_LIBRARY) ? J9PORT_SLOPEN_DECORATE | J9PORT_SLOPEN_LAZY : J9PORT_SLOPEN_DECORATE;\n \t\t\tUDATA jitFileHandle = 0;\n \t\t\tUDATA rc = 0;\n+\n+\t\t\t/*\n+\t\t\t* On Linux on Z libj9jit dynamically loads libj9zlib as it is used for AOT method data compression\n+\t\t\t* which is currently only enabled on Z platform. We want to ensure that when the JVM loads libj9jit,\n+\t\t\t* libj9zlib is already loaded. See eclipse/openj9#8561 for more details.\n+\t\t\t*/\n+#if (defined(S390) && defined(LINUX))\n+\t\t\t{\n+\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\tUDATA expectedZlibPathLength = 0;\n+\t\t\tUDATA zlibDllLength = 0;\n+\t\t\tUDATA zlibFileHandle = 0;\n+\t\t\tUDATA zlibRC = 0;\n+\t\t\t\n+\t\t\tzlibDllLength = strlen(vm->j9libvmDirectory);\n+\t\t\texpectedZlibPathLength = zlibDllLength + (sizeof(DIR_SEPARATOR_STR) - 1) + strlen(J9_ZIP_DLL_NAME) + 1;\n+\t\t\tif (expectedZlibPathLength > EsMaxPath) {\n+\t\t\t\tzlibDllDir = j9mem_allocate_memory(expectedZlibPathLength, OMRMEM_CATEGORY_VM);\n+\t\t\t\tif (NULL == zlibDllDir) {\n+\t\t\t\t\treturn JNI_ERR;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tj9str_printf(PORTLIB, zlibDllDir, expectedZlibPathLength, \"%s%s%s\",\n+\t\t\t\t\tvm->j9libvmDirectory, DIR_SEPARATOR_STR, J9_ZIP_DLL_NAME);\n+\t\t\tzlibFileHandle = j9sl_open_shared_library(zlibDllDir, &(entry->descriptor), openFlags);\n+\t\t\tif (0 != zlibFileHandle) {\n+\t\t\t\tj9tty_printf(PORTLIB, \"Error: Failed to open zlib DLL %s (%s)\\n\", zlibDllDir, j9error_last_error_message());\n+\t\t\t\tzlibRC = JNI_ERR;\n+\t\t\t}\n+\t\t\tif (dllCheckPath != dllCheckPathPtr) {\n+\t\t\t\tj9mem_free_memory(dllCheckPathPtr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a89449f2f40886f87f752cd1906190c63fb59c9c"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwNDI1MA==", "bodyText": "please remove this and the newline below as they aren't necessary", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r385504250", "createdAt": "2020-02-28T04:37:55Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2843,8 +2882,10 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a89449f2f40886f87f752cd1906190c63fb59c9c"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e48c33912d47113584108850881db71f46a57220", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e48c33912d47113584108850881db71f46a57220", "committedDate": "2020-02-28T15:32:31Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a89449f2f40886f87f752cd1906190c63fb59c9c", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/a89449f2f40886f87f752cd1906190c63fb59c9c", "committedDate": "2020-02-27T21:19:55Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}, "afterCommit": {"oid": "e48c33912d47113584108850881db71f46a57220", "author": {"user": {"login": "simonameng", "name": "Simona Meng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e48c33912d47113584108850881db71f46a57220", "committedDate": "2020-02-28T15:32:31Z", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NDk5MjMx", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-366499231", "createdAt": "2020-02-28T15:53:19Z", "commit": {"oid": "e48c33912d47113584108850881db71f46a57220"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjY2NjYx", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-368266661", "createdAt": "2020-03-03T19:36:53Z", "commit": {"oid": "e48c33912d47113584108850881db71f46a57220"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4Mjg0OTMy", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-368284932", "createdAt": "2020-03-03T20:04:07Z", "commit": {"oid": "e48c33912d47113584108850881db71f46a57220"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4Mjk5MDkw", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#pullrequestreview-368299090", "createdAt": "2020-03-03T20:26:31Z", "commit": {"oid": "e48c33912d47113584108850881db71f46a57220"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 786, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}