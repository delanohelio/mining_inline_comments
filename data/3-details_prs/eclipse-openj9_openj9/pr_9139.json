{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5ODQ0OTU5", "number": 9139, "title": "Avoid value type inline allocations", "bodyText": "For the prototype implementation of value types, special handling of value type classes is required in a few cases:\n\nIf the new bytecode is applied to a value type class, an InstantiationError must be thrown;\nIf an identity (that is, non-value type) class has a value type field, that field should be instantiated with the default value of the value type when an instance of the identity class is create with the new bytecode; and\nIf an array with value type elements is created with anewarray or with multianewarray, the elements of value type are initialized with the default value for the value type.\n\nThese changes avoid inline allocation and stack allocation in such situations, as the code for inline allocation is not yet able to handle the special requirements.", "createdAt": "2020-04-06T19:03:58Z", "url": "https://github.com/eclipse-openj9/openj9/pull/9139", "merged": true, "mergeCommit": {"oid": "80fe748aaf5c68080ed4a6b5d0eca32d10c5ac58"}, "closed": true, "closedAt": "2020-04-27T13:56:49Z", "author": {"login": "hzongaro"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcU_bKFgH2gAyMzk5ODQ0OTU5OjI4NzRjMTFlZmQ2YzJkYzRlZmI2YmQ1ZWZkZGIxNjc2MDMwZjU2N2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbvs9agFqTQwMDk3Njg5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2874c11efd6c2dc4efb6bd5efddb1676030f567d", "author": {"user": {"login": "hzongaro", "name": "Henry Zongaro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2874c11efd6c2dc4efb6bd5efddb1676030f567d", "committedDate": "2020-04-06T14:18:15Z", "message": "Ensure that jitNewObject for value type is not evaluated inline\n\nIn the prototype implementation of value types, if the class specified\nfor the NEW bytecode instruction is a value type, an InstantiationError\nmust be thrown.  Value type instances are only created through the\ndefaultvalue and withfield bytecode instructions.\n\nIf the class passed to the jitNewObject helper is known to be a value\ntype, have canAllocateInlineClass return false for it.  That prevents\nthe JIT from generating inline code for allocating an instance,\nincluding preventing it from being eligible for escape analysis.  That\nensures the helper is called at runtime, allowing it to throw the\nrequired InstantiationError.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzE4NzQw", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#pullrequestreview-390318740", "createdAt": "2020-04-08T20:46:03Z", "commit": {"oid": "89a6f471bd5000458aefa91d54a9f0b17ff1cfdc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo0NjowM1rOGDAT_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo0NjowM1rOGDAT_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNDAzMA==", "bodyText": "Just to clarify, \"unflattened value type\" means a value type that is not the reference project of the type?", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#discussion_r405804030", "createdAt": "2020-04-08T20:46:03Z", "author": {"login": "Leonardo2718"}, "path": "runtime/compiler/optimizer/EscapeAnalysis.cpp", "diffHunk": "@@ -1076,6 +1076,23 @@ int32_t TR_EscapeAnalysis::performAnalysisOnce()\n                traceMsg(comp(), \"   Make [%p] non-local because we can't have locking when candidate escapes in cold blocks\\n\", candidate->_node);\n             }\n \n+         // Value type fields of objects created with a NEW bytecode must be initialized\n+         // with their default values.  EA is not yet set up to perform such iniitialization,\n+         // so remove the candidate from consideration.\n+         if (candidate->_kind == TR::New)\n+            {\n+            TR_OpaqueClassBlock *clazz = (TR_OpaqueClassBlock *)candidate->_node->getFirstChild()->getSymbol()->getStaticSymbol()->getStaticAddress();\n+\n+            if (!TR::Compiler->cls.isZeroInitializable(clazz))\n+               {\n+               if (trace())\n+                  traceMsg(comp(), \"   Fail [%p] because the candidate is not zero initializable (that is, it has a field that is an unflattened value type)\\n\", candidate->_node);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a6f471bd5000458aefa91d54a9f0b17ff1cfdc"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzIwODY0", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#pullrequestreview-390320864", "createdAt": "2020-04-08T20:49:13Z", "commit": {"oid": "ed0d00d2bc63a98162302a40aab45f56c785ae18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo0OToxM1rOGDAa-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDo0OToxM1rOGDAa-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNTgxOQ==", "bodyText": "Can I suggest making this a const?", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#discussion_r405805819", "createdAt": "2020-04-08T20:49:13Z", "author": {"login": "Leonardo2718"}, "path": "runtime/compiler/compile/J9Compilation.cpp", "diffHunk": "@@ -617,6 +617,8 @@ J9::Compilation::canAllocateInline(TR::Node* node, TR_OpaqueClassBlock* &classIn\n \n    bool generateArraylets = self()->generateArraylets();\n \n+   bool areValueTypesEnabled = TR::Compiler->om.areValueTypesEnabled();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed0d00d2bc63a98162302a40aab45f56c785ae18"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNzg1ODEz", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#pullrequestreview-390785813", "createdAt": "2020-04-09T13:22:18Z", "commit": {"oid": "e91dcf5de46b3fb00e676d5474e337e7d3e411ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzoyMjoxOFrOGDYbfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzoyMjoxOFrOGDYbfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE5OTE2Ng==", "bodyText": "How does this fail happen - the trace says there is a failure, but the candidate isn't removed?", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#discussion_r406199166", "createdAt": "2020-04-09T13:22:18Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/optimizer/EscapeAnalysis.cpp", "diffHunk": "@@ -1169,6 +1187,16 @@ int32_t TR_EscapeAnalysis::performAnalysisOnce()\n                rememoize(candidate);\n                _candidates.remove(candidate);\n                }\n+            else\n+               {\n+               TR_OpaqueClassBlock *clazz = (TR_OpaqueClassBlock*)classNode->getSymbol()->castToStaticSymbol()->getStaticAddress();\n+\n+               if (TR::Compiler->cls.isValueTypeClass(clazz))\n+                  {\n+                  if (trace())\n+                     traceMsg(comp(), \"   Fail [%p] because array has value type elements\\n\", candidate->_node);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e91dcf5de46b3fb00e676d5474e337e7d3e411ab"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNzg3MTk0", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#pullrequestreview-390787194", "createdAt": "2020-04-09T13:23:54Z", "commit": {"oid": "e91dcf5de46b3fb00e676d5474e337e7d3e411ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzoyMzo1NFrOGDYf9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzoyMzo1NFrOGDYf9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIwMDMwOQ==", "bodyText": "This is a pretty big thing since the dynamic allocations won't work - can we have a debug counter and a trace statement? Ultimately we would want to check at runtime if we could do the inline allocation otherwise call out, but this is fine as a first step for functional correctness.", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#discussion_r406200309", "createdAt": "2020-04-09T13:23:54Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/compile/J9Compilation.cpp", "diffHunk": "@@ -665,11 +667,12 @@ J9::Compilation::canAllocateInline(TR::Node* node, TR_OpaqueClassBlock* &classIn\n       {\n       classRef      = node->getSecondChild();\n \n-      // In the case of dynamic array allocation, return 0 indicating variable dynamic array allocation\n+      // In the case of dynamic array allocation, return 0 indicating variable dynamic array allocation,\n+      // unless value types are enabled, in which case return -1 to prevent inline allocation\n       if (classRef->getOpCodeValue() != TR::loadaddr)\n          {\n          classInfo = NULL;\n-         return 0;\n+         return areValueTypesEnabled ? -1 : 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e91dcf5de46b3fb00e676d5474e337e7d3e411ab"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwODUyNzY4", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#pullrequestreview-390852768", "createdAt": "2020-04-09T14:37:19Z", "commit": {"oid": "e91dcf5de46b3fb00e676d5474e337e7d3e411ab"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDozNzoxOVrOGDbpUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDo0MjozNFrOGDb4cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1MTg1Ng==", "bodyText": "I'd like to see TraceAssert added to inlineAllocateIndexableObject and similar helpers to validate that we're not passing any classes that have the J9ClassContainsUnflattenedFlattenables bit set.\nThe assert should be guarded by J9VM_OPT_VALHALLA_VALUE_TYPES.  FYI @tajila", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#discussion_r406251856", "createdAt": "2020-04-09T14:37:19Z", "author": {"login": "DanHeidinga"}, "path": "runtime/oti/VMHelpers.hpp", "diffHunk": "@@ -756,7 +756,7 @@ class VM_VMHelpers\n #if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n \t\tif (J9_IS_J9CLASS_FLATTENED(arrayClass)) {\n \t\t\tinstance = objectAllocate->inlineAllocateIndexableValueTypeObject(currentThread, arrayClass, size, initializeSlots, memoryBarrier, sizeCheck);\n-\t\t} else\n+\t\t} else if (J9_ARE_NO_BITS_SET(arrayClass->classFlags, J9ClassContainsUnflattenedFlattenables))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e91dcf5de46b3fb00e676d5474e337e7d3e411ab"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NTczMQ==", "bodyText": "Looking at the interpreter code, I think we have different semantics there and may trip up on a case like:\ninline class I {\n   int a;\n   int b;\n}\n\nclass Bad {\n  I i;\n  int c;\n}\n\nnew Bad[10];\nSee\nhttps://github.com/eclipse/openj9/blob/c6b594b6c03f957bb6a07f5d234a6d996037a17f/runtime/vm/BytecodeInterpreter.hpp#L1079-L1087\nwhich calls:\nhttps://github.com/eclipse/openj9/blob/c6b594b6c03f957bb6a07f5d234a6d996037a17f/runtime/vm/BytecodeInterpreter.hpp#L1051-L1061\nwhich means either the inline allocate code already handles this or the interpreter needs to be fixed too", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#discussion_r406255731", "createdAt": "2020-04-09T14:42:34Z", "author": {"login": "DanHeidinga"}, "path": "runtime/oti/VMHelpers.hpp", "diffHunk": "@@ -756,7 +756,7 @@ class VM_VMHelpers\n #if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n \t\tif (J9_IS_J9CLASS_FLATTENED(arrayClass)) {\n \t\t\tinstance = objectAllocate->inlineAllocateIndexableValueTypeObject(currentThread, arrayClass, size, initializeSlots, memoryBarrier, sizeCheck);\n-\t\t} else\n+\t\t} else if (J9_ARE_NO_BITS_SET(arrayClass->classFlags, J9ClassContainsUnflattenedFlattenables))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1MTg1Ng=="}, "originalCommit": {"oid": "e91dcf5de46b3fb00e676d5474e337e7d3e411ab"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwODk1MzYw", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#pullrequestreview-390895360", "createdAt": "2020-04-09T15:24:52Z", "commit": {"oid": "e91dcf5de46b3fb00e676d5474e337e7d3e411ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d897b437a02626a45d5be525d10a50d192db14c1", "author": {"user": {"login": "hzongaro", "name": "Henry Zongaro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d897b437a02626a45d5be525d10a50d192db14c1", "committedDate": "2020-04-13T18:09:23Z", "message": "Avoid Escape Analysis for objects or arrays involving value types\n\nA value type field of an object created by the NEW bytecode must be\ninitialized with the default value of the field.  Escape Analysis is\nnot yet prepared to perform that initialization, so for now such objects\nmust not be stack allocated.\n\nSimilarly, an array whose element type is a value type has its elements\ninitialized by the ANEWARRAY or MULTIANEWARRAY bytecode with the\ndefault value of the type, but Escape Analysis is not yet set up to\nperform such initialization, so such arrays must not be stack allocated\nfor now.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e91dcf5de46b3fb00e676d5474e337e7d3e411ab", "author": {"user": {"login": "hzongaro", "name": "Henry Zongaro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e91dcf5de46b3fb00e676d5474e337e7d3e411ab", "committedDate": "2020-04-06T14:18:15Z", "message": "Check for array elements with value type fields\n\nCheck whether array elements have value type fields that have not been\nflattened in deciding whether inline allocation can be used to allocate\nthe array.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>"}, "afterCommit": {"oid": "b50419689b2cd71d4ad7306e2d6e3995a5ab0802", "author": {"user": {"login": "hzongaro", "name": "Henry Zongaro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b50419689b2cd71d4ad7306e2d6e3995a5ab0802", "committedDate": "2020-04-13T18:09:32Z", "message": "Check for array elements with value type fields\n\nCheck whether array elements have value type fields that have not been\nflattened in deciding whether inline allocation can be used to allocate\nthe array.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NzYyMjAx", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#pullrequestreview-394762201", "createdAt": "2020-04-16T15:41:48Z", "commit": {"oid": "b50419689b2cd71d4ad7306e2d6e3995a5ab0802"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo0MTo0OFrOGGriXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo0MTo0OFrOGGriXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY1Nzk1MA==", "bodyText": "Windows build failure due to the reference to the uninitialized size variable in the call to traceMsg.", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#discussion_r409657950", "createdAt": "2020-04-16T15:41:48Z", "author": {"login": "hzongaro"}, "path": "runtime/compiler/compile/J9Compilation.cpp", "diffHunk": "@@ -665,11 +667,26 @@ J9::Compilation::canAllocateInline(TR::Node* node, TR_OpaqueClassBlock* &classIn\n       {\n       classRef      = node->getSecondChild();\n \n-      // In the case of dynamic array allocation, return 0 indicating variable dynamic array allocation\n+      // In the case of dynamic array allocation, return 0 indicating variable dynamic array allocation,\n+      // unless value types are enabled, in which case return -1 to prevent inline allocation\n       if (classRef->getOpCodeValue() != TR::loadaddr)\n          {\n          classInfo = NULL;\n-         return 0;\n+         if (areValueTypesEnabled)\n+            {\n+            if (self()->getOption(TR_TraceCG))\n+               {\n+               traceMsg(self(), \"cannot inline array allocation @ node %p because value types are enabled\\n\", node, size);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b50419689b2cd71d4ad7306e2d6e3995a5ab0802"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a328c0329eb9ecb0ba1648741437e5cb24d151ad", "author": {"user": {"login": "hzongaro", "name": "Henry Zongaro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/a328c0329eb9ecb0ba1648741437e5cb24d151ad", "committedDate": "2020-04-16T15:47:27Z", "message": "Avoid inline allocation of arrays of value types\n\nAn array whose elements are of a value type needs to be initialized\nwith the default value of its elements' value type when it is\ncreated with an ANEWARRAY or MULTIANEWARRAY bytecode.  Inline\nallocation of arrays is not yet able to handle this, so inline\nallocation has to be prevented for such arrays.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9066f729bd7b8dcdda01175419aaac8f86fdeba8", "author": {"user": {"login": "hzongaro", "name": "Henry Zongaro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9066f729bd7b8dcdda01175419aaac8f86fdeba8", "committedDate": "2020-04-16T15:47:53Z", "message": "Check for array elements with value type fields\n\nCheck whether array elements have value type fields that have not been\nflattened in deciding whether inline allocation can be used to allocate\nthe array.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b50419689b2cd71d4ad7306e2d6e3995a5ab0802", "author": {"user": {"login": "hzongaro", "name": "Henry Zongaro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b50419689b2cd71d4ad7306e2d6e3995a5ab0802", "committedDate": "2020-04-13T18:09:32Z", "message": "Check for array elements with value type fields\n\nCheck whether array elements have value type fields that have not been\nflattened in deciding whether inline allocation can be used to allocate\nthe array.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>"}, "afterCommit": {"oid": "9066f729bd7b8dcdda01175419aaac8f86fdeba8", "author": {"user": {"login": "hzongaro", "name": "Henry Zongaro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9066f729bd7b8dcdda01175419aaac8f86fdeba8", "committedDate": "2020-04-16T15:47:53Z", "message": "Check for array elements with value type fields\n\nCheck whether array elements have value type fields that have not been\nflattened in deciding whether inline allocation can be used to allocate\nthe array.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwOTc2ODk2", "url": "https://github.com/eclipse-openj9/openj9/pull/9139#pullrequestreview-400976896", "createdAt": "2020-04-27T13:56:41Z", "commit": {"oid": "9066f729bd7b8dcdda01175419aaac8f86fdeba8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1199, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}