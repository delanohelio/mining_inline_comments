{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExMTAyNDY0", "number": 9415, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDozOTowNVrOD4ErLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNTowNTo1MFrOD4FZzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMTIzNDM3OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/HookedByTheJit.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDozOTowNVrOGOsZCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDozOTowNVrOGOsZCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2MDU1Mg==", "bodyText": "This second line of comment can be removed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418060552", "createdAt": "2020-04-30T14:39:05Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/HookedByTheJit.cpp", "diffHunk": "@@ -2484,20 +2484,25 @@ void jitIllegalFinalFieldModification(J9VMThread *currentThread, J9Class *fieldC\n    {\n    J9JITConfig * jitConfig = currentThread->javaVM->jitConfig;\n    TR::CompilationInfo * compInfo = TR::CompilationInfo::get(jitConfig);\n+   TR_J9VMBase * fe = TR_J9VMBase::get(jitConfig, currentThread);\n+\n+   // Set the bit so that VM doesn't report the modification next time\n+   fieldClass->classFlags |= J9ClassHasIllegalFinalFieldModifications;\n \n #if defined(J9VM_OPT_JITSERVER)\n    if (compInfo->getPersistentInfo()->getRemoteCompilationMode() == JITServer::SERVER)\n       {\n       // Don't execute this hook at the jitserver side\n       // This piece of code will be removed once all JIT hooks is disabled at the jitserver side", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMTI0NDQ1OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDo0MToxNlrOGOsfVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNTozNTo1OFrOGOu5aA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2MjE2NA==", "bodyText": "Let's split this line because it's too long", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418062164", "createdAt": "2020-04-30T14:41:16Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -3138,6 +3138,9 @@ remoteCompile(\n    // Collect the list of unloaded classes\n    std::vector<TR_OpaqueClassBlock*> unloadedClasses(compInfo->getUnloadedClassesTempList()->begin(), compInfo->getUnloadedClassesTempList()->end());\n    compInfo->getUnloadedClassesTempList()->clear();\n+   std::vector<TR_OpaqueClassBlock*> illegalModificationList(compInfo->getIllegalFinalFieldModificationList()->begin(),\n+                                                                       compInfo->getIllegalFinalFieldModificationList()->end());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwMTYwOA==", "bodyText": "Not sure I'm following. It's already separated into two lines:\n   std::vector<TR_OpaqueClassBlock*> illegalModificationList(compInfo->getIllegalFinalFieldModificationList()->begin(),\n                                                             compInfo->getIllegalFinalFieldModificationList()->end());", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418101608", "createdAt": "2020-04-30T15:35:58Z", "author": {"login": "a7ehuo"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -3138,6 +3138,9 @@ remoteCompile(\n    // Collect the list of unloaded classes\n    std::vector<TR_OpaqueClassBlock*> unloadedClasses(compInfo->getUnloadedClassesTempList()->begin(), compInfo->getUnloadedClassesTempList()->end());\n    compInfo->getUnloadedClassesTempList()->clear();\n+   std::vector<TR_OpaqueClassBlock*> illegalModificationList(compInfo->getIllegalFinalFieldModificationList()->begin(),\n+                                                                       compInfo->getIllegalFinalFieldModificationList()->end());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2MjE2NA=="}, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMTI4MjkwOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/env/CHTable.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDo0OTozMVrOGOs3_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDo0OTozMVrOGOs3_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2ODQ3OA==", "bodyText": "Changes from #9396 need to be incorporated. Please rebase.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418068478", "createdAt": "2020-04-30T14:49:31Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/CHTable.cpp", "diffHunk": "@@ -377,7 +377,7 @@ bool TR_CHTable::commit(TR::Compilation *comp)\n          {\n          if (TR::Options::isAnyVerboseOptionSet(TR_VerboseRuntimeAssumptions, TR_VerboseCompileEnd, TR_VerbosePerformance, TR_VerboseCompFailure))\n             {\n-            TR_VerboseLog::writeLineLocked(TR_Vlog_FAILURE, \"Failure while commiting static final field assumption for class %p for %s\", clazz, comp->signature());\n+            TR_VerboseLog::writeLineLocked(TR_Vlog_FAILURE, \"hasIllegalStaticFinalFieldModification: Failure while commiting static final field assumption for class %p for %s\", clazz, comp->signature());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMTI5MjUzOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/env/J9ClassEnv.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDo1MTo0OFrOGOs-Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDo1MTo0OFrOGOs-Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA3MDA3OQ==", "bodyText": "This commented out code needs to be deleted.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418070079", "createdAt": "2020-04-30T14:51:48Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/J9ClassEnv.cpp", "diffHunk": "@@ -353,8 +353,25 @@ J9::ClassEnv::classHasIllegalStaticFinalFieldModification(TR_OpaqueClassBlock *\n #if defined(J9VM_OPT_JITSERVER)\n    if (auto stream = TR::CompilationInfo::getStream())\n       {\n+#if 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMTM0ODQwOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/runtime/JITClientSession.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNTowNDozMlrOGOtiyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNTo0MjoxN1rOGOvKgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA3OTQzNA==", "bodyText": "I thought about it and we don't need to acquire the RWMutex for this operation.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418079434", "createdAt": "2020-04-30T15:04:32Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -200,6 +200,39 @@ ClientSessionData::processUnloadedClasses(const std::vector<TR_OpaqueClassBlock*\n       writeReleaseClassUnloadRWMutex();\n    }\n \n+void\n+ClientSessionData::processIllegalFinalFieldModificationList(const std::vector<TR_OpaqueClassBlock*> &classes)\n+   {\n+   const size_t numOfClasses = classes.size();\n+\n+   if (TR::Options::getVerboseOption(TR_VerboseJITServer))\n+      TR_VerboseLog::writeLineLocked(TR_Vlog_JITServer,\n+         \"compThreadID=%d will process a list of %zu classes with illegal final field modification for clientUID %llu\",\n+            TR::compInfoPT->getCompThreadId(), numOfClasses, (unsigned long long)_clientUID);\n+\n+   if (numOfClasses > 0)\n+      writeAcquireClassUnloadRWMutex(); //TODO: use RAII style to avoid problems with exceptions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwNTk4NA==", "bodyText": "I'll remove them. I think it should be okay without taking the RWMutex.  Functional wise, it should work. If one thread reads the value without waiting for the write to complete and static field folding takes place, #9396 will abort the compilation properly at the client. This case might be rare so the performance might not be an issue.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418105984", "createdAt": "2020-04-30T15:42:17Z", "author": {"login": "a7ehuo"}, "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -200,6 +200,39 @@ ClientSessionData::processUnloadedClasses(const std::vector<TR_OpaqueClassBlock*\n       writeReleaseClassUnloadRWMutex();\n    }\n \n+void\n+ClientSessionData::processIllegalFinalFieldModificationList(const std::vector<TR_OpaqueClassBlock*> &classes)\n+   {\n+   const size_t numOfClasses = classes.size();\n+\n+   if (TR::Options::getVerboseOption(TR_VerboseJITServer))\n+      TR_VerboseLog::writeLineLocked(TR_Vlog_JITServer,\n+         \"compThreadID=%d will process a list of %zu classes with illegal final field modification for clientUID %llu\",\n+            TR::compInfoPT->getCompThreadId(), numOfClasses, (unsigned long long)_clientUID);\n+\n+   if (numOfClasses > 0)\n+      writeAcquireClassUnloadRWMutex(); //TODO: use RAII style to avoid problems with exceptions", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA3OTQzNA=="}, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMTM1Mzc1OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/runtime/JITClientSession.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNTowNTo1MFrOGOtmVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNTowNTo1MFrOGOtmVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4MDM0Mg==", "bodyText": "TR::compInfoPT->getCompThreadId() uses thread local storage which has overhead. Let's cache this and not call it repeatedly in the loop.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418080342", "createdAt": "2020-04-30T15:05:50Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -200,6 +200,39 @@ ClientSessionData::processUnloadedClasses(const std::vector<TR_OpaqueClassBlock*\n       writeReleaseClassUnloadRWMutex();\n    }\n \n+void\n+ClientSessionData::processIllegalFinalFieldModificationList(const std::vector<TR_OpaqueClassBlock*> &classes)\n+   {\n+   const size_t numOfClasses = classes.size();\n+\n+   if (TR::Options::getVerboseOption(TR_VerboseJITServer))\n+      TR_VerboseLog::writeLineLocked(TR_Vlog_JITServer,\n+         \"compThreadID=%d will process a list of %zu classes with illegal final field modification for clientUID %llu\",\n+            TR::compInfoPT->getCompThreadId(), numOfClasses, (unsigned long long)_clientUID);\n+\n+   if (numOfClasses > 0)\n+      writeAcquireClassUnloadRWMutex(); //TODO: use RAII style to avoid problems with exceptions\n+\n+      {\n+      OMR::CriticalSection processClassesWithIllegalModification(getROMMapMonitor());\n+      for (auto clazz : classes)\n+         {\n+         auto it = _romClassMap.find((J9Class*)clazz);\n+         if (it != _romClassMap.end())\n+            {\n+            it->second._classFlags |= J9ClassHasIllegalFinalFieldModifications;\n+            if (TR::Options::getVerboseOption(TR_VerboseJITServer))\n+               TR_VerboseLog::writeLineLocked(TR_Vlog_JITServer,\n+                  \"compThreadID=%d found clazz %p in the cache and updated bit J9ClassHasIllegalFinalFieldModifications to 1\\n\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 295, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}