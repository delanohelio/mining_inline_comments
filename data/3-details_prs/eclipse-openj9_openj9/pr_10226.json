{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NDMyNDQw", "number": 10226, "title": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon", "bodyText": "The intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.\nSigned-off-by: Cheng Jin jincheng@ca.ibm.com", "createdAt": "2020-07-23T01:21:00Z", "url": "https://github.com/eclipse-openj9/openj9/pull/10226", "merged": true, "mergeCommit": {"oid": "f60babb2cfa741dcc0ac80b17b1c98f73743a06e"}, "closed": true, "closedAt": "2020-07-24T00:26:11Z", "author": {"login": "ChengJin01"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3lVRFABqjM1NzgxMzYwODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3ysANABqjM1ODA5NTM5NjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d52abdda6d258112dc3615c974f9bbd9390821b2", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d52abdda6d258112dc3615c974f9bbd9390821b2", "committedDate": "2020-07-22T19:27:02Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}, "afterCommit": {"oid": "629cba27a2fa856f01cab9d9c8005f9af6a6d07e", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/629cba27a2fa856f01cab9d9c8005f9af6a6d07e", "committedDate": "2020-07-23T01:41:22Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "629cba27a2fa856f01cab9d9c8005f9af6a6d07e", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/629cba27a2fa856f01cab9d9c8005f9af6a6d07e", "committedDate": "2020-07-23T01:41:22Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}, "afterCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/71ef0796f2b472f441b581d5283812cc0dea71b4", "committedDate": "2020-07-23T04:21:39Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.[ci skip]\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MjQwMjYz", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#pullrequestreview-454240263", "createdAt": "2020-07-23T15:16:34Z", "commit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToxNjozNFrOG2PXvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToxNjozNFrOG2PXvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUyODEyNw==", "bodyText": "For consistency, please remove the space after the * in options (here and in the function declaration).", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459528127", "createdAt": "2020-07-23T15:16:34Z", "author": {"login": "gacholio"}, "path": "runtime/oti/jclprots.h", "diffHunk": "@@ -711,7 +711,7 @@ UDATA initializeRequiredClasses(J9VMThread *vmThread, char* libName);\n /* J9SourceJclDefineClass*/\n extern J9_CFUNC jclass \n defineClassCommon (JNIEnv *env, jobject classLoaderObject,\n-\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA options, J9Class *hostClass, J9ClassPatchMap *patchMap);\n+\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA * options, J9Class *hostClass, J9ClassPatchMap *patchMap, UDATA allowedBitsForClassName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MjQyNzgx", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#pullrequestreview-454242781", "createdAt": "2020-07-23T15:19:09Z", "commit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToxOTowOVrOG2PfVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToxOTowOVrOG2PfVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMDA3MQ==", "bodyText": "Array classes are not created via defineClass, so the more restrictive input value should be used here.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459530071", "createdAt": "2020-07-23T15:19:09Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/j7vmi.c", "diffHunk": "@@ -2555,11 +2555,17 @@ jvmDefineClassHelper(JNIEnv *env, jobject classLoaderObject,\n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n \n \tif (NULL != className) {\n-\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, J9_JNI_UNWRAP_REFERENCE(className), J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n+\t\tj9object_t classNameObject = J9_JNI_UNWRAP_REFERENCE(className);\n+\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, classNameObject, J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n \t\tif (NULL == utf8Name) {\n \t\t\tvmFuncs->setNativeOutOfMemoryError(currentThread, 0, 0);\n \t\t\tgoto done;\n \t\t}\n+\n+\t\tif (CLASSNAME_INVALID == vmFuncs->verifyQualifiedName(currentThread, classNameObject, CLASSNAME_VALID)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MjQ1NzEx", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#pullrequestreview-454245711", "createdAt": "2020-07-23T15:22:15Z", "commit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToyMjoxNVrOG2PoPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToyMjoxNVrOG2PoPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMjM1MQ==", "bodyText": "It doesn't look like the modified options value is used by any caller, so there's really no need to pass this by pointer. You are free to modify the options value directly.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459532351", "createdAt": "2020-07-23T15:22:15Z", "author": {"login": "gacholio"}, "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -29,7 +29,7 @@\n \n jclass \n defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n-\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA options, J9Class *hostClass, J9ClassPatchMap *patchMap)\n+\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA * options, J9Class *hostClass, J9ClassPatchMap *patchMap, UDATA allowedBitsForClassName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MjQ2OTc5", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#pullrequestreview-454246979", "createdAt": "2020-07-23T15:23:33Z", "commit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToyMzozNFrOG2Pr4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToyMzozNFrOG2Pr4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMzI4MA==", "bodyText": "Since defineClass never operates on arrays, you could pass BOOLEAN validateName instead of the allowed bits.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459533280", "createdAt": "2020-07-23T15:23:34Z", "author": {"login": "gacholio"}, "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -29,7 +29,7 @@\n \n jclass \n defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n-\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA options, J9Class *hostClass, J9ClassPatchMap *patchMap)\n+\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA * options, J9Class *hostClass, J9ClassPatchMap *patchMap, UDATA allowedBitsForClassName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/71ef0796f2b472f441b581d5283812cc0dea71b4", "committedDate": "2020-07-23T04:21:39Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.[ci skip]\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}, "afterCommit": {"oid": "b0053fa50cf4928721cb633858d31ef17e7d3ff4", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b0053fa50cf4928721cb633858d31ef17e7d3ff4", "committedDate": "2020-07-23T15:55:00Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.[ci skip]\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzEwNTY1", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#pullrequestreview-454310565", "createdAt": "2020-07-23T16:38:27Z", "commit": {"oid": "b0053fa50cf4928721cb633858d31ef17e7d3ff4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjozODoyOFrOG2SrxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjozODoyOFrOG2SrxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MjQwNQ==", "bodyText": "The passed in validateName should be the non-array constant.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459582405", "createdAt": "2020-07-23T16:38:28Z", "author": {"login": "gacholio"}, "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -102,12 +94,21 @@ defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n \n \t/* Allocate and initialize a UTF8 copy of the Unicode class-name */\n \tif (NULL != className) {\n-\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, J9_JNI_UNWRAP_REFERENCE(className), J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n+\t\tj9object_t classNameObject = J9_JNI_UNWRAP_REFERENCE(className);\n+\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, classNameObject, J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n \n \t\tif (NULL == utf8Name) {\n \t\t\tvmFuncs->setNativeOutOfMemoryError(currentThread, 0, 0);\n \t\t\tgoto done;\n \t\t}\n+\n+\t\tif (validateName && (CLASSNAME_INVALID == vmFuncs->verifyQualifiedName(currentThread, classNameObject, validateName))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0053fa50cf4928721cb633858d31ef17e7d3ff4"}, "originalPosition": 61}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0053fa50cf4928721cb633858d31ef17e7d3ff4", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b0053fa50cf4928721cb633858d31ef17e7d3ff4", "committedDate": "2020-07-23T15:55:00Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.[ci skip]\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}, "afterCommit": {"oid": "522c7f551ab5d28d0c7ce726026cba20e3549cc1", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/522c7f551ab5d28d0c7ce726026cba20e3549cc1", "committedDate": "2020-07-23T16:42:32Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.[ci skip]\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzE4NDA1", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#pullrequestreview-454318405", "createdAt": "2020-07-23T16:48:47Z", "commit": {"oid": "522c7f551ab5d28d0c7ce726026cba20e3549cc1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fe5c0afb85c96c89f486bc0b3b642ce0014f003", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2fe5c0afb85c96c89f486bc0b3b642ce0014f003", "committedDate": "2020-07-23T17:14:55Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.[ci skip]\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "522c7f551ab5d28d0c7ce726026cba20e3549cc1", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/522c7f551ab5d28d0c7ce726026cba20e3549cc1", "committedDate": "2020-07-23T16:42:32Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.[ci skip]\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}, "afterCommit": {"oid": "2fe5c0afb85c96c89f486bc0b3b642ce0014f003", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2fe5c0afb85c96c89f486bc0b3b642ce0014f003", "committedDate": "2020-07-23T17:14:55Z", "message": "Move verifyQualifiedName to jvmDefineClassHelper & defineClassCommon\n\nThe intention is to move verifyQualifiedName to jvmDefineClassHelper &\ndefineClassCommon in order to share the memory allocated by\ncopyStringToUTF8WithMemAlloc for the class name string later.[ci skip]\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 336, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}