{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NDMyNDQw", "number": 10226, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToxNjozNFrOERfyDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjozODoyOFrOERh10w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NzgxOTY0OnYy", "diffSide": "RIGHT", "path": "runtime/oti/jclprots.h", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToxNjozNFrOG2PXvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNTo1NTo1NFrOG2RDYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUyODEyNw==", "bodyText": "For consistency, please remove the space after the * in options (here and in the function declaration).", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459528127", "createdAt": "2020-07-23T15:16:34Z", "author": {"login": "gacholio"}, "path": "runtime/oti/jclprots.h", "diffHunk": "@@ -711,7 +711,7 @@ UDATA initializeRequiredClasses(J9VMThread *vmThread, char* libName);\n /* J9SourceJclDefineClass*/\n extern J9_CFUNC jclass \n defineClassCommon (JNIEnv *env, jobject classLoaderObject,\n-\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA options, J9Class *hostClass, J9ClassPatchMap *patchMap);\n+\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA * options, J9Class *hostClass, J9ClassPatchMap *patchMap, UDATA allowedBitsForClassName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1NTY4MA==", "bodyText": "Fixed as suggested above.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459555680", "createdAt": "2020-07-23T15:55:54Z", "author": {"login": "ChengJin01"}, "path": "runtime/oti/jclprots.h", "diffHunk": "@@ -711,7 +711,7 @@ UDATA initializeRequiredClasses(J9VMThread *vmThread, char* libName);\n /* J9SourceJclDefineClass*/\n extern J9_CFUNC jclass \n defineClassCommon (JNIEnv *env, jobject classLoaderObject,\n-\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA options, J9Class *hostClass, J9ClassPatchMap *patchMap);\n+\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA * options, J9Class *hostClass, J9ClassPatchMap *patchMap, UDATA allowedBitsForClassName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUyODEyNw=="}, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NzgzMTM2OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/j7vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToxOTowOVrOG2PfVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNTo1NjoyOFrOG2RE5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMDA3MQ==", "bodyText": "Array classes are not created via defineClass, so the more restrictive input value should be used here.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459530071", "createdAt": "2020-07-23T15:19:09Z", "author": {"login": "gacholio"}, "path": "runtime/j9vm/j7vmi.c", "diffHunk": "@@ -2555,11 +2555,17 @@ jvmDefineClassHelper(JNIEnv *env, jobject classLoaderObject,\n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n \n \tif (NULL != className) {\n-\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, J9_JNI_UNWRAP_REFERENCE(className), J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n+\t\tj9object_t classNameObject = J9_JNI_UNWRAP_REFERENCE(className);\n+\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, classNameObject, J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n \t\tif (NULL == utf8Name) {\n \t\t\tvmFuncs->setNativeOutOfMemoryError(currentThread, 0, 0);\n \t\t\tgoto done;\n \t\t}\n+\n+\t\tif (CLASSNAME_INVALID == vmFuncs->verifyQualifiedName(currentThread, classNameObject, CLASSNAME_VALID)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1NjA3MA==", "bodyText": "Replaced with CLASSNAME_VALID_NON_ARRARY in such case.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459556070", "createdAt": "2020-07-23T15:56:28Z", "author": {"login": "ChengJin01"}, "path": "runtime/j9vm/j7vmi.c", "diffHunk": "@@ -2555,11 +2555,17 @@ jvmDefineClassHelper(JNIEnv *env, jobject classLoaderObject,\n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n \n \tif (NULL != className) {\n-\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, J9_JNI_UNWRAP_REFERENCE(className), J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n+\t\tj9object_t classNameObject = J9_JNI_UNWRAP_REFERENCE(className);\n+\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, classNameObject, J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n \t\tif (NULL == utf8Name) {\n \t\t\tvmFuncs->setNativeOutOfMemoryError(currentThread, 0, 0);\n \t\t\tgoto done;\n \t\t}\n+\n+\t\tif (CLASSNAME_INVALID == vmFuncs->verifyQualifiedName(currentThread, classNameObject, CLASSNAME_VALID)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMDA3MQ=="}, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2Nzg0NTc3OnYy", "diffSide": "RIGHT", "path": "runtime/jcl/common/jcldefine.c", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToyMjoxNVrOG2PoPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNTo0NjoxOVrOG2QpiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMjM1MQ==", "bodyText": "It doesn't look like the modified options value is used by any caller, so there's really no need to pass this by pointer. You are free to modify the options value directly.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459532351", "createdAt": "2020-07-23T15:22:15Z", "author": {"login": "gacholio"}, "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -29,7 +29,7 @@\n \n jclass \n defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n-\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA options, J9Class *hostClass, J9ClassPatchMap *patchMap)\n+\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA * options, J9Class *hostClass, J9ClassPatchMap *patchMap, UDATA allowedBitsForClassName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0MjQ1Mg==", "bodyText": "the options are checked by Java_java_lang_ClassLoader_defineClassImpl as follows:\nJava_java_lang_ClassLoader_defineClassImpl(JNIEnv *env, jobject receiver, jstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain)\n{\n....\n\tjclass result = defineClassCommon(env, receiver, className, classRep, offset, length, protectionDomain, &options, NULL, NULL, CLASSNAME_VALID);\n\n\tif (J9_ARE_ANY_BITS_SET(options, J9_FINDCLASS_FLAG_NAME_IS_INVALID) <-----------\n\t&& (NULL == result) && (NULL == currentThread->currentException)) {\n\t\t/*\n\t\t * Now that we know the class is not exempt, throw NoClassDefFoundError as we\n\t\t * would have liked to have done above before we called defineClassCommon().\n\t\t */\n\t\tvmFuncs->internalEnterVMFromJNI(currentThread);\n\t\tvmFuncs->setCurrentException(currentThread, J9VMCONSTANTPOOL_JAVALANGNOCLASSDEFFOUNDERROR, (UDATA *)*(j9object_t *)className);\n\t\tvmFuncs->internalExitVMToJNI(currentThread);\n\t}\n\nWe can't move the setup of exception into defineClassCommon as other callers won't set up the NoClassDefFoundError exception.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459542452", "createdAt": "2020-07-23T15:36:37Z", "author": {"login": "ChengJin01"}, "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -29,7 +29,7 @@\n \n jclass \n defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n-\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA options, J9Class *hostClass, J9ClassPatchMap *patchMap)\n+\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA * options, J9Class *hostClass, J9ClassPatchMap *patchMap, UDATA allowedBitsForClassName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMjM1MQ=="}, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0OTA2NQ==", "bodyText": "Sorry, missed that.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459549065", "createdAt": "2020-07-23T15:46:19Z", "author": {"login": "gacholio"}, "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -29,7 +29,7 @@\n \n jclass \n defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n-\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA options, J9Class *hostClass, J9ClassPatchMap *patchMap)\n+\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA * options, J9Class *hostClass, J9ClassPatchMap *patchMap, UDATA allowedBitsForClassName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMjM1MQ=="}, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2Nzg1MTkzOnYy", "diffSide": "RIGHT", "path": "runtime/jcl/common/jcldefine.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToyMzozNFrOG2Pr4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNTo1NzoxMFrOG2RG6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMzI4MA==", "bodyText": "Since defineClass never operates on arrays, you could pass BOOLEAN validateName instead of the allowed bits.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459533280", "createdAt": "2020-07-23T15:23:34Z", "author": {"login": "gacholio"}, "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -29,7 +29,7 @@\n \n jclass \n defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n-\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA options, J9Class *hostClass, J9ClassPatchMap *patchMap)\n+\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA * options, J9Class *hostClass, J9ClassPatchMap *patchMap, UDATA allowedBitsForClassName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1NjU4Nw==", "bodyText": "Updated with BOOLEAN validateName as suggested above.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459556587", "createdAt": "2020-07-23T15:57:10Z", "author": {"login": "ChengJin01"}, "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -29,7 +29,7 @@\n \n jclass \n defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n-\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA options, J9Class *hostClass, J9ClassPatchMap *patchMap)\n+\tjstring className, jbyteArray classRep, jint offset, jint length, jobject protectionDomain, UDATA * options, J9Class *hostClass, J9ClassPatchMap *patchMap, UDATA allowedBitsForClassName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMzI4MA=="}, "originalCommit": {"oid": "71ef0796f2b472f441b581d5283812cc0dea71b4"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2ODE1Njk5OnYy", "diffSide": "RIGHT", "path": "runtime/jcl/common/jcldefine.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjozODoyOFrOG2SrxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjo0MzowMVrOG2S2bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MjQwNQ==", "bodyText": "The passed in validateName should be the non-array constant.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459582405", "createdAt": "2020-07-23T16:38:28Z", "author": {"login": "gacholio"}, "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -102,12 +94,21 @@ defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n \n \t/* Allocate and initialize a UTF8 copy of the Unicode class-name */\n \tif (NULL != className) {\n-\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, J9_JNI_UNWRAP_REFERENCE(className), J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n+\t\tj9object_t classNameObject = J9_JNI_UNWRAP_REFERENCE(className);\n+\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, classNameObject, J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n \n \t\tif (NULL == utf8Name) {\n \t\t\tvmFuncs->setNativeOutOfMemoryError(currentThread, 0, 0);\n \t\t\tgoto done;\n \t\t}\n+\n+\t\tif (validateName && (CLASSNAME_INVALID == vmFuncs->verifyQualifiedName(currentThread, classNameObject, validateName))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0053fa50cf4928721cb633858d31ef17e7d3ff4"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4NTEzMw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/10226#discussion_r459585133", "createdAt": "2020-07-23T16:43:01Z", "author": {"login": "ChengJin01"}, "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -102,12 +94,21 @@ defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n \n \t/* Allocate and initialize a UTF8 copy of the Unicode class-name */\n \tif (NULL != className) {\n-\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, J9_JNI_UNWRAP_REFERENCE(className), J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n+\t\tj9object_t classNameObject = J9_JNI_UNWRAP_REFERENCE(className);\n+\t\tutf8Name = (U_8*)vmFuncs->copyStringToUTF8WithMemAlloc(currentThread, classNameObject, J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT, \"\", 0, utf8NameStackBuffer, J9VM_PACKAGE_NAME_BUFFER_LENGTH, &utf8Length);\n \n \t\tif (NULL == utf8Name) {\n \t\t\tvmFuncs->setNativeOutOfMemoryError(currentThread, 0, 0);\n \t\t\tgoto done;\n \t\t}\n+\n+\t\tif (validateName && (CLASSNAME_INVALID == vmFuncs->verifyQualifiedName(currentThread, classNameObject, validateName))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MjQwNQ=="}, "originalCommit": {"oid": "b0053fa50cf4928721cb633858d31ef17e7d3ff4"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4803, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}