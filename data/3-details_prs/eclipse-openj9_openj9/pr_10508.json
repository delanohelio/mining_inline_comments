{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3OTI2NDY2", "number": 10508, "title": "Maintain CH table per JITServer client", "bodyText": "Before this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.", "createdAt": "2020-09-02T16:03:07Z", "url": "https://github.com/eclipse-openj9/openj9/pull/10508", "merged": true, "mergeCommit": {"oid": "6648d4de73464ddb7364ec673ddccef5bd1e5fdc"}, "closed": true, "closedAt": "2020-09-12T02:51:52Z", "author": {"login": "dmitry-ten"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG8qikgBqjM3NDI0NjU0MDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH5WChAFqTQ4NzAxNDg5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ceea4396ebcdc044b55680b245e5d714fc338a03", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ceea4396ebcdc044b55680b245e5d714fc338a03", "committedDate": "2020-09-02T16:02:21Z", "message": "Maintain CH table per JITServer client\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "dbf5a7e085871c22bc5755a13031f4010501e2c8", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/dbf5a7e085871c22bc5755a13031f4010501e2c8", "committedDate": "2020-09-08T18:18:33Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dbf5a7e085871c22bc5755a13031f4010501e2c8", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/dbf5a7e085871c22bc5755a13031f4010501e2c8", "committedDate": "2020-09-08T18:18:33Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "8a39749c7c5da7fd6fe0bddc66b3663e3c41a51a", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8a39749c7c5da7fd6fe0bddc66b3663e3c41a51a", "committedDate": "2020-09-08T19:24:30Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a39749c7c5da7fd6fe0bddc66b3663e3c41a51a", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8a39749c7c5da7fd6fe0bddc66b3663e3c41a51a", "committedDate": "2020-09-08T19:24:30Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "adacc61cfc364a66a065097bf64915ab72976ea9", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/adacc61cfc364a66a065097bf64915ab72976ea9", "committedDate": "2020-09-08T19:26:53Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDMzOTk3", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#pullrequestreview-484433997", "createdAt": "2020-09-08T19:31:45Z", "commit": {"oid": "adacc61cfc364a66a065097bf64915ab72976ea9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxOTozMTo0NVrOHOrJoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxOTozMTo0NVrOHOrJoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0OTA4OQ==", "bodyText": "@mpirvu The includes in this file have some weird issues:\n\nIf I uncomment #if defined(J9VM_OPT_JITSERVER), then the code compiles but it compiles as if the environment variable is not set, i.e. none of the jitserver code in this file is compiled.\nIf I move PersistentInfo include to the top of the file, then compilation fails with \u2018getRemoteCompilationMode\u2019 was not declared in this scope message despite it being declared in J9PersistentInfo.hpp.\n\nI don't know what might be causing this as I think I modified make/cmake files correctly and everything else compiles without problems. This problem persists when I build a clean OpenJ9 sdk so it's not a stale build issue.", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485149089", "createdAt": "2020-09-08T19:31:45Z", "author": {"login": "dmitry-ten"}, "path": "runtime/compiler/env/J9PersistentInfo.cpp", "diffHunk": "@@ -0,0 +1,51 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+// #if defined(J9VM_OPT_JITSERVER)\n+#include \"control/CompilationThread.hpp\"\n+#include \"runtime/JITClientSession.hpp\"\n+// #endif\n+#include \"env/PersistentInfo.hpp\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adacc61cfc364a66a065097bf64915ab72976ea9"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adacc61cfc364a66a065097bf64915ab72976ea9", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/adacc61cfc364a66a065097bf64915ab72976ea9", "committedDate": "2020-09-08T19:26:53Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "ca99164138432936c756a3500e5606f84c740849", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ca99164138432936c756a3500e5606f84c740849", "committedDate": "2020-09-08T19:54:49Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0OTk1ODIy", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#pullrequestreview-484995822", "createdAt": "2020-09-09T13:15:54Z", "commit": {"oid": "ca99164138432936c756a3500e5606f84c740849"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMzoxNTo1NVrOHPGymw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMzoxNTo1NVrOHPGymw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYwMTk0Nw==", "bodyText": "Shouldn't this be J9PersistentInfo.hpp ?", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485601947", "createdAt": "2020-09-09T13:15:55Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/J9PersistentInfo.cpp", "diffHunk": "@@ -0,0 +1,51 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+// #if defined(J9VM_OPT_JITSERVER)\n+#include \"control/CompilationThread.hpp\"\n+#include \"runtime/JITClientSession.hpp\"\n+// #endif\n+#include \"env/PersistentInfo.hpp\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca99164138432936c756a3500e5606f84c740849"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca99164138432936c756a3500e5606f84c740849", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ca99164138432936c756a3500e5606f84c740849", "committedDate": "2020-09-08T19:54:49Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "f80102380e90b91caca55ee5707b24b709d6ac77", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f80102380e90b91caca55ee5707b24b709d6ac77", "committedDate": "2020-09-09T18:47:27Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f80102380e90b91caca55ee5707b24b709d6ac77", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f80102380e90b91caca55ee5707b24b709d6ac77", "committedDate": "2020-09-09T18:47:27Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/67ae9a357a82884837c892371b444b4639fd24c5", "committedDate": "2020-09-09T18:58:08Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDg5MzUz", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#pullrequestreview-485489353", "createdAt": "2020-09-10T00:33:58Z", "commit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMDozMzo1OFrOHPew9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMTozMToyN1rOHPfsjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5NDc0Mw==", "bodyText": "We typically arrange these filenames alphabetically, so we should put this new file after\nenv/J9ObjectModel.cpp", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485994743", "createdAt": "2020-09-10T00:33:58Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/CMakeLists.txt", "diffHunk": "@@ -57,6 +57,7 @@ j9jit_files(\n \tenv/Startup.cpp\n \tenv/SystemSegmentProvider.cpp\n \tenv/VMJ9.cpp\n+\tenv/J9PersistentInfo.cpp", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5OTU0NQ==", "bodyText": "I don't see where this monitor is used.", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485999545", "createdAt": "2020-09-10T00:51:48Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/JITServerPersistentCHTable.hpp", "diffHunk": "@@ -79,7 +82,8 @@ class JITServerPersistentCHTable : public TR_PersistentCHTable\n    void commitRemoves(const std::string &data);\n    void commitModifications(const std::string &data);\n \n-   PersistentUnorderedMap<TR_OpaqueClassBlock*, TR_PersistentClassInfo*> &getData();\n+   PersistentUnorderedMap<TR_OpaqueClassBlock*, TR_PersistentClassInfo*> _classMap;\n+   TR::Monitor *_classMapMonitor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5OTc4OQ==", "bodyText": "Maybe we should give a different name to this function because there is another classMapMonitor in the client session and it can be confusing", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485999789", "createdAt": "2020-09-10T00:52:47Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/JITServerPersistentCHTable.hpp", "diffHunk": "@@ -56,15 +56,18 @@ class JITServerPersistentCHTable : public TR_PersistentCHTable\n    TR_ALLOC(TR_Memory::PersistentCHTable)\n \n    JITServerPersistentCHTable(TR_PersistentMemory *);\n+   ~JITServerPersistentCHTable();\n \n-   bool isInitialized() { return !getData().empty(); } // needs CHTable mutex in hand\n+   bool isInitialized() { return !_classMap.empty(); } // needs CHTable monitor in hand\n    bool initializeCHTable(TR_J9VMBase *fej9, const std::string &rawData);\n    void doUpdate(TR_J9VMBase *fej9, const std::string &removeStr, const std::string &modifyStr);\n \n    virtual TR_PersistentClassInfo * findClassInfo(TR_OpaqueClassBlock * classId) override;\n    virtual TR_PersistentClassInfo * findClassInfoAfterLocking(TR_OpaqueClassBlock * classId, TR::Compilation *, bool returnClassInfoForAOT = false) override;\n    virtual TR_PersistentClassInfo * findClassInfoAfterLocking(TR_OpaqueClassBlock * classId, TR_FrontEnd *, bool returnClassInfoForAOT = false) override;\n \n+   TR::Monitor *getClassMapMonitor() { return _classMapMonitor; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNjQwMg==", "bodyText": "clearCaches() must clear the CHTable as well.", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486006402", "createdAt": "2020-09-10T01:18:00Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -501,14 +507,6 @@ ClientSessionData::clearCaches()\n \n    _classChainDataMap.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwODg5Mg==", "bodyText": "We need the acquire the new monitor that was created for the CHTable per client", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486008892", "createdAt": "2020-09-10T01:27:15Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -1914,6 +1914,25 @@ TR_J9ServerVM::getObjectSizeClass(uintptr_t objectSize)\n    return 0;\n    }\n \n+bool\n+TR_J9ServerVM::acquireClassTableMutex()\n+   {\n+   // Acquire per-client class table lock\n+   TR::Monitor *classTableMonitor = _compInfoPT->getClientData()->getClassMapMonitor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwOTA0NA==", "bodyText": "We need the release the new monitor that was created for the CHTable per client", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486009044", "createdAt": "2020-09-10T01:27:52Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -1914,6 +1914,25 @@ TR_J9ServerVM::getObjectSizeClass(uintptr_t objectSize)\n    return 0;\n    }\n \n+bool\n+TR_J9ServerVM::acquireClassTableMutex()\n+   {\n+   // Acquire per-client class table lock\n+   TR::Monitor *classTableMonitor = _compInfoPT->getClientData()->getClassMapMonitor();\n+   TR_ASSERT_FATAL(classTableMonitor, \"CH table and its monitor must be initialized\");\n+   classTableMonitor->enter();\n+   return true;\n+   }\n+\n+void\n+TR_J9ServerVM::releaseClassTableMutex(bool releaseVMAccess)\n+   {\n+   // Release per-cient class table lock\n+   TR::Monitor *classTableMonitor = _compInfoPT->getClientData()->getClassMapMonitor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwOTk5OQ==", "bodyText": "We can forward declare class JITServerPersistentCHTable and avoid this include.\nWe may need an include in the cpp file though", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486009999", "createdAt": "2020-09-10T01:31:27Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/runtime/JITClientSession.hpp", "diffHunk": "@@ -27,6 +27,7 @@\n #include \"env/PersistentCollections.hpp\" // for PersistentUnorderedMap\n #include \"il/DataTypes.hpp\" // for DataType\n #include \"env/VMJ9.h\" // for TR_StaticFinalData\n+#include \"env/JITServerPersistentCHTable.hpp\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/67ae9a357a82884837c892371b444b4639fd24c5", "committedDate": "2020-09-09T18:58:08Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "ad825933876c82422a2572312d525031060588b1", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ad825933876c82422a2572312d525031060588b1", "committedDate": "2020-09-10T15:39:27Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzkxODE2", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#pullrequestreview-486391816", "createdAt": "2020-09-11T00:12:38Z", "commit": {"oid": "ad825933876c82422a2572312d525031060588b1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMDoxMjozOFrOHQJ2WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMDoxNjoyOFrOHQJ7CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwMDYzMw==", "bodyText": "I wonder I should we do if the monitor cannot be initialized. Maybe throw bad_alloc as if we couldn't allocate the memory.", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486700633", "createdAt": "2020-09-11T00:12:38Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/JITServerPersistentCHTable.cpp", "diffHunk": "@@ -31,14 +31,23 @@\n \n \n JITServerPersistentCHTable::JITServerPersistentCHTable(TR_PersistentMemory *trMemory)\n-   : TR_PersistentCHTable(trMemory)\n+   : TR_PersistentCHTable(trMemory),\n+   _classMap(decltype(_classMap)::allocator_type(TR::Compiler->persistentAllocator()))\n    {\n+   _chTableMonitor = TR::Monitor::create(\"JIT-JITServerCHTableMonitor\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad825933876c82422a2572312d525031060588b1"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwMTgzMw==", "bodyText": "In case some message gets lost we have to clear all caches and start all over because that message may have carried important class unload and CHTable modification that needs to be applied. The client session data is not destroyed, just the caches are cleared, including the CHTable.", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486701833", "createdAt": "2020-09-11T00:16:28Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -501,14 +507,6 @@ ClientSessionData::clearCaches()\n \n    _classChainDataMap.clear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNjQwMg=="}, "originalCommit": {"oid": "67ae9a357a82884837c892371b444b4639fd24c5"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad825933876c82422a2572312d525031060588b1", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ad825933876c82422a2572312d525031060588b1", "committedDate": "2020-09-10T15:39:27Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "5e350ebbff75c434e90b18e0c505a1e2eb875371", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5e350ebbff75c434e90b18e0c505a1e2eb875371", "committedDate": "2020-09-11T15:47:52Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e350ebbff75c434e90b18e0c505a1e2eb875371", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5e350ebbff75c434e90b18e0c505a1e2eb875371", "committedDate": "2020-09-11T15:47:52Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "2e2f6bde20fb30eedb27ddc2c22dbc3cadd7e287", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2e2f6bde20fb30eedb27ddc2c22dbc3cadd7e287", "committedDate": "2020-09-11T16:21:21Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2OTk3MzQw", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#pullrequestreview-486997340", "createdAt": "2020-09-11T17:36:42Z", "commit": {"oid": "2e2f6bde20fb30eedb27ddc2c22dbc3cadd7e287"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNzozNjo0MlrOHQnz3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNzozNjo0MlrOHQnz3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MTUxNg==", "bodyText": "We need to set the _chTable to NULL after freeing it. The session may continue to live even after caches are cleared.", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r487191516", "createdAt": "2020-09-11T17:36:42Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -501,17 +502,16 @@ ClientSessionData::clearCaches()\n \n    _classChainDataMap.clear();\n \n-   // Free CHTable \n-   for (auto& it : _chTableClassMap)\n-      {\n-      TR_PersistentClassInfo *classInfo = it.second;\n-      classInfo->removeSubClasses();\n-      jitPersistentFree(classInfo);\n-      }\n-   _chTableClassMap.clear();\n    _registeredJ2IThunksMap.clear();\n    _registeredInvokeExactJ2IThunksSet.clear();\n    _bClassUnloadingAttempt = false;\n+\n+   if (_chTable)\n+      {\n+      // Free CH table\n+      _chTable->~JITServerPersistentCHTable();\n+      jitPersistentFree(_chTable);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e2f6bde20fb30eedb27ddc2c22dbc3cadd7e287"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c231a5c687903b033139d436bea37f85748fce61", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c231a5c687903b033139d436bea37f85748fce61", "committedDate": "2020-09-11T17:53:33Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e2f6bde20fb30eedb27ddc2c22dbc3cadd7e287", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2e2f6bde20fb30eedb27ddc2c22dbc3cadd7e287", "committedDate": "2020-09-11T16:21:21Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}, "afterCommit": {"oid": "c231a5c687903b033139d436bea37f85748fce61", "author": {"user": {"login": "dmitry-ten", "name": "Dmitry Ten"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c231a5c687903b033139d436bea37f85748fce61", "committedDate": "2020-09-11T17:53:33Z", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDE0ODkw", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#pullrequestreview-487014890", "createdAt": "2020-09-11T18:03:22Z", "commit": {"oid": "c231a5c687903b033139d436bea37f85748fce61"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4932, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}