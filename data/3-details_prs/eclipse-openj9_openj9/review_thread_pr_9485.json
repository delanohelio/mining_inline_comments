{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NzgxMzYy", "number": 9485, "reviewThreads": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNjo1ODo0OVrOD6VmzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDo1Mjo0MVrOD-Yy2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNDk3OTk3OnYy", "diffSide": "RIGHT", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNjo1ODo0OVrOGSHvgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODoxMTozMVrOGSKZWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NDQwMw==", "bodyText": "Please add extra parentheses here and in similar tests on lines 391 amd 405.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r421654403", "createdAt": "2020-05-07T16:58:49Z", "author": {"login": "keithc-ca"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -369,7 +369,7 @@ private static boolean isSamePackage(Class<?> a, Class<?> b){\n \t\t}\n \t\t\n \t\tvoid checkAccess(MethodHandle handle, boolean skipAccessCheckPara) throws IllegalAccessException {\n-\t\t\tif (INTERNAL_PRIVILEGED == accessMode) {\n+\t\t\tif (INTERNAL_PRIVILEGED == accessMode || FULL_ACCESS_MASK == accessMode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171e3665ca4ef2c5da77cafbd7293d9718f22744"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY5Nzg4MA==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r421697880", "createdAt": "2020-05-07T18:11:31Z", "author": {"login": "hangshao0"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -369,7 +369,7 @@ private static boolean isSamePackage(Class<?> a, Class<?> b){\n \t\t}\n \t\t\n \t\tvoid checkAccess(MethodHandle handle, boolean skipAccessCheckPara) throws IllegalAccessException {\n-\t\t\tif (INTERNAL_PRIVILEGED == accessMode) {\n+\t\t\tif (INTERNAL_PRIVILEGED == accessMode || FULL_ACCESS_MASK == accessMode) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NDQwMw=="}, "originalCommit": {"oid": "171e3665ca4ef2c5da77cafbd7293d9718f22744"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNDk4MjM0OnYy", "diffSide": "RIGHT", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNjo1OToyNVrOGSHxAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODoxMTo0MlrOGSKZww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NDc4NQ==", "bodyText": "Please remove the unnecessary initialization.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r421654785", "createdAt": "2020-05-07T16:59:25Z", "author": {"login": "keithc-ca"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2256,17 +2256,38 @@ public boolean hasFullPrivilegeAccess() {\n \t\t}\n \n \t\tstatic class ClassDefiner {\n-\t\t\tClass<?> defineClass(boolean option) {\n-\t\t\t\treturn null;\n+\t\t\tprivate byte[] classBytes;\n+\t\t\tprivate String className;\n+\t\t\tprivate Lookup lookup;\n+\t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n+\t\t\t\tclassName = name;\n+\t\t\t\tclassBytes = template;\n+\t\t\t\tlookup = lookupObj;\n+\t\t\t}\n+\t\t\tClass<?> defineClass(boolean initOption) {\n+\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, 0, null);\n \t\t\t}\n \t\t}\n \n \t\tpublic Lookup defineHiddenClass(byte[] bytes, boolean initOption, ClassOption... classOptions) {\n-\t\t\treturn null;\n+\t\t\tClassReader cr = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171e3665ca4ef2c5da77cafbd7293d9718f22744"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY5Nzk4Nw==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r421697987", "createdAt": "2020-05-07T18:11:42Z", "author": {"login": "hangshao0"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2256,17 +2256,38 @@ public boolean hasFullPrivilegeAccess() {\n \t\t}\n \n \t\tstatic class ClassDefiner {\n-\t\t\tClass<?> defineClass(boolean option) {\n-\t\t\t\treturn null;\n+\t\t\tprivate byte[] classBytes;\n+\t\t\tprivate String className;\n+\t\t\tprivate Lookup lookup;\n+\t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n+\t\t\t\tclassName = name;\n+\t\t\t\tclassBytes = template;\n+\t\t\t\tlookup = lookupObj;\n+\t\t\t}\n+\t\t\tClass<?> defineClass(boolean initOption) {\n+\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, 0, null);\n \t\t\t}\n \t\t}\n \n \t\tpublic Lookup defineHiddenClass(byte[] bytes, boolean initOption, ClassOption... classOptions) {\n-\t\t\treturn null;\n+\t\t\tClassReader cr = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NDc4NQ=="}, "originalCommit": {"oid": "171e3665ca4ef2c5da77cafbd7293d9718f22744"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNDk5NzIwOnYy", "diffSide": "RIGHT", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzowMzoyOFrOGSH61Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODoxMTo0OVrOGSKZ_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NzMwMQ==", "bodyText": "The class and all its fields should be final.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r421657301", "createdAt": "2020-05-07T17:03:28Z", "author": {"login": "keithc-ca"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2256,17 +2256,38 @@ public boolean hasFullPrivilegeAccess() {\n \t\t}\n \n \t\tstatic class ClassDefiner {\n-\t\t\tClass<?> defineClass(boolean option) {\n-\t\t\t\treturn null;\n+\t\t\tprivate byte[] classBytes;\n+\t\t\tprivate String className;\n+\t\t\tprivate Lookup lookup;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "171e3665ca4ef2c5da77cafbd7293d9718f22744"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY5ODA0NA==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r421698044", "createdAt": "2020-05-07T18:11:49Z", "author": {"login": "hangshao0"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2256,17 +2256,38 @@ public boolean hasFullPrivilegeAccess() {\n \t\t}\n \n \t\tstatic class ClassDefiner {\n-\t\t\tClass<?> defineClass(boolean option) {\n-\t\t\t\treturn null;\n+\t\t\tprivate byte[] classBytes;\n+\t\t\tprivate String className;\n+\t\t\tprivate Lookup lookup;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY1NzMwMQ=="}, "originalCommit": {"oid": "171e3665ca4ef2c5da77cafbd7293d9718f22744"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNTI5NjQ4OnYy", "diffSide": "RIGHT", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODoyNToyMVrOGSK4rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODozNTowMFrOGSLO-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcwNTkwMw==", "bodyText": "This should be defined in jcl/src/java.base/share/classes/com/ibm/oti/util/ExternalMessages-MasterIndex.properties.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r421705903", "createdAt": "2020-05-07T18:25:21Z", "author": {"login": "pshipton"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2255,18 +2261,39 @@ public boolean hasFullPrivilegeAccess() {\n \t\t\tSTRONG\n \t\t}\n \n-\t\tstatic class ClassDefiner {\n-\t\t\tClass<?> defineClass(boolean option) {\n-\t\t\t\treturn null;\n+\t\tstatic final class ClassDefiner {\n+\t\t\tprivate final byte[] classBytes;\n+\t\t\tprivate final String className;\n+\t\t\tprivate final Lookup lookup;\n+\t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n+\t\t\t\tclassName = name;\n+\t\t\t\tclassBytes = template;\n+\t\t\t\tlookup = lookupObj;\n+\t\t\t}\n+\t\t\tClass<?> defineClass(boolean initOption) {\n+\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, 0, null);\n \t\t\t}\n \t\t}\n \n \t\tpublic Lookup defineHiddenClass(byte[] bytes, boolean initOption, ClassOption... classOptions) {\n-\t\t\treturn null;\n+\t\t\tClassReader cr;\n+\t\t\ttry {\n+\t\t\t\tcr = new ClassReader(bytes);\n+\t\t\t} catch (ArrayIndexOutOfBoundsException e) {\n+\t\t\t\t/*[MSG \"K065Y2\", \"The class byte array is corrupted\"]*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d819802c70261667a2876cbd9aaa3b0302e2ee3f"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcxMTYxMA==", "bodyText": "It is already there:\nhttps://github.com/eclipse/openj9/blob/master/jcl/src/java.base/share/classes/com/ibm/oti/util/ExternalMessages-MasterIndex.properties#L407", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r421711610", "createdAt": "2020-05-07T18:35:00Z", "author": {"login": "hangshao0"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2255,18 +2261,39 @@ public boolean hasFullPrivilegeAccess() {\n \t\t\tSTRONG\n \t\t}\n \n-\t\tstatic class ClassDefiner {\n-\t\t\tClass<?> defineClass(boolean option) {\n-\t\t\t\treturn null;\n+\t\tstatic final class ClassDefiner {\n+\t\t\tprivate final byte[] classBytes;\n+\t\t\tprivate final String className;\n+\t\t\tprivate final Lookup lookup;\n+\t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n+\t\t\t\tclassName = name;\n+\t\t\t\tclassBytes = template;\n+\t\t\t\tlookup = lookupObj;\n+\t\t\t}\n+\t\t\tClass<?> defineClass(boolean initOption) {\n+\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, 0, null);\n \t\t\t}\n \t\t}\n \n \t\tpublic Lookup defineHiddenClass(byte[] bytes, boolean initOption, ClassOption... classOptions) {\n-\t\t\treturn null;\n+\t\t\tClassReader cr;\n+\t\t\ttry {\n+\t\t\t\tcr = new ClassReader(bytes);\n+\t\t\t} catch (ArrayIndexOutOfBoundsException e) {\n+\t\t\t\t/*[MSG \"K065Y2\", \"The class byte array is corrupted\"]*/", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTcwNTkwMw=="}, "originalCommit": {"oid": "d819802c70261667a2876cbd9aaa3b0302e2ee3f"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzExOTczOnYy", "diffSide": "RIGHT", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNToyOTo0N1rOGT2lvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMjoxNzoxNlrOGUa7Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3MDUyNQ==", "bodyText": "@hangshao0 pls wrap this in an AccessController.doPrivileged() to fix some of the test failures.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r423470525", "createdAt": "2020-05-12T05:29:47Z", "author": {"login": "pshipton"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2255,18 +2261,39 @@ public boolean hasFullPrivilegeAccess() {\n \t\t\tSTRONG\n \t\t}\n \n-\t\tstatic class ClassDefiner {\n-\t\t\tClass<?> defineClass(boolean option) {\n-\t\t\t\treturn null;\n+\t\tstatic final class ClassDefiner {\n+\t\t\tprivate final byte[] classBytes;\n+\t\t\tprivate final String className;\n+\t\t\tprivate final Lookup lookup;\n+\t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n+\t\t\t\tclassName = name;\n+\t\t\t\tclassBytes = template;\n+\t\t\t\tlookup = lookupObj;\n+\t\t\t}\n+\t\t\tClass<?> defineClass(boolean initOption) {\n+\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, 0, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d819802c70261667a2876cbd9aaa3b0302e2ee3f"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2NTg0Mg==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r424065842", "createdAt": "2020-05-12T22:17:16Z", "author": {"login": "hangshao0"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2255,18 +2261,39 @@ public boolean hasFullPrivilegeAccess() {\n \t\t\tSTRONG\n \t\t}\n \n-\t\tstatic class ClassDefiner {\n-\t\t\tClass<?> defineClass(boolean option) {\n-\t\t\t\treturn null;\n+\t\tstatic final class ClassDefiner {\n+\t\t\tprivate final byte[] classBytes;\n+\t\t\tprivate final String className;\n+\t\t\tprivate final Lookup lookup;\n+\t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n+\t\t\t\tclassName = name;\n+\t\t\t\tclassBytes = template;\n+\t\t\t\tlookup = lookupObj;\n+\t\t\t}\n+\t\t\tClass<?> defineClass(boolean initOption) {\n+\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, 0, null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3MDUyNQ=="}, "originalCommit": {"oid": "d819802c70261667a2876cbd9aaa3b0302e2ee3f"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODU5MjU4OnYy", "diffSide": "RIGHT", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMjo1MzozOVrOGUFGRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMjoyNTowMlrOGUbGog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcwODIzMA==", "bodyText": "Seems adding this is causing a number of test suite failures, even in jdk11.\nhttps://ci.eclipse.org/openj9/job/Test_openjdk11_j9_sanity.functional_s390x_linux_Personal/413", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r423708230", "createdAt": "2020-05-12T12:53:39Z", "author": {"login": "pshipton"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -369,7 +369,9 @@ private static boolean isSamePackage(Class<?> a, Class<?> b){\n \t\t}\n \t\t\n \t\tvoid checkAccess(MethodHandle handle, boolean skipAccessCheckPara) throws IllegalAccessException {\n-\t\t\tif (INTERNAL_PRIVILEGED == accessMode) {\n+\t\t\tif ((INTERNAL_PRIVILEGED == accessMode)\n+\t\t\t\t|| (FULL_ACCESS_MASK == accessMode)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d819802c70261667a2876cbd9aaa3b0302e2ee3f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg2NDI3MA==", "bodyText": "I added this line because OpenJ9 is throwing IllegalAccessException with message \"K0587\". The new Java 15 code from InnerClassLambdaMetafactory is passing in accessMode FULL_ACCESS_MASK. It is calling from findConstructor().", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r423864270", "createdAt": "2020-05-12T16:19:51Z", "author": {"login": "hangshao0"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -369,7 +369,9 @@ private static boolean isSamePackage(Class<?> a, Class<?> b){\n \t\t}\n \t\t\n \t\tvoid checkAccess(MethodHandle handle, boolean skipAccessCheckPara) throws IllegalAccessException {\n-\t\t\tif (INTERNAL_PRIVILEGED == accessMode) {\n+\t\t\tif ((INTERNAL_PRIVILEGED == accessMode)\n+\t\t\t\t|| (FULL_ACCESS_MASK == accessMode)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcwODIzMA=="}, "originalCommit": {"oid": "d819802c70261667a2876cbd9aaa3b0302e2ee3f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1MjQ5OA==", "bodyText": "OK, I seem to know what is going on. definingClass should be made nestmate of accessClass which is missing here.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r423952498", "createdAt": "2020-05-12T18:40:33Z", "author": {"login": "hangshao0"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -369,7 +369,9 @@ private static boolean isSamePackage(Class<?> a, Class<?> b){\n \t\t}\n \t\t\n \t\tvoid checkAccess(MethodHandle handle, boolean skipAccessCheckPara) throws IllegalAccessException {\n-\t\t\tif (INTERNAL_PRIVILEGED == accessMode) {\n+\t\t\tif ((INTERNAL_PRIVILEGED == accessMode)\n+\t\t\t\t|| (FULL_ACCESS_MASK == accessMode)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcwODIzMA=="}, "originalCommit": {"oid": "d819802c70261667a2876cbd9aaa3b0302e2ee3f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2ODc3MA==", "bodyText": "I have removed the checks for FULL_ACCESS_MASK.\nI don't find an existing APIs (Java or native) that could let me make a class to be nestmate of another class. So I have changed the native implementation of getNestHost() to return the nesthost of the loopup class for hidden classes (which is defined by Unsafe.defineAnonyousClass()).\nI am able to build Java 15 with the current change.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r424068770", "createdAt": "2020-05-12T22:25:02Z", "author": {"login": "hangshao0"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -369,7 +369,9 @@ private static boolean isSamePackage(Class<?> a, Class<?> b){\n \t\t}\n \t\t\n \t\tvoid checkAccess(MethodHandle handle, boolean skipAccessCheckPara) throws IllegalAccessException {\n-\t\t\tif (INTERNAL_PRIVILEGED == accessMode) {\n+\t\t\tif ((INTERNAL_PRIVILEGED == accessMode)\n+\t\t\t\t|| (FULL_ACCESS_MASK == accessMode)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcwODIzMA=="}, "originalCommit": {"oid": "d819802c70261667a2876cbd9aaa3b0302e2ee3f"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0Mzg2OTk1OnYy", "diffSide": "RIGHT", "path": "runtime/jcl/common/java_lang_Class.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjoxNTozNFrOGU5TEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODoyMTowNlrOGU-CBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2MzQ3NA==", "bodyText": "This local could be pushed before, and reused in, the declaration of vmFuncs.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r424563474", "createdAt": "2020-05-13T16:15:34Z", "author": {"login": "keithc-ca"}, "path": "runtime/jcl/common/java_lang_Class.cpp", "diffHunk": "@@ -1805,13 +1805,26 @@ Java_java_lang_Class_getNestHostImpl(JNIEnv *env, jobject recv)\n \tJ9Class *nestHost = clazz->nestHost;\n \n \tif (NULL == nestHost) {\n-\t\tif (J9_VISIBILITY_ALLOWED == vmFuncs->loadAndVerifyNestHost(currentThread, clazz, J9_LOOK_NO_THROW)) {\n-\t\t\tnestHost = clazz->nestHost;\n+\t\tJ9Class *clazzToUse = clazz;\n+\t\tJ9JavaVM *vm = currentThread->javaVM;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dab142323c228b28f3ff65915c6af38a1962cb9c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MTAzMQ==", "bodyText": "Changed the code to use #if JAVA_SPEC_VERSION >= 15. There is no need to have this local variable vm anymore.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r424641031", "createdAt": "2020-05-13T18:21:06Z", "author": {"login": "hangshao0"}, "path": "runtime/jcl/common/java_lang_Class.cpp", "diffHunk": "@@ -1805,13 +1805,26 @@ Java_java_lang_Class_getNestHostImpl(JNIEnv *env, jobject recv)\n \tJ9Class *nestHost = clazz->nestHost;\n \n \tif (NULL == nestHost) {\n-\t\tif (J9_VISIBILITY_ALLOWED == vmFuncs->loadAndVerifyNestHost(currentThread, clazz, J9_LOOK_NO_THROW)) {\n-\t\t\tnestHost = clazz->nestHost;\n+\t\tJ9Class *clazzToUse = clazz;\n+\t\tJ9JavaVM *vm = currentThread->javaVM;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2MzQ3NA=="}, "originalCommit": {"oid": "dab142323c228b28f3ff65915c6af38a1962cb9c"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0Mzg5MzUzOnYy", "diffSide": "RIGHT", "path": "runtime/jcl/common/java_lang_Class.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNjoyMTozNFrOGU5iZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODoxOTozMFrOGU9-FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2NzM5Ng==", "bodyText": "Why not #if JAVA_SPEC_VERSION >= 15 instead of runtime check?", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r424567396", "createdAt": "2020-05-13T16:21:34Z", "author": {"login": "keithc-ca"}, "path": "runtime/jcl/common/java_lang_Class.cpp", "diffHunk": "@@ -1805,13 +1805,26 @@ Java_java_lang_Class_getNestHostImpl(JNIEnv *env, jobject recv)\n \tJ9Class *nestHost = clazz->nestHost;\n \n \tif (NULL == nestHost) {\n-\t\tif (J9_VISIBILITY_ALLOWED == vmFuncs->loadAndVerifyNestHost(currentThread, clazz, J9_LOOK_NO_THROW)) {\n-\t\t\tnestHost = clazz->nestHost;\n+\t\tJ9Class *clazzToUse = clazz;\n+\t\tJ9JavaVM *vm = currentThread->javaVM;\n+\t\tif (J2SE_VERSION(vm) >= J2SE_V15) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dab142323c228b28f3ff65915c6af38a1962cb9c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MDAyMA==", "bodyText": "I've changed the code to use #if JAVA_SPEC_VERSION >= 15", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r424640020", "createdAt": "2020-05-13T18:19:30Z", "author": {"login": "hangshao0"}, "path": "runtime/jcl/common/java_lang_Class.cpp", "diffHunk": "@@ -1805,13 +1805,26 @@ Java_java_lang_Class_getNestHostImpl(JNIEnv *env, jobject recv)\n \tJ9Class *nestHost = clazz->nestHost;\n \n \tif (NULL == nestHost) {\n-\t\tif (J9_VISIBILITY_ALLOWED == vmFuncs->loadAndVerifyNestHost(currentThread, clazz, J9_LOOK_NO_THROW)) {\n-\t\t\tnestHost = clazz->nestHost;\n+\t\tJ9Class *clazzToUse = clazz;\n+\t\tJ9JavaVM *vm = currentThread->javaVM;\n+\t\tif (J2SE_VERSION(vm) >= J2SE_V15) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU2NzM5Ng=="}, "originalCommit": {"oid": "dab142323c228b28f3ff65915c6af38a1962cb9c"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0Nzc3NTMxOnYy", "diffSide": "RIGHT", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDo0NTowNlrOGVfwhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMDoyMzo0NlrOGVs3jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5MzYwNw==", "bodyText": "This needs javadoc", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425193607", "createdAt": "2020-05-14T14:45:06Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2245,7 +2246,57 @@ public boolean hasFullPrivilegeAccess() {\n \t\t\treturn (!isWeakenedLookup() && (MODULE == (accessMode & MODULE)));\n \t\t}\n \t\t/*[ENDIF] Java14*/\n-\t\t/*[ENDIF]*/\n+\t\t/*[ENDIF] Sidecar19-SE */\n+\t\t\n+\t\t/*[IF Java15]*/\n+\t\t// TODO: implement support for hidden classes.\n+\n+\t\tpublic enum ClassOption {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwODM5Nw==", "bodyText": "Javadoc added.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425408397", "createdAt": "2020-05-14T20:23:46Z", "author": {"login": "hangshao0"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2245,7 +2246,57 @@ public boolean hasFullPrivilegeAccess() {\n \t\t\treturn (!isWeakenedLookup() && (MODULE == (accessMode & MODULE)));\n \t\t}\n \t\t/*[ENDIF] Java14*/\n-\t\t/*[ENDIF]*/\n+\t\t/*[ENDIF] Sidecar19-SE */\n+\t\t\n+\t\t/*[IF Java15]*/\n+\t\t// TODO: implement support for hidden classes.\n+\n+\t\tpublic enum ClassOption {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5MzYwNw=="}, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0Nzc3NjAzOnYy", "diffSide": "RIGHT", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDo0NToxNVrOGVfw8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMDoyNDo0NlrOGVs5hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5MzcxMw==", "bodyText": "this needs javadoc", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425193713", "createdAt": "2020-05-14T14:45:15Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2245,7 +2246,57 @@ public boolean hasFullPrivilegeAccess() {\n \t\t\treturn (!isWeakenedLookup() && (MODULE == (accessMode & MODULE)));\n \t\t}\n \t\t/*[ENDIF] Java14*/\n-\t\t/*[ENDIF]*/\n+\t\t/*[ENDIF] Sidecar19-SE */\n+\t\t\n+\t\t/*[IF Java15]*/\n+\t\t// TODO: implement support for hidden classes.\n+\n+\t\tpublic enum ClassOption {\n+\t\t\tNESTMATE,\n+\t\t\tSTRONG\n+\t\t}\n+\n+\t\tstatic final class ClassDefiner {\n+\t\t\tprivate final byte[] classBytes;\n+\t\t\tprivate final String className;\n+\t\t\tprivate final Lookup lookup;\n+\t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n+\t\t\t\tclassName = name;\n+\t\t\t\tclassBytes = template;\n+\t\t\t\tlookup = lookupObj;\n+\t\t\t}\n+\t\t\tClass<?> defineClass(boolean initOption) {\n+\t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n+\t\t\t\t\t@Override\n+\t\t\t\t\tpublic Class<?> run() {\n+\t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, 0, null);\n+\t\t\t\t\t}\n+\t\t\t\t});\n+\t\t\t\treturn ret;\n+\t\t\t}\n+\t\t}\n+\n+\t\tpublic Lookup defineHiddenClass(byte[] bytes, boolean initOption, ClassOption... classOptions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5NTI3MQ==", "bodyText": "And I assume classOptions will be used later in the complete implementation?", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425195271", "createdAt": "2020-05-14T14:47:16Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2245,7 +2246,57 @@ public boolean hasFullPrivilegeAccess() {\n \t\t\treturn (!isWeakenedLookup() && (MODULE == (accessMode & MODULE)));\n \t\t}\n \t\t/*[ENDIF] Java14*/\n-\t\t/*[ENDIF]*/\n+\t\t/*[ENDIF] Sidecar19-SE */\n+\t\t\n+\t\t/*[IF Java15]*/\n+\t\t// TODO: implement support for hidden classes.\n+\n+\t\tpublic enum ClassOption {\n+\t\t\tNESTMATE,\n+\t\t\tSTRONG\n+\t\t}\n+\n+\t\tstatic final class ClassDefiner {\n+\t\t\tprivate final byte[] classBytes;\n+\t\t\tprivate final String className;\n+\t\t\tprivate final Lookup lookup;\n+\t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n+\t\t\t\tclassName = name;\n+\t\t\t\tclassBytes = template;\n+\t\t\t\tlookup = lookupObj;\n+\t\t\t}\n+\t\t\tClass<?> defineClass(boolean initOption) {\n+\t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n+\t\t\t\t\t@Override\n+\t\t\t\t\tpublic Class<?> run() {\n+\t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, 0, null);\n+\t\t\t\t\t}\n+\t\t\t\t});\n+\t\t\t\treturn ret;\n+\t\t\t}\n+\t\t}\n+\n+\t\tpublic Lookup defineHiddenClass(byte[] bytes, boolean initOption, ClassOption... classOptions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5MzcxMw=="}, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwODkwMg==", "bodyText": "Javadoc added.\n\nclassOptions will be used later in the complete implementation?\n\nYes.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425408902", "createdAt": "2020-05-14T20:24:46Z", "author": {"login": "hangshao0"}, "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2245,7 +2246,57 @@ public boolean hasFullPrivilegeAccess() {\n \t\t\treturn (!isWeakenedLookup() && (MODULE == (accessMode & MODULE)));\n \t\t}\n \t\t/*[ENDIF] Java14*/\n-\t\t/*[ENDIF]*/\n+\t\t/*[ENDIF] Sidecar19-SE */\n+\t\t\n+\t\t/*[IF Java15]*/\n+\t\t// TODO: implement support for hidden classes.\n+\n+\t\tpublic enum ClassOption {\n+\t\t\tNESTMATE,\n+\t\t\tSTRONG\n+\t\t}\n+\n+\t\tstatic final class ClassDefiner {\n+\t\t\tprivate final byte[] classBytes;\n+\t\t\tprivate final String className;\n+\t\t\tprivate final Lookup lookup;\n+\t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n+\t\t\t\tclassName = name;\n+\t\t\t\tclassBytes = template;\n+\t\t\t\tlookup = lookupObj;\n+\t\t\t}\n+\t\t\tClass<?> defineClass(boolean initOption) {\n+\t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n+\t\t\t\t\t@Override\n+\t\t\t\t\tpublic Class<?> run() {\n+\t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, 0, null);\n+\t\t\t\t\t}\n+\t\t\t\t});\n+\t\t\t\treturn ret;\n+\t\t\t}\n+\t\t}\n+\n+\t\tpublic Lookup defineHiddenClass(byte[] bytes, boolean initOption, ClassOption... classOptions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5MzcxMw=="}, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODAyMDg4OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNTozNzoxN1rOGViMKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMDoyNTo1NFrOGVs79w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIzMzQ1MQ==", "bodyText": "isCopy is an output parameter.  This code needs to handle the case where the string isn't a copy", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425233451", "createdAt": "2020-05-14T15:37:17Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +730,80 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char* * packages = (const char* *)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\tgoto cleanup;\n+\t}\n+\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tmemset((void *)packages, 0, packagesNumBytes);\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tjobject packageObj = (*env)->GetObjectArrayElement(env, packageArray, pkgIndex);\n+\t\t\tif ((*env)->ExceptionCheck(env)) {\n+\t\t\t\tAssert_SC_unreachable();\n+\t\t\t\tgoto cleanup;\n+\t\t\t}\n+\t\t\tif (NULL != packageObj) {\n+\t\t\t\tjboolean isCopy = JNI_FALSE;\n+\t\t\t\tconst char* packageName = (*env)->GetStringUTFChars(env, packageObj, &isCopy);\n+\t\t\t\t(*env)->DeleteLocalRef(env, packageObj);\n+\n+\t\t\t\tif (NULL == packageName) {\n+\t\t\t\t\toom = TRUE;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t\tif (JNI_FALSE == isCopy) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwOTUyNw==", "bodyText": "Updated to use copyStringToUTF8Helper(). isCopy is removed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425409527", "createdAt": "2020-05-14T20:25:54Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +730,80 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char* * packages = (const char* *)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\tgoto cleanup;\n+\t}\n+\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tmemset((void *)packages, 0, packagesNumBytes);\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tjobject packageObj = (*env)->GetObjectArrayElement(env, packageArray, pkgIndex);\n+\t\t\tif ((*env)->ExceptionCheck(env)) {\n+\t\t\t\tAssert_SC_unreachable();\n+\t\t\t\tgoto cleanup;\n+\t\t\t}\n+\t\t\tif (NULL != packageObj) {\n+\t\t\t\tjboolean isCopy = JNI_FALSE;\n+\t\t\t\tconst char* packageName = (*env)->GetStringUTFChars(env, packageObj, &isCopy);\n+\t\t\t\t(*env)->DeleteLocalRef(env, packageObj);\n+\n+\t\t\t\tif (NULL == packageName) {\n+\t\t\t\t\toom = TRUE;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t\tif (JNI_FALSE == isCopy) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIzMzQ1MQ=="}, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODA4MjEyOnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNTo1MDo0N1rOGVizTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMDoyNjoxM1rOGVs8pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0MzQ2OQ==", "bodyText": "It would be more efficient to get vm access earlier and do this with VM calls rather than JNI.  It would also remove the need to assert on the isCopy above by using the copyStringToUTF8Helper helper", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425243469", "createdAt": "2020-05-14T15:50:47Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +730,80 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char* * packages = (const char* *)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\tgoto cleanup;\n+\t}\n+\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tmemset((void *)packages, 0, packagesNumBytes);\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tjobject packageObj = (*env)->GetObjectArrayElement(env, packageArray, pkgIndex);\n+\t\t\tif ((*env)->ExceptionCheck(env)) {\n+\t\t\t\tAssert_SC_unreachable();\n+\t\t\t\tgoto cleanup;\n+\t\t\t}\n+\t\t\tif (NULL != packageObj) {\n+\t\t\t\tjboolean isCopy = JNI_FALSE;\n+\t\t\t\tconst char* packageName = (*env)->GetStringUTFChars(env, packageObj, &isCopy);\n+\t\t\t\t(*env)->DeleteLocalRef(env, packageObj);\n+\n+\t\t\t\tif (NULL == packageName) {\n+\t\t\t\t\toom = TRUE;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t\tif (JNI_FALSE == isCopy) {\n+\t\t\t\t\tAssert_SC_unreachable();\n+\t\t\t\t\tgoto cleanup;\n+\t\t\t\t}\n+\t\t\t\tconvertPackageName((char*)packageName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwOTcwMQ==", "bodyText": "Updated to use copyStringToUTF8Helper().", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425409701", "createdAt": "2020-05-14T20:26:13Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +730,80 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char* * packages = (const char* *)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\tgoto cleanup;\n+\t}\n+\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tmemset((void *)packages, 0, packagesNumBytes);\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tjobject packageObj = (*env)->GetObjectArrayElement(env, packageArray, pkgIndex);\n+\t\t\tif ((*env)->ExceptionCheck(env)) {\n+\t\t\t\tAssert_SC_unreachable();\n+\t\t\t\tgoto cleanup;\n+\t\t\t}\n+\t\t\tif (NULL != packageObj) {\n+\t\t\t\tjboolean isCopy = JNI_FALSE;\n+\t\t\t\tconst char* packageName = (*env)->GetStringUTFChars(env, packageObj, &isCopy);\n+\t\t\t\t(*env)->DeleteLocalRef(env, packageObj);\n+\n+\t\t\t\tif (NULL == packageName) {\n+\t\t\t\t\toom = TRUE;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t\tif (JNI_FALSE == isCopy) {\n+\t\t\t\t\tAssert_SC_unreachable();\n+\t\t\t\t\tgoto cleanup;\n+\t\t\t\t}\n+\t\t\t\tconvertPackageName((char*)packageName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0MzQ2OQ=="}, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODA4NDg2OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNTo1MToyM1rOGVi1AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMDoyNjo0NVrOGVs9qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0MzkwNQ==", "bodyText": "same here - keep vm access and use the vm helpers rather than JNI", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425243905", "createdAt": "2020-05-14T15:51:23Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -851,6 +933,29 @@ JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version,\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n \tvmFuncs->internalExitVMToJNI(currentThread);\n \n+#if JAVA_SPEC_VERSION >= 15\n+cleanup:\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tjobject packageObj = NULL;\n+\t\t\tconst char* packageName = packages[pkgIndex];\n+\t\t\tif (NULL == packageName) {\n+\t\t\t\tbreak;\n+\t\t\t}\n+\n+\t\t\tpackageObj = (*env)->GetObjectArrayElement(env, packageArray, pkgIndex);\n+\t\t\tif ((*env)->ExceptionCheck(env)) {\n+\t\t\t\tAssert_SC_unreachable();\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\t(*env)->ReleaseStringUTFChars(env, packageObj, packageName);\n+\t\t\t(*env)->DeleteLocalRef(env, packageObj);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwOTk2MA==", "bodyText": "Updated to use copyStringToUTF8Helper().", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425409960", "createdAt": "2020-05-14T20:26:45Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -851,6 +933,29 @@ JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version,\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n \tvmFuncs->internalExitVMToJNI(currentThread);\n \n+#if JAVA_SPEC_VERSION >= 15\n+cleanup:\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tjobject packageObj = NULL;\n+\t\t\tconst char* packageName = packages[pkgIndex];\n+\t\t\tif (NULL == packageName) {\n+\t\t\t\tbreak;\n+\t\t\t}\n+\n+\t\t\tpackageObj = (*env)->GetObjectArrayElement(env, packageArray, pkgIndex);\n+\t\t\tif ((*env)->ExceptionCheck(env)) {\n+\t\t\t\tAssert_SC_unreachable();\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\t(*env)->ReleaseStringUTFChars(env, packageObj, packageName);\n+\t\t\t(*env)->DeleteLocalRef(env, packageObj);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0MzkwNQ=="}, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 136}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODA4NzcxOnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNTo1MjowMlrOGVi23A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMDoyNjo1N1rOGVs-AA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0NDM4MA==", "bodyText": "This should also move after getting vm access and use the copyStringToUTF8Helper helper.  Note, there's an J9_STR_XLAT flag that does the . -> / conversion", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425244380", "createdAt": "2020-05-14T15:52:02Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -866,19 +971,46 @@ JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version,\n  * 4) Package is not defined for fromModule's class loader\n  * 5) Package is not in module fromModule.\n  */\n+#if JAVA_SPEC_VERSION >= 15\n+void JNICALL\n+JVM_AddModuleExports(JNIEnv * env, jobject fromModule, jstring packageObj, jobject toModule)\n+#else\n void JNICALL\n JVM_AddModuleExports(JNIEnv * env, jobject fromModule, const char *package, jobject toModule)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM const * const vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tjboolean isCopy = JNI_FALSE;\n+\tconst char* package = (NULL == packageObj) ? NULL : (*env)->GetStringUTFChars(env, packageObj, &isCopy);\n+\tif ((NULL != package) && (JNI_FALSE == isCopy)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQxMDA0OA==", "bodyText": "Updated to use copyStringToUTF8Helper().", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425410048", "createdAt": "2020-05-14T20:26:57Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -866,19 +971,46 @@ JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version,\n  * 4) Package is not defined for fromModule's class loader\n  * 5) Package is not in module fromModule.\n  */\n+#if JAVA_SPEC_VERSION >= 15\n+void JNICALL\n+JVM_AddModuleExports(JNIEnv * env, jobject fromModule, jstring packageObj, jobject toModule)\n+#else\n void JNICALL\n JVM_AddModuleExports(JNIEnv * env, jobject fromModule, const char *package, jobject toModule)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM const * const vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tjboolean isCopy = JNI_FALSE;\n+\tconst char* package = (NULL == packageObj) ? NULL : (*env)->GetStringUTFChars(env, packageObj, &isCopy);\n+\tif ((NULL != package) && (JNI_FALSE == isCopy)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0NDM4MA=="}, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 163}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODA5NTA1OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNTo1MzozOFrOGVi7ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMDoyNzowM1rOGVs-Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0NTU2Mw==", "bodyText": "same here as well", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425245563", "createdAt": "2020-05-14T15:53:38Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -913,19 +1056,46 @@ JVM_AddModuleExports(JNIEnv * env, jobject fromModule, const char *package, jobj\n  * 3) Package is not defined for fromModule's class loader\n  * 4) Package is not in module fromModule.\n  */\n+#if JAVA_SPEC_VERSION >= 15\n+void JNICALL\n+JVM_AddModuleExportsToAll(JNIEnv * env, jobject fromModule, jstring packageObj)\n+#else\n void JNICALL\n JVM_AddModuleExportsToAll(JNIEnv * env, jobject fromModule, const char *package)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM const * const vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tjboolean isCopy = JNI_FALSE;\n+\tconst char* package = (NULL == packageObj) ? NULL : (*env)->GetStringUTFChars(env, packageObj, &isCopy);\n+\tif ((NULL != package) && (JNI_FALSE == isCopy)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 234}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQxMDA5OQ==", "bodyText": "Updated to use copyStringToUTF8Helper().", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425410099", "createdAt": "2020-05-14T20:27:03Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -913,19 +1056,46 @@ JVM_AddModuleExports(JNIEnv * env, jobject fromModule, const char *package, jobj\n  * 3) Package is not defined for fromModule's class loader\n  * 4) Package is not in module fromModule.\n  */\n+#if JAVA_SPEC_VERSION >= 15\n+void JNICALL\n+JVM_AddModuleExportsToAll(JNIEnv * env, jobject fromModule, jstring packageObj)\n+#else\n void JNICALL\n JVM_AddModuleExportsToAll(JNIEnv * env, jobject fromModule, const char *package)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM const * const vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tjboolean isCopy = JNI_FALSE;\n+\tconst char* package = (NULL == packageObj) ? NULL : (*env)->GetStringUTFChars(env, packageObj, &isCopy);\n+\tif ((NULL != package) && (JNI_FALSE == isCopy)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0NTU2Mw=="}, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 234}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODA5NjM2OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNTo1Mzo1NVrOGVi8RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMDoyNzowOFrOGVs-YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0NTc2NA==", "bodyText": "and here", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425245764", "createdAt": "2020-05-14T15:53:55Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -1142,19 +1323,46 @@ JVM_AddModulePackage(JNIEnv * env, jobject module, const char *package)\n  * 2) module is unnamed or\n  * 3) package is not in module\n  */\n+#if JAVA_SPEC_VERSION >= 15\n+void JNICALL\n+JVM_AddModuleExportsToAllUnnamed(JNIEnv * env, jobject fromModule, jstring packageObj)\n+#else\n void JNICALL\n JVM_AddModuleExportsToAllUnnamed(JNIEnv * env, jobject fromModule, const char *package)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM const * const vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tjboolean isCopy = JNI_FALSE;\n+\tconst char* package = (NULL == packageObj) ? NULL : (*env)->GetStringUTFChars(env, packageObj, &isCopy);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 304}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQxMDE0NQ==", "bodyText": "Updated to use copyStringToUTF8Helper().", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425410145", "createdAt": "2020-05-14T20:27:08Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -1142,19 +1323,46 @@ JVM_AddModulePackage(JNIEnv * env, jobject module, const char *package)\n  * 2) module is unnamed or\n  * 3) package is not in module\n  */\n+#if JAVA_SPEC_VERSION >= 15\n+void JNICALL\n+JVM_AddModuleExportsToAllUnnamed(JNIEnv * env, jobject fromModule, jstring packageObj)\n+#else\n void JNICALL\n JVM_AddModuleExportsToAllUnnamed(JNIEnv * env, jobject fromModule, const char *package)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM const * const vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tjboolean isCopy = JNI_FALSE;\n+\tconst char* package = (NULL == packageObj) ? NULL : (*env)->GetStringUTFChars(env, packageObj, &isCopy);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI0NTc2NA=="}, "originalCommit": {"oid": "9d734583e83f1df12e0c082b1200ecc0aae06877"}, "originalPosition": 304}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTMxMjA0OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTozNjowMlrOGVvGcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMjozNzowOFrOGVwkBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0NDk3Nw==", "bodyText": "See #9292 (comment): using JNI after calling internalEnterVMFromJNI() is not legal.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425444977", "createdAt": "2020-05-14T21:36:02Z", "author": {"login": "keithc-ca"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,79 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\n+#if JAVA_SPEC_VERSION >= 15\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\tgoto done;\n+\t}\n+\tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tmemset((void *)packages, 0, packagesNumBytes);\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tjobject packageObj = (*env)->GetObjectArrayElement(env, packageArray, pkgIndex);\n+\t\t\tif ((*env)->ExceptionCheck(env)) {\n+\t\t\t\t(*env)->DeleteLocalRef(env, packageObj);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3fe7d852f049455738ba053681d498f5d411d92"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ2ODkzMg==", "bodyText": "Removed these JNI calls.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r425468932", "createdAt": "2020-05-14T22:37:08Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,79 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\n+#if JAVA_SPEC_VERSION >= 15\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\tgoto done;\n+\t}\n+\tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tmemset((void *)packages, 0, packagesNumBytes);\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tjobject packageObj = (*env)->GetObjectArrayElement(env, packageArray, pkgIndex);\n+\t\t\tif ((*env)->ExceptionCheck(env)) {\n+\t\t\t\t(*env)->DeleteLocalRef(env, packageObj);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0NDk3Nw=="}, "originalCommit": {"oid": "e3fe7d852f049455738ba053681d498f5d411d92"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTQ4Nzc4OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjo1MjozM1rOGYKChw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTozNzo1MlrOGYR4XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4MzQ5NQ==", "bodyText": "Define the variables here and give them safe default values.  Leave the real values until we have vm access below\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #if JAVA_SPEC_VERSION >= 15\n          \n          \n            \n            \tBOOLEAN oom = FALSE;\n          \n          \n            \n            \tBOOLEAN nullPackage = FALSE;\n          \n          \n            \n            \tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n          \n          \n            \n            \tPORT_ACCESS_FROM_ENV(env);\n          \n          \n            \n            \tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n          \n          \n            \n            \tconst char** packages = NULL;\n          \n          \n            \n            \tif ((*env)->ExceptionCheck(env)) {\n          \n          \n            \n            \t\treturn module;\n          \n          \n            \n            \t}\n          \n          \n            \n            #endif /* JAVA_SPEC_VERSION >= 15 */\n          \n          \n            \n            #if JAVA_SPEC_VERSION >= 15\n          \n          \n            \n            \tBOOLEAN oom = FALSE;\n          \n          \n            \n            \tBOOLEAN nullPackage = FALSE;\n          \n          \n            \n            \tjsize numPackages = 0;\n          \n          \n            \n            \tUDATA packagesNumBytes = 0;\n          \n          \n            \n            \tconst char** packages = NULL;\n          \n          \n            \n            \tPORT_ACCESS_FROM_ENV(env);\n          \n          \n            \n            #endif /* JAVA_SPEC_VERSION >= 15 */", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r427983495", "createdAt": "2020-05-20T12:52:33Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\treturn module;\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExMTk2NQ==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r428111965", "createdAt": "2020-05-20T15:37:52Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\treturn module;\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4MzQ5NQ=="}, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTQ5NTc0OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjo1NDoyMFrOGYKHRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo0Mjo0NVrOGYSGeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NDcxMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #if JAVA_SPEC_VERSION >= 15\n          \n          \n            \n            \tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n          \n          \n            \n            #if JAVA_SPEC_VERSION >= 15\n          \n          \n            \n            \tif (NULL != packageArray) {\n          \n          \n            \n            \t\tnumPackages = J9INDEXABLEOBJECT_SIZE(currentThread, J9_JNI_UNWRAP_REFERENCE (packageArray));\n          \n          \n            \n            \t\tpackagesNumBytes = sizeof(char*) * numPackages;\n          \n          \n            \n            \t}\n          \n          \n            \n            \tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r427984711", "createdAt": "2020-05-20T12:54:20Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\treturn module;\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\n+#if JAVA_SPEC_VERSION >= 15\n+\tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NTAxNg==", "bodyText": "This saves getting and dropping vm access multiple times - array length and exception check", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r427985016", "createdAt": "2020-05-20T12:54:45Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\treturn module;\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\n+#if JAVA_SPEC_VERSION >= 15\n+\tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NDcxMQ=="}, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExNTU3Ng==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r428115576", "createdAt": "2020-05-20T15:42:45Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\treturn module;\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\n+#if JAVA_SPEC_VERSION >= 15\n+\tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NDcxMQ=="}, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTUxNTQ4OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjo1ODoyNlrOGYKTAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTozODo0N1rOGYR7Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NzcxNA==", "bodyText": "There's a future optimization here to avoid the allocation and use a stack allocated array for a small number of packages.  Probably worth opening a separate issue for that.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r427987714", "createdAt": "2020-05-20T12:58:26Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExMjY1NQ==", "bodyText": "Yes, I will open a separate issue once this piece of code is merged.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r428112655", "createdAt": "2020-05-20T15:38:47Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NzcxNA=="}, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTUyOTE5OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzowMToyMlrOGYKbRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTozOToyNVrOGYR8ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4OTgzMA==", "bodyText": "Can this check be moved earlier?  It seems like we do a != NULL check earlier that can be commoned with this", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r427989830", "createdAt": "2020-05-20T13:01:22Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\treturn module;\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\n+#if JAVA_SPEC_VERSION >= 15\n+\tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tmemset((void *)packages, 0, packagesNumBytes);\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tj9array_t array = (j9array_t)J9_JNI_UNWRAP_REFERENCE(packageArray);\n+\t\t\tj9object_t stringObject = J9JAVAARRAYOFOBJECT_LOAD(currentThread, array, pkgIndex);\n+\t\t\tif (NULL != stringObject) {\n+\t\t\t\tUDATA utfLength = vmFuncs->getStringUTF8Length(currentThread, stringObject) + 1;\n+\t\t\t\tchar *packageName = (char*)j9mem_allocate_memory(utfLength, OMRMEM_CATEGORY_VM);\n+\t\t\t\tif (NULL == packageName) {\n+\t\t\t\t\toom = TRUE;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t\tvmFuncs->copyStringToUTF8Helper(currentThread, stringObject, J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT , 0, J9VMJAVALANGSTRING_LENGTH(currentThread, stringObject), packageName, utfLength);\n+\t\t\t\tpackages[pkgIndex] = packageName;\n+\t\t\t} else {\n+\t\t\t\tnullPackage = TRUE;\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tif (NULL == packageArray) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExMzA4Mg==", "bodyText": "Yes, it can be moved earlier. Done.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r428113082", "createdAt": "2020-05-20T15:39:25Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\treturn module;\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\n+#if JAVA_SPEC_VERSION >= 15\n+\tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tmemset((void *)packages, 0, packagesNumBytes);\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tj9array_t array = (j9array_t)J9_JNI_UNWRAP_REFERENCE(packageArray);\n+\t\t\tj9object_t stringObject = J9JAVAARRAYOFOBJECT_LOAD(currentThread, array, pkgIndex);\n+\t\t\tif (NULL != stringObject) {\n+\t\t\t\tUDATA utfLength = vmFuncs->getStringUTF8Length(currentThread, stringObject) + 1;\n+\t\t\t\tchar *packageName = (char*)j9mem_allocate_memory(utfLength, OMRMEM_CATEGORY_VM);\n+\t\t\t\tif (NULL == packageName) {\n+\t\t\t\t\toom = TRUE;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t\tvmFuncs->copyStringToUTF8Helper(currentThread, stringObject, J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT , 0, J9VMJAVALANGSTRING_LENGTH(currentThread, stringObject), packageName, utfLength);\n+\t\t\t\tpackages[pkgIndex] = packageName;\n+\t\t\t} else {\n+\t\t\t\tnullPackage = TRUE;\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tif (NULL == packageArray) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4OTgzMA=="}, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTUzNzE0OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzowMzowNVrOGYKgAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo0MDoyOFrOGYR_8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk5MTA0MQ==", "bodyText": "Is the nullPackage variable needed?  Can the exception setting code be moved here and then the code could goto directly the cleanup label?\nIt means there's one less piece of state to keep straight", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r427991041", "createdAt": "2020-05-20T13:03:05Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\treturn module;\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\n+#if JAVA_SPEC_VERSION >= 15\n+\tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tmemset((void *)packages, 0, packagesNumBytes);\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tj9array_t array = (j9array_t)J9_JNI_UNWRAP_REFERENCE(packageArray);\n+\t\t\tj9object_t stringObject = J9JAVAARRAYOFOBJECT_LOAD(currentThread, array, pkgIndex);\n+\t\t\tif (NULL != stringObject) {\n+\t\t\t\tUDATA utfLength = vmFuncs->getStringUTF8Length(currentThread, stringObject) + 1;\n+\t\t\t\tchar *packageName = (char*)j9mem_allocate_memory(utfLength, OMRMEM_CATEGORY_VM);\n+\t\t\t\tif (NULL == packageName) {\n+\t\t\t\t\toom = TRUE;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t\tvmFuncs->copyStringToUTF8Helper(currentThread, stringObject, J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT , 0, J9VMJAVALANGSTRING_LENGTH(currentThread, stringObject), packageName, utfLength);\n+\t\t\t\tpackages[pkgIndex] = packageName;\n+\t\t\t} else {\n+\t\t\t\tnullPackage = TRUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExMzkwNw==", "bodyText": "Removed variable nullPackage and moved the exception setting here.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r428113907", "createdAt": "2020-05-20T15:40:28Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -710,18 +711,72 @@ allowReadAccessToModule(J9VMThread * currentThread, J9Module * fromModule, J9Mod\n  * @return If successful, returns a java.lang.reflect.Module object. Otherwise, returns NULL.\n  */\n jobject JNICALL\n+#if JAVA_SPEC_VERSION >= 15\n+JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, jobjectArray packageArray)\n+#else\n JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version, jstring location, const char* const* packages, jsize numPackages)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM * vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tBOOLEAN oom = FALSE;\n+\tBOOLEAN nullPackage = FALSE;\n+\tjsize numPackages = (NULL == packageArray) ? 0 : (*env)->GetArrayLength(env, packageArray);\n+\tPORT_ACCESS_FROM_ENV(env);\n+\tUDATA packagesNumBytes = sizeof(char*) * numPackages;\n+\tconst char** packages = NULL;\n+\tif ((*env)->ExceptionCheck(env)) {\n+\t\treturn module;\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\n+#if JAVA_SPEC_VERSION >= 15\n+\tpackages = (const char**)j9mem_allocate_memory(packagesNumBytes, OMRMEM_CATEGORY_VM);\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tmemset((void *)packages, 0, packagesNumBytes);\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tj9array_t array = (j9array_t)J9_JNI_UNWRAP_REFERENCE(packageArray);\n+\t\t\tj9object_t stringObject = J9JAVAARRAYOFOBJECT_LOAD(currentThread, array, pkgIndex);\n+\t\t\tif (NULL != stringObject) {\n+\t\t\t\tUDATA utfLength = vmFuncs->getStringUTF8Length(currentThread, stringObject) + 1;\n+\t\t\t\tchar *packageName = (char*)j9mem_allocate_memory(utfLength, OMRMEM_CATEGORY_VM);\n+\t\t\t\tif (NULL == packageName) {\n+\t\t\t\t\toom = TRUE;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t\tvmFuncs->copyStringToUTF8Helper(currentThread, stringObject, J9_STR_NULL_TERMINATE_RESULT | J9_STR_XLAT , 0, J9VMJAVALANGSTRING_LENGTH(currentThread, stringObject), packageName, utfLength);\n+\t\t\t\tpackages[pkgIndex] = packageName;\n+\t\t\t} else {\n+\t\t\t\tnullPackage = TRUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk5MTA0MQ=="}, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTU0MzIxOnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzowNDoyN1rOGYKjoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNTo0MDo1NlrOGYSBYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk5MTk2OA==", "bodyText": "similar potential optimization here by keeping a small stack allocated buffer to avoid the malloc", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r427991968", "createdAt": "2020-05-20T13:04:27Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -866,19 +932,46 @@ JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version,\n  * 4) Package is not defined for fromModule's class loader\n  * 5) Package is not in module fromModule.\n  */\n+#if JAVA_SPEC_VERSION >= 15\n+void JNICALL\n+JVM_AddModuleExports(JNIEnv * env, jobject fromModule, jstring packageObj, jobject toModule)\n+#else\n void JNICALL\n JVM_AddModuleExports(JNIEnv * env, jobject fromModule, const char *package, jobject toModule)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM const * const vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tconst char *package = NULL;\n+\tPORT_ACCESS_FROM_ENV(env);\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\t\n+#if JAVA_SPEC_VERSION >= 15\n+\tif (NULL != packageObj) {\n+\t\tj9object_t stringObject = J9_JNI_UNWRAP_REFERENCE(packageObj);\n+\t\tUDATA utfLength = vmFuncs->getStringUTF8Length(currentThread, stringObject) + 1;\n+\t\tchar* packageName = (char *)j9mem_allocate_memory(utfLength, OMRMEM_CATEGORY_VM);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExNDI3Mw==", "bodyText": "Will open a separate issue once this piece of code is merged.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r428114273", "createdAt": "2020-05-20T15:40:56Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -866,19 +932,46 @@ JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version,\n  * 4) Package is not defined for fromModule's class loader\n  * 5) Package is not in module fromModule.\n  */\n+#if JAVA_SPEC_VERSION >= 15\n+void JNICALL\n+JVM_AddModuleExports(JNIEnv * env, jobject fromModule, jstring packageObj, jobject toModule)\n+#else\n void JNICALL\n JVM_AddModuleExports(JNIEnv * env, jobject fromModule, const char *package, jobject toModule)\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n {\n \tJ9VMThread * const currentThread = (J9VMThread*)env;\n \tJ9JavaVM const * const vm = currentThread->javaVM;\n \tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+#if JAVA_SPEC_VERSION >= 15\n+\tconst char *package = NULL;\n+\tPORT_ACCESS_FROM_ENV(env);\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n \n \tvmFuncs->internalEnterVMFromJNI(currentThread);\n #if defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY)\n \tomrthread_monitor_enter(vm->classLoaderModuleAndLocationMutex);\n #else\n \tf_monitorEnter(vm->classLoaderModuleAndLocationMutex);\n #endif /* defined(CALL_BUNDLED_FUNCTIONS_DIRECTLY) */\n+\t\n+#if JAVA_SPEC_VERSION >= 15\n+\tif (NULL != packageObj) {\n+\t\tj9object_t stringObject = J9_JNI_UNWRAP_REFERENCE(packageObj);\n+\t\tUDATA utfLength = vmFuncs->getStringUTF8Length(currentThread, stringObject) + 1;\n+\t\tchar* packageName = (char *)j9mem_allocate_memory(utfLength, OMRMEM_CATEGORY_VM);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk5MTk2OA=="}, "originalCommit": {"oid": "ce8f59bf90dbe10c1ddde6ff4793219870280a69"}, "originalPosition": 130}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzQ0NTM2OnYy", "diffSide": "RIGHT", "path": "runtime/j9vm/java11vmi.c", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDo1Mjo0MVrOGYdZNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMToxNDowN1rOGYeBpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwMDU5OQ==", "bodyText": "The goto on line 745 should target cleanup to avoid leaking packages.\nThat would be the last use of done; perhaps cleanup should just become done.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r428300599", "createdAt": "2020-05-20T20:52:41Z", "author": {"login": "keithc-ca"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -843,6 +892,17 @@ JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version,\n \t\t\t}\n \t\t}\n \t}\n+#if JAVA_SPEC_VERSION >= 15\n+cleanup:\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tconst char* packageName = packages[pkgIndex];\n+\t\t\tj9mem_free_memory((void *)packageName);\n+\t\t}\n+\t\tj9mem_free_memory((void *)packages);\t\t\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n done:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27972950b3d8f6d7d3ed6cd4f7e1a95645966b7c"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxMDk0OA==", "bodyText": "Fixed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9485#discussion_r428310948", "createdAt": "2020-05-20T21:14:07Z", "author": {"login": "hangshao0"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -843,6 +892,17 @@ JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version,\n \t\t\t}\n \t\t}\n \t}\n+#if JAVA_SPEC_VERSION >= 15\n+cleanup:\n+\tif (NULL != packages) {\n+\t\tjsize pkgIndex = 0;\n+\t\tfor (pkgIndex = 0; pkgIndex < numPackages; pkgIndex++) {\n+\t\t\tconst char* packageName = packages[pkgIndex];\n+\t\t\tj9mem_free_memory((void *)packageName);\n+\t\t}\n+\t\tj9mem_free_memory((void *)packages);\t\t\n+\t}\n+#endif /* JAVA_SPEC_VERSION >= 15 */\n done:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwMDU5OQ=="}, "originalCommit": {"oid": "27972950b3d8f6d7d3ed6cd4f7e1a95645966b7c"}, "originalPosition": 90}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 134, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}