{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2ODc0ODgy", "number": 11448, "title": "Replace deprecated gethostbyname() with getaddrinfo() to avoid crash", "bodyText": "gethostbyname() used in openConnection() (which is used in JITServer code) is\nknown to be non MT safe. We have observed rare crashes in the client JVM,\nwhich are likely due to usage of gethostbyname() as explained in #11415\nThis commit replaces the usage of gethostbyname() with gettaddrinfo() which is\nreentrant and therefore more amenable to multithreaded code.\nFixes: #11415\nSigned-off-by: Marius Pirvu mpirvu@ca.ibm.com", "createdAt": "2020-12-11T12:54:18Z", "url": "https://github.com/eclipse-openj9/openj9/pull/11448", "merged": true, "mergeCommit": {"oid": "a3acacadf5102537beaca23be20cc17539240e0d"}, "closed": true, "closedAt": "2020-12-14T14:12:43Z", "author": {"login": "mpirvu"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlJC8wAFqTU1MDE1NTkxNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlJ4TygFqTU1MDIxMTc0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMTU1OTE1", "url": "https://github.com/eclipse-openj9/openj9/pull/11448#pullrequestreview-550155915", "createdAt": "2020-12-11T14:41:06Z", "commit": {"oid": "44d335a86e0d51a854fce9e8bcc6b6a28fd84983"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNDo0MTowNlrOID7tAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNDo0MTowNlrOID7tAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk5NDgxOA==", "bodyText": "This check isn't done elsewhere and seems unnecessary and since getaddrinfo will return at least one element if it succeeded.", "url": "https://github.com/eclipse-openj9/openj9/pull/11448#discussion_r540994818", "createdAt": "2020-12-11T14:41:06Z", "author": {"login": "ymanton"}, "path": "runtime/compiler/net/ClientStream.cpp", "diffHunk": "@@ -130,60 +130,86 @@ SSL_CTX *ClientStream::_sslCtx = NULL;\n \n int openConnection(const std::string &address, uint32_t port, uint32_t timeoutMs)\n    {\n-   // TODO consider using newer API like getaddrinfo to support IPv6\n-   struct hostent *entSer = gethostbyname(address.c_str());\n-   if (!entSer)\n+   // TODO consider support for IPv6\n+   struct addrinfo hints;\n+   memset(&hints, 0, sizeof(hints));\n+   hints.ai_family = AF_INET;    // Allow IPv4 only; could use AF_UNSPEC to allow IPv6 too\n+   hints.ai_socktype = SOCK_STREAM;\n+   hints.ai_flags = 0;\n+   hints.ai_protocol = 0; // Any protocol\n+\n+   char portName[12];\n+   int r = snprintf(portName, 12, \"%d\", port);\n+   if (r < 0 || r > 11)\n+      throw StreamFailure(\"snprintf failed\");\n+\n+   struct addrinfo *addrList = NULL;\n+   int res = getaddrinfo(address.c_str(), portName, &hints, &addrList);\n+   if (res != 0)\n+      {\n+      // Can use gai_strerror(res) to show error code\n       throw StreamFailure(\"Cannot resolve server name\");\n-\n-   struct sockaddr_in servAddr;\n-   memset(&servAddr, 0, sizeof(servAddr));\n-   memcpy(&servAddr.sin_addr.s_addr, entSer->h_addr, entSer->h_length);\n-   servAddr.sin_family = AF_INET;\n-   servAddr.sin_port = htons(port);\n-\n-   int sockfd = socket(AF_INET, SOCK_STREAM, 0);\n+      }\n+   struct addrinfo *pAddr;\n+   int sockfd = -1;\n+   for (pAddr = addrList; pAddr; pAddr = pAddr->ai_next) \n+      {\n+      sockfd = socket(pAddr->ai_family, pAddr->ai_socktype, pAddr->ai_protocol);\n+      if (sockfd >= 0)\n+         break; // Use the first address for which a socket could be created\n+      // Try next address\n+      }\n    if (sockfd < 0)\n+      {\n+      if (addrList)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44d335a86e0d51a854fce9e8bcc6b6a28fd84983"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a71216f4a5a623c21139cf8e4b306c33e9f7eb8a", "author": {"user": {"login": "mpirvu", "name": "Marius Pirvu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/a71216f4a5a623c21139cf8e4b306c33e9f7eb8a", "committedDate": "2020-12-11T15:32:23Z", "message": "Replace deprecated gethostbyname() with getaddrinfo() to avoid spurious crash\n\ngethostbyname() used in openConnection() (which is used in JITServer code) is\nknown to be non MT safe. We have observed rare crashes in the client JVM,\nwhich are likely due to usage of gethostbyname() as explained in #11415\nThis commit replaces the usage of gethostbyname() with gettaddrinfo() which is\nreentrant and therefore more amenable to multithreaded code.\n\nFixes: #11415\n\nSigned-off-by: Marius Pirvu <mpirvu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44d335a86e0d51a854fce9e8bcc6b6a28fd84983", "author": {"user": {"login": "mpirvu", "name": "Marius Pirvu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/44d335a86e0d51a854fce9e8bcc6b6a28fd84983", "committedDate": "2020-12-11T12:52:30Z", "message": "Replace deprecated gethostbyname() with getaddrinfo() to avoid spurious crash\n\ngethostbyname() used in openConnection() (which is used in JITServer code) is\nknown to be non MT safe. We have observed rare crashes in the client JVM,\nwhich are likely due to usage of gethostbyname() as explained in #11415\nThis commit replaces the usage of gethostbyname() with gettaddrinfo() which is\nreentrant and therefore more amenable to multithreaded code.\n\nFixes: #11415\n\nSigned-off-by: Marius Pirvu <mpirvu@ca.ibm.com>"}, "afterCommit": {"oid": "a71216f4a5a623c21139cf8e4b306c33e9f7eb8a", "author": {"user": {"login": "mpirvu", "name": "Marius Pirvu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/a71216f4a5a623c21139cf8e4b306c33e9f7eb8a", "committedDate": "2020-12-11T15:32:23Z", "message": "Replace deprecated gethostbyname() with getaddrinfo() to avoid spurious crash\n\ngethostbyname() used in openConnection() (which is used in JITServer code) is\nknown to be non MT safe. We have observed rare crashes in the client JVM,\nwhich are likely due to usage of gethostbyname() as explained in #11415\nThis commit replaces the usage of gethostbyname() with gettaddrinfo() which is\nreentrant and therefore more amenable to multithreaded code.\n\nFixes: #11415\n\nSigned-off-by: Marius Pirvu <mpirvu@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMjExNzQ4", "url": "https://github.com/eclipse-openj9/openj9/pull/11448#pullrequestreview-550211748", "createdAt": "2020-12-11T15:43:05Z", "commit": {"oid": "a71216f4a5a623c21139cf8e4b306c33e9f7eb8a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1501, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}