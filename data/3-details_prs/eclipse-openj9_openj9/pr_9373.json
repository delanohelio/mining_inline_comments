{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NjA0NzY1", "number": 9373, "title": "Remove discontiguous arraylet NULL pointers", "bodyText": "Currently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\nI included checks in case of discontiguous arraylets to make sure we\u2019re dealing with discontiguous arraylets or fail otherwise. This might be overkill so wanted feedback on it. Now that we don\u2019t have the distinction between discontiguous arraylet + nullPtr and normal arraylet without nullPtr there are 2 possibilities for discontiguous arraylet:\n\nFully discontiguous arraylet where 0 == dataSize % arrayletLeafRegionSize\narrayletSpineSize + lastLeafSize > arrayletLeafRegionSize, meaning we need to allocate an entire region for this leaf since it cannot fit with the spine however 0 != dataSize % arrayletLeafSize.\n\nSo I tried to capture these cases with my checks but not sure if it\u2019s overkill or not.\nSigned-off-by: Igor Braga higorb1@gmail.com", "createdAt": "2020-04-27T16:20:05Z", "url": "https://github.com/eclipse-openj9/openj9/pull/9373", "merged": true, "mergeCommit": {"oid": "478035be657787830c8f5de14c8d6837be96463f"}, "closed": true, "closedAt": "2020-06-16T19:13:30Z", "author": {"login": "bragaigor"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbxz4LgBqjMyNzY1Nzg2MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrhWSNAFqTQzMDY4NjQyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0604d007d7d1dd90e0035986b2280463424ba25b", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/0604d007d7d1dd90e0035986b2280463424ba25b", "committedDate": "2020-04-27T15:01:49Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}, "afterCommit": {"oid": "e3029be14ee2766ce0948b3f3df9f8c247453dc9", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e3029be14ee2766ce0948b3f3df9f8c247453dc9", "committedDate": "2020-04-27T16:23:31Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3029be14ee2766ce0948b3f3df9f8c247453dc9", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e3029be14ee2766ce0948b3f3df9f8c247453dc9", "committedDate": "2020-04-27T16:23:31Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}, "afterCommit": {"oid": "ee8012e36ef1e43a3a618a566f96215ca7e524d9", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ee8012e36ef1e43a3a618a566f96215ca7e524d9", "committedDate": "2020-05-05T17:54:58Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3e279ac956e786e8e9673118a398194d8a37aa2", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b3e279ac956e786e8e9673118a398194d8a37aa2", "committedDate": "2020-05-06T20:46:39Z", "message": "Fix discontiguous arraylet check\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}, "afterCommit": {"oid": "ec6aa199639b82ae37ae678190afe87c5143973f", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ec6aa199639b82ae37ae678190afe87c5143973f", "committedDate": "2020-05-06T23:23:26Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ec6aa199639b82ae37ae678190afe87c5143973f", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ec6aa199639b82ae37ae678190afe87c5143973f", "committedDate": "2020-05-06T23:23:26Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}, "afterCommit": {"oid": "604f28c17fb90153daddf241c6a19001824e0d15", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/604f28c17fb90153daddf241c6a19001824e0d15", "committedDate": "2020-05-15T22:14:46Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "604f28c17fb90153daddf241c6a19001824e0d15", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/604f28c17fb90153daddf241c6a19001824e0d15", "committedDate": "2020-05-15T22:14:46Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}, "afterCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d30f15694d6c117eaa9562beeeb245ca8efca105", "committedDate": "2020-06-08T14:59:52Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzU5NTMx", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#pullrequestreview-429359531", "createdAt": "2020-06-11T23:26:46Z", "commit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzoyNjo0N1rOGix_9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzoyNjo0N1rOGix_9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyMzk1Ng==", "bodyText": "There is no adjustment any more. This line and comment above should go away. The formal parameter should be renamed unadjustedDataSizeInBytes->dataSizeInBytes .", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439123956", "createdAt": "2020-06-11T23:26:47Z", "author": {"login": "amicic"}, "path": "runtime/gc_glue_java/ArrayletObjectModelBase.hpp", "diffHunk": "@@ -252,7 +252,7 @@ class GC_ArrayletObjectModelBase\n \t\t\t * of the after-last element without crashing. Handle the case of UDATA_MAX specially, since we use that\n \t\t\t * for any object whose size overflows the address space.\n \t\t\t */\n-\t\t\tUDATA dataSizeInBytes = (UDATA_MAX == unadjustedDataSizeInBytes) ? UDATA_MAX : (unadjustedDataSizeInBytes + 1);\n+\t\t\tUDATA dataSizeInBytes = (UDATA_MAX == unadjustedDataSizeInBytes) ? UDATA_MAX : unadjustedDataSizeInBytes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzU5ODE2", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#pullrequestreview-429359816", "createdAt": "2020-06-11T23:27:35Z", "commit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzoyNzozNVrOGiyAwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzoyNzozNVrOGiyAwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNDE2Mg==", "bodyText": "_numberOfArraylets is unsigned, so this becomes redundant.", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439124162", "createdAt": "2020-06-11T23:27:35Z", "author": {"login": "amicic"}, "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "diffHunk": "@@ -72,10 +72,10 @@ MM_IndexableObjectAllocationModel::initializeAllocateDescription(MM_EnvironmentB\n \t\tbreak;\n \n \tcase GC_ArrayletObjectModel::Discontiguous:\n-\t\tAssert_MM_true(0 < _numberOfArraylets);\n+\t\tAssert_MM_true(0 <= _numberOfArraylets);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzgyMjQz", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#pullrequestreview-429382243", "createdAt": "2020-06-12T00:09:08Z", "commit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMDowOTowOFrOGiyvpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMDowOTowOFrOGiyvpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzNjE2NQ==", "bodyText": "I believe this was the only user of AssertNotEmptyArrayletLeaves(), so that it can be removed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439136165", "createdAt": "2020-06-12T00:09:08Z", "author": {"login": "amicic"}, "path": "runtime/gc_glue_java/ArrayletObjectModel.hpp", "diffHunk": "@@ -52,17 +52,9 @@ class GC_ArrayletObjectModel : public GC_ArrayletObjectModelBase\n */\n private:\n \tvoid AssertBadElementSize();\n+\tvoid AssertArrayletIsDiscontiguous(J9IndexableObject *objPtr);\n #if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n \tvoid AssertNotEmptyArrayletLeaves(UDATA sizeInElements, UDATA arrayletLeafCount);\n-\tMMINLINE bool\n-\tisOneArrayletLeafWithNULL(J9IndexableObject *spine, UDATA arrayletLeafCount, UDATA sizeInElements)\n-\t{\n-\t\tUDATA arrayletLeafSize = _omrVM->_arrayletLeafSize;\n-\t\tUDATA dataSize = getDataSizeInBytes(spine);\n-\t\tAssertNotEmptyArrayletLeaves(sizeInElements, arrayletLeafCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzgzMzA4", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#pullrequestreview-429383308", "createdAt": "2020-06-12T00:12:31Z", "commit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMDoxMjozMVrOGiy3IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMDoxMjozMVrOGiy3IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzODA4MQ==", "bodyText": "I'm on a fence, if we really need this assert. @dmitripivkine, opinion?\nBesides, for Metronome that does not move object, even stronger assert (without +objectAlignment) should hold, right?\nAnd finally, you have a clone of this in another file - no way to reuse?", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439138081", "createdAt": "2020-06-12T00:12:31Z", "author": {"login": "amicic"}, "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "diffHunk": "@@ -258,22 +259,23 @@ MM_IndexableObjectAllocationModel::layoutDiscontiguousArraylet(MM_EnvironmentBas\n \tif (NULL != spine) {\n \t\tswitch (_layout) {\n \t\tcase GC_ArrayletObjectModel::Discontiguous:\n-\t\t\t/* if last arraylet leaf is empty (contains 0 bytes) arrayoid pointer is set to NULL */\n-\t\t\tif (arrayoidIndex == (_numberOfArraylets - 1)) {\n-\t\t\t\tAssert_MM_true(0 == (_dataSize % arrayletLeafSize));\n-\t\t\t\tGC_SlotObject slotObject(env->getOmrVM(), GC_SlotObject::addToSlotAddress(arrayoidPtr, arrayoidIndex, compressed));\n-\t\t\t\tslotObject.writeReferenceToSlot(NULL);\n-\t\t\t} else {\n-\t\t\t\tAssert_MM_true(0 != (_dataSize % arrayletLeafSize));\n-\t\t\t\tAssert_MM_true(arrayoidIndex == _numberOfArraylets);\n+#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n+\t\t\tif (!indexableObjectModel->isDoubleMappingEnabled())\n+#endif /* J9VM_GC_ENABLE_DOUBLE_MAP */\n+\t\t\t{\n+\t\t\t\tUDATA remainderBytes = _dataSize % arrayletLeafSize;\n+\t\t\t\tif (0 != remainderBytes) {\n+\t\t\t\t\tAssert_MM_true((indexableObjectModel->getSpineSize(spine) + remainderBytes + env->getObjectAlignmentInBytes()) > arrayletLeafSize);\n+\t\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "originalPosition": 58}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d30f15694d6c117eaa9562beeeb245ca8efca105", "committedDate": "2020-06-08T14:59:52Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}, "afterCommit": {"oid": "b3243abc05ec63411dc2560903d76127f03aaa65", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b3243abc05ec63411dc2560903d76127f03aaa65", "committedDate": "2020-06-12T00:28:40Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3243abc05ec63411dc2560903d76127f03aaa65", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b3243abc05ec63411dc2560903d76127f03aaa65", "committedDate": "2020-06-12T00:28:40Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}, "afterCommit": {"oid": "d73b62e245373f9f7b7c99009b4cd458c1261998", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d73b62e245373f9f7b7c99009b4cd458c1261998", "committedDate": "2020-06-12T00:46:22Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDExNjQ0", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#pullrequestreview-429411644", "createdAt": "2020-06-12T01:52:00Z", "commit": {"oid": "d73b62e245373f9f7b7c99009b4cd458c1261998"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMTo1MjowMVrOGi0hdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMTo1MjowMVrOGi0hdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE2NTMwMA==", "bodyText": "Perhaps you should drag in these few lines inside the assert helper. They exist at both sites where the helper is invoked.", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439165300", "createdAt": "2020-06-12T01:52:01Z", "author": {"login": "amicic"}, "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "diffHunk": "@@ -258,22 +258,20 @@ MM_IndexableObjectAllocationModel::layoutDiscontiguousArraylet(MM_EnvironmentBas\n \tif (NULL != spine) {\n \t\tswitch (_layout) {\n \t\tcase GC_ArrayletObjectModel::Discontiguous:\n-\t\t\t/* if last arraylet leaf is empty (contains 0 bytes) arrayoid pointer is set to NULL */\n-\t\t\tif (arrayoidIndex == (_numberOfArraylets - 1)) {\n-\t\t\t\tAssert_MM_true(0 == (_dataSize % arrayletLeafSize));\n-\t\t\t\tGC_SlotObject slotObject(env->getOmrVM(), GC_SlotObject::addToSlotAddress(arrayoidPtr, arrayoidIndex, compressed));\n-\t\t\t\tslotObject.writeReferenceToSlot(NULL);\n-\t\t\t} else {\n-\t\t\t\tAssert_MM_true(0 != (_dataSize % arrayletLeafSize));\n-\t\t\t\tAssert_MM_true(arrayoidIndex == _numberOfArraylets);\n+#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n+\t\t\tif (!indexableObjectModel->isDoubleMappingEnabled())\n+#endif /* J9VM_GC_ENABLE_DOUBLE_MAP */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d73b62e245373f9f7b7c99009b4cd458c1261998"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40da754e3a29cceef3b9c113be060af7b426333c", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/40da754e3a29cceef3b9c113be060af7b426333c", "committedDate": "2020-06-12T02:04:40Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d73b62e245373f9f7b7c99009b4cd458c1261998", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d73b62e245373f9f7b7c99009b4cd458c1261998", "committedDate": "2020-06-12T00:46:22Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}, "afterCommit": {"oid": "40da754e3a29cceef3b9c113be060af7b426333c", "author": {"user": {"login": "bragaigor", "name": "Igor Braga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/40da754e3a29cceef3b9c113be060af7b426333c", "committedDate": "2020-06-12T02:04:40Z", "message": "Remove discontiguous arraylet NULL pointers\n\nCurrently every discontiguous arraylet contains an extra\narrayoid that points to NULL, which is not required\nanymore; therefore, every arraylet from now on will\ncontain the exact number of arrayoids/leaves it consumes\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMDExNTMx", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#pullrequestreview-430011531", "createdAt": "2020-06-12T20:13:34Z", "commit": {"oid": "40da754e3a29cceef3b9c113be060af7b426333c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNjg2MzAx", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#pullrequestreview-430686301", "createdAt": "2020-06-15T14:15:53Z", "commit": {"oid": "40da754e3a29cceef3b9c113be060af7b426333c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNDoxNTo1M1rOGj0JVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNDoxNTo1M1rOGj0JVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIwNzcwMA==", "bodyText": "Would you please add comment here to explain that with exception of Double Mapping request the only case when layout Discontiguous can be selected is Arraylet Hybrid representation does not fit a region? It would improve readability. My original confusion when I read this first time was \"Discontiguous\" in function name refer to Discontiguous Layout of Arraylet, not Discontiguous Array representation.", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r440207700", "createdAt": "2020-06-15T14:15:53Z", "author": {"login": "dmitripivkine"}, "path": "runtime/gc_glue_java/ArrayletObjectModel.cpp", "diffHunk": "@@ -43,13 +43,21 @@ GC_ArrayletObjectModel::AssertBadElementSize()\n \tAssert_MM_unreachable();\n }\n \n-#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n void\n-GC_ArrayletObjectModel::AssertNotEmptyArrayletLeaves(UDATA sizeInElements, UDATA arrayletLeafCount)\n+GC_ArrayletObjectModel::AssertArrayletIsDiscontiguous(J9IndexableObject *objPtr)\n {\n-\tAssert_MM_true((0 == sizeInElements) || (arrayletLeafCount > 0));\n-}\n+#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n+\tif (!isDoubleMappingEnabled())\n #endif /* J9VM_GC_ENABLE_DOUBLE_MAP */\n+\t{\n+\t\tMM_GCExtensionsBase* extensions = MM_GCExtensionsBase::getExtensions(_omrVM);\n+\t\tUDATA arrayletLeafSize = _omrVM->_arrayletLeafSize;\n+\t\tUDATA remainderBytes = getDataSizeInBytes(objPtr) % arrayletLeafSize;\n+\t\tif (0 != remainderBytes) {\n+\t\t\tAssert_MM_true((getSpineSize(objPtr) + remainderBytes + extensions->getObjectAlignmentInBytes()) > arrayletLeafSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da754e3a29cceef3b9c113be060af7b426333c"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNjg2NDI2", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#pullrequestreview-430686426", "createdAt": "2020-06-15T14:16:02Z", "commit": {"oid": "40da754e3a29cceef3b9c113be060af7b426333c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1092, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}