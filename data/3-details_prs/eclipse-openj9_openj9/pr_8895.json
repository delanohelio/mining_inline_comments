{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMTIwMDg3", "number": 8895, "title": "Change realTimeGC option as per compilation", "bodyText": "This change is to support the JITServer receiving the realTimeGC config setting from the client for per compilation.\nAlso implemented the server version of getCellSizeForSizeClass() and getObjectSizeClass() which were missing and are triggered when realTimeGC is true.\nRelated to eclipse/omr#4945\nFixes: #8707\nSigned-off-by: Annabelle Huo Annabelle.Huo@ibm.com", "createdAt": "2020-03-17T22:57:09Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8895", "merged": true, "mergeCommit": {"oid": "cbd77bf62caada6474888fafc60f79beb7498dce"}, "closed": true, "closedAt": "2020-03-23T13:07:55Z", "author": {"login": "a7ehuo"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO4TipgBqjMxNDE3NDQ1MTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPij4xgBqjMxNDk4ODI5NTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "504b674610b2c8f5ee2d9a26d8f42e4bd9c95a73", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/504b674610b2c8f5ee2d9a26d8f42e4bd9c95a73", "committedDate": "2020-03-17T22:54:36Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "2e34ef71fbaf7f88887393bb7d8765a3c0f5eb33", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2e34ef71fbaf7f88887393bb7d8765a3c0f5eb33", "committedDate": "2020-03-18T14:33:20Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2OTg1ODY5", "url": "https://github.com/eclipse-openj9/openj9/pull/8895#pullrequestreview-376985869", "createdAt": "2020-03-18T15:38:01Z", "commit": {"oid": "2e34ef71fbaf7f88887393bb7d8765a3c0f5eb33"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNTozODowMVrOF4K0Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNjo0ODoyOFrOF4N9tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ0MTc1NQ==", "bodyText": "let use cg->comp()", "url": "https://github.com/eclipse-openj9/openj9/pull/8895#discussion_r394441755", "createdAt": "2020-03-18T15:38:01Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/arm/codegen/J9ARMEvaluator.cpp", "diffHunk": "@@ -932,7 +932,8 @@ static void genHeapAlloc(TR::CodeGenerator  *cg,\n                          TR::LabelSymbol     *callLabel,\n                          int32_t            allocSize)\n    {\n-   if (TR::Options::getCmdLineOptions()->realTimeGC())\n+   TR::Compilation *comp = TR::comp();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e34ef71fbaf7f88887393bb7d8765a3c0f5eb33"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4NDcyNA==", "bodyText": "This is problematic. We are looking at the thread on the server. I think we need to send a message for this one, but definitely needs more thought. It is the default behavior though.", "url": "https://github.com/eclipse-openj9/openj9/pull/8895#discussion_r394484724", "createdAt": "2020-03-18T16:35:42Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9.cpp", "diffHunk": "@@ -4220,7 +4221,7 @@ TR_J9VMBase::initializeLocalObjectFlags(TR::Compilation * comp, TR::Node * alloc\n    int32_t initValue = TR::Compiler->cls.romClassOf(ramClass)->instanceShape;\n #endif\n \n-   if (!TR::Options::getCmdLineOptions()->realTimeGC())\n+   if (!comp->getOptions()->realTimeGC())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e34ef71fbaf7f88887393bb7d8765a3c0f5eb33"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4NzExNQ==", "bodyText": "You moved the return statement up. Is it possible that the code executed before this return needed to stay because it had important side effects?\ngetSnippetLabel()->setCodeLocation(buffer);", "url": "https://github.com/eclipse-openj9/openj9/pull/8895#discussion_r394487115", "createdAt": "2020-03-18T16:39:17Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/p/codegen/J9PPCSnippet.cpp", "diffHunk": "@@ -1311,13 +1311,13 @@ void TR::createCCPreLoadedCode(uint8_t *CCPreLoadedCodeBase, uint8_t *CCPreLoade\n uint8_t *TR::PPCAllocPrefetchSnippet::emitSnippetBody()\n    {\n    TR::Compilation *comp = cg()->comp();\n+   if (comp->getOptions()->realTimeGC())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e34ef71fbaf7f88887393bb7d8765a3c0f5eb33"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4NzY2OA==", "bodyText": "Same here: You moved the return statement up. Is it possible that the code executed before this return needed to stay because it had important side effects?", "url": "https://github.com/eclipse-openj9/openj9/pull/8895#discussion_r394487668", "createdAt": "2020-03-18T16:40:04Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/p/codegen/J9PPCSnippet.cpp", "diffHunk": "@@ -1364,13 +1364,13 @@ TR::PPCNonZeroAllocPrefetchSnippet::PPCNonZeroAllocPrefetchSnippet(\n uint8_t *TR::PPCNonZeroAllocPrefetchSnippet::emitSnippetBody()\n    {\n    TR::Compilation *comp = cg()->comp();\n+   if (comp->getOptions()->realTimeGC())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e34ef71fbaf7f88887393bb7d8765a3c0f5eb33"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ5MzM2Ng==", "bodyText": "Please delete this comment", "url": "https://github.com/eclipse-openj9/openj9/pull/8895#discussion_r394493366", "createdAt": "2020-03-18T16:48:28Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/z/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -1910,7 +1910,9 @@ VMCardCheckEvaluator(\n       TR::LabelSymbol *doneLabel = NULL,\n       bool doCompileTimeCheckForHeapObj = true)\n    {\n-   if (!TR::Options::getCmdLineOptions()->realTimeGC())\n+   // Make sure we really should be here", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e34ef71fbaf7f88887393bb7d8765a3c0f5eb33"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e34ef71fbaf7f88887393bb7d8765a3c0f5eb33", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2e34ef71fbaf7f88887393bb7d8765a3c0f5eb33", "committedDate": "2020-03-18T14:33:20Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "3afed2c27e5e3e9b41c9f1d30b89b04955d7d44e", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3afed2c27e5e3e9b41c9f1d30b89b04955d7d44e", "committedDate": "2020-03-18T19:44:14Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MTk0MzU3", "url": "https://github.com/eclipse-openj9/openj9/pull/8895#pullrequestreview-377194357", "createdAt": "2020-03-18T20:03:02Z", "commit": {"oid": "3afed2c27e5e3e9b41c9f1d30b89b04955d7d44e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMDowMzowMlrOF4U5Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMDowMzowMlrOF4U5Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYwNjg5NA==", "bodyText": "I think this will result in many messages being sent.\nThe original code reads some value from the compilation thread (which could be any) to be used at runtime by any other application thread. This makes me think that all the threads have the same value which does not change in time. We need to verify that, but if that is the case then we can fetch that specific value once during the VMinit message.", "url": "https://github.com/eclipse-openj9/openj9/pull/8895#discussion_r394606894", "createdAt": "2020-03-18T20:03:02Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -1805,6 +1805,40 @@ TR_J9ServerVM::getInvokeExactThunkHelperAddress(TR::Compilation *comp, TR::Symbo\n    return helper;\n    }\n \n+UDATA\n+TR_J9ServerVM::getCellSizeForSizeClass(uintptr_t sizeClass)\n+   {\n+#if defined(J9VM_GC_REALTIME)\n+   JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n+   stream->write(JITServer::MessageType::VM_getCellSizeForSizeClass, sizeClass);\n+   return std::get<0>(stream->read<UDATA>());\n+#endif\n+   return 0;\n+   }\n+\n+UDATA\n+TR_J9ServerVM::getObjectSizeClass(uintptr_t objectSize)\n+   {\n+#if defined(J9VM_GC_REALTIME)\n+   JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n+   stream->write(JITServer::MessageType::VM_getObjectSizeClass, objectSize);\n+   return std::get<0>(stream->read<UDATA>());\n+#endif\n+   return 0;\n+   }\n+\n+// Creates a node to initialize the local object flags field\n+//\n+TR::Node *\n+TR_J9ServerVM::initializeLocalObjectFlags(TR::Compilation * comp, TR::Node * allocationNode, TR_OpaqueClassBlock * ramClass)\n+   {\n+   JITServer::ServerStream *stream = _compInfoPT->getMethodBeingCompiled()->_stream;\n+   stream->write(JITServer::MessageType::VM_initializeLocalObjectFlags, ramClass);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3afed2c27e5e3e9b41c9f1d30b89b04955d7d44e"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3afed2c27e5e3e9b41c9f1d30b89b04955d7d44e", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3afed2c27e5e3e9b41c9f1d30b89b04955d7d44e", "committedDate": "2020-03-18T19:44:14Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "c85b205a6908273555931acca083387dfb37e2c3", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c85b205a6908273555931acca083387dfb37e2c3", "committedDate": "2020-03-19T19:03:06Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()`\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MDM2NTEw", "url": "https://github.com/eclipse-openj9/openj9/pull/8895#pullrequestreview-378036510", "createdAt": "2020-03-19T19:39:28Z", "commit": {"oid": "c85b205a6908273555931acca083387dfb37e2c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c85b205a6908273555931acca083387dfb37e2c3", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c85b205a6908273555931acca083387dfb37e2c3", "committedDate": "2020-03-19T19:03:06Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()`\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "80f772127f646bcc5164b7f5a8722a69f90dc882", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/80f772127f646bcc5164b7f5a8722a69f90dc882", "committedDate": "2020-03-19T20:35:05Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()`\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80f772127f646bcc5164b7f5a8722a69f90dc882", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/80f772127f646bcc5164b7f5a8722a69f90dc882", "committedDate": "2020-03-19T20:35:05Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()`\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "d402a2ab3d46c5fdd238cb22f41eb526fe839d0f", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d402a2ab3d46c5fdd238cb22f41eb526fe839d0f", "committedDate": "2020-03-19T21:02:57Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()`\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NDU2NTE1", "url": "https://github.com/eclipse-openj9/openj9/pull/8895#pullrequestreview-378456515", "createdAt": "2020-03-20T12:54:44Z", "commit": {"oid": "d402a2ab3d46c5fdd238cb22f41eb526fe839d0f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02172866b19c2130f65dead89ee979f71ea01cad", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/02172866b19c2130f65dead89ee979f71ea01cad", "committedDate": "2020-03-20T15:50:33Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()`\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d402a2ab3d46c5fdd238cb22f41eb526fe839d0f", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d402a2ab3d46c5fdd238cb22f41eb526fe839d0f", "committedDate": "2020-03-19T21:02:57Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()`\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "02172866b19c2130f65dead89ee979f71ea01cad", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/02172866b19c2130f65dead89ee979f71ea01cad", "committedDate": "2020-03-20T15:50:33Z", "message": "Change realTimeGC option as per compilation\n\nThis change is to support the JITServer receiving\nthe realTimeGC config setting from the client for\nper compilation.\n\nAlso implemented the server version of\n`getCellSizeForSizeClass() and `getObjectSizeClass()`\nwhich were missing and are triggered when realTimeGC is true.\n\nRelated to eclipse/omr#4945\n\nFixes: #8707\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 504, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}