{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NjA0NzY1", "number": 9373, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzoyNjo0N1rOEE4Ztw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNDoxNTo1M1rOEFjjrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTUzODQ3OnYy", "diffSide": "RIGHT", "path": "runtime/gc_glue_java/ArrayletObjectModelBase.hpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzoyNjo0N1rOGix_9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzoyNjo0N1rOGix_9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyMzk1Ng==", "bodyText": "There is no adjustment any more. This line and comment above should go away. The formal parameter should be renamed unadjustedDataSizeInBytes->dataSizeInBytes .", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439123956", "createdAt": "2020-06-11T23:26:47Z", "author": {"login": "amicic"}, "path": "runtime/gc_glue_java/ArrayletObjectModelBase.hpp", "diffHunk": "@@ -252,7 +252,7 @@ class GC_ArrayletObjectModelBase\n \t\t\t * of the after-last element without crashing. Handle the case of UDATA_MAX specially, since we use that\n \t\t\t * for any object whose size overflows the address space.\n \t\t\t */\n-\t\t\tUDATA dataSizeInBytes = (UDATA_MAX == unadjustedDataSizeInBytes) ? UDATA_MAX : (unadjustedDataSizeInBytes + 1);\n+\t\t\tUDATA dataSizeInBytes = (UDATA_MAX == unadjustedDataSizeInBytes) ? UDATA_MAX : unadjustedDataSizeInBytes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTUzOTgwOnYy", "diffSide": "RIGHT", "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzoyNzozNVrOGiyAwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzoyNzozNVrOGiyAwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEyNDE2Mg==", "bodyText": "_numberOfArraylets is unsigned, so this becomes redundant.", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439124162", "createdAt": "2020-06-11T23:27:35Z", "author": {"login": "amicic"}, "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "diffHunk": "@@ -72,10 +72,10 @@ MM_IndexableObjectAllocationModel::initializeAllocateDescription(MM_EnvironmentB\n \t\tbreak;\n \n \tcase GC_ArrayletObjectModel::Discontiguous:\n-\t\tAssert_MM_true(0 < _numberOfArraylets);\n+\t\tAssert_MM_true(0 <= _numberOfArraylets);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTYxNzgzOnYy", "diffSide": "LEFT", "path": "runtime/gc_glue_java/ArrayletObjectModel.hpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMDowOTowOFrOGiyvpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMDowOTowOFrOGiyvpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzNjE2NQ==", "bodyText": "I believe this was the only user of AssertNotEmptyArrayletLeaves(), so that it can be removed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439136165", "createdAt": "2020-06-12T00:09:08Z", "author": {"login": "amicic"}, "path": "runtime/gc_glue_java/ArrayletObjectModel.hpp", "diffHunk": "@@ -52,17 +52,9 @@ class GC_ArrayletObjectModel : public GC_ArrayletObjectModelBase\n */\n private:\n \tvoid AssertBadElementSize();\n+\tvoid AssertArrayletIsDiscontiguous(J9IndexableObject *objPtr);\n #if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n \tvoid AssertNotEmptyArrayletLeaves(UDATA sizeInElements, UDATA arrayletLeafCount);\n-\tMMINLINE bool\n-\tisOneArrayletLeafWithNULL(J9IndexableObject *spine, UDATA arrayletLeafCount, UDATA sizeInElements)\n-\t{\n-\t\tUDATA arrayletLeafSize = _omrVM->_arrayletLeafSize;\n-\t\tUDATA dataSize = getDataSizeInBytes(spine);\n-\t\tAssertNotEmptyArrayletLeaves(sizeInElements, arrayletLeafCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTYzMDA1OnYy", "diffSide": "RIGHT", "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMDoxMjozMVrOGiy3IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMDoxOTo0MVrOGizGzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzODA4MQ==", "bodyText": "I'm on a fence, if we really need this assert. @dmitripivkine, opinion?\nBesides, for Metronome that does not move object, even stronger assert (without +objectAlignment) should hold, right?\nAnd finally, you have a clone of this in another file - no way to reuse?", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439138081", "createdAt": "2020-06-12T00:12:31Z", "author": {"login": "amicic"}, "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "diffHunk": "@@ -258,22 +259,23 @@ MM_IndexableObjectAllocationModel::layoutDiscontiguousArraylet(MM_EnvironmentBas\n \tif (NULL != spine) {\n \t\tswitch (_layout) {\n \t\tcase GC_ArrayletObjectModel::Discontiguous:\n-\t\t\t/* if last arraylet leaf is empty (contains 0 bytes) arrayoid pointer is set to NULL */\n-\t\t\tif (arrayoidIndex == (_numberOfArraylets - 1)) {\n-\t\t\t\tAssert_MM_true(0 == (_dataSize % arrayletLeafSize));\n-\t\t\t\tGC_SlotObject slotObject(env->getOmrVM(), GC_SlotObject::addToSlotAddress(arrayoidPtr, arrayoidIndex, compressed));\n-\t\t\t\tslotObject.writeReferenceToSlot(NULL);\n-\t\t\t} else {\n-\t\t\t\tAssert_MM_true(0 != (_dataSize % arrayletLeafSize));\n-\t\t\t\tAssert_MM_true(arrayoidIndex == _numberOfArraylets);\n+#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n+\t\t\tif (!indexableObjectModel->isDoubleMappingEnabled())\n+#endif /* J9VM_GC_ENABLE_DOUBLE_MAP */\n+\t\t\t{\n+\t\t\t\tUDATA remainderBytes = _dataSize % arrayletLeafSize;\n+\t\t\t\tif (0 != remainderBytes) {\n+\t\t\t\t\tAssert_MM_true((indexableObjectModel->getSpineSize(spine) + remainderBytes + env->getObjectAlignmentInBytes()) > arrayletLeafSize);\n+\t\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE0MjA5Mg==", "bodyText": "Yes you're right. I'll reuse the one from ArrayletObjectModel.cpp. And yes, now that\ndiscontiguous arraylets can have sizes that are not just modulo of arrayletLeafSize, I wasn't sure myself if we should have this Assert or not.", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439142092", "createdAt": "2020-06-12T00:19:41Z", "author": {"login": "bragaigor"}, "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "diffHunk": "@@ -258,22 +259,23 @@ MM_IndexableObjectAllocationModel::layoutDiscontiguousArraylet(MM_EnvironmentBas\n \tif (NULL != spine) {\n \t\tswitch (_layout) {\n \t\tcase GC_ArrayletObjectModel::Discontiguous:\n-\t\t\t/* if last arraylet leaf is empty (contains 0 bytes) arrayoid pointer is set to NULL */\n-\t\t\tif (arrayoidIndex == (_numberOfArraylets - 1)) {\n-\t\t\t\tAssert_MM_true(0 == (_dataSize % arrayletLeafSize));\n-\t\t\t\tGC_SlotObject slotObject(env->getOmrVM(), GC_SlotObject::addToSlotAddress(arrayoidPtr, arrayoidIndex, compressed));\n-\t\t\t\tslotObject.writeReferenceToSlot(NULL);\n-\t\t\t} else {\n-\t\t\t\tAssert_MM_true(0 != (_dataSize % arrayletLeafSize));\n-\t\t\t\tAssert_MM_true(arrayoidIndex == _numberOfArraylets);\n+#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n+\t\t\tif (!indexableObjectModel->isDoubleMappingEnabled())\n+#endif /* J9VM_GC_ENABLE_DOUBLE_MAP */\n+\t\t\t{\n+\t\t\t\tUDATA remainderBytes = _dataSize % arrayletLeafSize;\n+\t\t\t\tif (0 != remainderBytes) {\n+\t\t\t\t\tAssert_MM_true((indexableObjectModel->getSpineSize(spine) + remainderBytes + env->getObjectAlignmentInBytes()) > arrayletLeafSize);\n+\t\t\t\t}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzODA4MQ=="}, "originalCommit": {"oid": "d30f15694d6c117eaa9562beeeb245ca8efca105"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNTgwNDY5OnYy", "diffSide": "RIGHT", "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMTo1MjowMVrOGi0hdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQwMTo1MjowMVrOGi0hdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE2NTMwMA==", "bodyText": "Perhaps you should drag in these few lines inside the assert helper. They exist at both sites where the helper is invoked.", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r439165300", "createdAt": "2020-06-12T01:52:01Z", "author": {"login": "amicic"}, "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "diffHunk": "@@ -258,22 +258,20 @@ MM_IndexableObjectAllocationModel::layoutDiscontiguousArraylet(MM_EnvironmentBas\n \tif (NULL != spine) {\n \t\tswitch (_layout) {\n \t\tcase GC_ArrayletObjectModel::Discontiguous:\n-\t\t\t/* if last arraylet leaf is empty (contains 0 bytes) arrayoid pointer is set to NULL */\n-\t\t\tif (arrayoidIndex == (_numberOfArraylets - 1)) {\n-\t\t\t\tAssert_MM_true(0 == (_dataSize % arrayletLeafSize));\n-\t\t\t\tGC_SlotObject slotObject(env->getOmrVM(), GC_SlotObject::addToSlotAddress(arrayoidPtr, arrayoidIndex, compressed));\n-\t\t\t\tslotObject.writeReferenceToSlot(NULL);\n-\t\t\t} else {\n-\t\t\t\tAssert_MM_true(0 != (_dataSize % arrayletLeafSize));\n-\t\t\t\tAssert_MM_true(arrayoidIndex == _numberOfArraylets);\n+#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n+\t\t\tif (!indexableObjectModel->isDoubleMappingEnabled())\n+#endif /* J9VM_GC_ENABLE_DOUBLE_MAP */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d73b62e245373f9f7b7c99009b4cd458c1261998"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MjYwOTEwOnYy", "diffSide": "RIGHT", "path": "runtime/gc_glue_java/ArrayletObjectModel.cpp", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNDoxNTo1M1rOGj0JVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxOToxMjo1M1rOGkpkpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIwNzcwMA==", "bodyText": "Would you please add comment here to explain that with exception of Double Mapping request the only case when layout Discontiguous can be selected is Arraylet Hybrid representation does not fit a region? It would improve readability. My original confusion when I read this first time was \"Discontiguous\" in function name refer to Discontiguous Layout of Arraylet, not Discontiguous Array representation.", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r440207700", "createdAt": "2020-06-15T14:15:53Z", "author": {"login": "dmitripivkine"}, "path": "runtime/gc_glue_java/ArrayletObjectModel.cpp", "diffHunk": "@@ -43,13 +43,21 @@ GC_ArrayletObjectModel::AssertBadElementSize()\n \tAssert_MM_unreachable();\n }\n \n-#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n void\n-GC_ArrayletObjectModel::AssertNotEmptyArrayletLeaves(UDATA sizeInElements, UDATA arrayletLeafCount)\n+GC_ArrayletObjectModel::AssertArrayletIsDiscontiguous(J9IndexableObject *objPtr)\n {\n-\tAssert_MM_true((0 == sizeInElements) || (arrayletLeafCount > 0));\n-}\n+#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n+\tif (!isDoubleMappingEnabled())\n #endif /* J9VM_GC_ENABLE_DOUBLE_MAP */\n+\t{\n+\t\tMM_GCExtensionsBase* extensions = MM_GCExtensionsBase::getExtensions(_omrVM);\n+\t\tUDATA arrayletLeafSize = _omrVM->_arrayletLeafSize;\n+\t\tUDATA remainderBytes = getDataSizeInBytes(objPtr) % arrayletLeafSize;\n+\t\tif (0 != remainderBytes) {\n+\t\t\tAssert_MM_true((getSpineSize(objPtr) + remainderBytes + extensions->getObjectAlignmentInBytes()) > arrayletLeafSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da754e3a29cceef3b9c113be060af7b426333c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MTY0MA==", "bodyText": "I believe change can be merge without this suggested comment. We can add it later if necessary", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r441081640", "createdAt": "2020-06-16T19:10:15Z", "author": {"login": "dmitripivkine"}, "path": "runtime/gc_glue_java/ArrayletObjectModel.cpp", "diffHunk": "@@ -43,13 +43,21 @@ GC_ArrayletObjectModel::AssertBadElementSize()\n \tAssert_MM_unreachable();\n }\n \n-#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n void\n-GC_ArrayletObjectModel::AssertNotEmptyArrayletLeaves(UDATA sizeInElements, UDATA arrayletLeafCount)\n+GC_ArrayletObjectModel::AssertArrayletIsDiscontiguous(J9IndexableObject *objPtr)\n {\n-\tAssert_MM_true((0 == sizeInElements) || (arrayletLeafCount > 0));\n-}\n+#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n+\tif (!isDoubleMappingEnabled())\n #endif /* J9VM_GC_ENABLE_DOUBLE_MAP */\n+\t{\n+\t\tMM_GCExtensionsBase* extensions = MM_GCExtensionsBase::getExtensions(_omrVM);\n+\t\tUDATA arrayletLeafSize = _omrVM->_arrayletLeafSize;\n+\t\tUDATA remainderBytes = getDataSizeInBytes(objPtr) % arrayletLeafSize;\n+\t\tif (0 != remainderBytes) {\n+\t\t\tAssert_MM_true((getSpineSize(objPtr) + remainderBytes + extensions->getObjectAlignmentInBytes()) > arrayletLeafSize);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIwNzcwMA=="}, "originalCommit": {"oid": "40da754e3a29cceef3b9c113be060af7b426333c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4MzA0NQ==", "bodyText": "Sorry, I completely missed this comment. Let me know if you want the comment in this PR and I can insert it.", "url": "https://github.com/eclipse-openj9/openj9/pull/9373#discussion_r441083045", "createdAt": "2020-06-16T19:12:53Z", "author": {"login": "bragaigor"}, "path": "runtime/gc_glue_java/ArrayletObjectModel.cpp", "diffHunk": "@@ -43,13 +43,21 @@ GC_ArrayletObjectModel::AssertBadElementSize()\n \tAssert_MM_unreachable();\n }\n \n-#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n void\n-GC_ArrayletObjectModel::AssertNotEmptyArrayletLeaves(UDATA sizeInElements, UDATA arrayletLeafCount)\n+GC_ArrayletObjectModel::AssertArrayletIsDiscontiguous(J9IndexableObject *objPtr)\n {\n-\tAssert_MM_true((0 == sizeInElements) || (arrayletLeafCount > 0));\n-}\n+#if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n+\tif (!isDoubleMappingEnabled())\n #endif /* J9VM_GC_ENABLE_DOUBLE_MAP */\n+\t{\n+\t\tMM_GCExtensionsBase* extensions = MM_GCExtensionsBase::getExtensions(_omrVM);\n+\t\tUDATA arrayletLeafSize = _omrVM->_arrayletLeafSize;\n+\t\tUDATA remainderBytes = getDataSizeInBytes(objPtr) % arrayletLeafSize;\n+\t\tif (0 != remainderBytes) {\n+\t\t\tAssert_MM_true((getSpineSize(objPtr) + remainderBytes + extensions->getObjectAlignmentInBytes()) > arrayletLeafSize);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIwNzcwMA=="}, "originalCommit": {"oid": "40da754e3a29cceef3b9c113be060af7b426333c"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 270, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}