{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4OTE2ODU3", "number": 9814, "title": "Only add `/usr/lib` to AIX LIBPATH if not already there", "bodyText": "There are a couple of cases to cover.  The most common\nbeing that the JVM already appended :/usr/lib to the\nLIBPATH.\nIf we find :/usr/lib somewhere, we need to check whether\nit's the end of the string, or somewhere in the middle.\nIf it's in the middle, we need to differentiate between\n:/usr/lib: and :/usr/lib/something.\nOtherwise, check for /usr/lib at the start of the LIBPATH.\nIf the length of LIBPATH is the same as /usr/lib, then\nwe're done.  Otherwise, confirm that we found /usr/lib:.\nWhich is a lot of parsing to pass a test.\nfixes: #8504\nSigned-off-by: Dan Heidinga daniel_heidinga@ca.ibm.com", "createdAt": "2020-06-06T02:03:26Z", "url": "https://github.com/eclipse-openj9/openj9/pull/9814", "merged": true, "mergeCommit": {"oid": "3c0b08eec183995a16b8ae537ac3f723d39bf56e"}, "closed": true, "closedAt": "2020-06-15T18:23:19Z", "author": {"login": "DanHeidinga"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpQo5sAFqTQyNjIzNDk3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcriwFRgBqjM0NDUwNzY0MTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjM0OTc3", "url": "https://github.com/eclipse-openj9/openj9/pull/9814#pullrequestreview-426234977", "createdAt": "2020-06-08T13:29:44Z", "commit": {"oid": "6b5c08d43ec5af4bc2f58ddd6b7144bb904498cc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzoyOTo0NFrOGgeJtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzozOTo1OFrOGgekIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMTYyMw==", "bodyText": "I don't see how this is related to #9640 which speaks about MALLOCOPTIONS: this does nothing about that environment variable.", "url": "https://github.com/eclipse-openj9/openj9/pull/9814#discussion_r436701623", "createdAt": "2020-06-08T13:29:44Z", "author": {"login": "keithc-ca"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1717,12 +1717,56 @@ JNI_CreateJavaVM_impl(JavaVM **pvm, void **penv, void *vm_args, BOOLEAN isJITSer\n \t * trying to load application native libraries that are linked against\n \t * libraries in /usr/lib we could fail to find those libraries if /usr/lib\n \t * is not on the LIBPATH.\n-\t * */\n-\taddToLibpath(\"/usr/lib\", FALSE);\n+\t */\n+\t{\n+\t\t/* github #9640 & #8504 show tests fail if the libpath is modified", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5c08d43ec5af4bc2f58ddd6b7144bb904498cc"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwODM4Ng==", "bodyText": "I think a better solution would be to fix addToLibpath so it doesn't add entries that are already present, or perhaps better, eliminates all redundancy. Other entries are added to LIBPATH that might already be present (e.g. a VM process launching a child will end up with two (or more) occurrences .../lib/j9vm and .../lib/ppc64/compressedrefs).", "url": "https://github.com/eclipse-openj9/openj9/pull/9814#discussion_r436708386", "createdAt": "2020-06-08T13:39:58Z", "author": {"login": "keithc-ca"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1717,12 +1717,56 @@ JNI_CreateJavaVM_impl(JavaVM **pvm, void **penv, void *vm_args, BOOLEAN isJITSer\n \t * trying to load application native libraries that are linked against\n \t * libraries in /usr/lib we could fail to find those libraries if /usr/lib\n \t * is not on the LIBPATH.\n-\t * */\n-\taddToLibpath(\"/usr/lib\", FALSE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5c08d43ec5af4bc2f58ddd6b7144bb904498cc"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MTU0OTAz", "url": "https://github.com/eclipse-openj9/openj9/pull/9814#pullrequestreview-429154903", "createdAt": "2020-06-11T17:52:20Z", "commit": {"oid": "bd3e2e3b02b276abd6ffdeafbc9eac8c5bde8735"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNzo1MjoyMVrOGiodCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNzo1MjoyMVrOGiodCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk2NzU2MA==", "bodyText": "This needs to be in a loop, otherwise it won't handle situations like\nLIBPATH=prefix:/usr/lib64:/usr/lib:suffix", "url": "https://github.com/eclipse-openj9/openj9/pull/9814#discussion_r438967560", "createdAt": "2020-06-11T17:52:21Z", "author": {"login": "keithc-ca"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1717,12 +1717,56 @@ JNI_CreateJavaVM_impl(JavaVM **pvm, void **penv, void *vm_args, BOOLEAN isJITSer\n \t * trying to load application native libraries that are linked against\n \t * libraries in /usr/lib we could fail to find those libraries if /usr/lib\n \t * is not on the LIBPATH.\n-\t * */\n-\taddToLibpath(\"/usr/lib\", FALSE);\n+\t */\n+\t{\n+\t\t/* github #8504 show tests fail if the libpath is modified\n+\t\t * when creating a new process from Java.  The easy fix is to only\n+\t\t * append to the libpath if /usr/lib isn't already appended.\n+\t\t * Example libpath:\n+\t\t * LIBPATH=/jre/lib/ppc64/j9vm:/jre/lib/ppc64:/jre/lib/ppc64/jli:/jre/../lib/ppc64:/usr/lib\n+\t\t */\n+\n+\t\tconst char *currentLibPath = getenv(\"LIBPATH\");\n+\t\tBOOLEAN appendToLibPath = TRUE;\n+\t\tif (NULL != currentLibPath) {\n+\t\t\tsize_t currentLibPathLength = strlen(currentLibPath);\n+\t\t\tconst char *usrLib = \":/usr/lib\";\n+\t\t\tconst UDATA usrLibPtrLength = LITERAL_STRLEN(\":/usr/lib\");\n+\t\t\tconst char *usrLibPtr = strstr(currentLibPath, usrLib);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd3e2e3b02b276abd6ffdeafbc9eac8c5bde8735"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MjU5NjE1", "url": "https://github.com/eclipse-openj9/openj9/pull/9814#pullrequestreview-429259615", "createdAt": "2020-06-11T20:18:08Z", "commit": {"oid": "8accd6aa566f962c6ff27e95a673b3a267bb490a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMDoxODowOFrOGitS_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMDoyMDozNVrOGitaGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA0NjkwOA==", "bodyText": "This can be simplified:\n\nWe know remainingLength >= usrLibLength else strstr() would have returned NULL.\nIt's safe to peek at the character at needle[usrLibLength] unconditionally (at worst it's the NUL terminator).\n\n    if ((':' == needle[usrLibLength]) || ('\\0' == needle[usrLibLength])) {\n        /* Found a match */\n        appendToLibPath = FALSE;\n        break;\n    }\n\nNesting it within the inverse of the if statement above we can remove the goto and the label:\n    if ((0 == offsetFromStart) || (':' == needle[-1])) {\n        if ((':' == needle[usrLibLength]) || ('\\0' == needle[usrLibLength])) {\n            /* Found a match */\n            appendToLibPath = FALSE;\n            break;\n        }\n    }", "url": "https://github.com/eclipse-openj9/openj9/pull/9814#discussion_r439046908", "createdAt": "2020-06-11T20:18:08Z", "author": {"login": "keithc-ca"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1717,12 +1717,57 @@ JNI_CreateJavaVM_impl(JavaVM **pvm, void **penv, void *vm_args, BOOLEAN isJITSer\n \t * trying to load application native libraries that are linked against\n \t * libraries in /usr/lib we could fail to find those libraries if /usr/lib\n \t * is not on the LIBPATH.\n-\t * */\n-\taddToLibpath(\"/usr/lib\", FALSE);\n+\t */\n+\t{\n+\t\t/* github #8504 shows tests fail if the libpath is modified\n+\t\t * when creating a new process from Java.  The easy fix is to only\n+\t\t * append to the libpath if /usr/lib isn't already present.\n+\t\t * Example libpath:\n+\t\t * LIBPATH=/jre/lib/ppc64/j9vm:/jre/lib/ppc64:/jre/lib/ppc64/jli:/jre/../lib/ppc64:/usr/lib\n+\t\t */\n+\n+\t\tconst char *currentLibPath = getenv(\"LIBPATH\");\n+\t\tBOOLEAN appendToLibPath = TRUE;\n+\t\tif (NULL != currentLibPath) {\n+\t\t\tconst size_t currentLibPathLength = strlen(currentLibPath);\n+\t\t\tconst char *usrLib = \"/usr/lib\";\n+\t\t\tconst UDATA usrLibLength = LITERAL_STRLEN(\"/usr/lib\");\n+\t\t\tconst char *needle = strstr(currentLibPath, usrLib);\n+\t\t\twhile (NULL != needle) {\n+\t\t\t\t/* Note, inside the loop we're guaranteed to have \n+\t\t\t\t * usrLibLength of string to operate on.\n+\t\t\t\t */\n+\t\t\t\tconst ptrdiff_t offsetFromStart = needle - currentLibPath;\n+\t\t\t\tconst size_t remainingLength = currentLibPathLength - offsetFromStart;\n+\t\t\t\tif (0 != offsetFromStart) {\n+\t\t\t\t\tif (needle[-1] != ':') {\n+\t\t\t\t\t\tgoto nextCheck;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tif (remainingLength == usrLibLength) {\n+\t\t\t\t\t/* Found a match */\n+\t\t\t\t\tappendToLibPath = FALSE;\n+\t\t\t\t\tbreak;\n+\t\t\t\t} else if (remainingLength > usrLibLength) {\n+\t\t\t\t\tif (needle[usrLibLength] == ':') {\n+\t\t\t\t\t\t/* Found a match */\n+\t\t\t\t\t\tappendToLibPath = FALSE;\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n+\t\t\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8accd6aa566f962c6ff27e95a673b3a267bb490a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTA0ODcyOQ==", "bodyText": "nit: please remove whitespace at the end of this line", "url": "https://github.com/eclipse-openj9/openj9/pull/9814#discussion_r439048729", "createdAt": "2020-06-11T20:20:35Z", "author": {"login": "keithc-ca"}, "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1717,12 +1717,57 @@ JNI_CreateJavaVM_impl(JavaVM **pvm, void **penv, void *vm_args, BOOLEAN isJITSer\n \t * trying to load application native libraries that are linked against\n \t * libraries in /usr/lib we could fail to find those libraries if /usr/lib\n \t * is not on the LIBPATH.\n-\t * */\n-\taddToLibpath(\"/usr/lib\", FALSE);\n+\t */\n+\t{\n+\t\t/* github #8504 shows tests fail if the libpath is modified\n+\t\t * when creating a new process from Java.  The easy fix is to only\n+\t\t * append to the libpath if /usr/lib isn't already present.\n+\t\t * Example libpath:\n+\t\t * LIBPATH=/jre/lib/ppc64/j9vm:/jre/lib/ppc64:/jre/lib/ppc64/jli:/jre/../lib/ppc64:/usr/lib\n+\t\t */\n+\n+\t\tconst char *currentLibPath = getenv(\"LIBPATH\");\n+\t\tBOOLEAN appendToLibPath = TRUE;\n+\t\tif (NULL != currentLibPath) {\n+\t\t\tconst size_t currentLibPathLength = strlen(currentLibPath);\n+\t\t\tconst char *usrLib = \"/usr/lib\";\n+\t\t\tconst UDATA usrLibLength = LITERAL_STRLEN(\"/usr/lib\");\n+\t\t\tconst char *needle = strstr(currentLibPath, usrLib);\n+\t\t\twhile (NULL != needle) {\n+\t\t\t\t/* Note, inside the loop we're guaranteed to have ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8accd6aa566f962c6ff27e95a673b3a267bb490a"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNzMxMjU0", "url": "https://github.com/eclipse-openj9/openj9/pull/9814#pullrequestreview-430731254", "createdAt": "2020-06-15T15:02:45Z", "commit": {"oid": "8c6d7324c913bf30ca74df41a6eb82eed278446b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f15c903063dff75d903225db48c1d9e465abee3f", "author": {"user": {"login": "DanHeidinga", "name": "Dan Heidinga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f15c903063dff75d903225db48c1d9e465abee3f", "committedDate": "2020-06-15T15:53:01Z", "message": "Process the whole LIBPATH looking for '/usr/lib'.\n\nThere are a couple of cases to consider:\n* \"/usr/lib\": Path is exactly equal to /usr/lib\n\n* \"/usr/lib:...\" Path begins with /usr/lib.  This may\n\tor may not result in a valid match depending\n\ton whether it is followed by a ':' or not.\n\n* \"...:/usr/lib:...\" Path includes /usr/lib.  This may\n\tor may not result in a valid match depending\n\ton whether it is preceded by \":\" and followed\n\tby a ':' or not.\n\n* \"....:/usr/lib\" Path ends with /usr/lib.\n\nAll of these can be handled by looping through the LIBPATH\nlooking for /usr/lib and then handling the boundary cases\ncarefully.\n\nfixes: #8504\n\nSigned-off-by: Dan Heidinga <daniel_heidinga@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c6d7324c913bf30ca74df41a6eb82eed278446b", "author": {"user": {"login": "DanHeidinga", "name": "Dan Heidinga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/8c6d7324c913bf30ca74df41a6eb82eed278446b", "committedDate": "2020-06-12T18:45:00Z", "message": "Remove unnecessary whitespace\n\nSigned-off-by: Dan Heidinga <daniel_heidinga@ca.ibm.com>"}, "afterCommit": {"oid": "f15c903063dff75d903225db48c1d9e465abee3f", "author": {"user": {"login": "DanHeidinga", "name": "Dan Heidinga"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f15c903063dff75d903225db48c1d9e465abee3f", "committedDate": "2020-06-15T15:53:01Z", "message": "Process the whole LIBPATH looking for '/usr/lib'.\n\nThere are a couple of cases to consider:\n* \"/usr/lib\": Path is exactly equal to /usr/lib\n\n* \"/usr/lib:...\" Path begins with /usr/lib.  This may\n\tor may not result in a valid match depending\n\ton whether it is followed by a ':' or not.\n\n* \"...:/usr/lib:...\" Path includes /usr/lib.  This may\n\tor may not result in a valid match depending\n\ton whether it is preceded by \":\" and followed\n\tby a ':' or not.\n\n* \"....:/usr/lib\" Path ends with /usr/lib.\n\nAll of these can be handled by looping through the LIBPATH\nlooking for /usr/lib and then handling the boundary cases\ncarefully.\n\nfixes: #8504\n\nSigned-off-by: Dan Heidinga <daniel_heidinga@ca.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 623, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}