{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MzA0MzYw", "number": 10930, "title": "Cache Class#getSimpleName and Class#getCanonicalName", "bodyText": "This patch introduces cache for Class#getSimpleName and Class#getCanonicalName\nBenchmarks:\n\nStartup. I wrote simple Spring Application and measured with JMH how much time it needs to start. In fact I haven't noticed significant deviations:\n\n        Benchmark            Mode  Cnt  Score   Error  Units\nBefore: DemoApplication.run  avgt    5  0.121 \u00b1 0.003   s/op\nAfter:  DemoApplication.run  avgt    5  0.119 \u00b1 0.003   s/op\n\n\nThroughput. I also measured with JMH how performant is this implementations. Benchmark includes two types of executions: normal one (single-threaded) and ...Concurrent one - 10 threads in parallel.\n\n        Benchmark                                                                      Mode  Cnt          Score            Error  Units\n\nBefore: OpenJ9ClassMetadataThroughputBenchmark.classCanonicalNameBenchmark            thrpt    5   29182175.748 \u00b1    1537962.440  ops/s\nAfter:  OpenJ9ClassMetadataThroughputBenchmark.classCanonicalNameBenchmark            thrpt    5  219930389.533 \u00b1    2246706.612  ops/s\n\nBefore: OpenJ9ClassMetadataThroughputBenchmark.classCanonicalNameBenchmarkConcurrent  thrpt    5  123943856.531 \u00b1     991646.387  ops/s\nAfter:  OpenJ9ClassMetadataThroughputBenchmark.classCanonicalNameBenchmarkConcurrent  thrpt    5  656622074.401 \u00b1   12697222.008  ops/s\n\nBefore: OpenJ9ClassMetadataThroughputBenchmark.classSimpleNameBenchmark               thrpt    5    9446333.682 \u00b1     148938.440  ops/s\nAfter:  OpenJ9ClassMetadataThroughputBenchmark.classSimpleNameBenchmark               thrpt    5  213360602.590 \u00b1   93528750.650  ops/s\n\nBefore: OpenJ9ClassMetadataThroughputBenchmark.classSimpleNameBenchmarkConcurrent     thrpt    5   30667390.182 \u00b1     100680.850  ops/s\nAfter:  OpenJ9ClassMetadataThroughputBenchmark.classSimpleNameBenchmarkConcurrent     thrpt    5  649498541.172 \u00b1   11960827.470  ops/s\n\nThis benchmark looks even better than the previous one (using ReflectCache)\nFixes #9963\nSigned-off-by: Alexey Anufriev contact@alexey-anufriev.com", "createdAt": "2020-10-19T21:59:41Z", "url": "https://github.com/eclipse-openj9/openj9/pull/10930", "merged": true, "mergeCommit": {"oid": "183148a5e6e031cf689620ac8dc52056b1ac9c63"}, "closed": true, "closedAt": "2020-10-28T04:00:25Z", "author": {"login": "alexey-anufriev"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUN0aUAFqTUxMjI1MDgyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW1dGDgFqTUxODMwODEwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMjUwODI1", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#pullrequestreview-512250825", "createdAt": "2020-10-20T00:34:10Z", "commit": {"oid": "27eedb12add1912713382b61946cdbcc6126e345"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozNDoxMVrOHkmXBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDozNDoxMVrOHkmXBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzOTI3MA==", "bodyText": "@pshipton are you familiar with the rationale behind the naming scheme for CacheKey's using the .X or /X format?  These names seem fine to me but I'm not sure if they fit the existing schema.", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#discussion_r508139270", "createdAt": "2020-10-20T00:34:11Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/Class.java", "diffHunk": "@@ -4060,6 +4066,9 @@ static CacheKey newDeclaredPublicMethodsKey(String methodName, Class<?>[] parame\n \t\treturn new CacheKey(\"#m\" + methodName, parameterTypes, null);\t//$NON-NLS-1$\n \t}\n \n+\tstatic final CacheKey ClassCanonicalNameKey = new CacheKey(\"CanonicalName\", EmptyParameters, null); //$NON-NLS-1$\n+\tstatic final CacheKey ClassSimpleNameKey = new CacheKey(\"SimpleName\", EmptyParameters, null); //$NON-NLS-1$", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27eedb12add1912713382b61946cdbcc6126e345"}, "originalPosition": 70}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27eedb12add1912713382b61946cdbcc6126e345", "author": {"user": {"login": "alexey-anufriev", "name": "Alexey Anufriev"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/27eedb12add1912713382b61946cdbcc6126e345", "committedDate": "2020-10-19T21:58:23Z", "message": "Cache Class#getSimpleName and Class#getCanonicalName\n\nThis patch introduces cache for Class#getSimpleName and Class#getCanonicalName\n\nFixes #9963\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>"}, "afterCommit": {"oid": "609a33f7b5dfc0572a58aaf746b2a42fb63e9a21", "author": {"user": {"login": "alexey-anufriev", "name": "Alexey Anufriev"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/609a33f7b5dfc0572a58aaf746b2a42fb63e9a21", "committedDate": "2020-10-22T19:37:04Z", "message": "Cache Class#getSimpleName and Class#getCanonicalName\n\nThis patch introduces cache for Class#getSimpleName and Class#getCanonicalName\n\nFixes #9963\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NjU0NDYw", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#pullrequestreview-515654460", "createdAt": "2020-10-23T13:14:26Z", "commit": {"oid": "609a33f7b5dfc0572a58aaf746b2a42fb63e9a21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMzoxNDoyN1rOHnNU6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMzoxNDoyN1rOHnNU6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg3NDg1Nw==", "bodyText": "what happens when the SoftReference gets cleared?", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#discussion_r510874857", "createdAt": "2020-10-23T13:14:27Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/Class.java", "diffHunk": "@@ -3579,6 +3631,11 @@ public Method getEnclosingMethod() throws SecurityException {\n  * @see #isAnonymousClass()\n  */\n public String getSimpleName() {\n+\tMetadataCache cache = getMetadataCache();\n+\tif (cache.cachedSimpleName != null) {\n+\t\treturn cache.cachedSimpleName.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "609a33f7b5dfc0572a58aaf746b2a42fb63e9a21"}, "originalPosition": 146}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "609a33f7b5dfc0572a58aaf746b2a42fb63e9a21", "author": {"user": {"login": "alexey-anufriev", "name": "Alexey Anufriev"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/609a33f7b5dfc0572a58aaf746b2a42fb63e9a21", "committedDate": "2020-10-22T19:37:04Z", "message": "Cache Class#getSimpleName and Class#getCanonicalName\n\nThis patch introduces cache for Class#getSimpleName and Class#getCanonicalName\n\nFixes #9963\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>"}, "afterCommit": {"oid": "afbace5d925a71e0ff1a164c842c8121e007ca64", "author": {"user": {"login": "alexey-anufriev", "name": "Alexey Anufriev"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/afbace5d925a71e0ff1a164c842c8121e007ca64", "committedDate": "2020-10-23T19:54:38Z", "message": "Cache Class#getSimpleName and Class#getCanonicalName\n\nThis patch introduces cache for Class#getSimpleName and Class#getCanonicalName\n\nFixes #9963\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1OTgxMzg2", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#pullrequestreview-515981386", "createdAt": "2020-10-23T20:11:15Z", "commit": {"oid": "afbace5d925a71e0ff1a164c842c8121e007ca64"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDoxMToxNVrOHndGhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDoxNjozM1rOHndO_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEzMzMxNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tMetadataCache.cachedSimpleNameOffset = getFieldOffset(\n          \n          \n            \n            \t\t\t\tMetadataCache.class, \"cachedSimpleName\", MetadataCache.cachedSimpleNameOffset); //$NON-NLS-1$\n          \n          \n            \n            \t\tif (-1 == MetadataCache.cachedSimpleNameOffset) {\n          \n          \n            \n            \t\t\t/* Only lookup the offset if we haven't found it already */\n          \n          \n            \n            \t\t\tMetadataCache.cachedSimpleNameOffset = getFieldOffset(\n          \n          \n            \n            \t\t\t\tMetadataCache.class, \"cachedSimpleName\", MetadataCache.cachedSimpleNameOffset); //$NON-NLS-1$\n          \n          \n            \n            \t\t}", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#discussion_r511133317", "createdAt": "2020-10-23T20:11:15Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/Class.java", "diffHunk": "@@ -3029,6 +3015,72 @@ public MethodHandle run() {\n \treturn valueMethod;\n }\n \n+private MetadataCache getMetadataCache() {\n+\tif (metadataCache == null) {\n+\t\tmetadataCacheOffset = getFieldOffset(\"metadataCache\"); //$NON-NLS-1$\n+\t\twriteFieldValue(metadataCacheOffset, new MetadataCache());\n+\t}\n+\treturn metadataCache;\n+}\n+\n+private String cacheSimpleName(String simpleName) {\n+\tMetadataCache cache = getMetadataCache();\n+\n+\tif (cache.cachedSimpleName == null || cache.cachedSimpleName.get() == null) {\n+\t\tMetadataCache.cachedSimpleNameOffset = getFieldOffset(\n+\t\t\t\tMetadataCache.class, \"cachedSimpleName\", MetadataCache.cachedSimpleNameOffset); //$NON-NLS-1$", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afbace5d925a71e0ff1a164c842c8121e007ca64"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEzMzY4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tMetadataCache.cachedCanonicalNameOffset = getFieldOffset(\n          \n          \n            \n            \t\t\t\tMetadataCache.class, \"cachedCanonicalName\", MetadataCache.cachedCanonicalNameOffset); //$NON-NLS-1$\n          \n          \n            \n            \t\tif (-1 == MetadataCache.cachedCanonicalNameOffset) {\n          \n          \n            \n            \t\t\tMetadataCache.cachedCanonicalNameOffset = getFieldOffset(\n          \n          \n            \n            \t\t\t\t\tMetadataCache.class, \"cachedCanonicalName\", MetadataCache.cachedCanonicalNameOffset); //$NON-NLS-1$\n          \n          \n            \n            \t\t}", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#discussion_r511133680", "createdAt": "2020-10-23T20:12:18Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/Class.java", "diffHunk": "@@ -3029,6 +3015,72 @@ public MethodHandle run() {\n \treturn valueMethod;\n }\n \n+private MetadataCache getMetadataCache() {\n+\tif (metadataCache == null) {\n+\t\tmetadataCacheOffset = getFieldOffset(\"metadataCache\"); //$NON-NLS-1$\n+\t\twriteFieldValue(metadataCacheOffset, new MetadataCache());\n+\t}\n+\treturn metadataCache;\n+}\n+\n+private String cacheSimpleName(String simpleName) {\n+\tMetadataCache cache = getMetadataCache();\n+\n+\tif (cache.cachedSimpleName == null || cache.cachedSimpleName.get() == null) {\n+\t\tMetadataCache.cachedSimpleNameOffset = getFieldOffset(\n+\t\t\t\tMetadataCache.class, \"cachedSimpleName\", MetadataCache.cachedSimpleNameOffset); //$NON-NLS-1$\n+\n+\t\twriteFieldValue(cache, MetadataCache.cachedSimpleNameOffset, new SoftReference<>(simpleName));\n+\t}\n+\n+\treturn simpleName;\n+}\n+\n+private String cacheCanonicalName(String canonicalName) {\n+\tMetadataCache cache = getMetadataCache();\n+\n+\tif (cache.cachedCanonicalName == null || cache.cachedCanonicalName.get() == null) {\n+\t\tMetadataCache.cachedCanonicalNameOffset = getFieldOffset(\n+\t\t\t\tMetadataCache.class, \"cachedCanonicalName\", MetadataCache.cachedCanonicalNameOffset); //$NON-NLS-1$", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afbace5d925a71e0ff1a164c842c8121e007ca64"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEzNDk0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tMetadataCache cache = getMetadataCache();\n          \n          \n            \n            \tif (cache.cachedSimpleName != null && cache.cachedSimpleName.get() != null) {\n          \n          \n            \n            \t\treturn cache.cachedSimpleName.get();\n          \n          \n            \n            \tMetadataCache cache = getMetadataCache();\n          \n          \n            \n            \tif (cache.cachedSimpleName != null) {\n          \n          \n            \n            \t\t/* Get a strong ref to the cached name so it can't be gc'd out from under us */\t\n          \n          \n            \n            \t\tString cachedSimpleName = cache.cachedSimpleName.get();\n          \n          \n            \n            \t\tif (cachedSimpleName != null) {\n          \n          \n            \n            \t\t\treturn cache.cachedSimpleName.get();\n          \n          \n            \n            \t\t}", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#discussion_r511134947", "createdAt": "2020-10-23T20:15:21Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/Class.java", "diffHunk": "@@ -3579,6 +3631,11 @@ public Method getEnclosingMethod() throws SecurityException {\n  * @see #isAnonymousClass()\n  */\n public String getSimpleName() {\n+\tMetadataCache cache = getMetadataCache();\n+\tif (cache.cachedSimpleName != null && cache.cachedSimpleName.get() != null) {\n+\t\treturn cache.cachedSimpleName.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afbace5d925a71e0ff1a164c842c8121e007ca64"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEzNTM1OQ==", "bodyText": "For strict correctness, we should probably also get a local reference to cache.cachedSimpleName so we're dealing with consistent data.", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#discussion_r511135359", "createdAt": "2020-10-23T20:16:21Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/Class.java", "diffHunk": "@@ -3579,6 +3631,11 @@ public Method getEnclosingMethod() throws SecurityException {\n  * @see #isAnonymousClass()\n  */\n public String getSimpleName() {\n+\tMetadataCache cache = getMetadataCache();\n+\tif (cache.cachedSimpleName != null && cache.cachedSimpleName.get() != null) {\n+\t\treturn cache.cachedSimpleName.get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEzNDk0Nw=="}, "originalCommit": {"oid": "afbace5d925a71e0ff1a164c842c8121e007ca64"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEzNTQ4NQ==", "bodyText": "Same transform needed here", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#discussion_r511135485", "createdAt": "2020-10-23T20:16:33Z", "author": {"login": "DanHeidinga"}, "path": "jcl/src/java.base/share/classes/java/lang/Class.java", "diffHunk": "@@ -3659,6 +3716,11 @@ else if (!fullName.endsWith(simpleName)) {\n  * @see #isLocalClass()\n  */\n public String getCanonicalName() {\n+\tMetadataCache cache = getMetadataCache();\n+\tif (cache.cachedCanonicalName != null && cache.cachedCanonicalName.get() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afbace5d925a71e0ff1a164c842c8121e007ca64"}, "originalPosition": 166}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46759b866caac72669ca9fb6964d4238f079fdca", "author": {"user": {"login": "alexey-anufriev", "name": "Alexey Anufriev"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/46759b866caac72669ca9fb6964d4238f079fdca", "committedDate": "2020-10-26T21:22:29Z", "message": "Cache Class#getSimpleName and Class#getCanonicalName\n\nThis patch introduces cache for Class#getSimpleName and Class#getCanonicalName\n\nFixes #9963\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "afbace5d925a71e0ff1a164c842c8121e007ca64", "author": {"user": {"login": "alexey-anufriev", "name": "Alexey Anufriev"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/afbace5d925a71e0ff1a164c842c8121e007ca64", "committedDate": "2020-10-23T19:54:38Z", "message": "Cache Class#getSimpleName and Class#getCanonicalName\n\nThis patch introduces cache for Class#getSimpleName and Class#getCanonicalName\n\nFixes #9963\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>"}, "afterCommit": {"oid": "46759b866caac72669ca9fb6964d4238f079fdca", "author": {"user": {"login": "alexey-anufriev", "name": "Alexey Anufriev"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/46759b866caac72669ca9fb6964d4238f079fdca", "committedDate": "2020-10-26T21:22:29Z", "message": "Cache Class#getSimpleName and Class#getCanonicalName\n\nThis patch introduces cache for Class#getSimpleName and Class#getCanonicalName\n\nFixes #9963\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3Njk1MzIw", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#pullrequestreview-517695320", "createdAt": "2020-10-27T13:22:50Z", "commit": {"oid": "46759b866caac72669ca9fb6964d4238f079fdca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MzA4MTA5", "url": "https://github.com/eclipse-openj9/openj9/pull/10930#pullrequestreview-518308109", "createdAt": "2020-10-28T04:00:19Z", "commit": {"oid": "46759b866caac72669ca9fb6964d4238f079fdca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 226, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}