{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NjgyNDg3", "number": 8804, "title": "Pruning the cards from InterRegionRememberedsets after GMP", "bodyText": "After Global Marking Phase, the cards reference from \"free memory\"\nshould be pruned from InterRegionRememberedsets, in order to\nreuse the free memory in future, currently we have card refresh\nand card pruning in beginning PGC, so piggyback existing logic\nadd extra condition for pruning cards related with \"free memory\"\nin first PGC after GMP.\n\n- During Rememberedsets flush in the beginning PGC(for\ncollection set), extra condition check for dirty card (do not\ndirty card if corresponding MarkMap is 0)\n- During global Rememberedsets prune, extra condition check\nfor pruning the card (do remove the card if corresponding\nMarkMap is 0).\n\ndepends on: eclipse/omr#4928\nfix partial #9247\nSigned-off-by: Lin Hu linhu@ca.ibm.com", "createdAt": "2020-03-09T16:17:11Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8804", "merged": true, "mergeCommit": {"oid": "e18e584ab83f926a9e9e03b63064bf1207dedac2"}, "closed": true, "closedAt": "2020-03-30T13:34:49Z", "author": {"login": "LinHu2016"}, "timelineItems": {"totalCount": 36, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMqj5sAFqTM3Mjk3NDU1Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSumscgFqTM4Mzg1ODI3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyOTc0NTU3", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-372974557", "createdAt": "2020-03-11T17:28:24Z", "commit": {"oid": "7b3c5eb457bbc56786403f5703c09d1d863ad9de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzoyODoyNFrOF1BVbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzoyODoyNFrOF1BVbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0MDcxOA==", "bodyText": "this needs to go to MarkMap class, a helper like:\nbool anyLiveObjectInCard(void *heapAddress);", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r391140718", "createdAt": "2020-03-11T17:28:24Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/CardListFlushTask.cpp", "diffHunk": "@@ -119,8 +122,16 @@ MM_CardListFlushTask::run(MM_EnvironmentBase *envBase)\n \t\t\t\t\t\t/* For Marking purposes we do not need to track references within Collection Set */\n \t\t\t\t\t\tMM_HeapRegionDescriptorVLHGC *referencingRegion = interRegionRememberedSet->tableDescriptorForRememberedSetCard(card);\n \t\t\t\t\t\tif (referencingRegion->containsObjects() && !referencingRegion->_markData._shouldMark) {\n-\t\t\t\t\t\t\tCard *cardAddress = interRegionRememberedSet->rememberedSetCardToCardAddr(env, card);\n-\t\t\t\t\t\t\twriteFlushToCardState(cardAddress, gmpIsActive);\n+\t\t\t\t\t\t\tbool needToFlush = true;\n+\t\t\t\t\t\t\tif (needToCheckMarkMap) {\n+\t\t\t\t\t\t\t\tvoid* heapAddress = convertHeapAddressFromRememberedSetCard(envBase, card);\n+\t\t\t\t\t\t\t\tuint64_t* map4Card = (uint64_t*) &((uintptr_t *)(markMap->getMarkBits()))[markMap->getSlotIndex((omrobjectptr_t) heapAddress)];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b3c5eb457bbc56786403f5703c09d1d863ad9de"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyOTgyMDU4", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-372982058", "createdAt": "2020-03-11T17:37:54Z", "commit": {"oid": "7b3c5eb457bbc56786403f5703c09d1d863ad9de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzozNzo1NFrOF1BvVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzozNzo1NFrOF1BvVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0NzM0OQ==", "bodyText": "interRegionRememberedSet is available. you can use its  convertHeapAddressFromRememberedSetCard(), and no need to clone it in this class", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r391147349", "createdAt": "2020-03-11T17:37:54Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/CardListFlushTask.cpp", "diffHunk": "@@ -119,8 +122,16 @@ MM_CardListFlushTask::run(MM_EnvironmentBase *envBase)\n \t\t\t\t\t\t/* For Marking purposes we do not need to track references within Collection Set */\n \t\t\t\t\t\tMM_HeapRegionDescriptorVLHGC *referencingRegion = interRegionRememberedSet->tableDescriptorForRememberedSetCard(card);\n \t\t\t\t\t\tif (referencingRegion->containsObjects() && !referencingRegion->_markData._shouldMark) {\n-\t\t\t\t\t\t\tCard *cardAddress = interRegionRememberedSet->rememberedSetCardToCardAddr(env, card);\n-\t\t\t\t\t\t\twriteFlushToCardState(cardAddress, gmpIsActive);\n+\t\t\t\t\t\t\tbool needToFlush = true;\n+\t\t\t\t\t\t\tif (needToCheckMarkMap) {\n+\t\t\t\t\t\t\t\tvoid* heapAddress = convertHeapAddressFromRememberedSetCard(envBase, card);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b3c5eb457bbc56786403f5703c09d1d863ad9de"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMDgzOTkw", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-373083990", "createdAt": "2020-03-11T19:59:26Z", "commit": {"oid": "7b3c5eb457bbc56786403f5703c09d1d863ad9de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxOTo1OToyNlrOF1GuLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxOTo1OToyNlrOF1GuLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyODk3NQ==", "bodyText": "The new check is just more generic variant of fromRegion->containsObjects().\nSo I recommend you introduce a helper that will replace that containsObjects() check:\ninline bool IRRS::cardContainsObjects(card, fromRegion,  needToCheckMarkMap) {\nif needToCheckMarkMap\nreturn markMap->anyLiveObjectInCard(card)\nelse\nreturn !fromRegion->containsObjects()\n}", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r391228975", "createdAt": "2020-03-11T19:59:26Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/InterRegionRememberedSet.cpp", "diffHunk": "@@ -935,6 +941,17 @@ MM_InterRegionRememberedSet::clearFromRegionReferencesForMarkDirect(MM_Environme\n \t\t\t\t\tCard * cardAddress = rememberedSetCardToCardAddr(env, card);\n \t\t\t\t\t/* Regions that are completely swept after a GMP, might still have outgoing references (thus we consider empty regions too) */\n \t\t\t\t\tif (fromRegion->_markData._shouldMark  || !fromRegion->containsObjects() || isDirtyCardForPartialCollect(env, cardTable, cardAddress)) {\n+\t\t\t\t\t\tneedToRemove = true;\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tif (!needToRemove && needToCheckMarkMap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b3c5eb457bbc56786403f5703c09d1d863ad9de"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b3c5eb457bbc56786403f5703c09d1d863ad9de", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/7b3c5eb457bbc56786403f5703c09d1d863ad9de", "committedDate": "2020-03-09T16:14:04Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "9469d5ace747b85a9b370457e66208053f3a1d59", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9469d5ace747b85a9b370457e66208053f3a1d59", "committedDate": "2020-03-12T15:04:20Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9469d5ace747b85a9b370457e66208053f3a1d59", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9469d5ace747b85a9b370457e66208053f3a1d59", "committedDate": "2020-03-12T15:04:20Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "adc5735e4622035b7bd5ecdd25e3392e3066b1c2", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/adc5735e4622035b7bd5ecdd25e3392e3066b1c2", "committedDate": "2020-03-12T17:03:13Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adc5735e4622035b7bd5ecdd25e3392e3066b1c2", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/adc5735e4622035b7bd5ecdd25e3392e3066b1c2", "committedDate": "2020-03-12T17:03:13Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "e1a4cd9d5a5b4cf3f2687c3764d6d65d57697ab0", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e1a4cd9d5a5b4cf3f2687c3764d6d65d57697ab0", "committedDate": "2020-03-12T23:23:16Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1a4cd9d5a5b4cf3f2687c3764d6d65d57697ab0", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e1a4cd9d5a5b4cf3f2687c3764d6d65d57697ab0", "committedDate": "2020-03-12T23:23:16Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "32d98bce62a73df49b0ae191247d1ea1c942aebe", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/32d98bce62a73df49b0ae191247d1ea1c942aebe", "committedDate": "2020-03-13T13:29:33Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32d98bce62a73df49b0ae191247d1ea1c942aebe", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/32d98bce62a73df49b0ae191247d1ea1c942aebe", "committedDate": "2020-03-13T13:29:33Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "84d4894bbcf4dded4bde226586d08c3ab67b3bae", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/84d4894bbcf4dded4bde226586d08c3ab67b3bae", "committedDate": "2020-03-18T12:18:24Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84d4894bbcf4dded4bde226586d08c3ab67b3bae", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/84d4894bbcf4dded4bde226586d08c3ab67b3bae", "committedDate": "2020-03-18T12:18:24Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "d1c00abcde57994b48c9266bd003d0f1a7ab19e4", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d1c00abcde57994b48c9266bd003d0f1a7ab19e4", "committedDate": "2020-03-25T12:46:11Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1c00abcde57994b48c9266bd003d0f1a7ab19e4", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d1c00abcde57994b48c9266bd003d0f1a7ab19e4", "committedDate": "2020-03-25T12:46:11Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "b9207f58d20851c4e10b4ba0bb894e1772ddbe5e", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b9207f58d20851c4e10b4ba0bb894e1772ddbe5e", "committedDate": "2020-03-27T14:30:45Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9207f58d20851c4e10b4ba0bb894e1772ddbe5e", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b9207f58d20851c4e10b4ba0bb894e1772ddbe5e", "committedDate": "2020-03-27T14:30:45Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "467ebbca36de9484b336aa88f9e8cf2fb6c570d8", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/467ebbca36de9484b336aa88f9e8cf2fb6c570d8", "committedDate": "2020-03-27T15:34:30Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "467ebbca36de9484b336aa88f9e8cf2fb6c570d8", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/467ebbca36de9484b336aa88f9e8cf2fb6c570d8", "committedDate": "2020-03-27T15:34:30Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "da7c78fa0ed0abd9e4ee9dad1a74cd227e07513e", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/da7c78fa0ed0abd9e4ee9dad1a74cd227e07513e", "committedDate": "2020-03-27T15:50:19Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da7c78fa0ed0abd9e4ee9dad1a74cd227e07513e", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/da7c78fa0ed0abd9e4ee9dad1a74cd227e07513e", "committedDate": "2020-03-27T15:50:19Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "ef2f3c38e06cf5a8a1e1d768eb7e8454d23d69ed", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ef2f3c38e06cf5a8a1e1d768eb7e8454d23d69ed", "committedDate": "2020-03-27T16:23:11Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef2f3c38e06cf5a8a1e1d768eb7e8454d23d69ed", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ef2f3c38e06cf5a8a1e1d768eb7e8454d23d69ed", "committedDate": "2020-03-27T16:23:11Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "499e655d2ea8d8628d9358736e6acf9c02a226a8", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/499e655d2ea8d8628d9358736e6acf9c02a226a8", "committedDate": "2020-03-27T16:49:11Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "499e655d2ea8d8628d9358736e6acf9c02a226a8", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/499e655d2ea8d8628d9358736e6acf9c02a226a8", "committedDate": "2020-03-27T16:49:11Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "47aa9c2b8206c236bc0ae6a33163304151c38295", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/47aa9c2b8206c236bc0ae6a33163304151c38295", "committedDate": "2020-03-27T19:13:40Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTQwODk2", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383140896", "createdAt": "2020-03-27T19:23:19Z", "commit": {"oid": "47aa9c2b8206c236bc0ae6a33163304151c38295"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOToyMzoyMFrOF8-_Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOToyMzoyMFrOF8-_Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MDkwNw==", "bodyText": "no need for needToFlush flag, any more. here, and at a couple of other similar spots.", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399490907", "createdAt": "2020-03-27T19:23:20Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/CardListFlushTask.cpp", "diffHunk": "@@ -118,9 +121,12 @@ MM_CardListFlushTask::run(MM_EnvironmentBase *envBase)\n \t\t\t\t\twhile(0 != (card = rsclCardIterator.nextReferencingCard(env))) {\n \t\t\t\t\t\t/* For Marking purposes we do not need to track references within Collection Set */\n \t\t\t\t\t\tMM_HeapRegionDescriptorVLHGC *referencingRegion = interRegionRememberedSet->tableDescriptorForRememberedSetCard(card);\n-\t\t\t\t\t\tif (referencingRegion->containsObjects() && !referencingRegion->_markData._shouldMark) {\n-\t\t\t\t\t\t\tCard *cardAddress = interRegionRememberedSet->rememberedSetCardToCardAddr(env, card);\n-\t\t\t\t\t\t\twriteFlushToCardState(cardAddress, gmpIsActive);\n+\t\t\t\t\t\tif (interRegionRememberedSet->cardMayContainObjects(card, referencingRegion, needToCheckMarkMap, markMap) && !referencingRegion->_markData._shouldMark) {\n+\t\t\t\t\t\t\tbool needToFlush = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47aa9c2b8206c236bc0ae6a33163304151c38295"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTQxMjMz", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383141233", "createdAt": "2020-03-27T19:23:50Z", "commit": {"oid": "47aa9c2b8206c236bc0ae6a33163304151c38295"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOToyMzo1MFrOF8_AZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOToyMzo1MFrOF8_AZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MTE3NQ==", "bodyText": "no need for needToRemove", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399491175", "createdAt": "2020-03-27T19:23:50Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/InterRegionRememberedSet.cpp", "diffHunk": "@@ -933,8 +936,13 @@ MM_InterRegionRememberedSet::clearFromRegionReferencesForMarkDirect(MM_Environme\n \t\t\t\twhile(0 != (card = rsclCardIterator.nextReferencingCard(env))) {\n \t\t\t\t\tMM_HeapRegionDescriptorVLHGC *fromRegion = tableDescriptorForRememberedSetCard(card);\n \t\t\t\t\tCard * cardAddress = rememberedSetCardToCardAddr(env, card);\n-\t\t\t\t\t/* Regions that are completely swept after a GMP, might still have outgoing references (thus we consider empty regions too) */\n-\t\t\t\t\tif (fromRegion->_markData._shouldMark  || !fromRegion->containsObjects() || isDirtyCardForPartialCollect(env, cardTable, cardAddress)) {\n+\t\t\t\t\t/* Regions that are completely swept after a GMP, might still have outgoing references (thus we consider cardContainsNoObjects) */\n+\t\t\t\t\tif (fromRegion->_markData._shouldMark  || !cardMayContainObjects(card, fromRegion, needToCheckMarkMap, markMap) || isDirtyCardForPartialCollect(env, cardTable, cardAddress)) {\n+\t\t\t\t\t\tneedToRemove = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47aa9c2b8206c236bc0ae6a33163304151c38295"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTQyODI0", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383142824", "createdAt": "2020-03-27T19:26:20Z", "commit": {"oid": "47aa9c2b8206c236bc0ae6a33163304151c38295"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOToyNjoyMFrOF8_FeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOToyNjoyMFrOF8_FeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MjQ3Mw==", "bodyText": "pass compressedCardTable and mark map", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399492473", "createdAt": "2020-03-27T19:26:20Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/InterRegionRememberedSet.hpp", "diffHunk": "@@ -185,8 +189,39 @@ class MM_InterRegionRememberedSet : public MM_BaseVirtual\n \tvoid clearFromRegionReferencesForCompactOptimized(MM_EnvironmentVLHGC* env);\n \tMM_InterRegionRememberedSet(MM_HeapRegionManager *heapRegionManager);\n \t\n+\n+\t/**\n+\t * Helper function isCompressedCardDirtyForPartialCollect\n+\t * extended from compressedCardTable->isCompressedCardDirtyForPartialCollect(), only in case first PGC after GMP, also dirty card if card Contains No Object.\n+\t */\n+\tMMINLINE bool isCompressedCardDirtyForPartialCollect(MM_EnvironmentVLHGC* env, UDATA card, bool needToCheckMarkMap)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47aa9c2b8206c236bc0ae6a33163304151c38295"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47aa9c2b8206c236bc0ae6a33163304151c38295", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/47aa9c2b8206c236bc0ae6a33163304151c38295", "committedDate": "2020-03-27T19:13:40Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "b850c12f0da0158fae7ee8d3272a435c8aef27e9", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b850c12f0da0158fae7ee8d3272a435c8aef27e9", "committedDate": "2020-03-27T19:29:46Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTQ4MTQx", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383148141", "createdAt": "2020-03-27T19:35:02Z", "commit": {"oid": "b850c12f0da0158fae7ee8d3272a435c8aef27e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOTozNTowM1rOF8_W3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOTozNTowM1rOF8_W3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5NjkyNA==", "bodyText": "This whole comment should be updated:\nRegions that are completely swept or parts of regions that are partially swept after a GMP might still have outgoing references. If they are (if they may not contain objects), cards should be removed.", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399496924", "createdAt": "2020-03-27T19:35:03Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/InterRegionRememberedSet.cpp", "diffHunk": "@@ -933,11 +935,12 @@ MM_InterRegionRememberedSet::clearFromRegionReferencesForMarkDirect(MM_Environme\n \t\t\t\twhile(0 != (card = rsclCardIterator.nextReferencingCard(env))) {\n \t\t\t\t\tMM_HeapRegionDescriptorVLHGC *fromRegion = tableDescriptorForRememberedSetCard(card);\n \t\t\t\t\tCard * cardAddress = rememberedSetCardToCardAddr(env, card);\n-\t\t\t\t\t/* Regions that are completely swept after a GMP, might still have outgoing references (thus we consider empty regions too) */\n-\t\t\t\t\tif (fromRegion->_markData._shouldMark  || !fromRegion->containsObjects() || isDirtyCardForPartialCollect(env, cardTable, cardAddress)) {\n+\t\t\t\t\t/* Regions that are completely swept after a GMP, might still have outgoing references (thus we consider cardContainsNoObjects) */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b850c12f0da0158fae7ee8d3272a435c8aef27e9"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b850c12f0da0158fae7ee8d3272a435c8aef27e9", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/b850c12f0da0158fae7ee8d3272a435c8aef27e9", "committedDate": "2020-03-27T19:29:46Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "fe52ec3f97dd2f0da58b89537bfe4cd697266653", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/fe52ec3f97dd2f0da58b89537bfe4cd697266653", "committedDate": "2020-03-27T20:01:27Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe52ec3f97dd2f0da58b89537bfe4cd697266653", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/fe52ec3f97dd2f0da58b89537bfe4cd697266653", "committedDate": "2020-03-27T20:01:27Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "3d321a7c16be5275a8f745a6f623d8febcfa4ea8", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3d321a7c16be5275a8f745a6f623d8febcfa4ea8", "committedDate": "2020-03-27T20:11:58Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTg1NzI2", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383185726", "createdAt": "2020-03-27T20:40:56Z", "commit": {"oid": "3d321a7c16be5275a8f745a6f623d8febcfa4ea8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDo0MDo1NlrOF9BLmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDo0MDo1NlrOF9BLmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyNjgwOQ==", "bodyText": "both helpers could be static (hence saving by not passing implicit 'this' pointer)", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399526809", "createdAt": "2020-03-27T20:40:56Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/InterRegionRememberedSet.hpp", "diffHunk": "@@ -185,8 +189,39 @@ class MM_InterRegionRememberedSet : public MM_BaseVirtual\n \tvoid clearFromRegionReferencesForCompactOptimized(MM_EnvironmentVLHGC* env);\n \tMM_InterRegionRememberedSet(MM_HeapRegionManager *heapRegionManager);\n \t\n+\n+\t/**\n+\t * Helper function isCompressedCardDirtyForPartialCollect\n+\t * extended from compressedCardTable->isCompressedCardDirtyForPartialCollect(), only in case first PGC after GMP, also dirty card if card Contains No Object.\n+\t */\n+\tMMINLINE bool isCompressedCardDirtyForPartialCollect(MM_EnvironmentVLHGC* env, UDATA card, MM_CompressedCardTable *compressedCardTable, bool needToCheckMarkMap, MM_MarkMap *markMap)\n+\t{\n+\t\tvoid* heapAddress = convertHeapAddressFromRememberedSetCard(card);\n+\t\tbool ret = compressedCardTable->isCompressedCardDirtyForPartialCollect(env, heapAddress);\n+\t\tif (!ret && needToCheckMarkMap) {\n+\t\t\tret = markMap->areAnyLiveObjectsInCard(heapAddress);\n+\t\t}\n+\t\treturn ret;\n+\n+\t}\n protected:\n public:\n+\t/**\n+\t * Helper function cardMayContainObjects\n+\t * if this is first PGC after GMP, check if markMap->areAnyLiveObjectsInCard()\n+\t * otherwise check if region->containsObjects()\n+\t */\n+\tMMINLINE bool cardMayContainObjects(UDATA card, MM_HeapRegionDescriptorVLHGC *fromRegion, bool needToCheckMarkMap, MM_MarkMap *markMap)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d321a7c16be5275a8f745a6f623d8febcfa4ea8"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d321a7c16be5275a8f745a6f623d8febcfa4ea8", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3d321a7c16be5275a8f745a6f623d8febcfa4ea8", "committedDate": "2020-03-27T20:11:58Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "e27f867158b68f49d761a544c6ec71897193faa8", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e27f867158b68f49d761a544c6ec71897193faa8", "committedDate": "2020-03-27T20:46:55Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTkwODIz", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383190823", "createdAt": "2020-03-27T20:49:53Z", "commit": {"oid": "e27f867158b68f49d761a544c6ec71897193faa8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDo0OTo1M1rOF9BbWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDo0OTo1M1rOF9BbWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMDg0MQ==", "bodyText": "move open bracket to previous line", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399530841", "createdAt": "2020-03-27T20:49:53Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/CardListFlushTask.cpp", "diffHunk": "@@ -96,6 +97,11 @@ MM_CardListFlushTask::run(MM_EnvironmentBase *envBase)\n {\n \tMM_EnvironmentVLHGC *env = MM_EnvironmentVLHGC::getEnvironment(envBase);\n \tMM_GCExtensions *extensions = MM_GCExtensions::getExtensions(env);\n+\tMM_MarkMap *markMap = NULL;\n+\tif (static_cast<MM_CycleStateVLHGC*>(envBase->_cycleState)->_schedulingDelegate->isFirstPGCAfterGMP())\n+\t{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e27f867158b68f49d761a544c6ec71897193faa8"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTkxMDgx", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383191081", "createdAt": "2020-03-27T20:50:20Z", "commit": {"oid": "e27f867158b68f49d761a544c6ec71897193faa8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDo1MDoyMVrOF9BcIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDo1MDoyMVrOF9BcIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMTA0MA==", "bodyText": "move bracket", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399531040", "createdAt": "2020-03-27T20:50:21Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/InterRegionRememberedSet.cpp", "diffHunk": "@@ -914,7 +913,13 @@ void\n MM_InterRegionRememberedSet::clearFromRegionReferencesForMarkDirect(MM_EnvironmentVLHGC* env)\n {\n \tPORT_ACCESS_FROM_ENVIRONMENT(env);\n-\tMM_CardTable *cardTable = MM_GCExtensions::getExtensions(env)->cardTable;\n+\tMM_GCExtensions *extensions = MM_GCExtensions::getExtensions(env);\n+\tMM_CardTable *cardTable = extensions->cardTable;\n+\tMM_MarkMap *markMap = NULL;\n+\tif (static_cast<MM_CycleStateVLHGC*>(env->_cycleState)->_schedulingDelegate->isFirstPGCAfterGMP())\n+\t{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e27f867158b68f49d761a544c6ec71897193faa8"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTkxMjM2", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383191236", "createdAt": "2020-03-27T20:50:38Z", "commit": {"oid": "e27f867158b68f49d761a544c6ec71897193faa8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDo1MDozOFrOF9Bcng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDo1MDozOFrOF9Bcng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMTE2Ng==", "bodyText": "bracket", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399531166", "createdAt": "2020-03-27T20:50:38Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/InterRegionRememberedSet.cpp", "diffHunk": "@@ -969,8 +975,14 @@ void\n MM_InterRegionRememberedSet::clearFromRegionReferencesForMarkOptimized(MM_EnvironmentVLHGC* env)\n {\n \tPORT_ACCESS_FROM_ENVIRONMENT(env);\n-\tMM_CardTable *cardTable = MM_GCExtensions::getExtensions(env)->cardTable;\n-\tMM_CompressedCardTable *compressedCardTable = MM_GCExtensions::getExtensions(env)->compressedCardTable;\n+\tMM_GCExtensions *extensions = MM_GCExtensions::getExtensions(env);\n+\tMM_CardTable *cardTable = extensions->cardTable;\n+\tMM_CompressedCardTable *compressedCardTable = extensions->compressedCardTable;\n+\tMM_MarkMap *markMap = NULL;\n+\tif (static_cast<MM_CycleStateVLHGC*>(env->_cycleState)->_schedulingDelegate->isFirstPGCAfterGMP())\n+\t{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e27f867158b68f49d761a544c6ec71897193faa8"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMTk1MTcz", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383195173", "createdAt": "2020-03-27T20:57:58Z", "commit": {"oid": "e27f867158b68f49d761a544c6ec71897193faa8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDo1Nzo1OVrOF9Borw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDo1Nzo1OVrOF9Borw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzNDI1NQ==", "bodyText": "comment says 'also dirty card'\ndid you mean 'also remove card'?", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399534255", "createdAt": "2020-03-27T20:57:59Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/InterRegionRememberedSet.hpp", "diffHunk": "@@ -185,8 +189,39 @@ class MM_InterRegionRememberedSet : public MM_BaseVirtual\n \tvoid clearFromRegionReferencesForCompactOptimized(MM_EnvironmentVLHGC* env);\n \tMM_InterRegionRememberedSet(MM_HeapRegionManager *heapRegionManager);\n \t\n+\n+\t/**\n+\t * Helper function isCompressedCardDirtyForPartialCollect\n+\t * extended from compressedCardTable->isCompressedCardDirtyForPartialCollect(), only in case first PGC after GMP, also dirty card if card Contains No Object.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e27f867158b68f49d761a544c6ec71897193faa8"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e27f867158b68f49d761a544c6ec71897193faa8", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e27f867158b68f49d761a544c6ec71897193faa8", "committedDate": "2020-03-27T20:46:55Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "1f047a6939cee98a11905417ca1d4912632995c8", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/1f047a6939cee98a11905417ca1d4912632995c8", "committedDate": "2020-03-27T21:21:25Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjE1MTYy", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383215162", "createdAt": "2020-03-27T21:39:14Z", "commit": {"oid": "1f047a6939cee98a11905417ca1d4912632995c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMTozOToxNFrOF9CoFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMTozOToxNFrOF9CoFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1MDQ4NA==", "bodyText": "add comment:\nTODO: consider incorporating areAnyLiveObjectsInCard info when building Compressed Card Table", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399550484", "createdAt": "2020-03-27T21:39:14Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/InterRegionRememberedSet.hpp", "diffHunk": "@@ -185,8 +189,39 @@ class MM_InterRegionRememberedSet : public MM_BaseVirtual\n \tvoid clearFromRegionReferencesForCompactOptimized(MM_EnvironmentVLHGC* env);\n \tMM_InterRegionRememberedSet(MM_HeapRegionManager *heapRegionManager);\n \t\n+\n+\t/**\n+\t * Helper function isCompressedCardDirtyForPartialCollect\n+\t * extended from compressedCardTable->isCompressedCardDirtyForPartialCollect(), only in case first PGC after GMP, also dirty card if card Contains No Object.\n+\t */\n+\tMMINLINE static bool isCompressedCardDirtyForPartialCollect(MM_EnvironmentVLHGC* env, UDATA card, MM_CompressedCardTable *compressedCardTable, MM_MarkMap *markMap)\n+\t{\n+\t\tvoid* heapAddress = convertHeapAddressFromRememberedSetCard(card);\n+\t\tbool ret = compressedCardTable->isCompressedCardDirtyForPartialCollect(env, heapAddress);\n+\t\tif (!ret && (NULL != markMap)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f047a6939cee98a11905417ca1d4912632995c8"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f047a6939cee98a11905417ca1d4912632995c8", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/1f047a6939cee98a11905417ca1d4912632995c8", "committedDate": "2020-03-27T21:21:25Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "08dd3beeea8fe6ab08abaee6af60ddbd84b3c659", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/08dd3beeea8fe6ab08abaee6af60ddbd84b3c659", "committedDate": "2020-03-27T21:51:51Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08dd3beeea8fe6ab08abaee6af60ddbd84b3c659", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/08dd3beeea8fe6ab08abaee6af60ddbd84b3c659", "committedDate": "2020-03-27T21:51:51Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "81ae862e37e11c6385e18f4fa0c4b65a0186d3f6", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/81ae862e37e11c6385e18f4fa0c4b65a0186d3f6", "committedDate": "2020-03-27T21:58:51Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjMxOTU4", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383231958", "createdAt": "2020-03-27T22:21:38Z", "commit": {"oid": "81ae862e37e11c6385e18f4fa0c4b65a0186d3f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMjoyMTozOFrOF9DeeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMjoyMTozOFrOF9DeeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2NDQwOQ==", "bodyText": "These helpers won't be able to be static, afterall :( . It may work now, but once OMR_GC_FULL_POINTERS is enabled, they will indirectly rely on class member _compressObjectReferences", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399564409", "createdAt": "2020-03-27T22:21:38Z", "author": {"login": "amicic"}, "path": "runtime/gc_vlhgc/InterRegionRememberedSet.hpp", "diffHunk": "@@ -185,14 +189,46 @@ class MM_InterRegionRememberedSet : public MM_BaseVirtual\n \tvoid clearFromRegionReferencesForCompactOptimized(MM_EnvironmentVLHGC* env);\n \tMM_InterRegionRememberedSet(MM_HeapRegionManager *heapRegionManager);\n \t\n+\n+\t/**\n+\t * Helper function isCompressedCardDirtyForPartialCollect\n+\t * extended from compressedCardTable->isCompressedCardDirtyForPartialCollect(), only in case first PGC after GMP, also return as dirty if card Contains No Object.\n+\t */\n+\tMMINLINE static bool isCompressedCardDirtyForPartialCollect(MM_EnvironmentVLHGC* env, UDATA card, MM_CompressedCardTable *compressedCardTable, MM_MarkMap *markMap)\n+\t{\n+\t\tvoid* heapAddress = convertHeapAddressFromRememberedSetCard(card);\n+\t\tbool ret = compressedCardTable->isCompressedCardDirtyForPartialCollect(env, heapAddress);\n+\t\tif (!ret && (NULL != markMap)) {\n+\t\t\t/* TODO: consider incorporating areAnyLiveObjectsInCard info when building CompressedCard */\n+\t\t\tret = !markMap->areAnyLiveObjectsInCard(heapAddress);\n+\t\t}\n+\t\treturn ret;\n+\n+\t}\n protected:\n public:\n+\t/**\n+\t * Helper function cardMayContainObjects\n+\t * if this is first PGC after GMP, check if markMap->areAnyLiveObjectsInCard()\n+\t * otherwise check if region->containsObjects()\n+\t */\n+\tMMINLINE static bool cardMayContainObjects(UDATA card, MM_HeapRegionDescriptorVLHGC *fromRegion, MM_MarkMap *markMap)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81ae862e37e11c6385e18f4fa0c4b65a0186d3f6"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9711af8c1b81fe3972ab2b18d527003a9ec45ce", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c9711af8c1b81fe3972ab2b18d527003a9ec45ce", "committedDate": "2020-03-27T22:31:02Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81ae862e37e11c6385e18f4fa0c4b65a0186d3f6", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/81ae862e37e11c6385e18f4fa0c4b65a0186d3f6", "committedDate": "2020-03-27T21:58:51Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}, "afterCommit": {"oid": "c9711af8c1b81fe3972ab2b18d527003a9ec45ce", "author": {"user": {"login": "LinHu2016", "name": "Lin Hu"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c9711af8c1b81fe3972ab2b18d527003a9ec45ce", "committedDate": "2020-03-27T22:31:02Z", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzODU4Mjc5", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#pullrequestreview-383858279", "createdAt": "2020-03-30T13:34:37Z", "commit": {"oid": "c9711af8c1b81fe3972ab2b18d527003a9ec45ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 432, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}