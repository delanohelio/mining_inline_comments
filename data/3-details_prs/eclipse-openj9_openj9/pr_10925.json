{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MTQ4MzE0", "number": 10925, "title": "Fixes and changes to resolution sequence for unresolved field and virtual calls on Z", "bodyText": "While addressing the suggestions on fixing the GC map issue on Z in #10599, compilation failure while building JDK on Z was introduced. Changes in this PR fixes that in addition switching to OMR::CCData API to allocate the codecache data for this resolution sequence.\nSigned-off-by: Rahil Shah rahil@ca.ibm.com", "createdAt": "2020-10-19T17:32:51Z", "url": "https://github.com/eclipse-openj9/openj9/pull/10925", "merged": true, "mergeCommit": {"oid": "b07aac0788e3ae24d44322bc3fb5b963c5bd957a"}, "closed": true, "closedAt": "2020-10-27T16:49:08Z", "author": {"login": "r30shah"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUItpOgFqTUxMjA1OTQwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWY0ElAFqTUxNzA3MTMyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDU5NDA4", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#pullrequestreview-512059408", "createdAt": "2020-10-19T18:44:43Z", "commit": {"oid": "13a51f6bc611de8e95dcc43b18239f056fdbc616"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODo0NDo0NFrOHkc1vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODo0NDo0NFrOHkc1vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk4MzI5Mw==", "bodyText": "This looks like two lines in one. Can we break them apart?", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#discussion_r507983293", "createdAt": "2020-10-19T18:44:44Z", "author": {"login": "fjeremic"}, "path": "runtime/compiler/z/codegen/J9UnresolvedDataReadOnlySnippet.cpp", "diffHunk": "@@ -105,8 +105,9 @@ J9::Z::UnresolvedDataReadOnlySnippet::emitSnippetBody()\n \n    // Relative address to the start of the mainline resolution\n    intptr_t startResolutionSeqLabelAddr = reinterpret_cast<intptr_t>(startResolveSequenceLabel->getCodeLocation());\n-   TR_ASSERT_FATAL(cg()->canUseRelativeLongInstructions(startResolutionSeqLabelAddr), \"startResolveSequenceLabel [%p] is outside relative immediate range\", startResolutionSeqLabelAddr);*reinterpret_cast<int32_t*>(cursor) = static_cast<int32_t>(startOfResolutionSeqLabelAddr - (intptr_t)helperCallRA);\n+   TR_ASSERT_FATAL(cg()->canUseRelativeLongInstructions(startResolutionSeqLabelAddr), \"startResolveSequenceLabel [%p] is outside relative immediate range\", startResolutionSeqLabelAddr);*reinterpret_cast<int32_t*>(cursor) = static_cast<int32_t>(startResolutionSeqLabelAddr - (intptr_t)helperCallRA);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13a51f6bc611de8e95dcc43b18239f056fdbc616"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c7d856b40056b61d11c59838d21d44dad6005d2", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/4c7d856b40056b61d11c59838d21d44dad6005d2", "committedDate": "2020-10-19T18:50:35Z", "message": "Fix compilation errors in UnresolvedData\n\nWhile fixing gc map issue in the Unresolved Data snippet resolution\ncode, a compilation failure was introduced. This commit fixes that.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "13a51f6bc611de8e95dcc43b18239f056fdbc616", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/13a51f6bc611de8e95dcc43b18239f056fdbc616", "committedDate": "2020-10-19T17:11:58Z", "message": "Use CCData to allocate Unresolved MetaData on Z\n\nFor the unresolved data resolution sequence, use OMR::CCData to allocate\nthe metadata for Snapshot mode.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "e90116d7332681724cdd8aa492ff4522dadd0d6a", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e90116d7332681724cdd8aa492ff4522dadd0d6a", "committedDate": "2020-10-19T18:50:42Z", "message": "Use CCData to allocate Unresolved MetaData on Z\n\nFor the unresolved data resolution sequence, use OMR::CCData to allocate\nthe metadata for Snapshot mode.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDYyOTQ4", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#pullrequestreview-512062948", "createdAt": "2020-10-19T18:49:31Z", "commit": {"oid": "13a51f6bc611de8e95dcc43b18239f056fdbc616"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODo0OTozMVrOHkdA2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODo1MDoyNVrOHkdC2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk4NjEzNg==", "bodyText": "You have to check the result of put() for failure, not get().", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#discussion_r507986136", "createdAt": "2020-10-19T18:49:31Z", "author": {"login": "ymanton"}, "path": "runtime/compiler/z/codegen/J9MemoryReference.cpp", "diffHunk": "@@ -393,8 +397,11 @@ J9::Z::MemoryReference::create(TR::CodeGenerator* cg, TR::Node* node)\n \n       typedef J9::Z::UnresolvedDataReadOnlySnippet::CCUnresolvedData CCUnresolvedData;\n \n-      CCUnresolvedData* ccUnresolvedDataAddress =\n-         reinterpret_cast<J9::Z::UnresolvedDataReadOnlySnippet::CCUnresolvedData*>(cg->allocateCodeMemory(sizeof(CCUnresolvedData), false));\n+      OMR::CCData *codeCacheData = cg->getCodeCache()->manager()->getCodeCacheData();\n+      OMR::CCData::index_t index;\n+      codeCacheData->put(NULL, sizeof(CCUnresolvedData), 8, NULL, index);\n+      \n+      CCUnresolvedData* ccUnresolvedDataAddress = codeCacheData->get<CCUnresolvedData>(index);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13a51f6bc611de8e95dcc43b18239f056fdbc616"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk4NjY0OA==", "bodyText": "Likewise here.", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#discussion_r507986648", "createdAt": "2020-10-19T18:50:25Z", "author": {"login": "ymanton"}, "path": "runtime/compiler/z/codegen/S390PrivateLinkage.cpp", "diffHunk": "@@ -1583,7 +1583,11 @@ J9::Z::PrivateLinkage::buildNoPatchingVirtualDispatchWithResolve(TR::Node *callN\n       int32_t vtableOffset;\n       };\n    \n-   ccResolveVirtualData *ccResolveVirtualDataAddress = reinterpret_cast<ccResolveVirtualData *>(cg()->allocateCodeMemory(sizeof(ccResolveVirtualData), false));\n+   OMR::CCData *codeCacheData = cg()->getCodeCache()->manager()->getCodeCacheData();\n+   OMR::CCData::index_t index;\n+   codeCacheData->put(NULL, sizeof(ccResolveVirtualData), 8, NULL, index);\n+   \n+   ccResolveVirtualData *ccResolveVirtualDataAddress = codeCacheData->get<ccResolveVirtualData>(index);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13a51f6bc611de8e95dcc43b18239f056fdbc616"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e90116d7332681724cdd8aa492ff4522dadd0d6a", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e90116d7332681724cdd8aa492ff4522dadd0d6a", "committedDate": "2020-10-19T18:50:42Z", "message": "Use CCData to allocate Unresolved MetaData on Z\n\nFor the unresolved data resolution sequence, use OMR::CCData to allocate\nthe metadata for Snapshot mode.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "69c427858ff45f769e7f9831d4e4777159a0a758", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/69c427858ff45f769e7f9831d4e4777159a0a758", "committedDate": "2020-10-19T18:58:09Z", "message": "Use CCData to allocate Unresolved MetaData on Z\n\nFor the unresolved data resolution sequence, use OMR::CCData to allocate\nthe metadata for Snapshot mode.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d6e74fa87fdeafa1d06eccd29451578d147ee60", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5d6e74fa87fdeafa1d06eccd29451578d147ee60", "committedDate": "2020-10-19T19:01:16Z", "message": "Use CCData to allocate a resolveVirtualData on Z\n\nFor the SnapShot mode, use OMR::CCData to allocate the meta data for\nresolution of virtual calls.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69c427858ff45f769e7f9831d4e4777159a0a758", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/69c427858ff45f769e7f9831d4e4777159a0a758", "committedDate": "2020-10-19T18:58:09Z", "message": "Use CCData to allocate Unresolved MetaData on Z\n\nFor the unresolved data resolution sequence, use OMR::CCData to allocate\nthe metadata for Snapshot mode.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "e6572d23ab0cf110a98cc239bea656e8aa8729ec", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e6572d23ab0cf110a98cc239bea656e8aa8729ec", "committedDate": "2020-10-19T19:01:27Z", "message": "Use CCData to allocate Unresolved MetaData on Z\n\nFor the unresolved data resolution sequence, use OMR::CCData to allocate\nthe metadata for Snapshot mode.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>\nHH"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDgzMjU2", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#pullrequestreview-512083256", "createdAt": "2020-10-19T19:16:12Z", "commit": {"oid": "e6572d23ab0cf110a98cc239bea656e8aa8729ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDUwMjAx", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#pullrequestreview-517050201", "createdAt": "2020-10-26T18:10:27Z", "commit": {"oid": "e6572d23ab0cf110a98cc239bea656e8aa8729ec"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODoxMDoyN1rOHocTmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxODoxMzozMFrOHocaSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE2ODg1OQ==", "bodyText": "New typo: uVdnresolved", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#discussion_r512168859", "createdAt": "2020-10-26T18:10:27Z", "author": {"login": "ymanton"}, "path": "runtime/compiler/z/codegen/J9MemoryReference.cpp", "diffHunk": "@@ -393,14 +397,15 @@ J9::Z::MemoryReference::create(TR::CodeGenerator* cg, TR::Node* node)\n \n       typedef J9::Z::UnresolvedDataReadOnlySnippet::CCUnresolvedData CCUnresolvedData;\n \n-      CCUnresolvedData* ccUnresolvedDataAddress =\n-         reinterpret_cast<J9::Z::UnresolvedDataReadOnlySnippet::CCUnresolvedData*>(cg->allocateCodeMemory(sizeof(CCUnresolvedData), false));\n-\n-      if (ccUnresolvedDataAddress == NULL)\n+      OMR::CCData *codeCacheData = cg->getCodeCache()->manager()->getCodeCacheData();\n+      OMR::CCData::index_t index;\n+      if (!(codeCacheData->put(NULL, sizeof(CCUnresolvedData), 8, NULL, index)))\n          {\n-         comp->failCompilation<TR::CompilationException>(\"Could not allocate unresolved data metadata\");\n+         comp->failCompilation<TR::CompilationException>(\"Could not allocate uVdnresolved data metadata\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6572d23ab0cf110a98cc239bea656e8aa8729ec"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE2OTM3OQ==", "bodyText": "Existing typo: resovle", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#discussion_r512169379", "createdAt": "2020-10-26T18:11:23Z", "author": {"login": "ymanton"}, "path": "runtime/compiler/z/codegen/S390PrivateLinkage.cpp", "diffHunk": "@@ -1583,12 +1583,14 @@ J9::Z::PrivateLinkage::buildNoPatchingVirtualDispatchWithResolve(TR::Node *callN\n       int32_t vtableOffset;\n       };\n    \n-   ccResolveVirtualData *ccResolveVirtualDataAddress = reinterpret_cast<ccResolveVirtualData *>(cg()->allocateCodeMemory(sizeof(ccResolveVirtualData), false));\n-\n-   if (!ccResolveVirtualDataAddress)\n+   OMR::CCData *codeCacheData = cg()->getCodeCache()->manager()->getCodeCacheData();\n+   OMR::CCData::index_t index;\n+   if (!(codeCacheData->put(NULL, sizeof(ccResolveVirtualData), 8, NULL, index)))\n       {\n       comp()->failCompilation<TR::CompilationException>(\"Could not allocate resovle virtual dispatch metadata\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6572d23ab0cf110a98cc239bea656e8aa8729ec"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3MDM2NQ==", "bodyText": "Rather than hardcoding 8 here would alignof(CCUnresolvedData) be better?", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#discussion_r512170365", "createdAt": "2020-10-26T18:13:08Z", "author": {"login": "ymanton"}, "path": "runtime/compiler/z/codegen/J9MemoryReference.cpp", "diffHunk": "@@ -393,14 +397,15 @@ J9::Z::MemoryReference::create(TR::CodeGenerator* cg, TR::Node* node)\n \n       typedef J9::Z::UnresolvedDataReadOnlySnippet::CCUnresolvedData CCUnresolvedData;\n \n-      CCUnresolvedData* ccUnresolvedDataAddress =\n-         reinterpret_cast<J9::Z::UnresolvedDataReadOnlySnippet::CCUnresolvedData*>(cg->allocateCodeMemory(sizeof(CCUnresolvedData), false));\n-\n-      if (ccUnresolvedDataAddress == NULL)\n+      OMR::CCData *codeCacheData = cg->getCodeCache()->manager()->getCodeCacheData();\n+      OMR::CCData::index_t index;\n+      if (!(codeCacheData->put(NULL, sizeof(CCUnresolvedData), 8, NULL, index)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6572d23ab0cf110a98cc239bea656e8aa8729ec"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3MDU2OQ==", "bodyText": "Likewise here, alignof(CCUnresolvedData) rather than 8?", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#discussion_r512170569", "createdAt": "2020-10-26T18:13:30Z", "author": {"login": "ymanton"}, "path": "runtime/compiler/z/codegen/S390PrivateLinkage.cpp", "diffHunk": "@@ -1583,12 +1583,14 @@ J9::Z::PrivateLinkage::buildNoPatchingVirtualDispatchWithResolve(TR::Node *callN\n       int32_t vtableOffset;\n       };\n    \n-   ccResolveVirtualData *ccResolveVirtualDataAddress = reinterpret_cast<ccResolveVirtualData *>(cg()->allocateCodeMemory(sizeof(ccResolveVirtualData), false));\n-\n-   if (!ccResolveVirtualDataAddress)\n+   OMR::CCData *codeCacheData = cg()->getCodeCache()->manager()->getCodeCacheData();\n+   OMR::CCData::index_t index;\n+   if (!(codeCacheData->put(NULL, sizeof(ccResolveVirtualData), 8, NULL, index)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6572d23ab0cf110a98cc239bea656e8aa8729ec"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d1fee3c7c3d3066a711500dc5c93851f9df074c", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/6d1fee3c7c3d3066a711500dc5c93851f9df074c", "committedDate": "2020-10-26T18:27:42Z", "message": "Use CCData to allocate Unresolved MetaData on Z\n\nFor the unresolved data resolution sequence, use OMR::CCData to allocate\nthe metadata for Snapshot mode.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6572d23ab0cf110a98cc239bea656e8aa8729ec", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e6572d23ab0cf110a98cc239bea656e8aa8729ec", "committedDate": "2020-10-19T19:01:27Z", "message": "Use CCData to allocate Unresolved MetaData on Z\n\nFor the unresolved data resolution sequence, use OMR::CCData to allocate\nthe metadata for Snapshot mode.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>\nHH"}, "afterCommit": {"oid": "6d1fee3c7c3d3066a711500dc5c93851f9df074c", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/6d1fee3c7c3d3066a711500dc5c93851f9df074c", "committedDate": "2020-10-26T18:27:42Z", "message": "Use CCData to allocate Unresolved MetaData on Z\n\nFor the unresolved data resolution sequence, use OMR::CCData to allocate\nthe metadata for Snapshot mode.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDcxMzIz", "url": "https://github.com/eclipse-openj9/openj9/pull/10925#pullrequestreview-517071323", "createdAt": "2020-10-26T18:38:10Z", "commit": {"oid": "6d1fee3c7c3d3066a711500dc5c93851f9df074c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 217, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}