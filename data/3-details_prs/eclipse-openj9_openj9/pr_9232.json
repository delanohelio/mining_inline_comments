{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyODY5NTU3", "number": 9232, "title": "Set java.base module for anonymous classes loaded at bootup stage", "bodyText": "Set java.base module for anonymous classes loaded at bootup stage\nFor those anonymous classes loaded before the module java.base is created, set java.base module for such classes when java.base is just created.\nNote: This issue described in #9183 can be demonstrated by making modification in java.lang.ClassLoader.java.\nAdd a helper method:\n\tprotected static byte[] createDummyClass(String packageName) {\n\t\tClassWriter cw = new ClassWriter(0);\n\t\tMethodVisitor mv = null;\n\t\tString className = \"DummyClass\";\n\t\tif (packageName != null) {\n\t\t\tclassName = packageName + \"/\" + className;\n\t\t}\n\t\tcw.visit(52, ACC_PUBLIC, className, null, \"java/lang/Object\", null);\n\t\tmv = cw.visitMethod(ACC_PUBLIC, \"bar\", \"()V\", null, null);\n\t\tmv.visitCode();\n\t\tmv.visitInsn(RETURN);\n\t\tmv.visitMaxs(2, 1);\n\t\tmv.visitEnd();\n\t\tcw.visitEnd();\n\t\treturn cw.toByteArray();\n\t}\n\nPut following code right before https://github.com/eclipse/openj9/blob/ea159ff8388e3d2ea0d65c56fdac047d8035085b/jcl/src/java.base/share/classes/java/lang/ClassLoader.java#L294\n\tbyte[] bytes = createDummyClass(null);\n\tClass<?> anon = Unsafe.getUnsafe().defineAnonymousClass(Object.class, bytes, null);\t\t\n\tbytes = createDummyClass(\"java/lang\");\n\tanon = Unsafe.getUnsafe().defineAnonymousClass(Object.class, bytes, null);\n\nThese anonymous classes are loaded by vm->anonClassLoader and the module field in these class objects are null.\nThis PR sets java.base module for those class objects.\nTested in a personal build (JDK 8/11 xa64).\ncloses: #9183\nReviewer: @DanHeidinga\nSigned-off-by: Jason Feng fengj@ca.ibm.com", "createdAt": "2020-04-13T22:21:07Z", "url": "https://github.com/eclipse-openj9/openj9/pull/9232", "merged": true, "mergeCommit": {"oid": "ce88e19854cf4615f8da2a993ebe8f6607828afb"}, "closed": true, "closedAt": "2020-04-21T14:45:54Z", "author": {"login": "JasonFengJ9"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXnjJvAFqTM5MzE3NTA4Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXo8pRgFqTM5MzI0MzczNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMTc1MDg3", "url": "https://github.com/eclipse-openj9/openj9/pull/9232#pullrequestreview-393175087", "createdAt": "2020-04-14T18:10:26Z", "commit": {"oid": "f58a6594350e6f6e01e15947a0598988a21c7e66"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxODoxMDoyNlrOGFa5sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxODoxMDoyNlrOGFa5sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMzNjgxNw==", "bodyText": "I'd like to only do this second walk only if anon classes have been created.  We can check:\nif (vm->anonClassCount > 0) {\n   ......\n}\n\nand the locals related to this can be moved into this scope.", "url": "https://github.com/eclipse-openj9/openj9/pull/9232#discussion_r408336817", "createdAt": "2020-04-14T18:10:26Z", "author": {"login": "DanHeidinga"}, "path": "runtime/j9vm/java11vmi.c", "diffHunk": "@@ -810,6 +812,16 @@ JVM_DefineModule(JNIEnv * env, jobject module, jboolean isOpen, jstring version,\n \t\t\t\t\t\t\t\tclazz = vmFuncs->allClassesNextDo(&classWalkState);\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t\tvmFuncs->allClassesEndDo(&classWalkState);\n+\n+\t\t\t\t\t\t\tAssert_SC_notNull(vm->anonClassLoader);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f58a6594350e6f6e01e15947a0598988a21c7e66"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "092753224bdfdd31a8aac70b10d869465248fa46", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/092753224bdfdd31a8aac70b10d869465248fa46", "committedDate": "2020-04-14T19:07:56Z", "message": "Set java.base module for anonymous classes loaded at bootup stage\n\nFor those anonymous classes loaded before the module java.base is\ncreated, set java.base module for such classes when java.base is being\ncreated.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f58a6594350e6f6e01e15947a0598988a21c7e66", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f58a6594350e6f6e01e15947a0598988a21c7e66", "committedDate": "2020-04-13T16:56:01Z", "message": "Set java.base module for anonymous classes loaded at bootup stage\n\nFor those anonymous classes loaded before the module java.base is\ncreated, set java.base module for such classes when java.base is being\ncreated.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}, "afterCommit": {"oid": "092753224bdfdd31a8aac70b10d869465248fa46", "author": {"user": {"login": "JasonFengJ9", "name": "Jason Feng"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/092753224bdfdd31a8aac70b10d869465248fa46", "committedDate": "2020-04-14T19:07:56Z", "message": "Set java.base module for anonymous classes loaded at bootup stage\n\nFor those anonymous classes loaded before the module java.base is\ncreated, set java.base module for such classes when java.base is being\ncreated.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjQzNzM3", "url": "https://github.com/eclipse-openj9/openj9/pull/9232#pullrequestreview-393243737", "createdAt": "2020-04-14T19:48:47Z", "commit": {"oid": "092753224bdfdd31a8aac70b10d869465248fa46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1258, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}