{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NDM2NTg2", "number": 8651, "title": "AArch64: Implement Nestmate interface call", "bodyText": "This commit implements Nestmate interface call for AArch64.\nSigned-off-by: KONNO Kazuhiro konno@jp.ibm.com", "createdAt": "2020-02-25T08:33:59Z", "url": "https://github.com/eclipse-openj9/openj9/pull/8651", "merged": true, "mergeCommit": {"oid": "5e635eec7669587af9d10f18b8c3f1364a7b0548"}, "closed": true, "closedAt": "2020-03-13T03:09:56Z", "author": {"login": "knn-k"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJ-X6ZABqjMwOTExOTA1OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNHeNnAFqTM3NDAyNjMyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e74f1e4aebc1bffddd1791d257c49b5d023dc39", "author": {"user": {"login": "knn-k", "name": "KONNO Kazuhiro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/0e74f1e4aebc1bffddd1791d257c49b5d023dc39", "committedDate": "2020-02-25T08:32:00Z", "message": "AArch64: Implement Nestmate interface call\n\nThis commit implements Nestmate interface call for AArch64.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>"}, "afterCommit": {"oid": "2d82cf87a9b31af42b22265de7de845b805466ba", "author": {"user": {"login": "knn-k", "name": "KONNO Kazuhiro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2d82cf87a9b31af42b22265de7de845b805466ba", "committedDate": "2020-03-03T08:50:35Z", "message": "AArch64: Implement Nestmate interface call\n\nThis commit implements Nestmate interface call for AArch64.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNDE5NTk2", "url": "https://github.com/eclipse-openj9/openj9/pull/8651#pullrequestreview-372419596", "createdAt": "2020-03-11T01:13:44Z", "commit": {"oid": "2d82cf87a9b31af42b22265de7de845b805466ba"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwMToxMzo0NFrOF0mOZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwMToxOTowMFrOF0mTBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY5NjU0OA==", "bodyText": "This was already defined on L114.  Should be J9TR_ICSnippet_TargetAddr2?", "url": "https://github.com/eclipse-openj9/openj9/pull/8651#discussion_r390696548", "createdAt": "2020-03-11T01:13:44Z", "author": {"login": "0xdaryl"}, "path": "runtime/compiler/aarch64/runtime/PicBuilder.spp", "diffHunk": "@@ -108,7 +109,12 @@\n \t.set\tJ9TR_UICSnippet_CP,\t\t8\n \t.set\tJ9TR_UICSnippet_CPIndex,\t16\n \t.set\tJ9TR_ICSnippet_InterfaceClass,\t24\n-\t.set\tJ9TR_ICSnippet_MethodIndex,\t32\n+\t.set\tJ9TR_ICSnippet_ITableIndex,\t32\n+\t.set\tJ9TR_ICSnippet_Class1,\t\t40\n+\t.set\tJ9TR_ICSnippet_TargetAddr1,\t48\n+\t.set\tJ9TR_ICSnippet_Class2,\t\t56\n+\t.set\tJ9TR_ICSnippet_TargetAddr1,\t64", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d82cf87a9b31af42b22265de7de845b805466ba"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY5NzczNA==", "bodyText": "What is the purpose of these fields?  Are they for building an interface PIC?  If I understand the code in this PR correctly, they are introduced but not used in this PR.  I would say your commit message should at least comment on the fact that you're introducing them here, but the actual PIC mechanics will be completed later.", "url": "https://github.com/eclipse-openj9/openj9/pull/8651#discussion_r390697734", "createdAt": "2020-03-11T01:19:00Z", "author": {"login": "0xdaryl"}, "path": "runtime/compiler/aarch64/codegen/CallSnippet.cpp", "diffHunk": "@@ -508,44 +508,97 @@ uint32_t TR::ARM64VirtualUnresolvedSnippet::getLength(int32_t estimatedSnippetSt\n \n uint8_t *TR::ARM64InterfaceCallSnippet::emitSnippetBody()\n    {\n+   TR::Compilation *comp = cg()->comp();\n    uint8_t *cursor = cg()->getBinaryBufferCursor();\n+   TR::Node *callNode = getNode();\n    TR::SymbolReference *methodSymRef = getNode()->getSymbolReference();\n    TR::SymbolReference *glueRef = cg()->symRefTab()->findOrCreateRuntimeHelper(TR_ARM64interfaceCallHelper, false, false, false);\n+   TR_J9VMBase *fej9 = (TR_J9VMBase *)(comp->fe());\n+   void* thunk = fej9->getJ2IThunk(callNode->getSymbolReference()->getSymbol()->castToMethodSymbol()->getMethod(), comp);\n \n    getSnippetLabel()->setCodeLocation(cursor);\n \n    // bl glueRef\n-   *(int32_t *)cursor = cg()->encodeHelperBranchAndLink(glueRef, cursor, getNode());\n-   cursor += 4;\n+   *(int32_t *)cursor = cg()->encodeHelperBranchAndLink(glueRef, cursor, callNode);\n+   uint8_t *blAddress = cursor;\n+   cursor += ARM64_INSTRUCTION_LENGTH;\n \n    // Store the code cache RA\n    *(intptrj_t *)cursor = (intptrj_t)getReturnLabel()->getCodeLocation();\n    cg()->addExternalRelocation(new (cg()->trHeapMemory()) TR::ExternalRelocation(\n                                cursor,\n                                NULL,\n                                TR_AbsoluteMethodAddress, cg()),\n-                               __FILE__, __LINE__, getNode());\n-   cursor += 8;\n+                               __FILE__, __LINE__, callNode);\n+   cursor += sizeof(intptrj_t);\n \n    // CP\n-   *(intptrj_t *)cursor = (intptrj_t)methodSymRef->getOwningMethod(cg()->comp())->constantPool();\n-   cg()->addExternalRelocation(new (cg()->trHeapMemory()) TR::ExternalRelocation(\n-                               cursor,\n-                               *(uint8_t **)cursor,\n-                               getNode() ? (uint8_t *)getNode()->getInlinedSiteIndex() : (uint8_t *)-1,\n-                               TR_Thunks, cg()),\n-                               __FILE__, __LINE__, getNode());\n-   cursor += 8;\n+   intptrj_t cpAddr = (intptrj_t)methodSymRef->getOwningMethod(comp)->constantPool();\n+   *(intptrj_t *)cursor = cpAddr;\n+   uint8_t *j2iThunkRelocationPoint = cursor;\n+   cursor += sizeof(intptrj_t);\n \n    // CP index\n    *(intptrj_t *)cursor = methodSymRef->getCPIndexForVM();\n-   cursor += 8;\n+   cursor += sizeof(intptrj_t);\n \n-   // Add 2 more slots for resolved values (interface class and iTable offset)\n+   // 2 slots for resolved values (interface class and iTable index)\n    *(intptrj_t *)cursor = 0;\n-   cursor += 8;\n+   cursor += sizeof(intptrj_t);\n    *(intptrj_t *)cursor = 0;\n-   cursor += 8;\n+   cursor += sizeof(intptrj_t);\n+\n+   // Initialize for: two class ptrs, two target addrs\n+   // Initialize target addrs with the address of the bl\n+   *(intptrj_t *)cursor = -1;\n+   *(intptrj_t *)(cursor+sizeof(intptrj_t)) = (intptrj_t)blAddress;\n+   *(intptrj_t *)(cursor+2*sizeof(intptrj_t)) = -1;\n+   *(intptrj_t *)(cursor+3*sizeof(intptrj_t)) = (intptrj_t)blAddress;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d82cf87a9b31af42b22265de7de845b805466ba"}, "originalPosition": 65}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d82cf87a9b31af42b22265de7de845b805466ba", "author": {"user": {"login": "knn-k", "name": "KONNO Kazuhiro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2d82cf87a9b31af42b22265de7de845b805466ba", "committedDate": "2020-03-03T08:50:35Z", "message": "AArch64: Implement Nestmate interface call\n\nThis commit implements Nestmate interface call for AArch64.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>"}, "afterCommit": {"oid": "36a253eed6ed652ad886dc234e942b7760147bc0", "author": {"user": {"login": "knn-k", "name": "KONNO Kazuhiro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/36a253eed6ed652ad886dc234e942b7760147bc0", "committedDate": "2020-03-12T00:01:59Z", "message": "AArch64: Implement Nestmate interface call\n\nThis commit implements Nestmate interface call for AArch64.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9cbb0039a73a8678f16b17ab6e144a32598dd49", "author": {"user": {"login": "knn-k", "name": "KONNO Kazuhiro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f9cbb0039a73a8678f16b17ab6e144a32598dd49", "committedDate": "2020-03-12T23:29:59Z", "message": "AArch64: Implement Nestmate interface call\n\nThis commit implements Nestmate interface call for AArch64.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36a253eed6ed652ad886dc234e942b7760147bc0", "author": {"user": {"login": "knn-k", "name": "KONNO Kazuhiro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/36a253eed6ed652ad886dc234e942b7760147bc0", "committedDate": "2020-03-12T00:01:59Z", "message": "AArch64: Implement Nestmate interface call\n\nThis commit implements Nestmate interface call for AArch64.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>"}, "afterCommit": {"oid": "f9cbb0039a73a8678f16b17ab6e144a32598dd49", "author": {"user": {"login": "knn-k", "name": "KONNO Kazuhiro"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f9cbb0039a73a8678f16b17ab6e144a32598dd49", "committedDate": "2020-03-12T23:29:59Z", "message": "AArch64: Implement Nestmate interface call\n\nThis commit implements Nestmate interface call for AArch64.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MDI2MzI1", "url": "https://github.com/eclipse-openj9/openj9/pull/8651#pullrequestreview-374026325", "createdAt": "2020-03-13T03:09:26Z", "commit": {"oid": "f9cbb0039a73a8678f16b17ab6e144a32598dd49"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 593, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}