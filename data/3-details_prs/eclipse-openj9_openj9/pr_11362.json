{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMTc1OTc5", "number": 11362, "title": "Make ROMClass walkers in DDR and VM consistent", "bodyText": "This PR updates DDR ROMClass walker to match recent changes in the other ROMClass walker (the one used by VM code and cfdumper) in #11330:\n\nMethod parameter names are handled as UTF8 strings rather than raw SRPs.\nStrings in method debug info are visited as SRPs rather than direct pointers to J9UTF8.\n\nNote: this PR should be merged after #11330.", "createdAt": "2020-12-03T23:05:20Z", "url": "https://github.com/eclipse-openj9/openj9/pull/11362", "merged": true, "mergeCommit": {"oid": "fb38837fd10608076932e6eac995b446af79165f"}, "closed": true, "closedAt": "2021-01-29T01:53:54Z", "author": {"login": "AlexeyKhrabrov"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdirtrKABqjQwNzAyNjAwNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd0vYeTAFqTU3ODg4NDQ2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19593244bcf87e02f7f2777a7cb3a52692fdf217", "author": {"user": {"login": "AlexeyKhrabrov", "name": "Alexey Khrabrov"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/19593244bcf87e02f7f2777a7cb3a52692fdf217", "committedDate": "2020-12-03T22:55:10Z", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>"}, "afterCommit": {"oid": "ff7e35533ffdd4b3a35ce62c04cb180e0d836231", "author": {"user": {"login": "AlexeyKhrabrov", "name": "Alexey Khrabrov"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ff7e35533ffdd4b3a35ce62c04cb180e0d836231", "committedDate": "2020-12-03T23:26:10Z", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23e2ca0c06221110f44edc2e772a7d3946e836b4", "author": {"user": {"login": "AlexeyKhrabrov", "name": "Alexey Khrabrov"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/23e2ca0c06221110f44edc2e772a7d3946e836b4", "committedDate": "2021-01-20T21:47:45Z", "message": "Fix slot type for method parameter name in DDR ROMClass walker\n\nHandle method parameter names as UTF8 strings rather than raw SRPs.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff7e35533ffdd4b3a35ce62c04cb180e0d836231", "author": {"user": {"login": "AlexeyKhrabrov", "name": "Alexey Khrabrov"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ff7e35533ffdd4b3a35ce62c04cb180e0d836231", "committedDate": "2020-12-03T23:26:10Z", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>"}, "afterCommit": {"oid": "d474a449a6b198b782cb5d1ff1b3c42f661d1b2f", "author": {"user": {"login": "AlexeyKhrabrov", "name": "Alexey Khrabrov"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d474a449a6b198b782cb5d1ff1b3c42f661d1b2f", "committedDate": "2021-01-20T21:47:45Z", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczNDI0MTU1", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#pullrequestreview-573424155", "createdAt": "2021-01-21T15:07:19Z", "commit": {"oid": "d474a449a6b198b782cb5d1ff1b3c42f661d1b2f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMVQxNTowNzoyMFrOIX68-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMVQxNToxOTozMFrOIX7jPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTk1NDA0Mg==", "bodyText": "These address calculations are wrong for older core files (e.g. there's no nameSrp field to skip past).\nThis will require an update to VM_LOCAL_VARIABLE_TABLE_VERSION so we can interpret new and old core files correctly: #11330 should not have been merged without that.", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r561954042", "createdAt": "2021-01-21T15:07:20Z", "author": {"login": "keithc-ca"}, "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/walkers/LocalVariableTableIterator.java", "diffHunk": "@@ -139,16 +142,21 @@ public LocalVariableTable next() {\n \t\t\t\t} else {\n \t\t\t\t\treturn null;\n \t\t\t\t}\n+\n+\t\t\t\tnameSrp = SelfRelativePointer.cast(localVariableTablePtr);\n \t\t\t\tname = J9UTF8Pointer.cast(SelfRelativePointer.cast(localVariableTablePtr).get());\n \t\t\t\tlocalVariableTablePtr = localVariableTablePtr.add(SelfRelativePointer.SIZEOF);\n-\t\t\t\t\n+\n+\t\t\t\tsignatureSrp = SelfRelativePointer.cast(localVariableTablePtr);\n \t\t\t\tsignature = J9UTF8Pointer.cast(SelfRelativePointer.cast(localVariableTablePtr).get());\n \t\t\t\tlocalVariableTablePtr = localVariableTablePtr.add(SelfRelativePointer.SIZEOF);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d474a449a6b198b782cb5d1ff1b3c42f661d1b2f"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTk2MzgzOA==", "bodyText": "The string literals should correspond to the structure field names (i.e. \"name\" & \"signature\").", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r561963838", "createdAt": "2021-01-21T15:19:30Z", "author": {"login": "keithc-ca"}, "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -1054,10 +1055,10 @@ long allSlotsInMethodDebugInfoDo(U32Pointer cursor) throws CorruptDataException\n \t\t\t\tLocalVariableTable values = variableInfoValuesIterator.next();\n \n \t\t\t\t// Need to walk the name and signature to add them to the UTF8 section\n-\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_UTF8, values.getName(), \"name\");\n-\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_UTF8, values.getSignature(), \"getSignature\");\n+\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, values.getNameSrp(), \"variableName\");\n+\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, values.getSignatureSrp(), \"variableSignature\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d474a449a6b198b782cb5d1ff1b3c42f661d1b2f"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d474a449a6b198b782cb5d1ff1b3c42f661d1b2f", "author": {"user": {"login": "AlexeyKhrabrov", "name": "Alexey Khrabrov"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d474a449a6b198b782cb5d1ff1b3c42f661d1b2f", "committedDate": "2021-01-20T21:47:45Z", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>"}, "afterCommit": {"oid": "adbc5aa027ce6aebd657d7d488bad647b15b8119", "author": {"user": {"login": "AlexeyKhrabrov", "name": "Alexey Khrabrov"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/adbc5aa027ce6aebd657d7d488bad647b15b8119", "committedDate": "2021-01-21T19:35:17Z", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc2NDc0NjA2", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#pullrequestreview-576474606", "createdAt": "2021-01-26T15:36:58Z", "commit": {"oid": "adbc5aa027ce6aebd657d7d488bad647b15b8119"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQxNTozNjo1OVrOIac6nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQxNTo1MDoyM1rOIadnUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDYwNzY0Nw==", "bodyText": "This can now be simplified:\nname = J9UTF8Pointer.cast(nameSrp.get());\n\nLikewise, for signature and genericSignature.", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r564607647", "createdAt": "2021-01-26T15:36:59Z", "author": {"login": "keithc-ca"}, "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/walkers/LocalVariableTableIterator.java", "diffHunk": "@@ -139,16 +142,21 @@ public LocalVariableTable next() {\n \t\t\t\t} else {\n \t\t\t\t\treturn null;\n \t\t\t\t}\n+\n+\t\t\t\tnameSrp = SelfRelativePointer.cast(localVariableTablePtr);\n \t\t\t\tname = J9UTF8Pointer.cast(SelfRelativePointer.cast(localVariableTablePtr).get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adbc5aa027ce6aebd657d7d488bad647b15b8119"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDYxNjc2OA==", "bodyText": "I think this should use J9_UTF8 to benefit from the extra sanity checking in LinearDumper.java.", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r564616768", "createdAt": "2021-01-26T15:47:47Z", "author": {"login": "keithc-ca"}, "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -297,38 +297,38 @@ private J9ROMMethodPointer allSlotsInROMMethodDo(J9ROMMethodPointer method) thro\n \n \t\treturn J9ROMMethodPointer.cast(cursor);\n \t}\n-\t\n+\n \tprivate long allSlotsInMethodParametersDataDo(U32Pointer cursor) throws CorruptDataException\n \t{\n \t\tJ9MethodParametersDataPointer methodParametersData = J9MethodParametersDataPointer.cast(cursor);\n \t\tJ9MethodParameterPointer parameters = methodParametersData.parameters();\n \t\tlong methodParametersSize = ROMHelp.J9_METHOD_PARAMS_SIZE_FROM_NUMBER_OF_PARAMS(methodParametersData.parameterCount().longValue());\n \t\tlong padding = U32.SIZEOF - (methodParametersSize % U32.SIZEOF);\n \t\tlong size = 0;\n-\t\t\n+\n \t\tif (padding == U32.SIZEOF) {\n \t\t\tpadding = 0;\n \t\t}\n-\t\t\n+\n \t\tsize = methodParametersSize + padding;\n-\t\t\n+\n \t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_SRP, methodParametersData.parameterCountEA(), \"parameterCount\");\n-\t\t\n+\n \t\tfor (int i = 0; i < methodParametersData.parameterCount().longValue(); i++) {\n-\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_SRP, parameters.nameEA(), \"methodParameterName\");\n-\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_U16, parameters.flagsEA(), \"methodParameterFlag\");\t\t\t\n+\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, parameters.nameEA(), \"methodParameterName\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adbc5aa027ce6aebd657d7d488bad647b15b8119"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDYxOTA5MA==", "bodyText": "I think these should continue to use J9_UTF8 to benefit from the extra sanity checking in LinearDumper.java.\nThe corresponding arguments (getNameSrp(), etc. are correct).", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#discussion_r564619090", "createdAt": "2021-01-26T15:50:23Z", "author": {"login": "keithc-ca"}, "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -1054,10 +1055,10 @@ long allSlotsInMethodDebugInfoDo(U32Pointer cursor) throws CorruptDataException\n \t\t\t\tLocalVariableTable values = variableInfoValuesIterator.next();\n \n \t\t\t\t// Need to walk the name and signature to add them to the UTF8 section\n-\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_UTF8, values.getName(), \"name\");\n-\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_UTF8, values.getSignature(), \"getSignature\");\n+\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, values.getNameSrp(), \"name\");\n+\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, values.getSignatureSrp(), \"signature\");\n \t\t\t\tif (values.getGenericSignature().notNull()) {\n-\t\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_UTF8, values.getGenericSignature(), \"getGenericSignature\");\n+\t\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, values.getGenericSignatureSrp(), \"genericSignature\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adbc5aa027ce6aebd657d7d488bad647b15b8119"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10c3df5b01e54058d3d87a24e6e72414cdff314f", "author": {"user": {"login": "AlexeyKhrabrov", "name": "Alexey Khrabrov"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/10c3df5b01e54058d3d87a24e6e72414cdff314f", "committedDate": "2021-01-28T19:54:57Z", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adbc5aa027ce6aebd657d7d488bad647b15b8119", "author": {"user": {"login": "AlexeyKhrabrov", "name": "Alexey Khrabrov"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/adbc5aa027ce6aebd657d7d488bad647b15b8119", "committedDate": "2021-01-21T19:35:17Z", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>"}, "afterCommit": {"oid": "10c3df5b01e54058d3d87a24e6e72414cdff314f", "author": {"user": {"login": "AlexeyKhrabrov", "name": "Alexey Khrabrov"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/10c3df5b01e54058d3d87a24e6e72414cdff314f", "committedDate": "2021-01-28T19:54:57Z", "message": "Use J9_ROM_UTF8 instead of J9_UTF8 in DDR ROMClass walker\n\nMatch the ROMClass walk implementation used in VM and cfdumper in the\nway it handles UTF8 strings in method debug info.\n\nSigned-off-by: Alexey Khrabrov <khrabrov@cs.toronto.edu>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc4ODg0NDYx", "url": "https://github.com/eclipse-openj9/openj9/pull/11362#pullrequestreview-578884461", "createdAt": "2021-01-29T01:53:34Z", "commit": {"oid": "10c3df5b01e54058d3d87a24e6e72414cdff314f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1434, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}