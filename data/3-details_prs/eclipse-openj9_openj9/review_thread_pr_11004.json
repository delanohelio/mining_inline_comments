{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMzE5Mzkz", "number": 11004, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTo1NTo1N1rOEyGmFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxOTo0MzozMlrOE7NsSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTcyMzExOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTo1NTo1N1rOHoj4rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMzo1NDoyMVrOHqc6ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5MzAzOA==", "bodyText": "I think this assert was supposed to check if the child is a const.", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r512293038", "createdAt": "2020-10-26T21:55:57Z", "author": {"login": "IBMJimmyk"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1441,6 +1441,30 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n             {\n             // increment of PIV\n             traceMsg(comp, \"Reducing the number of iterations of the loop %d at storeNode [%p] by vector length %d \\n\",loop->getNumber(), storeNode, unrollCount);\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getOpCode().isAdd() || storeNode->getFirstChild()->getOpCode().isSub(), \"PIV increment should be simple (either by add or by sub\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getFirstChild()->getOpCode().isLoad(), \"PIV increment should have load\");\n+\t    TR_ASSERT_FATAL(!storeNode->getFirstChild()->getSecondChild()->getSymbolReference(), \"PIV increment should have const increment value\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7cf3a1249dec05592fb359439d0c5d7a1758c3a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI3NjAyNg==", "bodyText": "Code Updated", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r514276026", "createdAt": "2020-10-29T13:54:21Z", "author": {"login": "mnalam-p"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1441,6 +1441,30 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n             {\n             // increment of PIV\n             traceMsg(comp, \"Reducing the number of iterations of the loop %d at storeNode [%p] by vector length %d \\n\",loop->getNumber(), storeNode, unrollCount);\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getOpCode().isAdd() || storeNode->getFirstChild()->getOpCode().isSub(), \"PIV increment should be simple (either by add or by sub\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getFirstChild()->getOpCode().isLoad(), \"PIV increment should have load\");\n+\t    TR_ASSERT_FATAL(!storeNode->getFirstChild()->getSecondChild()->getSymbolReference(), \"PIV increment should have const increment value\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5MzAzOA=="}, "originalCommit": {"oid": "d7cf3a1249dec05592fb359439d0c5d7a1758c3a"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNzM3NjI4OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNDoxNDo1OVrOHpsMkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDo0Mjo1MFrOH1RTmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ3Nzc3Ng==", "bodyText": "Maybe I'm missing something, but if the increment is commoned with other uses why does uncommoning just the definition let the vectorization do the right thing but the commoned version does not?", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r513477776", "createdAt": "2020-10-28T14:14:59Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1441,6 +1441,30 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n             {\n             // increment of PIV\n             traceMsg(comp, \"Reducing the number of iterations of the loop %d at storeNode [%p] by vector length %d \\n\",loop->getNumber(), storeNode, unrollCount);\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getOpCode().isAdd() || storeNode->getFirstChild()->getOpCode().isSub(), \"PIV increment should be simple (either by add or by sub\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getFirstChild()->getOpCode().isLoad(), \"PIV increment should have load\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getSecondChild()->getOpCode().isLoadConst(), \"PIV increment should have const increment value\");\n+            if (storeNode->getFirstChild()->getReferenceCount() > 1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0bed4ff16a80d8a6af6a4d496449535f1be687c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUwMzE2Ng==", "bodyText": "Lets says we want to vectorize the following\nA[i] = B[i+1] * 2\nNow when we do that, the i + 1 calculation is the same value after incrementing i. Hence, they become common. Now, if we don't uncommon the i+1 node, then later on loop reduction will change the 1 to 4 (for example). Hence making i = i + 4. Now, as i + 1 was previously commoned, this change will make the code like below -\nA[i] = B[i+4] * 2", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r514503166", "createdAt": "2020-10-29T19:11:28Z", "author": {"login": "mnalam-p"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1441,6 +1441,30 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n             {\n             // increment of PIV\n             traceMsg(comp, \"Reducing the number of iterations of the loop %d at storeNode [%p] by vector length %d \\n\",loop->getNumber(), storeNode, unrollCount);\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getOpCode().isAdd() || storeNode->getFirstChild()->getOpCode().isSub(), \"PIV increment should be simple (either by add or by sub\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getFirstChild()->getOpCode().isLoad(), \"PIV increment should have load\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getSecondChild()->getOpCode().isLoadConst(), \"PIV increment should have const increment value\");\n+            if (storeNode->getFirstChild()->getReferenceCount() > 1)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ3Nzc3Ng=="}, "originalCommit": {"oid": "e0bed4ff16a80d8a6af6a4d496449535f1be687c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUwNDk5NA==", "bodyText": "Also, I believe this fix should be able to fix a previous bug #9446", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r514504994", "createdAt": "2020-10-29T19:14:54Z", "author": {"login": "mnalam-p"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1441,6 +1441,30 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n             {\n             // increment of PIV\n             traceMsg(comp, \"Reducing the number of iterations of the loop %d at storeNode [%p] by vector length %d \\n\",loop->getNumber(), storeNode, unrollCount);\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getOpCode().isAdd() || storeNode->getFirstChild()->getOpCode().isSub(), \"PIV increment should be simple (either by add or by sub\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getFirstChild()->getOpCode().isLoad(), \"PIV increment should have load\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getSecondChild()->getOpCode().isLoadConst(), \"PIV increment should have const increment value\");\n+            if (storeNode->getFirstChild()->getReferenceCount() > 1)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ3Nzc3Ng=="}, "originalCommit": {"oid": "e0bed4ff16a80d8a6af6a4d496449535f1be687c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzExNTY0NA==", "bodyText": "Also mixed tabs/spaces in this commit should be fixed up.", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r523115644", "createdAt": "2020-11-13T17:35:56Z", "author": {"login": "fjeremic"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1441,6 +1441,30 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n             {\n             // increment of PIV\n             traceMsg(comp, \"Reducing the number of iterations of the loop %d at storeNode [%p] by vector length %d \\n\",loop->getNumber(), storeNode, unrollCount);\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getOpCode().isAdd() || storeNode->getFirstChild()->getOpCode().isSub(), \"PIV increment should be simple (either by add or by sub\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getFirstChild()->getOpCode().isLoad(), \"PIV increment should have load\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getSecondChild()->getOpCode().isLoadConst(), \"PIV increment should have const increment value\");\n+            if (storeNode->getFirstChild()->getReferenceCount() > 1)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ3Nzc3Ng=="}, "originalCommit": {"oid": "e0bed4ff16a80d8a6af6a4d496449535f1be687c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYyMDEyMQ==", "bodyText": "The tabs/spaces are fixed, it was introduced due to vim not having proper tab extend setup", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r525620121", "createdAt": "2020-11-18T00:42:50Z", "author": {"login": "mnalam-p"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1441,6 +1441,30 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n             {\n             // increment of PIV\n             traceMsg(comp, \"Reducing the number of iterations of the loop %d at storeNode [%p] by vector length %d \\n\",loop->getNumber(), storeNode, unrollCount);\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getOpCode().isAdd() || storeNode->getFirstChild()->getOpCode().isSub(), \"PIV increment should be simple (either by add or by sub\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getFirstChild()->getOpCode().isLoad(), \"PIV increment should have load\");\n+\t    TR_ASSERT_FATAL(storeNode->getFirstChild()->getSecondChild()->getOpCode().isLoadConst(), \"PIV increment should have const increment value\");\n+            if (storeNode->getFirstChild()->getReferenceCount() > 1)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ3Nzc3Ng=="}, "originalCommit": {"oid": "e0bed4ff16a80d8a6af6a4d496449535f1be687c"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDAzNzk2OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzoxODo1MlrOH0bWJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzoxODo1MlrOH0bWJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczNjAzOA==", "bodyText": "Let's not return the value passed as a parameter. Better to make that function void.", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r524736038", "createdAt": "2020-11-16T23:18:52Z", "author": {"login": "gita-omr"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1369,6 +1369,30 @@ bool TR_SPMDKernelParallelizer::reductionLoopExitProcessing(TR::Compilation *com\n    return true;\n    }\n \n+TR::Node * replaceAndAnchorOldNode(TR::Compilation *comp, TR::TreeTop *treeTop, TR::Node *parent, TR::Node *oldNode, TR::Node *newNode, int index)\n+   {\n+\t   treeTop->insertBefore(TR::TreeTop::create(comp, TR::Node::create(TR::treetop, 1, oldNode)));\n+\t   oldNode->recursivelyDecReferenceCount();\n+\t   parent->setAndIncChild(index, newNode);\n+\t   return newNode;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f836f910bafa2fd12f1e2f8da99cdca24b924fc"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDA1MTkwOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzoyMDoyOFrOH0bgAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODozMjo0OFrOH1DexQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczODU2Mw==", "bodyText": "I would rather call it: changeLoopStride.", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r524738563", "createdAt": "2020-11-16T23:20:28Z", "author": {"login": "gita-omr"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1369,6 +1369,30 @@ bool TR_SPMDKernelParallelizer::reductionLoopExitProcessing(TR::Compilation *com\n    return true;\n    }\n \n+TR::Node * replaceAndAnchorOldNode(TR::Compilation *comp, TR::TreeTop *treeTop, TR::Node *parent, TR::Node *oldNode, TR::Node *newNode, int index)\n+   {\n+\t   treeTop->insertBefore(TR::TreeTop::create(comp, TR::Node::create(TR::treetop, 1, oldNode)));\n+\t   oldNode->recursivelyDecReferenceCount();\n+\t   parent->setAndIncChild(index, newNode);\n+\t   return newNode;\n+   }\n+\n+bool matchIVIncrementPattern(TR::Node *node, TR::SymbolReference *pivSymRef)\n+   {\n+   return (node->getOpCode().isAdd() || node->getOpCode().isSub()) && node->getFirstChild()->getOpCode().isLoad()\n+    && node->getFirstChild()->getSymbolReference() == pivSymRef && node->getSecondChild()->getOpCode().isLoadConst();\n+   }\n+\n+TR::Node * changeIAddISubConstNodeMultiplyBy(TR::Node * parent, int32_t multiple)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f836f910bafa2fd12f1e2f8da99cdca24b924fc"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM5MzYwNQ==", "bodyText": "or even better: multiplyLoopStride", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r525393605", "createdAt": "2020-11-17T18:32:48Z", "author": {"login": "gita-omr"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1369,6 +1369,30 @@ bool TR_SPMDKernelParallelizer::reductionLoopExitProcessing(TR::Compilation *com\n    return true;\n    }\n \n+TR::Node * replaceAndAnchorOldNode(TR::Compilation *comp, TR::TreeTop *treeTop, TR::Node *parent, TR::Node *oldNode, TR::Node *newNode, int index)\n+   {\n+\t   treeTop->insertBefore(TR::TreeTop::create(comp, TR::Node::create(TR::treetop, 1, oldNode)));\n+\t   oldNode->recursivelyDecReferenceCount();\n+\t   parent->setAndIncChild(index, newNode);\n+\t   return newNode;\n+   }\n+\n+bool matchIVIncrementPattern(TR::Node *node, TR::SymbolReference *pivSymRef)\n+   {\n+   return (node->getOpCode().isAdd() || node->getOpCode().isSub()) && node->getFirstChild()->getOpCode().isLoad()\n+    && node->getFirstChild()->getSymbolReference() == pivSymRef && node->getSecondChild()->getOpCode().isLoadConst();\n+   }\n+\n+TR::Node * changeIAddISubConstNodeMultiplyBy(TR::Node * parent, int32_t multiple)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczODU2Mw=="}, "originalCommit": {"oid": "8f836f910bafa2fd12f1e2f8da99cdca24b924fc"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDA2OTEyOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzoyMjo1OFrOH0btAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzoyMjo1OFrOH0btAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc0MTg5MQ==", "bodyText": "Please fix all the formatting.", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r524741891", "createdAt": "2020-11-16T23:22:58Z", "author": {"login": "gita-omr"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1427,26 +1451,110 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n    loop->getBlocks(&blocksInLoop);\n    ListIterator<TR::Block> blocksIt1(&blocksInLoop);\n \n-\n    // SIMD_TODO: improve this code\n \n    for (TR::Block *nextBlock = blocksIt1.getCurrent(); nextBlock; nextBlock=blocksIt1.getNext())\n       {\n+      TR_HashTab* entries = new (comp->trStackMemory()) TR_HashTab(comp->trMemory(), stackAlloc);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f836f910bafa2fd12f1e2f8da99cdca24b924fc"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDA5MDYzOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzoyNjo0MlrOH0b8Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzo0MzoxMVrOH0c-hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc0NTc1MA==", "bodyText": "I don't think we should create a hash table for each block. I think we need only one that is cleared on every block.", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r524745750", "createdAt": "2020-11-16T23:26:42Z", "author": {"login": "gita-omr"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1427,26 +1451,110 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n    loop->getBlocks(&blocksInLoop);\n    ListIterator<TR::Block> blocksIt1(&blocksInLoop);\n \n-\n    // SIMD_TODO: improve this code\n \n    for (TR::Block *nextBlock = blocksIt1.getCurrent(); nextBlock; nextBlock=blocksIt1.getNext())\n       {\n+      TR_HashTab* entries = new (comp->trStackMemory()) TR_HashTab(comp->trMemory(), stackAlloc);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f836f910bafa2fd12f1e2f8da99cdca24b924fc"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc2Mjc1Nw==", "bodyText": "Looks like the existing code assumes there are no extended blocks at this point (since we don't traverse in the order of the trees but just get a set of blocks in the loop). So perhaps having a hash table is not really necessary since there will be only one compare and branch and it will always follow an inductions variable increment.  But let's keep the hash table in case we want to handle more general case in the future.", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r524762757", "createdAt": "2020-11-16T23:43:11Z", "author": {"login": "gita-omr"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1427,26 +1451,110 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n    loop->getBlocks(&blocksInLoop);\n    ListIterator<TR::Block> blocksIt1(&blocksInLoop);\n \n-\n    // SIMD_TODO: improve this code\n \n    for (TR::Block *nextBlock = blocksIt1.getCurrent(); nextBlock; nextBlock=blocksIt1.getNext())\n       {\n+      TR_HashTab* entries = new (comp->trStackMemory()) TR_HashTab(comp->trMemory(), stackAlloc);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc0NTc1MA=="}, "originalCommit": {"oid": "8f836f910bafa2fd12f1e2f8da99cdca24b924fc"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDA5NjI5OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzoyNzozOFrOH0cACw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzoyNzozOFrOH0cACw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc0Njc2Mw==", "bodyText": "Since the node is not necessary a store maybe should be named something else.", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r524746763", "createdAt": "2020-11-16T23:27:38Z", "author": {"login": "gita-omr"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1427,26 +1451,110 @@ bool TR_SPMDKernelParallelizer::processSPMDKernelLoopForSIMDize(TR::Compilation\n    loop->getBlocks(&blocksInLoop);\n    ListIterator<TR::Block> blocksIt1(&blocksInLoop);\n \n-\n    // SIMD_TODO: improve this code\n \n    for (TR::Block *nextBlock = blocksIt1.getCurrent(); nextBlock; nextBlock=blocksIt1.getNext())\n       {\n+      TR_HashTab* entries = new (comp->trStackMemory()) TR_HashTab(comp->trMemory(), stackAlloc);\n       for (TR::TreeTop *tt = nextBlock->getEntry() ; tt != nextBlock->getExit() ; tt = tt->getNextTreeTop())\n          {\n          // identify operation for primary induction variable\n          TR::Node *storeNode = tt->getNode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f836f910bafa2fd12f1e2f8da99cdca24b924fc"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNTI1NzY5OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxOTo0MzozMlrOH2u0Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxOTo1MjoyOVrOH2vI-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE1MjE3NA==", "bodyText": "There are still some tabs here that should be replaced with spaces.", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r527152174", "createdAt": "2020-11-19T19:43:32Z", "author": {"login": "IBMJimmyk"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1369,6 +1369,29 @@ bool TR_SPMDKernelParallelizer::reductionLoopExitProcessing(TR::Compilation *com\n    return true;\n    }\n \n+void TR_SPMDKernelParallelizer::replaceAndAnchorOldNode(TR::Compilation *comp, TR::TreeTop *treeTop, TR::Node *parent, TR::Node *oldNode, TR::Node *newNode, int index)\n+   {\n+\t   treeTop->insertBefore(TR::TreeTop::create(comp, TR::Node::create(TR::treetop, 1, oldNode)));\n+\t   oldNode->recursivelyDecReferenceCount();\n+\t   parent->setAndIncChild(index, newNode);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3778a76309e1e9693ddc9569362048266b5a657"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE1NzQ5Nw==", "bodyText": "Fixed", "url": "https://github.com/eclipse-openj9/openj9/pull/11004#discussion_r527157497", "createdAt": "2020-11-19T19:52:29Z", "author": {"login": "mnalam-p"}, "path": "runtime/compiler/optimizer/SPMDParallelizer.cpp", "diffHunk": "@@ -1369,6 +1369,29 @@ bool TR_SPMDKernelParallelizer::reductionLoopExitProcessing(TR::Compilation *com\n    return true;\n    }\n \n+void TR_SPMDKernelParallelizer::replaceAndAnchorOldNode(TR::Compilation *comp, TR::TreeTop *treeTop, TR::Node *parent, TR::Node *oldNode, TR::Node *newNode, int index)\n+   {\n+\t   treeTop->insertBefore(TR::TreeTop::create(comp, TR::Node::create(TR::treetop, 1, oldNode)));\n+\t   oldNode->recursivelyDecReferenceCount();\n+\t   parent->setAndIncChild(index, newNode);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE1MjE3NA=="}, "originalCommit": {"oid": "c3778a76309e1e9693ddc9569362048266b5a657"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1018, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}