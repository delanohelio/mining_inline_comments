{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MDE2NDQw", "number": 10382, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozNjo1MVrOEcvSeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDo1MDoyOFrOEcvkbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTcwMzYwOnYy", "diffSide": "RIGHT", "path": "runtime/util/hshelp.c", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozNjo1MVrOHHczrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozNjo1MVrOHHczrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3NDA2Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif ((J2SE_VERSION(vm) >= J2SE_V11) && J9_ARE_ALL_BITS_SET(originalRAMClass->classFlags, J9ClassIsAnonymous)) {\n          \n          \n            \n            \t\t\tJ9ROMClass *hostROMClass = originalRAMClass->hostClass->romClass;\n          \n          \n            \n            \t\t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));;\n          \n          \n            \n            \t\t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n          \n          \n            \n            \t\t} else {\n          \n          \n            \n            \t\t\tloadData.hostPackageName = NULL;\n          \n          \n            \n            \t\t\tloadData.hostPackageLength = 0;\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \t\tloadData.hostPackageName = NULL;\n          \n          \n            \n            \t\tloadData.hostPackageLength = 0;\n          \n          \n            \n            \t\tif ((J2SE_VERSION(vm) >= J2SE_V11) && J9_ARE_ALL_BITS_SET(originalRAMClass->classFlags, J9ClassIsAnonymous)) {\n          \n          \n            \n            \t\t\tJ9ROMClass *hostROMClass = originalRAMClass->hostClass->romClass;\n          \n          \n            \n            \t\t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));;\n          \n          \n            \n            \t\t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n          \n          \n            \n            \t\t}", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#discussion_r477574063", "createdAt": "2020-08-26T20:36:51Z", "author": {"login": "DanHeidinga"}, "path": "runtime/util/hshelp.c", "diffHunk": "@@ -3531,6 +3531,15 @@ reloadROMClasses(J9VMThread * currentThread, jint class_count, const jvmtiClassD\n \t\tloadData.protectionDomain = J9VMJAVALANGCLASS_PROTECTIONDOMAIN(currentThread, heapClass);\n \t\tloadData.options = options;\n \n+\t\tif ((J2SE_VERSION(vm) >= J2SE_V11) && J9_ARE_ALL_BITS_SET(originalRAMClass->classFlags, J9ClassIsAnonymous)) {\n+\t\t\tJ9ROMClass *hostROMClass = originalRAMClass->hostClass->romClass;\n+\t\t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));;\n+\t\t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n+\t\t} else {\n+\t\t\tloadData.hostPackageName = NULL;\n+\t\t\tloadData.hostPackageLength = 0;\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTcwMzkxOnYy", "diffSide": "RIGHT", "path": "runtime/bcutil/defineclass.c", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozNjo1OFrOHHcz5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozNjo1OFrOHHcz5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3NDExOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tif (isAnonFlagSet && (J2SE_VERSION(vm) >= J2SE_V11)) {\n          \n          \n            \n            \t\tJ9ROMClass *hostROMClass = hostClass->romClass;\n          \n          \n            \n            \t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));\n          \n          \n            \n            \t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n          \n          \n            \n            \t} else {\n          \n          \n            \n            \t\tloadData.hostPackageName = NULL;\n          \n          \n            \n            \t\tloadData.hostPackageLength = 0;\n          \n          \n            \n            \t}\n          \n          \n            \n            \tloadData.hostPackageName = NULL;\n          \n          \n            \n            \tloadData.hostPackageLength = 0;\n          \n          \n            \n            \tif (isAnonFlagSet && (J2SE_VERSION(vm) >= J2SE_V11)) {\n          \n          \n            \n            \t\tJ9ROMClass *hostROMClass = hostClass->romClass;\n          \n          \n            \n            \t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));\n          \n          \n            \n            \t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n          \n          \n            \n            \t}", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#discussion_r477574118", "createdAt": "2020-08-26T20:36:58Z", "author": {"login": "DanHeidinga"}, "path": "runtime/bcutil/defineclass.c", "diffHunk": "@@ -107,6 +107,15 @@ internalDefineClass(\n \tloadData.freeFunction = NULL;\n \tloadData.romClass = existingROMClass;\n \n+\tif (isAnonFlagSet && (J2SE_VERSION(vm) >= J2SE_V11)) {\n+\t\tJ9ROMClass *hostROMClass = hostClass->romClass;\n+\t\tloadData.hostPackageName = J9UTF8_DATA(J9ROMCLASS_CLASSNAME(hostROMClass));\n+\t\tloadData.hostPackageLength = packageNameLength(hostROMClass);\n+\t} else {\n+\t\tloadData.hostPackageName = NULL;\n+\t\tloadData.hostPackageLength = 0;\n+\t}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTc0OTU3OnYy", "diffSide": "RIGHT", "path": "runtime/bcutil/ROMClassBuilder.cpp", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDo1MDoyOFrOHHdPdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNTowODozMVrOHIU08w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4MTE3NQ==", "bodyText": "I see for hidden classes tests, package name is already there. So I think package name should only be added for classes defined by Unsafe.defineAnonymous().  Hidden class can be anonymous, so package name should be added for non-hidden anon classes, i.e. isClassAnon() && !isClassHidden. You can change handleAnonClassName() to take an addition parameter like bool isHidden, and check this parameter to decide whether to add package name.", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#discussion_r477581175", "createdAt": "2020-08-26T20:50:28Z", "author": {"login": "hangshao0"}, "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -430,7 +440,7 @@ ROMClassBuilder::prepareAndLaydown( BufferManager *bufferManager, ClassFileParse\n \n \tbool isLambda = false;\n \tif (context->isClassAnon() || context->isClassHidden()) {\n-\t\tBuildResult res = handleAnonClassName(classFileParser->getParsedClassFile(), &isLambda);\n+\t\tBuildResult res = handleAnonClassName(classFileParser->getParsedClassFile(), &isLambda, context->hostPackageName(), context->hostPackageLength());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU5MzY4NQ==", "bodyText": "Probably it is worth testing if openjdk adds packagename to hidden classes using your TestAnonName.class\nbyte[] bytes = Files.readAllBytes(Paths.get(\"TestAnonName.class\"));\nClass<?> hc = lookup().defineHiddenClass(bytes, false).lookupClass();\nSystem.out.println(hc.getName());", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#discussion_r477593685", "createdAt": "2020-08-26T21:15:18Z", "author": {"login": "hangshao0"}, "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -430,7 +440,7 @@ ROMClassBuilder::prepareAndLaydown( BufferManager *bufferManager, ClassFileParse\n \n \tbool isLambda = false;\n \tif (context->isClassAnon() || context->isClassHidden()) {\n-\t\tBuildResult res = handleAnonClassName(classFileParser->getParsedClassFile(), &isLambda);\n+\t\tBuildResult res = handleAnonClassName(classFileParser->getParsedClassFile(), &isLambda, context->hostPackageName(), context->hostPackageLength());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4MTE3NQ=="}, "originalCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY2NTc5OA==", "bodyText": "Output of Hotspot JDK15 is:\nHidden class name: HiddenNamedClass/0x0000000800b8f440\n\nOutput with my change is the same. Hidden classes don't seem to come with a host class when being created, so it shouldn't need an extra variable.", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#discussion_r477665798", "createdAt": "2020-08-26T23:23:13Z", "author": {"login": "mikezhang1234567890"}, "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -430,7 +440,7 @@ ROMClassBuilder::prepareAndLaydown( BufferManager *bufferManager, ClassFileParse\n \n \tbool isLambda = false;\n \tif (context->isClassAnon() || context->isClassHidden()) {\n-\t\tBuildResult res = handleAnonClassName(classFileParser->getParsedClassFile(), &isLambda);\n+\t\tBuildResult res = handleAnonClassName(classFileParser->getParsedClassFile(), &isLambda, context->hostPackageName(), context->hostPackageLength());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4MTE3NQ=="}, "originalCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ5MTg5MQ==", "bodyText": "OK. Thanks.", "url": "https://github.com/eclipse-openj9/openj9/pull/10382#discussion_r478491891", "createdAt": "2020-08-27T15:08:31Z", "author": {"login": "hangshao0"}, "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -430,7 +440,7 @@ ROMClassBuilder::prepareAndLaydown( BufferManager *bufferManager, ClassFileParse\n \n \tbool isLambda = false;\n \tif (context->isClassAnon() || context->isClassHidden()) {\n-\t\tBuildResult res = handleAnonClassName(classFileParser->getParsedClassFile(), &isLambda);\n+\t\tBuildResult res = handleAnonClassName(classFileParser->getParsedClassFile(), &isLambda, context->hostPackageName(), context->hostPackageLength());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4MTE3NQ=="}, "originalCommit": {"oid": "2da45d62c6f0a42af83e51eec381b8d5dfbd3ea3"}, "originalPosition": 69}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4686, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}