{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNzU5Mjk1", "number": 11214, "title": "Delay liveness analysis to post tree lowering", "bodyText": "After splitPostGRA, live locals might not be updated for the newly split blocks. We need to rerun liveness analysis after optimizations.\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\nSigned-off-by: Annabelle Huo Annabelle.Huo@ibm.com", "createdAt": "2020-11-17T23:00:48Z", "url": "https://github.com/eclipse-openj9/openj9/pull/11214", "merged": true, "mergeCommit": {"oid": "567c5898fc244e9ecc522809a5ec99a190560fbf"}, "closed": true, "closedAt": "2020-12-16T14:31:00Z", "author": {"login": "a7ehuo"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddh9JtAFqTUzMjg5MTA5MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmv1KnAFqTU1Mzc0MDE4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODkxMDkx", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#pullrequestreview-532891091", "createdAt": "2020-11-17T23:14:42Z", "commit": {"oid": "50ecd8edddc7ea08913523eef8e834b4baa79b88"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzoxNDo0MlrOH1PW4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzoxNDo0MlrOH1PW4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4ODE5Mg==", "bodyText": "@andrewcraik @liqunl This change sets a flag in CG to trigger rerunLivenessAnalysis whenever splitPostGRA is called. However based on my test, I don't think liveness analysis should be run once the flag is true. There might be other things to take into consideration, such as if the optLevel is noOpt, it doesn't seem to be right to rerun liveness analysis.\nMy question is what criteria should be used to allow liveness analysis to rerun after tree lowering?\nI found there are two places in our code that do liveness analysis. Should we rerun liveness analysis after tree lowering if the liveness analysis has been performed in both  TR_GlobalRegisterAllocator and TR_GlobalLiveVariablesForGC? Or they are irrelevant to rerun liveness analysis after tree lowering?\n\n\nTR_GlobalRegisterAllocator\nhttps://github.com/eclipse/openj9-omr/blob/ff84a120148d2eeba5a6fcc594b846cb93f809c5/compiler/optimizer/GlobalRegisterAllocator.cpp#L446\n\n\nTR_GlobalLiveVariablesForGC https://github.com/eclipse/openj9/blob/33d30b17a7c6329c55546a46c42e5fdae0ac8585/runtime/compiler/optimizer/LiveVariablesForGC.cpp#L266\n\n\n@Leonardo2718 @hzongaro FYI", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#discussion_r525588192", "createdAt": "2020-11-17T23:14:42Z", "author": {"login": "a7ehuo"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -785,6 +789,13 @@ J9::CodeGenerator::preLowerTrees()\n    _uncommonedNodes.init(64, true);\n    }\n \n+void\n+J9::CodeGenerator::postLowerTrees()\n+   {\n+   OMR::CodeGeneratorConnector::postLowerTrees();\n+   if ((self()->isRerunLivenessAnalysis() && (self()->comp()->getOptLevel() > noOpt))\n+      self()->rerunLivenessAnalysis();\n+   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50ecd8edddc7ea08913523eef8e834b4baa79b88"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50ecd8edddc7ea08913523eef8e834b4baa79b88", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/50ecd8edddc7ea08913523eef8e834b4baa79b88", "committedDate": "2020-11-17T22:59:33Z", "message": "Rerun liveness analysis after tree lowering\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "19386cd6f73800e3e9c9505ef47ece447233bd9d", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/19386cd6f73800e3e9c9505ef47ece447233bd9d", "committedDate": "2020-11-18T01:25:25Z", "message": "Rerun liveness analysis after tree lowering\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNTEzNTI2", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#pullrequestreview-533513526", "createdAt": "2020-11-18T14:41:11Z", "commit": {"oid": "19386cd6f73800e3e9c9505ef47ece447233bd9d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNDo0MToxMVrOH1xAVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNDo0MjoyOFrOH1xEVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjEzOTQ3Ng==", "bodyText": "If live info has been computed, and then gets invalidated by calling splitPostGRA, then we need to rerun the analysis.", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#discussion_r526139476", "createdAt": "2020-11-18T14:41:11Z", "author": {"login": "liqunl"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -785,6 +789,13 @@ J9::CodeGenerator::preLowerTrees()\n    _uncommonedNodes.init(64, true);\n    }\n \n+void\n+J9::CodeGenerator::postLowerTrees()\n+   {\n+   OMR::CodeGeneratorConnector::postLowerTrees();\n+   if ((self()->isRerunLivenessAnalysis() && (self()->comp()->getOptLevel() > noOpt))\n+      self()->rerunLivenessAnalysis();\n+   }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4ODE5Mg=="}, "originalCommit": {"oid": "50ecd8edddc7ea08913523eef8e834b4baa79b88"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjE0MDUwMQ==", "bodyText": "The similar code is duplicated in GRA, GlobalLiveVariablesForGC and here, can we extract it to a util and call that util instead?", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#discussion_r526140501", "createdAt": "2020-11-18T14:42:28Z", "author": {"login": "liqunl"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -1530,7 +1541,93 @@ J9::CodeGenerator::lowerTreeIfNeeded(\n \n    }\n \n+void\n+J9::CodeGenerator::rerunLivenessAnalysis()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19386cd6f73800e3e9c9505ef47ece447233bd9d"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19386cd6f73800e3e9c9505ef47ece447233bd9d", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/19386cd6f73800e3e9c9505ef47ece447233bd9d", "committedDate": "2020-11-18T01:25:25Z", "message": "Rerun liveness analysis after tree lowering\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "c174cc98a53e1200fbe181e6a6dd7031bd732270", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c174cc98a53e1200fbe181e6a6dd7031bd732270", "committedDate": "2020-11-23T20:43:15Z", "message": "Rerun liveness analysis after tree lowering\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c174cc98a53e1200fbe181e6a6dd7031bd732270", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c174cc98a53e1200fbe181e6a6dd7031bd732270", "committedDate": "2020-11-23T20:43:15Z", "message": "Rerun liveness analysis after tree lowering\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "5bf06ec873b7bad0eb4377c60e7841a63f096440", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5bf06ec873b7bad0eb4377c60e7841a63f096440", "committedDate": "2020-11-24T14:58:30Z", "message": "Rerun liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. We need to rerun liveness\nanalysis after optimizations.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NzM2MzE1", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#pullrequestreview-538736315", "createdAt": "2020-11-25T17:55:12Z", "commit": {"oid": "5bf06ec873b7bad0eb4377c60e7841a63f096440"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNzo1NToxMlrOH5-c3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNzo1NToxMlrOH5-c3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU1NDA3OA==", "bodyText": "The rerun shouldn't be optional. It must happen or we'll have functional issue. Could you use dumpOptDetails inside the if statement?", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#discussion_r530554078", "createdAt": "2020-11-25T17:55:12Z", "author": {"login": "liqunl"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -1530,7 +1542,92 @@ J9::CodeGenerator::lowerTreeIfNeeded(\n \n    }\n \n+void\n+J9::CodeGenerator::rerunLivenessAnalysis()\n+   {\n+   auto comp = self()->comp();\n+   auto trHeapMemory = self()->trHeapMemory();\n+   auto trMemory = self()->trMemory();\n+\n+   if (!comp->getFlowGraph()->getStructure())\n+      {\n+      comp->getFlowGraph()->setStructure(TR_RegionAnalysis::getRegions(comp));\n+      }\n+\n+      {\n+      TR_BitVector *liveVars = NULL;\n+      int32_t numLocals = 0;\n+      TR::AutomaticSymbol *a;\n+      ListIterator<TR::AutomaticSymbol> locals(&comp->getMethodSymbol()->getAutomaticList());\n+      for (a = locals.getFirst(); a != NULL; a = locals.getNext())\n+         {\n+         // Mark collected locals as initialized. We will reset this property for\n+         // any locals that are live at the start of the method.\n+         //\n+         if (a->isCollectedReference() &&\n+            (!comp->getOption(TR_MimicInterpreterFrameShape) ||\n+             !comp->areSlotsSharedByRefAndNonRef() ||\n+             a->isSlotSharedByRefAndNonRef()))\n+               a->setInitializedReference();\n+         ++numLocals;\n+         }\n+\n+      if (comp->getOption(TR_EnableAggressiveLiveness))\n+         {\n+         TR::ParameterSymbol *p;\n+         ListIterator<TR::ParameterSymbol> parms(&comp->getMethodSymbol()->getParameterList());\n+         for (p = parms.getFirst(); p != NULL; p = parms.getNext())\n+            ++numLocals;\n+         }\n+\n+      if (numLocals > 0 && (performTransformation(comp, \"Rerunning liveness for CodeGen numLocals %d\\n\", numLocals)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bf06ec873b7bad0eb4377c60e7841a63f096440"}, "originalPosition": 84}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bf06ec873b7bad0eb4377c60e7841a63f096440", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5bf06ec873b7bad0eb4377c60e7841a63f096440", "committedDate": "2020-11-24T14:58:30Z", "message": "Rerun liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. We need to rerun liveness\nanalysis after optimizations.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "3564633f5714f484a274be010110bbc629fb1583", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3564633f5714f484a274be010110bbc629fb1583", "committedDate": "2020-11-25T19:45:43Z", "message": "Rerun liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. We need to rerun liveness\nanalysis after optimizations.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3564633f5714f484a274be010110bbc629fb1583", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/3564633f5714f484a274be010110bbc629fb1583", "committedDate": "2020-11-25T19:45:43Z", "message": "Rerun liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. We need to rerun liveness\nanalysis after optimizations.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "bf8d0c621b66be0f8cddafde8b86f4d90f07bfe7", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/bf8d0c621b66be0f8cddafde8b86f4d90f07bfe7", "committedDate": "2020-11-26T15:08:05Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf8d0c621b66be0f8cddafde8b86f4d90f07bfe7", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/bf8d0c621b66be0f8cddafde8b86f4d90f07bfe7", "committedDate": "2020-11-26T15:08:05Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "eb50d2dd162e3f7b6800331b7b6de15cc5c100f0", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/eb50d2dd162e3f7b6800331b7b6de15cc5c100f0", "committedDate": "2020-11-26T15:15:15Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb50d2dd162e3f7b6800331b7b6de15cc5c100f0", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/eb50d2dd162e3f7b6800331b7b6de15cc5c100f0", "committedDate": "2020-11-26T15:15:15Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "cfd83fc0cf1d6e3e947609f40855056ba0eb0a49", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/cfd83fc0cf1d6e3e947609f40855056ba0eb0a49", "committedDate": "2020-11-26T22:12:16Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTcyNjIy", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#pullrequestreview-540972622", "createdAt": "2020-11-30T14:42:53Z", "commit": {"oid": "cfd83fc0cf1d6e3e947609f40855056ba0eb0a49"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo0Mjo1M1rOH7-Mpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDo1MTozN1rOH7-mpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0NzA3OA==", "bodyText": "We should enable the check even if ValueType is not enabled", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#discussion_r532647078", "createdAt": "2020-11-30T14:42:53Z", "author": {"login": "liqunl"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -1530,6 +1540,112 @@ J9::CodeGenerator::lowerTreeIfNeeded(\n \n    }\n \n+void\n+J9::CodeGenerator::runGlobalLiveVariablesForGC()\n+   {\n+   auto comp = self()->comp();\n+   auto trHeapMemory = self()->trHeapMemory();\n+   auto trMemory = self()->trMemory();\n+\n+   if (TR::Compiler->om.areValueTypesEnabled() &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd83fc0cf1d6e3e947609f40855056ba0eb0a49"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1MjMwOA==", "bodyText": "If live locals are already computed before CG by whatever opt, it may also be invalidated by any block split operation. Make sure you invalidate any live local in block split.", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#discussion_r532652308", "createdAt": "2020-11-30T14:49:43Z", "author": {"login": "liqunl"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -1530,6 +1540,112 @@ J9::CodeGenerator::lowerTreeIfNeeded(\n \n    }\n \n+void\n+J9::CodeGenerator::runGlobalLiveVariablesForGC()\n+   {\n+   auto comp = self()->comp();\n+   auto trHeapMemory = self()->trHeapMemory();\n+   auto trMemory = self()->trMemory();\n+\n+   if (TR::Compiler->om.areValueTypesEnabled() &&\n+       (comp->getOption(TR_EnableParanoidOptCheck) || debug(\"paranoidOptCheck\")))\n+      comp->verifyCFG(comp->getMethodSymbol());\n+\n+   if (!comp->getFlowGraph()->getStructure())\n+      {\n+      comp->getFlowGraph()->setStructure(TR_RegionAnalysis::getRegions(comp));\n+      }\n+\n+   // Because only live locals are mapped for GC, there is normally no need to\n+   // make sure locals are cleared to NULL during method prologue.\n+   // However, we can have cases where GC-collected locals are live at the start\n+   // of the method. These locals will have to be cleared to NULL during method\n+   // prologue.\n+   // This can happen because of the way we treat non-inlined jsrs.\n+   //\n+   int32_t numLocals = 0;\n+   TR::AutomaticSymbol *p;\n+   ListIterator<TR::AutomaticSymbol> locals(&comp->getMethodSymbol()->getAutomaticList());\n+   for (p = locals.getFirst(); p != NULL; p = locals.getNext())\n+      {\n+      // Mark collected locals as initialized. We will reset this property for\n+      // any locals that are live at the start of the method.\n+      //\n+      if (p->isCollectedReference() &&\n+          (!comp->getOption(TR_MimicInterpreterFrameShape) ||\n+           !comp->areSlotsSharedByRefAndNonRef() ||\n+           p->isSlotSharedByRefAndNonRef()))\n+         p->setInitializedReference();\n+      ++numLocals;\n+      }\n+\n+   if (comp->getOption(TR_EnableAggressiveLiveness))\n+      {\n+      TR::ParameterSymbol *pp;\n+      ListIterator<TR::ParameterSymbol> parms(&comp->getMethodSymbol()->getParameterList());\n+      for (pp = parms.getFirst(); pp != NULL; pp = parms.getNext())\n+         ++numLocals;\n+      }\n+\n+   // Nothing to do if there are no locals\n+   //\n+   if (numLocals == 0)\n+      return;\n+\n+   TR_BitVector *liveVars = NULL;\n+\n+   if ((comp->getOption(TR_EnableOSR) && (comp->getHCRMode() == TR::osr || comp->getOption(TR_FullSpeedDebug)))\n+       || !self()->getLiveLocals()) // under OSR existing live locals is likely computed without ignoring OSR uses", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd83fc0cf1d6e3e947609f40855056ba0eb0a49"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1MzAxMA==", "bodyText": "Region analysis is expensive, we should only do it if we're to run liveness analysis", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#discussion_r532653010", "createdAt": "2020-11-30T14:50:37Z", "author": {"login": "liqunl"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -1530,6 +1540,112 @@ J9::CodeGenerator::lowerTreeIfNeeded(\n \n    }\n \n+void\n+J9::CodeGenerator::runGlobalLiveVariablesForGC()\n+   {\n+   auto comp = self()->comp();\n+   auto trHeapMemory = self()->trHeapMemory();\n+   auto trMemory = self()->trMemory();\n+\n+   if (TR::Compiler->om.areValueTypesEnabled() &&\n+       (comp->getOption(TR_EnableParanoidOptCheck) || debug(\"paranoidOptCheck\")))\n+      comp->verifyCFG(comp->getMethodSymbol());\n+\n+   if (!comp->getFlowGraph()->getStructure())\n+      {\n+      comp->getFlowGraph()->setStructure(TR_RegionAnalysis::getRegions(comp));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd83fc0cf1d6e3e947609f40855056ba0eb0a49"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY1MzczNQ==", "bodyText": "We should use StackMemoryRegion in the new code to reduce memory consumption.", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#discussion_r532653735", "createdAt": "2020-11-30T14:51:37Z", "author": {"login": "liqunl"}, "path": "runtime/compiler/optimizer/LiveVariablesForGC.cpp", "diffHunk": "@@ -182,109 +182,8 @@ int32_t TR_GlobalLiveVariablesForGC::perform()\n       return 0;\n       }\n \n-   TR::StackMemoryRegion stackMemoryRegion(*trMemory());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd83fc0cf1d6e3e947609f40855056ba0eb0a49"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfd83fc0cf1d6e3e947609f40855056ba0eb0a49", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/cfd83fc0cf1d6e3e947609f40855056ba0eb0a49", "committedDate": "2020-11-26T22:12:16Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "29bb422ad05619f2b8a85b2e6855087c59b4ef7f", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/29bb422ad05619f2b8a85b2e6855087c59b4ef7f", "committedDate": "2020-11-30T18:23:31Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29bb422ad05619f2b8a85b2e6855087c59b4ef7f", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/29bb422ad05619f2b8a85b2e6855087c59b4ef7f", "committedDate": "2020-11-30T18:23:31Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "f2edd16df40088f2d16e6458702ca2e63e13fe06", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f2edd16df40088f2d16e6458702ca2e63e13fe06", "committedDate": "2020-12-02T21:46:07Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f2edd16df40088f2d16e6458702ca2e63e13fe06", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f2edd16df40088f2d16e6458702ca2e63e13fe06", "committedDate": "2020-12-02T21:46:07Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "85d507d150e4ff24cc864bb00b3035d7135b446d", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/85d507d150e4ff24cc864bb00b3035d7135b446d", "committedDate": "2020-12-03T02:13:46Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MjI3ODgx", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#pullrequestreview-548227881", "createdAt": "2020-12-09T14:18:51Z", "commit": {"oid": "85d507d150e4ff24cc864bb00b3035d7135b446d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85d507d150e4ff24cc864bb00b3035d7135b446d", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/85d507d150e4ff24cc864bb00b3035d7135b446d", "committedDate": "2020-12-03T02:13:46Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "9ff0cc85e1447f0575530a5c6cebae731933796d", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9ff0cc85e1447f0575530a5c6cebae731933796d", "committedDate": "2020-12-09T20:31:33Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODAxMDM3", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#pullrequestreview-551801037", "createdAt": "2020-12-14T18:59:00Z", "commit": {"oid": "9ff0cc85e1447f0575530a5c6cebae731933796d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODo1OTowMVrOIFgpqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODo1OTowMVrOIFgpqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY0ODc0Nw==", "bodyText": "I wonder if this check is sufficient.  Presumably this means if structure is available already then we'll simply use it here.  But I think there are tree lowering transformations that might either introduce blocks or re-route control flow between them.  I'm not sure if we can guarantee that they will be diligent in repairing structure if they change it.\nPerhaps we should always rebuild structure here.  My understanding is that it should be a relatively inexpensive build especially since  globalLiveVariablesForGC is only enabled \"naturally\" at optlevels >= warm and a structure rebuild will just be in the noise in terms of compile time.", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#discussion_r542648747", "createdAt": "2020-12-14T18:59:01Z", "author": {"login": "0xdaryl"}, "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -1596,6 +1606,106 @@ J9::CodeGenerator::lowerTreeIfNeeded(\n \n    }\n \n+void\n+J9::CodeGenerator::runGlobalLiveVariablesForGC()\n+   {\n+   auto comp = self()->comp();\n+   auto trHeapMemory = self()->trHeapMemory();\n+   auto trMemory = self()->trMemory();\n+\n+   if (comp->getOption(TR_EnableParanoidOptCheck) || debug(\"paranoidOptCheck\"))\n+      comp->verifyCFG(comp->getMethodSymbol());\n+\n+   TR::StackMemoryRegion stackMemoryRegion(*trMemory);\n+   // Because only live locals are mapped for GC, there is normally no need to\n+   // make sure locals are cleared to NULL during method prologue.\n+   // However, we can have cases where GC-collected locals are live at the start\n+   // of the method. These locals will have to be cleared to NULL during method\n+   // prologue.\n+   // This can happen because of the way we treat non-inlined jsrs.\n+   //\n+   int32_t numLocals = 0;\n+   TR::AutomaticSymbol *p;\n+   ListIterator<TR::AutomaticSymbol> locals(&comp->getMethodSymbol()->getAutomaticList());\n+   for (p = locals.getFirst(); p != NULL; p = locals.getNext())\n+      {\n+      // Mark collected locals as initialized. We will reset this property for\n+      // any locals that are live at the start of the method.\n+      //\n+      if (p->isCollectedReference() &&\n+          (!comp->getOption(TR_MimicInterpreterFrameShape) ||\n+           !comp->areSlotsSharedByRefAndNonRef() ||\n+           p->isSlotSharedByRefAndNonRef()))\n+         p->setInitializedReference();\n+      ++numLocals;\n+      }\n+\n+   if (comp->getOption(TR_EnableAggressiveLiveness))\n+      {\n+      TR::ParameterSymbol *pp;\n+      ListIterator<TR::ParameterSymbol> parms(&comp->getMethodSymbol()->getParameterList());\n+      for (pp = parms.getFirst(); pp != NULL; pp = parms.getNext())\n+         ++numLocals;\n+      }\n+\n+   // Nothing to do if there are no locals\n+   //\n+   if (numLocals == 0)\n+      return;\n+\n+   TR_BitVector *liveVars = NULL;\n+\n+   // Perform liveness analysis\n+   //\n+   bool ignoreOSRuses = false; // Used to be set to true but we cannot set this to true because a variable may not be live in compiled code but may still be needed (live) in the interpreter\n+   /* for mimicInterpreterShape, because OSR points can extend the live range of autos\n+    * autos sharing the same slot in interpreter might end up with overlapped\n+    * live range if OSRUses are not ignored\n+    */\n+   if (comp->getOption(TR_MimicInterpreterFrameShape))\n+      ignoreOSRuses = true;\n+\n+   if (!comp->getFlowGraph()->getStructure())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ff0cc85e1447f0575530a5c6cebae731933796d"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5014bf0f1bae681c90955405d701ad5c9ca35a76", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5014bf0f1bae681c90955405d701ad5c9ca35a76", "committedDate": "2020-12-14T23:12:48Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ff0cc85e1447f0575530a5c6cebae731933796d", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9ff0cc85e1447f0575530a5c6cebae731933796d", "committedDate": "2020-12-09T20:31:33Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "5014bf0f1bae681c90955405d701ad5c9ca35a76", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5014bf0f1bae681c90955405d701ad5c9ca35a76", "committedDate": "2020-12-14T23:12:48Z", "message": "Delay liveness analysis after tree lowering\n\nAfter splitPostGRA, live locals might not be updated\nfor the newly split blocks. GlobalLiveVariablesForGC\nshould be delayed until after tree lowering to avoid\nrerunning it again.\n\nCo-authored-by: Liqun Liu liqunl@ca.ibm.com\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNzQwMTgz", "url": "https://github.com/eclipse-openj9/openj9/pull/11214#pullrequestreview-553740183", "createdAt": "2020-12-16T14:29:58Z", "commit": {"oid": "5014bf0f1bae681c90955405d701ad5c9ca35a76"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1599, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}