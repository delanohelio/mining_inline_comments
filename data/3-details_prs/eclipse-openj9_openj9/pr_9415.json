{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExMTAyNDY0", "number": 9415, "title": "Cache illegal final field modification at the server", "bodyText": "Sends a list of classes that have J9ClassHasIllegalFinalFieldModifications bit set to the server in the compilation request. The class cache at the server is updated before the compilation. During the compilation, the server only sends the message to query the value if the class is not cached. If static field folding takes place in the compilation at the server, the compilation is aborted at the client during the CHTable commit (implemented in #9396) if J9ClassHasIllegalFinalFieldModifications is set at the client during the remote compilation.\nImplements #9358\nSigned-off-by: Annabelle Huo Annabelle.Huo@ibm.com", "createdAt": "2020-04-30T03:29:56Z", "url": "https://github.com/eclipse-openj9/openj9/pull/9415", "merged": true, "mergeCommit": {"oid": "957a07826573fa58672a2e5a6735f7051b91be63"}, "closed": true, "closedAt": "2020-05-01T03:38:46Z", "author": {"login": "a7ehuo"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccukdUgFqTQwMzU4NTc0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABccwaykABqjMyOTA1NTAyMDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNTg1NzQy", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#pullrequestreview-403585742", "createdAt": "2020-04-30T14:39:05Z", "commit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDozOTowNVrOGOsZCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNTowNTo1MFrOGOtmVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2MDU1Mg==", "bodyText": "This second line of comment can be removed.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418060552", "createdAt": "2020-04-30T14:39:05Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/HookedByTheJit.cpp", "diffHunk": "@@ -2484,20 +2484,25 @@ void jitIllegalFinalFieldModification(J9VMThread *currentThread, J9Class *fieldC\n    {\n    J9JITConfig * jitConfig = currentThread->javaVM->jitConfig;\n    TR::CompilationInfo * compInfo = TR::CompilationInfo::get(jitConfig);\n+   TR_J9VMBase * fe = TR_J9VMBase::get(jitConfig, currentThread);\n+\n+   // Set the bit so that VM doesn't report the modification next time\n+   fieldClass->classFlags |= J9ClassHasIllegalFinalFieldModifications;\n \n #if defined(J9VM_OPT_JITSERVER)\n    if (compInfo->getPersistentInfo()->getRemoteCompilationMode() == JITServer::SERVER)\n       {\n       // Don't execute this hook at the jitserver side\n       // This piece of code will be removed once all JIT hooks is disabled at the jitserver side", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2MjE2NA==", "bodyText": "Let's split this line because it's too long", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418062164", "createdAt": "2020-04-30T14:41:16Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -3138,6 +3138,9 @@ remoteCompile(\n    // Collect the list of unloaded classes\n    std::vector<TR_OpaqueClassBlock*> unloadedClasses(compInfo->getUnloadedClassesTempList()->begin(), compInfo->getUnloadedClassesTempList()->end());\n    compInfo->getUnloadedClassesTempList()->clear();\n+   std::vector<TR_OpaqueClassBlock*> illegalModificationList(compInfo->getIllegalFinalFieldModificationList()->begin(),\n+                                                                       compInfo->getIllegalFinalFieldModificationList()->end());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2ODQ3OA==", "bodyText": "Changes from #9396 need to be incorporated. Please rebase.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418068478", "createdAt": "2020-04-30T14:49:31Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/CHTable.cpp", "diffHunk": "@@ -377,7 +377,7 @@ bool TR_CHTable::commit(TR::Compilation *comp)\n          {\n          if (TR::Options::isAnyVerboseOptionSet(TR_VerboseRuntimeAssumptions, TR_VerboseCompileEnd, TR_VerbosePerformance, TR_VerboseCompFailure))\n             {\n-            TR_VerboseLog::writeLineLocked(TR_Vlog_FAILURE, \"Failure while commiting static final field assumption for class %p for %s\", clazz, comp->signature());\n+            TR_VerboseLog::writeLineLocked(TR_Vlog_FAILURE, \"hasIllegalStaticFinalFieldModification: Failure while commiting static final field assumption for class %p for %s\", clazz, comp->signature());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA3MDA3OQ==", "bodyText": "This commented out code needs to be deleted.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418070079", "createdAt": "2020-04-30T14:51:48Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/env/J9ClassEnv.cpp", "diffHunk": "@@ -353,8 +353,25 @@ J9::ClassEnv::classHasIllegalStaticFinalFieldModification(TR_OpaqueClassBlock *\n #if defined(J9VM_OPT_JITSERVER)\n    if (auto stream = TR::CompilationInfo::getStream())\n       {\n+#if 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA3OTQzNA==", "bodyText": "I thought about it and we don't need to acquire the RWMutex for this operation.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418079434", "createdAt": "2020-04-30T15:04:32Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -200,6 +200,39 @@ ClientSessionData::processUnloadedClasses(const std::vector<TR_OpaqueClassBlock*\n       writeReleaseClassUnloadRWMutex();\n    }\n \n+void\n+ClientSessionData::processIllegalFinalFieldModificationList(const std::vector<TR_OpaqueClassBlock*> &classes)\n+   {\n+   const size_t numOfClasses = classes.size();\n+\n+   if (TR::Options::getVerboseOption(TR_VerboseJITServer))\n+      TR_VerboseLog::writeLineLocked(TR_Vlog_JITServer,\n+         \"compThreadID=%d will process a list of %zu classes with illegal final field modification for clientUID %llu\",\n+            TR::compInfoPT->getCompThreadId(), numOfClasses, (unsigned long long)_clientUID);\n+\n+   if (numOfClasses > 0)\n+      writeAcquireClassUnloadRWMutex(); //TODO: use RAII style to avoid problems with exceptions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4MDM0Mg==", "bodyText": "TR::compInfoPT->getCompThreadId() uses thread local storage which has overhead. Let's cache this and not call it repeatedly in the loop.", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#discussion_r418080342", "createdAt": "2020-04-30T15:05:50Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -200,6 +200,39 @@ ClientSessionData::processUnloadedClasses(const std::vector<TR_OpaqueClassBlock*\n       writeReleaseClassUnloadRWMutex();\n    }\n \n+void\n+ClientSessionData::processIllegalFinalFieldModificationList(const std::vector<TR_OpaqueClassBlock*> &classes)\n+   {\n+   const size_t numOfClasses = classes.size();\n+\n+   if (TR::Options::getVerboseOption(TR_VerboseJITServer))\n+      TR_VerboseLog::writeLineLocked(TR_Vlog_JITServer,\n+         \"compThreadID=%d will process a list of %zu classes with illegal final field modification for clientUID %llu\",\n+            TR::compInfoPT->getCompThreadId(), numOfClasses, (unsigned long long)_clientUID);\n+\n+   if (numOfClasses > 0)\n+      writeAcquireClassUnloadRWMutex(); //TODO: use RAII style to avoid problems with exceptions\n+\n+      {\n+      OMR::CriticalSection processClassesWithIllegalModification(getROMMapMonitor());\n+      for (auto clazz : classes)\n+         {\n+         auto it = _romClassMap.find((J9Class*)clazz);\n+         if (it != _romClassMap.end())\n+            {\n+            it->second._classFlags |= J9ClassHasIllegalFinalFieldModifications;\n+            if (TR::Options::getVerboseOption(TR_VerboseJITServer))\n+               TR_VerboseLog::writeLineLocked(TR_Vlog_JITServer,\n+                  \"compThreadID=%d found clazz %p in the cache and updated bit J9ClassHasIllegalFinalFieldModifications to 1\\n\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91c3579f653c1c8394b11805afb4aea6d4108605", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/91c3579f653c1c8394b11805afb4aea6d4108605", "committedDate": "2020-04-30T03:27:44Z", "message": "Cache classes with illegal final field modification at the server\n\nA list of the classes with J9ClassHasIllegalFinalFieldModifications\nbit set is sent to the server in the compilation request. The cache\nat the server is updated before the compilation. During the compilation,\nthe server only sends the message to query the value\nif this bit is not set.\n\nImplements #9358\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "09319e9b4f0de00ae72bd07dcfcebc7e2f7e0f45", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/09319e9b4f0de00ae72bd07dcfcebc7e2f7e0f45", "committedDate": "2020-04-30T15:18:56Z", "message": "Cache classes with illegal final field modification at the server\n\nSends a list of classes that have  J9ClassHasIllegalFinalFieldModifications\nbit set to the server in the compilation request. The class cache\nat the server is updated before the compilation. During the compilation,\nthe server only sends the message to query the value if the class is\nnot cached. If static field folding takes place in the\ncompilation at the server, the compilation is aborted at the client\nduring the CHTable commit (implemented in #9396)\nif J9ClassHasIllegalFinalFieldModifications is set at the client\nduring the remote compilation.\n\nImplements #9358\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09319e9b4f0de00ae72bd07dcfcebc7e2f7e0f45", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/09319e9b4f0de00ae72bd07dcfcebc7e2f7e0f45", "committedDate": "2020-04-30T15:18:56Z", "message": "Cache classes with illegal final field modification at the server\n\nSends a list of classes that have  J9ClassHasIllegalFinalFieldModifications\nbit set to the server in the compilation request. The class cache\nat the server is updated before the compilation. During the compilation,\nthe server only sends the message to query the value if the class is\nnot cached. If static field folding takes place in the\ncompilation at the server, the compilation is aborted at the client\nduring the CHTable commit (implemented in #9396)\nif J9ClassHasIllegalFinalFieldModifications is set at the client\nduring the remote compilation.\n\nImplements #9358\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "2026b170c9288ab1b9b7e0316701cf46a22fdf99", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2026b170c9288ab1b9b7e0316701cf46a22fdf99", "committedDate": "2020-04-30T15:48:37Z", "message": "Cache classes with illegal final field modification at the server\n\nSends a list of classes that have  J9ClassHasIllegalFinalFieldModifications\nbit set to the server in the compilation request. The class cache\nat the server is updated before the compilation. During the compilation,\nthe server only sends the message to query the value if the class is\nnot cached. If static field folding takes place in the\ncompilation at the server, the compilation is aborted at the client\nduring the CHTable commit (implemented in #9396)\nif J9ClassHasIllegalFinalFieldModifications is set at the client\nduring the remote compilation.\n\nImplements #9358\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2026b170c9288ab1b9b7e0316701cf46a22fdf99", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/2026b170c9288ab1b9b7e0316701cf46a22fdf99", "committedDate": "2020-04-30T15:48:37Z", "message": "Cache classes with illegal final field modification at the server\n\nSends a list of classes that have  J9ClassHasIllegalFinalFieldModifications\nbit set to the server in the compilation request. The class cache\nat the server is updated before the compilation. During the compilation,\nthe server only sends the message to query the value if the class is\nnot cached. If static field folding takes place in the\ncompilation at the server, the compilation is aborted at the client\nduring the CHTable commit (implemented in #9396)\nif J9ClassHasIllegalFinalFieldModifications is set at the client\nduring the remote compilation.\n\nImplements #9358\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "26d606152c1b95a251c95f3089da1471c33f1417", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/26d606152c1b95a251c95f3089da1471c33f1417", "committedDate": "2020-04-30T16:00:39Z", "message": "Cache classes with illegal final field modification at the server\n\nSends a list of classes that have  J9ClassHasIllegalFinalFieldModifications\nbit set to the server in the compilation request. The class cache\nat the server is updated before the compilation. During the compilation,\nthe server only sends the message to query the value if the class is\nnot cached. If static field folding takes place in the\ncompilation at the server, the compilation is aborted at the client\nduring the CHTable commit (implemented in #9396)\nif J9ClassHasIllegalFinalFieldModifications is set at the client\nduring the remote compilation.\n\nImplements #9358\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNzA3NDA2", "url": "https://github.com/eclipse-openj9/openj9/pull/9415#pullrequestreview-403707406", "createdAt": "2020-04-30T16:58:25Z", "commit": {"oid": "26d606152c1b95a251c95f3089da1471c33f1417"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e14f4bf77c52e616f6aec843c625d24b4332fecb", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e14f4bf77c52e616f6aec843c625d24b4332fecb", "committedDate": "2020-04-30T17:19:43Z", "message": "Cache illegal final field modification at the server\n\nSends a list of classes that have J9ClassHasIllegalFinalFieldModifications\nbit set to the server in the compilation request. The class cache\nat the server is updated before the compilation. During the compilation,\nthe server only sends the message to query the value if the class is\nnot cached. If static field folding takes place in the\ncompilation at the server, the compilation is aborted at the client\nduring the CHTable commit (implemented in #9396)\nif J9ClassHasIllegalFinalFieldModifications is set at the client\nduring the remote compilation.\n\nImplements #9358\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26d606152c1b95a251c95f3089da1471c33f1417", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/26d606152c1b95a251c95f3089da1471c33f1417", "committedDate": "2020-04-30T16:00:39Z", "message": "Cache classes with illegal final field modification at the server\n\nSends a list of classes that have  J9ClassHasIllegalFinalFieldModifications\nbit set to the server in the compilation request. The class cache\nat the server is updated before the compilation. During the compilation,\nthe server only sends the message to query the value if the class is\nnot cached. If static field folding takes place in the\ncompilation at the server, the compilation is aborted at the client\nduring the CHTable commit (implemented in #9396)\nif J9ClassHasIllegalFinalFieldModifications is set at the client\nduring the remote compilation.\n\nImplements #9358\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}, "afterCommit": {"oid": "e14f4bf77c52e616f6aec843c625d24b4332fecb", "author": {"user": {"login": "a7ehuo", "name": "Annabelle Huo"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/e14f4bf77c52e616f6aec843c625d24b4332fecb", "committedDate": "2020-04-30T17:19:43Z", "message": "Cache illegal final field modification at the server\n\nSends a list of classes that have J9ClassHasIllegalFinalFieldModifications\nbit set to the server in the compilation request. The class cache\nat the server is updated before the compilation. During the compilation,\nthe server only sends the message to query the value if the class is\nnot cached. If static field folding takes place in the\ncompilation at the server, the compilation is aborted at the client\nduring the CHTable commit (implemented in #9396)\nif J9ClassHasIllegalFinalFieldModifications is set at the client\nduring the remote compilation.\n\nImplements #9358\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1130, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}