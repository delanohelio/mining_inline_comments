{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MDkxNDAw", "number": 10366, "title": "Recognize Unsafe.copyMemory0 in JDK11", "bodyText": "OpenJ9 contains the optimization that recognizes the JNI call sun/misc/Unsafe.copyMemory and transforms it to System.arrayCopy calls, which is inlined and optimized on most of the platform. Due to implementation changes in JDK11 we can not apply this optimization to sun/misc/Unsafe.copyMemory method which in Java 11 acts as a java wrapper that calls the implementation of copyMemory method from jdk/internal/misc/Unsafe class. This implementation contains additional changes to check range for the source and destination (in case of illegal access throws RuntimeException) before calling the\nactual JNI method jdk/internal/misc/Unsafe.copyMemory0 which can be transformed to System.arrayCopy call. Due to this behavioural changes, when compiling method that calls Unsafe.copyMemory, we need to make sure that optimizer is exposed to JNI call Unsafe.copyMemory0 and that call is recognized same way as JNI call sun/misc/Unsafe.copyMemory is recognized in Java 8 to optimize it further.\nSigned-off-by: Rahil Shah rahil@ca.ibm.com", "createdAt": "2020-08-11T13:04:26Z", "url": "https://github.com/eclipse-openj9/openj9/pull/10366", "merged": true, "mergeCommit": {"oid": "b27e6eec6bc38771136e7081e4fb1864d2c0315b"}, "closed": true, "closedAt": "2020-09-16T13:08:36Z", "author": {"login": "r30shah"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc92i8LAFqTQ2NTA0NjMyNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJbsw0gBqjM3NzI5NzkwMjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MDQ2MzI0", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#pullrequestreview-465046324", "createdAt": "2020-08-11T13:08:29Z", "commit": {"oid": "643d77094f17e6804dca021bf8e12c9a8a638090"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMzowODoyOVrOG-29fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMzowODoyOVrOG-29fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU2NTM3Mg==", "bodyText": "I have a question to both @gita-omr  and @andrewcraik , I see that P and x86 codegen further forces the Unsafe.copyMemory calls to be inlined in case optimizer misses it. I do not see we do it on Z. Is it possible (Apart from running with noOpt) that optimizer would miss this call to transform?", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#discussion_r468565372", "createdAt": "2020-08-11T13:08:29Z", "author": {"login": "r30shah"}, "path": "runtime/compiler/p/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -11993,8 +11993,11 @@ J9::Power::CodeGenerator::inlineDirectCall(TR::Node *node, TR::Register *&result\n             }\n          break;\n          }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "643d77094f17e6804dca021bf8e12c9a8a638090"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MDY0NTM2", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#pullrequestreview-465064536", "createdAt": "2020-08-11T13:29:25Z", "commit": {"oid": "643d77094f17e6804dca021bf8e12c9a8a638090"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMzoyOToyNlrOG-3z0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMzozMTo1NFrOG-36kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU3OTI4Mw==", "bodyText": "I am not a fan of ifdef'd enum entries this makes corefile analysis and other things much harder than it needs to be - keep the numbering consistent. We do not generally use JDK version macros like this.", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#discussion_r468579283", "createdAt": "2020-08-11T13:29:26Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/codegen/J9RecognizedMethodsEnum.hpp", "diffHunk": "@@ -415,6 +415,10 @@\n \n    sun_misc_Unsafe_ensureClassInitialized,\n \n+#if JAVA_SPEC_VERSION >= 11", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "643d77094f17e6804dca021bf8e12c9a8a638090"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU4MTAxMA==", "bodyText": "I really don't think the method specific naming convention here makes sense. I think we should have an Unsafe_copyMemory_intrinsic which is what we match the sun/misc/Unsafe.copyMemory to under JDK8 and what we match the copyMemory0 to under JDK11. I think also that if there is a method to be inlined like jdk_internal_misc_Unsafe_copyMmeory0 that recognition can be matched unconditionally - it will only match when we are running JDK11 onward when the method moved. If there is a windows where the method moved but was native we can just check for the method being native before we recognize it and make all that matching code uncondition.\nUsing the Unsafe_copyMemory_intrinsic that is what OMR can reference and avoid Java specific issues to surface at that level of the architecture.", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#discussion_r468581010", "createdAt": "2020-08-11T13:31:54Z", "author": {"login": "andrewcraik"}, "path": "runtime/compiler/il/J9Node.cpp", "diffHunk": "@@ -299,7 +299,12 @@ J9::Node::processJNICall(TR::TreeTop * callNodeTreeTop, TR::ResolvedMethodSymbol\n #endif\n \n    if (comp->canTransformUnsafeCopyToArrayCopy() &&\n-       (methodSymbol->getRecognizedMethod() == TR::sun_misc_Unsafe_copyMemory))\n+#if JAVA_SPEC_VERSION == 8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "643d77094f17e6804dca021bf8e12c9a8a638090"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "643d77094f17e6804dca021bf8e12c9a8a638090", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/643d77094f17e6804dca021bf8e12c9a8a638090", "committedDate": "2020-08-11T13:00:27Z", "message": "Recognize Unsafe.copyMemory0 in JDK11\n\nOpenJ9 contains the optimization that recognizes the JNI call\nsun/misc/Unsafe.copyMemory and transforms it to System.arrayCopy calls,\nwhich is inlined and optimized on most of the platform. Due to\nimplementation changes in JDK11 we can not apply this optimization to\nsun/misc/Unsafe.copyMemory method which in Java 11 acts as a java\nwrapper that calls the implementation of copyMemory method from\njdk/internal/misc/Unsafe class. This implementation contains additional\nchanges to check range for the source and destination (in case of\nillegal access throws RuntimeException) before calling the\nactual JNI method jdk/internal/misc/Unsafe.copyMemory0 which can be\ntransformed to System.arrayCopy call. Due to this behavioural changes,\nwhen compiling method that calls Unsafe.copyMemory, we need to make sure\nthat optimizer is exposed to JNI call Unsafe.copyMemory0 and that call\nis recognized same way as JNI call sun/misc/Unsafe.copyMemory is\nrecognized in Java 8 to optimize it further.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "5bba1b1fbddd33850baf2a68cf9bd80d96689234", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5bba1b1fbddd33850baf2a68cf9bd80d96689234", "committedDate": "2020-08-11T20:43:44Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bba1b1fbddd33850baf2a68cf9bd80d96689234", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5bba1b1fbddd33850baf2a68cf9bd80d96689234", "committedDate": "2020-08-11T20:43:44Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "cdb436ce300395af11b2c1e141c4aa783f6e71b2", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/cdb436ce300395af11b2c1e141c4aa783f6e71b2", "committedDate": "2020-08-12T00:31:43Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTE4MTk2", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#pullrequestreview-465518196", "createdAt": "2020-08-12T00:40:44Z", "commit": {"oid": "cdb436ce300395af11b2c1e141c4aa783f6e71b2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwMDo0MDo0NFrOG_N38Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwMDo0MDo0NFrOG_N38Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk0MDc4NQ==", "bodyText": "I found that having a query on the call node is the most convenient place as we can have all the information to check whether call node is JNI call and it is one of the recognized copyMemory method.", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#discussion_r468940785", "createdAt": "2020-08-12T00:40:44Z", "author": {"login": "r30shah"}, "path": "runtime/compiler/il/J9Node.cpp", "diffHunk": "@@ -2212,6 +2212,23 @@ J9::Node::setDontInlinePutOrderedCall()\n    }\n \n bool\n+J9::Node::isUnsafeCopyMemoryIntrinsic()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdb436ce300395af11b2c1e141c4aa783f6e71b2"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NzYzMjY3", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#pullrequestreview-468763267", "createdAt": "2020-08-17T19:11:08Z", "commit": {"oid": "cdb436ce300395af11b2c1e141c4aa783f6e71b2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxOToxMTowOFrOHB3fDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxOToxMzowOFrOHB3i1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxOTY5Mw==", "bodyText": "These seem to only get used within the if block below. Can we move them there to limit the scope of the variables and make the code easier to reason about?", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#discussion_r471719693", "createdAt": "2020-08-17T19:11:08Z", "author": {"login": "fjeremic"}, "path": "runtime/compiler/optimizer/J9ValuePropagation.cpp", "diffHunk": "@@ -483,6 +483,88 @@ bool J9::ValuePropagation::transformIndexOfKnownString(\n    return false;\n    }\n \n+bool J9::ValuePropagation::transformUnsafeCopyMemoryCall(TR::Node *arraycopyNode)\n+   {\n+   if (!canRunTransformToArrayCopy())\n+      return false;\n+\n+   TR::TreeTop *tt = _curTree;\n+   TR::Node *ttNode = tt->getNode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdb436ce300395af11b2c1e141c4aa783f6e71b2"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcyMDY2MQ==", "bodyText": "We can move these definitions down to where the variables get set, so:\n         int64_t srcOffLow   = srcOffsetConstraint ? srcOffsetConstraint->getLowInt() : TR::getMinSigned<TR::Int32>();\n         int64_t srcOffHigh  = srcOffsetConstraint ? srcOffsetConstraint->getHighInt() : TR::getMaxSigned<TR::Int32>();\n         int64_t dstOffLow   = dstOffsetConstraint ? dstOffsetConstraint->getLowInt() : TR::getMinSigned<TR::Int32>();\n         int64_t dstOffHigh  = dstOffsetConstraint ? dstOffsetConstraint->getHighInt() : TR::getMaxSigned<TR::Int32>();\n         int64_t copyLenLow  = copyLenConstraint   ? copyLenConstraint->getLowInt() : TR::getMinSigned<TR::Int32>();\n         int64_t copyLenHigh = copyLenConstraint   ? copyLenConstraint->getHighInt() : TR::getMaxSigned<TR::Int32>();", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#discussion_r471720661", "createdAt": "2020-08-17T19:13:08Z", "author": {"login": "fjeremic"}, "path": "runtime/compiler/optimizer/J9ValuePropagation.cpp", "diffHunk": "@@ -483,6 +483,88 @@ bool J9::ValuePropagation::transformIndexOfKnownString(\n    return false;\n    }\n \n+bool J9::ValuePropagation::transformUnsafeCopyMemoryCall(TR::Node *arraycopyNode)\n+   {\n+   if (!canRunTransformToArrayCopy())\n+      return false;\n+\n+   TR::TreeTop *tt = _curTree;\n+   TR::Node *ttNode = tt->getNode();\n+\n+   if (comp()->canTransformUnsafeCopyToArrayCopy()\n+         && arraycopyNode->isUnsafeCopyMemoryIntrinsic())\n+      {\n+\n+      if ((ttNode->getOpCodeValue() == TR::treetop || ttNode->getOpCode().isResolveOrNullCheck())\n+            && performTransformation(comp(), \"%sChanging call Unsafe.copyMemory [%p] to arraycopy\\n\", OPT_DETAILS, arraycopyNode))\n+\n+         {\n+         TR::Node *unsafe     = arraycopyNode->getChild(0);\n+         TR::Node *src        = arraycopyNode->getChild(1);\n+         TR::Node *srcOffset  = arraycopyNode->getChild(2);\n+         TR::Node *dest       = arraycopyNode->getChild(3);\n+         TR::Node *destOffset = arraycopyNode->getChild(4);\n+         TR::Node *len        = arraycopyNode->getChild(5);\n+\n+         int64_t srcOffLow;\n+         int64_t srcOffHigh;\n+         int64_t dstOffLow;\n+         int64_t dstOffHigh;\n+         int64_t copyLenLow;\n+         int64_t copyLenHigh;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdb436ce300395af11b2c1e141c4aa783f6e71b2"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdb436ce300395af11b2c1e141c4aa783f6e71b2", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/cdb436ce300395af11b2c1e141c4aa783f6e71b2", "committedDate": "2020-08-12T00:31:43Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "d8f5f521fc955e5cb1fbfeaa0d418cb475503a1a", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d8f5f521fc955e5cb1fbfeaa0d418cb475503a1a", "committedDate": "2020-08-17T19:52:30Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8f5f521fc955e5cb1fbfeaa0d418cb475503a1a", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/d8f5f521fc955e5cb1fbfeaa0d418cb475503a1a", "committedDate": "2020-08-17T19:52:30Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "ff0b1e1650935286a1a1c68ca3f5b8d8402e489a", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ff0b1e1650935286a1a1c68ca3f5b8d8402e489a", "committedDate": "2020-08-17T19:54:39Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff0b1e1650935286a1a1c68ca3f5b8d8402e489a", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/ff0b1e1650935286a1a1c68ca3f5b8d8402e489a", "committedDate": "2020-08-17T19:54:39Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "5b7e35a24c88400aebba54647550e37df536c44c", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5b7e35a24c88400aebba54647550e37df536c44c", "committedDate": "2020-08-17T19:58:34Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4ODQxODQ2", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#pullrequestreview-468841846", "createdAt": "2020-08-17T21:22:19Z", "commit": {"oid": "5b7e35a24c88400aebba54647550e37df536c44c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QyMToyMjoxOVrOHB7Tzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QyMToyNzo0NlrOHB7dtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4MjM1MQ==", "bodyText": "So many return points! Now sure if this would be cleaner:\n   if (self()->getOpCode().isCall() && self()->getSymbol()->isMethod())\n      {\n      TR::MethodSymbol *symbol = self()->getSymbol()->getMethodSymbol();\n      if (symbol != NULL && symbol->isNative())\n         {\n         switch (symbol->getRecognizedMethod())\n            {\n            case TR::sun_misc_Unsafe_copyMemory:\n            case TR::jdk_internal_misc_Unsafe_copyMemory0:\n                return true;\n            default:\n                break;\n            }\n         }\n      }\n   \n   return false;", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#discussion_r471782351", "createdAt": "2020-08-17T21:22:19Z", "author": {"login": "fjeremic"}, "path": "runtime/compiler/il/J9Node.cpp", "diffHunk": "@@ -2212,6 +2212,23 @@ J9::Node::setDontInlinePutOrderedCall()\n    }\n \n bool\n+J9::Node::isUnsafeCopyMemoryIntrinsic()\n+   {\n+   if (!self()->getOpCode().isCall() || !self()->getSymbol()->isMethod())\n+      return false;\n+   TR::MethodSymbol *symbol = self()->getSymbol()->getMethodSymbol();\n+   if (!symbol || !symbol->isNative())\n+      return false;\n+   switch (symbol->getRecognizedMethod())\n+      {\n+      case TR::sun_misc_Unsafe_copyMemory:\n+      case TR::jdk_internal_misc_Unsafe_copyMemory0:\n+         return true;\n+      default:\n+         return false;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b7e35a24c88400aebba54647550e37df536c44c"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4MjU0Mg==", "bodyText": "This needs to be Doxygen documented as to why it exists and what is its purpose.", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#discussion_r471782542", "createdAt": "2020-08-17T21:22:45Z", "author": {"login": "fjeremic"}, "path": "runtime/compiler/il/J9Node.hpp", "diffHunk": "@@ -284,6 +284,8 @@ class OMR_EXTENSIBLE Node : public OMR::NodeConnector\n    bool chkDontInlineUnsafePutOrderedCall();\n    const char * printIsDontInlineUnsafePutOrderedCall();\n \n+   bool isUnsafeCopyMemoryIntrinsic();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b7e35a24c88400aebba54647550e37df536c44c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4NDg4Ng==", "bodyText": "IMO we should move that reduction out of the codegen evaluators and right into the J9RecognizedCallTransformer so all codegens can transparently take advantage. I'd try to avoid duplicating the already duplicated logic on Z.", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#discussion_r471784886", "createdAt": "2020-08-17T21:27:46Z", "author": {"login": "fjeremic"}, "path": "runtime/compiler/p/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -11993,8 +11993,11 @@ J9::Power::CodeGenerator::inlineDirectCall(TR::Node *node, TR::Register *&result\n             }\n          break;\n          }\n-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU2NTM3Mg=="}, "originalCommit": {"oid": "643d77094f17e6804dca021bf8e12c9a8a638090"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b7e35a24c88400aebba54647550e37df536c44c", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/5b7e35a24c88400aebba54647550e37df536c44c", "committedDate": "2020-08-17T19:58:34Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "91cf3d3105d3cec00915a532186cdcbf5977262d", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/91cf3d3105d3cec00915a532186cdcbf5977262d", "committedDate": "2020-08-18T00:55:09Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91cf3d3105d3cec00915a532186cdcbf5977262d", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/91cf3d3105d3cec00915a532186cdcbf5977262d", "committedDate": "2020-08-18T00:55:09Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "fa538f2b7d215cb17ca22ff9c8893ea698034030", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/fa538f2b7d215cb17ca22ff9c8893ea698034030", "committedDate": "2020-08-18T01:01:59Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NzA4MTM1", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#pullrequestreview-469708135", "createdAt": "2020-08-18T18:14:35Z", "commit": {"oid": "fa538f2b7d215cb17ca22ff9c8893ea698034030"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODoxNDozNVrOHCgZng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODoxNDozNVrOHCgZng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM5MDA0Ng==", "bodyText": "This API seems very very specific for it to exist in the Node class. I worry this class will turn into a kitchen sink eventually. Does this really need to exist? It seems it gets used in two locations:\n\nIn processJNICall which we can just replace with:\n\n   if (comp->canTransformUnsafeCopyToArrayCopy() &&\n       (methodSymbol->getRecognizedMethod() == TR::sun_misc_Unsafe_copyMemory ||\n        methodSymbol->getRecognizedMethod() == TR::jdk_internal_misc_Unsafe_copyMemory0))\n\n\nIn transformUnsafeCopyMemoryCall which we can just inline a partial version of this API.\n\nAre we sure introducing this extra complexity into the Node class outweighs the benefits?", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#discussion_r472390046", "createdAt": "2020-08-18T18:14:35Z", "author": {"login": "fjeremic"}, "path": "runtime/compiler/il/J9Node.hpp", "diffHunk": "@@ -284,6 +284,11 @@ class OMR_EXTENSIBLE Node : public OMR::NodeConnector\n    bool chkDontInlineUnsafePutOrderedCall();\n    const char * printIsDontInlineUnsafePutOrderedCall();\n \n+   /**\n+    * Checks  and return true if the callNode is JNI Call to Unsafe.copyMemory\n+    */\n+   bool isUnsafeCopyMemoryIntrinsic();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa538f2b7d215cb17ca22ff9c8893ea698034030"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa538f2b7d215cb17ca22ff9c8893ea698034030", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/fa538f2b7d215cb17ca22ff9c8893ea698034030", "committedDate": "2020-08-18T01:01:59Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "82e89e96d1f5f02429331969faa477cd5ba0cef2", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/82e89e96d1f5f02429331969faa477cd5ba0cef2", "committedDate": "2020-08-20T14:57:04Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NzY3NzY4", "url": "https://github.com/eclipse-openj9/openj9/pull/10366#pullrequestreview-476767768", "createdAt": "2020-08-27T14:18:14Z", "commit": {"oid": "82e89e96d1f5f02429331969faa477cd5ba0cef2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82e89e96d1f5f02429331969faa477cd5ba0cef2", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/82e89e96d1f5f02429331969faa477cd5ba0cef2", "committedDate": "2020-08-20T14:57:04Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "9939a4f246b56aaa499c1f2050b4f440d8a1b758", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9939a4f246b56aaa499c1f2050b4f440d8a1b758", "committedDate": "2020-08-27T14:37:49Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9939a4f246b56aaa499c1f2050b4f440d8a1b758", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/9939a4f246b56aaa499c1f2050b4f440d8a1b758", "committedDate": "2020-08-27T14:37:49Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "dc19287ce8f2ea18c87a0d5416ad6e2c416e7603", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/dc19287ce8f2ea18c87a0d5416ad6e2c416e7603", "committedDate": "2020-09-01T19:23:22Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc19287ce8f2ea18c87a0d5416ad6e2c416e7603", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/dc19287ce8f2ea18c87a0d5416ad6e2c416e7603", "committedDate": "2020-09-01T19:23:22Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "46b265ee4633c2c41f02d28b5d8172b3e6b4301d", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/46b265ee4633c2c41f02d28b5d8172b3e6b4301d", "committedDate": "2020-09-08T15:08:09Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46b265ee4633c2c41f02d28b5d8172b3e6b4301d", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/46b265ee4633c2c41f02d28b5d8172b3e6b4301d", "committedDate": "2020-09-08T15:08:09Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "49d0470e0d073c1ac9d7f5f13ebaf583d301a827", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/49d0470e0d073c1ac9d7f5f13ebaf583d301a827", "committedDate": "2020-09-14T14:24:35Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2307543b065b7dbd940928977b0b6ef9299ae7b", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c2307543b065b7dbd940928977b0b6ef9299ae7b", "committedDate": "2020-09-16T12:38:41Z", "message": "Recognize Unsafe.copyMemory0 in JDK11\n\nOpenJ9 contains the optimization that recognizes the JNI call\nsun/misc/Unsafe.copyMemory and transforms it to System.arrayCopy calls,\nwhich is inlined and optimized on most of the platform. Due to\nimplementation changes in JDK11 we can not apply this optimization to\nsun/misc/Unsafe.copyMemory method which in Java 11 acts as a java\nwrapper that calls the implementation of copyMemory method from\njdk/internal/misc/Unsafe class. This implementation contains additional\nchanges to check range for the source and destination (in case of\nillegal access throws RuntimeException) before calling the\nactual JNI method jdk/internal/misc/Unsafe.copyMemory0 which can be\ntransformed to System.arrayCopy call. Due to this behavioural changes,\nwhen compiling method that calls Unsafe.copyMemory, we need to make sure\nthat optimizer is exposed to JNI call Unsafe.copyMemory0 and that call\nis recognized same way as JNI call sun/misc/Unsafe.copyMemory is\nrecognized in Java 8 to optimize it further.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8663fcc199a1c2934fe0f531ce1eb729a6c9797", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c8663fcc199a1c2934fe0f531ce1eb729a6c9797", "committedDate": "2020-09-16T12:38:41Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "49d0470e0d073c1ac9d7f5f13ebaf583d301a827", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/49d0470e0d073c1ac9d7f5f13ebaf583d301a827", "committedDate": "2020-09-14T14:24:35Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}, "afterCommit": {"oid": "c8663fcc199a1c2934fe0f531ce1eb729a6c9797", "author": {"user": {"login": "r30shah", "name": "Rahil Shah"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/c8663fcc199a1c2934fe0f531ce1eb729a6c9797", "committedDate": "2020-09-16T12:38:41Z", "message": "Move transformUnsafeCopyMemoryCall in OpenJ9\n\nTransformation from Unsafe.copyMemory to System.arrayCopy was Java\nspecific transformation. This commit moves the transformation to OpenJ9.\n\nSigned-off-by: Rahil Shah <rahil@ca.ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 122, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}