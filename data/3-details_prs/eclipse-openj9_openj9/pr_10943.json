{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3MDUzNTg5", "number": 10943, "title": "Fix the Chinese modules path issue in JVM initialization", "bodyText": "The change is to convert the module path from UTF8 to\nthe platform encode setting on Windows to ensure it works\ncorrectly to open the jimage file.\nFixes: #10312\nSigned-off-by: Cheng Jin jincheng@ca.ibm.com", "createdAt": "2020-10-20T19:46:19Z", "url": "https://github.com/eclipse-openj9/openj9/pull/10943", "merged": true, "mergeCommit": {"oid": "e648c0e1baa3da963d1b9814b9107680bc53c434"}, "closed": true, "closedAt": "2020-10-21T19:30:53Z", "author": {"login": "ChengJin01"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUfUpoAFqTUxMzEyMTkwNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUykclgFqTUxNDExMjAxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTIxOTA2", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#pullrequestreview-513121906", "createdAt": "2020-10-20T20:49:46Z", "commit": {"oid": "4464ced0af3700acc7c63da90324feb39703b24c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDo0OTo0N1rOHlQh0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDo1NDozOFrOHlQsjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMDE2MA==", "bodyText": "The version check isn't needed here, this function is only called for Java 11+.", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508830160", "createdAt": "2020-10-20T20:49:47Z", "author": {"login": "pshipton"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -1448,6 +1431,81 @@ initializeClassPathEntry (J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n \tcpEntry->extraInfo = NULL;\n \treturn CPE_TYPE_UNUSABLE;\n }\n+\n+IDATA\n+initializeModulesPathEntry(J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n+{\n+\tPORT_ACCESS_FROM_JAVAVM(javaVM);\n+\tint32_t attr = 0;\n+#if defined(WIN32)\n+\tchar *convertedModulesPath = NULL;\n+\tIDATA convertedModulesPathLen = 0;\n+#endif /* defined(WIN32) */\n+\n+\t/* Start guessing. Is it a directory? */\n+\tattr = j9file_attr((char *)cpEntry->path);\n+\tif (EsIsDir == attr) {\n+\t\tcpEntry->type = CPE_TYPE_DIRECTORY;\n+\t\treturn CPE_TYPE_DIRECTORY;\n+\t}\n+\n+\tif ((EsIsFile == attr) && (J2SE_VERSION(javaVM) >= J2SE_V11)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4464ced0af3700acc7c63da90324feb39703b24c"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMTgxMQ==", "bodyText": "This should be defined in the inner most scope.", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508831811", "createdAt": "2020-10-20T20:52:33Z", "author": {"login": "pshipton"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -1448,6 +1431,81 @@ initializeClassPathEntry (J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n \tcpEntry->extraInfo = NULL;\n \treturn CPE_TYPE_UNUSABLE;\n }\n+\n+IDATA\n+initializeModulesPathEntry(J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n+{\n+\tPORT_ACCESS_FROM_JAVAVM(javaVM);\n+\tint32_t attr = 0;\n+#if defined(WIN32)\n+\tchar *convertedModulesPath = NULL;\n+\tIDATA convertedModulesPathLen = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4464ced0af3700acc7c63da90324feb39703b24c"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMjkwOA==", "bodyText": "This isn't needed, j9str_convert() populates the buffer.", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508832908", "createdAt": "2020-10-20T20:54:38Z", "author": {"login": "pshipton"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -1448,6 +1431,81 @@ initializeClassPathEntry (J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n \tcpEntry->extraInfo = NULL;\n \treturn CPE_TYPE_UNUSABLE;\n }\n+\n+IDATA\n+initializeModulesPathEntry(J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n+{\n+\tPORT_ACCESS_FROM_JAVAVM(javaVM);\n+\tint32_t attr = 0;\n+#if defined(WIN32)\n+\tchar *convertedModulesPath = NULL;\n+\tIDATA convertedModulesPathLen = 0;\n+#endif /* defined(WIN32) */\n+\n+\t/* Start guessing. Is it a directory? */\n+\tattr = j9file_attr((char *)cpEntry->path);\n+\tif (EsIsDir == attr) {\n+\t\tcpEntry->type = CPE_TYPE_DIRECTORY;\n+\t\treturn CPE_TYPE_DIRECTORY;\n+\t}\n+\n+\tif ((EsIsFile == attr) && (J2SE_VERSION(javaVM) >= J2SE_V11)) {\n+\t\tJ9JImageIntf *jimageIntf = javaVM->jimageIntf;\n+\t\tif (NULL != jimageIntf) {\n+\t\t\tI_32 rc = 0;\n+\t\t\tUDATA jimageHandle = 0;\n+\t\t\tchar *modulesPath = (char *)cpEntry->path;\n+#if defined(WIN32)\n+\t\t\tIDATA modulesPathLen = cpEntry->pathLength;\n+\t\t\tconvertedModulesPathLen = j9str_convert(J9STR_CODE_MUTF8, J9STR_CODE_WINDEFAULTACP, modulesPath, modulesPathLen, NULL, 0);\n+\t\t\tif (convertedModulesPathLen > 0) {\n+\t\t\t\tconvertedModulesPath = j9mem_allocate_memory(convertedModulesPathLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\t\tif (convertedModulesPath != NULL) {\n+\t\t\t\t\tmemset(convertedModulesPath, 0, convertedModulesPathLen + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4464ced0af3700acc7c63da90324feb39703b24c"}, "originalPosition": 65}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4464ced0af3700acc7c63da90324feb39703b24c", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/4464ced0af3700acc7c63da90324feb39703b24c", "committedDate": "2020-10-20T19:44:24Z", "message": "Fix the Chinese modules path issue in JVM initialization\n\nThe change is to convert the module path from UTF8 to\nthe platform encode setting on Windows to ensure it works\ncorrectly to open the jimage file.\n\nFixes: #10312\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}, "afterCommit": {"oid": "f940df03505c948030a723c17cc2956003968808", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f940df03505c948030a723c17cc2956003968808", "committedDate": "2020-10-20T21:37:21Z", "message": "Fix the Chinese modules path issue in JVM initialization\n\nThe change is to convert the module path from UTF8 to\nthe platform encode setting on Windows to ensure it works\ncorrectly to open the jimage file.\n\nFixes: #10312\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMjMyMjQ0", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#pullrequestreview-513232244", "createdAt": "2020-10-21T00:47:53Z", "commit": {"oid": "f940df03505c948030a723c17cc2956003968808"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwMDo0Nzo1M1rOHlWSKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwMDo0Nzo1M1rOHlWSKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyNDQ1OA==", "bodyText": "Maybe this needs to be pathLength + 1 to include the terminating NULL, now that the memset has been removed.", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508924458", "createdAt": "2020-10-21T00:47:53Z", "author": {"login": "pshipton"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -1448,6 +1431,79 @@ initializeClassPathEntry (J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n \tcpEntry->extraInfo = NULL;\n \treturn CPE_TYPE_UNUSABLE;\n }\n+\n+IDATA\n+initializeModulesPathEntry(J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n+{\n+\tPORT_ACCESS_FROM_JAVAVM(javaVM);\n+\tint32_t attr = 0;\n+#if defined(WIN32)\n+\tchar *convertedModulesPath = NULL;\n+#endif /* defined(WIN32) */\n+\n+\t/* Start guessing. Is it a directory? */\n+\tattr = j9file_attr((char *)cpEntry->path);\n+\tif (EsIsDir == attr) {\n+\t\tcpEntry->type = CPE_TYPE_DIRECTORY;\n+\t\treturn CPE_TYPE_DIRECTORY;\n+\t}\n+\n+\tif (EsIsFile == attr) {\n+\t\tJ9JImageIntf *jimageIntf = javaVM->jimageIntf;\n+\t\tif (NULL != jimageIntf) {\n+\t\t\tI_32 rc = 0;\n+\t\t\tUDATA jimageHandle = 0;\n+\t\t\tchar *modulesPath = (char *)cpEntry->path;\n+#if defined(WIN32)\n+\t\t\tIDATA modulesPathLen = cpEntry->pathLength;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f940df03505c948030a723c17cc2956003968808"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f626b308ebe728cd5f722d0f8bbb78ab9e106040", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f626b308ebe728cd5f722d0f8bbb78ab9e106040", "committedDate": "2020-10-21T04:23:08Z", "message": "Fix the Chinese modules path issue in JVM initialization\n\nThe change is to convert the module path from UTF8 to\nthe platform encode setting on Windows to ensure it works\ncorrectly to open the jimage file.\n\nFixes: #10312\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f940df03505c948030a723c17cc2956003968808", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f940df03505c948030a723c17cc2956003968808", "committedDate": "2020-10-20T21:37:21Z", "message": "Fix the Chinese modules path issue in JVM initialization\n\nThe change is to convert the module path from UTF8 to\nthe platform encode setting on Windows to ensure it works\ncorrectly to open the jimage file.\n\nFixes: #10312\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}, "afterCommit": {"oid": "f626b308ebe728cd5f722d0f8bbb78ab9e106040", "author": {"user": {"login": "ChengJin01", "name": "Cheng Jin"}}, "url": "https://github.com/eclipse-openj9/openj9/commit/f626b308ebe728cd5f722d0f8bbb78ab9e106040", "committedDate": "2020-10-21T04:23:08Z", "message": "Fix the Chinese modules path issue in JVM initialization\n\nThe change is to convert the module path from UTF8 to\nthe platform encode setting on Windows to ensure it works\ncorrectly to open the jimage file.\n\nFixes: #10312\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTEyMDE1", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#pullrequestreview-514112015", "createdAt": "2020-10-21T19:30:47Z", "commit": {"oid": "f626b308ebe728cd5f722d0f8bbb78ab9e106040"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 233, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}