{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxODIyNjM4", "number": 10672, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzowMjoxN1rOEmsfmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzo0NToyNFrOEnjFPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MDEwMzI5OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/CompilationRuntime.hpp", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzowMjoxN1rOHW4G0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzoyMDoxMlrOHW4xVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0OTk2OA==", "bodyText": "maybe this would be better named as getEntryIfCompiled() or something like that?", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493749968", "createdAt": "2020-09-23T17:02:17Z", "author": {"login": "mstoodle"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc1MjY1Nw==", "bodyText": "I could do that; do you want me to do that in this PR (noting that the PR builds are already underway and that the changes in this PR are going to be cherry-picked into the 0.23 branch) or is it ok if I make the change in another PR?", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493752657", "createdAt": "2020-09-23T17:06:44Z", "author": {"login": "dsouzai"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0OTk2OA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc1OTIwMQ==", "bodyText": "if you think it's the right approach, you can follow on in another PR, I suppose. wouldn't you want the second PR to be cherry picked too?", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493759201", "createdAt": "2020-09-23T17:17:27Z", "author": {"login": "mstoodle"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0OTk2OA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDg1NQ==", "bodyText": "I guess I'm thinking of it from a broader 'clean up how we interact with the extra' field approach. However, if you would want the getEntryIfCompiled() API in 0.23 then I might as well do it in this PR.", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493760855", "createdAt": "2020-09-23T17:20:12Z", "author": {"login": "dsouzai"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0OTk2OA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MDE2NzMwOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/CompilationRuntime.hpp", "isResolved": false, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzoxOTowNlrOHW4urg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxODoyNDowN1rOHYOIMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDE3NA==", "bodyText": "I'm not convinced the compiler has to respect this and only read the field once.  Maybe I should say that more strongly - there's no guarantee the compiler will read method->extra only once here.", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493760174", "createdAt": "2020-09-23T17:19:06Z", "author": {"login": "DanHeidinga"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)\n       {\n #if defined(J9VM_OPT_JITSERVER)\n       if (auto stream = getStream())\n          {\n          stream->write(JITServer::MessageType::CompInfo_isCompiled, method);\n-         return std::get<0>(stream->read<bool>());\n+         return std::get<0>(stream->read<void *>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      /* Read extra field only once */\n+      void *extra = method->extra;\n+\n+      /* Return extra field if compiled, NULL otherwise */\n+      return ((uintptr_t)extra & J9_STARTPC_NOT_TRANSLATED) == 0 ? extra : NULL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4OTM0MQ==", "bodyText": "I'm confused. The code as written cannot see different values for the two uses of the local variable \"extra\". The compiler isn't allowed to change that...", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493789341", "createdAt": "2020-09-23T18:07:29Z", "author": {"login": "mstoodle"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)\n       {\n #if defined(J9VM_OPT_JITSERVER)\n       if (auto stream = getStream())\n          {\n          stream->write(JITServer::MessageType::CompInfo_isCompiled, method);\n-         return std::get<0>(stream->read<bool>());\n+         return std::get<0>(stream->read<void *>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      /* Read extra field only once */\n+      void *extra = method->extra;\n+\n+      /* Return extra field if compiled, NULL otherwise */\n+      return ((uintptr_t)extra & J9_STARTPC_NOT_TRANSLATED) == 0 ? extra : NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDE3NA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5ODE0Ng==", "bodyText": "Couldn't the compiler see that the definition of extra comes from method->extra and just choose to use that since there's been no store to the local variable `extra'? Not sure why it would want to do that, but is that a possibility theoretically speaking?", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493798146", "createdAt": "2020-09-23T18:22:43Z", "author": {"login": "dsouzai"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)\n       {\n #if defined(J9VM_OPT_JITSERVER)\n       if (auto stream = getStream())\n          {\n          stream->write(JITServer::MessageType::CompInfo_isCompiled, method);\n-         return std::get<0>(stream->read<bool>());\n+         return std::get<0>(stream->read<void *>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      /* Read extra field only once */\n+      void *extra = method->extra;\n+\n+      /* Return extra field if compiled, NULL otherwise */\n+      return ((uintptr_t)extra & J9_STARTPC_NOT_TRANSLATED) == 0 ? extra : NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDE3NA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc5OTY2NA==", "bodyText": "As @dsouzai says, the compiler doesn't have to create a local for method->extra (privatize) and is free to continue to fetch from the method.  We've seen occurrences of this kind of behaviour on some platforms in the past, especially when code like this is inlined into other methods", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493799664", "createdAt": "2020-09-23T18:25:11Z", "author": {"login": "DanHeidinga"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)\n       {\n #if defined(J9VM_OPT_JITSERVER)\n       if (auto stream = getStream())\n          {\n          stream->write(JITServer::MessageType::CompInfo_isCompiled, method);\n-         return std::get<0>(stream->read<bool>());\n+         return std::get<0>(stream->read<void *>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      /* Read extra field only once */\n+      void *extra = method->extra;\n+\n+      /* Return extra field if compiled, NULL otherwise */\n+      return ((uintptr_t)extra & J9_STARTPC_NOT_TRANSLATED) == 0 ? extra : NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDE3NA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyMDIzOA==", "bodyText": "ok, yup, must be volatile and we need this change then", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493820238", "createdAt": "2020-09-23T18:53:09Z", "author": {"login": "mstoodle"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)\n       {\n #if defined(J9VM_OPT_JITSERVER)\n       if (auto stream = getStream())\n          {\n          stream->write(JITServer::MessageType::CompInfo_isCompiled, method);\n-         return std::get<0>(stream->read<bool>());\n+         return std::get<0>(stream->read<void *>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      /* Read extra field only once */\n+      void *extra = method->extra;\n+\n+      /* Return extra field if compiled, NULL otherwise */\n+      return ((uintptr_t)extra & J9_STARTPC_NOT_TRANSLATED) == 0 ? extra : NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDE3NA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkxNzI4NQ==", "bodyText": "Would void * volatile extra = method->extra; prevent the compiler from using method->extra instead of the local extra?\nI am thinking that adding the volatile keyword changes the type, so the compiler may not be able to use method->extra and extra interchangeably.", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493917285", "createdAt": "2020-09-23T21:54:23Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)\n       {\n #if defined(J9VM_OPT_JITSERVER)\n       if (auto stream = getStream())\n          {\n          stream->write(JITServer::MessageType::CompInfo_isCompiled, method);\n-         return std::get<0>(stream->read<bool>());\n+         return std::get<0>(stream->read<void *>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      /* Read extra field only once */\n+      void *extra = method->extra;\n+\n+      /* Return extra field if compiled, NULL otherwise */\n+      return ((uintptr_t)extra & J9_STARTPC_NOT_TRANSLATED) == 0 ? extra : NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDE3NA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkzNjU5NQ==", "bodyText": "I still find it mildly disturbing that a C compiler would de-privatize an access to a global variable, but I can also see the line of reasoning that led the optimization folks to find that behaviour desirable, relying on the volatile keyword to indicate that the value can change underfoot.\nThat got me thinking though: do any other variables that can be read or written to without a protective mutex need to be similarly marked as volatile? stackOverflowMark in the VM thread maybe?", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493936595", "createdAt": "2020-09-23T22:46:11Z", "author": {"login": "mstoodle"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)\n       {\n #if defined(J9VM_OPT_JITSERVER)\n       if (auto stream = getStream())\n          {\n          stream->write(JITServer::MessageType::CompInfo_isCompiled, method);\n-         return std::get<0>(stream->read<bool>());\n+         return std::get<0>(stream->read<void *>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      /* Read extra field only once */\n+      void *extra = method->extra;\n+\n+      /* Return extra field if compiled, NULL otherwise */\n+      return ((uintptr_t)extra & J9_STARTPC_NOT_TRANSLATED) == 0 ? extra : NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDE3NA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzMzY4NQ==", "bodyText": "I would think that the struct field being volatile ensures the compiler will use the local copy.", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r495133685", "createdAt": "2020-09-25T17:31:30Z", "author": {"login": "gacholio"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)\n       {\n #if defined(J9VM_OPT_JITSERVER)\n       if (auto stream = getStream())\n          {\n          stream->write(JITServer::MessageType::CompInfo_isCompiled, method);\n-         return std::get<0>(stream->read<bool>());\n+         return std::get<0>(stream->read<void *>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      /* Read extra field only once */\n+      void *extra = method->extra;\n+\n+      /* Return extra field if compiled, NULL otherwise */\n+      return ((uintptr_t)extra & J9_STARTPC_NOT_TRANSLATED) == 0 ? extra : NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDE3NA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzODgyMA==", "bodyText": "I agree. I was wondering if there are any other fields that the JIT accesses directly that could be concurrently updated that should also be marked as volatile (basically, are we sure that this one is the only instance of the problem?).", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r495138820", "createdAt": "2020-09-25T17:42:01Z", "author": {"login": "mstoodle"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)\n       {\n #if defined(J9VM_OPT_JITSERVER)\n       if (auto stream = getStream())\n          {\n          stream->write(JITServer::MessageType::CompInfo_isCompiled, method);\n-         return std::get<0>(stream->read<bool>());\n+         return std::get<0>(stream->read<void *>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      /* Read extra field only once */\n+      void *extra = method->extra;\n+\n+      /* Return extra field if compiled, NULL otherwise */\n+      return ((uintptr_t)extra & J9_STARTPC_NOT_TRANSLATED) == 0 ? extra : NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDE3NA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE1OTM0NA==", "bodyText": "Most of the fields that are concurrently updated are mutexxed, but I'm sure there are a few. J9VMThread.stackOverflowMark comes to mind immediately (since this caused problems on ZOS XLC). All of the RAM constant pool structs should probably be volatile (Jason fixed one in the last year that was causing MSVC to corrupt the field), though they are a somewhat special case in that there are only two possible states (multithreaded resolution always results in the same final values).", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r495159344", "createdAt": "2020-09-25T18:24:07Z", "author": {"login": "gacholio"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -457,17 +457,31 @@ class CompilationInfo\n    static JITServer::ServerStream *getStream();\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    static bool isInterpreted(J9Method *method) { return !isCompiled(method); }\n-   static bool isCompiled(J9Method *method)\n+\n+   /**\n+    * @brief Determines if a J9Method is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* isCompiled(J9Method *method)\n       {\n #if defined(J9VM_OPT_JITSERVER)\n       if (auto stream = getStream())\n          {\n          stream->write(JITServer::MessageType::CompInfo_isCompiled, method);\n-         return std::get<0>(stream->read<bool>());\n+         return std::get<0>(stream->read<void *>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      /* Read extra field only once */\n+      void *extra = method->extra;\n+\n+      /* Return extra field if compiled, NULL otherwise */\n+      return ((uintptr_t)extra & J9_STARTPC_NOT_TRANSLATED) == 0 ? extra : NULL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDE3NA=="}, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MDE3MDYxOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/CompilationThread.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzoxOTo1OVrOHW4wwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzoxOTo1OVrOHW4wwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDcwNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  void *extra;\n          \n          \n            \n                  void *extra = NULL;\n          \n      \n    \n    \n  \n\nEnsure this is definitely assigned", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493760705", "createdAt": "2020-09-23T17:19:59Z", "author": {"login": "DanHeidinga"}, "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -7512,10 +7511,14 @@ TR::CompilationInfoPerThreadBase::postCompilationTasks(J9VMThread * vmThread,\n    else // compilation will not be retried, either because it succeeded or because we don't want to\n       {\n       TR_PersistentJittedBodyInfo *bodyInfo;\n+      void *extra;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MDE3MTk0OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/HookedByTheJit.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzoyMDoxOFrOHW4xlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNzoyMDoxOFrOHW4xlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc2MDkxOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               void        *extra;\n          \n          \n            \n               void        *extra = NULL;", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r493760918", "createdAt": "2020-09-23T17:20:18Z", "author": {"login": "DanHeidinga"}, "path": "runtime/compiler/control/HookedByTheJit.cpp", "diffHunk": "@@ -846,6 +847,7 @@ void DLTLogic(J9VMThread* vmThread, TR::CompilationInfo *compInfo)\n    int32_t    idx = dltBlock->cursor + 1;\n    J9ROMMethod *romMethod = NULL;\n    bool         bcRepeats;\n+   void        *extra;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5336f6c1b04641d0dba7861488a221fbe70b66b"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODk2ODA5OnYy", "diffSide": "RIGHT", "path": "runtime/compiler/net/MessageTypes.hpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzoyMDowNVrOHYMM2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzozMTozNlrOHYMkGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyNzc2OA==", "bodyText": "Since a new message was introduced we need to increment the minor version info here:\nhttps://github.com/eclipse/openj9/blob/master/runtime/compiler/net/CommunicationStream.hpp#L105", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r495127768", "createdAt": "2020-09-25T17:20:05Z", "author": {"login": "mpirvu"}, "path": "runtime/compiler/net/MessageTypes.hpp", "diffHunk": "@@ -207,6 +207,7 @@ enum MessageType : uint16_t\n \n    // For static TR::CompilationInfo methods\n    CompInfo_isCompiled, // 171\n+   CompInfo_getPCIfCompiled,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcbaa0a8bedfe9020f856f11d993b45ae49f0130"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEzMzcyMw==", "bodyText": "Ah right, thanks", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r495133723", "createdAt": "2020-09-25T17:31:36Z", "author": {"login": "dsouzai"}, "path": "runtime/compiler/net/MessageTypes.hpp", "diffHunk": "@@ -207,6 +207,7 @@ enum MessageType : uint16_t\n \n    // For static TR::CompilationInfo methods\n    CompInfo_isCompiled, // 171\n+   CompInfo_getPCIfCompiled,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyNzc2OA=="}, "originalCommit": {"oid": "fcbaa0a8bedfe9020f856f11d993b45ae49f0130"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5OTA0NzAyOnYy", "diffSide": "RIGHT", "path": "runtime/compiler/control/CompilationRuntime.hpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNzo0NToyNFrOHYM-eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxODowMzoyMFrOHYNggQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE0MDQ3Mg==", "bodyText": "shouldn't this be MessageType::CompInfo_getPCIfCompiled ?", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r495140472", "createdAt": "2020-09-25T17:45:24Z", "author": {"login": "mstoodle"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -466,8 +474,34 @@ class CompilationInfo\n          return std::get<0>(stream->read<bool>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      return (getPCIfCompiled(method) != NULL);\n+      }\n+\n+   /**\n+    * @brief Returns the PC of a method that is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* getPCIfCompiled(J9Method *method)\n+      {\n+#if defined(J9VM_OPT_JITSERVER)\n+      if (auto stream = getStream())\n+         {\n+         stream->write(JITServer::MessageType::CompInfo_isCompiled, method);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4801cdbfe9ac00f007be76d466740e66aec4c843"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE0OTE4NQ==", "bodyText": "Damn, yeah you're right, thanks for catching it.", "url": "https://github.com/eclipse-openj9/openj9/pull/10672#discussion_r495149185", "createdAt": "2020-09-25T18:03:20Z", "author": {"login": "dsouzai"}, "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -466,8 +474,34 @@ class CompilationInfo\n          return std::get<0>(stream->read<bool>());\n          }\n #endif /* defined(J9VM_OPT_JITSERVER) */\n-      return (((uintptr_t)method->extra) & J9_STARTPC_NOT_TRANSLATED) == 0;\n+\n+      return (getPCIfCompiled(method) != NULL);\n+      }\n+\n+   /**\n+    * @brief Returns the PC of a method that is compiled\n+    *\n+    * @param method pointer to the J9Method\n+    *\n+    * @return The start PC if compiled, NULL otherwise\n+    */\n+   static void* getPCIfCompiled(J9Method *method)\n+      {\n+#if defined(J9VM_OPT_JITSERVER)\n+      if (auto stream = getStream())\n+         {\n+         stream->write(JITServer::MessageType::CompInfo_isCompiled, method);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE0MDQ3Mg=="}, "originalCommit": {"oid": "4801cdbfe9ac00f007be76d466740e66aec4c843"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1209, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}