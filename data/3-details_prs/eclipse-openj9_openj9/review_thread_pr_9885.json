{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NjI2ODM2", "number": 9885, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozMjozMlrOEF91kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozMzowMlrOEF92eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NjkxNDczOnYy", "diffSide": "RIGHT", "path": "runtime/vm/jvminit.c", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozMjozMlrOGkeSLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozMjozMlrOGkeSLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODA5Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t * so setting the flag again below is harmless.\n          \n          \n            \n            \t\t\t * so setting the `J9_RUNTIME_EXIT_STARTED` flag again below is harmless.", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440898093", "createdAt": "2020-06-16T14:32:32Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -506,22 +506,30 @@ void OMRNORETURN exitJavaVM(J9VMThread * vmThread, IDATA rc)\n \t\t\tomrthread_monitor_enter(mutex);\n \t\t}\n \n-\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers on exit - exit\n-\t\t * must be allowed in this case. CLEANUP will only ever be set once EXIT_STARTED has\n-\t\t * been set, so setting the flag again below is harmless.\n-\t\t */\n-\t\tif (J9_RUNTIME_EXIT_STARTED == (vm->runtimeFlags & (J9_RUNTIME_EXIT_STARTED | J9_RUNTIME_CLEANUP))) {\n-\t\t\tif (NULL != mutex) {\n-\t\t\t\tomrthread_monitor_exit(mutex);\n-\t\t\t}\n+\t\tif (J9_ARE_ANY_BITS_SET(vm->runtimeFlags, J9_RUNTIME_EXIT_STARTED)) {\n+\t\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers\n+\t\t\t * on exit - exit must be allowed in this case, but only from a finalizer\n+\t\t\t * thread (for simplicity, just check for a system thread as no other\n+\t\t\t * VM-owned threads will be attempting exit).\n+\t\t\t *\n+\t\t\t * CLEANUP will only ever be set once EXIT_STARTED has been set,\n+\t\t\t * so setting the flag again below is harmless.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17661d574ccce5be8e7bfc5253ae77e76c5b3527"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NjkxNzA0OnYy", "diffSide": "RIGHT", "path": "runtime/vm/jvminit.c", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozMzowMlrOGkeTug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDo1OToxNVrOGkfkZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODQ5MA==", "bodyText": "Mostly nitpick:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD) ||\n          \n          \n            \n            \t\t\t    J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)\n          \n          \n            \n            \t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD)\n          \n          \n            \n            \t\t\t|| J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440898490", "createdAt": "2020-06-16T14:33:02Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -506,22 +506,30 @@ void OMRNORETURN exitJavaVM(J9VMThread * vmThread, IDATA rc)\n \t\t\tomrthread_monitor_enter(mutex);\n \t\t}\n \n-\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers on exit - exit\n-\t\t * must be allowed in this case. CLEANUP will only ever be set once EXIT_STARTED has\n-\t\t * been set, so setting the flag again below is harmless.\n-\t\t */\n-\t\tif (J9_RUNTIME_EXIT_STARTED == (vm->runtimeFlags & (J9_RUNTIME_EXIT_STARTED | J9_RUNTIME_CLEANUP))) {\n-\t\t\tif (NULL != mutex) {\n-\t\t\t\tomrthread_monitor_exit(mutex);\n-\t\t\t}\n+\t\tif (J9_ARE_ANY_BITS_SET(vm->runtimeFlags, J9_RUNTIME_EXIT_STARTED)) {\n+\t\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers\n+\t\t\t * on exit - exit must be allowed in this case, but only from a finalizer\n+\t\t\t * thread (for simplicity, just check for a system thread as no other\n+\t\t\t * VM-owned threads will be attempting exit).\n+\t\t\t *\n+\t\t\t * CLEANUP will only ever be set once EXIT_STARTED has been set,\n+\t\t\t * so setting the flag again below is harmless.\n+\t\t\t */\n+\t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD) ||\n+\t\t\t    J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17661d574ccce5be8e7bfc5253ae77e76c5b3527"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODg2Mg==", "bodyText": "Do we not have a better way to ID finalizer threads?", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440898862", "createdAt": "2020-06-16T14:33:30Z", "author": {"login": "DanHeidinga"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -506,22 +506,30 @@ void OMRNORETURN exitJavaVM(J9VMThread * vmThread, IDATA rc)\n \t\t\tomrthread_monitor_enter(mutex);\n \t\t}\n \n-\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers on exit - exit\n-\t\t * must be allowed in this case. CLEANUP will only ever be set once EXIT_STARTED has\n-\t\t * been set, so setting the flag again below is harmless.\n-\t\t */\n-\t\tif (J9_RUNTIME_EXIT_STARTED == (vm->runtimeFlags & (J9_RUNTIME_EXIT_STARTED | J9_RUNTIME_CLEANUP))) {\n-\t\t\tif (NULL != mutex) {\n-\t\t\t\tomrthread_monitor_exit(mutex);\n-\t\t\t}\n+\t\tif (J9_ARE_ANY_BITS_SET(vm->runtimeFlags, J9_RUNTIME_EXIT_STARTED)) {\n+\t\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers\n+\t\t\t * on exit - exit must be allowed in this case, but only from a finalizer\n+\t\t\t * thread (for simplicity, just check for a system thread as no other\n+\t\t\t * VM-owned threads will be attempting exit).\n+\t\t\t *\n+\t\t\t * CLEANUP will only ever be set once EXIT_STARTED has been set,\n+\t\t\t * so setting the flag again below is harmless.\n+\t\t\t */\n+\t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD) ||\n+\t\t\t    J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODQ5MA=="}, "originalCommit": {"oid": "17661d574ccce5be8e7bfc5253ae77e76c5b3527"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkxOTE0MA==", "bodyText": "No, there can be multiple abandoned threads - the GC only records the active one.", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440919140", "createdAt": "2020-06-16T14:59:15Z", "author": {"login": "gacholio"}, "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -506,22 +506,30 @@ void OMRNORETURN exitJavaVM(J9VMThread * vmThread, IDATA rc)\n \t\t\tomrthread_monitor_enter(mutex);\n \t\t}\n \n-\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers on exit - exit\n-\t\t * must be allowed in this case. CLEANUP will only ever be set once EXIT_STARTED has\n-\t\t * been set, so setting the flag again below is harmless.\n-\t\t */\n-\t\tif (J9_RUNTIME_EXIT_STARTED == (vm->runtimeFlags & (J9_RUNTIME_EXIT_STARTED | J9_RUNTIME_CLEANUP))) {\n-\t\t\tif (NULL != mutex) {\n-\t\t\t\tomrthread_monitor_exit(mutex);\n-\t\t\t}\n+\t\tif (J9_ARE_ANY_BITS_SET(vm->runtimeFlags, J9_RUNTIME_EXIT_STARTED)) {\n+\t\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers\n+\t\t\t * on exit - exit must be allowed in this case, but only from a finalizer\n+\t\t\t * thread (for simplicity, just check for a system thread as no other\n+\t\t\t * VM-owned threads will be attempting exit).\n+\t\t\t *\n+\t\t\t * CLEANUP will only ever be set once EXIT_STARTED has been set,\n+\t\t\t * so setting the flag again below is harmless.\n+\t\t\t */\n+\t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD) ||\n+\t\t\t    J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODQ5MA=="}, "originalCommit": {"oid": "17661d574ccce5be8e7bfc5253ae77e76c5b3527"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 12, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}