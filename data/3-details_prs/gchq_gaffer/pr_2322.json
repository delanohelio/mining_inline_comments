{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNTEwNDM4", "number": 2322, "title": "Gh 2318 less extreme fix of accumulo imports", "bodyText": "In Gaffer 1.13, the Accumulo rest project broke due to dependencies pulled in by the Accumulo store. To resolve this I've moved the MiniAccumuloStore to the tests and removed the DemoMiniAccumuloStore - it never worked anyway.", "createdAt": "2020-10-09T10:54:56Z", "url": "https://github.com/gchq/Gaffer/pull/2322", "merged": true, "mergeCommit": {"oid": "f050fcf8f6f041f87d0105ccbcb4ec24a3713fe0"}, "closed": true, "closedAt": "2020-10-20T12:44:35Z", "author": {"login": "d47853"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQMke6AH2gAyNTAwNTEwNDM4OjIzZjk4ZDBhMmUzN2U0OTc4YmViZjllNTEyOTBmY2UzNzQ3OTFiNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUXRtkgH2gAyNTAwNTEwNDM4OjM2OGFmOWZmNjJmOGJkNWYzMWUyNjU3YWQyNTQ4YmRhYjcyM2E5ZmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "23f98d0a2e37e4978bebf9e51290fce374791b55", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/23f98d0a2e37e4978bebf9e51290fce374791b55", "committedDate": "2020-10-07T12:58:44Z", "message": "gh-2318 fixed accumulo store tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13c71c6dd3b10c43305669aafe446f6c15d194e5", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/13c71c6dd3b10c43305669aafe446f6c15d194e5", "committedDate": "2020-10-07T16:12:32Z", "message": "gh-2318 fixed the Spark accumulo library"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21317699aa11514cad5f723e86f583e9e738bf88", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/21317699aa11514cad5f723e86f583e9e738bf88", "committedDate": "2020-10-08T11:08:07Z", "message": "gh-2318 Fixed FederatedStore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79407e06c654349a2bd60059a82d9f9c5a948835", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/79407e06c654349a2bd60059a82d9f9c5a948835", "committedDate": "2020-10-08T11:44:10Z", "message": "gh-2318 removed all usages of MiniAccumuloManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d55bbc14d8d473ee45fea4a6c33bcef8e9e63086", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/d55bbc14d8d473ee45fea4a6c33bcef8e9e63086", "committedDate": "2020-10-08T12:24:47Z", "message": "working on gaffer-docker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd9cba6b6ef369cd368c724a343ded65ac49e5fb", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/dd9cba6b6ef369cd368c724a343ded65ac49e5fb", "committedDate": "2020-10-09T09:20:13Z", "message": "gh-2318 moved MiniAccumulo to test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca8e0d1541b5361e69d7dc054019cbba964cef4d", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/ca8e0d1541b5361e69d7dc054019cbba964cef4d", "committedDate": "2020-10-09T09:36:27Z", "message": "gh-2318 made spark test more readable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85d0ca39f78ec1bc8cfe6029f8129344884b9308", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/85d0ca39f78ec1bc8cfe6029f8129344884b9308", "committedDate": "2020-10-09T10:03:43Z", "message": "gh-2318 added docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50a64fdaa59b8e6b8efe6208d43611c11e7828b5", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/50a64fdaa59b8e6b8efe6208d43611c11e7828b5", "committedDate": "2020-10-09T10:14:16Z", "message": "gh-2318 fixed checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49ddfd1863adaf9fe5bfb4a9e8c28c1474ab521b", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/49ddfd1863adaf9fe5bfb4a9e8c28c1474ab521b", "committedDate": "2020-10-09T10:34:58Z", "message": "gh-2318 replaced accumulo store properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caa017783c4834eef72715a6755b435b945158da", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/caa017783c4834eef72715a6755b435b945158da", "committedDate": "2020-10-09T10:49:29Z", "message": "gh-2318 fixed junit 5 tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34f813d64243bf50401498fd247b8a63ed5c72cc", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/34f813d64243bf50401498fd247b8a63ed5c72cc", "committedDate": "2020-10-09T16:14:22Z", "message": "gh-2318 Fixed visibilities on store properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4367b2458f1a6dcf566cb9d449fd06a686bc4277", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/4367b2458f1a6dcf566cb9d449fd06a686bc4277", "committedDate": "2020-10-09T16:53:19Z", "message": "gh-2318 cleaned up checkstyle errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c4b6d3201f3608ba0adb30a85bc07d84612bb00", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/2c4b6d3201f3608ba0adb30a85bc07d84612bb00", "committedDate": "2020-10-09T17:03:23Z", "message": "gh-2318 Tried to remove fork config to speed up tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "719f504d0d3cfdd9e11222c79fa2f4f677c8caf8", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/719f504d0d3cfdd9e11222c79fa2f4f677c8caf8", "committedDate": "2020-10-11T20:22:39Z", "message": "gh-2318 reverted verbose logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cf846ce909d9165e2a1f77be953e3f37acf50ff", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/3cf846ce909d9165e2a1f77be953e3f37acf50ff", "committedDate": "2020-10-12T13:04:46Z", "message": "gh-2318 removed graphs before each test for separation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f64d17ae6e9b55609c00b377a987d9e0c023c31f", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/f64d17ae6e9b55609c00b377a987d9e0c023c31f", "committedDate": "2020-10-12T13:50:25Z", "message": "gh-2318 tried using sinlge use Accumulo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODAwMjQy", "url": "https://github.com/gchq/Gaffer/pull/2322#pullrequestreview-506800242", "createdAt": "2020-10-12T17:30:36Z", "commit": {"oid": "f64d17ae6e9b55609c00b377a987d9e0c023c31f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzozMDozNlrOHgHYBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzo0MDozNVrOHgHp8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQzNzMxOA==", "bodyText": "Can this be removed?", "url": "https://github.com/gchq/Gaffer/pull/2322#discussion_r503437318", "createdAt": "2020-10-12T17:30:36Z", "author": {"login": "t11947"}, "path": "store-implementation/federated-store/src/test/java/uk/gov/gchq/gaffer/federatedstore/integration/FederatedStoreRecursionIT.java", "diffHunk": "@@ -75,7 +75,7 @@ public void setUp() throws Exception {\n     }\n \n \n-    @Test(timeout = 60000)\n+    @Test//(timeout = 60000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f64d17ae6e9b55609c00b377a987d9e0c023c31f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQzODY1Mw==", "bodyText": "Does the Mock store need to be used here?", "url": "https://github.com/gchq/Gaffer/pull/2322#discussion_r503438653", "createdAt": "2020-10-12T17:33:32Z", "author": {"login": "t11947"}, "path": "example/basic/basic-rest/src/main/resources/accumulo/store.properties", "diffHunk": "@@ -14,13 +14,11 @@\n # limitations under the License.\n #\n # Accumulo store config\n-gaffer.store.class=uk.gov.gchq.gaffer.accumulostore.DemoMiniAccumuloStore\n+gaffer.store.class=uk.gov.gchq.gaffer.accumulostore.MockAccumuloStore", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f64d17ae6e9b55609c00b377a987d9e0c023c31f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQzOTYwMg==", "bodyText": "Typically mutable collections don't use constant casing", "url": "https://github.com/gchq/Gaffer/pull/2322#discussion_r503439602", "createdAt": "2020-10-12T17:35:30Z", "author": {"login": "t11947"}, "path": "store-implementation/accumulo-store/src/test/java/uk/gov/gchq/gaffer/accumulostore/MiniAccumuloStore.java", "diffHunk": "@@ -0,0 +1,176 @@\n+/*\n+ * Copyright 2020 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package uk.gov.gchq.gaffer.accumulostore;\n+\n+import com.google.common.io.Files;\n+import org.apache.accumulo.core.client.AccumuloException;\n+import org.apache.accumulo.core.client.AccumuloSecurityException;\n+import org.apache.accumulo.core.client.Connector;\n+import org.apache.accumulo.core.client.security.tokens.PasswordToken;\n+import org.apache.accumulo.core.security.Authorizations;\n+import org.apache.accumulo.core.security.SystemPermission;\n+import org.apache.accumulo.minicluster.MiniAccumuloCluster;\n+import org.apache.accumulo.minicluster.MiniAccumuloConfig;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.store.StoreException;\n+import uk.gov.gchq.gaffer.store.StoreProperties;\n+import uk.gov.gchq.gaffer.store.schema.Schema;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Set;\n+\n+/**\n+ * A {@code MiniAccumuloStore} is an {@link AccumuloStore} which sets up an {@link MiniAccumuloCluster}\n+ * for each unique instance name. If you create two Accumulo stores with the same instance name,\n+ * the same cluster will be used for both. It's advisable to re-use an instance so that you don't\n+ * spend unnecessary time spinning up mini-clusters.\n+ *\n+ * It's dependencies mean it cannot be run in a REST API.\n+ *\n+ * If a user hasn't been created on the accumulo instance, it will be created for you with the\n+ * CREATE_NAMESPACE and CREATE_TABLE permissions.\n+ *\n+ * If you specify the authorisations in the store properties, the current authorisations for any\n+ * existing user will be overwritten.\n+ */\n+public class MiniAccumuloStore extends AccumuloStore {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(MiniAccumuloStore.class);\n+\n+    private static final HashMap<String, MiniAccumuloCluster> CLUSTER_INSTANCES = new HashMap<>();\n+    private static final HashMap<String, File> ACCUMULO_DIRECTORIES = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f64d17ae6e9b55609c00b377a987d9e0c023c31f"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ0MTkwNw==", "bodyText": "Consider extracting to private method over commenting", "url": "https://github.com/gchq/Gaffer/pull/2322#discussion_r503441907", "createdAt": "2020-10-12T17:40:35Z", "author": {"login": "t11947"}, "path": "store-implementation/accumulo-store/src/test/java/uk/gov/gchq/gaffer/accumulostore/MiniAccumuloStore.java", "diffHunk": "@@ -0,0 +1,176 @@\n+/*\n+ * Copyright 2020 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package uk.gov.gchq.gaffer.accumulostore;\n+\n+import com.google.common.io.Files;\n+import org.apache.accumulo.core.client.AccumuloException;\n+import org.apache.accumulo.core.client.AccumuloSecurityException;\n+import org.apache.accumulo.core.client.Connector;\n+import org.apache.accumulo.core.client.security.tokens.PasswordToken;\n+import org.apache.accumulo.core.security.Authorizations;\n+import org.apache.accumulo.core.security.SystemPermission;\n+import org.apache.accumulo.minicluster.MiniAccumuloCluster;\n+import org.apache.accumulo.minicluster.MiniAccumuloConfig;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.store.StoreException;\n+import uk.gov.gchq.gaffer.store.StoreProperties;\n+import uk.gov.gchq.gaffer.store.schema.Schema;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Set;\n+\n+/**\n+ * A {@code MiniAccumuloStore} is an {@link AccumuloStore} which sets up an {@link MiniAccumuloCluster}\n+ * for each unique instance name. If you create two Accumulo stores with the same instance name,\n+ * the same cluster will be used for both. It's advisable to re-use an instance so that you don't\n+ * spend unnecessary time spinning up mini-clusters.\n+ *\n+ * It's dependencies mean it cannot be run in a REST API.\n+ *\n+ * If a user hasn't been created on the accumulo instance, it will be created for you with the\n+ * CREATE_NAMESPACE and CREATE_TABLE permissions.\n+ *\n+ * If you specify the authorisations in the store properties, the current authorisations for any\n+ * existing user will be overwritten.\n+ */\n+public class MiniAccumuloStore extends AccumuloStore {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(MiniAccumuloStore.class);\n+\n+    private static final HashMap<String, MiniAccumuloCluster> CLUSTER_INSTANCES = new HashMap<>();\n+    private static final HashMap<String, File> ACCUMULO_DIRECTORIES = new HashMap<>();\n+\n+    private static final String ROOT_PASSWORD_DEFAULT = \"password\";\n+    private static final int DEFAULT_ZOOKEEPER_PORT = 2181;\n+\n+    private static final String ROOT_USER = \"root\";\n+    private static final String VISIBILITIES_PROPERTY = \"accumulo.mini.visibilities\";\n+    private static final String ROOT_PASSWORD_PROPERTY = \"accumulo.mini.root.password\";\n+    private static final String ACCUMULO_DIRECTORY_PROPERTY = \"accumulo.mini.directory\";\n+\n+\n+    @Override\n+    public void preInitialise(final String graphId, final Schema schema, final StoreProperties properties) throws StoreException {\n+        super.preInitialise(graphId, schema, properties);\n+\n+        synchronized (this) {\n+            if (getCluster() == null) {\n+                try {\n+                    createCluster();\n+                } catch (final InterruptedException | IOException e) {\n+                    throw new StoreException(\"Failed to start accumulo cluster\", e);\n+                }\n+            }\n+        }\n+\n+\n+        try {\n+            ensureUserExists(getCluster());\n+        } catch (final AccumuloException | AccumuloSecurityException e) {\n+            throw new StoreException(\"Failed to ensure user was added\", e);\n+        }\n+\n+    }\n+\n+    private MiniAccumuloCluster getCluster() {\n+        return CLUSTER_INSTANCES.get(getProperties().getInstance());\n+    }\n+\n+    private File getAccumuloDirectory() {\n+        return ACCUMULO_DIRECTORIES.get(getProperties().getInstance());\n+    }\n+\n+    private void ensureUserExists(final MiniAccumuloCluster mac) throws AccumuloSecurityException, AccumuloException {\n+        String userName = getProperties().getUser();\n+        String rootPassword = getProperties().get(ROOT_PASSWORD_PROPERTY, ROOT_PASSWORD_DEFAULT);\n+\n+        // Ensure user exists\n+        synchronized (this) {\n+            Set<String> currentUsers = mac.getConnector(ROOT_USER, rootPassword).securityOperations().listLocalUsers();\n+            if (!currentUsers.contains(userName)) {\n+                mac.getConnector(ROOT_USER, rootPassword).securityOperations().createLocalUser(\n+                        userName, new PasswordToken(getProperties().getPassword())\n+                );\n+                mac.getConnector(ROOT_USER, rootPassword).securityOperations()\n+                        .grantSystemPermission(userName, SystemPermission.CREATE_NAMESPACE);\n+                mac.getConnector(ROOT_USER, rootPassword).securityOperations()\n+                        .grantSystemPermission(userName, SystemPermission.CREATE_TABLE);\n+            }\n+        }\n+\n+\n+        // Add Auths", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f64d17ae6e9b55609c00b377a987d9e0c023c31f"}, "originalPosition": 120}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35127bbdacd1ae3714c6a8488fd00280a5a9fcbf", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/35127bbdacd1ae3714c6a8488fd00280a5a9fcbf", "committedDate": "2020-10-15T11:07:53Z", "message": "gh-2318 removed whitespace and replace timeout on test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21fcd8f09c075b76f96845f87acc82b0c59de049", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/21fcd8f09c075b76f96845f87acc82b0c59de049", "committedDate": "2020-10-16T13:53:30Z", "message": "Merge branch 'develop' into gh-2318-less-extreme-fix-of-accumulo-imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNjQxMzQ1", "url": "https://github.com/gchq/Gaffer/pull/2322#pullrequestreview-511641345", "createdAt": "2020-10-19T10:56:19Z", "commit": {"oid": "21fcd8f09c075b76f96845f87acc82b0c59de049"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6b128e4ea21db306320d7582d5a9921a164ef8c", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/f6b128e4ea21db306320d7582d5a9921a164ef8c", "committedDate": "2020-10-20T09:29:39Z", "message": "gh-2318 fixed conflicts after merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "368af9ff62f8bd5f31e2657ad2548bdab723a9fa", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/368af9ff62f8bd5f31e2657ad2548bdab723a9fa", "committedDate": "2020-10-20T11:42:53Z", "message": "gh-2318 Increased sleep time in hacky flink test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1802, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}