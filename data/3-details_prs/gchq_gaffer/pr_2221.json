{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwOTg0MDQz", "number": 2221, "title": "Gh 2220 add function hook", "bodyText": "", "createdAt": "2020-01-09T14:21:25Z", "url": "https://github.com/gchq/Gaffer/pull/2221", "merged": true, "mergeCommit": {"oid": "dc634a9fc063da23445bc758a0e450a18c0ad8e8"}, "closed": true, "closedAt": "2020-01-15T15:45:22Z", "author": {"login": "d47853"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4C-jCgH2gAyMzYwOTg0MDQzOmU3YWNmNjJiZDI5ZGY2MmJhYTE2ZDQyZmFkMDQwYzkyZWE4MzM2YjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6l-yIAFqTM0MzIzNDY4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e7acf62bd29df62baa16d42fad040c92ea8336b5", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/e7acf62bd29df62baa16d42fad040c92ea8336b5", "committedDate": "2020-01-07T16:02:49Z", "message": "gh-2220 added hook and tests. Working with blacklist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ce693da3e009adb0746818b4c98577c75085e19", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/1ce693da3e009adb0746818b4c98577c75085e19", "committedDate": "2020-01-08T13:32:14Z", "message": "gh-2220 using whitelist and blacklist and added further tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96d3012ce964551e2887603f21dd681d56140b41", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/96d3012ce964551e2887603f21dd681d56140b41", "committedDate": "2020-01-08T16:43:30Z", "message": "gh-2220 added the function authoriser as a default graph hook"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e52112fe6c2d4c3e16623512284157c90196fa7", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/2e52112fe6c2d4c3e16623512284157c90196fa7", "committedDate": "2020-01-08T17:03:48Z", "message": "gh-2220 added null checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50bb9ac07a372b166e125ebeff95e8905c88febc", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/50bb9ac07a372b166e125ebeff95e8905c88febc", "committedDate": "2020-01-09T12:58:40Z", "message": "gh-2220 all tests in graph are passing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab4b0ca08dbd8e97d608817b9989db2990fa2a0c", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/ab4b0ca08dbd8e97d608817b9989db2990fa2a0c", "committedDate": "2020-01-09T14:04:22Z", "message": "gh-2220 added whitelist patterns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5153aa8818f28db22c114380de8ce2d28cc0243b", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/5153aa8818f28db22c114380de8ce2d28cc0243b", "committedDate": "2020-01-09T14:17:57Z", "message": "gh-2220 minor refactor and javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d869738d9d6355031d6a5f27e18dbeb2c6ec885b", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/d869738d9d6355031d6a5f27e18dbeb2c6ec885b", "committedDate": "2020-01-09T15:37:20Z", "message": "gh-2220 fixed external tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNTg1NDMw", "url": "https://github.com/gchq/Gaffer/pull/2221#pullrequestreview-340585430", "createdAt": "2020-01-09T15:05:35Z", "commit": {"oid": "5153aa8818f28db22c114380de8ce2d28cc0243b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNTowNTozNVrOFb46rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNjozNjo1NVrOFb8KLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc4ODM5Ng==", "bodyText": "Isn't clear from the comment that it's also possible to whitelist", "url": "https://github.com/gchq/Gaffer/pull/2221#discussion_r364788396", "createdAt": "2020-01-09T15:05:35Z", "author": {"login": "ss130257"}, "path": "core/graph/src/main/java/uk/gov/gchq/gaffer/graph/hook/FunctionAuthoriser.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2019 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package uk.gov.gchq.gaffer.graph.hook;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.commonutil.exception.UnauthorisedException;\n+import uk.gov.gchq.gaffer.exception.SerialisationException;\n+import uk.gov.gchq.gaffer.jsonserialisation.JSONSerialiser;\n+import uk.gov.gchq.gaffer.operation.OperationChain;\n+import uk.gov.gchq.gaffer.store.Context;\n+import uk.gov.gchq.koryphe.impl.predicate.And;\n+import uk.gov.gchq.koryphe.impl.predicate.Not;\n+import uk.gov.gchq.koryphe.impl.predicate.Or;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The FunctionAuthoriser is a {@link GraphHook} which stops a user running\n+ * Functions which have been banned. The Authoriser can be configured with a\n+ * list of unauthorised function classes, or a list of patterns to check against.\n+ * <p>\n+ * It should be noted that using the unauthorisedFunctions list will be more\n+ * efficient than using any of the patterns.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5153aa8818f28db22c114380de8ce2d28cc0243b"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDgxMzM1MQ==", "bodyText": "I don't think you tested a function being allowed when it IS in the whitelist", "url": "https://github.com/gchq/Gaffer/pull/2221#discussion_r364813351", "createdAt": "2020-01-09T15:47:08Z", "author": {"login": "ss130257"}, "path": "core/graph/src/test/java/uk/gov/gchq/gaffer/graph/hook/FunctionAuthoriserTest.java", "diffHunk": "@@ -0,0 +1,299 @@\n+/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5153aa8818f28db22c114380de8ce2d28cc0243b"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDgxODE3Ng==", "bodyText": "Should you add authorisedFunctionPatterns here as well?", "url": "https://github.com/gchq/Gaffer/pull/2221#discussion_r364818176", "createdAt": "2020-01-09T15:55:20Z", "author": {"login": "ss130257"}, "path": "core/graph/src/main/java/uk/gov/gchq/gaffer/graph/hook/FunctionAuthoriser.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2019 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package uk.gov.gchq.gaffer.graph.hook;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.commonutil.exception.UnauthorisedException;\n+import uk.gov.gchq.gaffer.exception.SerialisationException;\n+import uk.gov.gchq.gaffer.jsonserialisation.JSONSerialiser;\n+import uk.gov.gchq.gaffer.operation.OperationChain;\n+import uk.gov.gchq.gaffer.store.Context;\n+import uk.gov.gchq.koryphe.impl.predicate.And;\n+import uk.gov.gchq.koryphe.impl.predicate.Not;\n+import uk.gov.gchq.koryphe.impl.predicate.Or;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The FunctionAuthoriser is a {@link GraphHook} which stops a user running\n+ * Functions which have been banned. The Authoriser can be configured with a\n+ * list of unauthorised function classes, or a list of patterns to check against.\n+ * <p>\n+ * It should be noted that using the unauthorisedFunctions list will be more\n+ * efficient than using any of the patterns.\n+ */\n+@JsonPropertyOrder(value = {\"unauthorisedFunctions\", \"unauthorisedFunctionPatterns\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5153aa8818f28db22c114380de8ce2d28cc0243b"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0MTUxOA==", "bodyText": "Matching of the \"class\":\" string feels a bit fragile to me. You may want to consider creating a TreeModel from the Json string and traversing the tree of JsonNode objects checking for \"class\" fields.", "url": "https://github.com/gchq/Gaffer/pull/2221#discussion_r364841518", "createdAt": "2020-01-09T16:36:55Z", "author": {"login": "ss130257"}, "path": "core/graph/src/main/java/uk/gov/gchq/gaffer/graph/hook/FunctionAuthoriser.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2019 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package uk.gov.gchq.gaffer.graph.hook;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.commonutil.exception.UnauthorisedException;\n+import uk.gov.gchq.gaffer.exception.SerialisationException;\n+import uk.gov.gchq.gaffer.jsonserialisation.JSONSerialiser;\n+import uk.gov.gchq.gaffer.operation.OperationChain;\n+import uk.gov.gchq.gaffer.store.Context;\n+import uk.gov.gchq.koryphe.impl.predicate.And;\n+import uk.gov.gchq.koryphe.impl.predicate.Not;\n+import uk.gov.gchq.koryphe.impl.predicate.Or;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The FunctionAuthoriser is a {@link GraphHook} which stops a user running\n+ * Functions which have been banned. The Authoriser can be configured with a\n+ * list of unauthorised function classes, or a list of patterns to check against.\n+ * <p>\n+ * It should be noted that using the unauthorisedFunctions list will be more\n+ * efficient than using any of the patterns.\n+ */\n+@JsonPropertyOrder(value = {\"unauthorisedFunctions\", \"unauthorisedFunctionPatterns\"})\n+@JsonInclude(JsonInclude.Include.NON_DEFAULT)\n+public class FunctionAuthoriser implements GraphHook {\n+\n+    private static final String ERROR_MESSAGE_PREFIX = \"Operation chain contained an unauthorised function: \";\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FunctionAuthoriser.class);\n+    private List<Class<? extends Function>> unauthorisedFunctions = new ArrayList<>();\n+    private List<Pattern> authorisedFunctionPatterns = new ArrayList<>();\n+    private List<Pattern> unauthorisedFunctionPatterns = new ArrayList<>();\n+\n+    public FunctionAuthoriser() {\n+    }\n+\n+    public FunctionAuthoriser(final List<Class<? extends Function>> unauthorisedFunctions, final List<Pattern> unauthorisedFunctionPatterns, final List<Pattern> authorisedFunctionPatterns) {\n+        this.setUnauthorisedFunctions(unauthorisedFunctions);\n+        this.setAuthorisedFunctionPatterns(authorisedFunctionPatterns);\n+        this.setUnauthorisedFunctionPatterns(unauthorisedFunctionPatterns);\n+    }\n+\n+    @Override\n+    public void preExecute(final OperationChain<?> opChain, final Context context) {\n+        String chainString;\n+        try {\n+            chainString = new String(JSONSerialiser.serialise(opChain));\n+        } catch (final SerialisationException e) {\n+            // This should never happen in real life as operation chains should\n+            // always be json serialisable. However this could happen if using a\n+            // mock in testing. To account for this, it will be logged.\n+            LOGGER.warn(\"Failed to serialise operation chain: \" + opChain);\n+            return;\n+        }\n+\n+        if (unauthorisedFunctions != null) {\n+            checkNoBlacklistedFunctionsArePresent(chainString);\n+        }\n+        if (authorisedFunctionPatterns != null || unauthorisedFunctionPatterns != null) {\n+            checkAllFunctionsUsedAppearInPatterns(chainString);\n+        }\n+    }\n+\n+    private List<Predicate> convertPatternsToPredicates(final List<Pattern> patterns) {\n+        return patterns.stream()\n+                .map(Pattern::asPredicate)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private void checkAllFunctionsUsedAppearInPatterns(final String chainString) {\n+        boolean noWhitelistPatterns = (authorisedFunctionPatterns == null || authorisedFunctionPatterns.isEmpty());\n+        boolean noBlacklistPatterns = (unauthorisedFunctionPatterns == null || unauthorisedFunctionPatterns.isEmpty());\n+\n+        Predicate<String> isAuthorised = createAuthorisationFunction(noBlacklistPatterns, noWhitelistPatterns);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5153aa8818f28db22c114380de8ce2d28cc0243b"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3067b2d42aab0a93be5b0a66a33115ab2b84af0a", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/3067b2d42aab0a93be5b0a66a33115ab2b84af0a", "committedDate": "2020-01-13T09:23:06Z", "message": "gh-2220 added tests, updated javadoc and added field to jsonPropertyOrder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f612e13fa031934dcc13b1691affd1724cecd36", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/9f612e13fa031934dcc13b1691affd1724cecd36", "committedDate": "2020-01-13T09:45:34Z", "message": "gh-2220 using jsonnode and iterating"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNzM5NzEy", "url": "https://github.com/gchq/Gaffer/pull/2221#pullrequestreview-341739712", "createdAt": "2020-01-13T10:11:51Z", "commit": {"oid": "9f612e13fa031934dcc13b1691affd1724cecd36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxODE2NDg2", "url": "https://github.com/gchq/Gaffer/pull/2221#pullrequestreview-341816486", "createdAt": "2020-01-13T12:42:07Z", "commit": {"oid": "9f612e13fa031934dcc13b1691affd1724cecd36"}, "state": "DISMISSED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMjo0MjowOFrOFc1okQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMjo1OToyMFrOFc2Djw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc4MzE4NQ==", "bodyText": "Perhaps create a default black list and store that in another class, otherwise this list here could get rather big and messy.", "url": "https://github.com/gchq/Gaffer/pull/2221#discussion_r365783185", "createdAt": "2020-01-13T12:42:08Z", "author": {"login": "p013570"}, "path": "core/graph/src/main/java/uk/gov/gchq/gaffer/graph/Graph.java", "diffHunk": "@@ -995,6 +1000,11 @@ private void updateGraphHooks(final GraphConfig config) {\n                     config.getHooks().add(0, new NamedOperationResolver());\n                 }\n             }\n+            if (!hasFunctionAuthoriserHook && !config.isSkipDefaultSecurityHooks()) {\n+                config.getHooks().add(new FunctionAuthoriser.Builder()\n+                        .unauthorisedFunctions(Lists.newArrayList(CreateObject.class))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f612e13fa031934dcc13b1691affd1724cecd36"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc4NDMxOA==", "bodyText": "I'm not sure about this.", "url": "https://github.com/gchq/Gaffer/pull/2221#discussion_r365784318", "createdAt": "2020-01-13T12:45:14Z", "author": {"login": "p013570"}, "path": "core/graph/src/main/java/uk/gov/gchq/gaffer/graph/GraphConfig.java", "diffHunk": "@@ -64,6 +65,9 @@\n     private String description;\n     private List<GraphHook> hooks = new ArrayList<>();\n \n+    @JsonInclude(JsonInclude.Include.NON_DEFAULT)\n+    private boolean skipDefaultSecurityHooks = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f612e13fa031934dcc13b1691affd1724cecd36"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc4NTIxMw==", "bodyText": "If we are adding this FunctionAuthoriser by default for every Gaffer system, we should make sure it is efficient and doesn't error.", "url": "https://github.com/gchq/Gaffer/pull/2221#discussion_r365785213", "createdAt": "2020-01-13T12:47:37Z", "author": {"login": "p013570"}, "path": "core/graph/src/main/java/uk/gov/gchq/gaffer/graph/Graph.java", "diffHunk": "@@ -995,6 +1000,11 @@ private void updateGraphHooks(final GraphConfig config) {\n                     config.getHooks().add(0, new NamedOperationResolver());\n                 }\n             }\n+            if (!hasFunctionAuthoriserHook && !config.isSkipDefaultSecurityHooks()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f612e13fa031934dcc13b1691affd1724cecd36"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc4NjAzNA==", "bodyText": "Just wondering if it might be simpler to just call these white and black lists? As you refer to white and black lists in other parts of the code.", "url": "https://github.com/gchq/Gaffer/pull/2221#discussion_r365786034", "createdAt": "2020-01-13T12:49:36Z", "author": {"login": "p013570"}, "path": "core/graph/src/main/java/uk/gov/gchq/gaffer/graph/hook/FunctionAuthoriser.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright 2019 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package uk.gov.gchq.gaffer.graph.hook;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.commonutil.exception.UnauthorisedException;\n+import uk.gov.gchq.gaffer.exception.SerialisationException;\n+import uk.gov.gchq.gaffer.jsonserialisation.JSONSerialiser;\n+import uk.gov.gchq.gaffer.operation.OperationChain;\n+import uk.gov.gchq.gaffer.store.Context;\n+import uk.gov.gchq.koryphe.impl.predicate.And;\n+import uk.gov.gchq.koryphe.impl.predicate.Not;\n+import uk.gov.gchq.koryphe.impl.predicate.Or;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The FunctionAuthoriser is a {@link GraphHook} which stops a user running\n+ * Functions which have been banned. The Authoriser can be configured with a\n+ * list of unauthorised function classes or patterns, or a list of authorised\n+ * patterns to check against.\n+ * <p>\n+ * It should be noted that using the unauthorisedFunctions list will be more\n+ * efficient than using any of the patterns.\n+ */\n+@JsonPropertyOrder(value = {\"unauthorisedFunctions\", \"unauthorisedFunctionPatterns\", \"authorisedFunctionPatterns\"})\n+@JsonInclude(JsonInclude.Include.NON_DEFAULT)\n+public class FunctionAuthoriser implements GraphHook {\n+\n+    private static final String ERROR_MESSAGE_PREFIX = \"Operation chain contained an unauthorised function: \";\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FunctionAuthoriser.class);\n+    private List<Class<? extends Function>> unauthorisedFunctions = new ArrayList<>();\n+    private List<Pattern> authorisedFunctionPatterns = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f612e13fa031934dcc13b1691affd1724cecd36"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc4ODk3MA==", "bodyText": "Rather than going to String then to JsonNode, you might be able to use the valueToTree method on ObjectMapper. Just had a quick look at it and it should work. You would need to expose this in the Gaffer JSONSerialiser class.", "url": "https://github.com/gchq/Gaffer/pull/2221#discussion_r365788970", "createdAt": "2020-01-13T12:56:48Z", "author": {"login": "p013570"}, "path": "core/graph/src/main/java/uk/gov/gchq/gaffer/graph/hook/FunctionAuthoriser.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2019 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package uk.gov.gchq.gaffer.graph.hook;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.commonutil.exception.UnauthorisedException;\n+import uk.gov.gchq.gaffer.exception.SerialisationException;\n+import uk.gov.gchq.gaffer.jsonserialisation.JSONSerialiser;\n+import uk.gov.gchq.gaffer.operation.OperationChain;\n+import uk.gov.gchq.gaffer.store.Context;\n+import uk.gov.gchq.koryphe.impl.predicate.And;\n+import uk.gov.gchq.koryphe.impl.predicate.Not;\n+import uk.gov.gchq.koryphe.impl.predicate.Or;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The FunctionAuthoriser is a {@link GraphHook} which stops a user running\n+ * Functions which have been banned. The Authoriser can be configured with a\n+ * list of unauthorised function classes, or a list of patterns to check against.\n+ * <p>\n+ * It should be noted that using the unauthorisedFunctions list will be more\n+ * efficient than using any of the patterns.\n+ */\n+@JsonPropertyOrder(value = {\"unauthorisedFunctions\", \"unauthorisedFunctionPatterns\"})\n+@JsonInclude(JsonInclude.Include.NON_DEFAULT)\n+public class FunctionAuthoriser implements GraphHook {\n+\n+    private static final String ERROR_MESSAGE_PREFIX = \"Operation chain contained an unauthorised function: \";\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FunctionAuthoriser.class);\n+    private List<Class<? extends Function>> unauthorisedFunctions = new ArrayList<>();\n+    private List<Pattern> authorisedFunctionPatterns = new ArrayList<>();\n+    private List<Pattern> unauthorisedFunctionPatterns = new ArrayList<>();\n+\n+    public FunctionAuthoriser() {\n+    }\n+\n+    public FunctionAuthoriser(final List<Class<? extends Function>> unauthorisedFunctions, final List<Pattern> unauthorisedFunctionPatterns, final List<Pattern> authorisedFunctionPatterns) {\n+        this.setUnauthorisedFunctions(unauthorisedFunctions);\n+        this.setAuthorisedFunctionPatterns(authorisedFunctionPatterns);\n+        this.setUnauthorisedFunctionPatterns(unauthorisedFunctionPatterns);\n+    }\n+\n+    @Override\n+    public void preExecute(final OperationChain<?> opChain, final Context context) {\n+        String chainString;\n+        try {\n+            chainString = new String(JSONSerialiser.serialise(opChain));\n+        } catch (final SerialisationException e) {\n+            // This should never happen in real life as operation chains should\n+            // always be json serialisable. However this could happen if using a\n+            // mock in testing. To account for this, it will be logged.\n+            LOGGER.warn(\"Failed to serialise operation chain: \" + opChain);\n+            return;\n+        }\n+\n+        if (unauthorisedFunctions != null) {\n+            checkNoBlacklistedFunctionsArePresent(chainString);\n+        }\n+        if (authorisedFunctionPatterns != null || unauthorisedFunctionPatterns != null) {\n+            checkAllFunctionsUsedAppearInPatterns(chainString);\n+        }\n+    }\n+\n+    private List<Predicate> convertPatternsToPredicates(final List<Pattern> patterns) {\n+        return patterns.stream()\n+                .map(Pattern::asPredicate)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private void checkAllFunctionsUsedAppearInPatterns(final String chainString) {\n+        boolean noWhitelistPatterns = (authorisedFunctionPatterns == null || authorisedFunctionPatterns.isEmpty());\n+        boolean noBlacklistPatterns = (unauthorisedFunctionPatterns == null || unauthorisedFunctionPatterns.isEmpty());\n+\n+        Predicate<String> isAuthorised = createAuthorisationFunction(noBlacklistPatterns, noWhitelistPatterns);\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg0MTUxOA=="}, "originalCommit": {"oid": "5153aa8818f28db22c114380de8ce2d28cc0243b"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5MDA5NQ==", "bodyText": "The downside of using this mechanism, is you are assuming that all Functions will be serialised with a 'class' field. They should be, but if they are wrapped in some custom object and the JsonSubType annotation changes it, then it could be serialised differently.", "url": "https://github.com/gchq/Gaffer/pull/2221#discussion_r365790095", "createdAt": "2020-01-13T12:59:20Z", "author": {"login": "p013570"}, "path": "core/graph/src/main/java/uk/gov/gchq/gaffer/graph/hook/FunctionAuthoriser.java", "diffHunk": "@@ -0,0 +1,216 @@\n+/*\n+ * Copyright 2019 Crown Copyright\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package uk.gov.gchq.gaffer.graph.hook;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonPropertyOrder;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import uk.gov.gchq.gaffer.commonutil.exception.UnauthorisedException;\n+import uk.gov.gchq.gaffer.exception.SerialisationException;\n+import uk.gov.gchq.gaffer.jsonserialisation.JSONSerialiser;\n+import uk.gov.gchq.gaffer.operation.OperationChain;\n+import uk.gov.gchq.gaffer.store.Context;\n+import uk.gov.gchq.koryphe.impl.predicate.And;\n+import uk.gov.gchq.koryphe.impl.predicate.Not;\n+import uk.gov.gchq.koryphe.impl.predicate.Or;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The FunctionAuthoriser is a {@link GraphHook} which stops a user running\n+ * Functions which have been banned. The Authoriser can be configured with a\n+ * list of unauthorised function classes or patterns, or a list of authorised\n+ * patterns to check against.\n+ * <p>\n+ * It should be noted that using the unauthorisedFunctions list will be more\n+ * efficient than using any of the patterns.\n+ */\n+@JsonPropertyOrder(value = {\"unauthorisedFunctions\", \"unauthorisedFunctionPatterns\", \"authorisedFunctionPatterns\"})\n+@JsonInclude(JsonInclude.Include.NON_DEFAULT)\n+public class FunctionAuthoriser implements GraphHook {\n+\n+    private static final String ERROR_MESSAGE_PREFIX = \"Operation chain contained an unauthorised function: \";\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FunctionAuthoriser.class);\n+    private List<Class<? extends Function>> unauthorisedFunctions = new ArrayList<>();\n+    private List<Pattern> authorisedFunctionPatterns = new ArrayList<>();\n+    private List<Pattern> unauthorisedFunctionPatterns = new ArrayList<>();\n+\n+    public FunctionAuthoriser() {\n+    }\n+\n+    public FunctionAuthoriser(final List<Class<? extends Function>> unauthorisedFunctions, final List<Pattern> unauthorisedFunctionPatterns, final List<Pattern> authorisedFunctionPatterns) {\n+        this.setUnauthorisedFunctions(unauthorisedFunctions);\n+        this.setAuthorisedFunctionPatterns(authorisedFunctionPatterns);\n+        this.setUnauthorisedFunctionPatterns(unauthorisedFunctionPatterns);\n+    }\n+\n+    @Override\n+    public void preExecute(final OperationChain<?> opChain, final Context context) {\n+        String chainString;\n+        try {\n+            chainString = new String(JSONSerialiser.serialise(opChain));\n+        } catch (final SerialisationException e) {\n+            // This should never happen in real life as operation chains should\n+            // always be json serialisable. However this could happen if using a\n+            // mock in testing. To account for this, it will be logged.\n+            LOGGER.warn(\"Failed to serialise operation chain: \" + opChain);\n+            return;\n+        }\n+\n+        if (unauthorisedFunctions != null) {\n+            checkNoBlacklistedFunctionsArePresent(chainString);\n+        }\n+        if (authorisedFunctionPatterns != null || unauthorisedFunctionPatterns != null) {\n+            checkAllFunctionsUsedAppearInCorrectPatterns(chainString);\n+        }\n+    }\n+\n+    private List<Predicate> convertPatternsToPredicates(final List<Pattern> patterns) {\n+        return patterns.stream()\n+                .map(Pattern::asPredicate)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private void checkAllFunctionsUsedAppearInCorrectPatterns(final String chainString) {\n+        boolean noWhitelistPatterns = (authorisedFunctionPatterns == null || authorisedFunctionPatterns.isEmpty());\n+        boolean noBlacklistPatterns = (unauthorisedFunctionPatterns == null || unauthorisedFunctionPatterns.isEmpty());\n+\n+        Predicate<String> isAuthorised = createAuthorisationFunction(noBlacklistPatterns, noWhitelistPatterns);\n+\n+        final JsonNode node;\n+        try {\n+            node = JSONSerialiser.getJsonNodeFromString(chainString);\n+        } catch (final SerialisationException e) {\n+            // This should never happen as the string is derived from a\n+            // serialised object. Therefore throw an exception here.\n+            throw new RuntimeException(\"Failed to convert serialised operation\" +\n+                    \" chain into a JsonNode\", e);\n+        }\n+\n+        List<String> classNames = node.findValuesAsText(\"class\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f612e13fa031934dcc13b1691affd1724cecd36"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a0d2d200736a0f31bc54bd25d59fe307c9cefb9", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/4a0d2d200736a0f31bc54bd25d59fe307c9cefb9", "committedDate": "2020-01-13T14:52:32Z", "message": "gh-2220 moved list of blacklisted functions into util class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab0cce34a841769905c433ea04c55316d5ea4527", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/ab0cce34a841769905c433ea04c55316d5ea4527", "committedDate": "2020-01-14T14:37:59Z", "message": "gh-2220 simplified hook"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "862602e9a8c6eb50d71cb75ac72263c9ee753644", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/862602e9a8c6eb50d71cb75ac72263c9ee753644", "committedDate": "2020-01-14T14:57:36Z", "message": "gh-2220 added tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a6e1dd5b657f5c748c6caec4c59e14ff479453e", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/6a6e1dd5b657f5c748c6caec4c59e14ff479453e", "committedDate": "2020-01-14T15:05:29Z", "message": "gh-2220 renamed methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ca9c7ec721a5a0fcb0f03c8944b262d57148fdf", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/5ca9c7ec721a5a0fcb0f03c8944b262d57148fdf", "committedDate": "2020-01-14T16:30:24Z", "message": "gh-2220 moved input reset into finally block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63ee7c989ae6a982f3347ef1180daacacf209808", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/63ee7c989ae6a982f3347ef1180daacacf209808", "committedDate": "2020-01-14T16:36:11Z", "message": "gh-2220 fixed potentially massive error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b21cf02d157b792a5cfce9292c6364d5cf8d862", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/2b21cf02d157b792a5cfce9292c6364d5cf8d862", "committedDate": "2020-01-15T10:08:30Z", "message": "gh-2220 refactored graph"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd05396a6c81d9359b9b7efe4c96a12d8b3d99e9", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/cd05396a6c81d9359b9b7efe4c96a12d8b3d99e9", "committedDate": "2020-01-15T12:57:27Z", "message": "gh-2220 updated copyright and added entry in docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5063fe0e1110ca763648c4c25a0c629079d3a6f5", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/5063fe0e1110ca763648c4c25a0c629079d3a6f5", "committedDate": "2020-01-15T13:05:42Z", "message": "gh-2220 made FunctionAuthoriserTest implement GraphHookTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd01df7ffc59911a053086038116c36f6edd8ce5", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/dd01df7ffc59911a053086038116c36f6edd8ce5", "committedDate": "2020-01-15T13:30:12Z", "message": "gh-2220 updated docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMjM0Njgy", "url": "https://github.com/gchq/Gaffer/pull/2221#pullrequestreview-343234682", "createdAt": "2020-01-15T13:57:36Z", "commit": {"oid": "dd01df7ffc59911a053086038116c36f6edd8ce5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1823, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}