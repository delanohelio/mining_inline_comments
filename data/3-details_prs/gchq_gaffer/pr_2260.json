{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MjAxMDIw", "number": 2260, "title": "Gh 2259 FederatedStore mitigate infinite loop", "bodyText": "", "createdAt": "2020-03-16T12:24:42Z", "url": "https://github.com/gchq/Gaffer/pull/2260", "merged": true, "mergeCommit": {"oid": "40a38e06b64b0b5bbd882c41f1c1b828d6dc8eb5"}, "closed": true, "closedAt": "2020-04-14T10:23:29Z", "author": {"login": "GCHQDev404"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOMMd5AH2gAyMzg5MjAxMDIwOjI4ZGUyYWEyZDJjNzI3MmY4YmQyZGY3ZGQ1ZTI0MzZlYjEwNzg4NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT9wUpAFqTM4NzExMDQ4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "28de2aa2d2c7272f8bd2df7dd5e2436eb1078863", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/28de2aa2d2c7272f8bd2df7dd5e2436eb1078863", "committedDate": "2020-03-16T11:13:30Z", "message": "gh-2259 FederatedStore test for infinite loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4096ed0cdf453b0201c88a874aa783ca9c82d012", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/4096ed0cdf453b0201c88a874aa783ca9c82d012", "committedDate": "2020-03-16T12:46:38Z", "message": "gh-2259 FederatedStore will not return graphs more than once for the same operation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e272f4f37c5a836440ab39180e5ddc1a2b1303f7", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/e272f4f37c5a836440ab39180e5ddc1a2b1303f7", "committedDate": "2020-03-16T11:13:55Z", "message": "gh-2259 FederatedStore will not return graphs more than once for the same operation."}, "afterCommit": {"oid": "4096ed0cdf453b0201c88a874aa783ca9c82d012", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/4096ed0cdf453b0201c88a874aa783ca9c82d012", "committedDate": "2020-03-16T12:46:38Z", "message": "gh-2259 FederatedStore will not return graphs more than once for the same operation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTg0MjU2", "url": "https://github.com/gchq/Gaffer/pull/2260#pullrequestreview-375184256", "createdAt": "2020-03-16T12:51:57Z", "commit": {"oid": "e272f4f37c5a836440ab39180e5ddc1a2b1303f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjo1NDowNlrOF2y8fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjo1NDowNlrOF2y8fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAwMjExMQ==", "bodyText": "Is there any value in keeping this signature as an overload, and perhaps adding one for getGraphs(user)?", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r393002111", "createdAt": "2020-03-16T12:54:06Z", "author": {"login": "t11947"}, "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -334,10 +350,23 @@ public Schema getSchema(final Map<String, String> config, final User user) {\n      *\n      * @param user        the users scope to get graphs for.\n      * @param graphIdsCsv the csv of graphIds to get, null returns all graphs.\n+     * @param operation   the requesting operation.\n      * @return the graph collection.\n      */\n-    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4096ed0cdf453b0201c88a874aa783ca9c82d012"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "861bb0b94ec045638f50146865184060dc2e20d0", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/861bb0b94ec045638f50146865184060dc2e20d0", "committedDate": "2020-03-17T15:58:37Z", "message": "gh-2259 FederatedStore Logging, Test fixes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4877214d65715d8936e873061b444ab2a17379ca", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/4877214d65715d8936e873061b444ab2a17379ca", "committedDate": "2020-03-16T15:32:26Z", "message": "Merge branch 'develop' into gh-2259-FedeatedStore-mitigate-infinate-loop"}, "afterCommit": {"oid": "861bb0b94ec045638f50146865184060dc2e20d0", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/861bb0b94ec045638f50146865184060dc2e20d0", "committedDate": "2020-03-17T15:58:37Z", "message": "gh-2259 FederatedStore Logging, Test fixes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNjIxNTQy", "url": "https://github.com/gchq/Gaffer/pull/2260#pullrequestreview-380621542", "createdAt": "2020-03-24T19:14:21Z", "commit": {"oid": "9965c0644a99b3a77a829a64da37fb8d486cc445"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTQ3NTU2", "url": "https://github.com/gchq/Gaffer/pull/2260#pullrequestreview-380947556", "createdAt": "2020-03-25T08:44:11Z", "commit": {"oid": "9965c0644a99b3a77a829a64da37fb8d486cc445"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwODo0NDoxMVrOF7Q3jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwOToyMTowMlrOF7SKqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4NjY3MQ==", "bodyText": "Re-add old method to maintain public api. Old tests should be reverted and should pass.", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r397686671", "createdAt": "2020-03-25T08:44:11Z", "author": {"login": "d47853"}, "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -328,16 +349,45 @@ public Schema getSchema(final Map<String, String> config, final User user) {\n      * given csv of graphIds, with visibility of the given user.\n      * </p>\n      * <p>\n+     * Graphs are returned once per operation, this does not allow an infinite loop of FederatedStores to occur.\n+     * </p>\n+     * <p>\n      * if graphIdsCsv is null then all graph objects within FederatedStore\n      * scope are returned.\n      * </p>\n      *\n      * @param user        the users scope to get graphs for.\n      * @param graphIdsCsv the csv of graphIds to get, null returns all graphs.\n+     * @param operation   the requesting operation, graphs are returned only once per operation.\n      * @return the graph collection.\n      */\n-    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv) {\n-        return graphStorage.get(user, getCleanStrings(graphIdsCsv));\n+    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv, final Operation operation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9965c0644a99b3a77a829a64da37fb8d486cc445"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcwNDAwMA==", "bodyText": "Does this mean that two FederatedStores in seperate JVMs could have the same id?", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r397704000", "createdAt": "2020-03-25T09:14:31Z", "author": {"login": "d47853"}, "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -102,9 +111,21 @@\n  * @see Graph\n  */\n public class FederatedStore extends Store {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Store.class);\n+    private static final String FEDERATED_STORE_PROCESSED = \"FederatedStore.processed.\";\n     private FederatedGraphStorage graphStorage = new FederatedGraphStorage();\n     private Set<String> customPropertiesAuths;\n     private Boolean isPublicAccessAllowed = Boolean.valueOf(IS_PUBLIC_ACCESS_ALLOWED_DEFAULT);\n+    private static final List<Integer> ALL_IDS = new ArrayList<>();\n+    private final int id;\n+\n+    public FederatedStore() {\n+        Integer i = null;\n+        while (isNull(i) || ALL_IDS.contains(i)) {\n+            i = new Random().nextInt();\n+        }\n+        ALL_IDS.add(id = i);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9965c0644a99b3a77a829a64da37fb8d486cc445"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcwNzA0NA==", "bodyText": "Does operation.getOpertions() need wrapping here?", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r397707044", "createdAt": "2020-03-25T09:19:32Z", "author": {"login": "d47853"}, "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -328,16 +349,45 @@ public Schema getSchema(final Map<String, String> config, final User user) {\n      * given csv of graphIds, with visibility of the given user.\n      * </p>\n      * <p>\n+     * Graphs are returned once per operation, this does not allow an infinite loop of FederatedStores to occur.\n+     * </p>\n+     * <p>\n      * if graphIdsCsv is null then all graph objects within FederatedStore\n      * scope are returned.\n      * </p>\n      *\n      * @param user        the users scope to get graphs for.\n      * @param graphIdsCsv the csv of graphIds to get, null returns all graphs.\n+     * @param operation   the requesting operation, graphs are returned only once per operation.\n      * @return the graph collection.\n      */\n-    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv) {\n-        return graphStorage.get(user, getCleanStrings(graphIdsCsv));\n+    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv, final Operation operation) {\n+        Collection<Graph> rtn = new ArrayList<>();\n+        if (nonNull(operation)) {\n+            String optionKey = FEDERATED_STORE_PROCESSED + id;\n+            boolean isIdFound = !operation.getOption(optionKey, \"\").isEmpty();\n+            if (!isIdFound) {\n+                HashMap<String, String> updatedOptions = isNull(operation.getOptions()) ? new HashMap<>() : new HashMap<>(operation.getOptions());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9965c0644a99b3a77a829a64da37fb8d486cc445"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcwNzk0NA==", "bodyText": "Why not just use operation.addOption()?", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r397707944", "createdAt": "2020-03-25T09:21:02Z", "author": {"login": "d47853"}, "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -328,16 +349,45 @@ public Schema getSchema(final Map<String, String> config, final User user) {\n      * given csv of graphIds, with visibility of the given user.\n      * </p>\n      * <p>\n+     * Graphs are returned once per operation, this does not allow an infinite loop of FederatedStores to occur.\n+     * </p>\n+     * <p>\n      * if graphIdsCsv is null then all graph objects within FederatedStore\n      * scope are returned.\n      * </p>\n      *\n      * @param user        the users scope to get graphs for.\n      * @param graphIdsCsv the csv of graphIds to get, null returns all graphs.\n+     * @param operation   the requesting operation, graphs are returned only once per operation.\n      * @return the graph collection.\n      */\n-    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv) {\n-        return graphStorage.get(user, getCleanStrings(graphIdsCsv));\n+    public Collection<Graph> getGraphs(final User user, final String graphIdsCsv, final Operation operation) {\n+        Collection<Graph> rtn = new ArrayList<>();\n+        if (nonNull(operation)) {\n+            String optionKey = FEDERATED_STORE_PROCESSED + id;\n+            boolean isIdFound = !operation.getOption(optionKey, \"\").isEmpty();\n+            if (!isIdFound) {\n+                HashMap<String, String> updatedOptions = isNull(operation.getOptions()) ? new HashMap<>() : new HashMap<>(operation.getOptions());\n+                updatedOptions.put(optionKey, getGraphId());\n+                operation.setOptions(updatedOptions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9965c0644a99b3a77a829a64da37fb8d486cc445"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMDgwNjMy", "url": "https://github.com/gchq/Gaffer/pull/2260#pullrequestreview-381080632", "createdAt": "2020-03-25T11:57:54Z", "commit": {"oid": "9965c0644a99b3a77a829a64da37fb8d486cc445"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMTo1Nzo1NFrOF7XwYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMTo1Nzo1NFrOF7XwYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5OTUyMg==", "bodyText": "Is it worth hoisting the Random object to stop it being created every loop, and instantiating i to a random int off the bat to prevent the need for a null check?", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r397799522", "createdAt": "2020-03-25T11:57:54Z", "author": {"login": "t11947"}, "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -102,9 +111,21 @@\n  * @see Graph\n  */\n public class FederatedStore extends Store {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Store.class);\n+    private static final String FEDERATED_STORE_PROCESSED = \"FederatedStore.processed.\";\n     private FederatedGraphStorage graphStorage = new FederatedGraphStorage();\n     private Set<String> customPropertiesAuths;\n     private Boolean isPublicAccessAllowed = Boolean.valueOf(IS_PUBLIC_ACCESS_ALLOWED_DEFAULT);\n+    private static final List<Integer> ALL_IDS = new ArrayList<>();\n+    private final int id;\n+\n+    public FederatedStore() {\n+        Integer i = null;\n+        while (isNull(i) || ALL_IDS.contains(i)) {\n+            i = new Random().nextInt();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9965c0644a99b3a77a829a64da37fb8d486cc445"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzQ1ODUx", "url": "https://github.com/gchq/Gaffer/pull/2260#pullrequestreview-382745851", "createdAt": "2020-03-27T10:39:35Z", "commit": {"oid": "9965c0644a99b3a77a829a64da37fb8d486cc445"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMDozOTozNVrOF8rq9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMDozOTozNVrOF8rq9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NDM5MA==", "bodyText": "Consider not using constant case for mutable lists.", "url": "https://github.com/gchq/Gaffer/pull/2260#discussion_r399174390", "createdAt": "2020-03-27T10:39:35Z", "author": {"login": "t11947"}, "path": "store-implementation/federated-store/src/main/java/uk/gov/gchq/gaffer/federatedstore/FederatedStore.java", "diffHunk": "@@ -102,9 +111,21 @@\n  * @see Graph\n  */\n public class FederatedStore extends Store {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Store.class);\n+    private static final String FEDERATED_STORE_PROCESSED = \"FederatedStore.processed.\";\n     private FederatedGraphStorage graphStorage = new FederatedGraphStorage();\n     private Set<String> customPropertiesAuths;\n     private Boolean isPublicAccessAllowed = Boolean.valueOf(IS_PUBLIC_ACCESS_ALLOWED_DEFAULT);\n+    private static final List<Integer> ALL_IDS = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9965c0644a99b3a77a829a64da37fb8d486cc445"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ed4148bafd631c9545d831c453cd5093a99100c", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/1ed4148bafd631c9545d831c453cd5093a99100c", "committedDate": "2020-04-01T16:56:22Z", "message": "gh-2259 checkstyle"}, "afterCommit": {"oid": "440c30c6accf423fa0878d3bf791f30f6768f4b1", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/440c30c6accf423fa0878d3bf791f30f6768f4b1", "committedDate": "2020-04-01T18:23:11Z", "message": "gh-2259 FederatedStore PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6195da26af27a1b81d6f6647218d140e67dbdb0", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/f6195da26af27a1b81d6f6647218d140e67dbdb0", "committedDate": "2020-04-02T20:55:08Z", "message": "gh-2259 FederatedStore PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cc8a98cf13a839de714d5c2fa15f0bc390877b3", "author": {"user": {"login": "GCHQDev404", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/2cc8a98cf13a839de714d5c2fa15f0bc390877b3", "committedDate": "2020-04-02T20:56:02Z", "message": "Merge remote-tracking branch 'origin/develop' into gh-2259-FedeatedStore-mitigate-infinate-loop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTEwNDgw", "url": "https://github.com/gchq/Gaffer/pull/2260#pullrequestreview-387110480", "createdAt": "2020-04-03T09:47:38Z", "commit": {"oid": "2cc8a98cf13a839de714d5c2fa15f0bc390877b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1851, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}