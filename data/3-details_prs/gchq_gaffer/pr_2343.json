{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMjg4NDUw", "number": 2343, "title": "bugfix for gh-2239:  Merging views with global elements", "bodyText": "Resolves #2293\nOnly expand Global* elements in a View if the schema contains an entry with that element type in.  This supports stores such as the FederatedStore where the first Store a query gets run against is in some way a proxy of some other store(s) and doesn't have the schema information to do the expansion.\nAlso, update the logic in updateOperationChain such that it no longer expands  a View with no entities and edges but, e.g., a globalEntities element to include all of the edges.\nWhen reviewing, please note that I've chosen to change updateOperationChain to default scope for testing purposes and because the code didn't feel like it was perfectly encapsulated by the logic of executing a query.  Alternatively, I could change the tests to run against the public execute method (which felt a bit broad) or use reflection to test the method as a private (but I'm not sure how you feel about that 'round these parts).  Lastly, where there's identical logic for Edges and Entities, I've only included a unit for the edges part, but let me know if you want a repeated unit test for the Entities logic", "createdAt": "2020-11-17T10:04:32Z", "url": "https://github.com/gchq/Gaffer/pull/2343", "merged": true, "mergeCommit": {"oid": "458df7b2333b9afa58b038b88d77f1a10c8a970b"}, "closed": true, "closedAt": "2020-11-30T10:45:37Z", "author": {"login": "sw96411"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddWz0YgH2gAyNTIyMjg4NDUwOjIxODU3NTljZDY3MjMwOGI3YTYyM2RhNmM4NWI2YmUwMjE2ZmU0ZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhijWNgH2gAyNTIyMjg4NDUwOmUyN2FmYWVhODc2ZDQ4YjgwMWFlN2QyMDc3OTQ5MWU0ZTRkNzY4NmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2185759cd672308b7a623da6c85b6be0216fe4e3", "author": {"user": {"login": "sw96411", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/2185759cd672308b7a623da6c85b6be0216fe4e3", "committedDate": "2020-11-17T10:15:33Z", "message": "Only expand Global* elements in a View if the schema contains an entry with that element in.  This supports stores such as the FederatedStore where the first Store a query gets run against is in some way a proxy of some other store(s) and doesn't have the schema information to do the expansion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8541087241882cab0064d85382b9d005a93f5fef", "author": {"user": {"login": "sw96411", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/8541087241882cab0064d85382b9d005a93f5fef", "committedDate": "2020-11-17T11:16:18Z", "message": "gh-2239:  Updating to try and pass the checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMzI3MTEw", "url": "https://github.com/gchq/Gaffer/pull/2343#pullrequestreview-532327110", "createdAt": "2020-11-17T12:49:30Z", "commit": {"oid": "8541087241882cab0064d85382b9d005a93f5fef"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjo0OTozMFrOH0zTCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjo1NToyMlrOH0zgmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyODQ1OQ==", "bodyText": "Is this change needed? If it's just for the test then it would be better to indirectly call it from one of the public methods", "url": "https://github.com/gchq/Gaffer/pull/2343#discussion_r525128459", "createdAt": "2020-11-17T12:49:30Z", "author": {"login": "d47853"}, "path": "core/graph/src/main/java/uk/gov/gchq/gaffer/graph/Graph.java", "diffHunk": "@@ -350,22 +354,32 @@ public JobDetail executeJob(final Job job, final Context context) throws Operati\n         return new GraphResult<>(result, clonedContext);\n     }\n \n-    private void updateOperationChainView(final Operations<?> operations) {\n+    void updateOperationChainView(final Operations<?> operations) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8541087241882cab0064d85382b9d005a93f5fef"}, "originalPosition": 215}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyODU5Mw==", "bodyText": "There are a lot of changes to this file, most are whitespace from what I can tell. Please could you revert some of the whitespace changes so it's easier to review?", "url": "https://github.com/gchq/Gaffer/pull/2343#discussion_r525128593", "createdAt": "2020-11-17T12:49:44Z", "author": {"login": "d47853"}, "path": "core/graph/src/test/java/uk/gov/gchq/gaffer/graph/GraphTest.java", "diffHunk": "@@ -166,73 +167,41 @@ public void shouldConstructGraphFromSchemaModules() {\n         storeProperties.setStoreClass(TestStoreImpl.class.getName());\n \n         final Schema schemaModule1 = new Schema.Builder()\n-                .type(TestTypes.PROP_STRING, new TypeDefinition.Builder()\n-                        .clazz(String.class)\n-                        .build())\n-                .type(\"vertex\", new TypeDefinition.Builder()\n-                        .clazz(String.class)\n-                        .build())\n-                .edge(TestGroups.EDGE, new SchemaEdgeDefinition.Builder()\n-                        .property(TestPropertyNames.PROP_1, TestTypes.PROP_STRING)\n-                        .aggregate(false)\n-                        .source(\"vertex\")\n-                        .destination(\"vertex\")\n-                        .directed(DIRECTED_EITHER)\n-                        .build())\n+                .type(TestTypes.PROP_STRING, new TypeDefinition.Builder().clazz(String.class).build())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8541087241882cab0064d85382b9d005a93f5fef"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEzMTkyOA==", "bodyText": "Might be worth adding some integration tests into the federated store to check the behaviour", "url": "https://github.com/gchq/Gaffer/pull/2343#discussion_r525131928", "createdAt": "2020-11-17T12:55:22Z", "author": {"login": "d47853"}, "path": "core/graph/src/test/java/uk/gov/gchq/gaffer/graph/GraphTest.java", "diffHunk": "@@ -2418,20 +1970,94 @@ public void shouldNotAddDefaultSecurityHooksIfAlreadyAdded() {\n         TestStore.mockStore = mock(Store.class);\n         given(TestStore.mockStore.isSupported(NamedOperation.class)).willReturn(true);\n         // When\n-        final GraphConfig config = new GraphConfig.Builder()\n-                .graphId(\"test\")\n-                .addHook(new FunctionAuthoriser(Lists.newArrayList(Identity.class)))\n+        final GraphConfig config = new GraphConfig.Builder().graphId(\"test\")\n+                .addHook(new FunctionAuthoriser(Lists.newArrayList(Identity.class))).build();\n+\n+        final Graph graph = new Graph.Builder().addSchemas(StreamUtil.schemas(getClass()))\n+                .storeProperties(storeProperties).config(config).build();\n+\n+        // Then\n+        assertEquals(Arrays.asList(NamedOperationResolver.class, NamedViewResolver.class, FunctionAuthoriser.class),\n+                graph.getGraphHooks());\n+        assertEquals(Identity.class,\n+                ((FunctionAuthoriser) graph.getConfig().getHooks().get(2)).getUnauthorisedFunctions().get(0));\n+    }\n+\n+    @Test\n+    public void shouldExpandGlobalEdges() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8541087241882cab0064d85382b9d005a93f5fef"}, "originalPosition": 1825}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f7c3e7ffa0a973b5f5f1c0bf377d8a62dea810c", "author": {"user": {"login": "sw96411", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/5f7c3e7ffa0a973b5f5f1c0bf377d8a62dea810c", "committedDate": "2020-11-19T18:25:51Z", "message": "gh-2239: Testing via execute method, formatting matches as close as possible to original"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ae90fb60e0239773da89d59d191c287736f522d", "author": {"user": {"login": "sw96411", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/9ae90fb60e0239773da89d59d191c287736f522d", "committedDate": "2020-11-20T09:46:04Z", "message": "gh-2239;  Adding a test to ensure that global entities and expanded in the subgraphs of a federated graph"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "466f41542b60664cff9457c7094330c4edeb99d1", "author": {"user": {"login": "sw96411", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/466f41542b60664cff9457c7094330c4edeb99d1", "committedDate": "2020-11-26T11:48:36Z", "message": "Ensuring 100% test coverage of updateOperationChain in Graph.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d19fbfb264556ffc34c495bced7e00361d32bd2", "author": {"user": {"login": "sw96411", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/8d19fbfb264556ffc34c495bced7e00361d32bd2", "committedDate": "2020-11-26T13:20:20Z", "message": "gh-2239:  Reverting change made to version of fedeerated-store in error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5ODg2Mjcy", "url": "https://github.com/gchq/Gaffer/pull/2343#pullrequestreview-539886272", "createdAt": "2020-11-27T10:52:58Z", "commit": {"oid": "8d19fbfb264556ffc34c495bced7e00361d32bd2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e27afaea876d48b801ae7d20779491e4e4d7686e", "author": {"user": {"login": "d47853", "name": null}}, "url": "https://github.com/gchq/Gaffer/commit/e27afaea876d48b801ae7d20779491e4e4d7686e", "committedDate": "2020-11-30T10:12:07Z", "message": "Merge branch 'develop' into gh-2239-global-no-schema"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1808, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}