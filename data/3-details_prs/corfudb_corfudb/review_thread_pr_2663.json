{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NDIzMzY1", "number": 2663, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjoyNDowMlrOESoDKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjo0ODoxOVrOESoVQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3OTY1OTkyOnYy", "diffSide": "LEFT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/TestDataSender.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjoyNDowMlrOG36NcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNzo0MTo0OVrOG4Xgrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI3ODU3Ng==", "bodyText": "nit - probably we should rename this to setter of something.. because it is only setting the metadata.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461278576", "createdAt": "2020-07-28T02:24:02Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/TestDataSender.java", "diffHunk": "@@ -34,7 +36,18 @@ public TestDataSender() {\n         }\n \n         CompletableFuture<LogReplicationEntry> cf = new CompletableFuture<>();\n-        LogReplicationEntry ack = LogReplicationEntry.generateAck(message.getMetadata());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1ODYzOA==", "bodyText": "Yes, I had this comment on another PR and that PR is addressing it, so I'm not going to touch this here to not conflict.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461758638", "createdAt": "2020-07-28T17:41:49Z", "author": {"login": "annym"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/TestDataSender.java", "diffHunk": "@@ -34,7 +36,18 @@ public TestDataSender() {\n         }\n \n         CompletableFuture<LogReplicationEntry> cf = new CompletableFuture<>();\n-        LogReplicationEntry ack = LogReplicationEntry.generateAck(message.getMetadata());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI3ODU3Ng=="}, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3OTY4MTM0OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/TestSnapshotReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjozNTozNVrOG36ZvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNzo0MjoxNVrOG4XhrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4MTcyNA==", "bodyText": "index is never getting updated.  will it ever reach the condition index<baseSnapshot?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461281724", "createdAt": "2020-07-28T02:35:35Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/TestSnapshotReader.java", "diffHunk": "@@ -40,23 +40,24 @@ public SnapshotReadMessage read(UUID snapshotRequestId) {\n         // Connect to endpoint\n         List<LogReplicationEntry> messages = new ArrayList<>();\n \n+        int index = globalIndex;\n+\n+        // Limit to read as max as BatchSize and until the maximum baseSnapshot\n+        for (int i=index; (i<(index+config.getBatchSize()) && index<baseSnapshot) ; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1ODg5Mw==", "bodyText": "it is in line 43", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461758893", "createdAt": "2020-07-28T17:42:15Z", "author": {"login": "annym"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/TestSnapshotReader.java", "diffHunk": "@@ -40,23 +40,24 @@ public SnapshotReadMessage read(UUID snapshotRequestId) {\n         // Connect to endpoint\n         List<LogReplicationEntry> messages = new ArrayList<>();\n \n+        int index = globalIndex;\n+\n+        // Limit to read as max as BatchSize and until the maximum baseSnapshot\n+        for (int i=index; (i<(index+config.getBatchSize()) && index<baseSnapshot) ; i++) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4MTcyNA=="}, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3OTcwMjc3OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjo0NjowOFrOG36liw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNzo0MzozN1rOG4XksQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4NDc0Nw==", "bodyText": "apply has not been done yet, right?  Only transfer has completed?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461284747", "createdAt": "2020-07-28T02:46:08Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -272,26 +272,33 @@ private LogReplicationEntry processReceivedMessage(LogReplicationEntry message)\n             return logEntrySinkBufferManager.processMsgAndBuffer(message);\n         } else {\n             LogReplicationEntry ack = snapshotSinkBufferManager.processMsgAndBuffer(message);\n-            // Check to the one persisted...\n-            if (ack.getMetadata().getMessageMetadataType() == MessageType.SNAPSHOT_REPLICATED) {\n-                long lastAppliedBaseSnapshotTimestamp = logReplicationMetadataManager.getLastAppliedBaseSnapshotTimestamp();\n-                long latestSnapshotSyncCycleId = logReplicationMetadataManager.getCurrentSnapshotSyncCycleId();\n-                long ackSnapshotSyncCycleId = ack.getMetadata().getSyncRequestId().getMostSignificantBits() & Long.MAX_VALUE;\n-                // Verify this snapshot ACK corresponds to the last initialized/valid snapshot sync\n-                // as a previous one could have been canceled but still processed due to messages being out of order\n-                if ((ackSnapshotSyncCycleId == latestSnapshotSyncCycleId) &&\n-                        (ack.getMetadata().getSnapshotTimestamp() == lastAppliedBaseSnapshotTimestamp)) {\n-                    // Notify end of snapshot sync. This is a blocking call.\n-                    snapshotSyncPlugin.onSnapshotSyncEnd(runtime);\n-                } else {\n-                    log.warn(\"SNAPSHOT_SYNC has completed for {}, but new ongoing SNAPSHOT_SYNC is {}\",\n-                            ack.getMetadata().getSnapshotTimestamp(), lastAppliedBaseSnapshotTimestamp);\n-                }\n+            // If the snapshot sync apply has completed (determined by the end marker) notify\n+            // plugin the completion, so checkpoint/trim process is resumed.\n+            if (ack.getMetadata().getMessageMetadataType() == SNAPSHOT_END) {\n+                processSnapshotSyncApplied(ack);\n             }\n             return ack;\n         }\n     }\n \n+    private void processSnapshotSyncApplied(LogReplicationEntry ack) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1OTY2NQ==", "bodyText": "It has been applied already.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461759665", "createdAt": "2020-07-28T17:43:37Z", "author": {"login": "annym"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -272,26 +272,33 @@ private LogReplicationEntry processReceivedMessage(LogReplicationEntry message)\n             return logEntrySinkBufferManager.processMsgAndBuffer(message);\n         } else {\n             LogReplicationEntry ack = snapshotSinkBufferManager.processMsgAndBuffer(message);\n-            // Check to the one persisted...\n-            if (ack.getMetadata().getMessageMetadataType() == MessageType.SNAPSHOT_REPLICATED) {\n-                long lastAppliedBaseSnapshotTimestamp = logReplicationMetadataManager.getLastAppliedBaseSnapshotTimestamp();\n-                long latestSnapshotSyncCycleId = logReplicationMetadataManager.getCurrentSnapshotSyncCycleId();\n-                long ackSnapshotSyncCycleId = ack.getMetadata().getSyncRequestId().getMostSignificantBits() & Long.MAX_VALUE;\n-                // Verify this snapshot ACK corresponds to the last initialized/valid snapshot sync\n-                // as a previous one could have been canceled but still processed due to messages being out of order\n-                if ((ackSnapshotSyncCycleId == latestSnapshotSyncCycleId) &&\n-                        (ack.getMetadata().getSnapshotTimestamp() == lastAppliedBaseSnapshotTimestamp)) {\n-                    // Notify end of snapshot sync. This is a blocking call.\n-                    snapshotSyncPlugin.onSnapshotSyncEnd(runtime);\n-                } else {\n-                    log.warn(\"SNAPSHOT_SYNC has completed for {}, but new ongoing SNAPSHOT_SYNC is {}\",\n-                            ack.getMetadata().getSnapshotTimestamp(), lastAppliedBaseSnapshotTimestamp);\n-                }\n+            // If the snapshot sync apply has completed (determined by the end marker) notify\n+            // plugin the completion, so checkpoint/trim process is resumed.\n+            if (ack.getMetadata().getMessageMetadataType() == SNAPSHOT_END) {\n+                processSnapshotSyncApplied(ack);\n             }\n             return ack;\n         }\n     }\n \n+    private void processSnapshotSyncApplied(LogReplicationEntry ack) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4NDc0Nw=="}, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3OTcwNjI3OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/SenderBufferManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjo0ODoxOVrOG36nmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNzo0MzowMlrOG4Xjcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4NTI3NQ==", "bodyText": "default value will be false which can change the behavior.. is it intentional?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461285275", "createdAt": "2020-07-28T02:48:19Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/SenderBufferManager.java", "diffHunk": "@@ -53,8 +52,7 @@\n     /*\n      * If there is a timeout for a message, should generate an error or not\n      */\n-    private boolean errorOnMsgTimeout = true;\n-\n+    private boolean errorOnMsgTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1OTM0Ng==", "bodyText": "the static code analysis asks to remove this redundant. It is initialized in the constructor.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461759346", "createdAt": "2020-07-28T17:43:02Z", "author": {"login": "annym"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/SenderBufferManager.java", "diffHunk": "@@ -53,8 +52,7 @@\n     /*\n      * If there is a timeout for a message, should generate an error or not\n      */\n-    private boolean errorOnMsgTimeout = true;\n-\n+    private boolean errorOnMsgTimeout;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4NTI3NQ=="}, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1885, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}