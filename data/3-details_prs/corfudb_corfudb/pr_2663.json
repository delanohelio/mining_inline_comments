{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NDIzMzY1", "number": 2663, "title": "Fix FSM Unit Test and Snapshot Plugin Condition", "bodyText": "Overview\nDescription:\n\nFix Intermittent Failure on FSM Unit Test\nFix onSnapshotEnd condition to check for an ack SNAPSHOT_END instead of SNAPSHOT_REPLICATED (intermediate acks)\n\nWhy should this be merged: stabilize log replication master branch", "createdAt": "2020-07-27T21:57:22Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663", "merged": true, "mergeCommit": {"oid": "6440b33638d93adf3cb224c96d00ef4a86264a95"}, "closed": true, "closedAt": "2020-07-28T17:43:55Z", "author": {"login": "annym"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5JJeyAH2gAyNDU3NDIzMzY1OmQ4NjE1ZDc5ZmQ4ZjlhNmZmNzdiNDljODVmMGJlNWMzY2VlYmVjNGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5NZbFAFqTQ1NjI1ODA3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f", "committedDate": "2020-07-27T21:59:16Z", "message": "Fix FSM Unit Test and Snapshot Plugin Condition\n\n- Fix Intermittent Failure on FSM Unit Test\n- Fix onSnapshotEnd condition to check for an ack SNAPSHOT_END instead of SNAPSHOT_REPLICATED (intermediate acks)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "799d83cd2f75240986648610a80e0cc6f4b59647", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/799d83cd2f75240986648610a80e0cc6f4b59647", "committedDate": "2020-07-27T21:53:23Z", "message": "Fix FSM Unit Test and Snapshot Plugin Condition\n\n- Fix Intermittent Failure on FSM Unit Test\n- Fix onSnapshotEnd condition to check for an ack SNAPSHOT_END instead of SNAPSHOT_REPLICATED (intermediate acks)"}, "afterCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f", "committedDate": "2020-07-27T21:59:16Z", "message": "Fix FSM Unit Test and Snapshot Plugin Condition\n\n- Fix Intermittent Failure on FSM Unit Test\n- Fix onSnapshotEnd condition to check for an ack SNAPSHOT_END instead of SNAPSHOT_REPLICATED (intermediate acks)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTY3NTU2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#pullrequestreview-456167556", "createdAt": "2020-07-27T22:03:53Z", "commit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTk1NTQ4", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#pullrequestreview-456195548", "createdAt": "2020-07-27T23:10:03Z", "commit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MjEwMTY2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#pullrequestreview-456210166", "createdAt": "2020-07-27T23:49:46Z", "commit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MjU4MDc2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#pullrequestreview-456258076", "createdAt": "2020-07-28T02:24:02Z", "commit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjoyNDowMlrOG36NcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjo0ODoxOVrOG36nmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI3ODU3Ng==", "bodyText": "nit - probably we should rename this to setter of something.. because it is only setting the metadata.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461278576", "createdAt": "2020-07-28T02:24:02Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/TestDataSender.java", "diffHunk": "@@ -34,7 +36,18 @@ public TestDataSender() {\n         }\n \n         CompletableFuture<LogReplicationEntry> cf = new CompletableFuture<>();\n-        LogReplicationEntry ack = LogReplicationEntry.generateAck(message.getMetadata());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4MTcyNA==", "bodyText": "index is never getting updated.  will it ever reach the condition index<baseSnapshot?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461281724", "createdAt": "2020-07-28T02:35:35Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/fsm/TestSnapshotReader.java", "diffHunk": "@@ -40,23 +40,24 @@ public SnapshotReadMessage read(UUID snapshotRequestId) {\n         // Connect to endpoint\n         List<LogReplicationEntry> messages = new ArrayList<>();\n \n+        int index = globalIndex;\n+\n+        // Limit to read as max as BatchSize and until the maximum baseSnapshot\n+        for (int i=index; (i<(index+config.getBatchSize()) && index<baseSnapshot) ; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4NDc0Nw==", "bodyText": "apply has not been done yet, right?  Only transfer has completed?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461284747", "createdAt": "2020-07-28T02:46:08Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -272,26 +272,33 @@ private LogReplicationEntry processReceivedMessage(LogReplicationEntry message)\n             return logEntrySinkBufferManager.processMsgAndBuffer(message);\n         } else {\n             LogReplicationEntry ack = snapshotSinkBufferManager.processMsgAndBuffer(message);\n-            // Check to the one persisted...\n-            if (ack.getMetadata().getMessageMetadataType() == MessageType.SNAPSHOT_REPLICATED) {\n-                long lastAppliedBaseSnapshotTimestamp = logReplicationMetadataManager.getLastAppliedBaseSnapshotTimestamp();\n-                long latestSnapshotSyncCycleId = logReplicationMetadataManager.getCurrentSnapshotSyncCycleId();\n-                long ackSnapshotSyncCycleId = ack.getMetadata().getSyncRequestId().getMostSignificantBits() & Long.MAX_VALUE;\n-                // Verify this snapshot ACK corresponds to the last initialized/valid snapshot sync\n-                // as a previous one could have been canceled but still processed due to messages being out of order\n-                if ((ackSnapshotSyncCycleId == latestSnapshotSyncCycleId) &&\n-                        (ack.getMetadata().getSnapshotTimestamp() == lastAppliedBaseSnapshotTimestamp)) {\n-                    // Notify end of snapshot sync. This is a blocking call.\n-                    snapshotSyncPlugin.onSnapshotSyncEnd(runtime);\n-                } else {\n-                    log.warn(\"SNAPSHOT_SYNC has completed for {}, but new ongoing SNAPSHOT_SYNC is {}\",\n-                            ack.getMetadata().getSnapshotTimestamp(), lastAppliedBaseSnapshotTimestamp);\n-                }\n+            // If the snapshot sync apply has completed (determined by the end marker) notify\n+            // plugin the completion, so checkpoint/trim process is resumed.\n+            if (ack.getMetadata().getMessageMetadataType() == SNAPSHOT_END) {\n+                processSnapshotSyncApplied(ack);\n             }\n             return ack;\n         }\n     }\n \n+    private void processSnapshotSyncApplied(LogReplicationEntry ack) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI4NTI3NQ==", "bodyText": "default value will be false which can change the behavior.. is it intentional?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2663#discussion_r461285275", "createdAt": "2020-07-28T02:48:19Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/SenderBufferManager.java", "diffHunk": "@@ -53,8 +52,7 @@\n     /*\n      * If there is a timeout for a message, should generate an error or not\n      */\n-    private boolean errorOnMsgTimeout = true;\n-\n+    private boolean errorOnMsgTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8615d79fd8f9a6ff77b49c85f0be5c3ceebec4f"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4331, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}