{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NDY4NzE5", "number": 2492, "title": "Fix Trim Exception on Raw Stream Access", "bodyText": "Overview\nDescription:\nWhen a stream is being consumed directly (remaining/remainingUpTo\nin the StreamViews), the readCpQueue is not being cleared.\nIf on the first access there is a valid CP to load from, the addresses\nbelonging to it will always remain in memory in the readCPQueue.\nIf other entries are found, these will be read along the ones in the readCPQueue (always,\nas they're not cleared), when they're trimmed we will throw a TrimmedException on an old CP.\nWhy should this be merged:  TrimmedExceptions being thrown on direct stream access, provokes application restarts in a cycle.", "createdAt": "2020-03-30T07:49:25Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2492", "merged": true, "mergeCommit": {"oid": "9671712bd181737050b1c9e07ae90c20f1296ec5"}, "closed": true, "closedAt": "2020-04-01T01:32:50Z", "author": {"login": "annym"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSqmeAgFqTM4MzY1MDg0Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTLgC2ABqjMxODU1MjA5OTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNjUwODQz", "url": "https://github.com/CorfuDB/CorfuDB/pull/2492#pullrequestreview-383650843", "createdAt": "2020-03-30T08:52:59Z", "commit": {"oid": "dc5e512c3ffa1e7c5c98ac011c788377f273f3ac"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODo1MzowMFrOF9fvRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODo1MzowMFrOF9fvRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAyNzQ2MA==", "bodyText": "Actually for raw streams, looks like we never load the checkpoints: in line 356 there is a filter .filter(x -> x.containsStream(context.id)), which filters out the entries on checkpoint stream, but we still read it because the filter is applied after the read, which is unnecessary. If that is the case, I think we need a clean up, otherwise it's ineffiecient and the logic is fragile, but maybe be can do later as we are short of time now.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2492#discussion_r400027460", "createdAt": "2020-03-30T08:53:00Z", "author": {"login": "WenbinZhu"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/stream/AbstractQueuedStreamView.java", "diffHunk": "@@ -370,6 +371,7 @@ private void processTrimmedException(TrimmedException te) {\n         } else {\n             // Clear the entries which were read\n             context.readQueue.headSet(maxGlobal, true).clear();\n+            context.readCpQueue.headSet(maxGlobal, true).clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc5e512c3ffa1e7c5c98ac011c788377f273f3ac"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDcwOTA5", "url": "https://github.com/CorfuDB/CorfuDB/pull/2492#pullrequestreview-384070909", "createdAt": "2020-03-30T17:22:33Z", "commit": {"oid": "dc5e512c3ffa1e7c5c98ac011c788377f273f3ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ab4014c94f050a584bfab0750faed3ae5434893", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/0ab4014c94f050a584bfab0750faed3ae5434893", "committedDate": "2020-03-31T23:14:11Z", "message": "Fix Trim Exception on Raw Stream Access\n\nWhen a stream is being consumed directly (remaining/remainingUpTo\nin the StreamViews), the readCpQueue is not being cleared.\n\nIf on the first access there is a valid CP to load from, the addresses\nbelonging to it will always remain in memory in the readCPQueue.\nIf other entries are found, these will be read along the ones in the readCPQueue (always,\nas they're not cleared), when they're trimmed we will throw a TrimmedException on an old CP."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc5e512c3ffa1e7c5c98ac011c788377f273f3ac", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/dc5e512c3ffa1e7c5c98ac011c788377f273f3ac", "committedDate": "2020-03-30T07:40:19Z", "message": "Fix Trim Exception on Raw Stream Access\n\nWhen a stream is being consumed directly (remaining/remainingUpTo\nin the StreamViews), the readCpQueue is not being cleared.\n\nIf on the first access there is a valid CP to load from, the addresses\nbelonging to it will always remain in memory in the readCPQueue.\nIf other entries are found, these will be read along the ones in the readCPQueue (always,\nas they're not cleared), when they're trimmed we will throw a TrimmedException on an old CP."}, "afterCommit": {"oid": "0ab4014c94f050a584bfab0750faed3ae5434893", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/0ab4014c94f050a584bfab0750faed3ae5434893", "committedDate": "2020-03-31T23:14:11Z", "message": "Fix Trim Exception on Raw Stream Access\n\nWhen a stream is being consumed directly (remaining/remainingUpTo\nin the StreamViews), the readCpQueue is not being cleared.\n\nIf on the first access there is a valid CP to load from, the addresses\nbelonging to it will always remain in memory in the readCPQueue.\nIf other entries are found, these will be read along the ones in the readCPQueue (always,\nas they're not cleared), when they're trimmed we will throw a TrimmedException on an old CP."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4435, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}