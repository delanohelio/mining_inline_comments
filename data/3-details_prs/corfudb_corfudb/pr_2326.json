{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MTc5NjMy", "number": 2326, "title": "Explicit close", "bodyText": "Overview\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources.\nWhy should this be merged: Avoids GC-Finalize lag to release\nnative memory.\nRelated issue(s) (if applicable): #\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-01-26T04:00:41Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2326", "merged": true, "mergeCommit": {"oid": "e8f154e9330bf164003147b16c50fd77c6df58a5"}, "closed": true, "closedAt": "2020-02-01T00:20:33Z", "author": {"login": "Maithem"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-ktHvAFqTM0OTAyODExMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_20UvgBqjI5OTg3MTA2MjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDI4MTEx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2326#pullrequestreview-349028111", "createdAt": "2020-01-27T22:44:06Z", "commit": {"oid": "f51439f225d709e2bd1134374603b0b45a0085bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDIwMjg3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2326#pullrequestreview-349020287", "createdAt": "2020-01-27T22:28:13Z", "commit": {"oid": "f51439f225d709e2bd1134374603b0b45a0085bf"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMjoyODoxM1rOFiTr6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMjo0NDo0M1rOFiUFmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxODQ0Mg==", "bodyText": "Do you not need a precheck for checkStatus before invoking api or checkHandle is enough ?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2326#discussion_r371518442", "createdAt": "2020-01-27T22:28:13Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/CheckedRocksIterator.java", "diffHunk": "@@ -0,0 +1,139 @@\n+package org.corfudb.runtime.collections;\n+\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+import org.rocksdb.RocksIteratorInterface;\n+\n+/**\n+ *\n+ * A wrapper class that makes a access to the RocksIterator safe: the rocks library does some checks but they\n+ * are enforced via assert, but assert checking is disabled on many jvms by default, hence the explicit checking.\n+ *\n+ * Created by Maithem on 1/24/20.\n+ */\n+public class CheckedRocksIterator implements RocksIteratorInterface {\n+\n+    private final RocksIterator iterator;\n+    public CheckedRocksIterator(RocksIterator iterator) {\n+        this.iterator = iterator;\n+    }\n+\n+    private void checkHandle() {\n+        if (!iterator.isOwningHandle()) {\n+            throw new IllegalStateException(\"Handle is invalid\");\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean isValid() {\n+        checkHandle();\n+        boolean res =  iterator.isValid();\n+        checkStatus();\n+        return res;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekToFirst() {\n+        checkHandle();\n+        iterator.seekToFirst();\n+        checkStatus();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekToLast() {\n+        throw new UnsupportedOperationException(\"seekToLast\");\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seek(byte[] target) {\n+        throw new UnsupportedOperationException(\"seek\");\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void seekForPrev(byte[] target){\n+        throw new UnsupportedOperationException(\"seekForPrev\");\n+    }\n+\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void next() {\n+       checkHandle();\n+       iterator.next();\n+       checkStatus();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public void prev() {\n+        throw new UnsupportedOperationException(\"prev\");\n+    }\n+\n+    /**\n+     * Returns the key of the current position of the iterator.\n+     */\n+    public byte[] key() {\n+        checkHandle();\n+        byte[] res = iterator.key();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f51439f225d709e2bd1134374603b0b45a0085bf"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUxOTk1Nw==", "bodyText": "Please add note on what it checks on rocksdb", "url": "https://github.com/CorfuDB/CorfuDB/pull/2326#discussion_r371519957", "createdAt": "2020-01-27T22:31:48Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/CheckedRocksIterator.java", "diffHunk": "@@ -0,0 +1,139 @@\n+package org.corfudb.runtime.collections;\n+\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+import org.rocksdb.RocksIteratorInterface;\n+\n+/**\n+ *\n+ * A wrapper class that makes a access to the RocksIterator safe: the rocks library does some checks but they\n+ * are enforced via assert, but assert checking is disabled on many jvms by default, hence the explicit checking.\n+ *\n+ * Created by Maithem on 1/24/20.\n+ */\n+public class CheckedRocksIterator implements RocksIteratorInterface {\n+\n+    private final RocksIterator iterator;\n+    public CheckedRocksIterator(RocksIterator iterator) {\n+        this.iterator = iterator;\n+    }\n+\n+    private void checkHandle() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f51439f225d709e2bd1134374603b0b45a0085bf"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyMDY1OQ==", "bodyText": "nit:This code is repeated in every method.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2326#discussion_r371520659", "createdAt": "2020-01-27T22:33:38Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/CheckedRocksIterator.java", "diffHunk": "@@ -0,0 +1,139 @@\n+package org.corfudb.runtime.collections;\n+\n+import org.corfudb.runtime.exceptions.unrecoverable.UnrecoverableCorfuError;\n+import org.rocksdb.RocksDBException;\n+import org.rocksdb.RocksIterator;\n+import org.rocksdb.RocksIteratorInterface;\n+\n+/**\n+ *\n+ * A wrapper class that makes a access to the RocksIterator safe: the rocks library does some checks but they\n+ * are enforced via assert, but assert checking is disabled on many jvms by default, hence the explicit checking.\n+ *\n+ * Created by Maithem on 1/24/20.\n+ */\n+public class CheckedRocksIterator implements RocksIteratorInterface {\n+\n+    private final RocksIterator iterator;\n+    public CheckedRocksIterator(RocksIterator iterator) {\n+        this.iterator = iterator;\n+    }\n+\n+    private void checkHandle() {\n+        if (!iterator.isOwningHandle()) {\n+            throw new IllegalStateException(\"Handle is invalid\");\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean isValid() {\n+        checkHandle();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f51439f225d709e2bd1134374603b0b45a0085bf"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyNTAxOQ==", "bodyText": "Could you please add comments as to reason why try with resources is necessary here.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2326#discussion_r371525019", "createdAt": "2020-01-27T22:44:43Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/CorfuTable.java", "diffHunk": "@@ -358,19 +358,21 @@ public void insert(@ConflictParameter K key, V value) {\n      */\n     @Accessor\n     public List<V> scanAndFilter(Predicate<? super V> valuePredicate) {\n-        return mainMap.entryStream()\n-                .map(Entry::getValue).filter(valuePredicate)\n-                .collect(Collectors.toCollection(ArrayList::new));\n+        try (Stream<Entry<K, V>> stream = mainMap.entryStream()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f51439f225d709e2bd1134374603b0b45a0085bf"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDU4NTc1", "url": "https://github.com/CorfuDB/CorfuDB/pull/2326#pullrequestreview-349058575", "createdAt": "2020-01-28T00:02:02Z", "commit": {"oid": "f51439f225d709e2bd1134374603b0b45a0085bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f51439f225d709e2bd1134374603b0b45a0085bf", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/f51439f225d709e2bd1134374603b0b45a0085bf", "committedDate": "2020-01-26T03:56:36Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}, "afterCommit": {"oid": "c6740450be92a42a88a50b358442a0e9bacd0262", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c6740450be92a42a88a50b358442a0e9bacd0262", "committedDate": "2020-01-31T03:43:51Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6740450be92a42a88a50b358442a0e9bacd0262", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c6740450be92a42a88a50b358442a0e9bacd0262", "committedDate": "2020-01-31T03:43:51Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}, "afterCommit": {"oid": "d36833eacea200bcec998c676c725b6ff0eef60f", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/d36833eacea200bcec998c676c725b6ff0eef60f", "committedDate": "2020-01-31T03:47:08Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d36833eacea200bcec998c676c725b6ff0eef60f", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/d36833eacea200bcec998c676c725b6ff0eef60f", "committedDate": "2020-01-31T03:47:08Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}, "afterCommit": {"oid": "1f3dece27a5f5998c5f62608585dd955bb36ef2d", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/1f3dece27a5f5998c5f62608585dd955bb36ef2d", "committedDate": "2020-01-31T18:17:57Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f3dece27a5f5998c5f62608585dd955bb36ef2d", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/1f3dece27a5f5998c5f62608585dd955bb36ef2d", "committedDate": "2020-01-31T18:17:57Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}, "afterCommit": {"oid": "826d1800cf64cee2cc964193754433e6d6175992", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/826d1800cf64cee2cc964193754433e6d6175992", "committedDate": "2020-01-31T18:20:41Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "826d1800cf64cee2cc964193754433e6d6175992", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/826d1800cf64cee2cc964193754433e6d6175992", "committedDate": "2020-01-31T18:20:41Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}, "afterCommit": {"oid": "c3026eab4ae8751a53fabe36047ab009c5db1c66", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c3026eab4ae8751a53fabe36047ab009c5db1c66", "committedDate": "2020-01-31T22:17:21Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxODExNjYz", "url": "https://github.com/CorfuDB/CorfuDB/pull/2326#pullrequestreview-351811663", "createdAt": "2020-01-31T22:21:43Z", "commit": {"oid": "c3026eab4ae8751a53fabe36047ab009c5db1c66"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMjoyMTo0M1rOFkZifA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMjoyMTo0M1rOFkZifA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcxMTQ4NA==", "bodyText": "With this change, shall we put this log info before the try-with statement?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2326#discussion_r373711484", "createdAt": "2020-01-31T22:21:43Z", "author": {"login": "WenbinZhu"}, "path": "runtime/src/main/java/org/corfudb/runtime/CheckpointWriter.java", "diffHunk": "@@ -154,11 +148,10 @@ public Token appendCheckpoint(Token snapshotTimestamp) {\n                 .snapshot(snapshotTimestamp)\n                 .build()\n                 .begin();\n-        try (Timer.Context context = MetricsUtils.getConditionalContext(appendCheckpointTimer)) {\n+        try (Stream<Map.Entry> entries = this.map.entryStream()) {\n             // A checkpoint writer will do two accesses one to obtain the object\n             // vlo version and to get a shallow copy of the entry set\n             log.info(\"appendCheckpoint: Started checkpoint for {} at snapshot {}\", streamId, snapshotTimestamp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3026eab4ae8751a53fabe36047ab009c5db1c66"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e822b831810632b685448133fc797bc43fd481b8", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/e822b831810632b685448133fc797bc43fd481b8", "committedDate": "2020-01-31T22:23:56Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3026eab4ae8751a53fabe36047ab009c5db1c66", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c3026eab4ae8751a53fabe36047ab009c5db1c66", "committedDate": "2020-01-31T22:17:21Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}, "afterCommit": {"oid": "e822b831810632b685448133fc797bc43fd481b8", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/e822b831810632b685448133fc797bc43fd481b8", "committedDate": "2020-01-31T22:23:56Z", "message": "Explicitly Close Map Streams\n\nAlthough RocksDB iterators get closed automatically by finalize,\nthey should be closed right after they are no longer needed and\nnot relay on the Java's GC to release those resources."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3429, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}