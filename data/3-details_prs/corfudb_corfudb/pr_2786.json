{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwODc3MzA5", "number": 2786, "title": "Resume Snapshot Sync Apply on Restart", "bodyText": "Overview\nDescription:\nResume Snapshot Sync Apply on node restart or leadership change.\nIf the lead standby node is restarted after a snapshot transfer is completed but while apply is still not completed, there is no current way to resume snapshot apply on leadership change or restart.\nWhy should this be merged: potential bug\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-10-10T00:35:17Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786", "merged": true, "mergeCommit": {"oid": "21f741addd18ead502a4498a848ee879cea98e85"}, "closed": true, "closedAt": "2020-10-16T17:46:02Z", "author": {"login": "annym"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ_vUwAFqTUwNjA0NjkzOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSh1hcAFqTUwODYzMzU3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDQ2OTM5", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#pullrequestreview-506046939", "createdAt": "2020-10-10T00:35:44Z", "commit": {"oid": "cfd943317c739e40a5779c0d79f66ed2348b75d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMDozNTo0NFrOHfbubg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMDozNTo0NFrOHfbubg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcyMjE1OA==", "bodyText": "Writing a test to validate this scenario.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#discussion_r502722158", "createdAt": "2020-10-10T00:35:44Z", "author": {"login": "annym"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -512,6 +519,20 @@ public void shutdown() {\n         this.applyExecutor.shutdownNow();\n     }\n \n+    /**\n+     * Resume Snapshot Sync Apply\n+     *\n+     * In the event of restarts, a Snapshot Sync which had finished transfer can resume the apply stage.\n+     */\n+    public void resumeSnapshotApply() {\n+        // Construct Log Replication Entry message used to complete the Snapshot Sync with info in the metadata manager", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd943317c739e40a5779c0d79f66ed2348b75d4"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDY4MTg2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#pullrequestreview-506068186", "createdAt": "2020-10-10T05:29:40Z", "commit": {"oid": "cfd943317c739e40a5779c0d79f66ed2348b75d4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwNToyOTo0MVrOHfdYNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwNTozMToyN1rOHfdY4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0OTIzOA==", "bodyText": "Is there a race condition here? These two methods are not atomic. Should we use getAndSet()?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#discussion_r502749238", "createdAt": "2020-10-10T05:29:41Z", "author": {"login": "zhangn49"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -422,8 +425,11 @@ private void processSnapshotMessage(LogReplicationEntry entry) {\n         }\n     }\n \n-    private void startSnapshotApplyAsync(LogReplicationEntry entry) {\n-        applyExecutor.submit(() -> startSnapshotApply(entry));\n+    private synchronized void startSnapshotApplyAsync(LogReplicationEntry entry) {\n+        if (!ongoingApply.get()) {\n+            ongoingApply.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd943317c739e40a5779c0d79f66ed2348b75d4"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0OTQwOA==", "bodyText": "Need some log here", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#discussion_r502749408", "createdAt": "2020-10-10T05:31:27Z", "author": {"login": "zhangn49"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -512,6 +519,20 @@ public void shutdown() {\n         this.applyExecutor.shutdownNow();\n     }\n \n+    /**\n+     * Resume Snapshot Sync Apply\n+     *\n+     * In the event of restarts, a Snapshot Sync which had finished transfer can resume the apply stage.\n+     */\n+    public void resumeSnapshotApply() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd943317c739e40a5779c0d79f66ed2348b75d4"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfd943317c739e40a5779c0d79f66ed2348b75d4", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/cfd943317c739e40a5779c0d79f66ed2348b75d4", "committedDate": "2020-10-09T22:06:25Z", "message": "Resume Snapshot Sync Apply on Restart"}, "afterCommit": {"oid": "94d2d7ff241dfffead9655cbe8c3a3af62414a09", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/94d2d7ff241dfffead9655cbe8c3a3af62414a09", "committedDate": "2020-10-13T04:24:35Z", "message": "Resume Snapshot Sync Apply on Restart"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94d2d7ff241dfffead9655cbe8c3a3af62414a09", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/94d2d7ff241dfffead9655cbe8c3a3af62414a09", "committedDate": "2020-10-13T04:24:35Z", "message": "Resume Snapshot Sync Apply on Restart"}, "afterCommit": {"oid": "cb1fe91fd824fcc3c315f726b84d76a0d93c403a", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/cb1fe91fd824fcc3c315f726b84d76a0d93c403a", "committedDate": "2020-10-13T04:47:33Z", "message": "Resume Snapshot Sync Apply on Restart"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb1fe91fd824fcc3c315f726b84d76a0d93c403a", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/cb1fe91fd824fcc3c315f726b84d76a0d93c403a", "committedDate": "2020-10-13T04:47:33Z", "message": "Resume Snapshot Sync Apply on Restart"}, "afterCommit": {"oid": "3334f31b4ad9b2b0dbcfb8f4cd894c8f6f93003d", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/3334f31b4ad9b2b0dbcfb8f4cd894c8f6f93003d", "committedDate": "2020-10-13T09:05:25Z", "message": "Resume Snapshot Sync Apply on Restart"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3334f31b4ad9b2b0dbcfb8f4cd894c8f6f93003d", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/3334f31b4ad9b2b0dbcfb8f4cd894c8f6f93003d", "committedDate": "2020-10-13T09:05:25Z", "message": "Resume Snapshot Sync Apply on Restart"}, "afterCommit": {"oid": "4925495d7080aa8fb283f2dc0c4e35d8d36e0b07", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/4925495d7080aa8fb283f2dc0c4e35d8d36e0b07", "committedDate": "2020-10-13T09:32:53Z", "message": "Resume Snapshot Sync Apply on Restart"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4925495d7080aa8fb283f2dc0c4e35d8d36e0b07", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/4925495d7080aa8fb283f2dc0c4e35d8d36e0b07", "committedDate": "2020-10-13T09:32:53Z", "message": "Resume Snapshot Sync Apply on Restart"}, "afterCommit": {"oid": "b761dfdbb623757633044755f2761d4ca70a3ba7", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b761dfdbb623757633044755f2761d4ca70a3ba7", "committedDate": "2020-10-14T04:40:20Z", "message": "Resume Snapshot Sync Apply on Restart"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c68fe4391a1bc10c931dfdba0e70596cfc5958c0", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c68fe4391a1bc10c931dfdba0e70596cfc5958c0", "committedDate": "2020-10-14T04:45:20Z", "message": "Resume Snapshot Sync Apply on Restart"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b761dfdbb623757633044755f2761d4ca70a3ba7", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b761dfdbb623757633044755f2761d4ca70a3ba7", "committedDate": "2020-10-14T04:40:20Z", "message": "Resume Snapshot Sync Apply on Restart"}, "afterCommit": {"oid": "c68fe4391a1bc10c931dfdba0e70596cfc5958c0", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c68fe4391a1bc10c931dfdba0e70596cfc5958c0", "committedDate": "2020-10-14T04:45:20Z", "message": "Resume Snapshot Sync Apply on Restart"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NTQ4OTk0", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#pullrequestreview-508548994", "createdAt": "2020-10-14T16:57:44Z", "commit": {"oid": "c68fe4391a1bc10c931dfdba0e70596cfc5958c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjMzNTc1", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#pullrequestreview-508633575", "createdAt": "2020-10-14T18:48:46Z", "commit": {"oid": "c68fe4391a1bc10c931dfdba0e70596cfc5958c0"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo0ODo0NlrOHhgiCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxODo0OToyNlrOHhgjfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5ODA1Ng==", "bodyText": "looks like this is being used for UFO, can we rename it accordingly so that it doesnt confuse with the existing cpAndTrim() variant?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#discussion_r504898056", "createdAt": "2020-10-14T18:48:46Z", "author": {"login": "pankti-m"}, "path": "test/src/test/java/org/corfudb/integration/LogReplicationAbstractIT.java", "diffHunk": "@@ -339,6 +457,99 @@ public void checkpointAndTrim(boolean active, List<CorfuTable> tables) {\n         checkpointAndTrimCorfuStore(cpRuntime, trimMark);\n     }\n \n+    public void verifyDataOnStandby(int expectedConsecutiveWrites) {\n+        for(Map.Entry<String, Table<Sample.StringKey, Sample.IntValue, Sample.Metadata>> entry : mapNameToMapStandby.entrySet()) {\n+\n+            log.debug(\"Verify Data on Standby's Table {}\", entry.getKey());\n+\n+            // Wait until data is fully replicated\n+            while (entry.getValue().count() != expectedConsecutiveWrites) {\n+                // Block until expected number of entries is reached\n+            }\n+\n+            log.debug(\"Number updates on Standby Map {} :: {} \", entry.getKey(), expectedConsecutiveWrites);\n+\n+            // Verify data is present in Standby Site\n+            assertThat(entry.getValue().count()).isEqualTo(expectedConsecutiveWrites);\n+\n+            for (int i = 0; i < (expectedConsecutiveWrites); i++) {\n+                assertThat(entry.getValue().get(Sample.StringKey.newBuilder().setKey(String.valueOf(i)).build()).getPayload()).isNotNull();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Checkpoint and Trim Data Logs\n+     *\n+     * @param active true, checkpoint/trim on active cluster\n+     *               false, checkpoint/trim on standby cluster\n+     */\n+    public void checkpointAndTrim(boolean active) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c68fe4391a1bc10c931dfdba0e70596cfc5958c0"}, "originalPosition": 253}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5ODE3MQ==", "bodyText": "private?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#discussion_r504898171", "createdAt": "2020-10-14T18:49:01Z", "author": {"login": "pankti-m"}, "path": "test/src/test/java/org/corfudb/integration/LogReplicationAbstractIT.java", "diffHunk": "@@ -339,6 +457,99 @@ public void checkpointAndTrim(boolean active, List<CorfuTable> tables) {\n         checkpointAndTrimCorfuStore(cpRuntime, trimMark);\n     }\n \n+    public void verifyDataOnStandby(int expectedConsecutiveWrites) {\n+        for(Map.Entry<String, Table<Sample.StringKey, Sample.IntValue, Sample.Metadata>> entry : mapNameToMapStandby.entrySet()) {\n+\n+            log.debug(\"Verify Data on Standby's Table {}\", entry.getKey());\n+\n+            // Wait until data is fully replicated\n+            while (entry.getValue().count() != expectedConsecutiveWrites) {\n+                // Block until expected number of entries is reached\n+            }\n+\n+            log.debug(\"Number updates on Standby Map {} :: {} \", entry.getKey(), expectedConsecutiveWrites);\n+\n+            // Verify data is present in Standby Site\n+            assertThat(entry.getValue().count()).isEqualTo(expectedConsecutiveWrites);\n+\n+            for (int i = 0; i < (expectedConsecutiveWrites); i++) {\n+                assertThat(entry.getValue().get(Sample.StringKey.newBuilder().setKey(String.valueOf(i)).build()).getPayload()).isNotNull();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Checkpoint and Trim Data Logs\n+     *\n+     * @param active true, checkpoint/trim on active cluster\n+     *               false, checkpoint/trim on standby cluster\n+     */\n+    public void checkpointAndTrim(boolean active) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5ODA1Ng=="}, "originalCommit": {"oid": "c68fe4391a1bc10c931dfdba0e70596cfc5958c0"}, "originalPosition": 253}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5ODI3OA==", "bodyText": "private?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#discussion_r504898278", "createdAt": "2020-10-14T18:49:11Z", "author": {"login": "pankti-m"}, "path": "test/src/test/java/org/corfudb/integration/LogReplicationAbstractIT.java", "diffHunk": "@@ -339,6 +457,99 @@ public void checkpointAndTrim(boolean active, List<CorfuTable> tables) {\n         checkpointAndTrimCorfuStore(cpRuntime, trimMark);\n     }\n \n+    public void verifyDataOnStandby(int expectedConsecutiveWrites) {\n+        for(Map.Entry<String, Table<Sample.StringKey, Sample.IntValue, Sample.Metadata>> entry : mapNameToMapStandby.entrySet()) {\n+\n+            log.debug(\"Verify Data on Standby's Table {}\", entry.getKey());\n+\n+            // Wait until data is fully replicated\n+            while (entry.getValue().count() != expectedConsecutiveWrites) {\n+                // Block until expected number of entries is reached\n+            }\n+\n+            log.debug(\"Number updates on Standby Map {} :: {} \", entry.getKey(), expectedConsecutiveWrites);\n+\n+            // Verify data is present in Standby Site\n+            assertThat(entry.getValue().count()).isEqualTo(expectedConsecutiveWrites);\n+\n+            for (int i = 0; i < (expectedConsecutiveWrites); i++) {\n+                assertThat(entry.getValue().get(Sample.StringKey.newBuilder().setKey(String.valueOf(i)).build()).getPayload()).isNotNull();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Checkpoint and Trim Data Logs\n+     *\n+     * @param active true, checkpoint/trim on active cluster\n+     *               false, checkpoint/trim on standby cluster\n+     */\n+    public void checkpointAndTrim(boolean active) {\n+        CorfuRuntime cpRuntime;\n+\n+        if (active) {\n+            cpRuntime = new CorfuRuntime(activeEndpoint).connect();\n+        } else {\n+            cpRuntime = new CorfuRuntime(standbyEndpoint).connect();\n+        }\n+\n+        checkpointAndTrimCorfuStore(cpRuntime);\n+    }\n+\n+    public void checkpointAndTrimCorfuStore(CorfuRuntime cpRuntime) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c68fe4391a1bc10c931dfdba0e70596cfc5958c0"}, "originalPosition": 265}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5ODQyOA==", "bodyText": "private?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2786#discussion_r504898428", "createdAt": "2020-10-14T18:49:26Z", "author": {"login": "pankti-m"}, "path": "test/src/test/java/org/corfudb/integration/LogReplicationAbstractIT.java", "diffHunk": "@@ -390,4 +601,30 @@ public void checkpointAndTrimCorfuStore(CorfuRuntime cpRuntime, Token trimMark)\n         cpRuntime.getAddressSpaceView().invalidateServerCaches();\n         cpRuntime.getAddressSpaceView().gc();\n     }\n+\n+    /**\n+     * Return the first map on active cluster (typical for cases where the number of map is set to 1)\n+     * @return first map on active cluster\n+     */\n+    public Table<Sample.StringKey, Sample.IntValue, Sample.Metadata> getActiveMap() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c68fe4391a1bc10c931dfdba0e70596cfc5958c0"}, "originalPosition": 331}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4087, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}