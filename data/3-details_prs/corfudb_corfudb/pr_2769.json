{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1ODM1MzYx", "number": 2769, "title": "Local datastore read/write performance improvement.", "bodyText": "Overview\n\nRemoved all synchronized keywords.\nCurrent cache writer has to do two buffer copies before the actual\nwrite syscall happens, first time copy to a heap buffer to include\nchecksum, then java FileChannle will copy it again to a direct buffer\nbefore performing writes. This patch instead uses a direct buffer for\nthe first copy to eliminate the second copy.\n\nRelated issue(s) (if applicable): #2133, #2748\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-09-12T09:09:40Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769", "merged": true, "mergeCommit": {"oid": "23305c9b249d535d81502573b2a931f177af38e1"}, "closed": true, "closedAt": "2021-02-23T19:02:14Z", "author": {"login": "WenbinZhu"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdITHspAFqTQ4NzI2MzkzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABd82rVjAH2gAyNDg1ODM1MzYxOmFmZDFiODFmYTAzZDgwZTQ3NjQ5NTZlNjFhZjAwZTYwZjUwNDlhZDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MjYzOTMy", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#pullrequestreview-487263932", "createdAt": "2020-09-13T00:05:13Z", "commit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMDowNToxM1rOHQ4Tfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMDowNToxM1rOHQ4Tfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ2MTc1OQ==", "bodyText": "You can use putBytes(ByteBuffer bytes) directly", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#discussion_r487461759", "createdAt": "2020-09-13T00:05:13Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/datastore/DataStore.java", "diffHunk": "@@ -93,18 +97,15 @@ public DataStore(@Nonnull Map<String, Object> opts,\n         return Caffeine.newBuilder().build(k -> null);\n     }\n \n-\n-    public static int getChecksum(byte[] bytes) {\n+    private static int getChecksum(byte[] bytes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MjY0MDA3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#pullrequestreview-487264007", "createdAt": "2020-09-13T00:07:13Z", "commit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMDowNzoxM1rOHQ4UDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMDowNzoxM1rOHQ4UDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ2MTkwMg==", "bodyText": "String.getBytes will create a new buffer, you can eliminate it by using the String instead.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#discussion_r487461902", "createdAt": "2020-09-13T00:07:13Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/datastore/DataStore.java", "diffHunk": "@@ -129,12 +133,19 @@ public synchronized void write(@Nonnull String key, @Nonnull Object value) {\n                             String jsonPayload = JsonUtils.parser.toJson(value, value.getClass());\n                             byte[] bytes = jsonPayload.getBytes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MjY0MDU5", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#pullrequestreview-487264059", "createdAt": "2020-09-13T00:08:40Z", "commit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMDowODo0MFrOHQ4UZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMDowODo0MFrOHQ4UZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ2MTk5MQ==", "bodyText": "To eliminate the other buffer copy you can just use buffer.writeCharSequence(jsonPayload, Charset.defaultCharset()); , or maybe explicitly set it to UTF-8", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#discussion_r487461991", "createdAt": "2020-09-13T00:08:40Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/datastore/DataStore.java", "diffHunk": "@@ -129,12 +133,19 @@ public synchronized void write(@Nonnull String key, @Nonnull Object value) {\n                             String jsonPayload = JsonUtils.parser.toJson(value, value.getClass());\n                             byte[] bytes = jsonPayload.getBytes();\n \n-                            ByteBuffer buffer = ByteBuffer.allocate(bytes.length\n-                                    + Integer.BYTES);\n-                            buffer.putInt(getChecksum(bytes));\n-                            buffer.put(bytes);\n-                            Files.write(tmpPath, buffer.array(), StandardOpenOption.CREATE,\n+                            buffer = Unpooled.directBuffer(bytes.length + Integer.BYTES);\n+                            buffer.writeInt(getChecksum(bytes));\n+                            buffer.writeBytes(bytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666"}, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MjY0Mjc2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#pullrequestreview-487264276", "createdAt": "2020-09-13T00:13:36Z", "commit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMDoxMzozNlrOHQ4VyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMDoxMzozNlrOHQ4VyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ2MjM0NA==", "bodyText": "This is failing the build.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#discussion_r487462344", "createdAt": "2020-09-13T00:13:36Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/datastore/DataStore.java", "diffHunk": "@@ -143,27 +154,28 @@ public synchronized void write(@Nonnull String key, @Nonnull Object value) {\n                             cleanupTask.accept(dsFileName);\n                         } catch (IOException e) {\n                             throw new RuntimeException(e);\n+                        } finally {\n+                            if (buffer != null) {\n+                                buffer.release();\n+                            }\n+                            IOUtils.closeQuietly(writeChannel);\n                         }\n                     }\n \n                     @Override\n-                    public synchronized void delete(@Nonnull String key,\n-                                                    @Nullable Object value,\n-                                                    @Nonnull RemovalCause cause) {\n-                        try {\n-                            Path path = Paths.get(logDirPath, key);\n-                            Files.deleteIfExists(path);\n-                        } catch (IOException e) {\n-                            throw new RuntimeException(e);\n-                        }\n+                    public void delete(@Nonnull String key,\n+                                       @Nullable Object value,\n+                                       @Nonnull RemovalCause cause) {\n+                        // Delete should not remove the underlying file.\n+                        // Removal of underlying file is done by cleanupTask.\n                     }\n                 })\n-                .maximumSize(dsCacheSize)\n                 .build();\n     }\n \n     private <T> T load(Class<T> tClass, String key) {\n         try {\n+            System.out.println(1111);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666"}, "originalPosition": 148}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MjY0NzAx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#pullrequestreview-487264701", "createdAt": "2020-09-13T00:24:26Z", "commit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMDoyNDoyNlrOHQ4Ytg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMDoyNDoyNlrOHQ4Ytg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ2MzA5NA==", "bodyText": "Calling delete and not doing anything is a little weird. I would rather just delete the method from the interface. It's not used anyways.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#discussion_r487463094", "createdAt": "2020-09-13T00:24:26Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/datastore/DataStore.java", "diffHunk": "@@ -223,7 +233,7 @@ public synchronized void delete(@Nonnull String key,\n     }\n \n     @Override\n-    public synchronized <T> void delete(KvRecord<T> key) {\n+    public <T> void delete(KvRecord<T> key) {\n         cache.invalidate(key.getFullKeyName());\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666"}, "originalPosition": 192}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/6dbe9a92e1f55bcd66dd0bcfbc14fe2e72a4a666", "committedDate": "2020-09-12T09:08:38Z", "message": "Local datastore read/write performance improvement.\n\n- Removed all synchronized keywords.\n- Current cache writer has to do two buffer copies before the actual\nwrite syscall happens, first time copy to a heap buffer to include\nchecksum, then java FileChannle will copy it again to a direct buffer\nbefore performing writes. This patch instead uses a direct buffer for\nthe first copy to eliminate the second copy."}, "afterCommit": {"oid": "c65aa9e029ed52c885b60ff60b570a76ac63a577", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c65aa9e029ed52c885b60ff60b570a76ac63a577", "committedDate": "2020-09-13T07:32:42Z", "message": "Local datastore read/write performance improvement.\n\n- Removed all synchronized keywords.\n- Current cache writer has to do two buffer copies before the actual\nwrite syscall happens, first time copy to a heap buffer to include\nchecksum, then java FileChannle will copy it again to a direct buffer\nbefore performing writes. This patch instead uses a direct buffer for\nthe first copy to eliminate the second copy."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c65aa9e029ed52c885b60ff60b570a76ac63a577", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c65aa9e029ed52c885b60ff60b570a76ac63a577", "committedDate": "2020-09-13T07:32:42Z", "message": "Local datastore read/write performance improvement.\n\n- Removed all synchronized keywords.\n- Current cache writer has to do two buffer copies before the actual\nwrite syscall happens, first time copy to a heap buffer to include\nchecksum, then java FileChannle will copy it again to a direct buffer\nbefore performing writes. This patch instead uses a direct buffer for\nthe first copy to eliminate the second copy."}, "afterCommit": {"oid": "40e92757292d78cc26405b40145ef5c8794424cb", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/40e92757292d78cc26405b40145ef5c8794424cb", "committedDate": "2020-09-13T07:36:15Z", "message": "Local datastore read/write performance improvement.\n\n- Removed all synchronized keywords.\n- Current cache writer has to do two buffer copies before the actual\nwrite syscall happens, first time copy to a heap buffer to include\nchecksum, then java FileChannle will copy it again to a direct buffer\nbefore performing writes. This patch instead uses a direct buffer for\nthe first copy to eliminate the second copy."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzU1NzIy", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#pullrequestreview-487355722", "createdAt": "2020-09-14T00:25:49Z", "commit": {"oid": "40e92757292d78cc26405b40145ef5c8794424cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59d6db6ba515f12980bae69667361a2183d70f1b", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/59d6db6ba515f12980bae69667361a2183d70f1b", "committedDate": "2020-09-15T19:07:43Z", "message": "Local datastore read/write performance improvement.\n\n- Removed all synchronized keywords.\n- Current cache writer has to do two buffer copies before the actual\nwrite syscall happens, first time copy to a heap buffer to include\nchecksum, then java FileChannle will copy it again to a direct buffer\nbefore performing writes. This patch instead uses a direct buffer for\nthe first copy to eliminate the second copy."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b05c37f8e0b1ce71ea2608f0bebb46ca7eb8889a", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b05c37f8e0b1ce71ea2608f0bebb46ca7eb8889a", "committedDate": "2020-09-15T07:58:22Z", "message": "Merge branch 'master' into faster_datastore"}, "afterCommit": {"oid": "59d6db6ba515f12980bae69667361a2183d70f1b", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/59d6db6ba515f12980bae69667361a2183d70f1b", "committedDate": "2020-09-15T19:07:43Z", "message": "Local datastore read/write performance improvement.\n\n- Removed all synchronized keywords.\n- Current cache writer has to do two buffer copies before the actual\nwrite syscall happens, first time copy to a heap buffer to include\nchecksum, then java FileChannle will copy it again to a direct buffer\nbefore performing writes. This patch instead uses a direct buffer for\nthe first copy to eliminate the second copy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "523314eecc62b6d9e901e172f2f7ff3ffad6e39b", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/523314eecc62b6d9e901e172f2f7ff3ffad6e39b", "committedDate": "2020-09-16T08:59:25Z", "message": "Merge branch 'master' into faster_datastore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60e823115d229ecf3582448300237d2b848352da", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/60e823115d229ecf3582448300237d2b848352da", "committedDate": "2020-09-22T07:11:38Z", "message": "Merge branch 'master' into faster_datastore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc13b0e3d991d28e48c2ef38972d3572ee62fb33", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/bc13b0e3d991d28e48c2ef38972d3572ee62fb33", "committedDate": "2020-12-10T22:33:01Z", "message": "Merge branch 'master' into faster_datastore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9d519272e015e0ff6b7209dd2a280e091f6a11a", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b9d519272e015e0ff6b7209dd2a280e091f6a11a", "committedDate": "2021-02-18T09:41:13Z", "message": "Merge branch 'master' into faster_datastore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTkzNjY3MTcw", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#pullrequestreview-593667170", "createdAt": "2021-02-18T21:38:50Z", "commit": {"oid": "b9d519272e015e0ff6b7209dd2a280e091f6a11a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xOFQyMTozODo1MFrOIn84uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xOFQyMTozODo1MFrOIn84uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODc2MjkzNg==", "bodyText": "Replace 4 with Integer.BYTES?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#discussion_r578762936", "createdAt": "2021-02-18T21:38:50Z", "author": {"login": "Lujie1996"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/datastore/DataStore.java", "diffHunk": "@@ -171,14 +185,12 @@ public synchronized void delete(@Nonnull String key,\n             byte[] bytes = Files.readAllBytes(path);\n             ByteBuffer buf = ByteBuffer.wrap(bytes);\n             int checksum = buf.getInt();\n-            byte[] strBytes = Arrays.copyOfRange(bytes, 4, bytes.length);\n-            if (checksum != getChecksum(strBytes)) {\n+            if (checksum != getChecksum(bytes, 4, bytes.length - 4)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9d519272e015e0ff6b7209dd2a280e091f6a11a"}, "originalPosition": 157}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTkzNzYzMjY2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2769#pullrequestreview-593763266", "createdAt": "2021-02-19T00:25:56Z", "commit": {"oid": "b9d519272e015e0ff6b7209dd2a280e091f6a11a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e65569da51dd393c5db5528893d36ff3a27ae6c", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/5e65569da51dd393c5db5528893d36ff3a27ae6c", "committedDate": "2021-02-22T23:03:36Z", "message": "Merge branch 'master' into faster_datastore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cee7aaa54edb15fc5539032e653fe47bbf7411cf", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/cee7aaa54edb15fc5539032e653fe47bbf7411cf", "committedDate": "2021-02-22T23:37:14Z", "message": "Merge branch 'master' into faster_datastore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afd1b81fa03d80e4764956e61af00e60f5049ad5", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/afd1b81fa03d80e4764956e61af00e60f5049ad5", "committedDate": "2021-02-23T06:54:54Z", "message": "Merge branch 'master' into faster_datastore"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4054, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}