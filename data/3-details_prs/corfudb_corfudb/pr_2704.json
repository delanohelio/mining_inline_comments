{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NDk4NzQ5", "number": 2704, "title": "Fix NPE & Shutdown Server for UnrecoverableErrors", "bodyText": "Overview\nDescription:\n\nFix a NPE that we hit on stopLogReplication when an invalid topology is provided onProcessNotificationUpdate.\nShutdown Corfu Log Replication Service whenever Discovery Service is terminated.\nFix some logs to improve current readability/debugging\n\nWhy should this be merged: fix some ongoing bugs in LR\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-08-12T04:24:43Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704", "merged": true, "mergeCommit": {"oid": "473a4e8998cc7127a831235bdef653fd65d9f748"}, "closed": true, "closedAt": "2020-08-12T23:10:08Z", "author": {"login": "annym"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-EIkbAFqTQ2NTU5MTA5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-Eo7tgBqjM2NDYwNTE2MjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTkxMDk1", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#pullrequestreview-465591095", "createdAt": "2020-08-12T04:58:22Z", "commit": {"oid": "291afa64ff6dbb024c89962d05a1959c5600dcb9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNDo1ODoyMlrOG_R0MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNDo1ODoyMlrOG_R0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNTM2MA==", "bodyText": "A little confused, If a new topology is not valid, we don't update the localClusterDescriptor, right? How we hit this NPE?\nIf the localClusterDescriptor is always null, how does the log replication start?... It should hit NPE here.\n\n  \n    \n      CorfuDB/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java\n    \n    \n         Line 414\n      in\n      8fc1b8b\n    \n    \n    \n    \n\n        \n          \n           switch (localClusterDescriptor.getRole()) {", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#discussion_r469005360", "createdAt": "2020-08-12T04:58:22Z", "author": {"login": "zhangn49"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -463,7 +465,7 @@ private void fetchTopologyFromClusterManager() {\n      * Stop Log Replication\n      */\n     private void stopLogReplication() {\n-        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE && isLeader.get()) {\n+        if (localClusterDescriptor != null && localClusterDescriptor.getRole() == ClusterRole.ACTIVE && isLeader.get()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "291afa64ff6dbb024c89962d05a1959c5600dcb9"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTkzMDcz", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#pullrequestreview-465593073", "createdAt": "2020-08-12T05:04:53Z", "commit": {"oid": "291afa64ff6dbb024c89962d05a1959c5600dcb9"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNTowNDo1M1rOG_R6gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNTowODoyOFrOG_R9-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNjk3OA==", "bodyText": "dint we want to make this trace?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#discussion_r469006978", "createdAt": "2020-08-12T05:04:53Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/LogReplicationServer.java", "diffHunk": "@@ -123,9 +123,10 @@ private void handleLogReplicationNegotiationRequest(CorfuMsg msg, ChannelHandler\n \n     @ServerHandler(type = CorfuMsgType.LOG_REPLICATION_QUERY_LEADERSHIP)\n     private void handleLogReplicationQueryLeadership(CorfuMsg msg, ChannelHandlerContext ctx, IServerRouter r) {\n-        log.info(\"Log Replication Query Leadership Request received by Server.\");\n+        log.debug(\"Log Replication Query Leadership Request received by Server.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "291afa64ff6dbb024c89962d05a1959c5600dcb9"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNzg2NQ==", "bodyText": "is it a good idea to add a todo for revisiting these exceptions handling which we discussed today?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#discussion_r469007865", "createdAt": "2020-08-12T05:08:28Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -188,11 +188,13 @@ public void run() {\n                 }\n             }\n         } catch (Exception e) {\n-            log.error(\"Unhandled exception caught during log replication service discovery. Retry,\", e);\n+            log.error(\"Unhandled exception caught during log replication service discovery.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "291afa64ff6dbb024c89962d05a1959c5600dcb9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTk4NDU4", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#pullrequestreview-465598458", "createdAt": "2020-08-12T05:22:14Z", "commit": {"oid": "291afa64ff6dbb024c89962d05a1959c5600dcb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5797463b3ef310a976ebeee6706957aeb07113e5", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/5797463b3ef310a976ebeee6706957aeb07113e5", "committedDate": "2020-08-12T05:32:37Z", "message": "Fix NPE & Shutdown Server for UnrecoverableErrors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "291afa64ff6dbb024c89962d05a1959c5600dcb9", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/291afa64ff6dbb024c89962d05a1959c5600dcb9", "committedDate": "2020-08-12T04:20:36Z", "message": "Fix NPE & Shutdown Server for UnrecoverableErrors"}, "afterCommit": {"oid": "5797463b3ef310a976ebeee6706957aeb07113e5", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/5797463b3ef310a976ebeee6706957aeb07113e5", "committedDate": "2020-08-12T05:32:37Z", "message": "Fix NPE & Shutdown Server for UnrecoverableErrors"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4404, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}