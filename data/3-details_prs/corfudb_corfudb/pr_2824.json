{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NDg5NTkw", "number": 2824, "title": "CorfuStore: Allow re-entrant Transactions, full Queue over protobuf API support", "bodyText": "Overview\nDescription:\nWhy should this be merged:\nWithout re-entrant transaction support, all callers have to rewrite very large sections of their layers to pass around the TxnContext. Also in many cases the CorfuStore Transaction needs to work within code that already has a transaction management.\nCorfuQueue will be deprecated and its functionality is to be accessed from the CorfuStore layer directly.\nRelated issue(s) (if applicable): #\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-11-11T22:36:59Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824", "merged": true, "mergeCommit": {"oid": "187ab92112895ba173496d6c4679865a861f05f4"}, "closed": true, "closedAt": "2020-11-25T18:17:47Z", "author": {"login": "hisundar"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcTvK5ABqjM5OTYwNDgxNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf48nngBqjQwMzY1NTc3MTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a67bcec30691ad053508e5f655534626e30ff047", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/a67bcec30691ad053508e5f655534626e30ff047", "committedDate": "2020-11-11T22:36:29Z", "message": "TxnContext: Allow nesting & interleaving of different Transaction types"}, "afterCommit": {"oid": "d116dac822e882ba3c783f28f77c84041ac94533", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/d116dac822e882ba3c783f28f77c84041ac94533", "committedDate": "2020-11-14T04:06:03Z", "message": "TxnContext: Allow nested transactions\n\n+Test case to demonstrate read-committed for the nested level."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTUzNjU5", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#pullrequestreview-530553659", "createdAt": "2020-11-14T04:31:42Z", "commit": {"oid": "d116dac822e882ba3c783f28f77c84041ac94533"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwNDozMTo0MlrOHzIPmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwNDozMTo0MlrOHzIPmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM3NDQ4OQ==", "bodyText": "Nit: Can we indent the comment with the parameter?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r523374489", "createdAt": "2020-11-14T04:31:42Z", "author": {"login": "chetangudisagar"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreShimTest.java", "diffHunk": "@@ -494,4 +505,57 @@ public void onCommit(Map<String, List<CorfuStreamEntry>> mutations) {\n         }\n         log.debug(table.getMetrics().toString());\n     }\n+\n+    /**\n+     * Validate that nested transactions do not throw exception if txnWithNesting is used.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void checkNestedTransaction() throws Exception {\n+// Get a Corfu Runtime instance.\n+        CorfuRuntime corfuRuntime = getTestRuntime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d116dac822e882ba3c783f28f77c84041ac94533"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d116dac822e882ba3c783f28f77c84041ac94533", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/d116dac822e882ba3c783f28f77c84041ac94533", "committedDate": "2020-11-14T04:06:03Z", "message": "TxnContext: Allow nested transactions\n\n+Test case to demonstrate read-committed for the nested level."}, "afterCommit": {"oid": "c91ad9ce62ddb27096321fed7d406b938e3c8fd2", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c91ad9ce62ddb27096321fed7d406b938e3c8fd2", "committedDate": "2020-11-18T17:12:02Z", "message": "TxnContext: Allow nested transactions\n\nRemove inheritance to support auto-closeable\n+Test case to demonstrate read-committed for the nested level."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c91ad9ce62ddb27096321fed7d406b938e3c8fd2", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c91ad9ce62ddb27096321fed7d406b938e3c8fd2", "committedDate": "2020-11-18T17:12:02Z", "message": "TxnContext: Allow nested transactions\n\nRemove inheritance to support auto-closeable\n+Test case to demonstrate read-committed for the nested level."}, "afterCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/11f90666372c988fccbcd572f5a5b357a424b7ea", "committedDate": "2020-11-18T17:13:40Z", "message": "TxnContext: Allow nested transactions\n\nRemove inheritance to support auto-closeable\n+Test case to demonstrate read-committed for the nested level."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNzgyMjMy", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#pullrequestreview-533782232", "createdAt": "2020-11-18T19:02:05Z", "commit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "state": "APPROVED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTowMjowNlrOH19oyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMTowNjoyNFrOH2CJYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0NjQ0MA==", "bodyText": "comments need to be updated.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526346440", "createdAt": "2020-11-18T19:02:06Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/CorfuStore.java", "diffHunk": "@@ -206,7 +205,8 @@ public TxnContext txn(@Nonnull final String namespace, IsolationLevel isolationL\n                 this.runtime.getObjectsView(),\n                 this.runtime.getTableRegistry(),\n                 namespace,\n-                isolationLevel);\n+                isolationLevel,\n+                false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0NzU3MQ==", "bodyText": "need to add comments as to what it means.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526347571", "createdAt": "2020-11-18T19:04:03Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -64,14 +65,15 @@\n     public TxnContext(@Nonnull final ObjectsView objectsView,\n                       @Nonnull final TableRegistry tableRegistry,\n                       @Nonnull final String namespace,\n-                      @Nonnull final IsolationLevel isolationLevel) {\n+                      @Nonnull final IsolationLevel isolationLevel,\n+                      @Nonnull boolean allowNestedTransactions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NDIwNQ==", "bodyText": "getTxnContext or getThreadLocalTxnContext", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526364205", "createdAt": "2020-11-18T19:31:19Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -607,6 +633,24 @@ boolean isExists(@Nonnull String tableName, @Nonnull final K key) {\n         return table.scanAndFilterByEntry(record -> true);\n     }\n \n+    /**\n+     * @return The the thread local's TxnContext, null if not in a transaction.\n+     */\n+    public static TxnContext getMyTxnContext() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 184}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NTkxOA==", "bodyText": "can there be a failure before this is called ? in the run methods ?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526365918", "createdAt": "2020-11-18T19:34:10Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -652,10 +710,16 @@ private void txBeginInternal() {\n      * @return - address at which the commit of this transaction occurred.\n      */\n     public long commit() {\n-        if (!TransactionalContext.isInTransaction()) {\n+        if (!isInMyTransaction()) {\n             throw new IllegalStateException(\"commit() called without a transaction!\");\n         }\n+\n+        // Apply any buffered up operations.\n         operations.forEach(Runnable::run);\n+\n+        // Regardless of transaction outcome remove any TxnContext association from ThreadLocal.\n+        TransactionalContext.getRootContext().setTxnContext(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 253}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NzI0Mg==", "bodyText": "Is this correct ?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526367242", "createdAt": "2020-11-18T19:36:08Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -623,13 +667,26 @@ void applyWritesForReadOnTable(Table<K, V, M> tableBeingRead) {\n     }\n \n     /**\n+     * @param allowNestedTransactions - is it ok to re-use thread's corfu transaction?\n      * Start the actual corfu transaction. Ensure there isn't one already in the same thread.\n+     *\n      */\n-    private void txBeginInternal() {\n+    private void txBeginInternal(boolean allowNestedTransactions) {\n         if (TransactionalContext.isInTransaction()) {\n-            log.error(\"Cannot start new transaction in this thread without ending previous one\");\n-            throw new TransactionAlreadyStartedException(TransactionalContext.getRootContext().toString());\n+            TxnContext txnContext = TransactionalContext.getRootContext().getTxnContext();\n+            if (!allowNestedTransactions) {\n+                log.error(\"Current thread already has a transaction started and nested transactions are disabled!\");\n+                throw new TransactionAlreadyStartedException(TransactionalContext.getRootContext().toString());\n+            }\n+            if (txnContext != null) {\n+                log.error(\"Cannot start new transaction in this thread without ending previous one\");\n+                throw new TransactionAlreadyStartedException(TransactionalContext.getRootContext().toString());\n+            }\n+            this.txnStartTime = System.nanoTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 224}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3MDYxNA==", "bodyText": "Isn't this a little ambiguous ? put(key, null) = delete(key)", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526370614", "createdAt": "2020-11-18T19:41:33Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -164,21 +184,27 @@ void putRecord(@Nonnull Table<K, V, M> table,\n      */\n     public <K extends Message, V extends Message, M extends Message>\n     void merge(@Nonnull Table<K, V, M> table,\n-                     @Nonnull final K key,\n-                     @Nonnull MergeCallback mergeCallback,\n-                     @Nonnull final CorfuRecord<V,M> recordDelta) {\n-        validateTableWrittenIsInNamespace(table);\n+               @Nonnull final K key,\n+               @Nonnull MergeCallback mergeCallback,\n+               @Nonnull final CorfuRecord<V,M> recordDelta) {\n+        validateWrite(table, key);\n         operations.add(() -> {\n-            CorfuRecord<V,M> oldRecord = table.get(key);\n+            CorfuRecord<V, M> oldRecord = table.get(key);\n             CorfuRecord<V, M> mergedRecord;\n             try {\n-                mergedRecord = mergeCallback.doMerge(table, oldRecord, recordDelta);\n+                mergedRecord = mergeCallback.doMerge(table, key, oldRecord, recordDelta);\n             } catch (Exception ex) {\n                 txAbort(); // explicitly abort this transaction and then throw the abort manually\n                 log.error(\"TX Abort merge: {}\", table.getFullyQualifiedTableName(), ex);\n                 throw ex;\n             }\n-            table.put(key, mergedRecord.getPayload(), mergedRecord.getMetadata());\n+            if (mergedRecord == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxODM5Ng==", "bodyText": "The Shim prefix for the name is not that great. Can we change it to a better name.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526418396", "createdAt": "2020-11-18T21:02:48Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContextShim.java", "diffHunk": "@@ -7,46 +7,59 @@\n import org.corfudb.runtime.exceptions.StaleRevisionUpdateException;\n import org.corfudb.runtime.object.transactions.AbstractTransactionalContext;\n import org.corfudb.runtime.object.transactions.TransactionalContext;\n-import org.corfudb.runtime.view.ObjectsView;\n-import org.corfudb.runtime.view.TableRegistry;\n+import org.corfudb.runtime.view.Address;\n \n import javax.annotation.Nonnull;\n import javax.annotation.Nullable;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.UUID;\n+import java.util.function.BiFunction;\n+import java.util.function.BiPredicate;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n import java.util.stream.Collectors;\n \n /**\n- * Thin shim layer around CorfuStore's TxnContext for providing metadata management\n- * capabilities.\n+ * Shim layer around CorfuStore's TxnContext for providing metadata management\n+ * capabilities, nested transaction support and more!\n  *\n  * Created by hisundar on 2020-09-16\n  */\n @Slf4j\n-public class TxnContextShim extends TxnContext implements AutoCloseable {\n+public class TxnContextShim implements AutoCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMDMyMA==", "bodyText": "nit:since you use short circuit operator || the faster check could be first.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526420320", "createdAt": "2020-11-18T21:06:24Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContextShim.java", "diffHunk": "@@ -230,6 +608,92 @@ void putRecord(@Nonnull Table<K, V, M> table,\n         }\n     }\n \n+    /**\n+     * Delete the record given the table object and metadata for validation.\n+     *\n+     * @param table Table object to perform the create/update on.\n+     * @param key   Key of the record to be deleted.\n+     * @param metadata Metadata to validate against.\n+     * @param <K>   Type of Key.\n+     * @param <V>   Type of Value.\n+     * @param <M>   Type of Metadata.\n+     */\n+    public <K extends Message, V extends Message, M extends Message>\n+    void deleteRecord(@Nonnull Table<K, V, M> table,\n+                      @Nonnull final K key,\n+                      @Nullable final M metadata) {\n+        if (metadata == null) {\n+            this.txnContext.delete(table, key);\n+            return;\n+        }\n+        MergeCallbackForDeleteImpl mergeCallbackForDelete = new MergeCallbackForDeleteImpl();\n+        this.txnContext.merge(table, key, mergeCallbackForDelete, new CorfuRecord<>(null, metadata));\n+    }\n+\n+    /**\n+     *\n+     * Delete a record given just tableName and the metadata for validation against.\n+     *\n+     * @param tableName - full string representation of the table\n+     * @param key - the key of the record being inserted\n+     * @param metadata - the metadata which will be validated\n+     * @param <K> - type of the key or identifier.\n+     * @param <V> - type of the value or payload\n+     * @param <M> - type of the metadata\n+     */\n+    public <K extends Message, V extends Message, M extends Message>\n+    void deleteRecord(@Nonnull String tableName,\n+                      @Nonnull final K key,\n+                      @Nullable final M metadata) {\n+        deleteRecord(this.getTable(tableName), key, metadata);\n+    }\n+\n+    static class MergeCallbackForDeleteImpl implements TxnContext.MergeCallback {\n+        /**\n+         * Core logic for handling metadata modifications on delete with metadata.\n+         *\n+         * @param table       - The table object on which the merge is being done.\n+         * @param key         - Key of the record on which merge is being done.\n+         * @param oldRecord   - The previous fetched record that exists in the table.\n+         * @param deltaUpdate - Record with only the metadata passed in for validation.\n+         * @param <K>         - type of the key\n+         * @param <V>         - type of the value or payload\n+         * @param <M>         - type of the metadata\n+         * @return null if validation was successful or StaleRevision exception if not.\n+         */\n+        @Override\n+        public <K extends Message, V extends Message, M extends Message>\n+        CorfuRecord<V, M> doMerge(Table<K, V, M> table,\n+                                  K key,\n+                                  CorfuRecord<V, M> oldRecord,\n+                                  CorfuRecord<V, M> deltaUpdate) {\n+            M deltaMetadata = deltaUpdate.getMetadata();\n+            if (deltaUpdate.getPayload() != null) {\n+                throw new IllegalArgumentException(\"Non-null payload sent for delete validation\");\n+            }\n+\n+            final Message.Builder builder = deltaMetadata.toBuilder();\n+            for (Descriptors.FieldDescriptor fieldDescriptor : deltaMetadata.getDescriptorForType().getFields()) {\n+                if (\"revision\".equals(fieldDescriptor.getName())) {\n+                    if (oldRecord == null || oldRecord.getMetadata() == null) {\n+                        return null;\n+                    } else {\n+                        Long prevRevision = (Long) oldRecord.getMetadata().getField(fieldDescriptor);\n+                        Long givenRevision = (Long) deltaMetadata.getField(fieldDescriptor);\n+                        if ((givenRevision > 0 && // Validate revision only if set\n+                                prevRevision.longValue() == givenRevision.longValue())\n+                                || givenRevision == 0) { // Do not validate revision if field isn't set", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 612}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/11f90666372c988fccbcd572f5a5b357a424b7ea", "committedDate": "2020-11-18T17:13:40Z", "message": "TxnContext: Allow nested transactions\n\nRemove inheritance to support auto-closeable\n+Test case to demonstrate read-committed for the nested level."}, "afterCommit": {"oid": "0a086a0bd9cf0e4fd48232a61cf7c7aa4f61a715", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/0a086a0bd9cf0e4fd48232a61cf7c7aa4f61a715", "committedDate": "2020-11-19T17:05:37Z", "message": "TxnContext: Allow nested transactions\n\nRemove inheritance to support auto-closeable\n+Test case to demonstrate the 2 types of nesting."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a086a0bd9cf0e4fd48232a61cf7c7aa4f61a715", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/0a086a0bd9cf0e4fd48232a61cf7c7aa4f61a715", "committedDate": "2020-11-19T17:05:37Z", "message": "TxnContext: Allow nested transactions\n\nRemove inheritance to support auto-closeable\n+Test case to demonstrate the 2 types of nesting."}, "afterCommit": {"oid": "21f58d2628dbf47a4d6a52e4edcbfec90452c22b", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/21f58d2628dbf47a4d6a52e4edcbfec90452c22b", "committedDate": "2020-11-19T19:07:47Z", "message": "TxnContext: Allow nested transactions\n\nRemove inheritance to support auto-closeable\nAllow commitCallbacks in nested transactions.\n+Test case to demonstrate the 2 types of nesting."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0ODIzMDc0", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#pullrequestreview-534823074", "createdAt": "2020-11-19T20:28:12Z", "commit": {"oid": "51b570849d9a3f235077ee8fb9965caf992ba873"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDoyODoxMlrOH2wVbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDoyODoxMlrOH2wVbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3NzA2OQ==", "bodyText": "Probably should be validateNameSpace and not write. Kind of confusing when invoked for deletes. Also, for writes the Key can never be null, so its not even optional for a map.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r527177069", "createdAt": "2020-11-19T20:28:12Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -86,13 +87,15 @@ public TxnContext(@Nonnull final ObjectsView objectsView,\n     /**\n      * All write api must be validate to ensure that the table belongs to the namespace.\n      *\n-     * @param table - table being written to\n-     * @param <K> -type of the key\n-     * @param <V> - type of the payload/value\n-     * @param <M> - type of the metadata\n+     * @param table         - table being written to\n+     * @param key           - key used in the transaction to check for null.\n+     * @param validateKey   - should key be validated for null.\n+     * @param <K>           - type of the key\n+     * @param <V>           - type of the payload/value\n+     * @param <M>           - type of the metadata\n      */\n     private <K extends Message, V extends Message, M extends Message>\n-    void validateTableWrittenIsInNamespace(@Nonnull Table<K, V, M> table) {\n+    void validateWrite(@Nonnull Table<K, V, M> table, K key, boolean validateKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b570849d9a3f235077ee8fb9965caf992ba873"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0ODI1NzA2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#pullrequestreview-534825706", "createdAt": "2020-11-19T20:31:00Z", "commit": {"oid": "51b570849d9a3f235077ee8fb9965caf992ba873"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDozMTowMVrOH2wbow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDozMTowMVrOH2wbow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3ODY1OQ==", "bodyText": "Seems a little weird to manipulate the bitmask in a validate method.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r527178659", "createdAt": "2020-11-19T20:31:01Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -102,10 +105,24 @@ void validateTableWrittenIsInNamespace(@Nonnull Table<K, V, M> table) {\n                     \"TxnContext cannot be used after a transaction has ended on \"+\n                     table.getFullyQualifiedTableName());\n         }\n+        if (validateKey && key == null) {\n+            throw new IllegalArgumentException(\"Key cannot be null on \"\n+                    + table.getFullyQualifiedTableName() + \" in transaction on namespace \" + namespace);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b570849d9a3f235077ee8fb9965caf992ba873"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0ODU2MzQ1", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#pullrequestreview-534856345", "createdAt": "2020-11-19T21:13:57Z", "commit": {"oid": "21f58d2628dbf47a4d6a52e4edcbfec90452c22b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21f58d2628dbf47a4d6a52e4edcbfec90452c22b", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/21f58d2628dbf47a4d6a52e4edcbfec90452c22b", "committedDate": "2020-11-19T19:07:47Z", "message": "TxnContext: Allow nested transactions\n\nRemove inheritance to support auto-closeable\nAllow commitCallbacks in nested transactions.\n+Test case to demonstrate the 2 types of nesting."}, "afterCommit": {"oid": "19efe2356c8fad629cb90f4afe113dd252ce4ed7", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/19efe2356c8fad629cb90f4afe113dd252ce4ed7", "committedDate": "2020-11-20T05:15:54Z", "message": "TxnContext: Allow nested transactions\n\nRemove inheritance to support auto-closeable\nAllow commitCallbacks in nested transactions.\n+Test case to demonstrate the 2 types of nesting."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e88074802756b6e3267925359f77257ea10f2f66", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/e88074802756b6e3267925359f77257ea10f2f66", "committedDate": "2020-11-20T07:28:18Z", "message": "Debug start of transactions with explicit debug message"}, "afterCommit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/9a91e5774a928d2154862cf5203b346a870aee2e", "committedDate": "2020-11-21T00:28:33Z", "message": "Debug start of transactions with explicit debug message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MDM5NzQ3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#pullrequestreview-537039747", "createdAt": "2020-11-24T02:55:59Z", "commit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjo1NTo1OVrOH4p3uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMzozMTowM1rOH4qhxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE2ODMxMg==", "bodyText": "how about rootContext.setTxnContext(null)?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r529168312", "createdAt": "2020-11-24T02:55:59Z", "author": {"login": "Lujie1996"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -649,21 +745,35 @@ private void txBeginInternal() {\n      * Otherwise this throws a TransactionAbortedException with a cause.\n      * The cause and the caller's intent of the transaction can determine if this aborted\n      * Transaction can be retried.\n+     * If there are any post-commit callbacks registered, they will be invoked.\n      * @return - address at which the commit of this transaction occurred.\n      */\n     public long commit() {\n-        if (!TransactionalContext.isInTransaction()) {\n+        if (!isInMyTransaction()) {\n             throw new IllegalStateException(\"commit() called without a transaction!\");\n         }\n+\n+        // Apply any buffered up operations.\n         operations.forEach(Runnable::run);\n-        long commitAddress;\n-        try {\n-            commitAddress = this.objectsView.TXEnd();\n-        } catch (Exception ex) {\n-            tablesInTxn.values().forEach(t -> t.getMetrics().incNumTxnAborts());\n-            tablesInTxn.clear();\n-            throw ex;\n+\n+        // CorfuStore should have only one transactional context since nesting is prohibited.\n+        AbstractTransactionalContext rootContext = TransactionalContext.getRootContext();\n+        // Regardless of transaction outcome remove any TxnContext association from ThreadLocal.\n+        TransactionalContext.getRootContext().setTxnContext(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e"}, "originalPosition": 353}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE3OTA3OQ==", "bodyText": "Where is this commitCallback used?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r529179079", "createdAt": "2020-11-24T03:31:03Z", "author": {"login": "Lujie1996"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreShimTest.java", "diffHunk": "@@ -473,25 +482,125 @@ public void onCommit(Map<String, List<CorfuStreamEntry>> mutations) {\n             }\n         }\n \n-        try (TxnContextShim txn = shimStore.txn(someNamespace)) {\n-            txn.delete(tableName, key);\n-            txn.commit((mutations) -> {\n-                 mutations.values().forEach(mutation -> {\n-                     CorfuStreamEntry.OperationType op = mutation.get(0).getOperation();\n-                     assertThat(op).isEqualTo(CorfuStreamEntry.OperationType.DELETE);\n-                 });\n+        CommitCallbackImpl commitCallback = new CommitCallbackImpl();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e"}, "originalPosition": 221}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3OTQ0Njcy", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#pullrequestreview-537944672", "createdAt": "2020-11-24T21:19:09Z", "commit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/9a91e5774a928d2154862cf5203b346a870aee2e", "committedDate": "2020-11-21T00:28:33Z", "message": "Debug start of transactions with explicit debug message"}, "afterCommit": {"oid": "5be2242d5282d2d7f66c04c28a61a45c8f8d2f8a", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/5be2242d5282d2d7f66c04c28a61a45c8f8d2f8a", "committedDate": "2020-11-24T22:22:55Z", "message": "TxnContext: Allow re-entrant transactions\n\nRemove inheritance to support auto-closeable\nAllow commitCallbacks in nested transactions.\n+Test case to demonstrate the 2 types of nesting."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f35550f3009e521c217288ca3c96362cea026f3b", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/f35550f3009e521c217288ca3c96362cea026f3b", "committedDate": "2020-11-24T22:24:20Z", "message": "CorfuStore: Full Queue API support\n\nImplements the CorfuQueue over protobufs.\n+ Concurrent & Example tests to demonstrate\ncorrectness and usage."}, "afterCommit": {"oid": "3c5bfbbb2833355a9795e5a1358b83fff93137cc", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/3c5bfbbb2833355a9795e5a1358b83fff93137cc", "committedDate": "2020-11-24T22:36:25Z", "message": "CorfuStore: Full Queue API support\n\nImplements the CorfuQueue over protobufs.\n+ Concurrent & Example tests to demonstrate\ncorrectness and usage."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bebd40650bda47bb21190ed80a3597886c4263a", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/9bebd40650bda47bb21190ed80a3597886c4263a", "committedDate": "2020-11-25T07:09:21Z", "message": "CorfuStore: Validate metadata on deletes, key!=null\n\n+test case to validate for code coverage."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be229d56f76e54dacfe2c5dcbfb4d77a8dd612ce", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/be229d56f76e54dacfe2c5dcbfb4d77a8dd612ce", "committedDate": "2020-11-25T07:09:21Z", "message": "TxnContext: Allow re-entrant transactions\n\nRemove inheritance to support auto-closeable\nAllow commitCallbacks in nested transactions.\n+Test case to demonstrate the 2 types of nesting."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9b4e9f6e7fa4f299f46dd8baedbb4e928c4459d", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/d9b4e9f6e7fa4f299f46dd8baedbb4e928c4459d", "committedDate": "2020-11-25T07:09:21Z", "message": "CorfuGuidGenerator: Use CorfuStore for internal txns\n\nA prerequisite for supporting Queue api over CorfuStore\nis to have the internal guid generator move to a protobuf\nbased CorfuStore so that its checkpointing can be take care of."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80b332f147cfb9fe3992a4c7cbfab515556be6f8", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/80b332f147cfb9fe3992a4c7cbfab515556be6f8", "committedDate": "2020-11-25T07:09:22Z", "message": "CorfuStore: Full Queue API support\n\nImplements the CorfuQueue over protobufs.\n+ Concurrent & Example tests to demonstrate\ncorrectness and usage."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c5bfbbb2833355a9795e5a1358b83fff93137cc", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/3c5bfbbb2833355a9795e5a1358b83fff93137cc", "committedDate": "2020-11-24T22:36:25Z", "message": "CorfuStore: Full Queue API support\n\nImplements the CorfuQueue over protobufs.\n+ Concurrent & Example tests to demonstrate\ncorrectness and usage."}, "afterCommit": {"oid": "80b332f147cfb9fe3992a4c7cbfab515556be6f8", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/80b332f147cfb9fe3992a4c7cbfab515556be6f8", "committedDate": "2020-11-25T07:09:22Z", "message": "CorfuStore: Full Queue API support\n\nImplements the CorfuQueue over protobufs.\n+ Concurrent & Example tests to demonstrate\ncorrectness and usage."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4145, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}