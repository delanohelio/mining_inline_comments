{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MTExNDI0", "number": 2480, "title": "Fix LogData lastKnownSize which is inaccurate and inconsistent.", "bodyText": "Overview\n\n\nWhen set during serialization and deserialization, the LogData\nlastKnownSize is set to different values. It is also inaccurate\nas it is set to ByteBuf's internal array length during serialization,\nwhich is usually larger the actually (it is dynamically resized and\nusually 2x of previous size). It needs to be set to the payload's\nserialized size. This incorrect behavior affects transaction size\nlimit calculation, which results in unnecessary WriteSizeException.\n\n\nAlso fixed a test where compression should be ruled out.\n\n\nRelated issue(s) (if applicable): #2235\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-03-14T02:09:30Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2480", "merged": true, "mergeCommit": {"oid": "51c4cbbc9c66e3139305654a03724686efd4ecfd"}, "closed": true, "closedAt": "2020-03-30T23:14:52Z", "author": {"login": "WenbinZhu"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNbQIKgBqjMxMjg4NDE1NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS0zspgH2gAyMzg4MTExNDI0OmM5ODE2MTE3NzgzYzk0MTdhNDg1NzEzN2JkYThkNzQ4OTQyYWY5MjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bbf20bb5b4d31fd33f52bf4e8e8099650b2a38e6", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/bbf20bb5b4d31fd33f52bf4e8e8099650b2a38e6", "committedDate": "2020-03-14T02:03:19Z", "message": "Fix LogData lastKnownSize which is inaccurate and inconsistent.\n\nWhen set during serialization and deserialization, the LogData\nlastKnownSize is set to different values. It is also inaccurate\nas it is set to ByteBuf's internal array length during serialization,\nwhich is usually larger the actually (it is dynamically resized and\nusually 2x of previous size). It needs to be set to the payload's\nserialized size."}, "afterCommit": {"oid": "592d91925f3b7667e7d3cc5fa90560dbc84403f1", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/592d91925f3b7667e7d3cc5fa90560dbc84403f1", "committedDate": "2020-03-14T02:11:57Z", "message": "Fix LogData lastKnownSize which is inaccurate and inconsistent.\n\nWhen set during serialization and deserialization, the LogData\nlastKnownSize is set to different values. It is also inaccurate\nas it is set to ByteBuf's internal array length during serialization,\nwhich is usually larger the actually (it is dynamically resized and\nusually 2x of previous size). It needs to be set to the payload's\nserialized size."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "942961936f219b6e12c55d3a546e10cdd5c4b1ca", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/942961936f219b6e12c55d3a546e10cdd5c4b1ca", "committedDate": "2020-03-14T02:15:03Z", "message": "Fix LogData lastKnownSize which is inaccurate and inconsistent.\n\n- When set during serialization and deserialization, the LogData\nlastKnownSize is set to different values. It is also inaccurate\nas it is set to ByteBuf's internal array length during serialization,\nwhich is usually larger the actually (it is dynamically resized and\nusually 2x of previous size). It needs to be set to the payload's\nserialized size. This incorrect behavior affects transaction size\nlimit calculation, which results in unnecessary WriteSizeException.\n\n- Also fixed a test where compression should be ruled out."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "592d91925f3b7667e7d3cc5fa90560dbc84403f1", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/592d91925f3b7667e7d3cc5fa90560dbc84403f1", "committedDate": "2020-03-14T02:11:57Z", "message": "Fix LogData lastKnownSize which is inaccurate and inconsistent.\n\nWhen set during serialization and deserialization, the LogData\nlastKnownSize is set to different values. It is also inaccurate\nas it is set to ByteBuf's internal array length during serialization,\nwhich is usually larger the actually (it is dynamically resized and\nusually 2x of previous size). It needs to be set to the payload's\nserialized size."}, "afterCommit": {"oid": "942961936f219b6e12c55d3a546e10cdd5c4b1ca", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/942961936f219b6e12c55d3a546e10cdd5c4b1ca", "committedDate": "2020-03-14T02:15:03Z", "message": "Fix LogData lastKnownSize which is inaccurate and inconsistent.\n\n- When set during serialization and deserialization, the LogData\nlastKnownSize is set to different values. It is also inaccurate\nas it is set to ByteBuf's internal array length during serialization,\nwhich is usually larger the actually (it is dynamically resized and\nusually 2x of previous size). It needs to be set to the payload's\nserialized size. This incorrect behavior affects transaction size\nlimit calculation, which results in unnecessary WriteSizeException.\n\n- Also fixed a test where compression should be ruled out."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MDgwODg3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2480#pullrequestreview-377080887", "createdAt": "2020-03-18T17:23:42Z", "commit": {"oid": "942961936f219b6e12c55d3a546e10cdd5c4b1ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MjgyMjMx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2480#pullrequestreview-377282231", "createdAt": "2020-03-18T22:29:39Z", "commit": {"oid": "942961936f219b6e12c55d3a546e10cdd5c4b1ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjoyOTozOVrOF4ZIuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjoyOTozOVrOF4ZIuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NjQxMQ==", "bodyText": "can't you just set lastKnownSize = buf.readableBytes() on acquireBuffer  instead of setting it twice in doSerializeInternal ?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2480#discussion_r394676411", "createdAt": "2020-03-18T22:29:39Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/protocols/wireprotocol/LogData.java", "diffHunk": "@@ -129,7 +129,6 @@ public synchronized void acquireBuffer() {\n         if (serializedCache == null) {\n             serializedCache = Unpooled.buffer();\n             doSerializeInternal(serializedCache);\n-            lastKnownSize = serializedCache.array().length;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "942961936f219b6e12c55d3a546e10cdd5c4b1ca"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MjgyNzcy", "url": "https://github.com/CorfuDB/CorfuDB/pull/2480#pullrequestreview-377282772", "createdAt": "2020-03-18T22:30:54Z", "commit": {"oid": "942961936f219b6e12c55d3a546e10cdd5c4b1ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9816117783c9417a4857137bda8d748942af922", "author": {"user": {"login": "WenbinZhu", "name": "Wenbin Zhu"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c9816117783c9417a4857137bda8d748942af922", "committedDate": "2020-03-30T20:48:15Z", "message": "Merge branch 'master' into fix_logdata_size"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3376, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}