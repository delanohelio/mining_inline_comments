{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5NzAyOTc1", "number": 2675, "title": "Log Entry Sync allow mixed Transactions", "bodyText": "Overview\nDescription:\nAllow replication when a transaction is executed across\nreplicated and non-replicated streams. Filter out the streams\nof interest and disregard all other streams.\nWhy should this be merged:\nRelated issue(s) (if applicable): #\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-07-31T01:13:39Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2675", "merged": true, "mergeCommit": {"oid": "3475452c865cc1e8b508eec967ec8f8d4599c214"}, "closed": true, "closedAt": "2020-08-01T02:37:18Z", "author": {"login": "annym"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6csRHgFqTQ1OTUxMjEzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6fhNMgFqTQ1OTU0NDg0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTEyMTM1", "url": "https://github.com/CorfuDB/CorfuDB/pull/2675#pullrequestreview-459512135", "createdAt": "2020-07-31T22:43:40Z", "commit": {"oid": "2abe71cb9d402f24b5d5d03bfc32057f012bcb33"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjo0Mzo0MFrOG6YvLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMzoxMjowM1rOG6ZH9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NTg4Nw==", "bodyText": "We should log a message here or in cancelLogEntrySync.  Also, I think it will be useful to log the max allowed size and size of logData", "url": "https://github.com/CorfuDB/CorfuDB/pull/2675#discussion_r463875887", "createdAt": "2020-07-31T22:43:40Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/LogEntrySender.java", "diffHunk": "@@ -119,23 +118,15 @@ public void send(UUID logEntrySyncEventId) {\n                     // Back-off for couple of seconds and retry n times if not require full sync\n                 }\n \n-                if (logEntryReader.hasNoiseData()) {\n-                    cancelLogEntrySync(LogReplicationError.ILLEGAL_TRANSACTION, LogReplicationEventType.REPLICATION_SHUTDOWN, logEntrySyncEventId);\n+                if (logEntryReader.hasMessageExceededSize()) {\n+                    cancelLogEntrySync(LogReplicationError.LOG_ENTRY_MESSAGE_SIZE_EXCEEDED, LogReplicationEventType.REPLICATION_SHUTDOWN, logEntrySyncEventId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2abe71cb9d402f24b5d5d03bfc32057f012bcb33"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3OTI1MA==", "bodyText": "nit - no need of else.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2675#discussion_r463879250", "createdAt": "2020-07-31T22:57:46Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/logreader/StreamsLogEntryReader.java", "diffHunk": "@@ -89,55 +95,52 @@ private LogReplicationEntry generateMessageWithOpaqueEntryList(List<OpaqueEntry>\n         return txMessage;\n     }\n \n+    /**\n+     * Verify the transaction entry is valid, i.e., if the entry contains any\n+     * of the streams to be replicated.\n+     *\n+     * Notice that a transaction stream entry can be fully or partially replicated,\n+     * i.e., if only a subset of streams in the transaction entry are part of the streams\n+     * to replicate, the transaction entry will be partially replicated,\n+     * avoiding replication of the other streams present in the transaction.\n+     *\n+     * @param entry transaction stream opaque entry\n+     *\n+     * @return true, if the transaction entry has any valid stream to replicate.\n+     *         false, otherwise.\n+     */\n+    private boolean isValidTransactionEntry(@NonNull OpaqueEntry entry) {\n+        Set<UUID> txEntryStreamIds = new HashSet<>(entry.getEntries().keySet());\n \n-    // Check if it has the correct streams.\n-    private boolean shouldProcess(OpaqueEntry entry) {\n-        Set<UUID> tmpUUIDs = new HashSet<>(entry.getEntries().keySet());\n-\n-        // Check if Tx Stream Opaque Entry is empty\n-        if(tmpUUIDs.isEmpty()) {\n-            log.info(\"Log Entry Reader, TX stream Opaque entry is EMPTY, size={}, version={}\", streamUUIDs.size(),\n+        // Sanity Check: discard if transaction stream opaque entry is empty (no streams are present)\n+        if (txEntryStreamIds.isEmpty()) {\n+            log.info(\"Log Entry Reader, TX stream Opaque entry is EMPTY, streams_to_replicate={}, empty entry ts={}\", streamUUIDs.size(),\n                     entry.getVersion());\n             return false;\n         }\n \n-        // If the entry's stream set is a subset of interested streams, it is the entry we should process\n-        if (streamUUIDs.containsAll(tmpUUIDs)) {\n-            log.info(\"Log Entry Reader, replicating streams={}, replicateBase={}\", tmpUUIDs, streamUUIDs.size());\n-            return true;\n-        }\n-\n-        // If the entry's stream set has no overlap with the interested streams, it should be skipped.\n-        tmpUUIDs.retainAll(streamUUIDs);\n-        if (tmpUUIDs.isEmpty()) {\n-            log.info(\"Log Entry Reader, TX stream contains none of the streams of interest, version={}\", entry.getVersion());\n+        // If none of the streams in the transaction entry are specified to be replicated, this is an invalid entry, skip\n+        if (Collections.disjoint(streamUUIDs, txEntryStreamIds)) {\n+            log.debug(\"Log Entry Reader, TX entry[{}] contains none of the streams of interest, streams={}\", entry.getVersion(), txEntryStreamIds);\n             return false;\n+        } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2abe71cb9d402f24b5d5d03bfc32057f012bcb33"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4MjIzMQ==", "bodyText": "nit - extra newline", "url": "https://github.com/CorfuDB/CorfuDB/pull/2675#discussion_r463882231", "createdAt": "2020-07-31T23:12:03Z", "author": {"login": "pankti-m"}, "path": "runtime/src/main/java/org/corfudb/protocols/logprotocol/OpaqueEntry.java", "diffHunk": "@@ -36,6 +36,7 @@\n     // TODO(Maithem): Inconsistent behavior when full-sync vs delta (for full sync the versions will change)\n     final long version;\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2abe71cb9d402f24b5d5d03bfc32057f012bcb33"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2abe71cb9d402f24b5d5d03bfc32057f012bcb33", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/2abe71cb9d402f24b5d5d03bfc32057f012bcb33", "committedDate": "2020-07-31T01:10:13Z", "message": "Log Entry Sync allow mixed Transactions\n\nAllow replication when a transaction is executed across\nreplicated and non-replicated streams. Filter out the streams\nof interest and disregard all other streams."}, "afterCommit": {"oid": "b67fe140f56a514bd0c01ef3e40ec98d6aee2e31", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b67fe140f56a514bd0c01ef3e40ec98d6aee2e31", "committedDate": "2020-07-31T23:58:49Z", "message": "Log Entry Sync allow mixed Transactions\n\nAllow replication when a transaction is executed across\nreplicated and non-replicated streams. Filter out the streams\nof interest and disregard all other streams."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b67fe140f56a514bd0c01ef3e40ec98d6aee2e31", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b67fe140f56a514bd0c01ef3e40ec98d6aee2e31", "committedDate": "2020-07-31T23:58:49Z", "message": "Log Entry Sync allow mixed Transactions\n\nAllow replication when a transaction is executed across\nreplicated and non-replicated streams. Filter out the streams\nof interest and disregard all other streams."}, "afterCommit": {"oid": "01c0ac9c95ace627cb377947d24c4e4123da8b8f", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/01c0ac9c95ace627cb377947d24c4e4123da8b8f", "committedDate": "2020-08-01T01:17:04Z", "message": "Log Entry Sync allow mixed Transactions\n\nAllow replication when a transaction is executed across\nreplicated and non-replicated streams. Filter out the streams\nof interest and disregard all other streams."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01c0ac9c95ace627cb377947d24c4e4123da8b8f", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/01c0ac9c95ace627cb377947d24c4e4123da8b8f", "committedDate": "2020-08-01T01:17:04Z", "message": "Log Entry Sync allow mixed Transactions\n\nAllow replication when a transaction is executed across\nreplicated and non-replicated streams. Filter out the streams\nof interest and disregard all other streams."}, "afterCommit": {"oid": "cdf0bb8a1194e2324e84744946f6b4ab3ab08800", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/cdf0bb8a1194e2324e84744946f6b4ab3ab08800", "committedDate": "2020-08-01T01:18:06Z", "message": "Log Entry Sync allow mixed Transactions\n\nAllow replication when a transaction is executed across\nreplicated and non-replicated streams. Filter out the streams\nof interest and disregard all other streams."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb78d194f7129c79513764207502fd7dadd64265", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/fb78d194f7129c79513764207502fd7dadd64265", "committedDate": "2020-08-01T01:38:13Z", "message": "Log Entry Sync allow mixed Transactions\n\nAllow replication when a transaction is executed across\nreplicated and non-replicated streams. Filter out the streams\nof interest and disregard all other streams."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdf0bb8a1194e2324e84744946f6b4ab3ab08800", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/cdf0bb8a1194e2324e84744946f6b4ab3ab08800", "committedDate": "2020-08-01T01:18:06Z", "message": "Log Entry Sync allow mixed Transactions\n\nAllow replication when a transaction is executed across\nreplicated and non-replicated streams. Filter out the streams\nof interest and disregard all other streams."}, "afterCommit": {"oid": "fb78d194f7129c79513764207502fd7dadd64265", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/fb78d194f7129c79513764207502fd7dadd64265", "committedDate": "2020-08-01T01:38:13Z", "message": "Log Entry Sync allow mixed Transactions\n\nAllow replication when a transaction is executed across\nreplicated and non-replicated streams. Filter out the streams\nof interest and disregard all other streams."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTQ0ODQ4", "url": "https://github.com/CorfuDB/CorfuDB/pull/2675#pullrequestreview-459544848", "createdAt": "2020-08-01T02:37:01Z", "commit": {"oid": "b67fe140f56a514bd0c01ef3e40ec98d6aee2e31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4337, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}