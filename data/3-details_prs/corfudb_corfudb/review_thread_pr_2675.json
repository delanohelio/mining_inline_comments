{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5NzAyOTc1", "number": 2675, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjo0Mzo0MFrOEUOSMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMzoxMjowM1rOEUOi-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NjQxMDEwOnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/LogEntrySender.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjo0Mzo0MFrOG6YvLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjo0Mzo0MFrOG6YvLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NTg4Nw==", "bodyText": "We should log a message here or in cancelLogEntrySync.  Also, I think it will be useful to log the max allowed size and size of logData", "url": "https://github.com/CorfuDB/CorfuDB/pull/2675#discussion_r463875887", "createdAt": "2020-07-31T22:43:40Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/LogEntrySender.java", "diffHunk": "@@ -119,23 +118,15 @@ public void send(UUID logEntrySyncEventId) {\n                     // Back-off for couple of seconds and retry n times if not require full sync\n                 }\n \n-                if (logEntryReader.hasNoiseData()) {\n-                    cancelLogEntrySync(LogReplicationError.ILLEGAL_TRANSACTION, LogReplicationEventType.REPLICATION_SHUTDOWN, logEntrySyncEventId);\n+                if (logEntryReader.hasMessageExceededSize()) {\n+                    cancelLogEntrySync(LogReplicationError.LOG_ENTRY_MESSAGE_SIZE_EXCEEDED, LogReplicationEventType.REPLICATION_SHUTDOWN, logEntrySyncEventId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2abe71cb9d402f24b5d5d03bfc32057f012bcb33"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NjQzMjg2OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/logreader/StreamsLogEntryReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjo1Nzo0NlrOG6Y8Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjo1Nzo0NlrOG6Y8Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3OTI1MA==", "bodyText": "nit - no need of else.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2675#discussion_r463879250", "createdAt": "2020-07-31T22:57:46Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/send/logreader/StreamsLogEntryReader.java", "diffHunk": "@@ -89,55 +95,52 @@ private LogReplicationEntry generateMessageWithOpaqueEntryList(List<OpaqueEntry>\n         return txMessage;\n     }\n \n+    /**\n+     * Verify the transaction entry is valid, i.e., if the entry contains any\n+     * of the streams to be replicated.\n+     *\n+     * Notice that a transaction stream entry can be fully or partially replicated,\n+     * i.e., if only a subset of streams in the transaction entry are part of the streams\n+     * to replicate, the transaction entry will be partially replicated,\n+     * avoiding replication of the other streams present in the transaction.\n+     *\n+     * @param entry transaction stream opaque entry\n+     *\n+     * @return true, if the transaction entry has any valid stream to replicate.\n+     *         false, otherwise.\n+     */\n+    private boolean isValidTransactionEntry(@NonNull OpaqueEntry entry) {\n+        Set<UUID> txEntryStreamIds = new HashSet<>(entry.getEntries().keySet());\n \n-    // Check if it has the correct streams.\n-    private boolean shouldProcess(OpaqueEntry entry) {\n-        Set<UUID> tmpUUIDs = new HashSet<>(entry.getEntries().keySet());\n-\n-        // Check if Tx Stream Opaque Entry is empty\n-        if(tmpUUIDs.isEmpty()) {\n-            log.info(\"Log Entry Reader, TX stream Opaque entry is EMPTY, size={}, version={}\", streamUUIDs.size(),\n+        // Sanity Check: discard if transaction stream opaque entry is empty (no streams are present)\n+        if (txEntryStreamIds.isEmpty()) {\n+            log.info(\"Log Entry Reader, TX stream Opaque entry is EMPTY, streams_to_replicate={}, empty entry ts={}\", streamUUIDs.size(),\n                     entry.getVersion());\n             return false;\n         }\n \n-        // If the entry's stream set is a subset of interested streams, it is the entry we should process\n-        if (streamUUIDs.containsAll(tmpUUIDs)) {\n-            log.info(\"Log Entry Reader, replicating streams={}, replicateBase={}\", tmpUUIDs, streamUUIDs.size());\n-            return true;\n-        }\n-\n-        // If the entry's stream set has no overlap with the interested streams, it should be skipped.\n-        tmpUUIDs.retainAll(streamUUIDs);\n-        if (tmpUUIDs.isEmpty()) {\n-            log.info(\"Log Entry Reader, TX stream contains none of the streams of interest, version={}\", entry.getVersion());\n+        // If none of the streams in the transaction entry are specified to be replicated, this is an invalid entry, skip\n+        if (Collections.disjoint(streamUUIDs, txEntryStreamIds)) {\n+            log.debug(\"Log Entry Reader, TX entry[{}] contains none of the streams of interest, streams={}\", entry.getVersion(), txEntryStreamIds);\n             return false;\n+        } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2abe71cb9d402f24b5d5d03bfc32057f012bcb33"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5NjQ1MzA1OnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/protocols/logprotocol/OpaqueEntry.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMzoxMjowM1rOG6ZH9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMzoxMjowM1rOG6ZH9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg4MjIzMQ==", "bodyText": "nit - extra newline", "url": "https://github.com/CorfuDB/CorfuDB/pull/2675#discussion_r463882231", "createdAt": "2020-07-31T23:12:03Z", "author": {"login": "pankti-m"}, "path": "runtime/src/main/java/org/corfudb/protocols/logprotocol/OpaqueEntry.java", "diffHunk": "@@ -36,6 +36,7 @@\n     // TODO(Maithem): Inconsistent behavior when full-sync vs delta (for full sync the versions will change)\n     final long version;\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2abe71cb9d402f24b5d5d03bfc32057f012bcb33"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1890, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}