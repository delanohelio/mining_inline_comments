{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMzM5NjMy", "number": 2764, "title": "Fix the trimmed and not transferred segment case in S/T", "bodyText": "Overview\nDescription:\n\nThis patch includes the trimmed and not restored segments in the layout restoration workflow (see the linked issue below).\nAlso bug fix in one of the old tests\n\nRelated issue(s) (if applicable): #\nCloses  #2731, #2697\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-09-08T22:35:33Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2764", "merged": true, "mergeCommit": {"oid": "c1c368f029e5ec9c55c005b447b83ceb14e30226"}, "closed": true, "closedAt": "2020-09-11T03:49:25Z", "author": {"login": "PavelZaytsev"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG_UL_gH2gAyNDgyMzM5NjMyOmZmNjA4MmIwOTY4ZmM0MjVjNGEzNWIxMGVlMTlmYTY1MWRkYTQ4YmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHniyaAH2gAyNDgyMzM5NjMyOmNiYmM1ZmNhNmY4ODkxYTM0MTg1NjJmY2Y2NDc3YzVhMTZiMDRkMDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ff6082b0968fc425c4a35b10ee19fa651dda48ba", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/ff6082b0968fc425c4a35b10ee19fa651dda48ba", "committedDate": "2020-09-08T22:26:51Z", "message": "Fix the Trimmed/Not Transferred case in S/T"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTYzMDAw", "url": "https://github.com/CorfuDB/CorfuDB/pull/2764#pullrequestreview-484563000", "createdAt": "2020-09-08T23:37:40Z", "commit": {"oid": "ff6082b0968fc425c4a35b10ee19fa651dda48ba"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMzozNzo0MFrOHOxd3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMzozNzo0MFrOHOxd3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI1MjU3NA==", "bodyText": "maybe use two filter methods?\n.filter(segment -> segment.getEnd() <= trimMark)\n.filter(segment ->  !segmentContainsServer(segment, getServer()))", "url": "https://github.com/CorfuDB/CorfuDB/pull/2764#discussion_r485252574", "createdAt": "2020-09-08T23:37:40Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/redundancy/RedundancyCalculator.java", "diffHunk": "@@ -222,6 +223,38 @@ public static boolean canRestoreRedundancyOrMergeSegments(Layout layout, String\n                 .collect(ImmutableList.toImmutableList());\n     }\n \n+    /**\n+     * Get all the layout segments that were trimmed and that do not contain a current server, and\n+     * return them as TRANSFERRED segments. Since these segments were trimmed, they\n+     * contain zero transferable addresses, and hence are not eligible for state transfer.\n+     * However, since they also do not contain a current server, they should be considered\n+     * TRANSFERRED, eligible for the layout redundancy restoration.\n+     *\n+     * @param layout   A current layout.\n+     * @param trimMark A current global trim mark.\n+     * @return A list of transfer segments.\n+     */\n+    public ImmutableList<TransferSegment> getTrimmedNotRestoredSegments(Layout layout, long trimMark) {\n+        return layout.getSegments()\n+                .stream()\n+                .filter(segment -> segment.getEnd() <= trimMark && !segmentContainsServer(segment, getServer()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff6082b0968fc425c4a35b10ee19fa651dda48ba"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NTAxMDI4", "url": "https://github.com/CorfuDB/CorfuDB/pull/2764#pullrequestreview-485501028", "createdAt": "2020-09-10T01:14:26Z", "commit": {"oid": "ff6082b0968fc425c4a35b10ee19fa651dda48ba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NTk0ODMy", "url": "https://github.com/CorfuDB/CorfuDB/pull/2764#pullrequestreview-485594832", "createdAt": "2020-09-10T05:35:45Z", "commit": {"oid": "ff6082b0968fc425c4a35b10ee19fa651dda48ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNTozNTo0NVrOHPjvMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNTozNTo0NVrOHPjvMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA3NjIwOQ==", "bodyText": "Even if addresses before the trim mark have been trimmed, they are on disk right?  How is that data restored on B and C?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2764#discussion_r486076209", "createdAt": "2020-09-10T05:35:45Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/test/java/org/corfudb/infrastructure/redundancy/RedundancyCalculatorTest.java", "diffHunk": "@@ -556,4 +558,47 @@ public void testPrepareTransferWorkloadCommittedTailSplitsSegment() {\n                 s -> s.equals(testSegments.get(1).getStatus()))).isTrue();\n     }\n \n+    @Test\n+    public void testGetTrimmedNotRestoredSegments() {\n+        Layout.ReplicationMode replicationMode = CHAIN_REPLICATION;\n+        LayoutStripe layoutStripe1 = new LayoutStripe(ImmutableList.of(\"A\"));\n+        LayoutSegment segment1 = new LayoutSegment(replicationMode, 0L, 100L,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff6082b0968fc425c4a35b10ee19fa651dda48ba"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4146661ef07957fd59411b53a46e6fe323b4d430", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/4146661ef07957fd59411b53a46e6fe323b4d430", "committedDate": "2020-09-10T08:04:00Z", "message": "Calculate Remaining Replicated Entries based on TxStream\n\n- Calculate replicated remaining entries based on the txStream\n  to avoid the issue of holes enforced on regular streams by the checkpointer.\n- Minor bug fix, restarted Snapshot Sync same baseSnapshot (not reject)\n- Add some valuable logging for debugging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "557c9cb9fdeff440763430bf308240eed45b9677", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/557c9cb9fdeff440763430bf308240eed45b9677", "committedDate": "2020-09-10T18:05:56Z", "message": "Merge branch 'master' into st-trim-bug-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a91cc08043966830fcb3a5f787dedf235939fedb", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/a91cc08043966830fcb3a5f787dedf235939fedb", "committedDate": "2020-09-10T19:59:10Z", "message": "Merge branch 'calculateRemainingReplication' of github.com:CorfuDB/CorfuDB into st-trim-bug-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cfd920d1354714420a5f25d8455cdf1482f7aef", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/3cfd920d1354714420a5f25d8455cdf1482f7aef", "committedDate": "2020-09-10T21:16:02Z", "message": "Fix flaky test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4692cfe9ad6e02c83e5785f8ee47310b15d7023", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/d4692cfe9ad6e02c83e5785f8ee47310b15d7023", "committedDate": "2020-09-10T21:16:16Z", "message": "Merge branch 'st-trim-bug-fix' of github.com:CorfuDB/CorfuDB into st-trim-bug-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbbc5fca6f8891a3418562fcf6477c5a16b04d03", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/cbbc5fca6f8891a3418562fcf6477c5a16b04d03", "committedDate": "2020-09-10T21:19:00Z", "message": "Merge branch 'master' into st-trim-bug-fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4037, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}