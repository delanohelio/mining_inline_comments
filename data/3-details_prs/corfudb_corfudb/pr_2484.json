{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTQ2Mjg1", "number": 2484, "title": "Layout and ClusterId Validation for the Server Router", "bodyText": "Overview\nDescription:\nThis PR was previously merged but got reverted to introduce other changes.\nWhy should this be merged:\nThis PR introduces clusterId and layout validation on the server router level.\nRelated issue(s) (if applicable): #\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-03-19T17:44:04Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2484", "merged": true, "mergeCommit": {"oid": "6827715a21dcf6837e8e2e5370a7d1345200aac2"}, "closed": true, "closedAt": "2020-03-26T21:24:19Z", "author": {"login": "PavelZaytsev"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPPtXAABqjMxNDY2NDgzMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRiWFEgFqTM4MjQwMjI4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5286fc32117a6edb42345760e9e44a593e3d296e", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/5286fc32117a6edb42345760e9e44a593e3d296e", "committedDate": "2020-03-13T22:17:05Z", "message": "Merge branch 'master' into reset-bug"}, "afterCommit": {"oid": "eeb04025cb26f75a8b8ae61fb84b03f79941801e", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/eeb04025cb26f75a8b8ae61fb84b03f79941801e", "committedDate": "2020-03-19T17:51:17Z", "message": "Introduce clusterId and layout validation for server router"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MDc2NDk4", "url": "https://github.com/CorfuDB/CorfuDB/pull/2484#pullrequestreview-378076498", "createdAt": "2020-03-19T20:39:33Z", "commit": {"oid": "eeb04025cb26f75a8b8ae61fb84b03f79941801e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MTQ4NTI5", "url": "https://github.com/CorfuDB/CorfuDB/pull/2484#pullrequestreview-378148529", "createdAt": "2020-03-19T22:56:31Z", "commit": {"oid": "a73aad3b7817f6c7052a5e6ae3508a1dcc23bb68"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMjo1NjozMVrOF5DJJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMjo1NjozMVrOF5DJJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM2NDY0NQ==", "bodyText": "I feel this could have an issue. Think about this case:\n\nthe client connects to A, B, C\nC joined new cluster\nthe client runtime is invalidated, and when it tries to fetch layout, the layout servers it tries to connect is still A, B, C becuase this is based on last layout.\nC responded with a new layout and new cluster id. The client will take this layout as in the current CorfuRuntime, it only needs to successfuly fetch from one layout server.\nthe client connects to the new cluster, which is not intended because client may wants to stay in the old cluster.\n\nCan you think about this case and see if it's true?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2484#discussion_r395364645", "createdAt": "2020-03-19T22:56:31Z", "author": {"login": "WenbinZhu"}, "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -887,11 +887,13 @@ private void checkClusterId(@Nonnull Layout layout) {\n         if (clusterId == null) {\n             clusterId = layout.getClusterId();\n             if (clusterId != null) {\n-                log.info(\"Connected to new cluster {}\", UuidUtils.asBase64(clusterId));\n+                log.info(\"Connected to a new cluster {}\", UuidUtils.asBase64(clusterId));\n             }\n-        } else if (!clusterId.equals(layout.getClusterId())) {\n-            // We connected but got a cluster id we didn't expect.\n-            throw new WrongClusterException(clusterId, layout.getClusterId());\n+            // ClusterId has changed, connect to a new cluster.\n+        } else if (!clusterId.equals(layout.getClusterId()) && layout.getClusterId() != null) {\n+            log.warn(\"Connecting to a new cluster {}. Previous cluster was: {}\",\n+                    UuidUtils.asBase64(layout.getClusterId()), UuidUtils.asBase64(clusterId));\n+            clusterId = layout.getClusterId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a73aad3b7817f6c7052a5e6ae3508a1dcc23bb68"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a73aad3b7817f6c7052a5e6ae3508a1dcc23bb68", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/a73aad3b7817f6c7052a5e6ae3508a1dcc23bb68", "committedDate": "2020-03-19T22:45:55Z", "message": "Fix"}, "afterCommit": {"oid": "a0c65b6b09a9bc1bc2bed5de6ff3ecc4c836118f", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/a0c65b6b09a9bc1bc2bed5de6ff3ecc4c836118f", "committedDate": "2020-03-19T23:51:29Z", "message": "Introduce clusterId and layout validation on the server router level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b514e9bd2ec30228b50470ba7087508437bf7e57", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b514e9bd2ec30228b50470ba7087508437bf7e57", "committedDate": "2020-03-26T18:37:36Z", "message": "Introduce clusterId and layout validation on the server router level"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c27569eadb4776dc047bdbe0f344cc82db55a75e", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c27569eadb4776dc047bdbe0f344cc82db55a75e", "committedDate": "2020-03-26T18:35:14Z", "message": "Return old checkClusterId version"}, "afterCommit": {"oid": "b514e9bd2ec30228b50470ba7087508437bf7e57", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b514e9bd2ec30228b50470ba7087508437bf7e57", "committedDate": "2020-03-26T18:37:36Z", "message": "Introduce clusterId and layout validation on the server router level"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzk0MDEw", "url": "https://github.com/CorfuDB/CorfuDB/pull/2484#pullrequestreview-382394010", "createdAt": "2020-03-26T20:32:01Z", "commit": {"oid": "b514e9bd2ec30228b50470ba7087508437bf7e57"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDAyMjg2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2484#pullrequestreview-382402286", "createdAt": "2020-03-26T20:43:41Z", "commit": {"oid": "b514e9bd2ec30228b50470ba7087508437bf7e57"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4424, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}