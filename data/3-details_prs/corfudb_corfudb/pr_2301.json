{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MTUzNjcz", "number": 2301, "title": "CorfuStore: Version should start with 0", "bodyText": "Newly created CorfuStore objects need to have a version field of 0\nto be compatible with some older usecases.\n(Right now they start with 1)\n+TestCase to validate this.\nOverview\nDescription:\nWhy should this be merged:\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-01-03T23:25:29Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2301", "merged": true, "mergeCommit": {"oid": "cf7d84f8fe698e4d02555d7399ae7478d18227a2"}, "closed": true, "closedAt": "2020-01-06T21:27:41Z", "author": {"login": "hisundar"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb224chAH2gAyMzU5MTUzNjczOmFjMmY3NzJlZWRkYTU1Y2E3MzBlNDhhNTAzMmE4Njk1NjUwOWRhNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb3xxgPgFqTMzODg1NzkxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ac2f772eedda55ca730e48a5032a86956509da47", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/ac2f772eedda55ca730e48a5032a86956509da47", "committedDate": "2020-01-03T23:23:22Z", "message": "CorfuStore: Version should start with 0\n\nNewly created objects need to have a version field of 0\nto be compatible with some older usecases.\n+TestCase to validate this."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MzIwNzQ2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2301#pullrequestreview-338320746", "createdAt": "2020-01-04T00:03:25Z", "commit": {"oid": "ac2f772eedda55ca730e48a5032a86956509da47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4ODYwMzIx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2301#pullrequestreview-338860321", "createdAt": "2020-01-06T19:56:14Z", "commit": {"oid": "ac2f772eedda55ca730e48a5032a86956509da47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4ODU3OTEy", "url": "https://github.com/CorfuDB/CorfuDB/pull/2301#pullrequestreview-338857912", "createdAt": "2020-01-06T19:51:58Z", "commit": {"oid": "ac2f772eedda55ca730e48a5032a86956509da47"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxOTo1MTo1OFrOFaniAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxOTo1MTo1OFrOFaniAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ1NDk3Ng==", "bodyText": "Can we make 0L a static final variable?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2301#discussion_r363454976", "createdAt": "2020-01-06T19:51:58Z", "author": {"login": "annym"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/Table.java", "diffHunk": "@@ -300,15 +305,16 @@ int count() {\n             Descriptors.FieldDescriptor.Type.SFIXED64\n     ));\n \n-    private M getNewMetadata(@Nonnull M previousMetadata,\n-                             @Nullable M userMetadata) {\n+    private M mergeOldAndNewMetadata(@Nonnull M previousMetadata,\n+                                     @Nullable M userMetadata, boolean isCreate) {\n         M.Builder builder = previousMetadata.toBuilder();\n         for (Descriptors.FieldDescriptor fieldDescriptor : previousMetadata.getDescriptorForType().getFields()) {\n             if (fieldDescriptor.getOptions().getExtension(CorfuOptions.schema).getVersion()) {\n+                // If an object is just being created, explicitly set its version field to 0\n                 builder.setField(\n                         fieldDescriptor,\n                         Optional.ofNullable(previousMetadata.getField(fieldDescriptor))\n-                                .map(previousVersion -> ((Long) previousVersion) + 1)\n+                                .map(previousVersion -> (isCreate ? 0L : ((Long) previousVersion) + 1))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2f772eedda55ca730e48a5032a86956509da47"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3385, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}