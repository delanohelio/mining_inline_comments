{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNzU5MDQ2", "number": 2807, "title": "Client side corfu metrics", "bodyText": "Overview\nDescription:\nIntroduce client side metrics.\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-10-30T05:02:35Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807", "merged": true, "mergeCommit": {"oid": "8b401c1d3ea1a07b8f7d6ef9d6222f26a8f6d314"}, "closed": true, "closedAt": "2020-11-26T07:17:21Z", "author": {"login": "PavelZaytsev"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXtYrzgFqTUyMTAzODAwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgGHnxAH2gAyNTEyNzU5MDQ2OjAxNjU0MDg1NTBjOTQyYmNiYzg5ZmY4YmUzZWVkZTMxMDQ4ODVhNTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDM4MDAz", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-521038003", "createdAt": "2020-10-30T21:10:10Z", "commit": {"oid": "2cb91e198efb4c3f576ef349201995ee781023d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMToxMDoxMVrOHrgkTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMToxMDoxMVrOHrgkTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4NDM5OQ==", "bodyText": "can we extract these 3 variables into a MetricsConfig class?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r515384399", "createdAt": "2020-10-30T21:10:11Z", "author": {"login": "xnull"}, "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -242,6 +246,12 @@ public static CorfuRuntimeParametersBuilder builder() {\n          */\n         private MetricRegistry metricRegistry;\n \n+        private boolean microMeterRegistryEnabled;\n+\n+        private Duration microMeterLoggingInterval;\n+\n+        private String configuredLogger;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cb91e198efb4c3f576ef349201995ee781023d8"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDkxNzE3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-521091717", "createdAt": "2020-10-31T00:05:36Z", "commit": {"oid": "ca5efa942a6fe21ffd43c2b4ab3d874aeab03c26"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b4af572b5b4ea0935271c387097e12e905a8333", "author": {"user": {"login": "xnull", "name": "Viacheslav"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/7b4af572b5b4ea0935271c387097e12e905a8333", "committedDate": "2020-11-02T23:44:27Z", "message": "Merge branch 'master' into client-side-corfu-metrics"}, "afterCommit": {"oid": "21b67d73991a816828b5c54b0395a63e853bcc1f", "author": {"user": null}, "url": "https://github.com/CorfuDB/CorfuDB/commit/21b67d73991a816828b5c54b0395a63e853bcc1f", "committedDate": "2020-11-09T19:36:45Z", "message": "Client side metrics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "866723698be40b1cb5db004b344fd7f04b9932ac", "author": {"user": null}, "url": "https://github.com/CorfuDB/CorfuDB/commit/866723698be40b1cb5db004b344fd7f04b9932ac", "committedDate": "2020-11-13T21:32:21Z", "message": "Merge"}, "afterCommit": {"oid": "6edd50ad56254041809569ff6a39c10e2e0943be", "author": {"user": null}, "url": "https://github.com/CorfuDB/CorfuDB/commit/6edd50ad56254041809569ff6a39c10e2e0943be", "committedDate": "2020-11-13T21:34:21Z", "message": "Client side corfu metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODI2Mjcx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-533826271", "createdAt": "2020-11-18T19:59:09Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTo1OTowOVrOH1_wMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTo1OTowOVrOH1_wMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM4MTEwNQ==", "bodyText": "Can you remove  getInstance and just instantiate a new instance for LR (just like you do it for the client/server). Having a singleton implemented with a synchronized on the getter is not efficient.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r526381105", "createdAt": "2020-11-18T19:59:09Z", "author": {"login": "Maithem"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -25,6 +26,26 @@ private MeterRegistryProvider() {\n      * Class that initializes the Meter Registry.\n      */\n     public static class MeterRegistryInitializer extends MeterRegistryProvider {\n+\n+        /**\n+         * Create a new instance of MeterRegistry with the given logger, loggingInterval\n+         * and clientId.\n+         * @param logger A configured logger.\n+         * @param loggingInterval A duration between log appends for every metric.\n+         * @param clientId An id of a client for this metric.\n+         * @return A new meter registry.\n+         */\n+        public static MeterRegistry newInstance(Logger logger, Duration loggingInterval,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODM1OTYw", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-533835960", "createdAt": "2020-11-18T20:12:27Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDoxMjoyN1rOH2AOWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDoxMjoyN1rOH2AOWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM4ODgyNg==", "bodyText": "This init doesn't seem like its being used.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r526388826", "createdAt": "2020-11-18T20:12:27Z", "author": {"login": "Maithem"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -41,6 +62,22 @@ public static synchronized void init(Logger logger, Duration loggingInterval,\n             init(loggingInterval, localEndpoint, influxLineProtocolLoggingSink);\n         }\n \n+        /**\n+         * Configure the meter registry of type LoggingMeterRegistry. All the metrics registered\n+         * with this meter registry will be exported in the InfluxDB line protocol format\n+         * (https://docs.influxdata.com/influxdb/v1.8/write_protocols/line_protocol_tutorial/)\n+         * with  the provided loggingInterval frequency.\n+         * @param logger A configured logger.\n+         * @param loggingInterval A duration between log appends for every metric.\n+         */\n+        public static synchronized void init(Logger logger, Duration loggingInterval) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODM2NTM3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-533836537", "createdAt": "2020-11-18T20:13:14Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDoxMzoxNFrOH2AQCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDoxMzoxNFrOH2AQCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM4OTI1Nw==", "bodyText": "This init doesn't seem like its being used.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r526389257", "createdAt": "2020-11-18T20:13:14Z", "author": {"login": "Maithem"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -63,6 +100,25 @@ public static synchronized void init(Duration loggingInterval,\n             init(supplier);\n         }\n \n+        /**\n+         * Configure the meter registry of type LoggingMeterRegistry. All the metrics registered\n+         * with this meter registry will be exported via provided logging sink with\n+         * the provided loggingInterval frequency.\n+         * @param sink A configured logging sink.\n+         * @param loggingInterval A duration between log appends for every metric.\n+         */\n+        public static synchronized void init(Duration loggingInterval,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODQyMDkx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-533842091", "createdAt": "2020-11-18T20:19:03Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDoxOTowM1rOH2AiIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDoxOTowM1rOH2AiIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM5Mzg5MA==", "bodyText": "Why does this sink log to debug?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r526393890", "createdAt": "2020-11-18T20:19:03Z", "author": {"login": "Maithem"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/loggingsink/InfluxLineProtocolLoggingSink.java", "diffHunk": "@@ -20,6 +21,7 @@\n \n     @NonNull\n     private final Logger logger;\n+    @Getter", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODQ1NTQw", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-533845540", "createdAt": "2020-11-18T20:23:51Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDoyMzo1MVrOH2AufA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDoyMzo1MVrOH2AufA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM5NzA1Mg==", "bodyText": "Also, in LineTransformer instead of returning return an Optional.empty()  we should fail. Right now we don't have any metrics that we don't expect to transform. Returning an empty optional can hide incorrect regexes which makes it harder to debug (i.e., #2825 (comment) )", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r526397052", "createdAt": "2020-11-18T20:23:51Z", "author": {"login": "Maithem"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/loggingsink/InfluxLineProtocolLoggingSink.java", "diffHunk": "@@ -20,6 +21,7 @@\n \n     @NonNull\n     private final Logger logger;\n+    @Getter", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODU5NDc3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-533859477", "createdAt": "2020-11-18T20:43:24Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo0MzoyNFrOH2BYgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo0MzoyNFrOH2BYgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQwNzgxMA==", "bodyText": "If metricsEnabled = true but no logger was found then we should print a warning message.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r526407810", "createdAt": "2020-11-18T20:43:24Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -825,6 +849,17 @@ private CorfuRuntime(@Nonnull CorfuRuntimeParameters parameters) {\n             MetricsUtils.metricsReportingSetup(\n                     defaultMetrics, parameters.getPrometheusMetricsPort());\n         }\n+        CorfuRuntimeParameters.MicroMeterRuntimeConfig microMeterRuntimeConfig =\n+                this.parameters.getMicroMeterRuntimeConfig();\n+        if (microMeterRuntimeConfig.metricsEnabled) {\n+            LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory();\n+            registry = Optional.ofNullable(loggerContext.exists(microMeterRuntimeConfig.configuredLoggerName))\n+                    .map(logger -> MeterRegistryProvider.MeterRegistryInitializer.newInstance(logger,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 133}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODYxMTM1", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-533861135", "createdAt": "2020-11-18T20:45:48Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo0NTo0OFrOH2BduA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo0NTo0OFrOH2BduA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQwOTE0NA==", "bodyText": "What is the advantage of using Java's Optional over the No-op metric types that micrometer provides?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r526409144", "createdAt": "2020-11-18T20:45:48Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -1118,6 +1154,9 @@ private void pruneRemovedRouters(@Nonnull Layout layout) {\n                         // Prune away removed node routers from the nodeRouterPool.\n                         pruneRemovedRouters(l);\n \n+                        getRegistry().ifPresent(reg ->\n+                                fetchSample.ifPresent(sample ->\n+                                        sample.stop(reg.timer(\"runtime.fetch_layout.timer\"))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 158}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODY0MDgx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-533864081", "createdAt": "2020-11-18T20:50:00Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo1MDowMFrOH2BmnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo1MDowMFrOH2BmnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxMTQyMA==", "bodyText": "Can you use the existing logger name https://github.com/CorfuDB/CorfuDB/blob/master/runtime/src/main/java/org/corfudb/util/MetricsUtils.java#L212  ?\nWe have put out documents that use that logger's name, using a different one might be more confusing.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r526411420", "createdAt": "2020-11-18T20:50:00Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -269,6 +284,15 @@ public static CorfuRuntimeParametersBuilder builder() {\n             private PriorityLevel priorityLevel = PriorityLevel.NORMAL;\n             private Codec.Type codecType = Codec.Type.ZSTD;\n             private MetricRegistry metricRegistry = null;\n+            private MicroMeterRuntimeConfig microMeterRuntimeConfig =\n+                    new MicroMeterRuntimeConfig(true,\n+                    \"CorfuMetrics\", Duration.ofMinutes(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODY2MTky", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-533866192", "createdAt": "2020-11-18T20:52:53Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo1Mjo1M1rOH2BsjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo1Mjo1M1rOH2BsjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxMjk0MQ==", "bodyText": "Wouldn't this cause an issue if the consuming app's class path already has slf4j bindings ?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r526412941", "createdAt": "2020-11-18T20:52:53Z", "author": {"login": "Maithem"}, "path": "runtime/pom.xml", "diffHunk": "@@ -167,6 +167,11 @@\n             <version>6.0.53</version>\n             <scope>provided</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>ch.qos.logback</groupId>\n+            <artifactId>logback-classic</artifactId>\n+            <version>1.2.3</version>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODcxMDkz", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-533871093", "createdAt": "2020-11-18T20:59:43Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo1OTo0M1rOH2B7Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo1OTo0M1rOH2B7Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxNjc0Mw==", "bodyText": "Can you add a gauge on the miss ratio and some metrics for the load time stats.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r526416743", "createdAt": "2020-11-18T20:59:43Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/AddressSpaceView.java", "diffHunk": "@@ -112,14 +120,26 @@ public AddressSpaceView(@Nonnull final CorfuRuntime runtime) {\n                 .recordStats()\n                 .build();\n \n-        MetricRegistry metrics = CorfuRuntime.getDefaultMetrics();\n-        final String pfx = String.format(\"%s0x%x.cache.\", CorfuComponent.ADDRESS_SPACE_VIEW.toString(),\n-                this.hashCode());\n-        metrics.register(pfx + \"cache-size\", (Gauge<Long>) readCache::size);\n-        metrics.register(pfx + \"evictions\", (Gauge<Long>) () -> readCache.stats().evictionCount());\n-        metrics.register(pfx + \"hit-rate\", (Gauge<Double>) () -> readCache.stats().hitRate());\n-        metrics.register(pfx + \"hits\", (Gauge<Long>) () -> readCache.stats().hitCount());\n-        metrics.register(pfx + \"misses\", (Gauge<Long>) () -> readCache.stats().missCount());\n+        Optional<MeterRegistry> metricsRegistry = runtime.getRegistry();\n+\n+        metricsRegistry.ifPresent(registry ->\n+                GuavaCacheMetrics.monitor(registry, readCache, \"address_space.read_cache\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MDYxNTY2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-537061566", "createdAt": "2020-11-24T04:02:30Z", "commit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNDowMjozMFrOH4rDzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNDowMjozMFrOH4rDzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE4Nzc5MA==", "bodyText": "This is a stream range query (scans the bitsets on the sequencer), we should re-add that metric. Actually, there's a bug right now related to bitset queries #2747", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r529187790", "createdAt": "2020-11-24T04:02:30Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/SequencerView.java", "diffHunk": "@@ -122,27 +124,24 @@ public StreamAddressSpace getStreamAddressSpace(StreamAddressRange streamsAddres\n      * @return address space for each stream in the request.\n      */\n     public Map<UUID, StreamAddressSpace> getStreamsAddressSpace(List<StreamAddressRange> streamsAddressesRange) {\n-        try (Timer.Context context = MetricsUtils.getConditionalContext(sequencerNextOneStream)) {\n-            StreamsAddressResponse streamsAddressResponse = layoutHelper(e ->\n-                    CFUtils.getUninterruptibly(e.getPrimarySequencerClient()\n-                            .getStreamsAddressSpace(streamsAddressesRange)));\n-            return streamsAddressResponse.getAddressMap();\n-        }\n+        StreamsAddressResponse streamsAddressResponse = layoutHelper(e ->\n+                CFUtils.getUninterruptibly(e.getPrimarySequencerClient()\n+                        .getStreamsAddressSpace(streamsAddressesRange)));\n+        return streamsAddressResponse.getAddressMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63179154948708a363ea258632ffad40d5ad9c1e"}, "originalPosition": 146}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDc0ODM4", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-538074838", "createdAt": "2020-11-25T00:41:31Z", "commit": {"oid": "6f3fd79015b78e57a6ead6144ef734ceac8ad217"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e751fe0b706244b1e1bfaa9ac5e3ab8407498752", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/e751fe0b706244b1e1bfaa9ac5e3ab8407498752", "committedDate": "2020-11-25T03:13:36Z", "message": "Fix xml"}, "afterCommit": {"oid": "56e46cd3cd94083eccb24269bcd30a79379f1219", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/56e46cd3cd94083eccb24269bcd30a79379f1219", "committedDate": "2020-11-25T03:16:52Z", "message": "Introduce client-side corfu metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19eeb295515573b0489100977ed430d446b7d73b", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/19eeb295515573b0489100977ed430d446b7d73b", "committedDate": "2020-11-25T18:27:37Z", "message": "Client side metrics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "086697e2c2b0a25ad31f767007c2374bbfacfbb4", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/086697e2c2b0a25ad31f767007c2374bbfacfbb4", "committedDate": "2020-11-25T18:26:32Z", "message": "Resolve conflicts"}, "afterCommit": {"oid": "19eeb295515573b0489100977ed430d446b7d73b", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/19eeb295515573b0489100977ed430d446b7d73b", "committedDate": "2020-11-25T18:27:37Z", "message": "Client side metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NzYyMjE0", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#pullrequestreview-538762214", "createdAt": "2020-11-25T18:35:37Z", "commit": {"oid": "19eeb295515573b0489100977ed430d446b7d73b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxODozNTozN1rOH5_scg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxODozNTozN1rOH5_scg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3NDQ1MA==", "bodyText": "Not sure if we need to use 2 different timers to record optimistic sync and regular sync", "url": "https://github.com/CorfuDB/CorfuDB/pull/2807#discussion_r530574450", "createdAt": "2020-11-25T18:35:37Z", "author": {"login": "zhangn49"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/VersionLockedObject.java", "diffHunk": "@@ -679,32 +714,31 @@ protected void syncStreamUnsafe(ISMRStream stream, long timestamp) {\n                 ? \"Optimistic\" : \"to \" + timestamp);\n         long syncTo = (timestamp == Address.OPTIMISTIC) ? Address.MAX : timestamp;\n \n-        Histogram histogram = VloMetricsHelper.metrics.histogram(syncStreamCount);\n-        Counter counter = new Counter();\n-        try (Timer.Context context = getVloStreamSyncContext(timestamp, syncStreamTimer)) {\n-            stream.streamUpTo(syncTo)\n-                    .forEachOrdered(entry -> {\n-                        try {\n-                            counter.count++;\n-                            Object res = applyUpdateUnsafe(entry, timestamp);\n-                            if (timestamp == Address.OPTIMISTIC) {\n+        Runnable syncStreamRunnable = () ->\n+                stream.streamUpTo(syncTo)\n+                        .forEachOrdered(entry -> {\n+                            try {\n+                                Object res = applyUpdateUnsafe(entry, timestamp);\n+                                versionApplyCounter.ifPresent(Counter::increment);\n+                                if (timestamp == Address.OPTIMISTIC) {\n+                                    entry.setUpcallResult(res);\n+                                } else if (pendingUpcalls.contains(entry.getGlobalAddress())) {\n+                                    log.debug(\"Sync[{}] Upcall Result {}\",\n+                                            this, entry.getGlobalAddress());\n+                                    upcallResults.put(entry.getGlobalAddress(), res == null\n+                                            ? NullValue.NULL_VALUE : res);\n+                                    pendingUpcalls.remove(entry.getGlobalAddress());\n+                                }\n                                 entry.setUpcallResult(res);\n-                            } else if (pendingUpcalls.contains(entry.getGlobalAddress())) {\n-                                log.debug(\"Sync[{}] Upcall Result {}\",\n-                                        this, entry.getGlobalAddress());\n-                                upcallResults.put(entry.getGlobalAddress(), res == null\n-                                        ? NullValue.NULL_VALUE : res);\n-                                pendingUpcalls.remove(entry.getGlobalAddress());\n+                            } catch (Exception e) {\n+                                log.error(\"Sync[{}] Error: Couldn't execute upcall due to {}\", this, e);\n+                                throw new UnrecoverableCorfuError(e);\n                             }\n-                            entry.setUpcallResult(res);\n-                        } catch (Exception e) {\n-                            log.error(\"Sync[{}] Error: Couldn't execute upcall due to {}\", this, e);\n-                            throw new UnrecoverableCorfuError(e);\n-                        }\n-                    });\n-        }\n-        if (timestamp != Address.OPTIMISTIC) {\n-            histogram.update(counter.count);\n+                        });\n+        if (syncStreamTimer.isPresent()) {\n+            syncStreamTimer.get().record(syncStreamRunnable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19eeb295515573b0489100977ed430d446b7d73b"}, "originalPosition": 248}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0165408550c942bcbc89ff8be3eede3104885a54", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/0165408550c942bcbc89ff8be3eede3104885a54", "committedDate": "2020-11-25T22:30:34Z", "message": "Merge branch 'master' into client-side-corfu-metrics"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4122, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}