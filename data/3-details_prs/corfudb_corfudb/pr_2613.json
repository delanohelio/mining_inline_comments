{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3Mjk4MTc1", "number": 2613, "title": "Flush Async Logger on Exit", "bodyText": "Overview\nIf not flushed, some crucial logs can be lost.\nWhy should this be merged: Improves debuggability\nRelated issue(s) (if applicable): #2611\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-07-10T08:18:25Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613", "merged": true, "mergeCommit": {"oid": "1c155ee2b4c83e7588a178f0edd0f491e2e39794"}, "closed": true, "closedAt": "2020-07-16T01:14:20Z", "author": {"login": "Maithem"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczfVAIgFqTQ0NjIxNjE2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1Uq82gFqTQ0OTQ0MTIxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MjE2MTY3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#pullrequestreview-446216167", "createdAt": "2020-07-10T08:26:13Z", "commit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4Mjg5ODI2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#pullrequestreview-448289826", "createdAt": "2020-07-14T16:53:27Z", "commit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjo1MzoyN1rOGxciGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjo1MzoyN1rOGxciGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwMDg4OQ==", "bodyText": "Why do you need a local variable for this?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454500889", "createdAt": "2020-07-14T16:53:27Z", "author": {"login": "xiaoqin2012"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -346,7 +347,18 @@ static void restartServer(boolean resetData) {\n     private static void cleanShutdown() {\n         log.info(\"CleanShutdown: Starting Cleanup.\");\n         shutdownServer = true;\n-        activeServer.close();\n+        try {\n+            CorfuServerNode current = activeServer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MjkxODcy", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#pullrequestreview-448291872", "createdAt": "2020-07-14T16:56:06Z", "commit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MzgxMjIx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#pullrequestreview-448381221", "createdAt": "2020-07-14T18:59:11Z", "commit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxODo1OToxMlrOGxhIpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxODo1OToxMlrOGxhIpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU3NjI5NQ==", "bodyText": "This doesn't help at all, I suspect it can even cause loss of the logs.\nLogback already have solved the problem, and we have it enabled \n  \n    \n      CorfuDB/infrastructure/src/main/resources/logback.prod.xml\n    \n    \n         Line 5\n      in\n      30c8d15\n    \n    \n    \n    \n\n        \n          \n           <shutdownHook/>", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454576295", "createdAt": "2020-07-14T18:59:12Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -346,7 +347,18 @@ static void restartServer(boolean resetData) {\n     private static void cleanShutdown() {\n         log.info(\"CleanShutdown: Starting Cleanup.\");\n         shutdownServer = true;\n-        activeServer.close();\n+        try {\n+            CorfuServerNode current = activeServer;\n+            if (current != null) {\n+                activeServer.close();\n+            }\n+        } catch (Throwable th) {\n+            log.error(\"cleanShutdown: failed during shutdown\", th);\n+        }\n+\n+        // Flush the async appender before exiting to prevent the loss of logs\n+        LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTYwMTM0", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#pullrequestreview-448560134", "createdAt": "2020-07-15T00:56:46Z", "commit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDo1Njo0NlrOGxqYaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDo1Njo0NlrOGxqYaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyNzc4Nw==", "bodyText": "it has to be current  instead of activeServer", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454727787", "createdAt": "2020-07-15T00:56:46Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -346,7 +347,18 @@ static void restartServer(boolean resetData) {\n     private static void cleanShutdown() {\n         log.info(\"CleanShutdown: Starting Cleanup.\");\n         shutdownServer = true;\n-        activeServer.close();\n+        try {\n+            CorfuServerNode current = activeServer;\n+            if (current != null) {\n+                activeServer.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTYwODgx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#pullrequestreview-448560881", "createdAt": "2020-07-15T00:59:20Z", "commit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDo1OToyMFrOGxqbEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDo1OToyMFrOGxqbEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyODQ2NA==", "bodyText": "what about - replace volatile by AtomicReference? Then your code will be cleaner, no need for checking for null and bringing additional mental complexity to the code?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454728464", "createdAt": "2020-07-15T00:59:20Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -346,7 +347,18 @@ static void restartServer(boolean resetData) {\n     private static void cleanShutdown() {\n         log.info(\"CleanShutdown: Starting Cleanup.\");\n         shutdownServer = true;\n-        activeServer.close();\n+        try {\n+            CorfuServerNode current = activeServer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTcwOTc3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#pullrequestreview-448570977", "createdAt": "2020-07-15T01:33:41Z", "commit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMTozMzo0MVrOGxq_mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMTozMzo0MVrOGxq_mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNzgxOA==", "bodyText": "Should we remove this line: https://github.com/CorfuDB/CorfuDB/blob/master/infrastructure/src/main/resources/logback.prod.xml#L5 , since we are doing it elsewhere and it's missing class name as well?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r454737818", "createdAt": "2020-07-15T01:33:41Z", "author": {"login": "WenbinZhu"}, "path": "infrastructure/src/main/resources/logback.prod.xml", "diffHunk": "@@ -27,6 +27,7 @@\n     <appender name=\"async_file\" class=\"ch.qos.logback.classic.AsyncAppender\">\n         <appender-ref ref=\"file\" />\n         <queueSize>1024</queueSize>\n+        <maxFlushTime>5000</maxFlushTime>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad3026b915e39d6d20363d99d88800f0fec2f2aa", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/ad3026b915e39d6d20363d99d88800f0fec2f2aa", "committedDate": "2020-07-15T07:16:36Z", "message": "Flush Async Logger on Exit\n\nIf not flushed, some crucial logs can be lost. This patch\nintroduces an explicit flush that will be called during\nthe execution of the shutdown hook."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95e7e150cfab0df62b25eb3912206dc43bd2933c", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/95e7e150cfab0df62b25eb3912206dc43bd2933c", "committedDate": "2020-07-10T08:16:05Z", "message": "Flush Async Logger on Exit\n\nIf not flushed, some crucial logs can be lost."}, "afterCommit": {"oid": "ad3026b915e39d6d20363d99d88800f0fec2f2aa", "author": {"user": {"login": "Maithem", "name": "Maithem"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/ad3026b915e39d6d20363d99d88800f0fec2f2aa", "committedDate": "2020-07-15T07:16:36Z", "message": "Flush Async Logger on Exit\n\nIf not flushed, some crucial logs can be lost. This patch\nintroduces an explicit flush that will be called during\nthe execution of the shutdown hook."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NDQxMTgx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#pullrequestreview-449441181", "createdAt": "2020-07-16T01:09:01Z", "commit": {"oid": "ad3026b915e39d6d20363d99d88800f0fec2f2aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMTowOTowMVrOGyWh9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQwMTowOTowMVrOGyWh9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ1MTEyNw==", "bodyText": "In the best case would be great to get rid of a volatile variable completely. Probably next time", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#discussion_r455451127", "createdAt": "2020-07-16T01:09:01Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -346,7 +347,18 @@ static void restartServer(boolean resetData) {\n     private static void cleanShutdown() {\n         log.info(\"CleanShutdown: Starting Cleanup.\");\n         shutdownServer = true;\n-        activeServer.close();\n+        try {\n+            CorfuServerNode current = activeServer;\n+            if (current != null) {\n+                current.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad3026b915e39d6d20363d99d88800f0fec2f2aa"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NDQxMjEw", "url": "https://github.com/CorfuDB/CorfuDB/pull/2613#pullrequestreview-449441210", "createdAt": "2020-07-16T01:09:05Z", "commit": {"oid": "ad3026b915e39d6d20363d99d88800f0fec2f2aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4230, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}