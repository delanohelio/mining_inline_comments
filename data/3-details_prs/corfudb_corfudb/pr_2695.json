{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NzUxODI4", "number": 2695, "title": "Register System.exit for systemDownHandler for LR CorfuRuntime ", "bodyText": "Overview\nDescription:\nWhy should this be merged:\nDue to the clustering workflow constraints in the production environment, we have to restart the LR once the WCE is hit. This patch registers systemDownHandler on the CorfuRuntime and calls it every time WCE is hit. This should shut down LR JVM that will subsequently get restarted.", "createdAt": "2020-08-10T21:57:17Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695", "merged": true, "mergeCommit": {"oid": "25eed1ae785b3bf30a83ee06f207367746366e6a"}, "closed": true, "closedAt": "2020-08-19T18:22:32Z", "author": {"login": "PavelZaytsev"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9pl1rAFqTQ2NDYxODg5Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdATqpmgFqTQ3MDExMTczMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NjE4ODk3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#pullrequestreview-464618897", "createdAt": "2020-08-10T22:02:47Z", "commit": {"oid": "3dae7620535e91eda2fc58e54ea724f241add1c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMjowMjo0N1rOG-hWLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMjowMjo0N1rOG-hWLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIxMTI0Nw==", "bodyText": "Can we have a test that verifies that LR is correctly restarted and able to resume?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#discussion_r468211247", "createdAt": "2020-08-10T22:02:47Z", "author": {"login": "annym"}, "path": "utils/src/main/java/org/corfudb/utils/lock/states/NoLeaseState.java", "diffHunk": "@@ -90,7 +91,13 @@ private void acquireLease() {\n             if (lockStore.acquire(lock.getLockId())) {\n                 lock.input(LockEvent.LEASE_ACQUIRED);\n             }\n-        } catch (Exception e) {\n+        }\n+        catch (WrongClusterException wce) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3dae7620535e91eda2fc58e54ea724f241add1c4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NjM3ODY3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#pullrequestreview-464637867", "createdAt": "2020-08-10T22:46:44Z", "commit": {"oid": "3dae7620535e91eda2fc58e54ea724f241add1c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMjo0Njo0NVrOG-iUUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQyMjo0Njo0NVrOG-iUUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIyNzE1NQ==", "bodyText": "we should log something here also", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#discussion_r468227155", "createdAt": "2020-08-10T22:46:45Z", "author": {"login": "pankti-m"}, "path": "utils/src/main/java/org/corfudb/utils/lock/LockClient.java", "diffHunk": "@@ -160,7 +161,12 @@ private void monitorLocks() {\n                             log.debug(\"LockClient: lease revoked for lock {}\", lockId.getLockName());\n                             locks.get(lockId).input(LockEvent.LEASE_REVOKED);\n                         }\n-                    } catch (Exception ex) {\n+                    }\n+                    catch (WrongClusterException wce) {\n+                        log.error(\"Lock client {} is connected to a wrong cluster:\", clientId, wce);\n+                        throw wce;\n+                    }\n+                    catch (Exception ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3dae7620535e91eda2fc58e54ea724f241add1c4"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTg4ODEy", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#pullrequestreview-467188812", "createdAt": "2020-08-13T23:08:37Z", "commit": {"oid": "33db2f186aa9b755ed0a7d9fe3f3b111454499c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NzM5MzQz", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#pullrequestreview-468739343", "createdAt": "2020-08-17T18:33:50Z", "commit": {"oid": "1aa19d036578698f065fb0ab58e299d0ecfa1e21"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "281541d3c2049fb2910ace15c71973015b9cda71", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/281541d3c2049fb2910ace15c71973015b9cda71", "committedDate": "2020-08-18T22:50:40Z", "message": "Invoke systemDownHandler in LR in case of WCE"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b85cc07fb4f91f787bc906364b3151559f23dc60", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b85cc07fb4f91f787bc906364b3151559f23dc60", "committedDate": "2020-08-18T22:44:17Z", "message": "Merge branch 'wce-lock' of github.com:CorfuDB/CorfuDB into wce-lock"}, "afterCommit": {"oid": "281541d3c2049fb2910ace15c71973015b9cda71", "author": {"user": {"login": "PavelZaytsev", "name": "Pavel Zaytsev"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/281541d3c2049fb2910ace15c71973015b9cda71", "committedDate": "2020-08-18T22:50:40Z", "message": "Invoke systemDownHandler in LR in case of WCE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea2e6d60ba086d3ca5816826fe934ef65ff61cd0", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/ea2e6d60ba086d3ca5816826fe934ef65ff61cd0", "committedDate": "2020-08-19T02:57:33Z", "message": "Merge branch 'master' into wce-lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73230e9a2aba7fad452f6090b32a6aa9b7040dfb", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/73230e9a2aba7fad452f6090b32a6aa9b7040dfb", "committedDate": "2020-08-19T04:06:55Z", "message": "Merge branch 'master' into wce-lock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMTExNzMx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#pullrequestreview-470111731", "createdAt": "2020-08-19T04:12:01Z", "commit": {"oid": "73230e9a2aba7fad452f6090b32a6aa9b7040dfb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDoxMjowMVrOHCxUDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDoxMjowMVrOHCxUDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NzE0OA==", "bodyText": "Codacy found an issue: System.exit() should not be used in J2EE/JEE apps", "url": "https://github.com/CorfuDB/CorfuDB/pull/2695#discussion_r472667148", "createdAt": "2020-08-19T04:12:01Z", "author": {"login": "corfudb-bot"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -312,6 +316,7 @@ private CorfuRuntime getCorfuRuntime() {\n                     .keyStore((String) serverContext.getServerConfig().get(\"--keystore\"))\n                     .ksPasswordFile((String) serverContext.getServerConfig().get(\"--keystore-password-file\"))\n                     .tlsEnabled((Boolean) serverContext.getServerConfig().get(\"--enable-tls\"))\n+                    .systemDownHandler(() -> System.exit(SYSTEM_EXIT_ERROR_CODE))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73230e9a2aba7fad452f6090b32a6aa9b7040dfb"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4377, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}