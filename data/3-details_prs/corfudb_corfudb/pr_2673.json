{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4Nzg0MjA1", "number": 2673, "title": "Add option to load data into corfu table", "bodyText": "Using corfu browser we can now load data into a dummy table.\nThis is useful for testing checkpoint issues as well as live testing log-replication feature\nOverview\nDescription:\nWhy should this be merged:\nRelated issue(s) (if applicable): #\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-07-30T00:31:25Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2673", "merged": true, "mergeCommit": {"oid": "37ee3129bc471890980d7ac72c4e06c91ddcdea1"}, "closed": true, "closedAt": "2020-07-31T23:51:41Z", "author": {"login": "hisundar"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc51cLrgBqjM2MDE1NjM1MTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6cdMRgBqjM2MTA3MzUzMDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b444e1a203036c891b7f32cc9b2809bd8f4967d", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/9b444e1a203036c891b7f32cc9b2809bd8f4967d", "committedDate": "2020-07-30T00:28:06Z", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups."}, "afterCommit": {"oid": "8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69", "committedDate": "2020-07-30T01:35:17Z", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MDI3MzU5", "url": "https://github.com/CorfuDB/CorfuDB/pull/2673#pullrequestreview-458027359", "createdAt": "2020-07-30T02:21:45Z", "commit": {"oid": "8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoyMTo0NVrOG5Qr9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwMjoyMzo1OVrOG5QuSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NTQxMw==", "bodyText": "Probably it should be (int)Math.ceil((double)numItems/batchSize);\nImagine 10 entries, in batches of 8, it would return 1, instead of 2.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2673#discussion_r462695413", "createdAt": "2020-07-30T02:21:45Z", "author": {"login": "annym"}, "path": "corfudb-tools/src/main/java/org/corfudb/browser/CorfuStoreBrowser.java", "diffHunk": "@@ -203,4 +206,45 @@ public int dropTable(String namespace, String tablename) {\n         log.info(\"\\n======================\\n\");\n         return tableSize;\n     }\n+\n+    /**\n+     * Loads the table with random data\n+     * @param namespace - the namespace where the table belongs\n+     * @param tablename - table name without the namespace\n+     * @param numItems - total number of items to load\n+     * @param batchSize - number of items in each transaction\n+     * @return - number of entries in the table\n+     */\n+    public int loadTable(String namespace, String tablename, int numItems, int batchSize) {\n+        verifyNamespaceAndTablename(namespace, tablename);\n+        CorfuStore store = new CorfuStore(runtime);\n+        try {\n+            TableOptions.TableOptionsBuilder<Object, Object> optionsBuilder = TableOptions.builder();\n+            if (diskPath != null) {\n+                optionsBuilder.persistentDataPath(Paths.get(diskPath));\n+            }\n+            store.openTable(namespace, tablename,\n+                    TableName.getDefaultInstance().getClass(),\n+                    TableName.getDefaultInstance().getClass(),\n+                    TableName.getDefaultInstance().getClass(),\n+                    optionsBuilder.build());\n+\n+            TableName dummyVal = TableName.newBuilder().setNamespace(namespace).setTableName(tablename).build();\n+            log.info(\"Loading {} items in {} batchSized transactions into {}${}\",\n+                    numItems, batchSize, namespace, tablename);\n+            while (numItems > 0) {\n+                log.info(\"loadTable: Items left {}\", numItems);\n+                TxBuilder tx = store.tx(namespace);\n+                for (int j = batchSize; j > 0 && numItems > 0; j--, numItems--) {\n+                    TableName dummyKey = TableName.newBuilder().setNamespace(Integer.toString(numItems))\n+                            .setTableName(Integer.toString(j)).build();\n+                    tx.update(tablename, dummyKey, dummyVal, dummyVal);\n+                }\n+                tx.commit();\n+            }\n+        } catch (Exception e) {\n+            log.error(\"loadTable: {} {} {} {} failed.\", namespace, tablename, numItems, batchSize, e);\n+        }\n+        return numItems/batchSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY5NjAxMA==", "bodyText": "In line with the above comment probably we should explicitly expect numItems/batchSize (in case someone changes numItems)... or use non-divisible numbers for test completeness.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2673#discussion_r462696010", "createdAt": "2020-07-30T02:23:59Z", "author": {"login": "annym"}, "path": "test/src/test/java/org/corfudb/integration/CorfuStoreBrowserIT.java", "diffHunk": "@@ -132,6 +132,26 @@ public void browserTest() throws\n         Assert.assertEquals(browser.printTableInfo(namespace, tableName), 0);\n     }\n \n+    /**\n+     * Create a table and add data to it using the loadTable command.\n+     * @throws IOException\n+     */\n+    @Test\n+    public void loaderTest() throws IOException {\n+        final String namespace = \"namespace\";\n+        final String tableName = \"table\";\n+        runSinglePersistentServer(corfuSingleNodeHost,\n+                corfuStringNodePort);\n+\n+        // Start a Corfu runtime\n+        runtime = createRuntime(singleNodeEndpoint);\n+        final int numItems = 100;\n+        final int batchSize = 10;\n+\n+        CorfuStoreBrowser browser = new CorfuStoreBrowser(runtime);\n+        Assert.assertEquals(browser.loadTable(namespace, tableName, numItems, batchSize), batchSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/8e2cf9aa9f3d80dfe1859ec9a366e5882f644b69", "committedDate": "2020-07-30T01:35:17Z", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups."}, "afterCommit": {"oid": "b753a1c37760e2c904b77b0e204103868e873cf7", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b753a1c37760e2c904b77b0e204103868e873cf7", "committedDate": "2020-07-31T18:28:47Z", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDIxNTQ3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2673#pullrequestreview-459421547", "createdAt": "2020-07-31T19:43:16Z", "commit": {"oid": "b753a1c37760e2c904b77b0e204103868e873cf7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NDIyOTk0", "url": "https://github.com/CorfuDB/CorfuDB/pull/2673#pullrequestreview-459422994", "createdAt": "2020-07-31T19:45:59Z", "commit": {"oid": "b753a1c37760e2c904b77b0e204103868e873cf7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b753a1c37760e2c904b77b0e204103868e873cf7", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b753a1c37760e2c904b77b0e204103868e873cf7", "committedDate": "2020-07-31T18:28:47Z", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups."}, "afterCommit": {"oid": "6238336345f671eb7efdf8c5123a66ba2e7deb00", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/6238336345f671eb7efdf8c5123a66ba2e7deb00", "committedDate": "2020-07-31T22:30:55Z", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af11f7a8a5192b1caf5cacde2f04f5449235a988", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/af11f7a8a5192b1caf5cacde2f04f5449235a988", "committedDate": "2020-07-31T23:02:42Z", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6238336345f671eb7efdf8c5123a66ba2e7deb00", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/6238336345f671eb7efdf8c5123a66ba2e7deb00", "committedDate": "2020-07-31T22:30:55Z", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups."}, "afterCommit": {"oid": "af11f7a8a5192b1caf5cacde2f04f5449235a988", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/af11f7a8a5192b1caf5cacde2f04f5449235a988", "committedDate": "2020-07-31T23:02:42Z", "message": "CorfuStoreBrowser: add option to load data into a table\n\nthis is useful for testing checkpoint issues in live setups."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4334, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}