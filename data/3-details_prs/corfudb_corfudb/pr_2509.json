{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0ODQ5NTQz", "number": 2509, "title": "CorfuStore: retry internal txns on openTable", "bodyText": "Overview\nDescription:\nConsumers of CorfuStore are ok expecting their transactions aborting due to conflict but prefer that internal transactions like the one in openTable() be retried automatically on failure\nWhy should this be merged:\nRelated issue(s) (if applicable): #\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-04-17T00:00:22Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509", "merged": true, "mergeCommit": {"oid": "69ffc3c4b946452fd479b2628492fe861325d834"}, "closed": true, "closedAt": "2020-04-27T19:04:19Z", "author": {"login": "hisundar"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYYIMQAFqTM5NTEyNjMxOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbz0IMAFqTQwMTIyODM2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTI2MzE5", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#pullrequestreview-395126319", "createdAt": "2020-04-17T02:46:56Z", "commit": {"oid": "4f748641536632cb5c2dc9f7d090859534d4dca0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODc5ODY4", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#pullrequestreview-395879868", "createdAt": "2020-04-18T04:18:47Z", "commit": {"oid": "4f748641536632cb5c2dc9f7d090859534d4dca0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwNDoxODo0N1rOGHlmIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwNDoxODo0N1rOGHlmIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDYwOTE4NQ==", "bodyText": "Is it possible that before calling TXEnd(), while doing put, it will throw a transaction abort exception and the tx.end() is never called?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r410609185", "createdAt": "2020-04-18T04:18:47Z", "author": {"login": "xiaoqin2012"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/TableRegistry.java", "diffHunk": "@@ -178,17 +179,21 @@ void registerTable(@Nonnull String namespace,\n                 log.debug(\"registerTable: new schema:\"+tableDescriptors.getFileDescriptorsMap());\n             }\n         }\n-        try {\n-            this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n-            if (hasSchemaChanged) {\n-                this.registryTable.put(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n-            } else {\n-                this.registryTable.putIfAbsent(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+        int numRetries = 3; // Since this is an internal transaction, retry a few times before giving up.\n+        while (numRetries-- > 0) {\n+            try {\n+                this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n+                if (hasSchemaChanged) {\n+                    this.registryTable.put(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                } else {\n+                    this.registryTable.putIfAbsent(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                }\n+                this.runtime.getObjectsView().TXEnd();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f748641536632cb5c2dc9f7d090859534d4dca0"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9b67e146bdb7fcc4ac4990b367457e9797f1264", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/f9b67e146bdb7fcc4ac4990b367457e9797f1264", "committedDate": "2020-04-23T00:38:26Z", "message": "Merge branch 'master' into retryOpenTable"}, "afterCommit": {"oid": "1b71a80b4f13cb22e5f5f1565cddaef526fda67b", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/1b71a80b4f13cb22e5f5f1565cddaef526fda67b", "committedDate": "2020-04-24T21:34:00Z", "message": "CorfuStore: retry internal txns on openTable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/929617d73fec8dd9b350b027c3e31c2b61f6b7ac", "committedDate": "2020-04-25T06:34:10Z", "message": "CorfuStore: retry internal txns on openTable\n\nClients don't mind retrying transactions they started\nbut prefer internal transactions not started by them\nto be retried automatically.\nopenTable() transaction can abort if multiple nodes\nare comming up at the exact same time, so retrying\nwould be a safe operation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cab047fbbc41c87b0949d57e2d9c96ef2a6115fc", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/cab047fbbc41c87b0949d57e2d9c96ef2a6115fc", "committedDate": "2020-04-25T02:54:38Z", "message": "Merge branch 'master' into retryOpenTable"}, "afterCommit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac", "author": {"user": {"login": "hisundar", "name": "Sundar Sridharan"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/929617d73fec8dd9b350b027c3e31c2b61f6b7ac", "committedDate": "2020-04-25T06:34:10Z", "message": "CorfuStore: retry internal txns on openTable\n\nClients don't mind retrying transactions they started\nbut prefer internal transactions not started by them\nto be retried automatically.\nopenTable() transaction can abort if multiple nodes\nare comming up at the exact same time, so retrying\nwould be a safe operation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjIxMTU0", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#pullrequestreview-401221154", "createdAt": "2020-04-27T18:33:59Z", "commit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozMzo1OVrOGMx5fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozMzo1OVrOGMx5fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1MzYyOQ==", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r416053629", "createdAt": "2020-04-27T18:33:59Z", "author": {"login": "corfudb-bot"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "diffHunk": "@@ -282,6 +283,30 @@ public void checkMetadataTransactions() throws Exception {\n         }\n     }\n \n+    /**\n+     * Demonstrates that opening same table from multiple threads will retry internal transactions\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void checkOpenRetriesTXN() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjIxMTY4", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#pullrequestreview-401221168", "createdAt": "2020-04-27T18:34:00Z", "commit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozNDowMFrOGMx5iA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozNDowMFrOGMx5iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1MzY0MA==", "bodyText": "Issue found: Avoid unused imports such as 'org.corfudb.runtime.exceptions.TransactionAbortedException'", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r416053640", "createdAt": "2020-04-27T18:34:00Z", "author": {"login": "corfudb-bot"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "diffHunk": "@@ -11,6 +11,7 @@\n import org.corfudb.runtime.CorfuRuntime;\n import org.corfudb.runtime.CorfuStoreMetadata;\n import org.corfudb.runtime.CorfuStoreMetadata.Timestamp;\n+import org.corfudb.runtime.exceptions.TransactionAbortedException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjIxMTg2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#pullrequestreview-401221186", "createdAt": "2020-04-27T18:34:01Z", "commit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozNDowMVrOGMx5nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozNDowMVrOGMx5nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1MzY2MA==", "bodyText": "Issue found: Unused import - org.corfudb.runtime.exceptions.TransactionAbortedException.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r416053660", "createdAt": "2020-04-27T18:34:01Z", "author": {"login": "corfudb-bot"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "diffHunk": "@@ -11,6 +11,7 @@\n import org.corfudb.runtime.CorfuRuntime;\n import org.corfudb.runtime.CorfuStoreMetadata;\n import org.corfudb.runtime.CorfuStoreMetadata.Timestamp;\n+import org.corfudb.runtime.exceptions.TransactionAbortedException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjI4MzY4", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#pullrequestreview-401228368", "createdAt": "2020-04-27T18:44:08Z", "commit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3228, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}