{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NTE4MTM3", "number": 2705, "title": "Fix Lock ITs", "bodyText": "#Overview\nDescription:\n\nIntermittent failures due to race condition on FSM transition which affects all other 3 tests in LockIT.\n\nWhy should this be merged: stabilize Lock ITs\nRelated issue(s) (if applicable): #2700\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-08-12T05:23:19Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2705", "merged": true, "mergeCommit": {"oid": "ec7ef72824d75397209acabf6ed9c2219a7f7056"}, "closed": true, "closedAt": "2020-08-13T18:54:26Z", "author": {"login": "annym"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-NGOSgFqTQ2NjAyNTY2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-krcIgFqTQ2NzA0Mzk1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MDI1NjYw", "url": "https://github.com/CorfuDB/CorfuDB/pull/2705#pullrequestreview-466025660", "createdAt": "2020-08-12T15:24:57Z", "commit": {"oid": "284795a4b1864c4670a639c88fc3b6234fbabd73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MTY5NzE1", "url": "https://github.com/CorfuDB/CorfuDB/pull/2705#pullrequestreview-466169715", "createdAt": "2020-08-12T18:29:33Z", "commit": {"oid": "284795a4b1864c4670a639c88fc3b6234fbabd73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MTk2MjY2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2705#pullrequestreview-466196266", "createdAt": "2020-08-12T19:07:55Z", "commit": {"oid": "284795a4b1864c4670a639c88fc3b6234fbabd73"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxOTowNzo1NVrOG_uw8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxOTowNzo1NVrOG_uw8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ3OTY2Ng==", "bodyText": "Shouldn't there be a sleep here?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2705#discussion_r469479666", "createdAt": "2020-08-12T19:07:55Z", "author": {"login": "Maithem"}, "path": "test/src/test/java/org/corfudb/integration/LockIT.java", "diffHunk": "@@ -153,13 +153,18 @@ public void testSingleLockClientMultipleLocks() throws Exception {\n             // Since this is the only client, ALL locks should've been acquired, verify, block until condition is met\n             waitCondition = WaitConditionType.LOCK_ACQUIRED;\n             for (int i=0; i<numLocks; i++) {\n-                log.debug(\"***** Wait until lock \" + i + \" is acquired\");\n+                log.debug(\"***** Wait until lock {} is acquired\", i);\n                 blockUntilWaitCondition.acquire();\n             }\n \n             assertThat(lockAcquiredObservables.get(clientId).getValue()).isEqualTo(numLocks);\n-            lockIds.forEach(lockId ->\n-                assertThat(client.getLocks().get(lockId).getState().getType()).isEqualTo(LockStateType.HAS_LEASE));\n+            lockIds.forEach(lockId -> {\n+                    while(client.getLocks().get(lockId).getState().getType() != LockStateType.HAS_LEASE) {\n+                        // Lock state might take longer to update as the listener is updated before the FSM transitions\n+                        // to the new state\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "284795a4b1864c4670a639c88fc3b6234fbabd73"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2Mjc4MDIz", "url": "https://github.com/CorfuDB/CorfuDB/pull/2705#pullrequestreview-466278023", "createdAt": "2020-08-12T21:07:05Z", "commit": {"oid": "284795a4b1864c4670a639c88fc3b6234fbabd73"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMTowNzowNVrOG_y5KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMTowNzoyMlrOG_y5uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU0NzMwNQ==", "bodyText": "can we add the comment from line 238 here as well?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2705#discussion_r469547305", "createdAt": "2020-08-12T21:07:05Z", "author": {"login": "pankti-m"}, "path": "test/src/test/java/org/corfudb/integration/LockIT.java", "diffHunk": "@@ -230,17 +235,25 @@ public void testMultipleLockClientsSameLock() throws Exception {\n             }\n \n             // Verify that only one client has acquired the lock\n-            List<LockClient> clientsWithLock = getClientsThatAcquiredLock(lockId, clientIdToLockClient);\n+            // We might need to verify for several cycles as\n+            // the observable indicating the lock was acquired is\n+            // triggered before the state update\n+            List<LockClient> clientsWithLock;\n+            do {\n+                clientsWithLock = getClientsThatAcquiredLock(lockId, clientIdToLockClient);\n+            } while (clientsWithLock == null || clientsWithLock.isEmpty());\n+\n             assertThat(clientsWithLock.size()).isEqualTo(1);\n             LockClient clientWithLock = clientsWithLock.get(0);\n \n-\n             // Verify for 5 cycles that the lock is renewed\n             for (int i=0; i < RENEW_CYCLES; i++) {\n                 log.debug(\"***** Wait until lock is renewed\");\n                 // Wait for the renewal cycle + 1, and verify that the lock is still acquired by the same client\n                 Sleep.sleepUninterruptibly(Duration.ofSeconds(LOCK_TIME_CONSTANT + 1));\n-                clientsWithLock = getClientsThatAcquiredLock(lockId, clientIdToLockClient);\n+                do {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "284795a4b1864c4670a639c88fc3b6234fbabd73"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU0NzQ0OQ==", "bodyText": "comment", "url": "https://github.com/CorfuDB/CorfuDB/pull/2705#discussion_r469547449", "createdAt": "2020-08-12T21:07:22Z", "author": {"login": "pankti-m"}, "path": "test/src/test/java/org/corfudb/integration/LockIT.java", "diffHunk": "@@ -330,7 +350,10 @@ public void testMultipleLockClientsSameLockFailure() throws Exception {\n             }\n \n             // Verify that only one client has acquired the lock\n-            clientsWithLock = getClientsThatAcquiredLock(lockId, clientIdToLockClient);\n+            do {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "284795a4b1864c4670a639c88fc3b6234fbabd73"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cda83faeef9f9cba16e30db287c07f555c30195", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/9cda83faeef9f9cba16e30db287c07f555c30195", "committedDate": "2020-08-13T05:25:56Z", "message": "Fix Lock ITs\n\n- Intermittent failures due to race condition on FSM transition."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "284795a4b1864c4670a639c88fc3b6234fbabd73", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/284795a4b1864c4670a639c88fc3b6234fbabd73", "committedDate": "2020-08-12T05:19:33Z", "message": "Fix Lock ITs\n\n- Intermittent failures due to race condition on FSM transition."}, "afterCommit": {"oid": "9cda83faeef9f9cba16e30db287c07f555c30195", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/9cda83faeef9f9cba16e30db287c07f555c30195", "committedDate": "2020-08-13T05:25:56Z", "message": "Fix Lock ITs\n\n- Intermittent failures due to race condition on FSM transition."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDQzOTUx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2705#pullrequestreview-467043951", "createdAt": "2020-08-13T18:53:25Z", "commit": {"oid": "9cda83faeef9f9cba16e30db287c07f555c30195"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4407, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}