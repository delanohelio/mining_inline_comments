{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0MDE3NjU0", "number": 2841, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMTo0NToxNlrOFCE95w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMjo0MDowNlrOFCF3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NzIyODU1OnYy", "diffSide": "LEFT", "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMTo0NToxNlrOIBC-TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODo0MzowMFrOIBwYuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk2ODIwNQ==", "bodyText": "You can probably check if a logger was defined or not with Logger::isInfoEnabled", "url": "https://github.com/CorfuDB/CorfuDB/pull/2841#discussion_r537968205", "createdAt": "2020-12-08T01:45:16Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -847,13 +848,9 @@ private CorfuRuntime(@Nonnull CorfuRuntimeParameters parameters) {\n                 this.parameters.getMicroMeterRuntimeConfig();\n \n         if (microMeterRuntimeConfig.metricsEnabled) {\n-            LoggerContext context =  (LoggerContext) LoggerFactory.getILoggerFactory();\n-            registry = Optional.ofNullable(context.exists(microMeterRuntimeConfig.configuredLoggerName))\n-                    .map(logger -> MeterRegistryProvider.MeterRegistryInitializer.newInstance(logger,\n+            Logger logger = LoggerFactory.getLogger(microMeterRuntimeConfig.configuredLoggerName);\n+            registry = Optional.of(MeterRegistryInitializer.newInstance(logger,\n                             microMeterRuntimeConfig.loggingInterval, parameters.clientId));\n-            if (!registry.isPresent()) {\n-                log.warn(\"Logger was not found to enable metrics.\");\n-            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0b98e4a1585842049a444fdb181f9bcd34dc02d"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODcxMjI1MQ==", "bodyText": "done", "url": "https://github.com/CorfuDB/CorfuDB/pull/2841#discussion_r538712251", "createdAt": "2020-12-08T18:43:00Z", "author": {"login": "PavelZaytsev"}, "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -847,13 +848,9 @@ private CorfuRuntime(@Nonnull CorfuRuntimeParameters parameters) {\n                 this.parameters.getMicroMeterRuntimeConfig();\n \n         if (microMeterRuntimeConfig.metricsEnabled) {\n-            LoggerContext context =  (LoggerContext) LoggerFactory.getILoggerFactory();\n-            registry = Optional.ofNullable(context.exists(microMeterRuntimeConfig.configuredLoggerName))\n-                    .map(logger -> MeterRegistryProvider.MeterRegistryInitializer.newInstance(logger,\n+            Logger logger = LoggerFactory.getLogger(microMeterRuntimeConfig.configuredLoggerName);\n+            registry = Optional.of(MeterRegistryInitializer.newInstance(logger,\n                             microMeterRuntimeConfig.loggingInterval, parameters.clientId));\n-            if (!registry.isPresent()) {\n-                log.warn(\"Logger was not found to enable metrics.\");\n-            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk2ODIwNQ=="}, "originalCommit": {"oid": "c0b98e4a1585842049a444fdb181f9bcd34dc02d"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NzI4NTczOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMjowNToyN1rOIBDfAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODo0Mjo1MVrOIBwYaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3NjU3OA==", "bodyText": "What if two different suppliers are passed?\nI don't think its a good idea to just silently print a warning message.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2841#discussion_r537976578", "createdAt": "2020-12-08T02:05:27Z", "author": {"login": "Maithem"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -70,7 +72,8 @@ public static synchronized void init(Logger logger, Duration loggingInterval, St\n \n         private static void init(Supplier<Optional<MeterRegistry>> meterRegistrySupplier) {\n             if (meterRegistry.isPresent()) {\n-                throw new IllegalStateException(\"Registry has already been initialized.\");\n+                log.warn(\"Registry has already been initialized.\");\n+                return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0b98e4a1585842049a444fdb181f9bcd34dc02d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODcxMjE2OQ==", "bodyText": "I threw exception here and caught it at the places where we initialize a registry. We do need to ignore it for Corfu and Replication servers because otherwise, it would fail on restarts.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2841#discussion_r538712169", "createdAt": "2020-12-08T18:42:51Z", "author": {"login": "PavelZaytsev"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -70,7 +72,8 @@ public static synchronized void init(Logger logger, Duration loggingInterval, St\n \n         private static void init(Supplier<Optional<MeterRegistry>> meterRegistrySupplier) {\n             if (meterRegistry.isPresent()) {\n-                throw new IllegalStateException(\"Registry has already been initialized.\");\n+                log.warn(\"Registry has already been initialized.\");\n+                return;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3NjU3OA=="}, "originalCommit": {"oid": "c0b98e4a1585842049a444fdb181f9bcd34dc02d"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NzM3NTI2OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/HandlerMethods.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMjo0MDowNlrOIBEPtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODo0MToxN1rOIBwSXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk4OTA0NA==", "bodyText": "Should these updates also be made to the RequestHandlerMethods class? This class is only responsible for CorfuMsg types and does not take into account the server handler methods that handle Protobuf messages.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2841#discussion_r537989044", "createdAt": "2020-12-08T02:40:06Z", "author": {"login": "zfrenette"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/HandlerMethods.java", "diffHunk": "@@ -207,10 +207,14 @@ private void registerMethod(@Nonnull final MethodHandles.Lookup caller,\n     // Create a timer using cached timer name for the corresponding type\n     private Optional<Timer> getTimer(@Nonnull CorfuMsgType type) {\n         timerNameCache.computeIfAbsent(type,\n-                                       aType -> (CorfuComponent.INFRA_MSG_HANDLER +\n-                                                 aType.name().toLowerCase()));\n+                aType -> (CorfuComponent.INFRA_MSG_HANDLER +\n+                        aType.name().toLowerCase()));\n+        double[] percentiles = new double[]{0.50, 0.95, 0.99};\n \n         return MeterRegistryProvider.getInstance()\n-                .map(registry -> Timer.builder(timerNameCache.get(type)).register(registry));\n+                .map(registry -> Timer.builder(timerNameCache.get(type))\n+                        .publishPercentiles(percentiles)\n+                        .publishPercentileHistogram(true)\n+                        .register(registry));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd270fe8a09f61cf8378c7878004bf21038a9639"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODcxMDYyMA==", "bodyText": "Did not know about RequestHandlerMethods. I'll address in a separate PR, because this one is mostly to remove dependencies on logback.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2841#discussion_r538710620", "createdAt": "2020-12-08T18:41:17Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/HandlerMethods.java", "diffHunk": "@@ -207,10 +207,14 @@ private void registerMethod(@Nonnull final MethodHandles.Lookup caller,\n     // Create a timer using cached timer name for the corresponding type\n     private Optional<Timer> getTimer(@Nonnull CorfuMsgType type) {\n         timerNameCache.computeIfAbsent(type,\n-                                       aType -> (CorfuComponent.INFRA_MSG_HANDLER +\n-                                                 aType.name().toLowerCase()));\n+                aType -> (CorfuComponent.INFRA_MSG_HANDLER +\n+                        aType.name().toLowerCase()));\n+        double[] percentiles = new double[]{0.50, 0.95, 0.99};\n \n         return MeterRegistryProvider.getInstance()\n-                .map(registry -> Timer.builder(timerNameCache.get(type)).register(registry));\n+                .map(registry -> Timer.builder(timerNameCache.get(type))\n+                        .publishPercentiles(percentiles)\n+                        .publishPercentileHistogram(true)\n+                        .register(registry));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk4OTA0NA=="}, "originalCommit": {"oid": "fd270fe8a09f61cf8378c7878004bf21038a9639"}, "originalPosition": 90}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1650, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}