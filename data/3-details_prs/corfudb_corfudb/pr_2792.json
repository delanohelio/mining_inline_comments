{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0NTE1MTk4", "number": 2792, "title": "Use Node Id to match topology for LR", "bodyText": "Overview\nDescription:\nWhy should this be merged:\nRelated issue(s) (if applicable): #\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-10-16T03:14:52Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792", "merged": true, "mergeCommit": {"oid": "5017c6f42c86c2f9c962a5610da99e7d1b106ce4"}, "closed": true, "closedAt": "2020-10-20T20:06:32Z", "author": {"login": "zhangn49"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdS-X2NABqjM4ODQ0NjgxNjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTOUIDgFqTUxMDgzNDUyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ac7447c35dda4973c0835e3a6ed2342ff82e6ca", "author": {"user": {"login": "zhangn49", "name": "Nan Zhang"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/0ac7447c35dda4973c0835e3a6ed2342ff82e6ca", "committedDate": "2020-10-16T02:04:33Z", "message": "Use node_id to match topology in LR"}, "afterCommit": {"oid": "c858ef56eaab0b4a7dbfa6f9f14a323dba69162f", "author": {"user": {"login": "zhangn49", "name": "Nan Zhang"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c858ef56eaab0b4a7dbfa6f9f14a323dba69162f", "committedDate": "2020-10-16T04:07:50Z", "message": "Use node_id to match topology in LR"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c858ef56eaab0b4a7dbfa6f9f14a323dba69162f", "author": {"user": {"login": "zhangn49", "name": "Nan Zhang"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/c858ef56eaab0b4a7dbfa6f9f14a323dba69162f", "committedDate": "2020-10-16T04:07:50Z", "message": "Use node_id to match topology in LR"}, "afterCommit": {"oid": "b2b5223b23c2cf4967cd7cb402abf996a1b65e66", "author": {"user": {"login": "zhangn49", "name": "Nan Zhang"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/b2b5223b23c2cf4967cd7cb402abf996a1b65e66", "committedDate": "2020-10-16T04:13:22Z", "message": "Use node_id to match topology in LR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNzIwNzk0", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#pullrequestreview-510720794", "createdAt": "2020-10-16T18:46:57Z", "commit": {"oid": "d32ba3151aeb089115ef9acc13343d2ed0a8cb32"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxODo0Njo1N1rOHjMKNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxODo0ODo1MVrOHjMNyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY2MTQyOA==", "bodyText": "can we add a logging warning if no Node Id file path is found?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#discussion_r506661428", "createdAt": "2020-10-16T18:46:57Z", "author": {"login": "annym"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -864,4 +875,20 @@ private void updateReplicationStatus() {\n             statusFlag = true;\n         }\n     }\n+\n+    private void setupLocalNodeId() {\n+        // Retrieve system-specific node id\n+        LogReplicationPluginConfig config = new LogReplicationPluginConfig(serverContext.getPluginConfigFilePath());\n+        String nodeIdFilePath = config.getNodeIdFilePath();\n+        if (nodeIdFilePath != null) {\n+            File nodeIdFile = new File(nodeIdFilePath);\n+            try (BufferedReader bufferedReader = new BufferedReader(new FileReader(nodeIdFile))) {\n+                String line = bufferedReader.readLine();\n+                localNodeId = Optional.of(line.split(\"=\")[1].trim().toLowerCase());\n+                log.info(\"setupLocalNodeId succeeded, node id is {}\", localNodeId);\n+            } catch (Exception e) {\n+                log.warn(\"setupLocalNodeId failed\", e);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d32ba3151aeb089115ef9acc13343d2ed0a8cb32"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY2MjM0Ng==", "bodyText": "Can you add a comment on the method that specifies the format in which the node must be written in this file? for future reference..", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#discussion_r506662346", "createdAt": "2020-10-16T18:48:51Z", "author": {"login": "annym"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/plugins/LogReplicationPluginConfig.java", "diffHunk": "@@ -83,6 +86,8 @@ public LogReplicationPluginConfig(String filepath) {\n \n             this.topologyManagerAdapterJARPath = prop.getProperty(\"topology_manager_adapter_JAR_path\");\n             this.topologyManagerAdapterName = prop.getProperty(\"topology_manager_adapter_class_name\");\n+\n+            this.nodeIdFilePath = prop.getProperty(\"local_node_id_path\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d32ba3151aeb089115ef9acc13343d2ed0a8cb32"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47c5323c80c5e0dcf11430d27e36ff598dfd1cd1", "author": {"user": {"login": "zhangn49", "name": "Nan Zhang"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/47c5323c80c5e0dcf11430d27e36ff598dfd1cd1", "committedDate": "2020-10-16T19:05:41Z", "message": "Use node_id to match topology in LR\n\nAddressed comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d32ba3151aeb089115ef9acc13343d2ed0a8cb32", "author": {"user": {"login": "zhangn49", "name": "Nan Zhang"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/d32ba3151aeb089115ef9acc13343d2ed0a8cb32", "committedDate": "2020-10-16T17:47:35Z", "message": "Merge branch 'master' into node_id_match"}, "afterCommit": {"oid": "47c5323c80c5e0dcf11430d27e36ff598dfd1cd1", "author": {"user": {"login": "zhangn49", "name": "Nan Zhang"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/47c5323c80c5e0dcf11430d27e36ff598dfd1cd1", "committedDate": "2020-10-16T19:05:41Z", "message": "Use node_id to match topology in LR\n\nAddressed comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODMzNDY3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#pullrequestreview-510833467", "createdAt": "2020-10-16T22:38:36Z", "commit": {"oid": "47c5323c80c5e0dcf11430d27e36ff598dfd1cd1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMjozODozNlrOHjRk5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMjozODozNlrOHjRk5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc1MDE4Mw==", "bodyText": "can we only say 'nodeId format'?  what does 'file' mean here?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#discussion_r506750183", "createdAt": "2020-10-16T22:38:36Z", "author": {"login": "pankti-m"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/plugins/LogReplicationPluginConfig.java", "diffHunk": "@@ -67,6 +67,11 @@\n     @Getter\n     private String snapshotSyncPluginCanonicalName;\n \n+    // nodeId file format:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47c5323c80c5e0dcf11430d27e36ff598dfd1cd1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODM0NTI2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2792#pullrequestreview-510834526", "createdAt": "2020-10-16T22:42:27Z", "commit": {"oid": "47c5323c80c5e0dcf11430d27e36ff598dfd1cd1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4100, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}