{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NjEzNzMx", "number": 2825, "reviewThreads": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozNDoyM1rOE4WAlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMToxNzowNVrOE6xOtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTE2MzA4OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozNDoyM1rOHyNVzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMToyMjo0NlrOH6IpJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwOTQyMg==", "bodyText": "private?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522409422", "createdAt": "2020-11-12T20:34:23Z", "author": {"login": "xnull"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -41,6 +62,22 @@ public static synchronized void init(Logger logger, Duration loggingInterval,\n             init(loggingInterval, localEndpoint, influxLineProtocolLoggingSink);\n         }\n \n+        /**\n+         * Configure the meter registry of type LoggingMeterRegistry. All the metrics registered\n+         * with this meter registry will be exported in the InfluxDB line protocol format\n+         * (https://docs.influxdata.com/influxdb/v1.8/write_protocols/line_protocol_tutorial/)\n+         * with  the provided loggingInterval frequency.\n+         * @param logger A configured logger.\n+         * @param loggingInterval A duration between log appends for every metric.\n+         */\n+        public static synchronized void init(Logger logger, Duration loggingInterval) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee45ca813e2c97d3410f6754905ae183be31cb00"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMTA2MQ==", "bodyText": "Needs to be public to initialize it.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530721061", "createdAt": "2020-11-26T01:22:46Z", "author": {"login": "PavelZaytsev"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MeterRegistryProvider.java", "diffHunk": "@@ -41,6 +62,22 @@ public static synchronized void init(Logger logger, Duration loggingInterval,\n             init(loggingInterval, localEndpoint, influxLineProtocolLoggingSink);\n         }\n \n+        /**\n+         * Configure the meter registry of type LoggingMeterRegistry. All the metrics registered\n+         * with this meter registry will be exported in the InfluxDB line protocol format\n+         * (https://docs.influxdata.com/influxdb/v1.8/write_protocols/line_protocol_tutorial/)\n+         * with  the provided loggingInterval frequency.\n+         * @param logger A configured logger.\n+         * @param loggingInterval A duration between log appends for every metric.\n+         */\n+        public static synchronized void init(Logger logger, Duration loggingInterval) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwOTQyMg=="}, "originalCommit": {"oid": "ee45ca813e2c97d3410f6754905ae183be31cb00"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTE3ODI5OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MicroMeterUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozODozNFrOHyNemQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMToyMzo1M1rOH6IqFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQxMTY3Mw==", "bodyText": "looks like we don't need another future here, it's enough just stop the timer", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522411673", "createdAt": "2020-11-12T20:38:34Z", "author": {"login": "xnull"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MicroMeterUtils.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.corfudb.common.metrics.micrometer;\n+\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Timer;\n+\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+\n+public class MicroMeterUtils {\n+\n+    private MicroMeterUtils() {\n+\n+    }\n+\n+    public static <T> CompletableFuture<T> timeWhenCompletes(CompletableFuture<T> future,\n+                                                             Optional<Timer.Sample> maybeSample,\n+                                                             String timerName, String... tags) {\n+        if (timerName.isEmpty() || tags.length % 2 != 0) {\n+            throw new IllegalArgumentException(\"Name of the registered timer should be present and\" +\n+                    \" the number of tags should be even.\");\n+        }\n+        Optional<MeterRegistry> maybeRegistry = MeterRegistryProvider.getInstance();\n+        if (maybeRegistry.isPresent() && maybeSample.isPresent()) {\n+            MeterRegistry meterRegistry = maybeRegistry.get();\n+            Timer.Sample sample = maybeSample.get();\n+            CompletableFuture<T> cf = new CompletableFuture<>();\n+            future.whenComplete((res, ex) -> {\n+                sample.stop(meterRegistry.timer(timerName, tags));\n+                if (ex != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee45ca813e2c97d3410f6754905ae183be31cb00"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMTMwMg==", "bodyText": "Here I need to stop the timer no matter what and return the original result or the exception. I did not find another way of doing it.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530721302", "createdAt": "2020-11-26T01:23:53Z", "author": {"login": "PavelZaytsev"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/MicroMeterUtils.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.corfudb.common.metrics.micrometer;\n+\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Timer;\n+\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+\n+public class MicroMeterUtils {\n+\n+    private MicroMeterUtils() {\n+\n+    }\n+\n+    public static <T> CompletableFuture<T> timeWhenCompletes(CompletableFuture<T> future,\n+                                                             Optional<Timer.Sample> maybeSample,\n+                                                             String timerName, String... tags) {\n+        if (timerName.isEmpty() || tags.length % 2 != 0) {\n+            throw new IllegalArgumentException(\"Name of the registered timer should be present and\" +\n+                    \" the number of tags should be even.\");\n+        }\n+        Optional<MeterRegistry> maybeRegistry = MeterRegistryProvider.getInstance();\n+        if (maybeRegistry.isPresent() && maybeSample.isPresent()) {\n+            MeterRegistry meterRegistry = maybeRegistry.get();\n+            Timer.Sample sample = maybeSample.get();\n+            CompletableFuture<T> cf = new CompletableFuture<>();\n+            future.whenComplete((res, ex) -> {\n+                sample.stop(meterRegistry.timer(timerName, tags));\n+                if (ex != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQxMTY3Mw=="}, "originalCommit": {"oid": "ee45ca813e2c97d3410f6754905ae183be31cb00"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTU0OTMzOnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoyNTowOVrOHyRFZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoyNTowOVrOHyRFZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3MDc1Ng==", "bodyText": "let's throw LogUnitException", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522470756", "createdAt": "2020-11-12T22:25:09Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "diffHunk": "@@ -125,7 +156,20 @@ private void processor() {\n                     lastOp = null;\n                 } else if (currOp == BatchWriterOperation.SHUTDOWN) {\n                     log.warn(\"Shutting down the write processor\");\n-                    streamLog.sync(true);\n+                    Runnable fsyncRunnable = () -> {\n+                        try {\n+                            streamLog.sync(true);\n+                        } catch (IOException e) {\n+                            throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTU1Njk5OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoyNzo0OFrOHyRKDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMToyNTo0MlrOH6IsDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3MTk0OQ==", "bodyText": "Let's get rid of code duplication by method extraction\nprivate void yay(Runnable fsyncRunnable, Optional<Timer> fsyncTimer) {\n        if (fsyncTimer.isPresent()) {\n            fsyncTimer.get().record(fsyncRunnable);\n        } else {\n            fsyncRunnable.run();\n        }\n    }", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522471949", "createdAt": "2020-11-12T22:27:48Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "diffHunk": "@@ -154,11 +198,24 @@ private void processor() {\n                                 break;\n                             case WRITE:\n                                 WriteRequest write = (WriteRequest) currOp.getMsg().getPayload();\n-                                streamLog.append(write.getGlobalAddress(), (LogData) write.getData());\n+                                Runnable append =\n+                                        () -> streamLog.append(write.getGlobalAddress(), (LogData) write.getData());\n+                                if (writeRecordTimer.isPresent()) {\n+                                    writeRecordTimer.get().record(append);\n+                                }\n+                                else {\n+                                    append.run();\n+                                }\n                                 break;\n                             case RANGE_WRITE:\n                                 RangeWriteMsg writeRange = (RangeWriteMsg) currOp.getMsg().getPayload();\n-                                streamLog.append(writeRange.getEntries());\n+                                Runnable appendMultiple = () -> streamLog.append(writeRange.getEntries());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMTgwNw==", "bodyText": "Sounds good", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530721807", "createdAt": "2020-11-26T01:25:42Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "diffHunk": "@@ -154,11 +198,24 @@ private void processor() {\n                                 break;\n                             case WRITE:\n                                 WriteRequest write = (WriteRequest) currOp.getMsg().getPayload();\n-                                streamLog.append(write.getGlobalAddress(), (LogData) write.getData());\n+                                Runnable append =\n+                                        () -> streamLog.append(write.getGlobalAddress(), (LogData) write.getData());\n+                                if (writeRecordTimer.isPresent()) {\n+                                    writeRecordTimer.get().record(append);\n+                                }\n+                                else {\n+                                    append.run();\n+                                }\n                                 break;\n                             case RANGE_WRITE:\n                                 RangeWriteMsg writeRange = (RangeWriteMsg) currOp.getMsg().getPayload();\n-                                streamLog.append(writeRange.getEntries());\n+                                Runnable appendMultiple = () -> streamLog.append(writeRange.getEntries());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3MTk0OQ=="}, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTU1ODE4OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoyODoxNlrOHyRK1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMToyODoxMFrOH6IudA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3MjE0OA==", "bodyText": "don't need DURATION suffix", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522472148", "createdAt": "2020-11-12T22:28:16Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -191,6 +193,9 @@\n     // Error code required to detect an ungraceful shutdown.\n     private static final int EXIT_ERROR_CODE = 100;\n \n+    private static final String DEFAULT_METRICS_LOGGER_NAME = \"CorfuMetrics\";\n+\n+    private static final Duration DEFAULT_METRICS_LOGGING_INTERVAL_DURATION = Duration.ofSeconds(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMjQyMA==", "bodyText": "Done", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530722420", "createdAt": "2020-11-26T01:28:10Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -191,6 +193,9 @@\n     // Error code required to detect an ungraceful shutdown.\n     private static final int EXIT_ERROR_CODE = 100;\n \n+    private static final String DEFAULT_METRICS_LOGGER_NAME = \"CorfuMetrics\";\n+\n+    private static final Duration DEFAULT_METRICS_LOGGING_INTERVAL_DURATION = Duration.ofSeconds(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3MjE0OA=="}, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTU5MzU5OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/SequencerServerCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjozOTo1N1rOHyRgCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMToyNzozOVrOH6IuDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3NzU3OQ==", "bodyText": "please rename \"a\" to something else", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522477579", "createdAt": "2020-11-12T22:39:57Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/SequencerServerCache.java", "diffHunk": "@@ -83,9 +87,12 @@ public SequencerServerCache(int cacheSize, long maxConflictNewSequencer) {\n         this.cacheSize = cacheSize;\n         conflictKeys = new HashMap();\n         cacheEntries = new PriorityQueue(cacheSize, Comparator.comparingLong\n-                (a -> ((ConflictTxStream)a).txVersion));\n+                (a -> ((ConflictTxStream) a).txVersion));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMjMxNg==", "bodyText": "done", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530722316", "createdAt": "2020-11-26T01:27:39Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/SequencerServerCache.java", "diffHunk": "@@ -83,9 +87,12 @@ public SequencerServerCache(int cacheSize, long maxConflictNewSequencer) {\n         this.cacheSize = cacheSize;\n         conflictKeys = new HashMap();\n         cacheEntries = new PriorityQueue(cacheSize, Comparator.comparingLong\n-                (a -> ((ConflictTxStream)a).txVersion));\n+                (a -> ((ConflictTxStream) a).txVersion));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3NzU3OQ=="}, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTYyMTAwOnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/log/statetransfer/transferprocessor/ParallelTransferProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjo0OToyM1rOHyRwTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMToyNjoyMVrOH6Isww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4MTc0MQ==", "bodyText": "It seems to me this method is the same as CompletableFuture.allOf(...)", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522481741", "createdAt": "2020-11-12T22:49:23Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/log/statetransfer/transferprocessor/ParallelTransferProcessor.java", "diffHunk": "@@ -65,7 +70,14 @@ public ParallelTransferProcessor(StateTransferBatchProcessor stateTransferBatchP\n                             }\n                         });\n \n-        allFutures = CFUtils.allOfOrTerminateExceptionally(allFutures, batchTransferResult);\n+        CompletableFuture<Void> future = MicroMeterUtils\n+                .timeWhenCompletes(\n+                        batchTransferResult,\n+                        sample,\n+                        \"state-transfer.timer\", \"type\", \"committed\"\n+                );\n+\n+        allFutures = CFUtils.allOfOrTerminateExceptionally(allFutures, future);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMTk4Nw==", "bodyText": "allOf finishes when all the futures finish, here we need to quit once one of the futures terminate exceptionally.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530721987", "createdAt": "2020-11-26T01:26:21Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/log/statetransfer/transferprocessor/ParallelTransferProcessor.java", "diffHunk": "@@ -65,7 +70,14 @@ public ParallelTransferProcessor(StateTransferBatchProcessor stateTransferBatchP\n                             }\n                         });\n \n-        allFutures = CFUtils.allOfOrTerminateExceptionally(allFutures, batchTransferResult);\n+        CompletableFuture<Void> future = MicroMeterUtils\n+                .timeWhenCompletes(\n+                        batchTransferResult,\n+                        sample,\n+                        \"state-transfer.timer\", \"type\", \"committed\"\n+                );\n+\n+        allFutures = CFUtils.allOfOrTerminateExceptionally(allFutures, future);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4MTc0MQ=="}, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTYzOTY0OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/management/FailureDetector.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjo1MzoyN1rOHyR8NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozNDozOFrOH6I1BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NDc4OA==", "bodyText": "It seems to me you can get rid of some boilerplate code if you add a \"timer\" method into MetricRegistryProvider\npublic static void timer(String timerName, String tag, String tag2) {\n        getInstance()\n                .ifPresent(registry -> registry.timer(timerName, tag, tag2));\n    }\n\nthen you can use it:\nMeterRegistryProvider.timer(\"failure-detector.ping-latency\", \"node\", node);", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522484788", "createdAt": "2020-11-12T22:53:27Z", "author": {"login": "xnull"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/management/FailureDetector.java", "diffHunk": "@@ -99,6 +103,10 @@ public PollReport poll(\n         );\n     }\n \n+    private void registerTimerForNodeIfNeeded(String node) {\n+        MeterRegistryProvider.getInstance().ifPresent(registry -> registry.timer(\"failure-detector.ping-latency\", \"node\", node));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNDEwMQ==", "bodyText": "Done", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530724101", "createdAt": "2020-11-26T01:34:38Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/management/FailureDetector.java", "diffHunk": "@@ -99,6 +103,10 @@ public PollReport poll(\n         );\n     }\n \n+    private void registerTimerForNodeIfNeeded(String node) {\n+        MeterRegistryProvider.getInstance().ifPresent(registry -> registry.timer(\"failure-detector.ping-latency\", \"node\", node));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NDc4OA=="}, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTY0NjUyOnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjo1NDo1NFrOHySAnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozNTowNlrOH6I1mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NTkxNw==", "bodyText": "final?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522485917", "createdAt": "2020-11-12T22:54:54Z", "author": {"login": "xnull"}, "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -242,6 +254,8 @@ public static CorfuRuntimeParametersBuilder builder() {\n          */\n         private MetricRegistry metricRegistry;\n \n+        private MicroMeterRuntimeConfig microMeterRuntimeConfig;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNDI0OA==", "bodyText": "done", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530724248", "createdAt": "2020-11-26T01:35:06Z", "author": {"login": "PavelZaytsev"}, "path": "runtime/src/main/java/org/corfudb/runtime/CorfuRuntime.java", "diffHunk": "@@ -242,6 +254,8 @@ public static CorfuRuntimeParametersBuilder builder() {\n          */\n         private MetricRegistry metricRegistry;\n \n+        private MicroMeterRuntimeConfig microMeterRuntimeConfig;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4NTkxNw=="}, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTY2MDUyOnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/view/AddressSpaceView.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjo1Nzo1NFrOHySJTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozNjozOVrOH6I3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4ODE0MA==", "bodyText": "please rename \"l\"", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522488140", "createdAt": "2020-11-12T22:57:54Z", "author": {"login": "xnull"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/AddressSpaceView.java", "diffHunk": "@@ -185,57 +205,69 @@ private void validateStateOfWrittenEntry(long address, @Nonnull ILogData ld) {\n      * @throws WrongEpochException If the token epoch is invalid.\n      */\n     public void write(@Nonnull IToken token, @Nonnull Object data, @Nonnull CacheOption cacheOption) {\n-        ILogData ld;\n-        if (data instanceof ILogData) {\n-            ld = (ILogData) data;\n-        } else {\n-            ld = new LogData(DataType.DATA, data, runtime.getParameters().getCodecType());\n-        }\n \n-        layoutHelper(e -> {\n-            Layout l = e.getLayout();\n-            // Check if the token issued is in the same\n-            // epoch as the layout we are about to write\n-            // to.\n-            if (token.getEpoch() != l.getEpoch()) {\n-                throw new StaleTokenException(l.getEpoch());\n+        Runnable writeRunnable = () -> {\n+            ILogData ld;\n+            if (data instanceof ILogData) {\n+                ld = (ILogData) data;\n+            } else {\n+                ld = new LogData(DataType.DATA, data, runtime.getParameters().getCodecType());\n             }\n \n-            // Set the data to use the token\n-            ld.useToken(token);\n-            ld.setId(runtime.getParameters().getClientId());\n+            logSizeDist.ifPresent(dist -> dist.record(ld.getSizeEstimate()));\n+            layoutHelper(e -> {\n+                Layout l = e.getLayout();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNDY1Nw==", "bodyText": "done", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530724657", "createdAt": "2020-11-26T01:36:39Z", "author": {"login": "PavelZaytsev"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/AddressSpaceView.java", "diffHunk": "@@ -185,57 +205,69 @@ private void validateStateOfWrittenEntry(long address, @Nonnull ILogData ld) {\n      * @throws WrongEpochException If the token epoch is invalid.\n      */\n     public void write(@Nonnull IToken token, @Nonnull Object data, @Nonnull CacheOption cacheOption) {\n-        ILogData ld;\n-        if (data instanceof ILogData) {\n-            ld = (ILogData) data;\n-        } else {\n-            ld = new LogData(DataType.DATA, data, runtime.getParameters().getCodecType());\n-        }\n \n-        layoutHelper(e -> {\n-            Layout l = e.getLayout();\n-            // Check if the token issued is in the same\n-            // epoch as the layout we are about to write\n-            // to.\n-            if (token.getEpoch() != l.getEpoch()) {\n-                throw new StaleTokenException(l.getEpoch());\n+        Runnable writeRunnable = () -> {\n+            ILogData ld;\n+            if (data instanceof ILogData) {\n+                ld = (ILogData) data;\n+            } else {\n+                ld = new LogData(DataType.DATA, data, runtime.getParameters().getCodecType());\n             }\n \n-            // Set the data to use the token\n-            ld.useToken(token);\n-            ld.setId(runtime.getParameters().getClientId());\n+            logSizeDist.ifPresent(dist -> dist.record(ld.getSizeEstimate()));\n+            layoutHelper(e -> {\n+                Layout l = e.getLayout();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4ODE0MA=="}, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 140}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTY2NTU1OnYy", "diffSide": "RIGHT", "path": "test/src/test/java/org/corfudb/integration/AbstractIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjo1OToxMFrOHySMqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozNzowM1rOH6I3ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4OTAwMw==", "bodyText": "please use logger", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r522489003", "createdAt": "2020-11-12T22:59:10Z", "author": {"login": "xnull"}, "path": "test/src/test/java/org/corfudb/integration/AbstractIT.java", "diffHunk": "@@ -511,19 +525,38 @@ public String getOptionsString() {\n          */\n         public Process runServer() throws IOException {\n             final String serverConsoleLogPath = CORFU_LOG_PATH + File.separator + host + \"_\" + port + \"_consolelog\";\n-\n+            System.out.println(serverConsoleLogPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNDc3MQ==", "bodyText": "Was removed", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530724771", "createdAt": "2020-11-26T01:37:03Z", "author": {"login": "PavelZaytsev"}, "path": "test/src/test/java/org/corfudb/integration/AbstractIT.java", "diffHunk": "@@ -511,19 +525,38 @@ public String getOptionsString() {\n          */\n         public Process runServer() throws IOException {\n             final String serverConsoleLogPath = CORFU_LOG_PATH + File.separator + host + \"_\" + port + \"_consolelog\";\n-\n+            System.out.println(serverConsoleLogPath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ4OTAwMw=="}, "originalCommit": {"oid": "0e1ca86b2c19f415f1435c52e13fecc6c911fde7"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDQwNTQzOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/protocoltransformer/influx/TimerInfluxLineTransformer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMTozNzowMlrOHzAXAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozNzoxM1rOH6I30A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0NTMxMg==", "bodyText": "Can you add tests?\nThe regex is not correct. The timer outputs a decimal for throughout and not an integer.\nThe following test will fail\n@Test\n    public void timerTest() {\n        String dataPoint = \"rpc-latency{endpoint=localhost:9000} throughput=3.4/s mean=0.000204964s max=0.001044081s\";\n        TimerInfluxLineTransformer txn = new TimerInfluxLineTransformer();\n        assertThat(txn.test(dataPoint)).isTrue();\n    }\nYou can fix it with\nprotected static final String TIMER_PATTERN_STRING =\n            METRIC_PATTERN_STRING + \" (throughput=[\\\\d.]+/s mean=[\\\\d.]+s max=[\\\\d.]+s)$\";", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r523245312", "createdAt": "2020-11-13T21:37:02Z", "author": {"login": "Maithem"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/protocoltransformer/influx/TimerInfluxLineTransformer.java", "diffHunk": "@@ -23,6 +23,6 @@\n     public boolean test(String s) {\n         Matcher matcher = timerPattern.matcher(s);\n         this.matched = Optional.of(matcher);\n-        return matcher.find();\n+        return matcher.matches();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d8eceac61d0a9491a645d7551b9e9dc40df0401"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNDgxNg==", "bodyText": "Was fixed", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530724816", "createdAt": "2020-11-26T01:37:13Z", "author": {"login": "PavelZaytsev"}, "path": "common/src/main/java/org/corfudb/common/metrics/micrometer/protocoltransformer/influx/TimerInfluxLineTransformer.java", "diffHunk": "@@ -23,6 +23,6 @@\n     public boolean test(String s) {\n         Matcher matcher = timerPattern.matcher(s);\n         this.matched = Optional.of(matcher);\n-        return matcher.find();\n+        return matcher.matches();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI0NTMxMg=="}, "originalCommit": {"oid": "1d8eceac61d0a9491a645d7551b9e9dc40df0401"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDU2MjMyOnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMTowODoxN1rOH2CNkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozNzoyMlrOH6I37w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMTM5Mw==", "bodyText": "This is not the fsync latency, but rather the fsync time of all dirty segments. Based on the current batch + segment size at most it the sum of fsyncing two files.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r526421393", "createdAt": "2020-11-18T21:08:17Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "diffHunk": "@@ -105,7 +123,20 @@ private void processor() {\n \n                     if (currOp == null || processed == BATCH_SIZE\n                             || currOp == BatchWriterOperation.SHUTDOWN) {\n-                        streamLog.sync(sync);\n+                        Runnable fsyncRunnable = () -> {\n+                            try {\n+                                streamLog.sync(sync);\n+                            } catch (IOException e) {\n+                                throw new RuntimeException(e);\n+                            }\n+                        };\n+                        if (fsyncTimer.isPresent()) {\n+                            fsyncTimer.get().record(fsyncRunnable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNDg0Nw==", "bodyText": "Fixed", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530724847", "createdAt": "2020-11-26T01:37:22Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "diffHunk": "@@ -105,7 +123,20 @@ private void processor() {\n \n                     if (currOp == null || processed == BATCH_SIZE\n                             || currOp == BatchWriterOperation.SHUTDOWN) {\n-                        streamLog.sync(sync);\n+                        Runnable fsyncRunnable = () -> {\n+                            try {\n+                                streamLog.sync(sync);\n+                            } catch (IOException e) {\n+                                throw new RuntimeException(e);\n+                            }\n+                        };\n+                        if (fsyncTimer.isPresent()) {\n+                            fsyncTimer.get().record(fsyncRunnable);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMTM5Mw=="}, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDU2ODUxOnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMToxMDowN1rOH2CRTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozNzozMVrOH6I4Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMjM1MA==", "bodyText": "Having a histogram on the batch size/queue size can help answer questions about queuing delay.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r526422350", "createdAt": "2020-11-18T21:10:07Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "diffHunk": "@@ -70,6 +78,16 @@ public BatchProcessor(StreamLog streamLog, long sealEpoch, boolean sync) {\n         this.streamLog = streamLog;\n         operationsQueue = new LinkedBlockingQueue<>();\n         processorService.submit(this::processor);\n+\n+        writeRecordTimer = MeterRegistryProvider.getInstance().map(registry ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNDg5MA==", "bodyText": "Added", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530724890", "createdAt": "2020-11-26T01:37:31Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/BatchProcessor.java", "diffHunk": "@@ -70,6 +78,16 @@ public BatchProcessor(StreamLog streamLog, long sealEpoch, boolean sync) {\n         this.streamLog = streamLog;\n         operationsQueue = new LinkedBlockingQueue<>();\n         processorService.submit(this::processor);\n+\n+        writeRecordTimer = MeterRegistryProvider.getInstance().map(registry ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMjM1MA=="}, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDU3Mjk1OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMToxMToyNVrOH2CT9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozNzo1MVrOH6I4jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMzAyOA==", "bodyText": "This is a really short period given that most of the metrics collected are aggregates.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r526423028", "createdAt": "2020-11-18T21:11:25Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -191,6 +193,9 @@\n     // Error code required to detect an ungraceful shutdown.\n     private static final int EXIT_ERROR_CODE = 100;\n \n+    private static final String DEFAULT_METRICS_LOGGER_NAME = \"CorfuMetrics\";\n+\n+    private static final Duration DEFAULT_METRICS_LOGGING_INTERVAL_DURATION = Duration.ofSeconds(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNTAwNw==", "bodyText": "This was for debugging. Increased to a minute.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530725007", "createdAt": "2020-11-26T01:37:51Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/CorfuServer.java", "diffHunk": "@@ -191,6 +193,9 @@\n     // Error code required to detect an ungraceful shutdown.\n     private static final int EXIT_ERROR_CODE = 100;\n \n+    private static final String DEFAULT_METRICS_LOGGER_NAME = \"CorfuMetrics\";\n+\n+    private static final Duration DEFAULT_METRICS_LOGGING_INTERVAL_DURATION = Duration.ofSeconds(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMzAyOA=="}, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDU3OTA1OnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/LogUnitServerCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMToxMzoxMlrOH2CXxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozODowMVrOH6I4zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyNDAwNg==", "bodyText": "Can you also capture stats on the hit ratio, load time and total weight.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r526424006", "createdAt": "2020-11-18T21:13:12Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/LogUnitServerCache.java", "diffHunk": "@@ -32,13 +38,21 @@\n     //Empirical threshold of number of streams in a logdata beyond which server performance may be slow\n     private final int MAX_STREAM_THRESHOLD = 20;\n \n+    private final Optional<Timer> readTimer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNTA3MQ==", "bodyText": "Added", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530725071", "createdAt": "2020-11-26T01:38:01Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/LogUnitServerCache.java", "diffHunk": "@@ -32,13 +38,21 @@\n     //Empirical threshold of number of streams in a logdata beyond which server performance may be slow\n     private final int MAX_STREAM_THRESHOLD = 20;\n \n+    private final Optional<Timer> readTimer;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyNDAwNg=="}, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDU4MjQwOnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/SequencerServer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMToxNDowNlrOH2CZxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozODoxMVrOH6I49g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyNDUxOQ==", "bodyText": "Can you also capture histogram of the number of queues per transaction.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r526424519", "createdAt": "2020-11-18T21:14:06Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/SequencerServer.java", "diffHunk": "@@ -155,7 +160,8 @@ public SequencerServer(ServerContext serverContext) {\n \n         globalLogTail = Address.getMinAddress();\n         this.cache = new SequencerServerCache(config.getCacheSize(), globalLogTail - 1);\n-        setUpTimerNameCache();\n+        this.txResolutionTimer = MeterRegistryProvider.getInstance().map(registry ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNTExMA==", "bodyText": "Added", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530725110", "createdAt": "2020-11-26T01:38:11Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/SequencerServer.java", "diffHunk": "@@ -155,7 +160,8 @@ public SequencerServer(ServerContext serverContext) {\n \n         globalLogTail = Address.getMinAddress();\n         this.cache = new SequencerServerCache(config.getCacheSize(), globalLogTail - 1);\n-        setUpTimerNameCache();\n+        this.txResolutionTimer = MeterRegistryProvider.getInstance().map(registry ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyNDUxOQ=="}, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDU4NzAyOnYy", "diffSide": "RIGHT", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/SequencerServerCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMToxNToxM1rOH2CcXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTozODoyMFrOH6I5Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyNTE4MQ==", "bodyText": "We need to capture stats on the window size and number of evictions per trim call.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r526425181", "createdAt": "2020-11-18T21:15:13Z", "author": {"login": "Maithem"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/SequencerServerCache.java", "diffHunk": "@@ -81,11 +84,17 @@\n      */\n     public SequencerServerCache(int cacheSize, long maxConflictNewSequencer) {\n         this.cacheSize = cacheSize;\n-        conflictKeys = new HashMap();\n+\n         cacheEntries = new PriorityQueue(cacheSize, Comparator.comparingLong\n-                (a -> ((ConflictTxStream)a).txVersion));\n+                (a -> ((ConflictTxStream) a).txVersion));\n         maxConflictWildcard = maxConflictNewSequencer;\n         this.maxConflictNewSequencer = maxConflictNewSequencer;\n+        conflictKeys = MeterRegistryProvider\n+                .getInstance()\n+                .map(registry ->\n+                        registry.gauge(conflictKeysCounterName, Collections.emptyList(),\n+                                new HashMap<ConflictTxStream, Long>(), HashMap::size))\n+                .orElse(new HashMap<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNTEzOA==", "bodyText": "Added", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530725138", "createdAt": "2020-11-26T01:38:20Z", "author": {"login": "PavelZaytsev"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/SequencerServerCache.java", "diffHunk": "@@ -81,11 +84,17 @@\n      */\n     public SequencerServerCache(int cacheSize, long maxConflictNewSequencer) {\n         this.cacheSize = cacheSize;\n-        conflictKeys = new HashMap();\n+\n         cacheEntries = new PriorityQueue(cacheSize, Comparator.comparingLong\n-                (a -> ((ConflictTxStream)a).txVersion));\n+                (a -> ((ConflictTxStream) a).txVersion));\n         maxConflictWildcard = maxConflictNewSequencer;\n         this.maxConflictNewSequencer = maxConflictNewSequencer;\n+        conflictKeys = MeterRegistryProvider\n+                .getInstance()\n+                .map(registry ->\n+                        registry.gauge(conflictKeysCounterName, Collections.emptyList(),\n+                                new HashMap<ConflictTxStream, Long>(), HashMap::size))\n+                .orElse(new HashMap<>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyNTE4MQ=="}, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDU5NDQ3OnYy", "diffSide": "RIGHT", "path": "scripts/corfu_server.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMToxNzowNVrOH2Cgog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQwMTo0MzoxOVrOH6I-Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyNjI3NA==", "bodyText": "Can you just enable this by default and add the logging information in infrastructure/src/main/resources/logback.prod.xml", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r526426274", "createdAt": "2020-11-18T21:17:05Z", "author": {"login": "Maithem"}, "path": "scripts/corfu_server.sh", "diffHunk": "@@ -35,9 +35,13 @@ then\n     CLASSPATH=`cygpath -wp \"$CLASSPATH\"`\n fi\n \n+if [ \"$METRICS_CONFIG_FILE\" != \"\" ]; then\n+  LOGBACK_CONFIGURATION=\"-Dlogback.configurationFile=${METRICS_CONFIG_FILE}\"\n+  JAVA=\"$JAVA $LOGBACK_CONFIGURATION\"\n+fi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNjQ0Ng==", "bodyText": "This was done in order to supply the running processes in the integration tests with an XML file. It's mostly for debugging/viewing metrics in the integration tests. I will enable the metrics in the logback.prod.xml though.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2825#discussion_r530726446", "createdAt": "2020-11-26T01:43:19Z", "author": {"login": "PavelZaytsev"}, "path": "scripts/corfu_server.sh", "diffHunk": "@@ -35,9 +35,13 @@ then\n     CLASSPATH=`cygpath -wp \"$CLASSPATH\"`\n fi\n \n+if [ \"$METRICS_CONFIG_FILE\" != \"\" ]; then\n+  LOGBACK_CONFIGURATION=\"-Dlogback.configurationFile=${METRICS_CONFIG_FILE}\"\n+  JAVA=\"$JAVA $LOGBACK_CONFIGURATION\"\n+fi", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyNjI3NA=="}, "originalCommit": {"oid": "364f6559264c15e506158e68309a831a93be6dfd"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1781, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}