{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0ODQ5NTQz", "number": 2509, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwNDoxODo0N1rODzJggA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozNDowMVrOD21hwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0OTU5NzQ0OnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/view/TableRegistry.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwNDoxODo0N1rOGHlmIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxOTowNDowN1rOGMzIcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDYwOTE4NQ==", "bodyText": "Is it possible that before calling TXEnd(), while doing put, it will throw a transaction abort exception and the tx.end() is never called?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r410609185", "createdAt": "2020-04-18T04:18:47Z", "author": {"login": "xiaoqin2012"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/TableRegistry.java", "diffHunk": "@@ -178,17 +179,21 @@ void registerTable(@Nonnull String namespace,\n                 log.debug(\"registerTable: new schema:\"+tableDescriptors.getFileDescriptorsMap());\n             }\n         }\n-        try {\n-            this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n-            if (hasSchemaChanged) {\n-                this.registryTable.put(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n-            } else {\n-                this.registryTable.putIfAbsent(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+        int numRetries = 3; // Since this is an internal transaction, retry a few times before giving up.\n+        while (numRetries-- > 0) {\n+            try {\n+                this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n+                if (hasSchemaChanged) {\n+                    this.registryTable.put(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                } else {\n+                    this.registryTable.putIfAbsent(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                }\n+                this.runtime.getObjectsView().TXEnd();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f748641536632cb5c2dc9f7d090859534d4dca0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQyNjM3OA==", "bodyText": "No, we can't throw transaction abort exceptions until a transaction ends because only when a transaction ends will we have all the keys whose conflicts need resolution.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r413426378", "createdAt": "2020-04-23T00:38:16Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/TableRegistry.java", "diffHunk": "@@ -178,17 +179,21 @@ void registerTable(@Nonnull String namespace,\n                 log.debug(\"registerTable: new schema:\"+tableDescriptors.getFileDescriptorsMap());\n             }\n         }\n-        try {\n-            this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n-            if (hasSchemaChanged) {\n-                this.registryTable.put(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n-            } else {\n-                this.registryTable.putIfAbsent(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+        int numRetries = 3; // Since this is an internal transaction, retry a few times before giving up.\n+        while (numRetries-- > 0) {\n+            try {\n+                this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n+                if (hasSchemaChanged) {\n+                    this.registryTable.put(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                } else {\n+                    this.registryTable.putIfAbsent(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                }\n+                this.runtime.getObjectsView().TXEnd();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDYwOTE4NQ=="}, "originalCommit": {"oid": "4f748641536632cb5c2dc9f7d090859534d4dca0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQzMDQwNw==", "bodyText": "Ok. How about other exceptions? If before call TXEnd(), the above code throws other exceptions but not transaction abort exception, the the TXEnd() will not be called, is it safe to start a transaction without a TXEnd() call? Also after 3 retries, if it still catch a transaction abort exception, it should throw it, right?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r413430407", "createdAt": "2020-04-23T00:50:16Z", "author": {"login": "xiaoqin2012"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/TableRegistry.java", "diffHunk": "@@ -178,17 +179,21 @@ void registerTable(@Nonnull String namespace,\n                 log.debug(\"registerTable: new schema:\"+tableDescriptors.getFileDescriptorsMap());\n             }\n         }\n-        try {\n-            this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n-            if (hasSchemaChanged) {\n-                this.registryTable.put(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n-            } else {\n-                this.registryTable.putIfAbsent(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+        int numRetries = 3; // Since this is an internal transaction, retry a few times before giving up.\n+        while (numRetries-- > 0) {\n+            try {\n+                this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n+                if (hasSchemaChanged) {\n+                    this.registryTable.put(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                } else {\n+                    this.registryTable.putIfAbsent(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                }\n+                this.runtime.getObjectsView().TXEnd();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDYwOTE4NQ=="}, "originalCommit": {"oid": "4f748641536632cb5c2dc9f7d090859534d4dca0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MjA2Nw==", "bodyText": "Only TransactionAborted exception is caught and retried which is not thrown before TXEnd() is called as of this codebase.\nIf there are other exceptions then we will not catch or retry them, it will go up to caller as usual.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r414962067", "createdAt": "2020-04-25T03:03:47Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/TableRegistry.java", "diffHunk": "@@ -178,17 +179,21 @@ void registerTable(@Nonnull String namespace,\n                 log.debug(\"registerTable: new schema:\"+tableDescriptors.getFileDescriptorsMap());\n             }\n         }\n-        try {\n-            this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n-            if (hasSchemaChanged) {\n-                this.registryTable.put(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n-            } else {\n-                this.registryTable.putIfAbsent(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+        int numRetries = 3; // Since this is an internal transaction, retry a few times before giving up.\n+        while (numRetries-- > 0) {\n+            try {\n+                this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n+                if (hasSchemaChanged) {\n+                    this.registryTable.put(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                } else {\n+                    this.registryTable.putIfAbsent(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                }\n+                this.runtime.getObjectsView().TXEnd();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDYwOTE4NQ=="}, "originalCommit": {"oid": "4f748641536632cb5c2dc9f7d090859534d4dca0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk3MTU2OA==", "bodyText": "Two issues:\n\nThe original code, always execute TXEnd() as it is in the finally. So with any exception, the TXEnd() will be executed.\nIn the change, if transactionAborted happens three times after retry, the exception should be thrown again to the caller.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r414971568", "createdAt": "2020-04-25T04:03:42Z", "author": {"login": "xiaoqin2012"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/TableRegistry.java", "diffHunk": "@@ -178,17 +179,21 @@ void registerTable(@Nonnull String namespace,\n                 log.debug(\"registerTable: new schema:\"+tableDescriptors.getFileDescriptorsMap());\n             }\n         }\n-        try {\n-            this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n-            if (hasSchemaChanged) {\n-                this.registryTable.put(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n-            } else {\n-                this.registryTable.putIfAbsent(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+        int numRetries = 3; // Since this is an internal transaction, retry a few times before giving up.\n+        while (numRetries-- > 0) {\n+            try {\n+                this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n+                if (hasSchemaChanged) {\n+                    this.registryTable.put(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                } else {\n+                    this.registryTable.putIfAbsent(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                }\n+                this.runtime.getObjectsView().TXEnd();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDYwOTE4NQ=="}, "originalCommit": {"oid": "4f748641536632cb5c2dc9f7d090859534d4dca0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk5NjA0Ng==", "bodyText": "Calling TXEnd() on an other exception that occurred before it would be as undefined/wrong behavior as calling TXEnd() in the finally block - (one might end up committing a transaction that was supposed to fail). I suppose it's better to abort the transaction in that case to prevent corruption. Let me make that change instead.\nSure, while this will almost never occur in real life because the transaction abort itself is rare, I suppose it should be cleaner to re-throw the exception.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r414996046", "createdAt": "2020-04-25T06:35:52Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/TableRegistry.java", "diffHunk": "@@ -178,17 +179,21 @@ void registerTable(@Nonnull String namespace,\n                 log.debug(\"registerTable: new schema:\"+tableDescriptors.getFileDescriptorsMap());\n             }\n         }\n-        try {\n-            this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n-            if (hasSchemaChanged) {\n-                this.registryTable.put(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n-            } else {\n-                this.registryTable.putIfAbsent(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+        int numRetries = 3; // Since this is an internal transaction, retry a few times before giving up.\n+        while (numRetries-- > 0) {\n+            try {\n+                this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n+                if (hasSchemaChanged) {\n+                    this.registryTable.put(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                } else {\n+                    this.registryTable.putIfAbsent(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                }\n+                this.runtime.getObjectsView().TXEnd();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDYwOTE4NQ=="}, "originalCommit": {"oid": "4f748641536632cb5c2dc9f7d090859534d4dca0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA3Mzg0Mw==", "bodyText": "Addressed 1. and 2. thanks", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r416073843", "createdAt": "2020-04-27T19:04:07Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/view/TableRegistry.java", "diffHunk": "@@ -178,17 +179,21 @@ void registerTable(@Nonnull String namespace,\n                 log.debug(\"registerTable: new schema:\"+tableDescriptors.getFileDescriptorsMap());\n             }\n         }\n-        try {\n-            this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n-            if (hasSchemaChanged) {\n-                this.registryTable.put(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n-            } else {\n-                this.registryTable.putIfAbsent(tableNameKey,\n-                        new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+        int numRetries = 3; // Since this is an internal transaction, retry a few times before giving up.\n+        while (numRetries-- > 0) {\n+            try {\n+                this.runtime.getObjectsView().TXBuild().type(TransactionType.OPTIMISTIC).build().begin();\n+                if (hasSchemaChanged) {\n+                    this.registryTable.put(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                } else {\n+                    this.registryTable.putIfAbsent(tableNameKey,\n+                            new CorfuRecord<>(tableDescriptors, metadataBuilder.build()));\n+                }\n+                this.runtime.getObjectsView().TXEnd();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDYwOTE4NQ=="}, "originalCommit": {"oid": "4f748641536632cb5c2dc9f7d090859534d4dca0"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4ODI2NjY5OnYy", "diffSide": "RIGHT", "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozMzo1OVrOGMx5fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozMzo1OVrOGMx5fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1MzYyOQ==", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r416053629", "createdAt": "2020-04-27T18:33:59Z", "author": {"login": "corfudb-bot"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "diffHunk": "@@ -282,6 +283,30 @@ public void checkMetadataTransactions() throws Exception {\n         }\n     }\n \n+    /**\n+     * Demonstrates that opening same table from multiple threads will retry internal transactions\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void checkOpenRetriesTXN() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4ODI2Njc1OnYy", "diffSide": "RIGHT", "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozNDowMFrOGMx5iA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxOTowMzozN1rOGMzHKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1MzY0MA==", "bodyText": "Issue found: Avoid unused imports such as 'org.corfudb.runtime.exceptions.TransactionAbortedException'", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r416053640", "createdAt": "2020-04-27T18:34:00Z", "author": {"login": "corfudb-bot"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "diffHunk": "@@ -11,6 +11,7 @@\n import org.corfudb.runtime.CorfuRuntime;\n import org.corfudb.runtime.CorfuStoreMetadata;\n import org.corfudb.runtime.CorfuStoreMetadata.Timestamp;\n+import org.corfudb.runtime.exceptions.TransactionAbortedException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA2MDE5MA==", "bodyText": "nit - please remove this import", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r416060190", "createdAt": "2020-04-27T18:43:59Z", "author": {"login": "pankti-m"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "diffHunk": "@@ -11,6 +11,7 @@\n import org.corfudb.runtime.CorfuRuntime;\n import org.corfudb.runtime.CorfuStoreMetadata;\n import org.corfudb.runtime.CorfuStoreMetadata.Timestamp;\n+import org.corfudb.runtime.exceptions.TransactionAbortedException;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1MzY0MA=="}, "originalCommit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA3MzUxNA==", "bodyText": "will be removing this on the next patch.. thanks", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r416073514", "createdAt": "2020-04-27T19:03:37Z", "author": {"login": "hisundar"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "diffHunk": "@@ -11,6 +11,7 @@\n import org.corfudb.runtime.CorfuRuntime;\n import org.corfudb.runtime.CorfuStoreMetadata;\n import org.corfudb.runtime.CorfuStoreMetadata.Timestamp;\n+import org.corfudb.runtime.exceptions.TransactionAbortedException;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1MzY0MA=="}, "originalCommit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4ODI2NjkwOnYy", "diffSide": "RIGHT", "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozNDowMVrOGMx5nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODozNDowMVrOGMx5nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA1MzY2MA==", "bodyText": "Issue found: Unused import - org.corfudb.runtime.exceptions.TransactionAbortedException.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2509#discussion_r416053660", "createdAt": "2020-04-27T18:34:01Z", "author": {"login": "corfudb-bot"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreTest.java", "diffHunk": "@@ -11,6 +11,7 @@\n import org.corfudb.runtime.CorfuRuntime;\n import org.corfudb.runtime.CorfuStoreMetadata;\n import org.corfudb.runtime.CorfuStoreMetadata.Timestamp;\n+import org.corfudb.runtime.exceptions.TransactionAbortedException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "929617d73fec8dd9b350b027c3e31c2b61f6b7ac"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1967, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}