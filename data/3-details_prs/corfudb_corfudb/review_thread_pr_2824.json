{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NDg5NTkw", "number": 2824, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwNDozMTo0MlrOE47Gcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMzozMTowM1rOE8gQ8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MTI0MDE4OnYy", "diffSide": "RIGHT", "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreShimTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwNDozMTo0MlrOHzIPmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTo1NzoyNFrOH0Vn1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM3NDQ4OQ==", "bodyText": "Nit: Can we indent the comment with the parameter?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r523374489", "createdAt": "2020-11-14T04:31:42Z", "author": {"login": "chetangudisagar"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreShimTest.java", "diffHunk": "@@ -494,4 +505,57 @@ public void onCommit(Map<String, List<CorfuStreamEntry>> mutations) {\n         }\n         log.debug(table.getMetrics().toString());\n     }\n+\n+    /**\n+     * Validate that nested transactions do not throw exception if txnWithNesting is used.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void checkNestedTransaction() throws Exception {\n+// Get a Corfu Runtime instance.\n+        CorfuRuntime corfuRuntime = getTestRuntime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d116dac822e882ba3c783f28f77c84041ac94533"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY0MjI2Mw==", "bodyText": "done. thanks", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r524642263", "createdAt": "2020-11-16T21:57:24Z", "author": {"login": "hisundar"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreShimTest.java", "diffHunk": "@@ -494,4 +505,57 @@ public void onCommit(Map<String, List<CorfuStreamEntry>> mutations) {\n         }\n         log.debug(table.getMetrics().toString());\n     }\n+\n+    /**\n+     * Validate that nested transactions do not throw exception if txnWithNesting is used.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    public void checkNestedTransaction() throws Exception {\n+// Get a Corfu Runtime instance.\n+        CorfuRuntime corfuRuntime = getTestRuntime();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM3NDQ4OQ=="}, "originalCommit": {"oid": "d116dac822e882ba3c783f28f77c84041ac94533"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDA4NjMyOnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/CorfuStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTowMjowNlrOH19oyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMTo1MDo1M1rOH2JaeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0NjQ0MA==", "bodyText": "comments need to be updated.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526346440", "createdAt": "2020-11-18T19:02:06Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/CorfuStore.java", "diffHunk": "@@ -206,7 +205,8 @@ public TxnContext txn(@Nonnull final String namespace, IsolationLevel isolationL\n                 this.runtime.getObjectsView(),\n                 this.runtime.getTableRegistry(),\n                 namespace,\n-                isolationLevel);\n+                isolationLevel,\n+                false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUzOTM4NA==", "bodyText": "done", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526539384", "createdAt": "2020-11-19T01:50:53Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/CorfuStore.java", "diffHunk": "@@ -206,7 +205,8 @@ public TxnContext txn(@Nonnull final String namespace, IsolationLevel isolationL\n                 this.runtime.getObjectsView(),\n                 this.runtime.getTableRegistry(),\n                 namespace,\n-                isolationLevel);\n+                isolationLevel,\n+                false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0NjQ0MA=="}, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDA5MzUxOnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTowNDowM1rOH19tMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjo0NDoxNlrOH2FYEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0NzU3MQ==", "bodyText": "need to add comments as to what it means.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526347571", "createdAt": "2020-11-18T19:04:03Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -64,14 +65,15 @@\n     public TxnContext(@Nonnull final ObjectsView objectsView,\n                       @Nonnull final TableRegistry tableRegistry,\n                       @Nonnull final String namespace,\n-                      @Nonnull final IsolationLevel isolationLevel) {\n+                      @Nonnull final IsolationLevel isolationLevel,\n+                      @Nonnull boolean allowNestedTransactions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ3MzIzMg==", "bodyText": "done. thanks", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526473232", "createdAt": "2020-11-18T22:44:16Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -64,14 +65,15 @@\n     public TxnContext(@Nonnull final ObjectsView objectsView,\n                       @Nonnull final TableRegistry tableRegistry,\n                       @Nonnull final String namespace,\n-                      @Nonnull final IsolationLevel isolationLevel) {\n+                      @Nonnull final IsolationLevel isolationLevel,\n+                      @Nonnull boolean allowNestedTransactions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0NzU3MQ=="}, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDIwMDE5OnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTozMToxOVrOH1-uLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjo0NDozM1rOH2FYpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NDIwNQ==", "bodyText": "getTxnContext or getThreadLocalTxnContext", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526364205", "createdAt": "2020-11-18T19:31:19Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -607,6 +633,24 @@ boolean isExists(@Nonnull String tableName, @Nonnull final K key) {\n         return table.scanAndFilterByEntry(record -> true);\n     }\n \n+    /**\n+     * @return The the thread local's TxnContext, null if not in a transaction.\n+     */\n+    public static TxnContext getMyTxnContext() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 184}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ3MzM4Mw==", "bodyText": "done, thanks", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526473383", "createdAt": "2020-11-18T22:44:33Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -607,6 +633,24 @@ boolean isExists(@Nonnull String tableName, @Nonnull final K key) {\n         return table.scanAndFilterByEntry(record -> true);\n     }\n \n+    /**\n+     * @return The the thread local's TxnContext, null if not in a transaction.\n+     */\n+    public static TxnContext getMyTxnContext() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NDIwNQ=="}, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 184}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDIxMTI0OnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTozNDoxMFrOH1-03g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjo0NTowN1rOH2FZzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NTkxOA==", "bodyText": "can there be a failure before this is called ? in the run methods ?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526365918", "createdAt": "2020-11-18T19:34:10Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -652,10 +710,16 @@ private void txBeginInternal() {\n      * @return - address at which the commit of this transaction occurred.\n      */\n     public long commit() {\n-        if (!TransactionalContext.isInTransaction()) {\n+        if (!isInMyTransaction()) {\n             throw new IllegalStateException(\"commit() called without a transaction!\");\n         }\n+\n+        // Apply any buffered up operations.\n         operations.forEach(Runnable::run);\n+\n+        // Regardless of transaction outcome remove any TxnContext association from ThreadLocal.\n+        TransactionalContext.getRootContext().setTxnContext(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 253}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ3MzY3OQ==", "bodyText": "yes, then the auto-closeable will catch it and abort the transaction", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526473679", "createdAt": "2020-11-18T22:45:07Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -652,10 +710,16 @@ private void txBeginInternal() {\n      * @return - address at which the commit of this transaction occurred.\n      */\n     public long commit() {\n-        if (!TransactionalContext.isInTransaction()) {\n+        if (!isInMyTransaction()) {\n             throw new IllegalStateException(\"commit() called without a transaction!\");\n         }\n+\n+        // Apply any buffered up operations.\n         operations.forEach(Runnable::run);\n+\n+        // Regardless of transaction outcome remove any TxnContext association from ThreadLocal.\n+        TransactionalContext.getRootContext().setTxnContext(null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NTkxOA=="}, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 253}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDIyMDA1OnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTozNjowOFrOH1-6Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjo0NTozNlrOH2Favw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NzI0Mg==", "bodyText": "Is this correct ?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526367242", "createdAt": "2020-11-18T19:36:08Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -623,13 +667,26 @@ void applyWritesForReadOnTable(Table<K, V, M> tableBeingRead) {\n     }\n \n     /**\n+     * @param allowNestedTransactions - is it ok to re-use thread's corfu transaction?\n      * Start the actual corfu transaction. Ensure there isn't one already in the same thread.\n+     *\n      */\n-    private void txBeginInternal() {\n+    private void txBeginInternal(boolean allowNestedTransactions) {\n         if (TransactionalContext.isInTransaction()) {\n-            log.error(\"Cannot start new transaction in this thread without ending previous one\");\n-            throw new TransactionAlreadyStartedException(TransactionalContext.getRootContext().toString());\n+            TxnContext txnContext = TransactionalContext.getRootContext().getTxnContext();\n+            if (!allowNestedTransactions) {\n+                log.error(\"Current thread already has a transaction started and nested transactions are disabled!\");\n+                throw new TransactionAlreadyStartedException(TransactionalContext.getRootContext().toString());\n+            }\n+            if (txnContext != null) {\n+                log.error(\"Cannot start new transaction in this thread without ending previous one\");\n+                throw new TransactionAlreadyStartedException(TransactionalContext.getRootContext().toString());\n+            }\n+            this.txnStartTime = System.nanoTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 224}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ3MzkxOQ==", "bodyText": "it's best effort given that we did not actually start the transaction", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526473919", "createdAt": "2020-11-18T22:45:36Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -623,13 +667,26 @@ void applyWritesForReadOnTable(Table<K, V, M> tableBeingRead) {\n     }\n \n     /**\n+     * @param allowNestedTransactions - is it ok to re-use thread's corfu transaction?\n      * Start the actual corfu transaction. Ensure there isn't one already in the same thread.\n+     *\n      */\n-    private void txBeginInternal() {\n+    private void txBeginInternal(boolean allowNestedTransactions) {\n         if (TransactionalContext.isInTransaction()) {\n-            log.error(\"Cannot start new transaction in this thread without ending previous one\");\n-            throw new TransactionAlreadyStartedException(TransactionalContext.getRootContext().toString());\n+            TxnContext txnContext = TransactionalContext.getRootContext().getTxnContext();\n+            if (!allowNestedTransactions) {\n+                log.error(\"Current thread already has a transaction started and nested transactions are disabled!\");\n+                throw new TransactionAlreadyStartedException(TransactionalContext.getRootContext().toString());\n+            }\n+            if (txnContext != null) {\n+                log.error(\"Cannot start new transaction in this thread without ending previous one\");\n+                throw new TransactionAlreadyStartedException(TransactionalContext.getRootContext().toString());\n+            }\n+            this.txnStartTime = System.nanoTime();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NzI0Mg=="}, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 224}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDI0MjMzOnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTo0MTozM1rOH1_HNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjo0ODoxOVrOH2FfMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3MDYxNA==", "bodyText": "Isn't this a little ambiguous ? put(key, null) = delete(key)", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526370614", "createdAt": "2020-11-18T19:41:33Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -164,21 +184,27 @@ void putRecord(@Nonnull Table<K, V, M> table,\n      */\n     public <K extends Message, V extends Message, M extends Message>\n     void merge(@Nonnull Table<K, V, M> table,\n-                     @Nonnull final K key,\n-                     @Nonnull MergeCallback mergeCallback,\n-                     @Nonnull final CorfuRecord<V,M> recordDelta) {\n-        validateTableWrittenIsInNamespace(table);\n+               @Nonnull final K key,\n+               @Nonnull MergeCallback mergeCallback,\n+               @Nonnull final CorfuRecord<V,M> recordDelta) {\n+        validateWrite(table, key);\n         operations.add(() -> {\n-            CorfuRecord<V,M> oldRecord = table.get(key);\n+            CorfuRecord<V, M> oldRecord = table.get(key);\n             CorfuRecord<V, M> mergedRecord;\n             try {\n-                mergedRecord = mergeCallback.doMerge(table, oldRecord, recordDelta);\n+                mergedRecord = mergeCallback.doMerge(table, key, oldRecord, recordDelta);\n             } catch (Exception ex) {\n                 txAbort(); // explicitly abort this transaction and then throw the abort manually\n                 log.error(\"TX Abort merge: {}\", table.getFullyQualifiedTableName(), ex);\n                 throw ex;\n             }\n-            table.put(key, mergedRecord.getPayload(), mergedRecord.getMetadata());\n+            if (mergedRecord == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ3NTA1Ng==", "bodyText": "this was to actually fix a bug where delete with metadata wasn't being handled. I am open to suggestions though.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526475056", "createdAt": "2020-11-18T22:48:19Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -164,21 +184,27 @@ void putRecord(@Nonnull Table<K, V, M> table,\n      */\n     public <K extends Message, V extends Message, M extends Message>\n     void merge(@Nonnull Table<K, V, M> table,\n-                     @Nonnull final K key,\n-                     @Nonnull MergeCallback mergeCallback,\n-                     @Nonnull final CorfuRecord<V,M> recordDelta) {\n-        validateTableWrittenIsInNamespace(table);\n+               @Nonnull final K key,\n+               @Nonnull MergeCallback mergeCallback,\n+               @Nonnull final CorfuRecord<V,M> recordDelta) {\n+        validateWrite(table, key);\n         operations.add(() -> {\n-            CorfuRecord<V,M> oldRecord = table.get(key);\n+            CorfuRecord<V, M> oldRecord = table.get(key);\n             CorfuRecord<V, M> mergedRecord;\n             try {\n-                mergedRecord = mergeCallback.doMerge(table, oldRecord, recordDelta);\n+                mergedRecord = mergeCallback.doMerge(table, key, oldRecord, recordDelta);\n             } catch (Exception ex) {\n                 txAbort(); // explicitly abort this transaction and then throw the abort manually\n                 log.error(\"TX Abort merge: {}\", table.getFullyQualifiedTableName(), ex);\n                 throw ex;\n             }\n-            table.put(key, mergedRecord.getPayload(), mergedRecord.getMetadata());\n+            if (mergedRecord == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3MDYxNA=="}, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDU0Mjk2OnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContextShim.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMTowMjo0OFrOH2CB3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjo0NzoyOFrOH2Fd7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxODM5Ng==", "bodyText": "The Shim prefix for the name is not that great. Can we change it to a better name.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526418396", "createdAt": "2020-11-18T21:02:48Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContextShim.java", "diffHunk": "@@ -7,46 +7,59 @@\n import org.corfudb.runtime.exceptions.StaleRevisionUpdateException;\n import org.corfudb.runtime.object.transactions.AbstractTransactionalContext;\n import org.corfudb.runtime.object.transactions.TransactionalContext;\n-import org.corfudb.runtime.view.ObjectsView;\n-import org.corfudb.runtime.view.TableRegistry;\n+import org.corfudb.runtime.view.Address;\n \n import javax.annotation.Nonnull;\n import javax.annotation.Nullable;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.UUID;\n+import java.util.function.BiFunction;\n+import java.util.function.BiPredicate;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n import java.util.stream.Collectors;\n \n /**\n- * Thin shim layer around CorfuStore's TxnContext for providing metadata management\n- * capabilities.\n+ * Shim layer around CorfuStore's TxnContext for providing metadata management\n+ * capabilities, nested transaction support and more!\n  *\n  * Created by hisundar on 2020-09-16\n  */\n @Slf4j\n-public class TxnContextShim extends TxnContext implements AutoCloseable {\n+public class TxnContextShim implements AutoCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ3NDczNA==", "bodyText": "ok, changed to ManagedTxnContext", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526474734", "createdAt": "2020-11-18T22:47:28Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContextShim.java", "diffHunk": "@@ -7,46 +7,59 @@\n import org.corfudb.runtime.exceptions.StaleRevisionUpdateException;\n import org.corfudb.runtime.object.transactions.AbstractTransactionalContext;\n import org.corfudb.runtime.object.transactions.TransactionalContext;\n-import org.corfudb.runtime.view.ObjectsView;\n-import org.corfudb.runtime.view.TableRegistry;\n+import org.corfudb.runtime.view.Address;\n \n import javax.annotation.Nonnull;\n import javax.annotation.Nullable;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.UUID;\n+import java.util.function.BiFunction;\n+import java.util.function.BiPredicate;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n import java.util.stream.Collectors;\n \n /**\n- * Thin shim layer around CorfuStore's TxnContext for providing metadata management\n- * capabilities.\n+ * Shim layer around CorfuStore's TxnContext for providing metadata management\n+ * capabilities, nested transaction support and more!\n  *\n  * Created by hisundar on 2020-09-16\n  */\n @Slf4j\n-public class TxnContextShim extends TxnContext implements AutoCloseable {\n+public class TxnContextShim implements AutoCloseable {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxODM5Ng=="}, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMDU1NTIxOnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContextShim.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMTowNjoyNFrOH2CJYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjo0NjoyOVrOH2FcKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMDMyMA==", "bodyText": "nit:since you use short circuit operator || the faster check could be first.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526420320", "createdAt": "2020-11-18T21:06:24Z", "author": {"login": "medhavidhawan"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContextShim.java", "diffHunk": "@@ -230,6 +608,92 @@ void putRecord(@Nonnull Table<K, V, M> table,\n         }\n     }\n \n+    /**\n+     * Delete the record given the table object and metadata for validation.\n+     *\n+     * @param table Table object to perform the create/update on.\n+     * @param key   Key of the record to be deleted.\n+     * @param metadata Metadata to validate against.\n+     * @param <K>   Type of Key.\n+     * @param <V>   Type of Value.\n+     * @param <M>   Type of Metadata.\n+     */\n+    public <K extends Message, V extends Message, M extends Message>\n+    void deleteRecord(@Nonnull Table<K, V, M> table,\n+                      @Nonnull final K key,\n+                      @Nullable final M metadata) {\n+        if (metadata == null) {\n+            this.txnContext.delete(table, key);\n+            return;\n+        }\n+        MergeCallbackForDeleteImpl mergeCallbackForDelete = new MergeCallbackForDeleteImpl();\n+        this.txnContext.merge(table, key, mergeCallbackForDelete, new CorfuRecord<>(null, metadata));\n+    }\n+\n+    /**\n+     *\n+     * Delete a record given just tableName and the metadata for validation against.\n+     *\n+     * @param tableName - full string representation of the table\n+     * @param key - the key of the record being inserted\n+     * @param metadata - the metadata which will be validated\n+     * @param <K> - type of the key or identifier.\n+     * @param <V> - type of the value or payload\n+     * @param <M> - type of the metadata\n+     */\n+    public <K extends Message, V extends Message, M extends Message>\n+    void deleteRecord(@Nonnull String tableName,\n+                      @Nonnull final K key,\n+                      @Nullable final M metadata) {\n+        deleteRecord(this.getTable(tableName), key, metadata);\n+    }\n+\n+    static class MergeCallbackForDeleteImpl implements TxnContext.MergeCallback {\n+        /**\n+         * Core logic for handling metadata modifications on delete with metadata.\n+         *\n+         * @param table       - The table object on which the merge is being done.\n+         * @param key         - Key of the record on which merge is being done.\n+         * @param oldRecord   - The previous fetched record that exists in the table.\n+         * @param deltaUpdate - Record with only the metadata passed in for validation.\n+         * @param <K>         - type of the key\n+         * @param <V>         - type of the value or payload\n+         * @param <M>         - type of the metadata\n+         * @return null if validation was successful or StaleRevision exception if not.\n+         */\n+        @Override\n+        public <K extends Message, V extends Message, M extends Message>\n+        CorfuRecord<V, M> doMerge(Table<K, V, M> table,\n+                                  K key,\n+                                  CorfuRecord<V, M> oldRecord,\n+                                  CorfuRecord<V, M> deltaUpdate) {\n+            M deltaMetadata = deltaUpdate.getMetadata();\n+            if (deltaUpdate.getPayload() != null) {\n+                throw new IllegalArgumentException(\"Non-null payload sent for delete validation\");\n+            }\n+\n+            final Message.Builder builder = deltaMetadata.toBuilder();\n+            for (Descriptors.FieldDescriptor fieldDescriptor : deltaMetadata.getDescriptorForType().getFields()) {\n+                if (\"revision\".equals(fieldDescriptor.getName())) {\n+                    if (oldRecord == null || oldRecord.getMetadata() == null) {\n+                        return null;\n+                    } else {\n+                        Long prevRevision = (Long) oldRecord.getMetadata().getField(fieldDescriptor);\n+                        Long givenRevision = (Long) deltaMetadata.getField(fieldDescriptor);\n+                        if ((givenRevision > 0 && // Validate revision only if set\n+                                prevRevision.longValue() == givenRevision.longValue())\n+                                || givenRevision == 0) { // Do not validate revision if field isn't set", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 612}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ3NDI4MA==", "bodyText": "done. thanks", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r526474280", "createdAt": "2020-11-18T22:46:29Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContextShim.java", "diffHunk": "@@ -230,6 +608,92 @@ void putRecord(@Nonnull Table<K, V, M> table,\n         }\n     }\n \n+    /**\n+     * Delete the record given the table object and metadata for validation.\n+     *\n+     * @param table Table object to perform the create/update on.\n+     * @param key   Key of the record to be deleted.\n+     * @param metadata Metadata to validate against.\n+     * @param <K>   Type of Key.\n+     * @param <V>   Type of Value.\n+     * @param <M>   Type of Metadata.\n+     */\n+    public <K extends Message, V extends Message, M extends Message>\n+    void deleteRecord(@Nonnull Table<K, V, M> table,\n+                      @Nonnull final K key,\n+                      @Nullable final M metadata) {\n+        if (metadata == null) {\n+            this.txnContext.delete(table, key);\n+            return;\n+        }\n+        MergeCallbackForDeleteImpl mergeCallbackForDelete = new MergeCallbackForDeleteImpl();\n+        this.txnContext.merge(table, key, mergeCallbackForDelete, new CorfuRecord<>(null, metadata));\n+    }\n+\n+    /**\n+     *\n+     * Delete a record given just tableName and the metadata for validation against.\n+     *\n+     * @param tableName - full string representation of the table\n+     * @param key - the key of the record being inserted\n+     * @param metadata - the metadata which will be validated\n+     * @param <K> - type of the key or identifier.\n+     * @param <V> - type of the value or payload\n+     * @param <M> - type of the metadata\n+     */\n+    public <K extends Message, V extends Message, M extends Message>\n+    void deleteRecord(@Nonnull String tableName,\n+                      @Nonnull final K key,\n+                      @Nullable final M metadata) {\n+        deleteRecord(this.getTable(tableName), key, metadata);\n+    }\n+\n+    static class MergeCallbackForDeleteImpl implements TxnContext.MergeCallback {\n+        /**\n+         * Core logic for handling metadata modifications on delete with metadata.\n+         *\n+         * @param table       - The table object on which the merge is being done.\n+         * @param key         - Key of the record on which merge is being done.\n+         * @param oldRecord   - The previous fetched record that exists in the table.\n+         * @param deltaUpdate - Record with only the metadata passed in for validation.\n+         * @param <K>         - type of the key\n+         * @param <V>         - type of the value or payload\n+         * @param <M>         - type of the metadata\n+         * @return null if validation was successful or StaleRevision exception if not.\n+         */\n+        @Override\n+        public <K extends Message, V extends Message, M extends Message>\n+        CorfuRecord<V, M> doMerge(Table<K, V, M> table,\n+                                  K key,\n+                                  CorfuRecord<V, M> oldRecord,\n+                                  CorfuRecord<V, M> deltaUpdate) {\n+            M deltaMetadata = deltaUpdate.getMetadata();\n+            if (deltaUpdate.getPayload() != null) {\n+                throw new IllegalArgumentException(\"Non-null payload sent for delete validation\");\n+            }\n+\n+            final Message.Builder builder = deltaMetadata.toBuilder();\n+            for (Descriptors.FieldDescriptor fieldDescriptor : deltaMetadata.getDescriptorForType().getFields()) {\n+                if (\"revision\".equals(fieldDescriptor.getName())) {\n+                    if (oldRecord == null || oldRecord.getMetadata() == null) {\n+                        return null;\n+                    } else {\n+                        Long prevRevision = (Long) oldRecord.getMetadata().getField(fieldDescriptor);\n+                        Long givenRevision = (Long) deltaMetadata.getField(fieldDescriptor);\n+                        if ((givenRevision > 0 && // Validate revision only if set\n+                                prevRevision.longValue() == givenRevision.longValue())\n+                                || givenRevision == 0) { // Do not validate revision if field isn't set", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQyMDMyMA=="}, "originalCommit": {"oid": "11f90666372c988fccbcd572f5a5b357a424b7ea"}, "originalPosition": 612}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNTQxNDY1OnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDoyODoxMlrOH2wVbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo0MzowMlrOH20_Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3NzA2OQ==", "bodyText": "Probably should be validateNameSpace and not write. Kind of confusing when invoked for deletes. Also, for writes the Key can never be null, so its not even optional for a map.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r527177069", "createdAt": "2020-11-19T20:28:12Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -86,13 +87,15 @@ public TxnContext(@Nonnull final ObjectsView objectsView,\n     /**\n      * All write api must be validate to ensure that the table belongs to the namespace.\n      *\n-     * @param table - table being written to\n-     * @param <K> -type of the key\n-     * @param <V> - type of the payload/value\n-     * @param <M> - type of the metadata\n+     * @param table         - table being written to\n+     * @param key           - key used in the transaction to check for null.\n+     * @param validateKey   - should key be validated for null.\n+     * @param <K>           - type of the key\n+     * @param <V>           - type of the payload/value\n+     * @param <M>           - type of the metadata\n      */\n     private <K extends Message, V extends Message, M extends Message>\n-    void validateTableWrittenIsInNamespace(@Nonnull Table<K, V, M> table) {\n+    void validateWrite(@Nonnull Table<K, V, M> table, K key, boolean validateKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b570849d9a3f235077ee8fb9965caf992ba873"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1MzMxNQ==", "bodyText": "You'd be surprised then :)\nKey can never be null but the way it fails when the table.put() is invoked with the key being null is not pretty..\nObjectsView 9496 TXEnd[TX[9672]]: Unexpected exception java.lang.NullPointerException: null at org.corfudb.util.serializer.ISerializer.hash(ISerializer.java:123) ~[runtime-3.2.20201109031413.7872.1.jar:?] at org.corfudb.runtime.object.transactions.ConflictSetInfo.generateHashFromObject(ConflictSetInfo.java:28) ~[runtime-3.2.20201109031413.7872.1.jar:?] at org.corfudb.runtime.object.transactions.ConflictSetInfo.lambda$null$1(ConflictSetInfo.java:41) ~[runtime-3.2.20201109031413.7872.1.jar:?] at\nwe do need to validate for deletes as well because sometimes buggy code causes callers to send in null into the key.\nWe need to catch the error much early on for debug-ability.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r527253315", "createdAt": "2020-11-19T22:43:02Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -86,13 +87,15 @@ public TxnContext(@Nonnull final ObjectsView objectsView,\n     /**\n      * All write api must be validate to ensure that the table belongs to the namespace.\n      *\n-     * @param table - table being written to\n-     * @param <K> -type of the key\n-     * @param <V> - type of the payload/value\n-     * @param <M> - type of the metadata\n+     * @param table         - table being written to\n+     * @param key           - key used in the transaction to check for null.\n+     * @param validateKey   - should key be validated for null.\n+     * @param <K>           - type of the key\n+     * @param <V>           - type of the payload/value\n+     * @param <M>           - type of the metadata\n      */\n     private <K extends Message, V extends Message, M extends Message>\n-    void validateTableWrittenIsInNamespace(@Nonnull Table<K, V, M> table) {\n+    void validateWrite(@Nonnull Table<K, V, M> table, K key, boolean validateKey) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3NzA2OQ=="}, "originalCommit": {"oid": "51b570849d9a3f235077ee8fb9965caf992ba873"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNTQyNTAxOnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDozMTowMVrOH2wbow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo0NDoxOFrOH21BcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3ODY1OQ==", "bodyText": "Seems a little weird to manipulate the bitmask in a validate method.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r527178659", "createdAt": "2020-11-19T20:31:01Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -102,10 +105,24 @@ void validateTableWrittenIsInNamespace(@Nonnull Table<K, V, M> table) {\n                     \"TxnContext cannot be used after a transaction has ended on \"+\n                     table.getFullyQualifiedTableName());\n         }\n+        if (validateKey && key == null) {\n+            throw new IllegalArgumentException(\"Key cannot be null on \"\n+                    + table.getFullyQualifiedTableName() + \" in transaction on namespace \" + namespace);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b570849d9a3f235077ee8fb9965caf992ba873"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1Mzg3Mw==", "bodyText": "sure, open to any alternate suggestions for a better name.\nHow about preProcessMutation() ?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r527253873", "createdAt": "2020-11-19T22:44:18Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -102,10 +105,24 @@ void validateTableWrittenIsInNamespace(@Nonnull Table<K, V, M> table) {\n                     \"TxnContext cannot be used after a transaction has ended on \"+\n                     table.getFullyQualifiedTableName());\n         }\n+        if (validateKey && key == null) {\n+            throw new IllegalArgumentException(\"Key cannot be null on \"\n+                    + table.getFullyQualifiedTableName() + \" in transaction on namespace \" + namespace);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3ODY1OQ=="}, "originalCommit": {"oid": "51b570849d9a3f235077ee8fb9965caf992ba873"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxODcxOTI2OnYy", "diffSide": "RIGHT", "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjo1NTo1OVrOH4p3uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMjozMjozNlrOH5ZWnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE2ODMxMg==", "bodyText": "how about rootContext.setTxnContext(null)?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r529168312", "createdAt": "2020-11-24T02:55:59Z", "author": {"login": "Lujie1996"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -649,21 +745,35 @@ private void txBeginInternal() {\n      * Otherwise this throws a TransactionAbortedException with a cause.\n      * The cause and the caller's intent of the transaction can determine if this aborted\n      * Transaction can be retried.\n+     * If there are any post-commit callbacks registered, they will be invoked.\n      * @return - address at which the commit of this transaction occurred.\n      */\n     public long commit() {\n-        if (!TransactionalContext.isInTransaction()) {\n+        if (!isInMyTransaction()) {\n             throw new IllegalStateException(\"commit() called without a transaction!\");\n         }\n+\n+        // Apply any buffered up operations.\n         operations.forEach(Runnable::run);\n-        long commitAddress;\n-        try {\n-            commitAddress = this.objectsView.TXEnd();\n-        } catch (Exception ex) {\n-            tablesInTxn.values().forEach(t -> t.getMetrics().incNumTxnAborts());\n-            tablesInTxn.clear();\n-            throw ex;\n+\n+        // CorfuStore should have only one transactional context since nesting is prohibited.\n+        AbstractTransactionalContext rootContext = TransactionalContext.getRootContext();\n+        // Regardless of transaction outcome remove any TxnContext association from ThreadLocal.\n+        TransactionalContext.getRootContext().setTxnContext(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e"}, "originalPosition": 353}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk0NjI3MQ==", "bodyText": "done. thanks", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r529946271", "createdAt": "2020-11-24T22:32:36Z", "author": {"login": "hisundar"}, "path": "runtime/src/main/java/org/corfudb/runtime/collections/TxnContext.java", "diffHunk": "@@ -649,21 +745,35 @@ private void txBeginInternal() {\n      * Otherwise this throws a TransactionAbortedException with a cause.\n      * The cause and the caller's intent of the transaction can determine if this aborted\n      * Transaction can be retried.\n+     * If there are any post-commit callbacks registered, they will be invoked.\n      * @return - address at which the commit of this transaction occurred.\n      */\n     public long commit() {\n-        if (!TransactionalContext.isInTransaction()) {\n+        if (!isInMyTransaction()) {\n             throw new IllegalStateException(\"commit() called without a transaction!\");\n         }\n+\n+        // Apply any buffered up operations.\n         operations.forEach(Runnable::run);\n-        long commitAddress;\n-        try {\n-            commitAddress = this.objectsView.TXEnd();\n-        } catch (Exception ex) {\n-            tablesInTxn.values().forEach(t -> t.getMetrics().incNumTxnAborts());\n-            tablesInTxn.clear();\n-            throw ex;\n+\n+        // CorfuStore should have only one transactional context since nesting is prohibited.\n+        AbstractTransactionalContext rootContext = TransactionalContext.getRootContext();\n+        // Regardless of transaction outcome remove any TxnContext association from ThreadLocal.\n+        TransactionalContext.getRootContext().setTxnContext(null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE2ODMxMg=="}, "originalCommit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e"}, "originalPosition": 353}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxODc4NjQxOnYy", "diffSide": "RIGHT", "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreShimTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMzozMTowM1rOH4qhxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMjozODozNFrOH5Zv8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE3OTA3OQ==", "bodyText": "Where is this commitCallback used?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r529179079", "createdAt": "2020-11-24T03:31:03Z", "author": {"login": "Lujie1996"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreShimTest.java", "diffHunk": "@@ -473,25 +482,125 @@ public void onCommit(Map<String, List<CorfuStreamEntry>> mutations) {\n             }\n         }\n \n-        try (TxnContextShim txn = shimStore.txn(someNamespace)) {\n-            txn.delete(tableName, key);\n-            txn.commit((mutations) -> {\n-                 mutations.values().forEach(mutation -> {\n-                     CorfuStreamEntry.OperationType op = mutation.get(0).getOperation();\n-                     assertThat(op).isEqualTo(CorfuStreamEntry.OperationType.DELETE);\n-                 });\n+        CommitCallbackImpl commitCallback = new CommitCallbackImpl();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e"}, "originalPosition": 221}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk0NTkwNg==", "bodyText": "it is used by verticals to extract the modified metadata. It can also serve as a way to do fast table notifications.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r529945906", "createdAt": "2020-11-24T22:32:15Z", "author": {"login": "hisundar"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreShimTest.java", "diffHunk": "@@ -473,25 +482,125 @@ public void onCommit(Map<String, List<CorfuStreamEntry>> mutations) {\n             }\n         }\n \n-        try (TxnContextShim txn = shimStore.txn(someNamespace)) {\n-            txn.delete(tableName, key);\n-            txn.commit((mutations) -> {\n-                 mutations.values().forEach(mutation -> {\n-                     CorfuStreamEntry.OperationType op = mutation.get(0).getOperation();\n-                     assertThat(op).isEqualTo(CorfuStreamEntry.OperationType.DELETE);\n-                 });\n+        CommitCallbackImpl commitCallback = new CommitCallbackImpl();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE3OTA3OQ=="}, "originalCommit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e"}, "originalPosition": 221}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk1Mjc1Mw==", "bodyText": "But I couldn't find the usage of this commitCallback variable in this test. The following txn.addCommitCallback() adds its own callback lambda function right?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2824#discussion_r529952753", "createdAt": "2020-11-24T22:38:34Z", "author": {"login": "Lujie1996"}, "path": "test/src/test/java/org/corfudb/runtime/collections/CorfuStoreShimTest.java", "diffHunk": "@@ -473,25 +482,125 @@ public void onCommit(Map<String, List<CorfuStreamEntry>> mutations) {\n             }\n         }\n \n-        try (TxnContextShim txn = shimStore.txn(someNamespace)) {\n-            txn.delete(tableName, key);\n-            txn.commit((mutations) -> {\n-                 mutations.values().forEach(mutation -> {\n-                     CorfuStreamEntry.OperationType op = mutation.get(0).getOperation();\n-                     assertThat(op).isEqualTo(CorfuStreamEntry.OperationType.DELETE);\n-                 });\n+        CommitCallbackImpl commitCallback = new CommitCallbackImpl();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE3OTA3OQ=="}, "originalCommit": {"oid": "9a91e5774a928d2154862cf5203b346a870aee2e"}, "originalPosition": 221}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1776, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}