{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MTE2MTk5", "number": 2600, "title": "Startup TopologyConfigId Fix Receiver", "bodyText": "Overview\nDescription:\nOn receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\nWhy should this be merged: Bug Fix, when starting on a topologyConfigId != 0 all messages are dropped by the receiver.", "createdAt": "2020-07-07T03:06:59Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600", "merged": true, "mergeCommit": {"oid": "7cc53398158f2ee748b92a96e9d6f737da3cd08a"}, "closed": true, "closedAt": "2020-07-11T06:47:34Z", "author": {"login": "annym"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyc_dSgFqTQ0MzUzMjA0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABczutAsgFqTQ0Njc3MDI2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTMyMDQ3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#pullrequestreview-443532047", "createdAt": "2020-07-07T03:08:57Z", "commit": {"oid": "778677bdea92618d952e4c7ff6f94d0bbd359641"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMzowODo1N1rOGttpxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwMzowODo1N1rOGttpxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzA3OQ==", "bodyText": "I have a test to verify this fix. It will come as part of another PR as it has refactored the CorfuLogReplicationE2ETest to make the methods as utils for other tests.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r450587079", "createdAt": "2020-07-07T03:08:57Z", "author": {"login": "annym"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/replication/receive/LogReplicationSinkManager.java", "diffHunk": "@@ -113,6 +108,7 @@ public LogReplicationSinkManager(String localCorfuEndpoint, LogReplicationConfig\n          */\n         this.rxState = RxState.LOG_ENTRY_SYNC;\n         this.config = config;\n+        this.topologyConfigId = topologyConfigId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "778677bdea92618d952e4c7ff6f94d0bbd359641"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "778677bdea92618d952e4c7ff6f94d0bbd359641", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/778677bdea92618d952e4c7ff6f94d0bbd359641", "committedDate": "2020-07-07T02:46:18Z", "message": "Startup TopologyConfigId Fix Receiver\n\nOn receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message."}, "afterCommit": {"oid": "2acff5cab97f61758ca51823f8284661965d44b2", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/2acff5cab97f61758ca51823f8284661965d44b2", "committedDate": "2020-07-08T04:12:28Z", "message": "Startup TopologyConfigId Fix Receiver\n\nOn receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDA5NDMy", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#pullrequestreview-445009432", "createdAt": "2020-07-08T18:04:58Z", "commit": {"oid": "2acff5cab97f61758ca51823f8284661965d44b2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODowNDo1OFrOGuzhRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODowNDo1OFrOGuzhRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczMTc4Mw==", "bodyText": "Just doing updateTopologyConfigID is not enough. While process a topology change event, the discovery service does more work refer to processTopologyChangeNotification.\nWhile combining two events topology change and leadership change together, it is a bit complex.\nWould suggest to not call the fetchTopologyFromClusterManager.  First, the topology change is a notification API from clusterManager. Even with this call, it will fetch the cached value from clusterManagerAdapter. Second, it just add more complexity and doesn't completely solve the problem.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r451731783", "createdAt": "2020-07-08T18:04:58Z", "author": {"login": "xiaoqin2012"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -396,9 +419,28 @@ private void stopLogReplication() {\n     public void processLockAcquire() {\n         log.debug(\"Process lock acquire event\");\n         isLeader = true;\n+\n+        // Regardless of the role of this node, on leadership acquisition\n+        // we shall query the topology provider to get the most up to date\n+        // topologyConfigId, which might have changed during our time as non-leaders\n+        // and for which we might have missed the change notification and update it on\n+        // the sink manager so the value is cached to filter messages upon receive.\n+        fetchTopologyFromClusterManager();\n+        updateTopologyConfigId(topologyDescriptor.getTopologyConfigId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2acff5cab97f61758ca51823f8284661965d44b2"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDcyMTU5", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#pullrequestreview-445072159", "createdAt": "2020-07-08T19:37:13Z", "commit": {"oid": "2acff5cab97f61758ca51823f8284661965d44b2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxOTozNzoxM1rOGu2iMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxOTozNzoxM1rOGu2iMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4MTE3MA==", "bodyText": "I think we missed 'logReplicationServerHandler.setActive' after updating localTopology.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r451781170", "createdAt": "2020-07-08T19:37:13Z", "author": {"login": "zhangn49"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -396,9 +419,28 @@ private void stopLogReplication() {\n     public void processLockAcquire() {\n         log.debug(\"Process lock acquire event\");\n         isLeader = true;\n+\n+        // Regardless of the role of this node, on leadership acquisition\n+        // we shall query the topology provider to get the most up to date\n+        // topologyConfigId, which might have changed during our time as non-leaders\n+        // and for which we might have missed the change notification and update it on\n+        // the sink manager so the value is cached to filter messages upon receive.\n+        fetchTopologyFromClusterManager();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2acff5cab97f61758ca51823f8284661965d44b2"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDc1MzY2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#pullrequestreview-445075366", "createdAt": "2020-07-08T19:42:12Z", "commit": {"oid": "2acff5cab97f61758ca51823f8284661965d44b2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxOTo0MjoxMlrOGu2r4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxOTo0MjoxMlrOGu2r4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc4MzY0OA==", "bodyText": "One more thought is when we process config change event notification, we are using the config from that notification message, which might be delayed/outdated. I was wondering if we can fetch latest one to skip those outdated ones?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#discussion_r451783648", "createdAt": "2020-07-08T19:42:12Z", "author": {"login": "zhangn49"}, "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -370,6 +370,29 @@ private void onLeadershipAcquire() {\n         }\n     }\n \n+    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2acff5cab97f61758ca51823f8284661965d44b2"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2acff5cab97f61758ca51823f8284661965d44b2", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/2acff5cab97f61758ca51823f8284661965d44b2", "committedDate": "2020-07-08T04:12:28Z", "message": "Startup TopologyConfigId Fix Receiver\n\nOn receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message."}, "afterCommit": {"oid": "dea3a003a338449e6838c96328b0be479d1b12aa", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/dea3a003a338449e6838c96328b0be479d1b12aa", "committedDate": "2020-07-11T00:09:22Z", "message": "Startup TopologyConfigId Fix Receiver\n\n- On receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\n- Allow clusters to be onboarded later to ClusterManager without stopping LR completely.\n- Cluster Role Change or Addition/Removal of standby clusters is determined by analyzing\nTopologyDescriptors and not relying on topologyConfigId."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dea3a003a338449e6838c96328b0be479d1b12aa", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/dea3a003a338449e6838c96328b0be479d1b12aa", "committedDate": "2020-07-11T00:09:22Z", "message": "Startup TopologyConfigId Fix Receiver\n\n- On receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\n- Allow clusters to be onboarded later to ClusterManager without stopping LR completely.\n- Cluster Role Change or Addition/Removal of standby clusters is determined by analyzing\nTopologyDescriptors and not relying on topologyConfigId."}, "afterCommit": {"oid": "68a146cf0e049df9a19a59cd0f32db2cf10bca4b", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/68a146cf0e049df9a19a59cd0f32db2cf10bca4b", "committedDate": "2020-07-11T01:02:07Z", "message": "Startup TopologyConfigId Fix Receiver\n\n- On receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\n- Allow clusters to be onboarded later to ClusterManager without stopping LR completely.\n- Cluster Role Change or Addition/Removal of standby clusters is determined by analyzing\nTopologyDescriptors and not relying on topologyConfigId."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzY4NjY2", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#pullrequestreview-446768666", "createdAt": "2020-07-11T01:57:47Z", "commit": {"oid": "dea3a003a338449e6838c96328b0be479d1b12aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eafd53f303baeb060b5d436e412cf8c860e1f81d", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/eafd53f303baeb060b5d436e412cf8c860e1f81d", "committedDate": "2020-07-11T02:18:23Z", "message": "TopologyConfigId Update + Cluster Manager Support\n\n- On receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\n- Allow clusters to be onboarded later to ClusterManager without stopping LR completely.\n- Cluster Role Change or Addition/Removal of standby clusters is determined by analyzing\nTopologyDescriptors and not relying on topologyConfigId."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68a146cf0e049df9a19a59cd0f32db2cf10bca4b", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/68a146cf0e049df9a19a59cd0f32db2cf10bca4b", "committedDate": "2020-07-11T01:02:07Z", "message": "Startup TopologyConfigId Fix Receiver\n\n- On receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\n- Allow clusters to be onboarded later to ClusterManager without stopping LR completely.\n- Cluster Role Change or Addition/Removal of standby clusters is determined by analyzing\nTopologyDescriptors and not relying on topologyConfigId."}, "afterCommit": {"oid": "eafd53f303baeb060b5d436e412cf8c860e1f81d", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/eafd53f303baeb060b5d436e412cf8c860e1f81d", "committedDate": "2020-07-11T02:18:23Z", "message": "TopologyConfigId Update + Cluster Manager Support\n\n- On receiver startup the topologyConfigId needs to be initialized\nor received messages will be filtered out due to different topology\nconfig id when compared to the one in the message.\n- Allow clusters to be onboarded later to ClusterManager without stopping LR completely.\n- Cluster Role Change or Addition/Removal of standby clusters is determined by analyzing\nTopologyDescriptors and not relying on topologyConfigId."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzcwMjY5", "url": "https://github.com/CorfuDB/CorfuDB/pull/2600#pullrequestreview-446770269", "createdAt": "2020-07-11T02:21:01Z", "commit": {"oid": "eafd53f303baeb060b5d436e412cf8c860e1f81d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4213, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}