{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5MzQzNDU4", "number": 2758, "title": "Non-Transactional Access Trim Exception Handling", "bodyText": "Overview\nDescription:\nHandle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state.\nWhy should this be merged: existing bug which manifests in intermittent data loss.\nChecklist (Definition of Done):\n\n There are no TODOs left in the code\n Coding conventions (e.g. for logging, unit tests) have been followed\n Change is covered by automated tests\n Public API has Javadoc", "createdAt": "2020-09-04T06:30:25Z", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758", "merged": true, "mergeCommit": {"oid": "76b85729e865b83ff86b581130de8f51de793a15"}, "closed": true, "closedAt": "2020-09-08T19:20:27Z", "author": {"login": "annym"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFfR0zgBqjM3MjgxNTIwMTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdG8jx9AFqTQ4NDQyMjkzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59234615a413e7974b6990fc669c237dcb3f73bd", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/59234615a413e7974b6990fc669c237dcb3f73bd", "committedDate": "2020-09-04T06:25:13Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}, "afterCommit": {"oid": "f8a4fd4c322fa412161dbbe0e62af9f170aae835", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/f8a4fd4c322fa412161dbbe0e62af9f170aae835", "committedDate": "2020-09-04T06:33:09Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzk1MTM1", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#pullrequestreview-482395135", "createdAt": "2020-09-04T06:39:35Z", "commit": {"oid": "f8a4fd4c322fa412161dbbe0e62af9f170aae835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNjozOTozNVrOHNBemQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNjozOTozNVrOHNBemQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQxNzc1Mw==", "bodyText": "You need a break here otherwise it will run 2 times on every access.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483417753", "createdAt": "2020-09-04T06:39:35Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/CorfuCompileProxy.java", "diffHunk": "@@ -184,31 +185,34 @@ public CorfuCompileProxy(CorfuRuntime rt, UUID streamID, Class<T> type, Object[]\n             }\n         }\n \n-        // Perform underlying access\n-        for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n-            // Linearize this read against a timestamp\n-            final long timestamp = rt.getSequencerView()\n-                            .query(getStreamID());\n-            log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n+        // Linearize this read against a timestamp\n+        AtomicLong timestamp = new AtomicLong(rt.getSequencerView().query(getStreamID()));\n \n-            try {\n-                return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp\n-                                && !o.isOptimisticallyModifiedUnsafe(),\n-                        o -> o.syncObjectUnsafe(timestamp),\n-                        o -> accessMethod.access(o));\n-            } catch (TrimmedException te) {\n-                log.info(\"accessInner: Encountered trimmed address space \" +\n-                    \"while accessing version {} of stream {} on attempt {}\",\n-                    timestamp, getStreamID(), x);\n-                // We encountered a TRIM during sync, reset the object\n-                underlyingObject.update(o -> {\n-                    o.resetUnsafe();\n-                    return null;\n-                });\n-            }\n-        }\n+        log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n \n-        throw new TrimmedException();\n+        // Perform underlying access\n+        return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp.get()\n+                        && !o.isOptimisticallyModifiedUnsafe(),\n+                o -> {\n+                    for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n+                        try {\n+                            timestamp.set(rt.getSequencerView()\n+                                    .query(getStreamID()));\n+                            o.syncObjectUnsafe(timestamp.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a4fd4c322fa412161dbbe0e62af9f170aae835"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMzk2Nzg4", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#pullrequestreview-482396788", "createdAt": "2020-09-04T06:42:57Z", "commit": {"oid": "f8a4fd4c322fa412161dbbe0e62af9f170aae835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNjo0Mjo1N1rOHNBj1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNjo0Mjo1N1rOHNBj1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQxOTA5Mg==", "bodyText": "Move this to the catch block otherwise you'll have two sequencer queries per access.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483419092", "createdAt": "2020-09-04T06:42:57Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/CorfuCompileProxy.java", "diffHunk": "@@ -184,31 +185,34 @@ public CorfuCompileProxy(CorfuRuntime rt, UUID streamID, Class<T> type, Object[]\n             }\n         }\n \n-        // Perform underlying access\n-        for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n-            // Linearize this read against a timestamp\n-            final long timestamp = rt.getSequencerView()\n-                            .query(getStreamID());\n-            log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n+        // Linearize this read against a timestamp\n+        AtomicLong timestamp = new AtomicLong(rt.getSequencerView().query(getStreamID()));\n \n-            try {\n-                return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp\n-                                && !o.isOptimisticallyModifiedUnsafe(),\n-                        o -> o.syncObjectUnsafe(timestamp),\n-                        o -> accessMethod.access(o));\n-            } catch (TrimmedException te) {\n-                log.info(\"accessInner: Encountered trimmed address space \" +\n-                    \"while accessing version {} of stream {} on attempt {}\",\n-                    timestamp, getStreamID(), x);\n-                // We encountered a TRIM during sync, reset the object\n-                underlyingObject.update(o -> {\n-                    o.resetUnsafe();\n-                    return null;\n-                });\n-            }\n-        }\n+        log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n \n-        throw new TrimmedException();\n+        // Perform underlying access\n+        return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp.get()\n+                        && !o.isOptimisticallyModifiedUnsafe(),\n+                o -> {\n+                    for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n+                        try {\n+                            timestamp.set(rt.getSequencerView()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a4fd4c322fa412161dbbe0e62af9f170aae835"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDAyNDcx", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#pullrequestreview-482402471", "createdAt": "2020-09-04T06:54:25Z", "commit": {"oid": "f8a4fd4c322fa412161dbbe0e62af9f170aae835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNjo1NDoyNlrOHNB1-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNjo1NDoyNlrOHNB1-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQyMzczOQ==", "bodyText": "Btw, getUpcallResultInner has the same problem. The reset in the catch block should be part of the update lambda to be executed under the same lock.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483423739", "createdAt": "2020-09-04T06:54:26Z", "author": {"login": "Maithem"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/CorfuCompileProxy.java", "diffHunk": "@@ -184,31 +185,34 @@ public CorfuCompileProxy(CorfuRuntime rt, UUID streamID, Class<T> type, Object[]\n             }\n         }\n \n-        // Perform underlying access\n-        for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n-            // Linearize this read against a timestamp\n-            final long timestamp = rt.getSequencerView()\n-                            .query(getStreamID());\n-            log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n+        // Linearize this read against a timestamp\n+        AtomicLong timestamp = new AtomicLong(rt.getSequencerView().query(getStreamID()));\n \n-            try {\n-                return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp\n-                                && !o.isOptimisticallyModifiedUnsafe(),\n-                        o -> o.syncObjectUnsafe(timestamp),\n-                        o -> accessMethod.access(o));\n-            } catch (TrimmedException te) {\n-                log.info(\"accessInner: Encountered trimmed address space \" +\n-                    \"while accessing version {} of stream {} on attempt {}\",\n-                    timestamp, getStreamID(), x);\n-                // We encountered a TRIM during sync, reset the object\n-                underlyingObject.update(o -> {\n-                    o.resetUnsafe();\n-                    return null;\n-                });\n-            }\n-        }\n+        log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n \n-        throw new TrimmedException();\n+        // Perform underlying access", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8a4fd4c322fa412161dbbe0e62af9f170aae835"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8a4fd4c322fa412161dbbe0e62af9f170aae835", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/f8a4fd4c322fa412161dbbe0e62af9f170aae835", "committedDate": "2020-09-04T06:33:09Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}, "afterCommit": {"oid": "e2f1d1bc6ad17be76b97d18407dff1a9275eb47e", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/e2f1d1bc6ad17be76b97d18407dff1a9275eb47e", "committedDate": "2020-09-04T07:35:40Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2f1d1bc6ad17be76b97d18407dff1a9275eb47e", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/e2f1d1bc6ad17be76b97d18407dff1a9275eb47e", "committedDate": "2020-09-04T07:35:40Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}, "afterCommit": {"oid": "60fbf4cf56ceed9911d18b3ba2241582beea9aed", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/60fbf4cf56ceed9911d18b3ba2241582beea9aed", "committedDate": "2020-09-04T07:45:47Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDQwNjI0", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#pullrequestreview-482440624", "createdAt": "2020-09-04T07:59:08Z", "commit": {"oid": "60fbf4cf56ceed9911d18b3ba2241582beea9aed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDM5MDMz", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#pullrequestreview-482439033", "createdAt": "2020-09-04T07:56:51Z", "commit": {"oid": "60fbf4cf56ceed9911d18b3ba2241582beea9aed"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNzo1Njo1MVrOHNDmDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODozNjoyMlrOHNE3aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MjQyOQ==", "bodyText": "I think this line should be moved before the if check: for the last retry we also need to reset the object", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483452429", "createdAt": "2020-09-04T07:56:51Z", "author": {"login": "WenbinZhu"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/CorfuCompileProxy.java", "diffHunk": "@@ -184,31 +185,35 @@ public CorfuCompileProxy(CorfuRuntime rt, UUID streamID, Class<T> type, Object[]\n             }\n         }\n \n-        // Perform underlying access\n-        for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n-            // Linearize this read against a timestamp\n-            final long timestamp = rt.getSequencerView()\n-                            .query(getStreamID());\n-            log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n+        // Linearize this read against a timestamp\n+        AtomicLong timestamp = new AtomicLong(rt.getSequencerView().query(getStreamID()));\n \n-            try {\n-                return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp\n-                                && !o.isOptimisticallyModifiedUnsafe(),\n-                        o -> o.syncObjectUnsafe(timestamp),\n-                        o -> accessMethod.access(o));\n-            } catch (TrimmedException te) {\n-                log.info(\"accessInner: Encountered trimmed address space \" +\n-                    \"while accessing version {} of stream {} on attempt {}\",\n-                    timestamp, getStreamID(), x);\n-                // We encountered a TRIM during sync, reset the object\n-                underlyingObject.update(o -> {\n-                    o.resetUnsafe();\n-                    return null;\n-                });\n-            }\n-        }\n+        log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n \n-        throw new TrimmedException();\n+        // Perform underlying access\n+        return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp.get()\n+                        && !o.isOptimisticallyModifiedUnsafe(),\n+                o -> {\n+                    for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n+                        try {\n+                            o.syncObjectUnsafe(timestamp.get());\n+                            break;\n+                        } catch (TrimmedException te) {\n+                            log.info(\"accessInner: Encountered trimmed address space \" +\n+                                            \"while accessing version {} of stream {} on attempt {}\",\n+                                    timestamp.get(), getStreamID(), x);\n+\n+                            if (x == (rt.getParameters().getTrimRetry() - 1)) {\n+                                throw te;\n+                            }\n+\n+                            o.resetUnsafe();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60fbf4cf56ceed9911d18b3ba2241582beea9aed"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1OTg4Nw==", "bodyText": "Here reset should not be inside update() method, otherwise since StampedLock is not reentrant, this could be deadlock", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483459887", "createdAt": "2020-09-04T08:11:20Z", "author": {"login": "WenbinZhu"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/CorfuCompileProxy.java", "diffHunk": "@@ -280,39 +285,39 @@ private long logUpdateInner(String smrUpdateFunction, final boolean keepUpcallRe\n             return ret == VersionLockedObject.NullValue.NULL_VALUE ? null : ret;\n         }\n \n-        for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n-            try {\n-                return underlyingObject.update(o -> {\n-                    o.syncObjectUnsafe(timestamp);\n-                    if (o.getUpcallResults().containsKey(timestamp)) {\n-                        log.trace(\"Upcall[{}] {} Sync'd\", this, timestamp);\n-                        R ret = (R) o.getUpcallResults().get(timestamp);\n-                        o.getUpcallResults().remove(timestamp);\n-                        return ret == VersionLockedObject.NullValue.NULL_VALUE ? null : ret;\n+        return underlyingObject.update(o -> {\n+                    for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n+                        try {\n+                            o.syncObjectUnsafe(timestamp);\n+                            if (o.getUpcallResults().containsKey(timestamp)) {\n+                                log.trace(\"Upcall[{}] {} Sync'd\", this, timestamp);\n+                                R ret = (R) o.getUpcallResults().get(timestamp);\n+                                o.getUpcallResults().remove(timestamp);\n+                                return ret == VersionLockedObject.NullValue.NULL_VALUE ? null : ret;\n+                            }\n+\n+                            // The version is already ahead, but we don't have the result.\n+                            // The only way to get the correct result\n+                            // of the upcall would be to rollback. For now, we throw an exception\n+                            // since this is generally not expected. --- and probably a bug if it happens.\n+                            throw new RuntimeException(\"Attempted to get the result \"\n+                                    + \"of an upcall@\" + timestamp + \" but we are @\"\n+                                    + underlyingObject.getVersionUnsafe()\n+                                    + \" and we don't have a copy\");\n+                        } catch (TrimmedException ex) {\n+                            log.info(\"getUpcallResultInner: Encountered trimmed address space \" +\n+                                            \"while accessing version {} of stream {} on attempt {}\",\n+                                    timestamp, getStreamID(), x);\n+                            // We encountered a TRIM during sync, reset the object\n+                            underlyingObject.update(obj -> {\n+                                obj.resetUnsafe();\n+                                return null;\n+                            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60fbf4cf56ceed9911d18b3ba2241582beea9aed"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MjE2Mg==", "bodyText": "Can you add this log line in transactional access as well? https://github.com/CorfuDB/CorfuDB/blob/master/runtime/src/main/java/org/corfudb/runtime/object/transactions/AbstractTransactionalContext.java#L217\nWe used to have a hard time debugging trimmed exception in transaction case,  as there is no log, I think this could be an opportunity to add the same log line in transactional access as well.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483462162", "createdAt": "2020-09-04T08:15:39Z", "author": {"login": "WenbinZhu"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/CorfuCompileProxy.java", "diffHunk": "@@ -184,31 +185,35 @@ public CorfuCompileProxy(CorfuRuntime rt, UUID streamID, Class<T> type, Object[]\n             }\n         }\n \n-        // Perform underlying access\n-        for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n-            // Linearize this read against a timestamp\n-            final long timestamp = rt.getSequencerView()\n-                            .query(getStreamID());\n-            log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n+        // Linearize this read against a timestamp\n+        AtomicLong timestamp = new AtomicLong(rt.getSequencerView().query(getStreamID()));\n \n-            try {\n-                return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp\n-                                && !o.isOptimisticallyModifiedUnsafe(),\n-                        o -> o.syncObjectUnsafe(timestamp),\n-                        o -> accessMethod.access(o));\n-            } catch (TrimmedException te) {\n-                log.info(\"accessInner: Encountered trimmed address space \" +\n-                    \"while accessing version {} of stream {} on attempt {}\",\n-                    timestamp, getStreamID(), x);\n-                // We encountered a TRIM during sync, reset the object\n-                underlyingObject.update(o -> {\n-                    o.resetUnsafe();\n-                    return null;\n-                });\n-            }\n-        }\n+        log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n \n-        throw new TrimmedException();\n+        // Perform underlying access\n+        return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp.get()\n+                        && !o.isOptimisticallyModifiedUnsafe(),\n+                o -> {\n+                    for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n+                        try {\n+                            o.syncObjectUnsafe(timestamp.get());\n+                            break;\n+                        } catch (TrimmedException te) {\n+                            log.info(\"accessInner: Encountered trimmed address space \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60fbf4cf56ceed9911d18b3ba2241582beea9aed"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3MjkzMw==", "bodyText": "NIT: this can be in one line.", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483472933", "createdAt": "2020-09-04T08:35:40Z", "author": {"login": "WenbinZhu"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/CorfuCompileProxy.java", "diffHunk": "@@ -184,31 +185,35 @@ public CorfuCompileProxy(CorfuRuntime rt, UUID streamID, Class<T> type, Object[]\n             }\n         }\n \n-        // Perform underlying access\n-        for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n-            // Linearize this read against a timestamp\n-            final long timestamp = rt.getSequencerView()\n-                            .query(getStreamID());\n-            log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n+        // Linearize this read against a timestamp\n+        AtomicLong timestamp = new AtomicLong(rt.getSequencerView().query(getStreamID()));\n \n-            try {\n-                return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp\n-                                && !o.isOptimisticallyModifiedUnsafe(),\n-                        o -> o.syncObjectUnsafe(timestamp),\n-                        o -> accessMethod.access(o));\n-            } catch (TrimmedException te) {\n-                log.info(\"accessInner: Encountered trimmed address space \" +\n-                    \"while accessing version {} of stream {} on attempt {}\",\n-                    timestamp, getStreamID(), x);\n-                // We encountered a TRIM during sync, reset the object\n-                underlyingObject.update(o -> {\n-                    o.resetUnsafe();\n-                    return null;\n-                });\n-            }\n-        }\n+        log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n \n-        throw new TrimmedException();\n+        // Perform underlying access\n+        return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp.get()\n+                        && !o.isOptimisticallyModifiedUnsafe(),\n+                o -> {\n+                    for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n+                        try {\n+                            o.syncObjectUnsafe(timestamp.get());\n+                            break;\n+                        } catch (TrimmedException te) {\n+                            log.info(\"accessInner: Encountered trimmed address space \" +\n+                                            \"while accessing version {} of stream {} on attempt {}\",\n+                                    timestamp.get(), getStreamID(), x);\n+\n+                            if (x == (rt.getParameters().getTrimRetry() - 1)) {\n+                                throw te;\n+                            }\n+\n+                            o.resetUnsafe();\n+                            timestamp.set(rt.getSequencerView()\n+                                    .query(getStreamID()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60fbf4cf56ceed9911d18b3ba2241582beea9aed"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3MzI1Nw==", "bodyText": "Maybe we should check the number of retries and throw ex in the catch block and remove this line (same as what we did in accessInner)", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483473257", "createdAt": "2020-09-04T08:36:22Z", "author": {"login": "WenbinZhu"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/CorfuCompileProxy.java", "diffHunk": "@@ -280,39 +285,39 @@ private long logUpdateInner(String smrUpdateFunction, final boolean keepUpcallRe\n             return ret == VersionLockedObject.NullValue.NULL_VALUE ? null : ret;\n         }\n \n-        for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n-            try {\n-                return underlyingObject.update(o -> {\n-                    o.syncObjectUnsafe(timestamp);\n-                    if (o.getUpcallResults().containsKey(timestamp)) {\n-                        log.trace(\"Upcall[{}] {} Sync'd\", this, timestamp);\n-                        R ret = (R) o.getUpcallResults().get(timestamp);\n-                        o.getUpcallResults().remove(timestamp);\n-                        return ret == VersionLockedObject.NullValue.NULL_VALUE ? null : ret;\n+        return underlyingObject.update(o -> {\n+                    for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n+                        try {\n+                            o.syncObjectUnsafe(timestamp);\n+                            if (o.getUpcallResults().containsKey(timestamp)) {\n+                                log.trace(\"Upcall[{}] {} Sync'd\", this, timestamp);\n+                                R ret = (R) o.getUpcallResults().get(timestamp);\n+                                o.getUpcallResults().remove(timestamp);\n+                                return ret == VersionLockedObject.NullValue.NULL_VALUE ? null : ret;\n+                            }\n+\n+                            // The version is already ahead, but we don't have the result.\n+                            // The only way to get the correct result\n+                            // of the upcall would be to rollback. For now, we throw an exception\n+                            // since this is generally not expected. --- and probably a bug if it happens.\n+                            throw new RuntimeException(\"Attempted to get the result \"\n+                                    + \"of an upcall@\" + timestamp + \" but we are @\"\n+                                    + underlyingObject.getVersionUnsafe()\n+                                    + \" and we don't have a copy\");\n+                        } catch (TrimmedException ex) {\n+                            log.info(\"getUpcallResultInner: Encountered trimmed address space \" +\n+                                            \"while accessing version {} of stream {} on attempt {}\",\n+                                    timestamp, getStreamID(), x);\n+                            // We encountered a TRIM during sync, reset the object\n+                            underlyingObject.update(obj -> {\n+                                obj.resetUnsafe();\n+                                return null;\n+                            });\n+                        }\n                     }\n \n-                    // The version is already ahead, but we don't have the result.\n-                    // The only way to get the correct result\n-                    // of the upcall would be to rollback. For now, we throw an exception\n-                    // since this is generally not expected. --- and probably a bug if it happens.\n-                    throw new RuntimeException(\"Attempted to get the result \"\n-                            + \"of an upcall@\" + timestamp + \" but we are @\"\n-                            + underlyingObject.getVersionUnsafe()\n-                            + \" and we don't have a copy\");\n-                });\n-            } catch (TrimmedException ex) {\n-                log.info(\"getUpcallResultInner: Encountered trimmed address space \" +\n-                    \"while accessing version {} of stream {} on attempt {}\",\n-                    timestamp, getStreamID(), x);\n-                // We encountered a TRIM during sync, reset the object\n-                underlyingObject.update(o -> {\n-                    o.resetUnsafe();\n-                    return null;\n-                });\n-            }\n-        }\n-\n-        throw new TrimmedUpcallException(timestamp);\n+            throw new TrimmedUpcallException(timestamp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60fbf4cf56ceed9911d18b3ba2241582beea9aed"}, "originalPosition": 133}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60fbf4cf56ceed9911d18b3ba2241582beea9aed", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/60fbf4cf56ceed9911d18b3ba2241582beea9aed", "committedDate": "2020-09-04T07:45:47Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}, "afterCommit": {"oid": "ab88fd109efcceeee670c8953fbceb09c6ad65a6", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/ab88fd109efcceeee670c8953fbceb09c6ad65a6", "committedDate": "2020-09-05T01:08:32Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMDE4NzM3", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#pullrequestreview-483018737", "createdAt": "2020-09-05T01:08:56Z", "commit": {"oid": "60fbf4cf56ceed9911d18b3ba2241582beea9aed"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQwMTowOTo1MlrOHNefTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQwMToyMTo1NVrOHNekAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg5MzA3MQ==", "bodyText": "nit - indentation", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483893071", "createdAt": "2020-09-05T01:09:52Z", "author": {"login": "pankti-m"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/CorfuCompileProxy.java", "diffHunk": "@@ -280,39 +285,36 @@ private long logUpdateInner(String smrUpdateFunction, final boolean keepUpcallRe\n             return ret == VersionLockedObject.NullValue.NULL_VALUE ? null : ret;\n         }\n \n-        for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n-            try {\n-                return underlyingObject.update(o -> {\n-                    o.syncObjectUnsafe(timestamp);\n-                    if (o.getUpcallResults().containsKey(timestamp)) {\n-                        log.trace(\"Upcall[{}] {} Sync'd\", this, timestamp);\n-                        R ret = (R) o.getUpcallResults().get(timestamp);\n-                        o.getUpcallResults().remove(timestamp);\n-                        return ret == VersionLockedObject.NullValue.NULL_VALUE ? null : ret;\n+        return underlyingObject.update(o -> {\n+                    for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n+                        try {\n+                            o.syncObjectUnsafe(timestamp);\n+                            if (o.getUpcallResults().containsKey(timestamp)) {\n+                                log.trace(\"Upcall[{}] {} Sync'd\", this, timestamp);\n+                                R ret = (R) o.getUpcallResults().get(timestamp);\n+                                o.getUpcallResults().remove(timestamp);\n+                                return ret == VersionLockedObject.NullValue.NULL_VALUE ? null : ret;\n+                            }\n+\n+                            // The version is already ahead, but we don't have the result.\n+                            // The only way to get the correct result\n+                            // of the upcall would be to rollback. For now, we throw an exception\n+                            // since this is generally not expected. --- and probably a bug if it happens.\n+                            throw new RuntimeException(\"Attempted to get the result \"\n+                                    + \"of an upcall@\" + timestamp + \" but we are @\"\n+                                    + underlyingObject.getVersionUnsafe()\n+                                    + \" and we don't have a copy\");\n+                        } catch (TrimmedException ex) {\n+                            log.info(\"getUpcallResultInner: Encountered trimmed address space \" +\n+                                            \"while accessing version {} of stream {} on attempt {}\",\n+                                    timestamp, getStreamID(), x);\n+                            // We encountered a TRIM during sync, reset the object\n+                            o.resetUnsafe();\n+                        }\n                     }\n \n-                    // The version is already ahead, but we don't have the result.\n-                    // The only way to get the correct result\n-                    // of the upcall would be to rollback. For now, we throw an exception\n-                    // since this is generally not expected. --- and probably a bug if it happens.\n-                    throw new RuntimeException(\"Attempted to get the result \"\n-                            + \"of an upcall@\" + timestamp + \" but we are @\"\n-                            + underlyingObject.getVersionUnsafe()\n-                            + \" and we don't have a copy\");\n-                });\n-            } catch (TrimmedException ex) {\n-                log.info(\"getUpcallResultInner: Encountered trimmed address space \" +\n-                    \"while accessing version {} of stream {} on attempt {}\",\n-                    timestamp, getStreamID(), x);\n-                // We encountered a TRIM during sync, reset the object\n-                underlyingObject.update(o -> {\n-                    o.resetUnsafe();\n-                    return null;\n-                });\n-            }\n-        }\n-\n-        throw new TrimmedUpcallException(timestamp);\n+            throw new TrimmedUpcallException(timestamp);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab88fd109efcceeee670c8953fbceb09c6ad65a6"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg5MzY4OA==", "bodyText": "nit - extra ws", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483893688", "createdAt": "2020-09-05T01:15:51Z", "author": {"login": "pankti-m"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/VersionLockedObject.java", "diffHunk": "@@ -453,7 +453,7 @@ public void setUncommittedChanges(WriteSetSMRStream optimisticStream) {\n      *\n      * @return Returns the pointer position to the object in the stream.\n      */\n-    public long getVersionUnsafe() {\n+    public long  getVersionUnsafe() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab88fd109efcceeee670c8953fbceb09c6ad65a6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg5NDI3Mw==", "bodyText": "why do we need to set the timestamp here?  Is it expected to change after it was obtained in line 189?", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#discussion_r483894273", "createdAt": "2020-09-05T01:21:55Z", "author": {"login": "pankti-m"}, "path": "runtime/src/main/java/org/corfudb/runtime/object/CorfuCompileProxy.java", "diffHunk": "@@ -184,31 +185,35 @@ public CorfuCompileProxy(CorfuRuntime rt, UUID streamID, Class<T> type, Object[]\n             }\n         }\n \n-        // Perform underlying access\n-        for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n-            // Linearize this read against a timestamp\n-            final long timestamp = rt.getSequencerView()\n-                            .query(getStreamID());\n-            log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n+        // Linearize this read against a timestamp\n+        AtomicLong timestamp = new AtomicLong(rt.getSequencerView().query(getStreamID()));\n \n-            try {\n-                return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp\n-                                && !o.isOptimisticallyModifiedUnsafe(),\n-                        o -> o.syncObjectUnsafe(timestamp),\n-                        o -> accessMethod.access(o));\n-            } catch (TrimmedException te) {\n-                log.info(\"accessInner: Encountered trimmed address space \" +\n-                    \"while accessing version {} of stream {} on attempt {}\",\n-                    timestamp, getStreamID(), x);\n-                // We encountered a TRIM during sync, reset the object\n-                underlyingObject.update(o -> {\n-                    o.resetUnsafe();\n-                    return null;\n-                });\n-            }\n-        }\n+        log.debug(\"Access[{}] conflictObj={} version={}\", this, conflictObject, timestamp);\n \n-        throw new TrimmedException();\n+        // Perform underlying access\n+        return underlyingObject.access(o -> o.getVersionUnsafe() >= timestamp.get()\n+                        && !o.isOptimisticallyModifiedUnsafe(),\n+                o -> {\n+                    for (int x = 0; x < rt.getParameters().getTrimRetry(); x++) {\n+                        try {\n+                            o.syncObjectUnsafe(timestamp.get());\n+                            break;\n+                        } catch (TrimmedException te) {\n+                            log.info(\"accessInner: Encountered trimmed address space \" +\n+                                            \"while accessing version {} of stream {} on attempt {}\",\n+                                    timestamp.get(), getStreamID(), x);\n+\n+                            o.resetUnsafe();\n+\n+                            if (x == (rt.getParameters().getTrimRetry() - 1)) {\n+                                throw te;\n+                            }\n+\n+                            timestamp.set(rt.getSequencerView().query(getStreamID()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab88fd109efcceeee670c8953fbceb09c6ad65a6"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc0fadc1dbba31c095654ca3ba6cd7ee34801723", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/dc0fadc1dbba31c095654ca3ba6cd7ee34801723", "committedDate": "2020-09-05T01:39:52Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab88fd109efcceeee670c8953fbceb09c6ad65a6", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/ab88fd109efcceeee670c8953fbceb09c6ad65a6", "committedDate": "2020-09-05T01:08:32Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}, "afterCommit": {"oid": "dc0fadc1dbba31c095654ca3ba6cd7ee34801723", "author": {"user": {"login": "annym", "name": "Anny Martinez"}}, "url": "https://github.com/CorfuDB/CorfuDB/commit/dc0fadc1dbba31c095654ca3ba6cd7ee34801723", "committedDate": "2020-09-05T01:39:52Z", "message": "Non-Transactional Access Trim Exception Handling\n\n   Handle sync of non-transactional access under lock even in the event\nof TrimmedExceptions, otherwise, thread interleaving may lead to inconsistent state."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMDMyNzcw", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#pullrequestreview-483032770", "createdAt": "2020-09-05T05:44:37Z", "commit": {"oid": "dc0fadc1dbba31c095654ca3ba6cd7ee34801723"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDIyOTM1", "url": "https://github.com/CorfuDB/CorfuDB/pull/2758#pullrequestreview-484422935", "createdAt": "2020-09-08T19:14:10Z", "commit": {"oid": "dc0fadc1dbba31c095654ca3ba6cd7ee34801723"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4028, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}