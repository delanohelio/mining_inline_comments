{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NzMzMjEz", "number": 8790, "title": "SAK-44305 Messages > Save Draft > Recipient not Saved", "bodyText": "https://jira.sakaiproject.org/browse/SAK-44305\nMessages doesn't save recipients for drafts because that is effectively equivalent to sending the message (the recipients would see the message). Messages also only understands recipients as individual users. Any groups/roles selected in the message composition UI are automatically converted to a set of individual users when the message is sent.\nThis PR allows saving of the recipients for the draft by storing the UI selections (users/groups/roles) in a separate table. When re-opening the draft, saved the recipient entries (DraftRecipient) are matched up with the current UI recipient options (MembershipItem) to pre-populate the UI (since the ids for roles are randomly generated each time for the UI, this extra matching step is required). When sending the message, any entries for it in the draft recipients table are cleaned out.", "createdAt": "2020-11-06T13:08:50Z", "url": "https://github.com/sakaiproject/sakai/pull/8790", "merged": true, "mergeCommit": {"oid": "d297d8928b445ff99ec1a2b6b5a0134356c9d28f"}, "closed": true, "closedAt": "2020-11-24T16:21:22Z", "author": {"login": "plukasew"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ12V6AH2gAyNTE2NzMzMjEzOjQ2MTY3MWJmNTJkOTM4MDIxYTk3NjczZDBlZDgwYzJhODVkMGRhNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfsIkOAFqTUzNzY3ODc1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "461671bf52d938021a97673d0ed80c2a85d0da5f", "author": {"user": {"login": "plukasew", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/461671bf52d938021a97673d0ed80c2a85d0da5f", "committedDate": "2020-11-06T12:09:40Z", "message": "SAK-44305 Messages > Save Draft > Recipient not Saved"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MTg4Mjky", "url": "https://github.com/sakaiproject/sakai/pull/8790#pullrequestreview-525188292", "createdAt": "2020-11-06T14:17:56Z", "commit": {"oid": "f1110a9bc7ccfa1f3718c0a0598d8fe56610c5eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Mzc0OTI3", "url": "https://github.com/sakaiproject/sakai/pull/8790#pullrequestreview-525374927", "createdAt": "2020-11-06T17:57:58Z", "commit": {"oid": "f1110a9bc7ccfa1f3718c0a0598d8fe56610c5eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzo1Nzo1OFrOHu3-qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzo1Nzo1OFrOHu3-qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkxMzcwNQ==", "bodyText": "minor comment public is redundant on an interface", "url": "https://github.com/sakaiproject/sakai/pull/8790#discussion_r518913705", "createdAt": "2020-11-06T17:57:58Z", "author": {"login": "ern"}, "path": "msgcntr/messageforums-api/src/java/org/sakaiproject/api/app/messageforums/DraftRecipient.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package org.sakaiproject.api.app.messageforums;\n+\n+/**\n+ * This class represents a saved recipient for a draft message. It can represent a user, a group, a site role, a combination of those, or all participants.\n+ * It can be thought of as a more compact version of MembershipItem.\n+ *\n+ * @author plukasew\n+ */\n+public interface DraftRecipient\n+{\n+\tpublic static final String ALL_PARTICIPANTS_ID = \"all_participants\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1110a9bc7ccfa1f3718c0a0598d8fe56610c5eb"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Mzc5MzY5", "url": "https://github.com/sakaiproject/sakai/pull/8790#pullrequestreview-525379369", "createdAt": "2020-11-06T18:04:25Z", "commit": {"oid": "f1110a9bc7ccfa1f3718c0a0598d8fe56610c5eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxODowNDoyNVrOHu4L1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxODowNDoyNVrOHu4L1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkxNzA3OA==", "bodyText": "minor this can be further shortened removing intermediate vars:\nreturn getHibernateTemplate().execute(session -> session.getNamedQuery(\"findDraftRecipientsByMessageId\")\n           .setParameter()\n          .list();", "url": "https://github.com/sakaiproject/sakai/pull/8790#discussion_r518917078", "createdAt": "2020-11-06T18:04:25Z", "author": {"login": "ern"}, "path": "msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/MessageForumsMessageManagerImpl.java", "diffHunk": "@@ -2091,4 +2092,28 @@ public List findMovedHistoryByMessageId(final Long messageid){\n \n \t}\n \n+\t@Override\n+\tpublic void saveDraftRecipients(long msgId, List<DraftRecipient> recipients) {\n+\t\tfor (DraftRecipient dr : recipients) {\n+\t\t\tgetHibernateTemplate().persist(dr);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<DraftRecipient> findDraftRecipientsByMessageId(long msgId) {\n+\t\tHibernateCallback<List> hcb = session -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1110a9bc7ccfa1f3718c0a0598d8fe56610c5eb"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzgzMDAz", "url": "https://github.com/sakaiproject/sakai/pull/8790#pullrequestreview-525383003", "createdAt": "2020-11-06T18:09:58Z", "commit": {"oid": "f1110a9bc7ccfa1f3718c0a0598d8fe56610c5eb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxODowOTo1OFrOHu4W-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxODoxNDoxM1rOHu4fUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkxOTkzMA==", "bodyText": "Instead of an HBM please use JPA annotations plenty of examples, shouldn't take much to update.\nThe addition of new hbm files is prohibited, as they're all be converted to JPA.", "url": "https://github.com/sakaiproject/sakai/pull/8790#discussion_r518919930", "createdAt": "2020-11-06T18:09:58Z", "author": {"login": "ern"}, "path": "msgcntr/messageforums-hbm/src/java/org/sakaiproject/component/app/messageforums/dao/hibernate/DraftRecipient.hbm.xml", "diffHunk": "@@ -0,0 +1,39 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!DOCTYPE hibernate-mapping PUBLIC \"-//Hibernate/Hibernate Mapping DTD 3.0//EN\" \"http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd\">\n+<hibernate-mapping package=\"org.sakaiproject.component.app.messageforums.dao.hibernate\">\n+\n+  <class name=\"org.sakaiproject.component.app.messageforums.dao.hibernate.DraftRecipientImpl\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1110a9bc7ccfa1f3718c0a0598d8fe56610c5eb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyMjA2Nw==", "bodyText": "POJO's have little need for an interface and an impl move this to the interface and make it class", "url": "https://github.com/sakaiproject/sakai/pull/8790#discussion_r518922067", "createdAt": "2020-11-06T18:14:13Z", "author": {"login": "ern"}, "path": "msgcntr/messageforums-hbm/src/java/org/sakaiproject/component/app/messageforums/dao/hibernate/DraftRecipientImpl.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package org.sakaiproject.component.app.messageforums.dao.hibernate;\n+\n+import lombok.Getter;\n+import lombok.Setter;\n+import org.sakaiproject.api.app.messageforums.DraftRecipient;\n+import org.sakaiproject.api.app.messageforums.MembershipItem;\n+\n+@Getter @Setter\n+public class DraftRecipientImpl implements DraftRecipient", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1110a9bc7ccfa1f3718c0a0598d8fe56610c5eb"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed103b4b6cbf16eb2a0879f858722483411fd56", "author": {"user": {"login": "plukasew", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/1ed103b4b6cbf16eb2a0879f858722483411fd56", "committedDate": "2020-11-10T13:42:40Z", "message": "SAK-44305 switch to JPA"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1110a9bc7ccfa1f3718c0a0598d8fe56610c5eb", "author": {"user": {"login": "bjones86", "name": "Brian Jones"}}, "url": "https://github.com/sakaiproject/sakai/commit/f1110a9bc7ccfa1f3718c0a0598d8fe56610c5eb", "committedDate": "2020-11-06T14:17:25Z", "message": "tabs"}, "afterCommit": {"oid": "1ed103b4b6cbf16eb2a0879f858722483411fd56", "author": {"user": {"login": "plukasew", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/1ed103b4b6cbf16eb2a0879f858722483411fd56", "committedDate": "2020-11-10T13:42:40Z", "message": "SAK-44305 switch to JPA"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3Njc3NDU5", "url": "https://github.com/sakaiproject/sakai/pull/8790#pullrequestreview-537677459", "createdAt": "2020-11-24T16:12:45Z", "commit": {"oid": "1ed103b4b6cbf16eb2a0879f858722483411fd56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjoxMjo0NVrOH5KJtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjoxMjo0NVrOH5KJtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY5NzIwNw==", "bodyText": "Is this always adding a new transient DraftRecipient? if not will need to use merge", "url": "https://github.com/sakaiproject/sakai/pull/8790#discussion_r529697207", "createdAt": "2020-11-24T16:12:45Z", "author": {"login": "ern"}, "path": "msgcntr/messageforums-component-impl/src/java/org/sakaiproject/component/app/messageforums/MessageForumsMessageManagerImpl.java", "diffHunk": "@@ -2091,4 +2092,23 @@ public List findMovedHistoryByMessageId(final Long messageid){\n \n \t}\n \n+\t@Override\n+\tpublic void saveDraftRecipients(long msgId, List<DraftRecipient> recipients) {\n+\t\tfor (DraftRecipient dr : recipients) {\n+\t\t\tgetHibernateTemplate().persist(dr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ed103b4b6cbf16eb2a0879f858722483411fd56"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3Njc4NzU0", "url": "https://github.com/sakaiproject/sakai/pull/8790#pullrequestreview-537678754", "createdAt": "2020-11-24T16:14:04Z", "commit": {"oid": "1ed103b4b6cbf16eb2a0879f858722483411fd56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2450, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}