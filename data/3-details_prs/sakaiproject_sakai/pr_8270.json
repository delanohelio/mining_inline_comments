{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MDk3NjA0", "number": 8270, "title": "SAK-43238 Embedded Announcement block in Lessons display order", "bodyText": "https://jira.sakaiproject.org/browse/SAK-43238", "createdAt": "2020-06-04T21:21:04Z", "url": "https://github.com/sakaiproject/sakai/pull/8270", "merged": true, "mergeCommit": {"oid": "d9eb47c5c9711d029cb6c4e2d3805b14653aa21d"}, "closed": true, "closedAt": "2020-12-03T13:18:24Z", "author": {"login": "austin48"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpmwiRgFqTQyNzI3OTc1Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfsStogH2gAyNDI4MDk3NjA0OmZlNmUwODBkZWY1MmYwZGViZWQxZDE4ZGQ1MmFhZDNkNzQ2MWE3ZmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3Mjc5NzU2", "url": "https://github.com/sakaiproject/sakai/pull/8270#pullrequestreview-427279756", "createdAt": "2020-06-09T15:26:23Z", "commit": {"oid": "944c49c2b0d044a08b1fbac35c0629af1f709476"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNToyNjoyM1rOGhQGxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNToyNjoyM1rOGhQGxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyMDA3MQ==", "bodyText": "Use newer logging lingo (slf4j) log.debug", "url": "https://github.com/sakaiproject/sakai/pull/8270#discussion_r437520071", "createdAt": "2020-06-09T15:26:23Z", "author": {"login": "ern"}, "path": "announcement/announcement-tool/tool/src/java/org/sakaiproject/announcement/entityprovider/AnnouncementEntityProviderImpl.java", "diffHunk": "@@ -243,6 +257,29 @@ public String getEntityPrefix() {\n \t\t\tlog.debug(\"announcements.size(): {}\", announcements.size());\n \t\t}\n \t\t\n+\t\tif (AnnouncementAction.SORT_MESSAGE_ORDER.equals(sortCurrentOrder)) {\n+\t\t\ttry {\n+\t\t\t\tList<AnnouncementWrapper> messageList = new ArrayList<>();\n+\t\t\t\tAnnouncementChannel defaultChannel = (AnnouncementChannel) announcementService.getChannel(\"/announcement/channel/\" + siteId + \"/main\");\n+\t\t\t\tfor (Message msg : announcements) {\n+\t\t\t\t\tAnnouncementChannel curChannel = (AnnouncementChannel) announcementService.getChannel(msg.getReference().replace(\"msg\", \"channel\").replaceAll(\"main/(.*)\", \"main\"));\n+\t\t\t\t\tmessageList.add(new AnnouncementWrapper((AnnouncementMessage) msg, curChannel, defaultChannel, null, null));\n+\t\t\t\t}\n+\t\t\t\tSortedIterator<AnnouncementWrapper> rvSorted = new SortedIterator<>(messageList.iterator(), new AnnouncementWrapperComparator(sortCurrentOrder, announcementSortAsc));\n+\t\t\t\t\n+\t\t\t\tList<Message> subrv = new ArrayList();\n+\t\t\t\tfor (int index = 0; index < announcements.size(); index++) {\n+\t\t\t\t\tsubrv.add(rvSorted.next());\n+\t\t\t\t}\n+\t\t\t\tannouncements = subrv;\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tif(log.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "944c49c2b0d044a08b1fbac35c0629af1f709476"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MjgwMzEz", "url": "https://github.com/sakaiproject/sakai/pull/8270#pullrequestreview-427280313", "createdAt": "2020-06-09T15:26:59Z", "commit": {"oid": "944c49c2b0d044a08b1fbac35c0629af1f709476"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNToyNjo1OVrOGhQIYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNToyNjo1OVrOGhQIYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyMDQ4Mw==", "bodyText": "No need to loop here just use Collections.addAll", "url": "https://github.com/sakaiproject/sakai/pull/8270#discussion_r437520483", "createdAt": "2020-06-09T15:26:59Z", "author": {"login": "ern"}, "path": "announcement/announcement-tool/tool/src/java/org/sakaiproject/announcement/entityprovider/AnnouncementEntityProviderImpl.java", "diffHunk": "@@ -243,6 +257,29 @@ public String getEntityPrefix() {\n \t\t\tlog.debug(\"announcements.size(): {}\", announcements.size());\n \t\t}\n \t\t\n+\t\tif (AnnouncementAction.SORT_MESSAGE_ORDER.equals(sortCurrentOrder)) {\n+\t\t\ttry {\n+\t\t\t\tList<AnnouncementWrapper> messageList = new ArrayList<>();\n+\t\t\t\tAnnouncementChannel defaultChannel = (AnnouncementChannel) announcementService.getChannel(\"/announcement/channel/\" + siteId + \"/main\");\n+\t\t\t\tfor (Message msg : announcements) {\n+\t\t\t\t\tAnnouncementChannel curChannel = (AnnouncementChannel) announcementService.getChannel(msg.getReference().replace(\"msg\", \"channel\").replaceAll(\"main/(.*)\", \"main\"));\n+\t\t\t\t\tmessageList.add(new AnnouncementWrapper((AnnouncementMessage) msg, curChannel, defaultChannel, null, null));\n+\t\t\t\t}\n+\t\t\t\tSortedIterator<AnnouncementWrapper> rvSorted = new SortedIterator<>(messageList.iterator(), new AnnouncementWrapperComparator(sortCurrentOrder, announcementSortAsc));\n+\t\t\t\t\n+\t\t\t\tList<Message> subrv = new ArrayList();\n+\t\t\t\tfor (int index = 0; index < announcements.size(); index++) {\n+\t\t\t\t\tsubrv.add(rvSorted.next());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "944c49c2b0d044a08b1fbac35c0629af1f709476"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MjgyNzY3", "url": "https://github.com/sakaiproject/sakai/pull/8270#pullrequestreview-427282767", "createdAt": "2020-06-09T15:29:33Z", "commit": {"oid": "944c49c2b0d044a08b1fbac35c0629af1f709476"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNToyOTozM1rOGhQPXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNToyOTozM1rOGhQPXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyMjI3MQ==", "bodyText": "BooleanUtils maybe more appropriate here", "url": "https://github.com/sakaiproject/sakai/pull/8270#discussion_r437522271", "createdAt": "2020-06-09T15:29:33Z", "author": {"login": "ern"}, "path": "announcement/announcement-tool/tool/src/java/org/sakaiproject/announcement/entityprovider/AnnouncementEntityProviderImpl.java", "diffHunk": "@@ -130,6 +135,7 @@ public String getEntityPrefix() {\n \t\t//we use this zero value to determine if we need to look up from the tool config, or use the defaults if still not set.\n \t\tint numberOfAnnouncements = NumberUtils.toInt((String)params.get(\"n\"), 0);\n \t\tint numberOfDaysInThePast = NumberUtils.toInt((String)params.get(\"d\"), 0);\n+\t\tboolean announcementSortAsc = NumberUtils.toInt((String)params.get(\"a\"), 0) == 1 ? true:false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "944c49c2b0d044a08b1fbac35c0629af1f709476"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e62df7b3f504f0cecd414822d4d1b52bd63ad99", "author": {"user": {"login": "austin48", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/2e62df7b3f504f0cecd414822d4d1b52bd63ad99", "committedDate": "2020-10-07T18:59:43Z", "message": "SAK-43238 Embedded Announcement block in Lessons display order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d52786f88ce1f81e5b73ecb4a8597159bb4258a9", "author": {"user": {"login": "ern", "name": "Earle Nietzel"}}, "url": "https://github.com/sakaiproject/sakai/commit/d52786f88ce1f81e5b73ecb4a8597159bb4258a9", "committedDate": "2020-10-07T19:30:45Z", "message": "Updated PR that doesn't use deprecated SortedIterator"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "944c49c2b0d044a08b1fbac35c0629af1f709476", "author": {"user": {"login": "austin48", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/944c49c2b0d044a08b1fbac35c0629af1f709476", "committedDate": "2020-06-02T23:20:37Z", "message": "SAK-43238 Embedded Announcement block in Lessons display order"}, "afterCommit": {"oid": "d52786f88ce1f81e5b73ecb4a8597159bb4258a9", "author": {"user": {"login": "ern", "name": "Earle Nietzel"}}, "url": "https://github.com/sakaiproject/sakai/commit/d52786f88ce1f81e5b73ecb4a8597159bb4258a9", "committedDate": "2020-10-07T19:30:45Z", "message": "Updated PR that doesn't use deprecated SortedIterator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MzY5MzYz", "url": "https://github.com/sakaiproject/sakai/pull/8270#pullrequestreview-504369363", "createdAt": "2020-10-08T01:20:24Z", "commit": {"oid": "d52786f88ce1f81e5b73ecb4a8597159bb4258a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMToyMDoyNFrOHeK0Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMToyMDoyNFrOHeK0Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5NjU1OQ==", "bodyText": "the announcements list is always empty here because the else block below used to be above this sort block and always populated the list first.", "url": "https://github.com/sakaiproject/sakai/pull/8270#discussion_r501396559", "createdAt": "2020-10-08T01:20:24Z", "author": {"login": "austin48"}, "path": "announcement/announcement-tool/tool/src/java/org/sakaiproject/announcement/entityprovider/AnnouncementEntityProviderImpl.java", "diffHunk": "@@ -227,59 +230,51 @@ public String getEntityPrefix() {\n \t\t//get the announcements for each channel\n \t\tList<Message> announcements = new ArrayList<Message>();\n \t\t\n-\t\tboolean enableReorder = ComponentManager.get(ServerConfigurationService.class).getBoolean(AnnouncementAction.SAK_PROP_ANNC_REORDER, AnnouncementAction.SAK_PROP_ANNC_REORDER_DEFAULT);\n+\t\tboolean enableReorder = serverConfigurationService.getBoolean(AnnouncementAction.SAK_PROP_ANNC_REORDER, AnnouncementAction.SAK_PROP_ANNC_REORDER_DEFAULT);\n \t\tString sortCurrentOrder = AnnouncementAction.SORT_DATE;\n \t\tif (enableReorder){\n \t\t\tsortCurrentOrder = AnnouncementAction.SORT_MESSAGE_ORDER;\n \t\t}\n-\t\tViewableFilter msgFilter = AnnouncementAction.SORT_MESSAGE_ORDER.equals(sortCurrentOrder) ? null:new ViewableFilter(null, t, numberOfAnnouncements);\n-\t\t\n-\t\t//for each channel\n-\t\tfor(String channel: channels) {\n-\t\t\ttry {\n-\t\t\t\tannouncements.addAll(announcementService.getMessages(channel, msgFilter, announcementSortAsc, false));\n-\t\t\t} catch (PermissionException | IdUnusedException | NullPointerException ex) {\n-\t\t\t\t//user may not have access to view the channel but get all public messages in this channel\n-\t\t\t\tAnnouncementChannel announcementChannel = (AnnouncementChannel)announcementService.getChannelPublic(channel);\n-\t\t\t\tif(announcementChannel != null){\n-\t\t\t\t\tList<Message> publicMessages = announcementChannel.getMessagesPublic(null, true);\n-\t\t\t\t\tfor(Message message : publicMessages){\n-\t\t\t\t\t\t//Add message only if it is within the time range\n-\t\t\t\t\t\tif(isMessageWithinPastNDays(message, numberOfDaysInThePast) && announcementService.isMessageViewable((AnnouncementMessage) message)){\n-\t\t\t\t\t\t\tannouncements.add(message);\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\t\n-\t\tif(log.isDebugEnabled()) {\n-\t\t\tlog.debug(\"announcements.size(): {}\", announcements.size());\n-\t\t}\n+\t\tViewableFilter msgFilter = AnnouncementAction.SORT_MESSAGE_ORDER.equals(sortCurrentOrder) ? null : new ViewableFilter(null, t, numberOfAnnouncements);\n \t\t\n \t\tif (AnnouncementAction.SORT_MESSAGE_ORDER.equals(sortCurrentOrder)) {\n \t\t\ttry {\n \t\t\t\tList<AnnouncementWrapper> messageList = new ArrayList<>();\n-\t\t\t\tAnnouncementChannel defaultChannel = (AnnouncementChannel) announcementService.getChannel(\"/announcement/channel/\" + siteId + \"/main\");\n+\t\t\t\tfinal AnnouncementChannel defaultChannel = (AnnouncementChannel) announcementService.getChannel(\"/announcement/channel/\" + siteId + \"/main\");\n \t\t\t\tfor (Message msg : announcements) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d52786f88ce1f81e5b73ecb4a8597159bb4258a9"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd2115db906afb62d5dd147c56c4a85edf5e53c7", "author": {"user": {"login": "austin48", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/fd2115db906afb62d5dd147c56c4a85edf5e53c7", "committedDate": "2020-10-10T00:44:13Z", "message": "SAK-43238 Announcement navigation tabs are incorrect after viewing an announcement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06ab7c095b9e191b0cc99a946129d3323c9891b9", "author": {"user": {"login": "austin48", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/06ab7c095b9e191b0cc99a946129d3323c9891b9", "committedDate": "2020-11-02T20:06:10Z", "message": "SAK-43238 Embedded Announcement block in Lessons display order\n\nuse clear() instead of removeAll()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3Njg4OTA3", "url": "https://github.com/sakaiproject/sakai/pull/8270#pullrequestreview-537688907", "createdAt": "2020-11-24T16:24:26Z", "commit": {"oid": "06ab7c095b9e191b0cc99a946129d3323c9891b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3Njg5NDM5", "url": "https://github.com/sakaiproject/sakai/pull/8270#pullrequestreview-537689439", "createdAt": "2020-11-24T16:25:00Z", "commit": {"oid": "06ab7c095b9e191b0cc99a946129d3323c9891b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjoyNTowMFrOH5K0PA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjoyNTowMFrOH5K0PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcwODA5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tString sortCurrentOrder = AnnouncementAction.SORT_DATE;\n          \n          \n            \n            \t\tif (enableReorder){\n          \n          \n            \n            \t\t\tsortCurrentOrder = AnnouncementAction.SORT_MESSAGE_ORDER;\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \t\tfinal String sortCurrentOrder = enableReorder ? AnnouncementAction.SORT_MESSAGE_ORDER : AnnouncementAction.SORT_DATE;", "url": "https://github.com/sakaiproject/sakai/pull/8270#discussion_r529708092", "createdAt": "2020-11-24T16:25:00Z", "author": {"login": "adrianfish"}, "path": "announcement/announcement-tool/tool/src/java/org/sakaiproject/announcement/entityprovider/AnnouncementEntityProviderImpl.java", "diffHunk": "@@ -213,36 +222,60 @@ public String getEntityPrefix() {\n \n \t\tlog.debug(\"numberOfAnnouncements: {}\", numberOfAnnouncements);\n \t\tlog.debug(\"numberOfDaysInThePast: {}\", numberOfDaysInThePast);\n+\t\tlog.debug(\"announcementSortAsc: {}\", announcementSortAsc);\n \t\t\n \t\t//get the Sakai Time for the given java Date\n \t\tTime t = timeService.newTime(getTimeForDaysInPast(numberOfDaysInThePast).getTime());\n \t\t\n \t\t//get the announcements for each channel\n \t\tList<Message> announcements = new ArrayList<Message>();\n \t\t\n+\t\tboolean enableReorder = serverConfigurationService.getBoolean(AnnouncementAction.SAK_PROP_ANNC_REORDER, AnnouncementAction.SAK_PROP_ANNC_REORDER_DEFAULT);\n+\t\tString sortCurrentOrder = AnnouncementAction.SORT_DATE;\n+\t\tif (enableReorder){\n+\t\t\tsortCurrentOrder = AnnouncementAction.SORT_MESSAGE_ORDER;\n+\t\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06ab7c095b9e191b0cc99a946129d3323c9891b9"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe6e080def52f0debed1d18dd52aad3d7461a7fd", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/fe6e080def52f0debed1d18dd52aad3d7461a7fd", "committedDate": "2020-11-24T16:25:09Z", "message": "Update announcement/announcement-tool/tool/src/java/org/sakaiproject/announcement/entityprovider/AnnouncementEntityProviderImpl.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1965, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}