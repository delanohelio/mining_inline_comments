{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NzU0MTAx", "number": 7985, "title": "SAK-42890 Site Info > Groups: Indicate which tools and items are lock\u2026", "bodyText": "\u2026ing each group.\nThe 20.x version of this PR is #7977", "createdAt": "2020-03-06T10:46:21Z", "url": "https://github.com/sakaiproject/sakai/pull/7985", "merged": true, "mergeCommit": {"oid": "cc58b5a9145390a0845e57d23d95cca6afaad4ac"}, "closed": true, "closedAt": "2020-03-16T08:56:17Z", "author": {"login": "mpellicer"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcK90F9AFqTM3MDIzMzQ3OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNO7KBgBqjMxMjY0MzcyNTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMjMzNDc4", "url": "https://github.com/sakaiproject/sakai/pull/7985#pullrequestreview-370233478", "createdAt": "2020-03-06T10:46:26Z", "commit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMDo0NjoyNlrOFy0k3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMDo0NjoyNlrOFy0k3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgzNDUyNQ==", "bodyText": "Looks like there's a label missing for this input. That makes it hard for people using screen readers or voice control to use the input.", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r388834525", "createdAt": "2020-03-06T10:46:26Z", "author": {"login": "accesslint"}, "path": "site-manage/site-group-manager/src/main/webapp/WEB-INF/templates/index.html", "diffHunk": "@@ -21,16 +23,37 @@\n         <tbody>\n           <tr th:each=\"group : ${groupList}\">\n             <td>\n-              <span th:if=\"${lockedGroupList.contains(group)}\" class=\"fa fa-fw fa-lock\" aria-hidden=\"true\" th:title=\"#{index.table.grouplocked}\"></span>\n-              <a th:if=\"${!lockedGroupList.contains(group)}\" th:href=\"@{/group(groupId=${group.id})}\" th:text=\"${group.title}\"></a>\n-              <span th:if=\"${lockedGroupList.contains(group)}\" th:text=\"${group.title}\"></span>\n+              <span th:if=\"${lockedGroupList.contains(group.id)}\" class=\"fa fa-fw fa-lock\" aria-hidden=\"true\" th:title=\"#{index.table.grouplocked}\"></span>\n+              <a th:if=\"${!lockedGroupList.contains(group.id)}\" th:href=\"@{/group(groupId=${group.id})}\" th:text=\"${group.title}\"></a>\n+              <span th:if=\"${lockedGroupList.contains(group.id)}\" th:text=\"${group.title}\"></span>\n+            </td>\n+            <td class=\"hidden-xs\" th:if=\"${anyGroupLocked}\">\n+              <div th:if=\"${lockedGroupsEntityMap.get(group.id) != null }\">\n+                <div th:if=\"${!lockedGroupsEntityMap.get(group.id).get('assignments').isEmpty()}\">\n+                  <span class=\"group-locked-info-collapsed\" data-toggle=\"collapse\" th:data-target=\"|#lockingassignments-${group.id}|\" tabindex=\"0\" role=\"button\" th:text=\"#{index.table.assignments}\"></span>\n+                  <div th:id=\"|lockingassignments-${group.id}|\" class=\"collapse\">\n+                    <ul th:each=\" assigment : ${lockedGroupsEntityMap.get(group.id).get('assignments')}\">\n+                      <li th:text=\"${assigment}\"></li>\n+                    </ul>\n+                  </div>\n+                </div>\n+                <div class=\"clearfix\"></div>\n+                <div th:if=\"${!lockedGroupsEntityMap.get(group.id).get('assessments').isEmpty()}\">\n+                <span class=\"group-locked-info-collapsed\" data-toggle=\"collapse\" th:data-target=\"|#lockingassessments-${group.id}|\" tabindex=\"0\" role=\"button\" th:text=\"#{index.table.assessments}\"></span>\n+                  <div th:id=\"|lockingassessments-${group.id}|\" class=\"collapse\">\n+                    <ul th:each=\" assessment : ${lockedGroupsEntityMap.get(group.id).get('assessments')}\">\n+                      <li th:text=\"${assessment}\"></li>\n+                    </ul>\n+                  </div>\n+                </div>\n+              </div>\n             </td>\n             <td><a th:if=\"${groupJoinableSetMap.get(group.id) != null}\" th:href=\"@{/joinableset(joinableSetId=${groupJoinableSetMap.get(group.id)})}\" th:text=\"${groupJoinableSetMap.get(group.id)}\"></a></td>\n             <td class=\"hidden-xs\"><span th:text=\"${group.getMembers().size()}\"></span> <span th:if=\"${groupJoinableSetSizeMap.get(group.id) != null}\" th:text=\"'('+${groupJoinableSetSizeMap.get(group.id)}+')'\"></span></td>\n             <td class=\"hidden-xs\" th:text=\"${groupMemberMap.get(group.id)}\"></td>\n             <td>\n-              <input th:if=\"${!lockedForDeletionGroupList.contains(group)}\" th:attr=\"groupInfo=|${group.title} - ${group.getMembers().size()} #{index.table.members}|\" type=\"checkbox\" name=\"deletedGroupList\" th:field=\"*{deletedGroupList}\" th:value=\"${group.id}\" onchange=\"indexFunctions.checkSubmitButton();\"/>\n-              <span th:if=\"${lockedForDeletionGroupList.contains(group)}\" class=\"fa fa-fw fa-lock\" aria-hidden=\"true\" th:title=\"#{index.table.grouplocked.deletion}\"></span>\n+              <input th:if=\"${!lockedForDeletionGroupList.contains(group.id)}\" th:attr=\"groupInfo=|${group.title} - ${group.getMembers().size()} #{index.table.members}|\" type=\"checkbox\" name=\"deletedGroupList\" th:field=\"*{deletedGroupList}\" th:value=\"${group.id}\" onchange=\"indexFunctions.checkSubmitButton();\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNzkwNTA2", "url": "https://github.com/sakaiproject/sakai/pull/7985#pullrequestreview-372790506", "createdAt": "2020-03-11T14:08:19Z", "commit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNzg0NDE5", "url": "https://github.com/sakaiproject/sakai/pull/7985#pullrequestreview-373784419", "createdAt": "2020-03-12T18:02:19Z", "commit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "state": "DISMISSED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODowMjoyMFrOF1pgfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODo1NTo1OVrOF1rRBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5ODkxMQ==", "bodyText": "can use diamond operator here and in few other places\nArrayList<>()", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r391798911", "createdAt": "2020-03-12T18:02:20Z", "author": {"login": "ern"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/controller/MainController.java", "diffHunk": "@@ -75,11 +75,15 @@ public int compare(Group g1, Group g2){\n                 return g1.getTitle().compareToIgnoreCase(g2.getTitle());\n         }});\n \n-        List<Group> lockedGroupList = site.getGroups().stream().filter(group -> RealmLockMode.ALL.equals(group.getRealmLock()) || RealmLockMode.MODIFY.equals(group.getRealmLock())).collect(Collectors.toList());\n-        List<Group> lockedForDeletionGroupList = site.getGroups().stream().filter(group -> RealmLockMode.ALL.equals(group.getRealmLock()) || RealmLockMode.DELETE.equals(group.getRealmLock())).collect(Collectors.toList());\n+        // Control the groups that are locked by entities\n+        boolean anyGroupLocked = false;\n+        List<String> lockedGroupList = new ArrayList<String>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwMDE3Ng==", "bodyText": "super generic and vague name SakaiService, also given that this is in a tool this shouldn't be named a service as it's misleading!\nmaybe something like:\nGroupManagerOperations\nGroupManagerActions", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r391800176", "createdAt": "2020-03-12T18:04:37Z", "author": {"login": "ern"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "diffHunk": "@@ -42,6 +51,9 @@\n @Slf4j\n public class SakaiService  {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgyNzI1MA==", "bodyText": "Use the AssignmentConstants in the pi that's the whole purpose so we don't recreate all these constants.", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r391827250", "createdAt": "2020-03-12T18:55:11Z", "author": {"login": "ern"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "diffHunk": "@@ -126,4 +138,44 @@ public void postEvent(String event, String userId) {\n         eventTrackingService.post(eventTrackingService.newEvent(event, userId, true/*update event*/));\n     }\n \n+    public Map<String, List<String>> getGroupLockingEntities (Group group) {\n+        Map<String, List<String>> lockingEntitiesMap = new HashMap<String, List<String>>();\n+        List<String[]> groupRealmLocks = group.getRealmLocks();\n+\n+        // Add one list per entity that locks groups.\n+        List<String> assignmentTitles = new ArrayList<String>();\n+        List<String> assessmentTitles = new ArrayList<String>();\n+\n+        for (String[] groupRealmLock : groupRealmLocks) {\n+            String objectReference = groupRealmLock[0];\n+            if (StringUtils.isNotBlank(objectReference)) {\n+                if (objectReference.startsWith(GroupManagerConstants.ASN_ENTITY_PREFIX)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgyNzcxNg==", "bodyText": "Use the AssignmentReferenceReckoner to load an assignment reference which you can easily get the assignment to load", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r391827716", "createdAt": "2020-03-12T18:55:59Z", "author": {"login": "ern"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "diffHunk": "@@ -126,4 +138,44 @@ public void postEvent(String event, String userId) {\n         eventTrackingService.post(eventTrackingService.newEvent(event, userId, true/*update event*/));\n     }\n \n+    public Map<String, List<String>> getGroupLockingEntities (Group group) {\n+        Map<String, List<String>> lockingEntitiesMap = new HashMap<String, List<String>>();\n+        List<String[]> groupRealmLocks = group.getRealmLocks();\n+\n+        // Add one list per entity that locks groups.\n+        List<String> assignmentTitles = new ArrayList<String>();\n+        List<String> assessmentTitles = new ArrayList<String>();\n+\n+        for (String[] groupRealmLock : groupRealmLocks) {\n+            String objectReference = groupRealmLock[0];\n+            if (StringUtils.isNotBlank(objectReference)) {\n+                if (objectReference.startsWith(GroupManagerConstants.ASN_ENTITY_PREFIX)) {\n+                    String assignmentReference = objectReference.substring(objectReference.lastIndexOf(\"/\") + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 56}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336", "author": {"user": {"login": "mpellicer", "name": "Miguel Pellicer"}}, "url": "https://github.com/sakaiproject/sakai/commit/f6a624767a75c308c7d8b5e027725962c199a336", "committedDate": "2020-03-06T10:45:21Z", "message": "SAK-42890 Site Info > Groups: Indicate which tools and items are locking each group"}, "afterCommit": {"oid": "1e6fbdfac39f994a10053df0a0829147ff6db5ff", "author": {"user": {"login": "mpellicer", "name": "Miguel Pellicer"}}, "url": "https://github.com/sakaiproject/sakai/commit/1e6fbdfac39f994a10053df0a0829147ff6db5ff", "committedDate": "2020-03-13T11:39:20Z", "message": "SAK-42890 Site Info > Groups: Indicate which tools and items are locking each group"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63c037c12503b132caf8162d294423c29d8efcea", "author": {"user": {"login": "mpellicer", "name": "Miguel Pellicer"}}, "url": "https://github.com/sakaiproject/sakai/commit/63c037c12503b132caf8162d294423c29d8efcea", "committedDate": "2020-03-13T11:50:03Z", "message": "SAK-42890 Site Info > Groups: Indicate which tools and items are locking each group"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e6fbdfac39f994a10053df0a0829147ff6db5ff", "author": {"user": {"login": "mpellicer", "name": "Miguel Pellicer"}}, "url": "https://github.com/sakaiproject/sakai/commit/1e6fbdfac39f994a10053df0a0829147ff6db5ff", "committedDate": "2020-03-13T11:39:20Z", "message": "SAK-42890 Site Info > Groups: Indicate which tools and items are locking each group"}, "afterCommit": {"oid": "63c037c12503b132caf8162d294423c29d8efcea", "author": {"user": {"login": "mpellicer", "name": "Miguel Pellicer"}}, "url": "https://github.com/sakaiproject/sakai/commit/63c037c12503b132caf8162d294423c29d8efcea", "committedDate": "2020-03-13T11:50:03Z", "message": "SAK-42890 Site Info > Groups: Indicate which tools and items are locking each group"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2259, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}