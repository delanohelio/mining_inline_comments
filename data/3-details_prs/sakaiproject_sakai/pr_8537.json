{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMjM4MTM2", "number": 8537, "title": "SAK-43610: samigo > time exceptions > add validation to time limit", "bodyText": "https://jira.sakaiproject.org/browse/SAK-43610\nAdds validation and error messaging when time extension time limit is greater than availability window.\nTook the opportunity to reduce code duplication between ConfirmPublishAssessmentListener, SavePublishedSettingsListener, AssessmentSettingsBean, and PublishedAssessmentSettingsBean by introducing a new delegate class, ExtendedTimeValidator.\nMost of the code in this new delegate is just moved from the other classes. I'll denote inline where the new logic lives.", "createdAt": "2020-09-08T19:02:14Z", "url": "https://github.com/sakaiproject/sakai/pull/8537", "merged": true, "mergeCommit": {"oid": "af6f1398c162bb30dd60555ef1b6e09447d2a908"}, "closed": true, "closedAt": "2020-09-09T14:10:59Z", "author": {"login": "bjones86"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG8ZY6gFqTQ4NDQxNTU5Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHMkfAgFqTQ4NTAzMjU4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDE1NTk3", "url": "https://github.com/sakaiproject/sakai/pull/8537#pullrequestreview-484415597", "createdAt": "2020-09-08T19:02:48Z", "commit": {"oid": "51997deee5952aa6d7172833e4b62d5465e24fd1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxOTowMjo0OVrOHOqP1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxOTowMjo0OVrOHOqP1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEzNDI5Mw==", "bodyText": "This is the newly introduced validation routine.", "url": "https://github.com/sakaiproject/sakai/pull/8537#discussion_r485134293", "createdAt": "2020-09-08T19:02:49Z", "author": {"login": "bjones86"}, "path": "samigo/samigo-app/src/java/org/sakaiproject/tool/assessment/util/ExtendedTimeValidator.java", "diffHunk": "@@ -0,0 +1,409 @@\n+/**\n+ * Copyright (c) 2005-2020 The Apereo Foundation\n+ *\n+ * Licensed under the Educational Community License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *             http://opensource.org/licenses/ecl2\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.sakaiproject.tool.assessment.util;\n+\n+import java.text.MessageFormat;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import javax.faces.application.FacesMessage;\n+import javax.faces.context.FacesContext;\n+import javax.faces.model.SelectItem;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+import org.sakaiproject.tool.assessment.data.dao.assessment.ExtendedTime;\n+import org.sakaiproject.tool.assessment.data.ifc.assessment.AssessmentAccessControlIfc;\n+import org.sakaiproject.tool.assessment.ui.bean.author.AssessmentSettingsBean;\n+import org.sakaiproject.tool.assessment.ui.bean.author.PublishedAssessmentSettingsBean;\n+import org.sakaiproject.tool.assessment.ui.listener.util.ContextUtil;\n+\n+/**\n+ * Centralized extended time validator:\n+ * - name or group must be supplied\n+ * - due date can't be before now, or before start date\n+ * - retract date can't be before now, or before start date\n+ * - retract date can't be before due date; auto pushed to due date\n+ * - due date can't be the same as start date\n+ * - open window can't be less than time limit\n+ *\n+ * @author bjones86\n+ */\n+public class ExtendedTimeValidator\n+{\n+    public static final String ERROR_KEY_USER_OR_GROUP_NOT_SET        = \"extended_time_user_and_group_set\";\n+    public static final String ERROR_KEY_DUE_BEFORE_START             = \"extended_time_due_earlier_than_available\";\n+    public static final String ERROR_KEY_RETRACT_BEFORE_START         = \"extended_time_retract_earlier_than_available\";\n+    public static final String ERROR_KEY_DUE_SAME_AS_START            = \"extended_time_due_same_as_available\";\n+    public static final String ERROR_KEY_OPEN_WINDOW_LESS_THAN_LIMIT  = \"extended_time_open_window_less_than_time_limit\";\n+    public static final String ERROR_KEY_USER_SUBSTRING               = \"extended_time_error_user\";\n+    public static final String ERROR_KEY_GROUP_SUBSTRING              = \"extended_time_error_group\";\n+\n+    public static final String MSG_KEY_AND            = \"extended_time_and\";\n+    public static final String MSG_KEY_DUP_USERS      = \"extended_time_duplicate_users\";\n+    public static final String MSG_KEY_DUP_GROUPS     = \"extended_time_duplicate_groups\";\n+    public static final String MSG_KEY_NAME_NOT_FOUND = \"extended_time_name_not_found\";\n+\n+    public static final String ASSESSMENT_SETTINGS_BUNDLE = \"org.sakaiproject.tool.assessment.bundle.AssessmentSettingsMessages\";\n+\n+    private static Object settingsBean;\n+\n+    /**\n+     * Validate a single {@link ExtendedTime} entry.\n+     * @param entry the {@link ExtendedTime} entry to validate\n+     * @param context The {@link FacesContext}, in case validation errors are generated\n+     * @param settings The SettingsBean, for quiz settings (either {@link AssessmentSettingsBean} or {@link PublishedAssessmentSettingsBean})\n+     * @return true if all entities are valid; false otherwise.\n+     */\n+    public static boolean validateEntry( ExtendedTime entry, FacesContext context, Object settings )\n+    {\n+        List<ExtendedTime> entries = new ArrayList<>( 1 );\n+        entries.add( entry );\n+        return validateEntries( entries, context , settings );\n+    }\n+\n+    /**\n+     * Validate a list of {@link ExtendedTime} entries.\n+     * @param entries The {@link ExtendedTime} entries to validate\n+     * @param context The {@link FacesContext}, in case validation errors are generated\n+     * @param settings The SettingsBean, for quiz settings (either {@link AssessmentSettingsBean} or {@link PublishedAssessmentSettingsBean})\n+     * @return true if all entities are valid; false otherwise.\n+     */\n+    public static boolean validateEntries( List<ExtendedTime> entries, FacesContext context, Object settings )\n+    {\n+        boolean valid = true;\n+        settingsBean = settings;\n+        List<String> users = new ArrayList<>( entries.size() );\n+        List<String> groups = new ArrayList<>( entries.size() );\n+        for( ExtendedTime entry : entries )\n+        {\n+            String user = entry.getUser();\n+            String group = entry.getGroup();\n+            Date startDate = entry.getStartDate();\n+            Date dueDate = entry.getDueDate();\n+            Date retractDate = entry.getRetractDate();\n+\n+            if( StringUtils.isNotEmpty( user ) )\n+            {\n+                users.add( user );\n+            }\n+\n+            if( StringUtils.isNotEmpty( group ) )\n+            {\n+                groups.add( group );\n+            }\n+\n+            // Name & group validation\n+            if( StringUtils.isBlank( user ) && StringUtils.isBlank( group ) )\n+            {\n+                String errorMsg = getError( ERROR_KEY_USER_OR_GROUP_NOT_SET, entry );\n+                context.addMessage( null, new FacesMessage( FacesMessage.SEVERITY_WARN, errorMsg, null ) );\n+                valid = false;\n+            }\n+\n+            // Due date can't be before now, or before start date\n+            if( (startDate != null && dueDate != null && dueDate.before( startDate ))\n+                || (startDate == null && dueDate != null && dueDate.before( new Date() )) )\n+            {\n+                String errorMsg = getError( ERROR_KEY_DUE_BEFORE_START, entry );\n+                context.addMessage( null, new FacesMessage( FacesMessage.SEVERITY_WARN, errorMsg, null ) );\n+                entry.setStartDate( new Date() );\n+                valid = false;\n+            }\n+\n+            boolean isEntryRetractEarlierThanAvailable = false;\n+            if( StringUtils.equals( getLateHandling(), AssessmentAccessControlIfc.ACCEPT_LATE_SUBMISSION.toString() ) )\n+            {\n+                // Retract date can't be before now, or before start date\n+                if( (retractDate != null && startDate != null && retractDate.before( startDate ))\n+                    || (retractDate != null && startDate == null && retractDate.before( new Date() )) )\n+                {\n+                    String errorMsg = getError( ERROR_KEY_RETRACT_BEFORE_START, entry );\n+                    context.addMessage( null, new FacesMessage( FacesMessage.SEVERITY_WARN, errorMsg, null ) );\n+                    entry.setStartDate( new Date() );\n+                    isEntryRetractEarlierThanAvailable = true;\n+                    valid = false;\n+                }\n+\n+                // Retract date can't be before due date; push it to the due date\n+                if( !isEntryRetractEarlierThanAvailable && (retractDate != null && dueDate != null && retractDate.before( dueDate )) )\n+                {\n+                    entry.setRetractDate( dueDate );\n+                }\n+            }\n+\n+            // Due date can't be the same as start date\n+            if( dueDate != null && startDate != null && dueDate.equals( startDate ) )\n+            {\n+                String errorMsg = getError( ERROR_KEY_DUE_SAME_AS_START, entry );\n+                context.addMessage( null, new FacesMessage( FacesMessage.SEVERITY_WARN, errorMsg, null ) );\n+                valid = false;\n+            }\n+\n+            // If time limit is set, ensure open window is not less than the time limit\n+            boolean hasTimer = (entry.getTimeHours() != null && entry.getTimeHours() > 0) || (entry.getTimeMinutes() != null && entry.getTimeMinutes() > 0);\n+            if (hasTimer)\n+            {\n+                Date due = entry.getRetractDate() != null ? entry.getRetractDate() : entry.getDueDate();\n+                long timerMinutes = 0;\n+                if( entry.getTimeHours() != null )\n+                {\n+                    timerMinutes += entry.getTimeHours().longValue() * 60;\n+                }\n+                if( entry.getTimeMinutes() != null )\n+                {\n+                    timerMinutes += entry.getTimeMinutes().longValue();\n+                }\n+\n+                long openWindowMinutes = (due.getTime() - entry.getStartDate().getTime()) / 1000 / 60;\n+                if( openWindowMinutes < timerMinutes )\n+                {\n+                    String errorString = getError( ERROR_KEY_OPEN_WINDOW_LESS_THAN_LIMIT, entry );\n+                    context.addMessage( null, new FacesMessage( FacesMessage.SEVERITY_WARN, errorString, null ) );\n+                    valid = false;\n+                }\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51997deee5952aa6d7172833e4b62d5465e24fd1"}, "originalPosition": 183}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "686f2519171ada6b418c2b32bd5d23d815f47fbf", "author": {"user": {"login": "bjones86", "name": "Brian Jones"}}, "url": "https://github.com/sakaiproject/sakai/commit/686f2519171ada6b418c2b32bd5d23d815f47fbf", "committedDate": "2020-09-08T19:10:51Z", "message": "SAK-43610: samigo > time exceptions > add validation to time limit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51997deee5952aa6d7172833e4b62d5465e24fd1", "author": {"user": {"login": "bjones86", "name": "Brian Jones"}}, "url": "https://github.com/sakaiproject/sakai/commit/51997deee5952aa6d7172833e4b62d5465e24fd1", "committedDate": "2020-09-08T18:48:22Z", "message": "SAK-43610: samigo > time exceptions > add validation to time limit"}, "afterCommit": {"oid": "686f2519171ada6b418c2b32bd5d23d815f47fbf", "author": {"user": {"login": "bjones86", "name": "Brian Jones"}}, "url": "https://github.com/sakaiproject/sakai/commit/686f2519171ada6b418c2b32bd5d23d815f47fbf", "committedDate": "2020-09-08T19:10:51Z", "message": "SAK-43610: samigo > time exceptions > add validation to time limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTM1NDky", "url": "https://github.com/sakaiproject/sakai/pull/8537#pullrequestreview-484535492", "createdAt": "2020-09-08T22:33:48Z", "commit": {"oid": "686f2519171ada6b418c2b32bd5d23d815f47fbf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMjozMzo0OFrOHOwMBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMjozMzo0OFrOHOwMBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzMTYyMA==", "bodyText": "i occassionally see instructors choose both user and group .... does it make sense to just assume that they mean one user and ignore the group selection ?", "url": "https://github.com/sakaiproject/sakai/pull/8537#discussion_r485231620", "createdAt": "2020-09-08T22:33:48Z", "author": {"login": "ottenhoff"}, "path": "samigo/samigo-app/src/java/org/sakaiproject/tool/assessment/util/ExtendedTimeValidator.java", "diffHunk": "@@ -0,0 +1,408 @@\n+/**\n+ * Copyright (c) 2005-2020 The Apereo Foundation\n+ *\n+ * Licensed under the Educational Community License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *             http://opensource.org/licenses/ecl2\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.sakaiproject.tool.assessment.util;\n+\n+import java.text.MessageFormat;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import javax.faces.application.FacesMessage;\n+import javax.faces.context.FacesContext;\n+import javax.faces.model.SelectItem;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+import org.sakaiproject.tool.assessment.data.dao.assessment.ExtendedTime;\n+import org.sakaiproject.tool.assessment.data.ifc.assessment.AssessmentAccessControlIfc;\n+import org.sakaiproject.tool.assessment.ui.bean.author.AssessmentSettingsBean;\n+import org.sakaiproject.tool.assessment.ui.bean.author.PublishedAssessmentSettingsBean;\n+import org.sakaiproject.tool.assessment.ui.listener.util.ContextUtil;\n+\n+/**\n+ * Centralized extended time validator:\n+ * - name or group must be supplied\n+ * - due date can't be before now, or before start date\n+ * - retract date can't be before now, or before start date\n+ * - retract date can't be before due date; auto pushed to due date\n+ * - due date can't be the same as start date\n+ * - open window can't be less than time limit\n+ *\n+ * @author bjones86\n+ */\n+public class ExtendedTimeValidator\n+{\n+    public static final String ERROR_KEY_USER_OR_GROUP_NOT_SET        = \"extended_time_user_and_group_set\";\n+    public static final String ERROR_KEY_DUE_BEFORE_START             = \"extended_time_due_earlier_than_available\";\n+    public static final String ERROR_KEY_RETRACT_BEFORE_START         = \"extended_time_retract_earlier_than_available\";\n+    public static final String ERROR_KEY_DUE_SAME_AS_START            = \"extended_time_due_same_as_available\";\n+    public static final String ERROR_KEY_OPEN_WINDOW_LESS_THAN_LIMIT  = \"extended_time_open_window_less_than_time_limit\";\n+    public static final String ERROR_KEY_USER_SUBSTRING               = \"extended_time_error_user\";\n+    public static final String ERROR_KEY_GROUP_SUBSTRING              = \"extended_time_error_group\";\n+\n+    public static final String MSG_KEY_AND            = \"extended_time_and\";\n+    public static final String MSG_KEY_DUP_USERS      = \"extended_time_duplicate_users\";\n+    public static final String MSG_KEY_DUP_GROUPS     = \"extended_time_duplicate_groups\";\n+    public static final String MSG_KEY_NAME_NOT_FOUND = \"extended_time_name_not_found\";\n+\n+    public static final String ASSESSMENT_SETTINGS_BUNDLE = \"org.sakaiproject.tool.assessment.bundle.AssessmentSettingsMessages\";\n+\n+    private static Object settingsBean;\n+\n+    /**\n+     * Validate a single {@link ExtendedTime} entry.\n+     * @param entry the {@link ExtendedTime} entry to validate\n+     * @param context The {@link FacesContext}, in case validation errors are generated\n+     * @param settings The SettingsBean, for quiz settings (either {@link AssessmentSettingsBean} or {@link PublishedAssessmentSettingsBean})\n+     * @return true if all entities are valid; false otherwise.\n+     */\n+    public static boolean validateEntry( ExtendedTime entry, FacesContext context, Object settings )\n+    {\n+        return validateEntries( Collections.singletonList( entry ), context , settings );\n+    }\n+\n+    /**\n+     * Validate a list of {@link ExtendedTime} entries.\n+     * @param entries The {@link ExtendedTime} entries to validate\n+     * @param context The {@link FacesContext}, in case validation errors are generated\n+     * @param settings The SettingsBean, for quiz settings (either {@link AssessmentSettingsBean} or {@link PublishedAssessmentSettingsBean})\n+     * @return true if all entities are valid; false otherwise.\n+     */\n+    public static boolean validateEntries( List<ExtendedTime> entries, FacesContext context, Object settings )\n+    {\n+        boolean valid = true;\n+        settingsBean = settings;\n+        List<String> users = new ArrayList<>( entries.size() );\n+        List<String> groups = new ArrayList<>( entries.size() );\n+        for( ExtendedTime entry : entries )\n+        {\n+            String user = entry.getUser();\n+            String group = entry.getGroup();\n+            Date startDate = entry.getStartDate();\n+            Date dueDate = entry.getDueDate();\n+            Date retractDate = entry.getRetractDate();\n+\n+            if( StringUtils.isNotEmpty( user ) )\n+            {\n+                users.add( user );\n+            }\n+\n+            if( StringUtils.isNotEmpty( group ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "686f2519171ada6b418c2b32bd5d23d815f47fbf"}, "originalPosition": 107}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTM2NjA3", "url": "https://github.com/sakaiproject/sakai/pull/8537#pullrequestreview-484536607", "createdAt": "2020-09-08T22:36:40Z", "commit": {"oid": "686f2519171ada6b418c2b32bd5d23d815f47fbf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMjozNjo0MFrOHOwQJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMjozNjo0MFrOHOwQJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzMjY3Nw==", "bodyText": "wow this is a lot of lifting for duplicates!", "url": "https://github.com/sakaiproject/sakai/pull/8537#discussion_r485232677", "createdAt": "2020-09-08T22:36:40Z", "author": {"login": "ottenhoff"}, "path": "samigo/samigo-app/src/java/org/sakaiproject/tool/assessment/util/ExtendedTimeValidator.java", "diffHunk": "@@ -0,0 +1,408 @@\n+/**\n+ * Copyright (c) 2005-2020 The Apereo Foundation\n+ *\n+ * Licensed under the Educational Community License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *             http://opensource.org/licenses/ecl2\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.sakaiproject.tool.assessment.util;\n+\n+import java.text.MessageFormat;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import javax.faces.application.FacesMessage;\n+import javax.faces.context.FacesContext;\n+import javax.faces.model.SelectItem;\n+\n+import org.apache.commons.lang3.StringUtils;\n+\n+import org.sakaiproject.tool.assessment.data.dao.assessment.ExtendedTime;\n+import org.sakaiproject.tool.assessment.data.ifc.assessment.AssessmentAccessControlIfc;\n+import org.sakaiproject.tool.assessment.ui.bean.author.AssessmentSettingsBean;\n+import org.sakaiproject.tool.assessment.ui.bean.author.PublishedAssessmentSettingsBean;\n+import org.sakaiproject.tool.assessment.ui.listener.util.ContextUtil;\n+\n+/**\n+ * Centralized extended time validator:\n+ * - name or group must be supplied\n+ * - due date can't be before now, or before start date\n+ * - retract date can't be before now, or before start date\n+ * - retract date can't be before due date; auto pushed to due date\n+ * - due date can't be the same as start date\n+ * - open window can't be less than time limit\n+ *\n+ * @author bjones86\n+ */\n+public class ExtendedTimeValidator\n+{\n+    public static final String ERROR_KEY_USER_OR_GROUP_NOT_SET        = \"extended_time_user_and_group_set\";\n+    public static final String ERROR_KEY_DUE_BEFORE_START             = \"extended_time_due_earlier_than_available\";\n+    public static final String ERROR_KEY_RETRACT_BEFORE_START         = \"extended_time_retract_earlier_than_available\";\n+    public static final String ERROR_KEY_DUE_SAME_AS_START            = \"extended_time_due_same_as_available\";\n+    public static final String ERROR_KEY_OPEN_WINDOW_LESS_THAN_LIMIT  = \"extended_time_open_window_less_than_time_limit\";\n+    public static final String ERROR_KEY_USER_SUBSTRING               = \"extended_time_error_user\";\n+    public static final String ERROR_KEY_GROUP_SUBSTRING              = \"extended_time_error_group\";\n+\n+    public static final String MSG_KEY_AND            = \"extended_time_and\";\n+    public static final String MSG_KEY_DUP_USERS      = \"extended_time_duplicate_users\";\n+    public static final String MSG_KEY_DUP_GROUPS     = \"extended_time_duplicate_groups\";\n+    public static final String MSG_KEY_NAME_NOT_FOUND = \"extended_time_name_not_found\";\n+\n+    public static final String ASSESSMENT_SETTINGS_BUNDLE = \"org.sakaiproject.tool.assessment.bundle.AssessmentSettingsMessages\";\n+\n+    private static Object settingsBean;\n+\n+    /**\n+     * Validate a single {@link ExtendedTime} entry.\n+     * @param entry the {@link ExtendedTime} entry to validate\n+     * @param context The {@link FacesContext}, in case validation errors are generated\n+     * @param settings The SettingsBean, for quiz settings (either {@link AssessmentSettingsBean} or {@link PublishedAssessmentSettingsBean})\n+     * @return true if all entities are valid; false otherwise.\n+     */\n+    public static boolean validateEntry( ExtendedTime entry, FacesContext context, Object settings )\n+    {\n+        return validateEntries( Collections.singletonList( entry ), context , settings );\n+    }\n+\n+    /**\n+     * Validate a list of {@link ExtendedTime} entries.\n+     * @param entries The {@link ExtendedTime} entries to validate\n+     * @param context The {@link FacesContext}, in case validation errors are generated\n+     * @param settings The SettingsBean, for quiz settings (either {@link AssessmentSettingsBean} or {@link PublishedAssessmentSettingsBean})\n+     * @return true if all entities are valid; false otherwise.\n+     */\n+    public static boolean validateEntries( List<ExtendedTime> entries, FacesContext context, Object settings )\n+    {\n+        boolean valid = true;\n+        settingsBean = settings;\n+        List<String> users = new ArrayList<>( entries.size() );\n+        List<String> groups = new ArrayList<>( entries.size() );\n+        for( ExtendedTime entry : entries )\n+        {\n+            String user = entry.getUser();\n+            String group = entry.getGroup();\n+            Date startDate = entry.getStartDate();\n+            Date dueDate = entry.getDueDate();\n+            Date retractDate = entry.getRetractDate();\n+\n+            if( StringUtils.isNotEmpty( user ) )\n+            {\n+                users.add( user );\n+            }\n+\n+            if( StringUtils.isNotEmpty( group ) )\n+            {\n+                groups.add( group );\n+            }\n+\n+            // Name & group validation\n+            if( StringUtils.isBlank( user ) && StringUtils.isBlank( group ) )\n+            {\n+                String errorMsg = getError( ERROR_KEY_USER_OR_GROUP_NOT_SET, entry );\n+                context.addMessage( null, new FacesMessage( FacesMessage.SEVERITY_WARN, errorMsg, null ) );\n+                valid = false;\n+            }\n+\n+            // Due date can't be before now, or before start date\n+            if( (startDate != null && dueDate != null && dueDate.before( startDate ))\n+                || (startDate == null && dueDate != null && dueDate.before( new Date() )) )\n+            {\n+                String errorMsg = getError( ERROR_KEY_DUE_BEFORE_START, entry );\n+                context.addMessage( null, new FacesMessage( FacesMessage.SEVERITY_WARN, errorMsg, null ) );\n+                entry.setStartDate( new Date() );\n+                valid = false;\n+            }\n+\n+            boolean isEntryRetractEarlierThanAvailable = false;\n+            if( StringUtils.equals( getLateHandling(), AssessmentAccessControlIfc.ACCEPT_LATE_SUBMISSION.toString() ) )\n+            {\n+                // Retract date can't be before now, or before start date\n+                if( (retractDate != null && startDate != null && retractDate.before( startDate ))\n+                    || (retractDate != null && startDate == null && retractDate.before( new Date() )) )\n+                {\n+                    String errorMsg = getError( ERROR_KEY_RETRACT_BEFORE_START, entry );\n+                    context.addMessage( null, new FacesMessage( FacesMessage.SEVERITY_WARN, errorMsg, null ) );\n+                    entry.setStartDate( new Date() );\n+                    isEntryRetractEarlierThanAvailable = true;\n+                    valid = false;\n+                }\n+\n+                // Retract date can't be before due date; push it to the due date\n+                if( !isEntryRetractEarlierThanAvailable && (retractDate != null && dueDate != null && retractDate.before( dueDate )) )\n+                {\n+                    entry.setRetractDate( dueDate );\n+                }\n+            }\n+\n+            // Due date can't be the same as start date\n+            if( dueDate != null && startDate != null && dueDate.equals( startDate ) )\n+            {\n+                String errorMsg = getError( ERROR_KEY_DUE_SAME_AS_START, entry );\n+                context.addMessage( null, new FacesMessage( FacesMessage.SEVERITY_WARN, errorMsg, null ) );\n+                valid = false;\n+            }\n+\n+            // If time limit is set, ensure open window is not less than the time limit\n+            boolean hasTimer = (entry.getTimeHours() != null && entry.getTimeHours() > 0) || (entry.getTimeMinutes() != null && entry.getTimeMinutes() > 0);\n+            if (hasTimer)\n+            {\n+                Date due = entry.getRetractDate() != null ? entry.getRetractDate() : entry.getDueDate();\n+                long timerMinutes = 0;\n+                if( entry.getTimeHours() != null )\n+                {\n+                    timerMinutes += entry.getTimeHours().longValue() * 60;\n+                }\n+                if( entry.getTimeMinutes() != null )\n+                {\n+                    timerMinutes += entry.getTimeMinutes().longValue();\n+                }\n+\n+                long openWindowMinutes = (due.getTime() - entry.getStartDate().getTime()) / 1000 / 60;\n+                if( openWindowMinutes < timerMinutes )\n+                {\n+                    String errorString = getError( ERROR_KEY_OPEN_WINDOW_LESS_THAN_LIMIT, entry );\n+                    context.addMessage( null, new FacesMessage( FacesMessage.SEVERITY_WARN, errorString, null ) );\n+                    valid = false;\n+                }\n+            }\n+        }\n+\n+        // Check for duplicate users\n+        Set<String> duplicateUsers = findDuplicates(users);\n+        if( !duplicateUsers.isEmpty() )\n+        {\n+            String dupUsers = \"\";\n+            int count = 0;\n+            int end = users.size();\n+            for( String entry : duplicateUsers )\n+            {\n+                if( count == 0 )\n+                {\n+                    dupUsers = \"'\" + getUserName( entry ) + \"'\";\n+                }\n+                else if( count < (end - 1) )\n+                {\n+                    dupUsers = dupUsers + \", '\" + getUserName( entry ) + \"'\";\n+                }\n+                else\n+                {\n+                    String and = ContextUtil.getLocalizedString( ASSESSMENT_SETTINGS_BUNDLE, MSG_KEY_AND );\n+                    dupUsers = dupUsers + \", \" + and + \" '\" + getUserName( entry );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "686f2519171ada6b418c2b32bd5d23d815f47fbf"}, "originalPosition": 204}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTQwNDI4", "url": "https://github.com/sakaiproject/sakai/pull/8537#pullrequestreview-484540428", "createdAt": "2020-09-08T22:45:42Z", "commit": {"oid": "686f2519171ada6b418c2b32bd5d23d815f47fbf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6420fc260493f27055113d5bb12c7f9e15847f56", "author": {"user": {"login": "bjones86", "name": "Brian Jones"}}, "url": "https://github.com/sakaiproject/sakai/commit/6420fc260493f27055113d5bb12c7f9e15847f56", "committedDate": "2020-09-09T13:31:55Z", "message": "SAK-43610: don't overwrite errors boolean if all exceptions are valid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MDMyNTgw", "url": "https://github.com/sakaiproject/sakai/pull/8537#pullrequestreview-485032580", "createdAt": "2020-09-09T13:53:25Z", "commit": {"oid": "6420fc260493f27055113d5bb12c7f9e15847f56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2813, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}