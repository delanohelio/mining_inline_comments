{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MTQ4MzY4", "number": 8550, "title": "SAK-44265 Moved bullhorns to use Server Sent Events", "bodyText": "https://jira.sakaiproject.org/browse/SAK-44265", "createdAt": "2020-09-10T17:45:52Z", "url": "https://github.com/sakaiproject/sakai/pull/8550", "merged": true, "mergeCommit": {"oid": "70e10a2ce23e975a91b3e8e7b99a4a9c25fc9be7"}, "closed": true, "closedAt": "2021-03-25T20:25:28Z", "author": {"login": "adrianfish"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSdfGGgBqjM4NzY2OTExODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeGr-_JgBqjQ1MDk5NDIyNzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "902c0e1ca2d1b8b0b2a8a4345f7e4786f617c3f0", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/902c0e1ca2d1b8b0b2a8a4345f7e4786f617c3f0", "committedDate": "2020-09-10T17:43:21Z", "message": "SAK-44265 Moved bullhorns to use Server Sent Events\n\nhttps://jira.sakaiproject.org/browse/SAK-44265"}, "afterCommit": {"oid": "b262be15600fefe197b6f6343ec4a790aabbcbd3", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/b262be15600fefe197b6f6343ec4a790aabbcbd3", "committedDate": "2020-10-14T13:48:17Z", "message": "SAK-44265 Moved bullhorns to use Server Sent Events\n\nhttps://jira.sakaiproject.org/browse/SAK-44265"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b262be15600fefe197b6f6343ec4a790aabbcbd3", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/b262be15600fefe197b6f6343ec4a790aabbcbd3", "committedDate": "2020-10-14T13:48:17Z", "message": "SAK-44265 Moved bullhorns to use Server Sent Events\n\nhttps://jira.sakaiproject.org/browse/SAK-44265"}, "afterCommit": {"oid": "1325afcbf33d60dddc1403ae20dace77e96a3b5f", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/1325afcbf33d60dddc1403ae20dace77e96a3b5f", "committedDate": "2020-11-10T13:12:06Z", "message": "SAK-44265 Moved bullhorns to use Server Sent Events\n\nhttps://jira.sakaiproject.org/browse/SAK-44265"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1325afcbf33d60dddc1403ae20dace77e96a3b5f", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/1325afcbf33d60dddc1403ae20dace77e96a3b5f", "committedDate": "2020-11-10T13:12:06Z", "message": "SAK-44265 Moved bullhorns to use Server Sent Events\n\nhttps://jira.sakaiproject.org/browse/SAK-44265"}, "afterCommit": {"oid": "d0c69c85b96c790efc6fe539bff2c7c70d57be37", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/d0c69c85b96c790efc6fe539bff2c7c70d57be37", "committedDate": "2020-11-10T13:17:44Z", "message": "SAK-44265 Moved bullhorns to use Server Sent Events\n\nhttps://jira.sakaiproject.org/browse/SAK-44265"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0c69c85b96c790efc6fe539bff2c7c70d57be37", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/d0c69c85b96c790efc6fe539bff2c7c70d57be37", "committedDate": "2020-11-10T13:17:44Z", "message": "SAK-44265 Moved bullhorns to use Server Sent Events\n\nhttps://jira.sakaiproject.org/browse/SAK-44265"}, "afterCommit": {"oid": "7b62837eb2ed1a3ddc8b1ec9bdadf5df2522ebab", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/7b62837eb2ed1a3ddc8b1ec9bdadf5df2522ebab", "committedDate": "2020-11-12T12:36:47Z", "message": "SAK-44265 Moved bullhorns to use Server Sent Events\n\nhttps://jira.sakaiproject.org/browse/SAK-44265"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjE5MTY0MDA5", "url": "https://github.com/sakaiproject/sakai/pull/8550#pullrequestreview-619164009", "createdAt": "2021-03-23T23:11:23Z", "commit": {"oid": "7b62837eb2ed1a3ddc8b1ec9bdadf5df2522ebab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0yM1QyMzoxMToyM1rOI8OhcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0yM1QyMzoxMToyM1rOI8OhcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMDAyMzQwOQ==", "bodyText": "what's the logic around removing this cache?", "url": "https://github.com/sakaiproject/sakai/pull/8550#discussion_r600023409", "createdAt": "2021-03-23T23:11:23Z", "author": {"login": "ottenhoff"}, "path": "assignment/api/src/java/org/sakaiproject/assignment/api/AddAssignmentBullhornHandler.java", "diffHunk": "@@ -150,8 +146,6 @@ protected void doInTransactionWithoutResult(TransactionStatus status) {\n             }\n         });\n \n-        users.forEach(u -> countCache.remove(u));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b62837eb2ed1a3ddc8b1ec9bdadf5df2522ebab"}, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjE5MTY1MjQ4", "url": "https://github.com/sakaiproject/sakai/pull/8550#pullrequestreview-619165248", "createdAt": "2021-03-23T23:14:09Z", "commit": {"oid": "7b62837eb2ed1a3ddc8b1ec9bdadf5df2522ebab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0yM1QyMzoxNDowOVrOI8Oljg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0yM1QyMzoxNDowOVrOI8Oljg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMDAyNDQ2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        <version>3.3.9.RELEASE</version>\n          \n          \n            \n                        <version>3.3.15.RELEASE</version>", "url": "https://github.com/sakaiproject/sakai/pull/8550#discussion_r600024462", "createdAt": "2021-03-23T23:14:09Z", "author": {"login": "ottenhoff"}, "path": "deploy/pom.xml", "diffHunk": "@@ -392,6 +392,22 @@\n             <artifactId>spring-webmvc</artifactId>\n             <scope>compile</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.reactivestreams</groupId>\n+            <artifactId>reactive-streams</artifactId>\n+            <version>1.0.3</version>\n+            <scope>compile</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>io.projectreactor</groupId>\n+            <artifactId>reactor-core</artifactId>\n+            <version>3.3.9.RELEASE</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b62837eb2ed1a3ddc8b1ec9bdadf5df2522ebab"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjE5MTY3MTI2", "url": "https://github.com/sakaiproject/sakai/pull/8550#pullrequestreview-619167126", "createdAt": "2021-03-23T23:18:21Z", "commit": {"oid": "7b62837eb2ed1a3ddc8b1ec9bdadf5df2522ebab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0yM1QyMzoxODoyMVrOI8Or7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0yM1QyMzoxODoyMVrOI8Or7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMDAyNjA5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (comments.size() > 1) {\n          \n          \n            \n                            if (comments != null && comments.size() > 1) {", "url": "https://github.com/sakaiproject/sakai/pull/8550#discussion_r600026093", "createdAt": "2021-03-23T23:18:21Z", "author": {"login": "ottenhoff"}, "path": "lessonbuilder/api/src/java/org/sakaiproject/lessonbuildertool/api/AddLessonsCommentBullhornHandler.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/**\n+ * Copyright (c) 2003-2017 The Apereo Foundation\n+ *\n+ * Licensed under the Educational Community License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *             http://opensource.org/licenses/ecl2\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sakaiproject.lessonbuildertool.api;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import javax.annotation.Resource;\n+\n+import org.sakaiproject.event.api.Event;\n+import org.sakaiproject.lessonbuildertool.SimplePage;\n+import org.sakaiproject.lessonbuildertool.SimplePageComment;\n+import org.sakaiproject.lessonbuildertool.model.SimplePageToolDao;\n+import org.sakaiproject.messaging.api.BullhornData;\n+import org.sakaiproject.messaging.api.bullhornhandlers.AbstractBullhornHandler;\n+import org.sakaiproject.user.api.User;\n+\n+import org.springframework.stereotype.Component;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+@Slf4j\n+@Component\n+public class AddLessonsCommentBullhornHandler extends AbstractBullhornHandler {\n+\n+    @Resource(name = \"org.sakaiproject.lessonbuildertool.model.SimplePageToolDao\")\n+    private SimplePageToolDao simplePageToolDao;\n+\n+    @Override\n+    public List<String> getHandledEvents() {\n+        return Arrays.asList(LessonBuilderEvents.COMMENT_CREATE);\n+    }\n+\n+    @Override\n+    public Optional<List<BullhornData>> handleEvent(Event e) {\n+\n+        List<BullhornData> bhEvents = new ArrayList<>();\n+\n+        String ref = e.getResource();\n+        String context = e.getContext();\n+        String[] pathParts = ref.split(\"/\");\n+        String from = e.getUserId();\n+\n+        try {\n+            long commentId = Long.parseLong(pathParts[pathParts.length - 1]);\n+            SimplePageComment comment = simplePageToolDao.findCommentById(commentId);\n+\n+            String url = simplePageToolDao.getPageUrl(comment.getPageId());\n+\n+            if (url != null) {\n+                List<String> done = new ArrayList<>();\n+                // Alert tutor types.\n+                List<User> receivers = securityService.unlockUsers(\n+                    SimplePage.PERMISSION_LESSONBUILDER_UPDATE, \"/site/\" + context);\n+                for (User receiver : receivers) {\n+                    String to = receiver.getId();\n+                    if (!to.equals(from)) {\n+                        //doInsert(from, to, event, ref, \"title\", context, e.getEventTime(), url);\n+                        bhEvents.add(new BullhornData(from, to, context, \"title\", url));\n+                        done.add(to);\n+                    }\n+                }\n+\n+                // Get all the comments in the same item\n+                List<SimplePageComment> comments\n+                    = simplePageToolDao.findCommentsOnItems(\n+                        Arrays.asList(new Long[] {comment.getItemId()}));\n+\n+                if (comments.size() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b62837eb2ed1a3ddc8b1ec9bdadf5df2522ebab"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjIxNTE5MzIw", "url": "https://github.com/sakaiproject/sakai/pull/8550#pullrequestreview-621519320", "createdAt": "2021-03-25T19:47:53Z", "commit": {"oid": "886c6c8b4bfa3e2abaf80f6d6a07cd89b5d99a33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "582d561c528773cc87da6e1c7250d73b76a433a7", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/582d561c528773cc87da6e1c7250d73b76a433a7", "committedDate": "2021-03-25T20:06:09Z", "message": "SAK-44265 Moved bullhorns to use Server Sent Events\n\nhttps://jira.sakaiproject.org/browse/SAK-44265"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "886c6c8b4bfa3e2abaf80f6d6a07cd89b5d99a33", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/886c6c8b4bfa3e2abaf80f6d6a07cd89b5d99a33", "committedDate": "2021-03-24T10:21:18Z", "message": "Update lessonbuilder/api/src/java/org/sakaiproject/lessonbuildertool/api/AddLessonsCommentBullhornHandler.java\n\nCo-authored-by: Sam Ottenhoff <ottenhoff@longsight.com>"}, "afterCommit": {"oid": "582d561c528773cc87da6e1c7250d73b76a433a7", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/582d561c528773cc87da6e1c7250d73b76a433a7", "committedDate": "2021-03-25T20:06:09Z", "message": "SAK-44265 Moved bullhorns to use Server Sent Events\n\nhttps://jira.sakaiproject.org/browse/SAK-44265"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2614, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}