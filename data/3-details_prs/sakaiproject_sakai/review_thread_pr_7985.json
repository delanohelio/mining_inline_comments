{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NzU0MTAx", "number": 7985, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMDo0NjoyNlrODlwRsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODo1NTo1OVrODnlj6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwOTE0ODY2OnYy", "diffSide": "RIGHT", "path": "site-manage/site-group-manager/src/main/webapp/WEB-INF/templates/index.html", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMDo0NjoyNlrOFy0k3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMDo0NjoyNlrOFy0k3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgzNDUyNQ==", "bodyText": "Looks like there's a label missing for this input. That makes it hard for people using screen readers or voice control to use the input.", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r388834525", "createdAt": "2020-03-06T10:46:26Z", "author": {"login": "accesslint"}, "path": "site-manage/site-group-manager/src/main/webapp/WEB-INF/templates/index.html", "diffHunk": "@@ -21,16 +23,37 @@\n         <tbody>\n           <tr th:each=\"group : ${groupList}\">\n             <td>\n-              <span th:if=\"${lockedGroupList.contains(group)}\" class=\"fa fa-fw fa-lock\" aria-hidden=\"true\" th:title=\"#{index.table.grouplocked}\"></span>\n-              <a th:if=\"${!lockedGroupList.contains(group)}\" th:href=\"@{/group(groupId=${group.id})}\" th:text=\"${group.title}\"></a>\n-              <span th:if=\"${lockedGroupList.contains(group)}\" th:text=\"${group.title}\"></span>\n+              <span th:if=\"${lockedGroupList.contains(group.id)}\" class=\"fa fa-fw fa-lock\" aria-hidden=\"true\" th:title=\"#{index.table.grouplocked}\"></span>\n+              <a th:if=\"${!lockedGroupList.contains(group.id)}\" th:href=\"@{/group(groupId=${group.id})}\" th:text=\"${group.title}\"></a>\n+              <span th:if=\"${lockedGroupList.contains(group.id)}\" th:text=\"${group.title}\"></span>\n+            </td>\n+            <td class=\"hidden-xs\" th:if=\"${anyGroupLocked}\">\n+              <div th:if=\"${lockedGroupsEntityMap.get(group.id) != null }\">\n+                <div th:if=\"${!lockedGroupsEntityMap.get(group.id).get('assignments').isEmpty()}\">\n+                  <span class=\"group-locked-info-collapsed\" data-toggle=\"collapse\" th:data-target=\"|#lockingassignments-${group.id}|\" tabindex=\"0\" role=\"button\" th:text=\"#{index.table.assignments}\"></span>\n+                  <div th:id=\"|lockingassignments-${group.id}|\" class=\"collapse\">\n+                    <ul th:each=\" assigment : ${lockedGroupsEntityMap.get(group.id).get('assignments')}\">\n+                      <li th:text=\"${assigment}\"></li>\n+                    </ul>\n+                  </div>\n+                </div>\n+                <div class=\"clearfix\"></div>\n+                <div th:if=\"${!lockedGroupsEntityMap.get(group.id).get('assessments').isEmpty()}\">\n+                <span class=\"group-locked-info-collapsed\" data-toggle=\"collapse\" th:data-target=\"|#lockingassessments-${group.id}|\" tabindex=\"0\" role=\"button\" th:text=\"#{index.table.assessments}\"></span>\n+                  <div th:id=\"|lockingassessments-${group.id}|\" class=\"collapse\">\n+                    <ul th:each=\" assessment : ${lockedGroupsEntityMap.get(group.id).get('assessments')}\">\n+                      <li th:text=\"${assessment}\"></li>\n+                    </ul>\n+                  </div>\n+                </div>\n+              </div>\n             </td>\n             <td><a th:if=\"${groupJoinableSetMap.get(group.id) != null}\" th:href=\"@{/joinableset(joinableSetId=${groupJoinableSetMap.get(group.id)})}\" th:text=\"${groupJoinableSetMap.get(group.id)}\"></a></td>\n             <td class=\"hidden-xs\"><span th:text=\"${group.getMembers().size()}\"></span> <span th:if=\"${groupJoinableSetSizeMap.get(group.id) != null}\" th:text=\"'('+${groupJoinableSetSizeMap.get(group.id)}+')'\"></span></td>\n             <td class=\"hidden-xs\" th:text=\"${groupMemberMap.get(group.id)}\"></td>\n             <td>\n-              <input th:if=\"${!lockedForDeletionGroupList.contains(group)}\" th:attr=\"groupInfo=|${group.title} - ${group.getMembers().size()} #{index.table.members}|\" type=\"checkbox\" name=\"deletedGroupList\" th:field=\"*{deletedGroupList}\" th:value=\"${group.id}\" onchange=\"indexFunctions.checkSubmitButton();\"/>\n-              <span th:if=\"${lockedForDeletionGroupList.contains(group)}\" class=\"fa fa-fw fa-lock\" aria-hidden=\"true\" th:title=\"#{index.table.grouplocked.deletion}\"></span>\n+              <input th:if=\"${!lockedForDeletionGroupList.contains(group.id)}\" th:attr=\"groupInfo=|${group.title} - ${group.getMembers().size()} #{index.table.members}|\" type=\"checkbox\" name=\"deletedGroupList\" th:field=\"*{deletedGroupList}\" th:value=\"${group.id}\" onchange=\"indexFunctions.checkSubmitButton();\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyODE4ODg1OnYy", "diffSide": "RIGHT", "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/controller/MainController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODowMjoyMFrOF1pgfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMToyNjoyNlrOF2AR3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5ODkxMQ==", "bodyText": "can use diamond operator here and in few other places\nArrayList<>()", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r391798911", "createdAt": "2020-03-12T18:02:20Z", "author": {"login": "ern"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/controller/MainController.java", "diffHunk": "@@ -75,11 +75,15 @@ public int compare(Group g1, Group g2){\n                 return g1.getTitle().compareToIgnoreCase(g2.getTitle());\n         }});\n \n-        List<Group> lockedGroupList = site.getGroups().stream().filter(group -> RealmLockMode.ALL.equals(group.getRealmLock()) || RealmLockMode.MODIFY.equals(group.getRealmLock())).collect(Collectors.toList());\n-        List<Group> lockedForDeletionGroupList = site.getGroups().stream().filter(group -> RealmLockMode.ALL.equals(group.getRealmLock()) || RealmLockMode.DELETE.equals(group.getRealmLock())).collect(Collectors.toList());\n+        // Control the groups that are locked by entities\n+        boolean anyGroupLocked = false;\n+        List<String> lockedGroupList = new ArrayList<String>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE3MTk5OA==", "bodyText": "Well, it's optional right? I like declaring the types but ok, I've changed them.", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r392171998", "createdAt": "2020-03-13T11:26:26Z", "author": {"login": "mpellicer"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/controller/MainController.java", "diffHunk": "@@ -75,11 +75,15 @@ public int compare(Group g1, Group g2){\n                 return g1.getTitle().compareToIgnoreCase(g2.getTitle());\n         }});\n \n-        List<Group> lockedGroupList = site.getGroups().stream().filter(group -> RealmLockMode.ALL.equals(group.getRealmLock()) || RealmLockMode.MODIFY.equals(group.getRealmLock())).collect(Collectors.toList());\n-        List<Group> lockedForDeletionGroupList = site.getGroups().stream().filter(group -> RealmLockMode.ALL.equals(group.getRealmLock()) || RealmLockMode.DELETE.equals(group.getRealmLock())).collect(Collectors.toList());\n+        // Control the groups that are locked by entities\n+        boolean anyGroupLocked = false;\n+        List<String> lockedGroupList = new ArrayList<String>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5ODkxMQ=="}, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyODE5NjQxOnYy", "diffSide": "RIGHT", "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODowNDozN1rOF1plcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMToyNzo0OFrOF2AUBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwMDE3Ng==", "bodyText": "super generic and vague name SakaiService, also given that this is in a tool this shouldn't be named a service as it's misleading!\nmaybe something like:\nGroupManagerOperations\nGroupManagerActions", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r391800176", "createdAt": "2020-03-12T18:04:37Z", "author": {"login": "ern"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "diffHunk": "@@ -42,6 +51,9 @@\n @Slf4j\n public class SakaiService  {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE3MjU1MA==", "bodyText": "I don't agree with this, this is a \"service that interacts with some Sakai services\", SakaiService makes sense to me. I'm not going to change the name of the service and all the variables in this PR.", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r392172550", "createdAt": "2020-03-13T11:27:48Z", "author": {"login": "mpellicer"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "diffHunk": "@@ -42,6 +51,9 @@\n @Slf4j\n public class SakaiService  {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwMDE3Ng=="}, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyODM2MTcwOnYy", "diffSide": "RIGHT", "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODo1NToxMVrOF1rPMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMTozODo0MVrOF2Al0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgyNzI1MA==", "bodyText": "Use the AssignmentConstants in the pi that's the whole purpose so we don't recreate all these constants.", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r391827250", "createdAt": "2020-03-12T18:55:11Z", "author": {"login": "ern"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "diffHunk": "@@ -126,4 +138,44 @@ public void postEvent(String event, String userId) {\n         eventTrackingService.post(eventTrackingService.newEvent(event, userId, true/*update event*/));\n     }\n \n+    public Map<String, List<String>> getGroupLockingEntities (Group group) {\n+        Map<String, List<String>> lockingEntitiesMap = new HashMap<String, List<String>>();\n+        List<String[]> groupRealmLocks = group.getRealmLocks();\n+\n+        // Add one list per entity that locks groups.\n+        List<String> assignmentTitles = new ArrayList<String>();\n+        List<String> assessmentTitles = new ArrayList<String>();\n+\n+        for (String[] groupRealmLock : groupRealmLocks) {\n+            String objectReference = groupRealmLock[0];\n+            if (StringUtils.isNotBlank(objectReference)) {\n+                if (objectReference.startsWith(GroupManagerConstants.ASN_ENTITY_PREFIX)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE3NzEwNw==", "bodyText": "Ok, thanks for the constant!", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r392177107", "createdAt": "2020-03-13T11:38:41Z", "author": {"login": "mpellicer"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "diffHunk": "@@ -126,4 +138,44 @@ public void postEvent(String event, String userId) {\n         eventTrackingService.post(eventTrackingService.newEvent(event, userId, true/*update event*/));\n     }\n \n+    public Map<String, List<String>> getGroupLockingEntities (Group group) {\n+        Map<String, List<String>> lockingEntitiesMap = new HashMap<String, List<String>>();\n+        List<String[]> groupRealmLocks = group.getRealmLocks();\n+\n+        // Add one list per entity that locks groups.\n+        List<String> assignmentTitles = new ArrayList<String>();\n+        List<String> assessmentTitles = new ArrayList<String>();\n+\n+        for (String[] groupRealmLock : groupRealmLocks) {\n+            String objectReference = groupRealmLock[0];\n+            if (StringUtils.isNotBlank(objectReference)) {\n+                if (objectReference.startsWith(GroupManagerConstants.ASN_ENTITY_PREFIX)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgyNzI1MA=="}, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyODM2NDU2OnYy", "diffSide": "RIGHT", "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODo1NTo1OVrOF1rRBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMTozOTowNVrOF2AmuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgyNzcxNg==", "bodyText": "Use the AssignmentReferenceReckoner to load an assignment reference which you can easily get the assignment to load", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r391827716", "createdAt": "2020-03-12T18:55:59Z", "author": {"login": "ern"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "diffHunk": "@@ -126,4 +138,44 @@ public void postEvent(String event, String userId) {\n         eventTrackingService.post(eventTrackingService.newEvent(event, userId, true/*update event*/));\n     }\n \n+    public Map<String, List<String>> getGroupLockingEntities (Group group) {\n+        Map<String, List<String>> lockingEntitiesMap = new HashMap<String, List<String>>();\n+        List<String[]> groupRealmLocks = group.getRealmLocks();\n+\n+        // Add one list per entity that locks groups.\n+        List<String> assignmentTitles = new ArrayList<String>();\n+        List<String> assessmentTitles = new ArrayList<String>();\n+\n+        for (String[] groupRealmLock : groupRealmLocks) {\n+            String objectReference = groupRealmLock[0];\n+            if (StringUtils.isNotBlank(objectReference)) {\n+                if (objectReference.startsWith(GroupManagerConstants.ASN_ENTITY_PREFIX)) {\n+                    String assignmentReference = objectReference.substring(objectReference.lastIndexOf(\"/\") + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE3NzMzNw==", "bodyText": "Thanks for that, implemented the change, now using the AssignmentReferenceReckoner.", "url": "https://github.com/sakaiproject/sakai/pull/7985#discussion_r392177337", "createdAt": "2020-03-13T11:39:05Z", "author": {"login": "mpellicer"}, "path": "site-manage/site-group-manager/src/main/java/org/sakaiproject/groupmanager/service/SakaiService.java", "diffHunk": "@@ -126,4 +138,44 @@ public void postEvent(String event, String userId) {\n         eventTrackingService.post(eventTrackingService.newEvent(event, userId, true/*update event*/));\n     }\n \n+    public Map<String, List<String>> getGroupLockingEntities (Group group) {\n+        Map<String, List<String>> lockingEntitiesMap = new HashMap<String, List<String>>();\n+        List<String[]> groupRealmLocks = group.getRealmLocks();\n+\n+        // Add one list per entity that locks groups.\n+        List<String> assignmentTitles = new ArrayList<String>();\n+        List<String> assessmentTitles = new ArrayList<String>();\n+\n+        for (String[] groupRealmLock : groupRealmLocks) {\n+            String objectReference = groupRealmLock[0];\n+            if (StringUtils.isNotBlank(objectReference)) {\n+                if (objectReference.startsWith(GroupManagerConstants.ASN_ENTITY_PREFIX)) {\n+                    String assignmentReference = objectReference.substring(objectReference.lastIndexOf(\"/\") + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgyNzcxNg=="}, "originalCommit": {"oid": "f6a624767a75c308c7d8b5e027725962c199a336"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2393, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}