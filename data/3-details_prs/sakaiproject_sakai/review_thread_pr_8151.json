{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NDA3NzYw", "number": 8151, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNDoyMTozNVrODyhrpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo0NToxNFrODykFug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MzA3MjM4OnYy", "diffSide": "RIGHT", "path": "webcomponents/tool/src/main/frontend/js/sakai-date-picker.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNDoyMTozNVrOGGnxDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNDoyMTozNVrOGGnxDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5NjE3Mw==", "bodyText": "Looks like there's a label missing for this input. That makes it hard for people using screen readers or voice control to use the input.", "url": "https://github.com/sakaiproject/sakai/pull/8151#discussion_r409596173", "createdAt": "2020-04-16T14:21:35Z", "author": {"login": "accesslint"}, "path": "webcomponents/tool/src/main/frontend/js/sakai-date-picker.js", "diffHunk": "@@ -3,44 +3,90 @@ import {html} from \"./assets/lit-element/lit-element.js\";\n \n class SakaiDatePicker extends SakaiElement {\n \n+  constructor() {\n+\n+    super();\n+\n+    this.hoursFromNow = 0;\n+\n+    this.idSalt = Math.floor(Math.random() * Math.floor(1000));\n+    this.start = moment();\n+\n+    this.i18n = {};\n+    this.loadTranslations(\"date-picker-wc\").then(r => this.i18n = r);\n+  }\n+\n   static get properties() {\n \n     return {\n-      initialValue: { attribute: \"initial-value\", type : String },\n-      parseFormat: { attribute: \"parse-format\", type: String },\n+      hoursFromNow: { attribute: \"hours-from-now\", type: Number },\n+      initialValue: { attribute: \"initial-value\", type: Number }\n     };\n+  }\n+\n+  set initialValue(newValue) {\n \n+    this._initialValue = newValue;\n+    this.start = this.getPreferredSakaiDatetime(newValue);\n   }\n \n-  constructor() {\n+  get initialValue() {\n+    return this._initialValue;\n+  }\n \n-    super();\n+  set hoursFromNow(newValue) {\n+\n+    this._hoursFromNow = newValue;\n+    this.start = moment(this.start).add(this.hoursFromNow, \"hours\");\n+  }\n \n-    this.parseFormat = \"YYYY-MM-DDTHH:mm:ssZ\";\n-    this.inputId = `date-picker-${Math.floor(Math.random() * Math.floor(1000))}`;\n+  get hoursFromNow() {\n+    return this._hoursFromNow;\n   }\n \n   firstUpdated(changedProperties) {\n \n-    localDatePicker({\n-      input: `#${this.inputId}`,\n-      useTime: 1,\n-      val: this.initialValue,\n-      parseFormat: this.parseFormat,\n-      onDateTimeSelected: (v) => this.fireEvent(v),\n-    });\n+    const self = this;\n+\n+    let config = {\n+      enableTime: true,\n+      locale: portal.locale.split(\"-\")[0],\n+      time_24hr: true,\n+      allowInput: true,\n+      defaultHour: this.start.hours(),\n+      defaultMinute: this.start.minutes(),\n+      static: true,\n+      onReady() {\n+        this.showTimeInput = true;\n+        this.setDate(self.start.toDate());\n+      },\n+      onChange(selectedDates) {\n+        self.dispatchEvent(new CustomEvent(\"datetime-selected\", { detail: { epochMillis: selectedDates[0].getTime() }, bubbles: true }));\n+      }\n+    };\n+\n+    config.locale = window.top.portal && window.top.portal.locale ? window.top.portal.locale.split(\"-\")[0] : \"default\";\n+    if (config.locale === \"en\") config.locale = \"default\";\n+\n+    flatpickr(`#picker-${this.idSalt}`, config);\n   }\n \n   render() {\n \n     return html`\n-      <input id=\"${this.inputId}\" type=\"text\" />\n-      <div>${this.dateTime}</div>\n+      <input type=\"text\" id=\"picker-${this.idSalt}\" size=\"30\" placeholder=\"${this.i18n[\"input_placeholder\"]}\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b92e33c89c2865c2219cf0679a63ef53a88f88f2"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MzQ2NjgyOnYy", "diffSide": "RIGHT", "path": "webcomponents/tool/src/main/frontend/js/sakai-date-picker.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo0NToxNFrOGGrr5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo0NToxNFrOGGrr5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY2MDM5MA==", "bodyText": "Looks like there's a label missing for this input. That makes it hard for people using screen readers or voice control to use the input.", "url": "https://github.com/sakaiproject/sakai/pull/8151#discussion_r409660390", "createdAt": "2020-04-16T15:45:14Z", "author": {"login": "accesslint"}, "path": "webcomponents/tool/src/main/frontend/js/sakai-date-picker.js", "diffHunk": "@@ -1,46 +1,113 @@\n import {SakaiElement} from \"./sakai-element.js\";\n import {html} from \"./assets/lit-element/lit-element.js\";\n \n+/**\n+ * Renders an input which, when clicked, launches a Flatpickr instance. This tag relies\n+ * on both flatpickr.js and moment.js being in scope.\n+ *\n+ * @example <caption>Usage:</caption>\n+ * <sakai-date-picker epoch-millis=\"345922925445\" @/>\n+ * <sakai-date-picker hours-from-now=\"5\" />\n+ *\n+ * The tag fires the event 'datetime-selected'. You'd handle that with (vanillajs):\n+ *\n+ * sakaiDatePicker.addEventListener(\"datetime-selected\", (e) => console.log(e.detail.epochMillis));\n+ *\n+ * @extends SakaiElement\n+ * @author Adrian Fish <adrian.r.fish@gmail.com>\n+ */\n class SakaiDatePicker extends SakaiElement {\n \n+  constructor() {\n+\n+    super();\n+\n+    this.hoursFromNow = 0;\n+\n+    this.idSalt = Math.floor(Math.random() * Math.floor(1000));\n+    this.start = moment();\n+\n+    this.i18n = {};\n+    this.loadTranslations(\"date-picker-wc\").then(r => this.i18n = r);\n+  }\n+\n   static get properties() {\n \n     return {\n-      initialValue: { attribute: \"initial-value\", type : String },\n-      parseFormat: { attribute: \"parse-format\", type: String },\n+      hoursFromNow: { attribute: \"hours-from-now\", type: Number },\n+      initialValue: { attribute: \"initial-value\", type: Number }\n     };\n+  }\n+\n+  set initialValue(newValue) {\n+\n+    this._initialValue = newValue;\n \n+    if (newValue) {\n+      this.start = this.getPreferredSakaiDatetime(newValue);\n+    }\n   }\n \n-  constructor() {\n+  get initialValue() {\n+    return this._initialValue;\n+  }\n \n-    super();\n+  set hoursFromNow(newValue) {\n+\n+    this._hoursFromNow = newValue;\n+\n+    if (newValue) {\n+      this.start = moment(this.start).add(this.hoursFromNow, \"hours\");\n+    }\n+  }\n \n-    this.parseFormat = \"YYYY-MM-DDTHH:mm:ssZ\";\n-    this.inputId = `date-picker-${Math.floor(Math.random() * Math.floor(1000))}`;\n+  get hoursFromNow() {\n+    return this._hoursFromNow;\n   }\n \n   firstUpdated(changedProperties) {\n \n-    localDatePicker({\n-      input: `#${this.inputId}`,\n-      useTime: 1,\n-      val: this.initialValue,\n-      parseFormat: this.parseFormat,\n-      onDateTimeSelected: (v) => this.fireEvent(v),\n-    });\n+    const self = this;\n+\n+    let config = {\n+      enableTime: true,\n+      locale: portal.locale.split(\"-\")[0],\n+      time_24hr: true,\n+      allowInput: true,\n+      defaultHour: this.start.hours(),\n+      defaultMinute: this.start.minutes(),\n+      static: true,\n+      onReady() {\n+        this.showTimeInput = true;\n+        this.setDate(self.start.toDate());\n+      },\n+      onChange(selectedDates) {\n+        self.dispatchEvent(new CustomEvent(\"datetime-selected\", { detail: { epochMillis: selectedDates[0].getTime() }, bubbles: true }));\n+      }\n+    };\n+\n+    config.locale = window.top.portal && window.top.portal.locale ? window.top.portal.locale.split(\"-\")[0] : \"default\";\n+    if (config.locale === \"en\") config.locale = \"default\";\n+\n+    flatpickr(`#picker-${this.idSalt}`, config);\n   }\n \n   render() {\n \n     return html`\n-      <input id=\"${this.inputId}\" type=\"text\" />\n-      <div>${this.dateTime}</div>\n+      <input type=\"text\" id=\"picker-${this.idSalt}\" size=\"30\" placeholder=\"${this.i18n[\"input_placeholder\"]}\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "458d96201a5c4c00a35f65de66b5bcaf99371306"}, "originalPosition": 113}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2244, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}