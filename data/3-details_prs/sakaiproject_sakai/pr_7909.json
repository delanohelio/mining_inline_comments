{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2ODE5MjMw", "number": 7909, "title": "SAK-42959 Default lang-datepicker to user's local timestamp", "bodyText": "https://jira.sakaiproject.org/browse/SAK-42959", "createdAt": "2020-02-18T20:27:50Z", "url": "https://github.com/sakaiproject/sakai/pull/7909", "merged": true, "mergeCommit": {"oid": "6b3dd1412dbeea007adcdad1652b1cd38c6b3633"}, "closed": true, "closedAt": "2020-02-19T21:04:02Z", "author": {"login": "adrianfish"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFo4WFgFqTM2MDY4ODU5OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcF8ktLABqjMwNTMyOTQ4OTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjg4NTk5", "url": "https://github.com/sakaiproject/sakai/pull/7909#pullrequestreview-360688599", "createdAt": "2020-02-18T21:33:26Z", "commit": {"oid": "f9af75b3e54be203c85db3ae6e700c56fdccf543"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozMzoyN1rOFrTNbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozMzoyN1rOFrTNbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0NzgyMg==", "bodyText": "Just one method called addUserTimezoneInfo ? And then we add 3-4 new vars around time?", "url": "https://github.com/sakaiproject/sakai/pull/7909#discussion_r380947822", "createdAt": "2020-02-18T21:33:27Z", "author": {"login": "ottenhoff"}, "path": "portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/SiteHandler.java", "diffHunk": "@@ -556,6 +556,10 @@ public void doSite(HttpServletRequest req, HttpServletResponse res, Session sess\n \t\trcontext.put(\"showFavStarsOnAllFavSites\",ServerConfigurationService.getBoolean(SAK_PROP_SHOW_FAV_STARS_ON_ALL, SAK_PROP_SHOW_FAV_STARS_ON_ALL_DFLT));\n \t\t\n \t\taddLocale(rcontext, site, session.getUserId());\n+\n+\t\taddServerTime(rcontext);\n+\n+\t\taddUserTimezoneOffset(rcontext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9af75b3e54be203c85db3ae6e700c56fdccf543"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjg5Mjcy", "url": "https://github.com/sakaiproject/sakai/pull/7909#pullrequestreview-360689272", "createdAt": "2020-02-18T21:34:28Z", "commit": {"oid": "f9af75b3e54be203c85db3ae6e700c56fdccf543"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozNDoyOFrOFrTPmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozNDoyOFrOFrTPmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0ODM3OA==", "bodyText": "while we are here, why don't we add the user's current (localized) date/time as ISO-8601 .... and might as well add their preferred timezone (e.g., Europe/Stockholm) .......", "url": "https://github.com/sakaiproject/sakai/pull/7909#discussion_r380948378", "createdAt": "2020-02-18T21:34:28Z", "author": {"login": "ottenhoff"}, "path": "portal/portal-impl/impl/src/java/org/sakaiproject/portal/charon/handlers/BasePortalHandler.java", "diffHunk": "@@ -209,4 +210,14 @@ protected void addLocale(PortalRenderContext rcontext, Site site, String userId)\n \t\t\ttimeService.clearLocalTimeZone(userId);\n \t\t}\n \t}\n+\n+\tprotected void addServerTime(PortalRenderContext rcontext) {\n+\t\trcontext.put(\"serverTime\", Instant.now().toEpochMilli());\n+\t}\n+\n+\tprotected void addUserTimezoneOffset(PortalRenderContext rcontext) {\n+\n+\t\tint offset = timeService.getLocalTimeZone().getOffset(Instant.now().toEpochMilli());\n+\t\trcontext.put(\"userTimezoneOffset\", offset);\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9af75b3e54be203c85db3ae6e700c56fdccf543"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjg5NjU4", "url": "https://github.com/sakaiproject/sakai/pull/7909#pullrequestreview-360689658", "createdAt": "2020-02-18T21:35:06Z", "commit": {"oid": "f9af75b3e54be203c85db3ae6e700c56fdccf543"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozNTowN1rOFrTQvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozNTowN1rOFrTQvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0ODY2OQ==", "bodyText": "you GMT developers live in an offset-free world!\n var osTzOffset = (new Date()).getTimezoneOffset();\n            initVal = moment(parseInt(portal.serverTime))\n              .add(portal.userTimezoneOffset, 'ms')\n              .add(osTzOffset, 'm')\n              .toDate();", "url": "https://github.com/sakaiproject/sakai/pull/7909#discussion_r380948669", "createdAt": "2020-02-18T21:35:07Z", "author": {"login": "ottenhoff"}, "path": "library/src/webapp/js/lang-datepicker/lang-datepicker.js", "diffHunk": "@@ -1684,40 +1684,47 @@ if(c&&c._defaults.timeOnly&&b.input.val()!==b.lastVal)try{$.datepicker._updateDa\n \t\t\t}\n \t\t}\n \n-\t\t/**\n-\t\t * Initiallizes the base date for the picker.\n-\t\t * This gets the date that should be displayed to the user.\n-\t\t * \n-\t\t */\n-\t\tvar initDateTime = function () {\n-\t\t\tvar initVal;\n+    /**\n+     * Initiallizes the base date for the picker.\n+     * This gets the date that should be displayed to the user.\n+     *\n+     */\n+    var initDateTime = function () {\n \n- \t\t\t// If val is undefined, we assume we're to use the input value \n-\t\t\tif (typeof options.val === 'undefined' && $(options.input).val() !== '') {\n-\t\t\t\tinitVal = $(options.input).val();\n-\t\t\t}\n+      var initVal;\n \n-\t\t\t// if val is set, use it\n-\t\t\tif (typeof options.val !== 'undefined') {\n-\t\t\t\tinitVal = options.val;\n-\t\t\t}\n+      // If val is undefined, we assume we're to use the input value\n+      if (typeof options.val === 'undefined' && $(options.input).val() !== '') {\n+        initVal = $(options.input).val();\n+      }\n \n-\t\t\t// if getval is set, this will override val\n-\t\t\tif (typeof options.getval !== 'undefined') {\n-\t\t\t\tinitVal = $(options.getval).val();\n-\t\t\t}\n+      // if val is set, use it\n+      if (typeof options.val !== 'undefined') {\n+        initVal = options.val;\n+      }\n \n-\t\t\t// finally trim the initVal and make sure it is set so we don't Dec 1969 the user\n-\t\t\tinitVal = jQuery.trim(initVal);\n+      // if getval is set, this will override val\n+      if (typeof options.getval !== 'undefined') {\n+        initVal = $(options.getval).val();\n+      }\n \n-\t\t\tif (!(initVal == \"\" && options.allowEmptyDate)){\n-\t\t\t\tif (!initVal) initVal = new Date();\n-\t\t\t}\n+      // finally trim the initVal and make sure it is set so we don't Dec 1969 the user\n+      initVal = jQuery.trim(initVal);\n \n+      if (!(initVal == \"\" && options.allowEmptyDate)){\n+        if (!initVal) {\n+          if (portal.serverTime && portal.userTimezoneOffset) {\n+            initVal = moment.utc(parseInt(portal.serverTime)).add(portal.userTimezoneOffset/1000, \"seconds\").toDate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9af75b3e54be203c85db3ae6e700c56fdccf543"}, "originalPosition": 58}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9af75b3e54be203c85db3ae6e700c56fdccf543", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/f9af75b3e54be203c85db3ae6e700c56fdccf543", "committedDate": "2020-02-18T20:25:06Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}, "afterCommit": {"oid": "ab490516ab88bb2a21b51b4881989d26c42bc38d", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/ab490516ab88bb2a21b51b4881989d26c42bc38d", "committedDate": "2020-02-19T08:45:10Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab490516ab88bb2a21b51b4881989d26c42bc38d", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/ab490516ab88bb2a21b51b4881989d26c42bc38d", "committedDate": "2020-02-19T08:45:10Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}, "afterCommit": {"oid": "81f489eb9e280bc443ab2fbdd48fbd15d850ec15", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/81f489eb9e280bc443ab2fbdd48fbd15d850ec15", "committedDate": "2020-02-19T10:09:35Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81f489eb9e280bc443ab2fbdd48fbd15d850ec15", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/81f489eb9e280bc443ab2fbdd48fbd15d850ec15", "committedDate": "2020-02-19T10:09:35Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}, "afterCommit": {"oid": "1af1ad207e5d9041367725ac15eeb5ce967d0d54", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/1af1ad207e5d9041367725ac15eeb5ce967d0d54", "committedDate": "2020-02-19T20:06:57Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNDEwMjkz", "url": "https://github.com/sakaiproject/sakai/pull/7909#pullrequestreview-361410293", "createdAt": "2020-02-19T20:24:08Z", "commit": {"oid": "1af1ad207e5d9041367725ac15eeb5ce967d0d54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1af1ad207e5d9041367725ac15eeb5ce967d0d54", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/1af1ad207e5d9041367725ac15eeb5ce967d0d54", "committedDate": "2020-02-19T20:06:57Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}, "afterCommit": {"oid": "15288745b67d0a5f8976322907591b75d3f43b21", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/15288745b67d0a5f8976322907591b75d3f43b21", "committedDate": "2020-02-19T20:24:33Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b67e16e3e1c1db3f5c997c42f20f294c2982c9f7", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/b67e16e3e1c1db3f5c997c42f20f294c2982c9f7", "committedDate": "2020-02-19T20:29:47Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15288745b67d0a5f8976322907591b75d3f43b21", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/15288745b67d0a5f8976322907591b75d3f43b21", "committedDate": "2020-02-19T20:24:33Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}, "afterCommit": {"oid": "b67e16e3e1c1db3f5c997c42f20f294c2982c9f7", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/b67e16e3e1c1db3f5c997c42f20f294c2982c9f7", "committedDate": "2020-02-19T20:29:47Z", "message": "SAK-42959 Default lang-datepicker to user's local timestamp\n\nhttps://jira.sakaiproject.org/browse/SAK-42959"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2353, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}