{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NTEyNjAz", "number": 8637, "title": "SAK-44379 Move file conversion service to session factory", "bodyText": "https://jira.sakaiproject.org/browse/SAK-44379", "createdAt": "2020-09-30T13:32:05Z", "url": "https://github.com/sakaiproject/sakai/pull/8637", "merged": true, "mergeCommit": {"oid": "092ebe56ef75c4cb13b67311c5874956b3b310de"}, "closed": true, "closedAt": "2020-12-16T13:45:52Z", "author": {"login": "adrianfish"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN-gIwABqjM4MjUxMjc2ODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk700aAFqTU0OTY4OTc0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eba8a432729f73d60abbc0e4e8f5ec7e80c743fe", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/eba8a432729f73d60abbc0e4e8f5ec7e80c743fe", "committedDate": "2020-09-30T12:58:13Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}, "afterCommit": {"oid": "a04079bbb8b9845572461b9c570d003fc0e399ee", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/a04079bbb8b9845572461b9c570d003fc0e399ee", "committedDate": "2020-09-30T15:27:08Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzIyNTQ0", "url": "https://github.com/sakaiproject/sakai/pull/8637#pullrequestreview-500722544", "createdAt": "2020-10-01T21:13:17Z", "commit": {"oid": "a04079bbb8b9845572461b9c570d003fc0e399ee"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToxMzoxN1rOHbbA8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToxMzoxN1rOHbbA8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxNjIwOQ==", "bodyText": "You can do straight up sql using hibernate no need to bring in sqlservice", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r498516209", "createdAt": "2020-10-01T21:13:17Z", "author": {"login": "ern"}, "path": "kernel/kernel-impl/src/main/java/org/sakaiproject/content/impl/FileConversionServiceImpl.java", "diffHunk": "@@ -28,39 +28,47 @@\n import java.util.concurrent.ScheduledExecutorService;\n import java.util.concurrent.TimeUnit;\n \n+import org.hibernate.Session;\n+import org.hibernate.SessionFactory;\n+import org.hibernate.criterion.Restrictions;\n+\n import org.sakaiproject.authz.api.SecurityAdvisor;\n import org.sakaiproject.authz.api.SecurityService;\n import org.sakaiproject.component.api.ServerConfigurationService;\n import org.sakaiproject.content.api.ContentHostingService;\n import org.sakaiproject.content.api.ContentResource;\n import org.sakaiproject.content.api.FileConversionService;\n-import org.sakaiproject.content.api.repository.FileConversionQueueItemRepository;\n import org.sakaiproject.content.hbm.FileConversionQueueItem;\n import org.sakaiproject.content.impl.converters.LoolFileConverter;\n+import org.sakaiproject.db.api.SqlService;\n import org.sakaiproject.entity.api.ResourceProperties;\n import org.sakaiproject.entity.api.ResourcePropertiesEdit;\n import org.sakaiproject.exception.IdUnusedException;\n import org.sakaiproject.exception.PermissionException;\n-import org.springframework.transaction.TransactionStatus;\n-import org.springframework.transaction.annotation.Transactional;\n-import org.springframework.transaction.support.TransactionCallbackWithoutResult;\n-import org.springframework.transaction.support.TransactionTemplate;\n \n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.transaction.support.TransactionTemplate;\n \n import lombok.Setter;\n import lombok.extern.slf4j.Slf4j;\n \n+import javax.annotation.Resource;\n+\n @Slf4j\n @Setter\n public class FileConversionServiceImpl implements FileConversionService {\n \n     @Autowired private ContentHostingService contentHostingService;\n-    @Autowired private FileConversionQueueItemRepository repository;\n     @Autowired private SecurityService securityService;\n     @Autowired private ServerConfigurationService serverConfigurationService;\n+    @Autowired private SqlService sqlService;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a04079bbb8b9845572461b9c570d003fc0e399ee"}, "originalPosition": 44}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a04079bbb8b9845572461b9c570d003fc0e399ee", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/a04079bbb8b9845572461b9c570d003fc0e399ee", "committedDate": "2020-09-30T15:27:08Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}, "afterCommit": {"oid": "ba2cd4d98511c8a5fea9dc68be445345a91ad5f4", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/ba2cd4d98511c8a5fea9dc68be445345a91ad5f4", "committedDate": "2020-10-23T13:37:57Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba2cd4d98511c8a5fea9dc68be445345a91ad5f4", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/ba2cd4d98511c8a5fea9dc68be445345a91ad5f4", "committedDate": "2020-10-23T13:37:57Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}, "afterCommit": {"oid": "ebca36e2474c409c8bc754fed7e8673d1c9df58d", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/ebca36e2474c409c8bc754fed7e8673d1c9df58d", "committedDate": "2020-10-23T14:35:22Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ebca36e2474c409c8bc754fed7e8673d1c9df58d", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/ebca36e2474c409c8bc754fed7e8673d1c9df58d", "committedDate": "2020-10-23T14:35:22Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}, "afterCommit": {"oid": "c03ef437699220be39865ff74167243c50eb362a", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/c03ef437699220be39865ff74167243c50eb362a", "committedDate": "2020-12-02T16:50:43Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MTgyMjA1", "url": "https://github.com/sakaiproject/sakai/pull/8637#pullrequestreview-544182205", "createdAt": "2020-12-03T17:03:57Z", "commit": {"oid": "c03ef437699220be39865ff74167243c50eb362a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNzowMzo1N1rOH-nTMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNzowNjozNlrOH-ndzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQxNzY0OQ==", "bodyText": "You don't need to manage the session as that is performed by Spring TX Manager", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r535417649", "createdAt": "2020-12-03T17:03:57Z", "author": {"login": "ern"}, "path": "kernel/kernel-impl/src/main/java/org/sakaiproject/content/impl/persistence/FileConversionServiceRepositoryImpl.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package org.sakaiproject.content.impl.persistence;\n+\n+import org.hibernate.Session;\n+import org.hibernate.SessionFactory;\n+import org.hibernate.TransientObjectException;\n+import org.hibernate.criterion.Restrictions;\n+\n+import java.util.List;\n+import javax.annotation.Resource;\n+\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import org.sakaiproject.content.api.persistence.FileConversionQueueItem;\n+import org.sakaiproject.content.api.persistence.FileConversionServiceRepository;\n+\n+import lombok.Setter;\n+\n+public class FileConversionServiceRepositoryImpl implements FileConversionServiceRepository {\n+\n+    @Resource(name = \"org.sakaiproject.springframework.orm.hibernate.GlobalSessionFactory\")\n+    @Setter\n+    private SessionFactory sessionFactory;\n+\n+    @Transactional\n+    public List<FileConversionQueueItem> findByStatus(FileConversionQueueItem.Status status) {\n+\n+        Session session = sessionFactory.getCurrentSession();\n+        List<FileConversionQueueItem> items\n+            = session.createCriteria(FileConversionQueueItem.class)\n+                .add(Restrictions.eq(\"status\", status)).list();\n+        session.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c03ef437699220be39865ff74167243c50eb362a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQxODE5OQ==", "bodyText": "same here no need to manage the session", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r535418199", "createdAt": "2020-12-03T17:04:29Z", "author": {"login": "ern"}, "path": "kernel/kernel-impl/src/main/java/org/sakaiproject/content/impl/persistence/FileConversionServiceRepositoryImpl.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package org.sakaiproject.content.impl.persistence;\n+\n+import org.hibernate.Session;\n+import org.hibernate.SessionFactory;\n+import org.hibernate.TransientObjectException;\n+import org.hibernate.criterion.Restrictions;\n+\n+import java.util.List;\n+import javax.annotation.Resource;\n+\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import org.sakaiproject.content.api.persistence.FileConversionQueueItem;\n+import org.sakaiproject.content.api.persistence.FileConversionServiceRepository;\n+\n+import lombok.Setter;\n+\n+public class FileConversionServiceRepositoryImpl implements FileConversionServiceRepository {\n+\n+    @Resource(name = \"org.sakaiproject.springframework.orm.hibernate.GlobalSessionFactory\")\n+    @Setter\n+    private SessionFactory sessionFactory;\n+\n+    @Transactional\n+    public List<FileConversionQueueItem> findByStatus(FileConversionQueueItem.Status status) {\n+\n+        Session session = sessionFactory.getCurrentSession();\n+        List<FileConversionQueueItem> items\n+            = session.createCriteria(FileConversionQueueItem.class)\n+                .add(Restrictions.eq(\"status\", status)).list();\n+        session.close();\n+        return items;\n+    }\n+\n+    @Transactional\n+    public FileConversionQueueItem save(FileConversionQueueItem item) {\n+\n+        Session session = sessionFactory.getCurrentSession();\n+        FileConversionQueueItem mergedItem = null;\n+        try {\n+            mergedItem = (FileConversionQueueItem) session.merge(item);\n+        } catch (TransientObjectException toe) {\n+            session.persist(item);\n+            mergedItem = item;\n+        }\n+        session.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c03ef437699220be39865ff74167243c50eb362a"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQyMDM2Nw==", "bodyText": "I think this should be repository it's how it's done in other places", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r535420367", "createdAt": "2020-12-03T17:06:36Z", "author": {"login": "ern"}, "path": "kernel/kernel-impl/src/main/java/org/sakaiproject/content/impl/FileConversionServiceImpl.java", "diffHunk": "@@ -34,32 +34,30 @@\n import org.sakaiproject.content.api.ContentHostingService;\n import org.sakaiproject.content.api.ContentResource;\n import org.sakaiproject.content.api.FileConversionService;\n-import org.sakaiproject.content.api.repository.FileConversionQueueItemRepository;\n-import org.sakaiproject.content.hbm.FileConversionQueueItem;\n+import org.sakaiproject.content.api.persistence.FileConversionQueueItem;\n+import org.sakaiproject.content.api.persistence.FileConversionServiceRepository;\n import org.sakaiproject.content.impl.converters.LoolFileConverter;\n import org.sakaiproject.entity.api.ResourceProperties;\n import org.sakaiproject.entity.api.ResourcePropertiesEdit;\n import org.sakaiproject.exception.IdUnusedException;\n import org.sakaiproject.exception.PermissionException;\n-import org.springframework.transaction.TransactionStatus;\n-import org.springframework.transaction.annotation.Transactional;\n-import org.springframework.transaction.support.TransactionCallbackWithoutResult;\n-import org.springframework.transaction.support.TransactionTemplate;\n \n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.transaction.annotation.Transactional;\n \n import lombok.Setter;\n import lombok.extern.slf4j.Slf4j;\n \n+import javax.annotation.Resource;\n+\n @Slf4j\n @Setter\n public class FileConversionServiceImpl implements FileConversionService {\n \n     @Autowired private ContentHostingService contentHostingService;\n-    @Autowired private FileConversionQueueItemRepository repository;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c03ef437699220be39865ff74167243c50eb362a"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c03ef437699220be39865ff74167243c50eb362a", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/c03ef437699220be39865ff74167243c50eb362a", "committedDate": "2020-12-02T16:50:43Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}, "afterCommit": {"oid": "2258379fa7babade7298df72c12a97054b0e2096", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/2258379fa7babade7298df72c12a97054b0e2096", "committedDate": "2020-12-04T16:26:50Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fca054ad3d12ef6c63effc43a9bc030f162360de", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/fca054ad3d12ef6c63effc43a9bc030f162360de", "committedDate": "2020-12-04T17:16:15Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2258379fa7babade7298df72c12a97054b0e2096", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/2258379fa7babade7298df72c12a97054b0e2096", "committedDate": "2020-12-04T16:26:50Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}, "afterCommit": {"oid": "fca054ad3d12ef6c63effc43a9bc030f162360de", "author": {"user": {"login": "adrianfish", "name": "Adrian Fish"}}, "url": "https://github.com/sakaiproject/sakai/commit/fca054ad3d12ef6c63effc43a9bc030f162360de", "committedDate": "2020-12-04T17:16:15Z", "message": "SAK-44379 Move file conversion service to session factory\n\nhttps://jira.sakaiproject.org/browse/SAK-44379"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Njg3ODY1", "url": "https://github.com/sakaiproject/sakai/pull/8637#pullrequestreview-549687865", "createdAt": "2020-12-10T23:16:22Z", "commit": {"oid": "fca054ad3d12ef6c63effc43a9bc030f162360de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzoxNjoyM1rOIDh2Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzoxNjoyM1rOIDh2Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3MTIyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    session.close();", "url": "https://github.com/sakaiproject/sakai/pull/8637#discussion_r540571227", "createdAt": "2020-12-10T23:16:23Z", "author": {"login": "ern"}, "path": "kernel/kernel-impl/src/main/java/org/sakaiproject/content/impl/persistence/FileConversionServiceRepositoryImpl.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.sakaiproject.content.impl.persistence;\n+\n+import org.hibernate.Session;\n+import org.hibernate.criterion.Restrictions;\n+\n+import java.util.List;\n+\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import org.sakaiproject.content.api.persistence.FileConversionQueueItem;\n+import org.sakaiproject.content.api.persistence.FileConversionServiceRepository;\n+import org.sakaiproject.springframework.data.SpringCrudRepositoryImpl;\n+\n+public class FileConversionServiceRepositoryImpl extends SpringCrudRepositoryImpl<FileConversionQueueItem, Long>  implements FileConversionServiceRepository {\n+\n+    @Transactional\n+    public List<FileConversionQueueItem> findByStatus(FileConversionQueueItem.Status status) {\n+\n+        Session session = sessionFactory.getCurrentSession();\n+        List<FileConversionQueueItem> items\n+            = session.createCriteria(FileConversionQueueItem.class)\n+                .add(Restrictions.eq(\"status\", status)).list();\n+        session.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fca054ad3d12ef6c63effc43a9bc030f162360de"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fb3d42a6c3c1f34df0ab6d4ac1056533978d6df", "author": {"user": {"login": "ern", "name": "Earle Nietzel"}}, "url": "https://github.com/sakaiproject/sakai/commit/4fb3d42a6c3c1f34df0ab6d4ac1056533978d6df", "committedDate": "2020-12-10T23:16:41Z", "message": "remove session.close()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Njg5NzQ3", "url": "https://github.com/sakaiproject/sakai/pull/8637#pullrequestreview-549689747", "createdAt": "2020-12-10T23:20:36Z", "commit": {"oid": "4fb3d42a6c3c1f34df0ab6d4ac1056533978d6df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2715, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}