{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODIwNjIy", "number": 8218, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMDo0Njo1NVrOD8bJ4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMDo0Njo1NVrOD8bJ4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0Njg2MDQ4OnYy", "diffSide": "RIGHT", "path": "calendar/calendar-tool/tool/src/java/org/sakaiproject/calendar/tool/CalendarAction.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMDo0Njo1NVrOGVWphw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMjo1NjoxN1rOGVa4mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA0NDM1OQ==", "bodyText": "I feel I'm missing something. Where is the velocity template, with the new tag in it? Did you add it?", "url": "https://github.com/sakaiproject/sakai/pull/8218#discussion_r425044359", "createdAt": "2020-05-14T10:46:55Z", "author": {"login": "adrianfish"}, "path": "calendar/calendar-tool/tool/src/java/org/sakaiproject/calendar/tool/CalendarAction.java", "diffHunk": "@@ -7701,41 +7705,14 @@ public void doDefaultview( RunData rundata, Context context )\n \t */\n \tpublic void doPermissions(RunData data, Context context)\n \t{\n-\t\t// get into helper mode with this helper tool\n-\t\tstartHelper(data.getRequest(), \"sakai.permissions.helper\");\n-\n \t\t// setup the parameters for the helper\n \t\tSessionState state = ((JetspeedRunData) data).getPortletSessionState(((JetspeedRunData) data).getJs_peid());\n \t\tCalendarActionState cstate = (CalendarActionState) getState(context, data, CalendarActionState.class);\n \n-\t\tString calendarRefStr = cstate.getPrimaryCalendarReference();\n-\t\tReference calendarRef = EntityManager.newReference(calendarRefStr);\n-\t\tString siteRef = SiteService.siteReference(calendarRef.getContext());\n-\n-\t\t// setup for editing the permissions of the site for this tool, using the roles of this site, too\n-\t\tstate.setAttribute(PermissionsHelper.TARGET_REF, siteRef);\n+\t\tcstate.setPrevState(cstate.getState());\n+\t\tcstate.setState(MODE_PERMISSIONS);\n \n-\t\t// ... with this description\n-\t\tstate.setAttribute(PermissionsHelper.DESCRIPTION, rb.getString(\"java.set\")\n-\t\t\t\t+ SiteService.getSiteDisplay(calendarRef.getContext()));\n-\n-\t\t// ... showing only locks that are prpefixed with this\n-\t\tstate.setAttribute(PermissionsHelper.PREFIX, \"calendar.\");\n-\t\t// ... pass the resource loader object\n-\t\tResourceLoader pRb = new ResourceLoader(\"permissions\");\n-\t\tHashMap<String, String> pRbValues = new HashMap<String, String>();\n-\t\tfor (Iterator<Entry<String, String>> iKeys = pRb.entrySet().iterator();iKeys.hasNext();)\n-\t\t{\n-\t\t\tEntry entry = iKeys.next();\n-\t\t\tString key = (String)entry.getKey();\n-\t\t\tpRbValues.put(key, (String)entry.getValue());\n-\n-\t\t}\n-\t\tstate.setAttribute(\"permissionDescriptions\",  pRbValues);\n-\t\t\n-\t\tString groupAware = ToolManager.getCurrentTool().getRegisteredConfig().getProperty(\"groupAware\");\n-\t\tstate.setAttribute(\"groupAware\", groupAware != null?Boolean.valueOf(groupAware):Boolean.FALSE);\n-\t\tstate.removeAttribute(\"menu\"); //Menu not required in the permission view\n+\t\tstate.setAttribute(STATE_TOOL_KEY, \"calendar\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "936ea9d2e8c0211026c9430da7aa610466e33834"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA1MzMyMg==", "bodyText": "It's included in the velocity folder as global (velocity/tool/src/templates/permissions.vm).  Added by @bgarciaentornos : d5e3e83\nAnd modified by me: #8217\nBut in this case, we don't need the last update, because the tool_id and bundle-key are equal.", "url": "https://github.com/sakaiproject/sakai/pull/8218#discussion_r425053322", "createdAt": "2020-05-14T11:04:22Z", "author": {"login": "frasese"}, "path": "calendar/calendar-tool/tool/src/java/org/sakaiproject/calendar/tool/CalendarAction.java", "diffHunk": "@@ -7701,41 +7705,14 @@ public void doDefaultview( RunData rundata, Context context )\n \t */\n \tpublic void doPermissions(RunData data, Context context)\n \t{\n-\t\t// get into helper mode with this helper tool\n-\t\tstartHelper(data.getRequest(), \"sakai.permissions.helper\");\n-\n \t\t// setup the parameters for the helper\n \t\tSessionState state = ((JetspeedRunData) data).getPortletSessionState(((JetspeedRunData) data).getJs_peid());\n \t\tCalendarActionState cstate = (CalendarActionState) getState(context, data, CalendarActionState.class);\n \n-\t\tString calendarRefStr = cstate.getPrimaryCalendarReference();\n-\t\tReference calendarRef = EntityManager.newReference(calendarRefStr);\n-\t\tString siteRef = SiteService.siteReference(calendarRef.getContext());\n-\n-\t\t// setup for editing the permissions of the site for this tool, using the roles of this site, too\n-\t\tstate.setAttribute(PermissionsHelper.TARGET_REF, siteRef);\n+\t\tcstate.setPrevState(cstate.getState());\n+\t\tcstate.setState(MODE_PERMISSIONS);\n \n-\t\t// ... with this description\n-\t\tstate.setAttribute(PermissionsHelper.DESCRIPTION, rb.getString(\"java.set\")\n-\t\t\t\t+ SiteService.getSiteDisplay(calendarRef.getContext()));\n-\n-\t\t// ... showing only locks that are prpefixed with this\n-\t\tstate.setAttribute(PermissionsHelper.PREFIX, \"calendar.\");\n-\t\t// ... pass the resource loader object\n-\t\tResourceLoader pRb = new ResourceLoader(\"permissions\");\n-\t\tHashMap<String, String> pRbValues = new HashMap<String, String>();\n-\t\tfor (Iterator<Entry<String, String>> iKeys = pRb.entrySet().iterator();iKeys.hasNext();)\n-\t\t{\n-\t\t\tEntry entry = iKeys.next();\n-\t\t\tString key = (String)entry.getKey();\n-\t\t\tpRbValues.put(key, (String)entry.getValue());\n-\n-\t\t}\n-\t\tstate.setAttribute(\"permissionDescriptions\",  pRbValues);\n-\t\t\n-\t\tString groupAware = ToolManager.getCurrentTool().getRegisteredConfig().getProperty(\"groupAware\");\n-\t\tstate.setAttribute(\"groupAware\", groupAware != null?Boolean.valueOf(groupAware):Boolean.FALSE);\n-\t\tstate.removeAttribute(\"menu\"); //Menu not required in the permission view\n+\t\tstate.setAttribute(STATE_TOOL_KEY, \"calendar\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA0NDM1OQ=="}, "originalCommit": {"oid": "936ea9d2e8c0211026c9430da7aa610466e33834"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTExMzc1Mg==", "bodyText": "Thanks - I forgot about that shared template.", "url": "https://github.com/sakaiproject/sakai/pull/8218#discussion_r425113752", "createdAt": "2020-05-14T12:56:17Z", "author": {"login": "adrianfish"}, "path": "calendar/calendar-tool/tool/src/java/org/sakaiproject/calendar/tool/CalendarAction.java", "diffHunk": "@@ -7701,41 +7705,14 @@ public void doDefaultview( RunData rundata, Context context )\n \t */\n \tpublic void doPermissions(RunData data, Context context)\n \t{\n-\t\t// get into helper mode with this helper tool\n-\t\tstartHelper(data.getRequest(), \"sakai.permissions.helper\");\n-\n \t\t// setup the parameters for the helper\n \t\tSessionState state = ((JetspeedRunData) data).getPortletSessionState(((JetspeedRunData) data).getJs_peid());\n \t\tCalendarActionState cstate = (CalendarActionState) getState(context, data, CalendarActionState.class);\n \n-\t\tString calendarRefStr = cstate.getPrimaryCalendarReference();\n-\t\tReference calendarRef = EntityManager.newReference(calendarRefStr);\n-\t\tString siteRef = SiteService.siteReference(calendarRef.getContext());\n-\n-\t\t// setup for editing the permissions of the site for this tool, using the roles of this site, too\n-\t\tstate.setAttribute(PermissionsHelper.TARGET_REF, siteRef);\n+\t\tcstate.setPrevState(cstate.getState());\n+\t\tcstate.setState(MODE_PERMISSIONS);\n \n-\t\t// ... with this description\n-\t\tstate.setAttribute(PermissionsHelper.DESCRIPTION, rb.getString(\"java.set\")\n-\t\t\t\t+ SiteService.getSiteDisplay(calendarRef.getContext()));\n-\n-\t\t// ... showing only locks that are prpefixed with this\n-\t\tstate.setAttribute(PermissionsHelper.PREFIX, \"calendar.\");\n-\t\t// ... pass the resource loader object\n-\t\tResourceLoader pRb = new ResourceLoader(\"permissions\");\n-\t\tHashMap<String, String> pRbValues = new HashMap<String, String>();\n-\t\tfor (Iterator<Entry<String, String>> iKeys = pRb.entrySet().iterator();iKeys.hasNext();)\n-\t\t{\n-\t\t\tEntry entry = iKeys.next();\n-\t\t\tString key = (String)entry.getKey();\n-\t\t\tpRbValues.put(key, (String)entry.getValue());\n-\n-\t\t}\n-\t\tstate.setAttribute(\"permissionDescriptions\",  pRbValues);\n-\t\t\n-\t\tString groupAware = ToolManager.getCurrentTool().getRegisteredConfig().getProperty(\"groupAware\");\n-\t\tstate.setAttribute(\"groupAware\", groupAware != null?Boolean.valueOf(groupAware):Boolean.FALSE);\n-\t\tstate.removeAttribute(\"menu\"); //Menu not required in the permission view\n+\t\tstate.setAttribute(STATE_TOOL_KEY, \"calendar\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA0NDM1OQ=="}, "originalCommit": {"oid": "936ea9d2e8c0211026c9430da7aa610466e33834"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2181, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}