{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MDMwMjg2", "number": 8438, "title": "SAK-44071: Update Presence correctly by clearing timer and update active tabs", "bodyText": "The setTimeout handle is not cleared properly and might cause a cascade effect if multiple updatePresence function calls are made.\n\n\nPresence sends out a lot of HTTP requests for each tab open in a browser - this creates unnecessary load on the server.\n\n\nA more accurate portrayal of activity is when a user is active on the tab that is open in the browser - this reduces the number of presence requests that are sent to the server.", "createdAt": "2020-08-06T13:32:43Z", "url": "https://github.com/sakaiproject/sakai/pull/8438", "merged": true, "mergeCommit": {"oid": "47815b9422255f1bc2dc48e1118f6fba34d9c167"}, "closed": true, "closedAt": "2020-08-18T14:42:46Z", "author": {"login": "TurRil"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9y1HeAFqTQ2NDg1NzIwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAIB0qAFqTQ2OTUyMjAwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0ODU3MjAw", "url": "https://github.com/sakaiproject/sakai/pull/8438#pullrequestreview-464857200", "createdAt": "2020-08-11T08:31:41Z", "commit": {"oid": "2fe378b2af7364f126e8f80bb07872eece04c81e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwODozMTo0MVrOG-tycw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwODo0ODoyMFrOG-uY2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQxNTA5MQ==", "bodyText": "I'd just make hidden a boolean. You don't use that string in any console output, so there's no point overcomplicating it. Actually, forget that. I'd just use document.hidden. It's supported in all the browsers we're interested in. Sakai won't work in IE < 10, anyway. I'd just remove your hidden var and use document.hidden.", "url": "https://github.com/sakaiproject/sakai/pull/8438#discussion_r468415091", "createdAt": "2020-08-11T08:31:41Z", "author": {"login": "adrianfish"}, "path": "library/src/morpheus-master/js/src/sakai.morpheus.update.presence.js", "diffHunk": "@@ -1,4 +1,49 @@\n-function updatePresence(){\n+var active_tab_listener_attached = false; // initial load\n+\n+// Set the name of the hidden property and the change event for visibility\n+var hidden, visibilityChange;\n+if (typeof document.hidden !== \"undefined\") { // Opera 12.10 and Firefox 18 and later support \n+    hidden = \"hidden\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fe378b2af7364f126e8f80bb07872eece04c81e"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQyNDkyMQ==", "bodyText": "I think you should be using your variable  \"visibilityChange\" from earlier. Although perhaps \"visibiitychange\" just works on all the modern browsers now. Anyway, you should use that variable you created.", "url": "https://github.com/sakaiproject/sakai/pull/8438#discussion_r468424921", "createdAt": "2020-08-11T08:48:20Z", "author": {"login": "adrianfish"}, "path": "library/src/morpheus-master/js/src/sakai.morpheus.update.presence.js", "diffHunk": "@@ -1,4 +1,49 @@\n-function updatePresence(){\n+var active_tab_listener_attached = false; // initial load\n+\n+// Set the name of the hidden property and the change event for visibility\n+var hidden, visibilityChange;\n+if (typeof document.hidden !== \"undefined\") { // Opera 12.10 and Firefox 18 and later support \n+    hidden = \"hidden\";\n+    visibilityChange = \"visibilitychange\";\n+} else if (typeof document.msHidden !== \"undefined\") {\n+    hidden = \"msHidden\";\n+    visibilityChange = \"msvisibilitychange\";\n+} else if (typeof document.webkitHidden !== \"undefined\") {\n+    hidden = \"webkitHidden\";\n+    visibilityChange = \"webkitvisibilitychange\";\n+}\n+\n+function updatePresenceTimeout(_ms, _go) {\n+    if (window.sakaiLastPresenceTimeOut != null) {\n+        clearTimeout(window.sakaiLastPresenceTimeOut);\n+        window.sakaiLastPresenceTimeOut = null;\n+    }\n+    if (_go) {\n+        window.sakaiLastPresenceTimeOut = setTimeout('updatePresence()', _ms);\n+    }\n+}\n+\n+// Triggers when visibility changes\n+function handleVisibilityChange() {\n+    if (document.hidden) {\n+        console.log(\"hidden\");\n+        updatePresenceTimeout(window.sakaiPresenceTimeDelay, false); //stop\n+    } else  {\n+        console.log(\"visible\");\n+        updatePresenceTimeout(window.sakaiPresenceTimeDelay, false); \n+        updatePresence(); //start immediately\n+    }\n+}\n+\n+function updatePresence() {\n+  if (!active_tab_listener_attached) {\n+    document.addEventListener(\"visibilitychange\", handleVisibilityChange, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fe378b2af7364f126e8f80bb07872eece04c81e"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bd6156973117d530711f0e2e6e70933dae9e310", "author": {"user": {"login": "TurRil", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/2bd6156973117d530711f0e2e6e70933dae9e310", "committedDate": "2020-08-12T07:40:55Z", "message": "SAK-44071: Update Presence correctly by clearing timer and update when browser tab is active."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4e438ed4a460c16192668972b7e17e98eccdca0", "author": {"user": {"login": "TurRil", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/c4e438ed4a460c16192668972b7e17e98eccdca0", "committedDate": "2020-08-12T07:40:56Z", "message": "SAK-44071: Updates to improve JS according to Codacy/PR Quality Review."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdf8593880138274af342012a75cd4d634203ea8", "author": {"user": {"login": "TurRil", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/fdf8593880138274af342012a75cd4d634203ea8", "committedDate": "2020-08-12T07:40:57Z", "message": "SAK-44071: define document.addEventListener early as empty function and redefine after all functions are declared."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b91333e629f223b7afbe9f8cbf1951c2f087acb8", "author": {"user": {"login": "TurRil", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/b91333e629f223b7afbe9f8cbf1951c2f087acb8", "committedDate": "2020-08-07T08:44:42Z", "message": "SAK-44071: define document.addEventListener early as empty function and redefine after all functions are declared."}, "afterCommit": {"oid": "fdf8593880138274af342012a75cd4d634203ea8", "author": {"user": {"login": "TurRil", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/fdf8593880138274af342012a75cd4d634203ea8", "committedDate": "2020-08-12T07:40:57Z", "message": "SAK-44071: define document.addEventListener early as empty function and redefine after all functions are declared."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787f86e84f24cc008f3084ccac6551697812cde9", "author": {"user": {"login": "TurRil", "name": null}}, "url": "https://github.com/sakaiproject/sakai/commit/787f86e84f24cc008f3084ccac6551697812cde9", "committedDate": "2020-08-12T13:07:55Z", "message": "SAK-44071: Updated code after review - removed variable declarations that where not used."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODk3NjA5", "url": "https://github.com/sakaiproject/sakai/pull/8438#pullrequestreview-465897609", "createdAt": "2020-08-12T13:07:57Z", "commit": {"oid": "fdf8593880138274af342012a75cd4d634203ea8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTIyMDAw", "url": "https://github.com/sakaiproject/sakai/pull/8438#pullrequestreview-469522000", "createdAt": "2020-08-18T14:38:28Z", "commit": {"oid": "787f86e84f24cc008f3084ccac6551697812cde9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2903, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}