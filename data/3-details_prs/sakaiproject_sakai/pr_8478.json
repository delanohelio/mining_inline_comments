{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0MTQ5MTA2", "number": 8478, "title": "SAK-44153 Improvements to Group and Date Released Subpages in Lessons", "bodyText": "Updated lesson page so hidden subpages would show \"released on\" instead of \"Not released until\" even\nafter the release date.\nChanged released color to be green. The color of the text will toggle depending on the state of whether\nor not the page is visible.\nLinks are visible but disabled in the tool menu if they are not released\nMake lessons subpage navigation group aware in the tool menu\nAdd option for visible but inactive subpages\nAdded release string to date released subpages for student view\nAdded checkbox to hide subpage on the main subpage edit screen rather than in gear icon\nAdd release date and Hidden properties to those copied in duplication", "createdAt": "2020-08-26T20:57:41Z", "url": "https://github.com/sakaiproject/sakai/pull/8478", "merged": true, "mergeCommit": {"oid": "24e0ae414a69008804746309d8e8efc4a008b39b"}, "closed": true, "closedAt": "2020-08-31T15:15:00Z", "author": {"login": "davidpbauer"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCvgMPgH2gAyNDc0MTQ5MTA2OjE1Y2MyMWMwOTViY2I5ZmNiZmJlYjEzMDJkZmJjY2FhNTI5NjY4ZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEUV2bAFqTQ3ODcwNDQ5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa", "author": {"user": {"login": "davidpbauer", "name": "David P. Bauer"}}, "url": "https://github.com/sakaiproject/sakai/commit/15cc21c095bcb9fcbfbeb1302dfbccaa529668fa", "committedDate": "2020-08-26T17:45:47Z", "message": "SAK-44153 Improvements to Group and Date Released Subpages in Lessons\n\n- Updated lesson page so hidden subpages would show \"released on\" instead of \"Not released until\" even\nafter the release date.\n- Changed released color to be green. The color of the text will toggle depending on the state of whether\nor not the page is visible.\n- Links are visible but disabled in the tool menu if they are not released\n- Make lessons subpage navigation group aware in the tool menu\n- Add option for visible but inactive subpages\n- Added release string to date released subpages for student view\n- Added checkbox to hide subpage on the main subpage edit screen rather than in gear icon\n- Add release date and Hidden properties to those copied in duplication"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NzEwNDg1", "url": "https://github.com/sakaiproject/sakai/pull/8478#pullrequestreview-476710485", "createdAt": "2020-08-27T13:18:03Z", "commit": {"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa"}, "state": "APPROVED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMzoxODowM1rOHIP71Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMzo0NTowOFrOHIRE1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQxMTczMw==", "bodyText": "Why not type this?\nList groups = new ArrayList<>();\nActually:\nfinal List groupIds = siteService.getSite(siteId).getGroupsWithMember(userId).stream().map(Group::getId).collect(Collectors.toList());", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478411733", "createdAt": "2020-08-27T13:18:03Z", "author": {"login": "adrianfish"}, "path": "lessonbuilder/components/src/java/org/sakaiproject/lessonbuildertool/model/SimplePageToolDaoImpl.java", "diffHunk": "@@ -1893,7 +1896,18 @@ public String getLessonSubPageJSON(final String userId, final boolean isInstruct\n \t\t\tfields[i+1] = pageIds.get(i);\n \t\t}\n \n-\t\tfinal LessonsSubNavBuilder lessonsSubNavBuilder = new LessonsSubNavBuilder(siteId, canSeeAll);\n+\t\tArrayList groups = new ArrayList();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyNjIxMg==", "bodyText": "Indentation", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478426212", "createdAt": "2020-08-27T13:39:16Z", "author": {"login": "adrianfish"}, "path": "lessonbuilder/tool/src/java/org/sakaiproject/lessonbuildertool/service/LessonBuilderEntityProducer.java", "diffHunk": "@@ -1120,6 +1122,18 @@ public String merge(String siteId, Element root, String archivePath, String from\n \t\t     String folder = pageElement.getAttribute(\"folder\");\n \t\t     if (StringUtils.isNotEmpty(folder))\n \t\t\t page.setFolder(folder);\n+\t\t     //get new page's Date Release property", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyNjc3OQ==", "bodyText": "Indentations gone a bit crazy here :)", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478426779", "createdAt": "2020-08-27T13:40:07Z", "author": {"login": "adrianfish"}, "path": "lessonbuilder/tool/src/java/org/sakaiproject/lessonbuildertool/tool/beans/SimplePageBean.java", "diffHunk": "@@ -3555,19 +3555,19 @@ public String getReleaseString(SimplePageItem i, Locale locale) {\n \t\t if (page.isHidden())\n \t\t     return messageLocator.getMessage(\"simplepage.hiddenpage\");\n \t\t // for index of pages we need to show even out of date release dates\n-\t\t if (page.getReleaseDate() != null) { // && page.getReleaseDate().after(new Date())) {\n-\t\t     Date releaseDate = page.getReleaseDate();\n-\t\t     Date date = new Date();\n-\t\t     if (date.before(releaseDate)) {\n-\t\t        DateFormat df = DateFormat.getDateTimeInstance(DateFormat.MEDIUM, DateFormat.SHORT, locale);\n-\t\t        TimeZone tz = userTimeService.getLocalTimeZone();\n-\t\t        String releaseDateStr = df.format(page.getReleaseDate());\n-\t\t        df.setTimeZone(tz);\n-\t\t        return messageLocator.getMessage(\"simplepage.pagenotreleased\").replace(\"{}\", releaseDateStr);\n-\t\t     }\n-\t\t     return null;\n+\t\t if (page.getReleaseDate() != null ) {\n+\t\t     DateFormat df = DateFormat.getDateTimeInstance(DateFormat.SHORT, DateFormat.SHORT, locale);\n+\t\t     TimeZone tz = userTimeService.getLocalTimeZone();\n+\t\t     df.setTimeZone(tz);\n+\t\t\t String releaseDate = df.format(page.getReleaseDate());\n+\t\t     if(Instant.now().isBefore(page.getReleaseDate().toInstant())){\n+\t\t\t\t return messageLocator.getMessage(\"simplepage.pagenotreleased\").replace(\"{}\", releaseDate);\n+\t\t\t } else{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyODAyMA==", "bodyText": "Need a opening brace after the if statement, close after. I know lessons does this all over the place, Python style, but still ...", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478428020", "createdAt": "2020-08-27T13:41:50Z", "author": {"login": "adrianfish"}, "path": "lessonbuilder/tool/src/java/org/sakaiproject/lessonbuildertool/tool/beans/SimplePageBean.java", "diffHunk": "@@ -5063,13 +5063,11 @@ public boolean isItemVisible(SimplePageItem item, SimplePage page, boolean testp\n \t\tif (item.getType() == SimplePageItem.BREAK)\n \t\t    return true;  // breaks are always visible to all users\n \t\telse if (item.getType() == SimplePageItem.PAGE) {\n-\t\t  if (!item.isRequired()) {\n \t\t    SimplePage itemPage = getPage(Long.valueOf(item.getSakaiId()));\n \t\t    if (itemPage.isHidden())\n \t\t\treturn false;\n \t\t    if (itemPage.getReleaseDate() != null && itemPage.getReleaseDate().after(new Date()))\n-\t\t\treturn false;\n-\t\t  }\n+\t\t\treturn true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyODg5Mg==", "bodyText": "Can you wrap some braces around this?", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478428892", "createdAt": "2020-08-27T13:43:01Z", "author": {"login": "adrianfish"}, "path": "lessonbuilder/tool/src/java/org/sakaiproject/lessonbuildertool/tool/producers/ShowPageProducer.java", "diffHunk": "@@ -1735,6 +1722,23 @@ else if (forum.notPublished())\n \n \t\t\t\t\t} // end of canEditPage\n \n+\t\t\t\t\tif (i.getType() == SimplePageItem.PAGE) {\n+\t\t\t\t\t\tUIOutput.make(tableRow, \"type\", \"page\");\n+\t\t\t\t\t\tUIOutput.make(tableRow, \"page-next\", Boolean.toString(i.getNextPage()));\n+\t\t\t\t\t\tUIOutput.make(tableRow, \"page-button\", Boolean.toString(\"button\".equals(i.getFormat())));\n+\t\t\t\t\t\tSimplePage page = simplePageToolDao.getPage(Long.valueOf(i.getSakaiId()));\n+\t\t\t\t\t\tUIOutput.make(tableRow, \"page-hidden\", Boolean.toString(page.isHidden()));\n+\t\t\t\t\t\titemGroupString = simplePageBean.getItemGroupString(i, null, true);\n+\t\t\t\t\t\tUIOutput.make(tableRow, \"item-groups\", itemGroupString);\n+\t\t\t\t\t\tSimplePage sPage = simplePageBean.getPage(Long.parseLong(i.getSakaiId()));\n+\t\t\t\t\t\tif (sPage != null) {\n+\t\t\t\t\t\t\tDate rDate = sPage.getReleaseDate();\n+\t\t\t\t\t\t\tString rDateString = \"\";\n+\t\t\t\t\t\t\tif (rDate != null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyOTQxNQ==", "bodyText": "Indentation", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478429415", "createdAt": "2020-08-27T13:43:44Z", "author": {"login": "adrianfish"}, "path": "lessonbuilder/tool/src/java/org/sakaiproject/lessonbuildertool/tool/producers/ShowPageProducer.java", "diffHunk": "@@ -3939,8 +3991,27 @@ protected static boolean makeLink(UIContainer container, String ID, SimplePageIt\n \t\t    link.decorate(new UIFreeAttributeDecorator(\"lessonbuilderitem\", itemString));\n \t\t    // fake and available occurs when prerequisites aren't the issue (it's avaiable)\n \t\t    // so the item must be nonexistent or otherwise unavalable.\n-\t\t    if (available)\n-\t\t\tlink.decorate(new UITooltipDecorator(messageLocator.getMessage(\"simplepage.not_usable\")));\n+\t\t    if (available) {\n+\t\t    \tif(i.getType() == SimplePageItem.PAGE){\n+\t\t\t\t\t// set up locale\n+\t\t\t\t\tLocale M_locale = null;\n+\t\t\t\t\tString langLoc[] = localegetter.get().toString().split(\"_\");\n+\t\t\t\t\tif (langLoc.length >= 2) {\n+\t\t\t\t\t\tif (\"en\".equals(langLoc[0]) && \"ZA\".equals(langLoc[1])) {\n+\t\t\t\t\t\t\tM_locale = new Locale(\"en\", \"GB\");\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tM_locale = new Locale(langLoc[0], langLoc[1]);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tM_locale = new Locale(langLoc[0]);\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tString releaseString = simplePageBean.getReleaseString(i, M_locale);\n+\t\t    \t\tlink.decorate(new UITooltipDecorator(releaseString));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa"}, "originalPosition": 157}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQzMDIwMg==", "bodyText": "You can chain these calls.", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478430202", "createdAt": "2020-08-27T13:44:51Z", "author": {"login": "adrianfish"}, "path": "lessonbuilder/tool/src/webapp/js/show-page.js", "diffHunk": "@@ -1709,6 +1709,14 @@ $(document).ready(function() {\n \t\t\t\t$(\"#item-button\").prop(\"checked\", false);\n \t\t\t    }\n \n+\t\t\t    var pagehidden = row.find(\".page-hidden\").text();\n+\t\t\t    if(pagehidden === \"true\") {\n+\t\t\t    \t$(\"#hide2\").prop(\"checked\", true);\n+\t\t\t    \t$(\"#hide2\").attr(\"defaultChecked\", true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQzMDQyMg==", "bodyText": "Indentation", "url": "https://github.com/sakaiproject/sakai/pull/8478#discussion_r478430422", "createdAt": "2020-08-27T13:45:08Z", "author": {"login": "adrianfish"}, "path": "lessonbuilder/tool/src/webapp/js/show-page.js", "diffHunk": "@@ -1709,6 +1709,14 @@ $(document).ready(function() {\n \t\t\t\t$(\"#item-button\").prop(\"checked\", false);\n \t\t\t    }\n \n+\t\t\t    var pagehidden = row.find(\".page-hidden\").text();\n+\t\t\t    if(pagehidden === \"true\") {\n+\t\t\t    \t$(\"#hide2\").prop(\"checked\", true);\n+\t\t\t    \t$(\"#hide2\").attr(\"defaultChecked\", true);\n+\t\t\t\t}else {\n+\t\t\t    \t$(\"#hide2\").prop(\"checked\", false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cc21c095bcb9fcbfbeb1302dfbccaa529668fa"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccc75ef6aa5265ba0aa30136a615bfb4c2e4aeae", "author": {"user": {"login": "davidpbauer", "name": "David P. Bauer"}}, "url": "https://github.com/sakaiproject/sakai/commit/ccc75ef6aa5265ba0aa30136a615bfb4c2e4aeae", "committedDate": "2020-08-28T20:45:27Z", "message": "SAK-44153 Cleanup old Lessons code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NzA0NDkz", "url": "https://github.com/sakaiproject/sakai/pull/8478#pullrequestreview-478704493", "createdAt": "2020-08-31T15:14:54Z", "commit": {"oid": "ccc75ef6aa5265ba0aa30136a615bfb4c2e4aeae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2749, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}