{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5ODY3Njcy", "number": 907, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjoxNzo0NlrODvo1dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzoyNDo1N1rODwvusg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMjc4NzA4OnYy", "diffSide": "LEFT", "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjoxNzo0NlrOGCLeoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjoxNzo0NlrOGCLeoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkzODQwMA==", "bodyText": "If you use\n\ncontext.asyncAssertSuccess(res -> {\ncontext.asyncAssertFailure(ex -> {\ncontext.verify(verify -> {\n\nyou can\n\navoid manual async\navoid async.await\navoid context.assertTrue(res.failed()) and context.assertTrue(res.succeeded())\nand use Assume.assume... inside an asyncAsserSuccess/asyncAssertFailure/verify block to properly skip a test so that JUnit reports it as skipped.", "url": "https://github.com/folio-org/okapi/pull/907#discussion_r404938400", "createdAt": "2020-04-07T16:17:46Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -88,7 +89,6 @@ public void testDockerVersionAtLocal(TestContext context) {\n       \"mod-users-5.0.0-SNAPSHOT\", ports, \"localhost\", 9232, new JsonObject());\n \n     dh.getUrl(\"/version\", res -> {\n-      Assume.assumeTrue(res.succeeded());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "496a5b28d315587372c62fd05dcf3d04fb55e489"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjkwMjI1OnYy", "diffSide": "RIGHT", "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo0NzowMVrOGDs8xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo0NzowMVrOGDs8xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNTM2NA==", "bodyText": "Can you remove this line or tweak it? It failed on one of our ec2 box because \"Platform\" does not exist. The actual result is {\"Version\":\"17.06.2-ce\",\"ApiVersion\":\"1.30\",\"MinAPIVersion\":\"1.12\",\"GitCommit\":\"402dd4a/17.06.2-ce\",\"GoVersion\":\"go1.8.3\",\"Os\":\"linux\",\"Arch\":\"amd64\",\"KernelVersion\":\"4.14.94-89.73.amzn2.x86_64\",\"BuildTime\":\"2017-11-14T22:04:39.163310834+00:00\"}", "url": "https://github.com/folio-org/okapi/pull/907#discussion_r406535364", "createdAt": "2020-04-09T23:47:01Z", "author": {"login": "hjiebsco"}, "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -87,28 +80,27 @@ public void testDockerVersionAtLocal(TestContext context) {\n     DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n       \"mod-users-5.0.0-SNAPSHOT\", ports, \"localhost\", 9232, new JsonObject());\n \n+    JsonObject versionRes = new JsonObject();\n+    Async async = context.async();\n     dh.getUrl(\"/version\", res -> {\n-      Assume.assumeTrue(res.succeeded());\n-      if (res.failed()) {\n-        logger.warn(res.cause().getMessage());\n-        async.complete();\n-        return;\n+      if (res.succeeded()) {\n+        versionRes.put(\"result\", res.result());\n       }\n-      dh.deleteUrl(\"/version\", \"msg\", res2 -> { // provoke 404 not found\n-        context.assertTrue(res2.failed());\n-        if (res2.failed()) {\n-          context.assertTrue(res2.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-            res2.cause().getMessage());\n-        }\n-        dh.postUrlJson(\"/version\", \"msg\", \"{}\", res3 -> { // provoke 404 not found\n-          context.assertTrue(res2.failed());\n-          if (res3.failed()) {\n-            context.assertTrue(res3.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-              res3.cause().getMessage());\n-          }\n-          async.complete();\n-        });\n-      });\n+      async.complete();\n     });\n+    async.await(1000);\n+    Assume.assumeTrue(versionRes.containsKey(\"result\"));\n+    context.assertTrue(versionRes.getJsonObject(\"result\").containsKey(\"Platform\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5890d5783b27fe956a287c388c58c3c557f7b041"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjkwODI5OnYy", "diffSide": "RIGHT", "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo0OTo1NlrOGDtAFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMTo1NTowNFrOGD4iEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNjIxMw==", "bodyText": "It seems dh.deleteUrl and dh.postUrlJson can be tested independently. Is there a reason to chain them?", "url": "https://github.com/folio-org/okapi/pull/907#discussion_r406536213", "createdAt": "2020-04-09T23:49:56Z", "author": {"login": "hjiebsco"}, "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -87,28 +80,27 @@ public void testDockerVersionAtLocal(TestContext context) {\n     DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n       \"mod-users-5.0.0-SNAPSHOT\", ports, \"localhost\", 9232, new JsonObject());\n \n+    JsonObject versionRes = new JsonObject();\n+    Async async = context.async();\n     dh.getUrl(\"/version\", res -> {\n-      Assume.assumeTrue(res.succeeded());\n-      if (res.failed()) {\n-        logger.warn(res.cause().getMessage());\n-        async.complete();\n-        return;\n+      if (res.succeeded()) {\n+        versionRes.put(\"result\", res.result());\n       }\n-      dh.deleteUrl(\"/version\", \"msg\", res2 -> { // provoke 404 not found\n-        context.assertTrue(res2.failed());\n-        if (res2.failed()) {\n-          context.assertTrue(res2.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-            res2.cause().getMessage());\n-        }\n-        dh.postUrlJson(\"/version\", \"msg\", \"{}\", res3 -> { // provoke 404 not found\n-          context.assertTrue(res2.failed());\n-          if (res3.failed()) {\n-            context.assertTrue(res3.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-              res3.cause().getMessage());\n-          }\n-          async.complete();\n-        });\n-      });\n+      async.complete();\n     });\n+    async.await(1000);\n+    Assume.assumeTrue(versionRes.containsKey(\"result\"));\n+    context.assertTrue(versionRes.getJsonObject(\"result\").containsKey(\"Platform\"));\n+\n+    // provoke 404 not found\n+    dh.deleteUrl(\"/version\", \"msg\", context.asyncAssertFailure(cause -> {\n+      context.assertTrue(cause.getMessage().startsWith(\"msg HTTP error 404\"),\n+        cause.getMessage());\n+      // provoke 404 not found\n+      dh.postUrlJson(\"/version\", \"msg\", \"{}\", context.asyncAssertFailure(cause2 -> {\n+        context.assertTrue(cause2.getMessage().startsWith(\"msg HTTP error 404\"),\n+          cause2.getMessage());\n+      }));\n+    }));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5890d5783b27fe956a287c388c58c3c557f7b041"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MzY4Nw==", "bodyText": "Well. they must be executed only if Docker is available through domain socket. But they could be separate anyway.", "url": "https://github.com/folio-org/okapi/pull/907#discussion_r406683687", "createdAt": "2020-04-10T09:35:12Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -87,28 +80,27 @@ public void testDockerVersionAtLocal(TestContext context) {\n     DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n       \"mod-users-5.0.0-SNAPSHOT\", ports, \"localhost\", 9232, new JsonObject());\n \n+    JsonObject versionRes = new JsonObject();\n+    Async async = context.async();\n     dh.getUrl(\"/version\", res -> {\n-      Assume.assumeTrue(res.succeeded());\n-      if (res.failed()) {\n-        logger.warn(res.cause().getMessage());\n-        async.complete();\n-        return;\n+      if (res.succeeded()) {\n+        versionRes.put(\"result\", res.result());\n       }\n-      dh.deleteUrl(\"/version\", \"msg\", res2 -> { // provoke 404 not found\n-        context.assertTrue(res2.failed());\n-        if (res2.failed()) {\n-          context.assertTrue(res2.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-            res2.cause().getMessage());\n-        }\n-        dh.postUrlJson(\"/version\", \"msg\", \"{}\", res3 -> { // provoke 404 not found\n-          context.assertTrue(res2.failed());\n-          if (res3.failed()) {\n-            context.assertTrue(res3.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-              res3.cause().getMessage());\n-          }\n-          async.complete();\n-        });\n-      });\n+      async.complete();\n     });\n+    async.await(1000);\n+    Assume.assumeTrue(versionRes.containsKey(\"result\"));\n+    context.assertTrue(versionRes.getJsonObject(\"result\").containsKey(\"Platform\"));\n+\n+    // provoke 404 not found\n+    dh.deleteUrl(\"/version\", \"msg\", context.asyncAssertFailure(cause -> {\n+      context.assertTrue(cause.getMessage().startsWith(\"msg HTTP error 404\"),\n+        cause.getMessage());\n+      // provoke 404 not found\n+      dh.postUrlJson(\"/version\", \"msg\", \"{}\", context.asyncAssertFailure(cause2 -> {\n+        context.assertTrue(cause2.getMessage().startsWith(\"msg HTTP error 404\"),\n+          cause2.getMessage());\n+      }));\n+    }));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNjIxMw=="}, "originalCommit": {"oid": "5890d5783b27fe956a287c388c58c3c557f7b041"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4NjU3OA==", "bodyText": "It seems to be overkill to move check for docker in Setup.. So I'd rather keep this in one test.", "url": "https://github.com/folio-org/okapi/pull/907#discussion_r406686578", "createdAt": "2020-04-10T09:43:53Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -87,28 +80,27 @@ public void testDockerVersionAtLocal(TestContext context) {\n     DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n       \"mod-users-5.0.0-SNAPSHOT\", ports, \"localhost\", 9232, new JsonObject());\n \n+    JsonObject versionRes = new JsonObject();\n+    Async async = context.async();\n     dh.getUrl(\"/version\", res -> {\n-      Assume.assumeTrue(res.succeeded());\n-      if (res.failed()) {\n-        logger.warn(res.cause().getMessage());\n-        async.complete();\n-        return;\n+      if (res.succeeded()) {\n+        versionRes.put(\"result\", res.result());\n       }\n-      dh.deleteUrl(\"/version\", \"msg\", res2 -> { // provoke 404 not found\n-        context.assertTrue(res2.failed());\n-        if (res2.failed()) {\n-          context.assertTrue(res2.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-            res2.cause().getMessage());\n-        }\n-        dh.postUrlJson(\"/version\", \"msg\", \"{}\", res3 -> { // provoke 404 not found\n-          context.assertTrue(res2.failed());\n-          if (res3.failed()) {\n-            context.assertTrue(res3.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-              res3.cause().getMessage());\n-          }\n-          async.complete();\n-        });\n-      });\n+      async.complete();\n     });\n+    async.await(1000);\n+    Assume.assumeTrue(versionRes.containsKey(\"result\"));\n+    context.assertTrue(versionRes.getJsonObject(\"result\").containsKey(\"Platform\"));\n+\n+    // provoke 404 not found\n+    dh.deleteUrl(\"/version\", \"msg\", context.asyncAssertFailure(cause -> {\n+      context.assertTrue(cause.getMessage().startsWith(\"msg HTTP error 404\"),\n+        cause.getMessage());\n+      // provoke 404 not found\n+      dh.postUrlJson(\"/version\", \"msg\", \"{}\", context.asyncAssertFailure(cause2 -> {\n+        context.assertTrue(cause2.getMessage().startsWith(\"msg HTTP error 404\"),\n+          cause2.getMessage());\n+      }));\n+    }));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNjIxMw=="}, "originalCommit": {"oid": "5890d5783b27fe956a287c388c58c3c557f7b041"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyNTEzNg==", "bodyText": "I did not mean to separate them to different tests. Below is what I was thinking, pure format change to look a bit  nicer.\n// provoke 404 not found\ndh.deleteUrl(\"/version\", \"msg\", context.asyncAssertFailure(cause -> {\n  context.assertTrue(cause.getMessage().startsWith(\"msg HTTP error 404\"), cause.getMessage());\n}));\n// provoke 404 not found\ndh.postUrlJson(\"/version\", \"msg\", \"{}\", context.asyncAssertFailure(cause -> {\n  context.assertTrue(cause.getMessage().startsWith(\"msg HTTP error 404\"), cause.getMessage());\n}));", "url": "https://github.com/folio-org/okapi/pull/907#discussion_r406725136", "createdAt": "2020-04-10T11:55:04Z", "author": {"login": "hjiebsco"}, "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -87,28 +80,27 @@ public void testDockerVersionAtLocal(TestContext context) {\n     DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n       \"mod-users-5.0.0-SNAPSHOT\", ports, \"localhost\", 9232, new JsonObject());\n \n+    JsonObject versionRes = new JsonObject();\n+    Async async = context.async();\n     dh.getUrl(\"/version\", res -> {\n-      Assume.assumeTrue(res.succeeded());\n-      if (res.failed()) {\n-        logger.warn(res.cause().getMessage());\n-        async.complete();\n-        return;\n+      if (res.succeeded()) {\n+        versionRes.put(\"result\", res.result());\n       }\n-      dh.deleteUrl(\"/version\", \"msg\", res2 -> { // provoke 404 not found\n-        context.assertTrue(res2.failed());\n-        if (res2.failed()) {\n-          context.assertTrue(res2.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-            res2.cause().getMessage());\n-        }\n-        dh.postUrlJson(\"/version\", \"msg\", \"{}\", res3 -> { // provoke 404 not found\n-          context.assertTrue(res2.failed());\n-          if (res3.failed()) {\n-            context.assertTrue(res3.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-              res3.cause().getMessage());\n-          }\n-          async.complete();\n-        });\n-      });\n+      async.complete();\n     });\n+    async.await(1000);\n+    Assume.assumeTrue(versionRes.containsKey(\"result\"));\n+    context.assertTrue(versionRes.getJsonObject(\"result\").containsKey(\"Platform\"));\n+\n+    // provoke 404 not found\n+    dh.deleteUrl(\"/version\", \"msg\", context.asyncAssertFailure(cause -> {\n+      context.assertTrue(cause.getMessage().startsWith(\"msg HTTP error 404\"),\n+        cause.getMessage());\n+      // provoke 404 not found\n+      dh.postUrlJson(\"/version\", \"msg\", \"{}\", context.asyncAssertFailure(cause2 -> {\n+        context.assertTrue(cause2.getMessage().startsWith(\"msg HTTP error 404\"),\n+          cause2.getMessage());\n+      }));\n+    }));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNjIxMw=="}, "originalCommit": {"oid": "5890d5783b27fe956a287c388c58c3c557f7b041"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNDQwMjQyOnYy", "diffSide": "RIGHT", "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzoyNDo1N1rOGD6Zug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzoyNDo1N1rOGD6Zug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1NTc3MA==", "bodyText": "Why don't you use context.verify?\n    Async async = context.async();\n    dh.getUrl(\"/version\", res -> context.verify(h -> {\n      Assume.assumeTrue(res.succeeded());  // skip test if no access to Okapi\n      context.assertTrue(res.result().containsKey(\"Version\"));\n      async.complete();\n    }));\n    async.await(1000);", "url": "https://github.com/folio-org/okapi/pull/907#discussion_r406755770", "createdAt": "2020-04-10T13:24:57Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -87,28 +80,27 @@ public void testDockerVersionAtLocal(TestContext context) {\n     DockerModuleHandle dh = new DockerModuleHandle(vertx, ld,\n       \"mod-users-5.0.0-SNAPSHOT\", ports, \"localhost\", 9232, new JsonObject());\n \n+    JsonObject versionRes = new JsonObject();\n+    Async async = context.async();\n     dh.getUrl(\"/version\", res -> {\n-      Assume.assumeTrue(res.succeeded());\n-      if (res.failed()) {\n-        logger.warn(res.cause().getMessage());\n-        async.complete();\n-        return;\n+      if (res.succeeded()) {\n+        versionRes.put(\"result\", res.result());\n       }\n-      dh.deleteUrl(\"/version\", \"msg\", res2 -> { // provoke 404 not found\n-        context.assertTrue(res2.failed());\n-        if (res2.failed()) {\n-          context.assertTrue(res2.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-            res2.cause().getMessage());\n-        }\n-        dh.postUrlJson(\"/version\", \"msg\", \"{}\", res3 -> { // provoke 404 not found\n-          context.assertTrue(res2.failed());\n-          if (res3.failed()) {\n-            context.assertTrue(res3.cause().getMessage().startsWith(\"msg HTTP error 404\"),\n-              res3.cause().getMessage());\n-          }\n-          async.complete();\n-        });\n-      });\n+      async.complete();\n     });\n+    async.await(1000);\n+    Assume.assumeTrue(versionRes.containsKey(\"result\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b99d40109ac35d2c9229aeb4e02f70330131da"}, "originalPosition": 66}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 229, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}