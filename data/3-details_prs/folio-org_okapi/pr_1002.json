{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MTA5ODY0", "number": 1002, "title": "OKAPI-921 skip token cache if no request token is present", "bodyText": "Overview\ninstead of explicitly incorporating things like tenant and userId into the cache key we use the entire token in the request as part of the cache key since it includes this information. In doing so, we need to ensure that we don't allow cache keys w/ token=null. See OKAPI-921\nAdditional context: FOLIO-2839", "createdAt": "2020-10-16T21:24:39Z", "url": "https://github.com/folio-org/okapi/pull/1002", "merged": true, "mergeCommit": {"oid": "7bcd4b41d810a402abaec05d69e45ba135a7ac65"}, "closed": true, "closedAt": "2020-10-19T13:37:36Z", "author": {"login": "craigmcnally"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTNLavAH2gAyNTA1MTA5ODY0OjM4YzNlODlkM2MyYWQzYTVmZWVhMGViZjA3ZGExNDAxYTIxZDgwNGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUESLoAFqTUxMTc2NjIyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "38c3e89d3c2ad3a5feea0ebf07da1401a21d804d", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/38c3e89d3c2ad3a5feea0ebf07da1401a21d804d", "committedDate": "2020-10-16T21:23:02Z", "message": "OKAPI-921 skip cache if no token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dab4739dc57fb4c0eb470d1a84fee8aedd1ff467", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/dab4739dc57fb4c0eb470d1a84fee8aedd1ff467", "committedDate": "2020-10-16T21:28:23Z", "message": "OKAPI-921 fix indentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNjk3Mzgx", "url": "https://github.com/folio-org/okapi/pull/1002#pullrequestreview-511697381", "createdAt": "2020-10-19T12:17:29Z", "commit": {"oid": "dab4739dc57fb4c0eb470d1a84fee8aedd1ff467"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMjoxNzoyOVrOHkLehw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxMjoxNzoyOVrOHkLehw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY5ODgyMw==", "bodyText": "Checking for tokenCache == null seems redundant. It is always constructed. Perhaps it should be final?", "url": "https://github.com/folio-org/okapi/pull/1002#discussion_r507698823", "createdAt": "2020-10-19T12:17:29Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -203,9 +203,20 @@ private boolean resolveRedirects(ProxyContext pc,\n    */\n   private boolean checkTokenCache(String tenant, HttpServerRequest req, String pathPattern,\n       ModuleInstance mi) {\n-    CacheEntry cached =\n-        tokenCache.get(tenant, req.method().name(), pathPattern == null ? req.path() : pathPattern,\n-            req.getHeader(XOkapiHeaders.USER_ID), req.headers().get(XOkapiHeaders.TOKEN));\n+    String token = req.headers().get(XOkapiHeaders.TOKEN);\n+    if (token == null) {\n+      mi.setAuthToken(null);\n+      mi.setUserId(null);\n+      mi.setPermissions(null);\n+      return false;\n+    }\n+\n+    String pathComponent = pathPattern == null ? req.path() : pathPattern;\n+\n+    CacheEntry cached = tokenCache == null ? null\n+        : tokenCache.get(tenant, req.method().name(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dab4739dc57fb4c0eb470d1a84fee8aedd1ff467"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e280b5abc8394d829840a46685f995097a48127", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/4e280b5abc8394d829840a46685f995097a48127", "committedDate": "2020-10-19T12:48:40Z", "message": "Merge branch 'master' into OKAPI-921"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6d0083335bb9836ea4ef5eee7c016d1495f039b", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/b6d0083335bb9836ea4ef5eee7c016d1495f039b", "committedDate": "2020-10-19T12:53:05Z", "message": "OKAPI-921 remove unneeded null check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExNzY2MjI3", "url": "https://github.com/folio-org/okapi/pull/1002#pullrequestreview-511766227", "createdAt": "2020-10-19T13:35:12Z", "commit": {"oid": "b6d0083335bb9836ea4ef5eee7c016d1495f039b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2873, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}