{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNjA1ODk4", "number": 936, "title": "OKAPI-787: Support SSL connections to Postgres", "bodyText": "Add new configuration option postgres_server_pem.\nAdd netty-tcnative-boringssl-static because OpenJDK 8\ndoesn't support TLSv1.3.\nFor testing a postgres:12-alpine testingcontainers.org\ncontainer is startet. PostgreSQL 10 does not support\nssl_min_protocol_version that we need for the TLSv1.3\ntest. The Alpine version is sufficient, we don't need\nthe large Debian container.\nThis also introduces JUnit 5 (Jupiter).", "createdAt": "2020-06-10T17:41:55Z", "url": "https://github.com/folio-org/okapi/pull/936", "merged": true, "mergeCommit": {"oid": "164d7d3c5a7b1f84efb7d498d7d07bd63fc34160"}, "closed": true, "closedAt": "2020-06-12T07:07:44Z", "author": {"login": "julianladisch"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp82VrAH2gAyNDMyNjA1ODk4OmY5NWYxZGI5MzAwZmEyNDFhYTZhNDVkNjMzOWE1NDc0ZDgwYzg2MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqLFjDgFqTQyODc1NjIyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f95f1db9300fa241aa6a45d6339a5474d80c8619", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/f95f1db9300fa241aa6a45d6339a5474d80c8619", "committedDate": "2020-06-10T17:10:38Z", "message": "OKAPI-787: Support SSL connections to Postgres\n\nAdd new configuration option postgres_server_pem.\n\nAdd netty-tcnative-boringssl-static because OpenJDK 8\ndoesn't support TLSv1.3.\n\nFor testing a postgres:12-alpine testingcontainers.org\ncontainer is startet. PostgreSQL 10 does not support\nssl_min_protocol_version that we need for the TLSv1.3\ntest. The Alpine version is sufficient, we don't need\nthe large Debian container.\n\nThis also introduces JUnit 5 (Jupiter)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDE0OTM3", "url": "https://github.com/folio-org/okapi/pull/936#pullrequestreview-428414937", "createdAt": "2020-06-10T20:46:01Z", "commit": {"oid": "f95f1db9300fa241aa6a45d6339a5474d80c8619"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMDo0NjowMVrOGiFtGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMDo0NjowMVrOGiFtGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM5ODIzNA==", "bodyText": "What happens if an invalid cert is provided?  Does this call do validation, causing a failure here, or would SSL requests just be rejected later on, or...?", "url": "https://github.com/folio-org/okapi/pull/936#discussion_r438398234", "createdAt": "2020-06-10T20:46:01Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/PostgresHandle.java", "diffHunk": "@@ -63,6 +68,15 @@\n         Config.getSysConf(\"postgres_user\", \"okapi\", new JsonObject()), conf));\n     connectOptions.setPassword(Config.getSysConf(\"postgres_password\", \"okapi25\", conf));\n     connectOptions.setDatabase(Config.getSysConf(\"postgres_database\", \"okapi\", conf));\n+    String serverPem = Config.getSysConf(\"postgres_server_pem\", null, conf);\n+    if (serverPem != null) {\n+      connectOptions.setSslMode(SslMode.VERIFY_FULL);\n+      connectOptions.setHostnameVerificationAlgorithm(\"HTTPS\");\n+      connectOptions.setPemTrustOptions(\n+          new PemTrustOptions().addCertValue(Buffer.buffer(serverPem)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f95f1db9300fa241aa6a45d6339a5474d80c8619"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDE5MDQ2", "url": "https://github.com/folio-org/okapi/pull/936#pullrequestreview-428419046", "createdAt": "2020-06-10T20:52:17Z", "commit": {"oid": "f95f1db9300fa241aa6a45d6339a5474d80c8619"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMDo1MjoxN1rOGiF5Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMDo1MjoxN1rOGiF5Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQwMTMyMg==", "bodyText": "consider adding a debug/info level log message indicating that SSL is being used.", "url": "https://github.com/folio-org/okapi/pull/936#discussion_r438401322", "createdAt": "2020-06-10T20:52:17Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/PostgresHandle.java", "diffHunk": "@@ -63,6 +68,15 @@\n         Config.getSysConf(\"postgres_user\", \"okapi\", new JsonObject()), conf));\n     connectOptions.setPassword(Config.getSysConf(\"postgres_password\", \"okapi25\", conf));\n     connectOptions.setDatabase(Config.getSysConf(\"postgres_database\", \"okapi\", conf));\n+    String serverPem = Config.getSysConf(\"postgres_server_pem\", null, conf);\n+    if (serverPem != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f95f1db9300fa241aa6a45d6339a5474d80c8619"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7356239d377d72db3577704bc167285f8f78de9", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/b7356239d377d72db3577704bc167285f8f78de9", "committedDate": "2020-06-10T21:38:20Z", "message": "Remove unused empty file foobar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bb582565cf37bf4aa74176031912e492095c2d6", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/6bb582565cf37bf4aa74176031912e492095c2d6", "committedDate": "2020-06-10T22:02:06Z", "message": "logger.debug about enabling SSL"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTQ1NzA2", "url": "https://github.com/folio-org/okapi/pull/936#pullrequestreview-428545706", "createdAt": "2020-06-11T02:11:13Z", "commit": {"oid": "6bb582565cf37bf4aa74176031912e492095c2d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NzU2MjIw", "url": "https://github.com/folio-org/okapi/pull/936#pullrequestreview-428756220", "createdAt": "2020-06-11T09:45:55Z", "commit": {"oid": "6bb582565cf37bf4aa74176031912e492095c2d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2969, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}