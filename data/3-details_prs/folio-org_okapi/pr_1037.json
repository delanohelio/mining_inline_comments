{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MDE1MTQx", "number": 1037, "title": "OKAPI-944 failed tests on mac and ec2", "bodyText": "Made two small changes to get failed tests pass. For EC2, the connection refused message does not match perfectly. For mac, it turns out the NuProcess returns the sh pid but not the Java pid. So the NuProcess object is not null and is not running, the tryConnect loop does not capture this. Extending the timer wait time to let tryConnect succeed as a work around.\nAfter updating Docker on my Mac, I start to see lots of Ryuk connection error. Updating testcontains version fixed that. There was an issue reported for testcontainer. See testcontainers/testcontainers-java#3159", "createdAt": "2020-11-06T22:46:59Z", "url": "https://github.com/folio-org/okapi/pull/1037", "merged": true, "mergeCommit": {"oid": "32ae0a46de5b33ec6a12321e766f408c4663b186"}, "closed": true, "closedAt": "2020-11-09T17:54:52Z", "author": {"login": "hjiebsco"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ8AhcgH2gAyNTE3MDE1MTQxOjdkNWQzNjk3Y2IyOWFhYzk4M2FlODM5MjQ1MDJjZmFjMTRhZjFmNGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda2wkBgFqTUyNjM4OTA1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7d5d3697cb29aac983ae83924502cfac14af1f4a", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/7d5d3697cb29aac983ae83924502cfac14af1f4a", "committedDate": "2020-11-06T19:20:13Z", "message": "Give more time for process to start/stop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "791d429ec1edec85d315487f79cf970eab82141a", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/791d429ec1edec85d315487f79cf970eab82141a", "committedDate": "2020-11-06T21:59:36Z", "message": "Match message in AWS ec2 env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f415a732d0a6a80466d4c392cc42ee0618ead7a", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/9f415a732d0a6a80466d4c392cc42ee0618ead7a", "committedDate": "2020-11-07T15:34:24Z", "message": "Update testcontainers to fix Ryuk connection issue on macOS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0539863d47b5d9bd912a44e0d32c2bf609561c97", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/0539863d47b5d9bd912a44e0d32c2bf609561c97", "committedDate": "2020-11-09T10:40:32Z", "message": "use assertThat"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MTU1MjE2", "url": "https://github.com/folio-org/okapi/pull/1037#pullrequestreview-526155216", "createdAt": "2020-11-09T11:20:47Z", "commit": {"oid": "0539863d47b5d9bd912a44e0d32c2bf609561c97"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyMDo0N1rOHvqD3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyMjowNlrOHvqGwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczNDIzNg==", "bodyText": "How do you conclude that the NuPocess is not returning the right process? As far as I can tell it reaches waitReady as it should, but the Test doesn't wait enough time.. So I think we should just increase waitIterations in ProcessModuleHandleTest, say, from 15 to 20 (desc.setWaitIterations(15)).\nThe test runs a Bourne Shell script and that's the exit code we check (also on Linux).\nIncreasing from 1 to 3 seconds will make ALL process deployments 2 seconds slower.", "url": "https://github.com/folio-org/okapi/pull/1037#discussion_r519734236", "createdAt": "2020-11-09T11:20:47Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -149,7 +149,7 @@ private NuProcess launch(EnvEntry[] env, String [] command) {\n     Promise<Void> promise = Promise.promise();\n     // time to wait for process status.. when a port is present (always in real life)..\n     // The waitReady will check if process eventually starts listening on port\n-    vertx.setTimer(port == 0 ? 3000 : 1000, timerRes -> {\n+    vertx.setTimer(3000, timerRes -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0539863d47b5d9bd912a44e0d32c2bf609561c97"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczNDYyNQ==", "bodyText": "Same here.. Increasing waitIterations is a better solution, IMHO.", "url": "https://github.com/folio-org/okapi/pull/1037#discussion_r519734625", "createdAt": "2020-11-09T11:21:29Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -198,7 +198,7 @@ private NuProcess launch(EnvEntry[] env, String [] command) {\n     Promise<Void> promise = Promise.promise();\n     // time to wait for process that shuts down service.. when a port is present (always in prod)\n     // The waitPortClose will wait for service to shut down\n-    vertx.setTimer(port == 0 ? 3000 : 1000, timerRes -> {\n+    vertx.setTimer(3000, timerRes -> {\n       if (pp.isRunning() || exitCode == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0539863d47b5d9bd912a44e0d32c2bf609561c97"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczNDc2NA==", "bodyText": "Yes", "url": "https://github.com/folio-org/okapi/pull/1037#discussion_r519734764", "createdAt": "2020-11-09T11:21:45Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/test/java/org/folio/okapi/service/impl/DockerModuleHandleTest.java", "diffHunk": "@@ -511,7 +511,7 @@ public void testDockerVersionAtLocal(TestContext context) {\n     {\n       Async async = context.async();\n       dh.pullImage().onComplete(context.asyncAssertFailure(res -> {\n-        context.assertTrue(res.getMessage().contains(\"9231: connect: connection refused\"), res.getMessage());\n+        assertThat(res.getMessage()).contains(\"9231\").contains(\"connection refused\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0539863d47b5d9bd912a44e0d32c2bf609561c97"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczNDk3Ng==", "bodyText": "Nice. Great that was fixed and we don't have to use \"snapshot\" or similar.", "url": "https://github.com/folio-org/okapi/pull/1037#discussion_r519734976", "createdAt": "2020-11-09T11:22:06Z", "author": {"login": "adamdickmeiss"}, "path": "pom.xml", "diffHunk": "@@ -133,7 +133,7 @@\n       <dependency>\n         <groupId>org.testcontainers</groupId>\n         <artifactId>testcontainers-bom</artifactId>\n-        <version>1.14.3</version>\n+        <version>1.15.0</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0539863d47b5d9bd912a44e0d32c2bf609561c97"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83b9edc59c580032395827a71b9009fbdeca9a2b", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/83b9edc59c580032395827a71b9009fbdeca9a2b", "committedDate": "2020-11-09T15:29:14Z", "message": "Changes per Adam PR review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f59fc6c0a45f85db6d6538d36194a5f25713c42", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/3f59fc6c0a45f85db6d6538d36194a5f25713c42", "committedDate": "2020-11-09T15:43:31Z", "message": "Make testProgramNoListener faster"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Mzg5MDUx", "url": "https://github.com/folio-org/okapi/pull/1037#pullrequestreview-526389051", "createdAt": "2020-11-09T15:47:11Z", "commit": {"oid": "3f59fc6c0a45f85db6d6538d36194a5f25713c42"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2911, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}