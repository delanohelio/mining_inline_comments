{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NjQ2MzQ0", "number": 931, "title": "Allow delegate CORS to module", "bodyText": "See OKAPI-847: Conditionally defer CORS handling to module when invoked via passthrough API", "createdAt": "2020-05-31T17:52:12Z", "url": "https://github.com/folio-org/okapi/pull/931", "merged": true, "mergeCommit": {"oid": "60b32aa929dc0d2726671e814ba95a0293b9bd13"}, "closed": true, "closedAt": "2020-06-02T13:11:11Z", "author": {"login": "hjiebsco"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmvT71gH2gAyNDI1NjQ2MzQ0OjY2YWZkZDEzZDhmZjFmY2NhYWMwNTkzMmUzOTA3ZDU4MmFkZTY3ODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnUbbFgFqTQyMjY0NzM2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "66afdd13d8ff1fccaac05932e3907d582ade6785", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/66afdd13d8ff1fccaac05932e3907d582ade6785", "committedDate": "2020-05-31T17:42:31Z", "message": "Allow delegate CORS to module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a1b3a11b009b6ba189f01e375cee02ba98ad551", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/2a1b3a11b009b6ba189f01e375cee02ba98ad551", "committedDate": "2020-05-31T17:57:12Z", "message": "Typo in comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxODYwNzkw", "url": "https://github.com/folio-org/okapi/pull/931#pullrequestreview-421860790", "createdAt": "2020-06-01T13:53:55Z", "commit": {"oid": "66afdd13d8ff1fccaac05932e3907d582ade6785"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxMzo1Mzo1NlrOGdLUMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxMzo1Mzo1NlrOGdLUMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI0NzI4Mg==", "bodyText": "Please don't import MainVerticle which also includes ProxyService. Can you move all CORS logic to a CorsHandler class? Which is this is then imported/used by ProxyService and MainVerticle.", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433247282", "createdAt": "2020-06-01T13:53:56Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -538,6 +539,18 @@ public void proxy(RoutingContext ctx) {\n           stream.resume();\n           return; // ctx already set up\n         }\n+\n+        // handle delegate CORS\n+        if (ctx.data().containsKey(MainVerticle.CHECK_DELEGATE_CORS)) {\n+          ctx.data().remove(MainVerticle.CHECK_DELEGATE_CORS);\n+          if (l.stream().anyMatch(mi -> mi.isHandler() && mi.getRoutingEntry().isDelegateCors())) {\n+            ctx.data().put(MainVerticle.DELEGATE_CORS, true);\n+            stream.resume();\n+            ctx.reroute(ctx.request().path());\n+            return;\n+          }\n+        }\n+\n         pc.setModList(l);\n \n         pc.logRequest(ctx, tenantId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66afdd13d8ff1fccaac05932e3907d582ade6785"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "062b78bb1a14051e9beaed262443f7858b96fae3", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/062b78bb1a14051e9beaed262443f7858b96fae3", "committedDate": "2020-06-01T15:50:47Z", "message": "Move changes to a new class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6abc470d4e7d2797bde2483ed0932fb53a5625e0", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/6abc470d4e7d2797bde2483ed0932fb53a5625e0", "committedDate": "2020-06-01T16:13:12Z", "message": "Tweak method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/add1a2af02024965b0dd8421a290859defa5df3d", "committedDate": "2020-06-01T16:51:30Z", "message": "check style change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzEwNzA4", "url": "https://github.com/folio-org/okapi/pull/931#pullrequestreview-422310708", "createdAt": "2020-06-02T03:01:09Z", "commit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowMTowOVrOGdggzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowMTowOVrOGdggzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDU3NQ==", "bodyText": "Typo \"Hanlder\"", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433594575", "createdAt": "2020-06-02T03:01:09Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/MainVerticle.java", "diffHunk": "@@ -352,26 +350,9 @@ private void checkSuperTenant(String okapiModule, Promise<Void> promise) {\n   private Future<Void> startListening() {\n     Router router = Router.router(vertx);\n     logger.debug(\"Setting up routes\");\n+\n     //handle CORS\n-    router.route().handler(CorsHandler.create(\"*\")\n-        .allowedMethod(HttpMethod.PUT)\n-        .allowedMethod(HttpMethod.DELETE)\n-        .allowedMethod(HttpMethod.GET)\n-        .allowedMethod(HttpMethod.POST)\n-        //allow request headers\n-        .allowedHeader(HttpHeaders.CONTENT_TYPE.toString())\n-        .allowedHeader(XOkapiHeaders.TENANT)\n-        .allowedHeader(XOkapiHeaders.TOKEN)\n-        .allowedHeader(XOkapiHeaders.AUTHORIZATION)\n-        .allowedHeader(XOkapiHeaders.REQUEST_ID) //expose response headers\n-        .allowedHeader(XOkapiHeaders.MODULE_ID)\n-        .exposedHeader(HttpHeaders.LOCATION.toString())\n-        .exposedHeader(XOkapiHeaders.TRACE)\n-        .exposedHeader(XOkapiHeaders.TOKEN)\n-        .exposedHeader(XOkapiHeaders.AUTHORIZATION)\n-        .exposedHeader(XOkapiHeaders.REQUEST_ID)\n-        .exposedHeader(XOkapiHeaders.MODULE_ID)\n-    );\n+    CorsHelper.addCorsHanlder(router);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzExMDg0", "url": "https://github.com/folio-org/okapi/pull/931#pullrequestreview-422311084", "createdAt": "2020-06-02T03:02:36Z", "commit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowMjozN1rOGdgh9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowMjozN1rOGdgh9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDg2OA==", "bodyText": "See above comment about typo", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433594868", "createdAt": "2020-06-02T03:02:37Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/util/CorsHelper.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.folio.okapi.util;\n+\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.CorsHandler;\n+import java.util.List;\n+import org.folio.okapi.bean.ModuleInstance;\n+import org.folio.okapi.common.XOkapiHeaders;\n+\n+/**\n+ * Customized CORS handling.\n+ *\n+ * <p>If a module API specifies <b>delegateCORS</b> to true in RAML, Okapi will\n+ * delegate CORS handling to the module if and only if the API is invoked\n+ * through {@code /_/invoke/tenant/<tenantId>/moduleAPI}\n+ */\n+public class CorsHelper {\n+\n+  private static final String CHECK_DELEGATE_CORS = \"check-delegate-CORS\";\n+  private static final String DELEGATE_CORS = \"delegate-CORS\";\n+\n+  private CorsHelper() {\n+  }\n+\n+  /**\n+   * Add CORS handler to {@link Router}.\n+   *\n+   * @param router - {@link Router}\n+   */\n+  public static void addCorsHanlder(Router router) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzExNjQz", "url": "https://github.com/folio-org/okapi/pull/931#pullrequestreview-422311643", "createdAt": "2020-06-02T03:04:38Z", "commit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowNDozOFrOGdgjuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowNDozOFrOGdgjuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NTMyMQ==", "bodyText": "consider mentioning that this only applies to calls made via /_/invoke/tenant/<tid>/<path>", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433595321", "createdAt": "2020-06-02T03:04:38Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/raml/RoutingEntry.json", "diffHunk": "@@ -68,6 +68,10 @@\n       \"items\": {\n         \"type\": \"string\"\n       }\n+    },\n+    \"delegateCORS\": {\n+      \"description\": \"Okapi handles CORS by default. Set to true to delegate CORS handling to the module\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a088ae9e5f104464288576ac38b25353d8229c0c", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/a088ae9e5f104464288576ac38b25353d8229c0c", "committedDate": "2020-06-02T03:26:14Z", "message": "Fix typo and update json schema description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNTMwMTYx", "url": "https://github.com/folio-org/okapi/pull/931#pullrequestreview-422530161", "createdAt": "2020-06-02T10:05:34Z", "commit": {"oid": "a088ae9e5f104464288576ac38b25353d8229c0c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNjQ3MzYz", "url": "https://github.com/folio-org/okapi/pull/931#pullrequestreview-422647363", "createdAt": "2020-06-02T12:57:11Z", "commit": {"oid": "a088ae9e5f104464288576ac38b25353d8229c0c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2964, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}