{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyODE1MDEx", "number": 1063, "title": "OKAPI-968: Unhandled exception in DockerModuleHandle.request", "bodyText": "Vert.x HttpClient.request doesn't return all exceptions as a failed future but also directly throws some of them.\nExample:\n2020-12-18T22:03:31,099 INFO  DockerModuleHandle   delete container 8ee1e1ec95ecc311d7d603a4d5871ac17dd67c860a48f613ce0c7199e4e4c59b image folioci/mod-gobi:1.\n8.0-SNAPSHOT.98\n2020-12-18T22:03:31,102 ERROR ?                    Unhandled exception\njava.lang.IllegalStateException: Client is closed\n        at io.vertx.core.http.impl.HttpClientImpl.checkClosed(HttpClientImpl.java:634) ~[okapi-core-fat.jar:?]\n        at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:542) ~[okapi-core-fat.jar:?]\n        at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:396) ~[okapi-core-fat.jar:?]\n        at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:391) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.request(DockerModuleHandle.java:145) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.deleteUrl(DockerModuleHandle.java:159) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.deleteContainer(DockerModuleHandle.java:175) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.lambda$prepareContainer$18(DockerModuleHandle.java:430) ~[okapi-core-fat.jar:?]\n\nTask:\nCatch them and pass them as a failed future.", "createdAt": "2020-12-18T22:54:04Z", "url": "https://github.com/folio-org/okapi/pull/1063", "merged": true, "mergeCommit": {"oid": "0a7c3318b7c0ac5d2b8be6feb156bd8f9397cdd1"}, "closed": true, "closedAt": "2021-01-13T22:15:35Z", "author": {"login": "julianladisch"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdngNX1gH2gAyNTQyODE1MDExOjgxMjdhMTM0NWFjOTA3MzM3NmIwMTA1NDk4YzkzMGQ0Y2VhNjE0ZmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvxRhpAFqTU2NzMyMzY4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8127a1345ac9073376b0105498c930d4cea614fe", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/8127a1345ac9073376b0105498c930d4cea614fe", "committedDate": "2020-12-18T22:51:51Z", "message": "OKAPI-968: Unhandled exception in DockerModuleHandle.request\n\nVert.x HttpClient.request doesn't return all exceptions as a failed future but also directly throws some of them.\n\nExample:\n```\n2020-12-18T22:03:31,099 INFO  DockerModuleHandle   delete container 8ee1e1ec95ecc311d7d603a4d5871ac17dd67c860a48f613ce0c7199e4e4c59b image folioci/mod-gobi:1.\n8.0-SNAPSHOT.98\n2020-12-18T22:03:31,102 ERROR ?                    Unhandled exception\njava.lang.IllegalStateException: Client is closed\n        at io.vertx.core.http.impl.HttpClientImpl.checkClosed(HttpClientImpl.java:634) ~[okapi-core-fat.jar:?]\n        at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:542) ~[okapi-core-fat.jar:?]\n        at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:396) ~[okapi-core-fat.jar:?]\n        at io.vertx.core.http.impl.HttpClientImpl.request(HttpClientImpl.java:391) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.request(DockerModuleHandle.java:145) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.deleteUrl(DockerModuleHandle.java:159) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.deleteContainer(DockerModuleHandle.java:175) ~[okapi-core-fat.jar:?]\n        at org.folio.okapi.service.impl.DockerModuleHandle.lambda$prepareContainer$18(DockerModuleHandle.java:430) ~[okapi-core-fat.jar:?]\n```\n\nTask:\nCatch them and pass them as a failed future."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1OTQ0MzY5", "url": "https://github.com/folio-org/okapi/pull/1063#pullrequestreview-555944369", "createdAt": "2020-12-19T14:17:37Z", "commit": {"oid": "8127a1345ac9073376b0105498c930d4cea614fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82e3afea3c0cb1712840965e978162a59d85f92a", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/82e3afea3c0cb1712840965e978162a59d85f92a", "committedDate": "2021-01-12T16:15:49Z", "message": "Merge branch 'master' into OKAPI-968-DockerModuleHandle.request-exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2NTI3MjYw", "url": "https://github.com/folio-org/okapi/pull/1063#pullrequestreview-566527260", "createdAt": "2021-01-12T17:54:12Z", "commit": {"oid": "8127a1345ac9073376b0105498c930d4cea614fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQxNzo1NDoxMlrOISNaHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQxNzo1NDoxMlrOISNaHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk2NDk1Ng==", "bodyText": "Should make the try block smaller to start from line 146?", "url": "https://github.com/folio-org/okapi/pull/1063#discussion_r555964956", "createdAt": "2021-01-12T17:54:12Z", "author": {"login": "hjiebsco"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/DockerModuleHandle.java", "diffHunk": "@@ -136,18 +136,22 @@ static String setupDockerAddress(StringBuilder socketAddress, String u) {\n   private Future<HttpClientResponse> request(HttpMethod method, String url,\n                                              MultiMap headers, Buffer body) {\n \n-    RequestOptions requestOptions = new RequestOptions()\n-        .setMethod(method)\n-        .setAbsoluteURI(dockerUrl + url);\n-    if (socketAddress != null) {\n-      requestOptions.setServer(socketAddress);\n-    }\n-    return client.request(requestOptions).compose(request -> {\n-      if (headers != null) {\n-        request.headers().setAll(headers);\n+    try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8127a1345ac9073376b0105498c930d4cea614fe"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f084cbd1e5c81f372983db77ee830b85eb10d2e5", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/f084cbd1e5c81f372983db77ee830b85eb10d2e5", "committedDate": "2021-01-12T21:33:18Z", "message": "Extract try-catch into FuturisedHttpClient; reuse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "703a71f2332e3e14b0905c31794caa5adcf3b357", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/703a71f2332e3e14b0905c31794caa5adcf3b357", "committedDate": "2021-01-12T21:44:59Z", "message": "Merge branch 'master' into OKAPI-968-DockerModuleHandle.request-exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2NzQ0OTM1", "url": "https://github.com/folio-org/okapi/pull/1063#pullrequestreview-566744935", "createdAt": "2021-01-12T22:13:03Z", "commit": {"oid": "703a71f2332e3e14b0905c31794caa5adcf3b357"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQyMjoxMzowM1rOISXe3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQyMjoxMzowM1rOISXe3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjEzMDAxMw==", "bodyText": "OkapiClient does not need this new FuturisedHttpClient?", "url": "https://github.com/folio-org/okapi/pull/1063#discussion_r556130013", "createdAt": "2021-01-12T22:13:03Z", "author": {"login": "hjiebsco"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -1201,7 +1201,7 @@ private static DeploymentDescriptor pickInstance(List<DeploymentDescriptor> inst\n     Map<String, String> headers = sysReqHeaders(headersIn, tenantId, authToken, inst, modPerms);\n     headers.put(XOkapiHeaders.URL_TO, inst.getUrl());\n     logger.debug(\"syscall begin {} {}{}\", inst.getMethod(), inst.getUrl(), inst.getPath());\n-    OkapiClient cli = new OkapiClient(this.httpClient, inst.getUrl(), vertx, headers);\n+    OkapiClient cli = new OkapiClient(httpClient.getHttpClient(), inst.getUrl(), vertx, headers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "703a71f2332e3e14b0905c31794caa5adcf3b357"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e645af97b04564104b5b54c166134a36d794b4b0", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/e645af97b04564104b5b54c166134a36d794b4b0", "committedDate": "2021-01-12T22:36:13Z", "message": "Fix FuturisedHttpClient test; fix 'Connection refused' translation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3MzIzNjg2", "url": "https://github.com/folio-org/okapi/pull/1063#pullrequestreview-567323686", "createdAt": "2021-01-13T15:16:10Z", "commit": {"oid": "e645af97b04564104b5b54c166134a36d794b4b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2794, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}