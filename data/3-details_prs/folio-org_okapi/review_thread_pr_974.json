{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NTcyODM0", "number": 974, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNjo1Njo1N1rOEko5qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMTowMTowN1rOEmB-3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2ODU0MzE0OnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNjo1Njo1N1rOHTsn5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNDoxNzoyNFrOHUPGsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxNjEwMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param id if of process (possibly module ID)\n          \n          \n            \n               * @param id process identifier used for logging (possibly module ID)", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r490416103", "createdAt": "2020-09-17T16:56:57Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -41,13 +45,14 @@\n    * Construct process module handler.\n    * @param vertx Vert.x handle\n    * @param desc launch descriptor\n+   * @param id if of process (possibly module ID)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5fac4836d287f0e1e02414673faa2c10885b19b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4MTA0MA==", "bodyText": "Agreed. better. if of :-)", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r490981040", "createdAt": "2020-09-18T14:17:24Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -41,13 +45,14 @@\n    * Construct process module handler.\n    * @param vertx Vert.x handle\n    * @param desc launch descriptor\n+   * @param id if of process (possibly module ID)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxNjEwMw=="}, "originalCommit": {"oid": "b5fac4836d287f0e1e02414673faa2c10885b19b"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2ODY4NjIwOnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzozNToxN1rOHTuB4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMDowMzowOFrOHUGijQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQzOTEzNw==", "bodyText": "The default worker pool size is 20. If I start 11 processes and each runs 2 captureStream there is some blocking. If the first runs 60 seconds and all other run 1 second then the logging of the 11th is blocked until the first has finished.\nhttps://vertx.io/docs/vertx-core/java/#blocking_code says about executeBlocking:\n\nBlocking code should block for a reasonable amount of time (i.e no more than a few seconds). Long blocking operations or polling operations (i.e a thread that spin in a loop polling events in a blocking fashion) are precluded. When the blocking operation lasts more than the 10 seconds, a message will be printed on the console by the blocked thread checker. Long blocking operations should use a dedicated thread managed by the application, which can interact with verticles using the event-bus or runOnContext\n\nSee also https://github.com/vietj/childprocess-vertx-ext based on https://github.com/brettwooldridge/NuProcess :\n\nA low-overhead, non-blocking I/O, external Process execution implementation for Java. It is a replacement for java.lang.ProcessBuilder and java.lang.Process.\nHave you ever been annoyed by the fact that whenever you spawn a process in Java you have to create two or three \"pumper\" threads (for every process) to pull data out of the stdout and stderr pipes and pump data into stdin? If your code starts a lot of processes you can have dozens or hundreds of threads doing nothing but pumping data.", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r490439137", "createdAt": "2020-09-17T17:35:17Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -98,6 +92,36 @@ public void start(Handler<AsyncResult<Void>> startFuture) {\n     }\n   }\n \n+  private static Process launch(Vertx vertx, String id, EnvEntry[] env,\n+                                String [] command) throws IOException {\n+\n+    ProcessBuilder pb = new ProcessBuilder(command);\n+    if (env != null) {\n+      Map<String, String> penv = pb.environment();\n+      for (EnvEntry nv : env) {\n+        penv.put(nv.getName(), nv.getValue());\n+      }\n+    }\n+    Process process = pb.start();\n+    captureStream(vertx, id, process.getInputStream());\n+    captureStream(vertx, id, process.getErrorStream());\n+    return process;\n+  }\n+\n+  private static void captureStream(Vertx vertx, String id, InputStream input) {\n+    vertx.executeBlocking(res -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5fac4836d287f0e1e02414673faa2c10885b19b"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MDcxNw==", "bodyText": "Thx. I'll look for another capture approach.", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r490840717", "createdAt": "2020-09-18T10:03:08Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -98,6 +92,36 @@ public void start(Handler<AsyncResult<Void>> startFuture) {\n     }\n   }\n \n+  private static Process launch(Vertx vertx, String id, EnvEntry[] env,\n+                                String [] command) throws IOException {\n+\n+    ProcessBuilder pb = new ProcessBuilder(command);\n+    if (env != null) {\n+      Map<String, String> penv = pb.environment();\n+      for (EnvEntry nv : env) {\n+        penv.put(nv.getName(), nv.getValue());\n+      }\n+    }\n+    Process process = pb.start();\n+    captureStream(vertx, id, process.getInputStream());\n+    captureStream(vertx, id, process.getErrorStream());\n+    return process;\n+  }\n+\n+  private static void captureStream(Vertx vertx, String id, InputStream input) {\n+    vertx.executeBlocking(res -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQzOTEzNw=="}, "originalCommit": {"oid": "b5fac4836d287f0e1e02414673faa2c10885b19b"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MzEzODIzOnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMTowMTowN1rOHV0xcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMToxMDo1N1rOHV1EXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY0Njc3MA==", "bodyText": "This should not use the Charset of the server where Okapi runs but StandardCharsets.UTF_8.", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r492646770", "createdAt": "2020-09-22T11:01:07Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -98,6 +92,47 @@ public void start(Handler<AsyncResult<Void>> startFuture) {\n     }\n   }\n \n+  @Override\n+  public void onStdout(ByteBuffer buffer, boolean closed) {\n+    byte[] bytes = new byte[buffer.remaining()];\n+    buffer.get(bytes);\n+    String s = new String(bytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f3304ef2edf946f7b1b94864e4b648792b2349"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY1MTYxMg==", "bodyText": "ok. done", "url": "https://github.com/folio-org/okapi/pull/974#discussion_r492651612", "createdAt": "2020-09-22T11:10:57Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -98,6 +92,47 @@ public void start(Handler<AsyncResult<Void>> startFuture) {\n     }\n   }\n \n+  @Override\n+  public void onStdout(ByteBuffer buffer, boolean closed) {\n+    byte[] bytes = new byte[buffer.remaining()];\n+    buffer.get(bytes);\n+    String s = new String(bytes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY0Njc3MA=="}, "originalCommit": {"oid": "41f3304ef2edf946f7b1b94864e4b648792b2349"}, "originalPosition": 86}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 137, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}