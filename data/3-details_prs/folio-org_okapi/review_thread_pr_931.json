{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NjQ2MzQ0", "number": 931, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxMzo1Mzo1NlrOEBXvrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowNDozOFrOEBlBRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5ODczMDcwOnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxMzo1Mzo1NlrOGdLUMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNzowMTo1NVrOGdSjdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI0NzI4Mg==", "bodyText": "Please don't import MainVerticle which also includes ProxyService. Can you move all CORS logic to a CorsHandler class? Which is this is then imported/used by ProxyService and MainVerticle.", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433247282", "createdAt": "2020-06-01T13:53:56Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -538,6 +539,18 @@ public void proxy(RoutingContext ctx) {\n           stream.resume();\n           return; // ctx already set up\n         }\n+\n+        // handle delegate CORS\n+        if (ctx.data().containsKey(MainVerticle.CHECK_DELEGATE_CORS)) {\n+          ctx.data().remove(MainVerticle.CHECK_DELEGATE_CORS);\n+          if (l.stream().anyMatch(mi -> mi.isHandler() && mi.getRoutingEntry().isDelegateCors())) {\n+            ctx.data().put(MainVerticle.DELEGATE_CORS, true);\n+            stream.resume();\n+            ctx.reroute(ctx.request().path());\n+            return;\n+          }\n+        }\n+\n         pc.setModList(l);\n \n         pc.logRequest(ctx, tenantId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66afdd13d8ff1fccaac05932e3907d582ade6785"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM2NTg3Ng==", "bodyText": "Done.", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433365876", "createdAt": "2020-06-01T17:01:55Z", "author": {"login": "hjiebsco"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -538,6 +539,18 @@ public void proxy(RoutingContext ctx) {\n           stream.resume();\n           return; // ctx already set up\n         }\n+\n+        // handle delegate CORS\n+        if (ctx.data().containsKey(MainVerticle.CHECK_DELEGATE_CORS)) {\n+          ctx.data().remove(MainVerticle.CHECK_DELEGATE_CORS);\n+          if (l.stream().anyMatch(mi -> mi.isHandler() && mi.getRoutingEntry().isDelegateCors())) {\n+            ctx.data().put(MainVerticle.DELEGATE_CORS, true);\n+            stream.resume();\n+            ctx.reroute(ctx.request().path());\n+            return;\n+          }\n+        }\n+\n         pc.setModList(l);\n \n         pc.logRequest(ctx, tenantId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI0NzI4Mg=="}, "originalCommit": {"oid": "66afdd13d8ff1fccaac05932e3907d582ade6785"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDkwMDk1OnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/MainVerticle.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowMTowOVrOGdggzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzoyNzo0NFrOGdg3UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDU3NQ==", "bodyText": "Typo \"Hanlder\"", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433594575", "createdAt": "2020-06-02T03:01:09Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/MainVerticle.java", "diffHunk": "@@ -352,26 +350,9 @@ private void checkSuperTenant(String okapiModule, Promise<Void> promise) {\n   private Future<Void> startListening() {\n     Router router = Router.router(vertx);\n     logger.debug(\"Setting up routes\");\n+\n     //handle CORS\n-    router.route().handler(CorsHandler.create(\"*\")\n-        .allowedMethod(HttpMethod.PUT)\n-        .allowedMethod(HttpMethod.DELETE)\n-        .allowedMethod(HttpMethod.GET)\n-        .allowedMethod(HttpMethod.POST)\n-        //allow request headers\n-        .allowedHeader(HttpHeaders.CONTENT_TYPE.toString())\n-        .allowedHeader(XOkapiHeaders.TENANT)\n-        .allowedHeader(XOkapiHeaders.TOKEN)\n-        .allowedHeader(XOkapiHeaders.AUTHORIZATION)\n-        .allowedHeader(XOkapiHeaders.REQUEST_ID) //expose response headers\n-        .allowedHeader(XOkapiHeaders.MODULE_ID)\n-        .exposedHeader(HttpHeaders.LOCATION.toString())\n-        .exposedHeader(XOkapiHeaders.TRACE)\n-        .exposedHeader(XOkapiHeaders.TOKEN)\n-        .exposedHeader(XOkapiHeaders.AUTHORIZATION)\n-        .exposedHeader(XOkapiHeaders.REQUEST_ID)\n-        .exposedHeader(XOkapiHeaders.MODULE_ID)\n-    );\n+    CorsHelper.addCorsHanlder(router);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYwMDMzNw==", "bodyText": "Fixed.", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433600337", "createdAt": "2020-06-02T03:27:44Z", "author": {"login": "hjiebsco"}, "path": "okapi-core/src/main/java/org/folio/okapi/MainVerticle.java", "diffHunk": "@@ -352,26 +350,9 @@ private void checkSuperTenant(String okapiModule, Promise<Void> promise) {\n   private Future<Void> startListening() {\n     Router router = Router.router(vertx);\n     logger.debug(\"Setting up routes\");\n+\n     //handle CORS\n-    router.route().handler(CorsHandler.create(\"*\")\n-        .allowedMethod(HttpMethod.PUT)\n-        .allowedMethod(HttpMethod.DELETE)\n-        .allowedMethod(HttpMethod.GET)\n-        .allowedMethod(HttpMethod.POST)\n-        //allow request headers\n-        .allowedHeader(HttpHeaders.CONTENT_TYPE.toString())\n-        .allowedHeader(XOkapiHeaders.TENANT)\n-        .allowedHeader(XOkapiHeaders.TOKEN)\n-        .allowedHeader(XOkapiHeaders.AUTHORIZATION)\n-        .allowedHeader(XOkapiHeaders.REQUEST_ID) //expose response headers\n-        .allowedHeader(XOkapiHeaders.MODULE_ID)\n-        .exposedHeader(HttpHeaders.LOCATION.toString())\n-        .exposedHeader(XOkapiHeaders.TRACE)\n-        .exposedHeader(XOkapiHeaders.TOKEN)\n-        .exposedHeader(XOkapiHeaders.AUTHORIZATION)\n-        .exposedHeader(XOkapiHeaders.REQUEST_ID)\n-        .exposedHeader(XOkapiHeaders.MODULE_ID)\n-    );\n+    CorsHelper.addCorsHanlder(router);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDU3NQ=="}, "originalCommit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDkwMjY2OnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/util/CorsHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowMjozN1rOGdgh9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzoyNzo1NFrOGdg3dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDg2OA==", "bodyText": "See above comment about typo", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433594868", "createdAt": "2020-06-02T03:02:37Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/util/CorsHelper.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.folio.okapi.util;\n+\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.CorsHandler;\n+import java.util.List;\n+import org.folio.okapi.bean.ModuleInstance;\n+import org.folio.okapi.common.XOkapiHeaders;\n+\n+/**\n+ * Customized CORS handling.\n+ *\n+ * <p>If a module API specifies <b>delegateCORS</b> to true in RAML, Okapi will\n+ * delegate CORS handling to the module if and only if the API is invoked\n+ * through {@code /_/invoke/tenant/<tenantId>/moduleAPI}\n+ */\n+public class CorsHelper {\n+\n+  private static final String CHECK_DELEGATE_CORS = \"check-delegate-CORS\";\n+  private static final String DELEGATE_CORS = \"delegate-CORS\";\n+\n+  private CorsHelper() {\n+  }\n+\n+  /**\n+   * Add CORS handler to {@link Router}.\n+   *\n+   * @param router - {@link Router}\n+   */\n+  public static void addCorsHanlder(Router router) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYwMDM3Mw==", "bodyText": "Fixed.", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433600373", "createdAt": "2020-06-02T03:27:54Z", "author": {"login": "hjiebsco"}, "path": "okapi-core/src/main/java/org/folio/okapi/util/CorsHelper.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.folio.okapi.util;\n+\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpMethod;\n+import io.vertx.ext.web.Router;\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.CorsHandler;\n+import java.util.List;\n+import org.folio.okapi.bean.ModuleInstance;\n+import org.folio.okapi.common.XOkapiHeaders;\n+\n+/**\n+ * Customized CORS handling.\n+ *\n+ * <p>If a module API specifies <b>delegateCORS</b> to true in RAML, Okapi will\n+ * delegate CORS handling to the module if and only if the API is invoked\n+ * through {@code /_/invoke/tenant/<tenantId>/moduleAPI}\n+ */\n+public class CorsHelper {\n+\n+  private static final String CHECK_DELEGATE_CORS = \"check-delegate-CORS\";\n+  private static final String DELEGATE_CORS = \"delegate-CORS\";\n+\n+  private CorsHelper() {\n+  }\n+\n+  /**\n+   * Add CORS handler to {@link Router}.\n+   *\n+   * @param router - {@link Router}\n+   */\n+  public static void addCorsHanlder(Router router) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NDg2OA=="}, "originalCommit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMDkwNTY0OnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/raml/RoutingEntry.json", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzowNDozOFrOGdgjuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMzoyODowMlrOGdg3ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NTMyMQ==", "bodyText": "consider mentioning that this only applies to calls made via /_/invoke/tenant/<tid>/<path>", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433595321", "createdAt": "2020-06-02T03:04:38Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/raml/RoutingEntry.json", "diffHunk": "@@ -68,6 +68,10 @@\n       \"items\": {\n         \"type\": \"string\"\n       }\n+    },\n+    \"delegateCORS\": {\n+      \"description\": \"Okapi handles CORS by default. Set to true to delegate CORS handling to the module\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYwMDM5NA==", "bodyText": "Added.", "url": "https://github.com/folio-org/okapi/pull/931#discussion_r433600394", "createdAt": "2020-06-02T03:28:02Z", "author": {"login": "hjiebsco"}, "path": "okapi-core/src/main/raml/RoutingEntry.json", "diffHunk": "@@ -68,6 +68,10 @@\n       \"items\": {\n         \"type\": \"string\"\n       }\n+    },\n+    \"delegateCORS\": {\n+      \"description\": \"Okapi handles CORS by default. Set to true to delegate CORS handling to the module\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU5NTMyMQ=="}, "originalCommit": {"oid": "add1a2af02024965b0dd8421a290859defa5df3d"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 247, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}