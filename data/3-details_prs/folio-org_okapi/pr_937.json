{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNjg1MTE2", "number": 937, "title": "OKAPI-835 secure APIs is by default", "bodyText": "All end points now have a required permission.", "createdAt": "2020-06-10T20:33:07Z", "url": "https://github.com/folio-org/okapi/pull/937", "merged": true, "mergeCommit": {"oid": "015b5a4a5a8d01916407aee514528812f17bad43"}, "closed": true, "closedAt": "2020-07-03T08:29:01Z", "author": {"login": "adamdickmeiss"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpleI1gH2gAyNDMyNjg1MTE2OjM5MTFkN2E5OTJkZGE1ZDk5Mjk3OWFkNDA5NTA3ODBiMzAzMGY0ZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcw-fmygH2gAyNDMyNjg1MTE2OmEzYjU2YWVhMjEyNDI4MjlkNzM2ZWMwMDYyNmUxNzU4ZDU4YjYwMmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3911d7a992dda5d992979ad40950780b3030f4de", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/3911d7a992dda5d992979ad40950780b3030f4de", "committedDate": "2020-06-09T13:56:23Z", "message": "Secure OKAPI internal APIs OKAPI-835\n\nDoes not pass yet."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2c43708165d40fdcaf3605608308436b5a9627f", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/d2c43708165d40fdcaf3605608308436b5a9627f", "committedDate": "2020-06-10T20:01:55Z", "message": "Missing use of token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75fdeff7efb2aa15b5745e75f9b9715e12215447", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/75fdeff7efb2aa15b5745e75f9b9715e12215447", "committedDate": "2020-06-10T20:31:07Z", "message": "Complete; set version to 4.0.0-SNAPSHOT OKAPI-835"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c11efe2e572b42aacdd695f186e3296d627a462", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/8c11efe2e572b42aacdd695f186e3296d627a462", "committedDate": "2020-06-10T20:34:16Z", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDU3Mjgx", "url": "https://github.com/folio-org/okapi/pull/937#pullrequestreview-428457281", "createdAt": "2020-06-10T21:58:14Z", "commit": {"oid": "8c11efe2e572b42aacdd695f186e3296d627a462"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMTo1ODoxNFrOGiHtww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMTo1ODoxNFrOGiHtww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQzMTE3MQ==", "bodyText": "Can you fix the comment in lines 98-101?", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438431171", "createdAt": "2020-06-10T21:58:14Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/InternalModule.java", "diffHunk": "@@ -216,12 +216,12 @@ public static ModuleDescriptor moduleDescriptor(String okapiVersion) {\n         + \"   }, {\"\n         + \"    \\\"methods\\\" :  [ \\\"GET\\\" ],\"\n         + \"    \\\"pathPattern\\\" : \\\"/_/proxy/modules\\\",\"\n-        + \"    \\\"permissionsRequired\\\" : [ ], \"\n+        + \"    \\\"permissionsRequired\\\" : [ \\\"okapi.proxy.modules.list\\\" ], \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c11efe2e572b42aacdd695f186e3296d627a462"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDU3NzMx", "url": "https://github.com/folio-org/okapi/pull/937#pullrequestreview-428457731", "createdAt": "2020-06-10T21:59:12Z", "commit": {"oid": "8c11efe2e572b42aacdd695f186e3296d627a462"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NTc5ODA2", "url": "https://github.com/folio-org/okapi/pull/937#pullrequestreview-428579806", "createdAt": "2020-06-11T04:11:53Z", "commit": {"oid": "8c11efe2e572b42aacdd695f186e3296d627a462"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf45a5712218bbe6cb6aedcafd4f567f741ce8d3", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/bf45a5712218bbe6cb6aedcafd4f567f741ce8d3", "committedDate": "2020-06-11T07:49:24Z", "message": "permissionSets and okapi.readonly set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5304b75137b6b5500d3f391ef3493b4951b57b32", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/5304b75137b6b5500d3f391ef3493b4951b57b32", "committedDate": "2020-06-11T09:35:46Z", "message": "Rework inspection of tenant permissions results in tests\n\nThe X-Tenant-Perms-Result was used to return permissions that\nwere posted (_tenantPermissions). A very bad idea when permissions\ncan become larger than 8k. Instead header module has a service\nto retrieve most recently permissions (/permResult)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcceeaf4eed0fdabb880fafe0af0f1b18b905e24", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/fcceeaf4eed0fdabb880fafe0af0f1b18b905e24", "committedDate": "2020-06-11T09:48:51Z", "message": "Remove useless curly brace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c", "committedDate": "2020-06-11T10:28:30Z", "message": "Test trace header for system call"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTI5NjI2", "url": "https://github.com/folio-org/okapi/pull/937#pullrequestreview-428929626", "createdAt": "2020-06-11T13:46:43Z", "commit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo0Njo0M1rOGieBjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo0Njo0M1rOGieBjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NjY4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .extract().body().asString();\n          \n          \n            \n            \n          \n          \n            \n                JsonArray ar = new JsonArray(body);\n          \n          \n            \n                context.assertEquals(2, ar.size());\n          \n          \n            \n                context.assertEquals(\"okapi-0.0.0\", ar.getJsonObject(0).getString(\"moduleId\"));\n          \n          \n            \n                context.assertEquals(\"header-1\", ar.getJsonObject(1).getString(\"moduleId\"));\n          \n          \n            \n                .body(\"$\", hasSize(2))\n          \n          \n            \n                .body(\"[0].moduleId\", is(\"okapi-0.0.0\"))\n          \n          \n            \n                .body(\"[1].moduleId\", is(\"header-1\"));\n          \n      \n    \n    \n  \n\nRestAssured has JSON path (GPath syntax) support. Simply use a recent RestAssured version, put RestAssured.defaultParser = Parser.JSON; into setUp, and import the hamcrest matcher:\n+import static org.hamcrest.collection.IsCollectionWithSize.hasSize;\n+import static org.hamcrest.Matchers.is;", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438796684", "createdAt": "2020-06-11T13:46:43Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/test/java/org/folio/okapi/ModuleTest.java", "diffHunk": "@@ -1241,12 +1250,21 @@ public void testSystemInterfaces(TestContext context) {\n       .log().ifValidationFails()\n       .extract().headers();\n     final String locHdrEnable = headers.getValue(\"Location\");\n-    List<Header> list = headers.getList(\"X-Tenant-Perms-Result\");\n-    Assert.assertEquals(2, list.size()); // one for okapi, one for header-1\n-    Assert.assertThat(\"okapi perm result\",\n-      list.get(0).getValue(), containsString(\"okapi.all\"));\n-    Assert.assertThat(\"header-1perm result\",\n-      list.get(1).getValue(), containsString(\"header-1\"));\n+    // one trace from Okapi, two from the header module since it's called twice\n+    context.assertEquals(3, headers.getValues(\"X-Okapi-Trace\").size());\n+\n+    String body = given()\n+        .header(\"X-Okapi-Tenant\", okapiTenant)\n+        .get(\"/permResult\")\n+        .then()\n+        .statusCode(200)\n+        .log().ifValidationFails()\n+        .extract().body().asString();\n+\n+    JsonArray ar = new JsonArray(body);\n+    context.assertEquals(2, ar.size());\n+    context.assertEquals(\"okapi-0.0.0\", ar.getJsonObject(0).getString(\"moduleId\"));\n+    context.assertEquals(\"header-1\", ar.getJsonObject(1).getString(\"moduleId\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTM0MTQ5", "url": "https://github.com/folio-org/okapi/pull/937#pullrequestreview-428934149", "createdAt": "2020-06-11T13:51:06Z", "commit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo1MTowN1rOGieQ3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo1MTowN1rOGieQ3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMDYwNw==", "bodyText": "encode() does not guarantee the order of the keys. You probably want to compare without encode().", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438800607", "createdAt": "2020-06-11T13:51:07Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/test/java/org/folio/okapi/ModuleTest.java", "diffHunk": "@@ -1330,9 +1348,20 @@ public void testSystemInterfaces(TestContext context) {\n       .then()\n       .statusCode(201)\n       .log().ifValidationFails()\n-      .header(\"X-Tenant-Perms-Result\", expPerms)\n       .extract().header(\"Location\");\n \n+    body = given()\n+        .header(\"X-Okapi-Tenant\", okapiTenant)\n+        .get(\"/permResult\")\n+        .then()\n+        .statusCode(200)\n+        .log().ifValidationFails()\n+        .extract().body().asString();\n+\n+    ar = new JsonArray(body);\n+    context.assertEquals(1, ar.size());\n+    context.assertEquals(new JsonObject(expPerms).encode(), ar.getJsonObject(0).encode());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTM0NjI3", "url": "https://github.com/folio-org/okapi/pull/937#pullrequestreview-428934627", "createdAt": "2020-06-11T13:51:37Z", "commit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo1MTozN1rOGieS0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo1MTozN1rOGieS0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMTEwNQ==", "bodyText": "encode() does not guarantee the order of the keys. You probably want to compare without encode().", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438801105", "createdAt": "2020-06-11T13:51:37Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/test/java/org/folio/okapi/ModuleTest.java", "diffHunk": "@@ -1361,9 +1390,20 @@ public void testSystemInterfaces(TestContext context) {\n       .then()\n       .statusCode(201)\n       .log().ifValidationFails()\n-      .header(\"X-Tenant-Perms-Result\", expPerms2)\n       .extract().header(\"Location\");\n \n+    body = given()\n+        .header(\"X-Okapi-Tenant\", okapiTenant)\n+        .get(\"/permResult\")\n+        .then()\n+        .statusCode(200)\n+        .log().ifValidationFails()\n+        .extract().body().asString();\n+\n+    ar = new JsonArray(body);\n+    context.assertEquals(1, ar.size());\n+    context.assertEquals(new JsonObject(expPerms2).encode(), ar.getJsonObject(0).encode());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTM0Nzg3", "url": "https://github.com/folio-org/okapi/pull/937#pullrequestreview-428934787", "createdAt": "2020-06-11T13:51:48Z", "commit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo1MTo0OFrOGieTeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo1MTo0OFrOGieTeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMTI3Mg==", "bodyText": "encode() does not guarantee the order of the keys. You probably want to compare without encode().", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438801272", "createdAt": "2020-06-11T13:51:48Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/test/java/org/folio/okapi/ModuleTest.java", "diffHunk": "@@ -1420,8 +1460,20 @@ public void testSystemInterfaces(TestContext context) {\n       .then()\n       .statusCode(201)\n       .log().ifValidationFails()\n-      .header(\"X-Tenant-Perms-Result\", expPerms)\n       .extract().header(\"Location\");\n+\n+    body = given()\n+        .header(\"X-Okapi-Tenant\", okapiTenant)\n+        .get(\"/permResult\")\n+        .then()\n+        .statusCode(200)\n+        .log().ifValidationFails()\n+        .extract().body().asString();\n+\n+    ar = new JsonArray(body);\n+    context.assertEquals(2, ar.size());\n+    context.assertEquals(new JsonObject(expPerms).encode(), ar.getJsonObject(1).encode());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c"}, "originalPosition": 146}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTM2NzM4", "url": "https://github.com/folio-org/okapi/pull/937#pullrequestreview-428936738", "createdAt": "2020-06-11T13:53:53Z", "commit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo1Mzo1M1rOGiebtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzo1Mzo1M1rOGiebtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgwMzM4Mw==", "bodyText": "encode() does not guarantee the order of the keys. You probably want to compare without encode().", "url": "https://github.com/folio-org/okapi/pull/937#discussion_r438803383", "createdAt": "2020-06-11T13:53:53Z", "author": {"login": "julianladisch"}, "path": "okapi-test-header-module/src/test/java/HeaderModuleTest.java", "diffHunk": "@@ -78,11 +81,19 @@ public void test3(TestContext context, Async async) {\n     HashMap<String, String> headers = new HashMap<>();\n \n     OkapiClient cli = new OkapiClient(URL, vertx, headers);\n-    cli.post(\"/_/tenantPermissions\", \"a, b,\\nc\", res -> {\n-      cli.close();\n-      context.assertTrue(res.succeeded());\n-      context.assertEquals(\"a, b, c\", cli.getRespHeaders().get(\"X-Tenant-Perms-Result\"));\n-      async.complete();\n+    cli.post(\"/_/tenantPermissions\", \"{\", res1 -> {\n+      context.assertTrue(res1.failed());\n+      JsonObject perm = new JsonObject(\"{\\\"k\\\": \\\"v\\\"}\");\n+      cli.post(\"/_/tenantPermissions\", perm.encode(), res2 -> {\n+        context.assertTrue(res2.succeeded());\n+        context.assertEquals(\"GET test-header-module /_/tenantPermissions 200 -\",\n+            cli.getRespHeaders().get(XOkapiHeaders.TRACE));\n+        cli.get(\"/permResult\", res3 -> {\n+          cli.close();\n+          context.assertEquals(perm.encode(), new JsonArray(res3.result()).getJsonObject(0).encode());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99bff29bac49f4d74259dfdc8e30e2ec5ca5d43c"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dc7e6444ecb280894902e9685e1838bdf99001e", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/0dc7e6444ecb280894902e9685e1838bdf99001e", "committedDate": "2020-06-17T08:52:38Z", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bf792bdf16673180a247909b4fbe01c7cfc3903", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/3bf792bdf16673180a247909b4fbe01c7cfc3903", "committedDate": "2020-06-18T08:01:50Z", "message": "Merge remote-tracking branch 'origin/master' into OKAPI-835-secure-APIs-by-default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0daa51de370764ba01a683715878eceb254e62d6", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/0daa51de370764ba01a683715878eceb254e62d6", "committedDate": "2020-06-19T10:44:54Z", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7bf60ff89051dc6e851ce699a4037e6a57fa7d4", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/e7bf60ff89051dc6e851ce699a4037e6a57fa7d4", "committedDate": "2020-06-24T16:34:38Z", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ae39d188f4c06e77868c7a60ae62b50e9f31234", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/0ae39d188f4c06e77868c7a60ae62b50e9f31234", "committedDate": "2020-07-01T18:21:56Z", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3b56aea21242829d736ec00626e1758d58b602e", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/a3b56aea21242829d736ec00626e1758d58b602e", "committedDate": "2020-07-02T13:03:05Z", "message": "Merge branch 'master' into OKAPI-835-secure-APIs-by-default"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2974, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}