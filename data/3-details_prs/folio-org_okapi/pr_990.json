{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MDgwMTYz", "number": 990, "title": "OKAPI-911: Unit test failures for ProcessModuleHandleTest", "bodyText": "", "createdAt": "2020-10-07T08:36:52Z", "url": "https://github.com/folio-org/okapi/pull/990", "merged": true, "mergeCommit": {"oid": "d33bf351a4f1bc90dffea9ec497f36a690dda37a"}, "closed": true, "closedAt": "2020-10-09T08:18:31Z", "author": {"login": "adamdickmeiss"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQIy1FgH2gAyNDk5MDgwMTYzOmFjYTBjNTFkMjFiYWU1YmIyNzcxNmFjNmNhNWU5MmY4MWE5NTJiYmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQxlJogH2gAyNDk5MDgwMTYzOjk1OTQ0MWVlNTE3YWMzMzMxMGZmYjYzZGY4YzA1MTU1NTdiMGY1Y2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aca0c51d21bae5bb27716ac6ca5e92f81a952bbb", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/aca0c51d21bae5bb27716ac6ca5e92f81a952bbb", "committedDate": "2020-10-07T08:34:47Z", "message": "Test double start+stop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92484ab9c9cf46e4ef3a80a1f179eddd8f5c4522", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/92484ab9c9cf46e4ef3a80a1f179eddd8f5c4522", "committedDate": "2020-10-07T08:34:51Z", "message": "Avoid executeBlocking for ProcessModuleHandle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e2465576a0ea44fe8697372d6fbf508d25a8e7f", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/7e2465576a0ea44fe8697372d6fbf508d25a8e7f", "committedDate": "2020-10-07T09:03:20Z", "message": "No need to wait for cmdineStop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d1265d08d64f3dfbd4aa53c51567490e6ad44d2", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/6d1265d08d64f3dfbd4aa53c51567490e6ad44d2", "committedDate": "2020-10-07T17:25:07Z", "message": "Shut down that NetClient for each tryConnect attempt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87e886738bec5cea8137cb09a6a9573e83a2df09", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/87e886738bec5cea8137cb09a6a9573e83a2df09", "committedDate": "2020-10-08T08:05:29Z", "message": "Merge branch 'master' into OKAPI-911-unit-test-failures-for-process-module-handle-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a2d04b1c728930aab051bec2e87764f0348e1ed", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/0a2d04b1c728930aab051bec2e87764f0348e1ed", "committedDate": "2020-10-08T09:07:29Z", "message": "testExecMultiple: spawn 3 rather than 9 modules\n\nSpawning 9 takes a long time on slower systems which gives\ntest errors (when in reality waiting longer would make it succeed)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "361afa6474a222b8bbf607fc0906de10ab7af0ca", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/361afa6474a222b8bbf607fc0906de10ab7af0ca", "committedDate": "2020-10-08T09:10:14Z", "message": "Merge branch 'master' into OKAPI-911-unit-test-failures-for-process-module-handle-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b46c873d6504431e80178c4eb738670b402a1465", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/b46c873d6504431e80178c4eb738670b402a1465", "committedDate": "2020-10-08T13:34:43Z", "message": "Increase wait for install/deployment in InstallTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0ODQ0MzMw", "url": "https://github.com/folio-org/okapi/pull/990#pullrequestreview-504844330", "createdAt": "2020-10-08T14:28:45Z", "commit": {"oid": "b46c873d6504431e80178c4eb738670b402a1465"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNDoyODo0NVrOHehaFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNDoyODo0NVrOHehaFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc2NjY3Ng==", "bodyText": "Can you also remove the import of TimeUnit?", "url": "https://github.com/folio-org/okapi/pull/990#discussion_r501766676", "createdAt": "2020-10-08T14:28:45Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -125,48 +129,39 @@ private NuProcess launch(Vertx vertx, String id, EnvEntry[] env,\n     return process;\n   }\n \n-  @SuppressWarnings(\"indentation\")\n   private Future<Void> start2() {\n-    return vertx.executeBlocking(future -> {\n-      if (process == null) {\n-        String c = \"\";\n-        try {\n-          String[] l;\n-          if (exec != null) {\n-            if (!exec.contains(\"%p\")) {\n-              future.fail(\"Can not deploy: No %p in the exec line\");\n-              return;\n-            }\n-            c = exec.replace(\"%p\", Integer.toString(port));\n-            l = c.split(\" \");\n-          } else if (cmdlineStart != null) {\n-            if (!cmdlineStart.contains(\"%p\")) {\n-              future.fail(\"Can not deploy: No %p in the cmdlineStart\");\n-              return;\n-            }\n-            c = cmdlineStart.replace(\"%p\", Integer.toString(port));\n-            l = new String[]{\"sh\", \"-c\", c};\n-          } else {\n-            future.fail(\"Can not deploy: No exec, no CmdlineStart in LaunchDescriptor\");\n-            return;\n-          }\n-          process = launch(vertx, id, env, l);\n-          process.waitFor(1, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46c873d6504431e80178c4eb738670b402a1465"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0ODY2NjY5", "url": "https://github.com/folio-org/okapi/pull/990#pullrequestreview-504866669", "createdAt": "2020-10-08T14:49:51Z", "commit": {"oid": "b46c873d6504431e80178c4eb738670b402a1465"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNDo0OTo1MVrOHeibJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNDo0OTo1MVrOHeibJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4MzMzNA==", "bodyText": "A few lines below we have this code:\n  socket.close();\n  return Future.failedFuture(messages.getMessage(\"11502\", Integer.toString(port)));\n\nThis doesn't wait until the socket has been closed. Better:\n  return socket.close().otherwiseEmpty()\n      .compose(x -> Future.failedFuture(messages.getMessage(\"11502\", Integer.toString(port))));", "url": "https://github.com/folio-org/okapi/pull/990#discussion_r501783334", "createdAt": "2020-10-08T14:49:51Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -72,6 +73,9 @@ public ProcessModuleHandle(Vertx vertx, LaunchDescriptor desc, String id,\n \n   @Override\n   public Future<Void> start() {\n+    if (process != null) {\n+      return Future.failedFuture(\"already started \" + commandLine);\n+    }\n     if (port == 0) {\n       return start2();\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46c873d6504431e80178c4eb738670b402a1465"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0ODY5NTk3", "url": "https://github.com/folio-org/okapi/pull/990#pullrequestreview-504869597", "createdAt": "2020-10-08T14:52:28Z", "commit": {"oid": "361afa6474a222b8bbf607fc0906de10ab7af0ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0ODcyODQx", "url": "https://github.com/folio-org/okapi/pull/990#pullrequestreview-504872841", "createdAt": "2020-10-08T14:55:35Z", "commit": {"oid": "b46c873d6504431e80178c4eb738670b402a1465"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNDo1NTozNlrOHeitHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNDo1NTozNlrOHeitHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4NzkzMg==", "bodyText": "Easier to read:\nif (process.isRunning() || exitCode == 0) {\n  promise.complete();\n  return;\n}\nif (exitCode == Integer.MIN_VALUE) {\n  promise.fail(messages.getMessage(\"11504\", commandLineF));\n} else {\n  promise.fail(messages.getMessage(\"11500\", exitCode));\n}", "url": "https://github.com/folio-org/okapi/pull/990#discussion_r501787932", "createdAt": "2020-10-08T14:55:36Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/ProcessModuleHandle.java", "diffHunk": "@@ -125,48 +129,39 @@ private NuProcess launch(Vertx vertx, String id, EnvEntry[] env,\n     return process;\n   }\n \n-  @SuppressWarnings(\"indentation\")\n   private Future<Void> start2() {\n-    return vertx.executeBlocking(future -> {\n-      if (process == null) {\n-        String c = \"\";\n-        try {\n-          String[] l;\n-          if (exec != null) {\n-            if (!exec.contains(\"%p\")) {\n-              future.fail(\"Can not deploy: No %p in the exec line\");\n-              return;\n-            }\n-            c = exec.replace(\"%p\", Integer.toString(port));\n-            l = c.split(\" \");\n-          } else if (cmdlineStart != null) {\n-            if (!cmdlineStart.contains(\"%p\")) {\n-              future.fail(\"Can not deploy: No %p in the cmdlineStart\");\n-              return;\n-            }\n-            c = cmdlineStart.replace(\"%p\", Integer.toString(port));\n-            l = new String[]{\"sh\", \"-c\", c};\n-          } else {\n-            future.fail(\"Can not deploy: No exec, no CmdlineStart in LaunchDescriptor\");\n-            return;\n-          }\n-          process = launch(vertx, id, env, l);\n-          process.waitFor(1, TimeUnit.SECONDS);\n-        } catch (InterruptedException ex) {\n-          logger.warn(\"when starting {}\", c, ex);\n-          Thread.currentThread().interrupt();\n-        }\n-        if (!process.isRunning() && exitCode != 0) {\n-          if (exitCode == Integer.MIN_VALUE) {\n-            future.handle(Future.failedFuture(messages.getMessage(\"11504\", c)));\n-          } else {\n-            future.handle(Future.failedFuture(messages.getMessage(\"11500\", exitCode)));\n-          }\n-          return;\n+    commandLine = \"\";\n+    String[] l;\n+    if (exec != null) {\n+      if (!exec.contains(\"%p\")) {\n+        return Future.failedFuture(\"Can not deploy: No %p in the exec line\");\n+      }\n+      commandLine = exec.replace(\"%p\", Integer.toString(port));\n+      l = commandLine.split(\" \");\n+    } else if (cmdlineStart != null) {\n+      if (!cmdlineStart.contains(\"%p\")) {\n+        return Future.failedFuture(\"Can not deploy: No %p in the cmdlineStart\");\n+      }\n+      commandLine = cmdlineStart.replace(\"%p\", Integer.toString(port));\n+      l = new String[]{\"sh\", \"-c\", commandLine};\n+    } else {\n+      return Future.failedFuture(\"Can not deploy: No exec, no CmdlineStart in LaunchDescriptor\");\n+    }\n+    final String commandLineF = commandLine;\n+    process = launch(vertx, id, env, l);\n+    Promise<Void> promise = Promise.promise();\n+    vertx.setTimer(1000, timerRes -> {\n+      if (!process.isRunning() && exitCode != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b46c873d6504431e80178c4eb738670b402a1465"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e5bdd4dae769e1293d42351eca9344941931164", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/4e5bdd4dae769e1293d42351eca9344941931164", "committedDate": "2020-10-08T16:42:21Z", "message": "Unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbcd20f96bddecb0ba00afc38f6bcb4cbce718a4", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/fbcd20f96bddecb0ba00afc38f6bcb4cbce718a4", "committedDate": "2020-10-08T16:42:34Z", "message": "Wait for socket to close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4c6f24fc529082619a1dd26d05667379f235789", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/c4c6f24fc529082619a1dd26d05667379f235789", "committedDate": "2020-10-08T16:43:10Z", "message": "Wait 3 seconds for process stop/start wo port\n\nWHen there is a port, it is still 1 second, at which point\nthe exit code is checked if the process has shut down. If not,\nwhen a port is in use the system will wait for listener to\nbe present or be gone."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0OTgxNTIz", "url": "https://github.com/folio-org/okapi/pull/990#pullrequestreview-504981523", "createdAt": "2020-10-08T16:55:01Z", "commit": {"oid": "c4c6f24fc529082619a1dd26d05667379f235789"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77b16ea376255b1e349a88949f374259814524d1", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/77b16ea376255b1e349a88949f374259814524d1", "committedDate": "2020-10-08T17:03:14Z", "message": "Merge branch 'master' into OKAPI-911-unit-test-failures-for-process-module-handle-test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjI3MjUy", "url": "https://github.com/folio-org/okapi/pull/990#pullrequestreview-505227252", "createdAt": "2020-10-08T22:51:54Z", "commit": {"oid": "77b16ea376255b1e349a88949f374259814524d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b353c1b900b05d36fc5903a05dee4bade9c03e6", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/6b353c1b900b05d36fc5903a05dee4bade9c03e6", "committedDate": "2020-10-09T07:56:31Z", "message": "Wait for socket.close to complete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01f1d66f64e2466227466c260b221529a2922ff1", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/01f1d66f64e2466227466c260b221529a2922ff1", "committedDate": "2020-10-09T07:56:54Z", "message": "Merge branch 'OKAPI-911-unit-test-failures-for-process-module-handle-test' of github.com:folio-org/okapi into OKAPI-911-unit-test-failures-for-process-module-handle-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef16ed1bac3a5df99ce933dd5f3f1b7c4b4345a6", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/ef16ed1bac3a5df99ce933dd5f3f1b7c4b4345a6", "committedDate": "2020-10-09T07:57:18Z", "message": "Merge remote-tracking branch 'origin/master' into OKAPI-911-unit-test-failures-for-process-module-handle-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "959441ee517ac33310ffb63df8c0515557b0f5cf", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/959441ee517ac33310ffb63df8c0515557b0f5cf", "committedDate": "2020-10-09T08:05:57Z", "message": "Spelling"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2863, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}