{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTAwNDAy", "number": 892, "title": "OkapiToken faster; simpler API OKAPI-818", "bodyText": "", "createdAt": "2020-03-19T16:17:46Z", "url": "https://github.com/folio-org/okapi/pull/892", "merged": true, "mergeCommit": {"oid": "72e46a3222a0ef77beb40dc1e65177c515c2487d"}, "closed": true, "closedAt": "2020-04-01T14:10:23Z", "author": {"login": "adamdickmeiss"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPOU8zAH2gAyMzkxMTAwNDAyOmViMmFlYjg5YjA5ZjdlNDU1ZTRjZmE1M2U1OTEyNGY1NWU3OWQwMmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTX0qhgH2gAyMzkxMTAwNDAyOjlmMzU3NjNlZGY2Mzk0OGE2NTM0MGNjNDJlOTJiZmMwMTk5ZjMwMWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eb2aeb89b09f7e455e4cfa53e59124f55e79d02d", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/eb2aeb89b09f7e455e4cfa53e59124f55e79d02d", "committedDate": "2020-03-19T16:16:30Z", "message": "OkapiToken faster; simpler API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b9cc001f7a28d7804d594fae610481782e8adb2", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/3b9cc001f7a28d7804d594fae610481782e8adb2", "committedDate": "2020-03-19T20:01:28Z", "message": "Merge branch 'master' into faster-and-simpler-okapi-token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d04fc259fa5fe9b91d4b9eb9ce2cd4b3fb5ab89", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/4d04fc259fa5fe9b91d4b9eb9ce2cd4b3fb5ab89", "committedDate": "2020-03-20T20:36:42Z", "message": "Further test of token/authorization header checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3632cb0361f77d7f067dceea5844f4dfe2ba5773", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/3632cb0361f77d7f067dceea5844f4dfe2ba5773", "committedDate": "2020-03-20T20:37:08Z", "message": "Merge branch 'faster-and-simpler-okapi-token' of github.com:folio-org/okapi into faster-and-simpler-okapi-token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31c15649c96a4af8d4bcea90fa4d5413431e1d34", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/31c15649c96a4af8d4bcea90fa4d5413431e1d34", "committedDate": "2020-03-26T11:25:42Z", "message": "Merge branch 'master' into faster-and-simpler-okapi-token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/695b31918b439523d416890ed9c347ea0ec9f3d7", "committedDate": "2020-03-31T07:07:05Z", "message": "OKAPI-818: Move each exception test into its own test method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDU3Mjk1", "url": "https://github.com/folio-org/okapi/pull/892#pullrequestreview-384457295", "createdAt": "2020-03-31T07:14:05Z", "commit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNzoxNDowNlrOF-IMAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNzoxNDowNlrOF-IMAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY5MDE3OQ==", "bodyText": "I've moved the duplicated code into this method and moved each exception test into its own method.", "url": "https://github.com/folio-org/okapi/pull/892#discussion_r400690179", "createdAt": "2020-03-31T07:14:06Z", "author": {"login": "julianladisch"}, "path": "okapi-common/src/test/java/org/folio/okapi/common/OkapiTokenTest.java", "diffHunk": "@@ -1,99 +1,68 @@\n package org.folio.okapi.common;\n \n import io.vertx.core.json.JsonObject;\n-import org.junit.Test;\n-import static org.junit.Assert.*;\n import java.util.Base64;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n \n public class OkapiTokenTest {\n \n   @Test\n   public void test() {\n-    OkapiToken t = new OkapiToken();\n-\n     JsonObject o = new JsonObject();\n     o.put(\"tenant\", \"test-lib\");\n     o.put(\"foo\", \"bar\");\n     String s = o.encodePrettily();\n     byte[] encodedBytes = Base64.getEncoder().encode(s.getBytes());\n     String e = new String(encodedBytes);\n     String tokenStr = \"method.\" + e + \".trail\";\n-    t.setToken(tokenStr);\n-    assertEquals(\"test-lib\", t.getTenant());\n+    OkapiToken tok = new OkapiToken(tokenStr);\n+    Assert.assertEquals(\"test-lib\", tok.getTenant());\n   }\n \n   @Test\n-  public void test2() {\n-    String s = \"eyJzdWIiOiJfX3VuZGVmaW5lZF9fIiwidXNlcl9pZCI6Ijk5OTk5OTk5L\"\n-      + \"Tk5OTktNDk5OS05OTk5LTk5OTk5OTk5OTk5OSIsInRlbmFudCI6InRlc3RsaWIifQ\";\n-    byte[] buf = Base64.getDecoder().decode(s);\n-    String got = new String(buf);\n-    String exp = \"{\\\"sub\\\":\\\"__undefined__\\\",\"\n-      + \"\\\"user_id\\\":\\\"99999999-9999-4999-9999-999999999999\\\",\\\"tenant\\\":\\\"testlib\\\"}\";\n-    assertEquals(exp, got);\n+  public void noTenant() {\n+    OkapiToken tok = new OkapiToken(\"a.eyB9Cg==.c\"); // \"{ }\"\n+    Assert.assertNull(tok.getTenant());\n   }\n \n   @Test\n-  public void test3() {\n-    OkapiToken tok = new OkapiToken();\n-    tok.setToken(null);\n-    assertEquals(null, tok.getTenant());\n-\n-    Boolean ex;\n+  public void testNull() {\n+    OkapiToken tok = new OkapiToken(null);\n+    Assert.assertEquals(null, tok.getTenant());\n+  }\n \n-    ex = false;\n-    tok.setToken(\"\");\n-    try {\n-      String v = tok.getTenant();\n-    } catch (IllegalArgumentException e) {\n-      ex = true;\n-    }\n-    assertTrue(ex);\n+  private String exceptionMessage(String token) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDY2NjM4", "url": "https://github.com/folio-org/okapi/pull/892#pullrequestreview-384466638", "createdAt": "2020-03-31T07:28:58Z", "commit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNzoyODo1OFrOF-Ipmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNzoyODo1OFrOF-Ipmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY5Nzc1NA==", "bodyText": "https://tools.ietf.org/html/rfc6750#section-2.1 requires a single space after Bearer.\nCan you check for startsWith(\"Bearer \")?", "url": "https://github.com/folio-org/okapi/pull/892#discussion_r400697754", "createdAt": "2020-03-31T07:28:58Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -254,27 +252,24 @@ private String tenantHeader(ProxyContext pc) {\n     String tok = ctx.request().getHeader(XOkapiHeaders.TOKEN);\n \n     if (auth != null) {\n-      Pattern pattern = Pattern.compile(\"Bearer\\\\s+(.+)\"); // Grab anything after 'Bearer' and whitespace\n-      Matcher matcher = pattern.matcher(auth);\n-      if (matcher.find() && matcher.groupCount() > 0) {\n-        auth = matcher.group(1);\n+      if (auth.startsWith(\"Bearer\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NTQ4MDU0", "url": "https://github.com/folio-org/okapi/pull/892#pullrequestreview-384548054", "createdAt": "2020-03-31T09:18:03Z", "commit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwOToxODowM1rOF-MoFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwOToxODowM1rOF-MoFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc2MjkwMA==", "bodyText": "Can you drop this else to reduce indentation?", "url": "https://github.com/folio-org/okapi/pull/892#discussion_r400762900", "createdAt": "2020-03-31T09:18:03Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -254,27 +252,24 @@ private String tenantHeader(ProxyContext pc) {\n     String tok = ctx.request().getHeader(XOkapiHeaders.TOKEN);\n \n     if (auth != null) {\n-      Pattern pattern = Pattern.compile(\"Bearer\\\\s+(.+)\"); // Grab anything after 'Bearer' and whitespace\n-      Matcher matcher = pattern.matcher(auth);\n-      if (matcher.find() && matcher.groupCount() > 0) {\n-        auth = matcher.group(1);\n+      if (auth.startsWith(\"Bearer\")) {\n+        auth = auth.substring(6).trim();\n+      }\n+      if (tok != null && !auth.equals(tok)) {\n+        pc.responseError(400, messages.getMessage(\"10104\"));\n+        return null;\n+      } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf4a88f800d7e00f06ad872f389b51cb440d777e", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/cf4a88f800d7e00f06ad872f389b51cb440d777e", "committedDate": "2020-03-31T11:09:42Z", "message": "Test for Bearer+blank; redundant else"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjQ0MDg3", "url": "https://github.com/folio-org/okapi/pull/892#pullrequestreview-384644087", "createdAt": "2020-03-31T11:34:26Z", "commit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMTozNDoyNlrOF-Ragg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMTozNDoyNlrOF-Ragg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg0MTM0Ng==", "bodyText": "This returns the payload without validating the JWT using the signature. This may be a security issue if used in other contexts.\nCan the method been renamed to getPayloadWithoutValidation and javadoc added that there is no JWT signature validation?", "url": "https://github.com/folio-org/okapi/pull/892#discussion_r400841346", "createdAt": "2020-03-31T11:34:26Z", "author": {"login": "julianladisch"}, "path": "okapi-common/src/main/java/org/folio/okapi/common/OkapiToken.java", "diffHunk": "@@ -15,25 +14,21 @@\n public class OkapiToken {\n   private String token;\n \n-  public OkapiToken() {\n-    this.token = null;\n-  }\n-\n-  public OkapiToken(RoutingContext ctx) {\n-    this.token = ctx.request().getHeader(XOkapiHeaders.TOKEN);\n-  }\n-\n-  public void setToken(String token) {\n+  public OkapiToken(String token) {\n     this.token = token;\n   }\n \n   private JsonObject getPayload() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjQ1MzUw", "url": "https://github.com/folio-org/okapi/pull/892#pullrequestreview-384645350", "createdAt": "2020-03-31T11:36:26Z", "commit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMTozNjoyN1rOF-Reig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMTozNjoyN1rOF-Reig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg0MjM3OA==", "bodyText": "You can avoid this variable and save 2 lines by using return new JsonObject(decodedJson);", "url": "https://github.com/folio-org/okapi/pull/892#discussion_r400842378", "createdAt": "2020-03-31T11:36:27Z", "author": {"login": "julianladisch"}, "path": "okapi-common/src/main/java/org/folio/okapi/common/OkapiToken.java", "diffHunk": "@@ -15,25 +14,21 @@\n public class OkapiToken {\n   private String token;\n \n-  public OkapiToken() {\n-    this.token = null;\n-  }\n-\n-  public OkapiToken(RoutingContext ctx) {\n-    this.token = ctx.request().getHeader(XOkapiHeaders.TOKEN);\n-  }\n-\n-  public void setToken(String token) {\n+  public OkapiToken(String token) {\n     this.token = token;\n   }\n \n   private JsonObject getPayload() {\n-    String encodedJson;\n-    try {\n-      encodedJson = this.token.split(\"\\\\.\")[1];\n-    } catch (ArrayIndexOutOfBoundsException e) {\n-      throw new IllegalArgumentException(e.getMessage());\n+    int idx1 = token.indexOf('.');\n+    if (idx1 == -1) {\n+      throw new IllegalArgumentException(\"Missing . separator for token\");\n+    }\n+    idx1++;\n+    int idx2 = token.indexOf('.', idx1);\n+    if (idx2 == -1) {\n+      throw new IllegalArgumentException(\"Missing . separator for token\");\n     }\n+    String encodedJson = token.substring(idx1, idx2);\n     String decodedJson = new String(Base64.getDecoder().decode(encodedJson));\n     JsonObject j;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "695b31918b439523d416890ed9c347ea0ec9f3d7"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4851e03e45efa6ecde6e6b3593cf2415d6f685c2", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/4851e03e45efa6ecde6e6b3593cf2415d6f685c2", "committedDate": "2020-03-31T17:49:40Z", "message": "Merge branch 'master' into faster-and-simpler-okapi-token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0bb3ead11d6ec6923dcce889c367600b60046f5", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/d0bb3ead11d6ec6923dcce889c367600b60046f5", "committedDate": "2020-03-31T17:59:04Z", "message": "Note on no JWT validation; rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc3769dac49036cd781837e02419f232faa1027e", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/dc3769dac49036cd781837e02419f232faa1027e", "committedDate": "2020-03-31T18:23:44Z", "message": "Avoid temporary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdece97a430eb94acf427ca0f1811da82720cd17", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/cdece97a430eb94acf427ca0f1811da82720cd17", "committedDate": "2020-03-31T18:24:02Z", "message": "Merge branch 'master' into faster-and-simpler-okapi-token"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTkwOTAz", "url": "https://github.com/folio-org/okapi/pull/892#pullrequestreview-385590903", "createdAt": "2020-04-01T13:35:46Z", "commit": {"oid": "cdece97a430eb94acf427ca0f1811da82720cd17"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f35763edf63948a65340cc42e92bfc0199f301d", "author": {"user": {"login": "julianladisch", "name": null}}, "url": "https://github.com/folio-org/okapi/commit/9f35763edf63948a65340cc42e92bfc0199f301d", "committedDate": "2020-04-01T13:35:59Z", "message": "Merge branch 'master' into faster-and-simpler-okapi-token"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2937, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}