{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNDQzNDkz", "number": 1024, "title": "Add support for dockerRegistries property in dist okapi.conf.", "bodyText": "OKAPI-934", "createdAt": "2020-10-29T17:31:34Z", "url": "https://github.com/folio-org/okapi/pull/1024", "merged": true, "mergeCommit": {"oid": "1f34deb033c485163787d180bebb750b202e5cc4"}, "closed": true, "closedAt": "2020-10-29T20:40:48Z", "author": {"login": "wafschneider"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXVo2RgH2gAyNTEyNDQzNDkzOjIxYTVlMGI3ZmEwOWIwNjgzYzRlNTM2NzA0MWY3NTg4OGRiNTc3ZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXYPZdAH2gAyNTEyNDQzNDkzOjY2MjIwZDQ2NTNjZGI5MmNmYmY5NDdmY2Q3YzY0M2VmMTY4MWU1MDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "21a5e0b7fa09b0683c4e5367041f75888db577de", "author": {"user": {"login": "wafschneider", "name": "Wayne Schneider"}}, "url": "https://github.com/folio-org/okapi/commit/21a5e0b7fa09b0683c4e5367041f75888db577de", "committedDate": "2020-10-29T17:30:07Z", "message": "Add support for dockerRegistries property in dist okapi.conf.\n\nOKAPI-934"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5OTQyMjEy", "url": "https://github.com/folio-org/okapi/pull/1024#pullrequestreview-519942212", "createdAt": "2020-10-29T18:07:14Z", "commit": {"oid": "21a5e0b7fa09b0683c4e5367041f75888db577de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODowNzoxNFrOHqobGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODowNzoxNFrOHqobGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ2NDUzOA==", "bodyText": "The identitytoken that can be used in dockerRegistries should also been replaced by ...", "url": "https://github.com/folio-org/okapi/pull/1024#discussion_r514464538", "createdAt": "2020-10-29T18:07:14Z", "author": {"login": "julianladisch"}, "path": "dist/okapi.sh", "diffHunk": "@@ -17,42 +17,54 @@ fi\n DATA_DIR=\"${DATA_DIR:-/var/lib/okapi}\"\n LIB_DIR=\"${LIB_DIR:-/usr/share/folio/okapi/lib}\"\n OKAPI_JAR=\"${LIB_DIR}/okapi-core-fat.jar\"\n-# Copy from deprecated postgres_user into postgres_username\n-postgres_username=\"${postgres_username:-${postgres_user:-okapi}}\"\n \n parse_okapi_conf()  {\n \n-   # storage backend options\n-   if [ \"$role\" == \"dev\" ] || [ $role == \"cluster\" ]; then\n+   if [ \"$role\" == \"dev\" ] || [ \"$role\" == \"cluster\" ]; then\n \n+      # storage backend options\n       if [ \"$storage\" == \"postgres\" ]; then\n          OKAPI_JAVA_OPTS+=\" -Dstorage=postgres\"\n-         OKAPI_OPTIONS+=\" -conf ${PID_DIR}/okapi-postgres.conf\"\n-         rm -f \"${PID_DIR}/okapi-postgres.conf\" > /dev/null 2>&1\n-         touch \"${PID_DIR}/okapi-postgres.conf\"\n-         chmod 600 \"${PID_DIR}/okapi-postgres.conf\"\n-         # include postgres_server_pem only if defined (even if empty string)\n-         jq -n --arg WARNING \"AUTOMATICALLY CREATED FILE, DO NOT EDIT!\"  \\\n-               --arg postgres_host       \"${postgres_host:-localhost}\"   \\\n-               --arg postgres_port       \"${postgres_port:-5432}\"        \\\n-               --arg postgres_username   \"${postgres_username:-okapi}\"   \\\n-               --arg postgres_password   \"${postgres_password:-okapi25}\" \\\n-               --arg postgres_database   \"${postgres_database:-okapi}\"   \\\n-               --arg postgres_server_pem \"${postgres_server_pem}\"        \\\n-               \"{\\$WARNING,\n-                 \\$postgres_host,\n-                 \\$postgres_port,\n-                 \\$postgres_username,\n-                 \\$postgres_password,\n-                 \\$postgres_database\n-                 ${postgres_server_pem+,\\$postgres_server_pem}\n-               }\" > \"${PID_DIR}/okapi-postgres.conf\"\n-         echo \"${PID_DIR}/okapi-postgres.conf = \"\n-         cat \"${PID_DIR}/okapi-postgres.conf\" | sed 's/\\(\\\"\\postgres_password\":\\).*[^,]/\\1 .../g'\n+         # Copy from deprecated postgres_user into postgres_username\n+         postgres_username=\"${postgres_username:-${postgres_user:-okapi}}\"\n+         # Set other defaults\n+         postgres_host=\"${postgres_host:-localhost}\"\n+         postgres_port=\"${postgres_port:-5432}\"\n+         postgres_password=\"${postgres_password:-okapi25}\"\n+         postgres_database=\"${postgres_database:-okapi}\"\n       else\n          OKAPI_JAVA_OPTS+=\" -Dstorage=inmemory\"\n       fi\n \n+      # create runtime configuration file for sensitive information\n+      # Store auth here rather than exposing on command line\n+      if [ \"$storage\" == \"postgres\" ] || [ \"$docker_registries\" ]; then\n+         OKAPI_OPTIONS+=\" -conf ${PID_DIR}/okapi-runtime.conf\"\n+         rm -f \"${PID_DIR}/okapi-runtime.conf\" > /dev/null 2>&1\n+         touch \"${PID_DIR}/okapi-runtime.conf\"\n+         chmod 600 \"${PID_DIR}/okapi-runtime.conf\"\n+         # include postgres connection arguments only if defined\n+         jq -n --arg WARNING \"AUTOMATICALLY CREATED FILE, DO NOT EDIT!\"    \\\n+               --argjson dockerRegistries  \"${docker_registries:-[]}\"      \\\n+               --arg postgres_host         \"${postgres_host}\"              \\\n+               --arg postgres_port         \"${postgres_port}\"              \\\n+               --arg postgres_username     \"${postgres_username}\"          \\\n+               --arg postgres_password     \"${postgres_password}\"          \\\n+               --arg postgres_database     \"${postgres_database}\"          \\\n+               --arg postgres_server_pem   \"${postgres_server_pem}\"        \\\n+               \"{\\$WARNING,\n+                 \\$dockerRegistries\n+                 ${postgres_host+,\\$postgres_host}\n+                 ${postgres_port+,\\$postgres_port}\n+                 ${postgres_username+,\\$postgres_username}\n+                 ${postgres_password+,\\$postgres_password}\n+                 ${postgres_database+,\\$postgres_database}\n+                 ${postgres_server_pem+,\\$postgres_server_pem}\n+               }\" > \"${PID_DIR}/okapi-runtime.conf\"\n+         echo \"${PID_DIR}/okapi-runtime.conf = \"\n+         cat \"${PID_DIR}/okapi-runtime.conf\" | sed 's/\\(password\":\\).*[^,]/\\1 .../g'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21a5e0b7fa09b0683c4e5367041f75888db577de"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bafafe37718ea9f04a51a99dcad42e2050e5d40", "author": {"user": {"login": "wafschneider", "name": "Wayne Schneider"}}, "url": "https://github.com/folio-org/okapi/commit/1bafafe37718ea9f04a51a99dcad42e2050e5d40", "committedDate": "2020-10-29T18:35:38Z", "message": "In dist okapi.sh, blank out identitytoken value in the system log.\n\nTowards OKAPI-934"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5OTgxNDg1", "url": "https://github.com/folio-org/okapi/pull/1024#pullrequestreview-519981485", "createdAt": "2020-10-29T18:57:42Z", "commit": {"oid": "1bafafe37718ea9f04a51a99dcad42e2050e5d40"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66220d4653cdb92cfbf947fcd7c643ef1681e504", "author": {"user": {"login": "wafschneider", "name": "Wayne Schneider"}}, "url": "https://github.com/folio-org/okapi/commit/66220d4653cdb92cfbf947fcd7c643ef1681e504", "committedDate": "2020-10-29T20:32:02Z", "message": "Merge branch 'master' into OKAPI-934-dist-dockerRegistries"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2891, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}