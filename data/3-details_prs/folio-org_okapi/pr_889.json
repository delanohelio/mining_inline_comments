{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MTc1MzI3", "number": 889, "title": "Okapi 773 switch discovery only if all succeeds", "bodyText": "This PR improves coverage in general for install. It ensures that the tenant module association is not happening until all modules have been completing tenant init and tenant permissions interface. Of course, if the modules do not implement these interfaces, they will not be considered. Also if a module is not running at all, of course, also that stops upgrading. There's no switch for this. This changes behavior for the better, so a desired breaking change = bug fix.\nOut of scope of this issue:\nWe should extend the tenant interface with a rollback mechanism so that module can be notified to rollback if they have succeeded but another module has failed.\nFinally, we could do a pre-check tenant init which has no side effects but just let the module ack that it can do upgrade (without actually doing anything). https://issues.folio.org/browse/OKAPI-814", "createdAt": "2020-03-10T14:42:47Z", "url": "https://github.com/folio-org/okapi/pull/889", "merged": true, "mergeCommit": {"oid": "e0c6d8880fe1dc511ee06bb12c19fb46046e494b"}, "closed": true, "closedAt": "2020-03-19T10:44:56Z", "author": {"login": "adamdickmeiss"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcL9_FnAH2gAyMzg2MTc1MzI3OjhmMWM2MWU2Mzc4ODc3MDNlYzE1NjMyY2U3NjI3NWUyMDZkNWQzYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPJY8MAH2gAyMzg2MTc1MzI3OjdjYTViMjIxMTg3YjZkZTA2MGE2ZjQ4YmQzNjc3MWZjZjYzZTQxOTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f1c61e637887703ec15632ce76275e206d5d3a7", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/8f1c61e637887703ec15632ce76275e206d5d3a7", "committedDate": "2020-03-09T13:32:22Z", "message": "Fix SQ smells; refactor ProxyService.getNewIterator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbee244eb4d489011f189de1c5db49415e5adbd2", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/bbee244eb4d489011f189de1c5db49415e5adbd2", "committedDate": "2020-03-09T13:34:21Z", "message": "Make a few utilities static"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a85a674c95b50f541c9df3faf06587003170ba7", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/1a85a674c95b50f541c9df3faf06587003170ba7", "committedDate": "2020-03-10T09:26:07Z", "message": "Log version details in Okapi startup; more testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c4371d92d1c3906d4f397541b266824cd2db3ac", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/8c4371d92d1c3906d4f397541b266824cd2db3ac", "committedDate": "2020-03-10T11:04:17Z", "message": "For mode initdatabase, avoid exit\n\nThis allows us to test it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "135cbdc91c358e5a48d12cb40997b2fbb2f28526", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/135cbdc91c358e5a48d12cb40997b2fbb2f28526", "committedDate": "2020-03-10T11:31:45Z", "message": "Test initdatabase with bad credentials"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cdbf84f02c6e0adca1a65a954fc13c922e939e8", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/0cdbf84f02c6e0adca1a65a954fc13c922e939e8", "committedDate": "2020-03-10T12:08:47Z", "message": "fixing test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c228367720f124746f56aef01f4892f23517c40", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/4c228367720f124746f56aef01f4892f23517c40", "committedDate": "2020-03-10T12:32:37Z", "message": "Test purgedatabase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82b0bc016ed0d65ff5c6ed7cf859b2b85f6752fe", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/82b0bc016ed0d65ff5c6ed7cf859b2b85f6752fe", "committedDate": "2020-03-10T14:41:20Z", "message": "Switch modules for tenant only if all succeeds OKAPI-773"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4340d158c235fe1da31739454f743058e1978d37", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/4340d158c235fe1da31739454f743058e1978d37", "committedDate": "2020-03-10T14:53:16Z", "message": "Remove a few unused definitions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc29f3814b11bfdb1dcfc817ab199050ffe2e30e", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/cc29f3814b11bfdb1dcfc817ab199050ffe2e30e", "committedDate": "2020-03-11T10:01:32Z", "message": "Install always returns 400 if tenant init fails\n\nThe response body has more details WRT which module failed - including\nthe status code from it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5173be39ee8f52aa2effdc8c003f30957db4dd77", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/5173be39ee8f52aa2effdc8c003f30957db4dd77", "committedDate": "2020-03-11T10:14:01Z", "message": "Update auth test case ErrorType USER"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "651873e6cca300cb9119d5925bda39a14dda6035", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/651873e6cca300cb9119d5925bda39a14dda6035", "committedDate": "2020-03-11T10:25:14Z", "message": "Reorder headers and wondering abt java:S2275"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7d3715c7b95a55fd9091e1295f7a9ce1339aab7", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/e7d3715c7b95a55fd9091e1295f7a9ce1339aab7", "committedDate": "2020-03-11T10:33:32Z", "message": "no format for Throwable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a975c4f0d26324b416d49e4fc80121475faf5992", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/a975c4f0d26324b416d49e4fc80121475faf5992", "committedDate": "2020-03-11T10:52:01Z", "message": "Useless log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "719a911cd7970ec9a07cf379de5bdf04c7cdbf6e", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/719a911cd7970ec9a07cf379de5bdf04c7cdbf6e", "committedDate": "2020-03-11T10:52:47Z", "message": "ExtendedAsyncResult to Promise map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/0179852657bb4c6af67f96d67f2d67e3358d3360", "committedDate": "2020-03-11T11:01:13Z", "message": "Remove useless curly braces around statement"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTQ4NTU1", "url": "https://github.com/folio-org/okapi/pull/889#pullrequestreview-375148555", "createdAt": "2020-03-16T12:09:54Z", "commit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjowOTo1NFrOF2xELA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjowOTo1NFrOF2xELA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk3MTMwOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Json.encode(cli.getRespHeaders().entries()));\n          \n          \n            \n                    () -> Json.encode(cli.getRespHeaders().entries()));\n          \n      \n    \n    \n  \n\nAvoid encoding when debug logging is diabled.", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r392971308", "createdAt": "2020-03-16T12:09:54Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -1108,14 +1092,13 @@ private void authForSystemInterface(ModuleDescriptor authMod, RoutingEntry filt,\n     ModuleInstance authInst = new ModuleInstance(authMod, filt, inst.getPath(), HttpMethod.HEAD, inst.isHandler());\n     doCallSystemInterface(headers, tenantId, null, authInst, modPerms, \"\", res -> {\n       if (res.failed()) {\n-        logger.warn(\"Auth check for systemInterface failed!\");\n-        fut.handle(new Failure<>(res.getType(), res.cause()));\n+        fut.handle(res);\n         return;\n       }\n       OkapiClient cli = res.result();\n       String deftok = cli.getRespHeaders().get(XOkapiHeaders.TOKEN);\n-      logger.debug(\"authForSystemInterface:\"\n-        + Json.encode(cli.getRespHeaders().entries()));\n+      logger.debug(\"authForSystemInterface: {}\",\n+        Json.encode(cli.getRespHeaders().entries()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360"}, "originalPosition": 136}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTQ5Mzc3", "url": "https://github.com/folio-org/okapi/pull/889#pullrequestreview-375149377", "createdAt": "2020-03-16T12:11:15Z", "commit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjoxMToxNlrOF2xG6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjoxMToxNlrOF2xG6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk3MjAwOA==", "bodyText": "Good!", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r392972008", "createdAt": "2020-03-16T12:11:16Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -1033,7 +1017,7 @@ private DeploymentDescriptor pickInstance(List<DeploymentDescriptor> instances)\n    */\n   public void callSystemInterface(Tenant tenant, ModuleInstance inst,\n     String request, ProxyContext pc,\n-    Handler<ExtendedAsyncResult<OkapiClient>> fut) {\n+    Handler<AsyncResult<OkapiClient>> fut) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTY4MzEw", "url": "https://github.com/folio-org/okapi/pull/889#pullrequestreview-375168310", "createdAt": "2020-03-16T12:27:52Z", "commit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjoyNzo1MlrOF2xuHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjoyNzo1MlrOF2xuHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk4MjA0NQ==", "bodyText": "If it is intentional that the failure is only logged and not reported via promise there should be a // comment saying so.", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r392982045", "createdAt": "2020-03-16T12:27:52Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/MainVerticle.java", "diffHunk": "@@ -457,7 +434,7 @@ private void checkSuperTenant(String okapiModule, Promise<Void> promise) {\n       if (res.succeeded()) {\n         logger.info(\"Deploy completed succesfully\");\n       } else {\n-        logger.info(\"Deploy failed: {}\", res.cause());\n+        logger.info(\"Deploy failed\", res.cause());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360"}, "originalPosition": 230}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTcxNTIw", "url": "https://github.com/folio-org/okapi/pull/889#pullrequestreview-375171520", "createdAt": "2020-03-16T12:32:53Z", "commit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjozMjo1NFrOF2x-pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjozMjo1NFrOF2x-pA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk4NjI3Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.warn(\"pull for {} failed with status {}\", baseUrl,\n          \n          \n            \n                      res1.cause().getMessage());\n          \n          \n            \n                    logger.warn(\"pull for {} failed: {}\", baseUrl,\n          \n          \n            \n                      res1.cause().getMessage(), res1);\n          \n      \n    \n    \n  \n\nAdd stacktrace.", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r392986276", "createdAt": "2020-03-16T12:32:54Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/PullManager.java", "diffHunk": "@@ -52,17 +52,17 @@ private void getRemoteUrl(Iterator<String> it,\n     final Buffer body = Buffer.buffer();\n     HttpClientRequest req = httpClient.getAbs(url, res1 -> {\n       if (res1.failed()) {\n-        logger.info(\"pull for \" + baseUrl + \" failed with status \"\n-          + res1.cause().getMessage());\n+        logger.warn(\"pull for {} failed with status {}\", baseUrl,\n+          res1.cause().getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdddd974b629f8fc586740a66d75099af36e0145", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/cdddd974b629f8fc586740a66d75099af36e0145", "committedDate": "2020-03-16T13:57:39Z", "message": "Julians suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4354c73013680757ccd3253660eda9ccd65a291b", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/4354c73013680757ccd3253660eda9ccd65a291b", "committedDate": "2020-03-16T14:18:34Z", "message": "Proper stacktrace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1OTY3NTgz", "url": "https://github.com/folio-org/okapi/pull/889#pullrequestreview-375967583", "createdAt": "2020-03-17T11:58:21Z", "commit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMTo1ODoyMVrOF3ZENA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMTo1ODoyMVrOF3ZENA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYyNjY3Ng==", "bodyText": "The duplicate code should be extracted into a method:\n private void undeployFirstAndDeploy(TestContext context, JsonObject aConf, Handler<AsyncResult<String>> fut) {\n   Async myAsync = context.async();\n   undeployFirst(context.asyncAssertSuccess(handler -> {\n     DeploymentOptions opt = new DeploymentOptions().setConfig(aConf);\n     vertx.deployVerticle(MainVerticle.class.getName(), opt, res -> {\n       fut.handle(res);\n       myAsync.complete();\n     });\n   }));\n   myAsync.await(2000);\n }\n\n private void undeployFirstAndDeploy(TestContext context, JsonObject aConf) {\n   undeployFirstAndDeploy(context, aConf, context.asyncAssertSuccess());\n }\n\nExample usage:\nundeployFirstAndDeploy(context, conf);\n\nundeployFirstAndDeploy(context, conf, context.asyncAssertFailure(cause -> {\n  Assert.assertThat(cause.getMessage(), containsString(\n      \"password authentication failed for user \\\"okapi\\\"\"));\n}));", "url": "https://github.com/folio-org/okapi/pull/889#discussion_r393626676", "createdAt": "2020-03-17T11:58:21Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/test/java/org/folio/okapi/ModuleTest.java", "diffHunk": "@@ -2681,32 +2683,97 @@ private void undeployFirst(Handler<AsyncResult<Void>> fut) {\n   }\n \n   @Test\n-  public void testInternalModule(TestContext context) {\n-    logger.info(\"testInternalModule 1\");\n+  public void testInitdatabase(TestContext context) {\n+    conf.remove(\"mongo_db_init\");\n+    conf.remove(\"postgres_db_init\");\n+    conf.put(\"mode\", \"initdatabase\");\n     async = context.async();\n     undeployFirst(x -> {\n-      conf.remove(\"mongo_db_init\");\n-      conf.remove(\"postgres_db_init\");\n+      DeploymentOptions opt = new DeploymentOptions().setConfig(conf);\n+      vertx.deployVerticle(MainVerticle.class.getName(), opt, res -> {\n+        context.assertTrue(res.succeeded());\n+        async.complete();\n+      });\n+    });\n+    async.await(1000);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0179852657bb4c6af67f96d67f2d67e3358d3360"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MDc1Njc1", "url": "https://github.com/folio-org/okapi/pull/889#pullrequestreview-376075675", "createdAt": "2020-03-17T14:16:37Z", "commit": {"oid": "4354c73013680757ccd3253660eda9ccd65a291b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a4b9ef06da46ef78fe47166e374c90bf25cf8c1", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/5a4b9ef06da46ef78fe47166e374c90bf25cf8c1", "committedDate": "2020-03-19T08:54:47Z", "message": "Merge branch 'master' into okapi-773-switch-discovery-only-if-all-succeeds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ca5b221187b6de060a6f48bd36771fcf63e4199", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/7ca5b221187b6de060a6f48bd36771fcf63e4199", "committedDate": "2020-03-19T10:31:20Z", "message": "undeployFirstAndDeploy utility for ModuleTest"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2933, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}