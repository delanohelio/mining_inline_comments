{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NDg4OTA1", "number": 1012, "title": "Add more metrics backends (Prometheus and JMX) support", "bodyText": "Added metrics support for backend Prometheus (and JMX). Documentation is updated as below. I will create a follow up ticket to move some stuff to okapi-common, so RMB can use it directly.\nInstrumentation\nOkapi uses Micrometer to managing metrics and reporting to backends. To enable it,\nadd Java parameter -Dvertx.metrics.options.enabled=true first.\nMore Java parameters are needed to config which backends to use\n\n-DinfluxDbOptions='{\"uri\": \"http://localhost:8086\", \"db\":\"okapi\"}' - Send metrics to InfluxDB\n-DprometheusOptions='{\"embeddedServerOptions\": {\"port\": 9930}}' - Expose <server>:9930/metrics for Prometheus\n-DjmxMetricsOptions='{\"domain\": \"org.folio.metrics\"}' - JMX\n\nAnother Java parameter can be used to filter metrics\n\n-DmetricsPrefixFilter=org.folio - Will only report metrics with name starting org.folio\n\nA full example: java -Dvertx.metrics.options.enabled=true -DmetricsPrefixFilter=org.folio -DinfluxDbOptions='{\"uri\": \"http://localhost:8086\", \"db\":\"okapi\"}' -DprometheusOptions='{\"embeddedServerOptions\": {\"port\": 9930}}' -DjmxMetricsOptions='{\"domain\": \"org.folio\"}' -jar okapi-core/target/okapi-core-fat.jar dev", "createdAt": "2020-10-22T18:46:15Z", "url": "https://github.com/folio-org/okapi/pull/1012", "merged": true, "mergeCommit": {"oid": "a2305e4532a61f3671bd1760757d60bd67a9381c"}, "closed": true, "closedAt": "2020-10-24T08:35:34Z", "author": {"login": "hjiebsco"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVFxAhAH2gAyNTA4NDg4OTA1Ojk1NGE1ZjJhNjA3ODdjYzQxNDUyNDc0MmNmYTM3NGNjMjFjYTIxYTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVm1O_gH2gAyNTA4NDg4OTA1OjEzMjBkMWI5Mjg4YWM0ODdlNzY5NzAzYTFmZTRhZWZiMWI5YmI4MTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "954a5f2a60787cc414524742cfa374cc21ca21a8", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/954a5f2a60787cc414524742cfa374cc21ca21a8", "committedDate": "2020-10-22T17:52:42Z", "message": "Add metrics Prometheus backend support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1ODIzNzcx", "url": "https://github.com/folio-org/okapi/pull/1012#pullrequestreview-515823771", "createdAt": "2020-10-23T16:25:51Z", "commit": {"oid": "954a5f2a60787cc414524742cfa374cc21ca21a8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNjoyNTo1MVrOHnU9Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNjoyNTo1MVrOHnU9Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk5OTg3OA==", "bodyText": "I think you should break this long line with backslashes.. Of course, so that it's possible to still cut'n paste to shell.", "url": "https://github.com/folio-org/okapi/pull/1012#discussion_r510999878", "createdAt": "2020-10-23T16:25:51Z", "author": {"login": "adamdickmeiss"}, "path": "doc/guide.md", "diffHunk": "@@ -3050,23 +3049,18 @@ Use `modulePermissions` to grant permissions for the token.\n \n ### Instrumentation\n \n-Okapi pushes instrumentation data to an InfluxDB backend, from which\n-they can be shown with something like Grafana. Vert.x pushes some numbers\n-automatically, but various parts of Okapi push their own numbers explicitly,\n-so we can classify by tenant or module. Individual\n-modules may push their own numbers as well, as needed. It is hoped that they\n-will use a key naming scheme that is close to what we do in Okapi.\n+Okapi uses Micrometer to managing metrics and reporting to backends. To enable it,\n+add Java parameter `-Dvertx.metrics.options.enabled=true` first.\n \n-Enabling the metrics via `-enable-metrics` will start sending metrics to `localhost:8086`\n+More Java parameters are needed to config which backends to use\n+* `-DinfluxDbOptions='{\"uri\": \"http://localhost:8086\", \"db\":\"okapi\"}'` - Send metrics to InfluxDB\n+* `-DprometheusOptions='{\"embeddedServerOptions\": {\"port\": 9930}}'` - Expose `<server>:9930/metrics` for Prometheus\n+* `-DjmxMetricsOptions='{\"domain\": \"org.folio.metrics\"}'` - JMX\n \n-Follwing Java parameters can be used to config InfluxDB connection.\n-* `influxUrl` - default to `http://localhost:8086`\n-* `influxDbName` - default to `okapi`\n-* `influxUser` - default to null\n-* `influxPassword` - default to null\n+Another Java parameter can be used to filter metrics\n+* `-DmetricsPrefixFilter=org.folio` - Will only report metrics with name starting `org.folio`\n \n-For example: `java -DinfluxUrl=http://influx.yourdomain.io:8086 -jar okapi-core/target/okapi-core-fat.jar dev -enable-metrics` then metrics\n-will be sent to `http://influx.yourdomain.io:8086`\n+A full example: `java -Dvertx.metrics.options.enabled=true -DmetricsPrefixFilter=org.folio -DinfluxDbOptions='{\"uri\": \"http://localhost:8086\", \"db\":\"okapi\"}' -DprometheusOptions='{\"embeddedServerOptions\": {\"port\": 9930}}' -DjmxMetricsOptions='{\"domain\": \"org.folio\"}' -jar okapi-core/target/okapi-core-fat.jar dev`\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "954a5f2a60787cc414524742cfa374cc21ca21a8"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "467b1cf0b5326c44d355d1b038493e250b27f267", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/467b1cf0b5326c44d355d1b038493e250b27f267", "committedDate": "2020-10-24T08:22:51Z", "message": "Reformat guide example"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1320d1b9288ac487e769703a1fe4aefb1b9bb818", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/1320d1b9288ac487e769703a1fe4aefb1b9bb818", "committedDate": "2020-10-24T08:24:11Z", "message": "Merge branch 'master' into OKAPI-900-prometheus"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2882, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}