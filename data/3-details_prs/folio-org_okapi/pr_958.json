{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MDMxMzY2", "number": 958, "title": "Okapi 860 metrics", "bodyText": "Please see OKAPI-860. Following meters (and tags) are defined and implemented for Okapi HTTP proxy calls. There is no error meter defined for server side because that is covered by server processingTime meter. The naming convention follows Vert.x core tools metrics. Note, the dot in the name is converted to _ in InfluxDB automatically.\n\norg.folio.okapi.http.server.processingTime - metrics type is Micrometer Timer. Tags are below\n\nhost - Okapi instance. An example value: ip-172-31-19-200.ec2.internal/172.31.19.200\ntenant - FOLIO tenant id. An example value: diku\ncode - HTTP response code. An example value: 200\nmethod - HTTP request method. An example value: GET\nmodule - FOLIO module id. An example value: mod-authtoken-2.6.0-SNAPSHOT.73\nurl - HTTP request url as defined in module descriptor. An example value: /users/ {id}\n\n\norg.folio.okapi.http.client.responseTime - metrics type is Micrometer Timer. Tags are below\n\nall tags defined above plus\nphase - FOLIO proxy phase. An example value: auth. The default value is handler\n\n\norg.folio.okapi.http.client.errors - metrics type is Micrometer Counter. Tags are below\n\ntags: host, tenant, method, and url", "createdAt": "2020-08-11T10:59:25Z", "url": "https://github.com/folio-org/okapi/pull/958", "merged": true, "mergeCommit": {"oid": "bc446dd670fa56a193677e907f29cfcb027bc752"}, "closed": true, "closedAt": "2020-08-14T14:01:31Z", "author": {"login": "hjiebsco"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9z-a4AH2gAyNDY2MDMxMzY2OjM5ZWM3NTBhMzU0YzgzZTNmYWYyZTZmYTQ1Njk3MGQ0MmUyZDcyYjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-Qd6-gH2gAyNDY2MDMxMzY2OmZmMzRmZjY3MDlhYjRmZDc3MWJiY2Y3NjU3ZGZhYzcwNWIwNTRkMzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "39ec750a354c83e3faf2e6fa456970d42e2d72b2", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/39ec750a354c83e3faf2e6fa456970d42e2d72b2", "committedDate": "2020-08-11T10:08:48Z", "message": "Add HTTP proxy micrometer InfluxDB metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9e0f9dbc987cd2cdaa99e56442a1b914f77f654", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/d9e0f9dbc987cd2cdaa99e56442a1b914f77f654", "committedDate": "2020-08-11T10:31:07Z", "message": "Fix Sonar code smells"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7e982e5bbc2bdf1944a8b9f12da4b24066dc3a3", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/c7e982e5bbc2bdf1944a8b9f12da4b24066dc3a3", "committedDate": "2020-08-11T10:42:34Z", "message": "Fix Sonar code smells"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfb196bbf5597f0e028008b4e52c94a8098072df", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/cfb196bbf5597f0e028008b4e52c94a8098072df", "committedDate": "2020-08-11T10:52:17Z", "message": "Fix Sonar code smells"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MDc2NTgy", "url": "https://github.com/folio-org/okapi/pull/958#pullrequestreview-466076582", "createdAt": "2020-08-12T16:22:35Z", "commit": {"oid": "cfb196bbf5597f0e028008b4e52c94a8098072df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNjoyMjozNVrOG_o79A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNjoyMjozNVrOG_o79A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM4NDE4MA==", "bodyText": "There is no need to create an Optional for the sole purpose of providing a default value for null.\nThere exist several idioms for this:\n\nString.toString(influxUrl, \"http://localhost:8086\")\nObject.toString(influxUrl, \"http://localhost:8086\")\nStringUtils.defaultString(influxUrl, \"http://localhost:8086\")\nObjectUtils.firstNonNull(influxUrl, \"http://localhost:8086\")\n\n(There are 5 such Optional instances in this file.)", "url": "https://github.com/folio-org/okapi/pull/958#discussion_r469384180", "createdAt": "2020-08-12T16:22:35Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/util/MetricsHelper.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package org.folio.okapi.util;\n+\n+import io.micrometer.core.instrument.Counter;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Tag;\n+import io.micrometer.core.instrument.Timer;\n+import io.micrometer.core.instrument.Timer.Sample;\n+import io.micrometer.core.instrument.simple.SimpleMeterRegistry;\n+import io.vertx.core.VertxOptions;\n+import io.vertx.micrometer.MicrometerMetricsOptions;\n+import io.vertx.micrometer.VertxInfluxDbOptions;\n+import io.vertx.micrometer.backends.BackendRegistries;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.logging.log4j.Logger;\n+import org.folio.okapi.bean.ModuleInstance;\n+import org.folio.okapi.common.OkapiLogger;\n+\n+/**\n+ * Metrics handling.\n+ */\n+public class MetricsHelper {\n+\n+  private static final Logger logger = OkapiLogger.get();\n+\n+  private static final String METRICS_PREFIX = \"org.folio.okapi\";\n+  private static final String METRICS_HTTP = METRICS_PREFIX + \".http\";\n+  private static final String METRICS_HTTP_SERVER = METRICS_HTTP + \".server\";\n+  private static final String METRICS_HTTP_CLIENT = METRICS_HTTP + \".client\";\n+  private static final String METRICS_HTTP_SERVER_PROCESSING_TIME = METRICS_HTTP_SERVER\n+      + \".processingTime\";\n+  private static final String METRICS_HTTP_CLIENT_RESPONSE_TIME = METRICS_HTTP_CLIENT\n+      + \".responseTime\";\n+  private static final String METRICS_HTTP_CLIENT_ERRORS = METRICS_HTTP_CLIENT\n+      + \".errors\";\n+\n+  private static final String TAG_HOST = \"host\";\n+  private static final String TAG_TENANT = \"tenant\";\n+  private static final String TAG_CODE = \"code\";\n+  private static final String TAG_METHOD = \"method\";\n+  private static final String TAG_MODULE = \"module\";\n+  private static final String TAG_URL = \"url\";\n+  private static final String TAG_PHASE = \"phase\";\n+  private static final String TAG_EMPTY = \"null\";\n+\n+  static final String HOST_UNKNOWN = \"unknown\";\n+\n+  private static boolean enabled = false;\n+  private static MeterRegistry registry;\n+\n+  private MetricsHelper() {\n+  }\n+\n+  /**\n+   * Config metrics options - specifically use InfluxDb micrometer options.\n+   *\n+   * @param vertxOptions   - {@link VertxOptions}\n+   * @param influxUrl      - default to http://localhost:8086\n+   * @param influxDbName   - default to okapi\n+   * @param influxUserName - default to null\n+   * @param influxPassword - default to null\n+   */\n+  public static void config(VertxOptions vertxOptions, String influxUrl,\n+      String influxDbName, String influxUserName, String influxPassword) {\n+    VertxInfluxDbOptions influxDbOptions = new VertxInfluxDbOptions()\n+        .setEnabled(true)\n+        .setUri(Optional.ofNullable(influxUrl).orElse(\"http://localhost:8086\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfb196bbf5597f0e028008b4e52c94a8098072df"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MDg3OTgx", "url": "https://github.com/folio-org/okapi/pull/958#pullrequestreview-466087981", "createdAt": "2020-08-12T16:37:45Z", "commit": {"oid": "cfb196bbf5597f0e028008b4e52c94a8098072df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff34ff6709ab4fd771bbcf7657dfac705b054d36", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/ff34ff6709ab4fd771bbcf7657dfac705b054d36", "committedDate": "2020-08-12T19:20:33Z", "message": "Refactor a bit based on review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2813, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}