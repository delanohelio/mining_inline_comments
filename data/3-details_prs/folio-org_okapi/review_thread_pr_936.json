{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNjA1ODk4", "number": 936, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMDo0NjowMVrOEEdGRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMDo1MjoxN1rOEEdNig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMTA2NTAwOnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/PostgresHandle.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMDo0NjowMVrOGiFtGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMTo1NDoxNlrOGiZ6mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM5ODIzNA==", "bodyText": "What happens if an invalid cert is provided?  Does this call do validation, causing a failure here, or would SSL requests just be rejected later on, or...?", "url": "https://github.com/folio-org/okapi/pull/936#discussion_r438398234", "createdAt": "2020-06-10T20:46:01Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/PostgresHandle.java", "diffHunk": "@@ -63,6 +68,15 @@\n         Config.getSysConf(\"postgres_user\", \"okapi\", new JsonObject()), conf));\n     connectOptions.setPassword(Config.getSysConf(\"postgres_password\", \"okapi25\", conf));\n     connectOptions.setDatabase(Config.getSysConf(\"postgres_database\", \"okapi\", conf));\n+    String serverPem = Config.getSysConf(\"postgres_server_pem\", null, conf);\n+    if (serverPem != null) {\n+      connectOptions.setSslMode(SslMode.VERIFY_FULL);\n+      connectOptions.setHostnameVerificationAlgorithm(\"HTTPS\");\n+      connectOptions.setPemTrustOptions(\n+          new PemTrustOptions().addCertValue(Buffer.buffer(serverPem)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f95f1db9300fa241aa6a45d6339a5474d80c8619"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQyMjIzNw==", "bodyText": "The serverPem string is passed to PgPool that passes it to Vert.x that passes it to Netty that passes it to OpenSSL. OpenSSL does the validation.\nIf the cert is invalid there will be a connection failure. The failure will be similar to the failure for an invalid postgres password. I don't see the need for advanced error handling because the connection parameters are a one time task for the SysOp.", "url": "https://github.com/folio-org/okapi/pull/936#discussion_r438422237", "createdAt": "2020-06-10T21:37:05Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/PostgresHandle.java", "diffHunk": "@@ -63,6 +68,15 @@\n         Config.getSysConf(\"postgres_user\", \"okapi\", new JsonObject()), conf));\n     connectOptions.setPassword(Config.getSysConf(\"postgres_password\", \"okapi25\", conf));\n     connectOptions.setDatabase(Config.getSysConf(\"postgres_database\", \"okapi\", conf));\n+    String serverPem = Config.getSysConf(\"postgres_server_pem\", null, conf);\n+    if (serverPem != null) {\n+      connectOptions.setSslMode(SslMode.VERIFY_FULL);\n+      connectOptions.setHostnameVerificationAlgorithm(\"HTTPS\");\n+      connectOptions.setPemTrustOptions(\n+          new PemTrustOptions().addCertValue(Buffer.buffer(serverPem)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM5ODIzNA=="}, "originalCommit": {"oid": "f95f1db9300fa241aa6a45d6339a5474d80c8619"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcyOTM2OQ==", "bodyText": "Okapi exits with this error message if the provided certificate is invalid:\nFATAL PostgresQuery        getCon failed Postgres Server does not handle SSL connection\nThis is similar to the message when when Okapi exits because of wrong password:\nFATAL PostgresQuery        getCon failed password authentication failed for user \"okapi\"", "url": "https://github.com/folio-org/okapi/pull/936#discussion_r438729369", "createdAt": "2020-06-11T11:54:16Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/PostgresHandle.java", "diffHunk": "@@ -63,6 +68,15 @@\n         Config.getSysConf(\"postgres_user\", \"okapi\", new JsonObject()), conf));\n     connectOptions.setPassword(Config.getSysConf(\"postgres_password\", \"okapi25\", conf));\n     connectOptions.setDatabase(Config.getSysConf(\"postgres_database\", \"okapi\", conf));\n+    String serverPem = Config.getSysConf(\"postgres_server_pem\", null, conf);\n+    if (serverPem != null) {\n+      connectOptions.setSslMode(SslMode.VERIFY_FULL);\n+      connectOptions.setHostnameVerificationAlgorithm(\"HTTPS\");\n+      connectOptions.setPemTrustOptions(\n+          new PemTrustOptions().addCertValue(Buffer.buffer(serverPem)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM5ODIzNA=="}, "originalCommit": {"oid": "f95f1db9300fa241aa6a45d6339a5474d80c8619"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMTA4MzYyOnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/PostgresHandle.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMDo1MjoxN1rOGiF5Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMDo1MjoxN1rOGiF5Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQwMTMyMg==", "bodyText": "consider adding a debug/info level log message indicating that SSL is being used.", "url": "https://github.com/folio-org/okapi/pull/936#discussion_r438401322", "createdAt": "2020-06-10T20:52:17Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/service/impl/PostgresHandle.java", "diffHunk": "@@ -63,6 +68,15 @@\n         Config.getSysConf(\"postgres_user\", \"okapi\", new JsonObject()), conf));\n     connectOptions.setPassword(Config.getSysConf(\"postgres_password\", \"okapi25\", conf));\n     connectOptions.setDatabase(Config.getSysConf(\"postgres_database\", \"okapi\", conf));\n+    String serverPem = Config.getSysConf(\"postgres_server_pem\", null, conf);\n+    if (serverPem != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f95f1db9300fa241aa6a45d6339a5474d80c8619"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 250, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}