{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMDcyOTUz", "number": 1053, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzo0MzozNFrOFByQEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMTowODoxOVrOFCmMDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDE2MjExOnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/bean/ModuleInstance.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzo0MzozNFrOIAnVlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDo1MTo1MVrOICOaFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTQxNQ==", "bodyText": "Are there plans for other substitutions or can we use\n/**\n * Substitute {id} in path\n */\npublic void substPathId(String id) {\n  path = path.replace(\"{id}\", id);\n}", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r537515415", "createdAt": "2020-12-07T13:43:34Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/bean/ModuleInstance.java", "diffHunk": "@@ -44,6 +44,10 @@ public ModuleInstance(ModuleDescriptor md, RoutingEntry re,\n     this.withRetry = false;\n   }\n \n+  public void substPath(String pattern, String value) {\n+    path = path.replace(pattern, value);\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a4931a13cb1a2848592ff31f3674042cb07582"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMzA1MA==", "bodyText": "Not now. Can change it, if you like.", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r537523050", "createdAt": "2020-12-07T13:54:40Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/bean/ModuleInstance.java", "diffHunk": "@@ -44,6 +44,10 @@ public ModuleInstance(ModuleDescriptor md, RoutingEntry re,\n     this.withRetry = false;\n   }\n \n+  public void substPath(String pattern, String value) {\n+    path = path.replace(pattern, value);\n+  }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTQxNQ=="}, "originalCommit": {"oid": "f6a4931a13cb1a2848592ff31f3674042cb07582"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc3NDk0MA==", "bodyText": "I like it. Otherwise the task is split: Call to replace in ModuleInstance, substitution string \"{id}\" in TenantManager.", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538774940", "createdAt": "2020-12-08T20:14:55Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/bean/ModuleInstance.java", "diffHunk": "@@ -44,6 +44,10 @@ public ModuleInstance(ModuleDescriptor md, RoutingEntry re,\n     this.withRetry = false;\n   }\n \n+  public void substPath(String pattern, String value) {\n+    path = path.replace(pattern, value);\n+  }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTQxNQ=="}, "originalCommit": {"oid": "f6a4931a13cb1a2848592ff31f3674042cb07582"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIwNDExOA==", "bodyText": "Done.", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539204118", "createdAt": "2020-12-09T10:51:51Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/bean/ModuleInstance.java", "diffHunk": "@@ -44,6 +44,10 @@ public ModuleInstance(ModuleDescriptor md, RoutingEntry re,\n     this.withRetry = false;\n   }\n \n+  public void substPath(String pattern, String value) {\n+    path = path.replace(pattern, value);\n+  }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTQxNQ=="}, "originalCommit": {"oid": "f6a4931a13cb1a2848592ff31f3674042cb07582"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MTg4NzE5OnYy", "diffSide": "RIGHT", "path": "doc/guide.md", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODoxOTo0NFrOIBu8Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDo0OTo1NFrOICOVRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4ODU1OA==", "bodyText": "Show we add \"permissionsRequired\" : [ ]?", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538688558", "createdAt": "2020-12-08T18:19:44Z", "author": {"login": "julianladisch"}, "path": "doc/guide.md", "diffHunk": "@@ -3188,29 +3196,51 @@ etc.  also load sets of reference data. This can be controlled by\n supplying tenant parameters. These are properties (key-value pairs)\n that are passed to the module when enabled or upgraded. Passing those\n are only performed when tenantParameters is specified for install and\n-when the tenant interface is version 1.2.\n+when the tenant interface is version 1.2 and later.\n \n In FOLIO two such parameters are widely recognized:\n \n  * `loadReference` with value `true` loads reference data.\n  * `loadSample` with value `true` loads sample data.\n \n-### Tenant Interface\n+#### Tenant Interface definitions\n \n-The full `_tenant` interface version 1.1/1.2 portion:\n+A module supporting 1.1/1.2 of the `_tenant` interface should use this\n+snippet in the module descriptor:\n \n ```\n    \"id\" : \"_tenant\",\n    \"version\" : \"1.2\",\n    \"interfaceType\" : \"system\",\n    \"handlers\" : [ {\n-     \"methods\" : [ \"POST\", \"DELETE\" ],\n-     \"pathPattern\" : \"/_/tenant\"\n-    }, {\n-     \"methods\" : [ \"POST\" ],\n-     \"pathPattern\" : \"/_/tenant/disable\"\n-    } ]\n+       \"methods\" : [ \"POST\", \"DELETE\" ],\n+       \"pathPattern\" : \"/_/tenant\"\n+      }, {\n+       \"methods\" : [ \"POST\" ],\n+       \"pathPattern\" : \"/_/tenant/disable\"\n+      }\n+   ]\n+```\n+The corresponding RAML definition:\n+[tenant.raml](https://github.com/folio-org/raml/blob/tenant_interface_1_2/ramls/tenant.raml)\n+\n+Snippet of version 2.0 of the `_tenant` interface:\n+\n ```\n+   \"id\" : \"_tenant\",\n+   \"version\" : \"2.0\",\n+   \"interfaceType\" : \"system\",\n+   \"handlers\" : [ {\n+       \"methods\" : [ \"POST\" ],\n+       \"pathPattern\" : \"/_/tenant\"\n+      }, {\n+       \"methods\" : [ \"GET\", \"DELETE\" ],\n+       \"pathPattern\" : \"/_/tenant/{id}\"\n+      }\n+   ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODczMTAzNg==", "bodyText": "We could, but kind of redundant. They aren't required for system interfaces. In folio-org/raml-module-builder#815 the property is present. I think I'll just remove them from there. Shorter notation.", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538731036", "createdAt": "2020-12-08T19:05:07Z", "author": {"login": "adamdickmeiss"}, "path": "doc/guide.md", "diffHunk": "@@ -3188,29 +3196,51 @@ etc.  also load sets of reference data. This can be controlled by\n supplying tenant parameters. These are properties (key-value pairs)\n that are passed to the module when enabled or upgraded. Passing those\n are only performed when tenantParameters is specified for install and\n-when the tenant interface is version 1.2.\n+when the tenant interface is version 1.2 and later.\n \n In FOLIO two such parameters are widely recognized:\n \n  * `loadReference` with value `true` loads reference data.\n  * `loadSample` with value `true` loads sample data.\n \n-### Tenant Interface\n+#### Tenant Interface definitions\n \n-The full `_tenant` interface version 1.1/1.2 portion:\n+A module supporting 1.1/1.2 of the `_tenant` interface should use this\n+snippet in the module descriptor:\n \n ```\n    \"id\" : \"_tenant\",\n    \"version\" : \"1.2\",\n    \"interfaceType\" : \"system\",\n    \"handlers\" : [ {\n-     \"methods\" : [ \"POST\", \"DELETE\" ],\n-     \"pathPattern\" : \"/_/tenant\"\n-    }, {\n-     \"methods\" : [ \"POST\" ],\n-     \"pathPattern\" : \"/_/tenant/disable\"\n-    } ]\n+       \"methods\" : [ \"POST\", \"DELETE\" ],\n+       \"pathPattern\" : \"/_/tenant\"\n+      }, {\n+       \"methods\" : [ \"POST\" ],\n+       \"pathPattern\" : \"/_/tenant/disable\"\n+      }\n+   ]\n+```\n+The corresponding RAML definition:\n+[tenant.raml](https://github.com/folio-org/raml/blob/tenant_interface_1_2/ramls/tenant.raml)\n+\n+Snippet of version 2.0 of the `_tenant` interface:\n+\n ```\n+   \"id\" : \"_tenant\",\n+   \"version\" : \"2.0\",\n+   \"interfaceType\" : \"system\",\n+   \"handlers\" : [ {\n+       \"methods\" : [ \"POST\" ],\n+       \"pathPattern\" : \"/_/tenant\"\n+      }, {\n+       \"methods\" : [ \"GET\", \"DELETE\" ],\n+       \"pathPattern\" : \"/_/tenant/{id}\"\n+      }\n+   ]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4ODU1OA=="}, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgyMDQ0Mg==", "bodyText": "Agreed.", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538820442", "createdAt": "2020-12-08T21:28:30Z", "author": {"login": "julianladisch"}, "path": "doc/guide.md", "diffHunk": "@@ -3188,29 +3196,51 @@ etc.  also load sets of reference data. This can be controlled by\n supplying tenant parameters. These are properties (key-value pairs)\n that are passed to the module when enabled or upgraded. Passing those\n are only performed when tenantParameters is specified for install and\n-when the tenant interface is version 1.2.\n+when the tenant interface is version 1.2 and later.\n \n In FOLIO two such parameters are widely recognized:\n \n  * `loadReference` with value `true` loads reference data.\n  * `loadSample` with value `true` loads sample data.\n \n-### Tenant Interface\n+#### Tenant Interface definitions\n \n-The full `_tenant` interface version 1.1/1.2 portion:\n+A module supporting 1.1/1.2 of the `_tenant` interface should use this\n+snippet in the module descriptor:\n \n ```\n    \"id\" : \"_tenant\",\n    \"version\" : \"1.2\",\n    \"interfaceType\" : \"system\",\n    \"handlers\" : [ {\n-     \"methods\" : [ \"POST\", \"DELETE\" ],\n-     \"pathPattern\" : \"/_/tenant\"\n-    }, {\n-     \"methods\" : [ \"POST\" ],\n-     \"pathPattern\" : \"/_/tenant/disable\"\n-    } ]\n+       \"methods\" : [ \"POST\", \"DELETE\" ],\n+       \"pathPattern\" : \"/_/tenant\"\n+      }, {\n+       \"methods\" : [ \"POST\" ],\n+       \"pathPattern\" : \"/_/tenant/disable\"\n+      }\n+   ]\n+```\n+The corresponding RAML definition:\n+[tenant.raml](https://github.com/folio-org/raml/blob/tenant_interface_1_2/ramls/tenant.raml)\n+\n+Snippet of version 2.0 of the `_tenant` interface:\n+\n ```\n+   \"id\" : \"_tenant\",\n+   \"version\" : \"2.0\",\n+   \"interfaceType\" : \"system\",\n+   \"handlers\" : [ {\n+       \"methods\" : [ \"POST\" ],\n+       \"pathPattern\" : \"/_/tenant\"\n+      }, {\n+       \"methods\" : [ \"GET\", \"DELETE\" ],\n+       \"pathPattern\" : \"/_/tenant/{id}\"\n+      }\n+   ]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4ODU1OA=="}, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIwMjg4NA==", "bodyText": "I thought it was agreed that all endpoints in module descriptors should declare an empty modulePermissions property to make it explicit that a conscious decision had been made.\n@craigmcnally @skoczko Did I misunderstand that guidance?", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539202884", "createdAt": "2020-12-09T10:49:54Z", "author": {"login": "marcjohnson-kint"}, "path": "doc/guide.md", "diffHunk": "@@ -3188,29 +3196,51 @@ etc.  also load sets of reference data. This can be controlled by\n supplying tenant parameters. These are properties (key-value pairs)\n that are passed to the module when enabled or upgraded. Passing those\n are only performed when tenantParameters is specified for install and\n-when the tenant interface is version 1.2.\n+when the tenant interface is version 1.2 and later.\n \n In FOLIO two such parameters are widely recognized:\n \n  * `loadReference` with value `true` loads reference data.\n  * `loadSample` with value `true` loads sample data.\n \n-### Tenant Interface\n+#### Tenant Interface definitions\n \n-The full `_tenant` interface version 1.1/1.2 portion:\n+A module supporting 1.1/1.2 of the `_tenant` interface should use this\n+snippet in the module descriptor:\n \n ```\n    \"id\" : \"_tenant\",\n    \"version\" : \"1.2\",\n    \"interfaceType\" : \"system\",\n    \"handlers\" : [ {\n-     \"methods\" : [ \"POST\", \"DELETE\" ],\n-     \"pathPattern\" : \"/_/tenant\"\n-    }, {\n-     \"methods\" : [ \"POST\" ],\n-     \"pathPattern\" : \"/_/tenant/disable\"\n-    } ]\n+       \"methods\" : [ \"POST\", \"DELETE\" ],\n+       \"pathPattern\" : \"/_/tenant\"\n+      }, {\n+       \"methods\" : [ \"POST\" ],\n+       \"pathPattern\" : \"/_/tenant/disable\"\n+      }\n+   ]\n+```\n+The corresponding RAML definition:\n+[tenant.raml](https://github.com/folio-org/raml/blob/tenant_interface_1_2/ramls/tenant.raml)\n+\n+Snippet of version 2.0 of the `_tenant` interface:\n+\n ```\n+   \"id\" : \"_tenant\",\n+   \"version\" : \"2.0\",\n+   \"interfaceType\" : \"system\",\n+   \"handlers\" : [ {\n+       \"methods\" : [ \"POST\" ],\n+       \"pathPattern\" : \"/_/tenant\"\n+      }, {\n+       \"methods\" : [ \"GET\", \"DELETE\" ],\n+       \"pathPattern\" : \"/_/tenant/{id}\"\n+      }\n+   ]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4ODU1OA=="}, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 149}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MjM2NjAwOnYy", "diffSide": "RIGHT", "path": "doc/guide.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxOTo1NToxNFrOIBze_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNzo1MDozNVrOICG1WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc2MzAwNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                curl -HX-Okapi-url:http://localhost:8081 -HX-Okapi-Tenant:testlib \\\n          \n          \n            \n                  -HContent-Type:application/json \"-HAccept:*/*\" \\\n          \n          \n            \n                curl -H \"X-Okapi-url: http://localhost:8081\" -H \"X-Okapi-Tenant: testlib\" \\\n          \n          \n            \n                  -H \"Content-Type: application/json\" -H \"Accept: */*\" \\", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538763006", "createdAt": "2020-12-08T19:55:14Z", "author": {"login": "julianladisch"}, "path": "doc/guide.md", "diffHunk": "@@ -3142,9 +3138,19 @@ during the operation.\n \n Add 'loadSample=true` to parameters, to load sample data as well.\n \n+If the module supports version 2 of the `_tenant` interface it should return status 201 with\n+a `Location` header. This signals that the tenant job has started. Use a GET request on the\n+Location path returned to poll for the completion of the tenant job with the\n+\n+    curl -HX-Okapi-url:http://localhost:8081 -HX-Okapi-Tenant:testlib \\\n+      -HContent-Type:application/json \"-HAccept:*/*\" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA4MDAyNQ==", "bodyText": "More typing, but I guess it's more readable.", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539080025", "createdAt": "2020-12-09T07:50:35Z", "author": {"login": "adamdickmeiss"}, "path": "doc/guide.md", "diffHunk": "@@ -3142,9 +3138,19 @@ during the operation.\n \n Add 'loadSample=true` to parameters, to load sample data as well.\n \n+If the module supports version 2 of the `_tenant` interface it should return status 201 with\n+a `Location` header. This signals that the tenant job has started. Use a GET request on the\n+Location path returned to poll for the completion of the tenant job with the\n+\n+    curl -HX-Okapi-url:http://localhost:8081 -HX-Okapi-Tenant:testlib \\\n+      -HContent-Type:application/json \"-HAccept:*/*\" \\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc2MzAwNg=="}, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MjQxOTE2OnYy", "diffSide": "RIGHT", "path": "doc/guide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDowNzo1N1rOIBz9gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDowNzo1N1rOIBz9gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc3MDgxOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            a `Location` header. This signals that the tenant job has started. Use a GET request on the\n          \n          \n            \n            a\n          \n          \n            \n            \n          \n          \n            \n                Location: /_/tenant/6da99bac-457b-499f-89a4-34f4da8e9be8\n          \n          \n            \n                \n          \n          \n            \n            header. This signals that the tenant job has started. Use a GET request on the", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538770819", "createdAt": "2020-12-08T20:07:57Z", "author": {"login": "julianladisch"}, "path": "doc/guide.md", "diffHunk": "@@ -3142,9 +3138,19 @@ during the operation.\n \n Add 'loadSample=true` to parameters, to load sample data as well.\n \n+If the module supports version 2 of the `_tenant` interface it should return status 201 with\n+a `Location` header. This signals that the tenant job has started. Use a GET request on the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MjQxOTU0OnYy", "diffSide": "RIGHT", "path": "doc/guide.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDowODowNVrOIBz9wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDowODowNVrOIBz9wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc3MDg4MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  http://localhost:8081/path\n          \n          \n            \n                  http://localhost:8081/_/tenant/6da99bac-457b-499f-89a4-34f4da8e9be8", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538770881", "createdAt": "2020-12-08T20:08:05Z", "author": {"login": "julianladisch"}, "path": "doc/guide.md", "diffHunk": "@@ -3142,9 +3138,19 @@ during the operation.\n \n Add 'loadSample=true` to parameters, to load sample data as well.\n \n+If the module supports version 2 of the `_tenant` interface it should return status 201 with\n+a `Location` header. This signals that the tenant job has started. Use a GET request on the\n+Location path returned to poll for the completion of the tenant job with the\n+\n+    curl -HX-Okapi-url:http://localhost:8081 -HX-Okapi-Tenant:testlib \\\n+      -HContent-Type:application/json \"-HAccept:*/*\" \\\n+      http://localhost:8081/path", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MjYxMjIyOnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDo1NDo0N1rOIB1toQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDo1NzoyMlrOICOo4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5OTUyMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String reqId = inst.getPath().replaceFirst(\"^[/_]*([^/]+).*\", \"$1\");\n          \n          \n            \n                // first path segment, but skip leading /_\n          \n          \n            \n                String reqId = inst.getPath().replaceFirst(\"^(/_)?/([^/]+).*\", \"$2\");", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538799521", "createdAt": "2020-12-08T20:54:47Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -1193,6 +1193,40 @@ private static DeploymentDescriptor pickInstance(List<DeploymentDescriptor> inst\n         });\n   }\n \n+  private Future<OkapiClient> doCallSystemInterface2(\n+      MultiMap headersIn, String tenantId, String authToken,\n+      ModuleInstance inst, String modPerms, String request) {\n+\n+    Map<String, String> headers = sysReqHeaders(headersIn, tenantId, authToken, inst, modPerms);\n+    headers.put(XOkapiHeaders.URL_TO, inst.getUrl());\n+    logger.debug(\"syscall begin {} {}{}\", inst.getMethod(), inst.getUrl(), inst.getPath());\n+    OkapiClient cli = new OkapiClient(this.httpClient, inst.getUrl(), vertx, headers);\n+    String reqId = inst.getPath().replaceFirst(\"^[/_]*([^/]+).*\", \"$1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5MTA0OA==", "bodyText": "This replaceFirst was not part of PR (only due to refactorings)..\nThe initial replaceFirst would make tenant from path  /_/tenant. Your suggestion ends up with an empty string.", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539091048", "createdAt": "2020-12-09T08:09:31Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -1193,6 +1193,40 @@ private static DeploymentDescriptor pickInstance(List<DeploymentDescriptor> inst\n         });\n   }\n \n+  private Future<OkapiClient> doCallSystemInterface2(\n+      MultiMap headersIn, String tenantId, String authToken,\n+      ModuleInstance inst, String modPerms, String request) {\n+\n+    Map<String, String> headers = sysReqHeaders(headersIn, tenantId, authToken, inst, modPerms);\n+    headers.put(XOkapiHeaders.URL_TO, inst.getUrl());\n+    logger.debug(\"syscall begin {} {}{}\", inst.getMethod(), inst.getUrl(), inst.getPath());\n+    OkapiClient cli = new OkapiClient(this.httpClient, inst.getUrl(), vertx, headers);\n+    String reqId = inst.getPath().replaceFirst(\"^[/_]*([^/]+).*\", \"$1\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5OTUyMQ=="}, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIwNzkwNQ==", "bodyText": "System.out.println(\"/_/tenant\".replaceFirst(\"^(/_)?/([^/]+).*\", \"$2\"));\noutputs\ntenant\nFor all unit tests my suggestion returns the same result as before.", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539207905", "createdAt": "2020-12-09T10:57:22Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/ProxyService.java", "diffHunk": "@@ -1193,6 +1193,40 @@ private static DeploymentDescriptor pickInstance(List<DeploymentDescriptor> inst\n         });\n   }\n \n+  private Future<OkapiClient> doCallSystemInterface2(\n+      MultiMap headersIn, String tenantId, String authToken,\n+      ModuleInstance inst, String modPerms, String request) {\n+\n+    Map<String, String> headers = sysReqHeaders(headersIn, tenantId, authToken, inst, modPerms);\n+    headers.put(XOkapiHeaders.URL_TO, inst.getUrl());\n+    logger.debug(\"syscall begin {} {}{}\", inst.getMethod(), inst.getUrl(), inst.getPath());\n+    OkapiClient cli = new OkapiClient(this.httpClient, inst.getUrl(), vertx, headers);\n+    String reqId = inst.getPath().replaceFirst(\"^[/_]*([^/]+).*\", \"$1\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5OTUyMQ=="}, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MjY3MTUxOnYy", "diffSide": "RIGHT", "path": "okapi-core/src/test/java/org/folio/okapi/InstallTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMTowODoxOVrOIB2RAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDo1Mjo0NFrOICOclA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwODU3OQ==", "bodyText": "indexOf(\"/_/\") is always 0.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String locationInstallJob = r.getHeader(\"Location\");\n          \n          \n            \n            \n          \n          \n            \n                String path = locationInstallJob.substring(locationInstallJob.indexOf(\"/_/\"));\n          \n          \n            \n                String path = r.getHeader(\"Location\");", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r538808579", "createdAt": "2020-12-08T21:08:19Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/test/java/org/folio/okapi/InstallTest.java", "diffHunk": "@@ -1119,7 +1047,325 @@ public void installTenantInit(TestContext context) {\n     Assert.assertTrue(\n         \"raml: \" + c.getLastReport().toString(),\n         c.getLastReport().isEmpty());\n-    timerServer.close();\n+    httpServerV1.close();\n+  }\n+\n+  void createAsyncInitModule(TestContext context, String module) {\n+    final String docModule = \"{\" + LS\n+        + \"  \\\"id\\\" : \\\"\" + module + \"\\\",\" + LS\n+        + \"  \\\"name\\\" : \\\"async tenant init module\\\",\" + LS\n+        + \"  \\\"provides\\\" : [ {\" + LS\n+        + \"    \\\"id\\\" : \\\"_tenant\\\",\" + LS\n+        + \"    \\\"version\\\" : \\\"2.0\\\",\" + LS\n+        + \"    \\\"interfaceType\\\" : \\\"system\\\",\" + LS\n+        + \"    \\\"handlers\\\" : [ {\" + LS\n+        + \"      \\\"methods\\\" : [ \\\"POST\\\" ],\" + LS\n+        + \"      \\\"pathPattern\\\" : \\\"/_/tenant\\\",\" + LS\n+        + \"      \\\"permissionsRequired\\\" : [ ]\" + LS\n+        + \"    }, {\" + LS\n+        + \"      \\\"methods\\\" : [ \\\"GET\\\", \\\"DELETE\\\" ],\" + LS\n+        + \"      \\\"pathPattern\\\" : \\\"/_/tenant/{id}\\\",\" + LS\n+        + \"      \\\"permissionsRequired\\\" : [ ]\" + LS\n+        + \"    } ]\" + LS\n+        + \"  } ],\" + LS\n+        + \"  \\\"requires\\\" : [ ]\" + LS\n+        + \"}\";\n+\n+    RestAssuredClient c = api.createRestAssured3();\n+    c.given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .body(docModule).post(\"/_/proxy/modules\").then().statusCode(201);\n+  }\n+\n+  void deployAsyncInitModule(TestContext context, String module, int port) {\n+    final String nodeDoc1 = \"{\" + LS\n+        + \"  \\\"instId\\\" : \\\"localhost-\" + Integer.toString(port) + \"\\\",\" + LS\n+        + \"  \\\"srvcId\\\" : \\\"\" + module + \"\\\",\" + LS\n+        + \"  \\\"url\\\" : \\\"http://localhost:\" + Integer.toString(port) + \"\\\"\" + LS\n+        + \"}\";\n+\n+    RestAssuredClient c = api.createRestAssured3();\n+    c.given().header(\"Content-Type\", \"application/json\")\n+        .body(nodeDoc1).post(\"/_/discovery/modules\")\n+        .then().statusCode(201);\n+    Assert.assertTrue(\"raml: \" + c.getLastReport().toString(),\n+        c.getLastReport().isEmpty());\n+  }\n+\n+  JsonObject enableAndWait(TestContext context, String tenant, String module) {\n+    RestAssuredClient c = api.createRestAssured3();\n+    Response r = c.given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .body(\"[ {\\\"id\\\" : \\\"\" + module + \"\\\", \\\"action\\\" : \\\"enable\\\"} ]\")\n+        .post(\"/_/proxy/tenants/\" + tenant + \"/install?async=true\")\n+        .then().statusCode(201)\n+        .body(equalTo(\"[ {\" + LS\n+            + \"  \\\"id\\\" : \\\"\"+ module + \"\\\",\" + LS\n+            + \"  \\\"action\\\" : \\\"enable\\\"\" + LS\n+            + \"} ]\"))\n+        .extract().response();\n+    Assert.assertTrue(\n+        \"raml: \" + c.getLastReport().toString(),\n+        c.getLastReport().isEmpty());\n+    String locationInstallJob = r.getHeader(\"Location\");\n+\n+    String path = locationInstallJob.substring(locationInstallJob.indexOf(\"/_/\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 775}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5Mzc1MQ==", "bodyText": "LOL. Yes.. I was probably thinking that Location could be absolute URL!", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539093751", "createdAt": "2020-12-09T08:12:44Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/test/java/org/folio/okapi/InstallTest.java", "diffHunk": "@@ -1119,7 +1047,325 @@ public void installTenantInit(TestContext context) {\n     Assert.assertTrue(\n         \"raml: \" + c.getLastReport().toString(),\n         c.getLastReport().isEmpty());\n-    timerServer.close();\n+    httpServerV1.close();\n+  }\n+\n+  void createAsyncInitModule(TestContext context, String module) {\n+    final String docModule = \"{\" + LS\n+        + \"  \\\"id\\\" : \\\"\" + module + \"\\\",\" + LS\n+        + \"  \\\"name\\\" : \\\"async tenant init module\\\",\" + LS\n+        + \"  \\\"provides\\\" : [ {\" + LS\n+        + \"    \\\"id\\\" : \\\"_tenant\\\",\" + LS\n+        + \"    \\\"version\\\" : \\\"2.0\\\",\" + LS\n+        + \"    \\\"interfaceType\\\" : \\\"system\\\",\" + LS\n+        + \"    \\\"handlers\\\" : [ {\" + LS\n+        + \"      \\\"methods\\\" : [ \\\"POST\\\" ],\" + LS\n+        + \"      \\\"pathPattern\\\" : \\\"/_/tenant\\\",\" + LS\n+        + \"      \\\"permissionsRequired\\\" : [ ]\" + LS\n+        + \"    }, {\" + LS\n+        + \"      \\\"methods\\\" : [ \\\"GET\\\", \\\"DELETE\\\" ],\" + LS\n+        + \"      \\\"pathPattern\\\" : \\\"/_/tenant/{id}\\\",\" + LS\n+        + \"      \\\"permissionsRequired\\\" : [ ]\" + LS\n+        + \"    } ]\" + LS\n+        + \"  } ],\" + LS\n+        + \"  \\\"requires\\\" : [ ]\" + LS\n+        + \"}\";\n+\n+    RestAssuredClient c = api.createRestAssured3();\n+    c.given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .body(docModule).post(\"/_/proxy/modules\").then().statusCode(201);\n+  }\n+\n+  void deployAsyncInitModule(TestContext context, String module, int port) {\n+    final String nodeDoc1 = \"{\" + LS\n+        + \"  \\\"instId\\\" : \\\"localhost-\" + Integer.toString(port) + \"\\\",\" + LS\n+        + \"  \\\"srvcId\\\" : \\\"\" + module + \"\\\",\" + LS\n+        + \"  \\\"url\\\" : \\\"http://localhost:\" + Integer.toString(port) + \"\\\"\" + LS\n+        + \"}\";\n+\n+    RestAssuredClient c = api.createRestAssured3();\n+    c.given().header(\"Content-Type\", \"application/json\")\n+        .body(nodeDoc1).post(\"/_/discovery/modules\")\n+        .then().statusCode(201);\n+    Assert.assertTrue(\"raml: \" + c.getLastReport().toString(),\n+        c.getLastReport().isEmpty());\n+  }\n+\n+  JsonObject enableAndWait(TestContext context, String tenant, String module) {\n+    RestAssuredClient c = api.createRestAssured3();\n+    Response r = c.given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .body(\"[ {\\\"id\\\" : \\\"\" + module + \"\\\", \\\"action\\\" : \\\"enable\\\"} ]\")\n+        .post(\"/_/proxy/tenants/\" + tenant + \"/install?async=true\")\n+        .then().statusCode(201)\n+        .body(equalTo(\"[ {\" + LS\n+            + \"  \\\"id\\\" : \\\"\"+ module + \"\\\",\" + LS\n+            + \"  \\\"action\\\" : \\\"enable\\\"\" + LS\n+            + \"} ]\"))\n+        .extract().response();\n+    Assert.assertTrue(\n+        \"raml: \" + c.getLastReport().toString(),\n+        c.getLastReport().isEmpty());\n+    String locationInstallJob = r.getHeader(\"Location\");\n+\n+    String path = locationInstallJob.substring(locationInstallJob.indexOf(\"/_/\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwODU3OQ=="}, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 775}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIwNDc1Ng==", "bodyText": "LOL. Yes.. I was probably thinking that Location could be absolute URL!\n\nIs this the location for the status of the install task in Okapi or the location of the status of an individual module upgrade?", "url": "https://github.com/folio-org/okapi/pull/1053#discussion_r539204756", "createdAt": "2020-12-09T10:52:44Z", "author": {"login": "marcjohnson-kint"}, "path": "okapi-core/src/test/java/org/folio/okapi/InstallTest.java", "diffHunk": "@@ -1119,7 +1047,325 @@ public void installTenantInit(TestContext context) {\n     Assert.assertTrue(\n         \"raml: \" + c.getLastReport().toString(),\n         c.getLastReport().isEmpty());\n-    timerServer.close();\n+    httpServerV1.close();\n+  }\n+\n+  void createAsyncInitModule(TestContext context, String module) {\n+    final String docModule = \"{\" + LS\n+        + \"  \\\"id\\\" : \\\"\" + module + \"\\\",\" + LS\n+        + \"  \\\"name\\\" : \\\"async tenant init module\\\",\" + LS\n+        + \"  \\\"provides\\\" : [ {\" + LS\n+        + \"    \\\"id\\\" : \\\"_tenant\\\",\" + LS\n+        + \"    \\\"version\\\" : \\\"2.0\\\",\" + LS\n+        + \"    \\\"interfaceType\\\" : \\\"system\\\",\" + LS\n+        + \"    \\\"handlers\\\" : [ {\" + LS\n+        + \"      \\\"methods\\\" : [ \\\"POST\\\" ],\" + LS\n+        + \"      \\\"pathPattern\\\" : \\\"/_/tenant\\\",\" + LS\n+        + \"      \\\"permissionsRequired\\\" : [ ]\" + LS\n+        + \"    }, {\" + LS\n+        + \"      \\\"methods\\\" : [ \\\"GET\\\", \\\"DELETE\\\" ],\" + LS\n+        + \"      \\\"pathPattern\\\" : \\\"/_/tenant/{id}\\\",\" + LS\n+        + \"      \\\"permissionsRequired\\\" : [ ]\" + LS\n+        + \"    } ]\" + LS\n+        + \"  } ],\" + LS\n+        + \"  \\\"requires\\\" : [ ]\" + LS\n+        + \"}\";\n+\n+    RestAssuredClient c = api.createRestAssured3();\n+    c.given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .body(docModule).post(\"/_/proxy/modules\").then().statusCode(201);\n+  }\n+\n+  void deployAsyncInitModule(TestContext context, String module, int port) {\n+    final String nodeDoc1 = \"{\" + LS\n+        + \"  \\\"instId\\\" : \\\"localhost-\" + Integer.toString(port) + \"\\\",\" + LS\n+        + \"  \\\"srvcId\\\" : \\\"\" + module + \"\\\",\" + LS\n+        + \"  \\\"url\\\" : \\\"http://localhost:\" + Integer.toString(port) + \"\\\"\" + LS\n+        + \"}\";\n+\n+    RestAssuredClient c = api.createRestAssured3();\n+    c.given().header(\"Content-Type\", \"application/json\")\n+        .body(nodeDoc1).post(\"/_/discovery/modules\")\n+        .then().statusCode(201);\n+    Assert.assertTrue(\"raml: \" + c.getLastReport().toString(),\n+        c.getLastReport().isEmpty());\n+  }\n+\n+  JsonObject enableAndWait(TestContext context, String tenant, String module) {\n+    RestAssuredClient c = api.createRestAssured3();\n+    Response r = c.given()\n+        .header(\"Content-Type\", \"application/json\")\n+        .body(\"[ {\\\"id\\\" : \\\"\" + module + \"\\\", \\\"action\\\" : \\\"enable\\\"} ]\")\n+        .post(\"/_/proxy/tenants/\" + tenant + \"/install?async=true\")\n+        .then().statusCode(201)\n+        .body(equalTo(\"[ {\" + LS\n+            + \"  \\\"id\\\" : \\\"\"+ module + \"\\\",\" + LS\n+            + \"  \\\"action\\\" : \\\"enable\\\"\" + LS\n+            + \"} ]\"))\n+        .extract().response();\n+    Assert.assertTrue(\n+        \"raml: \" + c.getLastReport().toString(),\n+        c.getLastReport().isEmpty());\n+    String locationInstallJob = r.getHeader(\"Location\");\n+\n+    String path = locationInstallJob.substring(locationInstallJob.indexOf(\"/_/\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwODU3OQ=="}, "originalCommit": {"oid": "25877f91101ff95000c83fdd9fc440bba735dddd"}, "originalPosition": 775}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 100, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}