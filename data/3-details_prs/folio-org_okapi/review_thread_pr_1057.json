{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2OTAwMTk5", "number": 1057, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODowNDoxNVrOFFHa_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozMzo1NVrOFFLCjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwOTA4Nzk5OnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODowNDoxNVrOIFdScg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODoyOToyMFrOIFenCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MzY1MA==", "bodyText": "Please add check for \"2.0\". And report failure if no match (return failed future).", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542593650", "createdAt": "2020-12-14T18:04:15Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -651,16 +648,24 @@ private void fireTimer(Tenant tenant, ModuleDescriptor md, RoutingEntry re, Stri\n   }\n \n   private Future<Void> invokePermissionsForModule(Tenant tenant, ModuleDescriptor mdTo,\n-                                                  ModuleDescriptor permsModule, ProxyContext pc) {\n+      ModuleDescriptor mdFrom, ModuleDescriptor permsModule, ProxyContext pc) {\n \n     logger.debug(\"Loading permissions for {} (using {})\", mdTo.getName(), permsModule.getName());\n     String moduleTo = mdTo.getId();\n     PermissionList pl = null;\n     InterfaceDescriptor permInt = permsModule.getSystemInterface(\"_tenantPermissions\");\n-    if (permInt.getVersion().equals(\"1.0\")) {\n-      pl = new PermissionList(moduleTo, mdTo.getPermissionSets());\n+    String permIntVer = permInt.getVersion();\n+    if (permIntVer.equals(\"1.0\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getPermissionSets());\n+    } else if (permIntVer.equals(\"1.1\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getExpandedPermissionSets());\n     } else {\n-      pl = new PermissionList(moduleTo, mdTo.getExpandedPermissionSets());\n+      if (mdFrom != null) {\n+        pl = new PermissionListV2(moduleTo, mdFrom.getId(), mdTo.getExpandedPermissionSets(),\n+            mdFrom.getExpandedPermissionSets());\n+      } else {\n+        pl = new PermissionListV2(moduleTo, mdTo.getExpandedPermissionSets());\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a34a40dcbe4e020dbf60ed245be66c8fbd77de3"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxMDI1MA==", "bodyText": "And in the case where we get something other than 1.0, 1.1, or 2.0, also return a failure?  I guess the assumption there is that when/if 2.1 comes along we'll need to make changes here anyway?", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542610250", "createdAt": "2020-12-14T18:24:58Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -651,16 +648,24 @@ private void fireTimer(Tenant tenant, ModuleDescriptor md, RoutingEntry re, Stri\n   }\n \n   private Future<Void> invokePermissionsForModule(Tenant tenant, ModuleDescriptor mdTo,\n-                                                  ModuleDescriptor permsModule, ProxyContext pc) {\n+      ModuleDescriptor mdFrom, ModuleDescriptor permsModule, ProxyContext pc) {\n \n     logger.debug(\"Loading permissions for {} (using {})\", mdTo.getName(), permsModule.getName());\n     String moduleTo = mdTo.getId();\n     PermissionList pl = null;\n     InterfaceDescriptor permInt = permsModule.getSystemInterface(\"_tenantPermissions\");\n-    if (permInt.getVersion().equals(\"1.0\")) {\n-      pl = new PermissionList(moduleTo, mdTo.getPermissionSets());\n+    String permIntVer = permInt.getVersion();\n+    if (permIntVer.equals(\"1.0\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getPermissionSets());\n+    } else if (permIntVer.equals(\"1.1\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getExpandedPermissionSets());\n     } else {\n-      pl = new PermissionList(moduleTo, mdTo.getExpandedPermissionSets());\n+      if (mdFrom != null) {\n+        pl = new PermissionListV2(moduleTo, mdFrom.getId(), mdTo.getExpandedPermissionSets(),\n+            mdFrom.getExpandedPermissionSets());\n+      } else {\n+        pl = new PermissionListV2(moduleTo, mdTo.getExpandedPermissionSets());\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MzY1MA=="}, "originalCommit": {"oid": "3a34a40dcbe4e020dbf60ed245be66c8fbd77de3"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxMTIwNg==", "bodyText": "NM I need to read more closely.", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542611206", "createdAt": "2020-12-14T18:25:45Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -651,16 +648,24 @@ private void fireTimer(Tenant tenant, ModuleDescriptor md, RoutingEntry re, Stri\n   }\n \n   private Future<Void> invokePermissionsForModule(Tenant tenant, ModuleDescriptor mdTo,\n-                                                  ModuleDescriptor permsModule, ProxyContext pc) {\n+      ModuleDescriptor mdFrom, ModuleDescriptor permsModule, ProxyContext pc) {\n \n     logger.debug(\"Loading permissions for {} (using {})\", mdTo.getName(), permsModule.getName());\n     String moduleTo = mdTo.getId();\n     PermissionList pl = null;\n     InterfaceDescriptor permInt = permsModule.getSystemInterface(\"_tenantPermissions\");\n-    if (permInt.getVersion().equals(\"1.0\")) {\n-      pl = new PermissionList(moduleTo, mdTo.getPermissionSets());\n+    String permIntVer = permInt.getVersion();\n+    if (permIntVer.equals(\"1.0\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getPermissionSets());\n+    } else if (permIntVer.equals(\"1.1\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getExpandedPermissionSets());\n     } else {\n-      pl = new PermissionList(moduleTo, mdTo.getExpandedPermissionSets());\n+      if (mdFrom != null) {\n+        pl = new PermissionListV2(moduleTo, mdFrom.getId(), mdTo.getExpandedPermissionSets(),\n+            mdFrom.getExpandedPermissionSets());\n+      } else {\n+        pl = new PermissionListV2(moduleTo, mdTo.getExpandedPermissionSets());\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MzY1MA=="}, "originalCommit": {"oid": "3a34a40dcbe4e020dbf60ed245be66c8fbd77de3"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxNTMwNQ==", "bodyText": "Yes. Okapi should report a failure for an unknown interface version.", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542615305", "createdAt": "2020-12-14T18:29:20Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -651,16 +648,24 @@ private void fireTimer(Tenant tenant, ModuleDescriptor md, RoutingEntry re, Stri\n   }\n \n   private Future<Void> invokePermissionsForModule(Tenant tenant, ModuleDescriptor mdTo,\n-                                                  ModuleDescriptor permsModule, ProxyContext pc) {\n+      ModuleDescriptor mdFrom, ModuleDescriptor permsModule, ProxyContext pc) {\n \n     logger.debug(\"Loading permissions for {} (using {})\", mdTo.getName(), permsModule.getName());\n     String moduleTo = mdTo.getId();\n     PermissionList pl = null;\n     InterfaceDescriptor permInt = permsModule.getSystemInterface(\"_tenantPermissions\");\n-    if (permInt.getVersion().equals(\"1.0\")) {\n-      pl = new PermissionList(moduleTo, mdTo.getPermissionSets());\n+    String permIntVer = permInt.getVersion();\n+    if (permIntVer.equals(\"1.0\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getPermissionSets());\n+    } else if (permIntVer.equals(\"1.1\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getExpandedPermissionSets());\n     } else {\n-      pl = new PermissionList(moduleTo, mdTo.getExpandedPermissionSets());\n+      if (mdFrom != null) {\n+        pl = new PermissionListV2(moduleTo, mdFrom.getId(), mdTo.getExpandedPermissionSets(),\n+            mdFrom.getExpandedPermissionSets());\n+      } else {\n+        pl = new PermissionListV2(moduleTo, mdTo.getExpandedPermissionSets());\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MzY1MA=="}, "originalCommit": {"oid": "3a34a40dcbe4e020dbf60ed245be66c8fbd77de3"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwOTY4MDc4OnYy", "diffSide": "RIGHT", "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozMzo1NVrOIFjEjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozNjo0OFrOIFjQ4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4ODM5Ng==", "bodyText": "I prefer you use ErrorType.USER here so that it returns 400, not 500. I think we should only return 500 when Okapi makes unexpected failures that are \"not meant to happen\".", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542688396", "createdAt": "2020-12-14T19:33:55Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -659,13 +659,16 @@ private void fireTimer(Tenant tenant, ModuleDescriptor md, RoutingEntry re, Stri\n       pl = new PermissionListV1(moduleTo, mdTo.getPermissionSets());\n     } else if (permIntVer.equals(\"1.1\")) {\n       pl = new PermissionListV1(moduleTo, mdTo.getExpandedPermissionSets());\n-    } else {\n+    } else if (permIntVer.equals(\"2.0\")) {\n       if (mdFrom != null) {\n         pl = new PermissionListV2(moduleTo, mdFrom.getId(), mdTo.getExpandedPermissionSets(),\n             mdFrom.getExpandedPermissionSets());\n       } else {\n         pl = new PermissionListV2(moduleTo, mdTo.getExpandedPermissionSets());\n       }\n+    } else {\n+      return Future.failedFuture(new OkapiError(ErrorType.ANY,\n+          \"Unknown version of _tenantPermissions interface in use \" + permIntVer + \".\"));\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd54e81400e43f05c3f45a14f7fbc8adc508cabd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MTU1Mw==", "bodyText": "fair enough", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542691553", "createdAt": "2020-12-14T19:36:48Z", "author": {"login": "craigmcnally"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -659,13 +659,16 @@ private void fireTimer(Tenant tenant, ModuleDescriptor md, RoutingEntry re, Stri\n       pl = new PermissionListV1(moduleTo, mdTo.getPermissionSets());\n     } else if (permIntVer.equals(\"1.1\")) {\n       pl = new PermissionListV1(moduleTo, mdTo.getExpandedPermissionSets());\n-    } else {\n+    } else if (permIntVer.equals(\"2.0\")) {\n       if (mdFrom != null) {\n         pl = new PermissionListV2(moduleTo, mdFrom.getId(), mdTo.getExpandedPermissionSets(),\n             mdFrom.getExpandedPermissionSets());\n       } else {\n         pl = new PermissionListV2(moduleTo, mdTo.getExpandedPermissionSets());\n       }\n+    } else {\n+      return Future.failedFuture(new OkapiError(ErrorType.ANY,\n+          \"Unknown version of _tenantPermissions interface in use \" + permIntVer + \".\"));\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4ODM5Ng=="}, "originalCommit": {"oid": "fd54e81400e43f05c3f45a14f7fbc8adc508cabd"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 102, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}