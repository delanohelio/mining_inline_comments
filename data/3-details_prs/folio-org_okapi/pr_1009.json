{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NzI5NTUw", "number": 1009, "title": "Fixes install does not honor dependencies OKAPI-925", "bodyText": "But needs a good test for it.", "createdAt": "2020-10-21T17:26:18Z", "url": "https://github.com/folio-org/okapi/pull/1009", "merged": true, "mergeCommit": {"oid": "d8d726636655dbf7eb5810aad42160be7c22f042"}, "closed": true, "closedAt": "2020-10-22T13:51:41Z", "author": {"login": "adamdickmeiss"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUwyAXgH2gAyNTA3NzI5NTUwOmNlYjgwNzIzODY4NzE0NmY1NjdjZmUxOGRjODM4YzI3MWFlNGQwZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVCPZEAFqTUxNDc0MzQ4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ceb807238687146f567cfe18dc838c271ae4d0ee", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/ceb807238687146f567cfe18dc838c271ae4d0ee", "committedDate": "2020-10-21T17:25:47Z", "message": "Fixes install does not honor dependencies OKAPI-925\n\nBut needs a good test for it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75fba27d8a6fb0eb62f2b662191da92c5811c02a", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/75fba27d8a6fb0eb62f2b662191da92c5811c02a", "committedDate": "2020-10-22T08:24:07Z", "message": "Little more testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a75380804e2d96d327ec1ddbfa626955be7a0e00", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/a75380804e2d96d327ec1ddbfa626955be7a0e00", "committedDate": "2020-10-22T08:58:05Z", "message": "Provoke upgradeLeafs error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NjgyMDY4", "url": "https://github.com/folio-org/okapi/pull/1009#pullrequestreview-514682068", "createdAt": "2020-10-22T12:43:21Z", "commit": {"oid": "a75380804e2d96d327ec1ddbfa626955be7a0e00"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjo0MzoyMVrOHmfzyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjo0MzoyMVrOHmfzyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEyOTA5OQ==", "bodyText": "The list values are not needed. This can be simplified if upgradeLeafs2 returns a boolean that is true if something upgraded:\nwhile (upgradeLeafs2(modsAvailable, modsEnabled, tml)) {\n  // something upgraded.. try again\n}", "url": "https://github.com/folio-org/okapi/pull/1009#discussion_r510129099", "createdAt": "2020-10-22T12:43:21Z", "author": {"login": "julianladisch"}, "path": "okapi-core/src/main/java/org/folio/okapi/util/DepResolution.java", "diffHunk": "@@ -506,27 +506,41 @@ private static void addOrReplace(List<TenantModuleDescriptor> tml, ModuleDescrip\n   }\n \n   private static void upgradeLeafs(\n-      ModuleDescriptor md, Map<String, ModuleDescriptor> modsAvailable,\n+      Map<String, ModuleDescriptor> modsAvailable,\n       Map<String, ModuleDescriptor> modsEnabled, List<TenantModuleDescriptor> tml) {\n-    Iterator<ModuleDescriptor> it = modsEnabled.values().iterator();\n-    while (it.hasNext()) {\n-      ModuleDescriptor me = it.next();\n-      if (me.equals(md)) {\n-        continue;\n+    while (true) {\n+      List<String> ret = upgradeLeafs2(modsAvailable, modsEnabled, tml);\n+      if (ret == null) { // nothing done\n+        return;\n+      }\n+      if (!ret.isEmpty()) { // error\n+        return;\n       }\n-      ModuleDescriptor mdTo = null;\n-      for (InterfaceDescriptor prov : md.getProvidesList()) {\n-        for (InterfaceDescriptor req : me.getRequiresOptionalList()) {\n-          if (prov.getId().equals(req.getId()) && !prov.isCompatible(req)) {\n-            mdTo = lookupAvailableForProvided(modsAvailable, me, prov, mdTo);\n+      // something upgraded.. try again\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a75380804e2d96d327ec1ddbfa626955be7a0e00"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd837d110d798ad6584232980cdf3f7aa2120c44", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/bd837d110d798ad6584232980cdf3f7aa2120c44", "committedDate": "2020-10-22T13:01:49Z", "message": "upgradeLeafs2 returns boolean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cf7aba3040e3d958e6686b78d84437e249c8160", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/5cf7aba3040e3d958e6686b78d84437e249c8160", "committedDate": "2020-10-22T13:12:48Z", "message": "Merge remote-tracking branch 'origin/master' into OKAPI-925-install-does-not-honor-specified-modules-ids"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a09dd855474c45eac58c6ca4c5c0cae1f8644e6c", "author": {"user": {"login": "adamdickmeiss", "name": "Adam Dickmeiss"}}, "url": "https://github.com/folio-org/okapi/commit/a09dd855474c45eac58c6ca4c5c0cae1f8644e6c", "committedDate": "2020-10-22T13:20:09Z", "message": "Merge branch 'master' into OKAPI-925-install-does-not-honor-specified-modules-ids"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NzQzNDg1", "url": "https://github.com/folio-org/okapi/pull/1009#pullrequestreview-514743485", "createdAt": "2020-10-22T13:46:16Z", "commit": {"oid": "a09dd855474c45eac58c6ca4c5c0cae1f8644e6c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2879, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}