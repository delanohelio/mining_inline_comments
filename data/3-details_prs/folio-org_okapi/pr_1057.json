{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2OTAwMTk5", "number": 1057, "title": "OKAPI-947 - Updates for static permissions migration", "bodyText": "Purpose\nImplement changes to facilitate static permission migration.  For details, see https://wiki.folio.org/display/DD/Migration+of+Static+Permissions+Upon+Upgrade?src=contextnavpagetreemode\nAlso see:  https://issues.folio.org/browse/OKAPI-947\nApproach\n\nAdd a renamedFrom field to the module descriptor permission schema indicating a permission's previously used name(s)\nAdjust the payload for the _tenantPermissions call to include:\n\nmoduleIdFrom - the name/version of the module currently in use/being upgraded from (if applicable)\npermsFrom - the list of permissions defined by the version of the module currently in use (if applicable)\npermsTo - renamed from perms for clarity.\nmoduleIdTo - renamed from moduleId for clarity.\n\n\nWhen upgrading mod-permissions, call the _tenantPermissions API for each module enabled for the tenant, resulting in the permissions being refreshed.  This is already done when first enabling mod-permissions install, but is now also done when upgrading it.", "createdAt": "2020-12-11T13:33:10Z", "url": "https://github.com/folio-org/okapi/pull/1057", "merged": true, "mergeCommit": {"oid": "5c47e2ffd3bc92b572f227c1a7ca63f8ed5778be"}, "closed": true, "closedAt": "2020-12-14T22:38:55Z", "author": {"login": "craigmcnally"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlH5DQgH2gAyNTM2OTAwMTk5OmM4MjM3YzYxM2YxNDEwMTU0NDYzMGIxYjM3Njc3MzFlZjRmMGE1ZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmLnHJAH2gAyNTM2OTAwMTk5OmFkNjA4MDhiNWExMzBhNzQ2N2UyN2M4MDEyY2Y5ZTNjMmI4MTk1ZjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c8237c613f14101544630b1b3767731ef4f0a5d4", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/c8237c613f14101544630b1b3767731ef4f0a5d4", "committedDate": "2020-12-11T13:24:05Z", "message": "OKAPI-947 Adjust payload for _tenantPermissions, add renamedFrom field to MD, and refresh perms on all mod-permissions install/upgrades"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "668ba3eb3d9674606b1f11fb70e422ae5ac07261", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/668ba3eb3d9674606b1f11fb70e422ae5ac07261", "committedDate": "2020-12-11T15:22:56Z", "message": "Merge branch 'master' into OKAPI-947"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwODM4MjU1", "url": "https://github.com/folio-org/okapi/pull/1057#pullrequestreview-550838255", "createdAt": "2020-12-12T15:23:04Z", "commit": {"oid": "668ba3eb3d9674606b1f11fb70e422ae5ac07261"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ae21881e1a9e82a6d038d1b37cdd3ab994cc4d9", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/6ae21881e1a9e82a6d038d1b37cdd3ab994cc4d9", "committedDate": "2020-12-14T13:25:37Z", "message": "Merge branch 'master' into OKAPI-947"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a34a40dcbe4e020dbf60ed245be66c8fbd77de3", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/3a34a40dcbe4e020dbf60ed245be66c8fbd77de3", "committedDate": "2020-12-14T17:45:45Z", "message": "support _tenantPermissions 1.0, 1.1, 2.0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNzQxNzg3", "url": "https://github.com/folio-org/okapi/pull/1057#pullrequestreview-551741787", "createdAt": "2020-12-14T18:04:15Z", "commit": {"oid": "3a34a40dcbe4e020dbf60ed245be66c8fbd77de3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODowNDoxNVrOIFdScg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxODowNDoxNVrOIFdScg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MzY1MA==", "bodyText": "Please add check for \"2.0\". And report failure if no match (return failed future).", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542593650", "createdAt": "2020-12-14T18:04:15Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -651,16 +648,24 @@ private void fireTimer(Tenant tenant, ModuleDescriptor md, RoutingEntry re, Stri\n   }\n \n   private Future<Void> invokePermissionsForModule(Tenant tenant, ModuleDescriptor mdTo,\n-                                                  ModuleDescriptor permsModule, ProxyContext pc) {\n+      ModuleDescriptor mdFrom, ModuleDescriptor permsModule, ProxyContext pc) {\n \n     logger.debug(\"Loading permissions for {} (using {})\", mdTo.getName(), permsModule.getName());\n     String moduleTo = mdTo.getId();\n     PermissionList pl = null;\n     InterfaceDescriptor permInt = permsModule.getSystemInterface(\"_tenantPermissions\");\n-    if (permInt.getVersion().equals(\"1.0\")) {\n-      pl = new PermissionList(moduleTo, mdTo.getPermissionSets());\n+    String permIntVer = permInt.getVersion();\n+    if (permIntVer.equals(\"1.0\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getPermissionSets());\n+    } else if (permIntVer.equals(\"1.1\")) {\n+      pl = new PermissionListV1(moduleTo, mdTo.getExpandedPermissionSets());\n     } else {\n-      pl = new PermissionList(moduleTo, mdTo.getExpandedPermissionSets());\n+      if (mdFrom != null) {\n+        pl = new PermissionListV2(moduleTo, mdFrom.getId(), mdTo.getExpandedPermissionSets(),\n+            mdFrom.getExpandedPermissionSets());\n+      } else {\n+        pl = new PermissionListV2(moduleTo, mdTo.getExpandedPermissionSets());\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a34a40dcbe4e020dbf60ed245be66c8fbd77de3"}, "originalPosition": 106}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd54e81400e43f05c3f45a14f7fbc8adc508cabd", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/fd54e81400e43f05c3f45a14f7fbc8adc508cabd", "committedDate": "2020-12-14T19:15:16Z", "message": "OKAPI-947 explicit check for known _tenantPermissions version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f7af520866a184a18ef1f53e34af6055806f0ea", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/5f7af520866a184a18ef1f53e34af6055806f0ea", "committedDate": "2020-12-14T19:16:08Z", "message": "Merge branch 'master' into OKAPI-947"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODI3NTgx", "url": "https://github.com/folio-org/okapi/pull/1057#pullrequestreview-551827581", "createdAt": "2020-12-14T19:33:55Z", "commit": {"oid": "fd54e81400e43f05c3f45a14f7fbc8adc508cabd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozMzo1NVrOIFjEjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozMzo1NVrOIFjEjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4ODM5Ng==", "bodyText": "I prefer you use ErrorType.USER here so that it returns 400, not 500. I think we should only return 500 when Okapi makes unexpected failures that are \"not meant to happen\".", "url": "https://github.com/folio-org/okapi/pull/1057#discussion_r542688396", "createdAt": "2020-12-14T19:33:55Z", "author": {"login": "adamdickmeiss"}, "path": "okapi-core/src/main/java/org/folio/okapi/managers/TenantManager.java", "diffHunk": "@@ -659,13 +659,16 @@ private void fireTimer(Tenant tenant, ModuleDescriptor md, RoutingEntry re, Stri\n       pl = new PermissionListV1(moduleTo, mdTo.getPermissionSets());\n     } else if (permIntVer.equals(\"1.1\")) {\n       pl = new PermissionListV1(moduleTo, mdTo.getExpandedPermissionSets());\n-    } else {\n+    } else if (permIntVer.equals(\"2.0\")) {\n       if (mdFrom != null) {\n         pl = new PermissionListV2(moduleTo, mdFrom.getId(), mdTo.getExpandedPermissionSets(),\n             mdFrom.getExpandedPermissionSets());\n       } else {\n         pl = new PermissionListV2(moduleTo, mdTo.getExpandedPermissionSets());\n       }\n+    } else {\n+      return Future.failedFuture(new OkapiError(ErrorType.ANY,\n+          \"Unknown version of _tenantPermissions interface in use \" + permIntVer + \".\"));\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd54e81400e43f05c3f45a14f7fbc8adc508cabd"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "427db73115b9d51881068d0be1463fcfb4fdab18", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/427db73115b9d51881068d0be1463fcfb4fdab18", "committedDate": "2020-12-14T19:38:45Z", "message": "OKAPI-947 User error not server error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f7260e1598a40c3d54979d7a170acf1fc71a13e", "author": {"user": {"login": "craigmcnally", "name": "Craig McNally"}}, "url": "https://github.com/folio-org/okapi/commit/3f7260e1598a40c3d54979d7a170acf1fc71a13e", "committedDate": "2020-12-14T19:39:42Z", "message": "Merge branch 'master' into OKAPI-947"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODMyMDQ0", "url": "https://github.com/folio-org/okapi/pull/1057#pullrequestreview-551832044", "createdAt": "2020-12-14T19:39:59Z", "commit": {"oid": "3f7260e1598a40c3d54979d7a170acf1fc71a13e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad60808b5a130a7467e27c8012cf9e3c2b8195f3", "author": {"user": {"login": "hjiebsco", "name": "Hongwei Ji"}}, "url": "https://github.com/folio-org/okapi/commit/ad60808b5a130a7467e27c8012cf9e3c2b8195f3", "committedDate": "2020-12-14T20:18:02Z", "message": "Merge branch 'master' into OKAPI-947"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2791, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}