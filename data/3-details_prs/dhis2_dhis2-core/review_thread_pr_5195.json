{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1MDk5OTg3", "number": 5195, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzo0NDo1M1rODsjIpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzo0NjozN1rODsjLBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MDM5NTg5OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-analytics/src/test/java/org/hisp/dhis/analytics/event/data/EventsAnalyticsManagerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzo0NDo1M1rOF9dTcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzo0NDo1M1rOF9dTcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NzU3MQ==", "bodyText": "Style, a few missing spaces", "url": "https://github.com/dhis2/dhis2-core/pull/5195#discussion_r399987571", "createdAt": "2020-03-30T07:44:53Z", "author": {"login": "Bekkalizer"}, "path": "dhis-2/dhis-services/dhis-service-analytics/src/test/java/org/hisp/dhis/analytics/event/data/EventsAnalyticsManagerTest.java", "diffHunk": "@@ -272,6 +285,41 @@ public void verifyLastAggregationTypeSubquery()\n         verifyFirstOrLastAggregationTypeSubquery( AnalyticsAggregationType.LAST );\n     }\n \n+    @Test\n+    public void verifySortClauseHandlesProgramIndicators()\n+    {\n+        Program program = createProgram( 'P' );\n+        ProgramIndicator piA = createProgramIndicator( 'A', program, \".\", \".\" );\n+        piA.setUid( \"TLKx7vllb1I\" );\n+\n+        ProgramIndicator piB = createProgramIndicator( 'B', program, \".\", \".\" );\n+        piA.setUid( \"CCKx3gllb2P\" );\n+\n+        OrganisationUnit ouA = createOrganisationUnit( 'A' );\n+        Period peA = PeriodType.getPeriodFromIsoString( \"201501\" );\n+\n+        DataElement deA = createDataElement( 'A' );\n+        deA.setUid( \"ZE4cgllb2P\");\n+\n+        DataQueryParams params = DataQueryParams.newBuilder().withDataType( DataType.NUMERIC )\n+            .withTableName( \"analytics\" ).withPeriodType( QuarterlyPeriodType.NAME )\n+            .withAggregationType( AnalyticsAggregationType.fromAggregationType( AggregationType.DEFAULT ) )\n+            .addDimension( new BaseDimensionalObject( DATA_X_DIM_ID, DimensionType.PROGRAM_INDICATOR, getList( piA, piB ) ) )\n+            .addFilter( new BaseDimensionalObject( ORGUNIT_DIM_ID, DimensionType.ORGANISATION_UNIT, getList( ouA ) ) )\n+            .addDimension( new BaseDimensionalObject( PERIOD_DIM_ID, DimensionType.DATA_X, getList( peA ) ) )\n+            .addDimension( new BaseDimensionalObject( PERIOD_DIM_ID, DimensionType.PERIOD, getList( peA ) ) ).build();\n+\n+        final EventQueryParams.Builder eventQueryParamsBuilder = new EventQueryParams.Builder( params )\n+            .withProgram( program )\n+            .addAscSortItem( piA )\n+            .addDescSortItem( piB )\n+            .addAscSortItem( deA );\n+\n+        final String sql = subject.getEventsOrEnrollmentsSql( eventQueryParamsBuilder.build(), 100 );\n+\n+        assertThat(sql, containsString(\"order by \\\"\" + piA.getUid() + \"\\\" asc,ax.\\\"\" + deA.getUid() + \"\\\" asc,\\\"\" + piB.getUid() + \"\\\"\" ));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b567df3a2a797e21489598f59e93a1db97085201"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MDQwMTk4OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-analytics/src/main/java/org/hisp/dhis/analytics/event/data/AbstractJdbcEventAnalyticsManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzo0NjozN1rOF9dXFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODowMTo0NFrOF9d3Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4ODUwMw==", "bodyText": "Concider using the SortOrder type?\ndhis-2/dhis-api/src/main/java/org/hisp/dhis/analytics/SortOrder.java", "url": "https://github.com/dhis2/dhis2-core/pull/5195#discussion_r399988503", "createdAt": "2020-03-30T07:46:37Z", "author": {"login": "Bekkalizer"}, "path": "dhis-2/dhis-services/dhis-service-analytics/src/main/java/org/hisp/dhis/analytics/event/data/AbstractJdbcEventAnalyticsManager.java", "diffHunk": "@@ -134,19 +141,29 @@ private String getSortClause( EventQueryParams params )\n \n         if ( params.isSorting() )\n         {\n-            sql += \"order by \";\n+            sql += \"order by \" + getSortColumns( params, \"asc\" ) + getSortColumns( params, \"desc\" );\n \n-            for ( DimensionalItemObject item : params.getAsc() )\n+            sql = TextUtils.removeLastComma( sql ) + \" \";\n+        }\n+\n+        return sql;\n+    }\n+\n+    private String getSortColumns(EventQueryParams params , String order) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b567df3a2a797e21489598f59e93a1db97085201"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5Njc1OA==", "bodyText": "Yes!", "url": "https://github.com/dhis2/dhis2-core/pull/5195#discussion_r399996758", "createdAt": "2020-03-30T08:01:44Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-services/dhis-service-analytics/src/main/java/org/hisp/dhis/analytics/event/data/AbstractJdbcEventAnalyticsManager.java", "diffHunk": "@@ -134,19 +141,29 @@ private String getSortClause( EventQueryParams params )\n \n         if ( params.isSorting() )\n         {\n-            sql += \"order by \";\n+            sql += \"order by \" + getSortColumns( params, \"asc\" ) + getSortColumns( params, \"desc\" );\n \n-            for ( DimensionalItemObject item : params.getAsc() )\n+            sql = TextUtils.removeLastComma( sql ) + \" \";\n+        }\n+\n+        return sql;\n+    }\n+\n+    private String getSortColumns(EventQueryParams params , String order) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4ODUwMw=="}, "originalCommit": {"oid": "b567df3a2a797e21489598f59e93a1db97085201"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3498, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}