{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNTgzNzA1", "number": 5145, "title": "fix: Add index to trackedentityattributevalue table", "bodyText": "", "createdAt": "2020-03-20T15:09:07Z", "url": "https://github.com/dhis2/dhis2-core/pull/5145", "merged": true, "mergeCommit": {"oid": "f06703a1641524633e08f937ef3fa33349c34e60"}, "closed": true, "closedAt": "2020-04-02T07:06:46Z", "author": {"login": "stian-sandvold"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPh8cXAH2gAyMzkxNTgzNzA1OmZjYjI0ZTlhMzQ5ZjhhMTNlMjAxYTlhZmFhNmU0NGJhZmMyYzZmMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTVyCLAFqTM4NTQ4NjI3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fcb24e9a349f8a13e201a9afaa6e44bafc2c6f1a", "author": {"user": null}, "url": "https://github.com/dhis2/dhis2-core/commit/fcb24e9a349f8a13e201a9afaa6e44bafc2c6f1a", "committedDate": "2020-03-20T15:07:50Z", "message": "Add flyway script for adding btree index to trackedentityattributevalue table"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTc1Mzk2", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-378575396", "createdAt": "2020-03-20T15:19:18Z", "commit": {"oid": "fcb24e9a349f8a13e201a9afaa6e44bafc2c6f1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTkwMzM1", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-378590335", "createdAt": "2020-03-20T15:36:35Z", "commit": {"oid": "fcb24e9a349f8a13e201a9afaa6e44bafc2c6f1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTozNjozNVrOF5YyLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTozNjozNVrOF5YyLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcxOTIxMg==", "bodyText": "Perhaps add a bit more:\n\nCould not add btree-index to table 'trackedentityattributevalue', likely because the value column contains values which are longer than the index max size:\n\nAnd use String.format()", "url": "https://github.com/dhis2/dhis2-core/pull/5145#discussion_r395719212", "createdAt": "2020-03-20T15:36:35Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v34/V2_34_22__Add_teav_btree_index.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package org.hisp.dhis.db.migration.v34;\n+\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+public class V2_34_22__Add_teav_btree_index extends BaseJavaMigration\n+{\n+    private static final Logger log = LoggerFactory.getLogger( V2_34_22__Add_teav_btree_index.class );\n+\n+    @Override\n+    public void migrate( Context context )\n+        throws Exception\n+    {\n+        try ( Statement statement = context.getConnection().createStatement() )\n+        {\n+            statement.execute( \"create index in_attribute_value on trackedentityattributevalue using btree (trackedentityattributeid, lower(value)) \" );\n+        }\n+        catch ( SQLException sqlException )\n+        {\n+            log.warn( \"Could not add btree-index to table 'trackedentityattributevalue': \" + sqlException.getMessage() );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcb24e9a349f8a13e201a9afaa6e44bafc2c6f1a"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MDI5NjU1", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-379029655", "createdAt": "2020-03-22T17:43:16Z", "commit": {"oid": "fcb24e9a349f8a13e201a9afaa6e44bafc2c6f1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQxNzo0MzoxNlrOF5xTqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQxNzo0MzoxNlrOF5xTqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyMTAwMg==", "bodyText": "I think we need to enforce a max length (e.g. 1200) on TEI attribute values in the same PR to avoid too long values failing to be persisted.", "url": "https://github.com/dhis2/dhis2-core/pull/5145#discussion_r396121002", "createdAt": "2020-03-22T17:43:16Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v34/V2_34_22__Add_teav_btree_index.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package org.hisp.dhis.db.migration.v34;\n+\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+public class V2_34_22__Add_teav_btree_index extends BaseJavaMigration\n+{\n+    private static final Logger log = LoggerFactory.getLogger( V2_34_22__Add_teav_btree_index.class );\n+\n+    @Override\n+    public void migrate( Context context )\n+        throws Exception\n+    {\n+        try ( Statement statement = context.getConnection().createStatement() )\n+        {\n+            statement.execute( \"create index in_attribute_value on trackedentityattributevalue using btree (trackedentityattributeid, lower(value)) \" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcb24e9a349f8a13e201a9afaa6e44bafc2c6f1a"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b9bc4ba295fa0cee174ccf9865e949eab963154", "author": {"user": null}, "url": "https://github.com/dhis2/dhis2-core/commit/8b9bc4ba295fa0cee174ccf9865e949eab963154", "committedDate": "2020-03-23T14:56:50Z", "message": "Add test. Add validation for string length. Add upgrade for varchar(1200)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fcb0879d26e0230e556466e7e44c4efa29c13e9", "author": {"user": null}, "url": "https://github.com/dhis2/dhis2-core/commit/0fcb0879d26e0230e556466e7e44c4efa29c13e9", "committedDate": "2020-03-23T14:59:15Z", "message": "codestyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "786691f6791bcf2c1292854e232eb9f84edaf46d", "author": {"user": {"login": "stian-sandvold", "name": "Stian Sandvold"}}, "url": "https://github.com/dhis2/dhis2-core/commit/786691f6791bcf2c1292854e232eb9f84edaf46d", "committedDate": "2020-03-24T08:36:51Z", "message": "Add constant when refering to max value size. Fixed minor issues. Added String.format."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5261275ff18c69131d6223f4f16efa18e525c07c", "author": {"user": {"login": "stian-sandvold", "name": "Stian Sandvold"}}, "url": "https://github.com/dhis2/dhis2-core/commit/5261275ff18c69131d6223f4f16efa18e525c07c", "committedDate": "2020-03-24T08:40:01Z", "message": "Made COP_POST_URL static"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTEwNDI4", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-380110428", "createdAt": "2020-03-24T09:00:55Z", "commit": {"oid": "0fcb0879d26e0230e556466e7e44c4efa29c13e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTowMDo1NVrOF6mkBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTowMDo1NVrOF6mkBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5MzU0MA==", "bodyText": "Lets move \"1200\" to a constant and re-use across the classes.", "url": "https://github.com/dhis2/dhis2-core/pull/5145#discussion_r396993540", "createdAt": "2020-03-24T09:00:55Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/enrollment/AbstractEnrollmentService.java", "diffHunk": "@@ -1215,6 +1215,14 @@ private boolean doValidationOfMandatoryAttributes( User user )\n                 continue;\n             }\n \n+\n+            if ( attributeValueMap.get( trackedEntityAttribute.getUid() ).length() > 1200 )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fcb0879d26e0230e556466e7e44c4efa29c13e9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTEwNjk3", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-380110697", "createdAt": "2020-03-24T09:01:16Z", "commit": {"oid": "0fcb0879d26e0230e556466e7e44c4efa29c13e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTowMToxNlrOF6mkzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTowMToxNlrOF6mkzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5Mzc0Mg==", "bodyText": "Code style,  space.", "url": "https://github.com/dhis2/dhis2-core/pull/5145#discussion_r396993742", "createdAt": "2020-03-24T09:01:16Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v34/V2_34_22__Add_teav_btree_index.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.hisp.dhis.db.migration.v34;\n+\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+public class V2_34_22__Add_teav_btree_index\n+    extends BaseJavaMigration\n+{\n+\n+    private final String COP_POST_URL = \"https://community.dhis2.org/t/draft-important-database-upgrade-for-tracker-performance/38766\";\n+\n+    @Override\n+    public void migrate( Context context )\n+        throws Exception\n+    {\n+        try (Statement statement = context.getConnection().createStatement())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fcb0879d26e0230e556466e7e44c4efa29c13e9"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTExMDM4", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-380111038", "createdAt": "2020-03-24T09:01:44Z", "commit": {"oid": "0fcb0879d26e0230e556466e7e44c4efa29c13e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTowMTo0NVrOF6ml7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTowMTo0NVrOF6ml7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5NDAyOA==", "bodyText": "Add class javadoc about what this migration is doing and the \"special case\" of catching failing index creation.", "url": "https://github.com/dhis2/dhis2-core/pull/5145#discussion_r396994028", "createdAt": "2020-03-24T09:01:45Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v34/V2_34_22__Add_teav_btree_index.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.hisp.dhis.db.migration.v34;\n+\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+public class V2_34_22__Add_teav_btree_index", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fcb0879d26e0230e556466e7e44c4efa29c13e9"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTExMjQw", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-380111240", "createdAt": "2020-03-24T09:01:58Z", "commit": {"oid": "0fcb0879d26e0230e556466e7e44c4efa29c13e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTowMTo1OFrOF6mmeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTowMTo1OFrOF6mmeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5NDE2OQ==", "bodyText": "Use constant for 1200.", "url": "https://github.com/dhis2/dhis2-core/pull/5145#discussion_r396994169", "createdAt": "2020-03-24T09:01:58Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v34/V2_34_22__Add_teav_btree_index.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.hisp.dhis.db.migration.v34;\n+\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+public class V2_34_22__Add_teav_btree_index\n+    extends BaseJavaMigration\n+{\n+\n+    private final String COP_POST_URL = \"https://community.dhis2.org/t/draft-important-database-upgrade-for-tracker-performance/38766\";\n+\n+    @Override\n+    public void migrate( Context context )\n+        throws Exception\n+    {\n+        try (Statement statement = context.getConnection().createStatement())\n+        {\n+            statement\n+                .execute( \"alter table trackedentityattributevalue alter column value set data type varchar(1200)\" );\n+            statement.execute(\n+                \"create index in_trackedentity_attribute_value on trackedentityattributevalue using btree (trackedentityattributeid, lower(value)) \" );\n+        }\n+        catch ( SQLException sqlException )\n+        {\n+            StringBuilder stringBuilder = new StringBuilder(  );\n+\n+            stringBuilder\n+                .append( \"Could not perform upgrade of table 'trackedentityattributevalue'. \" )\n+                .append( \"Column 'value' should be altered to data type varchar(1200) and receive a new index. \" )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fcb0879d26e0230e556466e7e44c4efa29c13e9"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTcxMjY0", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-380171264", "createdAt": "2020-03-24T10:20:44Z", "commit": {"oid": "5261275ff18c69131d6223f4f16efa18e525c07c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoyMDo0NFrOF6plzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoyMDo0NFrOF6plzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MzE1MA==", "bodyText": "Is this URL available right now? Or is it private? When I tried it said \"Page doesnt exist, or is private\"", "url": "https://github.com/dhis2/dhis2-core/pull/5145#discussion_r397043150", "createdAt": "2020-03-24T10:20:44Z", "author": {"login": "ameenhere"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v34/V2_34_22__Add_teav_btree_index.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package org.hisp.dhis.db.migration.v34;\n+\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+import static org.hisp.dhis.trackedentity.TrackedEntityAttributeService.TEA_VALUE_MAX_LENGTH;\n+\n+/**\n+ * This Java migration changes the data type of the 'value' column in trackedentityattributevalue table to varchar(1200).\n+ * Additionally we put a btree index on the same table, to improve performance of lookup.\n+ * This upograde will fail is any value in the table exceeds 1200 characters. Due to this, we catch any SQLException and\n+ * write a custom message, including a link to a community.dhis2.org post explaining this upgrade, and how to deal with any\n+ * upgrade failures.\n+ *\n+ * @author Stian\n+ */\n+public class V2_34_22__Add_teav_btree_index\n+    extends BaseJavaMigration\n+{\n+    private final static String COP_POST_URL = \"https://community.dhis2.org/t/draft-important-database-upgrade-for-tracker-performance/38766\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5261275ff18c69131d6223f4f16efa18e525c07c"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjI2NDE3", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-380226417", "createdAt": "2020-03-24T11:38:42Z", "commit": {"oid": "5261275ff18c69131d6223f4f16efa18e525c07c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTozODo0MlrOF6sS2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTozODo0MlrOF6sS2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4NzQ0OQ==", "bodyText": "Break on multiple lines with + to avoid weirdness in IDEs.", "url": "https://github.com/dhis2/dhis2-core/pull/5145#discussion_r397087449", "createdAt": "2020-03-24T11:38:42Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-dxf2/src/test/java/org/hisp/dhis/dxf2/events/TrackedEntityInstanceServiceTest.java", "diffHunk": "@@ -503,6 +512,42 @@ public void testDeleteTrackedEntityInstances()\n         assertNull( trackedEntityInstanceService.getTrackedEntityInstance( maleB.getUid() ) );\n     }\n \n+    @Test\n+    public void testTooLongTrackedEntityAttributeValue()\n+    {\n+        TrackedEntityInstance tei = new TrackedEntityInstance();\n+\n+        Attribute attribute = new Attribute( \"01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5261275ff18c69131d6223f4f16efa18e525c07c"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd2ac0665fd973e8c9b72f64d6225b56a30564f1", "author": {"user": null}, "url": "https://github.com/dhis2/dhis2-core/commit/fd2ac0665fd973e8c9b72f64d6225b56a30564f1", "committedDate": "2020-03-24T16:40:45Z", "message": "Clean up test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMTAzOTEy", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-381103912", "createdAt": "2020-03-25T12:34:09Z", "commit": {"oid": "fd2ac0665fd973e8c9b72f64d6225b56a30564f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMjozNDowOVrOF7Y7UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMjozNDowOVrOF7Y7UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgxODcwNQ==", "bodyText": "Codestyle, 4 space indent.", "url": "https://github.com/dhis2/dhis2-core/pull/5145#discussion_r397818705", "createdAt": "2020-03-25T12:34:09Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v34/V2_34_22__Add_teav_btree_index.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package org.hisp.dhis.db.migration.v34;\n+\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+import static org.hisp.dhis.trackedentity.TrackedEntityAttributeService.TEA_VALUE_MAX_LENGTH;\n+\n+/**\n+ * This Java migration changes the data type of the 'value' column in trackedentityattributevalue table to varchar(1200).\n+ * Additionally we put a btree index on the same table, to improve performance of lookup.\n+ * This upograde will fail is any value in the table exceeds 1200 characters. Due to this, we catch any SQLException and\n+ * write a custom message, including a link to a community.dhis2.org post explaining this upgrade, and how to deal with any\n+ * upgrade failures.\n+ *\n+ * @author Stian\n+ */\n+public class V2_34_22__Add_teav_btree_index\n+    extends BaseJavaMigration\n+{\n+    private final static String COP_POST_URL = \"https://community.dhis2.org/t/draft-important-database-upgrade-for-tracker-performance/38766\";\n+\n+    @Override\n+    public void migrate( Context context )\n+        throws Exception\n+    {\n+        try ( Statement statement = context.getConnection().createStatement() )\n+        {\n+            statement\n+                .execute( String.format( \"alter table trackedentityattributevalue alter column value set data type varchar(1200)\", TEA_VALUE_MAX_LENGTH ) );\n+            statement.execute(\n+                \"create index in_trackedentity_attribute_value on trackedentityattributevalue using btree (trackedentityattributeid, lower(value)) \" );\n+        }\n+        catch ( SQLException sqlException )\n+        {\n+            String message = \"Could not perform upgrade of table 'trackedentityattributevalue'. \" +\n+                    String.format( \"Column 'value' should be altered to data type varchar(%s) and receive a new index. \", TEA_VALUE_MAX_LENGTH ) +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd2ac0665fd973e8c9b72f64d6225b56a30564f1"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d9f2bde43fb2e95487f3c5fca7fc830798461fd", "author": {"user": null}, "url": "https://github.com/dhis2/dhis2-core/commit/1d9f2bde43fb2e95487f3c5fca7fc830798461fd", "committedDate": "2020-03-26T13:28:02Z", "message": "minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3631930e4d1aaccc9ca5a4ba3c8f8e5a6cab7366", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3631930e4d1aaccc9ca5a4ba3c8f8e5a6cab7366", "committedDate": "2020-03-26T15:04:24Z", "message": "fix: Made addTeavBtreeIndex script to execute outside main transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aceb273c14f023de1eef5e2259bb85b4c9d054c", "author": {"user": null}, "url": "https://github.com/dhis2/dhis2-core/commit/9aceb273c14f023de1eef5e2259bb85b4c9d054c", "committedDate": "2020-03-27T10:16:01Z", "message": "minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d6f027d68a7f881e810dc9e5b1988174c7132dc", "author": {"user": null}, "url": "https://github.com/dhis2/dhis2-core/commit/7d6f027d68a7f881e810dc9e5b1988174c7132dc", "committedDate": "2020-03-31T12:55:41Z", "message": "merge from master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b96e1a3371fe60a3bee61ddabecc6a91882abe0", "author": {"user": null}, "url": "https://github.com/dhis2/dhis2-core/commit/8b96e1a3371fe60a3bee61ddabecc6a91882abe0", "committedDate": "2020-03-31T13:03:00Z", "message": "Add correct URL for log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NDg2Mjcy", "url": "https://github.com/dhis2/dhis2-core/pull/5145#pullrequestreview-385486272", "createdAt": "2020-04-01T11:13:18Z", "commit": {"oid": "8b96e1a3371fe60a3bee61ddabecc6a91882abe0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2790, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}