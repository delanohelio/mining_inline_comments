{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MDIzNzE2", "number": 6720, "title": "fix: DHIS2-9894 user assignment is checked through ProgramStage definition", "bodyText": "", "createdAt": "2020-11-19T15:11:27Z", "url": "https://github.com/dhis2/dhis2-core/pull/6720", "merged": true, "mergeCommit": {"oid": "e063801f23d5aa761a791364c8c82e2d784f8c84"}, "closed": true, "closedAt": "2020-11-23T08:23:20Z", "author": {"login": "gnespolino"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeEJ22gH2gAyNTI0MDIzNzE2OmQzYWMxMTJiM2E4OWVlNTc0YjlkZTU4M2FlNTZiNjBlYmNlOWIwYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfQzBhAFqTUzNjI0ODQ3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d3ac112b3a89ee574b9de583ae56b60ebce9b0a4", "author": {"user": {"login": "gnespolino", "name": "Giuseppe Nespolino"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d3ac112b3a89ee574b9de583ae56b60ebce9b0a4", "committedDate": "2020-11-19T15:05:21Z", "message": "fix: DHIS2-9894 user assignment is checked through ProgramStage definition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0e2edf11b368ebd28639b22754b49ecb2318d03", "author": {"user": {"login": "gnespolino", "name": "Giuseppe Nespolino"}}, "url": "https://github.com/dhis2/dhis2-core/commit/f0e2edf11b368ebd28639b22754b49ecb2318d03", "committedDate": "2020-11-19T15:10:28Z", "message": "Merge remote-tracking branch 'origin/master' into DHIS2-9894\n\n# Conflicts:\n#\tdhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/AssignedUserValidationHook.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0Nzg0MDcx", "url": "https://github.com/dhis2/dhis2-core/pull/6720#pullrequestreview-534784071", "createdAt": "2020-11-19T19:34:19Z", "commit": {"oid": "f0e2edf11b368ebd28639b22754b49ecb2318d03"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MTg5ODc4", "url": "https://github.com/dhis2/dhis2-core/pull/6720#pullrequestreview-535189878", "createdAt": "2020-11-20T07:58:40Z", "commit": {"oid": "f0e2edf11b368ebd28639b22754b49ecb2318d03"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNzo1OTozMFrOH3EI7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODowNDoyNVrOH3EXhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUwMTU1MQ==", "bodyText": "Not sure if the add warning utility method is implemented, but I think is a good moment to do so\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            reporter.addWarning( TrackerWarningReport.builder()\n          \n          \n            \n                                .warningCode( E1120 )\n          \n          \n            \n                                .trackerType( TrackerType.EVENT )\n          \n          \n            \n                                .addArg( event.getProgramStage() ) );\n          \n          \n            \n                            addWarning( reporter, E1118, event.getAssignedUser() );", "url": "https://github.com/dhis2/dhis2-core/pull/6720#discussion_r527501551", "createdAt": "2020-11-20T07:59:30Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/AssignedUserValidationHook.java", "diffHunk": "@@ -49,20 +54,56 @@\n     @Override\n     public void validateEvent( ValidationErrorReporter reporter, Event event )\n     {\n-        if ( event.getAssignedUser() != null &&\n-            ( !CodeGenerator.isValidUid( event.getAssignedUser() ) ||\n-                reporter.getValidationContext().getBundle().getPreheat().get( TrackerIdScheme.UID, User.class,\n-                    event.getAssignedUser() ) == null) )\n+        if ( event.getAssignedUser() != null )\n         {\n-            TrackerErrorReport.TrackerErrorReportBuilder report = TrackerErrorReport.builder()\n-                .errorCode( E1118 )\n-                .trackerType( TrackerType.EVENT )\n-                .addArg( event.getAssignedUser() );\n+            if ( isNotValidAssignedUserUid( event ) || userNotPresentInPreheat( reporter, event ) )\n+            {\n+                TrackerErrorReport.TrackerErrorReportBuilder report = TrackerErrorReport.builder()\n+                    .errorCode( E1118 )\n+                    .trackerType( TrackerType.EVENT )\n+                    .addArg( event.getAssignedUser() );\n \n-            reporter.addError( report );\n+                reporter.addError( report );\n+            }\n+            if ( isNotEnabledUserAssignment( reporter, event ) )\n+            {\n+                reporter.addWarning( TrackerWarningReport.builder()\n+                    .warningCode( E1120 )\n+                    .trackerType( TrackerType.EVENT )\n+                    .addArg( event.getProgramStage() ) );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e2edf11b368ebd28639b22754b49ecb2318d03"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUwMjE4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Boolean userAssignmentEnabled = ((ProgramStage) reporter.getValidationContext().getBundle().getPreheat().get(\n          \n          \n            \n                        TrackerIdScheme.UID, ProgramStage.class, event.getProgramStage() )).isEnableUserAssignment();\n          \n          \n            \n                    Boolean userAssignmentEnabled = ctx.getProgramStage( event.getProgramStage() ).isEnableUserAssignment();", "url": "https://github.com/dhis2/dhis2-core/pull/6720#discussion_r527502182", "createdAt": "2020-11-20T08:00:50Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/AssignedUserValidationHook.java", "diffHunk": "@@ -49,20 +54,56 @@\n     @Override\n     public void validateEvent( ValidationErrorReporter reporter, Event event )\n     {\n-        if ( event.getAssignedUser() != null &&\n-            ( !CodeGenerator.isValidUid( event.getAssignedUser() ) ||\n-                reporter.getValidationContext().getBundle().getPreheat().get( TrackerIdScheme.UID, User.class,\n-                    event.getAssignedUser() ) == null) )\n+        if ( event.getAssignedUser() != null )\n         {\n-            TrackerErrorReport.TrackerErrorReportBuilder report = TrackerErrorReport.builder()\n-                .errorCode( E1118 )\n-                .trackerType( TrackerType.EVENT )\n-                .addArg( event.getAssignedUser() );\n+            if ( isNotValidAssignedUserUid( event ) || userNotPresentInPreheat( reporter, event ) )\n+            {\n+                TrackerErrorReport.TrackerErrorReportBuilder report = TrackerErrorReport.builder()\n+                    .errorCode( E1118 )\n+                    .trackerType( TrackerType.EVENT )\n+                    .addArg( event.getAssignedUser() );\n \n-            reporter.addError( report );\n+                reporter.addError( report );\n+            }\n+            if ( isNotEnabledUserAssignment( reporter, event ) )\n+            {\n+                reporter.addWarning( TrackerWarningReport.builder()\n+                    .warningCode( E1120 )\n+                    .trackerType( TrackerType.EVENT )\n+                    .addArg( event.getProgramStage() ) );\n+            }\n         }\n     }\n \n+    private Boolean isNotEnabledUserAssignment( ValidationErrorReporter reporter, Event event )\n+    {\n+        /*\n+         * TODO: should we have an helper method in base class (or a dedicated service)\n+         * to easily access preheat maps ? this is hard to read\n+         */\n+\n+        Boolean userAssignmentEnabled = ((ProgramStage) reporter.getValidationContext().getBundle().getPreheat().get(\n+            TrackerIdScheme.UID, ProgramStage.class, event.getProgramStage() )).isEnableUserAssignment();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e2edf11b368ebd28639b22754b49ecb2318d03"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUwNTI4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            TrackerErrorReport.TrackerErrorReportBuilder report = TrackerErrorReport.builder()\n          \n          \n            \n                                .errorCode( E1118 )\n          \n          \n            \n                                .trackerType( TrackerType.EVENT )\n          \n          \n            \n                                .addArg( event.getAssignedUser() );\n          \n          \n            \n                            addError( reporter, E1118, event.getAssignedUser() );", "url": "https://github.com/dhis2/dhis2-core/pull/6720#discussion_r527505286", "createdAt": "2020-11-20T08:04:25Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/AssignedUserValidationHook.java", "diffHunk": "@@ -49,20 +54,56 @@\n     @Override\n     public void validateEvent( ValidationErrorReporter reporter, Event event )\n     {\n-        if ( event.getAssignedUser() != null &&\n-            ( !CodeGenerator.isValidUid( event.getAssignedUser() ) ||\n-                reporter.getValidationContext().getBundle().getPreheat().get( TrackerIdScheme.UID, User.class,\n-                    event.getAssignedUser() ) == null) )\n+        if ( event.getAssignedUser() != null )\n         {\n-            TrackerErrorReport.TrackerErrorReportBuilder report = TrackerErrorReport.builder()\n-                .errorCode( E1118 )\n-                .trackerType( TrackerType.EVENT )\n-                .addArg( event.getAssignedUser() );\n+            if ( isNotValidAssignedUserUid( event ) || userNotPresentInPreheat( reporter, event ) )\n+            {\n+                TrackerErrorReport.TrackerErrorReportBuilder report = TrackerErrorReport.builder()\n+                    .errorCode( E1118 )\n+                    .trackerType( TrackerType.EVENT )\n+                    .addArg( event.getAssignedUser() );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0e2edf11b368ebd28639b22754b49ecb2318d03"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "711784a8f1ce8c6f491324f54f3cabe45c3801e4", "author": {"user": {"login": "gnespolino", "name": "Giuseppe Nespolino"}}, "url": "https://github.com/dhis2/dhis2-core/commit/711784a8f1ce8c6f491324f54f3cabe45c3801e4", "committedDate": "2020-11-20T11:50:48Z", "message": "fix: DHIS2-9894 peer review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDAwMTc2", "url": "https://github.com/dhis2/dhis2-core/pull/6720#pullrequestreview-535400176", "createdAt": "2020-11-20T12:50:01Z", "commit": {"oid": "711784a8f1ce8c6f491324f54f3cabe45c3801e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MjQ4NDcz", "url": "https://github.com/dhis2/dhis2-core/pull/6720#pullrequestreview-536248473", "createdAt": "2020-11-23T08:23:06Z", "commit": {"oid": "711784a8f1ce8c6f491324f54f3cabe45c3801e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2287, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}