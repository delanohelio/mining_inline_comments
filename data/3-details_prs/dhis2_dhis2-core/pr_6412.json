{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNDQ0MTY2", "number": 6412, "title": "fix: Make db pool connection test enabled to avoid deadlocks", "bodyText": "Make most of the db pool settings configurable\nEnable test connection on checkin, default value \"true\", this change fixes the issue making the db pool deadlock on very high concurrency load right after startup.", "createdAt": "2020-10-14T15:06:55Z", "url": "https://github.com/dhis2/dhis2-core/pull/6412", "merged": true, "mergeCommit": {"oid": "907e1c64b9bb13005b1de59c24f3870775fef05a"}, "closed": true, "closedAt": "2020-10-15T10:37:35Z", "author": {"login": "netroms"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSGtcEAH2gAyNTAzNDQ0MTY2OjI2YTMyM2Y3OTRlZTBhMzc0OGMzNTNiODA4ODk4YTVkNmMwMTA5M2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSuu4rgFqTUwOTIxMDAwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "26a323f794ee0a3748c353b808898a5d6c01093b", "author": {"user": {"login": "netroms", "name": null}}, "url": "https://github.com/dhis2/dhis2-core/commit/26a323f794ee0a3748c353b808898a5d6c01093b", "committedDate": "2020-10-13T11:16:56Z", "message": "fix: broken Hibernate5module usage (#6300) (#6317)\n\n* Remove all usage of Hibernate5Module\nCurrent Hibernate5module configuration breaks the JSON deserialization. The Hibernate5module is meant to be used in context when there is no open session in view, like background tasks and asynchronous tasks.\nIn DHIS2 this used for scheduled background tasks and the audit system.\nAnother PR to reconfigure Hibernate5Module will come later.\n\nIssue: [DHIS2-9451]\n\nSigned-off-by: Morten Svanaes <msvanaes@dhis2.org>\n(cherry picked from commit 2a6af5fe3c745123be67bd3a84127d32f04761f4)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "804e41f0bcac6aca13f82d772223163b75eab0d1", "author": {"user": {"login": "netroms", "name": null}}, "url": "https://github.com/dhis2/dhis2-core/commit/804e41f0bcac6aca13f82d772223163b75eab0d1", "committedDate": "2020-10-14T15:05:35Z", "message": "fix: Change db pool timeout settings to avoid deadlocks\n\nSigned-off-by: Morten Svanaes <msvanaes@dhis2.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a6ec9ef8c0e19bd65508825958c2a4889e96f9c", "author": {"user": {"login": "netroms", "name": null}}, "url": "https://github.com/dhis2/dhis2-core/commit/5a6ec9ef8c0e19bd65508825958c2a4889e96f9c", "committedDate": "2020-10-15T07:28:24Z", "message": "fix: Change db pool timeout settings to avoid deadlocks\n\nSigned-off-by: Morten Svanaes <msvanaes@dhis2.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce7e1852b6045c447c03641255d7f0c0f9a9537f", "author": {"user": {"login": "netroms", "name": null}}, "url": "https://github.com/dhis2/dhis2-core/commit/ce7e1852b6045c447c03641255d7f0c0f9a9537f", "committedDate": "2020-10-15T07:33:15Z", "message": "Merge branch 'patch/2.35.0' of github.com:dhis2/dhis2-core into adjust_db_pool_timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MTE1MjIz", "url": "https://github.com/dhis2/dhis2-core/pull/6412#pullrequestreview-509115223", "createdAt": "2020-10-15T08:00:23Z", "commit": {"oid": "ce7e1852b6045c447c03641255d7f0c0f9a9537f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwODowMDoyNFrOHh5Niw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwODowMDoyNFrOHh5Niw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMwMjQxMQ==", "bodyText": "Code style, space after \"(\" and \",\". This and next line.", "url": "https://github.com/dhis2/dhis2-core/pull/6412#discussion_r505302411", "createdAt": "2020-10-15T08:00:24Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-support/dhis-support-external/src/main/java/org/hisp/dhis/external/conf/ConfigurationKey.java", "diffHunk": "@@ -52,6 +52,14 @@\n     CONNECTION_PASSWORD( \"connection.password\", \"\", true ),\n     CONNECTION_SCHEMA( \"connection.schema\", \"\", false ),\n     CONNECTION_POOL_MAX_SIZE( \"connection.pool.max_size\", \"80\", false ),\n+    CONNECTION_POOL_MIN_SIZE( \"connection.pool.min_size\", \"5\", false ),\n+    CONNECTION_POOL_INITIAL_SIZE( \"connection.pool.initial_size\", \"5\", false ),\n+    CONNECTION_POOL_ACQUIRE_INCR( \"connection.pool.acquire_incr\", \"5\", false ),\n+    CONNECTION_POOL_MAX_IDLE_TIME( \"connection.pool.max_idle_time\", \"7200\", false ),\n+    CONNECTION_POOL_MAX_IDLE_TIME_EXCESS_CON( \"connection.pool.max_idle_time_excess_con\", \"0\", false ),\n+    CONNECTION_POOL_IDLE_CON_TEST_PERIOD( \"connection.pool.idle.con.test.period\", \"0\", false ),\n+    CONNECTION_POOL_TEST_ON_CHECKOUT(\"connection.pool.test.on.checkout\",\"false\",false),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce7e1852b6045c447c03641255d7f0c0f9a9537f"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MTE5MDc4", "url": "https://github.com/dhis2/dhis2-core/pull/6412#pullrequestreview-509119078", "createdAt": "2020-10-15T08:05:10Z", "commit": {"oid": "ce7e1852b6045c447c03641255d7f0c0f9a9537f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwODowNToxMFrOHh5mWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwODowNToxMFrOHh5mWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMwODc2MA==", "bodyText": "Here we need to use the Hibernate Environment equivalent @netroms as the second argument . E.g. use Environment.C3P0_MAX_SIZE. This because we are eventually passing these properties to Hibernate. Hibernate needs its own config properties (or the C3P0 specific properties), not the DHIS 2 specific properties.", "url": "https://github.com/dhis2/dhis2-core/pull/6412#discussion_r505308760", "createdAt": "2020-10-15T08:05:10Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-support/dhis-support-hibernate/src/main/java/org/hisp/dhis/hibernate/DefaultHibernateConfigurationProvider.java", "diffHunk": "@@ -232,6 +232,22 @@ private Properties getHibernateProperties()\n         putIfExists( configurationProvider.getProperty( ConfigurationKey.CONNECTION_USERNAME ), Environment.USER, props );\n         putIfExists( configurationProvider.getProperty( ConfigurationKey.CONNECTION_PASSWORD ), Environment.PASS, props );\n         putIfExists( configurationProvider.getProperty( ConfigurationKey.CONNECTION_POOL_MAX_SIZE ), Environment.C3P0_MAX_SIZE, props );\n+        putIfExists( configurationProvider.getProperty( ConfigurationKey.CONNECTION_POOL_MIN_SIZE ),\n+            ConfigurationKey.CONNECTION_POOL_MIN_SIZE.getKey(), props );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce7e1852b6045c447c03641255d7f0c0f9a9537f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MjAyOTI4", "url": "https://github.com/dhis2/dhis2-core/pull/6412#pullrequestreview-509202928", "createdAt": "2020-10-15T09:45:47Z", "commit": {"oid": "ce7e1852b6045c447c03641255d7f0c0f9a9537f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2a852523facb3c3b0f58fa7c57096cedff61e8b", "author": {"user": {"login": "netroms", "name": null}}, "url": "https://github.com/dhis2/dhis2-core/commit/f2a852523facb3c3b0f58fa7c57096cedff61e8b", "committedDate": "2020-10-15T09:49:43Z", "message": "fix: Make db pool connection test enabled to avoid deadlocks\n\n* Formatting fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MjEwMDAx", "url": "https://github.com/dhis2/dhis2-core/pull/6412#pullrequestreview-509210001", "createdAt": "2020-10-15T09:54:43Z", "commit": {"oid": "f2a852523facb3c3b0f58fa7c57096cedff61e8b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2388, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}