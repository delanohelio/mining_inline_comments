{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NDg1NDM3", "number": 6083, "title": "fix: [DHIS2-9286] add exception handling globally to catch any unhandled ones and notify job correctly", "bodyText": "Added an try catch block around the new tracker import service flow, to catch any unhandled exceptions.\nIn case of exceptions, the import report and job summary in notifier will reflect the same with exception error message in it.", "createdAt": "2020-09-03T09:16:24Z", "url": "https://github.com/dhis2/dhis2-core/pull/6083", "merged": true, "mergeCommit": {"oid": "0b6ed856bcef9b64550fe8def5f67b269fc1ad52"}, "closed": true, "closedAt": "2020-09-04T11:45:38Z", "author": {"login": "ameenhere"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE7VGtgH2gAyNDc4NDg1NDM3OmQ4Njg2YTk4NmM5OWRmNmM0ZTJlMmIxNWVlMTU1MTM4MTQ1NWZiODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFjTk5gH2gAyNDc4NDg1NDM3OmUxMThjYTAzNjBkOGVmNzE3ODJmYTYzMmEwOTRlYzAwMjc2OGU0YmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d8686a986c99df6c4e2e2b15ee1551381455fb82", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d8686a986c99df6c4e2e2b15ee1551381455fb82", "committedDate": "2020-09-02T12:40:23Z", "message": "feat: add main exception handling in new tracker import job"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86297d3e9cf4a52a48f12a71c536bc28b7479720", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/86297d3e9cf4a52a48f12a71c536bc28b7479720", "committedDate": "2020-09-03T08:13:54Z", "message": "Add error report into import report in case of exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c924875d2141896556f9dcda3d583f01bf5a80c4", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/c924875d2141896556f9dcda3d583f01bf5a80c4", "committedDate": "2020-09-03T08:44:20Z", "message": "minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4ff562a5310c3d51d0efac153fe7a8f736ad452", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d4ff562a5310c3d51d0efac153fe7a8f736ad452", "committedDate": "2020-09-03T09:15:12Z", "message": "Minor refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNjU1MTI1", "url": "https://github.com/dhis2/dhis2-core/pull/6083#pullrequestreview-481655125", "createdAt": "2020-09-03T09:20:51Z", "commit": {"oid": "d4ff562a5310c3d51d0efac153fe7a8f736ad452"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwOToyMDo1MVrOHMd4Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwOToyMDo1MVrOHMd4Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgzNDUyNg==", "bodyText": "@luciano-fiandesio  Your thoughts?", "url": "https://github.com/dhis2/dhis2-core/pull/6083#discussion_r482834526", "createdAt": "2020-09-03T09:20:51Z", "author": {"login": "ameenhere"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/DefaultTrackerImportService.java", "diffHunk": "@@ -102,32 +104,62 @@ public TrackerImportReport importTracker( TrackerImportParams params )\n         {\n             notifier.notify( params.getJobConfiguration(), \"(\" + params.getUsername() + \") Import:Start\" );\n         }\n+        \n+        try\n+        {\n \n-        List<TrackerBundle> trackerBundles = preheatBundle( params, importReport );\n+            List<TrackerBundle> trackerBundles = preheatBundle( params, importReport );\n \n-        trackerBundles = preProcessBundle( trackerBundles, importReport );\n+            trackerBundles = preProcessBundle( trackerBundles, importReport );\n \n-        TrackerValidationReport validationReport = validateBundle( params, importReport, trackerBundles );\n+            TrackerValidationReport validationReport = validateBundle( params, importReport, trackerBundles );\n \n-        if ( validationReport.hasErrors() && params.getAtomicMode() == AtomicMode.ALL )\n-        {\n-            importReport.setStatus( TrackerStatus.ERROR );\n-        }\n-        else\n-        {\n-            if ( TrackerImportStrategy.DELETE == params.getImportStrategy() )\n+            if ( validationReport.hasErrors() && params.getAtomicMode() == AtomicMode.ALL )\n             {\n-                deleteBundle( params, importReport, trackerBundles );\n+                importReport.setStatus( TrackerStatus.ERROR );\n             }\n             else\n             {\n-                commitBundle( params, importReport, trackerBundles );\n+                if ( TrackerImportStrategy.DELETE == params.getImportStrategy() )\n+                {\n+                    deleteBundle( params, importReport, trackerBundles );\n+                }\n+                else\n+                {\n+                    commitBundle( params, importReport, trackerBundles );\n+                }\n             }\n+\n+            importReport.getTimings().setTotalImport( requestTimer.toString() );\n+\n+            TrackerBundleReportModeUtils.filter( importReport, params.getReportMode() );\n+\n         }\n+        catch ( Exception e )\n+        {\n+            \n+            TrackerValidationReport tvr = importReport.getTrackerValidationReport();\n+            \n+            if ( tvr == null )\n+            {\n+                tvr = new TrackerValidationReport();\n+            }\n+            \n+            tvr.getErrorReports().add(new TrackerErrorReport( null, \"Exception:\"+e.getMessage(), TrackerErrorCode.E9999, 0, null, null, null, null ));\n+            importReport.setTrackerValidationReport( tvr );\n+            importReport.setStatus( TrackerStatus.ERROR );\n+            \n+            if ( params.hasJobConfiguration() )\n+            {\n+                notifier.update( params.getJobConfiguration(), \"(\" + params.getUsername() + \") Import:Failed with exception: \" + e.getMessage(), true );\n+                notifier.addJobSummary( params.getJobConfiguration(), importReport, TrackerImportReport.class );\n+            }\n+            \n+            //TODO: Should this be rethrown in case of sync? Or is the error report added to the import report in the above lines enough?\n+            throw e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ff562a5310c3d51d0efac153fe7a8f736ad452"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b599b904efe879711d3e4eda1cdc5e04af0e9a5d", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b599b904efe879711d3e4eda1cdc5e04af0e9a5d", "committedDate": "2020-09-03T09:22:26Z", "message": "Added logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d636d78108d3e74e5c053c48febd67119d665ad0", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d636d78108d3e74e5c053c48febd67119d665ad0", "committedDate": "2020-09-03T09:55:22Z", "message": "Remove rethrowing of exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNzU5MDc1", "url": "https://github.com/dhis2/dhis2-core/pull/6083#pullrequestreview-481759075", "createdAt": "2020-09-03T11:48:31Z", "commit": {"oid": "d636d78108d3e74e5c053c48febd67119d665ad0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDMxNjMx", "url": "https://github.com/dhis2/dhis2-core/pull/6083#pullrequestreview-482431631", "createdAt": "2020-09-04T07:45:19Z", "commit": {"oid": "d636d78108d3e74e5c053c48febd67119d665ad0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNzo0NToxOVrOHNDOlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNzo0NToxOVrOHNDOlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ0NjQyMA==", "bodyText": "There is a static method to create new errors ValidationErrorReporter.newReport(errorCode) and then you can add an arg.\nYou can find a lot of examples in the validation hooks.\nNot a big change, but we avoid to have all this null in the constructor", "url": "https://github.com/dhis2/dhis2-core/pull/6083#discussion_r483446420", "createdAt": "2020-09-04T07:45:19Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/DefaultTrackerImportService.java", "diffHunk": "@@ -102,32 +107,60 @@ public TrackerImportReport importTracker( TrackerImportParams params )\n         {\n             notifier.notify( params.getJobConfiguration(), \"(\" + params.getUsername() + \") Import:Start\" );\n         }\n+        \n+        try\n+        {\n \n-        List<TrackerBundle> trackerBundles = preheatBundle( params, importReport );\n+            List<TrackerBundle> trackerBundles = preheatBundle( params, importReport );\n \n-        trackerBundles = preProcessBundle( trackerBundles, importReport );\n+            trackerBundles = preProcessBundle( trackerBundles, importReport );\n \n-        TrackerValidationReport validationReport = validateBundle( params, importReport, trackerBundles );\n+            TrackerValidationReport validationReport = validateBundle( params, importReport, trackerBundles );\n \n-        if ( validationReport.hasErrors() && params.getAtomicMode() == AtomicMode.ALL )\n-        {\n-            importReport.setStatus( TrackerStatus.ERROR );\n-        }\n-        else\n-        {\n-            if ( TrackerImportStrategy.DELETE == params.getImportStrategy() )\n+            if ( validationReport.hasErrors() && params.getAtomicMode() == AtomicMode.ALL )\n             {\n-                deleteBundle( params, importReport, trackerBundles );\n+                importReport.setStatus( TrackerStatus.ERROR );\n             }\n             else\n             {\n-                commitBundle( params, importReport, trackerBundles );\n+                if ( TrackerImportStrategy.DELETE == params.getImportStrategy() )\n+                {\n+                    deleteBundle( params, importReport, trackerBundles );\n+                }\n+                else\n+                {\n+                    commitBundle( params, importReport, trackerBundles );\n+                }\n             }\n+\n+            importReport.getTimings().setTotalImport( requestTimer.toString() );\n+\n+            TrackerBundleReportModeUtils.filter( importReport, params.getReportMode() );\n+\n         }\n+        catch ( Exception e )\n+        {\n+            log.error( \"Exception thrown during import.\",e );\n+            \n+            TrackerValidationReport tvr = importReport.getTrackerValidationReport();\n+            \n+            if ( tvr == null )\n+            {\n+                tvr = new TrackerValidationReport();\n+            }\n+            \n+            tvr.getErrorReports().add(new TrackerErrorReport( null, \"Exception:\"+e.getMessage(), TrackerErrorCode.E9999, 0, null, null, null, null ));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d636d78108d3e74e5c053c48febd67119d665ad0"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b266f8c4dd9861199e020c31e095a76dd4879e9f", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b266f8c4dd9861199e020c31e095a76dd4879e9f", "committedDate": "2020-09-04T10:28:24Z", "message": "Formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7919e69114ee708876d5340140840c9e64ad35c9", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/7919e69114ee708876d5340140840c9e64ad35c9", "committedDate": "2020-09-04T10:37:21Z", "message": "Fixed a test to solve potential race condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ae6f9f600a73bf3cd833e6280497a7401d95a28", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/5ae6f9f600a73bf3cd833e6280497a7401d95a28", "committedDate": "2020-09-04T11:03:46Z", "message": "Added a new constructor to avoid too many nulls in constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e118ca0360d8ef71782fa632a094ec002768e4bd", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/e118ca0360d8ef71782fa632a094ec002768e4bd", "committedDate": "2020-09-04T11:14:55Z", "message": "Revert weird tes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2484, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}