{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MzkzNDk1", "number": 5469, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMzo0NjoxNlrOD7Pxpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDo1OTo1MFrOEEVdig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNDUxMDQ3OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventchart/EventChartDeletionHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMzo0NjoxNlrOGTc-cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMzo0ODoyMFrOGTdEEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1MDg2NQ==", "bodyText": "For all your SQL, stick with either uppercase or lowercase for SQL keywords :)", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r423050865", "createdAt": "2020-05-11T13:46:16Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventchart/EventChartDeletionHandler.java", "diffHunk": "@@ -129,13 +137,36 @@ public void deleteProgramStage( ProgramStage programStage )\n     public void deleteProgram( Program program )\n     {\n         Collection<EventChart> charts = eventChartService.getAllEventCharts();\n-        \n+\n         for ( EventChart chart : charts )\n         {\n-            if ( chart.getProgram().equals( program ))\n+            if ( chart.getProgram().equals( program ) )\n             {\n                 eventChartService.deleteEventChart( chart );\n             }\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroupSet( OrganisationUnitGroupSet groupSet )\n+    {\n+        String sql = \"select count(*) \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e2b937ba17db359d75841fdbab9270991117b5a"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1MjMwNA==", "bodyText": "Also, the WHERE on a new line maybe :)?", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r423052304", "createdAt": "2020-05-11T13:48:20Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventchart/EventChartDeletionHandler.java", "diffHunk": "@@ -129,13 +137,36 @@ public void deleteProgramStage( ProgramStage programStage )\n     public void deleteProgram( Program program )\n     {\n         Collection<EventChart> charts = eventChartService.getAllEventCharts();\n-        \n+\n         for ( EventChart chart : charts )\n         {\n-            if ( chart.getProgram().equals( program ))\n+            if ( chart.getProgram().equals( program ) )\n             {\n                 eventChartService.deleteEventChart( chart );\n             }\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroupSet( OrganisationUnitGroupSet groupSet )\n+    {\n+        String sql = \"select count(*) \"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1MDg2NQ=="}, "originalCommit": {"oid": "2e2b937ba17db359d75841fdbab9270991117b5a"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NzY2OTEyOnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventchart/EventChartDeletionHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDoyMjoyM1rOGVesYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDoyMjoyM1rOGVesYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE3NjE2Mw==", "bodyText": "Use explicit join (\"inner join\") to remove ambiguity.", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r425176163", "createdAt": "2020-05-14T14:22:23Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventchart/EventChartDeletionHandler.java", "diffHunk": "@@ -129,13 +137,37 @@ public void deleteProgramStage( ProgramStage programStage )\n     public void deleteProgram( Program program )\n     {\n         Collection<EventChart> charts = eventChartService.getAllEventCharts();\n-        \n+\n         for ( EventChart chart : charts )\n         {\n-            if ( chart.getProgram().equals( program ))\n+            if ( chart.getProgram().equals( program ) )\n             {\n                 eventChartService.deleteEventChart( chart );\n             }\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroupSet( OrganisationUnitGroupSet groupSet )\n+    {\n+        String sql = \"SELECT count(*) \"\n+            + \" FROM orgunitgroupsetdimension d JOIN eventchart_orgunitgroupsetdimensions e \"\n+            + \" ON d.orgunitgroupsetdimensionid = e.orgunitgroupsetdimensionid \"\n+            + \" WHERE d.orgunitgroupsetid = \"\n+            + groupSet.getId();\n+\n+        return jdbcTemplate.queryForObject( sql, Integer.class ) == 0 ? null : \"orgunitgroupsetdimension\";\n+    }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroup( OrganisationUnitGroup group )\n+    {\n+        String sql = \"SELECT count(*) \"\n+            + \" FROM orgunitgroupsetdimension d JOIN eventchart_orgunitgroupsetdimensions e \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16399b46ec248c13322ac351df5d36838b386e8a"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NzcwNjU3OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventreport/EventReportDeletionHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDozMDowOVrOGVfEfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDozMDowOVrOGVfEfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE4MjMzMw==", "bodyText": "Use lower-case only in SQL statements for consistency.", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r425182333", "createdAt": "2020-05-14T14:30:09Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventreport/EventReportDeletionHandler.java", "diffHunk": "@@ -129,13 +138,36 @@ public void deleteProgramStage( ProgramStage programStage )\n     public void deleteProgram( Program program )\n     {\n         Collection<EventReport> charts = eventReportService.getAllEventReports();\n-        \n+\n         for ( EventReport chart : charts )\n         {\n-            if( chart.getProgram().equals( program ))\n+            if ( chart.getProgram().equals( program ) )\n             {\n-               eventReportService.deleteEventReport( chart );\n+                eventReportService.deleteEventReport( chart );\n             }\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroupSet( OrganisationUnitGroupSet groupSet )\n+    {\n+        String sql = \"SELECT count(*) \"\n+            + \" FROM orgunitgroupsetdimension d JOIN eventreport_orgunitgroupsetdimensions e \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16399b46ec248c13322ac351df5d36838b386e8a"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyOTgxMzg2OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/common/GenericAnalyticalObjectDeletionHandler.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDo1OTo1MFrOGh5E7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNTowNDo0OFrOGihhTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE5MTM0Mg==", "bodyText": "Just asking so that I understand - Do we need to filter out OrganisationUnitGroupSetDimensions, don't we already know they match after doing the query in analytical store with OrganisationUnitGroupSetDimension as the argument?", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r438191342", "createdAt": "2020-06-10T14:59:50Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/common/GenericAnalyticalObjectDeletionHandler.java", "diffHunk": "@@ -96,10 +106,52 @@ public String allowDeletePeriod( Period period )\n     @Override\n     public void deleteOrganisationUnit( OrganisationUnit organisationUnit )\n     {\n-        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnit ), organisationUnit, ( ao, di ) -> ao.getOrganisationUnits().remove( di ) );\n+        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnit ), organisationUnit,\n+            ( ao, di ) -> ao.getOrganisationUnits().remove( di ) );\n+    }\n+\n+    @Override\n+    public void deleteOrganisationUnitGroup( OrganisationUnitGroup organisationUnitGroup )\n+    {\n+        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnitGroup ), organisationUnitGroup,\n+            ( ao, di ) -> {\n+                List<OrganisationUnitGroupSetDimension> dimensionsToDelete = ao.getOrganisationUnitGroupSetDimensions()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc96a0521fbc9fcd91f695a9462405e1240ed8a4"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODY3NjgzNA==", "bodyText": "From the store we are retrieving AnalyticalObjects with the provided dimension.\nIn the consumer we are deleting the dimension linked to the group that we are deleting.\nSo we know that in the AnalyticalObject there is something to delete, but we do not want to delete all the dimensions in it.", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r438676834", "createdAt": "2020-06-11T10:01:06Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/common/GenericAnalyticalObjectDeletionHandler.java", "diffHunk": "@@ -96,10 +106,52 @@ public String allowDeletePeriod( Period period )\n     @Override\n     public void deleteOrganisationUnit( OrganisationUnit organisationUnit )\n     {\n-        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnit ), organisationUnit, ( ao, di ) -> ao.getOrganisationUnits().remove( di ) );\n+        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnit ), organisationUnit,\n+            ( ao, di ) -> ao.getOrganisationUnits().remove( di ) );\n+    }\n+\n+    @Override\n+    public void deleteOrganisationUnitGroup( OrganisationUnitGroup organisationUnitGroup )\n+    {\n+        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnitGroup ), organisationUnitGroup,\n+            ( ao, di ) -> {\n+                List<OrganisationUnitGroupSetDimension> dimensionsToDelete = ao.getOrganisationUnitGroupSetDimensions()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE5MTM0Mg=="}, "originalCommit": {"oid": "bc96a0521fbc9fcd91f695a9462405e1240ed8a4"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1Mzk2NA==", "bodyText": "Right, makes sense, got it.", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r438853964", "createdAt": "2020-06-11T15:04:48Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/common/GenericAnalyticalObjectDeletionHandler.java", "diffHunk": "@@ -96,10 +106,52 @@ public String allowDeletePeriod( Period period )\n     @Override\n     public void deleteOrganisationUnit( OrganisationUnit organisationUnit )\n     {\n-        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnit ), organisationUnit, ( ao, di ) -> ao.getOrganisationUnits().remove( di ) );\n+        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnit ), organisationUnit,\n+            ( ao, di ) -> ao.getOrganisationUnits().remove( di ) );\n+    }\n+\n+    @Override\n+    public void deleteOrganisationUnitGroup( OrganisationUnitGroup organisationUnitGroup )\n+    {\n+        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnitGroup ), organisationUnitGroup,\n+            ( ao, di ) -> {\n+                List<OrganisationUnitGroupSetDimension> dimensionsToDelete = ao.getOrganisationUnitGroupSetDimensions()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE5MTM0Mg=="}, "originalCommit": {"oid": "bc96a0521fbc9fcd91f695a9462405e1240ed8a4"}, "originalPosition": 87}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3467, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}