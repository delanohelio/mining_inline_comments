{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxOTQxODM0", "number": 6936, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMToxODowNlrOFHwV8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMToxODozNlrOFHwWeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNjc2NDAyOnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditScheduler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMToxODowNlrOIJU4GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMToxODowNlrOIJU4GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY1MDEzNg==", "bodyText": "merge? else if", "url": "https://github.com/dhis2/dhis2-core/pull/6936#discussion_r546650136", "createdAt": "2020-12-21T11:18:06Z", "author": {"login": "netroms"}, "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditScheduler.java", "diffHunk": "@@ -63,15 +75,23 @@ public void addAuditItem( final Audit auditItem )\n         {\n             log.debug( String.format( \"add Audit object with content %s to delayed queue\", auditItem.toLog() ) );\n         }\n-        final QueuedAudit postponed = new QueuedAudit( auditItem, delay );\n \n-        if ( !delayed.contains( postponed ) )\n+        final QueuedAudit postponed = new QueuedAudit( auditItem, DELAY );\n+\n+        if ( delayed.size() >= MAX_SIZE )\n+        {\n+            auditProducerSupplier.publish( auditItem );\n+        }\n+        else", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNjc2NTM3OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditScheduler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMToxODozNlrOIJU45A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMToxODozNlrOIJU45A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY1MDM0MA==", "bodyText": "Make variables configurable?", "url": "https://github.com/dhis2/dhis2-core/pull/6936#discussion_r546650340", "createdAt": "2020-12-21T11:18:36Z", "author": {"login": "netroms"}, "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditScheduler.java", "diffHunk": "@@ -40,13 +39,26 @@\n import lombok.extern.slf4j.Slf4j;\n \n /**\n+ * Buffers Audit messages prior to sending them to the Audit queue. This\n+ * scheduler is disabled by default (config key: audit.inmemory-queue.enabled)\n+ * and should be used only in very high-traffic environments. Note that upon a\n+ * JVM crash, the Audit messages in this queue will be lost.\n+ * \n+ * The buffer is based on a {@link DelayQueue} where messages are buffered for 5\n+ * seconds, before being de-queued to the Artemis broker.\n+ * \n+ * To avoid excessive memory pressure, max 200 messages can stay in the queue:\n+ * in-excess messages are processed immediately.\n+ *\n  * @author Luciano Fiandesio\n  */\n @Slf4j\n @Component\n public class AuditScheduler\n {\n-    private final long delay = 20_000; // 20 seconds\n+    private final static long DELAY = 5_000; // 5 seconds", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3692, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}