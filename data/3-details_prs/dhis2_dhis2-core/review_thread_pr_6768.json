{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTk5NDgy", "number": 6768, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNDowMTozOVrOE_Kddw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNDoxMToxMFrOE_KumA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NjY3MTI3OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNDowMTozOVrOH8t5ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMTozMTozNVrOH9WsfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyODYxOA==", "bodyText": "This TEI passed to validation cannot be null, so we could simply get the attributes without the optional", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r533428618", "createdAt": "2020-12-01T14:01:39Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "diffHunk": "@@ -97,6 +104,47 @@ public void validateTrackedEntity( ValidationErrorReporter reporter, TrackedEnti\n         OrganisationUnit organisationUnit = context.getOrganisationUnit( trackedEntity.getOrgUnit() );\n \n         validateAttributes( reporter, trackedEntity, tei, organisationUnit );\n+        validateMandatoryAttributes( reporter, trackedEntity );\n+    }\n+\n+    private void validateMandatoryAttributes( ValidationErrorReporter reporter, TrackedEntity trackedEntity )\n+    {\n+        TrackedEntityType trackedEntityType = reporter.getValidationContext()\n+            .getTrackedEntityType( trackedEntity.getTrackedEntityType() );\n+\n+        if ( trackedEntityType != null )\n+        {\n+            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5NzAyMQ==", "bodyText": "you're right, thank you", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r534097021", "createdAt": "2020-12-02T11:31:35Z", "author": {"login": "gnespolino"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "diffHunk": "@@ -97,6 +104,47 @@ public void validateTrackedEntity( ValidationErrorReporter reporter, TrackedEnti\n         OrganisationUnit organisationUnit = context.getOrganisationUnit( trackedEntity.getOrgUnit() );\n \n         validateAttributes( reporter, trackedEntity, tei, organisationUnit );\n+        validateMandatoryAttributes( reporter, trackedEntity );\n+    }\n+\n+    private void validateMandatoryAttributes( ValidationErrorReporter reporter, TrackedEntity trackedEntity )\n+    {\n+        TrackedEntityType trackedEntityType = reporter.getValidationContext()\n+            .getTrackedEntityType( trackedEntity.getTrackedEntityType() );\n+\n+        if ( trackedEntityType != null )\n+        {\n+            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyODYxOA=="}, "originalCommit": {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NjcxNTEyOnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNDoxMToxMFrOH8uUNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMTozMTo1OVrOH9WtaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzNTQ0Nw==", "bodyText": "I found difficult following this Optional.of and then orElse flow and I am not sure if in this case you could really have a null TrackedEntityTypeAttribute in the list of trackedEntityType.getTrackedEntityTypeAttributes()\nI would go with\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .filter( this::isMandatory )\n          \n          \n            \n                           .filter(Obects::isNotNull)\n          \n          \n            \n                           .filter(TrackedEntityTypeAttribute::isMandatory)\n          \n      \n    \n    \n  \n\nbut of course this is purely personal style", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r533435447", "createdAt": "2020-12-01T14:11:10Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "diffHunk": "@@ -97,6 +104,47 @@ public void validateTrackedEntity( ValidationErrorReporter reporter, TrackedEnti\n         OrganisationUnit organisationUnit = context.getOrganisationUnit( trackedEntity.getOrgUnit() );\n \n         validateAttributes( reporter, trackedEntity, tei, organisationUnit );\n+        validateMandatoryAttributes( reporter, trackedEntity );\n+    }\n+\n+    private void validateMandatoryAttributes( ValidationErrorReporter reporter, TrackedEntity trackedEntity )\n+    {\n+        TrackedEntityType trackedEntityType = reporter.getValidationContext()\n+            .getTrackedEntityType( trackedEntity.getTrackedEntityType() );\n+\n+        if ( trackedEntityType != null )\n+        {\n+            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )\n+                .map( TrackedEntity::getAttributes )\n+                .orElse( Collections.emptyList() )\n+                .stream()\n+                .map( Attribute::getAttribute )\n+                .collect( Collectors.toSet() );\n+\n+            trackedEntityType.getTrackedEntityTypeAttributes()\n+                .stream()\n+                .filter( this::isMandatory )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5NzI1Nw==", "bodyText": "yes, your version is much easier, I'll change it", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r534097257", "createdAt": "2020-12-02T11:31:59Z", "author": {"login": "gnespolino"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "diffHunk": "@@ -97,6 +104,47 @@ public void validateTrackedEntity( ValidationErrorReporter reporter, TrackedEnti\n         OrganisationUnit organisationUnit = context.getOrganisationUnit( trackedEntity.getOrgUnit() );\n \n         validateAttributes( reporter, trackedEntity, tei, organisationUnit );\n+        validateMandatoryAttributes( reporter, trackedEntity );\n+    }\n+\n+    private void validateMandatoryAttributes( ValidationErrorReporter reporter, TrackedEntity trackedEntity )\n+    {\n+        TrackedEntityType trackedEntityType = reporter.getValidationContext()\n+            .getTrackedEntityType( trackedEntity.getTrackedEntityType() );\n+\n+        if ( trackedEntityType != null )\n+        {\n+            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )\n+                .map( TrackedEntity::getAttributes )\n+                .orElse( Collections.emptyList() )\n+                .stream()\n+                .map( Attribute::getAttribute )\n+                .collect( Collectors.toSet() );\n+\n+            trackedEntityType.getTrackedEntityTypeAttributes()\n+                .stream()\n+                .filter( this::isMandatory )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzNTQ0Nw=="}, "originalCommit": {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6"}, "originalPosition": 55}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3706, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}