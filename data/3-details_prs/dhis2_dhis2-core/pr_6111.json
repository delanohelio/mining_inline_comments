{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyMjA0MTU2", "number": 6111, "title": "feat: require bundled app overrides to be configured with the coreApp flag in the manifest", "bodyText": "This does two things:\n\n\n(important!) this adds a check on application install to ensure that any app which will override a bundled app has the new core_app=true flag set in its manifest.  This ensures that override apps are explicitly built to be served from the /dhis-web-xyz namespace rather than the /api/apps/xyz namespace, and should help prevent unintentional bundled app overrides.\n\n\n(minor) This adds a little more information to /dhis-web-apps/index.html and /dhis-web-apps/apps-bundle.json, specifying the name of the application (which can then be used for overrides)", "createdAt": "2020-09-08T17:51:00Z", "url": "https://github.com/dhis2/dhis2-core/pull/6111", "merged": true, "mergeCommit": {"oid": "81735f2a16184f4f7cf26803d712f059cf822894"}, "closed": true, "closedAt": "2020-09-08T20:46:58Z", "author": {"login": "amcgee"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG7SFcAH2gAyNDgyMjA0MTU2OmExOTI2ZmNjODRhY2QzZDBjZmQzZGNhOGZiYTg3N2RjMDU1NGU1OTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdG9m-vAH2gAyNDgyMjA0MTU2OjljM2EyYWU2ODgwOWVlM2MwMDI0NjRmN2M2ODAwMjZjYWMxMTUxNDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a1926fcc84acd3d0cfd3dca8fba877dc0554e595", "author": {"user": {"login": "amcgee", "name": "Austin McGee"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a1926fcc84acd3d0cfd3dca8fba877dc0554e595", "committedDate": "2020-09-08T17:44:56Z", "message": "feat: require bundled app overrides to be configured with the coreApp flag in the manifest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5af47f58932bed8ff3ef44639b7a6441f7cb1f1f", "author": {"user": {"login": "amcgee", "name": "Austin McGee"}}, "url": "https://github.com/dhis2/dhis2-core/commit/5af47f58932bed8ff3ef44639b7a6441f7cb1f1f", "committedDate": "2020-09-08T17:53:25Z", "message": "chore: add comment describing core_app property"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0Mzc4OTg2", "url": "https://github.com/dhis2/dhis2-core/pull/6111#pullrequestreview-484378986", "createdAt": "2020-09-08T18:08:13Z", "commit": {"oid": "5af47f58932bed8ff3ef44639b7a6441f7cb1f1f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e12106e3081474c322c9479f8d57acf73e1b69c", "author": {"user": {"login": "amcgee", "name": "Austin McGee"}}, "url": "https://github.com/dhis2/dhis2-core/commit/5e12106e3081474c322c9479f8d57acf73e1b69c", "committedDate": "2020-09-08T18:52:42Z", "message": "refactor: extract app validation logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDQ1ODI5", "url": "https://github.com/dhis2/dhis2-core/pull/6111#pullrequestreview-484445829", "createdAt": "2020-09-08T19:50:25Z", "commit": {"oid": "5e12106e3081474c322c9479f8d57acf73e1b69c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0741fe1c5b320255f81938beefd6ab7eefea6e4", "author": {"user": {"login": "amcgee", "name": "Austin McGee"}}, "url": "https://github.com/dhis2/dhis2-core/commit/e0741fe1c5b320255f81938beefd6ab7eefea6e4", "committedDate": "2020-09-08T19:50:30Z", "message": "chore: add details to dhis-web-apps index and json"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDQ4NDUz", "url": "https://github.com/dhis2/dhis2-core/pull/6111#pullrequestreview-484448453", "createdAt": "2020-09-08T19:54:42Z", "commit": {"oid": "e0741fe1c5b320255f81938beefd6ab7eefea6e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxOTo1NDo0MlrOHOr3WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxOTo1NDo0MlrOHOr3WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2MDc5Mw==", "bodyText": "I think a better name here is just bundled. The \"is\" prefix is normally avoided in primitive booleans, as \"is\" the regular prefix for get methods. The \"app\" part is implicit since the object is called App.\nThe the getter/setter become isBundled and setBundled.", "url": "https://github.com/dhis2/dhis2-core/pull/6111#discussion_r485160793", "createdAt": "2020-09-08T19:54:42Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/appmanager/App.java", "diffHunk": "@@ -95,9 +95,12 @@\n \n     private Set<String> authorities = new HashSet<>();\n \n-    private AppStatus appState = AppStatus.OK;\n+    private boolean coreApp = false;\n \n-    private boolean isBundledApp = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0741fe1c5b320255f81938beefd6ab7eefea6e4"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDYxODgy", "url": "https://github.com/dhis2/dhis2-core/pull/6111#pullrequestreview-484461882", "createdAt": "2020-09-08T20:15:37Z", "commit": {"oid": "e0741fe1c5b320255f81938beefd6ab7eefea6e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMDoxNTozN1rOHOsg9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMDoxNTozN1rOHOsg9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE3MTQ0NQ==", "bodyText": "Typo: \"muse\" -> \"must\".", "url": "https://github.com/dhis2/dhis2-core/pull/6111#discussion_r485171445", "createdAt": "2020-09-08T20:15:37Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/appmanager/JCloudsAppStorageService.java", "diffHunk": "@@ -271,6 +271,63 @@ public void cleanUp()\n         return reservedNamespaces;\n     }\n \n+    private boolean validateApp( App app, Cache<App> appCache )\n+    {\n+        // -----------------------------------------------------------------\n+        // Check if app with same key is currently being deleted (deletion_in_progress)\n+        // -----------------------------------------------------------------\n+        Optional<App> existingApp = appCache.getIfPresent( app.getKey() );\n+        if ( existingApp.isPresent() && existingApp.get().getAppState() == AppStatus.DELETION_IN_PROGRESS )\n+        {\n+            log.error( \"Failed to install app: App with same name is currently being deleted\" );\n+\n+            app.setAppState( AppStatus.DELETION_IN_PROGRESS );\n+            return false;\n+        }\n+\n+        // -----------------------------------------------------------------\n+        // Check for namespace and if it's already taken by another app\n+        // -----------------------------------------------------------------\n+\n+        String namespace = app.getActivities().getDhis().getNamespace();\n+\n+        if ( namespace != null && !namespace.isEmpty() && app.equals( reservedNamespaces.get( namespace ) ) )\n+        {\n+            log.error( String.format( \"Failed to install app '%s': Namespace '%s' already taken.\",\n+                app.getName(), namespace ) );\n+\n+            app.setAppState( AppStatus.NAMESPACE_TAKEN );\n+            return false;\n+        }\n+\n+        // -----------------------------------------------------------------\n+        // Check that, iff this is a bundled app, it is configured as a core app\n+        // -----------------------------------------------------------------\n+\n+        if ( app.getIsBundledApp() != app.getIsCoreApp() )\n+        {\n+            if ( app.getIsBundledApp() )\n+            {\n+                log.error(\n+                    String.format(\n+                        \"Failed to install app '%s': bundled app overrides muse be declared with core_app=true\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0741fe1c5b320255f81938beefd6ab7eefea6e4"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDYzNTU1", "url": "https://github.com/dhis2/dhis2-core/pull/6111#pullrequestreview-484463555", "createdAt": "2020-09-08T20:18:15Z", "commit": {"oid": "e0741fe1c5b320255f81938beefd6ab7eefea6e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMDoxODoxNlrOHOslzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMDoxODoxNlrOHOslzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE3MjY4Ng==", "bodyText": "A unit test would be appropriate here, as this code can easily be tested. Method could be made public (or just default modifier). Can wait until after hard freeze.", "url": "https://github.com/dhis2/dhis2-core/pull/6111#discussion_r485172686", "createdAt": "2020-09-08T20:18:16Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/appmanager/JCloudsAppStorageService.java", "diffHunk": "@@ -271,6 +271,63 @@ public void cleanUp()\n         return reservedNamespaces;\n     }\n \n+    private boolean validateApp( App app, Cache<App> appCache )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0741fe1c5b320255f81938beefd6ab7eefea6e4"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NDY1NDI5", "url": "https://github.com/dhis2/dhis2-core/pull/6111#pullrequestreview-484465429", "createdAt": "2020-09-08T20:21:15Z", "commit": {"oid": "e0741fe1c5b320255f81938beefd6ab7eefea6e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c3a2ae68809ee3c002464f7c680026cac115143", "author": {"user": {"login": "amcgee", "name": "Austin McGee"}}, "url": "https://github.com/dhis2/dhis2-core/commit/9c3a2ae68809ee3c002464f7c680026cac115143", "committedDate": "2020-09-08T20:27:34Z", "message": "chore: use simpler boolean getters, setters, and properties"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2507, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}