{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzOTY0MDcz", "number": 4726, "title": "feat: Support saving jsonb auditAttributes", "bodyText": "https://jira.dhis2.org/browse/DHIS2-8123", "createdAt": "2020-01-17T04:57:42Z", "url": "https://github.com/dhis2/dhis2-core/pull/4726", "merged": true, "mergeCommit": {"oid": "a3ee65c1d7c3bc7920e74c548a0a0e5ac7214593"}, "closed": true, "closedAt": "2020-02-10T07:42:28Z", "author": {"login": "vietnguyen"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7HhvZgBqjI5NTY5MTg2OTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcC4MYIAFqTM1NTczNDQxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb6075f693c616a8a07343a08be6718452af4e3d", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/cb6075f693c616a8a07343a08be6718452af4e3d", "committedDate": "2020-01-17T04:55:27Z", "message": "feat: support saving jsonb auditAttributes"}, "afterCommit": {"oid": "1a8003993d0c4381a483881901f1fc3921c2498d", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1a8003993d0c4381a483881901f1fc3921c2498d", "committedDate": "2020-01-17T05:01:56Z", "message": "feat: support saving jsonb auditAttributes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a8003993d0c4381a483881901f1fc3921c2498d", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1a8003993d0c4381a483881901f1fc3921c2498d", "committedDate": "2020-01-17T05:01:56Z", "message": "feat: support saving jsonb auditAttributes"}, "afterCommit": {"oid": "65f570e6309c6475cf551738679ce168aec3fdbb", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/65f570e6309c6475cf551738679ce168aec3fdbb", "committedDate": "2020-01-17T05:06:14Z", "message": "feat: support saving jsonb auditAttributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28630d9e348ba1fca43ac4cf1e13cbc7b6f58802", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/28630d9e348ba1fca43ac4cf1e13cbc7b6f58802", "committedDate": "2020-01-17T08:46:54Z", "message": "feat: support saving jsonb auditAttributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d6b5533c58c14bbd3f5ac6c73286fec6981c3bf", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/8d6b5533c58c14bbd3f5ac6c73286fec6981c3bf", "committedDate": "2020-01-20T07:11:39Z", "message": "Merge remote-tracking branch 'upstream/master' into DHIS2-8123"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65f570e6309c6475cf551738679ce168aec3fdbb", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/65f570e6309c6475cf551738679ce168aec3fdbb", "committedDate": "2020-01-17T05:06:14Z", "message": "feat: support saving jsonb auditAttributes"}, "afterCommit": {"oid": "8d6b5533c58c14bbd3f5ac6c73286fec6981c3bf", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/8d6b5533c58c14bbd3f5ac6c73286fec6981c3bf", "committedDate": "2020-01-20T07:11:39Z", "message": "Merge remote-tracking branch 'upstream/master' into DHIS2-8123"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68d52af3b74fd7d49a8ee67a1eb019683bfa3b70", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/68d52af3b74fd7d49a8ee67a1eb019683bfa3b70", "committedDate": "2020-01-20T11:21:40Z", "message": "feat: add cache for auditAttributes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f472316ce50dd8249fa54e00877130873c80724", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/2f472316ce50dd8249fa54e00877130873c80724", "committedDate": "2020-01-21T05:44:31Z", "message": "feat: Add unit test for AnnotationUtil"}, "afterCommit": {"oid": "beea1ff70b20697f5d91c69bbec579d1dba14c27", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/beea1ff70b20697f5d91c69bbec579d1dba14c27", "committedDate": "2020-01-21T06:02:42Z", "message": "feat: Add unit test for AnnotationUtil"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "beea1ff70b20697f5d91c69bbec579d1dba14c27", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/beea1ff70b20697f5d91c69bbec579d1dba14c27", "committedDate": "2020-01-21T06:02:42Z", "message": "feat: Add unit test for AnnotationUtil"}, "afterCommit": {"oid": "795e9facdf8be6767f69fd941f1e21dd570251ad", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/795e9facdf8be6767f69fd941f1e21dd570251ad", "committedDate": "2020-01-21T06:07:48Z", "message": "feat: Add unit test for AnnotationUtil"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "795e9facdf8be6767f69fd941f1e21dd570251ad", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/795e9facdf8be6767f69fd941f1e21dd570251ad", "committedDate": "2020-01-21T06:07:48Z", "message": "feat: Add unit test for AnnotationUtil"}, "afterCommit": {"oid": "a39c9f2c0d082b26bf9278a2cfd2d348f1acd9b1", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a39c9f2c0d082b26bf9278a2cfd2d348f1acd9b1", "committedDate": "2020-01-21T06:08:41Z", "message": "feat: Add unit test for AnnotationUtil"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a39c9f2c0d082b26bf9278a2cfd2d348f1acd9b1", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a39c9f2c0d082b26bf9278a2cfd2d348f1acd9b1", "committedDate": "2020-01-21T06:08:41Z", "message": "feat: Add unit test for AnnotationUtil"}, "afterCommit": {"oid": "974c8a47ced360d241c205c16d5a86bd43893251", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/974c8a47ced360d241c205c16d5a86bd43893251", "committedDate": "2020-01-21T06:11:32Z", "message": "feat: Add unit test for AnnotationUtil"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "974c8a47ced360d241c205c16d5a86bd43893251", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/974c8a47ced360d241c205c16d5a86bd43893251", "committedDate": "2020-01-21T06:11:32Z", "message": "feat: Add unit test for AnnotationUtil"}, "afterCommit": {"oid": "34ac172873da811b11ec8f49ac203c7e1960e8cd", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/34ac172873da811b11ec8f49ac203c7e1960e8cd", "committedDate": "2020-01-21T06:14:21Z", "message": "feat: Add unit test for AnnotationUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fc4fa15ae11a78bec2e92d43dae65bdbb979702", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3fc4fa15ae11a78bec2e92d43dae65bdbb979702", "committedDate": "2020-01-21T06:51:30Z", "message": "feat: Add unit test for AnnotationUtil"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34ac172873da811b11ec8f49ac203c7e1960e8cd", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/34ac172873da811b11ec8f49ac203c7e1960e8cd", "committedDate": "2020-01-21T06:14:21Z", "message": "feat: Add unit test for AnnotationUtil"}, "afterCommit": {"oid": "3fc4fa15ae11a78bec2e92d43dae65bdbb979702", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3fc4fa15ae11a78bec2e92d43dae65bdbb979702", "committedDate": "2020-01-21T06:51:30Z", "message": "feat: Add unit test for AnnotationUtil"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODUyNTk4", "url": "https://github.com/dhis2/dhis2-core/pull/4726#pullrequestreview-347852598", "createdAt": "2020-01-24T10:06:23Z", "commit": {"oid": "3fc4fa15ae11a78bec2e92d43dae65bdbb979702"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowNjoyM1rOFhY7fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowNjoyM1rOFhY7fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU1NTc3Mg==", "bodyText": "Please, add some Javadoc to explain what is annotation is used for", "url": "https://github.com/dhis2/dhis2-core/pull/4726#discussion_r370555772", "createdAt": "2020-01-24T10:06:23Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/audit/AuditAttribute.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.hisp.dhis.audit;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fc4fa15ae11a78bec2e92d43dae65bdbb979702"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MTY4Nzcx", "url": "https://github.com/dhis2/dhis2-core/pull/4726#pullrequestreview-349168771", "createdAt": "2020-01-28T07:24:18Z", "commit": {"oid": "3fc4fa15ae11a78bec2e92d43dae65bdbb979702"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzoyNDoxOVrOFibJww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzoyNToxN1rOFibKvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MDc3MQ==", "bodyText": "We should probably keep this under watch and make sure we don't kick any fields out... we have quite a lot of classes, and while I'm not sure how many places we will add this attribute, we should never be in a situation where some fields are kicked out of the cache", "url": "https://github.com/dhis2/dhis2-core/pull/4726#discussion_r371640771", "createdAt": "2020-01-28T07:24:19Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/legacy/DefaultAuditObjectFactory.java", "diffHunk": "@@ -46,9 +59,24 @@\n {\n     private final RenderService renderService;\n \n-    public DefaultAuditObjectFactory( RenderService renderService )\n+    private final CacheProvider cacheProvider;\n+\n+    private Cache<Map<Field, Method>> cachedAuditAttributeFields;\n+\n+    public DefaultAuditObjectFactory( RenderService renderService, CacheProvider cacheProvider )\n     {\n         this.renderService = renderService;\n+        this.cacheProvider = cacheProvider;\n+    }\n+\n+    @PostConstruct\n+    public void initCache()\n+    {\n+        cachedAuditAttributeFields = cacheProvider.newCacheBuilder( Field.class, Method.class )\n+            .forRegion( \"auditAttributeFields\" )\n+            .withInitialCapacity( 100 )\n+            .withMaximumSize( 500 )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fc4fa15ae11a78bec2e92d43dae65bdbb979702"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MTAyMQ==", "bodyText": "Could probably be collapsed to a single return? no need to split up here", "url": "https://github.com/dhis2/dhis2-core/pull/4726#discussion_r371641021", "createdAt": "2020-01-28T07:25:17Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/legacy/DefaultAuditObjectFactory.java", "diffHunk": "@@ -67,6 +95,38 @@ public Object create( AuditScope auditScope, AuditType auditType, Object object,\n         return null;\n     }\n \n+    @Override\n+    public AuditAttributes collectAuditAttributes( Object auditObject )\n+    {\n+        AuditAttributes auditAttributes = new AuditAttributes();\n+\n+        getAuditAttributeFields( auditObject.getClass() ).entrySet().forEach( entry -> {\n+\n+            Object attributeObject = ReflectionUtils.invokeMethod( auditObject, entry.getValue() );\n+\n+            if ( !ReflectionUtils.isCollection( attributeObject ) )\n+            {\n+                if ( attributeObject instanceof IdentifiableObject )\n+                {\n+                    auditAttributes.put( entry.getKey().getName(), ( ( IdentifiableObject ) attributeObject).getUid() );\n+                }\n+                else\n+                {\n+                    auditAttributes.put( entry.getKey().getName(), attributeObject );\n+                }\n+            }\n+        } );\n+\n+        return auditAttributes;\n+    }\n+\n+    private Map<Field, Method> getAuditAttributeFields( Class<?> auditClass )\n+    {\n+        Optional<Map<Field, Method>> listFields = cachedAuditAttributeFields.get( auditClass.getName(), a -> AnnotationUtils.getAnnotatedFields( auditClass, AuditAttribute.class ) );\n+\n+        return listFields.orElse( new HashMap<>() );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fc4fa15ae11a78bec2e92d43dae65bdbb979702"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38258cf873b8be92877542f22ee9ce3231035f8d", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/38258cf873b8be92877542f22ee9ce3231035f8d", "committedDate": "2020-01-29T05:21:16Z", "message": "feat: add java doc and clean up code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9ecad71e74b9bc195e61397dd70f82c537ba307", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b9ecad71e74b9bc195e61397dd70f82c537ba307", "committedDate": "2020-02-05T08:10:12Z", "message": "feat: add unit test for saving auditAttributes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NzM0NDE5", "url": "https://github.com/dhis2/dhis2-core/pull/4726#pullrequestreview-355734419", "createdAt": "2020-02-10T07:42:08Z", "commit": {"oid": "b9ecad71e74b9bc195e61397dd70f82c537ba307"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2922, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}