{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTk5NDgy", "number": 6768, "title": "fix: DHIS2-10001 logic added to tracker importer to validate TEIs mandatory attributes", "bodyText": "", "createdAt": "2020-11-26T17:17:55Z", "url": "https://github.com/dhis2/dhis2-core/pull/6768", "merged": true, "mergeCommit": {"oid": "d3aa60aac248b75b5728d245a876b0a0905748fb"}, "closed": true, "closedAt": "2020-12-02T15:34:37Z", "author": {"login": "gnespolino"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgWPJWAH2gAyNTI4MTk5NDgyOjFiNDEyZmRkMWFmMDAxNmQ5YzA2YTNkMzIwZGMyY2ViN2M5YTkzOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiQEgmAH2gAyNTI4MTk5NDgyOjJjMzBkYWQ5OGRhMWJiNjMxNjBiMmNmYjk4ZDE5NWJmNjYzMzM3MWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1b412fdd1af0016d9c06a3d320dc2ceb7c9a9392", "author": {"user": {"login": "gnespolino", "name": "Giuseppe Nespolino"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1b412fdd1af0016d9c06a3d320dc2ceb7c9a9392", "committedDate": "2020-11-26T17:17:16Z", "message": "fix: DHIS2-10001 logic added to tracker importer to validate TEIs mandatory attributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6", "author": {"user": {"login": "gnespolino", "name": "Giuseppe Nespolino"}}, "url": "https://github.com/dhis2/dhis2-core/commit/fe8c907baeb7e9cf517e7452431782eb6f7b38e6", "committedDate": "2020-11-27T12:45:00Z", "message": "fix: DHIS2-10001 mandatory attributes in existing tests is set to false to fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODE2ODM3", "url": "https://github.com/dhis2/dhis2-core/pull/6768#pullrequestreview-541816837", "createdAt": "2020-12-01T11:45:44Z", "commit": {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxOTIxMjY3", "url": "https://github.com/dhis2/dhis2-core/pull/6768#pullrequestreview-541921267", "createdAt": "2020-12-01T14:01:39Z", "commit": {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNDowMTozOVrOH8t5ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNDoxMToxMFrOH8uUNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyODYxOA==", "bodyText": "This TEI passed to validation cannot be null, so we could simply get the attributes without the optional", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r533428618", "createdAt": "2020-12-01T14:01:39Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "diffHunk": "@@ -97,6 +104,47 @@ public void validateTrackedEntity( ValidationErrorReporter reporter, TrackedEnti\n         OrganisationUnit organisationUnit = context.getOrganisationUnit( trackedEntity.getOrgUnit() );\n \n         validateAttributes( reporter, trackedEntity, tei, organisationUnit );\n+        validateMandatoryAttributes( reporter, trackedEntity );\n+    }\n+\n+    private void validateMandatoryAttributes( ValidationErrorReporter reporter, TrackedEntity trackedEntity )\n+    {\n+        TrackedEntityType trackedEntityType = reporter.getValidationContext()\n+            .getTrackedEntityType( trackedEntity.getTrackedEntityType() );\n+\n+        if ( trackedEntityType != null )\n+        {\n+            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzNTQ0Nw==", "bodyText": "I found difficult following this Optional.of and then orElse flow and I am not sure if in this case you could really have a null TrackedEntityTypeAttribute in the list of trackedEntityType.getTrackedEntityTypeAttributes()\nI would go with\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .filter( this::isMandatory )\n          \n          \n            \n                           .filter(Obects::isNotNull)\n          \n          \n            \n                           .filter(TrackedEntityTypeAttribute::isMandatory)\n          \n      \n    \n    \n  \n\nbut of course this is purely personal style", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r533435447", "createdAt": "2020-12-01T14:11:10Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "diffHunk": "@@ -97,6 +104,47 @@ public void validateTrackedEntity( ValidationErrorReporter reporter, TrackedEnti\n         OrganisationUnit organisationUnit = context.getOrganisationUnit( trackedEntity.getOrgUnit() );\n \n         validateAttributes( reporter, trackedEntity, tei, organisationUnit );\n+        validateMandatoryAttributes( reporter, trackedEntity );\n+    }\n+\n+    private void validateMandatoryAttributes( ValidationErrorReporter reporter, TrackedEntity trackedEntity )\n+    {\n+        TrackedEntityType trackedEntityType = reporter.getValidationContext()\n+            .getTrackedEntityType( trackedEntity.getTrackedEntityType() );\n+\n+        if ( trackedEntityType != null )\n+        {\n+            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )\n+                .map( TrackedEntity::getAttributes )\n+                .orElse( Collections.emptyList() )\n+                .stream()\n+                .map( Attribute::getAttribute )\n+                .collect( Collectors.toSet() );\n+\n+            trackedEntityType.getTrackedEntityTypeAttributes()\n+                .stream()\n+                .filter( this::isMandatory )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c30dad98da1bb63160b2cfb98d195bf6633371d", "author": {"user": {"login": "gnespolino", "name": "Giuseppe Nespolino"}}, "url": "https://github.com/dhis2/dhis2-core/commit/2c30dad98da1bb63160b2cfb98d195bf6633371d", "committedDate": "2020-12-02T15:14:04Z", "message": "feat: DHIS2-10001 mandatory attribute check implementation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2246, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}