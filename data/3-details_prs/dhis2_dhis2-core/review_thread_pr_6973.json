{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzNTI2Nzgw", "number": 6973, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNToyMjozMlrOFH1HwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNToyMjozMlrOFH1HwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzNzU0Njg5OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/programrule/ShowErrorWarningImplementerTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNToyMjozMlrOIJb8cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMToyNzozOFrOIJ37Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc2NTkzNw==", "bodyText": "Mocking data is a bit controversial, in general, it should be avoided. I guess in this case, it's not worth to change.", "url": "https://github.com/dhis2/dhis2-core/pull/6973#discussion_r546765937", "createdAt": "2020-12-21T15:22:32Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/programrule/ShowErrorWarningImplementerTest.java", "diffHunk": "@@ -71,173 +63,133 @@\n \n     private final static String EVALUATED_DATA = \"4.0\";\n \n-    @Autowired\n-    private ObjectBundleService objectBundleService;\n-\n-    @Autowired\n-    private ObjectBundleValidationService objectBundleValidationService;\n-\n-    @Autowired\n-    private RenderService _renderService;\n+    private final static String ACTIVE_ENROLLMENT_ID = \"ActiveEnrollmentUid\";\n \n-    @Autowired\n-    private UserService _userService;\n+    private final static String COMPLETED_ENROLLMENT_ID = \"CompletedEnrollmentUid\";\n \n-    @Autowired\n-    private TrackerBundleService trackerBundleService;\n+    private final static String ACTIVE_EVENT_ID = \"EventUid\";\n \n-    @Autowired\n-    private ProgramRuleService programRuleService;\n+    private final static String COMPLETED_EVENT_ID = \"CompletedEventUid\";\n \n-    @Autowired\n-    private ProgramRuleActionService programRuleActionService;\n+    private final static String ERROR_PREFIX = \"Error\";\n \n-    @Autowired\n-    private ShowWarningOnCompleteValidator warningOnCompleteImplementer;\n+    private final static String WARNING_PREFIX = \"Warning\";\n \n-    @Autowired\n-    private ShowErrorOnCompleteValidator errorOnCompleteImplementer;\n-\n-    @Autowired\n-    private ShowErrorValidator errorImplementer;\n-\n-    @Autowired\n-    private ShowWarningValidator warningImplementer;\n-\n-    private TrackerBundle trackerBundle;\n-\n-    @Override\n-    protected void setUpTest()\n-        throws IOException\n-    {\n-        renderService = _renderService;\n-        userService = _userService;\n+    private final static String ERROR_ON_COMPLETE_PREFIX = \"Error on complete\";\n \n-        Map<Class<? extends IdentifiableObject>, List<IdentifiableObject>> metadata = renderService\n-            .fromMetadata( new ClassPathResource( \"tracker/event_metadata.json\" ).getInputStream(), RenderFormat.JSON );\n+    private final static String WARNING_ON_COMPLETE_PREFIX = \"Warning on complete\";\n \n-        ObjectBundleParams params = new ObjectBundleParams();\n-        params.setObjectBundleMode( ObjectBundleMode.COMMIT );\n-        params.setImportStrategy( ImportStrategy.CREATE );\n-        params.setObjects( metadata );\n+    private final static String PROGRAM_STAGE_ID = \"ProrgamStageId\";\n \n-        ObjectBundle bundle = objectBundleService.create( params );\n-        ObjectBundleValidationReport validationReport = objectBundleValidationService.validate( bundle );\n-        assertTrue( validationReport.getErrorReports().isEmpty() );\n+    private final static String DATA_ELEMENT_ID = \"DataElementId\";\n \n-        objectBundleService.commit( bundle );\n+    private ShowWarningOnCompleteValidator warningOnCompleteImplementer = new ShowWarningOnCompleteValidator();\n \n-        Program program = bundle.getPreheat().get( PreheatIdentifier.UID, Program.class, \"BFcipDERJwr\" );\n+    private ShowErrorOnCompleteValidator errorOnCompleteImplementer = new ShowErrorOnCompleteValidator();\n \n-        ProgramRule programRule = createProgramRule( 'B',\n-            program );\n-        programRule.setCondition( \"true\" );\n-        programRuleService.addProgramRule( programRule );\n-        ProgramRuleAction programRuleActionError = createProgramRuleAction( 'A', programRule );\n-        programRuleActionError.setProgramRuleActionType( ProgramRuleActionType.SHOWERROR );\n+    private ShowErrorValidator errorImplementer = new ShowErrorValidator();\n \n-        programRuleActionError.setContent( CONTENT );\n-        programRuleActionError.setData( DATA );\n-        programRuleActionService.addProgramRuleAction( programRuleActionError );\n+    private ShowWarningValidator warningImplementer = new ShowWarningValidator();\n \n-        ProgramRuleAction programRuleActionErrorOnComplete = createProgramRuleAction( 'B', programRule );\n-        programRuleActionErrorOnComplete.setProgramRuleActionType( ProgramRuleActionType.ERRORONCOMPLETE );\n+    private TrackerBundle bundle;\n \n-        programRuleActionErrorOnComplete.setContent( CONTENT );\n-        programRuleActionErrorOnComplete.setData( DATA );\n-        programRuleActionService.addProgramRuleAction( programRuleActionErrorOnComplete );\n+    @Mock\n+    private TrackerPreheat preheat;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a461de33d9589d538e53787c42c7042b81aa6cc"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEyNDc5NA==", "bodyText": "When we test and there is the Preheat involved is always difficult to go to the actual service to mock it.\nIn the end, we are using the Preheat as a service that give us the data from the DB in a performant way.", "url": "https://github.com/dhis2/dhis2-core/pull/6973#discussion_r547124794", "createdAt": "2020-12-22T07:59:43Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/programrule/ShowErrorWarningImplementerTest.java", "diffHunk": "@@ -71,173 +63,133 @@\n \n     private final static String EVALUATED_DATA = \"4.0\";\n \n-    @Autowired\n-    private ObjectBundleService objectBundleService;\n-\n-    @Autowired\n-    private ObjectBundleValidationService objectBundleValidationService;\n-\n-    @Autowired\n-    private RenderService _renderService;\n+    private final static String ACTIVE_ENROLLMENT_ID = \"ActiveEnrollmentUid\";\n \n-    @Autowired\n-    private UserService _userService;\n+    private final static String COMPLETED_ENROLLMENT_ID = \"CompletedEnrollmentUid\";\n \n-    @Autowired\n-    private TrackerBundleService trackerBundleService;\n+    private final static String ACTIVE_EVENT_ID = \"EventUid\";\n \n-    @Autowired\n-    private ProgramRuleService programRuleService;\n+    private final static String COMPLETED_EVENT_ID = \"CompletedEventUid\";\n \n-    @Autowired\n-    private ProgramRuleActionService programRuleActionService;\n+    private final static String ERROR_PREFIX = \"Error\";\n \n-    @Autowired\n-    private ShowWarningOnCompleteValidator warningOnCompleteImplementer;\n+    private final static String WARNING_PREFIX = \"Warning\";\n \n-    @Autowired\n-    private ShowErrorOnCompleteValidator errorOnCompleteImplementer;\n-\n-    @Autowired\n-    private ShowErrorValidator errorImplementer;\n-\n-    @Autowired\n-    private ShowWarningValidator warningImplementer;\n-\n-    private TrackerBundle trackerBundle;\n-\n-    @Override\n-    protected void setUpTest()\n-        throws IOException\n-    {\n-        renderService = _renderService;\n-        userService = _userService;\n+    private final static String ERROR_ON_COMPLETE_PREFIX = \"Error on complete\";\n \n-        Map<Class<? extends IdentifiableObject>, List<IdentifiableObject>> metadata = renderService\n-            .fromMetadata( new ClassPathResource( \"tracker/event_metadata.json\" ).getInputStream(), RenderFormat.JSON );\n+    private final static String WARNING_ON_COMPLETE_PREFIX = \"Warning on complete\";\n \n-        ObjectBundleParams params = new ObjectBundleParams();\n-        params.setObjectBundleMode( ObjectBundleMode.COMMIT );\n-        params.setImportStrategy( ImportStrategy.CREATE );\n-        params.setObjects( metadata );\n+    private final static String PROGRAM_STAGE_ID = \"ProrgamStageId\";\n \n-        ObjectBundle bundle = objectBundleService.create( params );\n-        ObjectBundleValidationReport validationReport = objectBundleValidationService.validate( bundle );\n-        assertTrue( validationReport.getErrorReports().isEmpty() );\n+    private final static String DATA_ELEMENT_ID = \"DataElementId\";\n \n-        objectBundleService.commit( bundle );\n+    private ShowWarningOnCompleteValidator warningOnCompleteImplementer = new ShowWarningOnCompleteValidator();\n \n-        Program program = bundle.getPreheat().get( PreheatIdentifier.UID, Program.class, \"BFcipDERJwr\" );\n+    private ShowErrorOnCompleteValidator errorOnCompleteImplementer = new ShowErrorOnCompleteValidator();\n \n-        ProgramRule programRule = createProgramRule( 'B',\n-            program );\n-        programRule.setCondition( \"true\" );\n-        programRuleService.addProgramRule( programRule );\n-        ProgramRuleAction programRuleActionError = createProgramRuleAction( 'A', programRule );\n-        programRuleActionError.setProgramRuleActionType( ProgramRuleActionType.SHOWERROR );\n+    private ShowErrorValidator errorImplementer = new ShowErrorValidator();\n \n-        programRuleActionError.setContent( CONTENT );\n-        programRuleActionError.setData( DATA );\n-        programRuleActionService.addProgramRuleAction( programRuleActionError );\n+    private ShowWarningValidator warningImplementer = new ShowWarningValidator();\n \n-        ProgramRuleAction programRuleActionErrorOnComplete = createProgramRuleAction( 'B', programRule );\n-        programRuleActionErrorOnComplete.setProgramRuleActionType( ProgramRuleActionType.ERRORONCOMPLETE );\n+    private TrackerBundle bundle;\n \n-        programRuleActionErrorOnComplete.setContent( CONTENT );\n-        programRuleActionErrorOnComplete.setData( DATA );\n-        programRuleActionService.addProgramRuleAction( programRuleActionErrorOnComplete );\n+    @Mock\n+    private TrackerPreheat preheat;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc2NTkzNw=="}, "originalCommit": {"oid": "6a461de33d9589d538e53787c42c7042b81aa6cc"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIwMTYzMg==", "bodyText": "Sorry Enrico, I placed the cursor on the wrong place. I meant this:\n@Mock\nprivate ProgramStage programStage;", "url": "https://github.com/dhis2/dhis2-core/pull/6973#discussion_r547201632", "createdAt": "2020-12-22T10:38:36Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/programrule/ShowErrorWarningImplementerTest.java", "diffHunk": "@@ -71,173 +63,133 @@\n \n     private final static String EVALUATED_DATA = \"4.0\";\n \n-    @Autowired\n-    private ObjectBundleService objectBundleService;\n-\n-    @Autowired\n-    private ObjectBundleValidationService objectBundleValidationService;\n-\n-    @Autowired\n-    private RenderService _renderService;\n+    private final static String ACTIVE_ENROLLMENT_ID = \"ActiveEnrollmentUid\";\n \n-    @Autowired\n-    private UserService _userService;\n+    private final static String COMPLETED_ENROLLMENT_ID = \"CompletedEnrollmentUid\";\n \n-    @Autowired\n-    private TrackerBundleService trackerBundleService;\n+    private final static String ACTIVE_EVENT_ID = \"EventUid\";\n \n-    @Autowired\n-    private ProgramRuleService programRuleService;\n+    private final static String COMPLETED_EVENT_ID = \"CompletedEventUid\";\n \n-    @Autowired\n-    private ProgramRuleActionService programRuleActionService;\n+    private final static String ERROR_PREFIX = \"Error\";\n \n-    @Autowired\n-    private ShowWarningOnCompleteValidator warningOnCompleteImplementer;\n+    private final static String WARNING_PREFIX = \"Warning\";\n \n-    @Autowired\n-    private ShowErrorOnCompleteValidator errorOnCompleteImplementer;\n-\n-    @Autowired\n-    private ShowErrorValidator errorImplementer;\n-\n-    @Autowired\n-    private ShowWarningValidator warningImplementer;\n-\n-    private TrackerBundle trackerBundle;\n-\n-    @Override\n-    protected void setUpTest()\n-        throws IOException\n-    {\n-        renderService = _renderService;\n-        userService = _userService;\n+    private final static String ERROR_ON_COMPLETE_PREFIX = \"Error on complete\";\n \n-        Map<Class<? extends IdentifiableObject>, List<IdentifiableObject>> metadata = renderService\n-            .fromMetadata( new ClassPathResource( \"tracker/event_metadata.json\" ).getInputStream(), RenderFormat.JSON );\n+    private final static String WARNING_ON_COMPLETE_PREFIX = \"Warning on complete\";\n \n-        ObjectBundleParams params = new ObjectBundleParams();\n-        params.setObjectBundleMode( ObjectBundleMode.COMMIT );\n-        params.setImportStrategy( ImportStrategy.CREATE );\n-        params.setObjects( metadata );\n+    private final static String PROGRAM_STAGE_ID = \"ProrgamStageId\";\n \n-        ObjectBundle bundle = objectBundleService.create( params );\n-        ObjectBundleValidationReport validationReport = objectBundleValidationService.validate( bundle );\n-        assertTrue( validationReport.getErrorReports().isEmpty() );\n+    private final static String DATA_ELEMENT_ID = \"DataElementId\";\n \n-        objectBundleService.commit( bundle );\n+    private ShowWarningOnCompleteValidator warningOnCompleteImplementer = new ShowWarningOnCompleteValidator();\n \n-        Program program = bundle.getPreheat().get( PreheatIdentifier.UID, Program.class, \"BFcipDERJwr\" );\n+    private ShowErrorOnCompleteValidator errorOnCompleteImplementer = new ShowErrorOnCompleteValidator();\n \n-        ProgramRule programRule = createProgramRule( 'B',\n-            program );\n-        programRule.setCondition( \"true\" );\n-        programRuleService.addProgramRule( programRule );\n-        ProgramRuleAction programRuleActionError = createProgramRuleAction( 'A', programRule );\n-        programRuleActionError.setProgramRuleActionType( ProgramRuleActionType.SHOWERROR );\n+    private ShowErrorValidator errorImplementer = new ShowErrorValidator();\n \n-        programRuleActionError.setContent( CONTENT );\n-        programRuleActionError.setData( DATA );\n-        programRuleActionService.addProgramRuleAction( programRuleActionError );\n+    private ShowWarningValidator warningImplementer = new ShowWarningValidator();\n \n-        ProgramRuleAction programRuleActionErrorOnComplete = createProgramRuleAction( 'B', programRule );\n-        programRuleActionErrorOnComplete.setProgramRuleActionType( ProgramRuleActionType.ERRORONCOMPLETE );\n+    private TrackerBundle bundle;\n \n-        programRuleActionErrorOnComplete.setContent( CONTENT );\n-        programRuleActionErrorOnComplete.setData( DATA );\n-        programRuleActionService.addProgramRuleAction( programRuleActionErrorOnComplete );\n+    @Mock\n+    private TrackerPreheat preheat;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc2NTkzNw=="}, "originalCommit": {"oid": "6a461de33d9589d538e53787c42c7042b81aa6cc"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIyNDM0Ng==", "bodyText": "I agree, fixed", "url": "https://github.com/dhis2/dhis2-core/pull/6973#discussion_r547224346", "createdAt": "2020-12-22T11:27:38Z", "author": {"login": "enricocolasante"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/programrule/ShowErrorWarningImplementerTest.java", "diffHunk": "@@ -71,173 +63,133 @@\n \n     private final static String EVALUATED_DATA = \"4.0\";\n \n-    @Autowired\n-    private ObjectBundleService objectBundleService;\n-\n-    @Autowired\n-    private ObjectBundleValidationService objectBundleValidationService;\n-\n-    @Autowired\n-    private RenderService _renderService;\n+    private final static String ACTIVE_ENROLLMENT_ID = \"ActiveEnrollmentUid\";\n \n-    @Autowired\n-    private UserService _userService;\n+    private final static String COMPLETED_ENROLLMENT_ID = \"CompletedEnrollmentUid\";\n \n-    @Autowired\n-    private TrackerBundleService trackerBundleService;\n+    private final static String ACTIVE_EVENT_ID = \"EventUid\";\n \n-    @Autowired\n-    private ProgramRuleService programRuleService;\n+    private final static String COMPLETED_EVENT_ID = \"CompletedEventUid\";\n \n-    @Autowired\n-    private ProgramRuleActionService programRuleActionService;\n+    private final static String ERROR_PREFIX = \"Error\";\n \n-    @Autowired\n-    private ShowWarningOnCompleteValidator warningOnCompleteImplementer;\n+    private final static String WARNING_PREFIX = \"Warning\";\n \n-    @Autowired\n-    private ShowErrorOnCompleteValidator errorOnCompleteImplementer;\n-\n-    @Autowired\n-    private ShowErrorValidator errorImplementer;\n-\n-    @Autowired\n-    private ShowWarningValidator warningImplementer;\n-\n-    private TrackerBundle trackerBundle;\n-\n-    @Override\n-    protected void setUpTest()\n-        throws IOException\n-    {\n-        renderService = _renderService;\n-        userService = _userService;\n+    private final static String ERROR_ON_COMPLETE_PREFIX = \"Error on complete\";\n \n-        Map<Class<? extends IdentifiableObject>, List<IdentifiableObject>> metadata = renderService\n-            .fromMetadata( new ClassPathResource( \"tracker/event_metadata.json\" ).getInputStream(), RenderFormat.JSON );\n+    private final static String WARNING_ON_COMPLETE_PREFIX = \"Warning on complete\";\n \n-        ObjectBundleParams params = new ObjectBundleParams();\n-        params.setObjectBundleMode( ObjectBundleMode.COMMIT );\n-        params.setImportStrategy( ImportStrategy.CREATE );\n-        params.setObjects( metadata );\n+    private final static String PROGRAM_STAGE_ID = \"ProrgamStageId\";\n \n-        ObjectBundle bundle = objectBundleService.create( params );\n-        ObjectBundleValidationReport validationReport = objectBundleValidationService.validate( bundle );\n-        assertTrue( validationReport.getErrorReports().isEmpty() );\n+    private final static String DATA_ELEMENT_ID = \"DataElementId\";\n \n-        objectBundleService.commit( bundle );\n+    private ShowWarningOnCompleteValidator warningOnCompleteImplementer = new ShowWarningOnCompleteValidator();\n \n-        Program program = bundle.getPreheat().get( PreheatIdentifier.UID, Program.class, \"BFcipDERJwr\" );\n+    private ShowErrorOnCompleteValidator errorOnCompleteImplementer = new ShowErrorOnCompleteValidator();\n \n-        ProgramRule programRule = createProgramRule( 'B',\n-            program );\n-        programRule.setCondition( \"true\" );\n-        programRuleService.addProgramRule( programRule );\n-        ProgramRuleAction programRuleActionError = createProgramRuleAction( 'A', programRule );\n-        programRuleActionError.setProgramRuleActionType( ProgramRuleActionType.SHOWERROR );\n+    private ShowErrorValidator errorImplementer = new ShowErrorValidator();\n \n-        programRuleActionError.setContent( CONTENT );\n-        programRuleActionError.setData( DATA );\n-        programRuleActionService.addProgramRuleAction( programRuleActionError );\n+    private ShowWarningValidator warningImplementer = new ShowWarningValidator();\n \n-        ProgramRuleAction programRuleActionErrorOnComplete = createProgramRuleAction( 'B', programRule );\n-        programRuleActionErrorOnComplete.setProgramRuleActionType( ProgramRuleActionType.ERRORONCOMPLETE );\n+    private TrackerBundle bundle;\n \n-        programRuleActionErrorOnComplete.setContent( CONTENT );\n-        programRuleActionErrorOnComplete.setData( DATA );\n-        programRuleActionService.addProgramRuleAction( programRuleActionErrorOnComplete );\n+    @Mock\n+    private TrackerPreheat preheat;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc2NTkzNw=="}, "originalCommit": {"oid": "6a461de33d9589d538e53787c42c7042b81aa6cc"}, "originalPosition": 155}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3653, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}