{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MDYxMjM5", "number": 6163, "title": "fix: [DHIS2-9023] Block programStage deletion when a program rule is linked to it", "bodyText": "", "createdAt": "2020-09-16T15:14:10Z", "url": "https://github.com/dhis2/dhis2-core/pull/6163", "merged": true, "mergeCommit": {"oid": "42a2433b818ec05b1ee28fabe3d8eed5bddac230"}, "closed": true, "closedAt": "2020-09-22T12:04:13Z", "author": {"login": "enricocolasante"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJd71EgH2gAyNDg4MDYxMjM5OjNmYTBjOGM0YWUzMTI4ZWZlOGUwM2Y0ZGJjNjg2NTViZGRhNDI5NjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLT8PkAH2gAyNDg4MDYxMjM5OjA2MDI2Nzc0ZGZhY2RjZTIwMmQyNDllNjNiYjA1M2ZmYzk5MzcxMTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "committedDate": "2020-09-16T15:15:09Z", "message": "fix: [DHIS2-9023] Block programStage deletion when a program rule is linked to it"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38671aa037cd5e3f407842710ebe686d05e4ef13", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/38671aa037cd5e3f407842710ebe686d05e4ef13", "committedDate": "2020-09-16T14:53:20Z", "message": "[DHIS2-9023] Block programStage deletion when a program rule is linked to it"}, "afterCommit": {"oid": "3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "committedDate": "2020-09-16T15:15:09Z", "message": "fix: [DHIS2-9023] Block programStage deletion when a program rule is linked to it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f752745e476d1421f775ef5044315ab564d954a", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/6f752745e476d1421f775ef5044315ab564d954a", "committedDate": "2020-09-16T15:45:25Z", "message": "Fix sonar code smells"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMzAwNzIz", "url": "https://github.com/dhis2/dhis2-core/pull/6163#pullrequestreview-491300723", "createdAt": "2020-09-18T09:29:21Z", "commit": {"oid": "6f752745e476d1421f775ef5044315ab564d954a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjI4MDc2", "url": "https://github.com/dhis2/dhis2-core/pull/6163#pullrequestreview-493228076", "createdAt": "2020-09-22T08:23:26Z", "commit": {"oid": "6f752745e476d1421f775ef5044315ab564d954a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODoyMzoyNlrOHVvPCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODoyNDoxOFrOHVvRFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU1NjA0MA==", "bodyText": "Minor: Might be slightly more compact and avoid to stream twice, like this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Override\n          \n          \n            \n                public String allowDeleteProgramStage( ProgramStage programStage )\n          \n          \n            \n                {\n          \n          \n            \n                    List<ProgramRule> programRuleVariables = programRuleService\n          \n          \n            \n                        .getProgramRule( programStage.getProgram() )\n          \n          \n            \n                        .stream()\n          \n          \n            \n                        .filter( pr -> isLinkedToProgramStage( programStage, pr ) )\n          \n          \n            \n                        .collect( Collectors.toList() );\n          \n          \n            \n            \n          \n          \n            \n                    if ( programRuleVariables.isEmpty() )\n          \n          \n            \n                    {\n          \n          \n            \n                        return null;\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    return programRuleVariables.stream()\n          \n          \n            \n                        .map( BaseIdentifiableObject::getName )\n          \n          \n            \n                        .collect( Collectors.joining( \", \" ) );\n          \n          \n            \n                }\n          \n          \n            \n                @Override\n          \n          \n            \n                public String allowDeleteProgramStage( ProgramStage programStage )\n          \n          \n            \n                {\n          \n          \n            \n                    String programRuleVariables = programRuleService\n          \n          \n            \n                        .getProgramRule( programStage.getProgram() )\n          \n          \n            \n                        .stream()\n          \n          \n            \n                        .filter( pr -> isLinkedToProgramStage( programStage, pr ) )\n          \n          \n            \n                        .map( BaseIdentifiableObject::getName )\n          \n          \n            \n                        .collect( Collectors.joining( \", \" ) );\n          \n          \n            \n            \n          \n          \n            \n                    return StringUtils.isBlank( programRuleVariables ) ? null : programRuleVariables;\n          \n          \n            \n                }", "url": "https://github.com/dhis2/dhis2-core/pull/6163#discussion_r492556040", "createdAt": "2020-09-22T08:23:26Z", "author": {"login": "gnespolino"}, "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/ProgramRuleDeletionHandler.java", "diffHunk": "@@ -72,4 +78,31 @@ public void deleteProgram( Program program )\n             programRuleService.deleteProgramRule( programRule );\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteProgramStage( ProgramStage programStage )\n+    {\n+        List<ProgramRule> programRuleVariables = programRuleService\n+            .getProgramRule( programStage.getProgram() )\n+            .stream()\n+            .filter( pr -> isLinkedToProgramStage( programStage, pr ) )\n+            .collect( Collectors.toList() );\n+\n+        if ( programRuleVariables.isEmpty() )\n+        {\n+            return null;\n+        }\n+\n+        return programRuleVariables.stream()\n+            .map( BaseIdentifiableObject::getName )\n+            .collect( Collectors.joining( \", \" ) );\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f752745e476d1421f775ef5044315ab564d954a"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU1NjU2NQ==", "bodyText": "Same comment as before.", "url": "https://github.com/dhis2/dhis2-core/pull/6163#discussion_r492556565", "createdAt": "2020-09-22T08:24:18Z", "author": {"login": "gnespolino"}, "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/ProgramRuleVariableDeletionHandler.java", "diffHunk": "@@ -61,6 +67,25 @@ protected String getClassName()\n     {\n         return ProgramRuleVariable.class.getSimpleName();\n     }\n+\n+    @Override\n+    public String allowDeleteProgramStage( ProgramStage programStage )\n+    {\n+        List<ProgramRuleVariable> programRuleVariables = programRuleVariableService\n+            .getProgramRuleVariable( programStage.getProgram() )\n+            .stream()\n+            .filter( prv -> Objects.equals( prv.getProgramStage(), programStage ) )\n+            .collect( Collectors.toList() );\n+\n+        if ( programRuleVariables.isEmpty() )\n+        {\n+            return null;\n+        }\n+\n+        return programRuleVariables.stream()\n+            .map( BaseIdentifiableObject::getName )\n+            .collect( Collectors.joining( \", \" ) );\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f752745e476d1421f775ef5044315ab564d954a"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bef0e4db734072ae447ebb1758a099f600f8c23", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/4bef0e4db734072ae447ebb1758a099f600f8c23", "committedDate": "2020-09-22T08:28:22Z", "message": "Update dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/ProgramRuleDeletionHandler.java\n\nCo-authored-by: Giuseppe Nespolino <gnespolino@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06026774dfacdce202d249e63bb053ffc9937111", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/06026774dfacdce202d249e63bb053ffc9937111", "committedDate": "2020-09-22T08:44:24Z", "message": "Code review fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2446, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}