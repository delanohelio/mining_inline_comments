{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2OTUyOTEw", "number": 6045, "title": "feat: support collections for UserPropertyTransformer", "bodyText": "Adds support for PropertyTransformer on collections\n\nDHIS2-8750", "createdAt": "2020-09-01T09:37:07Z", "url": "https://github.com/dhis2/dhis2-core/pull/6045", "merged": true, "mergeCommit": {"oid": "28e42c9f4dfa144d037668588a3d0ae4fb24a6a1"}, "closed": true, "closedAt": "2020-09-03T06:23:57Z", "author": {"login": "mortenoh"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEkGdNAH2gAyNDc2OTUyOTEwOmZhMWFmNzVkMDcwZmI2NDYwYzNjODM0Y2ZlY2FjZDExNzBjNDhkODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFKeySAFqTQ4MTUyMjU1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fa1af75d070fb6460c3c834cfecacd1170c48d81", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/fa1af75d070fb6460c3c834cfecacd1170c48d81", "committedDate": "2020-09-01T09:36:34Z", "message": "fix: re-enable property transformer for getMembers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0288243f024478a503f537cc99d0397151b502d", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a0288243f024478a503f537cc99d0397151b502d", "committedDate": "2020-09-01T10:17:41Z", "message": "minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c33abedaec9efa9bb5c224ce4aa97fb8c249720", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3c33abedaec9efa9bb5c224ce4aa97fb8c249720", "committedDate": "2020-09-01T10:17:45Z", "message": "Merge remote-tracking branch 'origin/master' into user-collection-transformer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bcdf14ceb60923c4d831a3ddf707ec4c7919807", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3bcdf14ceb60923c4d831a3ddf707ec4c7919807", "committedDate": "2020-09-01T11:41:30Z", "message": "fix: minor code fixes, npe checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "048d03236516e056ef45e298b7b8c9e49ea9b754", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/048d03236516e056ef45e298b7b8c9e49ea9b754", "committedDate": "2020-09-01T12:05:54Z", "message": "fix: re-fetch schema for transformed properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96b538392adcf7e835b228919d151ba04eb43e7c", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/96b538392adcf7e835b228919d151ba04eb43e7c", "committedDate": "2020-09-02T06:49:36Z", "message": "Merge remote-tracking branch 'origin/master' into user-collection-transformer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c52f7c5436652c1f9e4c56e7a271e5534149088", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3c52f7c5436652c1f9e4c56e7a271e5534149088", "committedDate": "2020-09-02T08:49:52Z", "message": "Merge remote-tracking branch 'origin/master' into user-collection-transformer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c2a6fec4433b46490cb19ea3e60bee558ec4e13", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/9c2a6fec4433b46490cb19ea3e60bee558ec4e13", "committedDate": "2020-09-02T09:38:30Z", "message": "Merge remote-tracking branch 'origin/master' into user-collection-transformer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "390390c4e6f3aa58f710a2ce00160abec926d388", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/390390c4e6f3aa58f710a2ce00160abec926d388", "committedDate": "2020-09-02T10:45:10Z", "message": "minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "484e148a80d196f19936ff9f75da5dbd68d708ee", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/484e148a80d196f19936ff9f75da5dbd68d708ee", "committedDate": "2020-09-02T11:14:46Z", "message": "fix: support field expansion for property transformers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89e2751850d2a36efa15ca999e8d1a6327a4b883", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/89e2751850d2a36efa15ca999e8d1a6327a4b883", "committedDate": "2020-09-02T11:27:39Z", "message": "Merge remote-tracking branch 'origin/master' into user-collection-transformer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87", "committedDate": "2020-09-02T11:48:15Z", "message": "fix: npe check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzc5MTkw", "url": "https://github.com/dhis2/dhis2-core/pull/6045#pullrequestreview-480779190", "createdAt": "2020-09-02T12:43:13Z", "commit": {"oid": "e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNTIyMzQ4", "url": "https://github.com/dhis2/dhis2-core/pull/6045#pullrequestreview-481522348", "createdAt": "2020-09-03T06:19:05Z", "commit": {"oid": "e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwNjoxOTowNlrOHMXb2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwNjoxOTowNlrOHMXb2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyODkyMw==", "bodyText": "Maybe add a little message to this possible require non null, I guess this is not supposed to happen, but if... a small explanation what is possibly wrong could be nice, will also work as a sort of documentation possibly.", "url": "https://github.com/dhis2/dhis2-core/pull/6045#discussion_r482728923", "createdAt": "2020-09-03T06:19:06Z", "author": {"login": "netroms"}, "path": "dhis-2/dhis-services/dhis-service-node/src/main/java/org/hisp/dhis/fieldfilter/DefaultFieldFilterService.java", "diffHunk": "@@ -429,11 +424,22 @@ else if ( property.isIdentifiableObject() && isProperIdObject( propertyClass ) )\n                     child = new CollectionNode( property.getCollectionName() );\n                     child.setNamespace( property.getNamespace() );\n \n-                    for ( Object collectionObject : (Collection<?>) returnValue )\n+                    for ( Object collectionObject : (Collection<?>) Objects.requireNonNull( returnValue ) )\n                     {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNTIyNDc2", "url": "https://github.com/dhis2/dhis2-core/pull/6045#pullrequestreview-481522476", "createdAt": "2020-09-03T06:19:21Z", "commit": {"oid": "e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwNjoxOToyMVrOHMXcOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwNjoxOToyMVrOHMXcOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyOTAxNg==", "bodyText": "Same as comment above", "url": "https://github.com/dhis2/dhis2-core/pull/6045#discussion_r482729016", "createdAt": "2020-09-03T06:19:21Z", "author": {"login": "netroms"}, "path": "dhis-2/dhis-services/dhis-service-node/src/main/java/org/hisp/dhis/fieldfilter/DefaultFieldFilterService.java", "diffHunk": "@@ -429,11 +424,22 @@ else if ( property.isIdentifiableObject() && isProperIdObject( propertyClass ) )\n                     child = new CollectionNode( property.getCollectionName() );\n                     child.setNamespace( property.getNamespace() );\n \n-                    for ( Object collectionObject : (Collection<?>) returnValue )\n+                    for ( Object collectionObject : (Collection<?>) Objects.requireNonNull( returnValue ) )\n                     {\n-                        Node node = buildNode( fieldValue, property.getItemKlass(), collectionObject, user, property.getName(), defaults );\n+                        Node node;\n+\n+                        if ( property.hasPropertyTransformer() )\n+                        {\n+                            // if it has a transformer, re-get the schema (the item klass has probably changed)\n+                            Schema sch = schemaService.getDynamicSchema( collectionObject.getClass() );\n+                            node = buildNode( fieldValue, sch.getKlass(), collectionObject, user, property.getName(), defaults );\n+                        }\n+                        else\n+                        {\n+                            node = buildNode( fieldValue, property.getItemKlass(), collectionObject, user, property.getName(), defaults );\n+                        }\n \n-                        if ( !node.getChildren().isEmpty() )\n+                        if ( !Objects.requireNonNull( node ).getChildren().isEmpty() )\n                         {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87"}, "originalPosition": 107}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNTIyNTU1", "url": "https://github.com/dhis2/dhis2-core/pull/6045#pullrequestreview-481522555", "createdAt": "2020-09-03T06:19:32Z", "commit": {"oid": "e8af4efdc08020a0bbfbe3d2a4c5650e8e7d2a87"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2473, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}