{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzODgyNTc5", "number": 5813, "title": "feat: Introduce user lookup API [DHIS2-8749]", "bodyText": "Introduces a user lookup API. This is intended as a minimal API for user information, which can be used by clients which needs access to basic user information, without exposing sensitive or extensive user information.\nThe endpoint is located at /api/userLookup. The first method located at /api/userLookup/{id} allows for lookup by either UID, UUID or username and will return exactly one or zero users.\nThe second method located at /api/userLookup?query={query} allows for querying users by firstname, surname, username and email, and will return many or zero users.\nIntroduces centralized method for username validation. This needs more work and probably stricter requirements. A first step is to introduce a single place for it to keep it consistent across the system.", "createdAt": "2020-07-03T06:43:55Z", "url": "https://github.com/dhis2/dhis2-core/pull/5813", "merged": true, "mergeCommit": {"oid": "4a0141b03ebca082efd61d2e1352b948126e8b61"}, "closed": true, "closedAt": "2020-07-14T09:31:27Z", "author": {"login": "larshelge"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxBSEqgH2gAyNDQzODgyNTc5OjliZTI3MDFhODVjM2UzNWYyYWQ0ODgzOGZkNjkzNjlkZjE1Zjk5NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0xm9ngFqTQ0Nzg4OTUzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9be2701a85c3e35f2ad48838fd69369df15f9941", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/9be2701a85c3e35f2ad48838fd69369df15f9941", "committedDate": "2020-07-02T16:18:01Z", "message": "Add getByUuid method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1edcaf3f579bf480a6bce1dab4b66930a0aeb5c3", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1edcaf3f579bf480a6bce1dab4b66930a0aeb5c3", "committedDate": "2020-07-02T16:41:30Z", "message": "Add DTO and util method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e690864a5a6a1a14eff7e8e51fe265b3849c6f10", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/e690864a5a6a1a14eff7e8e51fe265b3849c6f10", "committedDate": "2020-07-02T16:41:52Z", "message": "Merge branch 'master' into DHIS2-8749"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9865a92fb1b27e7573c0391bb5066a31735ce26", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b9865a92fb1b27e7573c0391bb5066a31735ce26", "committedDate": "2020-07-03T06:41:54Z", "message": "Add username validation method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d96be00d84f61085c548d4568260166952bae63", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3d96be00d84f61085c548d4568260166952bae63", "committedDate": "2020-07-03T06:50:00Z", "message": "Username validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "817a291448af3f15392a52a40678eec285647d15", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/817a291448af3f15392a52a40678eec285647d15", "committedDate": "2020-07-03T06:50:09Z", "message": "Merge branch 'DHIS2-8749' of github.com:dhis2/dhis2-core into DHIS2-8749"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdf82fd813bb66cf1cfeb65d5bf8011f525331d9", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/bdf82fd813bb66cf1cfeb65d5bf8011f525331d9", "committedDate": "2020-07-03T06:56:19Z", "message": "User lookup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d29629c69e53b4fb79728283ebf3f2279298111c", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d29629c69e53b4fb79728283ebf3f2279298111c", "committedDate": "2020-07-03T07:10:57Z", "message": "Query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c989d6d204717a2c1b8102dbab823cb3df24ffa", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/7c989d6d204717a2c1b8102dbab823cb3df24ffa", "committedDate": "2020-07-03T07:12:06Z", "message": "Add license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b8f2398a146ca278fc2c9ffd3b171759ac6cb01", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/0b8f2398a146ca278fc2c9ffd3b171759ac6cb01", "committedDate": "2020-07-03T07:14:40Z", "message": "Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42e4f29b53cca99a3f80d4242275ef9dda453050", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/42e4f29b53cca99a3f80d4242275ef9dda453050", "committedDate": "2020-07-03T07:17:14Z", "message": "Comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9346f163b545b70aae54d9791988b8e8b7ce777d", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/9346f163b545b70aae54d9791988b8e8b7ce777d", "committedDate": "2020-07-03T07:25:40Z", "message": "Add controller annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85c988703c15e785fdecd3f1959802e08c840d1c", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/85c988703c15e785fdecd3f1959802e08c840d1c", "committedDate": "2020-07-03T07:26:35Z", "message": "Add controller annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b92813bea805505a9f587de62a99f98e926a0ee9", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b92813bea805505a9f587de62a99f98e926a0ee9", "committedDate": "2020-07-03T07:42:18Z", "message": "Minor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MTY3MzQ5", "url": "https://github.com/dhis2/dhis2-core/pull/5813#pullrequestreview-447167349", "createdAt": "2020-07-13T11:31:35Z", "commit": {"oid": "b92813bea805505a9f587de62a99f98e926a0ee9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MTY4NTUw", "url": "https://github.com/dhis2/dhis2-core/pull/5813#pullrequestreview-447168550", "createdAt": "2020-07-13T11:33:31Z", "commit": {"oid": "b92813bea805505a9f587de62a99f98e926a0ee9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMTozMzozMVrOGwkrKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMTozMzozMVrOGwkrKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NTcwNw==", "bodyText": "Add missing test?", "url": "https://github.com/dhis2/dhis2-core/pull/5813#discussion_r453585707", "createdAt": "2020-07-13T11:33:31Z", "author": {"login": "netroms"}, "path": "dhis-2/dhis-services/dhis-service-core/src/test/java/org/hisp/dhis/user/UserServiceTest.java", "diffHunk": "@@ -377,6 +377,28 @@ public void testGetByPhoneNumber()\n         assertEquals( userB, users.get( 0 ) );\n     }\n \n+    @Test\n+    public void testGetByIdentifier()\n+    {\n+        User userA = createUser( 'A' );\n+        User userB = createUser( 'B' );\n+        User userC = createUser( 'C' );\n+\n+        UserCredentials credentialsA = createUserCredentials( 'A', userA );\n+        UserCredentials credentialsB = createUserCredentials( 'B', userB );\n+        UserCredentials credentialsC = createUserCredentials( 'C', userC );\n+\n+        userService.addUser( userA );\n+        userService.addUser( userB );\n+        userService.addUser( userC );\n+\n+        userService.addUserCredentials( credentialsA );\n+        userService.addUserCredentials( credentialsB );\n+        userService.addUserCredentials( credentialsC );\n+\n+        //TODO Add tests", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b92813bea805505a9f587de62a99f98e926a0ee9"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64a77081739aeb1634fcde6a063996998b5ca615", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/64a77081739aeb1634fcde6a063996998b5ca615", "committedDate": "2020-07-14T05:53:44Z", "message": "Add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48021bd39662c84df22b5c11b63f75e298a8af50", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/48021bd39662c84df22b5c11b63f75e298a8af50", "committedDate": "2020-07-14T06:34:03Z", "message": "Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0c086fb5ea73d9807dea985a15d4dc791a6a1b8", "author": {"user": {"login": "larshelge", "name": "Lars Helge \u00d8verland"}}, "url": "https://github.com/dhis2/dhis2-core/commit/c0c086fb5ea73d9807dea985a15d4dc791a6a1b8", "committedDate": "2020-07-14T07:17:46Z", "message": "Add test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODgxMzAy", "url": "https://github.com/dhis2/dhis2-core/pull/5813#pullrequestreview-447881302", "createdAt": "2020-07-14T08:06:36Z", "commit": {"oid": "c0c086fb5ea73d9807dea985a15d4dc791a6a1b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODowNjozNlrOGxI4Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODowNjozNlrOGxI4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE3ODg2Ng==", "bodyText": "The username string would go directly into the query from UserCredentials uc where uc.username = :username. Have we already had sql escape somewhere in the api ?\ne.g. what if username string =  (select username from users order by lastlogin desc limit 1)", "url": "https://github.com/dhis2/dhis2-core/pull/5813#discussion_r454178866", "createdAt": "2020-07-14T08:06:36Z", "author": {"login": "vietnguyen"}, "path": "dhis-2/dhis-support/dhis-support-system/src/main/java/org/hisp/dhis/system/util/ValidationUtils.java", "diffHunk": "@@ -177,6 +179,36 @@ public static boolean urlIsValid( String url )\n         return new UrlValidator().isValid( url );\n     }\n \n+    /**\n+     * Validates whether a UUID is valid.\n+     *\n+     * @param uuid the UUID as string.\n+     * @return true if the UUID is valid, false otherwise.\n+     */\n+    public static boolean uuidIsValid( String uuid )\n+    {\n+        try\n+        {\n+            UUID.fromString( uuid );\n+            return true;\n+        }\n+        catch ( IllegalArgumentException ex )\n+        {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Validates whether a username is valid.\n+     *\n+     * @param username the username.\n+     * @return true if the username is valid, false otherwise.\n+     */\n+    public static boolean usernameIsValid( String username )\n+    {\n+        return username != null && username.length() <= UserCredentials.USERNAME_MAX_LENGTH;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0c086fb5ea73d9807dea985a15d4dc791a6a1b8"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODg5NTM4", "url": "https://github.com/dhis2/dhis2-core/pull/5813#pullrequestreview-447889538", "createdAt": "2020-07-14T08:18:03Z", "commit": {"oid": "c0c086fb5ea73d9807dea985a15d4dc791a6a1b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2620, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}