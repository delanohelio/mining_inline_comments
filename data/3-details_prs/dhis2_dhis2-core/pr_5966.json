{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMzIwMjY4", "number": 5966, "title": "fix: [WIP] Add uid column in IncomingSms and OutboundSms", "bodyText": "", "createdAt": "2020-08-19T17:48:30Z", "url": "https://github.com/dhis2/dhis2-core/pull/5966", "merged": true, "mergeCommit": {"oid": "5ae0346cc9f15743aa5f7d4af182306a6905d3bc"}, "closed": true, "closedAt": "2020-08-25T06:04:33Z", "author": {"login": "zubaira"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_3z1_gH2gAyNDcwMzIwMjY4OjFiNTczY2QzMTYyMDk3Zjk0MzI5NDY0NjdiOWMzMzAzMzkyMzRlMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCQ3h0gFqTQ3NDE1ODU5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1b573cd3162097f9432946467b9c330339234e07", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1b573cd3162097f9432946467b9c330339234e07", "committedDate": "2020-08-17T19:44:43Z", "message": "fix: Add API endpoints for listing sms and deletion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c52e00e770e31e784c447885df4547347760e501", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/c52e00e770e31e784c447885df4547347760e501", "committedDate": "2020-08-17T19:52:15Z", "message": "renaming methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3ce0d6723a45a19f3bf1a91f2267db96dbfe4d7", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b3ce0d6723a45a19f3bf1a91f2267db96dbfe4d7", "committedDate": "2020-08-17T20:04:48Z", "message": "minor code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4e3f55e82f3c9192cd88915442b2a1d22c38ffc", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/f4e3f55e82f3c9192cd88915442b2a1d22c38ffc", "committedDate": "2020-08-17T20:34:12Z", "message": "bulk message deletion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e4a2100dfdca31330d8dcacc3125213f1ee9619", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/6e4a2100dfdca31330d8dcacc3125213f1ee9619", "committedDate": "2020-08-17T21:08:40Z", "message": "add json annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d12005e10e5cde166dc0ec57f7439be2a576a76f", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d12005e10e5cde166dc0ec57f7439be2a576a76f", "committedDate": "2020-08-18T07:30:17Z", "message": "rename incoming sms service method parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc547e70aa7aafc5a7588c4c1bc1b352ff66c2d0", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/bc547e70aa7aafc5a7588c4c1bc1b352ff66c2d0", "committedDate": "2020-08-18T07:48:50Z", "message": "add empty check for originator string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9bb486d5fa7ac70823eae18b9a004229e00916d", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b9bb486d5fa7ac70823eae18b9a004229e00916d", "committedDate": "2020-08-18T07:52:44Z", "message": "removed unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a258015cf575ccbcf4d4e86781590756f0a8da47", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a258015cf575ccbcf4d4e86781590756f0a8da47", "committedDate": "2020-08-18T12:40:42Z", "message": "Add content type to response"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88396189db2f193dc0781b384bfef689e2ccea7e", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/88396189db2f193dc0781b384bfef689e2ccea7e", "committedDate": "2020-08-18T13:08:21Z", "message": "fix conflict and merge with master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cad5af146e31e3c3dab16834c6a74e6790fa6096", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/cad5af146e31e3c3dab16834c6a74e6790fa6096", "committedDate": "2020-08-19T17:05:31Z", "message": "Merge branch 'master' into sms-api-endpoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21465a3bdb7c3a1f3ab9c1eb7ed7fb21bf210b16", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/21465a3bdb7c3a1f3ab9c1eb7ed7fb21bf210b16", "committedDate": "2020-08-19T17:47:25Z", "message": "fix: Add uid column in IncomingSms and OutboundSms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4712359f88d0dd3b893698cde04be7555229dba", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/e4712359f88d0dd3b893698cde04be7555229dba", "committedDate": "2020-08-19T20:52:18Z", "message": "fix unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5cc01ec8ac377901d83b091d72e3e6ea60b6537", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a5cc01ec8ac377901d83b091d72e3e6ea60b6537", "committedDate": "2020-08-19T21:15:24Z", "message": "fix unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72b10e3e779f9719ac1bdde3776eba6b555ec6d4", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/72b10e3e779f9719ac1bdde3776eba6b555ec6d4", "committedDate": "2020-08-20T13:05:01Z", "message": "Add flyway script to add/update uid column"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41c94deb8f4af68ae2e66fe977bf1767f130b496", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/41c94deb8f4af68ae2e66fe977bf1767f130b496", "committedDate": "2020-08-20T16:23:58Z", "message": "Add pagination support to SmsController"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8c402c91888c321c856e169fde37186d7b54625", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d8c402c91888c321c856e169fde37186d7b54625", "committedDate": "2020-08-20T17:20:19Z", "message": "fixes after testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc85fa3c536f3456a25625c6143953a590240f4e", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/bc85fa3c536f3456a25625c6143953a590240f4e", "committedDate": "2020-08-20T17:23:49Z", "message": "fix sonar code smells"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTEzOTg3", "url": "https://github.com/dhis2/dhis2-core/pull/5966#pullrequestreview-471913987", "createdAt": "2020-08-20T19:23:22Z", "commit": {"oid": "bc85fa3c536f3456a25625c6143953a590240f4e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxOToyMzoyMlrOHEP5jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxOToyMzoyMlrOHEP5jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIxNjg0Nw==", "bodyText": "I guess there can be a lot of SMS in a database, and this might be slow or lead to out of mem. We have a PSQL function for generating UIDs now I believe @stian-sandvold ? I would suggest we use that PSQL function instead to make this much faster and less prone to mem issues.", "url": "https://github.com/dhis2/dhis2-core/pull/5966#discussion_r474216847", "createdAt": "2020-08-20T19:23:22Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v35/V2_35_21__Generate_uid_for_sms.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.hisp.dhis.db.migration.v35;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+import org.hisp.dhis.common.CodeGenerator;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.Statement;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class V2_35_21__Generate_uid_for_sms extends BaseJavaMigration\n+{\n+    private static final Logger log = LoggerFactory.getLogger( V2_35_21__Generate_uid_for_sms.class );\n+\n+    @Override\n+    public void migrate( Context context ) throws Exception\n+    {\n+        List<Long> incomingSmsIds = new ArrayList<>();\n+        List<Long> outboundSmsIds = new ArrayList<>();\n+\n+        try ( Statement statement = context.getConnection().createStatement(); ResultSet resultSetIncomingSms = statement.executeQuery( \"select id from incomingsms\" ) )\n+        {\n+            while ( resultSetIncomingSms.next() )\n+            {\n+                incomingSmsIds.add( resultSetIncomingSms.getLong(\"id\") );\n+            }\n+        }\n+\n+        try ( Statement statement = context.getConnection().createStatement(); ResultSet resultSetOutboundSms = statement.executeQuery( \"select id from outbound_sms\" ) )\n+        {\n+            while ( resultSetOutboundSms.next() )\n+            {\n+                outboundSmsIds.add( resultSetOutboundSms.getLong( \"id\" ) );\n+            }\n+        }\n+\n+        if ( !incomingSmsIds.isEmpty() )\n+        {\n+            for ( long id : incomingSmsIds )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc85fa3c536f3456a25625c6143953a590240f4e"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72f2942805fbd9460b228df3349931ca3ada20a4", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/72f2942805fbd9460b228df3349931ca3ada20a4", "committedDate": "2020-08-21T12:08:32Z", "message": "update uid for sms tables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e83a5409607338ad3d6efd4a8ec60d8bc406cfb7", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/e83a5409607338ad3d6efd4a8ec60d8bc406cfb7", "committedDate": "2020-08-23T10:54:13Z", "message": "Merge branch 'master' into sms-api-endpoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44a8aa7e073eb62f3849874c3de86662e82b6d9f", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/44a8aa7e073eb62f3849874c3de86662e82b6d9f", "committedDate": "2020-08-23T11:40:53Z", "message": "remove obsolete sms endpoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20c75b0d140457d28239c9457f1406a0b704b9c3", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/20c75b0d140457d28239c9457f1406a0b704b9c3", "committedDate": "2020-08-23T12:29:19Z", "message": "remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19427864438874eda1615e08b1aa91d8128013f4", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/19427864438874eda1615e08b1aa91d8128013f4", "committedDate": "2020-08-24T07:38:28Z", "message": "Revert \"remove unused imports\"\n\nThis reverts commit 20c75b0d140457d28239c9457f1406a0b704b9c3."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8ef335f37437703bc66485a9caad3b3d1538a77", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/c8ef335f37437703bc66485a9caad3b3d1538a77", "committedDate": "2020-08-24T07:38:45Z", "message": "Revert \"remove obsolete sms endpoints\"\n\nThis reverts commit 44a8aa7e073eb62f3849874c3de86662e82b6d9f."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4239ca2339e8e6acb46e5674d6b8eb3faabbb8bf", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/4239ca2339e8e6acb46e5674d6b8eb3faabbb8bf", "committedDate": "2020-08-24T07:46:56Z", "message": "remove unused endpoints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzY5NTQ4", "url": "https://github.com/dhis2/dhis2-core/pull/5966#pullrequestreview-473369548", "createdAt": "2020-08-24T11:14:55Z", "commit": {"oid": "4239ca2339e8e6acb46e5674d6b8eb3faabbb8bf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMToxNDo1NVrOHFf3QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMToxNToyMlrOHFf4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNjk3Nw==", "bodyText": "where uid is null*", "url": "https://github.com/dhis2/dhis2-core/pull/5966#discussion_r475526977", "createdAt": "2020-08-24T11:14:55Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/resources/org/hisp/dhis/db/migration/2.35/V2_35_20__Add_uid_column_in_sms_table.sql", "diffHunk": "@@ -0,0 +1,12 @@\n+\n+-- add column uid to incomingsms and outboundsms table\n+alter table incomingsms add column if not exists \"uid\" varchar(255);\n+alter table outbound_sms add column if not exists \"uid\" varchar(255);\n+\n+-- change id column type from integer to long\n+alter table incomingsms alter column id type bigint;\n+alter table outbound_sms alter column id type bigint;\n+\n+-- update uid column with randomly generated uid values\n+update incomingsms set uid = generate_uid();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4239ca2339e8e6acb46e5674d6b8eb3faabbb8bf"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNzIxNg==", "bodyText": "this way it can be run again without invalidating uids.", "url": "https://github.com/dhis2/dhis2-core/pull/5966#discussion_r475527216", "createdAt": "2020-08-24T11:15:22Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/resources/org/hisp/dhis/db/migration/2.35/V2_35_20__Add_uid_column_in_sms_table.sql", "diffHunk": "@@ -0,0 +1,12 @@\n+\n+-- add column uid to incomingsms and outboundsms table\n+alter table incomingsms add column if not exists \"uid\" varchar(255);\n+alter table outbound_sms add column if not exists \"uid\" varchar(255);\n+\n+-- change id column type from integer to long\n+alter table incomingsms alter column id type bigint;\n+alter table outbound_sms alter column id type bigint;\n+\n+-- update uid column with randomly generated uid values\n+update incomingsms set uid = generate_uid();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNjk3Nw=="}, "originalCommit": {"oid": "4239ca2339e8e6acb46e5674d6b8eb3faabbb8bf"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93afcf669246c683c3a76f2a8faa46a9e5247d12", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/93afcf669246c683c3a76f2a8faa46a9e5247d12", "committedDate": "2020-08-24T11:45:00Z", "message": "add null check for uid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2ad5c9bd3ba985b50855d855c3cf0db1e58f7fb", "author": {"user": {"login": "zubaira", "name": "Zubair Asghar"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a2ad5c9bd3ba985b50855d855c3cf0db1e58f7fb", "committedDate": "2020-08-24T14:22:54Z", "message": "separate inbound and outbound controllers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MTU4NTkx", "url": "https://github.com/dhis2/dhis2-core/pull/5966#pullrequestreview-474158591", "createdAt": "2020-08-25T06:04:13Z", "commit": {"oid": "a2ad5c9bd3ba985b50855d855c3cf0db1e58f7fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2535, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}