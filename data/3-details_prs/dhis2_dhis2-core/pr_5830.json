{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1NDY4OTY1", "number": 5830, "title": "fix: Remove the possibility of race conditions while reserving sequential-based generated ids", "bodyText": "This PR introduces a new postgres procedure that removes the issue of race conditions related to generating new id's based on the sequential pattern.", "createdAt": "2020-07-07T14:56:12Z", "url": "https://github.com/dhis2/dhis2-core/pull/5830", "merged": true, "mergeCommit": {"oid": "5eab23059684caf6a91a2f5a1bbe55743a677638"}, "closed": true, "closedAt": "2020-08-06T14:33:24Z", "author": {"login": "stian-sandvold"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcynFYKAH2gAyNDQ1NDY4OTY1OmEwM2U4YjQ4NGRlM2ZiYmZiMjM3ODEzZmFjMDUzMzk5MzBlNzBkMWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8QAhDgFqTQ2MjUyODY4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a03e8b484de3fbbfb237813fac05339930e70d1f", "author": {"user": null}, "url": "https://github.com/dhis2/dhis2-core/commit/a03e8b484de3fbbfb237813fac05339930e70d1f", "committedDate": "2020-07-07T14:54:28Z", "message": "Added new procedure for removing race conditions, and updated store to reflect the changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b33db53fbd8ca97b1c91b7197497ed2b4c708d44", "author": {"user": {"login": "stian-sandvold", "name": "Stian Sandvold"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b33db53fbd8ca97b1c91b7197497ed2b4c708d44", "committedDate": "2020-07-23T15:47:06Z", "message": "fix: Update test to integration tests; Update flyway script to account for no row"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dc26ebff2ec5cd3aee2f8df8fbd7c6838f122b3", "author": {"user": {"login": "stian-sandvold", "name": "Stian Sandvold"}}, "url": "https://github.com/dhis2/dhis2-core/commit/2dc26ebff2ec5cd3aee2f8df8fbd7c6838f122b3", "committedDate": "2020-07-23T16:11:32Z", "message": "fix: Change test to integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cbaa97eb9ef096f8d0a6a6ce9bbd186e7931776", "author": {"user": {"login": "stian-sandvold", "name": "Stian Sandvold"}}, "url": "https://github.com/dhis2/dhis2-core/commit/2cbaa97eb9ef096f8d0a6a6ce9bbd186e7931776", "committedDate": "2020-07-23T16:56:50Z", "message": "fix: Add transactional annotation to method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzU1NDAw", "url": "https://github.com/dhis2/dhis2-core/pull/5830#pullrequestreview-454355400", "createdAt": "2020-07-23T17:38:09Z", "commit": {"oid": "2cbaa97eb9ef096f8d0a6a6ce9bbd186e7931776"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDA5NTI5", "url": "https://github.com/dhis2/dhis2-core/pull/5830#pullrequestreview-454409529", "createdAt": "2020-07-23T18:53:51Z", "commit": {"oid": "2cbaa97eb9ef096f8d0a6a6ce9bbd186e7931776"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODo1Mzo1MlrOG2XbiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODo1Mzo1MlrOG2XbiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MDE2OQ==", "bodyText": "I'm a bit worried that this TABLE LOCK - ROW EXCLUSIVE is going to generate a lot of deadlocks under moderate concurrency. I think we should at least test it with a stress test, simulating 50/100 concurrent users.", "url": "https://github.com/dhis2/dhis2-core/pull/5830#discussion_r459660169", "createdAt": "2020-07-23T18:53:52Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/resources/org/hisp/dhis/db/migration/2.35/V2_35_11__Add_sequentialcounter_procedure.sql", "diffHunk": "@@ -0,0 +1,27 @@\n+CREATE OR REPLACE FUNCTION incrementSequentialCounter(counter_owner text, counter_key text, i integer) RETURNS integer AS $$\n+\tDECLARE\n+\t\t-- Get the initial count, or 0 if it doesnt exist\n+\t\tcurrent_counter integer;\n+\tBEGIN\n+\t\t-- Lock the row, so noone else gets an old count.\n+\t\tLOCK TABLE sequentialnumbercounter IN ROW EXCLUSIVE MODE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cbaa97eb9ef096f8d0a6a6ce9bbd186e7931776"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70b7a8dae2080e3eb8c7ec550799f4c74d60cd6d", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/70b7a8dae2080e3eb8c7ec550799f4c74d60cd6d", "committedDate": "2020-07-23T21:46:42Z", "message": "add multithreaded test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a919cf52bfd2c2bcacc6d86b54b3053bfe75b69", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/0a919cf52bfd2c2bcacc6d86b54b3053bfe75b69", "committedDate": "2020-07-24T07:14:54Z", "message": "use different uid for each task during concurrent test for reserved values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dea251ed257dab522e9fb8ce5373b15bdce2c6f2", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/dea251ed257dab522e9fb8ce5373b15bdce2c6f2", "committedDate": "2020-07-24T07:22:07Z", "message": "fix assertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b8d48418b0377cfa1d5435121d2c5625d4c4f0e", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3b8d48418b0377cfa1d5435121d2c5625d4c4f0e", "committedDate": "2020-07-24T07:34:32Z", "message": "reverted test to use one key/owner across all threads"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "142418385f32d131a1b217bf76c9beeaaf0b7ba6", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/142418385f32d131a1b217bf76c9beeaaf0b7ba6", "committedDate": "2020-07-24T14:08:35Z", "message": "modified SP to execute an upsert while locking on the reserved value row"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwODI4NzM1", "url": "https://github.com/dhis2/dhis2-core/pull/5830#pullrequestreview-460828735", "createdAt": "2020-08-04T13:48:37Z", "commit": {"oid": "142418385f32d131a1b217bf76c9beeaaf0b7ba6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMzo0ODozOFrOG7hMew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMzo0ODozOFrOG7hMew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA2MzAzNQ==", "bodyText": "@luciano-fiandesio / @stian-sandvold , please synchronize this Flyway migration version with the others PR's:\n#5876\n#5885", "url": "https://github.com/dhis2/dhis2-core/pull/5830#discussion_r465063035", "createdAt": "2020-08-04T13:48:38Z", "author": {"login": "maikelarabori"}, "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/resources/org/hisp/dhis/db/migration/2.35/V2_35_11__Add_sequentialcounter_procedure.sql", "diffHunk": "@@ -0,0 +1,24 @@\n+-- remove primary key on id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142418385f32d131a1b217bf76c9beeaaf0b7ba6"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6d7cc592b97f9c6fea7adab372476da31c34bf8", "author": {"user": {"login": "stian-sandvold", "name": "Stian Sandvold"}}, "url": "https://github.com/dhis2/dhis2-core/commit/c6d7cc592b97f9c6fea7adab372476da31c34bf8", "committedDate": "2020-08-06T09:56:11Z", "message": "Ignore test. Works, but unexplainably is using H2 during github check test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4151dd6d80ef2905570efde55706f3c2363f5009", "author": {"user": {"login": "stian-sandvold", "name": "Stian Sandvold"}}, "url": "https://github.com/dhis2/dhis2-core/commit/4151dd6d80ef2905570efde55706f3c2363f5009", "committedDate": "2020-08-06T10:01:02Z", "message": " Merge with master. Readjusted flyway script version number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2b1732f3cde0f16b332cfd50a3b7f16e6164408", "author": {"user": {"login": "stian-sandvold", "name": "Stian Sandvold"}}, "url": "https://github.com/dhis2/dhis2-core/commit/f2b1732f3cde0f16b332cfd50a3b7f16e6164408", "committedDate": "2020-08-06T10:01:54Z", "message": "Merge branch 'DHIS2-9146' of github.com:dhis2/dhis2-core into DHIS2-9146"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a5f52c5ce85e9392c9334e5f209065a1e63c910", "author": {"user": {"login": "stian-sandvold", "name": "Stian Sandvold"}}, "url": "https://github.com/dhis2/dhis2-core/commit/0a5f52c5ce85e9392c9334e5f209065a1e63c910", "committedDate": "2020-08-06T11:36:09Z", "message": "fix: Reload periodTypes before test to get right id"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNTI4Njg2", "url": "https://github.com/dhis2/dhis2-core/pull/5830#pullrequestreview-462528686", "createdAt": "2020-08-06T13:40:35Z", "commit": {"oid": "0a5f52c5ce85e9392c9334e5f209065a1e63c910"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2555, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}