{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2Njg1OTM3", "number": 6587, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODozMjoxNVrOE2p4Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyOTozMFrOE2uKgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzQ0NzA2OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/JdbcEventStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODozMjoxNVrOHvjuZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNTo1NjoxOVrOHv1cfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzMDQzNg==", "bodyText": "minor: since this query looks like is only for events, I would rename to PSI_EVENT_QUERY or something like this", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519630436", "createdAt": "2020-11-09T08:32:15Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/JdbcEventStore.java", "diffHunk": "@@ -147,6 +145,27 @@\n @Repository( \"org.hisp.dhis.dxf2.events.event.EventStore\" )\n public class JdbcEventStore implements EventStore\n {\n+\n+    private static final String COMMENT_QUERY =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkyMDc2Ng==", "bodyText": "this one is the sub-query for comments, so I'll rename to PSI_EVENT_COMMENT_QUERY", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519920766", "createdAt": "2020-11-09T15:56:19Z", "author": {"login": "gnespolino"}, "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/JdbcEventStore.java", "diffHunk": "@@ -147,6 +145,27 @@\n @Repository( \"org.hisp.dhis.dxf2.events.event.EventStore\" )\n public class JdbcEventStore implements EventStore\n {\n+\n+    private static final String COMMENT_QUERY =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzMDQzNg=="}, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzQ1MjQ0OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/program/UserInfoSnapshot.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0NDo1M1rOHvkK1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0NDo1M1rOHvkK1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNzcxNw==", "bodyText": "Let's add some Javadoc so it's clear what's the intent of this class.", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519637717", "createdAt": "2020-11-09T08:44:53Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/program/UserInfoSnapshot.java", "diffHunk": "@@ -41,7 +43,7 @@\n \n @NoArgsConstructor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzQ3MzkyOnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/JdbcEventStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODozOTozNVrOHvj-MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNTo1MjowNVrOHv1N7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNDQ4MQ==", "bodyText": "Please, remove the additional spaces", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519634481", "createdAt": "2020-11-09T08:39:35Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/JdbcEventStore.java", "diffHunk": "@@ -147,6 +145,27 @@\n @Repository( \"org.hisp.dhis.dxf2.events.event.EventStore\" )\n public class JdbcEventStore implements EventStore\n {\n+\n+    private static final String COMMENT_QUERY =\n+        \"select psic.programstageinstanceid    as psic_id,\" +\n+        \"                           psinote.trackedentitycommentid as psinote_id,\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkxNzAzOQ==", "bodyText": "it was to make it more readable, however I'll remove it", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519917039", "createdAt": "2020-11-09T15:52:05Z", "author": {"login": "gnespolino"}, "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/JdbcEventStore.java", "diffHunk": "@@ -147,6 +145,27 @@\n @Repository( \"org.hisp.dhis.dxf2.events.event.EventStore\" )\n public class JdbcEventStore implements EventStore\n {\n+\n+    private static final String COMMENT_QUERY =\n+        \"select psic.programstageinstanceid    as psic_id,\" +\n+        \"                           psinote.trackedentitycommentid as psinote_id,\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNDQ4MQ=="}, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NzQ3OTE4OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/converter/NotesConverterService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0MDo1NVrOHvkBVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNTo1Mzo0NVrOHv1TGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNTI4NQ==", "bodyText": "This is more like a general issue for all these lastUpdated, created etc. fields: shall we instead use default values at the DB level? What do you think?", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519635285", "createdAt": "2020-11-09T08:40:55Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/converter/NotesConverterService.java", "diffHunk": "@@ -68,8 +69,9 @@ public TrackedEntityComment from( TrackerPreheat preheat, Note note )\n         comment.setAutoFields();\n         comment.setCommentText( note.getValue() );\n \n-        // FIXME: what about the storedBy and lastUpdatedBy -> currently they are set to\n-        // null\n+        comment.setLastUpdatedBy( preheat.getUser() );\n+        comment.setLastUpdated( new Date() );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkxODM2Mg==", "bodyText": "yes probably it would be much better to have them out of the box, either by default value in DB or default values during instance creation.", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519918362", "createdAt": "2020-11-09T15:53:45Z", "author": {"login": "gnespolino"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/converter/NotesConverterService.java", "diffHunk": "@@ -68,8 +69,9 @@ public TrackedEntityComment from( TrackerPreheat preheat, Note note )\n         comment.setAutoFields();\n         comment.setCommentText( note.getValue() );\n \n-        // FIXME: what about the storedBy and lastUpdatedBy -> currently they are set to\n-        // null\n+        comment.setLastUpdatedBy( preheat.getUser() );\n+        comment.setLastUpdated( new Date() );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNTI4NQ=="}, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1ODE0MTA1OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/program/UserInfoSnapshot.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyNzoxMVrOHvqRyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyNzoxMVrOHvqRyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczNzgwMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static UserInfoSnapshot of(long id, String code, String uid, String username, String firstName, String surname )\n          \n          \n            \n                public static UserInfoSnapshot of( long id, String code, String uid, String username, String firstName, String surname )", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519737802", "createdAt": "2020-11-09T11:27:11Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/program/UserInfoSnapshot.java", "diffHunk": "@@ -93,13 +95,29 @@ public void setSurname( String surname )\n         this.surname = surname;\n     }\n \n-    public static ProgramStageInstanceUserInfo from( User user )\n+    public static UserInfoSnapshot from(User user )\n+    {\n+        return Optional.ofNullable(user)\n+                .map(UserInfoSnapshot::toUserInfoSnapshot)\n+                .orElse(null);\n+    }\n+\n+    private static UserInfoSnapshot toUserInfoSnapshot( User user )\n     {\n-        ProgramStageInstanceUserInfo eventUserInfo = new ProgramStageInstanceUserInfo( user.getUsername(),\n+        UserInfoSnapshot eventUserInfo = new UserInfoSnapshot( user.getUsername(),\n             user.getFirstName(), user.getSurname() );\n         eventUserInfo.setId( user.getId() );\n         eventUserInfo.setCode( user.getCode() );\n         eventUserInfo.setUid( user.getUid() );\n         return eventUserInfo;\n     }\n+\n+    public static UserInfoSnapshot of(long id, String code, String uid, String username, String firstName, String surname )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1ODE0NDQ0OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/EventUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyODoxM1rOHvqUDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyODoxM1rOHvqUDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczODM4Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static PGobject userInfoToJson(UserInfoSnapshot userInfo, ObjectMapper mapper )\n          \n          \n            \n                public static PGobject userInfoToJson( UserInfoSnapshot userInfo, ObjectMapper mapper )", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519738382", "createdAt": "2020-11-09T11:28:13Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/EventUtils.java", "diffHunk": "@@ -191,27 +191,27 @@ else if ( attributeValues instanceof PGobject )\n     }\n \n     @SneakyThrows\n-    public static PGobject userInfoToJson( ProgramStageInstanceUserInfo userInfo, ObjectMapper mapper )\n+    public static PGobject userInfoToJson(UserInfoSnapshot userInfo, ObjectMapper mapper )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1ODE0NDk0OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/EventUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyODoyMVrOHvqUUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyODoyMVrOHvqUUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczODQ1MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static UserInfoSnapshot jsonToUserInfo(String userInfoAsString, ObjectMapper mapper )\n          \n          \n            \n                public static UserInfoSnapshot jsonToUserInfo( String userInfoAsString, ObjectMapper mapper )", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519738451", "createdAt": "2020-11-09T11:28:21Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/event/EventUtils.java", "diffHunk": "@@ -191,27 +191,27 @@ else if ( attributeValues instanceof PGobject )\n     }\n \n     @SneakyThrows\n-    public static PGobject userInfoToJson( ProgramStageInstanceUserInfo userInfo, ObjectMapper mapper )\n+    public static PGobject userInfoToJson(UserInfoSnapshot userInfo, ObjectMapper mapper )\n     {\n         PGobject jsonbObj = new PGobject();\n         jsonbObj.setType( \"json\" );\n         jsonbObj.setValue( mapper.writeValueAsString( userInfo ) );\n         return jsonbObj;\n     }\n \n-    public static ProgramStageInstanceUserInfo jsonToUserInfo( String userInfoAsString, ObjectMapper mapper )\n+    public static UserInfoSnapshot jsonToUserInfo(String userInfoAsString, ObjectMapper mapper )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1ODE0OTE1OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/importer/update/preprocess/UserInfoUpdatePreProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyOTozMFrOHvqW2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMToyOTozMFrOHvqW2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczOTA5OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected void updateDataValueUserInfo(EventDataValue dataValue, UserInfoSnapshot userInfo )\n          \n          \n            \n                protected void updateDataValueUserInfo( EventDataValue dataValue, UserInfoSnapshot userInfo )", "url": "https://github.com/dhis2/dhis2-core/pull/6587#discussion_r519739099", "createdAt": "2020-11-09T11:29:30Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/events/importer/update/preprocess/UserInfoUpdatePreProcessor.java", "diffHunk": "@@ -32,19 +32,19 @@\n import org.hisp.dhis.dxf2.events.event.Event;\n import org.hisp.dhis.dxf2.events.importer.shared.preprocess.AbstractUserInfoPreProcessor;\n import org.hisp.dhis.eventdatavalue.EventDataValue;\n-import org.hisp.dhis.program.ProgramStageInstanceUserInfo;\n+import org.hisp.dhis.program.UserInfoSnapshot;\n \n public class UserInfoUpdatePreProcessor extends AbstractUserInfoPreProcessor\n {\n \n     @Override\n-    protected void updateDataValueUserInfo(EventDataValue dataValue, ProgramStageInstanceUserInfo userInfo )\n+    protected void updateDataValueUserInfo(EventDataValue dataValue, UserInfoSnapshot userInfo )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4c422557ad39161f6a38baba964c11ac8dbd46"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3761, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}