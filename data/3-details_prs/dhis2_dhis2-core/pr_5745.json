{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NDQ3MDk4", "number": 5745, "title": "fix: Invalid weekly period year reference", "bodyText": "This fix corrects an error during the _periodstructure generation process. The process assigns the wrong year to a week Period.\nExample: 2019-12-31\nThe week of 2019-12-31, according to the ISO calendar system, belongs to 2020, since 4 or more days of that week fall in 2020.\nIn order to handle all Weekly Period types uniformly, 3 days are added to a Weekly Period type start date.\nExample:\n\n\n\nWeekly Type\nExample Date\nDate -> Start Date -> + 3\n\n\n\n\nStandard\n2019-12-31\n-> 2019-12-31 +3 = 2020-01-03 = 2020\n\n\nWeekly Saturday\n2019-12-31\n-> 2019-12-28 + 3 = 2019-12-31 = 2019\n\n\nWeekly Sunday\n2019-12-31\n-> 2019-12-29 + 3 = 2020-01-01 = 2020\n\n\nWeekly Thursday\n2019-12-31\n-> 2019-12-26 + 3 = 2019-12-29 = 2019\n\n\nWeekly Wed\n2019-12-31\n-> 2019-12-25 + 3 = 2019-12-28 = 2019\n\n\n\nref: DHIS2-5990", "createdAt": "2020-06-15T10:35:32Z", "url": "https://github.com/dhis2/dhis2-core/pull/5745", "merged": true, "mergeCommit": {"oid": "aa75a25b530d5013d0b309ac8f492828cad456e0"}, "closed": true, "closedAt": "2020-06-16T09:14:25Z", "author": {"login": "luciano-fiandesio"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcreKxygH2gAyNDM0NDQ3MDk4OjFjZjllYjhiNDE4NGNiNTU0MjVhZjExODM2NzQwODAzYzA1MmVkMGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrxazZgFqTQzMTMwMTA1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1cf9eb8b4184cb55425af11836740803c052ed0e", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1cf9eb8b4184cb55425af11836740803c052ed0e", "committedDate": "2020-06-15T10:33:45Z", "message": "fix: Invalid weekly period year reference\n\nThis fix corrects an error during the `_periodstructure` generation process. The process assigns the wrong year to a week Period.\n\nExample: `2019-12-31`\nThe week of `2019-12-31`, according to the ISO calendar system, belongs to 2020, since 4 or more days of that week fall in 2020.\n\nIn order to handle all Weekly Period types uniformly, 3 days are added to a Weekly Period type start date.\n\nExample:\n\n| Weekly Type     | Example Date | Date -> Start Date -> + 3             |\n|-----------------|--------------|---------------------------------------|\n| Standard        | 2019-12-31   | -> 2019-12-31 +3 = 2020-01-03 = 2020  |\n| Weekly Saturday | 2019-12-31   | -> 2019-12-28 + 3 = 2019-12-31 = 2019 |\n| Weekly Sunday   | 2019-12-31   | -> 2019-12-29 + 3 = 2020-01-01 = 2020 |\n| Weekly Thursday | 2019-12-31   | -> 2019-12-26 + 3 = 2019-12-29 = 2019 |\n| Weekly Wed      | 2019-12-31   | -> 2019-12-25 + 3 = 2019-12-28 = 2019 |\n\nref: DHIS2-5990"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c0ce36e09aa39e0d0da22e2ebfe962f85924319", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/6c0ce36e09aa39e0d0da22e2ebfe962f85924319", "committedDate": "2020-06-15T11:10:58Z", "message": "chore: address sonar issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNjMxNzY4", "url": "https://github.com/dhis2/dhis2-core/pull/5745#pullrequestreview-430631768", "createdAt": "2020-06-15T13:15:36Z", "commit": {"oid": "6c0ce36e09aa39e0d0da22e2ebfe962f85924319"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNzI5OTQ3", "url": "https://github.com/dhis2/dhis2-core/pull/5745#pullrequestreview-430729947", "createdAt": "2020-06-15T15:01:20Z", "commit": {"oid": "6c0ce36e09aa39e0d0da22e2ebfe962f85924319"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNTowMToyMVrOGj2Kbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNTowMToyMVrOGj2Kbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0MDc1MA==", "bodyText": "Looks great.\nMy only concern here is our famous Calendar system. I think we need to retrieve the current calendar and use that when determining the year? We can check with Morten H.", "url": "https://github.com/dhis2/dhis2-core/pull/5745#discussion_r440240750", "createdAt": "2020-06-15T15:01:21Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-administration/src/main/java/org/hisp/dhis/resourcetable/table/PeriodResourceTable.java", "diffHunk": "@@ -140,4 +142,20 @@ public String getCreateTempTableStatement()\n \n         return Lists.newArrayList( sql );\n     }\n+    \n+    private int resolveYearFromPeriod( Period period )\n+    {\n+        // Weekly type has to be treated separately from other Period types.\n+        // In order to handle all weekly types uniformly, 3 days are added to the week start day and\n+        // the year of the modified start date is used as reference year for the Period\n+\n+        if ( WeeklyAbstractPeriodType.class.isAssignableFrom( period.getPeriodType().getClass() ) )\n+        {\n+            return new DateTime( period.getStartDate().getTime() ).plusDays( 3 ).getYear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c0ce36e09aa39e0d0da22e2ebfe962f85924319"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNzc2OTQz", "url": "https://github.com/dhis2/dhis2-core/pull/5745#pullrequestreview-430776943", "createdAt": "2020-06-15T15:53:07Z", "commit": {"oid": "6c0ce36e09aa39e0d0da22e2ebfe962f85924319"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNTo1MzowN1rOGj4Xgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNTo1MzowN1rOGj4Xgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3Njg2Nw==", "bodyText": "When it comes to weeks we currently don't do much considerations for other calendars, mostly because they normally don't have properly defined weeks etc... so i think this is fine (for now at least lets just do ISO weeks for all calendars)", "url": "https://github.com/dhis2/dhis2-core/pull/5745#discussion_r440276867", "createdAt": "2020-06-15T15:53:07Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-services/dhis-service-administration/src/main/java/org/hisp/dhis/resourcetable/table/PeriodResourceTable.java", "diffHunk": "@@ -140,4 +142,20 @@ public String getCreateTempTableStatement()\n \n         return Lists.newArrayList( sql );\n     }\n+    \n+    private int resolveYearFromPeriod( Period period )\n+    {\n+        // Weekly type has to be treated separately from other Period types.\n+        // In order to handle all weekly types uniformly, 3 days are added to the week start day and\n+        // the year of the modified start date is used as reference year for the Period\n+\n+        if ( WeeklyAbstractPeriodType.class.isAssignableFrom( period.getPeriodType().getClass() ) )\n+        {\n+            return new DateTime( period.getStartDate().getTime() ).plusDays( 3 ).getYear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0MDc1MA=="}, "originalCommit": {"oid": "6c0ce36e09aa39e0d0da22e2ebfe962f85924319"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMzAxMDUx", "url": "https://github.com/dhis2/dhis2-core/pull/5745#pullrequestreview-431301051", "createdAt": "2020-06-16T08:59:27Z", "commit": {"oid": "6c0ce36e09aa39e0d0da22e2ebfe962f85924319"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2637, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}