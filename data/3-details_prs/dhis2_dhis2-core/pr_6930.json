{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNzQxODAz", "number": 6930, "title": "perf: replace expensive \"Program has OrgUnit\" call with faster SQL", "bodyText": "Deprecated the method Program.hasOrganisationUnit() and replaced with SQL method on the ProgramService.\nAll calls to Program.hasOrganisationUnit() have been replaced with a call to ProgramService.hasOrgUnit, which uses a fast JDBC-based query against the program_organisationunits table.\nAdditionally, added a check to disable the LOAD Hibernate listener if ON_LOAD auditing is disabled by the user.\n(cherry picked from commit 18a1dea)\nAdditional changes in this PR related to the new Tracker:\n\nRemoved OrgUnits from Program during object mapping\nRemoved OrgUnits list from the Error Code E1041 output\nIntroduce new Preheat class to efficiently preload Program and associated Org Units\nIntroduced validation check for Events so that if an Event's OU doesn't belong to the Event's Program OUs, error with code E1029 is raised", "createdAt": "2020-12-17T09:52:40Z", "url": "https://github.com/dhis2/dhis2-core/pull/6930", "merged": true, "mergeCommit": {"oid": "055574bea49c3a40c5cfff3cb86694fc4bd12c45"}, "closed": true, "closedAt": "2021-01-12T14:26:27Z", "author": {"login": "luciano-fiandesio"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnD4DGgFqTU1NDYyMDY1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtLK3VgFqTU2MTc5NzU0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjIwNjU4", "url": "https://github.com/dhis2/dhis2-core/pull/6930#pullrequestreview-554620658", "createdAt": "2020-12-17T13:51:13Z", "commit": {"oid": "22d9e6d4a228c0ffb2a9e657203b6f4eeb5394d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo1MToxM1rOIH2inw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo1MToxM1rOIH2inw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwNDU0Mw==", "bodyText": "Maybe slightly safer to do !query.getResultList().isEmpty().", "url": "https://github.com/dhis2/dhis2-core/pull/6930#discussion_r545104543", "createdAt": "2020-12-17T13:51:13Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramStore.java", "diffHunk": "@@ -105,4 +106,14 @@ public HibernateProgramStore( SessionFactory sessionFactory, JdbcTemplate jdbcTe\n \n         return getQuery( hql ).setParameter( \"dataEntryForm\", dataEntryForm ).list();\n     }\n+\n+    public boolean hasOrgUnit( Program program, OrganisationUnit organisationUnit )\n+    {\n+        NativeQuery<Long> query = getSession().createNativeQuery(\n+            \"select programid from program_organisationunits where programid = :pid and organisationunitid = :ouid\" );\n+        query.setParameter( \"pid\", program.getId() );\n+        query.setParameter( \"ouid\", organisationUnit.getId() );\n+\n+        return query.getResultList().size() == 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22d9e6d4a228c0ffb2a9e657203b6f4eeb5394d4"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjIxMTA5", "url": "https://github.com/dhis2/dhis2-core/pull/6930#pullrequestreview-554621109", "createdAt": "2020-12-17T13:51:45Z", "commit": {"oid": "22d9e6d4a228c0ffb2a9e657203b6f4eeb5394d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo1MTo0NVrOIH2kEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo1MTo0NVrOIH2kEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwNDkxNQ==", "bodyText": "Remove commented code.", "url": "https://github.com/dhis2/dhis2-core/pull/6930#discussion_r545104915", "createdAt": "2020-12-17T13:51:45Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/test/java/org/hisp/dhis/program/ProgramServiceTest.java", "diffHunk": "@@ -184,4 +184,18 @@ public void testGetProgramByUid()\n         assertEquals( programA, programService.getProgram( \"UID-A\" ) );\n         assertEquals( programB, programService.getProgram( \"UID-B\" ) );\n     }\n+\n+    @Test\n+    public void testProgramHasOrgUnit()\n+    {\n+        programService.addProgram( programA );\n+\n+        Program p = programService.getProgram( programA.getUid() );\n+        OrganisationUnit ou = organisationUnitService.getOrganisationUnit( organisationUnitA.getUid() );\n+\n+        //sessionFactory.getCurrentSession().flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22d9e6d4a228c0ffb2a9e657203b6f4eeb5394d4"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjUxMzE4", "url": "https://github.com/dhis2/dhis2-core/pull/6930#pullrequestreview-554651318", "createdAt": "2020-12-17T14:24:57Z", "commit": {"oid": "22d9e6d4a228c0ffb2a9e657203b6f4eeb5394d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c871e9435a6a188de96b640ef335b6a74b3163a", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1c871e9435a6a188de96b640ef335b6a74b3163a", "committedDate": "2020-12-22T19:43:40Z", "message": "perf: replace expensive \"Program has OrgUnit\" call with faster SQL\n\nDeprecated the method `Program.hasOrganisationUnit()` and replaced with SQL method on the `ProgramService`.\n\nAll calls to `Program.hasOrganisationUnit()` have been replaced with a call to `ProgramService.hasOrgUnit`, which uses a fast JDBC-based query against the `program_organisationunits` table.\n\nAdditionally, added a check to disable the `LOAD` Hibernate listener, if ON_LOAD auditing is disabled by the user.\n\n(cherry picked from commit 18a1dead646233bbb969767bb1cd8351be4ae289)\n\nAdditional changes in this PR related to the new Tracker:\n\n- Removed OrgUnits from Program during object mapping\n- Removed OrgUnits list from the Error Code `E1041` output\n- Introduce new Preheat class to efficiently preload Program and associated Org Units\n- Introduced validation check for Events so that if an Event's OU doesn't belong to the Event's Program OUs, error with code E1029 is raised"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4d2920dcdd6d3f90b88bec9e12a57a6c028ee2d", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b4d2920dcdd6d3f90b88bec9e12a57a6c028ee2d", "committedDate": "2020-12-22T19:43:43Z", "message": "chore: address PR review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c64bb5039d79f11ef572af0d7440d66702e93b61", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/c64bb5039d79f11ef572af0d7440d66702e93b61", "committedDate": "2020-12-17T15:35:07Z", "message": "chore: address PR review comments"}, "afterCommit": {"oid": "b4d2920dcdd6d3f90b88bec9e12a57a6c028ee2d", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b4d2920dcdd6d3f90b88bec9e12a57a6c028ee2d", "committedDate": "2020-12-22T19:43:43Z", "message": "chore: address PR review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01dd598391c6ece27988a7980da4149092093f44", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/01dd598391c6ece27988a7980da4149092093f44", "committedDate": "2020-12-22T20:03:39Z", "message": "chore: fix json test file after rebase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwODM3ODIw", "url": "https://github.com/dhis2/dhis2-core/pull/6930#pullrequestreview-560837820", "createdAt": "2021-01-04T08:09:29Z", "commit": {"oid": "01dd598391c6ece27988a7980da4149092093f44"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "171defba4ef3c973ebf083c8a8bb16f81bd13c2b", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/171defba4ef3c973ebf083c8a8bb16f81bd13c2b", "committedDate": "2021-01-05T13:08:05Z", "message": "Merge remote-tracking branch 'origin/master' into PROGRAM_HAS_ORGUNIT_PERF_FIX"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNzgyMTU2", "url": "https://github.com/dhis2/dhis2-core/pull/6930#pullrequestreview-561782156", "createdAt": "2021-01-05T13:22:44Z", "commit": {"oid": "171defba4ef3c973ebf083c8a8bb16f81bd13c2b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNzk3NTQ0", "url": "https://github.com/dhis2/dhis2-core/pull/6930#pullrequestreview-561797544", "createdAt": "2021-01-05T13:44:39Z", "commit": {"oid": "171defba4ef3c973ebf083c8a8bb16f81bd13c2b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2222, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}