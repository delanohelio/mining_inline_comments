{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MzkzNDk1", "number": 5469, "title": "fix: [DHIS2-2652] Block deletion of org unit group and set linked to \u2026", "bodyText": "\u2026analytics objects\nI am just not sure about Chart.\nShould I create a deletion handler for it?", "createdAt": "2020-04-27T10:07:32Z", "url": "https://github.com/dhis2/dhis2-core/pull/5469", "merged": true, "mergeCommit": {"oid": "4d263f5a9607409b3cab1f7919f1437bb2a51b27"}, "closed": true, "closedAt": "2020-06-11T15:05:14Z", "author": {"login": "enricocolasante"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgP8dEAFqTQwOTE4NjkyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqPpyLgFqTQyOTAwMzU4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MTg2OTI3", "url": "https://github.com/dhis2/dhis2-core/pull/5469#pullrequestreview-409186927", "createdAt": "2020-05-11T13:46:16Z", "commit": {"oid": "2e2b937ba17db359d75841fdbab9270991117b5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMzo0NjoxNlrOGTc-cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMzo0NjoxNlrOGTc-cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1MDg2NQ==", "bodyText": "For all your SQL, stick with either uppercase or lowercase for SQL keywords :)", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r423050865", "createdAt": "2020-05-11T13:46:16Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventchart/EventChartDeletionHandler.java", "diffHunk": "@@ -129,13 +137,36 @@ public void deleteProgramStage( ProgramStage programStage )\n     public void deleteProgram( Program program )\n     {\n         Collection<EventChart> charts = eventChartService.getAllEventCharts();\n-        \n+\n         for ( EventChart chart : charts )\n         {\n-            if ( chart.getProgram().equals( program ))\n+            if ( chart.getProgram().equals( program ) )\n             {\n                 eventChartService.deleteEventChart( chart );\n             }\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroupSet( OrganisationUnitGroupSet groupSet )\n+    {\n+        String sql = \"select count(*) \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e2b937ba17db359d75841fdbab9270991117b5a"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNzYwMTEw", "url": "https://github.com/dhis2/dhis2-core/pull/5469#pullrequestreview-411760110", "createdAt": "2020-05-14T12:39:11Z", "commit": {"oid": "16399b46ec248c13322ac351df5d36838b386e8a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExODU1ODI4", "url": "https://github.com/dhis2/dhis2-core/pull/5469#pullrequestreview-411855828", "createdAt": "2020-05-14T14:22:23Z", "commit": {"oid": "16399b46ec248c13322ac351df5d36838b386e8a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDoyMjoyM1rOGVesYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDoyMjoyM1rOGVesYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE3NjE2Mw==", "bodyText": "Use explicit join (\"inner join\") to remove ambiguity.", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r425176163", "createdAt": "2020-05-14T14:22:23Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventchart/EventChartDeletionHandler.java", "diffHunk": "@@ -129,13 +137,37 @@ public void deleteProgramStage( ProgramStage programStage )\n     public void deleteProgram( Program program )\n     {\n         Collection<EventChart> charts = eventChartService.getAllEventCharts();\n-        \n+\n         for ( EventChart chart : charts )\n         {\n-            if ( chart.getProgram().equals( program ))\n+            if ( chart.getProgram().equals( program ) )\n             {\n                 eventChartService.deleteEventChart( chart );\n             }\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroupSet( OrganisationUnitGroupSet groupSet )\n+    {\n+        String sql = \"SELECT count(*) \"\n+            + \" FROM orgunitgroupsetdimension d JOIN eventchart_orgunitgroupsetdimensions e \"\n+            + \" ON d.orgunitgroupsetdimensionid = e.orgunitgroupsetdimensionid \"\n+            + \" WHERE d.orgunitgroupsetid = \"\n+            + groupSet.getId();\n+\n+        return jdbcTemplate.queryForObject( sql, Integer.class ) == 0 ? null : \"orgunitgroupsetdimension\";\n+    }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroup( OrganisationUnitGroup group )\n+    {\n+        String sql = \"SELECT count(*) \"\n+            + \" FROM orgunitgroupsetdimension d JOIN eventchart_orgunitgroupsetdimensions e \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16399b46ec248c13322ac351df5d36838b386e8a"}, "originalPosition": 122}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExODY0MDE0", "url": "https://github.com/dhis2/dhis2-core/pull/5469#pullrequestreview-411864014", "createdAt": "2020-05-14T14:30:09Z", "commit": {"oid": "16399b46ec248c13322ac351df5d36838b386e8a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDozMDowOVrOGVfEfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDozMDowOVrOGVfEfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE4MjMzMw==", "bodyText": "Use lower-case only in SQL statements for consistency.", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r425182333", "createdAt": "2020-05-14T14:30:09Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/eventreport/EventReportDeletionHandler.java", "diffHunk": "@@ -129,13 +138,36 @@ public void deleteProgramStage( ProgramStage programStage )\n     public void deleteProgram( Program program )\n     {\n         Collection<EventReport> charts = eventReportService.getAllEventReports();\n-        \n+\n         for ( EventReport chart : charts )\n         {\n-            if( chart.getProgram().equals( program ))\n+            if ( chart.getProgram().equals( program ) )\n             {\n-               eventReportService.deleteEventReport( chart );\n+                eventReportService.deleteEventReport( chart );\n             }\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteOrganisationUnitGroupSet( OrganisationUnitGroupSet groupSet )\n+    {\n+        String sql = \"SELECT count(*) \"\n+            + \" FROM orgunitgroupsetdimension d JOIN eventreport_orgunitgroupsetdimensions e \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16399b46ec248c13322ac351df5d36838b386e8a"}, "originalPosition": 113}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d512f9b677b8be043d2d6579fb971f00b617ebb", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/7d512f9b677b8be043d2d6579fb971f00b617ebb", "committedDate": "2020-05-15T09:14:02Z", "message": "Code review fixes"}, "afterCommit": {"oid": "bc96a0521fbc9fcd91f695a9462405e1240ed8a4", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/bc96a0521fbc9fcd91f695a9462405e1240ed8a4", "committedDate": "2020-06-01T13:42:48Z", "message": "fix: Delete OU groups and sets using generic deletion handler [DHIS2-2652]"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNDgyMDk5", "url": "https://github.com/dhis2/dhis2-core/pull/5469#pullrequestreview-422482099", "createdAt": "2020-06-02T09:03:35Z", "commit": {"oid": "bc96a0521fbc9fcd91f695a9462405e1240ed8a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MTQ1Mjg3", "url": "https://github.com/dhis2/dhis2-core/pull/5469#pullrequestreview-428145287", "createdAt": "2020-06-10T14:59:50Z", "commit": {"oid": "bc96a0521fbc9fcd91f695a9462405e1240ed8a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDo1OTo1MFrOGh5E7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDo1OTo1MFrOGh5E7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE5MTM0Mg==", "bodyText": "Just asking so that I understand - Do we need to filter out OrganisationUnitGroupSetDimensions, don't we already know they match after doing the query in analytical store with OrganisationUnitGroupSetDimension as the argument?", "url": "https://github.com/dhis2/dhis2-core/pull/5469#discussion_r438191342", "createdAt": "2020-06-10T14:59:50Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/common/GenericAnalyticalObjectDeletionHandler.java", "diffHunk": "@@ -96,10 +106,52 @@ public String allowDeletePeriod( Period period )\n     @Override\n     public void deleteOrganisationUnit( OrganisationUnit organisationUnit )\n     {\n-        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnit ), organisationUnit, ( ao, di ) -> ao.getOrganisationUnits().remove( di ) );\n+        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnit ), organisationUnit,\n+            ( ao, di ) -> ao.getOrganisationUnits().remove( di ) );\n+    }\n+\n+    @Override\n+    public void deleteOrganisationUnitGroup( OrganisationUnitGroup organisationUnitGroup )\n+    {\n+        removeItem( getAnalyticalObjectService().getAnalyticalObjects( organisationUnitGroup ), organisationUnitGroup,\n+            ( ao, di ) -> {\n+                List<OrganisationUnitGroupSetDimension> dimensionsToDelete = ao.getOrganisationUnitGroupSetDimensions()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc96a0521fbc9fcd91f695a9462405e1240ed8a4"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4823f7f02090115b634353aba9ae54128a6c45e", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b4823f7f02090115b634353aba9ae54128a6c45e", "committedDate": "2020-06-11T10:06:06Z", "message": "fix: Delete OU groups and sets using generic deletion handler [DHIS2-2652]"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc96a0521fbc9fcd91f695a9462405e1240ed8a4", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/bc96a0521fbc9fcd91f695a9462405e1240ed8a4", "committedDate": "2020-06-01T13:42:48Z", "message": "fix: Delete OU groups and sets using generic deletion handler [DHIS2-2652]"}, "afterCommit": {"oid": "b4823f7f02090115b634353aba9ae54128a6c45e", "author": {"user": {"login": "enricocolasante", "name": "Enrico Colasante"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b4823f7f02090115b634353aba9ae54128a6c45e", "committedDate": "2020-06-11T10:06:06Z", "message": "fix: Delete OU groups and sets using generic deletion handler [DHIS2-2652]"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MDAzNTg1", "url": "https://github.com/dhis2/dhis2-core/pull/5469#pullrequestreview-429003585", "createdAt": "2020-06-11T15:05:07Z", "commit": {"oid": "b4823f7f02090115b634353aba9ae54128a6c45e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2730, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}