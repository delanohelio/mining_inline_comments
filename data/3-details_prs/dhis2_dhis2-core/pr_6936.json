{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxOTQxODM0", "number": 6936, "title": "fix: made the Audit queue buffer bounded", "bodyText": "The Audit system may use a queue (disabled by default) to buffer Audit messages before these are de-queued to\nthe Artemis broker.\nThis PR makes the queue bound to 200 items and lowers the de-queue delay to 5 seconds, to avoid excessive memory pressure\nduring large imports.", "createdAt": "2020-12-17T15:29:16Z", "url": "https://github.com/dhis2/dhis2-core/pull/6936", "merged": true, "mergeCommit": {"oid": "7769e2a9fe9304e90492140fdb6619cb710d1667"}, "closed": true, "closedAt": "2020-12-22T11:18:23Z", "author": {"login": "luciano-fiandesio"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnFO_jgH2gAyNTQxOTQxODM0OmNlMGYyZTBmNGI2YjJiYmYzOWNhMjMxODUwZTg3YTY5Zjc5NjE1ZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoUGEQAFqTU1NjMwNzAwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5", "committedDate": "2020-12-17T15:26:11Z", "message": "fix: made the Audit queue buffer bounded\n\nThe Audit system may use a queue (disabled by default) to buffer Audit messages before these are de-queued to\nthe Artemis broker.\nThis PR makes the queue bound to 200 items and lowers the de-queue delay to 5 seconds, to avoid excessive memory pressure\nduring large imports."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MTQ2MTIz", "url": "https://github.com/dhis2/dhis2-core/pull/6936#pullrequestreview-556146123", "createdAt": "2020-12-21T06:01:18Z", "commit": {"oid": "ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MzA3MDAy", "url": "https://github.com/dhis2/dhis2-core/pull/6936#pullrequestreview-556307002", "createdAt": "2020-12-21T11:18:06Z", "commit": {"oid": "ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMToxODowNlrOIJU4GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMToxODozNlrOIJU45A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY1MDEzNg==", "bodyText": "merge? else if", "url": "https://github.com/dhis2/dhis2-core/pull/6936#discussion_r546650136", "createdAt": "2020-12-21T11:18:06Z", "author": {"login": "netroms"}, "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditScheduler.java", "diffHunk": "@@ -63,15 +75,23 @@ public void addAuditItem( final Audit auditItem )\n         {\n             log.debug( String.format( \"add Audit object with content %s to delayed queue\", auditItem.toLog() ) );\n         }\n-        final QueuedAudit postponed = new QueuedAudit( auditItem, delay );\n \n-        if ( !delayed.contains( postponed ) )\n+        final QueuedAudit postponed = new QueuedAudit( auditItem, DELAY );\n+\n+        if ( delayed.size() >= MAX_SIZE )\n+        {\n+            auditProducerSupplier.publish( auditItem );\n+        }\n+        else", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY1MDM0MA==", "bodyText": "Make variables configurable?", "url": "https://github.com/dhis2/dhis2-core/pull/6936#discussion_r546650340", "createdAt": "2020-12-21T11:18:36Z", "author": {"login": "netroms"}, "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditScheduler.java", "diffHunk": "@@ -40,13 +39,26 @@\n import lombok.extern.slf4j.Slf4j;\n \n /**\n+ * Buffers Audit messages prior to sending them to the Audit queue. This\n+ * scheduler is disabled by default (config key: audit.inmemory-queue.enabled)\n+ * and should be used only in very high-traffic environments. Note that upon a\n+ * JVM crash, the Audit messages in this queue will be lost.\n+ * \n+ * The buffer is based on a {@link DelayQueue} where messages are buffered for 5\n+ * seconds, before being de-queued to the Artemis broker.\n+ * \n+ * To avoid excessive memory pressure, max 200 messages can stay in the queue:\n+ * in-excess messages are processed immediately.\n+ *\n  * @author Luciano Fiandesio\n  */\n @Slf4j\n @Component\n public class AuditScheduler\n {\n-    private final long delay = 20_000; // 20 seconds\n+    private final static long DELAY = 5_000; // 5 seconds", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce0f2e0f4b6b2bbf39ca231850e87a69f79615d5"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2228, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}