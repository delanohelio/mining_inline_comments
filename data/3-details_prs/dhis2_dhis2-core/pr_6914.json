{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMjU4NDc4", "number": 6914, "title": "fix: [DHIS2-6642] delete relationships associated with soft deleted events (2.36)", "bodyText": "Remove associated relationships when soft deleting events/enrollments to avoid constraint issues when hard deleting them. Also added a flyway script to remove historically soft deleted events/enrollments", "createdAt": "2020-12-15T13:37:24Z", "url": "https://github.com/dhis2/dhis2-core/pull/6914", "merged": true, "mergeCommit": {"oid": "249be815640f75b48d4d02278961fc795551762e"}, "closed": true, "closedAt": "2020-12-21T08:57:25Z", "author": {"login": "ameenhere"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmaeGbAH2gAyNTQwMjU4NDc4OjU5M2FmMWI2NmNkMDdmZjI5OTQ2YzE5ZGY0MmMwNGE5Y2MxYmRhYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoSKhBgFqTU1NjIyNTg5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "593af1b66cd07ff29946c19df42c04a9cc1bdaa4", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/593af1b66cd07ff29946c19df42c04a9cc1bdaa4", "committedDate": "2020-12-15T13:36:46Z", "message": "fix: [DHIS2-6642] delete relationships associated with soft deleted events (2.36)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62f68a0f4cec94e9c239b8f4b6fed4e91e97ca15", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/62f68a0f4cec94e9c239b8f4b6fed4e91e97ca15", "committedDate": "2020-12-15T17:35:31Z", "message": "Added flyway script and handled soft deleted enrollment referencing relationships"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NDA1Mzcy", "url": "https://github.com/dhis2/dhis2-core/pull/6914#pullrequestreview-555405372", "createdAt": "2020-12-18T11:21:17Z", "commit": {"oid": "62f68a0f4cec94e9c239b8f4b6fed4e91e97ca15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MjE2OTM3", "url": "https://github.com/dhis2/dhis2-core/pull/6914#pullrequestreview-556216937", "createdAt": "2020-12-21T08:49:19Z", "commit": {"oid": "62f68a0f4cec94e9c239b8f4b6fed4e91e97ca15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MjI1Nzg4", "url": "https://github.com/dhis2/dhis2-core/pull/6914#pullrequestreview-556225788", "createdAt": "2020-12-21T09:03:47Z", "commit": {"oid": "62f68a0f4cec94e9c239b8f4b6fed4e91e97ca15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQwOTowMzo0OFrOIJRAEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQwOTowMzo0OFrOIJRAEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU4NjY0Mw==", "bodyText": "just as a suggestion:\nwe might replace this block of code which is duplicated across the whole class with a private method like:\n    private void deleteRelationships(Collection<Relationship> relationships )\n    {\n        Optional.ofNullable( relationships )\n            .orElse( Collections.emptySet() )\n            .forEach( relationshipService::deleteRelationship );\n    }\nso that each method would become just:\n    @Override\n    public void deleteProgramStageInstance( ProgramStageInstance programStageInstance )\n    {\n        deleteRelationships( relationshipService.getRelationshipsByProgramStageInstance( programStageInstance, false ) );\n    }", "url": "https://github.com/dhis2/dhis2-core/pull/6914#discussion_r546586643", "createdAt": "2020-12-21T09:03:48Z", "author": {"login": "gnespolino"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/relationship/RelationshipDeletionHandler.java", "diffHunk": "@@ -76,6 +78,37 @@ public void deleteTrackedEntityInstance( TrackedEntityInstance entityInstance )\n             }\n         }\n     }\n+    \n+    @Override\n+    public void deleteProgramStageInstance( ProgramStageInstance programStageInstance )\n+    {\n+        Collection<Relationship> relationships = relationshipService\n+            .getRelationshipsByProgramStageInstance( programStageInstance, false );\n+\n+        if ( relationships != null )\n+        {\n+            for ( Relationship relationship : relationships )\n+            {\n+                relationshipService.deleteRelationship( relationship );\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f68a0f4cec94e9c239b8f4b6fed4e91e97ca15"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MjI1ODkz", "url": "https://github.com/dhis2/dhis2-core/pull/6914#pullrequestreview-556225893", "createdAt": "2020-12-21T09:03:59Z", "commit": {"oid": "62f68a0f4cec94e9c239b8f4b6fed4e91e97ca15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2216, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}