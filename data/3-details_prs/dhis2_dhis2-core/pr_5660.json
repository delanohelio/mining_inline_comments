{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MjUzMTU4", "number": 5660, "title": "feat: (DHIS2-7734) add parameter to restrict associated orgunits to strictly capture scope for categoryOptions [master]", "bodyText": "Added a query parameter named \"restrictToCaptureScope\" for AbstractCrudController. It restricts the results returned to only those that have associated OrgUnits empty OR if the associated orgUnits have any capture scope ous in them.\nAn additional change to queryplanner to mark the query as \"nonPersisted\" by recursively checking criterions for presence of non persisted property. Earlier it was only checking the first level of criterions.", "createdAt": "2020-06-03T14:47:28Z", "url": "https://github.com/dhis2/dhis2-core/pull/5660", "merged": true, "mergeCommit": {"oid": "73f25715081a83a398b6458127d51de80787b91a"}, "closed": true, "closedAt": "2020-06-16T15:35:00Z", "author": {"login": "ameenhere"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcczmCYAH2gAyNDI3MjUzMTU4OmE5NzY2MzU2NjcwNzEyOTBhNjk3NTlhODc4M2Q1ZmVlODM1ZDQyMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr3EyZAFqTQzMTYzNTg4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a976635667071290a69759a8783d5fee835d4214", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a976635667071290a69759a8783d5fee835d4214", "committedDate": "2020-04-30T21:02:40Z", "message": "Initial Commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd6b1ba1ed54040af273910c15e72f415163c7b5", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/cd6b1ba1ed54040af273910c15e72f415163c7b5", "committedDate": "2020-05-06T08:50:22Z", "message": "Merge branch 'master' into DHIS2-7734-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d78a1bba5966855727da2f24d5b2b15cf93a2a65", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d78a1bba5966855727da2f24d5b2b15cf93a2a65", "committedDate": "2020-05-07T08:11:53Z", "message": "Add org unit childrens as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9234771d6e16afc26368e9ef24d149facb64e1f", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/e9234771d6e16afc26368e9ef24d149facb64e1f", "committedDate": "2020-05-14T09:43:00Z", "message": "Merge branch 'master' into DHIS2-7734-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa8f184fb48f792e62456fc8750808e3a9e7490c", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/fa8f184fb48f792e62456fc8750808e3a9e7490c", "committedDate": "2020-06-02T08:36:38Z", "message": "Modified to use single disjunction for org unit filtering in Query object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0786be0827d217affbdf665e64ffbd34e93c288", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b0786be0827d217affbdf665e64ffbd34e93c288", "committedDate": "2020-06-03T01:07:16Z", "message": "Added postprocessing method to remove associated orgunits that are not part of the capture scope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b9716af3570710ca93cf087045f257e75386063", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/5b9716af3570710ca93cf087045f257e75386063", "committedDate": "2020-06-03T01:07:42Z", "message": "Merge branch 'master' into DHIS2-7734-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96e287bccf434c9ea28e661e8a074ae6d87e9ea9", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/96e287bccf434c9ea28e661e8a074ae6d87e9ea9", "committedDate": "2020-06-03T14:44:59Z", "message": "Merge branch 'master' into DHIS2-7734-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "580abb0f5c5a1e5008b9b9adb14ff5d836117272", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/580abb0f5c5a1e5008b9b9adb14ff5d836117272", "committedDate": "2020-06-03T17:44:01Z", "message": "fix cognitive complexity suggested by sonar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6819948e5a32550eb475e601f0c25d3c55be59ce", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/6819948e5a32550eb475e601f0c25d3c55be59ce", "committedDate": "2020-06-09T17:16:38Z", "message": "Merge branch 'master' into DHIS2-7734-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99e2ef4fcc318842a51b513c77c719dcf3c04d62", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/99e2ef4fcc318842a51b513c77c719dcf3c04d62", "committedDate": "2020-06-09T19:03:18Z", "message": "Modified parameter name to restrictToCaptureScope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df7e833723de17cae5cb43a28418294f4a1579df", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/df7e833723de17cae5cb43a28418294f4a1579df", "committedDate": "2020-06-09T19:25:10Z", "message": "Minor sonar qube fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d18b91b4aca797abf549266ded716841b9c11ab8", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d18b91b4aca797abf549266ded716841b9c11ab8", "committedDate": "2020-06-10T08:16:30Z", "message": "fix cached count when restrictToCaptureScope parameter is added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/022d31468958ca980b23e573cabe0cd8ce7c8c9e", "committedDate": "2020-06-10T08:16:53Z", "message": "Merge branch 'master' into DHis2-7734-master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3ODc1MTgy", "url": "https://github.com/dhis2/dhis2-core/pull/5660#pullrequestreview-427875182", "createdAt": "2020-06-10T09:25:42Z", "commit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNTo0MlrOGhslMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNjoyN1rOGhsnEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4NjYxMA==", "bodyText": "style, space in paranthesis", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437986610", "createdAt": "2020-06-10T09:25:42Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryParser.java", "diffHunk": "@@ -97,10 +118,34 @@ public Query parse( Class<?> klass, List<String> filters, Junction.Type rootJunc\n                 query.add( getRestriction( schema, split[0], split[1], null ) );\n             }\n         }\n+        \n+        if ( restrictToCaptureScope && schema.haveProperty( ORGANISATION_UNITS ) )\n+        {\n+            User user = currentUserService.getCurrentUser();\n \n+            if ( user != null )\n+            {\n+                handleCaptureScopeOuFiltering( schema, user, query.addDisjunction() );\n+            }\n+        }\n         return query;\n     }\n \n+    private void handleCaptureScopeOuFiltering(Schema schema, User user, Disjunction disjunction)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4Njc2Nw==", "bodyText": "style, space in paranthesis", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437986767", "createdAt": "2020-06-10T09:25:56Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryService.java", "diffHunk": "@@ -117,7 +117,13 @@ public Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order>\n     @Override\n     public Query getQueryFromUrl(Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination, Junction.Type rootJunction ) throws QueryParserException\n     {\n-        Query query = queryParser.parse( klass, filters, rootJunction );\n+        return getQueryFromUrl( klass, filters, orders, pagination, rootJunction, false );\n+    }\n+\n+    @Override\n+    public Query getQueryFromUrl(Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination, Junction.Type rootJunction, boolean restrictToCaptureScope ) throws QueryParserException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4Njk1Ng==", "bodyText": "Too much space in paranthesis", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437986956", "createdAt": "2020-06-10T09:26:14Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/QueryParser.java", "diffHunk": "@@ -58,4 +60,7 @@\n     Property getProperty( Schema schema, String path ) throws QueryParserException;\n \n     Restriction getRestriction( Schema schema, String path, String operator, Object arg ) throws QueryParserException;\n+\n+    Query parse( Class<?> klass, List<String> filters, Type rootJunction, boolean restrictToCaptureScope  )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4NzA5MQ==", "bodyText": "Too much space in paranthesis", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437987091", "createdAt": "2020-06-10T09:26:27Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/QueryService.java", "diffHunk": "@@ -80,4 +81,7 @@\n     Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination) throws QueryParserException;\n \n     Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order> orders ) throws QueryParserException;\n+\n+    Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination, Type rootJunction, boolean restrictToCaptureScope  )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3OTkxMTA5", "url": "https://github.com/dhis2/dhis2-core/pull/5660#pullrequestreview-427991109", "createdAt": "2020-06-10T12:15:23Z", "commit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjoxNToyM1rOGhx_Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjoxNToyM1rOGhx_Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3NTIzMQ==", "bodyText": "Try not to have too many levels of nesting, if the option is not there, you can quickly jump out", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r438075231", "createdAt": "2020-06-10T12:15:23Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/category/CategoryOptionController.java", "diffHunk": "@@ -39,7 +50,41 @@\n  */\n @Controller\n @RequestMapping( value = CategoryOptionSchemaDescriptor.API_ENDPOINT )\n-public class CategoryOptionController\n-    extends AbstractCrudController<CategoryOption>\n+public class CategoryOptionController extends AbstractCrudController<CategoryOption>\n {\n+    @Autowired\n+    private CurrentUserService currentUserService;\n+\n+    @Autowired\n+    private OrganisationUnitService organisationUnitService;\n+\n+    @Override\n+    protected void postProcessResponseEntities( List<CategoryOption> entityList, WebOptions options, Map<String, String> parameters )\n+    {\n+\n+        if ( \"true\".equalsIgnoreCase( options.getOptions().get( \"restrictToCaptureScope\" ) ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MDA0OTIx", "url": "https://github.com/dhis2/dhis2-core/pull/5660#pullrequestreview-428004921", "createdAt": "2020-06-10T12:33:38Z", "commit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjozMzozOFrOGhyniw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjozMzozOFrOGhyniw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NTUxNQ==", "bodyText": "Isn't the user already available in query.getUser() ? why do you need to refetch current user here?", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r438085515", "createdAt": "2020-06-10T12:33:38Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryParser.java", "diffHunk": "@@ -97,10 +118,34 @@ public Query parse( Class<?> klass, List<String> filters, Junction.Type rootJunc\n                 query.add( getRestriction( schema, split[0], split[1], null ) );\n             }\n         }\n+        \n+        if ( restrictToCaptureScope && schema.haveProperty( ORGANISATION_UNITS ) )\n+        {\n+            User user = currentUserService.getCurrentUser();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cf00ee5b174ec74708f8cce5fac9d8fe4e8b0d8", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/4cf00ee5b174ec74708f8cce5fac9d8fe4e8b0d8", "committedDate": "2020-06-16T09:05:37Z", "message": "Merge branch 'master' into DHIS2-7734-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "088618a8dfdc274fce82a5f19da6ce2fa83a83a5", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/088618a8dfdc274fce82a5f19da6ce2fa83a83a5", "committedDate": "2020-06-16T09:25:41Z", "message": "Added review comment changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "355d662b2da1f5c6ae05cda4a84ce1abb7677d19", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/355d662b2da1f5c6ae05cda4a84ce1abb7677d19", "committedDate": "2020-06-16T10:53:13Z", "message": "Merge branch 'master' into DHIS2-7734-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3232f1830749a3488a635de4b6fb08079e91a754", "author": {"user": {"login": "ameenhere", "name": "Mohamed Ameen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/3232f1830749a3488a635de4b6fb08079e91a754", "committedDate": "2020-06-16T12:46:25Z", "message": "Review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDkxNDk0", "url": "https://github.com/dhis2/dhis2-core/pull/5660#pullrequestreview-431491494", "createdAt": "2020-06-16T13:17:44Z", "commit": {"oid": "3232f1830749a3488a635de4b6fb08079e91a754"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNjM1ODg3", "url": "https://github.com/dhis2/dhis2-core/pull/5660#pullrequestreview-431635887", "createdAt": "2020-06-16T15:34:50Z", "commit": {"oid": "3232f1830749a3488a635de4b6fb08079e91a754"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2700, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}