{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MjUzMTU4", "number": 5660, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNTo0MlrOEENxXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjozMzozOFrOEERglg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyODU1Mzg5OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNTo0MlrOGhslMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNTo0MlrOGhslMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4NjYxMA==", "bodyText": "style, space in paranthesis", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437986610", "createdAt": "2020-06-10T09:25:42Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryParser.java", "diffHunk": "@@ -97,10 +118,34 @@ public Query parse( Class<?> klass, List<String> filters, Junction.Type rootJunc\n                 query.add( getRestriction( schema, split[0], split[1], null ) );\n             }\n         }\n+        \n+        if ( restrictToCaptureScope && schema.haveProperty( ORGANISATION_UNITS ) )\n+        {\n+            User user = currentUserService.getCurrentUser();\n \n+            if ( user != null )\n+            {\n+                handleCaptureScopeOuFiltering( schema, user, query.addDisjunction() );\n+            }\n+        }\n         return query;\n     }\n \n+    private void handleCaptureScopeOuFiltering(Schema schema, User user, Disjunction disjunction)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyODU1NDk0OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNTo1NlrOGhslzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNTo1NlrOGhslzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4Njc2Nw==", "bodyText": "style, space in paranthesis", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437986767", "createdAt": "2020-06-10T09:25:56Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryService.java", "diffHunk": "@@ -117,7 +117,13 @@ public Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order>\n     @Override\n     public Query getQueryFromUrl(Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination, Junction.Type rootJunction ) throws QueryParserException\n     {\n-        Query query = queryParser.parse( klass, filters, rootJunction );\n+        return getQueryFromUrl( klass, filters, orders, pagination, rootJunction, false );\n+    }\n+\n+    @Override\n+    public Query getQueryFromUrl(Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination, Junction.Type rootJunction, boolean restrictToCaptureScope ) throws QueryParserException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyODU1NjE2OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/QueryParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNjoxNFrOGhsmjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNjoxNFrOGhsmjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4Njk1Ng==", "bodyText": "Too much space in paranthesis", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437986956", "createdAt": "2020-06-10T09:26:14Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/QueryParser.java", "diffHunk": "@@ -58,4 +60,7 @@\n     Property getProperty( Schema schema, String path ) throws QueryParserException;\n \n     Restriction getRestriction( Schema schema, String path, String operator, Object arg ) throws QueryParserException;\n+\n+    Query parse( Class<?> klass, List<String> filters, Type rootJunction, boolean restrictToCaptureScope  )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyODU1NzAyOnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/QueryService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNjoyN1rOGhsnEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOToyNjoyN1rOGhsnEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4NzA5MQ==", "bodyText": "Too much space in paranthesis", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437987091", "createdAt": "2020-06-10T09:26:27Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/QueryService.java", "diffHunk": "@@ -80,4 +81,7 @@\n     Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination) throws QueryParserException;\n \n     Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order> orders ) throws QueryParserException;\n+\n+    Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination, Type rootJunction, boolean restrictToCaptureScope  )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyOTEwMTY0OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/category/CategoryOptionController.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjoxNToyM1rOGhx_Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMTowNzoyMlrOGkWabw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3NTIzMQ==", "bodyText": "Try not to have too many levels of nesting, if the option is not there, you can quickly jump out", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r438075231", "createdAt": "2020-06-10T12:15:23Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/category/CategoryOptionController.java", "diffHunk": "@@ -39,7 +50,41 @@\n  */\n @Controller\n @RequestMapping( value = CategoryOptionSchemaDescriptor.API_ENDPOINT )\n-public class CategoryOptionController\n-    extends AbstractCrudController<CategoryOption>\n+public class CategoryOptionController extends AbstractCrudController<CategoryOption>\n {\n+    @Autowired\n+    private CurrentUserService currentUserService;\n+\n+    @Autowired\n+    private OrganisationUnitService organisationUnitService;\n+\n+    @Override\n+    protected void postProcessResponseEntities( List<CategoryOption> entityList, WebOptions options, Map<String, String> parameters )\n+    {\n+\n+        if ( \"true\".equalsIgnoreCase( options.getOptions().get( \"restrictToCaptureScope\" ) ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxNTQyMg==", "bodyText": "Isnt that happening here? if the option doesnt exist or is false, the control flow doesnt get into the if construct and jumps out. Is that OK?", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r440715422", "createdAt": "2020-06-16T09:30:13Z", "author": {"login": "ameenhere"}, "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/category/CategoryOptionController.java", "diffHunk": "@@ -39,7 +50,41 @@\n  */\n @Controller\n @RequestMapping( value = CategoryOptionSchemaDescriptor.API_ENDPOINT )\n-public class CategoryOptionController\n-    extends AbstractCrudController<CategoryOption>\n+public class CategoryOptionController extends AbstractCrudController<CategoryOption>\n {\n+    @Autowired\n+    private CurrentUserService currentUserService;\n+\n+    @Autowired\n+    private OrganisationUnitService organisationUnitService;\n+\n+    @Override\n+    protected void postProcessResponseEntities( List<CategoryOption> entityList, WebOptions options, Map<String, String> parameters )\n+    {\n+\n+        if ( \"true\".equalsIgnoreCase( options.getOptions().get( \"restrictToCaptureScope\" ) ) )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3NTIzMQ=="}, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2OTEzNQ==", "bodyText": "I mean, if you jump (return) out immediately, you don't need to nest the next lines", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r440769135", "createdAt": "2020-06-16T11:07:22Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/category/CategoryOptionController.java", "diffHunk": "@@ -39,7 +50,41 @@\n  */\n @Controller\n @RequestMapping( value = CategoryOptionSchemaDescriptor.API_ENDPOINT )\n-public class CategoryOptionController\n-    extends AbstractCrudController<CategoryOption>\n+public class CategoryOptionController extends AbstractCrudController<CategoryOption>\n {\n+    @Autowired\n+    private CurrentUserService currentUserService;\n+\n+    @Autowired\n+    private OrganisationUnitService organisationUnitService;\n+\n+    @Override\n+    protected void postProcessResponseEntities( List<CategoryOption> entityList, WebOptions options, Map<String, String> parameters )\n+    {\n+\n+        if ( \"true\".equalsIgnoreCase( options.getOptions().get( \"restrictToCaptureScope\" ) ) )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3NTIzMQ=="}, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyOTE2NjMwOnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryParser.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjozMzozOFrOGhyniw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMTowNTozOVrOGkWXPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NTUxNQ==", "bodyText": "Isn't the user already available in query.getUser() ? why do you need to refetch current user here?", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r438085515", "createdAt": "2020-06-10T12:33:38Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryParser.java", "diffHunk": "@@ -97,10 +118,34 @@ public Query parse( Class<?> klass, List<String> filters, Junction.Type rootJunc\n                 query.add( getRestriction( schema, split[0], split[1], null ) );\n             }\n         }\n+        \n+        if ( restrictToCaptureScope && schema.haveProperty( ORGANISATION_UNITS ) )\n+        {\n+            User user = currentUserService.getCurrentUser();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwMTgyMw==", "bodyText": "Not at this point. This is the part where the Query object is created. The user is yet to be injected into it. But we can add it to the Query object here then if that makes more sense?", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r440701823", "createdAt": "2020-06-16T09:07:51Z", "author": {"login": "ameenhere"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryParser.java", "diffHunk": "@@ -97,10 +118,34 @@ public Query parse( Class<?> klass, List<String> filters, Junction.Type rootJunc\n                 query.add( getRestriction( schema, split[0], split[1], null ) );\n             }\n         }\n+        \n+        if ( restrictToCaptureScope && schema.haveProperty( ORGANISATION_UNITS ) )\n+        {\n+            User user = currentUserService.getCurrentUser();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NTUxNQ=="}, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2ODMxOQ==", "bodyText": "Ok, thats fine then, just leave it as it is", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r440768319", "createdAt": "2020-06-16T11:05:39Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryParser.java", "diffHunk": "@@ -97,10 +118,34 @@ public Query parse( Class<?> klass, List<String> filters, Junction.Type rootJunc\n                 query.add( getRestriction( schema, split[0], split[1], null ) );\n             }\n         }\n+        \n+        if ( restrictToCaptureScope && schema.haveProperty( ORGANISATION_UNITS ) )\n+        {\n+            User user = currentUserService.getCurrentUser();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NTUxNQ=="}, "originalCommit": {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e"}, "originalPosition": 76}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3438, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}