{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NjExODEz", "number": 5908, "title": "fix: Load TEI in TrackerCapture app trigger update query", "bodyText": "https://jira.dhis2.org/browse/DHIS2-9230\n\nRemoved AbstractDeviceRenderTypeMapDeserializer\nAdd function programAttributeStore.getAttributes( programs )  and  entityTypeAttributeStore.getAttributes( trackedEntityTypes)\nThose new functions extract TrackedEntityAttribute  directly from hibernate, no mapping/deserialization needed. It also uses one IN condition instead of n queries by programid as in old code.\n\nThis fix considered as a work around, it doesn't fix the root cause. Maybe the cause is because of jsonb column deserialization causing additional update queries.  Need more time to investigate and work on that.", "createdAt": "2020-08-10T16:41:47Z", "url": "https://github.com/dhis2/dhis2-core/pull/5908", "merged": true, "mergeCommit": {"oid": "e5bb2c79e86efa50f195d727b77ce7877a127faf"}, "closed": true, "closedAt": "2020-08-13T07:18:58Z", "author": {"login": "vietnguyen"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9lFO-ABqjM2Mzk2MjQxMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-avdAgFqTQ2NjUwMjk2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f0f24fff0682fd7e910a2105663b779004410dc", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/8f0f24fff0682fd7e910a2105663b779004410dc", "committedDate": "2020-08-10T16:41:08Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}, "afterCommit": {"oid": "cdd1ac45c3d861ce85d6a921210a0a91aebc88c2", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/cdd1ac45c3d861ce85d6a921210a0a91aebc88c2", "committedDate": "2020-08-10T16:47:27Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdd1ac45c3d861ce85d6a921210a0a91aebc88c2", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/cdd1ac45c3d861ce85d6a921210a0a91aebc88c2", "committedDate": "2020-08-10T16:47:27Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}, "afterCommit": {"oid": "dff4a8282affd2f551fd8600e299506d164a6483", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/dff4a8282affd2f551fd8600e299506d164a6483", "committedDate": "2020-08-11T02:12:29Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NzQ3MDM1", "url": "https://github.com/dhis2/dhis2-core/pull/5908#pullrequestreview-464747035", "createdAt": "2020-08-11T04:53:36Z", "commit": {"oid": "dff4a8282affd2f551fd8600e299506d164a6483"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNDo1MzozNlrOG-oUjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNDo1ODowMlrOG-oYrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyNTUxOQ==", "bodyText": "Please add Javadoc\nI would rename this method to getAttributes and explain the ACL part in the java docs", "url": "https://github.com/dhis2/dhis2-core/pull/5908#discussion_r468325519", "createdAt": "2020-08-11T04:53:36Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/program/ProgramTrackedEntityAttributeStore.java", "diffHunk": "@@ -39,4 +42,6 @@\n     extends IdentifiableObjectStore<ProgramTrackedEntityAttribute>\n {\n     ProgramTrackedEntityAttribute get( Program program, TrackedEntityAttribute attribute );\n+\n+    List<TrackedEntityAttribute> getAttributesByProgramsWithDataRead( List<Program> programs, User user );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dff4a8282affd2f551fd8600e299506d164a6483"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyNTY0MA==", "bodyText": "Please add Javadoc\nI would rename this method to getAttributes and explain the ACL part in the java docs", "url": "https://github.com/dhis2/dhis2-core/pull/5908#discussion_r468325640", "createdAt": "2020-08-11T04:54:02Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/trackedentity/TrackedEntityTypeAttributeStore.java", "diffHunk": "@@ -28,13 +28,14 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import org.hisp.dhis.render.type.SectionRenderingObject;\n+import org.hisp.dhis.common.IdentifiableObjectStore;\n+import org.hisp.dhis.program.ProgramTrackedEntityAttribute;\n+import org.hisp.dhis.user.User;\n \n-public class SectionRenderTypeDeserialize\n-    extends AbstractDeviceRenderTypeMapDeserializer<SectionRenderingObject>\n+import java.util.List;\n+\n+public interface TrackedEntityTypeAttributeStore\n+    extends IdentifiableObjectStore<TrackedEntityTypeAttribute>\n {\n-    public SectionRenderTypeDeserialize()\n-    {\n-        super( SectionRenderingObject::new );\n-    }\n+    List<TrackedEntityAttribute> getAttributesByTrackedEntityTypesWithDataRead( List<TrackedEntityType> trackedEntityTypes, User user );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dff4a8282affd2f551fd8600e299506d164a6483"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyNjM1NA==", "bodyText": "I'm not very familiar with this renderer, but this look like a drastic change. Can you comment what has been done here?", "url": "https://github.com/dhis2/dhis2-core/pull/5908#discussion_r468326354", "createdAt": "2020-08-11T04:56:57Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-support/dhis-support-hibernate/src/main/java/org/hisp/dhis/hibernate/jsonb/type/JsonDeviceRenderTypeMap.java", "diffHunk": "@@ -28,38 +28,32 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import com.fasterxml.jackson.core.JsonParser;\n-import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.JavaType;\n import org.hisp.dhis.render.DeviceRenderTypeMap;\n+import org.hisp.dhis.render.RenderDevice;\n+import org.hisp.dhis.render.type.RenderingObject;\n \n import java.io.IOException;\n+import java.util.LinkedHashMap;\n import java.util.Properties;\n \n public class JsonDeviceRenderTypeMap extends JsonBinaryType\n {\n-    private Class<? extends JsonDeserializer> deserializer;\n+    private Class<? extends RenderingObject> renderType;\n \n     @Override\n-    protected Object convertJsonToObject( String content )\n+    protected JavaType getResultingJavaType( Class<?> returnedClass )\n     {\n-        try", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dff4a8282affd2f551fd8600e299506d164a6483"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyNjU3Mg==", "bodyText": "Do we have a test for this function?", "url": "https://github.com/dhis2/dhis2-core/pull/5908#discussion_r468326572", "createdAt": "2020-08-11T04:58:02Z", "author": {"login": "luciano-fiandesio"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramTrackedEntityAttributeStore.java", "diffHunk": "@@ -66,4 +75,21 @@ public ProgramTrackedEntityAttribute get(Program program, TrackedEntityAttribute\n             .addPredicate( root -> builder.equal( root.get( \"program\" ), program ) )\n             .addPredicate( root -> builder.equal( root.get( \"attribute\" ), attribute ) ) );\n     }\n+\n+    @Override\n+    public List<TrackedEntityAttribute> getAttributesByProgramsWithDataRead( List<Program> programs, User user )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dff4a8282affd2f551fd8600e299506d164a6483"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NzQ5NjQw", "url": "https://github.com/dhis2/dhis2-core/pull/5908#pullrequestreview-464749640", "createdAt": "2020-08-11T05:02:28Z", "commit": {"oid": "dff4a8282affd2f551fd8600e299506d164a6483"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dff4a8282affd2f551fd8600e299506d164a6483", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/dff4a8282affd2f551fd8600e299506d164a6483", "committedDate": "2020-08-11T02:12:29Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}, "afterCommit": {"oid": "b67af0f93fe901698340b87a6f7b1541ee9f1974", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b67af0f93fe901698340b87a6f7b1541ee9f1974", "committedDate": "2020-08-11T08:15:14Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b67af0f93fe901698340b87a6f7b1541ee9f1974", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b67af0f93fe901698340b87a6f7b1541ee9f1974", "committedDate": "2020-08-11T08:15:14Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}, "afterCommit": {"oid": "81a7fcd5e1996e1241513e3550829f24c4a61c46", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/81a7fcd5e1996e1241513e3550829f24c4a61c46", "committedDate": "2020-08-11T09:17:05Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81a7fcd5e1996e1241513e3550829f24c4a61c46", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/81a7fcd5e1996e1241513e3550829f24c4a61c46", "committedDate": "2020-08-11T09:17:05Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}, "afterCommit": {"oid": "bdd4e545789071641ebc3d5e0880aaede4ff8418", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/bdd4e545789071641ebc3d5e0880aaede4ff8418", "committedDate": "2020-08-11T13:54:18Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00e79abb0bc57a4fa7d044431e17cf5ac250d216", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/00e79abb0bc57a4fa7d044431e17cf5ac250d216", "committedDate": "2020-08-12T08:24:23Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bdd4e545789071641ebc3d5e0880aaede4ff8418", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/bdd4e545789071641ebc3d5e0880aaede4ff8418", "committedDate": "2020-08-11T13:54:18Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}, "afterCommit": {"oid": "00e79abb0bc57a4fa7d044431e17cf5ac250d216", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/00e79abb0bc57a4fa7d044431e17cf5ac250d216", "committedDate": "2020-08-12T08:24:23Z", "message": "fix: Load TEI in TrackerCapture app trigger update query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MDUxODQ4", "url": "https://github.com/dhis2/dhis2-core/pull/5908#pullrequestreview-466051848", "createdAt": "2020-08-12T15:52:21Z", "commit": {"oid": "00e79abb0bc57a4fa7d044431e17cf5ac250d216"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NTAyMTY5", "url": "https://github.com/dhis2/dhis2-core/pull/5908#pullrequestreview-466502169", "createdAt": "2020-08-13T07:17:29Z", "commit": {"oid": "00e79abb0bc57a4fa7d044431e17cf5ac250d216"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzoxNzoyOVrOG_-_4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNzoxNzoyOVrOG_-_4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc0NTYzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Collectors.toList()) ));\n          \n          \n            \n                                Collectors.toList() ) ) );", "url": "https://github.com/dhis2/dhis2-core/pull/5908#discussion_r469745635", "createdAt": "2020-08-13T07:17:29Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/trackedentity/DefaultTrackedEntityAttributeService.java", "diffHunk": "@@ -283,13 +288,20 @@ else if ( trackedEntityAttribute.hasOptionSet() && !trackedEntityAttribute.isVal\n     @Transactional(readOnly = true)\n     public Set<TrackedEntityAttribute> getAllUserReadableTrackedEntityAttributes( User user, List<Program> programs, List<TrackedEntityType> trackedEntityTypes )\n     {\n-        Set<TrackedEntityAttribute> attributes;\n+        Set<TrackedEntityAttribute> attributes = new HashSet<>();\n \n-        attributes = programs.stream().filter( program -> aclService.canDataRead( user, program ) ).collect( Collectors.toList() )\n-            .stream().map( Program::getTrackedEntityAttributes ).flatMap( Collection::stream ).collect( Collectors.toSet() );\n+        if ( programs != null && !programs.isEmpty() )\n+        {\n+            attributes.addAll( programAttributeStore.getAttributes(\n+                programs.stream().filter( program -> aclService.canDataRead( user, program ) ).collect( Collectors.toList()) ) );\n+        }\n \n-        attributes.addAll( trackedEntityTypes.stream().filter( trackedEntityType -> aclService.canDataRead( user, trackedEntityType ) ).collect( Collectors.toList() )\n-            .stream().map( TrackedEntityType::getTrackedEntityAttributes ).flatMap( Collection::stream ).collect( Collectors.toSet() ) );\n+        if ( trackedEntityTypes != null && !trackedEntityTypes.isEmpty() )\n+        {\n+            attributes.addAll( entityTypeAttributeStore.getAttributes(\n+                trackedEntityTypes.stream().filter( trackedEntityType -> aclService.canDataRead( user, trackedEntityType ) ).collect(\n+                    Collectors.toList()) ));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00e79abb0bc57a4fa7d044431e17cf5ac250d216"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NTAyOTYy", "url": "https://github.com/dhis2/dhis2-core/pull/5908#pullrequestreview-466502962", "createdAt": "2020-08-13T07:18:45Z", "commit": {"oid": "00e79abb0bc57a4fa7d044431e17cf5ac250d216"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2599, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}