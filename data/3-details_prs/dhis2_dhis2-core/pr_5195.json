{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1MDk5OTg3", "number": 5195, "title": "fix: Prevent invalid query when using PI as sort item", "bodyText": "DHIS2-8542\nFix event/enrollment query generation process, by referencing a\nProgram Indicator alias (as uid) in the \"order by\" clause (instead of a column name)", "createdAt": "2020-03-28T14:03:12Z", "url": "https://github.com/dhis2/dhis2-core/pull/5195", "merged": true, "mergeCommit": {"oid": "59232d19c6ddb4d5ad3af58ab5c5894a930c0446"}, "closed": true, "closedAt": "2020-03-30T10:36:01Z", "author": {"login": "luciano-fiandesio"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSFwg1AH2gAyMzk1MDk5OTg3OmI1NjdkZjNhMmE3OTdlMjE0ODk1OThmNTllOTNhMWRiOTcwODUyMDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSsC6BgFqTM4MzcyNzg0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b567df3a2a797e21489598f59e93a1db97085201", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b567df3a2a797e21489598f59e93a1db97085201", "committedDate": "2020-03-28T13:59:14Z", "message": "fix: Prevent invalid query when using PI as sort item\n\n- DHIS2-8542\n- Fix event/enrollment query generation process, by referencing a\nProgram Indicator alias (as uid) in the \"order by\" clause (instead of a column name)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNjAyMDkz", "url": "https://github.com/dhis2/dhis2-core/pull/5195#pullrequestreview-383602093", "createdAt": "2020-03-30T07:44:53Z", "commit": {"oid": "b567df3a2a797e21489598f59e93a1db97085201"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzo0NDo1M1rOF9dTcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzo0NDo1M1rOF9dTcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NzU3MQ==", "bodyText": "Style, a few missing spaces", "url": "https://github.com/dhis2/dhis2-core/pull/5195#discussion_r399987571", "createdAt": "2020-03-30T07:44:53Z", "author": {"login": "Bekkalizer"}, "path": "dhis-2/dhis-services/dhis-service-analytics/src/test/java/org/hisp/dhis/analytics/event/data/EventsAnalyticsManagerTest.java", "diffHunk": "@@ -272,6 +285,41 @@ public void verifyLastAggregationTypeSubquery()\n         verifyFirstOrLastAggregationTypeSubquery( AnalyticsAggregationType.LAST );\n     }\n \n+    @Test\n+    public void verifySortClauseHandlesProgramIndicators()\n+    {\n+        Program program = createProgram( 'P' );\n+        ProgramIndicator piA = createProgramIndicator( 'A', program, \".\", \".\" );\n+        piA.setUid( \"TLKx7vllb1I\" );\n+\n+        ProgramIndicator piB = createProgramIndicator( 'B', program, \".\", \".\" );\n+        piA.setUid( \"CCKx3gllb2P\" );\n+\n+        OrganisationUnit ouA = createOrganisationUnit( 'A' );\n+        Period peA = PeriodType.getPeriodFromIsoString( \"201501\" );\n+\n+        DataElement deA = createDataElement( 'A' );\n+        deA.setUid( \"ZE4cgllb2P\");\n+\n+        DataQueryParams params = DataQueryParams.newBuilder().withDataType( DataType.NUMERIC )\n+            .withTableName( \"analytics\" ).withPeriodType( QuarterlyPeriodType.NAME )\n+            .withAggregationType( AnalyticsAggregationType.fromAggregationType( AggregationType.DEFAULT ) )\n+            .addDimension( new BaseDimensionalObject( DATA_X_DIM_ID, DimensionType.PROGRAM_INDICATOR, getList( piA, piB ) ) )\n+            .addFilter( new BaseDimensionalObject( ORGUNIT_DIM_ID, DimensionType.ORGANISATION_UNIT, getList( ouA ) ) )\n+            .addDimension( new BaseDimensionalObject( PERIOD_DIM_ID, DimensionType.DATA_X, getList( peA ) ) )\n+            .addDimension( new BaseDimensionalObject( PERIOD_DIM_ID, DimensionType.PERIOD, getList( peA ) ) ).build();\n+\n+        final EventQueryParams.Builder eventQueryParamsBuilder = new EventQueryParams.Builder( params )\n+            .withProgram( program )\n+            .addAscSortItem( piA )\n+            .addDescSortItem( piB )\n+            .addAscSortItem( deA );\n+\n+        final String sql = subject.getEventsOrEnrollmentsSql( eventQueryParamsBuilder.build(), 100 );\n+\n+        assertThat(sql, containsString(\"order by \\\"\" + piA.getUid() + \"\\\" asc,ax.\\\"\" + deA.getUid() + \"\\\" asc,\\\"\" + piB.getUid() + \"\\\"\" ));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b567df3a2a797e21489598f59e93a1db97085201"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNjAzMjUy", "url": "https://github.com/dhis2/dhis2-core/pull/5195#pullrequestreview-383603252", "createdAt": "2020-03-30T07:46:37Z", "commit": {"oid": "b567df3a2a797e21489598f59e93a1db97085201"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzo0NjozN1rOF9dXFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzo0NjozN1rOF9dXFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4ODUwMw==", "bodyText": "Concider using the SortOrder type?\ndhis-2/dhis-api/src/main/java/org/hisp/dhis/analytics/SortOrder.java", "url": "https://github.com/dhis2/dhis2-core/pull/5195#discussion_r399988503", "createdAt": "2020-03-30T07:46:37Z", "author": {"login": "Bekkalizer"}, "path": "dhis-2/dhis-services/dhis-service-analytics/src/main/java/org/hisp/dhis/analytics/event/data/AbstractJdbcEventAnalyticsManager.java", "diffHunk": "@@ -134,19 +141,29 @@ private String getSortClause( EventQueryParams params )\n \n         if ( params.isSorting() )\n         {\n-            sql += \"order by \";\n+            sql += \"order by \" + getSortColumns( params, \"asc\" ) + getSortColumns( params, \"desc\" );\n \n-            for ( DimensionalItemObject item : params.getAsc() )\n+            sql = TextUtils.removeLastComma( sql ) + \" \";\n+        }\n+\n+        return sql;\n+    }\n+\n+    private String getSortColumns(EventQueryParams params , String order) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b567df3a2a797e21489598f59e93a1db97085201"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18ac3e710e878c3e5e2aa8b5446e28f43c15a641", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/18ac3e710e878c3e5e2aa8b5446e28f43c15a641", "committedDate": "2020-03-30T08:00:57Z", "message": "chore: style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNjgwMTE2", "url": "https://github.com/dhis2/dhis2-core/pull/5195#pullrequestreview-383680116", "createdAt": "2020-03-30T09:30:47Z", "commit": {"oid": "18ac3e710e878c3e5e2aa8b5446e28f43c15a641"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNzI3ODQ2", "url": "https://github.com/dhis2/dhis2-core/pull/5195#pullrequestreview-383727846", "createdAt": "2020-03-30T10:35:43Z", "commit": {"oid": "18ac3e710e878c3e5e2aa8b5446e28f43c15a641"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2766, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}