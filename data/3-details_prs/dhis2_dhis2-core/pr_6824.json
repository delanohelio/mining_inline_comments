{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxOTkzNjkz", "number": 6824, "title": "fix: Tracker Identifiers resolution during Tracker import", "bodyText": "This PR simplifies the way the TrackerPreheat object keeps track of metadata objects during the Tracker Import.\nRather than keeping track of the TrackerIdScheme associated to each class of object, the system now simply uses a Map where the key is the class type (e.g. Program) and the value is a Map of object key and pre-heated object.\nAssuming that IdScheme CODE is used for Program, the data is structred like so:\nProgram.class -->  CODE_1 -> Program 1\n                   CODE_2 -> Program 2\n                   CODE_3 -> Program 3\n\n\nBy using this simplified data structure, the pre-heated object can be simply fetched by using the id used in the payload (uid, code, etc.), without having to specify the TrackerIdScheme on TrackerPreheat.get().\nAdditionally, this PR fixes a serialization issue with the TrackerIdentifierParams, which was not serialized correctly to Json and \"broke\" the propagation of IdScheme to the Import Service.\nref: DHIS2-9895", "createdAt": "2020-12-03T18:38:36Z", "url": "https://github.com/dhis2/dhis2-core/pull/6824", "merged": true, "mergeCommit": {"oid": "699074cbe82db1a8e0a5e72edf2a981f3628b54b"}, "closed": true, "closedAt": "2020-12-07T09:47:48Z", "author": {"login": "luciano-fiandesio"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdinlxggH2gAyNTMxOTkzNjkzOjVlOGI4Y2I0NDQ3ODU0ZjExZGU4NGI0NzhiZGQyZjI0MDVjMjc3MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjyZU1AFqTU0NTk4MTQzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5e8b8cb4447854f11de84b478bdd2f2405c27719", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/5e8b8cb4447854f11de84b478bdd2f2405c27719", "committedDate": "2020-12-03T18:38:13Z", "message": "fix: Tracker Identifiers resolution during Tracker import\n\nThis PR simplifies the way the `TrackerPreheat` object keeps track of metadata objects during the Tracker Import.\nRather than keeping track of the `TrackerIdScheme` associated to each class of object, the system now simply uses a `Map` where\nthe key is the class type (e.g. `Program`) and the value is a `Map` of object key and pre-heated object.\n\nAssuming that IdScheme `CODE` is used for `Program`, the data is structred like so:\n\n```\nProgram.class -->  CODE_1 -> Program 1\n                   CODE_2 -> Program 2\n                   CODE_3 -> Program 3\n\n```\n\nBy using this simplified data structred, the pre-heated object can be simply fetched by using the id used in the payload, without having to specify the `TrackerIdScheme`.\n\nAdditionally, this PR fixes a serialization issue with the `TrackerIdentifierParams`, which was not serialized correctly to Json and\n\"broke\" the propagation of IdScheme to the Import Service.\n\nref: DHIS2-9895"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70c38ac13bcc86c330d17ebcd71af9ba50c139f4", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/70c38ac13bcc86c330d17ebcd71af9ba50c139f4", "committedDate": "2020-12-03T18:40:13Z", "message": "chore: remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a34158669143336d5a9c16e4f09c4c3380131d20", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a34158669143336d5a9c16e4f09c4c3380131d20", "committedDate": "2020-12-03T18:54:34Z", "message": "fix: compilation error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NzQ2Njk3", "url": "https://github.com/dhis2/dhis2-core/pull/6824#pullrequestreview-544746697", "createdAt": "2020-12-04T08:30:41Z", "commit": {"oid": "a34158669143336d5a9c16e4f09c4c3380131d20"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTgwNjM4", "url": "https://github.com/dhis2/dhis2-core/pull/6824#pullrequestreview-545980638", "createdAt": "2020-12-07T09:46:29Z", "commit": {"oid": "a34158669143336d5a9c16e4f09c4c3380131d20"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwOTo0NjozMFrOIAeNlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwOTo0NjozMFrOIAeNlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM2NTkxMQ==", "bodyText": "AUTO should just be UID as far as I know.", "url": "https://github.com/dhis2/dhis2-core/pull/6824#discussion_r537365911", "createdAt": "2020-12-07T09:46:30Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/preheat/TrackerPreheat.java", "diffHunk": "@@ -687,4 +552,24 @@ public String toString()\n             .toString();\n     }\n \n+    private <T extends IdentifiableObject> Optional<String> resolveKey( TrackerIdentifier identifier, T object )\n+    {\n+        if ( identifier.getIdScheme().equals( TrackerIdScheme.UID ) )\n+        {\n+            return Optional.ofNullable( object.getUid() );\n+        }\n+        else if ( identifier.getIdScheme().equals( TrackerIdScheme.CODE ) )\n+        {\n+            return Optional.ofNullable( object.getCode() );\n+        }\n+        else if ( identifier.getIdScheme().equals( TrackerIdScheme.ATTRIBUTE ) )\n+        {\n+            return Optional.ofNullable( identifier.getIdentifier( object ) );\n+        }\n+        // TODO TrackerIdScheme.AUTO ??", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a34158669143336d5a9c16e4f09c4c3380131d20"}, "originalPosition": 277}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTgxNDM3", "url": "https://github.com/dhis2/dhis2-core/pull/6824#pullrequestreview-545981437", "createdAt": "2020-12-07T09:47:30Z", "commit": {"oid": "a34158669143336d5a9c16e4f09c4c3380131d20"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2257, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}