{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MTIxNTc0", "number": 5897, "title": "fix: Error importing data values in first time", "bodyText": "https://jira.dhis2.org/browse/DHIS2-7539\nIssue in in dataValueSet api.\n\nIf the payload includes a period that doesn't exist in DB, then we have the function reloadAndForceAddPeriod to handle it.\nHowever the newly added Period is flushed to DB after the dataValuesBatchHandler.flush() Which leads to a foreign key constraint error\n\n=> This  fix will create a StatelessSession for adding the new Period and sync it with DB immediately. Instead of using the current session.", "createdAt": "2020-08-09T08:02:10Z", "url": "https://github.com/dhis2/dhis2-core/pull/5897", "merged": true, "mergeCommit": {"oid": "90901175e50aec4f96b33b6c9137a15538f7c729"}, "closed": true, "closedAt": "2020-08-14T11:15:13Z", "author": {"login": "vietnguyen"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9c_LsgBqjM2Mzc1MjMwMjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-yuD2gFqTQ2NzQ5NjgzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2c31803ec4eeb5f0caa7402577798c731854e31", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a2c31803ec4eeb5f0caa7402577798c731854e31", "committedDate": "2020-08-09T07:53:50Z", "message": "fix: Error importing data values in first time."}, "afterCommit": {"oid": "139adfb52037addfaf328b30a88266dc25e0d302", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/139adfb52037addfaf328b30a88266dc25e0d302", "committedDate": "2020-08-10T07:21:26Z", "message": "fix: Error importing data values in first time."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "139adfb52037addfaf328b30a88266dc25e0d302", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/139adfb52037addfaf328b30a88266dc25e0d302", "committedDate": "2020-08-10T07:21:26Z", "message": "fix: Error importing data values in first time."}, "afterCommit": {"oid": "799119efed0dd0f7e0c832d474c8be6dbefb4ce0", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/799119efed0dd0f7e0c832d474c8be6dbefb4ce0", "committedDate": "2020-08-10T09:23:46Z", "message": "fix: Error importing data values in first time."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1OTkzMjc0", "url": "https://github.com/dhis2/dhis2-core/pull/5897#pullrequestreview-465993274", "createdAt": "2020-08-12T14:50:12Z", "commit": {"oid": "799119efed0dd0f7e0c832d474c8be6dbefb4ce0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDo1MDoxM1rOG_k4SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDo1MDoxM1rOG_k4SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMxNzcwNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.periodService = new DefaultPeriodService(periodStore, sessionFactory);\n          \n          \n            \n                    this.periodService = new DefaultPeriodService( periodStore, sessionFactory );", "url": "https://github.com/dhis2/dhis2-core/pull/5897#discussion_r469317704", "createdAt": "2020-08-12T14:50:13Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-validation/src/test/java/org/hisp/dhis/validation/ValidationNotificationServiceTest.java", "diffHunk": "@@ -134,7 +139,7 @@ public void initTest()\n \n         subject = new DefaultValidationNotificationService(renderer, messageService, validationResultService);\n \n-        this.periodService = new DefaultPeriodService(periodStore);\n+        this.periodService = new DefaultPeriodService(periodStore, sessionFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799119efed0dd0f7e0c832d474c8be6dbefb4ce0"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1OTkzMzQ5", "url": "https://github.com/dhis2/dhis2-core/pull/5897#pullrequestreview-465993349", "createdAt": "2020-08-12T14:50:18Z", "commit": {"oid": "799119efed0dd0f7e0c832d474c8be6dbefb4ce0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NDE2NzQy", "url": "https://github.com/dhis2/dhis2-core/pull/5897#pullrequestreview-467416742", "createdAt": "2020-08-14T08:57:23Z", "commit": {"oid": "799119efed0dd0f7e0c832d474c8be6dbefb4ce0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo1NzoyM1rOHAtC3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwODo1NzoyM1rOHAtC3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwMDA2MQ==", "bodyText": "Ideally, the close statement should have its own try-finally block, as the commit operation might also fail, leaving the session open. Perhaps move those two statements to a utility method.", "url": "https://github.com/dhis2/dhis2-core/pull/5897#discussion_r470500061", "createdAt": "2020-08-14T08:57:23Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/period/DefaultPeriodService.java", "diffHunk": "@@ -284,6 +296,53 @@ public Period reloadPeriod( Period period )\n     {\n         return periodStore.reloadForceAddPeriod( period );\n     }\n+\n+    /**\n+     * Fix issue DHIS2-7539\n+     * If period doesn't exist in cache and database.\n+     * Need to add and sync with database right away in a separate session/transaction.\n+     * Otherwise will get foreign key constraint error in subsequence calls of batch.flush()\n+     **/\n+    @Override\n+    @Transactional(readOnly = true)\n+    public Period reloadIsoPeriodInStatelessSession( String isoPeriod )\n+    {\n+        Period period = PeriodType.getPeriodFromIsoString( isoPeriod );\n+\n+        if ( period == null )\n+        {\n+            return null;\n+        }\n+\n+        Period reloadedPeriod = periodStore.reloadPeriod( period );\n+\n+        if ( reloadedPeriod != null )\n+        {\n+            return reloadedPeriod;\n+        }\n+\n+        StatelessSession session = sessionFactory.openStatelessSession();\n+        session.beginTransaction();\n+        try\n+        {\n+            period.setPeriodType( reloadPeriodType( period.getPeriodType() ) );\n+\n+            session.insert( period );\n+\n+            return period;\n+        }\n+        catch ( Exception exception )\n+        {\n+            log.error( DebugUtils.getStackTrace( exception ) );\n+        }\n+        finally\n+        {\n+            session.getTransaction().commit();\n+            session.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799119efed0dd0f7e0c832d474c8be6dbefb4ce0"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9217289639e8460d36d7ea6f4b737e5abe04e9dc", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/9217289639e8460d36d7ea6f4b737e5abe04e9dc", "committedDate": "2020-08-14T10:35:13Z", "message": "fix: Error importing data values in first time."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "799119efed0dd0f7e0c832d474c8be6dbefb4ce0", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/799119efed0dd0f7e0c832d474c8be6dbefb4ce0", "committedDate": "2020-08-10T09:23:46Z", "message": "fix: Error importing data values in first time."}, "afterCommit": {"oid": "9217289639e8460d36d7ea6f4b737e5abe04e9dc", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/9217289639e8460d36d7ea6f4b737e5abe04e9dc", "committedDate": "2020-08-14T10:35:13Z", "message": "fix: Error importing data values in first time."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NDc5NDM3", "url": "https://github.com/dhis2/dhis2-core/pull/5897#pullrequestreview-467479437", "createdAt": "2020-08-14T10:41:00Z", "commit": {"oid": "9217289639e8460d36d7ea6f4b737e5abe04e9dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NDk2ODMz", "url": "https://github.com/dhis2/dhis2-core/pull/5897#pullrequestreview-467496833", "createdAt": "2020-08-14T11:14:57Z", "commit": {"oid": "9217289639e8460d36d7ea6f4b737e5abe04e9dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2596, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}