{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNzExMjYz", "number": 5706, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjozNzoyOFrOED2u5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjo1OTowMlrOED3S2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDc3OTI3OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/AggregateAuditConsumer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjozNzoyOFrOGhHeQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjozNzoyOFrOGhHeQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3ODYyNA==", "bodyText": "Use DhisConfigurationProvider#isEnabled to check if \"on\".", "url": "https://github.com/dhis2/dhis2-core/pull/5706#discussion_r437378624", "createdAt": "2020-06-09T12:37:28Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/AggregateAuditConsumer.java", "diffHunk": "@@ -28,38 +28,42 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import com.fasterxml.jackson.annotation.JsonProperty;\n-import com.fasterxml.jackson.dataformat.xml.annotation.JacksonXmlProperty;\n-import com.fasterxml.jackson.dataformat.xml.annotation.JacksonXmlRootElement;\n-import org.hisp.dhis.common.DxfNamespaces;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.extern.slf4j.Slf4j;\n+import org.hisp.dhis.artemis.Topics;\n+import org.hisp.dhis.audit.AbstractAuditConsumer;\n+import org.hisp.dhis.audit.AuditService;\n+import org.hisp.dhis.external.conf.ConfigurationKey;\n+import org.hisp.dhis.external.conf.DhisConfigurationProvider;\n+import org.springframework.jms.annotation.JmsListener;\n+import org.springframework.stereotype.Component;\n+\n+import javax.jms.TextMessage;\n+import java.util.Objects;\n \n /**\n- * @author Morten Olav Hansen <mortenoh@gmail.com>\n+ * A Aggregate object consumer.\n  */\n-@JacksonXmlRootElement( localName = \"metadataAudit\", namespace = DxfNamespaces.DXF_2_0 )\n-public class MetadataAudit\n+@Slf4j\n+@Component\n+public class AggregateAuditConsumer\n+    extends AbstractAuditConsumer\n {\n-    private boolean log;\n-\n-    public MetadataAudit()\n-    {\n-    }\n-\n-    public MetadataAudit( boolean log )\n+    public AggregateAuditConsumer(\n+        AuditService auditService,\n+        ObjectMapper objectMapper,\n+        DhisConfigurationProvider dhisConfig )\n     {\n-        this.log = log;\n-    }\n+        this.auditService = auditService;\n+        this.objectMapper = objectMapper;\n \n-    @JsonProperty\n-    @JacksonXmlProperty( namespace = DxfNamespaces.DXF_2_0 )\n-    public boolean isLog()\n-    {\n-        return log;\n+        this.isAuditLogEnabled = Objects.equals( dhisConfig.getProperty( ConfigurationKey.AUDIT_LOGGER ), \"on\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0315ee2cc73a336a794dc3e8ba6a0786c431f424"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDc3OTk0OnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/MetadataAuditConsumer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjozNzo0MFrOGhHesg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjozNzo0MFrOGhHesg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3ODczOA==", "bodyText": "Use DhisConfigurationProvider#isEnabled to check if \"on\".", "url": "https://github.com/dhis2/dhis2-core/pull/5706#discussion_r437378738", "createdAt": "2020-06-09T12:37:40Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/MetadataAuditConsumer.java", "diffHunk": "@@ -67,42 +59,13 @@ public MetadataAuditConsumer(\n         this.auditService = auditService;\n         this.objectMapper = objectMapper;\n \n-        this.metadataAuditLog = Objects.equals( dhisConfig.getProperty( ConfigurationKey.METADATA_AUDIT_LOG ), \"on\" );\n+        this.isAuditLogEnabled = Objects.equals( dhisConfig.getProperty( ConfigurationKey.AUDIT_LOGGER ), \"on\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0315ee2cc73a336a794dc3e8ba6a0786c431f424"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDg3MTMxOnYy", "diffSide": "RIGHT", "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/TrackerAuditConsumer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjo1OTowMlrOGhIW8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjo1OTowMlrOGhIW8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM5MzEzOA==", "bodyText": "Use getPropertyOrDefault.", "url": "https://github.com/dhis2/dhis2-core/pull/5706#discussion_r437393138", "createdAt": "2020-06-09T12:59:02Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/TrackerAuditConsumer.java", "diffHunk": "@@ -28,60 +28,43 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import java.io.IOException;\n-\n-import javax.jms.TextMessage;\n-\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import org.hisp.dhis.artemis.Topics;\n-import org.hisp.dhis.artemis.audit.Audit;\n-import org.hisp.dhis.audit.AuditConsumer;\n+import org.hisp.dhis.audit.AbstractAuditConsumer;\n import org.hisp.dhis.audit.AuditService;\n-import org.hisp.dhis.render.RenderService;\n+import org.hisp.dhis.external.conf.ConfigurationKey;\n+import org.hisp.dhis.external.conf.DhisConfigurationProvider;\n import org.springframework.jms.annotation.JmsListener;\n import org.springframework.stereotype.Component;\n \n-import lombok.extern.slf4j.Slf4j;\n+import javax.jms.TextMessage;\n+import java.util.Objects;\n \n /**\n- * Tracker audits consumer.\n+ * Tracker audit consumer.\n  *\n  * @author Morten Olav Hansen <morten@dhis2.org>\n  */\n-@Slf4j\n @Component\n-public class TrackerAuditConsumer implements AuditConsumer\n+public class TrackerAuditConsumer\n+    extends AbstractAuditConsumer\n {\n-    private final AuditService auditService;\n-    private final RenderService renderService;\n-\n     public TrackerAuditConsumer(\n-        AuditService auditService, RenderService renderService )\n+        AuditService auditService,\n+        ObjectMapper objectMapper,\n+        DhisConfigurationProvider dhisConfig )\n     {\n         this.auditService = auditService;\n-        this.renderService = renderService;\n+        this.objectMapper = objectMapper;\n+\n+        // for legacy reasons we are overriding the default here and using \"off\" for tracking logger (we don't have a specific key for tracker logger)\n+        this.isAuditLogEnabled = Objects.equals( dhisConfig.getProperty( ConfigurationKey.AUDIT_LOGGER ), \"off\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c71549b5646dddf2658a07fbec83d61e98d691"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3361, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}