{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNjE4MjU2", "number": 6683, "title": "fix: invalid detection of duplicated relationships during Tracker import", "bodyText": "This PR introduces a new Tracker Import PreProcessor to remove duplicated relationship from the\nTracker payload (Tracker Bundle). The duplicated relationship logic is detailed here: https://jira.dhis2.org/browse/DHIS2-9965\nAdditionally, the Relationship validation code (RelationshipsValidationHook) has been improved to better report invalid relationships.\n\nMissing \"from\" returns 4007 code and message \"Missing required relationship property: 'from'.\"\nMissing \"to\" returns 4008 code and message \"Missing required relationship property: 'to'.\"\nMissing \"relationshipType\" returns 4004 code and message \"Missing required relationship property: 'relationshipType'.\"\nInvalid \"relationshipType\" returns 4009 code and message \"Relationship Type {0} is not valid.\" - where 0 corresponds to the relationship type uid\nOn invalid Relationship constraint (based on the Relationship Type) the system returns 4010 code and message: \"\"Relationship Type {0} constraint requires a {1} but a {2} was found.\"\nOn multiple value provided for a Relationship Item (e.g. trackerEntity and Enrollment) the system returns E4001 and message: \"Relationship Item {0} for Relationship {1} is invalid: an Item can link only one Tracker entity.\" where {0} is from|to, {1} is the relationship uid\n\nFinally, the constraint and \"self-reference\" validation only takes place if the required data validation has no errrors.\nREF: DHIS2-9965", "createdAt": "2020-11-16T12:01:23Z", "url": "https://github.com/dhis2/dhis2-core/pull/6683", "merged": true, "mergeCommit": {"oid": "77ddd2e97bab29df8fa6b5656ddfeeba06cdf4d5"}, "closed": true, "closedAt": "2020-11-16T14:21:17Z", "author": {"login": "luciano-fiandesio"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddDt9KgH2gAyNTIxNjE4MjU2OjBhZDFhOTMwZDEyYjU4MGZhZWI5OTQ0YWM1YmVkYjE5Y2FiYzkyYTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddFkTYgFqTUzMTM1MzAzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ad1a930d12b580faeb9944ac5bedb19cabc92a0", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/0ad1a930d12b580faeb9944ac5bedb19cabc92a0", "committedDate": "2020-11-16T12:00:57Z", "message": "fix: invalid detection of duplicated relationships during Tracker import\n\nThis PR introduces a new Tracker Import PreProcessor to remove duplicated relationship from the\nTracker payload (Tracker Bundle). The duplicated relationship logic is detailed here: https://jira.dhis2.org/browse/DHIS2-9965\n\nAdditionally, the Relationship validation code (`RelationshipsValidationHook`) has been improved to better report invalid relationships.\n\n- Missing \"from\" returns `4007` code and message \"Missing required relationship property: 'from'.\"\n- Missing \"to\" returns `4008` code and message \"Missing required relationship property: 'to'.\"\n- Missing \"relationshipType\" returns `4004` code and message \"Missing required relationship property: 'relationshipType'.\"\n- Invalid \"relationshipType\" returns `4009` code and message \"Relationship Type `{0}` is not valid.\" - where 0 corresponds to the relationship type uid\n- On invalid Relationship constraint (based on the Relationship Type) the system returns `4010` code and message: \"\"Relationship Type `{0}` constraint requires a {1} but a {2} was found.\"\n\nFinally, the constraint and \"self-reference\" validation only takes place if the required data validation has no errrors.\n\nREF: DHIS2-9965"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7998fc91636b2383831507741c75ad36e173db75", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/7998fc91636b2383831507741c75ad36e173db75", "committedDate": "2020-11-16T12:04:03Z", "message": "chore: javadoc typos"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMjcyOTE2", "url": "https://github.com/dhis2/dhis2-core/pull/6683#pullrequestreview-531272916", "createdAt": "2020-11-16T12:25:33Z", "commit": {"oid": "7998fc91636b2383831507741c75ad36e173db75"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjoyNTozM1rOHz7lXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjoyOToyMVrOHz702g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIxNTY0Nw==", "bodyText": "Here we use \"get\"+\"From\"/\"To\", while further down we just use \"relationshipType\", maybe we should omit the \"get\" part? Looks better in my opinion:\nrelationship.from, relationship.to, relationship.relationshiptype", "url": "https://github.com/dhis2/dhis2-core/pull/6683#discussion_r524215647", "createdAt": "2020-11-16T12:25:33Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/RelationshipsValidationHook.java", "diffHunk": "@@ -89,37 +87,57 @@ public void validateRelationship( ValidationErrorReporter reporter, Relationship\n             return;\n         }\n \n-        validateRelationshipType( reporter, relationship, bundle.getPreheat() );\n-        validateAutoRelationship( reporter, relationship );\n-        validateBidirectionalDuplicatedRelationships( reporter, bundle, relationship );\n+        boolean isValid = validateMandatoryData( reporter, relationship,\n+            bundle.getPreheat().getAll( TrackerIdScheme.UID, RelationshipType.class ) );\n+\n+        // No need to check additional data if there are missing information on the\n+        // Relationship\n+        if ( isValid )\n+        {\n+            validateRelationshipConstraint( reporter, relationship, bundle );\n+\n+            validateAutoRelationship( reporter, relationship );\n+\n+            // validateReferences( reporter, bundle, relationship); // TODO Enrico\n+        }\n+\n     }\n \n-    private void validateBidirectionalDuplicatedRelationships( ValidationErrorReporter reporter, TrackerBundle bundle,\n-        Relationship relationship )\n+    private void validateRelationshipConstraint( ValidationErrorReporter reporter, Relationship relationship,\n+        TrackerBundle bundle )\n     {\n-        List<Pair<RelationshipItem, RelationshipItem>> relationships =\n-            bundle.getRelationships()\n-                .stream()\n-                .map( r -> new ImmutablePair<>( r.getFrom(), r.getTo() ) )\n-                .collect( Collectors.toList() );\n+        getRelationshipType( bundle.getPreheat().getAll( TrackerIdScheme.UID, RelationshipType.class ),\n+            relationship.getRelationshipType() ).ifPresent( relationshipType -> {\n+\n+                validateRelationshipConstraint( \"from\", relationship.getFrom(), relationshipType.getFromConstraint() )\n+                    .forEach( reporter::addError );\n+                validateRelationshipConstraint( \"to\", relationship.getTo(), relationshipType.getToConstraint() )\n+                    .forEach( reporter::addError );\n \n-        List<ImmutablePair<RelationshipItem, RelationshipItem>> bidirectionalRelationship = Lists\n-            .newArrayList( relationship )\n-            .stream()\n-            .filter( Relationship::isBidirectional )\n-            .map( r -> new ImmutablePair<>( r.getTo(), r.getFrom() ) )\n-            .collect( Collectors.toList() );\n+            } );\n+    }\n \n-        relationships.addAll( bidirectionalRelationship );\n+    private boolean validateMandatoryData( ValidationErrorReporter reporter, Relationship relationship,\n+        List<RelationshipType> relationshipsTypes )\n+    {\n+        addErrorIfNull( relationship.getFrom(), reporter, E4007, \"relationship.getFrom\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7998fc91636b2383831507741c75ad36e173db75"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIxOTYxMA==", "bodyText": "This is just a note, more than feedback:\nI was thinking we have to validate that wrong values are not inserted as well (IE. tei inserted, when constraint is EVENT).\nHowever, we actually ignore other values when comitting, so I say we don't add that validation, unless you think it makes sense to report sending too much data (wrong data is already covered, assuming wrong data = wrong constraint type)", "url": "https://github.com/dhis2/dhis2-core/pull/6683#discussion_r524219610", "createdAt": "2020-11-16T12:29:21Z", "author": {"login": "stian-sandvold"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/RelationshipsValidationHook.java", "diffHunk": "@@ -130,128 +148,58 @@ private void validateAutoRelationship( ValidationErrorReporter reporter, Relatio\n         }\n     }\n \n-    private void validateRelationshipType( ValidationErrorReporter reporter,\n-        Relationship relationship, TrackerPreheat preheat )\n+    private String relationshipItemValueType( RelationshipItem item )\n     {\n-        List<RelationshipType> relationshipsTypes = preheat.getAll( TrackerIdScheme.UID, RelationshipType.class );\n-        Optional<RelationshipType> optionalRelationshipType = relationshipsTypes.stream()\n-            .filter( type -> type.getUid().equals( relationship.getRelationshipType() ) ).findFirst();\n-\n-        if ( !optionalRelationshipType.isPresent() )\n-        {\n-            addError( reporter, E4004, RELATIONSHIP_TYPE );\n-            return;\n-        }\n-\n-        if ( relationship.getFrom() == null )\n+        if ( StringUtils.isNotEmpty( item.getTrackedEntity() ) )\n         {\n-            addError( reporter, E4004, \"relationship.getFrom\" );\n+            return TRACKED_ENTITY;\n         }\n-        else\n-        {\n-            optionalRelationshipType\n-                .ifPresent( relationshipType -> validateRelationshipConstraint( relationship.getFrom(),\n-                    relationshipType.getFromConstraint() )\n-                        .stream()\n-                        .forEach( reporter::addError ) );\n-        }\n-\n-        if ( relationship.getTo() == null )\n+        else if ( StringUtils.isNotEmpty( item.getEnrollment() ) )\n         {\n-            addError( reporter, E4004, \"relationship.getTo\" );\n+            return ENROLLMENT;\n         }\n-        else\n+        else if ( StringUtils.isNotEmpty( item.getEvent() ) )\n         {\n-            if ( optionalRelationshipType.isPresent() )\n-            {\n-                validateRelationshipConstraint( relationship.getTo(),\n-                    optionalRelationshipType.get().getToConstraint() )\n-                    .stream()\n-                    .forEach( reporter::addError );\n-                ;\n-            }\n+            return EVENT;\n         }\n-\n+        return null;\n     }\n \n-    private List<TrackerErrorReport.TrackerErrorReportBuilder> validateRelationshipConstraint( RelationshipItem item,\n-        RelationshipConstraint relationshipType )\n+    private List<TrackerErrorReport.TrackerErrorReportBuilder> validateRelationshipConstraint( String relSide,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7998fc91636b2383831507741c75ad36e173db75"}, "originalPosition": 191}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMjc2NTkz", "url": "https://github.com/dhis2/dhis2-core/pull/6683#pullrequestreview-531276593", "createdAt": "2020-11-16T12:30:44Z", "commit": {"oid": "7998fc91636b2383831507741c75ad36e173db75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjozMDo0NFrOHz76zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjozMDo0NFrOHz76zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyMTEzNQ==", "bodyText": "Could not find RelationShipType: {0}.\"  -> can you change to relationshipType?", "url": "https://github.com/dhis2/dhis2-core/pull/6683#discussion_r524221135", "createdAt": "2020-11-16T12:30:44Z", "author": {"login": "vilkg"}, "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/report/TrackerErrorCode.java", "diffHunk": "@@ -145,11 +145,14 @@\n     E4000( \"Relationship: `{0}` cannot link to itself\" ),\n     E4001( \"Property `{0}` can not be set when property `{1}` is `{2}`. \" ),\n     E4002( \"Property `{0}` must be set when property `{1}` is `{2}`. \" ),\n-    E4003( \"There are duplicated relationships. \" ),\n-    E4004( \"Missing required property: 'relationshipType'.\" ),\n+    E4003( \"There are duplicated relationships.\" ),\n+    E4004( \"Missing required relationship property: 'relationshipType'.\" ),\n     E4005( \"RelationShip: `{0}`, do not exist.\" ),\n     E4006( \"Could not find RelationShipType: `{0}`.\"  ),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7998fc91636b2383831507741c75ad36e173db75"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ae54c1614a686be734a54a8b3dfeb1b7a92c7d1", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/2ae54c1614a686be734a54a8b3dfeb1b7a92c7d1", "committedDate": "2020-11-16T13:05:48Z", "message": "fix: fixed unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb8d1660c359b6e303794110bb9c3268484e8c19", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/cb8d1660c359b6e303794110bb9c3268484e8c19", "committedDate": "2020-11-16T13:31:46Z", "message": "chore: removed comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMzUzMDMz", "url": "https://github.com/dhis2/dhis2-core/pull/6683#pullrequestreview-531353033", "createdAt": "2020-11-16T14:10:13Z", "commit": {"oid": "cb8d1660c359b6e303794110bb9c3268484e8c19"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2275, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}