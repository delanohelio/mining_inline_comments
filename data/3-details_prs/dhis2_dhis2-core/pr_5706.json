{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNzExMjYz", "number": 5706, "title": "feat: support enabling/disabling audit logging/database", "bodyText": "Adds 2 new audit configuration keys to enable or disable logging (using slf4j) and saving to database, using keys audit.logger = on/off and audit.database = on/off.\nThis allows you to disable both logger and database completely, but still have the audit message sent out on the artemis topic.", "createdAt": "2020-06-09T11:02:00Z", "url": "https://github.com/dhis2/dhis2-core/pull/5706", "merged": true, "mergeCommit": {"oid": "7f2d109e885cab9a5664e75431468634336c2bf6"}, "closed": true, "closedAt": "2020-06-09T13:14:30Z", "author": {"login": "mortenoh"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpiTQdgH2gAyNDMxNzExMjYzOmQzMzAzMjliYmY5N2E1ZjA4NTQ5N2Y3OTdkZDljNzJmNmMyNDk2MTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpk3YXgFqTQyNzEzMDA3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d330329bbf97a5f085497f797dd9c72f6c249613", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d330329bbf97a5f085497f797dd9c72f6c249613", "committedDate": "2020-06-09T10:14:47Z", "message": "fix: inject ObjectMapper instead of RenderService in TrackerAuditConsumer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df4e9b5643741fc078a8a046e7ae5b0332efd46d", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/df4e9b5643741fc078a8a046e7ae5b0332efd46d", "committedDate": "2020-06-09T10:23:23Z", "message": "fix: adds configuration props for enabling/disabling logging/persistence  in the audit consumer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bb37d3f1d2459e2fe6f394d3f420eecc3d244db", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/5bb37d3f1d2459e2fe6f394d3f420eecc3d244db", "committedDate": "2020-06-09T11:00:25Z", "message": "feat: support enabling disabling globally audit logging/database"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "743a972292ebcb8f10e4cea8d1e2257346c2e14a", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/743a972292ebcb8f10e4cea8d1e2257346c2e14a", "committedDate": "2020-06-09T11:04:06Z", "message": "fix: don't serialize audit data if its already string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e81410ef4253a987d34850ae01946a91288c9bd3", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/e81410ef4253a987d34850ae01946a91288c9bd3", "committedDate": "2020-06-09T11:14:36Z", "message": "chore: clean up old audit logger configuration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDg2NDA0", "url": "https://github.com/dhis2/dhis2-core/pull/5706#pullrequestreview-427086404", "createdAt": "2020-06-09T12:24:30Z", "commit": {"oid": "e81410ef4253a987d34850ae01946a91288c9bd3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0315ee2cc73a336a794dc3e8ba6a0786c431f424", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/0315ee2cc73a336a794dc3e8ba6a0786c431f424", "committedDate": "2020-06-09T12:35:47Z", "message": "refactor: move out common pieces from AuditConsumers into AbstractAuditConsumer, moves consumers from legacy to consumers package"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDk2MjE4", "url": "https://github.com/dhis2/dhis2-core/pull/5706#pullrequestreview-427096218", "createdAt": "2020-06-09T12:37:28Z", "commit": {"oid": "0315ee2cc73a336a794dc3e8ba6a0786c431f424"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjozNzoyOFrOGhHeQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjozNzoyOFrOGhHeQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3ODYyNA==", "bodyText": "Use DhisConfigurationProvider#isEnabled to check if \"on\".", "url": "https://github.com/dhis2/dhis2-core/pull/5706#discussion_r437378624", "createdAt": "2020-06-09T12:37:28Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/AggregateAuditConsumer.java", "diffHunk": "@@ -28,38 +28,42 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import com.fasterxml.jackson.annotation.JsonProperty;\n-import com.fasterxml.jackson.dataformat.xml.annotation.JacksonXmlProperty;\n-import com.fasterxml.jackson.dataformat.xml.annotation.JacksonXmlRootElement;\n-import org.hisp.dhis.common.DxfNamespaces;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.extern.slf4j.Slf4j;\n+import org.hisp.dhis.artemis.Topics;\n+import org.hisp.dhis.audit.AbstractAuditConsumer;\n+import org.hisp.dhis.audit.AuditService;\n+import org.hisp.dhis.external.conf.ConfigurationKey;\n+import org.hisp.dhis.external.conf.DhisConfigurationProvider;\n+import org.springframework.jms.annotation.JmsListener;\n+import org.springframework.stereotype.Component;\n+\n+import javax.jms.TextMessage;\n+import java.util.Objects;\n \n /**\n- * @author Morten Olav Hansen <mortenoh@gmail.com>\n+ * A Aggregate object consumer.\n  */\n-@JacksonXmlRootElement( localName = \"metadataAudit\", namespace = DxfNamespaces.DXF_2_0 )\n-public class MetadataAudit\n+@Slf4j\n+@Component\n+public class AggregateAuditConsumer\n+    extends AbstractAuditConsumer\n {\n-    private boolean log;\n-\n-    public MetadataAudit()\n-    {\n-    }\n-\n-    public MetadataAudit( boolean log )\n+    public AggregateAuditConsumer(\n+        AuditService auditService,\n+        ObjectMapper objectMapper,\n+        DhisConfigurationProvider dhisConfig )\n     {\n-        this.log = log;\n-    }\n+        this.auditService = auditService;\n+        this.objectMapper = objectMapper;\n \n-    @JsonProperty\n-    @JacksonXmlProperty( namespace = DxfNamespaces.DXF_2_0 )\n-    public boolean isLog()\n-    {\n-        return log;\n+        this.isAuditLogEnabled = Objects.equals( dhisConfig.getProperty( ConfigurationKey.AUDIT_LOGGER ), \"on\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0315ee2cc73a336a794dc3e8ba6a0786c431f424"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDk2Mzg4", "url": "https://github.com/dhis2/dhis2-core/pull/5706#pullrequestreview-427096388", "createdAt": "2020-06-09T12:37:40Z", "commit": {"oid": "0315ee2cc73a336a794dc3e8ba6a0786c431f424"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjozNzo0MFrOGhHesg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjozNzo0MFrOGhHesg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3ODczOA==", "bodyText": "Use DhisConfigurationProvider#isEnabled to check if \"on\".", "url": "https://github.com/dhis2/dhis2-core/pull/5706#discussion_r437378738", "createdAt": "2020-06-09T12:37:40Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/MetadataAuditConsumer.java", "diffHunk": "@@ -67,42 +59,13 @@ public MetadataAuditConsumer(\n         this.auditService = auditService;\n         this.objectMapper = objectMapper;\n \n-        this.metadataAuditLog = Objects.equals( dhisConfig.getProperty( ConfigurationKey.METADATA_AUDIT_LOG ), \"on\" );\n+        this.isAuditLogEnabled = Objects.equals( dhisConfig.getProperty( ConfigurationKey.AUDIT_LOGGER ), \"on\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0315ee2cc73a336a794dc3e8ba6a0786c431f424"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05c71549b5646dddf2658a07fbec83d61e98d691", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/05c71549b5646dddf2658a07fbec83d61e98d691", "committedDate": "2020-06-09T12:45:11Z", "message": "fix: use dhisConfig.isEnabled(..) to check audit logging/database config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTE2ODM0", "url": "https://github.com/dhis2/dhis2-core/pull/5706#pullrequestreview-427116834", "createdAt": "2020-06-09T12:59:02Z", "commit": {"oid": "05c71549b5646dddf2658a07fbec83d61e98d691"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjo1OTowMlrOGhIW8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMjo1OTowMlrOGhIW8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM5MzEzOA==", "bodyText": "Use getPropertyOrDefault.", "url": "https://github.com/dhis2/dhis2-core/pull/5706#discussion_r437393138", "createdAt": "2020-06-09T12:59:02Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/TrackerAuditConsumer.java", "diffHunk": "@@ -28,60 +28,43 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import java.io.IOException;\n-\n-import javax.jms.TextMessage;\n-\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import org.hisp.dhis.artemis.Topics;\n-import org.hisp.dhis.artemis.audit.Audit;\n-import org.hisp.dhis.audit.AuditConsumer;\n+import org.hisp.dhis.audit.AbstractAuditConsumer;\n import org.hisp.dhis.audit.AuditService;\n-import org.hisp.dhis.render.RenderService;\n+import org.hisp.dhis.external.conf.ConfigurationKey;\n+import org.hisp.dhis.external.conf.DhisConfigurationProvider;\n import org.springframework.jms.annotation.JmsListener;\n import org.springframework.stereotype.Component;\n \n-import lombok.extern.slf4j.Slf4j;\n+import javax.jms.TextMessage;\n+import java.util.Objects;\n \n /**\n- * Tracker audits consumer.\n+ * Tracker audit consumer.\n  *\n  * @author Morten Olav Hansen <morten@dhis2.org>\n  */\n-@Slf4j\n @Component\n-public class TrackerAuditConsumer implements AuditConsumer\n+public class TrackerAuditConsumer\n+    extends AbstractAuditConsumer\n {\n-    private final AuditService auditService;\n-    private final RenderService renderService;\n-\n     public TrackerAuditConsumer(\n-        AuditService auditService, RenderService renderService )\n+        AuditService auditService,\n+        ObjectMapper objectMapper,\n+        DhisConfigurationProvider dhisConfig )\n     {\n         this.auditService = auditService;\n-        this.renderService = renderService;\n+        this.objectMapper = objectMapper;\n+\n+        // for legacy reasons we are overriding the default here and using \"off\" for tracking logger (we don't have a specific key for tracker logger)\n+        this.isAuditLogEnabled = Objects.equals( dhisConfig.getProperty( ConfigurationKey.AUDIT_LOGGER ), \"off\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c71549b5646dddf2658a07fbec83d61e98d691"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87c995ba7271660e8c5aff271cff7ac7848ac25c", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/87c995ba7271660e8c5aff271cff7ac7848ac25c", "committedDate": "2020-06-09T12:59:05Z", "message": "fix: use getPropertyOrDefault to enable/disable audit log for tracker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTMwMDc3", "url": "https://github.com/dhis2/dhis2-core/pull/5706#pullrequestreview-427130077", "createdAt": "2020-06-09T13:14:03Z", "commit": {"oid": "87c995ba7271660e8c5aff271cff7ac7848ac25c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2627, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}