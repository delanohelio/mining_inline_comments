{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNDM2NzY1", "number": 4693, "title": "feat: Audit Matrix to control auditing", "bodyText": "DHIS2-8122\nCreated AuditMatrix class to control Auditing message publishing based on simple rules (Audit category and Audit action - READ, WRITE, etc)\nAuditMatrix is configured by setting specific properties on dhis.conf\nSerialization of Auditable entities now takes place in the AuditManager, to prevent costly early serialization", "createdAt": "2020-01-10T12:51:52Z", "url": "https://github.com/dhis2/dhis2-core/pull/4693", "merged": true, "mergeCommit": {"oid": "1a0f525d0a0b05ea87c91d81680f878d5daa1057"}, "closed": true, "closedAt": "2020-01-16T07:04:08Z", "author": {"login": "luciano-fiandesio"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5kFvgABqjI5NDExMTIyODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb60qTCAFqTM0MzcwNjI3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "838281c263f1c8720b75f428b2811d7cbb6e3060", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/838281c263f1c8720b75f428b2811d7cbb6e3060", "committedDate": "2020-01-10T12:55:50Z", "message": "chore: formatting"}, "afterCommit": {"oid": "a68345a935313005cf5e51b07013c091bf708015", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a68345a935313005cf5e51b07013c091bf708015", "committedDate": "2020-01-12T09:11:02Z", "message": "chore: formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjMyMTM3", "url": "https://github.com/dhis2/dhis2-core/pull/4693#pullrequestreview-341632137", "createdAt": "2020-01-13T03:56:34Z", "commit": {"oid": "a68345a935313005cf5e51b07013c091bf708015"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMzo1NjozNFrOFcs-eQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMzo1OTo1M1rOFcs_vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTMzNw==", "bodyText": "Do we still need this?", "url": "https://github.com/dhis2/dhis2-core/pull/4693#discussion_r365641337", "createdAt": "2020-01-13T03:56:34Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/legacy/MetadataAuditConsumer.java", "diffHunk": "@@ -67,7 +67,6 @@ public MetadataAuditConsumer(\n         this.auditService = auditService;\n         this.objectMapper = objectMapper;\n \n-        // TODO remove and replace with Audit Configuration Grid (ACG)\n         this.metadataAuditPersist = Objects.equals( dhisConfig.getProperty( ConfigurationKey.METADATA_AUDIT_PERSIST ), \"on\" );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a68345a935313005cf5e51b07013c091bf708015"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTU0OA==", "bodyText": "Why are we replacing the existing JsonPOJOBuilder approach here? then we don't need to manually add all the properties etc in the JsonCreator", "url": "https://github.com/dhis2/dhis2-core/pull/4693#discussion_r365641548", "createdAt": "2020-01-13T03:58:49Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/Audit.java", "diffHunk": "@@ -80,6 +82,49 @@\n     @JsonProperty\n     private Object data;\n \n+    @JsonIgnore\n+    private AuditableEntity auditableEntity;\n+\n+    /**\n+     * This constructor is used to create an instance of Audit using the 'Builder'\n+     * pattern This should be used by a service that needs to create a new Audit\n+     * entry\n+     */\n+    @Builder( builderClassName = \"AuditBuilder\" )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a68345a935313005cf5e51b07013c091bf708015"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTY2Mg==", "bodyText": "Maybe cleaner to do !auditMatrix.isEnabled(audit) and log/return out if not enabled? so we don't have this extra level of indenting", "url": "https://github.com/dhis2/dhis2-core/pull/4693#discussion_r365641662", "createdAt": "2020-01-13T03:59:53Z", "author": {"login": "mortenoh"}, "path": "dhis-2/dhis-support/dhis-support-artemis/src/main/java/org/hisp/dhis/artemis/audit/AuditManager.java", "diffHunk": "@@ -37,34 +40,54 @@\n  * @author Morten Olav Hansen <mortenoh@gmail.com>\n  */\n @Component\n+@Slf4j\n public class AuditManager\n {\n     private final AuditProducerSupplier auditProducerSupplier;\n     private final AuditProducerConfiguration config;\n     private final AuditScheduler auditScheduler;\n+    private final AuditMatrix auditMatrix;\n+\n+    private final AuditObjectFactory objectFactory;\n \n     public AuditManager(\n         AuditProducerSupplier auditProducerSupplier,\n         AuditScheduler auditScheduler,\n-        AuditProducerConfiguration config )\n+        AuditProducerConfiguration config,\n+        AuditMatrix auditMatrix, AuditObjectFactory auditObjectFactory )\n     {\n         checkNotNull( auditProducerSupplier );\n         checkNotNull( config );\n+        checkNotNull( auditMatrix );\n+        checkNotNull( auditObjectFactory );\n \n         this.auditProducerSupplier = auditProducerSupplier;\n         this.config = config;\n         this.auditScheduler = auditScheduler;\n+        this.auditMatrix = auditMatrix;\n+        this.objectFactory = auditObjectFactory;\n     }\n \n     public void send( Audit audit )\n     {\n-        if ( config.isUseQueue() )\n+        if ( auditMatrix.isEnabled( audit ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a68345a935313005cf5e51b07013c091bf708015"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8382b625bf0743c41a13476e97f7bf0d32a81eb5", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/8382b625bf0743c41a13476e97f7bf0d32a81eb5", "committedDate": "2020-01-15T14:22:57Z", "message": "feat: Audit Matrix to control auditing\n\n(cherry picked from commit 13b6e98503f17d5155d35ef825459f582b330ca3)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15e85655043748b73085dceee3f9b4617e5e57c4", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/15e85655043748b73085dceee3f9b4617e5e57c4", "committedDate": "2020-01-15T14:22:57Z", "message": "chore: formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd2c72caaf71f94ea3108c9f3e58f59a3d0a1426", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/fd2c72caaf71f94ea3108c9f3e58f59a3d0a1426", "committedDate": "2020-01-15T14:22:57Z", "message": "chore: removed boolean property to persist audit entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e731a79e1090f3d7f1fc10c2760c8d5143d4ad39", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/e731a79e1090f3d7f1fc10c2760c8d5143d4ad39", "committedDate": "2020-01-15T14:22:57Z", "message": "chore: minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1f22daf3f8f3f8d93582ee07211488423364ece", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d1f22daf3f8f3f8d93582ee07211488423364ece", "committedDate": "2020-01-15T14:22:58Z", "message": "fix: removed constructors on Audit obj"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d88817e107b91ca8ddc84b139cea003e39eec31b", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/d88817e107b91ca8ddc84b139cea003e39eec31b", "committedDate": "2020-01-15T14:22:58Z", "message": "chore: comments + removed lombok log annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b93f30a575563a27581102c06cbb74a0fa7940d", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/5b93f30a575563a27581102c06cbb74a0fa7940d", "committedDate": "2020-01-15T14:22:58Z", "message": "feat: property based Audit matrix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b72c3bf966303ea693f1dc1be11c6587e570e897", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b72c3bf966303ea693f1dc1be11c6587e570e897", "committedDate": "2020-01-15T08:23:09Z", "message": "chore: removed unused imports"}, "afterCommit": {"oid": "5b93f30a575563a27581102c06cbb74a0fa7940d", "author": {"user": {"login": "luciano-fiandesio", "name": "Luciano Fiandesio"}}, "url": "https://github.com/dhis2/dhis2-core/commit/5b93f30a575563a27581102c06cbb74a0fa7940d", "committedDate": "2020-01-15T14:22:58Z", "message": "feat: property based Audit matrix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2b0f33151a4208280f99a94deaa3400a1a3f587", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/a2b0f33151a4208280f99a94deaa3400a1a3f587", "committedDate": "2020-01-16T03:26:28Z", "message": "chore: code format updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f868377c2af5d7fd4f9be01dd0cfa05539a7b05", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1f868377c2af5d7fd4f9be01dd0cfa05539a7b05", "committedDate": "2020-01-16T03:35:22Z", "message": "chore: minor format fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dae4e8677ce804e9d1fc2e8c3806fe2579c9d59", "author": {"user": {"login": "mortenoh", "name": "Morten Hansen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/9dae4e8677ce804e9d1fc2e8c3806fe2579c9d59", "committedDate": "2020-01-16T04:45:15Z", "message": "fix: don't compress is data i s null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzA2Mjcy", "url": "https://github.com/dhis2/dhis2-core/pull/4693#pullrequestreview-343706272", "createdAt": "2020-01-16T07:03:48Z", "commit": {"oid": "9dae4e8677ce804e9d1fc2e8c3806fe2579c9d59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2977, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}