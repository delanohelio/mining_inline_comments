{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MDE5NDQw", "number": 5187, "title": "fix: DeletedObject constraint error when delete ProgramRule", "bodyText": "https://jira.dhis2.org/browse/DHIS2-3454\n\n\nThe issue is that for saving DeletedObject we use DeletedObjectIntegrator for triggering Hibernate POST_DELETE event, which is triggered for every objects including cascade objects\nBut for deleting the DeletedObject we explicit call deleteDeletedObject method in HibernateIdentifiableObjectStore.save() which does not touch the cascade objects.\n\n\nThis fix remove DeletedObjectIntegrator and use Hibernate POST_COMMIT_INSERT event to call deleteDeletedObject, so the cascade objects will be taken care of. Also adding DeletedObjectListenerConfigurer to register those hibernate event listeners\n\n\nAlso include a small fix for json serialization issue of ProgramRuleAction.evaluationEnvironment which is not an IdentifiableObject but was marked with @JsonSerialize( contentAs = BaseIdentifiableObject.class )\n\n\nAfter this fix, there were some integration test failures. The reason is because we have those kinds of code\ndataElementStore.save( dataElementA );\ncategoryService.getDefaultCategoryCombo();\n\n\nIn first line, hibernate put dataElementA into persistentContext of the current session, no transaction.\nThen in second line, a new readOnly transaction is created in same session.\nTherefore, when the transaction is committed/session flushed, hibernate can't save dataElementA in a readOnly transaction and throws error.\nBefore the fix, we call below code in HibernateIdentifiableStore so a separate transaction with readOnly = false is created when saving dataElementA.\n\n if (object instanceof MetadataObject )\n {\n       deletedObjectService.deleteDeletedObjects( new DeletedObjectQuery( object ) );\n }", "createdAt": "2020-03-26T08:14:47Z", "url": "https://github.com/dhis2/dhis2-core/pull/5187", "merged": true, "mergeCommit": {"oid": "feee4b7e1eaa3133321ad6bf5d187f7d7b4d6ebe"}, "closed": true, "closedAt": "2020-04-02T08:16:53Z", "author": {"login": "vietnguyen"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRKbl5gH2gAyMzk0MDE5NDQwOjcwNzg5N2E0N2RiZWYxOTViNGI3ZTcxMzA2NDFkZTUxZTlkNzYzN2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS9i6sAFqTM4NDQ0ODg5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "707897a47dbef195b4b7e7130641de51e9d7637e", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/707897a47dbef195b4b7e7130641de51e9d7637e", "committedDate": "2020-03-25T16:51:59Z", "message": "fix: DeletedObject constraint error when delete ProgramRule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc0251c710c743f13d9f2d95afdf821e4b6bf586", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/cc0251c710c743f13d9f2d95afdf821e4b6bf586", "committedDate": "2020-03-26T08:44:47Z", "message": "Merge remote-tracking branch 'upstream/master' into DHIS2-3454-35"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed967aeb45872ae063929026ccab0d60000196e", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1ed967aeb45872ae063929026ccab0d60000196e", "committedDate": "2020-03-27T08:32:21Z", "message": "Merge remote-tracking branch 'upstream/master' into DHIS2-3454-35"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMzI0MDA1", "url": "https://github.com/dhis2/dhis2-core/pull/5187#pullrequestreview-383324005", "createdAt": "2020-03-28T15:48:49Z", "commit": {"oid": "cc0251c710c743f13d9f2d95afdf821e4b6bf586"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQxNTo0ODo0OVrOF9KVHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQxNTo0ODo0OVrOF9KVHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY3NjcwMg==", "bodyText": "Add license.", "url": "https://github.com/dhis2/dhis2-core/pull/5187#discussion_r399676702", "createdAt": "2020-03-28T15:48:49Z", "author": {"login": "larshelge"}, "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/deletedobject/hibernate/DeletedObjectListenerConfigurer.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.hisp.dhis.deletedobject.hibernate;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc0251c710c743f13d9f2d95afdf821e4b6bf586"}, "originalPosition": 2}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9c66eac10f0cc4973d272cad98f56083bb3f0d5", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/e9c66eac10f0cc4973d272cad98f56083bb3f0d5", "committedDate": "2020-03-29T21:40:54Z", "message": "Fix integration test errors"}, "afterCommit": {"oid": "ff7dba5d65bc9157c04d9ed7e6466244a37560df", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/ff7dba5d65bc9157c04d9ed7e6466244a37560df", "committedDate": "2020-03-30T07:09:48Z", "message": "Fix integration test errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff7dba5d65bc9157c04d9ed7e6466244a37560df", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/ff7dba5d65bc9157c04d9ed7e6466244a37560df", "committedDate": "2020-03-30T07:09:48Z", "message": "Fix integration test errors"}, "afterCommit": {"oid": "b2556cb8ff21de83209db044077262404e509d9f", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b2556cb8ff21de83209db044077262404e509d9f", "committedDate": "2020-03-30T07:14:47Z", "message": "Fix integration test errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2556cb8ff21de83209db044077262404e509d9f", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/b2556cb8ff21de83209db044077262404e509d9f", "committedDate": "2020-03-30T07:14:47Z", "message": "Fix integration test errors"}, "afterCommit": {"oid": "1c122f0997350cbf6932a0e57b3554f68b1cee54", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1c122f0997350cbf6932a0e57b3554f68b1cee54", "committedDate": "2020-03-30T07:17:19Z", "message": "Fix integration test errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c122f0997350cbf6932a0e57b3554f68b1cee54", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/1c122f0997350cbf6932a0e57b3554f68b1cee54", "committedDate": "2020-03-30T07:17:19Z", "message": "Fix integration test errors"}, "afterCommit": {"oid": "7e35fd6b480ae1299ae86a788fbd83530861873a", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/7e35fd6b480ae1299ae86a788fbd83530861873a", "committedDate": "2020-03-30T07:37:01Z", "message": "Fix integration test errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNzMwODIw", "url": "https://github.com/dhis2/dhis2-core/pull/5187#pullrequestreview-383730820", "createdAt": "2020-03-30T10:40:16Z", "commit": {"oid": "7e35fd6b480ae1299ae86a788fbd83530861873a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MjgwMDAw", "url": "https://github.com/dhis2/dhis2-core/pull/5187#pullrequestreview-384280000", "createdAt": "2020-03-30T22:33:42Z", "commit": {"oid": "7e35fd6b480ae1299ae86a788fbd83530861873a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad277428c843b9d82bbfca86a1e5ecc5c8c40779", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/ad277428c843b9d82bbfca86a1e5ecc5c8c40779", "committedDate": "2020-03-31T05:35:23Z", "message": "Fix integration test errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e35fd6b480ae1299ae86a788fbd83530861873a", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/7e35fd6b480ae1299ae86a788fbd83530861873a", "committedDate": "2020-03-30T07:37:01Z", "message": "Fix integration test errors"}, "afterCommit": {"oid": "ad277428c843b9d82bbfca86a1e5ecc5c8c40779", "author": {"user": {"login": "vietnguyen", "name": "Viet Nguyen"}}, "url": "https://github.com/dhis2/dhis2-core/commit/ad277428c843b9d82bbfca86a1e5ecc5c8c40779", "committedDate": "2020-03-31T05:35:23Z", "message": "Fix integration test errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDQ4ODk4", "url": "https://github.com/dhis2/dhis2-core/pull/5187#pullrequestreview-384448898", "createdAt": "2020-03-31T06:59:04Z", "commit": {"oid": "ad277428c843b9d82bbfca86a1e5ecc5c8c40779"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2763, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}