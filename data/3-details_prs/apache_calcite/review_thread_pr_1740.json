{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMDcxNjQz", "number": 1740, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNDozMzo1NFrODXDNgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNDozOToyMVrODXDPWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NDk2NDQ4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNDozMzo1NFrOFcKEDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNDozMzo1NFrOFcKEDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA2OTMyNA==", "bodyText": "I'm confused with the code snippet\n        && (kind == kind.reverse()\n        || !op.getName().equals(kind.sql)\n        || sb.length() < 2 || sb.charAt(sb.length() - 1) != '(')", "url": "https://github.com/apache/calcite/pull/1740#discussion_r365069324", "createdAt": "2020-01-10T04:33:54Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "diffHunk": "@@ -127,11 +137,83 @@ protected final StringBuilder appendOperands(StringBuilder sb) {\n           includeType = RexDigestIncludeType.NO_TYPE;\n         }\n       }\n-      sb.append(((RexLiteral) operand).computeDigest(includeType));\n+      operandDigests.add(((RexLiteral) operand).computeDigest(includeType));\n+    }\n+    int totalLength = (operandDigests.size() - 1) * 2; // commas\n+    for (String s : operandDigests) {\n+      totalLength += s.length();\n+    }\n+    sb.ensureCapacity(sb.length() + totalLength);\n+    sortOperandsIfNeeded(sb, operands, operandDigests);\n+    for (int i = 0; i < operandDigests.size(); i++) {\n+      String op = operandDigests.get(i);\n+      if (i != 0) {\n+        sb.append(\", \");\n+      }\n+      sb.append(op);\n     }\n     return sb;\n   }\n \n+  private void sortOperandsIfNeeded(StringBuilder sb,\n+      List<RexNode> operands, List<String> operandDigests) {\n+    if (operands.isEmpty() || !needNormalize()) {\n+      return;\n+    }\n+    final SqlKind kind = op.getKind();\n+    if (SqlKind.SYMMETRICAL_SAME_ARG_TYPE.contains(kind)) {\n+      final RelDataType firstType = operands.get(0).getType();\n+      for (int i = 1; i < operands.size(); i++) {\n+        if (!equalSansNullability(firstType, operands.get(i).getType())) {\n+          // Arguments have different type, thus they must not be sorted\n+          return;\n+        }\n+      }\n+      // fall through: order arguments below\n+    } else if (!SqlKind.SYMMETRICAL.contains(kind)\n+        && (kind == kind.reverse()\n+        || !op.getName().equals(kind.sql)\n+        || sb.length() < 2 || sb.charAt(sb.length() - 1) != '(')) {\n+      // The operations have to be either symmetrical or reversible", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df79468c2e30285b0c7c83223cedb8d25969cf9f"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NDk2OTIzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "isResolved": false, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNDozOToyMVrOFcKG7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjoyMzozOVrOFcZKbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3MDA2MQ==", "bodyText": "We can make a sort if:\n\nThere is no decimals in the PLUS\nThere is no INTERVALs in TIMES", "url": "https://github.com/apache/calcite/pull/1740#discussion_r365070061", "createdAt": "2020-01-10T04:39:21Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "diffHunk": "@@ -127,11 +137,83 @@ protected final StringBuilder appendOperands(StringBuilder sb) {\n           includeType = RexDigestIncludeType.NO_TYPE;\n         }\n       }\n-      sb.append(((RexLiteral) operand).computeDigest(includeType));\n+      operandDigests.add(((RexLiteral) operand).computeDigest(includeType));\n+    }\n+    int totalLength = (operandDigests.size() - 1) * 2; // commas\n+    for (String s : operandDigests) {\n+      totalLength += s.length();\n+    }\n+    sb.ensureCapacity(sb.length() + totalLength);\n+    sortOperandsIfNeeded(sb, operands, operandDigests);\n+    for (int i = 0; i < operandDigests.size(); i++) {\n+      String op = operandDigests.get(i);\n+      if (i != 0) {\n+        sb.append(\", \");\n+      }\n+      sb.append(op);\n     }\n     return sb;\n   }\n \n+  private void sortOperandsIfNeeded(StringBuilder sb,\n+      List<RexNode> operands, List<String> operandDigests) {\n+    if (operands.isEmpty() || !needNormalize()) {\n+      return;\n+    }\n+    final SqlKind kind = op.getKind();\n+    if (SqlKind.SYMMETRICAL_SAME_ARG_TYPE.contains(kind)) {\n+      final RelDataType firstType = operands.get(0).getType();\n+      for (int i = 1; i < operands.size(); i++) {\n+        if (!equalSansNullability(firstType, operands.get(i).getType())) {\n+          // Arguments have different type, thus they must not be sorted", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df79468c2e30285b0c7c83223cedb8d25969cf9f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5MTk1Mg==", "bodyText": "Why drop decimals?\nWhy drop INTERVAL?", "url": "https://github.com/apache/calcite/pull/1740#discussion_r365091952", "createdAt": "2020-01-10T06:45:35Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "diffHunk": "@@ -127,11 +137,83 @@ protected final StringBuilder appendOperands(StringBuilder sb) {\n           includeType = RexDigestIncludeType.NO_TYPE;\n         }\n       }\n-      sb.append(((RexLiteral) operand).computeDigest(includeType));\n+      operandDigests.add(((RexLiteral) operand).computeDigest(includeType));\n+    }\n+    int totalLength = (operandDigests.size() - 1) * 2; // commas\n+    for (String s : operandDigests) {\n+      totalLength += s.length();\n+    }\n+    sb.ensureCapacity(sb.length() + totalLength);\n+    sortOperandsIfNeeded(sb, operands, operandDigests);\n+    for (int i = 0; i < operandDigests.size(); i++) {\n+      String op = operandDigests.get(i);\n+      if (i != 0) {\n+        sb.append(\", \");\n+      }\n+      sb.append(op);\n     }\n     return sb;\n   }\n \n+  private void sortOperandsIfNeeded(StringBuilder sb,\n+      List<RexNode> operands, List<String> operandDigests) {\n+    if (operands.isEmpty() || !needNormalize()) {\n+      return;\n+    }\n+    final SqlKind kind = op.getKind();\n+    if (SqlKind.SYMMETRICAL_SAME_ARG_TYPE.contains(kind)) {\n+      final RelDataType firstType = operands.get(0).getType();\n+      for (int i = 1; i < operands.size(); i++) {\n+        if (!equalSansNullability(firstType, operands.get(i).getType())) {\n+          // Arguments have different type, thus they must not be sorted", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3MDA2MQ=="}, "originalCommit": {"oid": "df79468c2e30285b0c7c83223cedb8d25969cf9f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5Mzg5Nw==", "bodyText": "Because of the return type inference, see RetirnTypes.NULLABLE_SUM and ReturnTypes.PRODUCT_NULLABLE.", "url": "https://github.com/apache/calcite/pull/1740#discussion_r365093897", "createdAt": "2020-01-10T06:54:16Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "diffHunk": "@@ -127,11 +137,83 @@ protected final StringBuilder appendOperands(StringBuilder sb) {\n           includeType = RexDigestIncludeType.NO_TYPE;\n         }\n       }\n-      sb.append(((RexLiteral) operand).computeDigest(includeType));\n+      operandDigests.add(((RexLiteral) operand).computeDigest(includeType));\n+    }\n+    int totalLength = (operandDigests.size() - 1) * 2; // commas\n+    for (String s : operandDigests) {\n+      totalLength += s.length();\n+    }\n+    sb.ensureCapacity(sb.length() + totalLength);\n+    sortOperandsIfNeeded(sb, operands, operandDigests);\n+    for (int i = 0; i < operandDigests.size(); i++) {\n+      String op = operandDigests.get(i);\n+      if (i != 0) {\n+        sb.append(\", \");\n+      }\n+      sb.append(op);\n     }\n     return sb;\n   }\n \n+  private void sortOperandsIfNeeded(StringBuilder sb,\n+      List<RexNode> operands, List<String> operandDigests) {\n+    if (operands.isEmpty() || !needNormalize()) {\n+      return;\n+    }\n+    final SqlKind kind = op.getKind();\n+    if (SqlKind.SYMMETRICAL_SAME_ARG_TYPE.contains(kind)) {\n+      final RelDataType firstType = operands.get(0).getType();\n+      for (int i = 1; i < operands.size(); i++) {\n+        if (!equalSansNullability(firstType, operands.get(i).getType())) {\n+          // Arguments have different type, thus they must not be sorted", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3MDA2MQ=="}, "originalCommit": {"oid": "df79468c2e30285b0c7c83223cedb8d25969cf9f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5NTgzNw==", "bodyText": "I do not follow you.\nI ensure the operands have to be of the same type, so I don't see why we should reject reordering in DECIMAL(5,0) + DECIMAL(5,0).", "url": "https://github.com/apache/calcite/pull/1740#discussion_r365095837", "createdAt": "2020-01-10T07:03:18Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "diffHunk": "@@ -127,11 +137,83 @@ protected final StringBuilder appendOperands(StringBuilder sb) {\n           includeType = RexDigestIncludeType.NO_TYPE;\n         }\n       }\n-      sb.append(((RexLiteral) operand).computeDigest(includeType));\n+      operandDigests.add(((RexLiteral) operand).computeDigest(includeType));\n+    }\n+    int totalLength = (operandDigests.size() - 1) * 2; // commas\n+    for (String s : operandDigests) {\n+      totalLength += s.length();\n+    }\n+    sb.ensureCapacity(sb.length() + totalLength);\n+    sortOperandsIfNeeded(sb, operands, operandDigests);\n+    for (int i = 0; i < operandDigests.size(); i++) {\n+      String op = operandDigests.get(i);\n+      if (i != 0) {\n+        sb.append(\", \");\n+      }\n+      sb.append(op);\n     }\n     return sb;\n   }\n \n+  private void sortOperandsIfNeeded(StringBuilder sb,\n+      List<RexNode> operands, List<String> operandDigests) {\n+    if (operands.isEmpty() || !needNormalize()) {\n+      return;\n+    }\n+    final SqlKind kind = op.getKind();\n+    if (SqlKind.SYMMETRICAL_SAME_ARG_TYPE.contains(kind)) {\n+      final RelDataType firstType = operands.get(0).getType();\n+      for (int i = 1; i < operands.size(); i++) {\n+        if (!equalSansNullability(firstType, operands.get(i).getType())) {\n+          // Arguments have different type, thus they must not be sorted", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3MDA2MQ=="}, "originalCommit": {"oid": "df79468c2e30285b0c7c83223cedb8d25969cf9f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwODc4MA==", "bodyText": "Oh, you mis-understood what i mean, i means to support more reordering for PLUS and TIMES even their operands types are different. For example, DECIMAL(3,0) + DECIMAL(5,0) can also be reordered.", "url": "https://github.com/apache/calcite/pull/1740#discussion_r365108780", "createdAt": "2020-01-10T07:56:37Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "diffHunk": "@@ -127,11 +137,83 @@ protected final StringBuilder appendOperands(StringBuilder sb) {\n           includeType = RexDigestIncludeType.NO_TYPE;\n         }\n       }\n-      sb.append(((RexLiteral) operand).computeDigest(includeType));\n+      operandDigests.add(((RexLiteral) operand).computeDigest(includeType));\n+    }\n+    int totalLength = (operandDigests.size() - 1) * 2; // commas\n+    for (String s : operandDigests) {\n+      totalLength += s.length();\n+    }\n+    sb.ensureCapacity(sb.length() + totalLength);\n+    sortOperandsIfNeeded(sb, operands, operandDigests);\n+    for (int i = 0; i < operandDigests.size(); i++) {\n+      String op = operandDigests.get(i);\n+      if (i != 0) {\n+        sb.append(\", \");\n+      }\n+      sb.append(op);\n     }\n     return sb;\n   }\n \n+  private void sortOperandsIfNeeded(StringBuilder sb,\n+      List<RexNode> operands, List<String> operandDigests) {\n+    if (operands.isEmpty() || !needNormalize()) {\n+      return;\n+    }\n+    final SqlKind kind = op.getKind();\n+    if (SqlKind.SYMMETRICAL_SAME_ARG_TYPE.contains(kind)) {\n+      final RelDataType firstType = operands.get(0).getType();\n+      for (int i = 1; i < operands.size(); i++) {\n+        if (!equalSansNullability(firstType, operands.get(i).getType())) {\n+          // Arguments have different type, thus they must not be sorted", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3MDA2MQ=="}, "originalCommit": {"oid": "df79468c2e30285b0c7c83223cedb8d25969cf9f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExNTc0MQ==", "bodyText": "Do we want to support strict floating-point non-associativity here?\nTechnically speaking, PLUS for FLOATs is not associative :(\nhttps://stackoverflow.com/a/10371890/1261287\n\ni means to support more reordering for PLUS and TIMES even their operands types are differen\n\nI wanted the first iteration to be as simple as it could be.\nProper cost estimates are more interesting for me than spending time on DECIMAL(3,0) + DECIMAL(5,0) normalization.\nReordering of DECIMAL(3,0) + DECIMAL(5,0) might be tricky, especially if it is nested: DECIMAL(3,0) + DECIMAL(3,0) + DECIMAL(5,0) might probably return different result than DECIMAL(5,0) + DECIMAL(3,0) + DECIMAL(3,0), so I don't want to spend time on exploring those scenarios as they are quite rare for me.", "url": "https://github.com/apache/calcite/pull/1740#discussion_r365115741", "createdAt": "2020-01-10T08:20:37Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "diffHunk": "@@ -127,11 +137,83 @@ protected final StringBuilder appendOperands(StringBuilder sb) {\n           includeType = RexDigestIncludeType.NO_TYPE;\n         }\n       }\n-      sb.append(((RexLiteral) operand).computeDigest(includeType));\n+      operandDigests.add(((RexLiteral) operand).computeDigest(includeType));\n+    }\n+    int totalLength = (operandDigests.size() - 1) * 2; // commas\n+    for (String s : operandDigests) {\n+      totalLength += s.length();\n+    }\n+    sb.ensureCapacity(sb.length() + totalLength);\n+    sortOperandsIfNeeded(sb, operands, operandDigests);\n+    for (int i = 0; i < operandDigests.size(); i++) {\n+      String op = operandDigests.get(i);\n+      if (i != 0) {\n+        sb.append(\", \");\n+      }\n+      sb.append(op);\n     }\n     return sb;\n   }\n \n+  private void sortOperandsIfNeeded(StringBuilder sb,\n+      List<RexNode> operands, List<String> operandDigests) {\n+    if (operands.isEmpty() || !needNormalize()) {\n+      return;\n+    }\n+    final SqlKind kind = op.getKind();\n+    if (SqlKind.SYMMETRICAL_SAME_ARG_TYPE.contains(kind)) {\n+      final RelDataType firstType = operands.get(0).getType();\n+      for (int i = 1; i < operands.size(); i++) {\n+        if (!equalSansNullability(firstType, operands.get(i).getType())) {\n+          // Arguments have different type, thus they must not be sorted", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3MDA2MQ=="}, "originalCommit": {"oid": "df79468c2e30285b0c7c83223cedb8d25969cf9f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExNjgyMw==", "bodyText": "I agree for the first iteration, we can keep it as simple as possible.\nWhy do you think PLUS for different data types are rare cases, i believe there would be many cases in production ~", "url": "https://github.com/apache/calcite/pull/1740#discussion_r365116823", "createdAt": "2020-01-10T08:24:08Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "diffHunk": "@@ -127,11 +137,83 @@ protected final StringBuilder appendOperands(StringBuilder sb) {\n           includeType = RexDigestIncludeType.NO_TYPE;\n         }\n       }\n-      sb.append(((RexLiteral) operand).computeDigest(includeType));\n+      operandDigests.add(((RexLiteral) operand).computeDigest(includeType));\n+    }\n+    int totalLength = (operandDigests.size() - 1) * 2; // commas\n+    for (String s : operandDigests) {\n+      totalLength += s.length();\n+    }\n+    sb.ensureCapacity(sb.length() + totalLength);\n+    sortOperandsIfNeeded(sb, operands, operandDigests);\n+    for (int i = 0; i < operandDigests.size(); i++) {\n+      String op = operandDigests.get(i);\n+      if (i != 0) {\n+        sb.append(\", \");\n+      }\n+      sb.append(op);\n     }\n     return sb;\n   }\n \n+  private void sortOperandsIfNeeded(StringBuilder sb,\n+      List<RexNode> operands, List<String> operandDigests) {\n+    if (operands.isEmpty() || !needNormalize()) {\n+      return;\n+    }\n+    final SqlKind kind = op.getKind();\n+    if (SqlKind.SYMMETRICAL_SAME_ARG_TYPE.contains(kind)) {\n+      final RelDataType firstType = operands.get(0).getType();\n+      for (int i = 1; i < operands.size(); i++) {\n+        if (!equalSansNullability(firstType, operands.get(i).getType())) {\n+          // Arguments have different type, thus they must not be sorted", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3MDA2MQ=="}, "originalCommit": {"oid": "df79468c2e30285b0c7c83223cedb8d25969cf9f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExODM0Ng==", "bodyText": "I've no idea. We could probably add a logger or counter to so it would count the number of times the normalization was skipped for + / *.\nIf you have production-like queries/test-cases, it would be nice if you could add them.\nHowever, I still think refining cost estimates and uniqueness metadata (see #1702 ) has better benefits than enhanced + * normalization.", "url": "https://github.com/apache/calcite/pull/1740#discussion_r365118346", "createdAt": "2020-01-10T08:29:01Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "diffHunk": "@@ -127,11 +137,83 @@ protected final StringBuilder appendOperands(StringBuilder sb) {\n           includeType = RexDigestIncludeType.NO_TYPE;\n         }\n       }\n-      sb.append(((RexLiteral) operand).computeDigest(includeType));\n+      operandDigests.add(((RexLiteral) operand).computeDigest(includeType));\n+    }\n+    int totalLength = (operandDigests.size() - 1) * 2; // commas\n+    for (String s : operandDigests) {\n+      totalLength += s.length();\n+    }\n+    sb.ensureCapacity(sb.length() + totalLength);\n+    sortOperandsIfNeeded(sb, operands, operandDigests);\n+    for (int i = 0; i < operandDigests.size(); i++) {\n+      String op = operandDigests.get(i);\n+      if (i != 0) {\n+        sb.append(\", \");\n+      }\n+      sb.append(op);\n     }\n     return sb;\n   }\n \n+  private void sortOperandsIfNeeded(StringBuilder sb,\n+      List<RexNode> operands, List<String> operandDigests) {\n+    if (operands.isEmpty() || !needNormalize()) {\n+      return;\n+    }\n+    final SqlKind kind = op.getKind();\n+    if (SqlKind.SYMMETRICAL_SAME_ARG_TYPE.contains(kind)) {\n+      final RelDataType firstType = operands.get(0).getType();\n+      for (int i = 1; i < operands.size(); i++) {\n+        if (!equalSansNullability(firstType, operands.get(i).getType())) {\n+          // Arguments have different type, thus they must not be sorted", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3MDA2MQ=="}, "originalCommit": {"oid": "df79468c2e30285b0c7c83223cedb8d25969cf9f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMxNjcxNw==", "bodyText": "In production the types will be the same: https://twitter.com/pysailor_de/status/1213126545642065920 :)", "url": "https://github.com/apache/calcite/pull/1740#discussion_r365316717", "createdAt": "2020-01-10T16:23:39Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/rex/RexCall.java", "diffHunk": "@@ -127,11 +137,83 @@ protected final StringBuilder appendOperands(StringBuilder sb) {\n           includeType = RexDigestIncludeType.NO_TYPE;\n         }\n       }\n-      sb.append(((RexLiteral) operand).computeDigest(includeType));\n+      operandDigests.add(((RexLiteral) operand).computeDigest(includeType));\n+    }\n+    int totalLength = (operandDigests.size() - 1) * 2; // commas\n+    for (String s : operandDigests) {\n+      totalLength += s.length();\n+    }\n+    sb.ensureCapacity(sb.length() + totalLength);\n+    sortOperandsIfNeeded(sb, operands, operandDigests);\n+    for (int i = 0; i < operandDigests.size(); i++) {\n+      String op = operandDigests.get(i);\n+      if (i != 0) {\n+        sb.append(\", \");\n+      }\n+      sb.append(op);\n     }\n     return sb;\n   }\n \n+  private void sortOperandsIfNeeded(StringBuilder sb,\n+      List<RexNode> operands, List<String> operandDigests) {\n+    if (operands.isEmpty() || !needNormalize()) {\n+      return;\n+    }\n+    final SqlKind kind = op.getKind();\n+    if (SqlKind.SYMMETRICAL_SAME_ARG_TYPE.contains(kind)) {\n+      final RelDataType firstType = operands.get(0).getType();\n+      for (int i = 1; i < operands.size(); i++) {\n+        if (!equalSansNullability(firstType, operands.get(i).getType())) {\n+          // Arguments have different type, thus they must not be sorted", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3MDA2MQ=="}, "originalCommit": {"oid": "df79468c2e30285b0c7c83223cedb8d25969cf9f"}, "originalPosition": 75}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 360, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}