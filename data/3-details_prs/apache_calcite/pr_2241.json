{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0NjAwMDA5", "number": 2241, "title": "[CALCITE-4374] Support materialized view recognition when query disti\u2026", "bodyText": "\u2026nct aggregate on target GROUP BY column (xzh)\nhttps://issues.apache.org/jira/browse/CALCITE-4374", "createdAt": "2020-11-03T09:26:49Z", "url": "https://github.com/apache/calcite/pull/2241", "merged": true, "mergeCommit": {"oid": "1e6b7425ec20e2bddc6331a21016475a43f9d995"}, "closed": true, "closedAt": "2020-11-12T01:52:51Z", "author": {"login": "xy2953396112"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY2My4ABqjM5NTIwMzY2NzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdahH70ABqjM5NzA4MDU0OTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "333bbe667147fd06d32ce5ba472a139af1bbaf59", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/333bbe667147fd06d32ce5ba472a139af1bbaf59", "committedDate": "2020-11-03T09:26:30Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}, "afterCommit": {"oid": "407f95f34b7d27cd8b89ab215e354c7c68c0d9bb", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/407f95f34b7d27cd8b89ab215e354c7c68c0d9bb", "committedDate": "2020-11-03T10:00:00Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNTMyMjk4", "url": "https://github.com/apache/calcite/pull/2241#pullrequestreview-522532298", "createdAt": "2020-11-03T14:11:51Z", "commit": {"oid": "407f95f34b7d27cd8b89ab215e354c7c68c0d9bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNDoxMTo1MVrOHswg1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNDoxMTo1MVrOHswg1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY5NDIyOA==", "bodyText": "What about other args ?", "url": "https://github.com/apache/calcite/pull/2241#discussion_r516694228", "createdAt": "2020-11-03T14:11:51Z", "author": {"login": "yanlin-Lynn"}, "path": "core/src/main/java/org/apache/calcite/plan/SubstitutionVisitor.java", "diffHunk": "@@ -1931,6 +1931,18 @@ public static MutableRel unifyAggregates(MutableAggregate query,\n       final List<AggregateCall> aggregateCalls = new ArrayList<>();\n       for (AggregateCall aggregateCall : query.aggCalls) {\n         if (aggregateCall.isDistinct()) {\n+          int aggIndex = aggregateCall.getArgList().get(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "407f95f34b7d27cd8b89ab215e354c7c68c0d9bb"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "407f95f34b7d27cd8b89ab215e354c7c68c0d9bb", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/407f95f34b7d27cd8b89ab215e354c7c68c0d9bb", "committedDate": "2020-11-03T10:00:00Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}, "afterCommit": {"oid": "2e3b15be1ba624ca49a97b8566226a3c67a98071", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/2e3b15be1ba624ca49a97b8566226a3c67a98071", "committedDate": "2020-11-03T14:19:01Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDMwNzc0", "url": "https://github.com/apache/calcite/pull/2241#pullrequestreview-523030774", "createdAt": "2020-11-04T04:06:45Z", "commit": {"oid": "2e3b15be1ba624ca49a97b8566226a3c67a98071"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwNDowNjo0NVrOHtIdEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwNDowNjo0NVrOHtIdEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA4NjQ4Mw==", "bodyText": "Could you please clarify why the size of the arguments has to be 1?", "url": "https://github.com/apache/calcite/pull/2241#discussion_r517086483", "createdAt": "2020-11-04T04:06:45Z", "author": {"login": "chunweilei"}, "path": "core/src/main/java/org/apache/calcite/plan/SubstitutionVisitor.java", "diffHunk": "@@ -1931,6 +1931,22 @@ public static MutableRel unifyAggregates(MutableAggregate query,\n       final List<AggregateCall> aggregateCalls = new ArrayList<>();\n       for (AggregateCall aggregateCall : query.aggCalls) {\n         if (aggregateCall.isDistinct()) {\n+          if (aggregateCall.getArgList().size() == 1) {\n+            int aggIndex = aggregateCall.getArgList().get(0);\n+            if (target.groupSet.asSet().contains(aggIndex)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e3b15be1ba624ca49a97b8566226a3c67a98071"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e3b15be1ba624ca49a97b8566226a3c67a98071", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/2e3b15be1ba624ca49a97b8566226a3c67a98071", "committedDate": "2020-11-03T14:19:01Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}, "afterCommit": {"oid": "56efb7fafc915a99a0b35a1c0ada592e9723254e", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/56efb7fafc915a99a0b35a1c0ada592e9723254e", "committedDate": "2020-11-05T02:07:20Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTAzMTMw", "url": "https://github.com/apache/calcite/pull/2241#pullrequestreview-523903130", "createdAt": "2020-11-05T03:36:39Z", "commit": {"oid": "56efb7fafc915a99a0b35a1c0ada592e9723254e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMzozNjozOVrOHtyZvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMzozODoyMVrOHtybZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc3Mzc1OQ==", "bodyText": "target.groupSet.asList() can be replaced by targetGroupByIndexList?\n[1]https://github.com/apache/calcite/pull/2241/files#diff-61f815e420e8c1c99c7f502f8105d6d2f91724a3bd0cb5ff4300a23ac96f527cR1898", "url": "https://github.com/apache/calcite/pull/2241#discussion_r517773759", "createdAt": "2020-11-05T03:36:39Z", "author": {"login": "chunweilei"}, "path": "core/src/main/java/org/apache/calcite/plan/SubstitutionVisitor.java", "diffHunk": "@@ -1930,7 +1930,20 @@ public static MutableRel unifyAggregates(MutableAggregate query,\n       }\n       final List<AggregateCall> aggregateCalls = new ArrayList<>();\n       for (AggregateCall aggregateCall : query.aggCalls) {\n-        if (aggregateCall.isDistinct()) {\n+        if (aggregateCall.isDistinct() && aggregateCall.getArgList().size() == 1) {\n+          int aggIndex = aggregateCall.getArgList().get(0);\n+          if (target.groupSet.asSet().contains(aggIndex)) {\n+            int newIndex = target.groupSet.asList().indexOf(aggIndex);\n+            aggregateCalls.add(\n+                AggregateCall.create(aggregateCall.getAggregation(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56efb7fafc915a99a0b35a1c0ada592e9723254e"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc3NDE4MQ==", "bodyText": "We'd better use a variable to represent target.groupSet.asSet() in case we have to transform it again and again.", "url": "https://github.com/apache/calcite/pull/2241#discussion_r517774181", "createdAt": "2020-11-05T03:38:21Z", "author": {"login": "chunweilei"}, "path": "core/src/main/java/org/apache/calcite/plan/SubstitutionVisitor.java", "diffHunk": "@@ -1930,7 +1930,20 @@ public static MutableRel unifyAggregates(MutableAggregate query,\n       }\n       final List<AggregateCall> aggregateCalls = new ArrayList<>();\n       for (AggregateCall aggregateCall : query.aggCalls) {\n-        if (aggregateCall.isDistinct()) {\n+        if (aggregateCall.isDistinct() && aggregateCall.getArgList().size() == 1) {\n+          int aggIndex = aggregateCall.getArgList().get(0);\n+          if (target.groupSet.asSet().contains(aggIndex)) {\n+            int newIndex = target.groupSet.asList().indexOf(aggIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56efb7fafc915a99a0b35a1c0ada592e9723254e"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56efb7fafc915a99a0b35a1c0ada592e9723254e", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/56efb7fafc915a99a0b35a1c0ada592e9723254e", "committedDate": "2020-11-05T02:07:20Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}, "afterCommit": {"oid": "e46c541c470371ceb0a317e1af390b3a0788dae4", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/e46c541c470371ceb0a317e1af390b3a0788dae4", "committedDate": "2020-11-05T12:51:41Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e46c541c470371ceb0a317e1af390b3a0788dae4", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/e46c541c470371ceb0a317e1af390b3a0788dae4", "committedDate": "2020-11-05T12:51:41Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}, "afterCommit": {"oid": "0a0792c40479a272c3c70eda1de74c38f9b68679", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/0a0792c40479a272c3c70eda1de74c38f9b68679", "committedDate": "2020-11-05T12:54:30Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a0792c40479a272c3c70eda1de74c38f9b68679", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/0a0792c40479a272c3c70eda1de74c38f9b68679", "committedDate": "2020-11-05T12:54:30Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY column (xzh)"}, "afterCommit": {"oid": "30770f5c0b8a5c68190ddaef4e78b7fd1b9271f1", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/30770f5c0b8a5c68190ddaef4e78b7fd1b9271f1", "committedDate": "2020-11-05T13:41:33Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY columns (xzh)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODIzMDk0", "url": "https://github.com/apache/calcite/pull/2241#pullrequestreview-524823094", "createdAt": "2020-11-06T02:53:03Z", "commit": {"oid": "30770f5c0b8a5c68190ddaef4e78b7fd1b9271f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMjo1MzowM1rOHueXyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMjo1MzowM1rOHueXyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ5NDE1Mg==", "bodyText": "if (targetGroupByIndexList.contains(aggIndex)) is not necessary.\nYou can do like this:\nfinal int newIndex = targetGroupByIndexList.indexOf(aggIndex);\nif (newIndex >=0 ) {\n   ......\n}", "url": "https://github.com/apache/calcite/pull/2241#discussion_r518494152", "createdAt": "2020-11-06T02:53:03Z", "author": {"login": "chunweilei"}, "path": "core/src/main/java/org/apache/calcite/plan/SubstitutionVisitor.java", "diffHunk": "@@ -1930,7 +1929,20 @@ public static MutableRel unifyAggregates(MutableAggregate query,\n       }\n       final List<AggregateCall> aggregateCalls = new ArrayList<>();\n       for (AggregateCall aggregateCall : query.aggCalls) {\n-        if (aggregateCall.isDistinct()) {\n+        if (aggregateCall.isDistinct() && aggregateCall.getArgList().size() == 1) {\n+          int aggIndex = aggregateCall.getArgList().get(0);\n+          if (targetGroupByIndexList.contains(aggIndex)) {\n+            int newIndex = targetGroupByIndexList.indexOf(aggIndex);\n+            aggregateCalls.add(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30770f5c0b8a5c68190ddaef4e78b7fd1b9271f1"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30770f5c0b8a5c68190ddaef4e78b7fd1b9271f1", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/30770f5c0b8a5c68190ddaef4e78b7fd1b9271f1", "committedDate": "2020-11-05T13:41:33Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY columns (xzh)"}, "afterCommit": {"oid": "feca3102fdb6c42a96ca3d843c13083a0902df5c", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/feca3102fdb6c42a96ca3d843c13083a0902df5c", "committedDate": "2020-11-06T07:04:18Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY columns (xzh)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fae4769e8ed6e93db6a8d66ed275d6eabeb580f5", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/fae4769e8ed6e93db6a8d66ed275d6eabeb580f5", "committedDate": "2020-11-08T14:34:16Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY columns (xzh)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "feca3102fdb6c42a96ca3d843c13083a0902df5c", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/feca3102fdb6c42a96ca3d843c13083a0902df5c", "committedDate": "2020-11-06T07:04:18Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY columns (xzh)"}, "afterCommit": {"oid": "fae4769e8ed6e93db6a8d66ed275d6eabeb580f5", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/fae4769e8ed6e93db6a8d66ed275d6eabeb580f5", "committedDate": "2020-11-08T14:34:16Z", "message": "[CALCITE-4374] Support materialized view recognition when query distinct aggregate on target GROUP BY columns (xzh)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3020, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}