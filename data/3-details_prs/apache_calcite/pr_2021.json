{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMTA3Njgw", "number": 2021, "title": "[CALCITE-3929] When deserialize UDAF aggregate call from json string,\u2026", "bodyText": "\u2026 throws NPE\nhttps://issues.apache.org/jira/browse/CALCITE-3929", "createdAt": "2020-06-11T14:12:10Z", "url": "https://github.com/apache/calcite/pull/2021", "merged": true, "mergeCommit": {"oid": "da7113949d6e22979cbb6981c1992a44db70cd4e"}, "closed": true, "closedAt": "2020-06-28T14:11:13Z", "author": {"login": "xy2953396112"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqPbA3gBqjM0MzQ1Mjg3Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvreQGgFqTQzODc3NTIyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7682a39401163bb3ed11d41879b7bb2a8c80f6a1", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/7682a39401163bb3ed11d41879b7bb2a8c80f6a1", "committedDate": "2020-06-11T14:11:25Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}, "afterCommit": {"oid": "e7d8d86dd3ab971921f5122de6c95868dec8739c", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/e7d8d86dd3ab971921f5122de6c95868dec8739c", "committedDate": "2020-06-11T14:48:34Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTQ5NDYw", "url": "https://github.com/apache/calcite/pull/2021#pullrequestreview-434149460", "createdAt": "2020-06-19T15:05:07Z", "commit": {"oid": "e7d8d86dd3ab971921f5122de6c95868dec8739c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTowNTowN1rOGmYDzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTowNTowN1rOGmYDzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5MzI2MQ==", "bodyText": "Where is this class attribute used? It doesn't seem to be in RelJsonWriter#toAggCall.", "url": "https://github.com/apache/calcite/pull/2021#discussion_r442893261", "createdAt": "2020-06-19T15:05:07Z", "author": {"login": "michaelmior"}, "path": "core/src/main/java/org/apache/calcite/rel/externalize/RelJson.java", "diffHunk": "@@ -271,7 +271,9 @@ public RelDataType toType(RelDataTypeFactory typeFactory, Object o) {\n \n   public Object toJson(AggregateCall node) {\n     final Map<String, Object> map = jsonBuilder.map();\n-    map.put(\"agg\", toJson(node.getAggregation()));\n+    Map<String, Object> aggMap = new HashMap(toJson(node.getAggregation()));\n+    aggMap.put(\"class\", node.getAggregation().getClass().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7d8d86dd3ab971921f5122de6c95868dec8739c"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDE4OTUz", "url": "https://github.com/apache/calcite/pull/2021#pullrequestreview-435018953", "createdAt": "2020-06-22T15:08:54Z", "commit": {"oid": "e7d8d86dd3ab971921f5122de6c95868dec8739c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNTowODo1NVrOGnFCEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNToxMToxMFrOGnFIdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYzMDA5OA==", "bodyText": "why new a map here, is it OK to do like this?\nfinal Map<String, Object> aggMap = toJson(node.getAggregation());\naggMap.put(\"class\", node.getAggregation().getClass().getName());\n\nAnd you only need to add class info for UDAF, for system aggregate function, you do not need to add class info in the map.", "url": "https://github.com/apache/calcite/pull/2021#discussion_r443630098", "createdAt": "2020-06-22T15:08:55Z", "author": {"login": "yanlin-Lynn"}, "path": "core/src/main/java/org/apache/calcite/rel/externalize/RelJson.java", "diffHunk": "@@ -271,7 +271,9 @@ public RelDataType toType(RelDataTypeFactory typeFactory, Object o) {\n \n   public Object toJson(AggregateCall node) {\n     final Map<String, Object> map = jsonBuilder.map();\n-    map.put(\"agg\", toJson(node.getAggregation()));\n+    Map<String, Object> aggMap = new HashMap(toJson(node.getAggregation()));\n+    aggMap.put(\"class\", node.getAggregation().getClass().getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5MzI2MQ=="}, "originalCommit": {"oid": "e7d8d86dd3ab971921f5122de6c95868dec8739c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYzMDYzMw==", "bodyText": "I don't think class info is needed for system aggregate function", "url": "https://github.com/apache/calcite/pull/2021#discussion_r443630633", "createdAt": "2020-06-22T15:09:38Z", "author": {"login": "yanlin-Lynn"}, "path": "core/src/test/java/org/apache/calcite/plan/RelWriterTest.java", "diffHunk": "@@ -146,8 +147,9 @@\n       + \"        {\\n\"\n       + \"          \\\"agg\\\": {\\n\"\n       + \"            \\\"name\\\": \\\"COUNT\\\",\\n\"\n-      + \"            \\\"kind\\\": \\\"COUNT\\\",\\n\"\n-      + \"            \\\"syntax\\\": \\\"FUNCTION_STAR\\\"\\n\"\n+      + \"            \\\"syntax\\\": \\\"FUNCTION_STAR\\\",\\n\"\n+      + \"            \\\"class\\\": \\\"org.apache.calcite.sql.fun.SqlCountAggFunction\\\",\\n\"\n+      + \"            \\\"kind\\\": \\\"COUNT\\\"\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7d8d86dd3ab971921f5122de6c95868dec8739c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYzMTczMg==", "bodyText": "extends SqlUserDefinedAggFunction might be better for your case", "url": "https://github.com/apache/calcite/pull/2021#discussion_r443631732", "createdAt": "2020-06-22T15:11:10Z", "author": {"login": "yanlin-Lynn"}, "path": "core/src/test/java/org/apache/calcite/test/MockSqlOperatorTable.java", "diffHunk": "@@ -125,6 +125,18 @@ public RelDataType inferReturnType(SqlOperatorBinding opBinding) {\n     }\n   }\n \n+  /** \"MYAGGFUNC\" user-defined aggregate function. This agg function accept one or more arguments\n+   * in order to reproduce the throws of CALCITE-3929. */\n+  public static class MyAggFunc extends SqlAggFunction {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7d8d86dd3ab971921f5122de6c95868dec8739c"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7d8d86dd3ab971921f5122de6c95868dec8739c", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/e7d8d86dd3ab971921f5122de6c95868dec8739c", "committedDate": "2020-06-11T14:48:34Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}, "afterCommit": {"oid": "6f3c9ea4384dcbf7d489a3cfd3d3e6c26594be51", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/6f3c9ea4384dcbf7d489a3cfd3d3e6c26594be51", "committedDate": "2020-06-22T16:21:44Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f3c9ea4384dcbf7d489a3cfd3d3e6c26594be51", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/6f3c9ea4384dcbf7d489a3cfd3d3e6c26594be51", "committedDate": "2020-06-22T16:21:44Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}, "afterCommit": {"oid": "346dfae6cb6604f38a1572a584d70dd2e49c2c0d", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/346dfae6cb6604f38a1572a584d70dd2e49c2c0d", "committedDate": "2020-06-22T16:25:19Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35095a61deeb279420631914102b3bfe60625aa1", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/35095a61deeb279420631914102b3bfe60625aa1", "committedDate": "2020-06-22T16:45:54Z", "message": "update"}, "afterCommit": {"oid": "648d8d24e4ed1a2f7d1d50cb4ec81c19f8f3f2ed", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/648d8d24e4ed1a2f7d1d50cb4ec81c19f8f3f2ed", "committedDate": "2020-06-23T00:07:53Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "648d8d24e4ed1a2f7d1d50cb4ec81c19f8f3f2ed", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/648d8d24e4ed1a2f7d1d50cb4ec81c19f8f3f2ed", "committedDate": "2020-06-23T00:07:53Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}, "afterCommit": {"oid": "45471830991b1335e9579a35237ff137c18cf5d6", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/45471830991b1335e9579a35237ff137c18cf5d6", "committedDate": "2020-06-23T01:23:04Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd197f3c131989ecd875fd28a70aef147f3b4887", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/cd197f3c131989ecd875fd28a70aef147f3b4887", "committedDate": "2020-06-27T08:24:23Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45471830991b1335e9579a35237ff137c18cf5d6", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/45471830991b1335e9579a35237ff137c18cf5d6", "committedDate": "2020-06-23T01:23:04Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}, "afterCommit": {"oid": "cd197f3c131989ecd875fd28a70aef147f3b4887", "author": {"user": {"login": "xy2953396112", "name": "xzh"}}, "url": "https://github.com/apache/calcite/commit/cd197f3c131989ecd875fd28a70aef147f3b4887", "committedDate": "2020-06-27T08:24:23Z", "message": "[CALCITE-3929] When deserialize UDAF aggregate call from json string, throws NPE (Xu Zhaohui)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4Nzc1MTc3", "url": "https://github.com/apache/calcite/pull/2021#pullrequestreview-438775177", "createdAt": "2020-06-28T12:18:48Z", "commit": {"oid": "cd197f3c131989ecd875fd28a70aef147f3b4887"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4Nzc1MjI1", "url": "https://github.com/apache/calcite/pull/2021#pullrequestreview-438775225", "createdAt": "2020-06-28T12:19:29Z", "commit": {"oid": "cd197f3c131989ecd875fd28a70aef147f3b4887"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3675, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}