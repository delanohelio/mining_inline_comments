{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4ODY2MzIz", "number": 1825, "title": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule", "bodyText": "JIRA: https://issues.apache.org/jira/browse/CALCITE-3817.", "createdAt": "2020-02-24T08:30:29Z", "url": "https://github.com/apache/calcite/pull/1825", "merged": true, "mergeCommit": {"oid": "089a3f61b7d2e85b2101eaa2869c866639f1abe5"}, "closed": true, "closedAt": "2020-02-25T13:26:43Z", "author": {"login": "chunweilei"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHZS4SAFqTM2MzIyMjY3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHtieQAFqTM2MzkzNDU5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjIyNjc1", "url": "https://github.com/apache/calcite/pull/1825#pullrequestreview-363222675", "createdAt": "2020-02-24T08:31:48Z", "commit": {"oid": "bb593bbfda7f0ce82a7f0b4895923758632dedec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwODozMTo0OFrOFtYaOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwODozMTo0OFrOFtYaOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzEzMDE3MQ==", "bodyText": "No need to use LinkedHashMultimap because the key should be unique.", "url": "https://github.com/apache/calcite/pull/1825#discussion_r383130171", "createdAt": "2020-02-24T08:31:48Z", "author": {"login": "chunweilei"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -239,8 +237,8 @@\n \n   /** Maps rule classes to their name, to ensure that the names are unique and\n    * conform to rules. */\n-  private final SetMultimap<String, Class> ruleNames =\n-      LinkedHashMultimap.create();\n+  private final Map<String, RelOptRule> ruleNames = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb593bbfda7f0ce82a7f0b4895923758632dedec"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb593bbfda7f0ce82a7f0b4895923758632dedec", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/bb593bbfda7f0ce82a7f0b4895923758632dedec", "committedDate": "2020-02-24T08:28:39Z", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule"}, "afterCommit": {"oid": "1c97cba020806951a97b2960dad26acfc267e019", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/1c97cba020806951a97b2960dad26acfc267e019", "committedDate": "2020-02-24T09:19:15Z", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c97cba020806951a97b2960dad26acfc267e019", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/1c97cba020806951a97b2960dad26acfc267e019", "committedDate": "2020-02-24T09:19:15Z", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule"}, "afterCommit": {"oid": "df80e6b5421f4ed14462ecf347d75f3fe115dd88", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/df80e6b5421f4ed14462ecf347d75f3fe115dd88", "committedDate": "2020-02-24T09:55:20Z", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df80e6b5421f4ed14462ecf347d75f3fe115dd88", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/df80e6b5421f4ed14462ecf347d75f3fe115dd88", "committedDate": "2020-02-24T09:55:20Z", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule"}, "afterCommit": {"oid": "10f52f7934c0801fe553689dece70beac9bf1fe6", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/10f52f7934c0801fe553689dece70beac9bf1fe6", "committedDate": "2020-02-24T10:00:05Z", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjE1MzMw", "url": "https://github.com/apache/calcite/pull/1825#pullrequestreview-363615330", "createdAt": "2020-02-24T18:45:51Z", "commit": {"oid": "10f52f7934c0801fe553689dece70beac9bf1fe6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxODo0NTo1MVrOFtrpyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxODo0Njo1NFrOFtrsCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0NTQ1MA==", "bodyText": "You can simplify this as -\nif (ruleNames.put(ruleName, rule)) {\n...\n}\nthen you won't need the else block.", "url": "https://github.com/apache/calcite/pull/1825#discussion_r383445450", "createdAt": "2020-02-24T18:45:51Z", "author": {"login": "xndai"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -451,12 +449,11 @@ public boolean addRule(RelOptRule rule) {\n     assert added;\n \n     final String ruleName = rule.toString();\n-    if (ruleNames.put(ruleName, rule.getClass())) {\n-      Set<Class> x = ruleNames.get(ruleName);\n-      if (x.size() > 1) {\n-        throw new RuntimeException(\"Rule description '\" + ruleName\n-            + \"' is not unique; classes: \" + x);\n-      }\n+    if (ruleNames.containsKey(ruleName)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10f52f7934c0801fe553689dece70beac9bf1fe6"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0NjAyNA==", "bodyText": "It's interesting that this is only called during planner clean up phase. But I think it's still good to fix this.", "url": "https://github.com/apache/calcite/pull/1825#discussion_r383446024", "createdAt": "2020-02-24T18:46:54Z", "author": {"login": "xndai"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -493,6 +490,9 @@ public boolean removeRule(RelOptRule rule) {\n       return false;\n     }\n \n+    // Remove rule name.\n+    ruleNames.remove(rule.toString());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10f52f7934c0801fe553689dece70beac9bf1fe6"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72650e363360f0a651c549e798c4fadb7981175d", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/72650e363360f0a651c549e798c4fadb7981175d", "committedDate": "2020-02-25T00:59:14Z", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10f52f7934c0801fe553689dece70beac9bf1fe6", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/10f52f7934c0801fe553689dece70beac9bf1fe6", "committedDate": "2020-02-24T10:00:05Z", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule"}, "afterCommit": {"oid": "72650e363360f0a651c549e798c4fadb7981175d", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/72650e363360f0a651c549e798c4fadb7981175d", "committedDate": "2020-02-25T00:59:14Z", "message": "[CALCITE-3817] VolcanoPlanner does not remove the entry in ruleNames when removing a rule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzODk4MDA5", "url": "https://github.com/apache/calcite/pull/1825#pullrequestreview-363898009", "createdAt": "2020-02-25T06:34:24Z", "commit": {"oid": "72650e363360f0a651c549e798c4fadb7981175d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzOTM0NTk3", "url": "https://github.com/apache/calcite/pull/1825#pullrequestreview-363934597", "createdAt": "2020-02-25T08:06:56Z", "commit": {"oid": "72650e363360f0a651c549e798c4fadb7981175d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4288, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}