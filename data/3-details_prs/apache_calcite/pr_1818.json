{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3ODA0MTEz", "number": 1818, "title": "[CALCITE-3809] RexSimplify simplifies nondeterministic function incorrectly", "bodyText": "JIRA: https://issues.apache.org/jira/browse/CALCITE-3809", "createdAt": "2020-02-20T14:59:10Z", "url": "https://github.com/apache/calcite/pull/1818", "merged": true, "mergeCommit": {"oid": "200a136dd3b2ca04a1d1283eb5a03a04388b1947"}, "closed": true, "closedAt": "2020-03-06T09:41:32Z", "author": {"login": "chunweilei"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGMgX9gFqTM2MTk3NDc3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcK8zgKgBqjMxMDQ2Mjc3MjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTc0Nzc1", "url": "https://github.com/apache/calcite/pull/1818#pullrequestreview-361974775", "createdAt": "2020-02-20T15:03:50Z", "commit": {"oid": "46c2a3c276cb3bc0c81e146f16c22fb311e9ade8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNTowMzo1MVrOFsW3NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNTowMzo1MVrOFsW3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1NjI0NA==", "bodyText": "RexUtil.isDeterministic walks over the full expression tree which might result in O(N^2) behaviors. Did you mean call.getOperator().isDeterministic() here?", "url": "https://github.com/apache/calcite/pull/1818#discussion_r382056244", "createdAt": "2020-02-20T15:03:51Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/rex/RexAnalyzer.java", "diffHunk": "@@ -128,6 +128,10 @@ public RexAnalyzer(RexNode e, RelOptPredicateList predicates) {\n     }\n \n     @Override public Void visitCall(RexCall call) {\n+      if (!RexUtil.isDeterministic(call)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46c2a3c276cb3bc0c81e146f16c22fb311e9ade8"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46c2a3c276cb3bc0c81e146f16c22fb311e9ade8", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/46c2a3c276cb3bc0c81e146f16c22fb311e9ade8", "committedDate": "2020-02-20T14:57:33Z", "message": "[CALCITE-3809] RexSimplify simplifies nondeterministic function incorrectly"}, "afterCommit": {"oid": "50fa47d6393301c834b92bfd4db194ac5318ac03", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/50fa47d6393301c834b92bfd4db194ac5318ac03", "committedDate": "2020-02-20T15:11:38Z", "message": "[CALCITE-3809] RexSimplify simplifies nondeterministic function incorrectly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTkzOTQ0", "url": "https://github.com/apache/calcite/pull/1818#pullrequestreview-361993944", "createdAt": "2020-02-20T15:25:33Z", "commit": {"oid": "50fa47d6393301c834b92bfd4db194ac5318ac03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNToyNTozM1rOFsXxOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNToyNTozM1rOFsXxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA3MTA5Ng==", "bodyText": "Can you please clarify why do you think RexInterpreter can't handle non-deterministic functions?", "url": "https://github.com/apache/calcite/pull/1818#discussion_r382071096", "createdAt": "2020-02-20T15:25:33Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/rex/RexAnalyzer.java", "diffHunk": "@@ -128,6 +128,10 @@ public RexAnalyzer(RexNode e, RelOptPredicateList predicates) {\n     }\n \n     @Override public Void visitCall(RexCall call) {\n+      if (!call.getOperator().isDeterministic()) {\n+        ++unsupportedCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50fa47d6393301c834b92bfd4db194ac5318ac03"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTk0NDk5", "url": "https://github.com/apache/calcite/pull/1818#pullrequestreview-361994499", "createdAt": "2020-02-20T15:26:10Z", "commit": {"oid": "50fa47d6393301c834b92bfd4db194ac5318ac03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNToyNjoxMFrOFsXy5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNToyNjoxMFrOFsXy5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA3MTUyNw==", "bodyText": "Is deep check required here? Doesn't it produce O(N^2) behaviors?", "url": "https://github.com/apache/calcite/pull/1818#discussion_r382071527", "createdAt": "2020-02-20T15:26:10Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/rex/RexSimplify.java", "diffHunk": "@@ -323,7 +323,7 @@ private RexNode simplifyComparison(RexCall e, RexUnknownAs unknownAs) {\n     // Simplify \"x <op> x\"\n     final RexNode o0 = operands.get(0);\n     final RexNode o1 = operands.get(1);\n-    if (o0.equals(o1)) {\n+    if (o0.equals(o1) && RexUtil.isDeterministic(o0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50fa47d6393301c834b92bfd4db194ac5318ac03"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NzIzMTM0", "url": "https://github.com/apache/calcite/pull/1818#pullrequestreview-364723134", "createdAt": "2020-02-26T09:04:11Z", "commit": {"oid": "488ac31bd1df89ecd7b2a8a8736eada3cfa0ef1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwOTowNDoxMVrOFujLZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwOTowNDoxMVrOFujLZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM1NTE3NA==", "bodyText": "Does it belong to RexInterpreter?", "url": "https://github.com/apache/calcite/pull/1818#discussion_r384355174", "createdAt": "2020-02-26T09:04:11Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/rex/RexAnalyzer.java", "diffHunk": "@@ -41,6 +43,16 @@\n   public final List<RexNode> variables;\n   public final int unsupportedCount;\n \n+  public static final EnumSet<SqlKind> SUPPORTED_SQL_KIND =\n+      EnumSet.of(SqlKind.IS_NOT_DISTINCT_FROM, SqlKind.EQUALS, SqlKind.IS_DISTINCT_FROM,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488ac31bd1df89ecd7b2a8a8736eada3cfa0ef1b"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "488ac31bd1df89ecd7b2a8a8736eada3cfa0ef1b", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/488ac31bd1df89ecd7b2a8a8736eada3cfa0ef1b", "committedDate": "2020-02-26T07:47:49Z", "message": "address comments"}, "afterCommit": {"oid": "42e38d71b8477fcf43b2cd17953ea363479f27e7", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/42e38d71b8477fcf43b2cd17953ea363479f27e7", "committedDate": "2020-02-26T10:54:14Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f756c888629dfd50a8bfb37123a56539255ac81b", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/f756c888629dfd50a8bfb37123a56539255ac81b", "committedDate": "2020-03-06T09:35:30Z", "message": "[CALCITE-3809] RexSimplify simplifies nondeterministic function incorrectly"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42e38d71b8477fcf43b2cd17953ea363479f27e7", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/42e38d71b8477fcf43b2cd17953ea363479f27e7", "committedDate": "2020-02-26T10:54:14Z", "message": "address comments"}, "afterCommit": {"oid": "f756c888629dfd50a8bfb37123a56539255ac81b", "author": {"user": {"login": "chunweilei", "name": "chunwei"}}, "url": "https://github.com/apache/calcite/commit/f756c888629dfd50a8bfb37123a56539255ac81b", "committedDate": "2020-03-06T09:35:30Z", "message": "[CALCITE-3809] RexSimplify simplifies nondeterministic function incorrectly"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4283, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}