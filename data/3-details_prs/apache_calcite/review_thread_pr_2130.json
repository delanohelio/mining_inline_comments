{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3NTkyNTc2", "number": 2130, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOTozMDo0N1rOEgUEBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOTozMDo0N1rOEgUEBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMzE4NTk3OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOTozMDo0N1rOHNGsVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwODoyNzo1OVrOHO8ZCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA==", "bodyText": "I'm confused by why the current_date caused the problem, does other non-param function triggers the bug too ?", "url": "https://github.com/apache/calcite/pull/2130#discussion_r483503190", "createdAt": "2020-09-04T09:30:47Z", "author": {"login": "danny0405"}, "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -11685,6 +11685,19 @@ private void checkCustomColumnResolving(String table) {\n             + \"MYFUN\\\\(<NUMERIC>, <NUMERIC>\\\\).*\");\n   }\n \n+  @Test void testPositionalAggregateWithExpandedCurrentDateFunction() {\n+    SqlConformance defaultPlusOrdinalGroupBy =\n+        new SqlDelegatingConformance(SqlConformanceEnum.DEFAULT) {\n+          @Override public boolean isGroupByOrdinal() {\n+            return true;\n+          }\n+        };\n+    sql(\"SELECT HIREDATE >= CURRENT_DATE, COUNT(*) \"\n+        + \"FROM EMP GROUP BY 1\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc13e00ae59c2b0c739e886713f01e62a1fd97a6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxMTIzMw==", "bodyText": "Please take a look at the stack trace from CALCITE-4207 description and this comment.", "url": "https://github.com/apache/calcite/pull/2130#discussion_r483511233", "createdAt": "2020-09-04T09:46:23Z", "author": {"login": "ihuzenko"}, "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -11685,6 +11685,19 @@ private void checkCustomColumnResolving(String table) {\n             + \"MYFUN\\\\(<NUMERIC>, <NUMERIC>\\\\).*\");\n   }\n \n+  @Test void testPositionalAggregateWithExpandedCurrentDateFunction() {\n+    SqlConformance defaultPlusOrdinalGroupBy =\n+        new SqlDelegatingConformance(SqlConformanceEnum.DEFAULT) {\n+          @Override public boolean isGroupByOrdinal() {\n+            return true;\n+          }\n+        };\n+    sql(\"SELECT HIREDATE >= CURRENT_DATE, COUNT(*) \"\n+        + \"FROM EMP GROUP BY 1\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, "originalCommit": {"oid": "bc13e00ae59c2b0c739e886713f01e62a1fd97a6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxNDE0NA==", "bodyText": "In one place CURRENT_DATE was represented as SqlBasicCall while in other it was instance of SqlIdentifier\n\nStill does not get your point, in you fix, you just use the expanded group expr for validation, but the CURRENT_DATE is not a group expr ?", "url": "https://github.com/apache/calcite/pull/2130#discussion_r483514144", "createdAt": "2020-09-04T09:51:59Z", "author": {"login": "danny0405"}, "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -11685,6 +11685,19 @@ private void checkCustomColumnResolving(String table) {\n             + \"MYFUN\\\\(<NUMERIC>, <NUMERIC>\\\\).*\");\n   }\n \n+  @Test void testPositionalAggregateWithExpandedCurrentDateFunction() {\n+    SqlConformance defaultPlusOrdinalGroupBy =\n+        new SqlDelegatingConformance(SqlConformanceEnum.DEFAULT) {\n+          @Override public boolean isGroupByOrdinal() {\n+            return true;\n+          }\n+        };\n+    sql(\"SELECT HIREDATE >= CURRENT_DATE, COUNT(*) \"\n+        + \"FROM EMP GROUP BY 1\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, "originalCommit": {"oid": "bc13e00ae59c2b0c739e886713f01e62a1fd97a6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU0OTQxNw==", "bodyText": "Positional aggregate points to the first expression in select. Validation tries to match 2 expression trees :\n\nThe first item from select which is already expanded at the moment and contains current_date as an instance of SqlBasicCall\nAn item from the group by where prior to my fix current_date was presented as an instance of the SqlIdentifier.\n\nDue to this instance mismatch validation goes further and tells that Expression 'EMP.HIREDATE' is not being grouped, although grouping was performed by the whole expression HIREDATE >= CURRENT_DATE.", "url": "https://github.com/apache/calcite/pull/2130#discussion_r483549417", "createdAt": "2020-09-04T11:08:47Z", "author": {"login": "ihuzenko"}, "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -11685,6 +11685,19 @@ private void checkCustomColumnResolving(String table) {\n             + \"MYFUN\\\\(<NUMERIC>, <NUMERIC>\\\\).*\");\n   }\n \n+  @Test void testPositionalAggregateWithExpandedCurrentDateFunction() {\n+    SqlConformance defaultPlusOrdinalGroupBy =\n+        new SqlDelegatingConformance(SqlConformanceEnum.DEFAULT) {\n+          @Override public boolean isGroupByOrdinal() {\n+            return true;\n+          }\n+        };\n+    sql(\"SELECT HIREDATE >= CURRENT_DATE, COUNT(*) \"\n+        + \"FROM EMP GROUP BY 1\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, "originalCommit": {"oid": "bc13e00ae59c2b0c739e886713f01e62a1fd97a6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc3ODQ4Nw==", "bodyText": "Hello @danny0405 , could you proceed with reviewing the PR?", "url": "https://github.com/apache/calcite/pull/2130#discussion_r484778487", "createdAt": "2020-09-08T09:25:53Z", "author": {"login": "ihuzenko"}, "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -11685,6 +11685,19 @@ private void checkCustomColumnResolving(String table) {\n             + \"MYFUN\\\\(<NUMERIC>, <NUMERIC>\\\\).*\");\n   }\n \n+  @Test void testPositionalAggregateWithExpandedCurrentDateFunction() {\n+    SqlConformance defaultPlusOrdinalGroupBy =\n+        new SqlDelegatingConformance(SqlConformanceEnum.DEFAULT) {\n+          @Override public boolean isGroupByOrdinal() {\n+            return true;\n+          }\n+        };\n+    sql(\"SELECT HIREDATE >= CURRENT_DATE, COUNT(*) \"\n+        + \"FROM EMP GROUP BY 1\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, "originalCommit": {"oid": "bc13e00ae59c2b0c739e886713f01e62a1fd97a6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5Mzg2Mw==", "bodyText": "I tried the fix locally and think the fix is reasonable.", "url": "https://github.com/apache/calcite/pull/2130#discussion_r485393863", "createdAt": "2020-09-09T07:24:19Z", "author": {"login": "danny0405"}, "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -11685,6 +11685,19 @@ private void checkCustomColumnResolving(String table) {\n             + \"MYFUN\\\\(<NUMERIC>, <NUMERIC>\\\\).*\");\n   }\n \n+  @Test void testPositionalAggregateWithExpandedCurrentDateFunction() {\n+    SqlConformance defaultPlusOrdinalGroupBy =\n+        new SqlDelegatingConformance(SqlConformanceEnum.DEFAULT) {\n+          @Override public boolean isGroupByOrdinal() {\n+            return true;\n+          }\n+        };\n+    sql(\"SELECT HIREDATE >= CURRENT_DATE, COUNT(*) \"\n+        + \"FROM EMP GROUP BY 1\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, "originalCommit": {"oid": "bc13e00ae59c2b0c739e886713f01e62a1fd97a6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQzMTU2MA==", "bodyText": "Thanks for review:)", "url": "https://github.com/apache/calcite/pull/2130#discussion_r485431560", "createdAt": "2020-09-09T08:27:59Z", "author": {"login": "ihuzenko"}, "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -11685,6 +11685,19 @@ private void checkCustomColumnResolving(String table) {\n             + \"MYFUN\\\\(<NUMERIC>, <NUMERIC>\\\\).*\");\n   }\n \n+  @Test void testPositionalAggregateWithExpandedCurrentDateFunction() {\n+    SqlConformance defaultPlusOrdinalGroupBy =\n+        new SqlDelegatingConformance(SqlConformanceEnum.DEFAULT) {\n+          @Override public boolean isGroupByOrdinal() {\n+            return true;\n+          }\n+        };\n+    sql(\"SELECT HIREDATE >= CURRENT_DATE, COUNT(*) \"\n+        + \"FROM EMP GROUP BY 1\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzE5MA=="}, "originalCommit": {"oid": "bc13e00ae59c2b0c739e886713f01e62a1fd97a6"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 122, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}