{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNzg0MTc4", "number": 2015, "title": "[CALCITE-4055] RelFieldTrimmer loses hints", "bodyText": "Jira: CALCITE-4055\nThe trimmed plan generated by RelFieldTrimmer can lose the hints that might be present in the input plan.", "createdAt": "2020-06-09T13:12:55Z", "url": "https://github.com/apache/calcite/pull/2015", "merged": true, "mergeCommit": {"oid": "7c2f6772ee6bbfe4fefc2cf35152d6c71cc7a361"}, "closed": true, "closedAt": "2020-06-12T07:19:42Z", "author": {"login": "rubenada"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqJepHgFqTQyODY3NDE2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqPRanAFqTQyODk3ODI0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4Njc0MTY3", "url": "https://github.com/apache/calcite/pull/2015#pullrequestreview-428674167", "createdAt": "2020-06-11T07:53:31Z", "commit": {"oid": "5d000e06dc760ac85995e0de412ec146cf63282f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNzo1MzozMVrOGiScYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNzo1MzozMVrOGiScYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYwNjk0Nw==", "bodyText": "Great fix, can we also add a test case for the aggregate ? thanks for that ~", "url": "https://github.com/apache/calcite/pull/2015#discussion_r438606947", "createdAt": "2020-06-11T07:53:31Z", "author": {"login": "danny0405"}, "path": "core/src/test/java/org/apache/calcite/sql2rel/RelFieldTrimmerTest.java", "diffHunk": "@@ -183,4 +187,44 @@\n     assertThat(trimmed, hasTree(expected));\n   }\n \n+  /** Test case for\n+   * <a href=\"https://issues.apache.org/jira/browse/CALCITE-4055\">[CALCITE-4055]\n+   * RelFieldTrimmer loses hints</a>. */\n+  @Test void testJoinWithHints() {\n+    final RelHint noHashJoinHint = RelHint.builder(\"NO_HASH_JOIN\").build();\n+    final RelBuilder builder = RelBuilder.create(config().build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d000e06dc760ac85995e0de412ec146cf63282f"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODM4MjA5", "url": "https://github.com/apache/calcite/pull/2015#pullrequestreview-428838209", "createdAt": "2020-06-11T11:56:43Z", "commit": {"oid": "da86d141b022484198bfd095633485463d0aa969"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bba25b12d75b87670bdee1f3fab4941aaeac6e99", "author": {"user": {"login": "rubenada", "name": null}}, "url": "https://github.com/apache/calcite/commit/bba25b12d75b87670bdee1f3fab4941aaeac6e99", "committedDate": "2020-06-11T12:45:07Z", "message": "[CALCITE-4055] RelFieldTrimmer loses hints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7cfaba4738de59809d788c885e4f31dd1ded8bc", "author": {"user": {"login": "rubenada", "name": null}}, "url": "https://github.com/apache/calcite/commit/f7cfaba4738de59809d788c885e4f31dd1ded8bc", "committedDate": "2020-06-11T12:42:26Z", "message": "[CALCITE-4055] RelFieldTrimmer loses hints"}, "afterCommit": {"oid": "bba25b12d75b87670bdee1f3fab4941aaeac6e99", "author": {"user": {"login": "rubenada", "name": null}}, "url": "https://github.com/apache/calcite/commit/bba25b12d75b87670bdee1f3fab4941aaeac6e99", "committedDate": "2020-06-11T12:45:07Z", "message": "[CALCITE-4055] RelFieldTrimmer loses hints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTc4MjQ1", "url": "https://github.com/apache/calcite/pull/2015#pullrequestreview-428978245", "createdAt": "2020-06-11T14:38:27Z", "commit": {"oid": "bba25b12d75b87670bdee1f3fab4941aaeac6e99"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDozODoyOVrOGigYvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDozODoyOVrOGigYvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzNTM4OQ==", "bodyText": "How about we change the param originalRelNode  to just hints which seems more straight-forward.", "url": "https://github.com/apache/calcite/pull/2015#discussion_r438835389", "createdAt": "2020-06-11T14:38:29Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/sql2rel/RelFieldTrimmer.java", "diffHunk": "@@ -417,17 +417,30 @@ public TrimResult trimFields(\n \n     relBuilder.push(newInput);\n     relBuilder.project(newProjects, newRowType.getFieldNames());\n-    return result(relBuilder.build(), mapping);\n+    final RelNode newProject = RelOptUtil.propagateRelHints(project, relBuilder.build());\n+    return result(newProject, mapping);\n   }\n \n   /** Creates a project with a dummy column, to protect the parts of the system\n    * that cannot handle a relational expression with no columns.\n    *\n    * @param fieldCount Number of fields in the original relational expression\n    * @param input Trimmed input\n-   * @return Dummy project, or null if no dummy is required\n+   * @return Dummy project\n    */\n   protected TrimResult dummyProject(int fieldCount, RelNode input) {\n+    return dummyProject(fieldCount, input, null);\n+  }\n+\n+  /** Creates a project with a dummy column, to protect the parts of the system\n+   * that cannot handle a relational expression with no columns.\n+   *\n+   * @param fieldCount Number of fields in the original relational expression\n+   * @param input Trimmed input\n+   * @param originalRelNode Source RelNode for hint propagation (or null if no propagation needed)\n+   * @return Dummy project\n+   */\n+  protected TrimResult dummyProject(int fieldCount, RelNode input, RelNode originalRelNode) {\n     final RelOptCluster cluster = input.getCluster();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bba25b12d75b87670bdee1f3fab4941aaeac6e99"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3629, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}