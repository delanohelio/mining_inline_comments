{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwOTY0Mjg3", "number": 1837, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMDo1NzozNlrODrKP-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMjo1NzoyMlrODr6C9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2NTgzMjg4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/calcite/sql/SqlUtil.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMDo1NzozNlrOF7VwTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDozNTowNVrOF8AoTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc2NjczNA==", "bodyText": "Does all kinds of functions return a non-empty list if the method call have parameter names ? I don't think so, and how about function.getParamNames().indexOf(argNames.get(i)) returns -1 there ?", "url": "https://github.com/apache/calcite/pull/1837#discussion_r397766734", "createdAt": "2020-03-25T10:57:36Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/sql/SqlUtil.java", "diffHunk": "@@ -676,14 +680,16 @@ public static boolean matchRoutinesByParameterCount(\n   }\n \n   private static RelDataType bestMatch(List<SqlFunction> sqlFunctions, int i,\n-      RelDataTypePrecedenceList precList) {\n+      List<String> argNames, RelDataTypePrecedenceList precList) {\n     RelDataType bestMatch = null;\n     for (SqlFunction function : sqlFunctions) {\n       List<RelDataType> paramTypes = function.getParamTypes();\n       if (paramTypes == null) {\n         continue;\n       }\n-      final RelDataType paramType = paramTypes.get(i);\n+      final RelDataType paramType = argNames != null\n+          ? paramTypes.get(function.getParamNames().indexOf(argNames.get(i)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aaa1a7bdda745ac111be3f6faf0bb82b79f3a488"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgwMDk1OQ==", "bodyText": "@danny0405, good question!\nThis method is called after calling filterRoutinesByParameterType(), which will return false for the case when the incorrect name was specified in argNames list: \n  \n    \n      calcite/core/src/main/java/org/apache/calcite/sql/SqlUtil.java\n    \n    \n         Line 611\n      in\n      1baee85\n    \n    \n    \n    \n\n        \n          \n           final int i = function.getParamNames().indexOf(argName.e); \n        \n    \n  \n\n\nSo at this point, we will have a list of functions, that have all parameter names from argNames list, if it is specified.", "url": "https://github.com/apache/calcite/pull/1837#discussion_r397800959", "createdAt": "2020-03-25T12:00:39Z", "author": {"login": "vvysotskyi"}, "path": "core/src/main/java/org/apache/calcite/sql/SqlUtil.java", "diffHunk": "@@ -676,14 +680,16 @@ public static boolean matchRoutinesByParameterCount(\n   }\n \n   private static RelDataType bestMatch(List<SqlFunction> sqlFunctions, int i,\n-      RelDataTypePrecedenceList precList) {\n+      List<String> argNames, RelDataTypePrecedenceList precList) {\n     RelDataType bestMatch = null;\n     for (SqlFunction function : sqlFunctions) {\n       List<RelDataType> paramTypes = function.getParamTypes();\n       if (paramTypes == null) {\n         continue;\n       }\n-      final RelDataType paramType = paramTypes.get(i);\n+      final RelDataType paramType = argNames != null\n+          ? paramTypes.get(function.getParamNames().indexOf(argNames.get(i)))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc2NjczNA=="}, "originalCommit": {"oid": "aaa1a7bdda745ac111be3f6faf0bb82b79f3a488"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgzMjQwOA==", "bodyText": "Thanks for the explanation. The code is a mess. Maybe we should have a method named filterRoutinesByParameterName", "url": "https://github.com/apache/calcite/pull/1837#discussion_r397832408", "createdAt": "2020-03-25T12:58:13Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/sql/SqlUtil.java", "diffHunk": "@@ -676,14 +680,16 @@ public static boolean matchRoutinesByParameterCount(\n   }\n \n   private static RelDataType bestMatch(List<SqlFunction> sqlFunctions, int i,\n-      RelDataTypePrecedenceList precList) {\n+      List<String> argNames, RelDataTypePrecedenceList precList) {\n     RelDataType bestMatch = null;\n     for (SqlFunction function : sqlFunctions) {\n       List<RelDataType> paramTypes = function.getParamTypes();\n       if (paramTypes == null) {\n         continue;\n       }\n-      final RelDataType paramType = paramTypes.get(i);\n+      final RelDataType paramType = argNames != null\n+          ? paramTypes.get(function.getParamNames().indexOf(argNames.get(i)))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc2NjczNA=="}, "originalCommit": {"oid": "aaa1a7bdda745ac111be3f6faf0bb82b79f3a488"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2OTE5Ng==", "bodyText": "I have renamed filterRoutinesByParameterType() method and excracted logic connected with types and names permutation.", "url": "https://github.com/apache/calcite/pull/1837#discussion_r398469196", "createdAt": "2020-03-26T10:35:05Z", "author": {"login": "vvysotskyi"}, "path": "core/src/main/java/org/apache/calcite/sql/SqlUtil.java", "diffHunk": "@@ -676,14 +680,16 @@ public static boolean matchRoutinesByParameterCount(\n   }\n \n   private static RelDataType bestMatch(List<SqlFunction> sqlFunctions, int i,\n-      RelDataTypePrecedenceList precList) {\n+      List<String> argNames, RelDataTypePrecedenceList precList) {\n     RelDataType bestMatch = null;\n     for (SqlFunction function : sqlFunctions) {\n       List<RelDataType> paramTypes = function.getParamTypes();\n       if (paramTypes == null) {\n         continue;\n       }\n-      final RelDataType paramType = paramTypes.get(i);\n+      final RelDataType paramType = argNames != null\n+          ? paramTypes.get(function.getParamNames().indexOf(argNames.get(i)))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc2NjczNA=="}, "originalCommit": {"oid": "aaa1a7bdda745ac111be3f6faf0bb82b79f3a488"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDc3MTE5OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/org/apache/calcite/test/JdbcTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo1MzozN1rOF8Fcdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODo0MzoxM1rOF8VVTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0ODA4Ng==", "bodyText": "I think we should keep the old name. The passed in param is not necessary to be an array, so it maybe not overloaded.", "url": "https://github.com/apache/calcite/pull/1837#discussion_r398548086", "createdAt": "2020-03-26T12:53:37Z", "author": {"login": "danny0405"}, "path": "core/src/test/java/org/apache/calcite/test/JdbcTest.java", "diffHunk": "@@ -568,36 +572,44 @@ private void addTableMacro(Connection connection, Method method) throws SQLExcep\n     checkTableFunctionInModel(Smalls.TestStaticTableFunction.class);\n   }\n \n-  private CalciteAssert.AssertThat assertWithMacro(Class clazz) {\n+  private CalciteAssert.AssertThat assertOverloadedWithMacro(Class<?>... clazz) {\n+    String prefix = \"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5820c21a21dcb759f044749bbddb739274626445"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgwODM5OQ==", "bodyText": "Ok, thanks for pointing this, reverted changing method name.", "url": "https://github.com/apache/calcite/pull/1837#discussion_r398808399", "createdAt": "2020-03-26T18:43:13Z", "author": {"login": "vvysotskyi"}, "path": "core/src/test/java/org/apache/calcite/test/JdbcTest.java", "diffHunk": "@@ -568,36 +572,44 @@ private void addTableMacro(Connection connection, Method method) throws SQLExcep\n     checkTableFunctionInModel(Smalls.TestStaticTableFunction.class);\n   }\n \n-  private CalciteAssert.AssertThat assertWithMacro(Class clazz) {\n+  private CalciteAssert.AssertThat assertOverloadedWithMacro(Class<?>... clazz) {\n+    String prefix = \"\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0ODA4Ng=="}, "originalCommit": {"oid": "5820c21a21dcb759f044749bbddb739274626445"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzY2Mzg5OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/org/apache/calcite/util/Smalls.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMjo1NzoyMlrOF8hiMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOTowMDozN1rOF8oS1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwODMwNw==", "bodyText": "How can we resolve \"View\"(r=>'6', s=>'5')) since both TableMacroFunctionWithNamedParameters\nand AnotherTableMacroFunctionWithNamedParameters match?", "url": "https://github.com/apache/calcite/pull/1837#discussion_r399008307", "createdAt": "2020-03-27T02:57:22Z", "author": {"login": "chunweilei"}, "path": "core/src/test/java/org/apache/calcite/util/Smalls.java", "diffHunk": "@@ -843,6 +843,30 @@ private void abc(StringBuilder sb, Object s) {\n     }\n   }\n \n+  /** User-defined table-macro function with named and optional parameters. */\n+  public static class AnotherTableMacroFunctionWithNamedParameters {\n+    public TranslatableTable eval(\n+        @Parameter(name = \"R\", optional = true) String r,\n+        @Parameter(name = \"S\") String s,\n+        @Parameter(name = \"T\", optional = true) Integer t,\n+        @Parameter(name = \"S2\", optional = true) String s2) {\n+      final StringBuilder sb = new StringBuilder();\n+      abc(sb, r);\n+      abc(sb, s);\n+      abc(sb, t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2853074ba4855ee7a4a484951422150074c73a1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEwNDY4MQ==", "bodyText": "In this case, will be used the first registered function. Here is the code which returns it: \n  \n    \n      calcite/core/src/main/java/org/apache/calcite/sql/SqlUtil.java\n    \n    \n         Line 451\n      in\n      1baee85\n    \n    \n    \n    \n\n        \n          \n           return list.next();", "url": "https://github.com/apache/calcite/pull/1837#discussion_r399104681", "createdAt": "2020-03-27T08:32:52Z", "author": {"login": "vvysotskyi"}, "path": "core/src/test/java/org/apache/calcite/util/Smalls.java", "diffHunk": "@@ -843,6 +843,30 @@ private void abc(StringBuilder sb, Object s) {\n     }\n   }\n \n+  /** User-defined table-macro function with named and optional parameters. */\n+  public static class AnotherTableMacroFunctionWithNamedParameters {\n+    public TranslatableTable eval(\n+        @Parameter(name = \"R\", optional = true) String r,\n+        @Parameter(name = \"S\") String s,\n+        @Parameter(name = \"T\", optional = true) Integer t,\n+        @Parameter(name = \"S2\", optional = true) String s2) {\n+      final StringBuilder sb = new StringBuilder();\n+      abc(sb, r);\n+      abc(sb, s);\n+      abc(sb, t);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwODMwNw=="}, "originalCommit": {"oid": "e2853074ba4855ee7a4a484951422150074c73a1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTExNjgxOA==", "bodyText": "Without your patch, will it happen too?", "url": "https://github.com/apache/calcite/pull/1837#discussion_r399116818", "createdAt": "2020-03-27T08:56:12Z", "author": {"login": "chunweilei"}, "path": "core/src/test/java/org/apache/calcite/util/Smalls.java", "diffHunk": "@@ -843,6 +843,30 @@ private void abc(StringBuilder sb, Object s) {\n     }\n   }\n \n+  /** User-defined table-macro function with named and optional parameters. */\n+  public static class AnotherTableMacroFunctionWithNamedParameters {\n+    public TranslatableTable eval(\n+        @Parameter(name = \"R\", optional = true) String r,\n+        @Parameter(name = \"S\") String s,\n+        @Parameter(name = \"T\", optional = true) Integer t,\n+        @Parameter(name = \"S2\", optional = true) String s2) {\n+      final StringBuilder sb = new StringBuilder();\n+      abc(sb, r);\n+      abc(sb, s);\n+      abc(sb, t);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwODMwNw=="}, "originalCommit": {"oid": "e2853074ba4855ee7a4a484951422150074c73a1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTExOTA2MA==", "bodyText": "Yes, the behavior would be the same without these changes.", "url": "https://github.com/apache/calcite/pull/1837#discussion_r399119060", "createdAt": "2020-03-27T09:00:37Z", "author": {"login": "vvysotskyi"}, "path": "core/src/test/java/org/apache/calcite/util/Smalls.java", "diffHunk": "@@ -843,6 +843,30 @@ private void abc(StringBuilder sb, Object s) {\n     }\n   }\n \n+  /** User-defined table-macro function with named and optional parameters. */\n+  public static class AnotherTableMacroFunctionWithNamedParameters {\n+    public TranslatableTable eval(\n+        @Parameter(name = \"R\", optional = true) String r,\n+        @Parameter(name = \"S\") String s,\n+        @Parameter(name = \"T\", optional = true) Integer t,\n+        @Parameter(name = \"S2\", optional = true) String s2) {\n+      final StringBuilder sb = new StringBuilder();\n+      abc(sb, r);\n+      abc(sb, s);\n+      abc(sb, t);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwODMwNw=="}, "originalCommit": {"oid": "e2853074ba4855ee7a4a484951422150074c73a1"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 317, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}