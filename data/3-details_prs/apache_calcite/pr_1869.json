{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNjk0MjAz", "number": 1869, "title": "[CALCITE-3868] Remove redundant ruleSet and ruleNames in VolcanoPlanner", "bodyText": "JIRA: https://issues.apache.org/jira/browse/CALCITE-3868", "createdAt": "2020-03-23T23:30:25Z", "url": "https://github.com/apache/calcite/pull/1869", "merged": true, "mergeCommit": {"oid": "90f3e98bb7b2de44a7ac0e2bf1d16cfb09888be1"}, "closed": true, "closedAt": "2020-04-21T09:54:35Z", "author": {"login": "hsyuan"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQnSHGgBqjMxNTc1NTA0Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZuTSEgBqjMyNTQ4NTQxOTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0290c89a383caaf0a568c783e895e5816e7ba10c", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/0290c89a383caaf0a568c783e895e5816e7ba10c", "committedDate": "2020-03-23T23:29:27Z", "message": "[CALCITE-3868] Remove redundant ruleSet and ruleNames in VolcanoPlanner"}, "afterCommit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/2df439464cac8321e5ed3c98d278c57193501dbb", "committedDate": "2020-03-23T23:54:48Z", "message": "[CALCITE-3868] Remove redundant ruleSet and ruleNames in VolcanoPlanner"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMDQ2NTgw", "url": "https://github.com/apache/calcite/pull/1869#pullrequestreview-380046580", "createdAt": "2020-03-24T07:15:17Z", "commit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMDQ5NTg5", "url": "https://github.com/apache/calcite/pull/1869#pullrequestreview-380049589", "createdAt": "2020-03-24T07:21:41Z", "commit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNzoyMTo0MlrOF6jhLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwNzoyMTo0MlrOF6jhLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk0MzY2MA==", "bodyText": "How should we validate the rule description pattern now ?", "url": "https://github.com/apache/calcite/pull/1869#discussion_r396943660", "createdAt": "2020-03-24T07:21:42Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/plan/AbstractRelOptPlanner.java", "diffHunk": "@@ -130,24 +125,15 @@ public void checkCancel() {\n    *\n    * @param rule Rule\n    */\n-  protected void mapRuleDescription(RelOptRule rule) {\n-    // Check that there isn't a rule with the same description,\n-    // also validating description string.\n-\n+  protected boolean mapRuleDescription(RelOptRule rule) {\n+    // Check that there isn't a rule with the same description\n     final String description = rule.toString();\n     assert description != null;\n-    assert !description.contains(\"$\")\n-        : \"Rule's description should not contain '$': \"\n-        + description;\n-    assert !INTEGER_PATTERN.matcher(description).matches()\n-        : \"Rule's description should not be an integer: \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTAzMTA4", "url": "https://github.com/apache/calcite/pull/1869#pullrequestreview-380103108", "createdAt": "2020-03-24T08:51:10Z", "commit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODo1MToxMFrOF6mMVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTowMTozNlrOF6mlkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4NzQ3Nw==", "bodyText": "With this change the map becomes the main data structure holding the rules so I think the Javadoc should be updated to reflect this. Increasing the visibility of the field makes it public API; it might be better to keep this private and rely on public/protected methods to recover the necessary info.", "url": "https://github.com/apache/calcite/pull/1869#discussion_r396987477", "createdAt": "2020-03-24T08:51:10Z", "author": {"login": "zabetak"}, "path": "core/src/main/java/org/apache/calcite/plan/AbstractRelOptPlanner.java", "diffHunk": "@@ -44,18 +44,13 @@\n  * Abstract base for implementations of the {@link RelOptPlanner} interface.\n  */\n public abstract class AbstractRelOptPlanner implements RelOptPlanner {\n-  //~ Static fields/initializers ---------------------------------------------\n-\n-  /** Regular expression for integer. */\n-  private static final Pattern INTEGER_PATTERN = Pattern.compile(\"[0-9]+\");\n-\n   //~ Instance fields --------------------------------------------------------\n \n   /**\n    * Maps rule description to rule, just to ensure that rules' descriptions\n    * are unique.\n    */\n-  private final Map<String, RelOptRule> mapDescToRule = new HashMap<>();\n+  protected final Map<String, RelOptRule> mapDescToRule = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4OTE2Nw==", "bodyText": "The method now basically registers the rule to the planner so it might be better to rename this entirely to addRule.", "url": "https://github.com/apache/calcite/pull/1869#discussion_r396989167", "createdAt": "2020-03-24T08:54:00Z", "author": {"login": "zabetak"}, "path": "core/src/main/java/org/apache/calcite/plan/AbstractRelOptPlanner.java", "diffHunk": "@@ -130,24 +125,15 @@ public void checkCancel() {\n    *\n    * @param rule Rule\n    */\n-  protected void mapRuleDescription(RelOptRule rule) {\n-    // Check that there isn't a rule with the same description,\n-    // also validating description string.\n-\n+  protected boolean mapRuleDescription(RelOptRule rule) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4OTYzNw==", "bodyText": "Rename this to removeRule and update the Javadoc?", "url": "https://github.com/apache/calcite/pull/1869#discussion_r396989637", "createdAt": "2020-03-24T08:54:46Z", "author": {"login": "zabetak"}, "path": "core/src/main/java/org/apache/calcite/plan/AbstractRelOptPlanner.java", "diffHunk": "@@ -156,16 +142,18 @@ protected void mapRuleDescription(RelOptRule rule) {\n             + \"existing rule=\" + existingRule + \"; new rule=\" + rule);\n       }\n     }\n+    return true;\n   }\n \n   /**\n    * Removes the mapping between a rule and its description.\n    *\n    * @param rule Rule\n+   * @return the rule that is removed, or null if no rule is removed\n    */\n-  protected void unmapRuleDescription(RelOptRule rule) {\n+  protected RelOptRule unmapRuleDescription(RelOptRule rule) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5MjczMA==", "bodyText": "Would it be a good idea to move the method to AbstractRelOptPlanner? This would allow us to keep mapDescToRule private and replace calls to mapDescToRule.values() with calls to this method.", "url": "https://github.com/apache/calcite/pull/1869#discussion_r396992730", "createdAt": "2020-03-24T08:59:39Z", "author": {"login": "zabetak"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -392,35 +382,24 @@ public RelSet getSet(RelNode rel) {\n     this.mapRel2Subset.clear();\n     this.relImportances.clear();\n     this.ruleQueue.clear();\n-    this.ruleNames.clear();\n     this.materializations.clear();\n     this.latticeByName.clear();\n     this.provenanceMap.clear();\n   }\n \n   public List<RelOptRule> getRules() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5MzkzNg==", "bodyText": "If we choose to add this method to the superclass (instead of having mapRuleDescription) then here we can ovverride.", "url": "https://github.com/apache/calcite/pull/1869#discussion_r396993936", "createdAt": "2020-03-24T09:01:36Z", "author": {"login": "zabetak"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -392,35 +382,24 @@ public RelSet getSet(RelNode rel) {\n     this.mapRel2Subset.clear();\n     this.relImportances.clear();\n     this.ruleQueue.clear();\n-    this.ruleNames.clear();\n     this.materializations.clear();\n     this.latticeByName.clear();\n     this.provenanceMap.clear();\n   }\n \n   public List<RelOptRule> getRules() {\n-    return ImmutableList.copyOf(ruleSet);\n+    return ImmutableList.copyOf(mapDescToRule.values());\n   }\n \n   public boolean addRule(RelOptRule rule) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb"}, "originalPosition": 48}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2df439464cac8321e5ed3c98d278c57193501dbb", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/2df439464cac8321e5ed3c98d278c57193501dbb", "committedDate": "2020-03-23T23:54:48Z", "message": "[CALCITE-3868] Remove redundant ruleSet and ruleNames in VolcanoPlanner"}, "afterCommit": {"oid": "19f913d76fb488d6b6615b74be38d6edf9699c12", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/19f913d76fb488d6b6615b74be38d6edf9699c12", "committedDate": "2020-03-25T21:30:16Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNzQ0MjA2", "url": "https://github.com/apache/calcite/pull/1869#pullrequestreview-381744206", "createdAt": "2020-03-26T07:06:49Z", "commit": {"oid": "19f913d76fb488d6b6615b74be38d6edf9699c12"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwNzowNjo0OVrOF75owQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwNzowNjo0OVrOF75owQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM1NDYyNQ==", "bodyText": "If we already know the size of mapDescToRule, we can create a set with exact size, which will eliminate capacity expansion overhead and space waste when creating. Even though this is trivial update, I think it is always a good manner to create collection in such way if possible.\ninstruction.ruleSet = Sets.newHashSetWithExpectedSize(mapDescToRule.size());", "url": "https://github.com/apache/calcite/pull/1869#discussion_r398354625", "createdAt": "2020-03-26T07:06:49Z", "author": {"login": "neoremind"}, "path": "core/src/main/java/org/apache/calcite/plan/hep/HepPlanner.java", "diffHunk": "@@ -275,7 +253,7 @@ void executeInstruction(\n     LOGGER.trace(\"Applying rule class {}\", instruction.ruleClass);\n     if (instruction.ruleSet == null) {\n       instruction.ruleSet = new LinkedHashSet<>();\n-      for (RelOptRule rule : allRules) {\n+      for (RelOptRule rule : mapDescToRule.values()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19f913d76fb488d6b6615b74be38d6edf9699c12"}, "originalPosition": 50}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19f913d76fb488d6b6615b74be38d6edf9699c12", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/19f913d76fb488d6b6615b74be38d6edf9699c12", "committedDate": "2020-03-25T21:30:16Z", "message": "Address comments"}, "afterCommit": {"oid": "21590a8557d86c177368a06db02b3d510b60c8af", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/21590a8557d86c177368a06db02b3d510b60c8af", "committedDate": "2020-03-29T02:13:12Z", "message": "[CALCITE-3868] Remove redundant ruleSet and ruleNames in VolcanoPlanner"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21590a8557d86c177368a06db02b3d510b60c8af", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/21590a8557d86c177368a06db02b3d510b60c8af", "committedDate": "2020-03-29T02:13:12Z", "message": "[CALCITE-3868] Remove redundant ruleSet and ruleNames in VolcanoPlanner"}, "afterCommit": {"oid": "9dddbdf23d8ddcf8b404bc1dc0afa93812eee582", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/9dddbdf23d8ddcf8b404bc1dc0afa93812eee582", "committedDate": "2020-04-13T01:13:32Z", "message": "[CALCITE-3868] Remove redundant ruleSet and ruleNames in VolcanoPlanner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "010645ad411d8389100fa959822ef25798c1d5af", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/010645ad411d8389100fa959822ef25798c1d5af", "committedDate": "2020-04-21T07:10:26Z", "message": "[CALCITE-3868] Remove redundant ruleSet and ruleNames in VolcanoPlanner"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9dddbdf23d8ddcf8b404bc1dc0afa93812eee582", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/9dddbdf23d8ddcf8b404bc1dc0afa93812eee582", "committedDate": "2020-04-13T01:13:32Z", "message": "[CALCITE-3868] Remove redundant ruleSet and ruleNames in VolcanoPlanner"}, "afterCommit": {"oid": "010645ad411d8389100fa959822ef25798c1d5af", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/010645ad411d8389100fa959822ef25798c1d5af", "committedDate": "2020-04-21T07:10:26Z", "message": "[CALCITE-3868] Remove redundant ruleSet and ruleNames in VolcanoPlanner"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3905, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}