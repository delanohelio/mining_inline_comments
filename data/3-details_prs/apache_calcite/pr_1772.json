{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MDQ3ODQ3", "number": 1772, "title": "[CALCITE-3744] Duplicate rule matches when RelSet gets merged", "bodyText": "JIRA: https://issues.apache.org/jira/browse/CALCITE-3744\nSome times RelSet can get merged. e.g.:\nEach number represet Rel id, and they are in different RelSet.\n 1            4\n   \\         /\n     2      /\n       \\   /\n         3\n\nAssume in the rulequeue, we have rule match with name of 12, 23, 43. For\nsimplicity, omit the rule name, first digit represent the parent RelNode,\nsecond represent the child.\nIf after some rule, we merged the set of 3 into the set of 2, and RelNode 4's\ninput is replaced by RelSubset of 2. We will retrigger rules and try to add\nrulematch 12, 42, 43 into rule queue.\n12 will be filtered out, because there is duplicate in the RuleMatch names set.\nBut for 43, it now has different rulematch digest with previous match, because\nRelNode # 4's input RelSubset changed, its digest also changed. So we can't\ndetect the duplication and will re-apply rulematch 43 twice.", "createdAt": "2020-01-21T00:37:14Z", "url": "https://github.com/apache/calcite/pull/1772", "merged": true, "mergeCommit": {"oid": "0196bb67a5255b7b0f9e297c74742c4d7203403d"}, "closed": true, "closedAt": "2020-01-23T21:43:41Z", "author": {"login": "hsyuan"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8ZIpBgFqTM0NTYyNTQ2OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8tkp6gFqTM0NjMzMzYzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NjI1NDY4", "url": "https://github.com/apache/calcite/pull/1772#pullrequestreview-345625468", "createdAt": "2020-01-21T04:07:26Z", "commit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNDowNzoyN1rOFft_Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNDowNzoyN1rOFft_Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgwMzY4Mg==", "bodyText": "as we are changing how the digest is computed anyway, we can simplify this as buf.append(',');", "url": "https://github.com/apache/calcite/pull/1772#discussion_r368803682", "createdAt": "2020-01-21T04:07:27Z", "author": {"login": "zhenyu-hou"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -145,16 +144,16 @@ private String computeDigest() {\n       if (i > 0) {\n         buf.append(\", \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NjI1NTY4", "url": "https://github.com/apache/calcite/pull/1772#pullrequestreview-345625568", "createdAt": "2020-01-21T04:08:03Z", "commit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNDowODowNFrOFft_sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNDowODowNFrOFft_sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgwMzc2MQ==", "bodyText": "how about buf.append('#').append(rels[i].getId());", "url": "https://github.com/apache/calcite/pull/1772#discussion_r368803761", "createdAt": "2020-01-21T04:08:04Z", "author": {"login": "zhenyu-hou"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -145,16 +144,16 @@ private String computeDigest() {\n       if (i > 0) {\n         buf.append(\", \");\n       }\n-      RelOptUtil.appendRelDescription(buf, rels[i]);\n+      buf.append(\"#\" + rels[i].getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NjI1Njgx", "url": "https://github.com/apache/calcite/pull/1772#pullrequestreview-345625681", "createdAt": "2020-01-21T04:08:36Z", "commit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNDowODozNlrOFfuAFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNDowODozNlrOFfuAFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgwMzg2MQ==", "bodyText": "similarly, change to buf.append(']') to improve perf slightly?", "url": "https://github.com/apache/calcite/pull/1772#discussion_r368803861", "createdAt": "2020-01-21T04:08:36Z", "author": {"login": "zhenyu-hou"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -145,16 +144,16 @@ private String computeDigest() {\n       if (i > 0) {\n         buf.append(\", \");\n       }\n-      RelOptUtil.appendRelDescription(buf, rels[i]);\n+      buf.append(\"#\" + rels[i].getId());\n     }\n     buf.append(\"]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NjUzNjQ4", "url": "https://github.com/apache/calcite/pull/1772#pullrequestreview-345653648", "createdAt": "2020-01-21T06:19:22Z", "commit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNjoxOToyMlrOFfvbWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNjoxOToyMlrOFfvbWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgyNzIyNQ==", "bodyText": "Can we remove the relevant entry when subsets are merged/removed?\nOtherwise, it looks like a memory leak.", "url": "https://github.com/apache/calcite/pull/1772#discussion_r368827225", "createdAt": "2020-01-21T06:19:22Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/RuleQueue.java", "diffHunk": "@@ -494,11 +494,10 @@ VolcanoRuleMatch popMatch(VolcanoPlannerPhase phase) {\n       }\n     }\n \n-    // A rule match's digest is composed of the operand RelNodes' digests,\n-    // which may have changed if sets have merged since the rule match was\n-    // enqueued.\n-    match.recomputeDigest();\n-\n+    // If sets have merged since the rule match was enqueued, the match\n+    // may not be removed from the matchMap because the subset may have\n+    // changed, it is OK to leave it since the matchMap will be cleared\n+    // at the end.\n     phaseMatchList.matchMap.remove(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07107cd3ab503ba32d4549d978078fc524ccc095", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/07107cd3ab503ba32d4549d978078fc524ccc095", "committedDate": "2020-01-21T19:22:35Z", "message": "[CALCITE-3744] Duplicate rule matches when RelSet gets merged\n\nSome times RelSet can get merged. e.g.\n\nEach number represet Rel id, and they are in different RelSet.\n\n 1            4\n   \\         /\n     2      /\n       \\   /\n         3\nAssume in the rulequeue, we have rule match with name of 12, 23, 43. For\nsimplicity, omit the rule name, first digit represent the parent RelNode,\nsecond represent the child.\n\nIf after some rule, we merged the set of 3 into the set of 2, and RelNode 4's\ninput is replaced by RelSubset of 2. We will retrigger rules and try to add\nrulematch 12, 42, 43 into rule queue.\n\n12 will be filtered out, because there is duplicate in the RuleMatch names set.\nBut for 43, it now has different rulematch digest with previous match, because\nRelNode #4's input RelSubset changed, its digest also changed. So we can't\ndetect the duplication and will re-apply rulematch 43 twice."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/34f04881f66628678642274ba75435c48f97c913", "committedDate": "2020-01-21T00:13:47Z", "message": "[CALCITE-3744] Duplicate rule matches when RelSet gets merged\n\nSome times RelSet can get merged. e.g.\n\nEach number represet Rel id, and they are in different RelSet.\n\n 1            4\n   \\         /\n     2      /\n       \\   /\n         3\nAssume in the rulequeue, we have rule match with name of 12, 23, 43. For\nsimplicity, omit the rule name, first digit represent the parent RelNode,\nsecond represent the child.\n\nIf after some rule, we merged the set of 3 into the set of 2, and RelNode 4's\ninput is replaced by RelSubset of 2. We will retrigger rules and try to add\nrulematch 12, 42, 43 into rule queue.\n\n12 will be filtered out, because there is duplicate in the RuleMatch names set.\nBut for 43, it now has different rulematch digest with previous match, because\nRelNode #4's input RelSubset changed, its digest also changed. So we can't\ndetect the duplication and will re-apply rulematch 43 twice."}, "afterCommit": {"oid": "07107cd3ab503ba32d4549d978078fc524ccc095", "author": {"user": {"login": "hsyuan", "name": "Haisheng Yuan"}}, "url": "https://github.com/apache/calcite/commit/07107cd3ab503ba32d4549d978078fc524ccc095", "committedDate": "2020-01-21T19:22:35Z", "message": "[CALCITE-3744] Duplicate rule matches when RelSet gets merged\n\nSome times RelSet can get merged. e.g.\n\nEach number represet Rel id, and they are in different RelSet.\n\n 1            4\n   \\         /\n     2      /\n       \\   /\n         3\nAssume in the rulequeue, we have rule match with name of 12, 23, 43. For\nsimplicity, omit the rule name, first digit represent the parent RelNode,\nsecond represent the child.\n\nIf after some rule, we merged the set of 3 into the set of 2, and RelNode 4's\ninput is replaced by RelSubset of 2. We will retrigger rules and try to add\nrulematch 12, 42, 43 into rule queue.\n\n12 will be filtered out, because there is duplicate in the RuleMatch names set.\nBut for 43, it now has different rulematch digest with previous match, because\nRelNode #4's input RelSubset changed, its digest also changed. So we can't\ndetect the duplication and will re-apply rulematch 43 twice."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MzMzNjM3", "url": "https://github.com/apache/calcite/pull/1772#pullrequestreview-346333637", "createdAt": "2020-01-22T03:56:08Z", "commit": {"oid": "07107cd3ab503ba32d4549d978078fc524ccc095"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMzo1NjowOVrOFgP8-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMzo1NjowOVrOFgP8-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM2MDEyMA==", "bodyText": "why remove the whitespace ?", "url": "https://github.com/apache/calcite/pull/1772#discussion_r369360120", "createdAt": "2020-01-22T03:56:09Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -143,18 +142,18 @@ private String computeDigest() {\n         new StringBuilder(\"rule [\" + getRule() + \"] rels [\");\n     for (int i = 0; i < rels.length; i++) {\n       if (i > 0) {\n-        buf.append(\", \");\n+        buf.append(',');\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07107cd3ab503ba32d4549d978078fc524ccc095"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4199, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}