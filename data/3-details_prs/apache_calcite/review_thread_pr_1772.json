{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MDQ3ODQ3", "number": 1772, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNDowNzoyN1rODZXvog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMzo1NjowOVrODZtWPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTMwMDE4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNDowNzoyN1rOFft_Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToyMjo1OFrOFgF6Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgwMzY4Mg==", "bodyText": "as we are changing how the digest is computed anyway, we can simplify this as buf.append(',');", "url": "https://github.com/apache/calcite/pull/1772#discussion_r368803682", "createdAt": "2020-01-21T04:07:27Z", "author": {"login": "zhenyu-hou"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -145,16 +144,16 @@ private String computeDigest() {\n       if (i > 0) {\n         buf.append(\", \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5NTYxOA==", "bodyText": "done", "url": "https://github.com/apache/calcite/pull/1772#discussion_r369195618", "createdAt": "2020-01-21T19:22:58Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -145,16 +144,16 @@ private String computeDigest() {\n       if (i > 0) {\n         buf.append(\", \");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgwMzY4Mg=="}, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTMwMDY2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNDowODowNFrOFft_sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToyMzoxNlrOFgF7BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgwMzc2MQ==", "bodyText": "how about buf.append('#').append(rels[i].getId());", "url": "https://github.com/apache/calcite/pull/1772#discussion_r368803761", "createdAt": "2020-01-21T04:08:04Z", "author": {"login": "zhenyu-hou"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -145,16 +144,16 @@ private String computeDigest() {\n       if (i > 0) {\n         buf.append(\", \");\n       }\n-      RelOptUtil.appendRelDescription(buf, rels[i]);\n+      buf.append(\"#\" + rels[i].getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5NTc4MA==", "bodyText": "done", "url": "https://github.com/apache/calcite/pull/1772#discussion_r369195780", "createdAt": "2020-01-21T19:23:16Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -145,16 +144,16 @@ private String computeDigest() {\n       if (i > 0) {\n         buf.append(\", \");\n       }\n-      RelOptUtil.appendRelDescription(buf, rels[i]);\n+      buf.append(\"#\" + rels[i].getId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgwMzc2MQ=="}, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTMwMTMwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNDowODozNlrOFfuAFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToyMzozMFrOFgF7hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgwMzg2MQ==", "bodyText": "similarly, change to buf.append(']') to improve perf slightly?", "url": "https://github.com/apache/calcite/pull/1772#discussion_r368803861", "createdAt": "2020-01-21T04:08:36Z", "author": {"login": "zhenyu-hou"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -145,16 +144,16 @@ private String computeDigest() {\n       if (i > 0) {\n         buf.append(\", \");\n       }\n-      RelOptUtil.appendRelDescription(buf, rels[i]);\n+      buf.append(\"#\" + rels[i].getId());\n     }\n     buf.append(\"]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5NTkwOQ==", "bodyText": "done", "url": "https://github.com/apache/calcite/pull/1772#discussion_r369195909", "createdAt": "2020-01-21T19:23:30Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -145,16 +144,16 @@ private String computeDigest() {\n       if (i > 0) {\n         buf.append(\", \");\n       }\n-      RelOptUtil.appendRelDescription(buf, rels[i]);\n+      buf.append(\"#\" + rels[i].getId());\n     }\n     buf.append(\"]\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgwMzg2MQ=="}, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3OTQ1MTIwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/calcite/plan/volcano/RuleQueue.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQwNjoxOToyMlrOFfvbWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwNDo0ODoxOVrOFgQeIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgyNzIyNQ==", "bodyText": "Can we remove the relevant entry when subsets are merged/removed?\nOtherwise, it looks like a memory leak.", "url": "https://github.com/apache/calcite/pull/1772#discussion_r368827225", "createdAt": "2020-01-21T06:19:22Z", "author": {"login": "vlsi"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/RuleQueue.java", "diffHunk": "@@ -494,11 +494,10 @@ VolcanoRuleMatch popMatch(VolcanoPlannerPhase phase) {\n       }\n     }\n \n-    // A rule match's digest is composed of the operand RelNodes' digests,\n-    // which may have changed if sets have merged since the rule match was\n-    // enqueued.\n-    match.recomputeDigest();\n-\n+    // If sets have merged since the rule match was enqueued, the match\n+    // may not be removed from the matchMap because the subset may have\n+    // changed, it is OK to leave it since the matchMap will be cleared\n+    // at the end.\n     phaseMatchList.matchMap.remove(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI3MTUwMg==", "bodyText": "You have to remove all the matches for the subset in matchMap, find them in the rulequeue and remove them from rulequeue, and remove them from names set. I don't think it is worth sweating.\nSince the leak already exists before this change, I prefer leaving it as it is.\nI am going to propose a change to completely remove rulematch importance.", "url": "https://github.com/apache/calcite/pull/1772#discussion_r369271502", "createdAt": "2020-01-21T22:13:12Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/RuleQueue.java", "diffHunk": "@@ -494,11 +494,10 @@ VolcanoRuleMatch popMatch(VolcanoPlannerPhase phase) {\n       }\n     }\n \n-    // A rule match's digest is composed of the operand RelNodes' digests,\n-    // which may have changed if sets have merged since the rule match was\n-    // enqueued.\n-    match.recomputeDigest();\n-\n+    // If sets have merged since the rule match was enqueued, the match\n+    // may not be removed from the matchMap because the subset may have\n+    // changed, it is OK to leave it since the matchMap will be cleared\n+    // at the end.\n     phaseMatchList.matchMap.remove(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgyNzIyNQ=="}, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1OTk2Mw==", "bodyText": "The change does not fix the title, right ?", "url": "https://github.com/apache/calcite/pull/1772#discussion_r369359963", "createdAt": "2020-01-22T03:55:22Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/RuleQueue.java", "diffHunk": "@@ -494,11 +494,10 @@ VolcanoRuleMatch popMatch(VolcanoPlannerPhase phase) {\n       }\n     }\n \n-    // A rule match's digest is composed of the operand RelNodes' digests,\n-    // which may have changed if sets have merged since the rule match was\n-    // enqueued.\n-    match.recomputeDigest();\n-\n+    // If sets have merged since the rule match was enqueued, the match\n+    // may not be removed from the matchMap because the subset may have\n+    // changed, it is OK to leave it since the matchMap will be cleared\n+    // at the end.\n     phaseMatchList.matchMap.remove(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgyNzIyNQ=="}, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM2ODYwOQ==", "bodyText": "What do you mean by not fix the title?", "url": "https://github.com/apache/calcite/pull/1772#discussion_r369368609", "createdAt": "2020-01-22T04:48:19Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/RuleQueue.java", "diffHunk": "@@ -494,11 +494,10 @@ VolcanoRuleMatch popMatch(VolcanoPlannerPhase phase) {\n       }\n     }\n \n-    // A rule match's digest is composed of the operand RelNodes' digests,\n-    // which may have changed if sets have merged since the rule match was\n-    // enqueued.\n-    match.recomputeDigest();\n-\n+    // If sets have merged since the rule match was enqueued, the match\n+    // may not be removed from the matchMap because the subset may have\n+    // changed, it is OK to leave it since the matchMap will be cleared\n+    // at the end.\n     phaseMatchList.matchMap.remove(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODgyNzIyNQ=="}, "originalCommit": {"oid": "34f04881f66628678642274ba75435c48f97c913"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjgzOTY3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMzo1NjowOVrOFgP8-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwNDo0NjowM1rOFgQcwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM2MDEyMA==", "bodyText": "why remove the whitespace ?", "url": "https://github.com/apache/calcite/pull/1772#discussion_r369360120", "createdAt": "2020-01-22T03:56:09Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -143,18 +142,18 @@ private String computeDigest() {\n         new StringBuilder(\"rule [\" + getRule() + \"] rels [\");\n     for (int i = 0; i < rels.length; i++) {\n       if (i > 0) {\n-        buf.append(\", \");\n+        buf.append(',');\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07107cd3ab503ba32d4549d978078fc524ccc095"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM2ODI1OA==", "bodyText": "It is useless.", "url": "https://github.com/apache/calcite/pull/1772#discussion_r369368258", "createdAt": "2020-01-22T04:46:03Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoRuleMatch.java", "diffHunk": "@@ -143,18 +142,18 @@ private String computeDigest() {\n         new StringBuilder(\"rule [\" + getRule() + \"] rels [\");\n     for (int i = 0; i < rels.length; i++) {\n       if (i > 0) {\n-        buf.append(\", \");\n+        buf.append(',');\n       }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM2MDEyMA=="}, "originalCommit": {"oid": "07107cd3ab503ba32d4549d978078fc524ccc095"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 278, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}