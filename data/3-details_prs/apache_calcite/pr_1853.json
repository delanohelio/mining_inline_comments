{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MTE2ODAx", "number": 1853, "title": "[CALCITE-3851] Replace the node importance map with a set for pruned nodes", "bodyText": "Currently, volcano planner stores rel node importances with a map. In fact, the value of the map can only be 0.\nSo there is no need to store the values, and we replace the map with a set to store nodes whose importances are 0.\nThis makes the code logic clearer, and avoids instability caused by comparing floating point values.", "createdAt": "2020-03-10T12:55:49Z", "url": "https://github.com/apache/calcite/pull/1853", "merged": true, "mergeCommit": {"oid": "15152b629c784bf7b82efe5bcbe5931ee18682c7"}, "closed": true, "closedAt": "2020-04-08T02:23:54Z", "author": {"login": "liyafan82"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMWJcaAFqTM3MjE4MDAwNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTrBwogFqTM4NjM1NDM2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTgwMDA3", "url": "https://github.com/apache/calcite/pull/1853#pullrequestreview-372180007", "createdAt": "2020-03-10T17:41:24Z", "commit": {"oid": "5ba9b3436bac0e0996ae2efa4791e81388cd0ce8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzo0MToyNFrOF0Z6tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzo0MToyNFrOF0Z6tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ5NDkwMQ==", "bodyText": "You can remove this method.", "url": "https://github.com/apache/calcite/pull/1853#discussion_r390494901", "createdAt": "2020-03-10T17:41:24Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -917,13 +917,13 @@ RelNode changeTraitsUsingConverters(\n   public void setImportance(RelNode rel, double importance) {\n     assert rel != null;\n     if (importance == 0d) {\n-      relImportances.put(rel, importance);\n+      nodesToSkip.add(rel);\n     }\n   }\n \n   Double getImportance(RelNode rel) {\n     assert rel != null;\n-    return relImportances.get(rel);\n+    return nodesToSkip.contains(rel) ? 0d : null;\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ba9b3436bac0e0996ae2efa4791e81388cd0ce8"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTgwMTgw", "url": "https://github.com/apache/calcite/pull/1853#pullrequestreview-372180180", "createdAt": "2020-03-10T17:41:37Z", "commit": {"oid": "5ba9b3436bac0e0996ae2efa4791e81388cd0ce8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzo0MTozN1rOF0Z7Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzo0MTozN1rOF0Z7Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ5NTA1MA==", "bodyText": "prunedNodes", "url": "https://github.com/apache/calcite/pull/1853#discussion_r390495050", "createdAt": "2020-03-10T17:41:37Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -135,16 +135,16 @@\n       new IdentityHashMap<>();\n \n   /**\n-   * The importance of relational expressions.\n+   * The nodes with zero importance.\n    *\n-   * <p>The map contains only RelNodes whose importance has been overridden\n+   * <p>The set contains only RelNodes whose importance has been set to 0\n    * using {@link RelOptPlanner#setImportance(RelNode, double)}. Other\n    * RelNodes are presumed to have 'normal' importance.\n    *\n    * <p>If a RelNode has 0 importance, all {@link RelOptRuleCall}s using it\n    * are ignored, and future RelOptRuleCalls are not queued up.\n    */\n-  final Map<RelNode, Double> relImportances = new HashMap<>();\n+  final Set<RelNode> nodesToSkip = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ba9b3436bac0e0996ae2efa4791e81388cd0ce8"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjAyNzEw", "url": "https://github.com/apache/calcite/pull/1853#pullrequestreview-374602710", "createdAt": "2020-03-13T20:31:22Z", "commit": {"oid": "ffb0b11a51cd7ce4f57f2c60a2aebdc18217a8a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMDozMToyMlrOF2RltQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMDozMToyMlrOF2RltQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ1NTYwNQ==", "bodyText": "Is it possible to add a API to RelNode? e.g.\nvoid RelNode.setPruned();\nboolean RelNode.isPruned();", "url": "https://github.com/apache/calcite/pull/1853#discussion_r392455605", "createdAt": "2020-03-13T20:31:22Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/AbstractRelOptPlanner.java", "diffHunk": "@@ -221,9 +221,13 @@ public long getRelMetadataTimestamp(RelNode rel) {\n     return 0;\n   }\n \n+  @Deprecated\n   public void setImportance(RelNode rel, double importance) {\n   }\n \n+  public void pruneNode(RelNode rel) {\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffb0b11a51cd7ce4f57f2c60a2aebdc18217a8a4"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjA0MDkw", "url": "https://github.com/apache/calcite/pull/1853#pullrequestreview-374604090", "createdAt": "2020-03-13T20:34:16Z", "commit": {"oid": "ffb0b11a51cd7ce4f57f2c60a2aebdc18217a8a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMDozNDoxNlrOF2Rs5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMDozNDoxNlrOF2Rs5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ1NzQ0NA==", "bodyText": "change to pruned", "url": "https://github.com/apache/calcite/pull/1853#discussion_r392457444", "createdAt": "2020-03-13T20:34:16Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/VolcanoPlanner.java", "diffHunk": "@@ -1003,9 +999,8 @@ private void dumpSets(PrintWriter pw) {\n               }\n             }\n           }\n-          Double importance = relImportances.get(rel);\n-          if (importance != null) {\n-            pw.print(\", importance=\" + importance);\n+          if (prunedNodes.contains(rel)) {\n+            pw.print(\", importance=0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffb0b11a51cd7ce4f57f2c60a2aebdc18217a8a4"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NzIyMzIx", "url": "https://github.com/apache/calcite/pull/1853#pullrequestreview-375722321", "createdAt": "2020-03-17T03:45:14Z", "commit": {"oid": "aa691ecbd3486e9630c8492521179c783cbfdefe"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NzIyNjg4", "url": "https://github.com/apache/calcite/pull/1853#pullrequestreview-375722688", "createdAt": "2020-03-17T03:46:33Z", "commit": {"oid": "aa691ecbd3486e9630c8492521179c783cbfdefe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwMzo0NjozM1rOF3NDbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwMzo0NjozM1rOF3NDbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyOTg3MQ==", "bodyText": "Why change it ?", "url": "https://github.com/apache/calcite/pull/1853#discussion_r393429871", "createdAt": "2020-03-17T03:46:33Z", "author": {"login": "chunweilei"}, "path": "core/src/main/java/org/apache/calcite/plan/volcano/RuleQueue.java", "diffHunk": "@@ -265,7 +264,7 @@ private void checkDuplicateSubsets(Deque<RelSubset> subsets,\n    * for a particular\n    * {@link VolcanoPlannerPhase phase of the planner's execution}.\n    */\n-  private static class PhaseMatchList {\n+  static class PhaseMatchList {\n     /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa691ecbd3486e9630c8492521179c783cbfdefe"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NzQ4Mjgx", "url": "https://github.com/apache/calcite/pull/1853#pullrequestreview-375748281", "createdAt": "2020-03-17T05:26:09Z", "commit": {"oid": "aa691ecbd3486e9630c8492521179c783cbfdefe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNToyNjowOVrOF3OXZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwNToyNjowOVrOF3OXZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ1MTM2NQ==", "bodyText": "needs update", "url": "https://github.com/apache/calcite/pull/1853#discussion_r393451365", "createdAt": "2020-03-17T05:26:09Z", "author": {"login": "hsyuan"}, "path": "core/src/main/java/org/apache/calcite/plan/RelOptPlanner.java", "diffHunk": "@@ -307,9 +307,24 @@ RelNode register(\n    *\n    * @param rel        Relational expression\n    * @param importance Importance\n+   *\n+   * @deprecated This API will be removed in a future release, as we no longer\n+   * support the concept of node importance. Please use\n+   * {@link RelOptPlanner#pruneNode(RelNode)} method instead.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa691ecbd3486e9630c8492521179c783cbfdefe"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa691ecbd3486e9630c8492521179c783cbfdefe", "author": {"user": {"login": "liyafan82", "name": null}}, "url": "https://github.com/apache/calcite/commit/aa691ecbd3486e9630c8492521179c783cbfdefe", "committedDate": "2020-03-14T09:17:09Z", "message": "[CALCITE-3851] Revise API name"}, "afterCommit": {"oid": "c97d2cd29435beea895eecc648fca6d1166507c8", "author": {"user": {"login": "liyafan82", "name": null}}, "url": "https://github.com/apache/calcite/commit/c97d2cd29435beea895eecc648fca6d1166507c8", "committedDate": "2020-03-17T09:27:30Z", "message": "[CALCITE-3851] Replace the node importance map with a set for pruned nodes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c97d2cd29435beea895eecc648fca6d1166507c8", "author": {"user": {"login": "liyafan82", "name": null}}, "url": "https://github.com/apache/calcite/commit/c97d2cd29435beea895eecc648fca6d1166507c8", "committedDate": "2020-03-17T09:27:30Z", "message": "[CALCITE-3851] Replace the node importance map with a set for pruned nodes"}, "afterCommit": {"oid": "23207422ba9bb83827c602339149f13029d64fb3", "author": {"user": {"login": "liyafan82", "name": null}}, "url": "https://github.com/apache/calcite/commit/23207422ba9bb83827c602339149f13029d64fb3", "committedDate": "2020-03-18T11:58:20Z", "message": "[CALCITE-3851] Replace the node importance map with a set for pruned nodes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MjQzNzI2", "url": "https://github.com/apache/calcite/pull/1853#pullrequestreview-378243726", "createdAt": "2020-03-20T05:46:35Z", "commit": {"oid": "23207422ba9bb83827c602339149f13029d64fb3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwNTo0NjozNVrOF5IOQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwNTo0NzowNlrOF5IOqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ0Nzg3NQ==", "bodyText": "Mark a deprecation version here", "url": "https://github.com/apache/calcite/pull/1853#discussion_r395447875", "createdAt": "2020-03-20T05:46:35Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/plan/AbstractRelOptPlanner.java", "diffHunk": "@@ -221,9 +221,13 @@ public long getRelMetadataTimestamp(RelNode rel) {\n     return 0;\n   }\n \n+  @Deprecated\n   public void setImportance(RelNode rel, double importance) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23207422ba9bb83827c602339149f13029d64fb3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ0Nzk3Ng==", "bodyText": "Missing deprecation version.", "url": "https://github.com/apache/calcite/pull/1853#discussion_r395447976", "createdAt": "2020-03-20T05:47:06Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/plan/RelOptPlanner.java", "diffHunk": "@@ -307,9 +307,24 @@ RelNode register(\n    *\n    * @param rel        Relational expression\n    * @param importance Importance\n+   *\n+   * @deprecated This API will be removed in a future release, as we no longer\n+   * support the concept of node importance. Please use\n+   * {@link RelOptPlanner#prune(RelNode)} method instead.\n    */\n+  @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23207422ba9bb83827c602339149f13029d64fb3"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23207422ba9bb83827c602339149f13029d64fb3", "author": {"user": {"login": "liyafan82", "name": null}}, "url": "https://github.com/apache/calcite/commit/23207422ba9bb83827c602339149f13029d64fb3", "committedDate": "2020-03-18T11:58:20Z", "message": "[CALCITE-3851] Replace the node importance map with a set for pruned nodes"}, "afterCommit": {"oid": "b147bfb1ba85763d594ec9757772317455e84366", "author": {"user": {"login": "liyafan82", "name": null}}, "url": "https://github.com/apache/calcite/commit/b147bfb1ba85763d594ec9757772317455e84366", "committedDate": "2020-03-20T06:37:21Z", "message": "[CALCITE-3851] Replace the node importance map with a set for pruned nodes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjMyMDQ3", "url": "https://github.com/apache/calcite/pull/1853#pullrequestreview-385232047", "createdAt": "2020-04-01T02:48:31Z", "commit": {"oid": "b147bfb1ba85763d594ec9757772317455e84366"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "877b3e605b7e8b24d402c85cac6f27994e142e8b", "author": {"user": {"login": "liyafan82", "name": null}}, "url": "https://github.com/apache/calcite/commit/877b3e605b7e8b24d402c85cac6f27994e142e8b", "committedDate": "2020-04-01T03:38:54Z", "message": "[CALCITE-3851] Replace the node importance map with a set for pruned nodes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b147bfb1ba85763d594ec9757772317455e84366", "author": {"user": {"login": "liyafan82", "name": null}}, "url": "https://github.com/apache/calcite/commit/b147bfb1ba85763d594ec9757772317455e84366", "committedDate": "2020-03-20T06:37:21Z", "message": "[CALCITE-3851] Replace the node importance map with a set for pruned nodes"}, "afterCommit": {"oid": "877b3e605b7e8b24d402c85cac6f27994e142e8b", "author": {"user": {"login": "liyafan82", "name": null}}, "url": "https://github.com/apache/calcite/commit/877b3e605b7e8b24d402c85cac6f27994e142e8b", "committedDate": "2020-04-01T03:38:54Z", "message": "[CALCITE-3851] Replace the node importance map with a set for pruned nodes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MzU0MzY5", "url": "https://github.com/apache/calcite/pull/1853#pullrequestreview-386354369", "createdAt": "2020-04-02T11:58:29Z", "commit": {"oid": "877b3e605b7e8b24d402c85cac6f27994e142e8b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4360, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}