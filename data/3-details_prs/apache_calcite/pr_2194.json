{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MzY0OTc3", "number": 2194, "title": "[CALCITE-4315] NPE in RelMdUtil#checkInputForCollationAndLimit", "bodyText": "CALCITE-4315: RelMdUtil#checkInputForCollationAndLimit does not check for null after calling mq.collations(input), which results in NPE.\nAlso add several simplifications and early returns.", "createdAt": "2020-10-07T16:13:14Z", "url": "https://github.com/apache/calcite/pull/2194", "merged": true, "mergeCommit": {"oid": "e328a33b6f08356396472c9fec83ca00ae951119"}, "closed": true, "closedAt": "2020-10-08T20:00:11Z", "author": {"login": "rubenada"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQPY_pAFqTUwNDA0OTgyMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQib7XABqjM4NTU3NTc1Nzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDQ5ODIy", "url": "https://github.com/apache/calcite/pull/2194#pullrequestreview-504049822", "createdAt": "2020-10-07T16:15:54Z", "commit": {"oid": "24f37a6d3eaa04c18e42e290adc47bbee1fe06d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjoxNTo1NFrOHd7L3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjoxNTo1NFrOHd7L3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE0MDQ0Nw==", "bodyText": "this is the NPE fix", "url": "https://github.com/apache/calcite/pull/2194#discussion_r501140447", "createdAt": "2020-10-07T16:15:54Z", "author": {"login": "rubenada"}, "path": "core/src/main/java/org/apache/calcite/rel/metadata/RelMdUtil.java", "diffHunk": "@@ -872,23 +872,36 @@ public static boolean checkInputForCollationAndLimit(RelMetadataQuery mq,\n       RelNode input, RelCollation collation, RexNode offset, RexNode fetch) {\n     // Check if the input is already sorted\n     boolean alreadySorted = collation.getFieldCollations().isEmpty();\n-    for (RelCollation inputCollation : mq.collations(input)) {\n-      if (inputCollation.satisfies(collation)) {\n-        alreadySorted = true;\n-        break;\n+    if (!alreadySorted) {\n+      final ImmutableList<RelCollation> collations = mq.collations(input);\n+      if (collations != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24f37a6d3eaa04c18e42e290adc47bbee1fe06d4"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MTMxNDEz", "url": "https://github.com/apache/calcite/pull/2194#pullrequestreview-504131413", "createdAt": "2020-10-07T17:57:00Z", "commit": {"oid": "24f37a6d3eaa04c18e42e290adc47bbee1fe06d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzo1NzowMFrOHd_Fng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzo1NzowMFrOHd_Fng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIwNDM4Mg==", "bodyText": "Could you add a clarification why true is expected here?\nFrankly speaking, it would be hard to maintain the test if it fails with \"expected true got false\" :-/", "url": "https://github.com/apache/calcite/pull/2194#discussion_r501204382", "createdAt": "2020-10-07T17:57:00Z", "author": {"login": "vlsi"}, "path": "core/src/test/java/org/apache/calcite/test/RelMetadataTest.java", "diffHunk": "@@ -3132,6 +3133,35 @@ private void checkNodeTypeCount(String sql, Map<Class<? extends RelNode>, Intege\n         is(\"=($0, $1)\"));\n   }\n \n+  /** Test case for\n+   * <a href=\"https://issues.apache.org/jira/browse/CALCITE-4315\">[CALCITE-4315]\n+   * NPE in RelMdUtil#checkInputForCollationAndLimit</a>. */\n+  @Test void testCheckInputForCollationAndLimit() {\n+    final Project rel = (Project) convertSql(\"select * from emp, dept\");\n+    final Join join = (Join) rel.getInput();\n+    final RelOptTable empTable = join.getInput(0).getTable();\n+    final RelOptTable deptTable = join.getInput(1).getTable();\n+    Frameworks.withPlanner((cluster, relOptSchema, rootSchema) -> {\n+      checkInputForCollationAndLimit(cluster, empTable, deptTable);\n+      return null;\n+    });\n+  }\n+\n+  private void checkInputForCollationAndLimit(RelOptCluster cluster, RelOptTable empTable,\n+      RelOptTable deptTable) {\n+    final RexBuilder rexBuilder = cluster.getRexBuilder();\n+    final RelMetadataQuery mq = cluster.getMetadataQuery();\n+    final List<RelHint> hints = ImmutableList.of();\n+    final LogicalTableScan empScan = LogicalTableScan.create(cluster, empTable, hints);\n+    final LogicalTableScan deptScan = LogicalTableScan.create(cluster, deptTable, hints);\n+    final LogicalJoin join =\n+        LogicalJoin.create(empScan, deptScan, ImmutableList.of(),\n+            rexBuilder.makeLiteral(true), ImmutableSet.of(), JoinRelType.INNER);\n+    assertTrue(\n+        RelMdUtil.checkInputForCollationAndLimit(mq, join, join.getTraitSet().getCollation(),\n+            null, null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24f37a6d3eaa04c18e42e290adc47bbee1fe06d4"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c329df7192a4c42ab2ac593564bd195ca0002485", "author": {"user": {"login": "rubenada", "name": null}}, "url": "https://github.com/apache/calcite/commit/c329df7192a4c42ab2ac593564bd195ca0002485", "committedDate": "2020-10-08T07:52:56Z", "message": "[CALCITE-4315] NPE in RelMdUtil#checkInputForCollationAndLimit"}, "afterCommit": {"oid": "da8245e60953b846992d70d794a0ee19fc1c8472", "author": {"user": {"login": "rubenada", "name": null}}, "url": "https://github.com/apache/calcite/commit/da8245e60953b846992d70d794a0ee19fc1c8472", "committedDate": "2020-10-08T07:53:51Z", "message": "[CALCITE-4315] NPE in RelMdUtil#checkInputForCollationAndLimit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29122c3bfc7268670c2f9746eaf585b97d773977", "author": {"user": {"login": "rubenada", "name": null}}, "url": "https://github.com/apache/calcite/commit/29122c3bfc7268670c2f9746eaf585b97d773977", "committedDate": "2020-10-08T14:26:47Z", "message": "[CALCITE-4315] NPE in RelMdUtil#checkInputForCollationAndLimit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa0b0b118b854e02c4368d3bcbb2618c8831813d", "author": {"user": {"login": "rubenada", "name": null}}, "url": "https://github.com/apache/calcite/commit/aa0b0b118b854e02c4368d3bcbb2618c8831813d", "committedDate": "2020-10-08T14:26:09Z", "message": "[CALCITE-4315] NPE in RelMdUtil#checkInputForCollationAndLimit"}, "afterCommit": {"oid": "29122c3bfc7268670c2f9746eaf585b97d773977", "author": {"user": {"login": "rubenada", "name": null}}, "url": "https://github.com/apache/calcite/commit/29122c3bfc7268670c2f9746eaf585b97d773977", "committedDate": "2020-10-08T14:26:47Z", "message": "[CALCITE-4315] NPE in RelMdUtil#checkInputForCollationAndLimit"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2923, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}