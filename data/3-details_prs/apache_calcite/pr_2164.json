{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwODk4NzQ4", "number": 2164, "title": "[CALCITE-4176] Key descriptor can be optional in SESSION table function", "bodyText": "This PR try to make the key descriptor optional in SESSION table function\n\nHandling the optional key descriptor when checking operand  types\nAdd validation and checks for operands of time column descriptor", "createdAt": "2020-09-22T12:17:27Z", "url": "https://github.com/apache/calcite/pull/2164", "merged": true, "mergeCommit": {"oid": "d701495640df77992b43093422e9331de103d9fd"}, "closed": true, "closedAt": "2020-09-27T17:45:07Z", "author": {"login": "liupc"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLwm5iAFqTQ5NDkxNjY0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdM95cogBqjM4MTE2MTUzNzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTE2NjQy", "url": "https://github.com/apache/calcite/pull/2164#pullrequestreview-494916642", "createdAt": "2020-09-23T18:05:48Z", "commit": {"oid": "960b89ea868ca3180b3163c3bfd35be3f7676ab2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODowNTo0OVrOHW6dIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODowODoxN1rOHW6iYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4ODQ0OA==", "bodyText": "Seems like you have changed this test which intended to test whether the first augment is named param is ok? If so can you change it back?", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493788448", "createdAt": "2020-09-23T18:05:49Z", "author": {"login": "amaliujia"}, "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -10512,41 +10515,47 @@ private void checkCustomColumnResolving(String table) {\n         + \"key => descriptor(productid),\\n\"\n         + \"size => interval '1' hour))\")\n         .ok();\n-    // negative tests.\n     sql(\"select * from table(\\n\"\n         + \"session(\\n\"\n-        + \"^\\\"data\\\"^ => table orders,\\n\"\n+        + \"data => table orders,\\n\"\n         + \"timecol => descriptor(rowtime),\\n\"\n-        + \"key => descriptor(productid),\\n\"\n         + \"size => interval '1' hour))\")\n-        .fails(\"Param 'data' not found in function 'SESSION'; did you mean 'DATA'\\\\?\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "960b89ea868ca3180b3163c3bfd35be3f7676ab2"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4OTAxMQ==", "bodyText": "One thing I am not sure is, does current Calcite named argument has an ordering requirement? Will Calcite accept if key/timecol is reordered?", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493789011", "createdAt": "2020-09-23T18:06:51Z", "author": {"login": "amaliujia"}, "path": "core/src/test/java/org/apache/calcite/test/SqlValidatorTest.java", "diffHunk": "@@ -10512,41 +10515,47 @@ private void checkCustomColumnResolving(String table) {\n         + \"key => descriptor(productid),\\n\"\n         + \"size => interval '1' hour))\")\n         .ok();\n-    // negative tests.\n     sql(\"select * from table(\\n\"\n         + \"session(\\n\"\n-        + \"^\\\"data\\\"^ => table orders,\\n\"\n+        + \"data => table orders,\\n\"\n         + \"timecol => descriptor(rowtime),\\n\"\n-        + \"key => descriptor(productid),\\n\"\n         + \"size => interval '1' hour))\")\n-        .fails(\"Param 'data' not found in function 'SESSION'; did you mean 'DATA'\\\\?\");\n+        .ok();\n+    // negative tests.\n     sql(\"select * from table(\\n\"\n         + \"^session(\\n\"\n         + \"data => table orders,\\n\"\n         + \"key => descriptor(productid),\\n\"\n         + \"size => interval '1' hour)^)\")\n-        .fails(\"Invalid number of arguments to function 'SESSION'. Was expecting 4 arguments\");\n+        .fails(\"Cannot apply 'SESSION' to arguments of type 'SESSION\\\\(<RECORDTYPE\\\\(TIMESTAMP\\\\(\"\n+            + \"0\\\\) ROWTIME, INTEGER PRODUCTID, INTEGER ORDERID\\\\)>, <COLUMN_LIST>, \"\n+            + \"<INTERVAL HOUR>\\\\)'. Supported form\\\\(s\\\\): SESSION\\\\(TABLE table_name, DESCRIPTOR\\\\(\"\n+            + \"timecol\\\\), DESCRIPTOR\\\\(key\\\\) optional, datetime interval\\\\)\");\n     sql(\"select * from table(\\n\"\n-        + \"^session(table orders, descriptor(rowtime), interval '2' hour)^)\")\n-        .fails(\"Invalid number of arguments to function 'SESSION'. Was expecting 4 arguments\");\n+        + \"session(\\n\"\n+        + \"^\\\"data\\\"^ => table orders,\\n\"\n+        + \"timecol => descriptor(rowtime),\\n\"\n+        + \"key => descriptor(productid),\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "960b89ea868ca3180b3163c3bfd35be3f7676ab2"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4OTc5Mg==", "bodyText": "Why need this addition (as this PR is to change SESSION)? is there a test case verify this line of change?", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493789792", "createdAt": "2020-09-23T18:08:17Z", "author": {"login": "amaliujia"}, "path": "core/src/main/java/org/apache/calcite/sql/SqlHopTableFunction.java", "diffHunk": "@@ -48,6 +48,9 @@ public SqlHopTableFunction() {\n       if (!checkTableAndDescriptorOperands(callBinding, 1)) {\n         return throwValidationSignatureErrorOrReturnFalse(callBinding, throwOnFailure);\n       }\n+      if (!checkTimeColumnDescriptorOperand(callBinding, 1)) {\n+        return throwValidationSignatureErrorOrReturnFalse(callBinding, throwOnFailure);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "960b89ea868ca3180b3163c3bfd35be3f7676ab2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTc0NTI4", "url": "https://github.com/apache/calcite/pull/2164#pullrequestreview-495174528", "createdAt": "2020-09-24T02:18:15Z", "commit": {"oid": "960b89ea868ca3180b3163c3bfd35be3f7676ab2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMjoxODoxNlrOHXHWCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMjoxODoxNlrOHXHWCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5OTYyNA==", "bodyText": "In fact, as I recall checkTableAndDescriptorOperands will check whether the second argument is a descriptor, so this line might not be needed.", "url": "https://github.com/apache/calcite/pull/2164#discussion_r493999624", "createdAt": "2020-09-24T02:18:16Z", "author": {"login": "amaliujia"}, "path": "core/src/main/java/org/apache/calcite/sql/SqlSessionTableFunction.java", "diffHunk": "@@ -42,25 +43,41 @@ public SqlSessionTableFunction() {\n   private static class OperandMetadataImpl extends AbstractOperandMetadata {\n     OperandMetadataImpl() {\n       super(ImmutableList.of(PARAM_DATA, PARAM_TIMECOL, PARAM_KEY, PARAM_SIZE),\n-          4);\n+          3);\n     }\n \n     @Override public boolean checkOperandTypes(SqlCallBinding callBinding,\n         boolean throwOnFailure) {\n-      final SqlValidator validator = callBinding.getValidator();\n-      if (!checkTableAndDescriptorOperands(callBinding, 2)) {\n+      if (!checkTableAndDescriptorOperands(callBinding, 1)) {\n+        return throwValidationSignatureErrorOrReturnFalse(callBinding, throwOnFailure);\n+      }\n+      if (!checkTimeColumnDescriptorOperand(callBinding, 1)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "960b89ea868ca3180b3163c3bfd35be3f7676ab2"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21df2389371ad55bfb2a5baa70f950e16a6592c9", "author": {"user": {"login": "liupc", "name": "PengchengLiu"}}, "url": "https://github.com/apache/calcite/commit/21df2389371ad55bfb2a5baa70f950e16a6592c9", "committedDate": "2020-09-27T12:07:49Z", "message": "[CALCITE-4176] Key descriptor can be optional in SESSION table function\n\nFix style\n\nFix style\n\nAdding tests to check time column for TUMBLE/HOP table function\n\nFix style"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "43bf9c9ab7b54742225d6e2ec0006019347868c8", "author": {"user": {"login": "liupc", "name": "PengchengLiu"}}, "url": "https://github.com/apache/calcite/commit/43bf9c9ab7b54742225d6e2ec0006019347868c8", "committedDate": "2020-09-25T09:55:44Z", "message": "Fix style"}, "afterCommit": {"oid": "21df2389371ad55bfb2a5baa70f950e16a6592c9", "author": {"user": {"login": "liupc", "name": "PengchengLiu"}}, "url": "https://github.com/apache/calcite/commit/21df2389371ad55bfb2a5baa70f950e16a6592c9", "committedDate": "2020-09-27T12:07:49Z", "message": "[CALCITE-4176] Key descriptor can be optional in SESSION table function\n\nFix style\n\nFix style\n\nAdding tests to check time column for TUMBLE/HOP table function\n\nFix style"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2879, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}