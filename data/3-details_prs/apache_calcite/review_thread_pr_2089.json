{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MjQwMzEw", "number": 2089, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzoyOToxNlrOET6tkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzozMTo1NlrOET6vGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzIwMzM5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/apache/calcite/sql/type/SqlTypeUtil.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzoyOToxNlrOG564MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOTowOTo0MlrOG6BlXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NjY3Mw==", "bodyText": "Seems the toType should always be a Decimal type, we should add a check here. Also, can we add some doc to this method ?", "url": "https://github.com/apache/calcite/pull/2089#discussion_r463386673", "createdAt": "2020-07-31T03:29:16Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/sql/type/SqlTypeUtil.java", "diffHunk": "@@ -1751,4 +1752,18 @@ public static RelDataType extractLastNFields(RelDataTypeFactory typeFactory,\n     return typeFactory.createStructType(\n         type.getFieldList().subList(fieldsCnt - numToKeep, fieldsCnt));\n   }\n+\n+  public static boolean isValidDecimalValue(BigDecimal value, RelDataType toType) {\n+    if (value == null) {\n+      return true;\n+    }\n+    switch (toType.getSqlTypeName()) {\n+    case DECIMAL:\n+      final int intDigits = value.precision() - value.scale();\n+      final int maxIntDigits = toType.getPrecision() - toType.getScale();\n+      return intDigits <= maxIntDigits;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74e25247096ae38b069e1674f7710a2c54c5d9d0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM5MDY1Ng==", "bodyText": "Seems the toType should always be a Decimal type, we should add a check here\n\nNot necessary. It would work even though toType is not Decimal since  I used case when.\n\nAlso, can we add some doc to this method ?\n\nMakes sense.", "url": "https://github.com/apache/calcite/pull/2089#discussion_r463390656", "createdAt": "2020-07-31T03:48:38Z", "author": {"login": "chunweilei"}, "path": "core/src/main/java/org/apache/calcite/sql/type/SqlTypeUtil.java", "diffHunk": "@@ -1751,4 +1752,18 @@ public static RelDataType extractLastNFields(RelDataTypeFactory typeFactory,\n     return typeFactory.createStructType(\n         type.getFieldList().subList(fieldsCnt - numToKeep, fieldsCnt));\n   }\n+\n+  public static boolean isValidDecimalValue(BigDecimal value, RelDataType toType) {\n+    if (value == null) {\n+      return true;\n+    }\n+    switch (toType.getSqlTypeName()) {\n+    case DECIMAL:\n+      final int intDigits = value.precision() - value.scale();\n+      final int maxIntDigits = toType.getPrecision() - toType.getScale();\n+      return intDigits <= maxIntDigits;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NjY3Mw=="}, "originalCommit": {"oid": "74e25247096ae38b069e1674f7710a2c54c5d9d0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNTg0Mg==", "bodyText": "If toType is not decimal, how can you ensure that it has a valid precision and scale, such as -1.", "url": "https://github.com/apache/calcite/pull/2089#discussion_r463435842", "createdAt": "2020-07-31T06:51:03Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/sql/type/SqlTypeUtil.java", "diffHunk": "@@ -1751,4 +1752,18 @@ public static RelDataType extractLastNFields(RelDataTypeFactory typeFactory,\n     return typeFactory.createStructType(\n         type.getFieldList().subList(fieldsCnt - numToKeep, fieldsCnt));\n   }\n+\n+  public static boolean isValidDecimalValue(BigDecimal value, RelDataType toType) {\n+    if (value == null) {\n+      return true;\n+    }\n+    switch (toType.getSqlTypeName()) {\n+    case DECIMAL:\n+      final int intDigits = value.precision() - value.scale();\n+      final int maxIntDigits = toType.getPrecision() - toType.getScale();\n+      return intDigits <= maxIntDigits;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NjY3Mw=="}, "originalCommit": {"oid": "74e25247096ae38b069e1674f7710a2c54c5d9d0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ0NDE4OQ==", "bodyText": "Do you want to throw an exception if toType is not decimal by saying \"add a check here\"?", "url": "https://github.com/apache/calcite/pull/2089#discussion_r463444189", "createdAt": "2020-07-31T07:14:24Z", "author": {"login": "chunweilei"}, "path": "core/src/main/java/org/apache/calcite/sql/type/SqlTypeUtil.java", "diffHunk": "@@ -1751,4 +1752,18 @@ public static RelDataType extractLastNFields(RelDataTypeFactory typeFactory,\n     return typeFactory.createStructType(\n         type.getFieldList().subList(fieldsCnt - numToKeep, fieldsCnt));\n   }\n+\n+  public static boolean isValidDecimalValue(BigDecimal value, RelDataType toType) {\n+    if (value == null) {\n+      return true;\n+    }\n+    switch (toType.getSqlTypeName()) {\n+    case DECIMAL:\n+      final int intDigits = value.precision() - value.scale();\n+      final int maxIntDigits = toType.getPrecision() - toType.getScale();\n+      return intDigits <= maxIntDigits;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NjY3Mw=="}, "originalCommit": {"oid": "74e25247096ae38b069e1674f7710a2c54c5d9d0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ5NjU0Mg==", "bodyText": "I just want to make sure the logic is robust, either a check or assert is okey from  my side.", "url": "https://github.com/apache/calcite/pull/2089#discussion_r463496542", "createdAt": "2020-07-31T09:09:42Z", "author": {"login": "danny0405"}, "path": "core/src/main/java/org/apache/calcite/sql/type/SqlTypeUtil.java", "diffHunk": "@@ -1751,4 +1752,18 @@ public static RelDataType extractLastNFields(RelDataTypeFactory typeFactory,\n     return typeFactory.createStructType(\n         type.getFieldList().subList(fieldsCnt - numToKeep, fieldsCnt));\n   }\n+\n+  public static boolean isValidDecimalValue(BigDecimal value, RelDataType toType) {\n+    if (value == null) {\n+      return true;\n+    }\n+    switch (toType.getSqlTypeName()) {\n+    case DECIMAL:\n+      final int intDigits = value.precision() - value.scale();\n+      final int maxIntDigits = toType.getPrecision() - toType.getScale();\n+      return intDigits <= maxIntDigits;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NjY3Mw=="}, "originalCommit": {"oid": "74e25247096ae38b069e1674f7710a2c54c5d9d0"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzIwNzMwOnYy", "diffSide": "RIGHT", "path": "core/src/test/resources/sql/misc.iq", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMzozMTo1NlrOG566cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOTozMTo0NFrOG6CO-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NzI0OQ==", "bodyText": "Why change the query ? It works in MySql and PostgresSQL.", "url": "https://github.com/apache/calcite/pull/2089#discussion_r463387249", "createdAt": "2020-07-31T03:31:56Z", "author": {"login": "danny0405"}, "path": "core/src/test/resources/sql/misc.iq", "diffHunk": "@@ -1689,7 +1689,7 @@ EnumerableCalc(expr#0=[{inputs}], expr#1=[123:BIGINT], EXPR$0=[$t1])\n !plan\n \n # Cast an integer literal to a decimal; note: the plan does not contain CAST\n-values cast('123.45' as decimal(4, 2));\n+values cast('123.45' as decimal(5, 2));\n +--------+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74e25247096ae38b069e1674f7710a2c54c5d9d0"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM5MDI5MA==", "bodyText": "It overflows.\nchunwei.lcw@chunwei:~$ psql\npsql (12.3)\nType \"help\" for help.\n\nchunwei.lcw=# select cast('111.23' as decimal(4, 2));\nERROR:  numeric field overflow\nDETAIL:  A field with precision 4, scale 2 must round to an absolute value less than 10^2.", "url": "https://github.com/apache/calcite/pull/2089#discussion_r463390290", "createdAt": "2020-07-31T03:46:44Z", "author": {"login": "chunweilei"}, "path": "core/src/test/resources/sql/misc.iq", "diffHunk": "@@ -1689,7 +1689,7 @@ EnumerableCalc(expr#0=[{inputs}], expr#1=[123:BIGINT], EXPR$0=[$t1])\n !plan\n \n # Cast an integer literal to a decimal; note: the plan does not contain CAST\n-values cast('123.45' as decimal(4, 2));\n+values cast('123.45' as decimal(5, 2));\n +--------+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NzI0OQ=="}, "originalCommit": {"oid": "74e25247096ae38b069e1674f7710a2c54c5d9d0"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNjc2NQ==", "bodyText": "Hmm, it seems only MySql succeed, with a result of 99.99 for query select cast('123.45' as decimal(4, 2))", "url": "https://github.com/apache/calcite/pull/2089#discussion_r463436765", "createdAt": "2020-07-31T06:53:43Z", "author": {"login": "danny0405"}, "path": "core/src/test/resources/sql/misc.iq", "diffHunk": "@@ -1689,7 +1689,7 @@ EnumerableCalc(expr#0=[{inputs}], expr#1=[123:BIGINT], EXPR$0=[$t1])\n !plan\n \n # Cast an integer literal to a decimal; note: the plan does not contain CAST\n-values cast('123.45' as decimal(4, 2));\n+values cast('123.45' as decimal(5, 2));\n +--------+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NzI0OQ=="}, "originalCommit": {"oid": "74e25247096ae38b069e1674f7710a2c54c5d9d0"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ5NzkzMw==", "bodyText": "We may need to have a conclusion for this behavior change, it seems breaking.", "url": "https://github.com/apache/calcite/pull/2089#discussion_r463497933", "createdAt": "2020-07-31T09:12:28Z", "author": {"login": "danny0405"}, "path": "core/src/test/resources/sql/misc.iq", "diffHunk": "@@ -1689,7 +1689,7 @@ EnumerableCalc(expr#0=[{inputs}], expr#1=[123:BIGINT], EXPR$0=[$t1])\n !plan\n \n # Cast an integer literal to a decimal; note: the plan does not contain CAST\n-values cast('123.45' as decimal(4, 2));\n+values cast('123.45' as decimal(5, 2));\n +--------+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NzI0OQ=="}, "originalCommit": {"oid": "74e25247096ae38b069e1674f7710a2c54c5d9d0"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUwNzE5Mw==", "bodyText": "Yep. But from what I can see, cast('123.45' as decimal(4, 2)) should not return 123.45.", "url": "https://github.com/apache/calcite/pull/2089#discussion_r463507193", "createdAt": "2020-07-31T09:31:44Z", "author": {"login": "chunweilei"}, "path": "core/src/test/resources/sql/misc.iq", "diffHunk": "@@ -1689,7 +1689,7 @@ EnumerableCalc(expr#0=[{inputs}], expr#1=[123:BIGINT], EXPR$0=[$t1])\n !plan\n \n # Cast an integer literal to a decimal; note: the plan does not contain CAST\n-values cast('123.45' as decimal(4, 2));\n+values cast('123.45' as decimal(5, 2));\n +--------+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4NzI0OQ=="}, "originalCommit": {"oid": "74e25247096ae38b069e1674f7710a2c54c5d9d0"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 102, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}