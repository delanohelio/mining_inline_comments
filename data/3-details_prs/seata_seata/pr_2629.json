{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5ODU1MDU4", "number": 2629, "title": "bugfix: fix duplicated resource id in PostgreSQL", "bodyText": "\u2160. Describe what this PR did\nIn this case\njdbc:postgresql://127.0.0.1:5432/seata?currentSchema=public\njdbc:postgresql://127.0.0.1:5432/seata?currentSchema=seata\n\nit will cause the same resource id. and the error below occur.\n1.Get file lock fail.\n2.Cause the wrong table meta in pg sql.\n\u2161. Does this pull request fix one issue?\n#2623\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-04-28T03:09:40Z", "url": "https://github.com/seata/seata/pull/2629", "merged": true, "mergeCommit": {"oid": "f9ac34c96bf7b1d702ad3e6c269919f484c7ac90"}, "closed": true, "closedAt": "2020-05-06T13:58:04Z", "author": {"login": "l81893521"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbtBlpAH2gAyNDA5ODU1MDU4OmUyMjNjMzM3YjllMGJhOTY2OThlMGMxYWQ2ZDk5YjIyOTM0YzgxY2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcemLaUAFqTQwNjQ4NzIzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e223c337b9e0ba96698e0c1ad6d99b22934c81ca", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/e223c337b9e0ba96698e0c1ad6d99b22934c81ca", "committedDate": "2020-04-27T10:49:30Z", "message": "separate table by schema in pg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3ab0765b4a5193e724787a41f62626971a66577", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/f3ab0765b4a5193e724787a41f62626971a66577", "committedDate": "2020-04-28T02:53:46Z", "message": "fix duplicated resource id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "292fc0e78c7cb1b03f36282ddb12cb1f4d07018e", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/292fc0e78c7cb1b03f36282ddb12cb1f4d07018e", "committedDate": "2020-04-28T03:01:25Z", "message": "fix duplicated resource id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "173aac3dff883a78554ff64b6b29fb493b49c6ba", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/173aac3dff883a78554ff64b6b29fb493b49c6ba", "committedDate": "2020-04-28T03:05:53Z", "message": "fix duplicated resource id"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNzA4NjU0", "url": "https://github.com/seata/seata/pull/2629#pullrequestreview-401708654", "createdAt": "2020-04-28T10:36:12Z", "commit": {"oid": "173aac3dff883a78554ff64b6b29fb493b49c6ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMDozNjoxMlrOGNNtPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMDozNjoxMlrOGNNtPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUwOTI0NA==", "bodyText": "1.currentSchema is magic number\n2.break?", "url": "https://github.com/seata/seata/pull/2629#discussion_r416509244", "createdAt": "2020-04-28T10:36:12Z", "author": {"login": "zjinlei"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/DataSourceProxy.java", "diffHunk": "@@ -141,7 +141,32 @@ public String getResourceGroupId() {\n     @Override\n     public String getResourceId() {\n         if (jdbcUrl.contains(\"?\")) {\n-            return jdbcUrl.substring(0, jdbcUrl.indexOf('?'));\n+            StringBuilder jdbcUrlBuilder = new StringBuilder();\n+            jdbcUrlBuilder.append(jdbcUrl.substring(0, jdbcUrl.indexOf('?')));\n+            /*\n+             * prevent pg sql url like\n+             * jdbc:postgresql://127.0.0.1:5432/seata?currentSchema=public\n+             * jdbc:postgresql://127.0.0.1:5432/seata?currentSchema=seata\n+             * cause the duplicated resourceId\n+             * it will cause the problem like\n+             * 1.get file lock fail\n+             * 2.error table meta cache\n+             */\n+            StringBuilder paramsBuilder = new StringBuilder();\n+            String paramUrl = jdbcUrl.substring(jdbcUrl.indexOf('?') + 1, jdbcUrl.length());\n+            String[] urlParams = paramUrl.split(\"&\");\n+            for (String urlParam : urlParams) {\n+                if (urlParam.contains(\"currentSchema\")) {\n+                    paramsBuilder.append(urlParam);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "173aac3dff883a78554ff64b6b29fb493b49c6ba"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2943b0e49a2be0f99d44c68a1a2e2d34ebf3ab8e", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/2943b0e49a2be0f99d44c68a1a2e2d34ebf3ab8e", "committedDate": "2020-04-29T01:12:41Z", "message": "add break"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93550eeaf2ec0de41d0c413680b008dce89f9808", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/93550eeaf2ec0de41d0c413680b008dce89f9808", "committedDate": "2020-04-29T06:20:48Z", "message": "Merge branch 'develop' into seperate_table_by_schema_pg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMzg5Mzk4", "url": "https://github.com/seata/seata/pull/2629#pullrequestreview-402389398", "createdAt": "2020-04-29T06:23:18Z", "commit": {"oid": "93550eeaf2ec0de41d0c413680b008dce89f9808"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNjoyMzoxOFrOGNxKyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNjoyMzoxOFrOGNxKyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5MDI1MA==", "bodyText": "According to dbType, non-pg remains the same", "url": "https://github.com/seata/seata/pull/2629#discussion_r417090250", "createdAt": "2020-04-29T06:23:18Z", "author": {"login": "zjinlei"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/DataSourceProxy.java", "diffHunk": "@@ -141,7 +141,33 @@ public String getResourceGroupId() {\n     @Override\n     public String getResourceId() {\n         if (jdbcUrl.contains(\"?\")) {\n-            return jdbcUrl.substring(0, jdbcUrl.indexOf('?'));\n+            StringBuilder jdbcUrlBuilder = new StringBuilder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93550eeaf2ec0de41d0c413680b008dce89f9808"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNDM0NTgz", "url": "https://github.com/seata/seata/pull/2629#pullrequestreview-402434583", "createdAt": "2020-04-29T07:50:38Z", "commit": {"oid": "93550eeaf2ec0de41d0c413680b008dce89f9808"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNzo1MDozOFrOGNzgdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwNzo1MDozOFrOGNzgdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyODU2Ng==", "bodyText": "remove else, direct return?", "url": "https://github.com/seata/seata/pull/2629#discussion_r417128566", "createdAt": "2020-04-29T07:50:38Z", "author": {"login": "jsbxyyx"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/DataSourceProxy.java", "diffHunk": "@@ -141,7 +141,33 @@ public String getResourceGroupId() {\n     @Override\n     public String getResourceId() {\n         if (jdbcUrl.contains(\"?\")) {\n-            return jdbcUrl.substring(0, jdbcUrl.indexOf('?'));\n+            StringBuilder jdbcUrlBuilder = new StringBuilder();\n+            jdbcUrlBuilder.append(jdbcUrl.substring(0, jdbcUrl.indexOf('?')));\n+            /*\n+             * prevent pg sql url like\n+             * jdbc:postgresql://127.0.0.1:5432/seata?currentSchema=public\n+             * jdbc:postgresql://127.0.0.1:5432/seata?currentSchema=seata\n+             * cause the duplicated resourceId\n+             * it will cause the problem like\n+             * 1.get file lock fail\n+             * 2.error table meta cache\n+             */\n+            StringBuilder paramsBuilder = new StringBuilder();\n+            String paramUrl = jdbcUrl.substring(jdbcUrl.indexOf('?') + 1, jdbcUrl.length());\n+            String[] urlParams = paramUrl.split(\"&\");\n+            for (String urlParam : urlParams) {\n+                if (urlParam.contains(\"currentSchema\")) {\n+                    paramsBuilder.append(urlParam);\n+                    break;\n+                }\n+            }\n+\n+            if (paramsBuilder.length() > 0) {\n+                jdbcUrlBuilder.append(\"?\");\n+                jdbcUrlBuilder.append(paramsBuilder);\n+            }\n+\n+            return jdbcUrlBuilder.toString();\n         } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93550eeaf2ec0de41d0c413680b008dce89f9808"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "010024cff216744d07a02d4768e0cfa30aa0f2d6", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/010024cff216744d07a02d4768e0cfa30aa0f2d6", "committedDate": "2020-04-29T09:40:12Z", "message": "add db type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "397f940fd0d628809df86d0daaf8aff5498f7b97", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/397f940fd0d628809df86d0daaf8aff5498f7b97", "committedDate": "2020-04-29T09:41:09Z", "message": "Merge remote-tracking branch 'me/seperate_table_by_schema_pg' into seperate_table_by_schema_pg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNzA2MzMx", "url": "https://github.com/seata/seata/pull/2629#pullrequestreview-402706331", "createdAt": "2020-04-29T14:11:19Z", "commit": {"oid": "397f940fd0d628809df86d0daaf8aff5498f7b97"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDoxMToxOVrOGOAxMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDoxMToxOVrOGOAxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM0NTg0Mw==", "bodyText": "Keep the original clear, suggest:\nreturn DBType.POSTGRESQL.name().equalsIgnoreCase(getDbType())? getPgResourceId() : jdbcUrl.substring(0,jdbcUrl.indexOf('?'));", "url": "https://github.com/seata/seata/pull/2629#discussion_r417345843", "createdAt": "2020-04-29T14:11:19Z", "author": {"login": "zjinlei"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/DataSourceProxy.java", "diffHunk": "@@ -141,7 +142,35 @@ public String getResourceGroupId() {\n     @Override\n     public String getResourceId() {\n         if (jdbcUrl.contains(\"?\")) {\n-            return jdbcUrl.substring(0, jdbcUrl.indexOf('?'));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "397f940fd0d628809df86d0daaf8aff5498f7b97"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33160d1742183a5040a64046fba867b29e6d5f31", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/33160d1742183a5040a64046fba867b29e6d5f31", "committedDate": "2020-04-30T01:27:03Z", "message": "make it more clear"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1025ce0de9cfeeeb493ed56e884cb9246509131e", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/1025ce0de9cfeeeb493ed56e884cb9246509131e", "committedDate": "2020-04-30T01:31:42Z", "message": "make it more clear."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bca658ced7575ad26b81081206b8839757b2a78b", "author": {"user": {"login": "xingfudeshi", "name": "xingfudeshi"}}, "url": "https://github.com/seata/seata/commit/bca658ced7575ad26b81081206b8839757b2a78b", "committedDate": "2020-05-02T16:05:48Z", "message": "Merge branch 'develop' into seperate_table_by_schema_pg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b99de959867911a081ffbf52ffb91491189f3798", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/b99de959867911a081ffbf52ffb91491189f3798", "committedDate": "2020-05-03T03:32:59Z", "message": "Merge branch 'develop' into seperate_table_by_schema_pg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2Mzg2MzUy", "url": "https://github.com/seata/seata/pull/2629#pullrequestreview-406386352", "createdAt": "2020-05-06T08:07:45Z", "commit": {"oid": "b99de959867911a081ffbf52ffb91491189f3798"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d8bad2864c3ecfdb79c9736740f221907852438", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/0d8bad2864c3ecfdb79c9736740f221907852438", "committedDate": "2020-05-06T08:07:54Z", "message": "Merge branch 'develop' into seperate_table_by_schema_pg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dd32311e42fae09683227df2f74e064ea915884", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/1dd32311e42fae09683227df2f74e064ea915884", "committedDate": "2020-05-06T08:46:21Z", "message": "Merge branch 'develop' into seperate_table_by_schema_pg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NDE2MDA2", "url": "https://github.com/seata/seata/pull/2629#pullrequestreview-406416006", "createdAt": "2020-05-06T08:50:03Z", "commit": {"oid": "0d8bad2864c3ecfdb79c9736740f221907852438"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NDg3MjMz", "url": "https://github.com/seata/seata/pull/2629#pullrequestreview-406487233", "createdAt": "2020-05-06T10:32:40Z", "commit": {"oid": "1dd32311e42fae09683227df2f74e064ea915884"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3948, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}