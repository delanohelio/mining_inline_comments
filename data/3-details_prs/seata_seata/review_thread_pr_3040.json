{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5MzQyNzA1", "number": 3040, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwODo0NTowOVrOEwI7jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMDoxOTozOVrOEx1cSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4OTEzNDIzOnYy", "diffSide": "RIGHT", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwODo0NTowOVrOHlg9YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMzo0NToxNlrOHmiiMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA5OTM2MA==", "bodyText": "why throw exx ? the connection will  remain unavailable?", "url": "https://github.com/seata/seata/pull/3040#discussion_r509099360", "createdAt": "2020-10-21T08:45:09Z", "author": {"login": "slievrly"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -251,6 +259,9 @@ public void rollback() throws SQLException {\n \n     @Override\n     public void setAutoCommit(boolean autoCommit) throws SQLException {\n+        if (exception != null) {\n+            throw exception;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76b4844a2a546b694b844fe1e7cde492dde46b58"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEwMTcyMw==", "bodyText": "execution should not continue because an exception has already been made", "url": "https://github.com/seata/seata/pull/3040#discussion_r509101723", "createdAt": "2020-10-21T08:48:28Z", "author": {"login": "a364176773"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -251,6 +259,9 @@ public void rollback() throws SQLException {\n \n     @Override\n     public void setAutoCommit(boolean autoCommit) throws SQLException {\n+        if (exception != null) {\n+            throw exception;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA5OTM2MA=="}, "originalCommit": {"oid": "76b4844a2a546b694b844fe1e7cde492dde46b58"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE3Mzc0NA==", "bodyText": "agree with @slievrly", "url": "https://github.com/seata/seata/pull/3040#discussion_r510173744", "createdAt": "2020-10-22T13:45:16Z", "author": {"login": "caohdgege"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -251,6 +259,9 @@ public void rollback() throws SQLException {\n \n     @Override\n     public void setAutoCommit(boolean autoCommit) throws SQLException {\n+        if (exception != null) {\n+            throw exception;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTA5OTM2MA=="}, "originalCommit": {"oid": "76b4844a2a546b694b844fe1e7cde492dde46b58"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NTU2MzA4OnYy", "diffSide": "RIGHT", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjo1NTo0MlrOHmgUuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjo1NTo0MlrOHmgUuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzNzUzMQ==", "bodyText": "\u8fd9\u91cc\u76f4\u63a5\u8c03\u7528context.reset\u4f1a\u4e0d\u4f1a\u597d\u4e00\u70b9\uff1f\n\u56e0\u4e3a\u8fd9\u4e2a\u5f02\u5e38\u6781\u6709\u53ef\u80fd\u5df2\u7ecf\u88ab\u8c03\u7528\u65b9\u6d88\u8d39\u6389\u4e86\u7684\u3002\u5e76\u4e14\u4f7f\u7528reset\u7684\u8bdd\uff0ctargetConnection\u7684autocommit\u662f\u4f20\u5165\u7684\u503c\uff1b\u5982\u679c\u76f4\u63a5\u629b\u5f02\u5e38\u7684\u8bdd\uff0c\u90a3\u5c31\u662f\u539f\u503c\u4e86\u3002\u671f\u5f85\u503c\u5e94\u8be5\u662f\u4f20\u5165\u7684\u503c\u7684\u3002", "url": "https://github.com/seata/seata/pull/3040#discussion_r510137531", "createdAt": "2020-10-22T12:55:42Z", "author": {"login": "caohdgege"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -251,6 +262,11 @@ public void rollback() throws SQLException {\n \n     @Override\n     public void setAutoCommit(boolean autoCommit) throws SQLException {\n+        if (exception != null) {\n+            SQLException e = exception;\n+            rollback();\n+            throw e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ff6c7a10d5cc6560d96928a17795829d4eeb12"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NTU2MzM1OnYy", "diffSide": "RIGHT", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjo1NTo0NlrOHmgU5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjo1NTo0NlrOHmgU5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzNzU3Mw==", "bodyText": "\u8fd9\u4e2a\u653e\u5728ConnectionContext\u91cc\u9762\u4f1a\u4e0d\u4f1a\u597d\u4e00\u70b9\uff1f", "url": "https://github.com/seata/seata/pull/3040#discussion_r510137573", "createdAt": "2020-10-22T12:55:46Z", "author": {"login": "caohdgege"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -57,6 +57,8 @@\n \n     private final static LockRetryPolicy LOCK_RETRY_POLICY = new LockRetryPolicy();\n \n+    private SQLException exception;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19ff6c7a10d5cc6560d96928a17795829d4eeb12"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjkxMjc1OnYy", "diffSide": "RIGHT", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMDoxOTozOVrOHoJA0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMDozNDo1NlrOHoJkdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Mjc1Mg==", "bodyText": "if(autocommit=false) {\n    rollback();\n}\n\nWhat kind of problem of this line solved ?", "url": "https://github.com/seata/seata/pull/3040#discussion_r511852752", "createdAt": "2020-10-26T10:19:39Z", "author": {"login": "l81893521"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -185,6 +185,9 @@ public void commit() throws SQLException {\n                 return null;\n             });\n         } catch (SQLException e) {\n+            if (targetConnection != null && !getAutoCommit()) {\n+                rollback();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0735d63b99690993ae47e89cd86552b240fc0afc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1NDI5NA==", "bodyText": "this connection is reset on rollback to prevent duplicate registration and connection unavailability issues", "url": "https://github.com/seata/seata/pull/3040#discussion_r511854294", "createdAt": "2020-10-26T10:22:21Z", "author": {"login": "a364176773"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -185,6 +185,9 @@ public void commit() throws SQLException {\n                 return null;\n             });\n         } catch (SQLException e) {\n+            if (targetConnection != null && !getAutoCommit()) {\n+                rollback();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Mjc1Mg=="}, "originalCommit": {"oid": "0735d63b99690993ae47e89cd86552b240fc0afc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg2MTg3Nw==", "bodyText": "How about under this situation\nset autocommit = 0;\nstart transaction;\n//success\ninsert into account values (xxxx);\nsavepoint step1;\n//lock conflict\ninsert into order values(xxxxx);\nrollback to step1;", "url": "https://github.com/seata/seata/pull/3040#discussion_r511861877", "createdAt": "2020-10-26T10:34:56Z", "author": {"login": "l81893521"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -185,6 +185,9 @@ public void commit() throws SQLException {\n                 return null;\n             });\n         } catch (SQLException e) {\n+            if (targetConnection != null && !getAutoCommit()) {\n+                rollback();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Mjc1Mg=="}, "originalCommit": {"oid": "0735d63b99690993ae47e89cd86552b240fc0afc"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1404, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}