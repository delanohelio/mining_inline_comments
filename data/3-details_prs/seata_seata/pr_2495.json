{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2ODgxMzI1", "number": 2495, "title": "bugfix:  fix the NPE and reduce the request when lockkey is null", "bodyText": "\u2160. Describe what this PR did\n1.fix: Fix the NPE when lockkey is null;\n2.optimize:  Reduce once db request when lockkey is null;\n\u2161. Does this pull request fix one issue?\n\nyes.\nissue\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-04-01T09:43:13Z", "url": "https://github.com/seata/seata/pull/2495", "merged": true, "mergeCommit": {"oid": "2e37c6b5d863629ab5da00a125f9b1b8359077ba"}, "closed": true, "closedAt": "2020-04-08T04:24:48Z", "author": {"login": "lightClouds917"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTUbB0AH2gAyMzk2ODgxMzI1OmZkNDc4OTQ1MDExMjYxZjYyOGJhM2RmMjM2MjlhMTlmMGVjZjk0YmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVgHw2AFqTM4OTY0MzMzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fd478945011261f628ba3df23629a19f0ecf94bb", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/fd478945011261f628ba3df23629a19f0ecf94bb", "committedDate": "2020-04-01T09:38:16Z", "message": "fix:fix the NPE,and reduce once db request when lockkey is null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTY3Mjkx", "url": "https://github.com/seata/seata/pull/2495#pullrequestreview-386967291", "createdAt": "2020-04-03T06:33:50Z", "commit": {"oid": "fd478945011261f628ba3df23629a19f0ecf94bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNjozMzo1MFrOGAGvUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNjozMzo1MFrOGAGvUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc2MzYwMQ==", "bodyText": "Is it more appropriate to put logic with lockkey as empty in the checkLock method?", "url": "https://github.com/seata/seata/pull/2495#discussion_r402763601", "createdAt": "2020-04-03T06:33:50Z", "author": {"login": "slievrly"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -198,8 +200,10 @@ private void doCommit() throws SQLException {\n     }\n \n     private void processLocalCommitWithGlobalLocks() throws SQLException {\n-\n-        checkLock(context.buildLockKeys());\n+        Set<String> lockKeys = context.getLockKeysBuffer();\n+        if (CollectionUtils.isNotEmpty(lockKeys)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd478945011261f628ba3df23629a19f0ecf94bb"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cc0dac5402f356b25dff64baf3fe961f6c5fcaa", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/4cc0dac5402f356b25dff64baf3fe961f6c5fcaa", "committedDate": "2020-04-03T08:02:03Z", "message": "Merge branch 'develop' of github.com:seata/seata into fix_lockkey_is_null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6eb6e0fd081aa4e538f379af66b88de2a090350b", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/6eb6e0fd081aa4e538f379af66b88de2a090350b", "committedDate": "2020-04-03T08:43:55Z", "message": "optimize:optimize the code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDgyNTM4", "url": "https://github.com/seata/seata/pull/2495#pullrequestreview-387082538", "createdAt": "2020-04-03T09:06:48Z", "commit": {"oid": "6eb6e0fd081aa4e538f379af66b88de2a090350b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NjcyNjc5", "url": "https://github.com/seata/seata/pull/2495#pullrequestreview-387672679", "createdAt": "2020-04-04T06:24:53Z", "commit": {"oid": "6eb6e0fd081aa4e538f379af66b88de2a090350b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3Njk4MDM3", "url": "https://github.com/seata/seata/pull/2495#pullrequestreview-387698037", "createdAt": "2020-04-04T13:08:22Z", "commit": {"oid": "6eb6e0fd081aa4e538f379af66b88de2a090350b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQxMzowODoyMlrOGAxwQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQxMzowODoyMlrOGAxwQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2ODM1Mw==", "bodyText": "Incorrect", "url": "https://github.com/seata/seata/pull/2495#discussion_r403468353", "createdAt": "2020-04-04T13:08:22Z", "author": {"login": "zjinlei"}, "path": "server/src/main/java/io/seata/server/lock/AbstractLockManager.java", "diffHunk": "@@ -153,6 +153,9 @@ protected Locker getLocker() {\n                                             Long branchID) {\n         List<RowLock> locks = new ArrayList<RowLock>();\n \n+        if (StringUtils.isEmpty(lockKey)) {\n+            return null;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eb6e0fd081aa4e538f379af66b88de2a090350b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da7dbd260704a5146974c63ef9dd75b9d2f575a5", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/da7dbd260704a5146974c63ef9dd75b9d2f575a5", "committedDate": "2020-04-07T03:27:41Z", "message": "Merge branch 'develop' of github.com:seata/seata into fix_lockkey_is_null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4OTQ4NDk0", "url": "https://github.com/seata/seata/pull/2495#pullrequestreview-388948494", "createdAt": "2020-04-07T09:36:28Z", "commit": {"oid": "da7dbd260704a5146974c63ef9dd75b9d2f575a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwOTozNjoyOVrOGB7Rgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwOTozNjoyOVrOGB7Rgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY3Mjg5OA==", "bodyText": "That s ok. And I think can remove the code\nif (StringUtils.isNullOrEmpty(lockKey)) {\n            // no lock\n            return true;\n}\n\nat\nacquireLock(BranchSession branchSession)", "url": "https://github.com/seata/seata/pull/2495#discussion_r404672898", "createdAt": "2020-04-07T09:36:29Z", "author": {"login": "l81893521"}, "path": "server/src/main/java/io/seata/server/lock/AbstractLockManager.java", "diffHunk": "@@ -153,6 +153,9 @@ protected Locker getLocker() {\n                                             Long branchID) {\n         List<RowLock> locks = new ArrayList<RowLock>();\n \n+        if (StringUtils.isEmpty(lockKey)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da7dbd260704a5146974c63ef9dd75b9d2f575a5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1fccadaf1dcacd637520ffb547881db144bff89", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/d1fccadaf1dcacd637520ffb547881db144bff89", "committedDate": "2020-04-08T01:39:24Z", "message": "add:add the NPE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edfd9b36b4fabc8374a4e6c2480526bec6f5a4c0", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/edfd9b36b4fabc8374a4e6c2480526bec6f5a4c0", "committedDate": "2020-04-08T01:53:31Z", "message": "add:add the NPE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c4b11c22fb9f13a91c19d7e1484de3219444d01", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/7c4b11c22fb9f13a91c19d7e1484de3219444d01", "committedDate": "2020-04-08T02:01:25Z", "message": "remove:remove the NPE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjEyOTY5", "url": "https://github.com/seata/seata/pull/2495#pullrequestreview-389612969", "createdAt": "2020-04-08T02:26:54Z", "commit": {"oid": "7c4b11c22fb9f13a91c19d7e1484de3219444d01"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bab34915c1920088ce6e9711099f1b4818a52ce5", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/bab34915c1920088ce6e9711099f1b4818a52ce5", "committedDate": "2020-04-08T04:06:47Z", "message": "Merge branch 'develop' into fix_lockkey_is_null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjQzMzMw", "url": "https://github.com/seata/seata/pull/2495#pullrequestreview-389643330", "createdAt": "2020-04-08T04:23:56Z", "commit": {"oid": "bab34915c1920088ce6e9711099f1b4818a52ce5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3871, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}