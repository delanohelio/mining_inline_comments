{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMzQ3ODQz", "number": 2307, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzo0NTowN1rODlzQyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDowMToyM1rODnU41Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwOTYzNzg2OnYy", "diffSide": "RIGHT", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzo0NTowN1rOFy5Kog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzo0NTowN1rOFy5Kog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTczMA==", "bodyText": "Thoughtful point", "url": "https://github.com/seata/seata/pull/2307#discussion_r388909730", "createdAt": "2020-03-06T13:45:07Z", "author": {"login": "zjinlei"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -108,4 +109,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresUndoFunction() {\n+\n+        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+            return false;\n+        }\n+\n+        if (RootContext.inGlobalTransaction() && !RootContext.getBranchType().equals(String.valueOf(BranchType.AT.ordinal()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwOTYzODE2OnYy", "diffSide": "RIGHT", "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzo0NToxNFrOFy5KzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDo0MzoyNVrOFzLUEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTc3Mw==", "bodyText": "SAGA", "url": "https://github.com/seata/seata/pull/2307#discussion_r388909773", "createdAt": "2020-03-06T13:45:14Z", "author": {"login": "zjinlei"}, "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "diffHunk": "@@ -116,6 +117,7 @@ protected void beginTransaction(StateMachineInstance machineInstance, ProcessCon\n             TransactionInfo transactionInfo = new TransactionInfo();\n             transactionInfo.setTimeOut(stateMachineConfig.getTransOperationTimeout());\n             transactionInfo.setName(machineInstance.getStateMachine().getName());\n+            transactionInfo.setDefaultBranchType(BranchType.AT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1MDQzMg==", "bodyText": "Sega default branch type is at ?", "url": "https://github.com/seata/seata/pull/2307#discussion_r388950432", "createdAt": "2020-03-06T14:57:45Z", "author": {"login": "q294881866"}, "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "diffHunk": "@@ -116,6 +117,7 @@ protected void beginTransaction(StateMachineInstance machineInstance, ProcessCon\n             TransactionInfo transactionInfo = new TransactionInfo();\n             transactionInfo.setTimeOut(stateMachineConfig.getTransOperationTimeout());\n             transactionInfo.setName(machineInstance.getStateMachine().getName());\n+            transactionInfo.setDefaultBranchType(BranchType.AT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTc3Mw=="}, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMzkwNg==", "bodyText": "Sega default branch type is at ?\n\nMy fault", "url": "https://github.com/seata/seata/pull/2307#discussion_r389203906", "createdAt": "2020-03-07T00:25:40Z", "author": {"login": "booogu"}, "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "diffHunk": "@@ -116,6 +117,7 @@ protected void beginTransaction(StateMachineInstance machineInstance, ProcessCon\n             TransactionInfo transactionInfo = new TransactionInfo();\n             transactionInfo.setTimeOut(stateMachineConfig.getTransOperationTimeout());\n             transactionInfo.setName(machineInstance.getStateMachine().getName());\n+            transactionInfo.setDefaultBranchType(BranchType.AT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTc3Mw=="}, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNzA1OA==", "bodyText": "SAGA\n\nchanged", "url": "https://github.com/seata/seata/pull/2307#discussion_r389207058", "createdAt": "2020-03-07T00:43:25Z", "author": {"login": "booogu"}, "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "diffHunk": "@@ -116,6 +117,7 @@ protected void beginTransaction(StateMachineInstance machineInstance, ProcessCon\n             TransactionInfo transactionInfo = new TransactionInfo();\n             transactionInfo.setTimeOut(stateMachineConfig.getTransOperationTimeout());\n             transactionInfo.setName(machineInstance.getStateMachine().getName());\n+            transactionInfo.setDefaultBranchType(BranchType.AT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTc3Mw=="}, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwOTY0MDg1OnYy", "diffSide": "RIGHT", "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactional.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzo0NTo1OVrOFy5MUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDo0MzoxMVrOFzLT9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxMDE2Mw==", "bodyText": "defaultBranchType->branchType", "url": "https://github.com/seata/seata/pull/2307#discussion_r388910163", "createdAt": "2020-03-06T13:45:59Z", "author": {"login": "zjinlei"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactional.java", "diffHunk": "@@ -75,4 +76,10 @@\n      * @return\n      */\n     Propagation propagation() default Propagation.REQUIRED;\n-}\n+\n+    /**\n+     * default branch type\n+     * @return\n+     */\n+    BranchType defaultBranchType() default BranchType.AT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNzAyOA==", "bodyText": "changed", "url": "https://github.com/seata/seata/pull/2307#discussion_r389207028", "createdAt": "2020-03-07T00:43:11Z", "author": {"login": "booogu"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactional.java", "diffHunk": "@@ -75,4 +76,10 @@\n      * @return\n      */\n     Propagation propagation() default Propagation.REQUIRED;\n-}\n+\n+    /**\n+     * default branch type\n+     * @return\n+     */\n+    BranchType defaultBranchType() default BranchType.AT;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxMDE2Mw=="}, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwOTY0NzE3OnYy", "diffSide": "RIGHT", "path": "tm/src/main/java/io/seata/tm/api/transaction/TransactionInfo.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzo0Nzo1NlrOFy5QEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDo0MzowM1rOFzLT3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxMTEyMg==", "bodyText": "defaultBranchType-> branchType", "url": "https://github.com/seata/seata/pull/2307#discussion_r388911122", "createdAt": "2020-03-06T13:47:56Z", "author": {"login": "zjinlei"}, "path": "tm/src/main/java/io/seata/tm/api/transaction/TransactionInfo.java", "diffHunk": "@@ -35,6 +36,8 @@\n \n     private Propagation propagation;\n \n+    private BranchType defaultBranchType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNzAwNQ==", "bodyText": "changed", "url": "https://github.com/seata/seata/pull/2307#discussion_r389207005", "createdAt": "2020-03-07T00:43:03Z", "author": {"login": "booogu"}, "path": "tm/src/main/java/io/seata/tm/api/transaction/TransactionInfo.java", "diffHunk": "@@ -35,6 +36,8 @@\n \n     private Propagation propagation;\n \n+    private BranchType defaultBranchType;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxMTEyMg=="}, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwOTcwNTQ0OnYy", "diffSide": "RIGHT", "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNDowNTo1NVrOFy5ziQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNTo1MjowMVrOFzMycQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyMDIwMQ==", "bodyText": "if xid not empty, need to deal with previousBranchType", "url": "https://github.com/seata/seata/pull/2307#discussion_r388920201", "createdAt": "2020-03-06T14:05:55Z", "author": {"login": "zjinlei"}, "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -53,20 +54,24 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n         }\n         Propagation propagation = txInfo.getPropagation();\n         String previousXid = null;\n+        String previousBranchType = null;\n         try {\n             switch (propagation) {\n                 case NOT_SUPPORTED:\n                     previousXid = RootContext.unbind();\n                     return business.execute();\n                 case REQUIRES_NEW:\n                     previousXid = RootContext.unbind();\n+                    previousBranchType = RootContext.unbindBranchType();\n                     break;\n                 case SUPPORTS:\n                     if (StringUtils.isEmpty(RootContext.getXID())) {\n                         return business.execute();\n                     }\n                     break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNjYxMw==", "bodyText": "I aggree with you and now my strategy is: If propagation is RequiresNew, then suspend the  previousXid and branchtype  (whether previousXid is null or not), and desides whether to recover them or not in the  finally{} call  by judging whether the previous value is empty.", "url": "https://github.com/seata/seata/pull/2307#discussion_r389206613", "createdAt": "2020-03-07T00:40:41Z", "author": {"login": "booogu"}, "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -53,20 +54,24 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n         }\n         Propagation propagation = txInfo.getPropagation();\n         String previousXid = null;\n+        String previousBranchType = null;\n         try {\n             switch (propagation) {\n                 case NOT_SUPPORTED:\n                     previousXid = RootContext.unbind();\n                     return business.execute();\n                 case REQUIRES_NEW:\n                     previousXid = RootContext.unbind();\n+                    previousBranchType = RootContext.unbindBranchType();\n                     break;\n                 case SUPPORTS:\n                     if (StringUtils.isEmpty(RootContext.getXID())) {\n                         return business.execute();\n                     }\n                     break;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyMDIwMQ=="}, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMTIxNw==", "bodyText": "My mistake, I mean SUPPORTS.", "url": "https://github.com/seata/seata/pull/2307#discussion_r389231217", "createdAt": "2020-03-07T05:52:01Z", "author": {"login": "zjinlei"}, "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -53,20 +54,24 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n         }\n         Propagation propagation = txInfo.getPropagation();\n         String previousXid = null;\n+        String previousBranchType = null;\n         try {\n             switch (propagation) {\n                 case NOT_SUPPORTED:\n                     previousXid = RootContext.unbind();\n                     return business.execute();\n                 case REQUIRES_NEW:\n                     previousXid = RootContext.unbind();\n+                    previousBranchType = RootContext.unbindBranchType();\n                     break;\n                 case SUPPORTS:\n                     if (StringUtils.isEmpty(RootContext.getXID())) {\n                         return business.execute();\n                     }\n                     break;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyMDIwMQ=="}, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTYzMjg1OnYy", "diffSide": "RIGHT", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDowMToyM1rOF1QkdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTo0NjozOVrOF1R6xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MDMyNA==", "bodyText": "StringUtils.equals", "url": "https://github.com/seata/seata/pull/2307#discussion_r391390324", "createdAt": "2020-03-12T04:01:23Z", "author": {"login": "jsbxyyx"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -108,4 +109,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresUndoFunction() {\n+\n+        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+            return false;\n+        }\n+\n+        if (RootContext.inGlobalTransaction() && !RootContext.getBranchType().equals(String.valueOf(BranchType.AT.ordinal()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57e7dfd979b2730809421c4f8ce5a629aead0083"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMjQyMg==", "bodyText": "Changed", "url": "https://github.com/seata/seata/pull/2307#discussion_r391412422", "createdAt": "2020-03-12T05:46:39Z", "author": {"login": "booogu"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -108,4 +109,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresUndoFunction() {\n+\n+        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+            return false;\n+        }\n+\n+        if (RootContext.inGlobalTransaction() && !RootContext.getBranchType().equals(String.valueOf(BranchType.AT.ordinal()))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MDMyNA=="}, "originalCommit": {"oid": "57e7dfd979b2730809421c4f8ce5a629aead0083"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1642, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}