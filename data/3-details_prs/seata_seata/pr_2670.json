{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NTI2NjAy", "number": 2670, "title": "bugfix: fix data source initialize more times", "bodyText": "\u2160. Describe what this PR did\nfix data source initialize more than one time cause the data source instance is not a single instance.\n\u2161. Does this pull request fix one issue?\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-05-09T06:32:16Z", "url": "https://github.com/seata/seata/pull/2670", "merged": true, "mergeCommit": {"oid": "fd3edf610b95d694658dd4759673f4c42d4324a7"}, "closed": true, "closedAt": "2020-05-12T07:26:27Z", "author": {"login": "l81893521"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfgf4PgH2gAyNDE1NTI2NjAyOjNmNDBiYjNmYjAwNWFiOWUxYjY2NjhhMWYxZTQ0OGUzZmE4YWMwZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgeekaAFqTQwOTczOTk4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3f40bb3fb005ab9e1b6668a1f1e448e3fa8ac0d1", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/3f40bb3fb005ab9e1b6668a1f1e448e3fa8ac0d1", "committedDate": "2020-05-09T06:29:31Z", "message": "fix single datasource instance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjE5MDE3", "url": "https://github.com/seata/seata/pull/2670#pullrequestreview-408619017", "createdAt": "2020-05-09T06:49:20Z", "commit": {"oid": "3f40bb3fb005ab9e1b6668a1f1e448e3fa8ac0d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNjo0OToyMFrOGS483w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNjo0OToyMFrOGS483w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2MDYzOQ==", "bodyText": "retain generateDataSource() ?", "url": "https://github.com/seata/seata/pull/2670#discussion_r422460639", "createdAt": "2020-05-09T06:49:20Z", "author": {"login": "jsbxyyx"}, "path": "core/src/main/java/io/seata/core/store/db/DataSourceGenerator.java", "diffHunk": "@@ -25,10 +25,9 @@\n public interface DataSourceGenerator {\n \n     /**\n-     * create DataSource from config\n-     *\n+     * get the data source\n      * @return data source\n      */\n-    DataSource generateDataSource();\n+    DataSource get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f40bb3fb005ab9e1b6668a1f1e448e3fa8ac0d1"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NjIxMTgw", "url": "https://github.com/seata/seata/pull/2670#pullrequestreview-408621180", "createdAt": "2020-05-09T07:16:15Z", "commit": {"oid": "3f40bb3fb005ab9e1b6668a1f1e448e3fa8ac0d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNzoxNjoxNVrOGS5FjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwNzoxNjoxNVrOGS5FjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ2Mjg2MQ==", "bodyText": "recommended to implement io.seata.common.executor.Initialize", "url": "https://github.com/seata/seata/pull/2670#discussion_r422462861", "createdAt": "2020-05-09T07:16:15Z", "author": {"login": "zjinlei"}, "path": "core/src/main/java/io/seata/core/store/db/AbstractDataSourceGenerator.java", "diffHunk": "@@ -60,6 +65,24 @@\n \n     private static final long DEFAULT_DB_MAX_WAIT = 5000;\n \n+    /**\n+     * generate the data source\n+     */\n+    public AbstractDataSourceGenerator() {\n+        this.dataSource = this.generate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f40bb3fb005ab9e1b6668a1f1e448e3fa8ac0d1"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4844e45afa168c0c7886881f3f76339c04c008f0", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/4844e45afa168c0c7886881f3f76339c04c008f0", "committedDate": "2020-05-09T07:27:48Z", "message": "implement initialize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfc482712f977a4092a116a0e55467d08695b9a4", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/bfc482712f977a4092a116a0e55467d08695b9a4", "committedDate": "2020-05-10T02:39:25Z", "message": "Merge branch 'develop' into fix_single_datasource_instance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faa201f8eed6923917ea60fa0e110deb232b76be", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/faa201f8eed6923917ea60fa0e110deb232b76be", "committedDate": "2020-05-10T06:56:33Z", "message": "remove generator and add provider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzMwNTk5", "url": "https://github.com/seata/seata/pull/2670#pullrequestreview-408730599", "createdAt": "2020-05-10T10:28:40Z", "commit": {"oid": "faa201f8eed6923917ea60fa0e110deb232b76be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQxMDoyODo0MFrOGTC7Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQxMDoyODo0MFrOGTC7Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYyNDA3MQ==", "bodyText": "common method, move to abstract class.", "url": "https://github.com/seata/seata/pull/2670#discussion_r422624071", "createdAt": "2020-05-10T10:28:40Z", "author": {"login": "zjinlei"}, "path": "server/src/main/java/io/seata/server/store/DbcpDataSourceProvider.java", "diffHunk": "@@ -49,6 +49,11 @@ public DataSource generateDataSource() {\n         ds.setTestWhileIdle(true);\n         ds.setValidationQuery(getValidationQuery(getDBType()));\n         ds.setConnectionProperties(\"useUnicode=yes;characterEncoding=utf8;socketTimeout=5000;connectTimeout=500\");\n-        return ds;\n+        setDataSource(ds);\n+    }\n+\n+    @Override\n+    public DataSource provide() {\n+        return getDataSource();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faa201f8eed6923917ea60fa0e110deb232b76be"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MTk1MDA2", "url": "https://github.com/seata/seata/pull/2670#pullrequestreview-409195006", "createdAt": "2020-05-11T13:54:59Z", "commit": {"oid": "faa201f8eed6923917ea60fa0e110deb232b76be"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMzo1NTowMFrOGTdWWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMzo1NTowMFrOGTdWWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA1Njk4Ng==", "bodyText": "You can put the test case in the abstract class", "url": "https://github.com/seata/seata/pull/2670#discussion_r423056986", "createdAt": "2020-05-11T13:55:00Z", "author": {"login": "slievrly"}, "path": "server/src/test/java/io/seata/server/store/db/DbcpDataSourceProviderTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.server.store.db;\n+\n+import io.seata.common.loader.EnhancedServiceLoader;\n+import io.seata.core.store.db.DataSourceProvider;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+import javax.sql.DataSource;\n+\n+/**\n+ * @author will\n+ */\n+public class DbcpDataSourceProviderTest {\n+\n+    private final String datasourceType = \"dbcp\";\n+\n+    @Test\n+    public void testDbcpDataSourceProvider() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faa201f8eed6923917ea60fa0e110deb232b76be"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bc76da9fac5d21328b228b75b610c8f0ea3fa0f", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/3bc76da9fac5d21328b228b75b610c8f0ea3fa0f", "committedDate": "2020-05-12T01:37:38Z", "message": "Merge branch 'develop' into fix_single_datasource_instance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac9789b148595e06ffc083b4721b08294c7dafd5", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/ac9789b148595e06ffc083b4721b08294c7dafd5", "committedDate": "2020-05-12T01:59:20Z", "message": "move provide() to abstractDatasourceProvider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "727cef9d293dbf5ef3b53464afac678bdb702cfe", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/727cef9d293dbf5ef3b53464afac678bdb702cfe", "committedDate": "2020-05-12T02:03:26Z", "message": "add abstract data source provider and remove dbcp, druid, hikari test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzEyMTU2", "url": "https://github.com/seata/seata/pull/2670#pullrequestreview-409712156", "createdAt": "2020-05-12T05:40:30Z", "commit": {"oid": "727cef9d293dbf5ef3b53464afac678bdb702cfe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzEyOTkz", "url": "https://github.com/seata/seata/pull/2670#pullrequestreview-409712993", "createdAt": "2020-05-12T05:42:55Z", "commit": {"oid": "727cef9d293dbf5ef3b53464afac678bdb702cfe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNTo0Mjo1NVrOGT20RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNTo0Mjo1NVrOGT20RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NDI0NQ==", "bodyText": "merge dataSourceType to array. for each test dataSource not null? simplify test case?", "url": "https://github.com/seata/seata/pull/2670#discussion_r423474245", "createdAt": "2020-05-12T05:42:55Z", "author": {"login": "jsbxyyx"}, "path": "server/src/test/java/io/seata/server/store/db/AbstractDataSourceProviderTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.server.store.db;\n+\n+import io.seata.common.loader.EnhancedServiceLoader;\n+import io.seata.core.store.db.DataSourceProvider;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+import javax.sql.DataSource;\n+\n+/**\n+ * @author: will\n+ */\n+public class AbstractDataSourceProviderTest {\n+\n+    private final String dbcpDatasourceType = \"dbcp\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "727cef9d293dbf5ef3b53464afac678bdb702cfe"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fb19a6cee70feee2dcd40880f72a302a103df6d", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/3fb19a6cee70feee2dcd40880f72a302a103df6d", "committedDate": "2020-05-12T06:09:22Z", "message": "add author name and remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzIzNjc4", "url": "https://github.com/seata/seata/pull/2670#pullrequestreview-409723678", "createdAt": "2020-05-12T06:09:33Z", "commit": {"oid": "727cef9d293dbf5ef3b53464afac678bdb702cfe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4a35567692e041851bdd91ce236e741f17beb0f", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/c4a35567692e041851bdd91ce236e741f17beb0f", "committedDate": "2020-05-12T06:20:41Z", "message": "change init to generate."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92e8fbecd30c1e08a50419e621171cbd8f004938", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/92e8fbecd30c1e08a50419e621171cbd8f004938", "committedDate": "2020-05-12T06:38:29Z", "message": "indentation 4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fb9d641b95995766679daa1a2620c705a4317b3", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/5fb9d641b95995766679daa1a2620c705a4317b3", "committedDate": "2020-05-12T06:39:45Z", "message": "Merge branch 'develop' into fix_single_datasource_instance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzM5OTgw", "url": "https://github.com/seata/seata/pull/2670#pullrequestreview-409739980", "createdAt": "2020-05-12T06:42:12Z", "commit": {"oid": "5fb9d641b95995766679daa1a2620c705a4317b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3965, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}