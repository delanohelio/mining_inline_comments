{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NzcyNzQz", "number": 2415, "title": "optimize: distinguish database behavior according to the branch type", "bodyText": "\u2160. Describe what this PR did\n1.Change the interceptorType to branchType,optimize the logic in TccActionInterceptor\n2.Optimize the judge condition of use UndoFunction in AT's ExecuteTemplate\n\u2161. Does this pull request fix one issue?\n\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-03-17T11:13:53Z", "url": "https://github.com/seata/seata/pull/2415", "merged": true, "mergeCommit": {"oid": "e5c68a78eab4d47f24cc5a30051add53700b3ada"}, "closed": true, "closedAt": "2020-04-27T01:54:25Z", "author": {"login": "booogu"}, "timelineItems": {"totalCount": 49, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIIYRtAH2gAyMzg5NzcyNzQzOjkyYTFlNGI0MDBiNGU1YTUyNTMwZTg5NjU1OTlmNzkyOGM4ZTMyZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbkdrPAH2gAyMzg5NzcyNzQzOjk3MGU4NmY0NDQ5NTA4MDk1ZmU4NmJkY2JjYzE1OWU3NzE5ZmYwN2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "92a1e4b400b4e5a52530e8965599f7928c8e32d3", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/92a1e4b400b4e5a52530e8965599f7928c8e32d3", "committedDate": "2020-02-26T15:23:14Z", "message": "optimize: optimize transaction context behavior when transaction mode is switched"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7829ce7022660f47357d2e10aab4b80b2c1a9fff", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/7829ce7022660f47357d2e10aab4b80b2c1a9fff", "committedDate": "2020-02-29T03:38:54Z", "message": "adjust BranchType switching with Propagation feature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4e407885ef5496cc26bca0a3a2df083efc37c12", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/f4e407885ef5496cc26bca0a3a2df083efc37c12", "committedDate": "2020-03-02T02:17:52Z", "message": "Merge remote-tracking branch 'upstream/develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef1ea3cb4db95c87aa787f48720bb8cc1c12f5ae", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/ef1ea3cb4db95c87aa787f48720bb8cc1c12f5ae", "committedDate": "2020-03-02T03:18:06Z", "message": "format code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/65312ddb69e103cea2552d6ea6ee3893bf31e509", "committedDate": "2020-03-05T01:46:22Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3f14830d070fe5232213ac533e2867fe10f610b", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/d3f14830d070fe5232213ac533e2867fe10f610b", "committedDate": "2020-03-06T14:06:47Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bbdd1fc0acf440c167338afa4689b27e35df6d0", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/9bbdd1fc0acf440c167338afa4689b27e35df6d0", "committedDate": "2020-03-07T00:42:34Z", "message": "fix the mistake in sagaBranch and rename defaultBranchType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fb6dc213670d1615639c6b3eb4dc41f7e0c62ce", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/8fb6dc213670d1615639c6b3eb4dc41f7e0c62ce", "committedDate": "2020-03-07T06:02:04Z", "message": "handle required branchType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "059610878760c39482ebd63d6642f34b8d681bff", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/059610878760c39482ebd63d6642f34b8d681bff", "committedDate": "2020-03-07T11:02:37Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52335c8448fcad3e091dcde510731c13e59b30c6", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/52335c8448fcad3e091dcde510731c13e59b30c6", "committedDate": "2020-03-10T08:22:06Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57e7dfd979b2730809421c4f8ce5a629aead0083", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/57e7dfd979b2730809421c4f8ce5a629aead0083", "committedDate": "2020-03-11T12:36:26Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06e79eaff0997739b87f45d2763e16f064bb2a2e", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/06e79eaff0997739b87f45d2763e16f064bb2a2e", "committedDate": "2020-03-12T05:41:42Z", "message": "use StringUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0b3128655aecb41e6e87eac55c593647ef43481", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/d0b3128655aecb41e6e87eac55c593647ef43481", "committedDate": "2020-03-17T07:53:56Z", "message": "Merge remote-tracking branch 'upstream/develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e721fb1be5eb6db499a77cf1cc27530cd34e407f", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/e721fb1be5eb6db499a77cf1cc27530cd34e407f", "committedDate": "2020-03-17T09:53:57Z", "message": "optimize: optimize interceptorType to branchType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6a1cb6f2b0ec42d8566c2148f93ca81714401e2", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/f6a1cb6f2b0ec42d8566c2148f93ca81714401e2", "committedDate": "2020-03-17T11:57:56Z", "message": "remove unuse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03d9a959cdaeacf6cc4e247c64e8f71553ce4fbe", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/03d9a959cdaeacf6cc4e247c64e8f71553ce4fbe", "committedDate": "2020-03-18T01:51:24Z", "message": "optimize rootcontext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3837de8313b336e39189cfc47cb806f472ea4b6", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/a3837de8313b336e39189cfc47cb806f472ea4b6", "committedDate": "2020-03-19T03:01:30Z", "message": "optimize branchType to tccScope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6030169137643d51fbe264784882dbe026316fae", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/6030169137643d51fbe264784882dbe026316fae", "committedDate": "2020-03-19T03:01:51Z", "message": "Merge remote-tracking branch 'upstream/develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd12c625ec82475ebe79d4600fac18aacf7a1a62", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/fd12c625ec82475ebe79d4600fac18aacf7a1a62", "committedDate": "2020-03-19T04:38:01Z", "message": "optimize branchType and tccScope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c50587fa89828164fa6b974694797f4cfb978465", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/c50587fa89828164fa6b974694797f4cfb978465", "committedDate": "2020-03-19T05:44:01Z", "message": "format some incorrect code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97510c0f233fb92b3fdb893a8eacc6c8f133866d", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/97510c0f233fb92b3fdb893a8eacc6c8f133866d", "committedDate": "2020-03-19T05:53:06Z", "message": "format code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "657c45ebd240b2f113666d740e87f229005bc1a2", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/657c45ebd240b2f113666d740e87f229005bc1a2", "committedDate": "2020-03-19T06:39:20Z", "message": "format code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d9a0324dad02dc889eec55f1c2f244d1410f978", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/3d9a0324dad02dc889eec55f1c2f244d1410f978", "committedDate": "2020-03-19T10:15:51Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5afdfc240e6c4c25c24a912d0c0573af89eed6c0", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/5afdfc240e6c4c25c24a912d0c0573af89eed6c0", "committedDate": "2020-03-23T04:29:52Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5dd5cde56612a08455118395a2a0fa6d227e774", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/d5dd5cde56612a08455118395a2a0fa6d227e774", "committedDate": "2020-03-25T00:46:01Z", "message": "Merge remote-tracking branch 'upstream/develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a0613b9a71a1457d4b9e6e4a521b2ba3c83f9dd", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/3a0613b9a71a1457d4b9e6e4a521b2ba3c83f9dd", "committedDate": "2020-03-25T09:36:36Z", "message": "merge latest code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MDc5MzMw", "url": "https://github.com/seata/seata/pull/2415#pullrequestreview-397079330", "createdAt": "2020-04-21T07:57:40Z", "commit": {"oid": "3a0613b9a71a1457d4b9e6e4a521b2ba3c83f9dd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwNzo1Nzo0MFrOGI4CeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwNzo1Nzo0MFrOGI4CeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk1OTkyOQ==", "bodyText": "Add BranchType.SAGA. Bind Saga type will commit at another pr : #2551", "url": "https://github.com/seata/seata/pull/2415#discussion_r411959929", "createdAt": "2020-04-21T07:57:40Z", "author": {"login": "long187"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -108,4 +110,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresUndoFunction() {\n+\n+        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+            return false;\n+        }\n+\n+        if (RootContext.inGlobalTransaction() && StringUtils.equals(BranchType.TCC.name(), RootContext.getBranchType())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a0613b9a71a1457d4b9e6e4a521b2ba3c83f9dd"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4785c8693fe209b820009da41f40b45707420a71", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/4785c8693fe209b820009da41f40b45707420a71", "committedDate": "2020-04-21T08:38:16Z", "message": "add SAGA in requireUndoFunction judgement conditions in"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "640477daf7b3f343ac0e245c2c593af69a309935", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/640477daf7b3f343ac0e245c2c593af69a309935", "committedDate": "2020-04-21T14:47:39Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4", "committedDate": "2020-04-21T15:01:15Z", "message": "fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDUyMjMz", "url": "https://github.com/seata/seata/pull/2415#pullrequestreview-397452233", "createdAt": "2020-04-21T15:40:09Z", "commit": {"oid": "bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNTo0MDoxMFrOGJMSWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNTo0MDoxMFrOGJMSWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MTY3Mw==", "bodyText": "?\nNot the same as ApacheDubboTransactionPropagationFilter.java", "url": "https://github.com/seata/seata/pull/2415#discussion_r412291673", "createdAt": "2020-04-21T15:40:10Z", "author": {"login": "zjinlei"}, "path": "integration/dubbo-alibaba/src/main/java/io/seata/integration/dubbo/alibaba/AlibabaDubboTransactionPropagationFilter.java", "diffHunk": "@@ -43,45 +45,49 @@ public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcExcept\n             return invoker.invoke(invocation);\n         }\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcInTCCScope = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);\n         } else {\n             if (rpcXid != null) {\n                 RootContext.bind(rpcXid);\n-                RootContext.bindInterceptorType(rpcXidInterceptorType);\n+                if (StringUtils.equals(rpcInTCCScope, String.valueOf(true))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDU0MTUx", "url": "https://github.com/seata/seata/pull/2415#pullrequestreview-397454151", "createdAt": "2020-04-21T15:45:46Z", "commit": {"oid": "bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNTo0NTo0OFrOGJMYPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNTo0NTo0OFrOGJMYPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MzE4MQ==", "bodyText": "Log output branchType", "url": "https://github.com/seata/seata/pull/2415#discussion_r412293181", "createdAt": "2020-04-21T15:45:48Z", "author": {"login": "zjinlei"}, "path": "integration/dubbo/src/main/java/io/seata/integration/dubbo/ApacheDubboTransactionPropagationFilter.java", "diffHunk": "@@ -40,42 +42,49 @@\n     @Override\n     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcBranchType = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);\n         } else {\n             if (rpcXid != null) {\n                 RootContext.bind(rpcXid);\n-                RootContext.bindInterceptorType(rpcXidInterceptorType);\n+                if (StringUtils.equals(BranchType.TCC.name(), rpcBranchType)) {\n+                    RootContext.bindBranchType(BranchType.TCC);\n+                }\n                 bind = true;\n                 if (LOGGER.isDebugEnabled()) {\n-                    LOGGER.debug(\"bind[{}] interceptorType[{}] to RootContext\", rpcXid, rpcXidInterceptorType);\n+                    LOGGER.debug(\"bind[{}] to RootContext\", rpcXid);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9979b005b423a04db6c5c33e67fa37e8f310b744", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/9979b005b423a04db6c5c33e67fa37e8f310b744", "committedDate": "2020-04-22T02:22:19Z", "message": "format code and keep code same in integration module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95ddbe280d1ac8f9c05bd78e3f14707780450862", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/95ddbe280d1ac8f9c05bd78e3f14707780450862", "committedDate": "2020-04-22T02:24:57Z", "message": "Merge branch 'f_tcc' of https://github.com/CharmingRabbit/seata into f_tcc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODU0NTEy", "url": "https://github.com/seata/seata/pull/2415#pullrequestreview-397854512", "createdAt": "2020-04-22T05:31:55Z", "commit": {"oid": "95ddbe280d1ac8f9c05bd78e3f14707780450862"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNTozMTo1NVrOGJkFZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNTozMjozN1rOGJkGSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY4MTU3Mg==", "bodyText": "Combine xid and branchType output without judgment \"if (StringUtils.equals(BranchType.TCC.name()...\"", "url": "https://github.com/seata/seata/pull/2415#discussion_r412681572", "createdAt": "2020-04-22T05:31:55Z", "author": {"login": "zjinlei"}, "path": "integration/dubbo/src/main/java/io/seata/integration/dubbo/ApacheDubboTransactionPropagationFilter.java", "diffHunk": "@@ -40,42 +42,49 @@\n     @Override\n     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcBranchType = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);\n         } else {\n             if (rpcXid != null) {\n                 RootContext.bind(rpcXid);\n-                RootContext.bindInterceptorType(rpcXidInterceptorType);\n+                if (StringUtils.equals(BranchType.TCC.name(), rpcBranchType)) {\n+                    RootContext.bindBranchType(BranchType.TCC);\n+                }\n                 bind = true;\n                 if (LOGGER.isDebugEnabled()) {\n-                    LOGGER.debug(\"bind[{}] interceptorType[{}] to RootContext\", rpcXid, rpcXidInterceptorType);\n+                    LOGGER.debug(\"bind[{}] to RootContext\", rpcXid);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MzE4MQ=="}, "originalCommit": {"oid": "bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY4MTgwMA==", "bodyText": "@GlobalLock does not have undo, this function name should be optimized", "url": "https://github.com/seata/seata/pull/2415#discussion_r412681800", "createdAt": "2020-04-22T05:32:37Z", "author": {"login": "zjinlei"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -66,7 +68,7 @@\n                                                      StatementCallback<T, S> statementCallback,\n                                                      Object... args) throws SQLException {\n \n-        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+        if (!requiresUndoFunction()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95ddbe280d1ac8f9c05bd78e3f14707780450862"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4ODE5MTUw", "url": "https://github.com/seata/seata/pull/2415#pullrequestreview-398819150", "createdAt": "2020-04-23T07:14:47Z", "commit": {"oid": "95ddbe280d1ac8f9c05bd78e3f14707780450862"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNzoxNDo0N1rOGKaONg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNzoxNDo0N1rOGKaONg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2ODU2Ng==", "bodyText": "Saga branch never set ?", "url": "https://github.com/seata/seata/pull/2415#discussion_r413568566", "createdAt": "2020-04-23T07:14:47Z", "author": {"login": "wangliang181230"}, "path": "integration/dubbo-alibaba/src/main/java/io/seata/integration/dubbo/alibaba/AlibabaDubboTransactionPropagationFilter.java", "diffHunk": "@@ -43,45 +45,56 @@ public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcExcept\n             return invoker.invoke(invocation);\n         }\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcBranchType = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);\n         } else {\n             if (rpcXid != null) {\n                 RootContext.bind(rpcXid);\n-                RootContext.bindInterceptorType(rpcXidInterceptorType);\n+                if (StringUtils.equals(BranchType.TCC.name(), rpcBranchType)) {\n+                    RootContext.bindBranchType(BranchType.TCC);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95ddbe280d1ac8f9c05bd78e3f14707780450862"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MDY3MzMw", "url": "https://github.com/seata/seata/pull/2415#pullrequestreview-399067330", "createdAt": "2020-04-23T12:52:07Z", "commit": {"oid": "95ddbe280d1ac8f9c05bd78e3f14707780450862"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7666bc1f420b2d0db84a053b98c6f3167c4eb946", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/7666bc1f420b2d0db84a053b98c6f3167c4eb946", "committedDate": "2020-04-24T13:14:31Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "127b3e8622f098dd9a80242ff264050f5d4ff3b2", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/127b3e8622f098dd9a80242ff264050f5d4ff3b2", "committedDate": "2020-04-24T13:36:12Z", "message": "optimize log output and func name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7d249b62e88bedb73980dd0affc594d24a3a46d", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/d7d249b62e88bedb73980dd0affc594d24a3a46d", "committedDate": "2020-04-24T13:36:39Z", "message": "Merge branch 'f_tcc' of https://github.com/CharmingRabbit/seata into f_tcc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMDQ4Mzgy", "url": "https://github.com/seata/seata/pull/2415#pullrequestreview-400048382", "createdAt": "2020-04-24T15:26:56Z", "commit": {"oid": "d7d249b62e88bedb73980dd0affc594d24a3a46d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69f29b73cd3d6588e328120ce11b4c5d3198c3f9", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/69f29b73cd3d6588e328120ce11b4c5d3198c3f9", "committedDate": "2020-04-24T15:56:24Z", "message": "restore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzYzMzU4", "url": "https://github.com/seata/seata/pull/2415#pullrequestreview-400363358", "createdAt": "2020-04-25T06:00:26Z", "commit": {"oid": "69f29b73cd3d6588e328120ce11b4c5d3198c3f9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e86dd32c43b972293c0a6826b4caa9d9bfbfc92", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/7e86dd32c43b972293c0a6826b4caa9d9bfbfc92", "committedDate": "2020-04-26T06:37:00Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDg2MjYy", "url": "https://github.com/seata/seata/pull/2415#pullrequestreview-400486262", "createdAt": "2020-04-26T10:19:15Z", "commit": {"oid": "7e86dd32c43b972293c0a6826b4caa9d9bfbfc92"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQxMDoxOToxNVrOGMCVWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQxMDoyMTo1M1rOGMCXfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3NDMzMQ==", "bodyText": "Is it better to separate and judge?", "url": "https://github.com/seata/seata/pull/2415#discussion_r415274331", "createdAt": "2020-04-26T10:19:15Z", "author": {"login": "slievrly"}, "path": "integration/dubbo-alibaba/src/main/java/io/seata/integration/dubbo/alibaba/AlibabaDubboTransactionPropagationFilter.java", "diffHunk": "@@ -43,45 +45,51 @@ public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcExcept\n             return invoker.invoke(invocation);\n         }\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcBranchType = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e86dd32c43b972293c0a6826b4caa9d9bfbfc92"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3NDYzNw==", "bodyText": "BranchType print null in AT mode is not very elegant.", "url": "https://github.com/seata/seata/pull/2415#discussion_r415274637", "createdAt": "2020-04-26T10:20:56Z", "author": {"login": "slievrly"}, "path": "integration/dubbo-alibaba/src/main/java/io/seata/integration/dubbo/alibaba/AlibabaDubboTransactionPropagationFilter.java", "diffHunk": "@@ -43,45 +45,51 @@ public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcExcept\n             return invoker.invoke(invocation);\n         }\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcBranchType = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);\n         } else {\n             if (rpcXid != null) {\n                 RootContext.bind(rpcXid);\n-                RootContext.bindInterceptorType(rpcXidInterceptorType);\n+                if (StringUtils.equals(BranchType.TCC.name(), rpcBranchType)) {\n+                    RootContext.bindBranchType(BranchType.TCC);\n+                }\n                 bind = true;\n                 if (LOGGER.isDebugEnabled()) {\n-                    LOGGER.debug(\"bind[{}] interceptorType[{}] to RootContext\", rpcXid, rpcXidInterceptorType);\n+                    LOGGER.debug(\"bind xid [{}] branchType [{}] to RootContext\", rpcXid, rpcBranchType);\n                 }\n             }\n         }\n         try {\n             return invoker.invoke(invocation);\n-\n         } finally {\n             if (bind) {\n-                String unbindInterceptorType = RootContext.unbindInterceptorType();\n                 String unbindXid = RootContext.unbind();\n+                String previousBranchType = RootContext.getBranchType();\n+                if (StringUtils.equals(BranchType.TCC.name(), previousBranchType)) {\n+                    RootContext.unbindBranchType();\n+                }\n                 if (LOGGER.isDebugEnabled()) {\n-                    LOGGER.debug(\"unbind[{}] interceptorType[{}] from RootContext\", unbindXid, unbindInterceptorType);\n+                    LOGGER.debug(\"unbind xid [{}] branchType [{}] from RootContext\", unbindXid, previousBranchType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e86dd32c43b972293c0a6826b4caa9d9bfbfc92"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3NDg3OQ==", "bodyText": "Other more meaningful method name?", "url": "https://github.com/seata/seata/pull/2415#discussion_r415274879", "createdAt": "2020-04-26T10:21:53Z", "author": {"login": "slievrly"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -115,4 +117,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresLockOrUndoFunction() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e86dd32c43b972293c0a6826b4caa9d9bfbfc92"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5c438ef9a0a86081d1af695542232c4f5b0eef4", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/f5c438ef9a0a86081d1af695542232c4f5b0eef4", "committedDate": "2020-04-26T11:07:08Z", "message": "optimize func name and log output"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d41df6973fcac9c38b7e3e50022f091ef425b05", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/7d41df6973fcac9c38b7e3e50022f091ef425b05", "committedDate": "2020-04-26T11:11:17Z", "message": "Merge branch 'f_tcc' of https://github.com/CharmingRabbit/seata into f_tcc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDk3ODM4", "url": "https://github.com/seata/seata/pull/2415#pullrequestreview-400497838", "createdAt": "2020-04-26T12:19:34Z", "commit": {"oid": "7d41df6973fcac9c38b7e3e50022f091ef425b05"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "970e86f4449508095fe86bdcbcc159e7719ff07d", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/970e86f4449508095fe86bdcbcc159e7719ff07d", "committedDate": "2020-04-27T00:51:02Z", "message": "remove travis -p param"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4100, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}