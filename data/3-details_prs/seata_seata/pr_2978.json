{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMjg4NzQ5", "number": 2978, "title": "optimize: opt globalCommit for mixed use of AT and TCC", "bodyText": "\u2160. Describe what this PR did\noptimize: opt globalCommit for mixed use of AT and TCC.\n\u4f18\u5316\u6df7\u5408\u4f7f\u7528AT\u548cTCC\u65f6\u7684\u5168\u5c40\u63d0\u4ea4\u7684\u6027\u80fd\uff0cAT\u5206\u652f\u8d8a\u591a\u7684\u5168\u5c40\u4e8b\u52a1\uff0c\u5168\u5c40\u63d0\u4ea4\u7684\u6027\u80fd\u63d0\u5347\u8d8a\u5927\u3002\n\u4f18\u5316\u5185\u5bb9\uff1a\n\u5728AT\u548cTCC\u6df7\u5408\u4f7f\u7528\u7684\u60c5\u51b5\u4e0b\uff0c\u5f53\u5168\u5c40\u63d0\u4ea4\u65f6\uff0c\u5148\u63d0\u4ea4\u6240\u6709TCC\u5206\u652f\uff0c\u5269\u4f59\u7684AT\u5206\u652f\u518d\u4ea4\u7531handleAsyncCommitting\u5f02\u6b65\u5904\u7406\u3002\n\u6ce8\uff1a\u76ee\u524d\u53ea\u6709AT\u5206\u652f\u652f\u6301\u5f02\u6b65\u63d0\u4ea4\u3002\u4f46\u662f\u5728 PR #2981 \u91cc\uff0c\u6dfb\u52a0\u4e86\u652f\u6301TCC\u5206\u652f\u53ef\u81ea\u5b9a\u4e49\u4e3a\u5f02\u6b65\u63d0\u4ea4\u3002\n\u2161. Does this pull request fix one issue?\n\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-08-05T10:18:29Z", "url": "https://github.com/seata/seata/pull/2978", "merged": true, "mergeCommit": {"oid": "e1e659dac7c0c180749866b3748549cd9706bd6c"}, "closed": true, "closedAt": "2020-08-18T09:56:26Z", "author": {"login": "wangliang181230"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc74dc6AH2gAyNDYzMjg4NzQ5OmQ2NDgxOTJlNTg2MzIwYWQ3ZGU2ZjcxM2JmZWViOTViMjVkYzFiOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdABpWFAFqTQ2OTA0ODgwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d648192e586320ad7de6f713bfeeb95b25dc1b96", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/d648192e586320ad7de6f713bfeeb95b25dc1b96", "committedDate": "2020-08-05T10:14:28Z", "message": "optimize: opt globalCommit for mixed use of AT and TCC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeabbfce88166e2be35b2719ee65ef9a87ccf155", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/aeabbfce88166e2be35b2719ee65ef9a87ccf155", "committedDate": "2020-08-05T10:23:19Z", "message": "Merge branch 'develop' into optimize-at-tcc-globalCommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eef3a70bc92aed76ef0997604c233cf360f6d4b7", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/eef3a70bc92aed76ef0997604c233cf360f6d4b7", "committedDate": "2020-08-06T01:40:17Z", "message": "\u6dfb\u52a0\u53ef\u5f02\u6b65\u63d0\u4ea4\u7684\u63a5\u53e3\u3002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d08053aba7bed0e156f6a950006252a356b809a1", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/d08053aba7bed0e156f6a950006252a356b809a1", "committedDate": "2020-08-06T01:41:11Z", "message": "Merge remote-tracking branch 'remotes/upstream/develop' into optimize-at-tcc-globalCommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5345d36752cdc54de3a20bdd55c13533446a92b4", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/5345d36752cdc54de3a20bdd55c13533446a92b4", "committedDate": "2020-08-06T11:05:42Z", "message": "Merge branch 'develop' into optimize-at-tcc-globalCommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "316322ca7899ed798c89fc9abfa38cde4a820ecf", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/316322ca7899ed798c89fc9abfa38cde4a820ecf", "committedDate": "2020-08-07T02:32:06Z", "message": "Merge branch 'develop' into optimize-at-tcc-globalCommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4921b3db32c9a7f2bcbedc3b73b1be15b690539b", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/4921b3db32c9a7f2bcbedc3b73b1be15b690539b", "committedDate": "2020-08-07T03:48:27Z", "message": "\u5c0f\u8c03\u6574\u3002"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMDQ5NjUx", "url": "https://github.com/seata/seata/pull/2978#pullrequestreview-463049651", "createdAt": "2020-08-07T05:50:22Z", "commit": {"oid": "4921b3db32c9a7f2bcbedc3b73b1be15b690539b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNTo1MDoyMlrOG9NU3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNTo1MDoyMlrOG9NU3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjgzNDY1Mw==", "bodyText": "there will be a ConcurrentModificationException\uff0cIterators should be used", "url": "https://github.com/seata/seata/pull/2978#discussion_r466834653", "createdAt": "2020-08-07T05:50:22Z", "author": {"login": "a364176773"}, "path": "server/src/main/java/io/seata/server/session/GlobalSession.java", "diffHunk": "@@ -106,15 +109,54 @@ public boolean remove(BranchSession branchSession) {\n      *\n      * @return the boolean\n      */\n+    @Override\n     public boolean canBeCommittedAsync() {\n         for (BranchSession branchSession : branchSessions) {\n-            if (branchSession.getBranchType() == BranchType.TCC || branchSession.getBranchType() == BranchType.XA) {\n+            if (!branchSession.canBeCommittedAsync()) {\n                 return false;\n             }\n         }\n         return true;\n     }\n \n+    /**\n+     * Take out branch sessions that can be committed async.\n+     *\n+     * @return the branch sessions that can be committed async\n+     */\n+    public ArrayList<BranchSession> takeOutBranchSessionsCanBeCommittedAsync() {\n+        ArrayList<BranchSession> branchSessionsCanBeCommittedAsync = new ArrayList<>();\n+\n+        BranchSession branchSession;\n+        for (int i = 0; i < branchSessions.size(); i++) {\n+            branchSession = branchSessions.get(i);\n+            if (branchSession.getBranchType() == BranchType.AT) {\n+                branchSessions.remove(i);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4921b3db32c9a7f2bcbedc3b73b1be15b690539b"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "238fa7516b6045285838d7faf07eb918a4ea437b", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/238fa7516b6045285838d7faf07eb918a4ea437b", "committedDate": "2020-08-07T06:03:37Z", "message": "for+remove\uff0c\u6539\u4e3aiter+remove"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMDU3MTE1", "url": "https://github.com/seata/seata/pull/2978#pullrequestreview-463057115", "createdAt": "2020-08-07T06:11:32Z", "commit": {"oid": "4921b3db32c9a7f2bcbedc3b73b1be15b690539b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMDcwOTYx", "url": "https://github.com/seata/seata/pull/2978#pullrequestreview-463070961", "createdAt": "2020-08-07T06:44:47Z", "commit": {"oid": "238fa7516b6045285838d7faf07eb918a4ea437b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMDkwMjk3", "url": "https://github.com/seata/seata/pull/2978#pullrequestreview-463090297", "createdAt": "2020-08-07T07:23:58Z", "commit": {"oid": "238fa7516b6045285838d7faf07eb918a4ea437b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNzoyMzo1OFrOG9PWlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwNzoyMzo1OFrOG9PWlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg2Nzg2MQ==", "bodyText": "branchSessionsCanBeCommittedAsync   -> branchSessions \uff1f", "url": "https://github.com/seata/seata/pull/2978#discussion_r466867861", "createdAt": "2020-08-07T07:23:58Z", "author": {"login": "slievrly"}, "path": "server/src/main/java/io/seata/server/session/GlobalSession.java", "diffHunk": "@@ -106,15 +110,54 @@ public boolean remove(BranchSession branchSession) {\n      *\n      * @return the boolean\n      */\n+    @Override\n     public boolean canBeCommittedAsync() {\n         for (BranchSession branchSession : branchSessions) {\n-            if (branchSession.getBranchType() == BranchType.TCC || branchSession.getBranchType() == BranchType.XA) {\n+            if (!branchSession.canBeCommittedAsync()) {\n                 return false;\n             }\n         }\n         return true;\n     }\n \n+    /**\n+     * Take out branch sessions that can be committed async.\n+     *\n+     * @return the branch sessions that can be committed async\n+     */\n+    public ArrayList<BranchSession> takeOutBranchSessionsCanBeCommittedAsync() {\n+        ArrayList<BranchSession> branchSessionsCanBeCommittedAsync = new ArrayList<>();\n+\n+        BranchSession branchSession;\n+        Iterator<BranchSession> iter = branchSessions.iterator();\n+        while (iter.hasNext()) {\n+            branchSession = iter.next();\n+            if (branchSession.getBranchType() == BranchType.AT) {\n+                iter.remove();\n+                branchSessionsCanBeCommittedAsync.add(branchSession);\n+            }\n+        }\n+\n+        if (branchSessionsCanBeCommittedAsync.size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "238fa7516b6045285838d7faf07eb918a4ea437b"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f8057f7eeefe5d33967e2213a948b967540f6c7", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/7f8057f7eeefe5d33967e2213a948b967540f6c7", "committedDate": "2020-08-07T08:17:45Z", "message": "\u4ee3\u7801\u91cd\u6784\u3002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f71ed68e3a692219d6abe70b08b603d137509c1", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/8f71ed68e3a692219d6abe70b08b603d137509c1", "committedDate": "2020-08-07T11:18:32Z", "message": "fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38b1019e714ddac8b5f7d23294b12fc54f92a434", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/38b1019e714ddac8b5f7d23294b12fc54f92a434", "committedDate": "2020-08-07T11:38:41Z", "message": "bug\u4fee\u590d\u3002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75c47c589ac04bd4471648f7df46963855315b23", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/75c47c589ac04bd4471648f7df46963855315b23", "committedDate": "2020-08-07T11:41:05Z", "message": "bug\u4fee\u590d\u3002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc4a4994d4bed6b989b046eddde3c59f68e8b77e", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/dc4a4994d4bed6b989b046eddde3c59f68e8b77e", "committedDate": "2020-08-10T03:24:47Z", "message": "\u4f18\u5316\u5f02\u6b65\u63d0\u4ea4\u7684\u903b\u8f91\u3002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a9cd1f2e5483e514727e56a397176bf61c1bd2f", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/5a9cd1f2e5483e514727e56a397176bf61c1bd2f", "committedDate": "2020-08-10T03:30:00Z", "message": "\u5c0f\u8c03\u6574\u3002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95f3b7b89b6f6ad416706dc7080271ae85d1e078", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/95f3b7b89b6f6ad416706dc7080271ae85d1e078", "committedDate": "2020-08-10T03:48:37Z", "message": "\u6d4b\u8bd5\u7528\u4f8b\u8c03\u6574\u3002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de337ecd7530569200d694f0fb8c958e8a591a03", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/de337ecd7530569200d694f0fb8c958e8a591a03", "committedDate": "2020-08-10T04:56:59Z", "message": "\u6d4b\u8bd5\u7528\u4f8b\u8c03\u6574\u3002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e2166261d1c02cedd06efb295777627d1656b74", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/3e2166261d1c02cedd06efb295777627d1656b74", "committedDate": "2020-08-10T05:42:01Z", "message": "\u6d4b\u8bd5\u7528\u4f8b\u8c03\u6574\u3002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a461a1687df6de9b82193ad0cee9fd5097ce5f5a", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/a461a1687df6de9b82193ad0cee9fd5097ce5f5a", "committedDate": "2020-08-11T05:21:38Z", "message": "\u6821\u9a8c\u662f\u5426\u5141\u8bb8\u5f02\u6b65\u63d0\u4ea4\u7684\u65b9\u6cd5\u8c03\u6574\uff0c\u6dfb\u52a0\u4e00\u9636\u6bb5\u5931\u8d25\u7684\u5206\u652f\u3002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ea57ad1a7b2f9a23fa14dacc4d11694f4d0539b", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/7ea57ad1a7b2f9a23fa14dacc4d11694f4d0539b", "committedDate": "2020-08-12T00:39:22Z", "message": "\u79fb\u9664\u63a5\u53e3AsyncableCommitted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcbc0f1e1a7923b7e984cafca3a5002366c04b3a", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/dcbc0f1e1a7923b7e984cafca3a5002366c04b3a", "committedDate": "2020-08-13T01:32:08Z", "message": "Merge branch 'develop' into optimize-at-tcc-globalCommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2037be1a9174f69a15cf34a599084cf41f03f2da", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/2037be1a9174f69a15cf34a599084cf41f03f2da", "committedDate": "2020-08-18T04:00:16Z", "message": "Merge branch 'develop' into optimize-at-tcc-globalCommit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MDQ4ODA2", "url": "https://github.com/seata/seata/pull/2978#pullrequestreview-469048806", "createdAt": "2020-08-18T07:12:18Z", "commit": {"oid": "2037be1a9174f69a15cf34a599084cf41f03f2da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3600, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}