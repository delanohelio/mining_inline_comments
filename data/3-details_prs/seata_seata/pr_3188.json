{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMzAxOTU3", "number": 3188, "title": "optimize: Local variable 'map' is redundant and check queue offer return value", "bodyText": "\u2160. Describe what this PR did\n\n  \n    \n      seata/core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java\n    \n    \n         Line 156\n      in\n      6c0c759\n    \n    \n    \n    \n\n        \n          \n           BlockingQueue<RpcMessage> basket = map.get(serverAddress); \n        \n    \n  \n\n\n// put message into basketMap\nConcurrentHashMap<String, BlockingQueue> map = basketMap;\nBlockingQueue basket = map.get(serverAddress);\nif (basket == null) {\nmap.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\nbasket = map.get(serverAddress);\n}\nbasket.offer(rpcMessage);\n1.remove redundant local variable 'map';\n2.check the BlockingQueue offer return value;\n\u2161. Does this pull request fix one issue?\n\nfixes #3187\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-10-13T13:18:40Z", "url": "https://github.com/seata/seata/pull/3188", "merged": true, "mergeCommit": {"oid": "69f341a7cdb8163724c154ee18814c98aec85cd3"}, "closed": true, "closedAt": "2020-11-11T02:05:14Z", "author": {"login": "everyhook1"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNi8grgH2gAyNTAyMzAxOTU3OjhjN2U1YjYyNTBkZGE1YmU2N2ZhOTNkOTk4NWFjOWVkZDViMzc5MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbT_LwAH2gAyNTAyMzAxOTU3OjYwMDZhOWM4MDU1ZTZjNDM1NmViNzVhZDNkYzI3MjRlNmVmMDA0M2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8c7e5b6250dda5be67fa93d9985ac9edd5b37916", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/8c7e5b6250dda5be67fa93d9985ac9edd5b37916", "committedDate": "2020-09-29T07:21:07Z", "message": "optimize: remove repeated conditional tests (#3161)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc11ac673fba43260a58a394bff7b512bb590145", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/bc11ac673fba43260a58a394bff7b512bb590145", "committedDate": "2020-09-29T07:45:05Z", "message": "optimize: remove repeated conditional tests (#3161)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2d1d5cc140341ab2b30ecb41ac26b645258873f", "author": {"user": {"login": "xingfudeshi", "name": "xingfudeshi"}}, "url": "https://github.com/seata/seata/commit/c2d1d5cc140341ab2b30ecb41ac26b645258873f", "committedDate": "2020-10-01T13:09:15Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "340ffbb9e47c8b133dacb300eeced9171549e4ab", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/340ffbb9e47c8b133dacb300eeced9171549e4ab", "committedDate": "2020-10-13T12:52:56Z", "message": "Merge branch 'develop' of https://github.com/seata/seata into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e45c5f81328160fdd2ac74625d037b5290807809", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/e45c5f81328160fdd2ac74625d037b5290807809", "committedDate": "2020-10-13T13:12:09Z", "message": "optimize: Local variable 'map' is redundant and check queue offer return value #3187"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDkyNDQz", "url": "https://github.com/seata/seata/pull/3188#pullrequestreview-507492443", "createdAt": "2020-10-13T14:23:47Z", "commit": {"oid": "e45c5f81328160fdd2ac74625d037b5290807809"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDoyMzo0OFrOHgpbTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDozMDoxN1rOHgpv8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NTIxMw==", "bodyText": "if(LOGGER.isErrorEnabled()){\nLOGGER.error(\"put message into basketMap offer failed, serverAddress:{},rpcMessage:{}\", serverAddress,\nrpcMessage);\n}", "url": "https://github.com/seata/seata/pull/3188#discussion_r503995213", "createdAt": "2020-10-13T14:23:48Z", "author": {"login": "a364176773"}, "path": "core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java", "diffHunk": "@@ -152,13 +152,12 @@ public Object sendSyncRequest(Object msg) throws TimeoutException {\n             futures.put(rpcMessage.getId(), messageFuture);\n \n             // put message into basketMap\n-            ConcurrentHashMap<String, BlockingQueue<RpcMessage>> map = basketMap;\n-            BlockingQueue<RpcMessage> basket = map.get(serverAddress);\n-            if (basket == null) {\n-                map.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n-                basket = map.get(serverAddress);\n+            basketMap.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n+            if (!basketMap.get(serverAddress).offer(rpcMessage)) {\n+                LOGGER.error(\"put message into basketMap offer failed, serverAddress:{},rpcMessage:{}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e45c5f81328160fdd2ac74625d037b5290807809"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAwMDQ5OA==", "bodyText": "basketMap.computeIfAbsent(serverAddress, k -> new LinkedBlockingQueue<>());\nI think it's better that way. what do you think?", "url": "https://github.com/seata/seata/pull/3188#discussion_r504000498", "createdAt": "2020-10-13T14:30:17Z", "author": {"login": "a364176773"}, "path": "core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java", "diffHunk": "@@ -152,13 +152,12 @@ public Object sendSyncRequest(Object msg) throws TimeoutException {\n             futures.put(rpcMessage.getId(), messageFuture);\n \n             // put message into basketMap\n-            ConcurrentHashMap<String, BlockingQueue<RpcMessage>> map = basketMap;\n-            BlockingQueue<RpcMessage> basket = map.get(serverAddress);\n-            if (basket == null) {\n-                map.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n-                basket = map.get(serverAddress);\n+            basketMap.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e45c5f81328160fdd2ac74625d037b5290807809"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fd12fe577b248b1cd9ac05eff9161358fc94eff", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/5fd12fe577b248b1cd9ac05eff9161358fc94eff", "committedDate": "2020-10-14T02:32:07Z", "message": "optimize: Local variable 'map' is redundant and check queue offer return value #3187"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8256383b6bca79c024b723a4ea52735cb6430c46", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/8256383b6bca79c024b723a4ea52735cb6430c46", "committedDate": "2020-10-14T02:33:28Z", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:\n  optimize: Local variable 'map' is redundant and check queue offer return value #3187"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3OTUzMDEx", "url": "https://github.com/seata/seata/pull/3188#pullrequestreview-507953011", "createdAt": "2020-10-14T02:35:52Z", "commit": {"oid": "8256383b6bca79c024b723a4ea52735cb6430c46"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMjozNTo1MlrOHg__tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMjozNTo1MlrOHg__tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM2NDk4Mw==", "bodyText": "do not need to get again\nBlockingQueue<RpcMessage> basket = basketMap.computeIfAbsent(serverAddress, k -> new LinkedBlockingQueue<>());\nif (!basket .offer(rpcMessage)) {\n    ......\n}", "url": "https://github.com/seata/seata/pull/3188#discussion_r504364983", "createdAt": "2020-10-14T02:35:52Z", "author": {"login": "wangliang181230"}, "path": "core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java", "diffHunk": "@@ -152,13 +152,14 @@ public Object sendSyncRequest(Object msg) throws TimeoutException {\n             futures.put(rpcMessage.getId(), messageFuture);\n \n             // put message into basketMap\n-            ConcurrentHashMap<String, BlockingQueue<RpcMessage>> map = basketMap;\n-            BlockingQueue<RpcMessage> basket = map.get(serverAddress);\n-            if (basket == null) {\n-                map.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n-                basket = map.get(serverAddress);\n+            basketMap.computeIfAbsent(serverAddress, k -> new LinkedBlockingQueue<>());\n+            if (!basketMap.get(serverAddress).offer(rpcMessage)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8256383b6bca79c024b723a4ea52735cb6430c46"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3OTUzNzky", "url": "https://github.com/seata/seata/pull/3188#pullrequestreview-507953792", "createdAt": "2020-10-14T02:38:25Z", "commit": {"oid": "8256383b6bca79c024b723a4ea52735cb6430c46"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMjozODoyNVrOHhACQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMjozODoyNVrOHhACQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM2NTYzNQ==", "bodyText": "not need check if is error log.", "url": "https://github.com/seata/seata/pull/3188#discussion_r504365635", "createdAt": "2020-10-14T02:38:25Z", "author": {"login": "wangliang181230"}, "path": "core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java", "diffHunk": "@@ -152,13 +152,14 @@ public Object sendSyncRequest(Object msg) throws TimeoutException {\n             futures.put(rpcMessage.getId(), messageFuture);\n \n             // put message into basketMap\n-            ConcurrentHashMap<String, BlockingQueue<RpcMessage>> map = basketMap;\n-            BlockingQueue<RpcMessage> basket = map.get(serverAddress);\n-            if (basket == null) {\n-                map.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n-                basket = map.get(serverAddress);\n+            basketMap.computeIfAbsent(serverAddress, k -> new LinkedBlockingQueue<>());\n+            if (!basketMap.get(serverAddress).offer(rpcMessage)) {\n+                if(LOGGER.isErrorEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8256383b6bca79c024b723a4ea52735cb6430c46"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17aa810cf4b463bf906ffa9496c1d22d378e7601", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/17aa810cf4b463bf906ffa9496c1d22d378e7601", "committedDate": "2020-10-14T03:02:40Z", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:\n  optimize: Local variable 'map' is redundant and check queue offer return value #3187"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a90a013757ca31098d3e6a6e0ada727deb707fb3", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/a90a013757ca31098d3e6a6e0ada727deb707fb3", "committedDate": "2020-10-14T03:08:59Z", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3OTYzNTc1", "url": "https://github.com/seata/seata/pull/3188#pullrequestreview-507963575", "createdAt": "2020-10-14T03:10:52Z", "commit": {"oid": "a90a013757ca31098d3e6a6e0ada727deb707fb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMzoxMDo1MlrOHhAjZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMzoxMDo1MlrOHhAjZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM3NDExOQ==", "bodyText": "lost the !, and error log", "url": "https://github.com/seata/seata/pull/3188#discussion_r504374119", "createdAt": "2020-10-14T03:10:52Z", "author": {"login": "wangliang181230"}, "path": "core/src/main/java/io/seata/core/rpc/netty/AbstractNettyRemotingClient.java", "diffHunk": "@@ -152,13 +152,10 @@ public Object sendSyncRequest(Object msg) throws TimeoutException {\n             futures.put(rpcMessage.getId(), messageFuture);\n \n             // put message into basketMap\n-            ConcurrentHashMap<String, BlockingQueue<RpcMessage>> map = basketMap;\n-            BlockingQueue<RpcMessage> basket = map.get(serverAddress);\n-            if (basket == null) {\n-                map.putIfAbsent(serverAddress, new LinkedBlockingQueue<>());\n-                basket = map.get(serverAddress);\n+            BlockingQueue<RpcMessage> basket = basketMap.computeIfAbsent(serverAddress, k -> new LinkedBlockingQueue<>());\n+            if (basket.offer(rpcMessage)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a90a013757ca31098d3e6a6e0ada727deb707fb3"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c8e4ede67b65db6bd60e99f1a09be5068608ca7", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/8c8e4ede67b65db6bd60e99f1a09be5068608ca7", "committedDate": "2020-10-14T03:23:51Z", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0da324ca26f501999cfc202fc27c6eb82adf844", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/b0da324ca26f501999cfc202fc27c6eb82adf844", "committedDate": "2020-10-14T03:24:31Z", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70902c7ea5ef4568c7b20b8fd58d7b83c6e39c86", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/70902c7ea5ef4568c7b20b8fd58d7b83c6e39c86", "committedDate": "2020-10-14T05:29:12Z", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4528430fadacd781a3b19ebf50df4432912619d1", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/4528430fadacd781a3b19ebf50df4432912619d1", "committedDate": "2020-10-14T05:29:52Z", "message": "Merge remote-tracking branch 'origin/develop' into develop\n\n* origin/develop:"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bee315735d7bf80a6cd3b037b411502b7ce83090", "author": {"user": {"login": "everyhook1", "name": "lin"}}, "url": "https://github.com/seata/seata/commit/bee315735d7bf80a6cd3b037b411502b7ce83090", "committedDate": "2020-10-14T08:10:19Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c59eb9b39db254b5e490e1402b26ada0d35bf41b", "author": {"user": {"login": "everyhook1", "name": "lin"}}, "url": "https://github.com/seata/seata/commit/c59eb9b39db254b5e490e1402b26ada0d35bf41b", "committedDate": "2020-10-15T02:25:47Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6308ca4a1a11599fa5789e4f45e1d67ee808f93", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/d6308ca4a1a11599fa5789e4f45e1d67ee808f93", "committedDate": "2020-10-15T02:27:07Z", "message": "Merge remote-tracking branch 'origin/develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NDkzMjIx", "url": "https://github.com/seata/seata/pull/3188#pullrequestreview-509493221", "createdAt": "2020-10-15T15:15:28Z", "commit": {"oid": "d6308ca4a1a11599fa5789e4f45e1d67ee808f93"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMzExNDk2", "url": "https://github.com/seata/seata/pull/3188#pullrequestreview-512311496", "createdAt": "2020-10-20T03:50:19Z", "commit": {"oid": "d6308ca4a1a11599fa5789e4f45e1d67ee808f93"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4220600437d629ae82c457e415916e6614a534b4", "author": {"user": {"login": "wangliang181230", "name": "WangLiang/\u738b\u826f"}}, "url": "https://github.com/seata/seata/commit/4220600437d629ae82c457e415916e6614a534b4", "committedDate": "2020-10-20T06:07:55Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "373c47d74457bb533c4c97913e6d151a5e00365e", "author": {"user": {"login": "everyhook1", "name": "lin"}}, "url": "https://github.com/seata/seata/commit/373c47d74457bb533c4c97913e6d151a5e00365e", "committedDate": "2020-10-20T15:56:50Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e57d05a44fc11b8c6d60279994d01e00c73cac3", "author": {"user": null}, "url": "https://github.com/seata/seata/commit/2e57d05a44fc11b8c6d60279994d01e00c73cac3", "committedDate": "2020-10-21T11:28:28Z", "message": "Merge branch 'develop' of https://github.com/seata/seata into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6006a9c8055e6c4356eb75ad3dc2724e6ef0043f", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/6006a9c8055e6c4356eb75ad3dc2724e6ef0043f", "committedDate": "2020-11-11T01:50:24Z", "message": "Merge branch 'develop' into develop"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3702, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}