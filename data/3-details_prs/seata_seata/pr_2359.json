{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MTAxMzk4", "number": 2359, "title": "feature: support propagation.never, propagation.mandatory, transaction suspend and resume api", "bodyText": "\u2160. Describe what this PR did\n1.add propagation about:never,mandatory\uff1b\n2.optimize the transationTemplate code\uff1b\n\u2161. Does this pull request fix one issue?\n\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-03-05T06:59:49Z", "url": "https://github.com/seata/seata/pull/2359", "merged": true, "mergeCommit": {"oid": "7b796c3bbb6d255a0a6228116eda014e2904c4a4"}, "closed": true, "closedAt": "2020-03-20T07:07:27Z", "author": {"login": "lightClouds917"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKl3BvgH2gAyMzg0MTAxMzk4OjA2YTJlYTVkZDFhZjg4NDMwZDc3MTcxNGZhNzJhZWE1OTc4YjdlN2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPa8lRgFqTM3ODI2MTU4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "06a2ea5dd1af88430d771714fa72aea5978b7e7c", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/06a2ea5dd1af88430d771714fa72aea5978b7e7c", "committedDate": "2020-03-05T06:51:55Z", "message": "feature:add propagation about:never,mandatory,and optimize the transationTemplate code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6099506a0adf1d276cf614424f295a7929281866", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/6099506a0adf1d276cf614424f295a7929281866", "committedDate": "2020-03-05T06:53:54Z", "message": "feature:add propagation about:never,mandatory,and optimize the transationTemplate code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a45d625edd4b708f1a45c5959df831549386dcb", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/1a45d625edd4b708f1a45c5959df831549386dcb", "committedDate": "2020-03-06T02:07:11Z", "message": "Merge branch 'develop' of github.com:seata/seata into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "058a95068d5203fa484a821c1b8d46e4337fe20b", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/058a95068d5203fa484a821c1b8d46e4337fe20b", "committedDate": "2020-03-06T02:52:07Z", "message": "fix:format the code style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzUzNjE0", "url": "https://github.com/seata/seata/pull/2359#pullrequestreview-370353614", "createdAt": "2020-03-06T14:19:21Z", "commit": {"oid": "058a95068d5203fa484a821c1b8d46e4337fe20b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNDoxOToyMVrOFy6Q0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNDoyMzoxNFrOFy6ZMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyNzY5Ng==", "bodyText": "StringUtils.isEmpty(RootContext.getXID()) has returned boolean, can use notEmpty", "url": "https://github.com/seata/seata/pull/2359#discussion_r388927696", "createdAt": "2020-03-06T14:19:21Z", "author": {"login": "zjinlei"}, "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -103,13 +114,43 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n                 cleanUp();\n             }\n         } finally {\n-            if (previousXid != null) {\n-                RootContext.bind(previousXid);\n-            }\n+            resume(suspendedXid);\n         }\n \n     }\n \n+    private boolean existingTransaction() {\n+        return StringUtils.isEmpty(RootContext.getXID()) ? false : true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "058a95068d5203fa484a821c1b8d46e4337fe20b"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyOTg0Mg==", "bodyText": "StringUtils.isEmpty(RootContext.getXID()) has returned boolean, can use notEmpty", "url": "https://github.com/seata/seata/pull/2359#discussion_r388929842", "createdAt": "2020-03-06T14:23:14Z", "author": {"login": "zjinlei"}, "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -103,13 +114,43 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n                 cleanUp();\n             }\n         } finally {\n-            if (previousXid != null) {\n-                RootContext.bind(previousXid);\n-            }\n+            resume(suspendedXid);\n         }\n \n     }\n \n+    private boolean existingTransaction() {\n+        return StringUtils.isEmpty(RootContext.getXID()) ? false : true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "058a95068d5203fa484a821c1b8d46e4337fe20b"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzU3MzU5", "url": "https://github.com/seata/seata/pull/2359#pullrequestreview-370357359", "createdAt": "2020-03-06T14:24:26Z", "commit": {"oid": "058a95068d5203fa484a821c1b8d46e4337fe20b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0492e91529185544f489084ba55f2e23eb253879", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/0492e91529185544f489084ba55f2e23eb253879", "committedDate": "2020-03-09T07:38:23Z", "message": "Merge branch 'develop' of github.com:seata/seata into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cafe21088a46fb0576648ddc7dfd66f539a6080", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/7cafe21088a46fb0576648ddc7dfd66f539a6080", "committedDate": "2020-03-10T05:43:33Z", "message": "optimize:replace magic number of date at the UUIDGenerator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81a90dad302a36ad15b4aa35b7fb3964d7c4c96c", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/81a90dad302a36ad15b4aa35b7fb3964d7c4c96c", "committedDate": "2020-03-10T07:08:34Z", "message": "Merge branch 'develop' of github.com:seata/seata into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "082e84a30d3356f6b6f505439b20af81e26d15ee", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/082e84a30d3356f6b6f505439b20af81e26d15ee", "committedDate": "2020-03-10T07:12:20Z", "message": "revert:revert the optimize:replace magic number of date at the UUIDGenerator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNTM1ODYy", "url": "https://github.com/seata/seata/pull/2359#pullrequestreview-372535862", "createdAt": "2020-03-11T07:56:44Z", "commit": {"oid": "082e84a30d3356f6b6f505439b20af81e26d15ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08a7ae65bdef1d8d3837e4744cd941779712a189", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/08a7ae65bdef1d8d3837e4744cd941779712a189", "committedDate": "2020-03-11T09:44:50Z", "message": "Merge branch 'develop' of github.com:seata/seata into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1453a17542a43ea623802335bf3ab86961ad7674", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/1453a17542a43ea623802335bf3ab86961ad7674", "committedDate": "2020-03-12T05:30:43Z", "message": "optimize:opitmize the code and add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a973b977263ecab3abcd5a88da523c3e2fde900e", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/a973b977263ecab3abcd5a88da523c3e2fde900e", "committedDate": "2020-03-13T04:25:59Z", "message": "optimize:add SuspendResourceHolder to hold the suspend resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22b8b072fbf00b66dd776880049a832f2d88180f", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/22b8b072fbf00b66dd776880049a832f2d88180f", "committedDate": "2020-03-13T04:26:29Z", "message": "Merge branch 'develop' of github.com:seata/seata into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eec785a5d9d6bdb537dcec53e9b5bf31e3e6d9f5", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/eec785a5d9d6bdb537dcec53e9b5bf31e3e6d9f5", "committedDate": "2020-03-13T05:29:38Z", "message": "optimize:update the exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6fad769ce880ef5c830e131efd8c47f1a4bb827", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/a6fad769ce880ef5c830e131efd8c47f1a4bb827", "committedDate": "2020-03-13T05:50:13Z", "message": "remove:remove the unuse import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2f9b0780a32ecb164c834b4894700ef7cb2a147", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/c2f9b0780a32ecb164c834b4894700ef7cb2a147", "committedDate": "2020-03-13T07:01:04Z", "message": "fix:fix the branchType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c90630c02683ac7d130a651e6afbb2c0b6fb53eb", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/c90630c02683ac7d130a651e6afbb2c0b6fb53eb", "committedDate": "2020-03-16T05:45:56Z", "message": "optimize:remove the branchType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d9c7a0307c6de79e02541232bb8f9ed5e12c853", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/1d9c7a0307c6de79e02541232bb8f9ed5e12c853", "committedDate": "2020-03-16T06:09:13Z", "message": "Merge branch 'develop' of github.com:seata/seata into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTA0OTMz", "url": "https://github.com/seata/seata/pull/2359#pullrequestreview-376504933", "createdAt": "2020-03-18T01:17:31Z", "commit": {"oid": "c90630c02683ac7d130a651e6afbb2c0b6fb53eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "529fa462e54a992ec3bf817bf1213fe006729795", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/529fa462e54a992ec3bf817bf1213fe006729795", "committedDate": "2020-03-18T05:27:53Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e537934d44a8ce2f39ea6b37f80a0db31430d220", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/e537934d44a8ce2f39ea6b37f80a0db31430d220", "committedDate": "2020-03-20T06:34:45Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MjU2ODUw", "url": "https://github.com/seata/seata/pull/2359#pullrequestreview-378256850", "createdAt": "2020-03-20T06:42:44Z", "commit": {"oid": "529fa462e54a992ec3bf817bf1213fe006729795"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwNjo0MzoxN1rOF5I5hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwNjo0MzoxN1rOF5I5hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1ODk1MA==", "bodyText": "how about print xid here\uff1f", "url": "https://github.com/seata/seata/pull/2359#discussion_r395458950", "createdAt": "2020-03-20T06:43:17Z", "author": {"login": "slievrly"}, "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -52,29 +53,42 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n         if (txInfo == null) {\n             throw new ShouldNeverHappenException(\"transactionInfo does not exist\");\n         }\n+        // 1.1 get or create a transaction\n+        GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();\n+\n+        // 1.2 Handle the Transaction propatation and the branchType\n         Propagation propagation = txInfo.getPropagation();\n-        String previousXid = null;\n+        SuspendedResourcesHolder suspendedResourcesHolder = null;\n         try {\n             switch (propagation) {\n                 case NOT_SUPPORTED:\n-                    previousXid = RootContext.unbind();\n+                    suspendedResourcesHolder = tx.suspend(true);\n                     return business.execute();\n                 case REQUIRES_NEW:\n-                    previousXid = RootContext.unbind();\n+                    suspendedResourcesHolder = tx.suspend(true);\n                     break;\n                 case SUPPORTS:\n-                    if (StringUtils.isEmpty(RootContext.getXID())) {\n+                    if (!existingTransaction()) {\n                         return business.execute();\n                     }\n                     break;\n                 case REQUIRED:\n                     break;\n+                case NEVER:\n+                    if (existingTransaction()) {\n+                        throw new TransactionException(\"Existing transaction found for transaction marked with propagation 'never'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e537934d44a8ce2f39ea6b37f80a0db31430d220"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82ea0886a5bc491efb2f026db47acc2cc3b3181c", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/82ea0886a5bc491efb2f026db47acc2cc3b3181c", "committedDate": "2020-03-20T06:46:17Z", "message": "Merge branch 'develop' of github.com:lightClouds917/seata into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7c245a40ecf8d48818a590c220b58ed6292321b", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/d7c245a40ecf8d48818a590c220b58ed6292321b", "committedDate": "2020-03-20T06:55:40Z", "message": "optimize:print xid for never"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MjYxNTgw", "url": "https://github.com/seata/seata/pull/2359#pullrequestreview-378261580", "createdAt": "2020-03-20T06:58:39Z", "commit": {"oid": "d7c245a40ecf8d48818a590c220b58ed6292321b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4052, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}