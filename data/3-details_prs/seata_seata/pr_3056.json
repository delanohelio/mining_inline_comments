{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMzMwNTgx", "number": 3056, "title": "bugfix:  fixed a bug that after branch deletion, there are still remaining branch lock", "bodyText": "\u2160. Describe what this PR did\n\u4fee\u6539\u4e00\u4e2abug\uff0c \u5f53\u4e8c\u9636\u6bb5\u56de\u6eda\u7684\u65f6\u5019\uff0c\u5220\u9664\u4e86\u5206\u652f\u4e8b\u52a1\u4e4b\u540e\uff0c\u51c6\u5907\u5220\u9664\u5206\u652f\u4e8b\u52a1\u9501\u7684\u65f6\u5019\u7a81\u7136\u7531\u4e8e\u67d0\u4e9b\u539f\u56e0\u9020\u6210\u5220\u9664\u9501\u5931\u8d25\u3002\u90a3\u4e48\u8fd9\u4e2a\u9501\u6570\u636e\u5c06\u4f1a\u4e00\u76f4\u5b58\u5728\uff0c\u9020\u6210\u4e4b\u540e\u7684\u4e8b\u52a1\u65e0\u6cd5\u83b7\u53d6\u6b64\u9501\u3002\nfix a bug, when the branch phase two rollbacked, and the branch info had been delete from the  branch_table. But\nthen delete the branch lock from the table of lock_table, an error occurred which cause the branch lock delete failed.\nThen the branch lock will be always in the table, and cause new transactions could not get this lock.\n\u2161. Does this pull request fix one issue?\nfixes #2976\n\u2162. Why don't you add test cases (unit test/integration test)?\nThis problem occurs only in exceptional cases\uff0c test cases are difficult to write\n\u6b64\u95ee\u9898\u5728\u67d0\u4e9b\u7279\u6b8a\u60c5\u51b5\u4e0b\u624d\u4f1a\u53d1\u751f\uff0c\u7528\u4f8b\u4e0d\u597d\u5199\u3002\n\u2163. Describe how to verify it\nMy test is to manually throw an exception directly in the unlock and delete branch transaction table\u3002\n\u6211\u7684\u6d4b\u8bd5\u65b9\u5f0f\u662f\u5728\u89e3\u9501\u548c\u5220\u9664\u5206\u652f\u4e8b\u52a1\u8868\u76f4\u63a5\u624b\u52a8\u629b\u51fa\u5f02\u5e38\u3002\nbranchSession.unlock();\n// throw an exception\nfor (SessionLifecycleListener lifecycleListener : lifecycleListeners) {\nlifecycleListener.onRemoveBranch(this, branchSession);\n}\n\u2164. Special notes for reviews\n\u95ee\u9898\u53d1\u751f\u7684\u539f\u56e0\u5c31\u662f\u5220\u9664\u4e86\u5206\u652f\u4e8b\u52a1\u8868\uff0c\u4f46\u662f\u9501\u6ca1\u6709\u5220\u6389\u3002\u5982\u679c\u4e24\u4e2a\u90fd\u8fd8\u5728\uff0c\u90a3\u4e48\u91cd\u8bd5\u7684\u65f6\u5019\u4f1a\u901a\u8fc7\u5206\u652f\u4e8b\u52a1\u6570\u636e\u5220\u9664\u8be5\u9501\u3002\u6240\u4ee5\u95ee\u9898\u7684\u5173\u952e\u5728\u4e8e\u9501\u9700\u8981\u5148\u4e8e\u5206\u652f\u4e8b\u52a1\u5220\u9664\u3002\n\u56e0\u4e3aGlobalSession.removeBranch()\u4ec5\u53d1\u751f\u5728\u4e8c\u9636\u6bb5\u76f8\u5e94\u7684\u5206\u652f\u5df2\u7ecf\u5b8c\u6210seata-server\u7684\u56de\u6eda\u548c\u54cd\u5e94\u8bf7\u6c42\u4e4b\u540e\u3002\u4e5f\u5c31\u662f\u8bf4\u6b64\u65f6RM\u7684\u76f8\u5e94\u64cd\u4f5c\u5df2\u7ecf\u5b8c\u6210\uff0c\u6bd4\u5982\u5220\u9664undoLog\uff0c\u6216\u8005\u8bbe\u7f6eundoLog\u72b6\u6001\u4e3a\u5b8c\u6210\uff0c\u5f02\u5e38\u7b49\u7b49\u3002\u6240\u4ee5RM\u7684\u4efb\u52a1\u5df2\u7ecf\u5b8c\u6210\u4e86\uff0c\u6b64\u65f6\u5df2\u7ecf\u53ef\u4ee5\u5220\u9664\u9501\u4e86\u3002\u6240\u4ee5\u5373\u4f7f\u5728\u5220\u9664\u9501\u540e\u5206\u652f\u4e8b\u52a1\u8868\u8fd8\u5728\uff0c\u4e5f\u6ca1\u6709\u4e8b\u60c5\uff0c\u5f53\u4ed6\u53d1\u8d77\u91cd\u8bd5\u7684\u65f6\u5019\uff0cRM\u5df2\u7ecf\u5b8c\u6210\u4e86\u64cd\u4f5c\uff0c\u4e0d\u4f1a\u91cd\u590d\u518d\u6b21\u6267\u884c\u4e00\u7bc7\u3002", "createdAt": "2020-08-24T07:39:54Z", "url": "https://github.com/seata/seata/pull/3056", "merged": true, "mergeCommit": {"oid": "7b1fcacfb552083eedff1f4ec366edabd55315f5"}, "closed": true, "closedAt": "2020-08-24T10:14:15Z", "author": {"login": "li469791221"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABam1qczAH2gAyNDcyMzMwNTgxOmU5ZTcyNTUwZmRmNTk0NmIwNTVkNWIwODkxNzhiZjMyOTk2NmVlNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdC4gMgAFqTQ3NjM3MzEzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e9e72550fdf5946b055d5b089178bf329966ee6b", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/e9e72550fdf5946b055d5b089178bf329966ee6b", "committedDate": "2019-04-30T08:44:14Z", "message": "release 0.5.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f017c6b875c304f75fe34be37f9d4cf75e2f45f4", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/f017c6b875c304f75fe34be37f9d4cf75e2f45f4", "committedDate": "2019-05-17T10:12:34Z", "message": "release 0.5.2\n\nrelease 0.5.2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ca3332d67c2f0d43ce7d854e6bbb04e48bcae8b", "author": {"user": {"login": "zhangthen", "name": null}}, "url": "https://github.com/seata/seata/commit/7ca3332d67c2f0d43ce7d854e6bbb04e48bcae8b", "committedDate": "2019-05-24T09:47:44Z", "message": "Release 0.6.0 (#1106)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc088cb9551d58acdf343f66166985e8fa8712fd", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/dc088cb9551d58acdf343f66166985e8fa8712fd", "committedDate": "2019-05-27T02:27:47Z", "message": "Revert \"Release 0.6.0 (#1106)\" (#1107)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da96029455843dfd8ace1c085e8a170f05ad659a", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/da96029455843dfd8ace1c085e8a170f05ad659a", "committedDate": "2019-05-27T02:40:28Z", "message": "re-merging 0.6.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca567ef724cc53ef624a42718997853fbdddae54", "author": {"user": {"login": "zhangthen", "name": null}}, "url": "https://github.com/seata/seata/commit/ca567ef724cc53ef624a42718997853fbdddae54", "committedDate": "2019-05-31T07:33:13Z", "message": "Release 0.6.1\n\nRelease 0.6.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b90f935a27a928a8a75e8c11a4687235f1507d9", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/1b90f935a27a928a8a75e8c11a4687235f1507d9", "committedDate": "2019-07-12T07:12:02Z", "message": "release 0.7.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39e4d892ada776f35c78528c85e773dd6ac8f5f1", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/39e4d892ada776f35c78528c85e773dd6ac8f5f1", "committedDate": "2019-07-15T12:01:04Z", "message": "release 0.7.1\n\nrelease 0.7.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09456818ecd6644439366647021b683516225cb3", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/09456818ecd6644439366647021b683516225cb3", "committedDate": "2019-08-16T08:13:03Z", "message": "release 0.8.0\n\nrelease 0.8.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ffa29044209f04c222eab5445c8b01ea6295522", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/9ffa29044209f04c222eab5445c8b01ea6295522", "committedDate": "2019-09-18T09:39:19Z", "message": "release  0.8.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a174ed5594d405ba26706c355327ac0ac8017b27", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/a174ed5594d405ba26706c355327ac0ac8017b27", "committedDate": "2019-10-16T05:38:49Z", "message": "release 0.9.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bdbc44e524263a47aa51a1a2a648b120456ee5b", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/5bdbc44e524263a47aa51a1a2a648b120456ee5b", "committedDate": "2019-12-20T16:59:09Z", "message": "[release] release 1.0.0\n\n[release] release 1.0.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f990a575328504ef4dece32a93383f1debc0d7f2", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/f990a575328504ef4dece32a93383f1debc0d7f2", "committedDate": "2020-02-19T15:13:24Z", "message": "release: release 1.1.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04d0568c0e89fd77c5a8c22a9d39025a0be41051", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/04d0568c0e89fd77c5a8c22a9d39025a0be41051", "committedDate": "2020-04-21T04:40:55Z", "message": "Merge pull request #2582 from seata/1.2.0\n\nrelease 1.2.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e2a4247a82e76d51a56485b46c0d948a0c1ea13", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/2e2a4247a82e76d51a56485b46c0d948a0c1ea13", "committedDate": "2020-07-15T16:28:39Z", "message": "release: release 1.3.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "943c526110c2f049f962ebe4e60bdbc25595839d", "author": {"user": {"login": "li469791221", "name": null}}, "url": "https://github.com/seata/seata/commit/943c526110c2f049f962ebe4e60bdbc25595839d", "committedDate": "2020-08-24T07:13:49Z", "message": "fix issue #2976"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dde7e372ba90b9974328eea2b13e539fafb6a40", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/0dde7e372ba90b9974328eea2b13e539fafb6a40", "committedDate": "2020-08-24T08:09:26Z", "message": "Merge branch 'develop' into dev"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjM4MjY1", "url": "https://github.com/seata/seata/pull/3056#pullrequestreview-473238265", "createdAt": "2020-08-24T08:51:04Z", "commit": {"oid": "0dde7e372ba90b9974328eea2b13e539fafb6a40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwODo1MTowNFrOHFabrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwODo1MTowNFrOHFabrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQzNzk5Ng==", "bodyText": "If it is false, please throw exception, otherwise the problem will still exist.", "url": "https://github.com/seata/seata/pull/3056#discussion_r475437996", "createdAt": "2020-08-24T08:51:04Z", "author": {"login": "wangliang181230"}, "path": "server/src/main/java/io/seata/server/session/GlobalSession.java", "diffHunk": "@@ -246,10 +246,10 @@ public void addBranch(BranchSession branchSession) throws TransactionException {\n \n     @Override\n     public void removeBranch(BranchSession branchSession) throws TransactionException {\n+        branchSession.unlock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dde7e372ba90b9974328eea2b13e539fafb6a40"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cec429486bed78d7737713c12efeec304f73774e", "author": {"user": {"login": "li469791221", "name": null}}, "url": "https://github.com/seata/seata/commit/cec429486bed78d7737713c12efeec304f73774e", "committedDate": "2020-08-24T09:25:20Z", "message": "deal with the unlock failed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjkyNjYy", "url": "https://github.com/seata/seata/pull/3056#pullrequestreview-473292662", "createdAt": "2020-08-24T09:33:29Z", "commit": {"oid": "cec429486bed78d7737713c12efeec304f73774e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjk2ODIw", "url": "https://github.com/seata/seata/pull/3056#pullrequestreview-473296820", "createdAt": "2020-08-24T09:39:36Z", "commit": {"oid": "cec429486bed78d7737713c12efeec304f73774e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzAzNTYy", "url": "https://github.com/seata/seata/pull/3056#pullrequestreview-473303562", "createdAt": "2020-08-24T09:49:15Z", "commit": {"oid": "cec429486bed78d7737713c12efeec304f73774e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOTo0OToxNVrOHFc-Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOTo0OToxNVrOHFc-Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ3OTU4Mg==", "bodyText": "throw TransactionException, not RuntimeException, otherwise, some forEach will break.", "url": "https://github.com/seata/seata/pull/3056#discussion_r475479582", "createdAt": "2020-08-24T09:49:15Z", "author": {"login": "wangliang181230"}, "path": "server/src/main/java/io/seata/server/session/GlobalSession.java", "diffHunk": "@@ -246,10 +246,12 @@ public void addBranch(BranchSession branchSession) throws TransactionException {\n \n     @Override\n     public void removeBranch(BranchSession branchSession) throws TransactionException {\n+        if (!branchSession.unlock()) {\n+            throw new RuntimeException(\"Unlock branch lock failed!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cec429486bed78d7737713c12efeec304f73774e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b417d35e8a41007bbf262b541bd2d008d966e9e6", "author": {"user": {"login": "li469791221", "name": null}}, "url": "https://github.com/seata/seata/commit/b417d35e8a41007bbf262b541bd2d008d966e9e6", "committedDate": "2020-08-24T09:51:11Z", "message": "throw TransactionException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzExNzUw", "url": "https://github.com/seata/seata/pull/3056#pullrequestreview-473311750", "createdAt": "2020-08-24T10:01:15Z", "commit": {"oid": "cec429486bed78d7737713c12efeec304f73774e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2MzczMTM0", "url": "https://github.com/seata/seata/pull/3056#pullrequestreview-476373134", "createdAt": "2020-08-27T04:14:56Z", "commit": {"oid": "b417d35e8a41007bbf262b541bd2d008d966e9e6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3625, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}