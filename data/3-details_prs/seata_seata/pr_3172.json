{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNDY4NTEx", "number": 3172, "title": "feature: support rollback info compress", "bodyText": "\u2160. Describe what this PR did\nsupport rollback info compress\n\u652f\u6301\u5bf9undo_log\u4e2d\u7684rollback_info\u8fdb\u884c\u538b\u7f29\u5b58\u50a8\n\u987a\u4fbf\u628a OracleUndoLogManager \u548c PostgresqlUndoLogManager \u4e2d\u7684hard code\u7528\u5e38\u91cf\u66ff\u6362\u4e86\n\u2161. Does this pull request fix one issue?\n\nfixes #3159\n\u2162. Why don't you add test cases (unit test/integration test)?\nalready add\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-10-09T09:35:17Z", "url": "https://github.com/seata/seata/pull/3172", "merged": true, "mergeCommit": {"oid": "aeeda4202797a83d950db4c1a31656f60738648f"}, "closed": true, "closedAt": "2020-12-15T05:10:58Z", "author": {"login": "caohdgege"}, "timelineItems": {"totalCount": 52, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN5H1mAH2gAyNTAwNDY4NTExOjkxOTIxMjRhYzEwYzhiZmU2Mjk1YjJiZmJjNDI2NDJhMDJhZDQ5Zjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmS5VCAH2gAyNTAwNDY4NTExOmZjZDUxNjI3OTY2NzkwODAzMWYwYjQ4MTM1MTlkNTk0NGQ4ZDJhMGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9192124ac10c8bfe6295b2bfbc42642a02ad49f8", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/9192124ac10c8bfe6295b2bfbc42642a02ad49f8", "committedDate": "2020-09-30T09:11:24Z", "message": "support compress for undo log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a1ef280e9e02450a69d0747066ba78f331e1e5e", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/9a1ef280e9e02450a69d0747066ba78f331e1e5e", "committedDate": "2020-09-30T09:29:38Z", "message": "add spring properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d06cecf480f9a7311cf5e490837032f47668a049", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/d06cecf480f9a7311cf5e490837032f47668a049", "committedDate": "2020-09-30T10:40:13Z", "message": "fix: read config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4463efb0aaf5eb95b385535c35bc6afff7879691", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/4463efb0aaf5eb95b385535c35bc6afff7879691", "committedDate": "2020-09-30T14:12:03Z", "message": "use exists compressor type enum"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed6518e9000a3afcf924133223fd0c5b2b91ad10", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/ed6518e9000a3afcf924133223fd0c5b2b91ad10", "committedDate": "2020-09-30T16:22:28Z", "message": "fix: test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "357b1bf12bed13bc3e6d25e2c228bcd6af21d1b2", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/357b1bf12bed13bc3e6d25e2c228bcd6af21d1b2", "committedDate": "2020-10-01T12:48:29Z", "message": "optimize: del useless log & optimize default val"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d52b732b424e87a36f94c011760cb5f5d5cda8a8", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/d52b732b424e87a36f94c011760cb5f5d5cda8a8", "committedDate": "2020-10-01T13:50:33Z", "message": "optimize: import && test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3410cd784ed66bfd8753860979381fc2eb15053", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/e3410cd784ed66bfd8753860979381fc2eb15053", "committedDate": "2020-10-01T15:30:36Z", "message": "optimize: code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4805b73c1f17ca2f74db3bfcca2a54244f9b1dab", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/4805b73c1f17ca2f74db3bfcca2a54244f9b1dab", "committedDate": "2020-10-09T09:30:27Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e70ac00a3095076d6675c1a9ddb7a053e53684b6", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/e70ac00a3095076d6675c1a9ddb7a053e53684b6", "committedDate": "2020-10-09T09:32:00Z", "message": "example"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15b3f19ec7f070f0436989f8ba8602a18b46fee0", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/15b3f19ec7f070f0436989f8ba8602a18b46fee0", "committedDate": "2020-10-09T09:39:27Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NTMwODkx", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-505530891", "createdAt": "2020-10-09T09:58:13Z", "commit": {"oid": "15b3f19ec7f070f0436989f8ba8602a18b46fee0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwOTo1ODoxM1rOHfDOLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTozNToxNFrOHfcJUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMyMDY4NQ==", "bodyText": "why is 1024 not a constant", "url": "https://github.com/seata/seata/pull/3172#discussion_r502320685", "createdAt": "2020-10-09T09:58:13Z", "author": {"login": "a364176773"}, "path": "common/src/main/java/io/seata/common/util/SizeUtil.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.common.util;\n+\n+/**\n+ * @author chd\n+ */\n+public class SizeUtil {\n+    /**\n+     * case size to byte length\n+     * example:\n+     *   2k => 2 * 1024\n+     *   2m => 2 * 1024 * 1024\n+     *   2g => 2 * 1024 * 1024 * 1024\n+     *   2t => 2 * 1024 * 1024 * 1024 * 1024\n+     * @param size the string size with unit\n+     * @return the byte length\n+     */\n+    public static long size2Long(String size) {\n+        if (null == size || size.length() <= 1) {\n+            throw new IllegalArgumentException(\"could not convert '\" + size + \"' to byte length\");\n+        }\n+\n+        String size2Lower = size.toLowerCase();\n+        char unit = size2Lower.charAt(size.length() - 1);\n+        long number;\n+        try {\n+            number = NumberUtils.toLong(size2Lower.substring(0, size.length() - 1));\n+        } catch (NumberFormatException | NullPointerException ex) {\n+            throw new IllegalArgumentException(\"could not convert '\" + size + \"' to byte length\");\n+        }\n+\n+        switch (unit) {\n+            case 'k':\n+                return number * 1024;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15b3f19ec7f070f0436989f8ba8602a18b46fee0"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcyOTA0Mw==", "bodyText": "Why not reduce the number of duplicate lines of code by putting decompression into AbstractUndoLogManager?", "url": "https://github.com/seata/seata/pull/3172#discussion_r502729043", "createdAt": "2020-10-10T01:35:14Z", "author": {"login": "a364176773"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/undo/oracle/OracleUndoLogManager.java", "diffHunk": "@@ -67,34 +73,37 @@ public int deleteUndoLogByLogCreated(Date logCreated, int limitRows, Connection\n     }\n \n     @Override\n-    protected void insertUndoLogWithNormal(String xid, long branchId, String rollbackCtx,\n-                                                byte[] undoLogContent, Connection conn) throws SQLException {\n-        insertUndoLog(xid, branchId,rollbackCtx, undoLogContent, State.Normal, conn);\n+    protected void insertUndoLogWithNormal(String xid, long branchId, String rollbackCtx, byte[] undoLogContent,\n+                                           CompressorType compressType, Connection conn) throws SQLException {\n+        insertUndoLog(xid, branchId,rollbackCtx, undoLogContent, compressType, State.Normal, conn);\n     }\n \n     @Override\n     protected byte[] getRollbackInfo(ResultSet rs) throws SQLException {\n         Blob b = rs.getBlob(ClientTableColumnsName.UNDO_LOG_ROLLBACK_INFO);\n         byte[] rollbackInfo = BlobUtils.blob2Bytes(b);\n-        return rollbackInfo;\n+        CompressorType compressType = CompressorType.getByCode(rs.getInt(ClientTableColumnsName.UNDO_LOG_COMPRESS_TYPE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15b3f19ec7f070f0436989f8ba8602a18b46fee0"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDUzNTA4", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-506053508", "createdAt": "2020-10-10T01:40:41Z", "commit": {"oid": "15b3f19ec7f070f0436989f8ba8602a18b46fee0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTo0MDo0MlrOHfcLyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTo0MDo0MlrOHfcLyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcyOTY3NQ==", "bodyText": "\u5e94\u8be5\u8865\u5145\u5230script\u6587\u4ef6\u5939\u4e0b\u7684client\u4e2d\u7684conf\u91cc\u7684file.conf\u6587\u4ef6", "url": "https://github.com/seata/seata/pull/3172#discussion_r502729675", "createdAt": "2020-10-10T01:40:42Z", "author": {"login": "a364176773"}, "path": "server/src/main/resources/file.conf.example", "diffHunk": "@@ -83,6 +83,14 @@ server {\n     logSaveDays = 7\n     #schedule delete expired undo_log in milliseconds\n     logDeletePeriod = 86400000\n+    compress {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15b3f19ec7f070f0436989f8ba8602a18b46fee0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDU1Mjcz", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-506055273", "createdAt": "2020-10-10T01:59:06Z", "commit": {"oid": "15b3f19ec7f070f0436989f8ba8602a18b46fee0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTo1OTowNlrOHfcUJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMTo1OTowNlrOHfcUJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczMTgxMg==", "bodyText": "// -> #", "url": "https://github.com/seata/seata/pull/3172#discussion_r502731812", "createdAt": "2020-10-10T01:59:06Z", "author": {"login": "wangliang181230"}, "path": "server/src/main/resources/file.conf.example", "diffHunk": "@@ -83,6 +83,14 @@ server {\n     logSaveDays = 7\n     #schedule delete expired undo_log in milliseconds\n     logDeletePeriod = 86400000\n+    compress {\n+      enable = true\n+      // allow zip, gzip, 7z, lz4, bzip2, default is zip", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15b3f19ec7f070f0436989f8ba8602a18b46fee0"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDU1NTI1", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-506055525", "createdAt": "2020-10-10T02:01:42Z", "commit": {"oid": "15b3f19ec7f070f0436989f8ba8602a18b46fee0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMjowMTo0M1rOHfcVUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwMjowMTo0M1rOHfcVUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjczMjExNQ==", "bodyText": "Please add optional values for this configuration in hints below. like seata.transport.compressor", "url": "https://github.com/seata/seata/pull/3172#discussion_r502732115", "createdAt": "2020-10-10T02:01:43Z", "author": {"login": "wangliang181230"}, "path": "seata-spring-boot-starter/src/main/resources/META-INF/additional-spring-configuration-metadata.json", "diffHunk": "@@ -150,6 +150,24 @@\n       \"sourceType\": \"io.seata.spring.boot.autoconfigure.properties.client.UndoProperties\",\n       \"defaultValue\": true\n     },\n+    {\n+      \"name\": \"seata.client.undo.compress.enable\",\n+      \"type\": \"java.lang.Boolean\",\n+      \"sourceType\": \"io.seata.spring.boot.autoconfigure.properties.client.UndoCompressProperties\",\n+      \"defaultValue\": true\n+    },\n+    {\n+      \"name\": \"seata.client.undo.compress.type\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15b3f19ec7f070f0436989f8ba8602a18b46fee0"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f270b7da3e5383f43f8d8599325bcce6b38b785", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/7f270b7da3e5383f43f8d8599325bcce6b38b785", "committedDate": "2020-10-10T02:10:58Z", "message": "move conf to script/client/conf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8be721e08d5a3dce6c8d0723def1e1f3eb7f1866", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/8be721e08d5a3dce6c8d0723def1e1f3eb7f1866", "committedDate": "2020-10-10T02:14:20Z", "message": "1024 to a const"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1d64442723e94a1d1ffdc608ccbb9751a5414ef", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/f1d64442723e94a1d1ffdc608ccbb9751a5414ef", "committedDate": "2020-10-10T02:20:51Z", "message": "add default config in config.txt application.properties application.properties template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ab647255fa34d04ef349615cdf1d48795cabf85", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/4ab647255fa34d04ef349615cdf1d48795cabf85", "committedDate": "2020-10-10T02:28:10Z", "message": "add hits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2015c5f7f130c1610f0e5b0fe3d2d6984ece055", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/a2015c5f7f130c1610f0e5b0fe3d2d6984ece055", "committedDate": "2020-10-10T02:30:48Z", "message": "Merge remote-tracking branch 'origin/feature-add-zip-for-rollback-info' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e11ede2dddef3d453a822d4a381196050235d00", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/0e11ede2dddef3d453a822d4a381196050235d00", "committedDate": "2020-10-10T06:29:40Z", "message": "simple code & optimize import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "850a7f10aa136c18806505ea337b4b6e09b9cce5", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/850a7f10aa136c18806505ea337b4b6e09b9cce5", "committedDate": "2020-10-10T06:41:41Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "899c577f6b21d8aa009d092af1954a3daffafc67", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/899c577f6b21d8aa009d092af1954a3daffafc67", "committedDate": "2020-10-10T08:04:23Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efd61b8c2e7cfb16d7c61307d7fac06612008131", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/efd61b8c2e7cfb16d7c61307d7fac06612008131", "committedDate": "2020-10-12T03:31:10Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjcyOTY3", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-506272967", "createdAt": "2020-10-12T03:36:37Z", "commit": {"oid": "899c577f6b21d8aa009d092af1954a3daffafc67"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMzozNjo1N1rOHfuCIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMzo0NToxMFrOHfuINg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAyMjExMw==", "bodyText": "compress_type should be placed in context field.", "url": "https://github.com/seata/seata/pull/3172#discussion_r503022113", "createdAt": "2020-10-12T03:36:57Z", "author": {"login": "jsbxyyx"}, "path": "script/client/at/db/mysql.sql", "diffHunk": "@@ -5,6 +5,7 @@ CREATE TABLE IF NOT EXISTS `undo_log`\n     `xid`           VARCHAR(100) NOT NULL COMMENT 'global transaction id',\n     `context`       VARCHAR(128) NOT NULL COMMENT 'undo_log context,such as serialization',\n     `rollback_info` LONGBLOB     NOT NULL COMMENT 'rollback info',\n+    `compress_type` TINYINT      NOT NULL COMMENT 'compress type',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efd61b8c2e7cfb16d7c61307d7fac06612008131"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAyMzY3MA==", "bodyText": "rollbackInfo needs to determine whether to decompress according to the compression type value in the context.", "url": "https://github.com/seata/seata/pull/3172#discussion_r503023670", "createdAt": "2020-10-12T03:45:10Z", "author": {"login": "jsbxyyx"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/undo/AbstractUndoLogManager.java", "diffHunk": "@@ -392,5 +414,18 @@ protected abstract void insertUndoLogWithNormal(String xid, long branchId, Strin\n      * @return\n      * @throws SQLException\n      */\n-    protected abstract byte[] getRollbackInfo(ResultSet rs) throws SQLException;\n+    protected byte[] getRollbackInfo(ResultSet rs) throws SQLException  {\n+        byte[] rollbackInfo = rs.getBytes(ClientTableColumnsName.UNDO_LOG_ROLLBACK_INFO);\n+        CompressorType compressType = CompressorType.getByCode(rs.getInt(ClientTableColumnsName.UNDO_LOG_COMPRESS_TYPE));\n+        return CompressorFactory.getCompressor(compressType.getCode()).decompress(rollbackInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efd61b8c2e7cfb16d7c61307d7fac06612008131"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2Mjc1MzY4", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-506275368", "createdAt": "2020-10-12T03:47:30Z", "commit": {"oid": "efd61b8c2e7cfb16d7c61307d7fac06612008131"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMzo0NzozMFrOHfuKJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMzo0NzozMFrOHfuKJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAyNDE2NA==", "bodyText": "compressorType placed in context.", "url": "https://github.com/seata/seata/pull/3172#discussion_r503024164", "createdAt": "2020-10-12T03:47:30Z", "author": {"login": "jsbxyyx"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/undo/AbstractUndoLogManager.java", "diffHunk": "@@ -213,11 +228,17 @@ public void flushUndoLogs(ConnectionProxy cp) throws SQLException {\n         UndoLogParser parser = UndoLogParserFactory.getInstance();\n         byte[] undoLogContent = parser.encode(branchUndoLog);\n \n+        CompressorType compressorType = CompressorType.NONE;\n+        if (needCompress(undoLogContent)) {\n+            compressorType = ROLLBACK_INFO_COMPRESS_TYPE;\n+            undoLogContent = CompressorFactory.getCompressor(compressorType.getCode()).compress(undoLogContent);\n+        }\n+\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"Flushing UNDO LOG: {}\", new String(undoLogContent, Constants.DEFAULT_CHARSET));\n         }\n \n-        insertUndoLogWithNormal(xid, branchId, buildContext(parser.getName()), undoLogContent,\n+        insertUndoLogWithNormal(xid, branchId, buildContext(parser.getName()), undoLogContent, compressorType,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efd61b8c2e7cfb16d7c61307d7fac06612008131"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dbdc800b0c9481899b1c434fc78c978525dbe6a", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/3dbdc800b0c9481899b1c434fc78c978525dbe6a", "committedDate": "2020-10-13T03:24:16Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "471a9c7c8870151e4eeef10b1e8996f62acd0e2d", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/471a9c7c8870151e4eeef10b1e8996f62acd0e2d", "committedDate": "2020-10-13T12:55:49Z", "message": "optimize: put compressor type in context but not add new column"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63ca412a61894639dfb253dc963a75f647603d26", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/63ca412a61894639dfb253dc963a75f647603d26", "committedDate": "2020-10-13T13:03:49Z", "message": "Merge remote-tracking branch 'origin/feature-add-zip-for-rollback-info' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c37012d52e2bd12b35754d670b5096ad455c2508", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/c37012d52e2bd12b35754d670b5096ad455c2508", "committedDate": "2020-10-13T13:10:31Z", "message": "fix: test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MDQ2ODEz", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-508046813", "createdAt": "2020-10-14T06:59:40Z", "commit": {"oid": "c37012d52e2bd12b35754d670b5096ad455c2508"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwNjo1OTo0MFrOHhE3Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwNjo1OTo0MFrOHhE3Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ0NDczNQ==", "bodyText": "old version upgrade new version. compressorType may be not exists in database. need to consider?", "url": "https://github.com/seata/seata/pull/3172#discussion_r504444735", "createdAt": "2020-10-14T06:59:40Z", "author": {"login": "jsbxyyx"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/undo/AbstractUndoLogManager.java", "diffHunk": "@@ -392,5 +413,22 @@ protected abstract void insertUndoLogWithNormal(String xid, long branchId, Strin\n      * @return\n      * @throws SQLException\n      */\n-    protected abstract byte[] getRollbackInfo(ResultSet rs) throws SQLException;\n+    protected byte[] getRollbackInfo(ResultSet rs) throws SQLException  {\n+        byte[] rollbackInfo = rs.getBytes(ClientTableColumnsName.UNDO_LOG_ROLLBACK_INFO);\n+\n+        String rollbackInfoContext = rs.getString(ClientTableColumnsName.UNDO_LOG_CONTEXT);\n+        Map<String, String> context = CollectionUtils.decodeMap(rollbackInfoContext);\n+        CompressorType compressorType = CompressorType.getByName(context.get(UndoLogConstants.COMPRESSOR_TYPE_KEY));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c37012d52e2bd12b35754d670b5096ad455c2508"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e871fcf95880d0c62fb62db51d4da089a2c2a561", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/e871fcf95880d0c62fb62db51d4da089a2c2a561", "committedDate": "2020-10-14T07:07:37Z", "message": "modify: get or default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9a1f8c639e45ec0a9e19db648661eb119a6d07b", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/d9a1f8c639e45ec0a9e19db648661eb119a6d07b", "committedDate": "2020-10-14T07:32:39Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e18462a8f52ce2a96471162f47de6aae1ab898b", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/0e18462a8f52ce2a96471162f47de6aae1ab898b", "committedDate": "2020-10-16T10:50:33Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9291370139cc6f8dd04f6f439a221be36a69ee07", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/9291370139cc6f8dd04f6f439a221be36a69ee07", "committedDate": "2020-10-17T11:15:33Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b61f26ecdeb65f1328fd17533fa085854ef2dea0", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/b61f26ecdeb65f1328fd17533fa085854ef2dea0", "committedDate": "2020-10-21T06:34:22Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c113237bf6beca0333c97e12a9aabdd065278fb", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/8c113237bf6beca0333c97e12a9aabdd065278fb", "committedDate": "2020-10-28T09:46:08Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3efc32e639a60e058be494cdf9b1970ad97d5ca", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/d3efc32e639a60e058be494cdf9b1970ad97d5ca", "committedDate": "2020-10-29T11:12:41Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNTQyMzU2", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-520542356", "createdAt": "2020-10-30T10:29:57Z", "commit": {"oid": "d3efc32e639a60e058be494cdf9b1970ad97d5ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMDoyOTo1N1rOHrJNYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMDoyOTo1N1rOHrJNYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAwMTY5OA==", "bodyText": "is the size need wrapped with '?", "url": "https://github.com/seata/seata/pull/3172#discussion_r515001698", "createdAt": "2020-10-30T10:29:57Z", "author": {"login": "mzzw"}, "path": "common/src/main/java/io/seata/common/util/SizeUtil.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.common.util;\n+\n+/**\n+ * @author chd\n+ */\n+public class SizeUtil {\n+    private static final long RADIX = 1024;\n+    /**\n+     * case size to byte length\n+     * example:\n+     *   2k => 2 * 1024\n+     *   2m => 2 * 1024 * 1024\n+     *   2g => 2 * 1024 * 1024 * 1024\n+     *   2t => 2 * 1024 * 1024 * 1024 * 1024\n+     * @param size the string size with unit\n+     * @return the byte length\n+     */\n+    public static long size2Long(String size) {\n+        if (null == size || size.length() <= 1) {\n+            throw new IllegalArgumentException(\"could not convert '\" + size + \"' to byte length\");\n+        }\n+\n+        String size2Lower = size.toLowerCase();\n+        char unit = size2Lower.charAt(size.length() - 1);\n+        long number;\n+        try {\n+            number = NumberUtils.toLong(size2Lower.substring(0, size.length() - 1));\n+        } catch (NumberFormatException | NullPointerException ex) {\n+            throw new IllegalArgumentException(\"could not convert '\" + size + \"' to byte length\");\n+        }\n+\n+        switch (unit) {\n+            case 'k':\n+                return number * RADIX;\n+            case 'm':\n+                return number * RADIX * RADIX;\n+            case 'g':\n+                return number * RADIX * RADIX * RADIX;\n+            case 't':\n+                return number * RADIX * RADIX * RADIX * RADIX;\n+            default:\n+                throw new IllegalArgumentException(\"could not convert \" + size + \" to byte length\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3efc32e639a60e058be494cdf9b1970ad97d5ca"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a4bd21770fe92321be4d1b930f5e86f447497ac", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/6a4bd21770fe92321be4d1b930f5e86f447497ac", "committedDate": "2020-10-31T08:02:03Z", "message": "add '"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20b2a896d62264b3bbd566602cc9c070cc3ed0f0", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/20b2a896d62264b3bbd566602cc9c070cc3ed0f0", "committedDate": "2020-10-31T08:03:07Z", "message": "Merge remote-tracking branch 'origin/feature-add-zip-for-rollback-info' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37c1fdae354caa3ae8fb321dc2d937d9e9e7d8c8", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/37c1fdae354caa3ae8fb321dc2d937d9e9e7d8c8", "committedDate": "2020-10-31T08:03:31Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b484753a5ea85b76b3d5e5bed0468bcd435271c0", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/b484753a5ea85b76b3d5e5bed0468bcd435271c0", "committedDate": "2020-11-06T08:42:17Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7ae3c0d2cbae63f6b2df2be8990eefa07657471", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/f7ae3c0d2cbae63f6b2df2be8990eefa07657471", "committedDate": "2020-11-18T05:48:56Z", "message": "Merge branch 'github-develop' into feature-add-zip-for-rollback-info\n\n# Conflicts:\n#\tseata-spring-boot-starter/src/main/java/io/seata/spring/boot/autoconfigure/StarterConstants.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58ebd1bf12990fc55861e3ae7cfd1b214ddb6fd0", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/58ebd1bf12990fc55861e3ae7cfd1b214ddb6fd0", "committedDate": "2020-11-18T05:53:19Z", "message": "solve the conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3e480a6d9b8dca35a29b7319887fb0e96d54614", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/c3e480a6d9b8dca35a29b7319887fb0e96d54614", "committedDate": "2020-11-22T13:09:29Z", "message": "Merge branch 'develop' into feature-add-zip-for-rollback-info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1e15b29d11333fa1f44796bec3934c06176e08b", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/c1e15b29d11333fa1f44796bec3934c06176e08b", "committedDate": "2020-11-28T14:30:33Z", "message": "Merge branch 'github-develop' into feature-add-zip-for-rollback-info\n\n# Conflicts:\n#\tscript/client/spring/application.properties\n#\tscript/client/spring/application.yml\n#\tscript/config-center/config.txt\n#\tseata-spring-boot-starter/src/main/java/io/seata/spring/boot/autoconfigure/StarterConstants.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c76259111540faf0fa1e365488290cbaa496c670", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/c76259111540faf0fa1e365488290cbaa496c670", "committedDate": "2020-11-28T14:47:37Z", "message": "allow deflater"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTY4MDA2", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-540968006", "createdAt": "2020-11-30T14:38:10Z", "commit": {"oid": "c76259111540faf0fa1e365488290cbaa496c670"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODA4NTU2", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-543808556", "createdAt": "2020-12-03T10:24:35Z", "commit": {"oid": "c76259111540faf0fa1e365488290cbaa496c670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDoyNDozNVrOH-RwbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMDoyNDozNVrOH-RwbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA2NDY4NQ==", "bodyText": "why add id?", "url": "https://github.com/seata/seata/pull/3172#discussion_r535064685", "createdAt": "2020-12-03T10:24:35Z", "author": {"login": "jsbxyyx"}, "path": "core/src/main/java/io/seata/core/constants/ClientTableColumnsName.java", "diffHunk": "@@ -22,6 +22,12 @@\n  */\n public interface ClientTableColumnsName {\n \n+    /**\n+     * The constant undo_log column name xid\n+     * this field is not use in mysql\n+     */\n+    String UNDO_LOG_ID = \"id\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c76259111540faf0fa1e365488290cbaa496c670"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NjgwMzIz", "url": "https://github.com/seata/seata/pull/3172#pullrequestreview-544680323", "createdAt": "2020-12-04T06:10:23Z", "commit": {"oid": "c76259111540faf0fa1e365488290cbaa496c670"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcd516279667908031f0b4813519d5944d8d2a0d", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/fcd516279667908031f0b4813519d5944d8d2a0d", "committedDate": "2020-12-15T04:47:16Z", "message": "Merge branch 'github-develop' into feature-add-zip-for-rollback-info\n\n# Conflicts:\n#\tcompressor/seata-compressor-all/pom.xml"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3696, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}