{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MDQwNjQ5", "number": 2616, "title": "feature: TCC adapter for Dubbo And Sofa reference annotation", "bodyText": "\u2160. Describe what this PR did\nSupport Dubbo @reference and sofa @SofaReference  annotation for TCC mode\n\u2161. Does this pull request fix one issue?\n\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-04-26T08:15:12Z", "url": "https://github.com/seata/seata/pull/2616", "merged": true, "mergeCommit": {"oid": "ab07a1f2866fc5f93f029beca5dc255c055dafee"}, "closed": true, "closedAt": "2020-06-30T03:18:11Z", "author": {"login": "q294881866"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcm3r-egH2gAyNDA5MDQwNjQ5OmE3NWU4ZGQ0YTQ5NDFiMDhlOGQzZDg5MTM1ZTBlNjYyZDIyMDc3OWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwMLVIgH2gAyNDA5MDQwNjQ5OmM3MTk4NWRhMjRhZTZjODhlYjU0MTZlOTE4MDdiNjkzZTUzMzE0OWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a75e8dd4a4941b08e8d3d89135e0e662d220779f", "author": {"user": {"login": "q294881866", "name": "Pengfei Pei"}}, "url": "https://github.com/seata/seata/commit/a75e8dd4a4941b08e8d3d89135e0e662d220779f", "committedDate": "2020-06-01T03:28:01Z", "message": "A tcc adapter for Dubbo Sofa annotation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a65bcd930c838489b121efe3a89bec569436520f", "author": {"user": {"login": "q294881866", "name": "Pengfei Pei"}}, "url": "https://github.com/seata/seata/commit/a65bcd930c838489b121efe3a89bec569436520f", "committedDate": "2020-06-01T02:59:09Z", "message": "Merge branch 'develop' into feature_tcc_annotation"}, "afterCommit": {"oid": "a75e8dd4a4941b08e8d3d89135e0e662d220779f", "author": {"user": {"login": "q294881866", "name": "Pengfei Pei"}}, "url": "https://github.com/seata/seata/commit/a75e8dd4a4941b08e8d3d89135e0e662d220779f", "committedDate": "2020-06-01T03:28:01Z", "message": "A tcc adapter for Dubbo Sofa annotation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjgyMzU1", "url": "https://github.com/seata/seata/pull/2616#pullrequestreview-431282355", "createdAt": "2020-06-16T08:36:52Z", "commit": {"oid": "a75e8dd4a4941b08e8d3d89135e0e662d220779f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMzA3ODg1", "url": "https://github.com/seata/seata/pull/2616#pullrequestreview-431307885", "createdAt": "2020-06-16T09:08:01Z", "commit": {"oid": "a75e8dd4a4941b08e8d3d89135e0e662d220779f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOTowODowMVrOGkST9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOToxNTo0OVrOGkSnBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwMTk0MQ==", "bodyText": "if necessary? FieldFilter check the filed contains annotation.", "url": "https://github.com/seata/seata/pull/2616#discussion_r440701941", "createdAt": "2020-06-16T09:08:01Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/tcc/TccAnnotationProcessor.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.tcc;\n+\n+import io.seata.rm.tcc.api.TwoPhaseBusinessAction;\n+import io.seata.rm.tcc.remoting.RemotingDesc;\n+import io.seata.spring.util.TCCBeanParserUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.BeansException;\n+import org.springframework.beans.factory.config.BeanPostProcessor;\n+import org.springframework.util.ReflectionUtils;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * An annotation adapter for TCC\n+ *\n+ * @author ppf\n+ */\n+public class TccAnnotationProcessor implements BeanPostProcessor {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(TccAnnotationProcessor.class);\n+\n+    private static final List<Class<? extends Annotation>> ANNOTATIONS = new ArrayList<>(4);\n+    private static final Set<String> PROXIED_SET = new HashSet<>();\n+\n+    static {\n+        ANNOTATIONS.add(loadAnnotation(\"org.apache.dubbo.config.annotation.Reference\"));\n+        ANNOTATIONS.add(loadAnnotation(\"com.alipay.sofa.runtime.api.annotation.SofaReference\"));\n+    }\n+\n+    private static Class<? extends Annotation> loadAnnotation(String annotation) {\n+        try {\n+            return (Class<? extends Annotation>) Class.forName(annotation);\n+        } catch (ClassNotFoundException e) {\n+            return null;\n+        }\n+    }\n+\n+\n+    /**\n+     * Process annotation\n+     *\n+     * @param bean\n+     * @param beanName\n+     * @param annotation\n+     */\n+    protected void process(Object bean, String beanName, Class<? extends Annotation> annotation) {\n+        if (Objects.isNull(annotation) || PROXIED_SET.contains(beanName)) {\n+            return;\n+        }\n+\n+        ReflectionUtils.doWithFields(bean.getClass(), field -> {\n+            Annotation reference = field.getAnnotation(annotation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a75e8dd4a4941b08e8d3d89135e0e662d220779f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwNjgyMg==", "bodyText": "why not getInterface()?", "url": "https://github.com/seata/seata/pull/2616#discussion_r440706822", "createdAt": "2020-06-16T09:15:49Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/tcc/TccAnnotationProcessor.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.tcc;\n+\n+import io.seata.rm.tcc.api.TwoPhaseBusinessAction;\n+import io.seata.rm.tcc.remoting.RemotingDesc;\n+import io.seata.spring.util.TCCBeanParserUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.BeansException;\n+import org.springframework.beans.factory.config.BeanPostProcessor;\n+import org.springframework.util.ReflectionUtils;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * An annotation adapter for TCC\n+ *\n+ * @author ppf\n+ */\n+public class TccAnnotationProcessor implements BeanPostProcessor {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(TccAnnotationProcessor.class);\n+\n+    private static final List<Class<? extends Annotation>> ANNOTATIONS = new ArrayList<>(4);\n+    private static final Set<String> PROXIED_SET = new HashSet<>();\n+\n+    static {\n+        ANNOTATIONS.add(loadAnnotation(\"org.apache.dubbo.config.annotation.Reference\"));\n+        ANNOTATIONS.add(loadAnnotation(\"com.alipay.sofa.runtime.api.annotation.SofaReference\"));\n+    }\n+\n+    private static Class<? extends Annotation> loadAnnotation(String annotation) {\n+        try {\n+            return (Class<? extends Annotation>) Class.forName(annotation);\n+        } catch (ClassNotFoundException e) {\n+            return null;\n+        }\n+    }\n+\n+\n+    /**\n+     * Process annotation\n+     *\n+     * @param bean\n+     * @param beanName\n+     * @param annotation\n+     */\n+    protected void process(Object bean, String beanName, Class<? extends Annotation> annotation) {\n+        if (Objects.isNull(annotation) || PROXIED_SET.contains(beanName)) {\n+            return;\n+        }\n+\n+        ReflectionUtils.doWithFields(bean.getClass(), field -> {\n+            Annotation reference = field.getAnnotation(annotation);\n+            if (reference == null) {\n+                return;\n+            }\n+\n+            addTccAdvise(bean, beanName, field, field.getType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a75e8dd4a4941b08e8d3d89135e0e662d220779f"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTE5OTIy", "url": "https://github.com/seata/seata/pull/2616#pullrequestreview-432919922", "createdAt": "2020-06-18T03:44:01Z", "commit": {"oid": "a75e8dd4a4941b08e8d3d89135e0e662d220779f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTkzMjQ1", "url": "https://github.com/seata/seata/pull/2616#pullrequestreview-432993245", "createdAt": "2020-06-18T07:02:13Z", "commit": {"oid": "a75e8dd4a4941b08e8d3d89135e0e662d220779f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c71985da24ae6c88eb5416e91807b693e533149f", "author": {"user": {"login": "q294881866", "name": "Pengfei Pei"}}, "url": "https://github.com/seata/seata/commit/c71985da24ae6c88eb5416e91807b693e533149f", "committedDate": "2020-06-30T02:25:41Z", "message": "Merge branch 'develop' into feature_tcc_annotation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3934, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}