{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMDQzMzYy", "number": 2301, "title": "feature: postgresql add default expr and nextval", "bodyText": "\u2160. Describe what this PR did\nfeature: postgresql add default expr and convert nextval to sequence expr.\n\u2161. Does this pull request fix one issue?\n\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-02-26T07:03:40Z", "url": "https://github.com/seata/seata/pull/2301", "merged": true, "mergeCommit": {"oid": "74f0f096533af1a56a7f15ab1d29f8d38d56f629"}, "closed": true, "closedAt": "2020-04-17T07:23:59Z", "author": {"login": "jsbxyyx"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIBNVogH2gAyMzgwMDQzMzYyOmJlMjlmMzcxNmViY2I0NzkxYTVlNDlmZDAzZDdmYjRlMTNmYzZjYzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYcFgKgFqTM5NTIxODY5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "be29f3716ebcb4791a5e49fd03d7fb4e13fc6cc7", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/be29f3716ebcb4791a5e49fd03d7fb4e13fc6cc7", "committedDate": "2020-02-26T07:01:57Z", "message": "postgresql add default expr and nextval"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c249f22be29df1f1b483ae75aa75a977f870a4bc", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/c249f22be29df1f1b483ae75aa75a977f870a4bc", "committedDate": "2020-02-26T07:05:59Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "805b561b6cf96c5bf73bfe6d808204411cfc8cdd", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/805b561b6cf96c5bf73bfe6d808204411cfc8cdd", "committedDate": "2020-03-05T01:09:16Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26d7cf53d282005d00e9825537e1dddd6b511238", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/26d7cf53d282005d00e9825537e1dddd6b511238", "committedDate": "2020-03-07T05:35:52Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8b3217a537a8960143494f0bd1408150b54d496", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/b8b3217a537a8960143494f0bd1408150b54d496", "committedDate": "2020-03-12T07:47:05Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ec644fae87d73f7b7a907656524c6d4a6d581d4", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/5ec644fae87d73f7b7a907656524c6d4a6d581d4", "committedDate": "2020-03-15T16:12:12Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3OTY3NDA3", "url": "https://github.com/seata/seata/pull/2301#pullrequestreview-387967407", "createdAt": "2020-04-06T06:40:22Z", "commit": {"oid": "5ec644fae87d73f7b7a907656524c6d4a6d581d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwNjo0MDoyM1rOGBJoUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwNjo0MDoyM1rOGBJoUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg1OTUzNg==", "bodyText": "InsertExecutor.getPkValuesBySequence\u903b\u8f91\u6ca1\u6709\u5b9e\u73b0", "url": "https://github.com/seata/seata/pull/2301#discussion_r403859536", "createdAt": "2020-04-06T06:40:23Z", "author": {"login": "jaspercloud"}, "path": "sqlparser/seata-sqlparser-druid/src/main/java/io/seata/sqlparser/druid/postgresql/PostgresqlInsertRecognizer.java", "diffHunk": "@@ -113,12 +116,21 @@ public boolean visit(SQLExprTableSource x) {\n                 } else if (expr instanceof SQLVariantRefExpr) {\n                     row.add(((SQLVariantRefExpr) expr).getName());\n                 } else if (expr instanceof SQLMethodInvokeExpr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ec644fae87d73f7b7a907656524c6d4a6d581d4"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3bba250dde920188db6b189ca46819706394050", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/c3bba250dde920188db6b189ca46819706394050", "committedDate": "2020-04-10T01:38:39Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "870444aae3b68d28e0adfb843bf6dcfcc44995f4", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/870444aae3b68d28e0adfb843bf6dcfcc44995f4", "committedDate": "2020-04-14T03:35:23Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e882696e212ecddb950e30925e055b9cccb09e2", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/8e882696e212ecddb950e30925e055b9cccb09e2", "committedDate": "2020-04-14T04:24:31Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eea8b915013db9a90687ce5aa68a07f76faf2346", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/eea8b915013db9a90687ce5aa68a07f76faf2346", "committedDate": "2020-04-14T06:33:30Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63e8694cffb5136dcb474174a5b6ccfd32d217e6", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/63e8694cffb5136dcb474174a5b6ccfd32d217e6", "committedDate": "2020-04-14T09:42:31Z", "message": "feat: support postgresql default insert."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "389102072d6030cc029f270a4bf3daa5f913c11d", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/389102072d6030cc029f270a4bf3daa5f913c11d", "committedDate": "2020-04-14T09:48:35Z", "message": "revert imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNzA0NzQz", "url": "https://github.com/seata/seata/pull/2301#pullrequestreview-393704743", "createdAt": "2020-04-15T11:58:08Z", "commit": {"oid": "389102072d6030cc029f270a4bf3daa5f913c11d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMTo1ODowOVrOGF2XbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMTo1ODowOVrOGF2XbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4Njc5Nw==", "bodyText": "why not use com.alibaba.druid.sql.ast.expr.SQLSequenceExpr", "url": "https://github.com/seata/seata/pull/2301#discussion_r408786797", "createdAt": "2020-04-15T11:58:09Z", "author": {"login": "l81893521"}, "path": "sqlparser/seata-sqlparser-core/src/main/java/io/seata/sqlparser/struct/SqlDefaultExpr.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "389102072d6030cc029f270a4bf3daa5f913c11d"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b8434f5a37dc9abd777b8830220e21e9a4e5924", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/5b8434f5a37dc9abd777b8830220e21e9a4e5924", "committedDate": "2020-04-15T15:17:21Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjgzODM5", "url": "https://github.com/seata/seata/pull/2301#pullrequestreview-394283839", "createdAt": "2020-04-16T04:03:53Z", "commit": {"oid": "5b8434f5a37dc9abd777b8830220e21e9a4e5924"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNDowMzo1M1rOGGTwLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNDowMzo1M1rOGGTwLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2ODI2OQ==", "bodyText": "I think the Exception should give more detail. like\nthrow new ShouldNeverHappenException(\"get primary key value failed, cause columnDef is \" + columnDef);", "url": "https://github.com/seata/seata/pull/2301#discussion_r409268269", "createdAt": "2020-04-16T04:03:53Z", "author": {"login": "l81893521"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/InsertExecutor.java", "diffHunk": "@@ -172,31 +173,65 @@ protected boolean containsColumns() {\n         if (!pkValues.isEmpty() && pkValues.get(0) instanceof SqlSequenceExpr) {\n             pkValues = getPkValuesBySequence(pkValues.get(0));\n         }\n+        else if (!pkValues.isEmpty() && pkValues.get(0) instanceof SqlDefaultExpr) {\n+            pkValues = getPkValuesByDefault();\n+        }\n         // pk auto generated while column exists and value is null\n         else if (!pkValues.isEmpty() && pkValues.get(0) instanceof Null) {\n             pkValues = getPkValuesByAuto();\n         }\n         return pkValues;\n     }\n \n-    protected List<Object> getPkValuesBySequence(Object expr) throws SQLException {\n+    /**\n+     * get primary key values by default\n+     * @return\n+     * @throws SQLException\n+     */\n+    private List<Object> getPkValuesByDefault() throws SQLException {\n+        Map<String, ColumnMeta> pkMetaMap = checkPrimaryKeyMap();\n+        ColumnMeta pkMeta = pkMetaMap.values().iterator().next();\n+        String columnDef = pkMeta.getColumnDef();\n+        // sample: nextval('test_id_seq'::regclass)\n+        String seq = org.apache.commons.lang.StringUtils.substringBetween(columnDef, \"'\", \"'\");\n+        String function = org.apache.commons.lang.StringUtils.substringBetween(columnDef, \"\", \"(\");\n+        if (StringUtils.isBlank(seq)) {\n+            throw new ShouldNeverHappenException(\"columnDef is \" + columnDef);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b8434f5a37dc9abd777b8830220e21e9a4e5924"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mjg5Mjkw", "url": "https://github.com/seata/seata/pull/2301#pullrequestreview-394289290", "createdAt": "2020-04-16T04:24:43Z", "commit": {"oid": "5b8434f5a37dc9abd777b8830220e21e9a4e5924"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNDoyNDo0M1rOGGUEow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNDoyNDo0M1rOGGUEow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI3MzUwNw==", "bodyText": "How about remove this method? Because multi primary key already check in TableMeta.getPrimaryKeyMap()", "url": "https://github.com/seata/seata/pull/2301#discussion_r409273507", "createdAt": "2020-04-16T04:24:43Z", "author": {"login": "l81893521"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/InsertExecutor.java", "diffHunk": "@@ -359,4 +388,12 @@ protected boolean checkPkValues(List<Object> pkValues) {\n         return pkValues;\n     }\n \n+    private Map<String, ColumnMeta> checkPrimaryKeyMap() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b8434f5a37dc9abd777b8830220e21e9a4e5924"}, "originalPosition": 138}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bc02bad5f79280148b04260b71241483a1b9a6f", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/8bc02bad5f79280148b04260b71241483a1b9a6f", "committedDate": "2020-04-16T04:30:36Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mzk3Mjg0", "url": "https://github.com/seata/seata/pull/2301#pullrequestreview-394397284", "createdAt": "2020-04-16T08:14:01Z", "commit": {"oid": "8bc02bad5f79280148b04260b71241483a1b9a6f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeb3cd07034ce4e79c257e443509d3d1c07c1621", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/aeb3cd07034ce4e79c257e443509d3d1c07c1621", "committedDate": "2020-04-16T10:00:51Z", "message": "fix review\n\nfix reviews"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da0e07768bd449225ee231dbecd10de60232e01e", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/da0e07768bd449225ee231dbecd10de60232e01e", "committedDate": "2020-04-16T10:19:10Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e8631aa5ed30e600b739e82ab99aed5c019ce09", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/9e8631aa5ed30e600b739e82ab99aed5c019ce09", "committedDate": "2020-04-16T10:32:34Z", "message": "fix: test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2b4953276e5932b314e81f78b4158bb1791f8d2", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/a2b4953276e5932b314e81f78b4158bb1791f8d2", "committedDate": "2020-04-16T10:33:01Z", "message": "Merge remote-tracking branch 'origin/sql_method' into sql_method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NTUwOTg5", "url": "https://github.com/seata/seata/pull/2301#pullrequestreview-394550989", "createdAt": "2020-04-16T11:44:27Z", "commit": {"oid": "a2b4953276e5932b314e81f78b4158bb1791f8d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39c1485becbd9f713968c77de1395040f40786fe", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/39c1485becbd9f713968c77de1395040f40786fe", "committedDate": "2020-04-17T06:17:55Z", "message": "Merge branch 'develop' into sql_method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MjE4Njkw", "url": "https://github.com/seata/seata/pull/2301#pullrequestreview-395218690", "createdAt": "2020-04-17T07:23:37Z", "commit": {"oid": "39c1485becbd9f713968c77de1395040f40786fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4024, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}