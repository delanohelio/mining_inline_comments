{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NjQ2MjQ3", "number": 2210, "title": "bugfix: retry expired commit and rollback globalSession can't be removed", "bodyText": "Signed-off-by: slievrly slievrly@163.com\n\n\u2160. Describe what this PR did\nbugfix: retry expired commit and rollback globalSession can't be removed\n\u2161. Does this pull request fix one issue?\nfix #2188\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-01-20T05:14:23Z", "url": "https://github.com/seata/seata/pull/2210", "merged": true, "mergeCommit": {"oid": "a512161c54e811b8b4fd9d13ca43a716f05deaa3"}, "closed": true, "closedAt": "2020-01-23T02:47:03Z", "author": {"login": "slievrly"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8FeR3gH2gAyMzY0NjQ2MjQ3OmE5ZWY2N2QyNzJkZDJjYWI2ZmI0YTQ1MmU5ZjI0ZTg3NjJhMDNjZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8_bkZgFqTM0NzAwMDU0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a9ef67d272dd2cab6fb4a452e9f24e8762a03cfb", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/a9ef67d272dd2cab6fb4a452e9f24e8762a03cfb", "committedDate": "2020-01-20T05:12:59Z", "message": "bugfix: retry expired commit and rollback globalSession can't be removed\n\nSigned-off-by: slievrly <slievrly@163.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b95d88d897ea1c5572fdb973237b4fbe3837d10b", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/b95d88d897ea1c5572fdb973237b4fbe3837d10b", "committedDate": "2020-01-20T07:46:03Z", "message": "bugfix: retry expired commit and rollback globalSession can't be removed\n\nSigned-off-by: slievrly <slievrly@163.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MzM0NjAy", "url": "https://github.com/seata/seata/pull/2210#pullrequestreview-345334602", "createdAt": "2020-01-20T14:13:29Z", "commit": {"oid": "b95d88d897ea1c5572fdb973237b4fbe3837d10b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDoxMzoyOVrOFffmtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDoxOToyMFrOFffx3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2Nzk4OQ==", "bodyText": "only clean in memory, how about root.data?", "url": "https://github.com/seata/seata/pull/2210#discussion_r368567989", "createdAt": "2020-01-20T14:13:29Z", "author": {"login": "zjinlei"}, "path": "server/src/test/java/io/seata/server/coordinator/DefaultCoordinatorTest.java", "diffHunk": "@@ -136,45 +135,46 @@ public void test_handleRetryRollbacking() throws TransactionException, Interrupt\n     }\n \n     @Test\n-    public void test_handleRetryRollbackingTimeOut() throws TransactionException, InterruptedException, NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InvocationTargetException {\n+    public void test_handleRetryRollbackingTimeOut() throws TransactionException, InterruptedException, NoSuchFieldException, IllegalAccessException {\n         defaultCoordinator = new DefaultCoordinator(serverMessageSender);\n         String xid = core.begin(applicationId, txServiceGroup, txName, 10);\n         Long branchId = core.branchRegister(BranchType.AT, \"abcd\", clientId, xid, applicationData, lockKeys_2);\n \n         GlobalSession globalSession = SessionHolder.findGlobalSession(xid);\n         Assertions.assertNotNull(globalSession);\n         Assertions.assertNotNull(globalSession.getBranchSessions());\n+        Assertions.assertNotNull(branchId);\n \n-        Thread.sleep(100);\n         ReflectionUtil.modifyStaticFinalField(defaultCoordinator.getClass(), \"MAX_ROLLBACK_RETRY_TIMEOUT\", Duration.ofMillis(10));\n         ReflectionUtil.modifyStaticFinalField(defaultCoordinator.getClass(), \"ROLLBACK_RETRY_TIMEOUT_UNLOCK_ENABLE\", false);\n+        TimeUnit.MILLISECONDS.sleep(100);\n         defaultCoordinator.timeoutCheck();\n         defaultCoordinator.handleRetryRollbacking();\n         int lockSize = globalSession.getBranchSessions().get(0).getLockHolder().size();\n         try {\n             Assertions.assertTrue(lockSize > 0);\n         } finally {\n-            core.setResourceManagerInbound(defaultCoordinator);\n-            core.doGlobalRollback(globalSession, true);\n+            globalSession.closeAndClean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b95d88d897ea1c5572fdb973237b4fbe3837d10b"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU3MDg0Nw==", "bodyText": "\"Assertions.assertNotNull(globalSession.getBranchSessions())\", is it enough?", "url": "https://github.com/seata/seata/pull/2210#discussion_r368570847", "createdAt": "2020-01-20T14:19:20Z", "author": {"login": "zjinlei"}, "path": "server/src/test/java/io/seata/server/coordinator/DefaultCoordinatorTest.java", "diffHunk": "@@ -136,45 +135,46 @@ public void test_handleRetryRollbacking() throws TransactionException, Interrupt\n     }\n \n     @Test\n-    public void test_handleRetryRollbackingTimeOut() throws TransactionException, InterruptedException, NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InvocationTargetException {\n+    public void test_handleRetryRollbackingTimeOut() throws TransactionException, InterruptedException, NoSuchFieldException, IllegalAccessException {\n         defaultCoordinator = new DefaultCoordinator(serverMessageSender);\n         String xid = core.begin(applicationId, txServiceGroup, txName, 10);\n         Long branchId = core.branchRegister(BranchType.AT, \"abcd\", clientId, xid, applicationData, lockKeys_2);\n \n         GlobalSession globalSession = SessionHolder.findGlobalSession(xid);\n         Assertions.assertNotNull(globalSession);\n         Assertions.assertNotNull(globalSession.getBranchSessions());\n+        Assertions.assertNotNull(branchId);\n \n-        Thread.sleep(100);\n         ReflectionUtil.modifyStaticFinalField(defaultCoordinator.getClass(), \"MAX_ROLLBACK_RETRY_TIMEOUT\", Duration.ofMillis(10));\n         ReflectionUtil.modifyStaticFinalField(defaultCoordinator.getClass(), \"ROLLBACK_RETRY_TIMEOUT_UNLOCK_ENABLE\", false);\n+        TimeUnit.MILLISECONDS.sleep(100);\n         defaultCoordinator.timeoutCheck();\n         defaultCoordinator.handleRetryRollbacking();\n         int lockSize = globalSession.getBranchSessions().get(0).getLockHolder().size();\n         try {\n             Assertions.assertTrue(lockSize > 0);\n         } finally {\n-            core.setResourceManagerInbound(defaultCoordinator);\n-            core.doGlobalRollback(globalSession, true);\n+            globalSession.closeAndClean();\n             ReflectionUtil.modifyStaticFinalField(defaultCoordinator.getClass(), \"MAX_ROLLBACK_RETRY_TIMEOUT\",\n                 ConfigurationFactory.getInstance().getDuration(ConfigurationKeys.MAX_ROLLBACK_RETRY_TIMEOUT, DurationUtil.DEFAULT_DURATION, 100));\n         }\n     }\n \n     @Test\n     public void test_handleRetryRollbackingTimeOut_unlock() throws TransactionException, InterruptedException,\n-        NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InvocationTargetException {\n+        NoSuchFieldException, IllegalAccessException {\n         defaultCoordinator = new DefaultCoordinator(serverMessageSender);\n         String xid = core.begin(applicationId, txServiceGroup, txName, 10);\n         Long branchId = core.branchRegister(BranchType.AT, \"abcd\", clientId, xid, applicationData, lockKeys_2);\n \n         GlobalSession globalSession = SessionHolder.findGlobalSession(xid);\n         Assertions.assertNotNull(globalSession);\n         Assertions.assertNotNull(globalSession.getBranchSessions());\n+        Assertions.assertNotNull(branchId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b95d88d897ea1c5572fdb973237b4fbe3837d10b"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02a4afbfbba0fa547dceb7f7fca99fb52dece546", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/02a4afbfbba0fa547dceb7f7fca99fb52dece546", "committedDate": "2020-01-20T14:42:07Z", "message": "Merge branch 'develop' into retry_delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2767f8029d8797b13006ec7257bc626de11384d0", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/2767f8029d8797b13006ec7257bc626de11384d0", "committedDate": "2020-01-22T01:37:31Z", "message": "Merge branch 'develop' into retry_delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "407c5ebeed223bcf31c747df4074f1e2b836a395", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/407c5ebeed223bcf31c747df4074f1e2b836a395", "committedDate": "2020-01-22T01:44:07Z", "message": "Merge branch 'develop' into retry_delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52075859161ff22f5dac67893271d306090601fa", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/52075859161ff22f5dac67893271d306090601fa", "committedDate": "2020-01-22T02:52:29Z", "message": "fix unit test\n\nSigned-off-by: slievrly <slievrly@163.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5db33b92d3bd14bffca8521352b4ff9a2a59e4e8", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/5db33b92d3bd14bffca8521352b4ff9a2a59e4e8", "committedDate": "2020-01-22T02:58:44Z", "message": "Merge remote-tracking branch 'upstream/develop' into retry_delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bdace9b4298ca2eca3abcd1b89fb0d1ecc7318c", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/0bdace9b4298ca2eca3abcd1b89fb0d1ecc7318c", "committedDate": "2020-01-22T03:01:47Z", "message": "Merge remote-tracking branch 'origin/retry_delete' into retry_delete"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MzM3OTQ4", "url": "https://github.com/seata/seata/pull/2210#pullrequestreview-346337948", "createdAt": "2020-01-22T04:18:09Z", "commit": {"oid": "0bdace9b4298ca2eca3abcd1b89fb0d1ecc7318c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea7d9897faad6388b0d7599de5bc50b34885a889", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/ea7d9897faad6388b0d7599de5bc50b34885a889", "committedDate": "2020-01-22T15:42:02Z", "message": "Merge branch 'develop' into retry_delete"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MDAwNTQ3", "url": "https://github.com/seata/seata/pull/2210#pullrequestreview-347000547", "createdAt": "2020-01-23T00:44:31Z", "commit": {"oid": "ea7d9897faad6388b0d7599de5bc50b34885a889"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3986, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}