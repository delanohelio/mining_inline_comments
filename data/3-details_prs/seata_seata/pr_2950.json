{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MTE4Nzc5", "number": 2950, "title": "feature: support the reentrant lock in redis module", "bodyText": "\u2160. Describe what this PR did\nredis\u652f\u6301\u53ef\u91cd\u5165\u9501\u3002\u9002\u5e94\u573a\u666f\uff1a\u5728\u540c\u4e00\u4e8b\u52a1\u4e2d\uff0c\u5bf9\u540c\u4e00\u6761\u6570\u636e\u8fdb\u884c\u591a\u6b21\u64cd\u4f5c\u7684\u60c5\u666f\n\u2161. Does this pull request fix one issue?\n\n\u81ea\u5df1\u53d1\u73b0 fixes #2938\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u540c\u4e00\u4e8b\u52a1\u53ef\u4ee5\u5148\u540e\u4e24\u6b21\u64cd\u4f5c\u540c\u4e00\u6761\u6570\u636e\uff0c\u6d41\u7a0b\u53ef\u4ee5\u6b63\u5e38\u8fdb\u884c\uff0c\u800c\u4e0d\u662f\u62a5\u83b7\u53d6\u4e0d\u5230\u9501\u7684\u5f02\u5e38\n\u2164. Special notes for reviews\nSupport the reentrant lock in redis module", "createdAt": "2020-07-30T12:10:39Z", "url": "https://github.com/seata/seata/pull/2950", "merged": true, "mergeCommit": {"oid": "ecbac3f11d0286c0ccb0eb1e551962c9ee660708"}, "closed": true, "closedAt": "2020-07-31T15:44:33Z", "author": {"login": "yujianfei1986"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5-YT5AH2gAyNDU5MTE4Nzc5OjYyNzQ5ZWM4ZjVkZGVlMjY0ZTk4MDA2NGE3MzQzY2QzMzA5OGNkZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6R5xtgH2gAyNDU5MTE4Nzc5OmY3NzM5YTFhZjQ2NjM5NTY3ODY3YjJjN2VhOWQ4OTdjMmE1NDNmMDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "62749ec8f5ddee264e980064a7343cd33098cde8", "author": {"user": {"login": "yujianfei1986", "name": null}}, "url": "https://github.com/seata/seata/commit/62749ec8f5ddee264e980064a7343cd33098cde8", "committedDate": "2020-07-30T12:00:26Z", "message": "\u652f\u6301\u53ef\u91cd\u5165\u9501"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42d62878c1cfef2071317bf0b5c146b598161477", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/42d62878c1cfef2071317bf0b5c146b598161477", "committedDate": "2020-07-30T12:34:11Z", "message": "Merge branch 'develop' into reentrantLock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzYxMTQ0", "url": "https://github.com/seata/seata/pull/2950#pullrequestreview-458361144", "createdAt": "2020-07-30T12:41:36Z", "commit": {"oid": "42d62878c1cfef2071317bf0b5c146b598161477"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0MTozNlrOG5hRRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0MTozNlrOG5hRRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NzExMQ==", "bodyText": "unnecessary", "url": "https://github.com/seata/seata/pull/2950#discussion_r462967111", "createdAt": "2020-07-30T12:41:36Z", "author": {"login": "a364176773"}, "path": "server/src/main/java/io/seata/server/storage/redis/lock/RedisLocker.java", "diffHunk": "@@ -75,13 +75,33 @@ public boolean acquireLock(List<RowLock> rowLocks) {\n                 locks =\n                     locks.stream().filter(LambdaUtils.distinctByKey(LockDO::getRowKey)).collect(Collectors.toList());\n             }\n-            Pipeline pipeline = jedis.pipelined();\n+            List<String> existedKeyList = new ArrayList<>();\n+            locks.forEach(lockDO -> {\n+                existedKeyList.add(getLockKey(lockDO.getRowKey()));\n+            });\n+            List<String> lockList = jedis.mget(existedKeyList.toArray(new String[0]));\n             List<String> readyKeys = new ArrayList<>();\n-            for (LockDO lock : locks) {\n-                String key = getLockKey(lock.getRowKey());\n-                pipeline.setnx(key, JSON.toJSONString(lock));\n-                readyKeys.add(key);\n+            Pipeline pipeline = null;\n+            for (int i = 0; i < existedKeyList.size(); i++) {\n+                String existedValue = lockList.get(i);\n+                if (existedValue == null) {\n+                    if (pipeline == null) {\n+                        pipeline = jedis.pipelined();\n+                    }\n+                    String key = existedKeyList.get(i);\n+                    pipeline.setnx(key, JSON.toJSONString(locks.get(i)));\n+                    readyKeys.add(key);\n+                } else {\n+                    LockDO existed = JSON.parseObject(existedValue, LockDO.class);\n+                    if (!StringUtils.equals(existed.getXid(), locks.get(i).getXid())) {\n+                        return false;\n+                    }\n+                }\n+            }\n+            if (CollectionUtils.isEmpty(readyKeys)) {\n+                return true;\n             }\n+            @SuppressWarnings(\"ConstantConditions\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42d62878c1cfef2071317bf0b5c146b598161477"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f94a62d795b4cd5b8652e8db2bcb1e7167537f8", "author": {"user": {"login": "yujianfei1986", "name": null}}, "url": "https://github.com/seata/seata/commit/4f94a62d795b4cd5b8652e8db2bcb1e7167537f8", "committedDate": "2020-07-30T12:47:35Z", "message": "\u652f\u6301\u53ef\u91cd\u5165\u9501"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f2c152f21ef5e837496af8b91c6f81c92c56c98", "author": {"user": {"login": "yujianfei1986", "name": null}}, "url": "https://github.com/seata/seata/commit/7f2c152f21ef5e837496af8b91c6f81c92c56c98", "committedDate": "2020-07-30T12:48:55Z", "message": "Merge remote-tracking branch 'origin/reentrantLock' into reentrantLock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzY4Nzgz", "url": "https://github.com/seata/seata/pull/2950#pullrequestreview-458368783", "createdAt": "2020-07-30T12:51:17Z", "commit": {"oid": "7f2c152f21ef5e837496af8b91c6f81c92c56c98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ba200b79a3f88a974fcf7581611d042839aed6b", "author": {"user": {"login": "yujianfei1986", "name": null}}, "url": "https://github.com/seata/seata/commit/0ba200b79a3f88a974fcf7581611d042839aed6b", "committedDate": "2020-07-30T13:57:29Z", "message": "\u652f\u6301\u53ef\u91cd\u5165\u9501"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "756be605f7b9659d8a7d911693abc9542312493b", "author": {"user": {"login": "yujianfei1986", "name": null}}, "url": "https://github.com/seata/seata/commit/756be605f7b9659d8a7d911693abc9542312493b", "committedDate": "2020-07-30T14:15:46Z", "message": "\u652f\u6301\u53ef\u91cd\u5165\u9501"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64aa983a365c3e95207cb88e3e78c529d8b76207", "author": {"user": {"login": "yujianfei1986", "name": null}}, "url": "https://github.com/seata/seata/commit/64aa983a365c3e95207cb88e3e78c529d8b76207", "committedDate": "2020-07-30T14:34:53Z", "message": "\u652f\u6301\u53ef\u91cd\u5165\u9501"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NDY2MjAz", "url": "https://github.com/seata/seata/pull/2950#pullrequestreview-458466203", "createdAt": "2020-07-30T14:38:49Z", "commit": {"oid": "64aa983a365c3e95207cb88e3e78c529d8b76207"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODY2OTQz", "url": "https://github.com/seata/seata/pull/2950#pullrequestreview-458866943", "createdAt": "2020-07-31T01:37:23Z", "commit": {"oid": "64aa983a365c3e95207cb88e3e78c529d8b76207"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODY3NTAx", "url": "https://github.com/seata/seata/pull/2950#pullrequestreview-458867501", "createdAt": "2020-07-31T01:39:32Z", "commit": {"oid": "64aa983a365c3e95207cb88e3e78c529d8b76207"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTYyNTU5", "url": "https://github.com/seata/seata/pull/2950#pullrequestreview-458962559", "createdAt": "2020-07-31T07:14:07Z", "commit": {"oid": "64aa983a365c3e95207cb88e3e78c529d8b76207"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzoxNDowOFrOG5-YbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNzoxNDowOFrOG5-YbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ0NDA3Ng==", "bodyText": "readyKeys.get(i) ?", "url": "https://github.com/seata/seata/pull/2950#discussion_r463444076", "createdAt": "2020-07-31T07:14:08Z", "author": {"login": "slievrly"}, "path": "server/src/main/java/io/seata/server/storage/redis/lock/RedisLocker.java", "diffHunk": "@@ -75,13 +78,31 @@ public boolean acquireLock(List<RowLock> rowLocks) {\n                 locks =\n                     locks.stream().filter(LambdaUtils.distinctByKey(LockDO::getRowKey)).collect(Collectors.toList());\n             }\n-            Pipeline pipeline = jedis.pipelined();\n+            List<String> existedKeyList = new ArrayList<>();\n+            locks.forEach(lockDO -> {\n+                existedKeyList.add(getLockKey(lockDO.getRowKey()));\n+            });\n+            List<String> lockList = jedis.mget(existedKeyList.toArray(new String[0]));\n             List<String> readyKeys = new ArrayList<>();\n-            for (LockDO lock : locks) {\n-                String key = getLockKey(lock.getRowKey());\n-                pipeline.setnx(key, JSON.toJSONString(lock));\n-                readyKeys.add(key);\n+            Map<String, String> map = new LinkedHashMap<>(existedKeyList.size(), 1);\n+            for (int i = 0; i < existedKeyList.size(); i++) {\n+                String existedValue = lockList.get(i);\n+                if (existedValue == null) {\n+                    String key = existedKeyList.get(i);\n+                    map.put(key, JSON.toJSONString(locks.get(i)));\n+                    readyKeys.add(key);\n+                } else {\n+                    LockDO existed = JSON.parseObject(existedValue, LockDO.class);\n+                    if (!StringUtils.equals(existed.getXid(), locks.get(i).getXid())) {\n+                        return false;\n+                    }\n+                }\n+            }\n+            if (map.size() == 0) {\n+                return true;\n             }\n+            Pipeline pipeline = jedis.pipelined();\n+            map.forEach(pipeline::setnx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64aa983a365c3e95207cb88e3e78c529d8b76207"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef4e315acd88c0053ad1f2fed162300e539ffb42", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/ef4e315acd88c0053ad1f2fed162300e539ffb42", "committedDate": "2020-07-31T07:21:47Z", "message": "Merge branch 'develop' into reentrantLock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTcwODIx", "url": "https://github.com/seata/seata/pull/2950#pullrequestreview-458970821", "createdAt": "2020-07-31T07:30:44Z", "commit": {"oid": "64aa983a365c3e95207cb88e3e78c529d8b76207"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70df844c51e2f0d894257758f86d2b5329a56c0f", "author": {"user": {"login": "yujianfei1986", "name": null}}, "url": "https://github.com/seata/seata/commit/70df844c51e2f0d894257758f86d2b5329a56c0f", "committedDate": "2020-07-31T10:44:51Z", "message": "\u652f\u6301\u53ef\u91cd\u5165\u9501"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7739a1af46639567867b2c7ea9d897c2a543f05", "author": {"user": {"login": "yujianfei1986", "name": null}}, "url": "https://github.com/seata/seata/commit/f7739a1af46639567867b2c7ea9d897c2a543f05", "committedDate": "2020-07-31T10:45:11Z", "message": "Merge remote-tracking branch 'origin/reentrantLock' into reentrantLock"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3588, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}