{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1ODMwNzQw", "number": 2253, "title": "feature:dynamic adjustment grade", "bodyText": "\u2160. Describe what this PR did\n\u8fde\u7eed\u9519\u8bef\u6570\u964d\u7ea7\u540e,\u901a\u8fc7\u8fde\u7eed\u6210\u529f\u6570\u6062\u590d\u5168\u5c40\u4e8b\u52a1\n\u8bbe\u7f6e\u8fde\u7eed\u964d\u7ea7\u6b21\u6570\u7b49\u540c\u4e8e\u5347\u7ea7\u6b21\u6570\ndegradeCheckAllowTimes \u5347\u964d\u7ea7\u8fbe\u6807\u9608\u503c,\u9ed8\u8ba410\ndegradeCheckPeriod \u670d\u52a1\u81ea\u68c0\u9891\u7387 \u9ed8\u8ba4 2000ms\ndegradeCheck \u52a8\u6001\u5347\u964d\u7ea7\u5f00\u5173\n\u9996\u5148\u7531startDegradeCheck\u542f\u52a8\u5b9a\u65f6\u4efb\u52a1,\u81ea\u52a8begin,commit,\u68c0\u67e5\u670d\u52a1\u53ef\u7528\u6027.\u4ee5\u53caswitchTransactionalExecutor.Code\u6765\u534f\u52a9\u5224\u65ad\u670d\u52a1\u53ef\u7528.\u5982\u679c\u670d\u52a1\u4e0d\u53ef\u7528degradeNum<degradeCheckAllowTimes(\u5347\u964d\u7ea7\u9608\u503c),\u90a3\u4e48\u8fdb\u884cdegradeNum++,\u5982\u679c\u7d2f\u52a0\u540e\u8fbe\u6807\u4e86,\u63d0\u793a\u7528\u6237\u5f53\u524d\u5df2\u88ab\u964d\u7ea7.\n\u5982\u679c\u5f53\u524d\u670d\u52a1\u5df2\u7ecf\u88ab\u964d\u7ea7degradeNum==degradeCheckAllowTimes\u6210\u7acb,\u81ea\u68c0\u670d\u52a1\u901a\u8fc7\u81ea\u68c0\u540e,\u8fdb\u884c\u7d2f\u52a0reachNum\u7684\u503c,\u8fde\u7eed\u6210\u529f\u6570\u8fbe\u5230degradeCheckAllowTimes\u540e,\u670d\u52a1\u6062\u590d\u6b63\u5e38\u53ef\u7528.\n\u5168\u5c40\u4e8b\u52a1\u6539\u901a\u8fc7\u6b64\u5224\u65ad\u6765\u786e\u5b9a\u662f\u5426\u5f00\u542f\u5168\u5c40\u4e8b\u52a1disable || (degradeCheck && degradeNum >= degradeCheckAllowTimes);\n\u4e24\u8005\u7686\u8868\u793a\u53ef\u4ee5\u5f00\u542f\u5168\u5c40\u4e8b\u52a1,\u5168\u5c40\u4e8b\u52a1\u624d\u4f1a\u5f00\u542f", "createdAt": "2020-02-16T14:14:02Z", "url": "https://github.com/seata/seata/pull/2253", "merged": true, "mergeCommit": {"oid": "b0e2e2db30a2047b116fbacfc3f6305cc82d8d45"}, "closed": true, "closedAt": "2020-05-08T03:44:40Z", "author": {"login": "a364176773"}, "timelineItems": {"totalCount": 80, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcE3uxrgH2gAyMzc1ODMwNzQwOmViZDk3OTZjNGI2YTQwYWEzMDllMmRlYmY3YmVmNzU0Y2Q3YTM3YjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfJh9DAFqTQwNzk3NzExNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ebd9796c4b6a40aa309e2debf7bef754cd7a37b2", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/ebd9796c4b6a40aa309e2debf7bef754cd7a37b2", "committedDate": "2020-02-16T12:17:39Z", "message": "dynamic adjustment grade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08e128a7a1d1c664a9158d8665e205743a969b8d", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/08e128a7a1d1c664a9158d8665e205743a969b8d", "committedDate": "2020-02-16T12:32:46Z", "message": "merge seata 1.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74d3aa357e0e445737642692bccc8f0f4f2d4731", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/74d3aa357e0e445737642692bccc8f0f4f2d4731", "committedDate": "2020-02-19T18:00:55Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46f4e34c13c16dc004c665e50d81b064a9a78caf", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/46f4e34c13c16dc004c665e50d81b064a9a78caf", "committedDate": "2020-02-22T08:10:06Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ca91a54203e84969be6adaa4e7da3ddfef8cda1", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/9ca91a54203e84969be6adaa4e7da3ddfef8cda1", "committedDate": "2020-02-25T07:02:10Z", "message": "Merge pull request #21 from seata/develop\n\nupdate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35c5483353c368a41168574ef9473cffa1896b82", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/35c5483353c368a41168574ef9473cffa1896b82", "committedDate": "2020-03-05T01:46:03Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "458a81edf827915ea9ece2f39b50f0e8d047cf25", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/458a81edf827915ea9ece2f39b50f0e8d047cf25", "committedDate": "2020-03-06T01:45:41Z", "message": "Merge pull request #25 from seata/develop\n\noptimize: StackTraceLogger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0932bfcf9b3b2ca3bf28b476a675568a50b9c52c", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/0932bfcf9b3b2ca3bf28b476a675568a50b9c52c", "committedDate": "2020-03-06T02:14:48Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f333252e50acd540afd63d9f2aac5568fa263a14", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/f333252e50acd540afd63d9f2aac5568fa263a14", "committedDate": "2020-03-07T08:53:39Z", "message": "Merge pull request #26 from seata/develop\n\nbugfix:modify the error configuration name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54ded4b49f8d79ff71e1e37718dc01c750d3cf44", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/54ded4b49f8d79ff71e1e37718dc01c750d3cf44", "committedDate": "2020-03-09T01:21:45Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5656dfecf7259938d29eff81366d193d4641dfe2", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/5656dfecf7259938d29eff81366d193d4641dfe2", "committedDate": "2020-03-09T05:41:28Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57fb2d769dc579b681248aa3a2b1436bfeefc45f", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/57fb2d769dc579b681248aa3a2b1436bfeefc45f", "committedDate": "2020-03-10T09:43:48Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ec90cc3915a3108d42ea879acdab53bd7d675f4", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/2ec90cc3915a3108d42ea879acdab53bd7d675f4", "committedDate": "2020-03-11T12:14:22Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de29ef9b0d901b96710bba27402bcea4f687ac4d", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/de29ef9b0d901b96710bba27402bcea4f687ac4d", "committedDate": "2020-03-18T05:32:57Z", "message": "Merge remote-tracking branch 'seata-develop/develop' into develop"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad801a47dca5cab076259f0c1b52f53dedcfad97", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/ad801a47dca5cab076259f0c1b52f53dedcfad97", "committedDate": "2020-03-18T05:30:41Z", "message": "Merge remote-tracking branch 'seata-develop/develop' into develop"}, "afterCommit": {"oid": "de29ef9b0d901b96710bba27402bcea4f687ac4d", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/de29ef9b0d901b96710bba27402bcea4f687ac4d", "committedDate": "2020-03-18T05:32:57Z", "message": "Merge remote-tracking branch 'seata-develop/develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b24a57f29b49db35238a54ff96071b986b179f5d", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/b24a57f29b49db35238a54ff96071b986b179f5d", "committedDate": "2020-03-18T05:45:11Z", "message": "tuning code logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a104fd0c8321a621821fb606456fbb7fbbcfba4", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/7a104fd0c8321a621821fb606456fbb7fbbcfba4", "committedDate": "2020-03-18T05:47:17Z", "message": "fix code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc72f9cbace1573e6ef49af48a40c84b891153bc", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/bc72f9cbace1573e6ef49af48a40c84b891153bc", "committedDate": "2020-03-19T01:43:03Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5cc5227077924527328224f6495f536032c39e8", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/c5cc5227077924527328224f6495f536032c39e8", "committedDate": "2020-03-20T01:26:37Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41937780ae8e75de59b35ecd161a158e0a83843a", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/41937780ae8e75de59b35ecd161a158e0a83843a", "committedDate": "2020-03-21T03:17:04Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODg4MzM3", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-378888337", "createdAt": "2020-03-21T03:28:55Z", "commit": {"oid": "41937780ae8e75de59b35ecd161a158e0a83843a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODg4NzM0", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-378888734", "createdAt": "2020-03-21T03:35:31Z", "commit": {"oid": "41937780ae8e75de59b35ecd161a158e0a83843a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "828c1384b3d6581d727799a929955f060c19f740", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/828c1384b3d6581d727799a929955f060c19f740", "committedDate": "2020-03-21T04:59:50Z", "message": "supplement and modify the variable name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4327e7ea18e672c5a6d8bf643ef055411ed26193", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/4327e7ea18e672c5a6d8bf643ef055411ed26193", "committedDate": "2020-03-21T05:51:27Z", "message": "code formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MTQ3Nzc5", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-379147779", "createdAt": "2020-03-23T05:53:33Z", "commit": {"oid": "4327e7ea18e672c5a6d8bf643ef055411ed26193"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNTo1MzozM1rOF53sbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNTo1MzozM1rOF53sbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIyNTY0NQ==", "bodyText": "Please check the spell of \"domotion\" is it wrong.", "url": "https://github.com/seata/seata/pull/2253#discussion_r396225645", "createdAt": "2020-03-23T05:53:33Z", "author": {"login": "l81893521"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -101,9 +139,10 @@ private Object handleGlobalLock(final MethodInvocation methodInvocation) throws\n     }\n \n     private Object handleGlobalTransaction(final MethodInvocation methodInvocation,\n-                                           final GlobalTransactional globalTrxAnno) throws Throwable {\n+        final GlobalTransactional globalTrxAnno, String domotionKey) throws Throwable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4327e7ea18e672c5a6d8bf643ef055411ed26193"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca328539f7005e7872841488b58c69e0d7e70e43", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/ca328539f7005e7872841488b58c69e0d7e70e43", "committedDate": "2020-03-23T05:59:48Z", "message": "modify the error variable name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83b0cc92d782028cf040e3de92c26e8c0f1f1b93", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/83b0cc92d782028cf040e3de92c26e8c0f1f1b93", "committedDate": "2020-03-23T08:40:03Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMDk2MTAw", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-380096100", "createdAt": "2020-03-24T08:41:14Z", "commit": {"oid": "83b0cc92d782028cf040e3de92c26e8c0f1f1b93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODo0MToxNVrOF6l2Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODo0MToxNVrOF6l2Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4MTc5OQ==", "bodyText": "Why not use if else", "url": "https://github.com/seata/seata/pull/2253#discussion_r396981799", "createdAt": "2020-03-24T08:41:15Z", "author": {"login": "l81893521"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -190,4 +240,38 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n         }\n     }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {\n+        ScheduledThreadPoolExecutor executor =\n+            new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(\"SelfCheckWorker\", 1, true));\n+        executor.scheduleAtFixedRate(() -> {\n+            if (demotionMap.size() > 0) {\n+                try {\n+                    TransactionManagerHolder.get()\n+                        .commit(TransactionManagerHolder.get().begin(null, null, \"test\", 60000));\n+                    onSelfCheck(false);\n+                } catch (Exception e) {\n+                    onSelfCheck(true);\n+                }\n+            }\n+        }, 10, selfCheckPeriod, TimeUnit.MILLISECONDS);\n+    }\n+\n+    private static synchronized void onSelfCheck(boolean isError) {\n+        if (!isError) {\n+            autoDemotionNum++;\n+            if (autoDemotionNum > selfCheckAllowTimes && demotionMap.size() > 0) {\n+                autoDemotionNum = 0;\n+                demotionMap.clear();\n+            }\n+        }\n+        if (isError) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83b0cc92d782028cf040e3de92c26e8c0f1f1b93"}, "originalPosition": 178}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83812183520714aeed790fea9325fd7de46a8618", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/83812183520714aeed790fea9325fd7de46a8618", "committedDate": "2020-03-24T08:42:42Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTE4MTQ2", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-380118146", "createdAt": "2020-03-24T09:11:28Z", "commit": {"oid": "83812183520714aeed790fea9325fd7de46a8618"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOToxMToyOVrOF6m8BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOToxMToyOVrOF6m8BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5OTY4NA==", "bodyText": "I think\nif (selfCheck) {\n    onSelfCheck(error);\n}\n\nis unnecessary here, already have thread to detect it.", "url": "https://github.com/seata/seata/pull/2253#discussion_r396999684", "createdAt": "2020-03-24T09:11:29Z", "author": {"login": "l81893521"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -155,11 +197,19 @@ public TransactionInfo getTransactionInfo() {\n                     failureHandler.onRollbackFailure(e.getTransaction(), e.getCause());\n                     throw e.getCause();\n                 case RollbackRetrying:\n+                    error = false;\n                     failureHandler.onRollbackRetrying(e.getTransaction(), e.getCause());\n                     throw e.getCause();\n                 default:\n                     throw new ShouldNeverHappenException(String.format(\"Unknown TransactionalExecutor.Code: %s\", code));\n-\n+            }\n+        } finally {\n+            if (selfCheck) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83812183520714aeed790fea9325fd7de46a8618"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8628550c91f87cbc3251950040b58c5d0496bcd9", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/8628550c91f87cbc3251950040b58c5d0496bcd9", "committedDate": "2020-03-24T09:12:39Z", "message": "optimize code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjA4Mjg1", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-380208285", "createdAt": "2020-03-24T11:11:51Z", "commit": {"oid": "8628550c91f87cbc3251950040b58c5d0496bcd9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMToxMTo1MVrOF6rZdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMToxMTo1MVrOF6rZdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3Mjc1OA==", "bodyText": "I think ScheduledThreadPoolExecutor should be static and outside the method.", "url": "https://github.com/seata/seata/pull/2253#discussion_r397072758", "createdAt": "2020-03-24T11:11:51Z", "author": {"login": "l81893521"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -190,4 +237,37 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n         }\n     }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {\n+        ScheduledThreadPoolExecutor executor =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8628550c91f87cbc3251950040b58c5d0496bcd9"}, "originalPosition": 152}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjA5NDE4", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-380209418", "createdAt": "2020-03-24T11:13:29Z", "commit": {"oid": "8628550c91f87cbc3251950040b58c5d0496bcd9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMToxMzoyOVrOF6rc_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMToxMzoyOVrOF6rc_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA3MzY2Mg==", "bodyText": "how about remove the condition of\ndemotionMap.size() > 0", "url": "https://github.com/seata/seata/pull/2253#discussion_r397073662", "createdAt": "2020-03-24T11:13:29Z", "author": {"login": "l81893521"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -190,4 +237,37 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n         }\n     }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {\n+        ScheduledThreadPoolExecutor executor =\n+            new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(\"SelfCheckWorker\", 1, true));\n+        executor.scheduleAtFixedRate(() -> {\n+            if (demotionMap.size() > 0) {\n+                try {\n+                    TransactionManagerHolder.get()\n+                        .commit(TransactionManagerHolder.get().begin(null, null, \"test\", 60000));\n+                    onSelfCheck(false);\n+                } catch (Exception e) {\n+                    onSelfCheck(true);\n+                }\n+            }\n+        }, 10, selfCheckPeriod, TimeUnit.MILLISECONDS);\n+    }\n+\n+    private static synchronized void onSelfCheck(boolean isError) {\n+        if (!isError) {\n+            autoDemotionNum++;\n+            if (autoDemotionNum > selfCheckAllowTimes && demotionMap.size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8628550c91f87cbc3251950040b58c5d0496bcd9"}, "originalPosition": 170}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cc1271c68f56f551b898b4c5867ab0a8e6037d8", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/6cc1271c68f56f551b898b4c5867ab0a8e6037d8", "committedDate": "2020-03-24T12:08:00Z", "message": "optimize code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0fa90a109bac2cab5c30734d53044da4f8ac595", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/b0fa90a109bac2cab5c30734d53044da4f8ac595", "committedDate": "2020-03-24T14:31:33Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzkyMzgx", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-380792381", "createdAt": "2020-03-25T00:46:41Z", "commit": {"oid": "b0fa90a109bac2cab5c30734d53044da4f8ac595"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d75201c84d0432823d5523c0abd3fe1168a287eb", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/d75201c84d0432823d5523c0abd3fe1168a287eb", "committedDate": "2020-03-28T13:15:49Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae30ce2c2abb6181240a149f11ac83808ee6f462", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/ae30ce2c2abb6181240a149f11ac83808ee6f462", "committedDate": "2020-03-31T09:37:17Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c86238df79c0f65f151d97ad384a4021b62b3e48", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/c86238df79c0f65f151d97ad384a4021b62b3e48", "committedDate": "2020-04-01T01:36:30Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad60f5333f42a4fc16f93f733f39eb8d8d4d52a2", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/ad60f5333f42a4fc16f93f733f39eb8d8d4d52a2", "committedDate": "2020-04-01T05:50:00Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MTM0NjU5", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-386134659", "createdAt": "2020-04-02T06:22:29Z", "commit": {"oid": "ad60f5333f42a4fc16f93f733f39eb8d8d4d52a2"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNjoyMjoyOVrOF_cyoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNjo0MDo0M1rOF_dOAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NjMyMA==", "bodyText": "degrade", "url": "https://github.com/seata/seata/pull/2253#discussion_r402076320", "createdAt": "2020-04-02T06:22:29Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactional.java", "diffHunk": "@@ -70,8 +70,21 @@\n      */\n     String[] noRollbackForClassName() default {};\n \n+    /**\n+     * Automatically demoted ultimate value\n+     * @return\n+     */\n+    int demotionTimes() default 10;\n+\n+    /**\n+     * Automatically demoted switch\n+     * @return\n+     */\n+    boolean demotion() default false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad60f5333f42a4fc16f93f733f39eb8d8d4d52a2"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NzM0NQ==", "bodyText": "how about seata-spring-boot-starter work\uff1f", "url": "https://github.com/seata/seata/pull/2253#discussion_r402077345", "createdAt": "2020-04-02T06:25:04Z", "author": {"login": "slievrly"}, "path": "core/src/main/java/io/seata/core/constants/ConfigurationKeys.java", "diffHunk": "@@ -419,4 +419,19 @@\n      * The constant SQL_PARSER_TYPE.\n      */\n     public static final String SQL_PARSER_TYPE = CLIENT_RM_PREFIX + \"sqlParserType\";\n+\n+    /**\n+     * The constant CLIENT_SELF_CHECK_PERIOD.\n+     */\n+    public static final String CLIENT_SELF_CHECK_PERIOD = CLIENT_TM_PREFIX + \"selfCheckPeriod\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad60f5333f42a4fc16f93f733f39eb8d8d4d52a2"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3ODgxNA==", "bodyText": "Variable is the name of the need to think about, self no actual meaning.", "url": "https://github.com/seata/seata/pull/2253#discussion_r402078814", "createdAt": "2020-04-02T06:28:54Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -58,29 +66,60 @@\n     private final GlobalLockTemplate<Object> globalLockTemplate = new GlobalLockTemplate<>();\n     private final FailureHandler failureHandler;\n     private volatile boolean disable;\n-\n+    private static int selfCheckPeriod;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad60f5333f42a4fc16f93f733f39eb8d8d4d52a2"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4MjY0OQ==", "bodyText": "split", "url": "https://github.com/seata/seata/pull/2253#discussion_r402082649", "createdAt": "2020-04-02T06:38:51Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -190,4 +238,35 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n         }\n     }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (demotionMap.size() > 0) {\n+                try {\n+                    TransactionManagerHolder.get()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad60f5333f42a4fc16f93f733f39eb8d8d4d52a2"}, "originalPosition": 157}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4MzMzMA==", "bodyText": "always >=0", "url": "https://github.com/seata/seata/pull/2253#discussion_r402083330", "createdAt": "2020-04-02T06:40:43Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -190,4 +238,35 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n         }\n     }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (demotionMap.size() > 0) {\n+                try {\n+                    TransactionManagerHolder.get()\n+                        .commit(TransactionManagerHolder.get().begin(null, null, \"test\", 60000));\n+                    onSelfCheck(false);\n+                } catch (Exception e) {\n+                    onSelfCheck(true);\n+                }\n+            }\n+        }, 10, selfCheckPeriod, TimeUnit.MILLISECONDS);\n+    }\n+\n+    private static synchronized void onSelfCheck(boolean isError) {\n+        if (!isError) {\n+            autoDemotionNum++;\n+            if (autoDemotionNum > selfCheckAllowTimes) {\n+                autoDemotionNum = 0;\n+                demotionMap.clear();\n+            }\n+        } else {\n+            if (autoDemotionNum > 0) {\n+                autoDemotionNum--;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad60f5333f42a4fc16f93f733f39eb8d8d4d52a2"}, "originalPosition": 176}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c677b1e194624570a00a937245777b96276a535", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/0c677b1e194624570a00a937245777b96276a535", "committedDate": "2020-04-02T09:15:37Z", "message": "health monitoring to adjust service degradation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9057a584f41db9941e4a6c11a901a5bc870ac01", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/d9057a584f41db9941e4a6c11a901a5bc870ac01", "committedDate": "2020-04-02T09:48:29Z", "message": "optimized code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eda5e9e26c7932fb5f3cd0447e4d02e53f5f9871", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/eda5e9e26c7932fb5f3cd0447e4d02e53f5f9871", "committedDate": "2020-04-02T09:52:19Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b0b9a8d2217165a30dc448eae3e6ab8fd7226cf", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/0b0b9a8d2217165a30dc448eae3e6ab8fd7226cf", "committedDate": "2020-04-03T06:38:20Z", "message": "support yaml and properties to read configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa9b1e24170383b6967dfdea6c6f621f8a12be8e", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/aa9b1e24170383b6967dfdea6c6f621f8a12be8e", "committedDate": "2020-04-03T06:54:28Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTc5NTY1", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-386979565", "createdAt": "2020-04-03T07:01:34Z", "commit": {"oid": "aa9b1e24170383b6967dfdea6c6f621f8a12be8e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzowMTozNVrOGAHYgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzowMTozNVrOGAHYgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc3NDE0NA==", "bodyText": "need to modify", "url": "https://github.com/seata/seata/pull/2253#discussion_r402774144", "createdAt": "2020-04-03T07:01:35Z", "author": {"login": "slievrly"}, "path": "script/config-center/config.txt", "diffHunk": "@@ -26,6 +26,9 @@ client.rm.sqlParserType=druid\n client.rm.reportSuccessEnable=false\n client.tm.commitRetryCount=5\n client.tm.rollbackRetryCount=5\n+client.tm.selfCheck=false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa9b1e24170383b6967dfdea6c6f621f8a12be8e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c19a797662c08dde0d49c07eae879d606f4a276", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/5c19a797662c08dde0d49c07eae879d606f4a276", "committedDate": "2020-04-03T07:05:04Z", "message": "change configuration name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57b90bbfbb00ab8237043c08097d47170db27a7a", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/57b90bbfbb00ab8237043c08097d47170db27a7a", "committedDate": "2020-04-03T07:05:36Z", "message": "Merge branch 'develop' of https://github.com/a364176773/seata into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f424a32840265a63e626c05388e03cc142ff1449", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/f424a32840265a63e626c05388e03cc142ff1449", "committedDate": "2020-04-03T07:26:46Z", "message": "change configuration name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTkxMTQ4", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-386991148", "createdAt": "2020-04-03T07:23:01Z", "commit": {"oid": "57b90bbfbb00ab8237043c08097d47170db27a7a"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzoyMzowMVrOGAH-Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzozNzo0MlrOGAIa3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc4Mzc2Mw==", "bodyText": "enableXXXX", "url": "https://github.com/seata/seata/pull/2253#discussion_r402783763", "createdAt": "2020-04-03T07:23:01Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -58,34 +65,52 @@\n     private final GlobalLockTemplate<Object> globalLockTemplate = new GlobalLockTemplate<>();\n     private final FailureHandler failureHandler;\n     private volatile boolean disable;\n+    private static int healthCheckPeriod;\n+    private static boolean healthCheck;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57b90bbfbb00ab8237043c08097d47170db27a7a"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc4NjAyMw==", "bodyText": "ahead of this to determine the global disable.", "url": "https://github.com/seata/seata/pull/2253#discussion_r402786023", "createdAt": "2020-04-03T07:27:25Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -58,34 +65,52 @@\n     private final GlobalLockTemplate<Object> globalLockTemplate = new GlobalLockTemplate<>();\n     private final FailureHandler failureHandler;\n     private volatile boolean disable;\n+    private static int healthCheckPeriod;\n+    private static boolean healthCheck;\n+    private static int healthCheckDegradeAllowTimes;\n+    private static volatile Integer degradeNum = 0;\n+    private static ScheduledThreadPoolExecutor executor =\n+        new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(\"healthCheckWorker\", 1, true));\n \n     /**\n      * Instantiates a new Global transactional interceptor.\n      *\n-     * @param failureHandler the failure handler\n+     * @param failureHandler\n+     *            the failure handler\n      */\n     public GlobalTransactionalInterceptor(FailureHandler failureHandler) {\n         this.failureHandler = failureHandler == null ? DEFAULT_FAIL_HANDLER : failureHandler;\n         this.disable = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n             DEFAULT_DISABLE_GLOBAL_TRANSACTION);\n+        this.healthCheck = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.CLIENT_HEALTH_CHECK,\n+            DEFAULT_TM_HEALTH_CHECK);\n+        if (healthCheck) {\n+            this.healthCheckPeriod = ConfigurationFactory.getInstance()\n+                .getInt(ConfigurationKeys.CLIENT_HEALTH_CHECK_PERIOD, DEFAULT_TM_HEALTH_CHECK_PERIOD);\n+            this.healthCheckDegradeAllowTimes = ConfigurationFactory.getInstance().getInt(\n+                ConfigurationKeys.CLIENT_HEALTH_CHECK_DEGRADE_ALLOW_TIMES, DEFAULT_TM_HEALTH_CHECK_DEGRADE_ALLOW_TIMES);\n+            if (healthCheckPeriod > 0 && healthCheckDegradeAllowTimes > 0) {\n+                startSelfCheck();\n+            }\n+        }\n     }\n \n     @Override\n     public Object invoke(final MethodInvocation methodInvocation) throws Throwable {\n-        Class<?> targetClass = methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis())\n-            : null;\n+        Class<?> targetClass =\n+            methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis()) : null;\n         Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);\n         final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);\n-\n         final GlobalTransactional globalTransactionalAnnotation = getAnnotation(method, GlobalTransactional.class);\n         final GlobalLock globalLockAnnotation = getAnnotation(method, GlobalLock.class);\n-        if (!disable && globalTransactionalAnnotation != null) {\n-            return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);\n-        } else if (!disable && globalLockAnnotation != null) {\n-            return handleGlobalLock(methodInvocation);\n-        } else {\n-            return methodInvocation.proceed();\n+        if (!healthCheck || degradeNum < healthCheckDegradeAllowTimes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57b90bbfbb00ab8237043c08097d47170db27a7a"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc4NjkzNg==", "bodyText": "voliate", "url": "https://github.com/seata/seata/pull/2253#discussion_r402786936", "createdAt": "2020-04-03T07:29:13Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -188,6 +219,40 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+        } else if (ConfigurationKeys.CLIENT_HEALTH_CHECK.equals(event.getDataId())) {\n+            healthCheck = Boolean.parseBoolean(event.getNewValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57b90bbfbb00ab8237043c08097d47170db27a7a"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc4NzgzMw==", "bodyText": "if startup healthCheck=false  and now change to true ,how to process?", "url": "https://github.com/seata/seata/pull/2253#discussion_r402787833", "createdAt": "2020-04-03T07:31:06Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -188,6 +219,40 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+        } else if (ConfigurationKeys.CLIENT_HEALTH_CHECK.equals(event.getDataId())) {\n+            healthCheck = Boolean.parseBoolean(event.getNewValue());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc4NjkzNg=="}, "originalCommit": {"oid": "57b90bbfbb00ab8237043c08097d47170db27a7a"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc4ODYyMA==", "bodyText": "split begin and commit, will be more clearly.", "url": "https://github.com/seata/seata/pull/2253#discussion_r402788620", "createdAt": "2020-04-03T07:32:43Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -190,4 +238,35 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n         }\n     }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (demotionMap.size() > 0) {\n+                try {\n+                    TransactionManagerHolder.get()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4MjY0OQ=="}, "originalCommit": {"oid": "ad60f5333f42a4fc16f93f733f39eb8d8d4d52a2"}, "originalPosition": 157}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc4OTI4Mg==", "bodyText": "10 ms  too small startup delay.", "url": "https://github.com/seata/seata/pull/2253#discussion_r402789282", "createdAt": "2020-04-03T07:34:07Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -188,6 +219,40 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+        } else if (ConfigurationKeys.CLIENT_HEALTH_CHECK.equals(event.getDataId())) {\n+            healthCheck = Boolean.parseBoolean(event.getNewValue());\n+            if (!healthCheck) {\n+                degradeNum = 0;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (healthCheck) {\n+                try {\n+                    TransactionManagerHolder.get()\n+                        .commit(TransactionManagerHolder.get().begin(null, null, \"test\", 60000));\n+                    onSelfCheck(true);\n+                } catch (Exception e) {\n+                    onSelfCheck(false);\n+                }\n+            }\n+        }, 10, healthCheckPeriod, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57b90bbfbb00ab8237043c08097d47170db27a7a"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc5MDM5Mw==", "bodyText": "Whether the executor needs to be stopped ?", "url": "https://github.com/seata/seata/pull/2253#discussion_r402790393", "createdAt": "2020-04-03T07:36:21Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -188,6 +219,40 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+        } else if (ConfigurationKeys.CLIENT_HEALTH_CHECK.equals(event.getDataId())) {\n+            healthCheck = Boolean.parseBoolean(event.getNewValue());\n+            if (!healthCheck) {\n+                degradeNum = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57b90bbfbb00ab8237043c08097d47170db27a7a"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc5MTEzNA==", "bodyText": "I think it should be here healthCheck   not !healthCheck", "url": "https://github.com/seata/seata/pull/2253#discussion_r402791134", "createdAt": "2020-04-03T07:37:42Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -155,11 +182,15 @@ public TransactionInfo getTransactionInfo() {\n                     failureHandler.onRollbackFailure(e.getTransaction(), e.getCause());\n                     throw e.getCause();\n                 case RollbackRetrying:\n+                    succeed = false;\n                     failureHandler.onRollbackRetrying(e.getTransaction(), e.getCause());\n                     throw e.getCause();\n                 default:\n                     throw new ShouldNeverHappenException(String.format(\"Unknown TransactionalExecutor.Code: %s\", code));\n-\n+            }\n+        } finally {\n+            if (!healthCheck) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57b90bbfbb00ab8237043c08097d47170db27a7a"}, "originalPosition": 124}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b1c84296b85b1b170c0fdaff82be4e4449ab154", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/9b1c84296b85b1b170c0fdaff82be4e4449ab154", "committedDate": "2020-04-03T08:44:54Z", "message": "adjust code logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTAwNDI1", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-387100425", "createdAt": "2020-04-03T09:32:46Z", "commit": {"oid": "9b1c84296b85b1b170c0fdaff82be4e4449ab154"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwOTozMjo0NlrOGAN1Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwOTozMjo0NlrOGAN1Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg3OTg0Mw==", "bodyText": "volatile  multi-thread", "url": "https://github.com/seata/seata/pull/2253#discussion_r402879843", "createdAt": "2020-04-03T09:32:46Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -188,6 +221,46 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+            if (!degradeCheck && disable != localDisable) {\n+                localDisable = disable;\n+            }\n+        } else if (ConfigurationKeys.CLIENT_DEGRADE_CHECK.equals(event.getDataId())) {\n+            degradeCheck = Boolean.parseBoolean(event.getNewValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b1c84296b85b1b170c0fdaff82be4e4449ab154"}, "originalPosition": 139}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e7e35317d5a307abdffcfe5dd1af0f1dc154d2b", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/2e7e35317d5a307abdffcfe5dd1af0f1dc154d2b", "committedDate": "2020-04-03T11:47:13Z", "message": "adjust code logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80596580a4aae0a14d453b651826cfd1ee646786", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/80596580a4aae0a14d453b651826cfd1ee646786", "committedDate": "2020-04-03T11:59:58Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d35c646a89c743a5629c81329f87201809bd6bcb", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/d35c646a89c743a5629c81329f87201809bd6bcb", "committedDate": "2020-04-03T12:16:32Z", "message": "optimize code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "095e16703a36674b07189f69391fe89334ebe3d1", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/095e16703a36674b07189f69391fe89334ebe3d1", "committedDate": "2020-04-03T12:18:03Z", "message": "optimize code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "444ddec25e7e10fb2061e0e0cd6e10c0c5d2ff01", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/444ddec25e7e10fb2061e0e0cd6e10c0c5d2ff01", "committedDate": "2020-04-07T14:50:25Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7af840aae7eadf03083b58fe3d8ae32594ba0d5", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/f7af840aae7eadf03083b58fe3d8ae32594ba0d5", "committedDate": "2020-04-08T05:21:54Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjY0Mjgy", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-389664282", "createdAt": "2020-04-08T05:38:21Z", "commit": {"oid": "f7af840aae7eadf03083b58fe3d8ae32594ba0d5"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNTozODoyMVrOGCfpeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNTo0NTowM1rOGCfxaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI2ODg1OA==", "bodyText": "starDegradeCheck", "url": "https://github.com/seata/seata/pull/2253#discussion_r405268858", "createdAt": "2020-04-08T05:38:21Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -188,6 +220,40 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+        } else if (ConfigurationKeys.CLIENT_DEGRADE_CHECK.equals(event.getDataId())) {\n+            degradeCheck = Boolean.parseBoolean(event.getNewValue());\n+            if (!degradeCheck) {\n+                degradeNum = 0;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7af840aae7eadf03083b58fe3d8ae32594ba0d5"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI2OTc4MA==", "bodyText": "Can the applicationId of the business be get?\ntest->degradeCheck", "url": "https://github.com/seata/seata/pull/2253#discussion_r405269780", "createdAt": "2020-04-08T05:41:23Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -188,6 +220,40 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+        } else if (ConfigurationKeys.CLIENT_DEGRADE_CHECK.equals(event.getDataId())) {\n+            degradeCheck = Boolean.parseBoolean(event.getNewValue());\n+            if (!degradeCheck) {\n+                degradeNum = 0;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (degradeCheck) {\n+                try {\n+                    String xid = TransactionManagerHolder.get().begin(null, null, \"test\", 60000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7af840aae7eadf03083b58fe3d8ae32594ba0d5"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI2OTk5Ng==", "bodyText": "onDegradeCheck", "url": "https://github.com/seata/seata/pull/2253#discussion_r405269996", "createdAt": "2020-04-08T05:42:11Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -188,6 +220,40 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+        } else if (ConfigurationKeys.CLIENT_DEGRADE_CHECK.equals(event.getDataId())) {\n+            degradeCheck = Boolean.parseBoolean(event.getNewValue());\n+            if (!degradeCheck) {\n+                degradeNum = 0;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (degradeCheck) {\n+                try {\n+                    String xid = TransactionManagerHolder.get().begin(null, null, \"test\", 60000);\n+                    TransactionManagerHolder.get().commit(xid);\n+                    onSelfCheck(true);\n+                } catch (Exception e) {\n+                    onSelfCheck(false);\n+                }\n+            }\n+        }, degradeCheckPeriod, degradeCheckPeriod, TimeUnit.MILLISECONDS);\n+    }\n+\n+    private static synchronized void onSelfCheck(boolean succeed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7af840aae7eadf03083b58fe3d8ae32594ba0d5"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3MDQzMg==", "bodyText": "degradeNum will never be greater than degradeCheckAllowTimes, how to trigger a degrade\uff1f", "url": "https://github.com/seata/seata/pull/2253#discussion_r405270432", "createdAt": "2020-04-08T05:43:37Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -188,6 +220,40 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+        } else if (ConfigurationKeys.CLIENT_DEGRADE_CHECK.equals(event.getDataId())) {\n+            degradeCheck = Boolean.parseBoolean(event.getNewValue());\n+            if (!degradeCheck) {\n+                degradeNum = 0;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startSelfCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (degradeCheck) {\n+                try {\n+                    String xid = TransactionManagerHolder.get().begin(null, null, \"test\", 60000);\n+                    TransactionManagerHolder.get().commit(xid);\n+                    onSelfCheck(true);\n+                } catch (Exception e) {\n+                    onSelfCheck(false);\n+                }\n+            }\n+        }, degradeCheckPeriod, degradeCheckPeriod, TimeUnit.MILLISECONDS);\n+    }\n+\n+    private static synchronized void onSelfCheck(boolean succeed) {\n+        if (succeed) {\n+            if (degradeNum > 0) {\n+                degradeNum--;\n+            }\n+        } else {\n+            if (degradeNum < degradeCheckAllowTimes) {\n+                degradeNum++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7af840aae7eadf03083b58fe3d8ae32594ba0d5"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI3MDg4OQ==", "bodyText": "I think the logic here is incorrect.", "url": "https://github.com/seata/seata/pull/2253#discussion_r405270889", "createdAt": "2020-04-08T05:45:03Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -144,6 +171,7 @@ public TransactionInfo getTransactionInfo() {\n             TransactionalExecutor.Code code = e.getCode();\n             switch (code) {\n                 case RollbackDone:\n+                    succeed = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7af840aae7eadf03083b58fe3d8ae32594ba0d5"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a556fd96d4e4de2b9c7e03fc2110616162fb70b", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/3a556fd96d4e4de2b9c7e03fc2110616162fb70b", "committedDate": "2020-04-08T08:13:52Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34514ddfa562e6d0bc945843139905361e6eaf83", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/34514ddfa562e6d0bc945843139905361e6eaf83", "committedDate": "2020-04-08T08:14:40Z", "message": "Merge branch 'develop' of https://github.com/a364176773/seata into develop"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85089d5e55a722e377535ece749c6910036d0ca4", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/85089d5e55a722e377535ece749c6910036d0ca4", "committedDate": "2020-04-08T08:34:44Z", "message": "fix bug"}, "afterCommit": {"oid": "34514ddfa562e6d0bc945843139905361e6eaf83", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/34514ddfa562e6d0bc945843139905361e6eaf83", "committedDate": "2020-04-08T08:14:40Z", "message": "Merge branch 'develop' of https://github.com/a364176773/seata into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10e0ace960d6dabb0fd23505e6839750a846930e", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/10e0ace960d6dabb0fd23505e6839750a846930e", "committedDate": "2020-04-08T08:45:09Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fd6d84014c578c7f71f432b7fb5bd792074b53c", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/4fd6d84014c578c7f71f432b7fb5bd792074b53c", "committedDate": "2020-04-08T08:49:48Z", "message": "modify the configuration name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3fde42bf57a4bf03a7b18ebb83aadf21b044ee2", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/d3fde42bf57a4bf03a7b18ebb83aadf21b044ee2", "committedDate": "2020-04-09T01:12:58Z", "message": "output logs when switching states"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dff224bf430370e3a85d3223b9d85bcd39a63b6", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/1dff224bf430370e3a85d3223b9d85bcd39a63b6", "committedDate": "2020-04-09T01:23:13Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc08e8cd4c0971f44276cbe7eb3e4340d111edd3", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/cc08e8cd4c0971f44276cbe7eb3e4340d111edd3", "committedDate": "2020-04-10T03:20:07Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05799ce37bfc570b5d2bf2f1861323cc5ba58a6b", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/05799ce37bfc570b5d2bf2f1861323cc5ba58a6b", "committedDate": "2020-04-10T09:16:16Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acfdfa802c588ede4e302a85ce00d00e17eef43d", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/acfdfa802c588ede4e302a85ce00d00e17eef43d", "committedDate": "2020-04-12T12:12:21Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3687b4184260e91a31fcc8e681bf5737bf31019", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/f3687b4184260e91a31fcc8e681bf5737bf31019", "committedDate": "2020-04-17T03:11:22Z", "message": "resolve conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "419f8eec0572971c4bd4f4f1cdf66094b8c34f7b", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/419f8eec0572971c4bd4f4f1cdf66094b8c34f7b", "committedDate": "2020-04-26T11:54:18Z", "message": "resolve conflict"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NDY0NTAz", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-405464503", "createdAt": "2020-05-05T02:42:16Z", "commit": {"oid": "419f8eec0572971c4bd4f4f1cdf66094b8c34f7b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwMjo0MjoxNlrOGQYt2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwMjo0NToyNFrOGQYwVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgzNTM1NA==", "bodyText": "reachNum >= degradeCheckAllowTimes", "url": "https://github.com/seata/seata/pull/2253#discussion_r419835354", "createdAt": "2020-05-05T02:42:16Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -190,6 +223,56 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+        } else if (ConfigurationKeys.CLIENT_DEGRADE_CHECK.equals(event.getDataId())) {\n+            degradeCheck = Boolean.parseBoolean(event.getNewValue());\n+            if (!degradeCheck) {\n+                degradeNum = 0;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startDegradeCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (degradeCheck) {\n+                try {\n+                    String xid = TransactionManagerHolder.get().begin(null, null, \"degradeCheck\", 60000);\n+                    TransactionManagerHolder.get().commit(xid);\n+                    onDegradeCheck(true);\n+                } catch (Exception e) {\n+                    onDegradeCheck(false);\n+                }\n+            }\n+        }, degradeCheckPeriod, degradeCheckPeriod, TimeUnit.MILLISECONDS);\n+    }\n+\n+    private static synchronized void onDegradeCheck(boolean succeed) {\n+        if (succeed) {\n+            if (degradeNum == degradeCheckAllowTimes) {\n+                reachNum++;\n+                if (reachNum >= degradeNum) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "419f8eec0572971c4bd4f4f1cdf66094b8c34f7b"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgzNTk4OQ==", "bodyText": "this will trigger the upgrade.", "url": "https://github.com/seata/seata/pull/2253#discussion_r419835989", "createdAt": "2020-05-05T02:45:24Z", "author": {"login": "slievrly"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactionalInterceptor.java", "diffHunk": "@@ -190,6 +223,56 @@ public void onChangeEvent(ConfigurationChangeEvent event) {\n             LOGGER.info(\"{} config changed, old value:{}, new value:{}\", ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n                 disable, event.getNewValue());\n             disable = Boolean.parseBoolean(event.getNewValue().trim());\n+        } else if (ConfigurationKeys.CLIENT_DEGRADE_CHECK.equals(event.getDataId())) {\n+            degradeCheck = Boolean.parseBoolean(event.getNewValue());\n+            if (!degradeCheck) {\n+                degradeNum = 0;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startDegradeCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (degradeCheck) {\n+                try {\n+                    String xid = TransactionManagerHolder.get().begin(null, null, \"degradeCheck\", 60000);\n+                    TransactionManagerHolder.get().commit(xid);\n+                    onDegradeCheck(true);\n+                } catch (Exception e) {\n+                    onDegradeCheck(false);\n+                }\n+            }\n+        }, degradeCheckPeriod, degradeCheckPeriod, TimeUnit.MILLISECONDS);\n+    }\n+\n+    private static synchronized void onDegradeCheck(boolean succeed) {\n+        if (succeed) {\n+            if (degradeNum == degradeCheckAllowTimes) {\n+                reachNum++;\n+                if (reachNum >= degradeNum) {\n+                    reachNum = 0;\n+                    degradeNum = 0;\n+                    if (LOGGER.isInfoEnabled()) {\n+                        LOGGER.info(\"the current global transaction has been restored\");\n+                    }\n+                }\n+            } else if (degradeNum != 0) {\n+                degradeNum = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "419f8eec0572971c4bd4f4f1cdf66094b8c34f7b"}, "originalPosition": 172}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38a3193bedb0b6160fc206fda48374b8ea6e47e1", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/38a3193bedb0b6160fc206fda48374b8ea6e47e1", "committedDate": "2020-05-05T03:12:47Z", "message": "optimize code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6544cb60be26f34deaf9ce751d3668a1f3d5a79a", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/6544cb60be26f34deaf9ce751d3668a1f3d5a79a", "committedDate": "2020-05-05T03:34:06Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d93d558463f87c430cb085003b4bcd9ab76cdd35", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/d93d558463f87c430cb085003b4bcd9ab76cdd35", "committedDate": "2020-05-07T09:28:31Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9418366143614fc8ad3660ed880e3644091adfd0", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/9418366143614fc8ad3660ed880e3644091adfd0", "committedDate": "2020-05-07T09:37:24Z", "message": "optimize code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MzExMTcw", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-407311170", "createdAt": "2020-05-07T09:41:17Z", "commit": {"oid": "9418366143614fc8ad3660ed880e3644091adfd0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa0055845263e4b83af74d7f2cf17bb6d8ca42bd", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/fa0055845263e4b83af74d7f2cf17bb6d8ca42bd", "committedDate": "2020-05-08T03:01:18Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3OTc3MTE1", "url": "https://github.com/seata/seata/pull/2253#pullrequestreview-407977115", "createdAt": "2020-05-08T03:43:58Z", "commit": {"oid": "fa0055845263e4b83af74d7f2cf17bb6d8ca42bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4012, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}