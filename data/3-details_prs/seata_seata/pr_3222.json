{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5OTIxODQ0", "number": 3222, "title": "optimize: optimize fileListener to decrease cpu time usage ", "bodyText": "\u2160. Describe what this PR did\n\u7531\u539f\u6765\u7684\u6bcf\u4e2adataId, configurationListener\u5bf9\u5e94\u4e00\u4e2aFileListener\u7684\u6b7b\u5faa\u73af\n\u6539\u6210\u6240\u6709\u7684FileListener\u5c31\u5bf9\u5e94\u4e00\u4e2a\u6b7b\u5faa\u73af\n\u2161. Does this pull request fix one issue?\n\nfixes #3571\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-10-26T10:15:22Z", "url": "https://github.com/seata/seata/pull/3222", "merged": true, "mergeCommit": {"oid": "80573c9daf8381cd63afd1228a2a8af5af3e3c3c"}, "closed": true, "closedAt": "2020-10-28T03:58:51Z", "author": {"login": "caohdgege"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWRnBvgH2gAyNTA5OTIxODQ0OjZlZjA2NTc1NDk4MjhkMTU5ZDFkMWFhZjliZTFjOTIzY2MyODdhNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW1a9VgFqTUxODMwNzQ5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6ef0657549828d159d1d1aaf9be1c923cc287a51", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/6ef0657549828d159d1d1aaf9be1c923cc287a51", "committedDate": "2020-10-26T10:14:35Z", "message": "opeimize: use fileListener singleton"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NjM1MTIx", "url": "https://github.com/seata/seata/pull/3222#pullrequestreview-516635121", "createdAt": "2020-10-26T10:18:39Z", "commit": {"oid": "6ef0657549828d159d1d1aaf9be1c923cc287a51"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMDoxODozOVrOHoI-lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMDoxODo1MlrOHoI_CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1MjE4Mw==", "bodyText": "\u65e2\u7136\u662f\u4e00\u4e2a\u5b9e\u4f8b\u4e86\uff0c\u6ca1\u6709\u5fc5\u8981\u53bb\u4e0d\u65ad\u7684new ConfigurationChangeEvent\u4e86\u5427\uff1f", "url": "https://github.com/seata/seata/pull/3222#discussion_r511852183", "createdAt": "2020-10-26T10:18:39Z", "author": {"login": "a364176773"}, "path": "config/seata-config-core/src/main/java/io/seata/config/FileConfiguration.java", "diffHunk": "@@ -230,7 +233,7 @@ public void addConfigListener(String dataId, ConfigurationChangeListener listene\n         listenedConfigMap.put(dataId, ConfigurationFactory.getInstance().getConfig(dataId));\n \n         // Start config change listener for the dataId.\n-        FileListener fileListener = new FileListener(dataId, listener);\n+        fileListener.addListener(dataId, listener);\n         fileListener.onProcessEvent(new ConfigurationChangeEvent());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ef0657549828d159d1d1aaf9be1c923cc287a51"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1MjI5Nw==", "bodyText": "\u5e94\u8be5\u5728\u4e0b\u9762\u6839\u636e\u4e0d\u540c\u7684dataid\u53bb\u6784\u5efa\u5bf9\u5e94\u7684event\u5b9e\u4f8b\uff0c\u800c\u4e0d\u662f\u5c31\u7528\u540c\u4e00\u4e2a\u4e86", "url": "https://github.com/seata/seata/pull/3222#discussion_r511852297", "createdAt": "2020-10-26T10:18:52Z", "author": {"login": "a364176773"}, "path": "config/seata-config-core/src/main/java/io/seata/config/FileConfiguration.java", "diffHunk": "@@ -333,39 +336,45 @@ private void setFailResult(ConfigFuture configFuture) {\n      */\n     class FileListener implements ConfigurationChangeListener {\n \n-        private final String dataId;\n-        private final ConfigurationChangeListener listener;\n+        private final Map<String, Set<ConfigurationChangeListener>> dataIdMap = new HashMap<>();\n+\n         private final ExecutorService executor = new ThreadPoolExecutor(CORE_LISTENER_THREAD, MAX_LISTENER_THREAD, 0L,\n                 TimeUnit.MILLISECONDS, new LinkedBlockingQueue<>(),\n                 new NamedThreadFactory(\"fileListener\", MAX_LISTENER_THREAD));\n \n         /**\n          * Instantiates a new FileListener.\n          *\n-         * @param dataId   the data id\n-         * @param listener the listener\n          */\n-        public FileListener(String dataId, ConfigurationChangeListener listener) {\n-            this.dataId = dataId;\n-            this.listener = listener;\n+        FileListener() {}\n+\n+        public void addListener(String dataId, ConfigurationChangeListener listener) {\n+            Set<ConfigurationChangeListener> changeListeners = dataIdMap.getOrDefault(dataId, new HashSet<>());\n+            changeListeners.add(listener);\n+            dataIdMap.put(dataId, changeListeners);\n         }\n \n         @Override\n         public void onChangeEvent(ConfigurationChangeEvent event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ef0657549828d159d1d1aaf9be1c923cc287a51"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e3f8b3b29f2ae221f3df1cae6c55065c2d7d518", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/6e3f8b3b29f2ae221f3df1cae6c55065c2d7d518", "committedDate": "2020-10-26T10:27:35Z", "message": "optimize: publicity process event"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzcxMzEy", "url": "https://github.com/seata/seata/pull/3222#pullrequestreview-517371312", "createdAt": "2020-10-27T06:05:33Z", "commit": {"oid": "6e3f8b3b29f2ae221f3df1cae6c55065c2d7d518"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjowNTozM1rOHosmjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNjowNjowNFrOHosnLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNTg1NQ==", "bodyText": "dataIdMap .computeIfAbsent(dataId,value->new HashSet<>())", "url": "https://github.com/seata/seata/pull/3222#discussion_r512435855", "createdAt": "2020-10-27T06:05:33Z", "author": {"login": "a364176773"}, "path": "config/seata-config-core/src/main/java/io/seata/config/FileConfiguration.java", "diffHunk": "@@ -333,39 +337,45 @@ private void setFailResult(ConfigFuture configFuture) {\n      */\n     class FileListener implements ConfigurationChangeListener {\n \n-        private final String dataId;\n-        private final ConfigurationChangeListener listener;\n+        private final Map<String, Set<ConfigurationChangeListener>> dataIdMap = new HashMap<>();\n+\n         private final ExecutorService executor = new ThreadPoolExecutor(CORE_LISTENER_THREAD, MAX_LISTENER_THREAD, 0L,\n                 TimeUnit.MILLISECONDS, new LinkedBlockingQueue<>(),\n                 new NamedThreadFactory(\"fileListener\", MAX_LISTENER_THREAD));\n \n         /**\n          * Instantiates a new FileListener.\n          *\n-         * @param dataId   the data id\n-         * @param listener the listener\n          */\n-        public FileListener(String dataId, ConfigurationChangeListener listener) {\n-            this.dataId = dataId;\n-            this.listener = listener;\n+        FileListener() {}\n+\n+        public void addListener(String dataId, ConfigurationChangeListener listener) {\n+            Set<ConfigurationChangeListener> changeListeners = dataIdMap.getOrDefault(dataId, new HashSet<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e3f8b3b29f2ae221f3df1cae6c55065c2d7d518"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNjAxNQ==", "bodyText": "Is there a thread safety issue?", "url": "https://github.com/seata/seata/pull/3222#discussion_r512436015", "createdAt": "2020-10-27T06:06:04Z", "author": {"login": "a364176773"}, "path": "config/seata-config-core/src/main/java/io/seata/config/FileConfiguration.java", "diffHunk": "@@ -333,39 +337,45 @@ private void setFailResult(ConfigFuture configFuture) {\n      */\n     class FileListener implements ConfigurationChangeListener {\n \n-        private final String dataId;\n-        private final ConfigurationChangeListener listener;\n+        private final Map<String, Set<ConfigurationChangeListener>> dataIdMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e3f8b3b29f2ae221f3df1cae6c55065c2d7d518"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f870d1fb3700179c4f867e5f2b176680346b33b", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/6f870d1fb3700179c4f867e5f2b176680346b33b", "committedDate": "2020-10-27T07:37:47Z", "message": "optimize code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d32d464c4686889665713e7737f3bf7840e2e12c", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/d32d464c4686889665713e7737f3bf7840e2e12c", "committedDate": "2020-10-27T07:40:34Z", "message": "use concurrent safe map & set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a842ef29369257983de3d0d97907c266e1eefd0", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/7a842ef29369257983de3d0d97907c266e1eefd0", "committedDate": "2020-10-27T08:41:39Z", "message": "remove useless import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "398a57df296e061687452b2b02920966a48602fe", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/398a57df296e061687452b2b02920966a48602fe", "committedDate": "2020-10-27T09:31:28Z", "message": "synchronized"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTAzMjMy", "url": "https://github.com/seata/seata/pull/3222#pullrequestreview-517503232", "createdAt": "2020-10-27T09:34:07Z", "commit": {"oid": "398a57df296e061687452b2b02920966a48602fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7a4bf9cfc45cb8c9c28cf38e95f955e4028a0e8", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/d7a4bf9cfc45cb8c9c28cf38e95f955e4028a0e8", "committedDate": "2020-10-28T02:46:22Z", "message": "Merge branch 'develop' into optimize-use-fileListener-singleton"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4Mjk3Mzkx", "url": "https://github.com/seata/seata/pull/3222#pullrequestreview-518297391", "createdAt": "2020-10-28T03:22:40Z", "commit": {"oid": "d7a4bf9cfc45cb8c9c28cf38e95f955e4028a0e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMzoyMjo0MFrOHpYmYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMzoyMjo0MFrOHpYmYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE1NjcwNg==", "bodyText": "Why not start onProcessEvent the first time you add a listener\uff1f", "url": "https://github.com/seata/seata/pull/3222#discussion_r513156706", "createdAt": "2020-10-28T03:22:40Z", "author": {"login": "slievrly"}, "path": "config/seata-config-core/src/main/java/io/seata/config/FileConfiguration.java", "diffHunk": "@@ -83,6 +86,7 @@ public FileConfiguration() {\n         this.name = null;\n         this.targetFilePath = null;\n         this.allowDynamicRefresh = false;\n+        fileListener.onProcessEvent(new ConfigurationChangeEvent());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7a4bf9cfc45cb8c9c28cf38e95f955e4028a0e8"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa01503afcac065ff39d239c5f2a85bc50b38707", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/aa01503afcac065ff39d239c5f2a85bc50b38707", "committedDate": "2020-10-28T03:28:58Z", "message": "move onProcessEvent to first time add listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5e567a92ad93edb7e93cd2cac4c9bbe75fc40ad", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/a5e567a92ad93edb7e93cd2cac4c9bbe75fc40ad", "committedDate": "2020-10-28T03:29:17Z", "message": "Merge remote-tracking branch 'origin/optimize-use-fileListener-singleton' into optimize-use-fileListener-singleton"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MzA3NDk0", "url": "https://github.com/seata/seata/pull/3222#pullrequestreview-518307494", "createdAt": "2020-10-28T03:57:59Z", "commit": {"oid": "a5e567a92ad93edb7e93cd2cac4c9bbe75fc40ad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3471, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}