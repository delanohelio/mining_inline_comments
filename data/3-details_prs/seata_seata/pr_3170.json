{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NTIxODUw", "number": 3170, "title": "bugfix: the disposables tree set won't accept another Disposable with the same priority.", "bodyText": "Fix the following issue:\nDisposable TmNettyRemotingClient and RmNettyRemotingClient added by GlobalTransactionScanner have the same priority by default, so the RmNettyRemotingClient won't be closed gracefully during shutdown.", "createdAt": "2020-10-06T12:54:43Z", "url": "https://github.com/seata/seata/pull/3170", "merged": true, "mergeCommit": {"oid": "11ffe19aa470a3ca84a4e0dd0667449075dfb511"}, "closed": true, "closedAt": "2020-10-20T03:31:11Z", "author": {"login": "jujinghao"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP32oagH2gAyNDk4NTIxODUwOjk0YWRmMjQ5YWJlZmZiMWFmY2I1MDEzNTEzY2U4YzBmYmFiMzBmMmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUQFiZgH2gAyNDk4NTIxODUwOmIzNmE4NWJmY2EwNDg1MzVlOGJiZmUxYTc2ODMyM2ExZjA2NmMxNWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "94adf249abeffb1afcb5013513ce8c0fbab30f2b", "author": {"user": {"login": "jujinghao", "name": null}}, "url": "https://github.com/seata/seata/commit/94adf249abeffb1afcb5013513ce8c0fbab30f2b", "committedDate": "2020-10-06T12:50:33Z", "message": "bugfix: the disposables tree set won't accept another Disposable with\nthe same priority.\n\nDisposable TmNettyRemotingClient and RmNettyRemotingClient added by\nGlobalTransactionScanner have the same priority by default, so the\nRmNettyRemotingClient won't be closed gracefully during shutdown."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cf144310f9c12920514b05ec439fc2e51806152", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/4cf144310f9c12920514b05ec439fc2e51806152", "committedDate": "2020-10-10T06:08:26Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDcxMzY2", "url": "https://github.com/seata/seata/pull/3170#pullrequestreview-506071366", "createdAt": "2020-10-10T06:26:54Z", "commit": {"oid": "4cf144310f9c12920514b05ec439fc2e51806152"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81c1c2a4021e754328e0f6f6f1c878099631448f", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/81c1c2a4021e754328e0f6f6f1c878099631448f", "committedDate": "2020-10-10T07:27:58Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDc1MzQ1", "url": "https://github.com/seata/seata/pull/3170#pullrequestreview-506075345", "createdAt": "2020-10-10T07:30:39Z", "commit": {"oid": "4cf144310f9c12920514b05ec439fc2e51806152"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwNzozMTo0MlrOHfd-9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwNzozMTo0MlrOHfd-9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc1OTE1Ng==", "bodyText": "use PriorityQueue to replace TreeSet will solve this problem once and forever. No need to add a \"seqId\" to fix the probem which is actually caused by TreeSet.", "url": "https://github.com/seata/seata/pull/3170#discussion_r502759156", "createdAt": "2020-10-10T07:31:42Z", "author": {"login": "selfishlover"}, "path": "core/src/main/java/io/seata/core/rpc/ShutdownHook.java", "diffHunk": "@@ -91,35 +91,63 @@ public static void removeRuntimeShutdownHook() {\n \n     private static class DisposablePriorityWrapper implements Comparable<DisposablePriorityWrapper>, Disposable {\n \n+        private static AtomicLong seq = new AtomicLong();\n+\n         private Disposable disposable;\n \n         private int priority;\n \n+        private long seqId;\n+\n         public DisposablePriorityWrapper(Disposable disposable, int priority) {\n             this.disposable = disposable;\n             this.priority = priority;\n+            this.seqId = seq.incrementAndGet();\n         }\n \n         @Override\n         public int compareTo(DisposablePriorityWrapper disposablePriorityWrapper) {\n-            return priority - disposablePriorityWrapper.priority;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81c1c2a4021e754328e0f6f6f1c878099631448f"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1659f28c66124af2a6ce7590b944bdc5484c09d1", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/1659f28c66124af2a6ce7590b944bdc5484c09d1", "committedDate": "2020-10-12T03:21:00Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjcwMTE3", "url": "https://github.com/seata/seata/pull/3170#pullrequestreview-506270117", "createdAt": "2020-10-12T03:24:28Z", "commit": {"oid": "1659f28c66124af2a6ce7590b944bdc5484c09d1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMzoyNDoyOFrOHft4VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMzoyNjozNVrOHft55w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAxOTYwNQ==", "bodyText": "Long.compare(x, y) ?", "url": "https://github.com/seata/seata/pull/3170#discussion_r503019605", "createdAt": "2020-10-12T03:24:28Z", "author": {"login": "jsbxyyx"}, "path": "core/src/main/java/io/seata/core/rpc/ShutdownHook.java", "diffHunk": "@@ -91,35 +91,63 @@ public static void removeRuntimeShutdownHook() {\n \n     private static class DisposablePriorityWrapper implements Comparable<DisposablePriorityWrapper>, Disposable {\n \n+        private static AtomicLong seq = new AtomicLong();\n+\n         private Disposable disposable;\n \n         private int priority;\n \n+        private long seqId;\n+\n         public DisposablePriorityWrapper(Disposable disposable, int priority) {\n             this.disposable = disposable;\n             this.priority = priority;\n+            this.seqId = seq.incrementAndGet();\n         }\n \n         @Override\n         public int compareTo(DisposablePriorityWrapper disposablePriorityWrapper) {\n-            return priority - disposablePriorityWrapper.priority;\n+            int cmp = priority - disposablePriorityWrapper.priority;\n+            if (cmp == 0) {\n+                if (seqId > disposablePriorityWrapper.seqId) {\n+                    cmp = 1;\n+                } else if (seqId < disposablePriorityWrapper.seqId) {\n+                    cmp = -1;\n+                } else {\n+                    cmp = 0;\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1659f28c66124af2a6ce7590b944bdc5484c09d1"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAyMDAwNw==", "bodyText": "Objects.hash(...values)?", "url": "https://github.com/seata/seata/pull/3170#discussion_r503020007", "createdAt": "2020-10-12T03:26:35Z", "author": {"login": "jsbxyyx"}, "path": "core/src/main/java/io/seata/core/rpc/ShutdownHook.java", "diffHunk": "@@ -91,35 +91,63 @@ public static void removeRuntimeShutdownHook() {\n \n     private static class DisposablePriorityWrapper implements Comparable<DisposablePriorityWrapper>, Disposable {\n \n+        private static AtomicLong seq = new AtomicLong();\n+\n         private Disposable disposable;\n \n         private int priority;\n \n+        private long seqId;\n+\n         public DisposablePriorityWrapper(Disposable disposable, int priority) {\n             this.disposable = disposable;\n             this.priority = priority;\n+            this.seqId = seq.incrementAndGet();\n         }\n \n         @Override\n         public int compareTo(DisposablePriorityWrapper disposablePriorityWrapper) {\n-            return priority - disposablePriorityWrapper.priority;\n+            int cmp = priority - disposablePriorityWrapper.priority;\n+            if (cmp == 0) {\n+                if (seqId > disposablePriorityWrapper.seqId) {\n+                    cmp = 1;\n+                } else if (seqId < disposablePriorityWrapper.seqId) {\n+                    cmp = -1;\n+                } else {\n+                    cmp = 0;\n+                }\n+            }\n+            return cmp;\n         }\n \n         @Override\n         public int hashCode() {\n-            return Objects.hashCode(this.priority);\n+            final int prime = 31;\n+            int result = 1;\n+            result = prime * result + priority;\n+            result = prime * result + (int) (seqId ^ (seqId >>> 32));\n+            return result;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1659f28c66124af2a6ce7590b944bdc5484c09d1"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a4175529032be9bed3dc351ff4cf8ac2b429a35", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/7a4175529032be9bed3dc351ff4cf8ac2b429a35", "committedDate": "2020-10-12T14:08:20Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NjUyOTU1", "url": "https://github.com/seata/seata/pull/3170#pullrequestreview-506652955", "createdAt": "2020-10-12T14:08:24Z", "commit": {"oid": "1659f28c66124af2a6ce7590b944bdc5484c09d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NjU1MTMy", "url": "https://github.com/seata/seata/pull/3170#pullrequestreview-506655132", "createdAt": "2020-10-12T14:10:56Z", "commit": {"oid": "7a4175529032be9bed3dc351ff4cf8ac2b429a35"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDoxMDo1NlrOHgAZvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDoxMDo1OFrOHgAZ1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMyMzA3MQ==", "bodyText": "+1", "url": "https://github.com/seata/seata/pull/3170#discussion_r503323071", "createdAt": "2020-10-12T14:10:56Z", "author": {"login": "a364176773"}, "path": "core/src/main/java/io/seata/core/rpc/ShutdownHook.java", "diffHunk": "@@ -91,35 +91,63 @@ public static void removeRuntimeShutdownHook() {\n \n     private static class DisposablePriorityWrapper implements Comparable<DisposablePriorityWrapper>, Disposable {\n \n+        private static AtomicLong seq = new AtomicLong();\n+\n         private Disposable disposable;\n \n         private int priority;\n \n+        private long seqId;\n+\n         public DisposablePriorityWrapper(Disposable disposable, int priority) {\n             this.disposable = disposable;\n             this.priority = priority;\n+            this.seqId = seq.incrementAndGet();\n         }\n \n         @Override\n         public int compareTo(DisposablePriorityWrapper disposablePriorityWrapper) {\n-            return priority - disposablePriorityWrapper.priority;\n+            int cmp = priority - disposablePriorityWrapper.priority;\n+            if (cmp == 0) {\n+                if (seqId > disposablePriorityWrapper.seqId) {\n+                    cmp = 1;\n+                } else if (seqId < disposablePriorityWrapper.seqId) {\n+                    cmp = -1;\n+                } else {\n+                    cmp = 0;\n+                }\n+            }\n+            return cmp;\n         }\n \n         @Override\n         public int hashCode() {\n-            return Objects.hashCode(this.priority);\n+            final int prime = 31;\n+            int result = 1;\n+            result = prime * result + priority;\n+            result = prime * result + (int) (seqId ^ (seqId >>> 32));\n+            return result;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAyMDAwNw=="}, "originalCommit": {"oid": "1659f28c66124af2a6ce7590b944bdc5484c09d1"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMyMzA5NA==", "bodyText": "+1", "url": "https://github.com/seata/seata/pull/3170#discussion_r503323094", "createdAt": "2020-10-12T14:10:58Z", "author": {"login": "a364176773"}, "path": "core/src/main/java/io/seata/core/rpc/ShutdownHook.java", "diffHunk": "@@ -91,35 +91,63 @@ public static void removeRuntimeShutdownHook() {\n \n     private static class DisposablePriorityWrapper implements Comparable<DisposablePriorityWrapper>, Disposable {\n \n+        private static AtomicLong seq = new AtomicLong();\n+\n         private Disposable disposable;\n \n         private int priority;\n \n+        private long seqId;\n+\n         public DisposablePriorityWrapper(Disposable disposable, int priority) {\n             this.disposable = disposable;\n             this.priority = priority;\n+            this.seqId = seq.incrementAndGet();\n         }\n \n         @Override\n         public int compareTo(DisposablePriorityWrapper disposablePriorityWrapper) {\n-            return priority - disposablePriorityWrapper.priority;\n+            int cmp = priority - disposablePriorityWrapper.priority;\n+            if (cmp == 0) {\n+                if (seqId > disposablePriorityWrapper.seqId) {\n+                    cmp = 1;\n+                } else if (seqId < disposablePriorityWrapper.seqId) {\n+                    cmp = -1;\n+                } else {\n+                    cmp = 0;\n+                }\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAxOTYwNQ=="}, "originalCommit": {"oid": "1659f28c66124af2a6ce7590b944bdc5484c09d1"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bee2d313d147d207543777e59da4b244851be3a1", "author": {"user": {"login": "jujinghao", "name": null}}, "url": "https://github.com/seata/seata/commit/bee2d313d147d207543777e59da4b244851be3a1", "committedDate": "2020-10-19T02:05:55Z", "message": "Merge branch 'develop' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b36a85bfca048535e8bbfe1a768323a1f066c15f", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/b36a85bfca048535e8bbfe1a768323a1f066c15f", "committedDate": "2020-10-20T03:20:15Z", "message": "Merge branch 'develop' into develop"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3691, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}