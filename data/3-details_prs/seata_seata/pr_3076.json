{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2ODY1Mjc4", "number": 3076, "title": "feature: Check lock in TC when use @GlobalLock", "bodyText": "Check global lock retry when conflict.\n\n\n\u2160. Describe what this PR did\n\nmake @GlobalLock work Independently\nCheck global lock can retry\n\n\u2161. Does this pull request fix one issue?\n\nfixes #3067\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\ncan check lock when only use @GLobalLock\u3002\ncan retry check lock when use @GlobalLock\u3002\n\u2164. Special notes for reviews", "createdAt": "2020-09-01T07:03:38Z", "url": "https://github.com/seata/seata/pull/3076", "merged": true, "mergeCommit": {"oid": "081ca51299857cf917d4ec90e4682dde92398e48"}, "closed": true, "closedAt": "2020-10-25T03:11:09Z", "author": {"login": "caohdgege"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEhNmJgH2gAyNDc2ODY1Mjc4OmQ5YzYwOGUwZDVlNjY0NGI1ZjlhM2JhZDBmZWRjYzYyNDhmZTU2ZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdV2y2yAH2gAyNDc2ODY1Mjc4OjY5ODQ4OGUxOTEzZjNiYTcyN2EyODI2YTY4YTFiMjFjOWYyY2Y1OTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d9c608e0d5e6644b5f9a3bad0fedcc6248fe56f4", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/d9c608e0d5e6644b5f9a3bad0fedcc6248fe56f4", "committedDate": "2020-09-01T06:14:39Z", "message": "optimize: 1. check global lock when use @GlobalLock Independently.\n2. Check global lock retry when conflict."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9c129d4797550f6b956f7edcdf77b8f1a69e853", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/a9c129d4797550f6b956f7edcdf77b8f1a69e853", "committedDate": "2020-09-01T07:28:34Z", "message": "optimize code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c2212d89efcfc9757df3a2b4b47f0b0f6b4e475", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/6c2212d89efcfc9757df3a2b4b47f0b0f6b4e475", "committedDate": "2020-09-01T09:18:35Z", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57d1b6860e55e38ce10592c2b63047600201118", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/d57d1b6860e55e38ce10592c2b63047600201118", "committedDate": "2020-09-03T13:05:57Z", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1ODA1MTAz", "url": "https://github.com/seata/seata/pull/3076#pullrequestreview-485805103", "createdAt": "2020-09-10T10:42:59Z", "commit": {"oid": "d57d1b6860e55e38ce10592c2b63047600201118"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMDo0MzowMFrOHPtvgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMDo0MzowMFrOHPtvgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI0MDEzMA==", "bodyText": "it's not consistent with the previous meaning", "url": "https://github.com/seata/seata/pull/3076#discussion_r486240130", "createdAt": "2020-09-10T10:43:00Z", "author": {"login": "slievrly"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java", "diffHunk": "@@ -113,7 +111,13 @@ public T doExecute(Object... args) throws Throwable {\n                     } else {\n                         conn.rollback();\n                     }\n-                    lockRetryController.sleep(lce);\n+\n+                    // retry hear only when the config is true\n+                    if (LockRetryPolicy.isLockRetryPolicyBranchRollbackOnConflict()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d57d1b6860e55e38ce10592c2b63047600201118"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "485ca9c2f3d8f0ea48a907f4e1a7db711f2d8ef3", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/485ca9c2f3d8f0ea48a907f4e1a7db711f2d8ef3", "committedDate": "2020-09-13T04:13:06Z", "message": "retry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ced5038437960b45f03886daa6c39d21c78fca9", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/8ced5038437960b45f03886daa6c39d21c78fca9", "committedDate": "2020-09-13T04:50:13Z", "message": "Merge remote-tracking branch 'origin/feature-check-lock-GlobalLock' into feature-check-lock-GlobalLock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8b149fd01fab76b1b3ae57fa2ca0681caeb7fbc", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/c8b149fd01fab76b1b3ae57fa2ca0681caeb7fbc", "committedDate": "2020-09-14T15:19:48Z", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2e17a7509a32bcf5fb49fa04ed4c5784a0a2a9d", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/d2e17a7509a32bcf5fb49fa04ed4c5784a0a2a9d", "committedDate": "2020-09-18T10:13:51Z", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4afe444ddd9aa2b5d73d5bb0298589f549dbdc4", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/c4afe444ddd9aa2b5d73d5bb0298589f549dbdc4", "committedDate": "2020-09-28T09:33:58Z", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "793bb2b7e6ac54905bace1b771ccfdd36a649ab2", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/793bb2b7e6ac54905bace1b771ccfdd36a649ab2", "committedDate": "2020-10-13T14:00:55Z", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock\n\n# Conflicts:\n#\trm-datasource/src/main/java/io/seata/rm/datasource/exec/AbstractDMLBaseExecutor.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4af642fc46ec84554556b8e6e3c295d926eb7a2", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/b4af642fc46ec84554556b8e6e3c295d926eb7a2", "committedDate": "2020-10-13T14:02:43Z", "message": "solve the conflict and modify code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ca5ef6e420b81e96f5de7bfa8f19dc99e60be2d", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/5ca5ef6e420b81e96f5de7bfa8f19dc99e60be2d", "committedDate": "2020-10-13T14:03:32Z", "message": "Merge remote-tracking branch 'origin/feature-check-lock-GlobalLock' into feature-check-lock-GlobalLock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6a42c92049253845d8da056c8e3c288bd6b0e23", "author": {"user": {"login": "a364176773", "name": "FUNKYE"}}, "url": "https://github.com/seata/seata/commit/b6a42c92049253845d8da056c8e3c288bd6b0e23", "committedDate": "2020-10-21T06:39:01Z", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9508ede9d1fb954ecd2267019e6f548fff0d4f7f", "author": {"user": {"login": "slievrly", "name": "jimin"}}, "url": "https://github.com/seata/seata/commit/9508ede9d1fb954ecd2267019e6f548fff0d4f7f", "committedDate": "2020-10-22T09:25:52Z", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NTM1MzEw", "url": "https://github.com/seata/seata/pull/3076#pullrequestreview-514535310", "createdAt": "2020-10-22T09:31:50Z", "commit": {"oid": "9508ede9d1fb954ecd2267019e6f548fff0d4f7f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MjY2OTU0", "url": "https://github.com/seata/seata/pull/3076#pullrequestreview-516266954", "createdAt": "2020-10-24T10:23:37Z", "commit": {"oid": "9508ede9d1fb954ecd2267019e6f548fff0d4f7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxMDoyMzozN1rOHnsSVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxMDoyMzozN1rOHnsSVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM4MjEwMg==", "bodyText": "Is it better to comment the code like \"Do the same thing under either @GlobalTransactional or @GlobalLock, that only check the global lock here.\" or something else more accurate? There is nothing about \u201ckey appending\u201d in the new code block, so the comment could be a little puzzling.", "url": "https://github.com/seata/seata/pull/3076#discussion_r511382102", "createdAt": "2020-10-24T10:23:37Z", "author": {"login": "ggndnn"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/SelectForUpdateExecutor.java", "diffHunk": "@@ -96,13 +96,11 @@ public T doExecute(Object... args) throws Throwable {\n                         break;\n                     }\n \n-                    if (RootContext.inGlobalTransaction()) {\n-                        //do as usual\n+                    if (RootContext.inGlobalTransaction() || RootContext.requireGlobalLock()) {\n+                        // do as usual\n+                        // in @GlobalLock env, don't need to append key eithor,\n+                        // but check lock hear, do the same thing as @GlobalTransactional env", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9508ede9d1fb954ecd2267019e6f548fff0d4f7f"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MjY3MDY4", "url": "https://github.com/seata/seata/pull/3076#pullrequestreview-516267068", "createdAt": "2020-10-24T10:25:46Z", "commit": {"oid": "9508ede9d1fb954ecd2267019e6f548fff0d4f7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxMDoyNTo0N1rOHnsV1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxMDoyNTo0N1rOHnsV1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM4Mjk5OQ==", "bodyText": "What's this line deleting for? Is it necessary?", "url": "https://github.com/seata/seata/pull/3076#discussion_r511382999", "createdAt": "2020-10-24T10:25:47Z", "author": {"login": "ggndnn"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/BaseTransactionalExecutor.java", "diffHunk": "@@ -407,5 +407,4 @@ protected TableRecords buildTableRecords(Map<String, List<Object>> pkValuesMap)\n     protected String getDbType() {\n         return statementProxy.getConnectionProxy().getDbType();\n     }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9508ede9d1fb954ecd2267019e6f548fff0d4f7f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da7a75f1ec39e7758626b6c6bed603be40b8af12", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/da7a75f1ec39e7758626b6c6bed603be40b8af12", "committedDate": "2020-10-24T11:25:58Z", "message": "modify note"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dac24dfb28f19442847c3d776fa9c3d6a440175", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/1dac24dfb28f19442847c3d776fa9c3d6a440175", "committedDate": "2020-10-24T11:32:00Z", "message": "optimize: notes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c7ae29c85eb90b63007c7f1e09ff664a29fffa3", "author": {"user": {"login": "caohdgege", "name": "chd"}}, "url": "https://github.com/seata/seata/commit/7c7ae29c85eb90b63007c7f1e09ff664a29fffa3", "committedDate": "2020-10-24T14:57:30Z", "message": "add empty line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MzIwNzU5", "url": "https://github.com/seata/seata/pull/3076#pullrequestreview-516320759", "createdAt": "2020-10-25T02:58:21Z", "commit": {"oid": "7c7ae29c85eb90b63007c7f1e09ff664a29fffa3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "698488e1913f3ba727a2826a68a1b21c9f2cf591", "author": {"user": {"login": "ggndnn", "name": null}}, "url": "https://github.com/seata/seata/commit/698488e1913f3ba727a2826a68a1b21c9f2cf591", "committedDate": "2020-10-25T03:00:04Z", "message": "Merge branch 'develop' into feature-check-lock-GlobalLock"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3639, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}