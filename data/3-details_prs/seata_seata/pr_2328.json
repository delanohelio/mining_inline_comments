{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyMjA4ODc5", "number": 2328, "title": "feature: mysql 5.x and 8.x jdbc drivers coexist in the server", "bodyText": "\u2160. Describe what this PR did\nThis PR provided a feature that mysql 5.x and 8.x jdbc drivers coexist in the server to fix issues like #2116.\n\nMade use of DriverClassLoader to load mysql 5.x and 8.x driver separately.\nMoved mysql driver jar from classpath to special location that the mysql drivers can coexist.\nUpgraded dbcp to avoid loading error (https://issues.apache.org/jira/browse/DBCP-333).\nDetermined different drivers according to driverClassName:\n\nstore.db.driverClassName=com.mysql.jdbc.Driver -> mysql 5.x\nstore.db.driverClassName=com.mysql.cj.jdbc.Driver -> mysql 8.x\n\n\nTested following combinations:\n\ndbcp + mysql-connector-java-5.1.30\ndbcp + mysql-connector-java-8.0.19\ndruid + mysql-connector-java-5.1.30\ndruid + mysql-connector-java-8.0.19\n\n\u2161. Does this pull request fix one issue?\n\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-03-02T06:58:21Z", "url": "https://github.com/seata/seata/pull/2328", "merged": true, "mergeCommit": {"oid": "dc67bebe28e714d44c61ec6964081f5adcf1986b"}, "closed": true, "closedAt": "2020-03-07T07:33:56Z", "author": {"login": "ggndnn"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKXecwABqjMwOTY2NTE4OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcK8lbxgBqjMxMDQ1NzYwODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a38193f148ff4591fa187805f0613e4023393ee3", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/a38193f148ff4591fa187805f0613e4023393ee3", "committedDate": "2020-03-02T12:34:21Z", "message": "Merge branch 'develop' into mysql_multi_version"}, "afterCommit": {"oid": "d733ae4c903c75d23f9cc06a0013f2d5730e118f", "author": {"user": {"login": "ggndnn", "name": null}}, "url": "https://github.com/seata/seata/commit/d733ae4c903c75d23f9cc06a0013f2d5730e118f", "committedDate": "2020-03-04T14:05:46Z", "message": "feature: mysql 5.x and 8.x jdbc drivers coexist in server"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NjM0ODE3", "url": "https://github.com/seata/seata/pull/2328#pullrequestreview-368634817", "createdAt": "2020-03-04T09:49:30Z", "commit": {"oid": "a38193f148ff4591fa187805f0613e4023393ee3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwOTo0OTozMFrOFxmcQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwOTo0OTozMFrOFxmcQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU1NDM3MA==", "bodyText": "what circumstances will this happen\uff1f", "url": "https://github.com/seata/seata/pull/2328#discussion_r387554370", "createdAt": "2020-03-04T09:49:30Z", "author": {"login": "slievrly"}, "path": "core/src/main/java/io/seata/core/store/db/AbstractDataSourceGenerator.java", "diffHunk": "@@ -61,6 +81,53 @@ protected String getDriverClassName() {\n         return driverClassName;\n     }\n \n+    protected ClassLoader getDriverClassLoader() {\n+        return MYSQL_DRIVER_LOADERS.getOrDefault(getDriverClassName(), ClassLoader.getSystemClassLoader());\n+    }\n+\n+    private static Map<String, ClassLoader> createMysqlDriverClassLoaders() {\n+        Map<String, ClassLoader> loaders = new HashMap<>();\n+        String cp = System.getProperty(\"java.class.path\");\n+        if (cp == null || cp.isEmpty()) {\n+            return loaders;\n+        }\n+        Stream.of(cp.split(File.pathSeparator))\n+                .map(File::new)\n+                .filter(File::exists)\n+                .map(file -> file.isFile() ? file.getParentFile() : file)\n+                .filter(Objects::nonNull)\n+                .filter(File::isDirectory)\n+                .map(file -> new File(file, \"jdbc\"))\n+                .filter(File::exists)\n+                .filter(File::isDirectory)\n+                .distinct()\n+                .flatMap(file -> {\n+                    File[] files = file.listFiles((f, name) -> name.startsWith(MYSQL_DRIVER_FILE_PREFIX));\n+                    if (files != null) {\n+                        return Stream.of(files);\n+                    } else {\n+                        return Stream.of();\n+                    }\n+                })\n+                .forEach(file -> {\n+                    if (loaders.containsKey(MYSQL8_DRIVER_CLASS_NAME) && loaders.containsKey(MYSQL_DRIVER_CLASS_NAME)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a38193f148ff4591fa187805f0613e4023393ee3"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MjY4MTYy", "url": "https://github.com/seata/seata/pull/2328#pullrequestreview-369268162", "createdAt": "2020-03-05T03:03:08Z", "commit": {"oid": "d733ae4c903c75d23f9cc06a0013f2d5730e118f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMDU0NTg5", "url": "https://github.com/seata/seata/pull/2328#pullrequestreview-370054589", "createdAt": "2020-03-06T02:55:53Z", "commit": {"oid": "d733ae4c903c75d23f9cc06a0013f2d5730e118f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b821e25d03c27ef81fdac7989db5ff172ffc03b2", "author": {"user": {"login": "ggndnn", "name": null}}, "url": "https://github.com/seata/seata/commit/b821e25d03c27ef81fdac7989db5ff172ffc03b2", "committedDate": "2020-03-06T09:19:53Z", "message": "feature: mysql 5.x and 8.x jdbc drivers coexist in server"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee86710cd48367c3727aa02d2648417d48897460", "author": {"user": {"login": "ggndnn", "name": null}}, "url": "https://github.com/seata/seata/commit/ee86710cd48367c3727aa02d2648417d48897460", "committedDate": "2020-03-06T08:59:11Z", "message": "Merge branch 'develop' into mysql_multi_version"}, "afterCommit": {"oid": "b821e25d03c27ef81fdac7989db5ff172ffc03b2", "author": {"user": {"login": "ggndnn", "name": null}}, "url": "https://github.com/seata/seata/commit/b821e25d03c27ef81fdac7989db5ff172ffc03b2", "committedDate": "2020-03-06T09:19:53Z", "message": "feature: mysql 5.x and 8.x jdbc drivers coexist in server"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4035, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}