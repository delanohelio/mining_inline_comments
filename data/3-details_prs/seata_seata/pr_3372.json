{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5MjI1NjQ0", "number": 3372, "title": "feature: Saga support customize whether update last retry log", "bodyText": "\u2160. Describe what this PR did\nadd config for saga, support customize whether update last retry log\n\u63d0\u4f9b\u914d\u7f6e\uff0c\u53ef\u81ea\u5b9a\u4e49\u6b63\u5411\u91cd\u8bd5\u548c\u53cd\u5411\u8865\u507f\u91cd\u8bd5\u7684\u65e5\u5fd7\u5b58\u50a8\u7b56\u7565\uff0c\u652f\u6301\u5728\u4e0a\u4e00\u6b21\u91cd\u8bd5\u65e5\u5fd7\u7684\u57fa\u7840\u4e0a\uff0c\u505a\u66f4\u65b0\u64cd\u4f5c\n\u63d0\u4f9b\u5168\u5c40\u914d\u7f6e\u53c2\u6570\uff1aclient.rm.sagaRetryPersistModeUpdate\u3001client.rm.sagaCompensatePersistModeUpdate\uff0c\u9ed8\u8ba4\u4e3a false\n\u63d0\u4f9b\u72b6\u6001\u673a\u7ea7\u522b\u3001\u5355\u4e2a\u72b6\u6001\u8282\u70b9\u914d\u7f6e\u53c2\u6570\uff1aretryPersistModeUpdate\u3001compensatePersistModeUpdate\uff0c\u9ed8\u8ba4\u4e3a false\n\u5f53 client.rm.sagaRetryPersistModeUpdate \u6216 retryPersistModeUpdate \u914d\u7f6e\u4e3atrue\u65f6\uff0c\u5f53\u524d\u4e8b\u52a1\u8282\u70b9\u7684\u91cd\u8bd5\uff0c\u57fa\u4e8e\u5f53\u524d\u9700\u8981\u91cd\u8bd5\u7684\u4e8b\u52a1\u65e5\u5fd7\u505a\u66f4\u65b0\uff0c\u800c\u4e0d\u662f\u65b0\u589e\u4e00\u6761\u91cd\u8bd5\u65e5\u5fd7\uff08compensate \u53c2\u6570\u540c\u7406\uff09\n\u2161. Does this pull request fix one issue?\n\nfixes #3394\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-12-14T07:44:16Z", "url": "https://github.com/seata/seata/pull/3372", "merged": true, "mergeCommit": {"oid": "491a9d75de45a103e7c80a01853a1e552f7316b4"}, "closed": true, "closedAt": "2020-12-24T03:36:08Z", "author": {"login": "anselleeyy"}, "timelineItems": {"totalCount": 42, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmArHVgH2gAyNTM5MjI1NjQ0Ojc2MjVlNDBhNWM3MDJkYzBjNTBlNzhhZDExMGZkNGUwNzJmZWRmNGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdpLQ80AFqTU1ODMyMDY1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7625e40a5c702dc0c50e78ad110fd4e072fedf4f", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/7625e40a5c702dc0c50e78ad110fd4e072fedf4f", "committedDate": "2020-12-14T07:33:27Z", "message": "feature: support customize if persist retry and compensate execution log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b44e65feac2944d1983c8314ba72f37b503af49b", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/b44e65feac2944d1983c8314ba72f37b503af49b", "committedDate": "2020-12-14T07:41:29Z", "message": "Merge remote-tracking branch 'upstream/develop' into feature/customize_persist_retryInst_log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61dcdc1165e2f3a078357fe9aff3bb19777f4323", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/61dcdc1165e2f3a078357fe9aff3bb19777f4323", "committedDate": "2020-12-14T07:55:37Z", "message": "fix codestyle problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b55d8490923132a8185c1774fee56395b353e7fc", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/b55d8490923132a8185c1774fee56395b353e7fc", "committedDate": "2020-12-14T08:01:42Z", "message": "fix codestyle problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67c6e490f03c536217f8d8653850f6cd1dba0d8e", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/67c6e490f03c536217f8d8653850f6cd1dba0d8e", "committedDate": "2020-12-14T09:21:50Z", "message": "support spring boot auto configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8c0855107443c14451938ecf2a9a9eb6610dd8a", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/f8c0855107443c14451938ecf2a9a9eb6610dd8a", "committedDate": "2020-12-14T09:22:17Z", "message": "Merge remote-tracking branch 'upstream/develop' into feature/customize_persist_retryInst_log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe492e0515465e4a526027c58d712e9d74dd346b", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/fe492e0515465e4a526027c58d712e9d74dd346b", "committedDate": "2020-12-16T03:52:29Z", "message": "fix compensate state type is subMachine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5da96c036e49d87887f03d483e2d1d4828683a7", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/c5da96c036e49d87887f03d483e2d1d4828683a7", "committedDate": "2020-12-16T05:11:00Z", "message": "Merge remote-tracking branch 'upstream/develop' into feature/customize_persist_retryInst_log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6551d2c77709ce0a3e109dcb7d93a5f152a378d", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/f6551d2c77709ce0a3e109dcb7d93a5f152a378d", "committedDate": "2020-12-16T06:39:10Z", "message": "add script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d93fc0f2c0616a6e57b49f0504d784a799f873f", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/5d93fc0f2c0616a6e57b49f0504d784a799f873f", "committedDate": "2020-12-16T09:40:35Z", "message": "remove unnecessary code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b82ef137c92f247eb2553609714133e4903c391b", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/b82ef137c92f247eb2553609714133e4903c391b", "committedDate": "2020-12-16T09:41:12Z", "message": "remove gmt_updated column"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf31c169f063a66b30a02c29d82edf0c648fe2d3", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/cf31c169f063a66b30a02c29d82edf0c648fe2d3", "committedDate": "2020-12-16T13:51:24Z", "message": "change naming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjQ3Nzk0", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-554247794", "createdAt": "2020-12-17T03:07:33Z", "commit": {"oid": "cf31c169f063a66b30a02c29d82edf0c648fe2d3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMzowNzozM1rOIHinPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMzowOTo1MFrOIHiqCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc3ODA0NA==", "bodyText": "\u8fd9\u4e2a\u53d8\u91cf\u53eb isUpdateMode = false; \u662f\u4e0d\u662f\u66f4\u5408\u9002\uff0c\u56e0\u4e3a\u5e76\u4e0d\u662f\u4e0dpersist", "url": "https://github.com/seata/seata/pull/3372#discussion_r544778044", "createdAt": "2020-12-17T03:07:33Z", "author": {"login": "long187"}, "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "diffHunk": "@@ -263,28 +266,47 @@ public void recordStateMachineRestarted(StateMachineInstance machineInstance, Pr\n     @Override\n     public void recordStateStarted(StateInstance stateInstance, ProcessContext context) {\n         if (stateInstance != null) {\n-            //if this state is for retry, do not register branch, but generate id\n-            if (StringUtils.hasLength(stateInstance.getStateIdRetriedFor())) {\n \n-                stateInstance.setId(generateRetryStateInstanceId(stateInstance));\n-            }\n-            //if this state is for compensation, do not register branch, but generate id\n-            else if (StringUtils.hasLength(stateInstance.getStateIdCompensatedFor())) {\n+            boolean isPersist = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf31c169f063a66b30a02c29d82edf0c648fe2d3"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc3ODc2Mg==", "bodyText": "\u8fd9\u91cc\u7528id\u662f\u4e0d\u662f-1\u7ed3\u5c3e\u5224\u65ad\u53ef\u80fd\u5bb9\u6613\u7559\u5751\uff0c\u5982\u679cid\u751f\u6210\u89c4\u5219\u53d8\u4e86\u3002\u5efa\u8bae\u662f\u7528tateIdCompensatedFor\u627e\u5230\u539fstateInstace\uff0c\u7136\u540estateInstace.getCompensationState()\u6765\u53d6\u5b83\u4e0a\u4e00\u6b21\u7684\u8865\u507f\u670d\u52a1\u7684id", "url": "https://github.com/seata/seata/pull/3372#discussion_r544778762", "createdAt": "2020-12-17T03:09:50Z", "author": {"login": "long187"}, "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "diffHunk": "@@ -263,28 +266,47 @@ public void recordStateMachineRestarted(StateMachineInstance machineInstance, Pr\n     @Override\n     public void recordStateStarted(StateInstance stateInstance, ProcessContext context) {\n         if (stateInstance != null) {\n-            //if this state is for retry, do not register branch, but generate id\n-            if (StringUtils.hasLength(stateInstance.getStateIdRetriedFor())) {\n \n-                stateInstance.setId(generateRetryStateInstanceId(stateInstance));\n-            }\n-            //if this state is for compensation, do not register branch, but generate id\n-            else if (StringUtils.hasLength(stateInstance.getStateIdCompensatedFor())) {\n+            boolean isPersist = true;\n \n-                stateInstance.setId(generateCompensateStateInstanceId(stateInstance));\n+            // if this state is for retry, do not register branch\n+            if (StringUtils.hasLength(stateInstance.getStateIdRetriedFor())) {\n+                if (!isUpdateMode(stateInstance, context)) {\n+                    // generate id by default\n+                    stateInstance.setId(generateRetryStateInstanceId(stateInstance));\n+                } else {\n+                    stateInstance.setId(stateInstance.getStateIdRetriedFor());\n+                    isPersist = false;\n+                }\n             }\n-            else {\n+            // if this state is for compensation, do not register branch\n+            else if (StringUtils.hasLength(stateInstance.getStateIdCompensatedFor())) {\n+                String compensateStateInstanceId = generateCompensateStateInstanceId(stateInstance);\n+                // generate id by default or first compensation\n+                if (compensateStateInstanceId.endsWith(\"-1\") || !isUpdateMode(stateInstance, context)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf31c169f063a66b30a02c29d82edf0c648fe2d3"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca3040ee441b70166a9a526bd03760ecccceb841", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/ca3040ee441b70166a9a526bd03760ecccceb841", "committedDate": "2020-12-17T10:46:22Z", "message": "fix report branch status bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d68cc73f88279d25f5ee0402a70ae7c13651bd9", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/0d68cc73f88279d25f5ee0402a70ae7c13651bd9", "committedDate": "2020-12-17T12:47:39Z", "message": "optimize code & fix wrong status check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40c7c67791a2109c2a2f164dd3108cca4578a621", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/40c7c67791a2109c2a2f164dd3108cca4578a621", "committedDate": "2020-12-21T10:23:58Z", "message": "fix subMachine compensate update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d184c688928882d2e477ea1dc6bc6c86fd2a689", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/9d184c688928882d2e477ea1dc6bc6c86fd2a689", "committedDate": "2020-12-21T10:32:52Z", "message": "optimize code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8333903d5a402c2d5c8237a19a69b269cbc6a797", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/8333903d5a402c2d5c8237a19a69b269cbc6a797", "committedDate": "2020-12-21T10:42:01Z", "message": "remove useless code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebe6140c9c0fbf5f250437298b2ae17751e38ff8", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/ebe6140c9c0fbf5f250437298b2ae17751e38ff8", "committedDate": "2020-12-21T10:48:47Z", "message": "optimize code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4638c49f64b3082899caaf68ac65bfad2c8689fd", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/4638c49f64b3082899caaf68ac65bfad2c8689fd", "committedDate": "2020-12-21T10:51:36Z", "message": "Merge branch 'develop' into feature/customize_persist_retryInst_log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MzM5MTU1", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556339155", "createdAt": "2020-12-21T12:19:55Z", "commit": {"oid": "4638c49f64b3082899caaf68ac65bfad2c8689fd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMjoxOTo1NlrOIJWbcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMjoxOTo1NlrOIJWbcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY3NTU2OQ==", "bodyText": "\u6b64\u5904\u7b80\u5316\u6210\uff1astateInstance.setId(generateCompensateStateInstanceId(stateInstance, isUpdateMode)); \u5373\u53ef", "url": "https://github.com/seata/seata/pull/3372#discussion_r546675569", "createdAt": "2020-12-21T12:19:56Z", "author": {"login": "long187"}, "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "diffHunk": "@@ -263,28 +262,43 @@ public void recordStateMachineRestarted(StateMachineInstance machineInstance, Pr\n     @Override\n     public void recordStateStarted(StateInstance stateInstance, ProcessContext context) {\n         if (stateInstance != null) {\n-            //if this state is for retry, do not register branch, but generate id\n-            if (StringUtils.hasLength(stateInstance.getStateIdRetriedFor())) {\n \n-                stateInstance.setId(generateRetryStateInstanceId(stateInstance));\n-            }\n-            //if this state is for compensation, do not register branch, but generate id\n-            else if (StringUtils.hasLength(stateInstance.getStateIdCompensatedFor())) {\n+            boolean isUpdateMode = isUpdateMode(stateInstance, context);\n \n-                stateInstance.setId(generateCompensateStateInstanceId(stateInstance));\n+            // if this state is for retry, do not register branch\n+            if (StringUtils.hasLength(stateInstance.getStateIdRetriedFor())) {\n+                if (isUpdateMode) {\n+                    stateInstance.setId(stateInstance.getStateIdRetriedFor());\n+                } else {\n+                    // generate id by default\n+                    stateInstance.setId(generateRetryStateInstanceId(stateInstance));\n+                }\n             }\n-            else {\n+            // if this state is for compensation, do not register branch\n+            else if (StringUtils.hasLength(stateInstance.getStateIdCompensatedFor())) {\n+                if (isUpdateMode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4638c49f64b3082899caaf68ac65bfad2c8689fd"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad019755836f224cd406471d77f29d3dc19dbbb7", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/ad019755836f224cd406471d77f29d3dc19dbbb7", "committedDate": "2020-12-21T13:59:35Z", "message": "merge code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2Nzc3NDE3", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556777417", "createdAt": "2020-12-22T02:21:00Z", "commit": {"oid": "ad019755836f224cd406471d77f29d3dc19dbbb7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2Nzg4NjUx", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556788651", "createdAt": "2020-12-22T03:00:07Z", "commit": {"oid": "ad019755836f224cd406471d77f29d3dc19dbbb7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMzowMDowOFrOIJsrpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMzowMDowOFrOIJsrpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0MDE2NQ==", "bodyText": "\u6211\u8ba4\u4e3a\u8fd8\u662f\u6dfb\u52a0\u4e00\u4e2agmt_updated\u5b57\u6bb5\u6bd4\u8f83\u597d\u5427\u3002", "url": "https://github.com/seata/seata/pull/3372#discussion_r547040165", "createdAt": "2020-12-22T03:00:08Z", "author": {"login": "wangliang181230"}, "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/StateLogStoreSqls.java", "diffHunk": "@@ -76,7 +76,7 @@\n         + \"AND machine_inst_id = ?\";\n \n     private static final String UPDATE_STATE_EXECUTION_STATUS_SQL\n-        = \"UPDATE ${TABLE_PREFIX}state_inst SET status = ? WHERE machine_inst_id = ? AND id = ?\";\n+        = \"UPDATE ${TABLE_PREFIX}state_inst SET status = ?, gmt_started = ? WHERE machine_inst_id = ? AND id = ?\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad019755836f224cd406471d77f29d3dc19dbbb7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53cecf47f2fadb8853649256036510b5fdd4736a", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/53cecf47f2fadb8853649256036510b5fdd4736a", "committedDate": "2020-12-22T04:45:31Z", "message": "add gmt_updated column"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2ODQxNTk1", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556841595", "createdAt": "2020-12-22T06:12:44Z", "commit": {"oid": "53cecf47f2fadb8853649256036510b5fdd4736a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNjoxMjo0NFrOIJvnfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNjoxMjo0NFrOIJvnfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4ODI1Mw==", "bodyText": "gmt_updated\u6700\u597d\u662f\u5141\u8bb8null\u5427\uff0c\u56e0\u4e3a\u6570\u636e\u5e93\u52a0\u4e86\u5b57\u6bb5\u540e\uff0c\u5e94\u7528\u8fd8\u6ca1\u6709\u5347\u7ea7\uff0c\u8001\u7684\u4ee3\u7801\u4e0d\u4f1a\u66f4\u65b0\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u8fd9\u65f6SQL\u53ef\u80fd\u4f1a\u62a5\u9519\u3002", "url": "https://github.com/seata/seata/pull/3372#discussion_r547088253", "createdAt": "2020-12-22T06:12:44Z", "author": {"login": "long187"}, "path": "script/client/saga/db/mysql.sql", "diffHunk": "@@ -57,6 +57,7 @@ CREATE TABLE IF NOT EXISTS `seata_state_inst`\n     `output_params`            TEXT COMMENT 'output parameters',\n     `status`                   VARCHAR(2)   NOT NULL COMMENT 'status(SU succeed|FA failed|UN unknown|SK skipped|RU running)',\n     `excep`                    BLOB COMMENT 'exception',\n+    `gmt_updated`              DATETIME(3) NOT NULL COMMENT 'update time',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53cecf47f2fadb8853649256036510b5fdd4736a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/147af4507ab33b83b874b6de5b31c9bf291ed23d", "committedDate": "2020-12-22T06:25:31Z", "message": "allow gmt_updated be null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2ODU5Mzg2", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556859386", "createdAt": "2020-12-22T07:00:52Z", "commit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTIxMjIy", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556921222", "createdAt": "2020-12-22T09:02:27Z", "commit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTowMjoyN1rOIJzldA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTowMjoyN1rOIJzldA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE1MzI2OA==", "bodyText": "@Override", "url": "https://github.com/seata/seata/pull/3372#discussion_r547153268", "createdAt": "2020-12-22T09:02:27Z", "author": {"login": "wangliang181230"}, "path": "saga/seata-saga-statelang/src/main/java/io/seata/saga/statelang/domain/impl/StateMachineImpl.java", "diffHunk": "@@ -189,4 +194,20 @@ public Date getGmtCreate() {\n     public void setGmtCreate(Date gmtCreate) {\n         this.gmtCreate = gmtCreate;\n     }\n+\n+    public boolean isRetryPersistModeUpdate() {\n+        return retryPersistModeUpdate;\n+    }\n+\n+    public void setRetryPersistModeUpdate(boolean retryPersistModeUpdate) {\n+        this.retryPersistModeUpdate = retryPersistModeUpdate;\n+    }\n+\n+    public boolean isCompensatePersistModeUpdate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTIxMjU2", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556921256", "createdAt": "2020-12-22T09:02:30Z", "commit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTowMjozMFrOIJzliA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTowMjozMFrOIJzliA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE1MzI4OA==", "bodyText": "@Override", "url": "https://github.com/seata/seata/pull/3372#discussion_r547153288", "createdAt": "2020-12-22T09:02:30Z", "author": {"login": "wangliang181230"}, "path": "saga/seata-saga-statelang/src/main/java/io/seata/saga/statelang/domain/impl/StateMachineImpl.java", "diffHunk": "@@ -189,4 +194,20 @@ public Date getGmtCreate() {\n     public void setGmtCreate(Date gmtCreate) {\n         this.gmtCreate = gmtCreate;\n     }\n+\n+    public boolean isRetryPersistModeUpdate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTIzODI1", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556923825", "createdAt": "2020-12-22T09:06:43Z", "commit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTowNjo0M1rOIJztiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTowNjo0M1rOIJztiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE1NTMzOQ==", "bodyText": "Boolean\u4e0d\u9700\u8981\u6dfb\u52a0hints\uff0c\u9ed8\u8ba4\u503c\u5df2\u7ecf\u663e\u793a\u5728\u63d0\u793a\u8bed\u4e2d\u4e86\u7684\u3002\n\u4f8b\uff1a", "url": "https://github.com/seata/seata/pull/3372#discussion_r547155339", "createdAt": "2020-12-22T09:06:43Z", "author": {"login": "wangliang181230"}, "path": "seata-spring-boot-starter/src/main/resources/META-INF/additional-spring-configuration-metadata.json", "diffHunk": "@@ -345,6 +357,30 @@\n         }\n       ]\n     },\n+    {\n+      \"name\": \"seata.client.rm.saga-retry-persist-mode-update\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTI0Mjcy", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556924272", "createdAt": "2020-12-22T09:07:24Z", "commit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTowNzoyNFrOIJzu3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOTowNzoyNFrOIJzu3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE1NTY3Nw==", "bodyText": "false\u4e0d\u9700\u8981\u53cc\u5f15\u53f7\u3002\n\u4e0b\u540c\u3002", "url": "https://github.com/seata/seata/pull/3372#discussion_r547155677", "createdAt": "2020-12-22T09:07:24Z", "author": {"login": "wangliang181230"}, "path": "seata-spring-boot-starter/src/main/resources/META-INF/additional-spring-configuration-metadata.json", "diffHunk": "@@ -72,6 +72,18 @@\n       \"sourceType\": \"io.seata.spring.boot.autoconfigure.properties.client.RmProperties\",\n       \"defaultValue\": \"fastjson\"\n     },\n+    {\n+      \"name\": \"seata.client.rm.saga-retry-persist-mode-update\",\n+      \"type\": \"java.lang.Boolean\",\n+      \"sourceType\": \"io.seata.spring.boot.autoconfigure.properties.client.RmProperties\",\n+      \"defaultValue\": \"false\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTI4Nzk5", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556928799", "createdAt": "2020-12-22T09:14:28Z", "commit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOToxNDoyOFrOIJz8Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOToxNDoyOFrOIJz8Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE1OTEzMQ==", "bodyText": "\u6211\u8ba4\u4e3a\u8fd9\u4e24\u4e2a\u914d\u7f6e\u9879\u7684\u503c\u5e94\u6539\u4e3aBoolean\u3002", "url": "https://github.com/seata/seata/pull/3372#discussion_r547159131", "createdAt": "2020-12-22T09:14:28Z", "author": {"login": "wangliang181230"}, "path": "saga/seata-saga-statelang/src/main/java/io/seata/saga/statelang/domain/StateMachine.java", "diffHunk": "@@ -142,6 +142,20 @@\n      */\n     boolean isPersist();\n \n+    /**\n+     * Is update last retry execution log, default append new\n+     *\n+     * @return\n+     */\n+    boolean isRetryPersistModeUpdate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTI5MTE0", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556929114", "createdAt": "2020-12-22T09:14:59Z", "commit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOToxNDo1OVrOIJz9VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOToxNDo1OVrOIJz9VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE1OTM4MQ==", "bodyText": "\u6211\u8ba4\u4e3a\u8fd9\u4e24\u4e2a\u914d\u7f6e\u9879\u7684\u503c\u5e94\u6539\u4e3aBoolean\u3002", "url": "https://github.com/seata/seata/pull/3372#discussion_r547159381", "createdAt": "2020-12-22T09:14:59Z", "author": {"login": "wangliang181230"}, "path": "saga/seata-saga-statelang/src/main/java/io/seata/saga/statelang/domain/ServiceTaskState.java", "diffHunk": "@@ -58,4 +58,18 @@\n      * @return\n      */\n     boolean isPersist();\n+\n+    /**\n+     * Is update last retry execution log, default append new\n+     *\n+     * @return\n+     */\n+    boolean isRetryPersistModeUpdate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTMwNTMw", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-556930530", "createdAt": "2020-12-22T09:17:09Z", "commit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOToxNzowOVrOIJ0B7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwOToxNzowOVrOIJ0B7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE2MDU1Nw==", "bodyText": "\u6211\u8ba4\u4e3a\u8fd9\u4e09\u5904\u7684\u914d\u7f6e\u662f\u6709\u4f18\u5148\u7ea7\u7684\u3002\u9996\u5148StateMachine\u548cState\u7684\u4e24\u4e2a\u5c5e\u6027\u7684\u7c7b\u578b\u9700\u53d8\u66f4\u4e3aBoolean\u3002\n\u7136\u540e\u4f18\u5148\u7ea7\u662fstate > stateMachine > config\u3002\n\u5426\u5219config\u4e2d\u914d\u7f6e\u4e3atrue\uff0cstateMachine\u6216state\u4e2d\u914d\u7f6e\u6210false\u5c31\u6ca1\u6709\u4efb\u4f55\u610f\u4e49\u4e86\u4e0d\u662f\uff1f", "url": "https://github.com/seata/seata/pull/3372#discussion_r547160557", "createdAt": "2020-12-22T09:17:09Z", "author": {"login": "wangliang181230"}, "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "diffHunk": "@@ -405,6 +419,33 @@ private int getIdIndex(String stateInstanceId, String separator) {\n         return -1;\n     }\n \n+    private boolean isUpdateMode(StateInstance stateInstance, ProcessContext context) {\n+        DefaultStateMachineConfig stateMachineConfig = (DefaultStateMachineConfig)context.getVariable(\n+            DomainConstants.VAR_NAME_STATEMACHINE_CONFIG);\n+        StateInstruction instruction = context.getInstruction(StateInstruction.class);\n+        ServiceTaskStateImpl state = (ServiceTaskStateImpl)instruction.getState(context);\n+\n+        if (StringUtils.hasLength(stateInstance.getStateIdRetriedFor())) {\n+\n+            return stateMachineConfig.isSagaRetryPersistModeUpdate() || stateInstance.getStateMachineInstance()\n+                .getStateMachine().isRetryPersistModeUpdate() || state.isRetryPersistModeUpdate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "147af4507ab33b83b874b6de5b31c9bf291ed23d"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "394515f3cebd58a32ef581fcfb56aad5ba5ee444", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/394515f3cebd58a32ef581fcfb56aad5ba5ee444", "committedDate": "2020-12-23T05:50:14Z", "message": "add @override"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c39b65078d13d3464c3296f942fbc19a78a488ad", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/c39b65078d13d3464c3296f942fbc19a78a488ad", "committedDate": "2020-12-23T05:51:09Z", "message": "adjust metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "146770056c7b5dce171a0d6ad7cf8e42a20de77b", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/146770056c7b5dce171a0d6ad7cf8e42a20de77b", "committedDate": "2020-12-23T06:30:26Z", "message": "fix config priority"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce7e2167631e441ed936d8aa6fdfc81f8869a1ea", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/ce7e2167631e441ed936d8aa6fdfc81f8869a1ea", "committedDate": "2020-12-23T06:39:49Z", "message": "Merge remote-tracking branch 'upstream/develop' into feature/customize_persist_retryInst_log"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80444c216055f0b3baefe04f67da7b920476c7f4", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/80444c216055f0b3baefe04f67da7b920476c7f4", "committedDate": "2020-12-23T13:54:24Z", "message": "CI test"}, "afterCommit": {"oid": "ce7e2167631e441ed936d8aa6fdfc81f8869a1ea", "author": {"user": {"login": "anselleeyy", "name": "Yaoyu Li"}}, "url": "https://github.com/seata/seata/commit/ce7e2167631e441ed936d8aa6fdfc81f8869a1ea", "committedDate": "2020-12-23T06:39:49Z", "message": "Merge remote-tracking branch 'upstream/develop' into feature/customize_persist_retryInst_log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4Mjc4Mjc3", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-558278277", "createdAt": "2020-12-24T00:01:12Z", "commit": {"oid": "ce7e2167631e441ed936d8aa6fdfc81f8869a1ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MzIwNjU3", "url": "https://github.com/seata/seata/pull/3372#pullrequestreview-558320657", "createdAt": "2020-12-24T03:35:36Z", "commit": {"oid": "ce7e2167631e441ed936d8aa6fdfc81f8869a1ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3553, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}