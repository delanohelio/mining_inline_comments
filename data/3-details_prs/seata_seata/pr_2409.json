{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MDIzNTQy", "number": 2409, "title": "optimize: reduce the db and network request when undoLog  or lockKey is empty", "bodyText": "\u2160. Describe what this PR did\n\u2161. Does this pull request fix one issue?\n\nissue\noptimize: unnecessary to register branch transaction when undo is empty\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-03-16T06:40:06Z", "url": "https://github.com/seata/seata/pull/2409", "merged": true, "mergeCommit": {"oid": "ec91140b4fc23c0e26ef9c6d2cfa867e34f0a7b0"}, "closed": true, "closedAt": "2020-04-14T03:51:55Z", "author": {"login": "lightClouds917"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOINN9AH2gAyMzg5MDIzNTQyOmM5MGFiYzBlNTg1OTYyYjg0MzhhYjk3OGQ4MjM3YzgxZWU5YzZlZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXa3sJAFqTM5MjU3ODYwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c90abc0e585962b8438ab978d8237c81ee9c6ef3", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/c90abc0e585962b8438ab978d8237c81ee9c6ef3", "committedDate": "2020-03-16T06:34:42Z", "message": "optimize:optimize useless branch register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46481ce2c55ef569b6f1f284c8c44ec455952913", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/46481ce2c55ef569b6f1f284c8c44ec455952913", "committedDate": "2020-03-18T02:10:02Z", "message": "add:add the report for not registered branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f8d2c64c80a3875796b1b54170f039c9c42d93f", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/1f8d2c64c80a3875796b1b54170f039c9c42d93f", "committedDate": "2020-03-20T01:21:16Z", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e141cf9a00fc4b21f41e8f95f8e11fac85a53db", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/1e141cf9a00fc4b21f41e8f95f8e11fac85a53db", "committedDate": "2020-03-21T06:55:22Z", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d1245301380cbc1f6ec80e2c38803f35a5469f9", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/6d1245301380cbc1f6ec80e2c38803f35a5469f9", "committedDate": "2020-03-24T10:51:54Z", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "483664c2f5fa55d5e85f83922589e1283603080f", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/483664c2f5fa55d5e85f83922589e1283603080f", "committedDate": "2020-03-26T09:25:07Z", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8119c88dec0f5f8925a0e7028b2221bece896529", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/8119c88dec0f5f8925a0e7028b2221bece896529", "committedDate": "2020-03-26T09:26:10Z", "message": "fix:fix mock error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4df3f9af7369bedafbb4e90eec8b2e6226a02d8", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/e4df3f9af7369bedafbb4e90eec8b2e6226a02d8", "committedDate": "2020-03-30T09:13:12Z", "message": "optimize:optimize the code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9823bde9019e2afdc21695964ad002093efb30ce", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/9823bde9019e2afdc21695964ad002093efb30ce", "committedDate": "2020-03-31T07:58:51Z", "message": "Merge branch 'develop' into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6f8c600ddaceb1d19643a3a8781f7eeaaf6c8c0", "author": {"user": {"login": "l81893521", "name": "will"}}, "url": "https://github.com/seata/seata/commit/a6f8c600ddaceb1d19643a3a8781f7eeaaf6c8c0", "committedDate": "2020-03-31T09:24:11Z", "message": "Merge branch 'develop' into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ca866b352301294b0603d37e694d34848c8867d", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/9ca866b352301294b0603d37e694d34848c8867d", "committedDate": "2020-04-01T01:55:21Z", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53dcc5aeea159472915f9cdf1a87c2d1e9d5fe4e", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/53dcc5aeea159472915f9cdf1a87c2d1e9d5fe4e", "committedDate": "2020-04-01T09:07:59Z", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85db4e8615c081dca2860dcf62866434ee9c7890", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/85db4e8615c081dca2860dcf62866434ee9c7890", "committedDate": "2020-04-01T09:21:43Z", "message": "Merge branch 'optimize_useless_register' of github.com:lightClouds917/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b0707a490c7cf0a8f68efaf40dea1900967ce30", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/9b0707a490c7cf0a8f68efaf40dea1900967ce30", "committedDate": "2020-04-06T01:33:57Z", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12fa50b85fb064c31ae312ceddb5e4f615cb4d8c", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/12fa50b85fb064c31ae312ceddb5e4f615cb4d8c", "committedDate": "2020-04-06T13:01:56Z", "message": "optimize:remove the unuse code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eb4daaf621daf7dcc32610d9c8cbe2b17fcf2ef", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/7eb4daaf621daf7dcc32610d9c8cbe2b17fcf2ef", "committedDate": "2020-04-06T13:11:56Z", "message": "optimize:optimize the log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13ac802cf582a202dca63ebe63d64fefc263a5bd", "author": {"user": {"login": "jsbxyyx", "name": "jsbxyyx"}}, "url": "https://github.com/seata/seata/commit/13ac802cf582a202dca63ebe63d64fefc263a5bd", "committedDate": "2020-04-10T03:40:15Z", "message": "Merge branch 'develop' into optimize_useless_register"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODUyNTQ0", "url": "https://github.com/seata/seata/pull/2409#pullrequestreview-391852544", "createdAt": "2020-04-12T12:31:44Z", "commit": {"oid": "13ac802cf582a202dca63ebe63d64fefc263a5bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxMjozMTo0NVrOGEVAiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQxMjozMTo0NVrOGEVAiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE5MTY5MQ==", "bodyText": "lack throw new SQLException(ex);", "url": "https://github.com/seata/seata/pull/2409#discussion_r407191691", "createdAt": "2020-04-12T12:31:45Z", "author": {"login": "zjinlei"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -211,23 +211,32 @@ private void processLocalCommitWithGlobalLocks() throws SQLException {\n     }\n \n     private void processGlobalTransactionCommit() throws SQLException {\n-        try {\n-            register();\n-        } catch (TransactionException e) {\n-            recognizeLockKeyConflictException(e, context.buildLockKeys());\n-        }\n-\n-        try {\n-            if (context.hasUndoLog()) {\n+        boolean hasUndoLog = context.hasUndoLog();\n+        if (hasUndoLog) {\n+            try {\n+                register();\n+            } catch (TransactionException e) {\n+                recognizeLockKeyConflictException(e, context.buildLockKeys());\n+            }\n+            try {\n                 UndoLogManagerFactory.getUndoLogManager(this.getDbType()).flushUndoLogs(this);\n+            } catch (SQLException sqlEx) {\n+                LOGGER.error(\"add undoLog error:{}\", sqlEx.getMessage(), sqlEx);\n+                throw new SQLException(sqlEx);\n             }\n+        }\n+        try {\n             targetConnection.commit();\n         } catch (Throwable ex) {\n-            LOGGER.error(\"process connectionProxy commit error: {}\", ex.getMessage(), ex);\n-            report(false);\n-            throw new SQLException(ex);\n+            if (hasUndoLog) {\n+                LOGGER.error(\"process connectionProxy commit error: {}\", ex.getMessage(), ex);\n+                report(false);\n+                throw new SQLException(ex);\n+            } else {\n+                LOGGER.error(\"process connectionProxy commit error: {},and the undolog is null\", ex.getMessage(), ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13ac802cf582a202dca63ebe63d64fefc263a5bd"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b113b7151040190b8213d44d2bd0fd8bdf451e57", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/b113b7151040190b8213d44d2bd0fd8bdf451e57", "committedDate": "2020-04-13T00:56:38Z", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29da872e0ca4ff49b4f2f3130af222d75c712baa", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/29da872e0ca4ff49b4f2f3130af222d75c712baa", "committedDate": "2020-04-13T01:10:06Z", "message": "Merge branch 'optimize_useless_register' of github.com:lightClouds917/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65cddffb9bab2bc3bac3ed093f72731b0f57ca0d", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/65cddffb9bab2bc3bac3ed093f72731b0f57ca0d", "committedDate": "2020-04-13T01:44:54Z", "message": "optimize:optimize the code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "393b8f10be4486777bea452b3b9ab38373a18552", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/393b8f10be4486777bea452b3b9ab38373a18552", "committedDate": "2020-04-13T02:13:25Z", "message": "optimize:optimize the code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f8b6c1d6ebdb4d0b05d5f17c384ac31f7c824c0", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/0f8b6c1d6ebdb4d0b05d5f17c384ac31f7c824c0", "committedDate": "2020-04-13T07:19:51Z", "message": "indentation 4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "758e046fef9bbeff878f692beecc9144e2299992", "author": {"user": {"login": "xingfudeshi", "name": "xingfudeshi"}}, "url": "https://github.com/seata/seata/commit/758e046fef9bbeff878f692beecc9144e2299992", "committedDate": "2020-04-13T09:51:39Z", "message": "Merge branch 'develop' into optimize_useless_register"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMTAyMjI2", "url": "https://github.com/seata/seata/pull/2409#pullrequestreview-392102226", "createdAt": "2020-04-13T11:54:53Z", "commit": {"oid": "758e046fef9bbeff878f692beecc9144e2299992"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMTo1NDo1M1rOGEkauQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMTo1NDo1M1rOGEkauQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ0NDE1Mw==", "bodyText": "I think it's better to put it in registers and flushUndoLogs.\nif there is no undolog why flushUndoLogs method execution without judgment", "url": "https://github.com/seata/seata/pull/2409#discussion_r407444153", "createdAt": "2020-04-13T11:54:53Z", "author": {"login": "slievrly"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/ConnectionProxy.java", "diffHunk": "@@ -211,24 +211,30 @@ private void processLocalCommitWithGlobalLocks() throws SQLException {\n     }\n \n     private void processGlobalTransactionCommit() throws SQLException {\n-        try {\n-            register();\n-        } catch (TransactionException e) {\n-            recognizeLockKeyConflictException(e, context.buildLockKeys());\n-        }\n-\n-        try {\n-            if (context.hasUndoLog()) {\n+        if (context.hasUndoLog()) {\n+            try {\n+                register();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "758e046fef9bbeff878f692beecc9144e2299992"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f21ec2f719b37bdeaaa611fa3d4c8a33df34e412", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/f21ec2f719b37bdeaaa611fa3d4c8a33df34e412", "committedDate": "2020-04-13T14:10:12Z", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7ed0b75ab062e22fac2a5e0159d923992aeaafc", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/b7ed0b75ab062e22fac2a5e0159d923992aeaafc", "committedDate": "2020-04-13T14:29:12Z", "message": "optimize:optimize the code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bd65bfb5ca5b4e8c88fa1802c5e9772db1f377d", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/6bd65bfb5ca5b4e8c88fa1802c5e9772db1f377d", "committedDate": "2020-04-13T14:32:32Z", "message": "Merge branch 'optimize_useless_register' of github.com:lightClouds917/seata into optimize_useless_register"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMTkyMzE0", "url": "https://github.com/seata/seata/pull/2409#pullrequestreview-392192314", "createdAt": "2020-04-13T14:49:03Z", "commit": {"oid": "6bd65bfb5ca5b4e8c88fa1802c5e9772db1f377d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8368360be0a07c529cf3fd70b88280984ff13a94", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/8368360be0a07c529cf3fd70b88280984ff13a94", "committedDate": "2020-04-14T02:55:22Z", "message": "Merge branch 'develop' of github.com:seata/seata into optimize_useless_register"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3315bcb0bb2d33c948b396679b08ba45a613a1a", "author": {"user": {"login": "lightClouds917", "name": "IT\u4e91\u6e05"}}, "url": "https://github.com/seata/seata/commit/c3315bcb0bb2d33c948b396679b08ba45a613a1a", "committedDate": "2020-04-14T02:56:01Z", "message": "bugfix:fix the unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTc4NjA0", "url": "https://github.com/seata/seata/pull/2409#pullrequestreview-392578604", "createdAt": "2020-04-14T03:24:42Z", "commit": {"oid": "c3315bcb0bb2d33c948b396679b08ba45a613a1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4094, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}