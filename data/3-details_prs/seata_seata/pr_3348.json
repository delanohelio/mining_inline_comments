{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0MjM3NzY2", "number": 3348, "title": "feature: support redis sentinel mode", "bodyText": "\u2160. Describe what this PR did\nsupports transaction session storage for redis sentinel mode\n\u2161. Does this pull request fix one issue?\nfixes #3339\n\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-12-08T08:04:31Z", "url": "https://github.com/seata/seata/pull/3348", "merged": true, "mergeCommit": {"oid": "08622b2ffc13b7b9f76781b0cd23e3ee6bb57065"}, "closed": true, "closedAt": "2020-12-29T06:21:23Z", "author": {"login": "lj2018110133"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkFboggH2gAyNTM0MjM3NzY2OmIyNWRhODg1ZTAwNTUzZGI0MGExOGMzYTMzMGYzNzkzOGEwMTdkMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdq0cC2gH2gAyNTM0MjM3NzY2OjljYmQ2OTRlZGEzY2ZiZjkzZWM1YmJlNGFjMThhOWIxYzg1OTM3Mzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b25da885e00553db40a18c3a330f37938a017d17", "author": {"user": {"login": "lj2018110133", "name": "liujian"}}, "url": "https://github.com/seata/seata/commit/b25da885e00553db40a18c3a330f37938a017d17", "committedDate": "2020-12-08T07:58:13Z", "message": "feature: support redis sentinel mode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MTk2NzI0", "url": "https://github.com/seata/seata/pull/3348#pullrequestreview-547196724", "createdAt": "2020-12-08T12:42:20Z", "commit": {"oid": "b25da885e00553db40a18c3a330f37938a017d17"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjo0MjoyMFrOIBYoUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjo0MjoyMFrOIBYoUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMyMzAyNg==", "bodyText": "\u9700\u8981\u8003\u8651\u517c\u5bb91.4\u7684\u914d\u7f6e\u8bfb\u53d6", "url": "https://github.com/seata/seata/pull/3348#discussion_r538323026", "createdAt": "2020-12-08T12:42:20Z", "author": {"login": "a364176773"}, "path": "server/src/main/java/io/seata/server/storage/redis/JedisPooledFactory.java", "diffHunk": "@@ -71,10 +74,25 @@ public static JedisPool getJedisPoolInstance(JedisPool... jedisPools) {\n                         poolConfig.setMinIdle(CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_MIN_CONN, MINCONN));\n                         poolConfig.setMaxIdle(CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_MAX_CONN, MAXCONN));\n                         poolConfig.setMaxTotal(CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_MAX_TOTAL, MAXTOTAL));\n-                        jedisPool =\n-                            new JedisPool(poolConfig, CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_HOST, HOST),\n-                                CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_PORT, PORT), 60000, password,\n-                                CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_DATABASE, DATABASE));\n+                        String mode = CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_MODE);\n+                        if (mode.equals(ConfigurationKeys.REDIS_SENTINEL_MODE)) {\n+                            String masterName = CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_SENTINEL_MASTERNAME);\n+                            if (StringUtils.isBlank(masterName)) {\n+                                throw new RedisException(\"The masterName is null in redis sentinel mode\");\n+                            }\n+                            Set<String> sentinels = new HashSet<>();\n+                            String[] sentinelHosts = CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_SENTINEL_HOST).split(\",\");\n+                            Arrays.asList(sentinelHosts).forEach(sentinelHost -> sentinels.add(sentinelHost));\n+                            jedisPool = new JedisSentinelPool(masterName, sentinels, poolConfig, 60000, password,\n+                                    CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_DATABASE, DATABASE));\n+                        } else if (mode.equals(ConfigurationKeys.REDIS_SINGLE_MODE)) {\n+                            jedisPool =\n+                                    new JedisPool(poolConfig, CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_SINGLE_HOST, HOST),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b25da885e00553db40a18c3a330f37938a017d17"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "925e689f1c86fd8ee34b47f18c25349dc3fcfdf9", "author": {"user": {"login": "lj2018110133", "name": "liujian"}}, "url": "https://github.com/seata/seata/commit/925e689f1c86fd8ee34b47f18c25349dc3fcfdf9", "committedDate": "2020-12-08T15:14:22Z", "message": "Compatible redis single mode with version 1.4"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MzQxMTY0", "url": "https://github.com/seata/seata/pull/3348#pullrequestreview-547341164", "createdAt": "2020-12-08T15:24:21Z", "commit": {"oid": "925e689f1c86fd8ee34b47f18c25349dc3fcfdf9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNToyNDoyMVrOIBjEcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNToyNDoyMVrOIBjEcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ5NDA2Ng==", "bodyText": "\u8c03\u6574\u4e00\u4e0bimport\u987a\u5e8f\u548c\u4e0d\u8981\u7528*\u914d\u7f6e", "url": "https://github.com/seata/seata/pull/3348#discussion_r538494066", "createdAt": "2020-12-08T15:24:21Z", "author": {"login": "caohdgege"}, "path": "server/src/main/java/io/seata/server/storage/redis/JedisPooledFactory.java", "diffHunk": "@@ -15,16 +15,19 @@\n  */\n package io.seata.server.storage.redis;\n \n+import io.seata.common.exception.RedisException;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import io.seata.common.util.StringUtils;\n import io.seata.config.Configuration;\n import io.seata.config.ConfigurationFactory;\n import io.seata.core.constants.ConfigurationKeys;\n-import redis.clients.jedis.Jedis;\n-import redis.clients.jedis.JedisPool;\n-import redis.clients.jedis.JedisPoolConfig;\n+import redis.clients.jedis.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "925e689f1c86fd8ee34b47f18c25349dc3fcfdf9"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MzQxNTYy", "url": "https://github.com/seata/seata/pull/3348#pullrequestreview-547341562", "createdAt": "2020-12-08T15:24:45Z", "commit": {"oid": "925e689f1c86fd8ee34b47f18c25349dc3fcfdf9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNToyNDo0NVrOIBjGQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNTozMzowMVrOIBjrLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ5NDUzMA==", "bodyText": "initsize?", "url": "https://github.com/seata/seata/pull/3348#discussion_r538494530", "createdAt": "2020-12-08T15:24:45Z", "author": {"login": "caohdgege"}, "path": "server/src/main/java/io/seata/server/storage/redis/JedisPooledFactory.java", "diffHunk": "@@ -71,10 +74,28 @@ public static JedisPool getJedisPoolInstance(JedisPool... jedisPools) {\n                         poolConfig.setMinIdle(CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_MIN_CONN, MINCONN));\n                         poolConfig.setMaxIdle(CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_MAX_CONN, MAXCONN));\n                         poolConfig.setMaxTotal(CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_MAX_TOTAL, MAXTOTAL));\n-                        jedisPool =\n-                            new JedisPool(poolConfig, CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_HOST, HOST),\n-                                CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_PORT, PORT), 60000, password,\n-                                CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_DATABASE, DATABASE));\n+                        String mode = CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_MODE,ConfigurationKeys.REDIS_SINGLE_MODE);\n+                        if (mode.equals(ConfigurationKeys.REDIS_SENTINEL_MODE)) {\n+                            String masterName = CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_SENTINEL_MASTERNAME);\n+                            if (StringUtils.isBlank(masterName)) {\n+                                throw new RedisException(\"The masterName is null in redis sentinel mode\");\n+                            }\n+                            Set<String> sentinels = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "925e689f1c86fd8ee34b47f18c25349dc3fcfdf9"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ5ODkyMQ==", "bodyText": "\u8c03\u6574\u4e00\u4e0b\u7f29\u8fdb", "url": "https://github.com/seata/seata/pull/3348#discussion_r538498921", "createdAt": "2020-12-08T15:28:38Z", "author": {"login": "caohdgege"}, "path": "server/src/main/resources/file.conf", "diffHunk": "@@ -40,8 +40,19 @@ store {\n \n   ## redis store property\n   redis {\n-    host = \"127.0.0.1\"\n-    port = \"6379\"\n+      ## redis mode: single\u3001sentinel", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "925e689f1c86fd8ee34b47f18c25349dc3fcfdf9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUwMzk4Mg==", "bodyText": "CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_SINGLE_HOST) \u8c03\u4e86\u4e24\u6b21\uff0c\u53ef\u4ee5\u7528\u4e2a\u53d8\u91cf\u63a5\u4e00\u4e0b\uff0c\u4e0b\u9762\u7684CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_SINGLE_PORT)\u4e5f\u662f", "url": "https://github.com/seata/seata/pull/3348#discussion_r538503982", "createdAt": "2020-12-08T15:33:01Z", "author": {"login": "caohdgege"}, "path": "server/src/main/java/io/seata/server/storage/redis/JedisPooledFactory.java", "diffHunk": "@@ -71,10 +74,28 @@ public static JedisPool getJedisPoolInstance(JedisPool... jedisPools) {\n                         poolConfig.setMinIdle(CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_MIN_CONN, MINCONN));\n                         poolConfig.setMaxIdle(CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_MAX_CONN, MAXCONN));\n                         poolConfig.setMaxTotal(CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_MAX_TOTAL, MAXTOTAL));\n-                        jedisPool =\n-                            new JedisPool(poolConfig, CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_HOST, HOST),\n-                                CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_PORT, PORT), 60000, password,\n-                                CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_DATABASE, DATABASE));\n+                        String mode = CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_MODE,ConfigurationKeys.REDIS_SINGLE_MODE);\n+                        if (mode.equals(ConfigurationKeys.REDIS_SENTINEL_MODE)) {\n+                            String masterName = CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_SENTINEL_MASTERNAME);\n+                            if (StringUtils.isBlank(masterName)) {\n+                                throw new RedisException(\"The masterName is null in redis sentinel mode\");\n+                            }\n+                            Set<String> sentinels = new HashSet<>();\n+                            String[] sentinelHosts = CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_SENTINEL_HOST).split(\",\");\n+                            Arrays.asList(sentinelHosts).forEach(sentinelHost -> sentinels.add(sentinelHost));\n+                            jedisPool = new JedisSentinelPool(masterName, sentinels, poolConfig, 60000, password,\n+                                    CONFIGURATION.getInt(ConfigurationKeys.STORE_REDIS_DATABASE, DATABASE));\n+                        } else if (mode.equals(ConfigurationKeys.REDIS_SINGLE_MODE)) {\n+                            String host = StringUtils.isBlank(CONFIGURATION.getConfig(ConfigurationKeys.STORE_REDIS_SINGLE_HOST)) ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "925e689f1c86fd8ee34b47f18c25349dc3fcfdf9"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32c27db1d307b9e6ae52e91b322790ac158f5b42", "author": {"user": {"login": "lj2018110133", "name": "liujian"}}, "url": "https://github.com/seata/seata/commit/32c27db1d307b9e6ae52e91b322790ac158f5b42", "committedDate": "2020-12-09T14:43:35Z", "message": "add the configurations of file.conf to application.properties and application.yml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODgzNjYx", "url": "https://github.com/seata/seata/pull/3348#pullrequestreview-558883661", "createdAt": "2020-12-26T17:23:21Z", "commit": {"oid": "32c27db1d307b9e6ae52e91b322790ac158f5b42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQxNzoyMzoyMVrOILlFVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQxNzoyMzoyMVrOILlFVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAxMjgyMQ==", "bodyText": "\u662f\u4e0d\u662f\u6539\u9519\u6587\u4ef6\u4e86\uff1f", "url": "https://github.com/seata/seata/pull/3348#discussion_r549012821", "createdAt": "2020-12-26T17:23:21Z", "author": {"login": "caohdgege"}, "path": "script/client/spring/application.properties", "diffHunk": "@@ -125,3 +125,38 @@ seata.registry.custom.name=\n \n seata.registry.load-balance=RandomLoadBalance\n seata.registry.load-balance-virtual-nodes=10\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32c27db1d307b9e6ae52e91b322790ac158f5b42"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6c653330552efb74a540c879ca91e6d2c1b2ef8", "author": {"user": {"login": "lj2018110133", "name": "liujian"}}, "url": "https://github.com/seata/seata/commit/b6c653330552efb74a540c879ca91e6d2c1b2ef8", "committedDate": "2020-12-27T04:13:37Z", "message": "Merge branch 'develop' of github.com:seata/seata into liujian"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a6b2b0bf253ef1e11bb9f6982637cc935940e81", "author": {"user": {"login": "lj2018110133", "name": "liujian"}}, "url": "https://github.com/seata/seata/commit/9a6b2b0bf253ef1e11bb9f6982637cc935940e81", "committedDate": "2020-12-27T04:25:56Z", "message": "add configrations of redis sentinel to script-server"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTAzNzU1", "url": "https://github.com/seata/seata/pull/3348#pullrequestreview-558903755", "createdAt": "2020-12-27T04:54:15Z", "commit": {"oid": "9a6b2b0bf253ef1e11bb9f6982637cc935940e81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTE1NDc5", "url": "https://github.com/seata/seata/pull/3348#pullrequestreview-558915479", "createdAt": "2020-12-27T09:34:52Z", "commit": {"oid": "9a6b2b0bf253ef1e11bb9f6982637cc935940e81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a2005299f0f67db0fe5ed203b3f111c7ae00165", "author": {"user": {"login": "lj2018110133", "name": "liujian"}}, "url": "https://github.com/seata/seata/commit/4a2005299f0f67db0fe5ed203b3f111c7ae00165", "committedDate": "2020-12-27T12:19:36Z", "message": "modify changes files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "081c364227bc0cc7536d10a14502de3a1a61f02c", "author": {"user": {"login": "lj2018110133", "name": "liujian"}}, "url": "https://github.com/seata/seata/commit/081c364227bc0cc7536d10a14502de3a1a61f02c", "committedDate": "2020-12-28T02:02:36Z", "message": "modify changes files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDM0NTIw", "url": "https://github.com/seata/seata/pull/3348#pullrequestreview-559034520", "createdAt": "2020-12-28T08:01:29Z", "commit": {"oid": "081c364227bc0cc7536d10a14502de3a1a61f02c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5Mzg2Mjcw", "url": "https://github.com/seata/seata/pull/3348#pullrequestreview-559386270", "createdAt": "2020-12-29T05:49:21Z", "commit": {"oid": "081c364227bc0cc7536d10a14502de3a1a61f02c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cbd694eda3cfbf93ec5bbe4ac18a9b1c8593738", "author": {"user": {"login": "lj2018110133", "name": "liujian"}}, "url": "https://github.com/seata/seata/commit/9cbd694eda3cfbf93ec5bbe4ac18a9b1c8593738", "committedDate": "2020-12-29T06:07:45Z", "message": "modify changes files"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3543, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}