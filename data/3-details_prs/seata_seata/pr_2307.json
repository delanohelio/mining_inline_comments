{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMzQ3ODQz", "number": 2307, "title": "optimize: optimize transaction context switch logic when transaction mode switching", "bodyText": "\u2160. Describe what this PR did\nOptimize transaction context behavior when transaction mode is switched:\n1.remove interceptorType context variable.\n2.add  branchType context variable and use it to distinguish different branch transaction modes.(distinguish TCC Mode and AT Mode)\n\u2161. Does this pull request fix one issue?\n\n\u2162. Why don't you add test cases (unit test/integration test)?\n\u2163. Describe how to verify it\n\u2164. Special notes for reviews", "createdAt": "2020-02-26T15:27:20Z", "url": "https://github.com/seata/seata/pull/2307", "merged": true, "mergeCommit": {"oid": "b1a19a3a90c0792d64bcdafa6a5aced1b9401a95"}, "closed": true, "closedAt": "2020-03-12T07:16:01Z", "author": {"login": "booogu"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIIYRtAH2gAyMzgwMzQ3ODQzOjkyYTFlNGI0MDBiNGU1YTUyNTMwZTg5NjU1OTlmNzkyOGM4ZTMyZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcM9zCqAFqTM3MzY4MTY1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "92a1e4b400b4e5a52530e8965599f7928c8e32d3", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/92a1e4b400b4e5a52530e8965599f7928c8e32d3", "committedDate": "2020-02-26T15:23:14Z", "message": "optimize: optimize transaction context behavior when transaction mode is switched"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7829ce7022660f47357d2e10aab4b80b2c1a9fff", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/7829ce7022660f47357d2e10aab4b80b2c1a9fff", "committedDate": "2020-02-29T03:38:54Z", "message": "adjust BranchType switching with Propagation feature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4e407885ef5496cc26bca0a3a2df083efc37c12", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/f4e407885ef5496cc26bca0a3a2df083efc37c12", "committedDate": "2020-03-02T02:17:52Z", "message": "Merge remote-tracking branch 'upstream/develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef1ea3cb4db95c87aa787f48720bb8cc1c12f5ae", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/ef1ea3cb4db95c87aa787f48720bb8cc1c12f5ae", "committedDate": "2020-03-02T03:18:06Z", "message": "format code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/65312ddb69e103cea2552d6ea6ee3893bf31e509", "committedDate": "2020-03-05T01:46:22Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzMwMzUw", "url": "https://github.com/seata/seata/pull/2307#pullrequestreview-370330350", "createdAt": "2020-03-06T13:45:07Z", "commit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzo0NTowN1rOFy5Kog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNDowNTo1NVrOFy5ziQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTczMA==", "bodyText": "Thoughtful point", "url": "https://github.com/seata/seata/pull/2307#discussion_r388909730", "createdAt": "2020-03-06T13:45:07Z", "author": {"login": "zjinlei"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -108,4 +109,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresUndoFunction() {\n+\n+        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+            return false;\n+        }\n+\n+        if (RootContext.inGlobalTransaction() && !RootContext.getBranchType().equals(String.valueOf(BranchType.AT.ordinal()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwOTc3Mw==", "bodyText": "SAGA", "url": "https://github.com/seata/seata/pull/2307#discussion_r388909773", "createdAt": "2020-03-06T13:45:14Z", "author": {"login": "zjinlei"}, "path": "saga/seata-saga-engine-store/src/main/java/io/seata/saga/engine/store/db/DbAndReportTcStateLogStore.java", "diffHunk": "@@ -116,6 +117,7 @@ protected void beginTransaction(StateMachineInstance machineInstance, ProcessCon\n             TransactionInfo transactionInfo = new TransactionInfo();\n             transactionInfo.setTimeOut(stateMachineConfig.getTransOperationTimeout());\n             transactionInfo.setName(machineInstance.getStateMachine().getName());\n+            transactionInfo.setDefaultBranchType(BranchType.AT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxMDE2Mw==", "bodyText": "defaultBranchType->branchType", "url": "https://github.com/seata/seata/pull/2307#discussion_r388910163", "createdAt": "2020-03-06T13:45:59Z", "author": {"login": "zjinlei"}, "path": "spring/src/main/java/io/seata/spring/annotation/GlobalTransactional.java", "diffHunk": "@@ -75,4 +76,10 @@\n      * @return\n      */\n     Propagation propagation() default Propagation.REQUIRED;\n-}\n+\n+    /**\n+     * default branch type\n+     * @return\n+     */\n+    BranchType defaultBranchType() default BranchType.AT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkxMTEyMg==", "bodyText": "defaultBranchType-> branchType", "url": "https://github.com/seata/seata/pull/2307#discussion_r388911122", "createdAt": "2020-03-06T13:47:56Z", "author": {"login": "zjinlei"}, "path": "tm/src/main/java/io/seata/tm/api/transaction/TransactionInfo.java", "diffHunk": "@@ -35,6 +36,8 @@\n \n     private Propagation propagation;\n \n+    private BranchType defaultBranchType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyMDIwMQ==", "bodyText": "if xid not empty, need to deal with previousBranchType", "url": "https://github.com/seata/seata/pull/2307#discussion_r388920201", "createdAt": "2020-03-06T14:05:55Z", "author": {"login": "zjinlei"}, "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -53,20 +54,24 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n         }\n         Propagation propagation = txInfo.getPropagation();\n         String previousXid = null;\n+        String previousBranchType = null;\n         try {\n             switch (propagation) {\n                 case NOT_SUPPORTED:\n                     previousXid = RootContext.unbind();\n                     return business.execute();\n                 case REQUIRES_NEW:\n                     previousXid = RootContext.unbind();\n+                    previousBranchType = RootContext.unbindBranchType();\n                     break;\n                 case SUPPORTS:\n                     if (StringUtils.isEmpty(RootContext.getXID())) {\n                         return business.execute();\n                     }\n                     break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3f14830d070fe5232213ac533e2867fe10f610b", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/d3f14830d070fe5232213ac533e2867fe10f610b", "committedDate": "2020-03-06T14:06:47Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzg5MDI2", "url": "https://github.com/seata/seata/pull/2307#pullrequestreview-370389026", "createdAt": "2020-03-06T15:05:02Z", "commit": {"oid": "d3f14830d070fe5232213ac533e2867fe10f610b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bbdd1fc0acf440c167338afa4689b27e35df6d0", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/9bbdd1fc0acf440c167338afa4689b27e35df6d0", "committedDate": "2020-03-07T00:42:34Z", "message": "fix the mistake in sagaBranch and rename defaultBranchType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fb6dc213670d1615639c6b3eb4dc41f7e0c62ce", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/8fb6dc213670d1615639c6b3eb4dc41f7e0c62ce", "committedDate": "2020-03-07T06:02:04Z", "message": "handle required branchType"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzI4MzUy", "url": "https://github.com/seata/seata/pull/2307#pullrequestreview-370728352", "createdAt": "2020-03-07T07:07:24Z", "commit": {"oid": "8fb6dc213670d1615639c6b3eb4dc41f7e0c62ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "059610878760c39482ebd63d6642f34b8d681bff", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/059610878760c39482ebd63d6642f34b8d681bff", "committedDate": "2020-03-07T11:02:37Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52335c8448fcad3e091dcde510731c13e59b30c6", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/52335c8448fcad3e091dcde510731c13e59b30c6", "committedDate": "2020-03-10T08:22:06Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNTMyMDIy", "url": "https://github.com/seata/seata/pull/2307#pullrequestreview-372532022", "createdAt": "2020-03-11T07:48:50Z", "commit": {"oid": "52335c8448fcad3e091dcde510731c13e59b30c6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57e7dfd979b2730809421c4f8ce5a629aead0083", "author": {"user": {"login": "zjinlei", "name": null}}, "url": "https://github.com/seata/seata/commit/57e7dfd979b2730809421c4f8ce5a629aead0083", "committedDate": "2020-03-11T12:36:26Z", "message": "Merge branch 'develop' into f_tcc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjY1NDc0", "url": "https://github.com/seata/seata/pull/2307#pullrequestreview-373265474", "createdAt": "2020-03-12T04:01:23Z", "commit": {"oid": "57e7dfd979b2730809421c4f8ce5a629aead0083"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDowMToyM1rOF1QkdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDowMToyM1rOF1QkdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MDMyNA==", "bodyText": "StringUtils.equals", "url": "https://github.com/seata/seata/pull/2307#discussion_r391390324", "createdAt": "2020-03-12T04:01:23Z", "author": {"login": "jsbxyyx"}, "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -108,4 +109,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresUndoFunction() {\n+\n+        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+            return false;\n+        }\n+\n+        if (RootContext.inGlobalTransaction() && !RootContext.getBranchType().equals(String.valueOf(BranchType.AT.ordinal()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57e7dfd979b2730809421c4f8ce5a629aead0083"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06e79eaff0997739b87f45d2763e16f064bb2a2e", "author": {"user": {"login": "booogu", "name": "haozhibei"}}, "url": "https://github.com/seata/seata/commit/06e79eaff0997739b87f45d2763e16f064bb2a2e", "committedDate": "2020-03-12T05:41:42Z", "message": "use StringUtils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMzA5ODQ2", "url": "https://github.com/seata/seata/pull/2307#pullrequestreview-373309846", "createdAt": "2020-03-12T06:44:56Z", "commit": {"oid": "06e79eaff0997739b87f45d2763e16f064bb2a2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNjgxNjU5", "url": "https://github.com/seata/seata/pull/2307#pullrequestreview-373681659", "createdAt": "2020-03-12T15:53:08Z", "commit": {"oid": "06e79eaff0997739b87f45d2763e16f064bb2a2e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4030, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}