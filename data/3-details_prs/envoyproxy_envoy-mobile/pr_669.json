{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNjY5NzEz", "number": 669, "title": "core: prevent race that causes double delete of HCM ActiveStreams", "bodyText": "Description: previously Envoy Mobile was not guarded against a race that resulted in a double deletion of an Http::ConnectionManagerImpl::ActiveStream. This PR creates state that protects against that race.\nRisk Level: low, integration test reproe'd the stack trace, and then updated prod code fixed as expected.\nTesting: new integration test.\nFixes #668\nSigned-off-by: Jose Nino jnino@lyft.com", "createdAt": "2020-02-08T02:26:15Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/669", "merged": true, "mergeCommit": {"oid": "ae16cfccf5c85d628eb6645189c5babc631c9255"}, "closed": true, "closedAt": "2020-02-10T19:28:41Z", "author": {"login": "junr03"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCHP9hAH2gAyMzcyNjY5NzEzOjA2YmZiM2Y4YWIzOWZjZDhhM2ViZTQ3ZmViYzhjYzcyM2Q1YzAzMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDBNpcAH2gAyMzcyNjY5NzEzOmMwYjkxYzc3ZTUyNDQxMjJiYTZmMzY3ZWY5YzczMDgyOThhYzAzNmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "06bfb3f8ab39fcd8a3ebe47febc8cc723d5c0319", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/06bfb3f8ab39fcd8a3ebe47febc8cc723d5c0319", "committedDate": "2020-02-07T22:40:42Z", "message": "wip\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09608b2ce2d1d900b1886b34daa959de44cf7d45", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/09608b2ce2d1d900b1886b34daa959de44cf7d45", "committedDate": "2020-02-08T01:54:10Z", "message": "test\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f166a496cb00a66126478aa4872fa77c223f30b", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/8f166a496cb00a66126478aa4872fa77c223f30b", "committedDate": "2020-02-08T01:55:18Z", "message": "Merge branch 'master' into deletion-race\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91b1a099beb37cf5750d7d03291b89806a78ba57", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/91b1a099beb37cf5750d7d03291b89806a78ba57", "committedDate": "2020-02-08T02:11:32Z", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTE1NzQz", "url": "https://github.com/envoyproxy/envoy-mobile/pull/669#pullrequestreview-356115743", "createdAt": "2020-02-10T17:15:23Z", "commit": {"oid": "91b1a099beb37cf5750d7d03291b89806a78ba57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNzoxNToyM1rOFnufOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNzoxNToyM1rOFnufOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwMDQ0MA==", "bodyText": "nit: pending_cleanup or pending_delete is a little more concise and feels equally expressive in this case. definitely nabd.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/669#discussion_r377200440", "createdAt": "2020-02-10T17:15:23Z", "author": {"login": "goaway"}, "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -31,6 +31,13 @@ Dispatcher::DirectStreamCallbacks::DirectStreamCallbacks(DirectStream& direct_st\n void Dispatcher::DirectStreamCallbacks::encodeHeaders(const HeaderMap& headers, bool end_stream) {\n   ENVOY_LOG(debug, \"[S{}] response headers for stream (end_stream={}):\\n{}\",\n             direct_stream_.stream_handle_, end_stream, headers);\n+\n+  // @see Dispatcher::resetStream's comment on its call to runResetCallbacks.\n+  // Envoy only deferredDeletes the ActiveStream if it was fully closed otherwise it issues a reset.\n+  if (direct_stream_.local_closed_ && end_stream) {\n+    direct_stream_.pending_stream_deferred_delete_ = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b1a099beb37cf5750d7d03291b89806a78ba57"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTE2ODIx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/669#pullrequestreview-356116821", "createdAt": "2020-02-10T17:16:54Z", "commit": {"oid": "91b1a099beb37cf5750d7d03291b89806a78ba57"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0b91c77e5244122ba6f367ef9c7308298ac036b", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/c0b91c77e5244122ba6f367ef9c7308298ac036b", "committedDate": "2020-02-10T18:12:40Z", "message": "var name\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4277, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}