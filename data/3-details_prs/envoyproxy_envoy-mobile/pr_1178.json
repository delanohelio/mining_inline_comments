{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5ODU0NzU2", "number": 1178, "title": "filters: add core and iOS support for on-cancel invocations", "bodyText": "Description: Also includes iOS wiring for on-error invocation path.\nRisk Level: Moderate\nTesting: Integration and unit tests, CI and local\nSigned-off-by: Mike Schore mike.schore@gmail.com", "createdAt": "2020-11-12T12:34:45Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178", "merged": true, "mergeCommit": {"oid": "adf92feb2e3c67c0938a56774e6a97a9eb1dc7c8"}, "closed": true, "closedAt": "2020-12-14T10:26:35Z", "author": {"login": "goaway"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbx0BxABqjM5ODg0NTc3NDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdl3qgBAH2gAyNTE5ODU0NzU2OmEyNjdhZDlmNzA5NjBmYjFjNDNhN2RlZTQ2ZWViYmNhMGRmM2MyNWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd6a5249ac24d1150ed16299c5eecac754163dbf", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/fd6a5249ac24d1150ed16299c5eecac754163dbf", "committedDate": "2020-11-12T12:34:14Z", "message": "filters: add support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "7668324fff4038496dead09b7d1b80cd858c4f29", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/7668324fff4038496dead09b7d1b80cd858c4f29", "committedDate": "2020-11-12T12:35:12Z", "message": "filters: add support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7668324fff4038496dead09b7d1b80cd858c4f29", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/7668324fff4038496dead09b7d1b80cd858c4f29", "committedDate": "2020-11-12T12:35:12Z", "message": "filters: add support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "99d0361148a6f4ee362d4c2ba8c803480eacf583", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/99d0361148a6f4ee362d4c2ba8c803480eacf583", "committedDate": "2020-11-18T11:51:44Z", "message": "filters: add core and iOS support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99d0361148a6f4ee362d4c2ba8c803480eacf583", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/99d0361148a6f4ee362d4c2ba8c803480eacf583", "committedDate": "2020-11-18T11:51:44Z", "message": "filters: add core and iOS support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "84c736584e9eed0ed1dddd32d903b5d07f2b0861", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/84c736584e9eed0ed1dddd32d903b5d07f2b0861", "committedDate": "2020-11-18T11:51:57Z", "message": "filters: add core and iOS support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NzcwMzkz", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#pullrequestreview-534770393", "createdAt": "2020-11-19T19:16:43Z", "commit": {"oid": "53b1aef70e6beeee0d0f1a826763bd900d0ba60a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53b1aef70e6beeee0d0f1a826763bd900d0ba60a", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/53b1aef70e6beeee0d0f1a826763bd900d0ba60a", "committedDate": "2020-11-18T18:59:26Z", "message": "copy-paste typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "53a9ce50c2470a4bee713f83c3f6440394a4c230", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/53a9ce50c2470a4bee713f83c3f6440394a4c230", "committedDate": "2020-12-02T18:41:25Z", "message": "add platform integration test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MjQ2NTUw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#pullrequestreview-544246550", "createdAt": "2020-12-03T18:15:39Z", "commit": {"oid": "cbab625a9e8218d08f840c421f12c11b1e1c002e"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxODoxNTozOVrOH-qfIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxODoxNzozOFrOH-qmFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ2OTg1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  self.onCancel = {\n          \n          \n            \n                    responseFilter.onCancel()\n          \n          \n            \n                  }\n          \n          \n            \n                  self.onCancel = responseFilter.onCancel", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#discussion_r535469859", "createdAt": "2020-12-03T18:15:39Z", "author": {"login": "rebello95"}, "path": "library/swift/src/filters/Filter.swift", "diffHunk": "@@ -104,6 +104,16 @@ extension EnvoyHTTPFilter {\n           ]\n         }\n       }\n+\n+      self.onError = { errorCode, message, attemptCount in\n+        let error = EnvoyError(errorCode: errorCode, message: message,\n+                               attemptCount: UInt32(exactly: attemptCount), cause: nil)\n+        responseFilter.onError(error)\n+      }\n+\n+      self.onCancel = {\n+        responseFilter.onCancel()\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbab625a9e8218d08f840c421f12c11b1e1c002e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3MDY0OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  init(expectation: XCTestExpectation) {\n          \n          \n            \n                    self.expectation = expectation\n          \n          \n            \n                  }\n          \n      \n    \n    \n  \n\nThis will work without the explicit init since the type is a struct", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#discussion_r535470649", "createdAt": "2020-12-03T18:16:33Z", "author": {"login": "rebello95"}, "path": "library/swift/test/HttpBridgeTests/CancelStreamTest.swift", "diffHunk": "@@ -33,25 +35,64 @@ final class CancelStreamTests: XCTestCase {\n                       direct_response:\n                         status: 200\n             http_filters:\n+              - name: envoy.filters.http.platform_bridge\n+                typed_config:\n+                  \"@type\": \\(platformBridgeFilterType)\n+                  platform_filter_name: cancel_validation_filter\n               - name: envoy.router\n                 typed_config:\n                   \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n     \"\"\"\n-    let expectation = self.expectation(description: \"Run called with expected cancellation\")\n+\n+    struct CancelValidationFilter: ResponseFilter {\n+      let expectation: XCTestExpectation\n+\n+      init(expectation: XCTestExpectation) {\n+        self.expectation = expectation\n+      }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbab625a9e8218d08f840c421f12c11b1e1c002e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3MTYzNg==", "bodyText": "Can we add a test for onError?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#discussion_r535471636", "createdAt": "2020-12-03T18:17:38Z", "author": {"login": "rebello95"}, "path": "library/swift/test/HttpBridgeTests/CancelStreamTest.swift", "diffHunk": "@@ -33,25 +35,64 @@ final class CancelStreamTests: XCTestCase {\n                       direct_response:\n                         status: 200\n             http_filters:\n+              - name: envoy.filters.http.platform_bridge\n+                typed_config:\n+                  \"@type\": \\(platformBridgeFilterType)\n+                  platform_filter_name: cancel_validation_filter\n               - name: envoy.router\n                 typed_config:\n                   \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\n     \"\"\"\n-    let expectation = self.expectation(description: \"Run called with expected cancellation\")\n+\n+    struct CancelValidationFilter: ResponseFilter {\n+      let expectation: XCTestExpectation\n+\n+      init(expectation: XCTestExpectation) {\n+        self.expectation = expectation\n+      }\n+\n+      func onResponseHeaders(_ headers: ResponseHeaders, endStream: Bool)\n+        -> FilterHeadersStatus<ResponseHeaders>\n+      {\n+        return .continue(headers: headers)\n+      }\n+\n+      func onResponseData(_ body: Data, endStream: Bool) -> FilterDataStatus<ResponseHeaders> {\n+        return .continue(data: body)\n+      }\n+\n+      func onResponseTrailers(_ trailers: ResponseTrailers)\n+          -> FilterTrailersStatus<ResponseHeaders, ResponseTrailers> {\n+        return .continue(trailers: trailers)\n+      }\n+\n+      func onError(_ error: EnvoyError) {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbab625a9e8218d08f840c421f12c11b1e1c002e"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbab625a9e8218d08f840c421f12c11b1e1c002e", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/cbab625a9e8218d08f840c421f12c11b1e1c002e", "committedDate": "2020-12-03T13:18:22Z", "message": "swiftlint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "c4077df71d9eba8a4f18368a3030087961732a1a", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/c4077df71d9eba8a4f18368a3030087961732a1a", "committedDate": "2020-12-04T18:35:08Z", "message": "updates for feedback\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NDEyNTI5", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#pullrequestreview-546412529", "createdAt": "2020-12-07T18:17:56Z", "commit": {"oid": "c4077df71d9eba8a4f18368a3030087961732a1a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4077df71d9eba8a4f18368a3030087961732a1a", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/c4077df71d9eba8a4f18368a3030087961732a1a", "committedDate": "2020-12-04T18:35:08Z", "message": "updates for feedback\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "7d317594e17501023c99b43a0a0dd11dc2891584", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/7d317594e17501023c99b43a0a0dd11dc2891584", "committedDate": "2020-12-08T19:01:41Z", "message": "updates for feedback\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTUwNjE3", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1178#pullrequestreview-547550617", "createdAt": "2020-12-08T19:14:56Z", "commit": {"oid": "7d317594e17501023c99b43a0a0dd11dc2891584"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18863487119211a9288f11855fcf9826251cf730", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/18863487119211a9288f11855fcf9826251cf730", "committedDate": "2020-12-10T20:47:18Z", "message": "filters: add core and iOS support for on-cancel invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0c3140fe5a3319224778614167bf7eb8bb92ba7", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/f0c3140fe5a3319224778614167bf7eb8bb92ba7", "committedDate": "2020-12-10T20:47:18Z", "message": "swiftlint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b35f14f429c786cb80407cd7a9c89d86439f24e1", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/b35f14f429c786cb80407cd7a9c89d86439f24e1", "committedDate": "2020-12-10T20:47:18Z", "message": "copy-paste typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc05659c43a8a5e824cfa8ddb96a429747dcdd7e", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/fc05659c43a8a5e824cfa8ddb96a429747dcdd7e", "committedDate": "2020-12-10T20:47:18Z", "message": "add platform integration test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33712e79a2106f2c1decab7443974ce38787e8b1", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/33712e79a2106f2c1decab7443974ce38787e8b1", "committedDate": "2020-12-10T20:47:18Z", "message": "swiftlint\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c79026bdf3a94011d72d70ac179db2c3732be900", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/c79026bdf3a94011d72d70ac179db2c3732be900", "committedDate": "2020-12-10T20:47:18Z", "message": "updates for feedback\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c1d4f5338245d0df94f5af85fc7c9d25cbdc335", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/6c1d4f5338245d0df94f5af85fc7c9d25cbdc335", "committedDate": "2020-12-13T20:47:54Z", "message": "passing test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d317594e17501023c99b43a0a0dd11dc2891584", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/7d317594e17501023c99b43a0a0dd11dc2891584", "committedDate": "2020-12-08T19:01:41Z", "message": "updates for feedback\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "6c1d4f5338245d0df94f5af85fc7c9d25cbdc335", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/6c1d4f5338245d0df94f5af85fc7c9d25cbdc335", "committedDate": "2020-12-13T20:47:54Z", "message": "passing test\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a267ad9f70960fb1c43a7dee46eebbca0df3c25b", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/a267ad9f70960fb1c43a7dee46eebbca0df3c25b", "committedDate": "2020-12-13T21:03:38Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3908, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}