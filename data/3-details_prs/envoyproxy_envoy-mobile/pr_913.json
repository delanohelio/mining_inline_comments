{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NTA5NTcy", "number": 913, "title": "kotlin: refactor public functionality as precursor to L7 filters", "bodyText": "Context\nThis is a mirror of the iOS interface refactors done in #858. Additionally, it introduces a set of mocks to match the iOS mocks introduced in #900.\nResolves #905 and resolves #907.\nGoals\n\nUnify the existing response handler and stream emitter types into a single \"stream\" type that will make it easier to communicate with an underlying filter manager for both outbound requests and inbound responses\nProvide guard rails that prevent the consumer from making mistakes, such as setting callback handlers after starting a stream and thus missing updates\nProvide a clear interface to the user for creating and starting streams\nFocus on the basics (bi-directional streaming support), which will allow for other wrappers to be written in the future (i.e., GRPC, unary, Rx, etc.)\nUpdate interfaces to utilize the new wrapper types introduced on master (ResponseHeaders, RequestHeaders, etc.)\n\nGoals of mocks:\n\nAvoid adding logic to the mocked types. Instead, provide types that utilize the existing underlying logic of the library (MockStreamPrototype is a good example of this: it does not add a custom set of mappings for StreamCallbacks to the engine's EnvoyHTTPCallbacks, but instead uses the existing implementation to bridge simulated response calls)\nEnsure that no Java types/interfaces are required to mock requests/responses end-to-end\nMake it easy for end users to consume the mocks in the same way that they would the production library\n\nTypes\n\nStreamClient: The publicly exposed interface of EnvoyEngine. Provides a function for starting a new stream using Envoy Mobile, and is built using StreamClientBuilder\nStreamPrototype: Type that allows users to set up a stream (providing callbacks, etc.) prior to starting it\nStream: Produced by calling start() on a StreamPrototype, and allows the consumer to send data over the stream and eventually close it\nGRPCClient / GRPCStreamPrototype / GRPCStream: Types wrapping the above 3 types, converting the existing gRPC types to utilize the new functionality\n\nTests\n\nI went through all of the Swift tests and audited the Kotlin tests to:\n\nAdd/update to ensure that we now have 1:1 parity on tests between the two languages (even the test names are the same!)\nFixed a bug I noticed while adding the tests where the retryable status code enum couldn't be properly serialized to headers and deserialized from those same headers\nMigrate them to the new interfaces\n\n\nSample apps have also been updated (CI validates via \"hello world\")\n\nNotes\n\nI noticed some Kotlin types that were unnecessarily public. Those have been made internal in this PR\nLogic and tests were added for setting headers with restricted prefixes (: and x-envoy-mobile), for parity with iOS\nDocumentation will be updated separately in #906\n\nSigned-off-by: Michael Rebello me@michaelrebello.com", "createdAt": "2020-06-16T22:58:14Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913", "merged": true, "mergeCommit": {"oid": "260985f12baf67cfa7490b811bed3d0f997b6eb7"}, "closed": true, "closedAt": "2020-06-18T20:04:46Z", "author": {"login": "rebello95"}, "timelineItems": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr9ZPKAH2gAyNDM1NTA5NTcyOjljZTA0ODdhZDJmN2E5MzMxZDMxOTJmZTE2N2JjNTU0NmViMWM2NmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsjpQAgFqTQzMzU4NDMxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ce0487ad2f7a9331d3192fe167bc5546eb1c66a", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/9ce0487ad2f7a9331d3192fe167bc5546eb1c66a", "committedDate": "2020-06-16T22:56:36Z", "message": "checkpoint\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40a587b52237c3a53a8c0f719116f35573090fb0", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/40a587b52237c3a53a8c0f719116f35573090fb0", "committedDate": "2020-06-17T00:09:43Z", "message": "android compiles\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f150e7f446ee781f26121085f990881b93d17bb", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/8f150e7f446ee781f26121085f990881b93d17bb", "committedDate": "2020-06-17T01:21:21Z", "message": "updates\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "774d82899aae3a4ddc28cf1518f99ecf61e0a041", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/774d82899aae3a4ddc28cf1518f99ecf61e0a041", "committedDate": "2020-06-17T03:42:26Z", "message": "some tests\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba1ce550f0e609e81cef73af5798cc0bef349c5b", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/ba1ce550f0e609e81cef73af5798cc0bef349c5b", "committedDate": "2020-06-17T16:52:11Z", "message": "ktlint\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3760807ad6da4b9b5d387af80d562ce01c80d329", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/3760807ad6da4b9b5d387af80d562ce01c80d329", "committedDate": "2020-06-17T17:19:37Z", "message": "GRPCRequestBuilderTest\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "064cb26199c51caf51b549d4883425d51dea424b", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/064cb26199c51caf51b549d4883425d51dea424b", "committedDate": "2020-06-17T21:51:48Z", "message": "mocks compile\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1858c6cef1a5bbb66f5ff30f5e43dd876d870b10", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/1858c6cef1a5bbb66f5ff30f5e43dd876d870b10", "committedDate": "2020-06-17T23:39:47Z", "message": "some fixes\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c143054d32c12c6ee1763689b50647180e1e7ad1", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/c143054d32c12c6ee1763689b50647180e1e7ad1", "committedDate": "2020-06-18T00:35:52Z", "message": "tests work\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fc7714fafc71cf3902d2c1ff49a08fe75f72126", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/6fc7714fafc71cf3902d2c1ff49a08fe75f72126", "committedDate": "2020-06-18T01:03:26Z", "message": "fixups\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf949d9036f69cb7cb9e6311262576e8a003a866", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/cf949d9036f69cb7cb9e6311262576e8a003a866", "committedDate": "2020-06-18T03:52:56Z", "message": "Merge remote-tracking branch 'origin/master' into kotlin-filters-m2\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b160cb1984d759117f0cfe4f72759c376a0d7da2", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/b160cb1984d759117f0cfe4f72759c376a0d7da2", "committedDate": "2020-06-18T04:43:14Z", "message": "fixes\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23cf61ebb84a2d007f30288bc1d82b6b1ddc9ae4", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/23cf61ebb84a2d007f30288bc1d82b6b1ddc9ae4", "committedDate": "2020-06-18T05:11:39Z", "message": "linter\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11eef0503e17f8acb202bc35101fe801397d72f0", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/11eef0503e17f8acb202bc35101fe801397d72f0", "committedDate": "2020-06-18T05:49:01Z", "message": "Update RequestHeadersBuilder.kt\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1098580e537f53d7566601489c04a89a437fe596", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/1098580e537f53d7566601489c04a89a437fe596", "committedDate": "2020-06-18T13:44:20Z", "message": "fixups\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDY2NTk1", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433466595", "createdAt": "2020-06-18T16:45:47Z", "commit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjo0NTo0N1rOGl3w7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjo0NTo0N1rOGl3w7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM2NDE0MA==", "bodyText": "This change was necessary in order to ensure that mock subclasses of EnvoyHTTPStream don't end up calling JNI at all (doing so caused tests to crash). Instead, the initializer now no longer has the side effect of calling the JNI, and the engine starts the stream via this method (similarly to the ObjC engine here)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442364140", "createdAt": "2020-06-18T16:45:47Z", "author": {"login": "rebello95"}, "path": "library/java/src/io/envoyproxy/envoymobile/engine/EnvoyHTTPStream.java", "diffHunk": "@@ -9,14 +9,22 @@\n import java.util.Map;\n \n public class EnvoyHTTPStream {\n-\n   private final long streamHandle;\n   private final JvmCallbackContext callbacksContext;\n \n-  EnvoyHTTPStream(long streamHandle, EnvoyHTTPCallbacks callbacks) {\n+  /**\n+   * Start the stream via the JNI library.\n+   */\n+  void start() { JniLibrary.startStream(streamHandle, callbacksContext); }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b90c5d6ec8942385a2c4b64470fc4a8e7dd1376", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/3b90c5d6ec8942385a2c4b64470fc4a8e7dd1376", "committedDate": "2020-06-18T16:46:16Z", "message": "Merge remote-tracking branch 'origin/master' into kotlin-filters-m2\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDY3Njc4", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433467678", "createdAt": "2020-06-18T16:47:08Z", "commit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjo0NzowOFrOGl30Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjo0NzowOFrOGl30Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM2NTAxNA==", "bodyText": "File was renamed from Envoy, but git didn't recognize this as a rename because there were enough changes in the file", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442365014", "createdAt": "2020-06-18T16:47:08Z", "author": {"login": "rebello95"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/EnvoyClient.kt", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.envoyproxy.envoymobile", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDc5MTk1", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433479195", "createdAt": "2020-06-18T17:02:05Z", "commit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzowMjowNVrOGl4WWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzowMjowNVrOGl4WWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3MzcyMA==", "bodyText": "These are necessary in order to return a RequestHeadersBuilder type rather than a HeadersBuilder", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442373720", "createdAt": "2020-06-18T17:02:05Z", "author": {"login": "rebello95"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/RequestHeadersBuilder.kt", "diffHunk": "@@ -35,6 +35,26 @@ class RequestHeadersBuilder : HeadersBuilder {\n    */\n   internal constructor(headers: MutableMap<String, MutableList<String>>) : super(headers)\n \n+  override fun add(name: String, value: String): RequestHeadersBuilder {\n+    super.add(name, value)\n+    return this\n+  }\n+\n+  override fun set(name: String, value: MutableList<String>): RequestHeadersBuilder {\n+    super.set(name, value)\n+    return this\n+  }\n+\n+  override fun remove(name: String): RequestHeadersBuilder {\n+    super.remove(name)\n+    return this\n+  }\n+\n+  override fun internalSet(name: String, value: MutableList<String>): RequestHeadersBuilder {\n+    super.internalSet(name, value)\n+    return this\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDc5NTc0", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433479574", "createdAt": "2020-06-18T17:02:36Z", "commit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzowMjozN1rOGl4Xhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzowMjozN1rOGl4Xhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3NDAyMg==", "bodyText": "This was a bug caught by the new tests I added \ud83d\ude43", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442374022", "createdAt": "2020-06-18T17:02:37Z", "author": {"login": "rebello95"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/RetryPolicy.kt", "diffHunk": "@@ -68,7 +67,7 @@ enum class RetryRule(internal val stringValue: String) {\n   companion object {\n     internal fun enumValue(stringRepresentation: String): RetryRule? {\n       return when (stringRepresentation) {\n-        \"status-5xx\" -> STATUS_5XX\n+        \"5xx\" -> STATUS_5XX", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDgxMTUx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433481151", "createdAt": "2020-06-18T17:04:41Z", "commit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzowNDo0MVrOGl4b1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzowNDo0MVrOGl4b1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3NTEyNg==", "bodyText": "Partly moved from a different file", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442375126", "createdAt": "2020-06-18T17:04:41Z", "author": {"login": "rebello95"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/StreamCallbacks.kt", "diffHunk": "@@ -0,0 +1,52 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.types.EnvoyHTTPCallbacks\n+import java.nio.ByteBuffer\n+import java.util.concurrent.Executor\n+\n+/**\n+ * A collection of platform-level callbacks that are specified by consumers\n+ * who wish to interact with streams.\n+ *\n+ * `StreamCallbacks` are bridged through to `EnvoyHTTPCallbacks` to communicate with the engine.\n+ */\n+internal class StreamCallbacks {\n+  var onHeaders: ((headers: ResponseHeaders, endStream: Boolean) -> Unit)? = null\n+  var onData: ((data: ByteBuffer, endStream: Boolean) -> Unit)? = null\n+  var onTrailers: ((trailers: ResponseTrailers) -> Unit)? = null\n+  var onCancel: (() -> Unit)? = null\n+  var onError: ((error: EnvoyError) -> Unit)? = null\n+}\n+\n+/**\n+ * Class responsible for bridging between the platform-level `StreamCallbacks` and the\n+ * engine's `EnvoyHTTPCallbacks`.\n+ */\n+internal class EnvoyHTTPCallbacksAdapter(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDg3MDE3", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433487017", "createdAt": "2020-06-18T17:12:38Z", "commit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoxMjozOFrOGl4tIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoxMjozOFrOGl4tIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3OTU1Mw==", "bodyText": "Renamed for consistency on both platforms", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442379553", "createdAt": "2020-06-18T17:12:38Z", "author": {"login": "rebello95"}, "path": "library/swift/src/grpc/GRPCRequestHeadersBuilder.swift", "diffHunk": "@@ -21,14 +21,14 @@ public final class GRPCRequestHeadersBuilder: HeadersBuilder {\n \n   /// Add a specific timeout for the gRPC request. This will be sent in the `grpc-timeout` header.\n   ///\n-  /// - parameter timeoutMS: Timeout, in milliseconds.\n+  /// - parameter timeoutMs: Timeout, in milliseconds.\n   ///\n   /// - returns: This builder.\n   @discardableResult\n-  public func addTimeoutMS(_ timeoutMS: UInt?) -> GRPCRequestHeadersBuilder {\n+  public func addTimeoutMs(_ timeoutMs: UInt?) -> GRPCRequestHeadersBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDg3MTEw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433487110", "createdAt": "2020-06-18T17:12:47Z", "commit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoxMjo0N1rOGl4tbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoxMjo0N1rOGl4tbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM3OTYzMQ==", "bodyText": "This was missing on master", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442379631", "createdAt": "2020-06-18T17:12:47Z", "author": {"login": "rebello95"}, "path": "library/swift/src/grpc/GRPCStreamPrototype.swift", "diffHunk": "@@ -96,6 +96,20 @@ public final class GRPCStreamPrototype: NSObject {\n     self.underlyingStream.setOnError(closure: closure)\n     return self\n   }\n+\n+  /// Specify a callback for when the stream is canceled.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1098580e537f53d7566601489c04a89a437fe596"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/c1ff70a18918427c61a48093f1f1b6209f93e478", "committedDate": "2020-06-18T17:13:16Z", "message": "self review\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDk2NzY0", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433496764", "createdAt": "2020-06-18T17:25:15Z", "commit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoyNToxNlrOGl5JvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoyNToxNlrOGl5JvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4Njg3Nw==", "bodyText": "Is this really needed? Could get rid of these constructors and you'd still be able to call this like:\nEnvoyClient(engine, envoyConfiguration)\n\nOR\nEnvoyClient(engine, configurationYAML  = yaml)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442386877", "createdAt": "2020-06-18T17:25:16Z", "author": {"login": "johnpaulmckean"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/EnvoyClient.kt", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.EnvoyConfiguration\n+import io.envoyproxy.envoymobile.engine.EnvoyEngine\n+\n+/**\n+ * Envoy's implementation of `StreamClient`, buildable using `StreamClientBuilder`.\n+ */\n+internal class EnvoyClient private constructor(\n+  internal val engine: EnvoyEngine,\n+  internal val envoyConfiguration: EnvoyConfiguration?,\n+  internal val configurationYAML: String?,\n+  internal val logLevel: LogLevel\n+) : StreamClient {\n+  constructor(\n+    engine: EnvoyEngine,\n+    envoyConfiguration: EnvoyConfiguration,\n+    logLevel: LogLevel = LogLevel.INFO\n+  ) : this(engine, envoyConfiguration, null, logLevel)\n+  constructor(\n+    engine: EnvoyEngine,\n+    configurationYAML: String,\n+    logLevel: LogLevel = LogLevel.INFO\n+  ) : this(engine, null, configurationYAML, logLevel)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDk3NjYx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433497661", "createdAt": "2020-06-18T17:26:31Z", "commit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoyNjozMlrOGl5McQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoyNjozMlrOGl5McQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4NzU2OQ==", "bodyText": "can just be:\noverride fun newStreamPrototype() = StreamPrototype(engine)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442387569", "createdAt": "2020-06-18T17:26:32Z", "author": {"login": "johnpaulmckean"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/EnvoyClient.kt", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.EnvoyConfiguration\n+import io.envoyproxy.envoymobile.engine.EnvoyEngine\n+\n+/**\n+ * Envoy's implementation of `StreamClient`, buildable using `StreamClientBuilder`.\n+ */\n+internal class EnvoyClient private constructor(\n+  internal val engine: EnvoyEngine,\n+  internal val envoyConfiguration: EnvoyConfiguration?,\n+  internal val configurationYAML: String?,\n+  internal val logLevel: LogLevel\n+) : StreamClient {\n+  constructor(\n+    engine: EnvoyEngine,\n+    envoyConfiguration: EnvoyConfiguration,\n+    logLevel: LogLevel = LogLevel.INFO\n+  ) : this(engine, envoyConfiguration, null, logLevel)\n+  constructor(\n+    engine: EnvoyEngine,\n+    configurationYAML: String,\n+    logLevel: LogLevel = LogLevel.INFO\n+  ) : this(engine, null, configurationYAML, logLevel)\n+\n+  init {\n+    if (envoyConfiguration == null) {\n+      engine.runWithConfig(configurationYAML, logLevel.level)\n+    } else {\n+      engine.runWithConfig(envoyConfiguration, logLevel.level)\n+    }\n+  }\n+\n+  override fun newStreamPrototype(): StreamPrototype {\n+    return StreamPrototype(engine)\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDk4OTYw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433498960", "createdAt": "2020-06-18T17:28:10Z", "commit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoyODoxMFrOGl5QfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzoyODoxMFrOGl5QfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4ODYwNA==", "bodyText": "can be:\nprivate fun isRestrictedHeader(name: String) = name.startsWith(\":\") || name.startsWith(\"x-envoy-mobile\")", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442388604", "createdAt": "2020-06-18T17:28:10Z", "author": {"login": "johnpaulmckean"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/HeadersBuilder.kt", "diffHunk": "@@ -49,8 +55,28 @@ open class HeadersBuilder {\n    *\n    * @return HeadersBuilder, This builder.\n    */\n-  fun remove(name: String): HeadersBuilder {\n+  open fun remove(name: String): HeadersBuilder {\n+    if (isRestrictedHeader(name)) {\n+      return this\n+    }\n     headers.remove(name)\n     return this\n   }\n+\n+  /**\n+   * Allows for setting headers that are not publicly mutable (i.e., restricted headers).\n+   *\n+   * @param name: The header name.\n+   * @param value: The value associated to the header name.\n+   *\n+   * @return HeadersBuilder, This builder.\n+   */\n+  internal open fun internalSet(name: String, value: MutableList<String>): HeadersBuilder {\n+    headers[name] = value\n+    return this\n+  }\n+\n+  private fun isRestrictedHeader(name: String): Boolean {\n+    return name.startsWith(\":\") || name.startsWith(\"x-envoy-mobile\")\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTAxNDcw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433501470", "createdAt": "2020-06-18T17:31:28Z", "commit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozMToyOFrOGl5YPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozMToyOFrOGl5YPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MDU4OQ==", "bodyText": "can be:\nfun toRequestTrailersBuilder() = RequestTrailersBuilder(this.headers.mapValues { \n    it.value.toMutableList() \n}.toMutableMap())", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442390589", "createdAt": "2020-06-18T17:31:28Z", "author": {"login": "johnpaulmckean"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/RequestTrailers.kt", "diffHunk": "@@ -11,4 +11,16 @@ class RequestTrailers : Headers {\n    * @param trailers: Headers to set.\n    */\n   internal constructor(trailers: Map<String, List<String>>) : super(trailers)\n+\n+  /**\n+   * Convert the trailers back to a builder for mutation.\n+   *\n+   * @return RequestTrailersBuilder, The new builder.\n+   */\n+  fun toRequestTrailersBuilder(): RequestTrailersBuilder {\n+    return RequestTrailersBuilder(\n+      this.headers.mapValues { it.value.toMutableList() }\n+        .toMutableMap()\n+    )\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTAzNDcx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433503471", "createdAt": "2020-06-18T17:34:14Z", "commit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozNDoxNVrOGl5eLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozNDoxNVrOGl5eLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MjEwOQ==", "bodyText": "would be pretty:\n  fun newGRPCStreamPrototype() = GRPCStreamPrototype(\n    streamClient.newStreamPrototype()\n )", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442392109", "createdAt": "2020-06-18T17:34:15Z", "author": {"login": "johnpaulmckean"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/grpc/GRPCClient.kt", "diffHunk": "@@ -1,27 +1,23 @@\n package io.envoyproxy.envoymobile\n \n // 1 byte for the compression flag, 4 bytes for the message length (int)\n-const val GRPC_PREFIX_LENGTH = 5\n+internal const val GRPC_PREFIX_LENGTH = 5\n \n /**\n  * Client that supports sending and receiving gRPC traffic.\n  *\n- * @param httpClient The HTTP client to use for gRPC streams.\n+ * @param streamClient The stream client to use for gRPC streams.\n  */\n class GRPCClient(\n-  private val httpClient: HTTPClient\n+  private val streamClient: StreamClient\n ) {\n-\n   /**\n-   * Start a gRPC request with the provided handler.\n-   *\n-   * @param request The outbound gRPC request. See `GRPCRequestBuilder` for creation.\n-   * @param handler Handler for receiving responses.\n+   * Create a new gRPC stream prototype which can be used to start streams.\n    *\n-   * @returns An emitter that can be used for sending more traffic over the stream.\n+   * @return The new gRPC stream prototype.\n    */\n-  fun start(request: Request, grpcResponseHandler: GRPCResponseHandler): GRPCStreamEmitter {\n-    val emitter = httpClient.start(request, grpcResponseHandler.underlyingHandler)\n-    return GRPCStreamEmitter(emitter)\n+  fun newGRPCStreamPrototype(): GRPCStreamPrototype {\n+    val prototype = streamClient.newStreamPrototype()\n+    return GRPCStreamPrototype(prototype)\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTAzOTk2", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433503996", "createdAt": "2020-06-18T17:35:00Z", "commit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozNTowMFrOGl5fvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozNTowMFrOGl5fvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MjUwOQ==", "bodyText": "you know ;)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442392509", "createdAt": "2020-06-18T17:35:00Z", "author": {"login": "johnpaulmckean"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/grpc/GRPCRequestHeaders.kt", "diffHunk": "@@ -0,0 +1,22 @@\n+package io.envoyproxy.envoymobile\n+\n+/*\n+ * Headers representing an outbound gRPC request.\n+ */\n+class GRPCRequestHeaders : RequestHeaders {\n+  /**\n+   * Internal constructor used by builders.\n+   *\n+   * @param headers: Headers to set.\n+   */\n+  internal constructor(headers: Map<String, List<String>>) : super(headers)\n+\n+  /**\n+   * Convert the headers back to a builder for mutation.\n+   *\n+   * @return GRPCRequestHeadersBuilder, The new builder.\n+   */\n+  fun toGRPCRequestHeadersBuilder(): GRPCRequestHeadersBuilder {\n+    return GRPCRequestHeadersBuilder(this.headers.mapValues { it.value.toMutableList() }.toMutableMap())\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTA1MDkw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433505090", "createdAt": "2020-06-18T17:36:31Z", "commit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozNjozMVrOGl5jDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzozNjozMVrOGl5jDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5MzM1Ng==", "bodyText": "this can all be just a few lines.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442393356", "createdAt": "2020-06-18T17:36:31Z", "author": {"login": "johnpaulmckean"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/mocks/MockEnvoyEngine.kt", "diffHunk": "@@ -0,0 +1,23 @@\n+package io.envoyproxy.envoymobile\n+\n+import io.envoyproxy.envoymobile.engine.EnvoyConfiguration\n+import io.envoyproxy.envoymobile.engine.EnvoyEngine\n+import io.envoyproxy.envoymobile.engine.EnvoyHTTPStream\n+import io.envoyproxy.envoymobile.engine.types.EnvoyHTTPCallbacks\n+\n+/**\n+ * Mock implementation of `EnvoyEngine`. Used internally for testing the bridging layer & mocking.\n+ */\n+internal class MockEnvoyEngine : EnvoyEngine {\n+  override fun runWithConfig(envoyConfiguration: EnvoyConfiguration?, logLevel: String?): Int {\n+    return 0\n+  }\n+\n+  override fun runWithConfig(configurationYAML: String?, logLevel: String?): Int {\n+    return 0\n+  }\n+\n+  override fun startStream(callbacks: EnvoyHTTPCallbacks?): EnvoyHTTPStream {\n+    return MockEnvoyHTTPStream(callbacks!!)\n+  }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTA4MTIx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433508121", "createdAt": "2020-06-18T17:40:46Z", "commit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzo0MDo0NlrOGl5riQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNzo0MDo0NlrOGl5riQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM5NTUyOQ==", "bodyText": "would highly recommend using kluent:\nhttps://github.com/MarkusAmshove/Kluent", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#discussion_r442395529", "createdAt": "2020-06-18T17:40:46Z", "author": {"login": "johnpaulmckean"}, "path": "library/kotlin/test/io/envoyproxy/envoymobile/GRPCRequestHeadersBuilderTest.kt", "diffHunk": "@@ -0,0 +1,69 @@\n+package io.envoyproxy.envoymobile\n+\n+import org.assertj.core.api.Assertions.assertThat\n+import org.junit.Test\n+\n+class GRPCRequestHeadersBuilderTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ff70a18918427c61a48093f1f1b6209f93e478"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d5ce6c61eb6ede4ae1328b85831901d24810478", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/2d5ce6c61eb6ede4ae1328b85831901d24810478", "committedDate": "2020-06-18T17:47:49Z", "message": "CR + running lint fixes\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34a840d3e67d0a6128005b51a66d13d2698d67e5", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/34a840d3e67d0a6128005b51a66d13d2698d67e5", "committedDate": "2020-06-18T18:55:17Z", "message": "missing overrides\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTg0MzEx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/913#pullrequestreview-433584311", "createdAt": "2020-06-18T19:30:29Z", "commit": {"oid": "34a840d3e67d0a6128005b51a66d13d2698d67e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4264, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}