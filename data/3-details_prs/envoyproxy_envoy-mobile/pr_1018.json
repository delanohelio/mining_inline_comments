{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1Nzg4NjIy", "number": 1018, "title": "crash fix: ensure main thread is destructed before Http::Dispatcher", "bodyText": "Description: Due to inverse destruction order, it was previously theoretically possible that the main thread could still be running and executing the event loop when the Http::Dispatcher had already been destroyed. This ensures that the normal destruction order of the Engine should ensure the main thread has been destructed (and terminated) before the dispatcher. Our presumption that the crash is called by this being null in the callback is covered by a new RELEASE_ASSERT, so that we can detect if further protection (e.g. capturing the dispatcher via a shared pointer in the callback) is needed.\nRisk Level: Low\nTesting: CI\nCo-authored-by: Jose Nino jnino@lyft.com\nSigned-off-by: Mike Schore mike.schore@gmail.com", "createdAt": "2020-08-10T23:56:49Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1018", "merged": true, "mergeCommit": {"oid": "fc5c570c5a32a63aef6b9f38500d84a416a89e01"}, "closed": true, "closedAt": "2020-08-11T18:17:30Z", "author": {"login": "goaway"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9rLLBgH2gAyNDY1Nzg4NjIyOmI1OTk3YTIyZThjNTJhOTBmNDBhODljY2U3NjlhNDI3N2E0YzUwMmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc96KuKAFqTQ2NTI3NDQwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b5997a22e8c52a90f40a89cce769a4277a4c502b", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/b5997a22e8c52a90f40a89cce769a4277a4c502b", "committedDate": "2020-08-10T23:53:35Z", "message": "crash fix: ensure main thread is destructed before Http::Dispatcher\n\nCo-authored-by: Jose Nino <jnino@lyft.com>\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NzU3NDU0", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1018#pullrequestreview-464757454", "createdAt": "2020-08-11T05:27:37Z", "commit": {"oid": "b5997a22e8c52a90f40a89cce769a4277a4c502b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNToyNzozOFrOG-o2rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNToyNzozOFrOG-o2rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMzNDI1Mw==", "bodyText": "Can we document this inline somewhere? We're now relying on implementation details of how destructors are called, which is very fragile. Tests would be ideal, but I understand this is probably quite difficult to test, so we should at least document it", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1018#discussion_r468334253", "createdAt": "2020-08-11T05:27:38Z", "author": {"login": "rebello95"}, "path": "library/common/engine.h", "diffHunk": "@@ -48,12 +48,12 @@ class Engine {\n   envoy_engine_callbacks callbacks_;\n   Thread::MutexBasicLockable mutex_;\n   Thread::CondVar cv_;\n-  std::thread main_thread_;\n   std::unique_ptr<Http::Dispatcher> http_dispatcher_;\n   std::unique_ptr<MobileMainCommon> main_common_ GUARDED_BY(mutex_);\n   Server::Instance* server_{};\n   Server::ServerLifecycleNotifier::HandlePtr postinit_callback_handler_;\n   Event::Dispatcher* event_dispatcher_;\n+  std::thread main_thread_;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5997a22e8c52a90f40a89cce769a4277a4c502b"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ad3cbf6520a8b5523c9e49fc2a54bc19d114d99", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/3ad3cbf6520a8b5523c9e49fc2a54bc19d114d99", "committedDate": "2020-08-11T16:17:14Z", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1Mjc0NDAz", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1018#pullrequestreview-465274403", "createdAt": "2020-08-11T17:21:40Z", "commit": {"oid": "3ad3cbf6520a8b5523c9e49fc2a54bc19d114d99"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4163, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}