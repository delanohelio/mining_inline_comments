{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MzU5MzE2", "number": 1021, "title": "shutdown: create avenues for shutdown out of static de-initialization", "bodyText": "Description: this PR attempts to fix two related crashes. By hooking up to iOS's notification system we attempt to terminate the engine earlier, and allow all objects necessary to be available fixing #1035. Potentially fixes #831.\nRisk Level: med - changes termination sequence\nTesting: added test\nSigned-off-by: Jose Nino jnino@lyft.com", "createdAt": "2020-08-11T21:15:42Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021", "merged": true, "mergeCommit": {"oid": "b30b61f99a24393d7a3187c1915f056f533bc9f9"}, "closed": true, "closedAt": "2020-09-04T00:45:00Z", "author": {"login": "junr03"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccNQBvAH2gAyNDY2MzU5MzE2OjE0YmJiYjBlOTYxMzkwNjE1ZDU0Yzc1NzIyYjM2NTE2ZjM3MGI1Y2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFXHvuAFqTQ4MjIwMTEwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "14bbbb0e961390615d54c75722b36516f370b5cf", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/14bbbb0e961390615d54c75722b36516f370b5cf", "committedDate": "2020-04-29T00:22:14Z", "message": "engine testing\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "273143cd096af223a3271cc0cd8f9eb08819f4d2", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/273143cd096af223a3271cc0cd8f9eb08819f4d2", "committedDate": "2020-04-29T21:21:35Z", "message": "experiment\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95508358fd31bc7bbbb99012a702b246c88f941c", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/95508358fd31bc7bbbb99012a702b246c88f941c", "committedDate": "2020-08-11T04:37:03Z", "message": "Merge branch 'main' into set-null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e88fd3cd5be8ad3ed612560ae9d25a070e29341", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/6e88fd3cd5be8ad3ed612560ae9d25a070e29341", "committedDate": "2020-08-11T20:21:57Z", "message": "look in linux\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93f5fa24d1121ebde10add10bb92705f63761bb9", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/93f5fa24d1121ebde10add10bb92705f63761bb9", "committedDate": "2020-08-11T20:57:09Z", "message": "join main thread\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91f3917ed4b1b75d4d8f430615660b2bc32b5764", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/91f3917ed4b1b75d4d8f430615660b2bc32b5764", "committedDate": "2020-08-11T21:26:48Z", "message": "clean up\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7daeb3135b04590fa09911c63b16d3f6ef3fdab", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/d7daeb3135b04590fa09911c63b16d3f6ef3fdab", "committedDate": "2020-08-11T21:27:32Z", "message": "clean up\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5c780411a669fbd74f01433a9212f8337ea921a", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/f5c780411a669fbd74f01433a9212f8337ea921a", "committedDate": "2020-08-11T22:11:42Z", "message": "bring back context\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "685cad333eb92ca0e6b84407bf113e830d7e8872", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/685cad333eb92ca0e6b84407bf113e830d7e8872", "committedDate": "2020-08-12T00:44:25Z", "message": "move strong ref\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dda8804c9dbda5976eede757eff03a0bec13c14", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/7dda8804c9dbda5976eede757eff03a0bec13c14", "committedDate": "2020-08-12T01:00:07Z", "message": "clean up\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9279776dc0332ce4d3fec4fbc15740868b58b80", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/e9279776dc0332ce4d3fec4fbc15740868b58b80", "committedDate": "2020-08-12T01:00:30Z", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ca9b043709720a2cdb0cee6c0ddbf08a43660f9", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/6ca9b043709720a2cdb0cee6c0ddbf08a43660f9", "committedDate": "2020-08-12T22:30:56Z", "message": "updates\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4378bb17a5f1810a8da643967919cde1443812d3", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/4378bb17a5f1810a8da643967919cde1443812d3", "committedDate": "2020-08-12T23:58:13Z", "message": "stamping and tests, missing context from platform for engine callbacks\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3d8caacee87efe183f27abcb95a3d30b9565f44", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/f3d8caacee87efe183f27abcb95a3d30b9565f44", "committedDate": "2020-08-13T01:17:25Z", "message": "final touches\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a6cbadc534e4ebdc6575435bd913a8aa1040343", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/2a6cbadc534e4ebdc6575435bd913a8aa1040343", "committedDate": "2020-08-13T19:04:10Z", "message": "ios and asan failures\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c9950f256e958d467fac99a886b99472bde7959", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/4c9950f256e958d467fac99a886b99472bde7959", "committedDate": "2020-08-13T20:19:40Z", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3OTIzMzg5", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#pullrequestreview-467923389", "createdAt": "2020-08-14T23:44:14Z", "commit": {"oid": "4c9950f256e958d467fac99a886b99472bde7959"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMzo0NDoxNFrOHBF3bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMzo0NDoxNFrOHBF3bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkwNjczNA==", "bodyText": "Can you provide some motivation here?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r470906734", "createdAt": "2020-08-14T23:44:14Z", "author": {"login": "goaway"}, "path": "library/common/engine.cc", "diffHunk": "@@ -21,17 +21,21 @@ Engine::Engine(envoy_engine_callbacks callbacks, const char* config, const char*\n   main_thread_ = std::thread(&Engine::run, this, std::string(config), std::string(log_level));\n }\n \n-envoy_status_t Engine::run(std::string config, std::string log_level) {\n+envoy_status_t Engine::run(const std::string config, const std::string log_level) {\n   {\n     Thread::LockGuard lock(mutex_);\n     try {\n-      char* envoy_argv[] = {strdup(\"envoy\"), strdup(\"--config-yaml\"),   strdup(config.c_str()),\n-                            strdup(\"-l\"),    strdup(log_level.c_str()), nullptr};\n+      const std::string name = \"envoy\";\n+      const std::string config_flag = \"--config-yaml\";\n+      const std::string log_flag = \"-l\";\n+      const char* envoy_argv[] = {name.c_str(),     config_flag.c_str(), config.c_str(),\n+                                  log_flag.c_str(), log_level.c_str(),   nullptr};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c9950f256e958d467fac99a886b99472bde7959"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3OTIzNzU2", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#pullrequestreview-467923756", "createdAt": "2020-08-14T23:45:46Z", "commit": {"oid": "4c9950f256e958d467fac99a886b99472bde7959"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMzo0NTo0NlrOHBF5LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMzo0NTo0NlrOHBF5LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkwNzE4MQ==", "bodyText": "This comment really applies to the event loop rather than the above calls now.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r470907181", "createdAt": "2020-08-14T23:45:46Z", "author": {"login": "goaway"}, "path": "library/common/engine.cc", "diffHunk": "@@ -60,13 +64,14 @@ envoy_status_t Engine::run(std::string config, std::string log_level) {\n   // The main run loop must run without holding the mutex, so that the destructor can acquire it.\n   bool run_success = TS_UNCHECKED_READ(main_common_)->run();\n \n-  // The above call is blocking; at this point the event loop has exited.\n-  callbacks_.on_exit();\n-\n   // Ensure destructors run on Envoy's main thread.\n+  http_dispatcher_->exit();\n   postinit_callback_handler_.reset();\n   TS_UNCHECKED_READ(main_common_).reset();\n \n+  // The above call is blocking; at this point the event loop has exited.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c9950f256e958d467fac99a886b99472bde7959"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b309cc73db498d74171b3a7b2d7df9f0964129b", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/5b309cc73db498d74171b3a7b2d7df9f0964129b", "committedDate": "2020-08-17T21:26:05Z", "message": "update comment placing\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1a6f8c65a5d3d6405d8b68ecb8dc178a3692456", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/e1a6f8c65a5d3d6405d8b68ecb8dc178a3692456", "committedDate": "2020-09-02T23:26:10Z", "message": "Merge branch 'main' into set-null\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cd198cd42df6afdacf011916582aef27ebf010d", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/6cd198cd42df6afdacf011916582aef27ebf010d", "committedDate": "2020-09-02T23:30:55Z", "message": "updates\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0757528016fa83f9a69c9eea4d800ec9dde4142", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/b0757528016fa83f9a69c9eea4d800ec9dde4142", "committedDate": "2020-09-03T00:26:58Z", "message": "error\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNjI3MjY3", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#pullrequestreview-481627267", "createdAt": "2020-09-03T08:46:53Z", "commit": {"oid": "b0757528016fa83f9a69c9eea4d800ec9dde4142"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwODo0Njo1M1rOHMcilw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwODo0Njo1M1rOHMcilw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxMjU2Nw==", "bodyText": "Won't this terminate the engine on any lifecycle notification? Or are we only registering for backgrounding/shutdown.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r482812567", "createdAt": "2020-09-03T08:46:53Z", "author": {"login": "goaway"}, "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -193,19 +195,18 @@ - (void)recordCounter:(NSString *)elements count:(NSUInteger)count {\n \n - (void)startObservingLifecycleNotifications {\n   NSNotificationCenter *notificationCenter = [NSNotificationCenter defaultCenter];\n-  [notificationCenter addObserver:self\n-                         selector:@selector(lifecycleDidChangeWithNotification:)\n-                             name:UIApplicationWillResignActiveNotification\n-                           object:nil];\n   [notificationCenter addObserver:self\n                          selector:@selector(lifecycleDidChangeWithNotification:)\n                              name:UIApplicationWillTerminateNotification\n                            object:nil];\n }\n \n - (void)lifecycleDidChangeWithNotification:(NSNotification *)notification {\n-  NSLog(@\"[Envoy] triggering stats flush (%@)\", notification.name);\n-  flush_stats();\n+  NSLog(@\"[Envoy] terminating engine (%@)\", notification.name);\n+  // TODO: ensure this is called with the correct envoy_engine_t once multiple Engine objects can\n+  // be allocated.\n+  // https://github.com/lyft/envoy-mobile/issues/332\n+  terminate_engine(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0757528016fa83f9a69c9eea4d800ec9dde4142"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNjI4OTI2", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#pullrequestreview-481628926", "createdAt": "2020-09-03T08:49:02Z", "commit": {"oid": "b0757528016fa83f9a69c9eea4d800ec9dde4142"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwODo0OTowMlrOHMcnSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwODo0OTowMlrOHMcnSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxMzc2OA==", "bodyText": "I agree this ordering makes more sense.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#discussion_r482813768", "createdAt": "2020-09-03T08:49:02Z", "author": {"login": "goaway"}, "path": "library/common/engine.cc", "diffHunk": "@@ -60,14 +64,14 @@ envoy_status_t Engine::run(std::string config, std::string log_level) {\n \n   // The main run loop must run without holding the mutex, so that the destructor can acquire it.\n   bool run_success = TS_UNCHECKED_READ(main_common_)->run();\n-\n   // The above call is blocking; at this point the event loop has exited.\n-  callbacks_.on_exit();\n \n   // Ensure destructors run on Envoy's main thread.\n   postinit_callback_handler_.reset();\n   TS_UNCHECKED_READ(main_common_).reset();\n \n+  callbacks_.on_exit(callbacks_.context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0757528016fa83f9a69c9eea4d800ec9dde4142"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "875224b75cda373f9746dc1dc31b81e47428b45d", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/875224b75cda373f9746dc1dc31b81e47428b45d", "committedDate": "2020-09-03T16:23:18Z", "message": "engine handle\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4710fa5611c326ebe256155e342d84b85751578e", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/4710fa5611c326ebe256155e342d84b85751578e", "committedDate": "2020-09-03T16:23:51Z", "message": "Merge branch 'main' into set-null\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bf2c1e13d2122b17b91fd766235d0c06a8c6222", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/6bf2c1e13d2122b17b91fd766235d0c06a8c6222", "committedDate": "2020-09-03T19:41:44Z", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMTg3Nzcy", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#pullrequestreview-482187772", "createdAt": "2020-09-03T20:41:13Z", "commit": {"oid": "6bf2c1e13d2122b17b91fd766235d0c06a8c6222"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbba71dbdf16ca5978dce3a40b12bb3f03dc3082", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/bbba71dbdf16ca5978dce3a40b12bb3f03dc3082", "committedDate": "2020-09-03T20:45:14Z", "message": "Merge branch 'main' into set-null\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccc55137ab275fa4a09a373516829ff0856e9dae", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/ccc55137ab275fa4a09a373516829ff0856e9dae", "committedDate": "2020-09-03T20:45:39Z", "message": "build\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjAxMTA0", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1021#pullrequestreview-482201104", "createdAt": "2020-09-03T21:03:08Z", "commit": {"oid": "ccc55137ab275fa4a09a373516829ff0856e9dae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4170, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}