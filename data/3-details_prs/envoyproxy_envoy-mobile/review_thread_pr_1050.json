{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczODk1MTUy", "number": 1050, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMzowMjoyNlrOEcyFDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMzowMjoyNlrOEcyFDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NjE2MDc3OnYy", "diffSide": "RIGHT", "path": "library/common/jni/jni_utility.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMzowMjoyNlrOHHhKIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMDozNjoxNlrOHIgWnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY0NTM0NQ==", "bodyText": "Please open issue for adding assertion dependency :)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1050#discussion_r477645345", "createdAt": "2020-08-26T23:02:26Z", "author": {"login": "buildbreaker"}, "path": "library/common/jni/jni_utility.cc", "diffHunk": "@@ -8,24 +8,26 @@\n // NOLINT(namespace-envoy)\n \n static JavaVM* static_jvm = nullptr;\n+static thread_local JNIEnv* local_env = nullptr;\n \n void set_vm(JavaVM* vm) { static_jvm = vm; }\n \n JavaVM* get_vm() { return static_jvm; }\n \n JNIEnv* get_env() {\n-  JNIEnv* env = nullptr;\n-  int get_env_res = static_jvm->GetEnv(reinterpret_cast<void**>(&env), JNI_VERSION);\n-  if (get_env_res == JNI_EDETACHED) {\n-    // TODO(goway): fix logging\n-    // log_write(ANDROID_LOG_VERBOSE, \"[Envoy]\", \"environment is JNI_EDETACHED\");\n+  if (local_env) {\n+    return local_env;\n+  }\n+\n+  jint result = static_jvm->GetEnv(reinterpret_cast<void**>(&local_env), JNI_VERSION);\n+  if (result == JNI_EDETACHED) {\n     // Note: the only thread that should need to be attached is Envoy's engine std::thread.\n-    // TODO: harden this piece of code to make sure that we are only needing to attach Envoy\n-    // engine's std::thread, and that we detach it successfully.\n-    static_jvm->AttachCurrentThread(&env, nullptr);\n-    static_jvm->GetEnv(reinterpret_cast<void**>(&env), JNI_VERSION);\n+    JavaVMAttachArgs args = {JNI_VERSION, \"EnvoyMain\", NULL};\n+    result = static_jvm->AttachCurrentThread(&local_env, &args);\n   }\n-  return env;\n+  // TODO(goaway): add assertions and uncomment\n+  // ASSERT(result == JNI_OK);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976a63823cc71a589ca4a651505b34e17c393900"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY4MDczMg==", "bodyText": "#1054", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1050#discussion_r478680732", "createdAt": "2020-08-27T20:36:16Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_utility.cc", "diffHunk": "@@ -8,24 +8,26 @@\n // NOLINT(namespace-envoy)\n \n static JavaVM* static_jvm = nullptr;\n+static thread_local JNIEnv* local_env = nullptr;\n \n void set_vm(JavaVM* vm) { static_jvm = vm; }\n \n JavaVM* get_vm() { return static_jvm; }\n \n JNIEnv* get_env() {\n-  JNIEnv* env = nullptr;\n-  int get_env_res = static_jvm->GetEnv(reinterpret_cast<void**>(&env), JNI_VERSION);\n-  if (get_env_res == JNI_EDETACHED) {\n-    // TODO(goway): fix logging\n-    // log_write(ANDROID_LOG_VERBOSE, \"[Envoy]\", \"environment is JNI_EDETACHED\");\n+  if (local_env) {\n+    return local_env;\n+  }\n+\n+  jint result = static_jvm->GetEnv(reinterpret_cast<void**>(&local_env), JNI_VERSION);\n+  if (result == JNI_EDETACHED) {\n     // Note: the only thread that should need to be attached is Envoy's engine std::thread.\n-    // TODO: harden this piece of code to make sure that we are only needing to attach Envoy\n-    // engine's std::thread, and that we detach it successfully.\n-    static_jvm->AttachCurrentThread(&env, nullptr);\n-    static_jvm->GetEnv(reinterpret_cast<void**>(&env), JNI_VERSION);\n+    JavaVMAttachArgs args = {JNI_VERSION, \"EnvoyMain\", NULL};\n+    result = static_jvm->AttachCurrentThread(&local_env, &args);\n   }\n-  return env;\n+  // TODO(goaway): add assertions and uncomment\n+  // ASSERT(result == JNI_OK);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY0NTM0NQ=="}, "originalCommit": {"oid": "976a63823cc71a589ca4a651505b34e17c393900"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 582, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}