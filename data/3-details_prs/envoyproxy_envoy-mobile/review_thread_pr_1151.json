{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNTEwMzAz", "number": 1151, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo1MDoxM1rOEy_syA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo1MToxMlrOEy_uCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxOTA3OTEyOnYy", "diffSide": "RIGHT", "path": "library/common/jni/jni_interface.cc", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo1MDoxM1rOHp84ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMVQwMzo0ODozNlrOHrr-Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTE3OA==", "bodyText": "sorry, I am a bit decontextualized here. Why 3? Can we have a constant?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r513751178", "createdAt": "2020-10-28T20:50:13Z", "author": {"login": "junr03"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -259,10 +259,18 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onRequestData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;\n+  if (size == 3) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "738d22c734d45cdd41d681dc5ec23b31dd3543ba"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2NjYyNA==", "bodyText": "Yeah, this isn't a great check. I'd like to move to fully-bridged types for filter statuses. But this ensures we don't attempt out of bounds access on the array.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r513766624", "createdAt": "2020-10-28T21:17:36Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -259,10 +259,18 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onRequestData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;\n+  if (size == 3) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTE3OA=="}, "originalCommit": {"oid": "738d22c734d45cdd41d681dc5ec23b31dd3543ba"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYxNDcwMw==", "bodyText": "Sure the comment helps. Can we state why 3 here and 4 below? Maybe make them constants?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r514614703", "createdAt": "2020-10-29T22:58:44Z", "author": {"login": "junr03"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -259,10 +259,18 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onRequestData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;\n+  if (size == 3) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTE3OA=="}, "originalCommit": {"oid": "738d22c734d45cdd41d681dc5ec23b31dd3543ba"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDgzODgwMg==", "bodyText": "Sure, I'll do that.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r514838802", "createdAt": "2020-10-30T04:32:05Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -259,10 +259,18 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onRequestData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;\n+  if (size == 3) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTE3OA=="}, "originalCommit": {"oid": "738d22c734d45cdd41d681dc5ec23b31dd3543ba"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU3MTI1NQ==", "bodyText": "Updated with a different and clearer check.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r515571255", "createdAt": "2020-11-01T03:48:36Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -259,10 +259,18 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onRequestData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;\n+  if (size == 3) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTE3OA=="}, "originalCommit": {"oid": "738d22c734d45cdd41d681dc5ec23b31dd3543ba"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxOTA4MTcwOnYy", "diffSide": "RIGHT", "path": "library/common/jni/jni_interface.cc", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo1MDo1OFrOHp86IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwODoxODo1MFrOHrl5fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTU4NA==", "bodyText": "Can we create static funcs for the repeated code in these functions?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r513751584", "createdAt": "2020-10-28T20:50:58Z", "author": {"login": "junr03"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -271,18 +279,27 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   env->DeleteLocalRef(j_data);\n \n   return (envoy_filter_data_status){/*status*/ unboxed_status,\n-                                    /*data*/ native_data};\n+                                    /*data*/ native_data,\n+                                    /*pending_headers*/ pending_headers};\n }\n \n static envoy_filter_data_status jvm_http_filter_on_response_data(envoy_data data, bool end_stream,\n                                                                  const void* context) {\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onResponseData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "738d22c734d45cdd41d681dc5ec23b31dd3543ba"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc2NTA1MA==", "bodyText": "I think the common factoring that's already here complicates following the code in this file somewhat, and would hesitate to push it further.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r513765050", "createdAt": "2020-10-28T21:14:43Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -271,18 +279,27 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   env->DeleteLocalRef(j_data);\n \n   return (envoy_filter_data_status){/*status*/ unboxed_status,\n-                                    /*data*/ native_data};\n+                                    /*data*/ native_data,\n+                                    /*pending_headers*/ pending_headers};\n }\n \n static envoy_filter_data_status jvm_http_filter_on_response_data(envoy_data data, bool end_stream,\n                                                                  const void* context) {\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onResponseData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTU4NA=="}, "originalCommit": {"oid": "738d22c734d45cdd41d681dc5ec23b31dd3543ba"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYxNTAzOQ==", "bodyText": "Not sure I completely agree. But feel free to TIOLI!", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r514615039", "createdAt": "2020-10-29T22:59:36Z", "author": {"login": "junr03"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -271,18 +279,27 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   env->DeleteLocalRef(j_data);\n \n   return (envoy_filter_data_status){/*status*/ unboxed_status,\n-                                    /*data*/ native_data};\n+                                    /*data*/ native_data,\n+                                    /*pending_headers*/ pending_headers};\n }\n \n static envoy_filter_data_status jvm_http_filter_on_response_data(envoy_data data, bool end_stream,\n                                                                  const void* context) {\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onResponseData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTU4NA=="}, "originalCommit": {"oid": "738d22c734d45cdd41d681dc5ec23b31dd3543ba"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ3MTc0MQ==", "bodyText": "Thanks, I do appreciate the perspective. I'll think further about how this could be simplified, but for now I'm going to stick with my inclination to leave it. Note there's a great deal of dispatch to common-factored paths already occurring. e.g. the jvm_http_filter_on_response_headers delegates to jvm_on_response_headers, which delegates to jvm_on_headers, which delegates pass_headers, all of which make use of further extracted common utility functions. While this common factoring can serve to encapsulate logic, it also means you need to jump between more locations to follow what's actually happening.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r515471741", "createdAt": "2020-10-31T08:18:50Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -271,18 +279,27 @@ static envoy_filter_data_status jvm_http_filter_on_request_data(envoy_data data,\n   env->DeleteLocalRef(j_data);\n \n   return (envoy_filter_data_status){/*status*/ unboxed_status,\n-                                    /*data*/ native_data};\n+                                    /*data*/ native_data,\n+                                    /*pending_headers*/ pending_headers};\n }\n \n static envoy_filter_data_status jvm_http_filter_on_response_data(envoy_data data, bool end_stream,\n                                                                  const void* context) {\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_data(\"onResponseData\", data, end_stream, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobject j_data = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n+  envoy_headers* pending_headers = nullptr;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTU4NA=="}, "originalCommit": {"oid": "738d22c734d45cdd41d681dc5ec23b31dd3543ba"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxOTA4MjMyOnYy", "diffSide": "RIGHT", "path": "library/common/jni/jni_interface.cc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo1MToxMlrOHp86fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo1MToxMlrOHp86fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MTY3Nw==", "bodyText": "Same two comments as above", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1151#discussion_r513751677", "createdAt": "2020-10-28T20:51:12Z", "author": {"login": "junr03"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -328,39 +346,69 @@ static envoy_filter_trailers_status jvm_http_filter_on_request_trailers(envoy_he\n   JNIEnv* env = get_env();\n   jobjectArray result = static_cast<jobjectArray>(\n       jvm_on_trailers(\"onRequestTrailers\", trailers, const_cast<void*>(context)));\n+  jsize size = env->GetArrayLength(result);\n \n   jobject status = env->GetObjectArrayElement(result, 0);\n   jobjectArray j_trailers = static_cast<jobjectArray>(env->GetObjectArrayElement(result, 1));\n \n   int unboxed_status = unbox_integer(env, status);\n-  envoy_headers native_headers = to_native_headers(env, j_trailers);\n+  envoy_headers native_trailers = to_native_headers(env, j_trailers);\n+\n+  envoy_headers* pending_headers = nullptr;\n+  envoy_data* pending_data = nullptr;\n+  if (size == 4) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "738d22c734d45cdd41d681dc5ec23b31dd3543ba"}, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 487, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}