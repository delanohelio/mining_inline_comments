{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNjU1NTE2", "number": 962, "title": "filters: add bridge support for data invocations", "bodyText": "Description: Add initial support for HTTP body data chunks to be bridged to platform filter invocations.\nRisk Level: Moderate\nTesting: Local\nSigned-off-by: Mike Schore mike.schore@gmail.com", "createdAt": "2020-07-17T01:21:26Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/962", "merged": true, "mergeCommit": {"oid": "9d858eeb0f1150702f8391e044f7a8b6ec7d7377"}, "closed": true, "closedAt": "2020-07-22T00:27:06Z", "author": {"login": "goaway"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1r-7LgFqTQ1MDM2MjI3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3Pp3IgFqTQ1MjkxNjEzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzYyMjc3", "url": "https://github.com/envoyproxy/envoy-mobile/pull/962#pullrequestreview-450362277", "createdAt": "2020-07-17T04:18:43Z", "commit": {"oid": "c0529be2dc35a8044a6229296be03c2721edac03"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0529be2dc35a8044a6229296be03c2721edac03", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/c0529be2dc35a8044a6229296be03c2721edac03", "committedDate": "2020-07-17T01:19:13Z", "message": "filters: add bridge support for data invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "459086011e005f62cb4f13a99cca5ed9d0732245", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/459086011e005f62cb4f13a99cca5ed9d0732245", "committedDate": "2020-07-17T21:29:42Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47706e83edc325c4e2f8840752eed27df1807956", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/47706e83edc325c4e2f8840752eed27df1807956", "committedDate": "2020-07-21T17:46:23Z", "message": "filters: add bridge support for data invocations\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82f4eb2ae55495cbbe766a6f0246b48821878057", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/82f4eb2ae55495cbbe766a6f0246b48821878057", "committedDate": "2020-07-21T17:46:23Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "459086011e005f62cb4f13a99cca5ed9d0732245", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/459086011e005f62cb4f13a99cca5ed9d0732245", "committedDate": "2020-07-17T21:29:42Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "b616e28c6f5a0d019af61cecaf4c07345a1f4478", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/b616e28c6f5a0d019af61cecaf4c07345a1f4478", "committedDate": "2020-07-21T17:51:56Z", "message": "update status to externed consts\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f42f6131ad8f6d04af43e1fc4e2820c046d30db6", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/f42f6131ad8f6d04af43e1fc4e2820c046d30db6", "committedDate": "2020-07-21T18:26:11Z", "message": "update status to externed consts\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b616e28c6f5a0d019af61cecaf4c07345a1f4478", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/b616e28c6f5a0d019af61cecaf4c07345a1f4478", "committedDate": "2020-07-21T17:51:56Z", "message": "update status to externed consts\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "f42f6131ad8f6d04af43e1fc4e2820c046d30db6", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/f42f6131ad8f6d04af43e1fc4e2820c046d30db6", "committedDate": "2020-07-21T18:26:11Z", "message": "update status to externed consts\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7374320b218361bd6ea301fb22da58bd34a62204", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/7374320b218361bd6ea301fb22da58bd34a62204", "committedDate": "2020-07-21T18:51:03Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a60e3c005d518fe812f71a402df189caa217535", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/0a60e3c005d518fe812f71a402df189caa217535", "committedDate": "2020-07-21T22:09:53Z", "message": "fix types\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyODk0ODIx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/962#pullrequestreview-452894821", "createdAt": "2020-07-21T23:22:01Z", "commit": {"oid": "0a60e3c005d518fe812f71a402df189caa217535"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMzoyMjowMVrOG1NN-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMzozMDo0NlrOG1NY_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NDI4MA==", "bodyText": "nit: is the k prefix a common c-style convention?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/962#discussion_r458444280", "createdAt": "2020-07-21T23:22:01Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/platform_bridge/c_types.cc", "diffHunk": "@@ -13,3 +13,10 @@ const envoy_filter_headers_status_t kEnvoyFilterHeadersStatusContinueAndEndStrea\n const envoy_filter_headers_status_t kEnvoyFilterHeadersStatusStopAllIterationAndBuffer =\n     static_cast<envoy_filter_headers_status_t>(\n         Envoy::Http::FilterHeadersStatus::StopAllIterationAndBuffer);\n+\n+const envoy_filter_data_status_t kEnvoyFilterDataStatusContinue =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a60e3c005d518fe812f71a402df189caa217535"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NDUyMw==", "bodyText": "Can we document this style decision in STYLE.md?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/962#discussion_r458444523", "createdAt": "2020-07-21T23:22:57Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/platform_bridge/c_types.h", "diffHunk": "@@ -24,11 +24,10 @@ typedef struct {\n /**\n  * Return codes for on-data filter invocations. @see envoy/http/filter.h\n  */\n-typedef enum {\n-  ENVOY_FILTER_DATA_STATUS_CONTINUE = 0,\n-  ENVOY_FILTER_DATA_STATUS_STOP_ITERATION_AND_BUFFER,\n-  ENVOY_FILTER_DATA_STATUS_STOP_ITERATION_NO_BUFFER,\n-} envoy_filter_data_status_t;\n+typedef int envoy_filter_data_status_t;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a60e3c005d518fe812f71a402df189caa217535"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NzEwMA==", "bodyText": "I still think that this wrapping class is such a nifty approach, love it.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/962#discussion_r458447100", "createdAt": "2020-07-21T23:30:46Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -47,15 +48,37 @@ Http::FilterHeadersStatus PlatformBridgeFilter::onHeaders(Http::HeaderMap& heade\n   return status;\n }\n \n+Http::FilterDataStatus PlatformBridgeFilter::onData(Buffer::Instance& data, bool end_stream,\n+                                                    envoy_filter_on_data_f on_data) {\n+  // Allow nullptr to act as (optimized) no-op.\n+  if (on_data == nullptr) {\n+    return Http::FilterDataStatus::Continue;\n+  }\n+\n+  envoy_data in_data = Buffer::Utility::toBridgeData(data);\n+  envoy_filter_data_status result = on_data(in_data, end_stream, platform_filter_->context);\n+  Http::FilterDataStatus status = static_cast<Http::FilterDataStatus>(result.status);\n+  // Current platform implementations expose immutable data, thus any modification necessitates a\n+  // full copy. If the returned buffer is identical, we assume no modification was made and elide\n+  // the copy here. See also https://github.com/lyft/envoy-mobile/issues/949 for potential future\n+  // optimization.\n+  if (in_data.bytes != result.data.bytes) {\n+    data.drain(data.length());\n+    data.addBufferFragment(*Buffer::BridgeFragment::createBridgeFragment(result.data));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a60e3c005d518fe812f71a402df189caa217535"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTE2MTM0", "url": "https://github.com/envoyproxy/envoy-mobile/pull/962#pullrequestreview-452916134", "createdAt": "2020-07-22T00:26:13Z", "commit": {"oid": "0a60e3c005d518fe812f71a402df189caa217535"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4108, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}