{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1MDIyNTE1", "number": 1188, "title": "bridge: add register string accessor functionality plus expose on Android", "bodyText": "Description: this PR adds the ability to register string accessors from the platform to the engine. This allows the core layer to access strings from the platform at runtime. Two highlights:\n\nEventually this mechanism should be made generic to be able to access and set arbitrary types from the platform. This is very type-specific as a POC. #1192\nThis PR only wires up Android's platform layer all the way. A subsequent PR will do the same for iOS.\n\nRisk Level: low - new API\nTesting: using the example app.\nSigned-off-by: Jose Nino jnino@lyft.com", "createdAt": "2020-11-21T00:25:35Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188", "merged": true, "mergeCommit": {"oid": "db4cbb08d2c1287b5315a3ee6fe5dbef90e851d1"}, "closed": true, "closedAt": "2020-12-04T00:19:41Z", "author": {"login": "junr03"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdegwwlgH2gAyNTI1MDIyNTE1OmZiYjE2OTBiODIyNjM4OGFhODc1YjQ5YzJkMWNlMTE2ZjljY2Q1MDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiitkEAFqTU0MzkyNTI2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/fbb1690b8226388aa875b49c2d1ce116f9ccd505", "committedDate": "2020-11-21T00:25:11Z", "message": "bridge: add register string accessor functionality plus expose on Android\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODU2OTg2", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#pullrequestreview-535856986", "createdAt": "2020-11-21T00:29:53Z", "commit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyOTo1NFrOH3k3mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDoyOTo1NFrOH3k3mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzNzc4NQ==", "bodyText": "Given that this accessor runs on the threading context that calls it I am not sure if we need it versus just passing the EnvoyStringAccessor to the jni and retaining that.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#discussion_r528037785", "createdAt": "2020-11-21T00:29:54Z", "author": {"login": "junr03"}, "path": "library/java/src/io/envoyproxy/envoymobile/engine/JvmStringAccessorContext.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package io.envoyproxy.envoymobile.engine;\n+\n+import java.nio.ByteBuffer;\n+\n+import io.envoyproxy.envoymobile.engine.types.EnvoyStringAccessor;\n+\n+class JvmStringAccessorContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODU3NDc4", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#pullrequestreview-535857478", "createdAt": "2020-11-21T00:32:18Z", "commit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDozMjoxOFrOH3k5fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMDozMjoxOFrOH3k5fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzODI2OQ==", "bodyText": "decided to return a ByteBuffer here rather than a String to take advantage of the utilities we already have that bridge it into an envoy_data.\nAlthough it wouldn't be too complicated to create a bridging utility from String to envoy_data if we'd rather use that type.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#discussion_r528038269", "createdAt": "2020-11-21T00:32:18Z", "author": {"login": "junr03"}, "path": "library/java/src/io/envoyproxy/envoymobile/engine/types/EnvoyStringAccessor.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package io.envoyproxy.envoymobile.engine.types;\n+\n+import java.nio.ByteBuffer;\n+\n+public interface EnvoyStringAccessor {\n+\n+  /**\n+   * Called to retrieve a string from the Application\n+   */\n+  ByteBuffer getString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NDE0ODA5", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#pullrequestreview-537414809", "createdAt": "2020-11-24T11:51:04Z", "commit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMTo1MTowNFrOH49U9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMTo1MTowNFrOH49U9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ4NzA5NA==", "bodyText": "This is a leak - the local ref needs to be deleted at the end of this function.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#discussion_r529487094", "createdAt": "2020-11-24T11:51:04Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -610,6 +611,19 @@ static const void* jvm_http_filter_init(const void* context) {\n   return retained_filter;\n }\n \n+// EnvoyStringAccessor\n+\n+static envoy_data jvm_get_string(void* context) {\n+  JNIEnv* env = get_env();\n+  jobject j_context = static_cast<jobject>(context);\n+  jclass jcls_JvmStringAccessorContext = env->GetObjectClass(j_context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NDE1MTMx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#pullrequestreview-537415131", "createdAt": "2020-11-24T11:51:31Z", "commit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMTo1MTozMVrOH49V_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMTo1MTozMVrOH49V_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ4NzM1OA==", "bodyText": "(This is not a leak - jmethodID is an int.)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#discussion_r529487358", "createdAt": "2020-11-24T11:51:31Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -610,6 +611,19 @@ static const void* jvm_http_filter_init(const void* context) {\n   return retained_filter;\n }\n \n+// EnvoyStringAccessor\n+\n+static envoy_data jvm_get_string(void* context) {\n+  JNIEnv* env = get_env();\n+  jobject j_context = static_cast<jobject>(context);\n+  jclass jcls_JvmStringAccessorContext = env->GetObjectClass(j_context);\n+  jmethodID jmid_getString =\n+      env->GetMethodID(jcls_JvmStringAccessorContext, \"getString\", \"()Ljava/lang/Object;\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NDE1NDE3", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#pullrequestreview-537415417", "createdAt": "2020-11-24T11:51:58Z", "commit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMTo1MTo1OFrOH49W8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMTo1MTo1OFrOH49W8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ4NzYwMQ==", "bodyText": "Also leaking.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#discussion_r529487601", "createdAt": "2020-11-24T11:51:58Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -610,6 +611,19 @@ static const void* jvm_http_filter_init(const void* context) {\n   return retained_filter;\n }\n \n+// EnvoyStringAccessor\n+\n+static envoy_data jvm_get_string(void* context) {\n+  JNIEnv* env = get_env();\n+  jobject j_context = static_cast<jobject>(context);\n+  jclass jcls_JvmStringAccessorContext = env->GetObjectClass(j_context);\n+  jmethodID jmid_getString =\n+      env->GetMethodID(jcls_JvmStringAccessorContext, \"getString\", \"()Ljava/lang/Object;\");\n+  // Passed as a java.nio.ByteBuffer.\n+  jobject data = env->CallObjectMethod(j_context, jmid_getString);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbb1690b8226388aa875b49c2d1ce116f9ccd505"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe74a2a4c24a24660c358a8906c9a11f68f5a3ee", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/fe74a2a4c24a24660c358a8906c9a11f68f5a3ee", "committedDate": "2020-11-24T22:05:41Z", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6f16b1c7053e60bf56a439cd58f972c5adf1f69", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/a6f16b1c7053e60bf56a439cd58f972c5adf1f69", "committedDate": "2020-12-01T17:52:21Z", "message": "add accessor all the way\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be82552d1711b1100724da34c0e6eaa5f89cfd5c", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/be82552d1711b1100724da34c0e6eaa5f89cfd5c", "committedDate": "2020-12-01T18:12:23Z", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5659a0199d0103a81cf68e1eac62187c00ed1961", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/5659a0199d0103a81cf68e1eac62187c00ed1961", "committedDate": "2020-12-01T18:12:49Z", "message": "Merge branch 'main' into register-api\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzc2MjM0", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#pullrequestreview-542376234", "createdAt": "2020-12-01T23:15:04Z", "commit": {"oid": "5659a0199d0103a81cf68e1eac62187c00ed1961"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMzoxNTowNFrOH9DtrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMzoxNTowNFrOH9DtrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc4NjAyOQ==", "bodyText": "Please add a docstring here and clarify that this is ready only.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#discussion_r533786029", "createdAt": "2020-12-01T23:15:04Z", "author": {"login": "goaway"}, "path": "library/common/api/c_types.h", "diffHunk": "@@ -0,0 +1,20 @@\n+#pragma once\n+\n+#include \"library/common/types/c_types.h\"\n+\n+// NOLINT(namespace-envoy)\n+\n+#ifdef __cplusplus\n+extern \"C\" { // function pointers\n+#endif\n+\n+typedef envoy_data (*envoy_get_string_f)(void* context);\n+\n+#ifdef __cplusplus\n+} // function pointers\n+#endif\n+\n+typedef struct {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5659a0199d0103a81cf68e1eac62187c00ed1961"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzc2NDA2", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#pullrequestreview-542376406", "createdAt": "2020-12-01T23:15:22Z", "commit": {"oid": "5659a0199d0103a81cf68e1eac62187c00ed1961"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a694d726dc06fa7f8e898e4761ab8c88d3ad57f", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/4a694d726dc06fa7f8e898e4761ab8c88d3ad57f", "committedDate": "2020-12-02T00:20:41Z", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84877a26491b19d00ee7fda7a9a0751207440553", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/84877a26491b19d00ee7fda7a9a0751207440553", "committedDate": "2020-12-03T00:58:36Z", "message": "fix test\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzOTI1MjYy", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1188#pullrequestreview-543925262", "createdAt": "2020-12-03T12:57:12Z", "commit": {"oid": "84877a26491b19d00ee7fda7a9a0751207440553"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3921, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}