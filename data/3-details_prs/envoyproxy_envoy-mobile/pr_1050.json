{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczODk1MTUy", "number": 1050, "title": "jni: make get_env skip JNI calls for the normal case", "bodyText": "Description: Previously, get_env would make unnecessary JNI calls every time it was called, making it relatively expensive, and encouraging passing the pointer around everywhere. This makes it faster in the normal case by skipping JNI calls except for the first time a thread uses it.\nRisk Level: Low\nTesting: Local and CI\nSigned-off-by: Mike Schore mike.schore@gmail.com", "createdAt": "2020-08-26T13:08:56Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1050", "merged": true, "mergeCommit": {"oid": "2ac04ff5d14c659f6a9f19ff2796ad01d04f1855"}, "closed": true, "closedAt": "2020-08-27T20:36:33Z", "author": {"login": "goaway"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCrij0gH2gAyNDczODk1MTUyOjY4MjEwMjM0ZjFmNGE0NTNjNTU3MGI5YWQwM2IxNDgyMDI2ZmJjMjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdC0CF9AFqTQ3NjAzNzEyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "68210234f1f4a453c5570b9ad03b1482026fbc29", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/68210234f1f4a453c5570b9ad03b1482026fbc29", "committedDate": "2020-08-26T13:08:45Z", "message": "jni: make get_env skip JNI calls for the normal case\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6003f24ea9130bfbdec7fa043fc659f1e3dc73d2", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/6003f24ea9130bfbdec7fa043fc659f1e3dc73d2", "committedDate": "2020-08-26T13:02:30Z", "message": "jni: make get_env skip JNI calls for the normal case\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "68210234f1f4a453c5570b9ad03b1482026fbc29", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/68210234f1f4a453c5570b9ad03b1482026fbc29", "committedDate": "2020-08-26T13:08:45Z", "message": "jni: make get_env skip JNI calls for the normal case\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be6d62699df7d46f65467b9404e4bd5e75ba67bb", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/be6d62699df7d46f65467b9404e4bd5e75ba67bb", "committedDate": "2020-08-26T13:51:26Z", "message": "fix cast\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "976a63823cc71a589ca4a651505b34e17c393900", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/976a63823cc71a589ca4a651505b34e17c393900", "committedDate": "2020-08-26T13:56:19Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2MDM0ODYy", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1050#pullrequestreview-476034862", "createdAt": "2020-08-26T23:01:09Z", "commit": {"oid": "976a63823cc71a589ca4a651505b34e17c393900"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2MDM3MTIx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1050#pullrequestreview-476037121", "createdAt": "2020-08-26T23:02:26Z", "commit": {"oid": "976a63823cc71a589ca4a651505b34e17c393900"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMzowMjoyNlrOHHhKIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMzowMjoyNlrOHHhKIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzY0NTM0NQ==", "bodyText": "Please open issue for adding assertion dependency :)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1050#discussion_r477645345", "createdAt": "2020-08-26T23:02:26Z", "author": {"login": "buildbreaker"}, "path": "library/common/jni/jni_utility.cc", "diffHunk": "@@ -8,24 +8,26 @@\n // NOLINT(namespace-envoy)\n \n static JavaVM* static_jvm = nullptr;\n+static thread_local JNIEnv* local_env = nullptr;\n \n void set_vm(JavaVM* vm) { static_jvm = vm; }\n \n JavaVM* get_vm() { return static_jvm; }\n \n JNIEnv* get_env() {\n-  JNIEnv* env = nullptr;\n-  int get_env_res = static_jvm->GetEnv(reinterpret_cast<void**>(&env), JNI_VERSION);\n-  if (get_env_res == JNI_EDETACHED) {\n-    // TODO(goway): fix logging\n-    // log_write(ANDROID_LOG_VERBOSE, \"[Envoy]\", \"environment is JNI_EDETACHED\");\n+  if (local_env) {\n+    return local_env;\n+  }\n+\n+  jint result = static_jvm->GetEnv(reinterpret_cast<void**>(&local_env), JNI_VERSION);\n+  if (result == JNI_EDETACHED) {\n     // Note: the only thread that should need to be attached is Envoy's engine std::thread.\n-    // TODO: harden this piece of code to make sure that we are only needing to attach Envoy\n-    // engine's std::thread, and that we detach it successfully.\n-    static_jvm->AttachCurrentThread(&env, nullptr);\n-    static_jvm->GetEnv(reinterpret_cast<void**>(&env), JNI_VERSION);\n+    JavaVMAttachArgs args = {JNI_VERSION, \"EnvoyMain\", NULL};\n+    result = static_jvm->AttachCurrentThread(&local_env, &args);\n   }\n-  return env;\n+  // TODO(goaway): add assertions and uncomment\n+  // ASSERT(result == JNI_OK);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976a63823cc71a589ca4a651505b34e17c393900"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3988, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}