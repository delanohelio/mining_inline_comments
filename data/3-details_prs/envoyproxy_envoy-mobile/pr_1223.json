{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyODA2NzEy", "number": 1223, "title": "python: engine implementation", "bodyText": "Description:\nAll header changes in this PR come from #1217, that should be reviewed and merged first.\nThis PR implements all of the engine-related classes, like Engine and EngineBuilder.\nRisk Level: Low\nTesting: N/A, will follow up when everything is finished with e2e testing + unit testing in Python and/or C++\nDocs Changes: N/A\nRelease Notes: N/A", "createdAt": "2020-12-18T22:38:42Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1223", "merged": true, "mergeCommit": {"oid": "7299831faae56683875f6548416e4b05c6484256"}, "closed": true, "closedAt": "2021-01-13T18:49:53Z", "author": {"login": "crockeo"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdthzzwgBqjQxNzU5MDM4NzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdv0UTdgFqTU2NzUyMTA3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7251818585f871d7eac698e300d37c1bbc04a73b", "author": {"user": {"login": "crockeo", "name": "Cerek Hillen"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/7251818585f871d7eac698e300d37c1bbc04a73b", "committedDate": "2020-12-18T22:00:32Z", "message": "py-envoy-mobile engine\n\nSigned-off-by: Cerek Hillen <chillen@lyft.com>"}, "afterCommit": {"oid": "29116a326ee13d35387f51760db43cfbb6d3f72a", "author": {"user": {"login": "crockeo", "name": "Cerek Hillen"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/29116a326ee13d35387f51760db43cfbb6d3f72a", "committedDate": "2021-01-06T16:07:04Z", "message": "py-envoy-mobile engine\n\nSigned-off-by: Cerek Hillen <chillen@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzODU1Nzc1", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1223#pullrequestreview-563855775", "createdAt": "2021-01-07T21:55:09Z", "commit": {"oid": "001420cc040c8c97a250865fa7fa80e1d517a317"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QyMTo1NTowOVrOIP93cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QyMTo1NTowOVrOIP93cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYxMzE3MA==", "bodyText": "I don't think it needs to be a blocker or necessarily changed here, but I might consider putting these in an anonymous namespace instead of using private static functions.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1223#discussion_r553613170", "createdAt": "2021-01-07T21:55:09Z", "author": {"login": "goaway"}, "path": "library/cc/engine.cc", "diffHunk": "@@ -0,0 +1,42 @@\n+#include \"engine.h\"\n+\n+#include \"library/common/main_interface.h\"\n+#include \"library/common/types/c_types.h\"\n+\n+namespace Envoy {\n+namespace Platform {\n+\n+Engine::Engine(envoy_engine_t engine, const std::string& configuration, LogLevel log_level,\n+               std::function<void()> on_engine_running)\n+    : engine_(engine), on_engine_running_(on_engine_running) {\n+  envoy_engine_callbacks callbacks{\n+      .on_engine_running = &Engine::c_on_engine_running,\n+      .on_exit = &Engine::c_on_exit,\n+      .context = this,\n+  };\n+\n+  run_engine(this->engine_, callbacks, configuration.c_str(),\n+             log_level_to_string(log_level).c_str());\n+\n+  this->stream_client_ = std::make_shared<StreamClient>(this->engine_);\n+  this->pulse_client_ = std::make_shared<PulseClient>();\n+}\n+\n+Engine::~Engine() { terminate_engine(this->engine_); }\n+\n+StreamClientSharedPtr Engine::stream_client() { return this->stream_client_; }\n+PulseClientSharedPtr Engine::pulse_client() { return this->pulse_client_; }\n+\n+void Engine::c_on_engine_running(void* context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "001420cc040c8c97a250865fa7fa80e1d517a317"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzODU4NTAx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1223#pullrequestreview-563858501", "createdAt": "2021-01-07T21:59:52Z", "commit": {"oid": "001420cc040c8c97a250865fa7fa80e1d517a317"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QyMTo1OTo1MlrOIP9_1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QyMTo1OTo1MlrOIP9_1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYxNTMxOA==", "bodyText": "nit: since this is static, let's maybe say engine instead of self for clarity.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1223#discussion_r553615318", "createdAt": "2021-01-07T21:59:52Z", "author": {"login": "goaway"}, "path": "library/cc/engine.cc", "diffHunk": "@@ -0,0 +1,42 @@\n+#include \"engine.h\"\n+\n+#include \"library/common/main_interface.h\"\n+#include \"library/common/types/c_types.h\"\n+\n+namespace Envoy {\n+namespace Platform {\n+\n+Engine::Engine(envoy_engine_t engine, const std::string& configuration, LogLevel log_level,\n+               std::function<void()> on_engine_running)\n+    : engine_(engine), on_engine_running_(on_engine_running) {\n+  envoy_engine_callbacks callbacks{\n+      .on_engine_running = &Engine::c_on_engine_running,\n+      .on_exit = &Engine::c_on_exit,\n+      .context = this,\n+  };\n+\n+  run_engine(this->engine_, callbacks, configuration.c_str(),\n+             log_level_to_string(log_level).c_str());\n+\n+  this->stream_client_ = std::make_shared<StreamClient>(this->engine_);\n+  this->pulse_client_ = std::make_shared<PulseClient>();\n+}\n+\n+Engine::~Engine() { terminate_engine(this->engine_); }\n+\n+StreamClientSharedPtr Engine::stream_client() { return this->stream_client_; }\n+PulseClientSharedPtr Engine::pulse_client() { return this->pulse_client_; }\n+\n+void Engine::c_on_engine_running(void* context) {\n+  Engine* self = static_cast<Engine*>(context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "001420cc040c8c97a250865fa7fa80e1d517a317"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzODU4Nzc2", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1223#pullrequestreview-563858776", "createdAt": "2021-01-07T22:00:20Z", "commit": {"oid": "001420cc040c8c97a250865fa7fa80e1d517a317"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QyMjowMDoyMFrOIP-A8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QyMjowMDoyMFrOIP-A8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYxNTYwMg==", "bodyText": "I'd love to improve the performance of this, but this is no worse than what the other platforms are doing right now.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1223#discussion_r553615602", "createdAt": "2021-01-07T22:00:20Z", "author": {"login": "goaway"}, "path": "library/cc/engine_builder.cc", "diffHunk": "@@ -0,0 +1,96 @@\n+#include \"engine_builder.h\"\n+\n+#include \"library/common/main_interface.h\"\n+\n+namespace Envoy {\n+namespace Platform {\n+\n+EngineBuilder::EngineBuilder() {}\n+\n+EngineBuilder& EngineBuilder::add_log_level(LogLevel log_level) {\n+  this->log_level_ = log_level;\n+  return *this;\n+}\n+\n+EngineBuilder& EngineBuilder::set_on_engine_running(std::function<void()> closure) {\n+  this->on_engine_running_ = closure;\n+  return *this;\n+}\n+\n+EngineBuilder& EngineBuilder::add_stats_domain(const std::string& stats_domain) {\n+  this->stats_domain_ = stats_domain;\n+  return *this;\n+}\n+\n+EngineBuilder& EngineBuilder::add_connect_timeout_seconds(int connect_timeout_seconds) {\n+  this->connect_timeout_seconds_ = connect_timeout_seconds;\n+  return *this;\n+}\n+\n+EngineBuilder& EngineBuilder::add_dns_refresh_seconds(int dns_refresh_seconds) {\n+  this->dns_refresh_seconds_ = dns_refresh_seconds;\n+  return *this;\n+}\n+\n+EngineBuilder& EngineBuilder::add_dns_failure_refresh_seconds(int base, int max) {\n+  this->dns_failure_refresh_seconds_base_ = base;\n+  this->dns_failure_refresh_seconds_max_ = max;\n+  return *this;\n+}\n+\n+EngineBuilder& EngineBuilder::add_stats_flush_seconds(int stats_flush_seconds) {\n+  this->stats_flush_seconds_ = stats_flush_seconds;\n+  return *this;\n+}\n+\n+EngineBuilder& EngineBuilder::set_app_version(const std::string& app_version) {\n+  this->app_version_ = app_version;\n+  return *this;\n+}\n+\n+EngineBuilder& EngineBuilder::set_app_id(const std::string& app_id) {\n+  this->app_id_ = app_id;\n+  return *this;\n+}\n+\n+EngineBuilder& EngineBuilder::add_virtual_clusters(const std::string& virtual_clusters) {\n+  this->virtual_clusters_ = virtual_clusters;\n+  return *this;\n+}\n+\n+EngineSharedPtr EngineBuilder::build() {\n+  std::vector<std::pair<std::string, std::string>> replacements{\n+      {\"{{ app_id }}\", this->app_id_},\n+      {\"{{ app_version }}\", this->app_version_},\n+      {\"{{ connect_timeout_seconds }}\", std::to_string(this->connect_timeout_seconds_)},\n+      {\"{{ device_os }}\", \"python\"},\n+      {\"{{ dns_failure_refresh_rate_seconds_base }}\",\n+       std::to_string(this->dns_failure_refresh_seconds_base_)},\n+      {\"{{ dns_failure_refresh_rate_seconds_max }}\",\n+       std::to_string(this->dns_failure_refresh_seconds_max_)},\n+      {\"{{ dns_refresh_rate_seconds }}\", std::to_string(this->dns_refresh_seconds_)},\n+      {\"{{ native_filter_chain }}\", \"\"},\n+      {\"{{ platform_filter_chain }}\", \"\"},\n+      {\"{{ stats_domain }}\", this->stats_domain_},\n+      {\"{{ stats_flush_interval_seconds }}\", std::to_string(this->stats_flush_seconds_)},\n+      {\"{{ virtual_clusters }}\", this->virtual_clusters_},\n+  };\n+\n+  std::string config_str(config_template);\n+  for (const auto& pair : replacements) {\n+    const auto& key = pair.first;\n+    const auto& value = pair.second;\n+\n+    size_t idx = 0;\n+    while ((idx = config_str.find(key, idx)) != std::string::npos) {\n+      config_str.replace(idx, key.size(), value);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "001420cc040c8c97a250865fa7fa80e1d517a317"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0322b97fcb84ca26250f1f51bfe878a3b2f5852a", "author": {"user": {"login": "crockeo", "name": "Cerek Hillen"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/0322b97fcb84ca26250f1f51bfe878a3b2f5852a", "committedDate": "2021-01-08T15:40:23Z", "message": "py-envoy-mobile engine\n\nSigned-off-by: Cerek Hillen <chillen@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "084fac22314fddbf0e6bff0768cd094b1ce4780d", "author": {"user": {"login": "crockeo", "name": "Cerek Hillen"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/084fac22314fddbf0e6bff0768cd094b1ce4780d", "committedDate": "2021-01-08T15:40:23Z", "message": "namespace engine builder shim\n\nSigned-off-by: Cerek Hillen <chillen@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99926e6ade879d5c1372c882d57d3619abdfee65", "author": {"user": {"login": "crockeo", "name": "Cerek Hillen"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/99926e6ade879d5c1372c882d57d3619abdfee65", "committedDate": "2021-01-08T15:40:23Z", "message": "easy comment\n\nSigned-off-by: Cerek Hillen <chillen@lyft.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "001420cc040c8c97a250865fa7fa80e1d517a317", "author": {"user": {"login": "crockeo", "name": "Cerek Hillen"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/001420cc040c8c97a250865fa7fa80e1d517a317", "committedDate": "2021-01-06T19:37:21Z", "message": "namespace engine builder shim\n\nSigned-off-by: Cerek Hillen <chillen@lyft.com>"}, "afterCommit": {"oid": "99926e6ade879d5c1372c882d57d3619abdfee65", "author": {"user": {"login": "crockeo", "name": "Cerek Hillen"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/99926e6ade879d5c1372c882d57d3619abdfee65", "committedDate": "2021-01-08T15:40:23Z", "message": "easy comment\n\nSigned-off-by: Cerek Hillen <chillen@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40fc3de29e29dec541ee9c1f2c96f42668bc17f9", "author": {"user": {"login": "crockeo", "name": "Cerek Hillen"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/40fc3de29e29dec541ee9c1f2c96f42668bc17f9", "committedDate": "2021-01-08T21:19:53Z", "message": "TODO for engine callbacks\n\nSigned-off-by: Cerek Hillen <chillen@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2NTQ3MjE3", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1223#pullrequestreview-566547217", "createdAt": "2021-01-12T18:19:35Z", "commit": {"oid": "40fc3de29e29dec541ee9c1f2c96f42668bc17f9"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cb6644b5e23205c66f8fc38bd7f914a488e1b9c", "author": {"user": {"login": "crockeo", "name": "Cerek Hillen"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/9cb6644b5e23205c66f8fc38bd7f914a488e1b9c", "committedDate": "2021-01-12T18:39:54Z", "message": "Merge branch 'main' of github.com:envoyproxy/envoy-mobile into ch/python-engine-impl\n\nSigned-off-by: Cerek Hillen <chillen@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3NTIxMDcy", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1223#pullrequestreview-567521072", "createdAt": "2021-01-13T18:48:55Z", "commit": {"oid": "9cb6644b5e23205c66f8fc38bd7f914a488e1b9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3975, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}