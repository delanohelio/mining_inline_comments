{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5MDcxMTcw", "number": 1072, "title": "assertion filter: add response assertion support", "bodyText": "Description: Adds response assertions to the AssertionFilter, using a 500 status code to distinguish response from request assertion failures.\nRisk Level: Low\nTesting: Local and CI\nSigned-off-by: Mike Schore mike.schore@gmail.com", "createdAt": "2020-09-03T22:55:28Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1072", "merged": true, "mergeCommit": {"oid": "287d920fa44f2383f08477166e50b782e2621288"}, "closed": true, "closedAt": "2020-09-11T20:04:05Z", "author": {"login": "goaway"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHC7ofgBqjM3NDM1OTQ3OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH5PwLABqjM3NTczODczMjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9cca6c704361bbdd1eac5935c8b365db2754e87e", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/9cca6c704361bbdd1eac5935c8b365db2754e87e", "committedDate": "2020-09-09T02:38:03Z", "message": "fix format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "d526559bb72e7e3bcebc5ab9a19e7e8f2f2c3532", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/d526559bb72e7e3bcebc5ab9a19e7e8f2f2c3532", "committedDate": "2020-09-09T02:39:28Z", "message": "use InternalServerError for failed response assertions\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d526559bb72e7e3bcebc5ab9a19e7e8f2f2c3532", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/d526559bb72e7e3bcebc5ab9a19e7e8f2f2c3532", "committedDate": "2020-09-09T02:39:28Z", "message": "use InternalServerError for failed response assertions\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "eafaaa4b0b041e1f889dda04403babe094d55316", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/eafaaa4b0b041e1f889dda04403babe094d55316", "committedDate": "2020-09-10T09:20:37Z", "message": "update failure paths\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzMwMzY4", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1072#pullrequestreview-486330368", "createdAt": "2020-09-10T21:41:11Z", "commit": {"oid": "104567e336ba7b2409d912f74b5c3c942d6221ec"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "104567e336ba7b2409d912f74b5c3c942d6221ec", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/104567e336ba7b2409d912f74b5c3c942d6221ec", "committedDate": "2020-09-10T09:59:47Z", "message": "add test coverage\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "23febab69e917d9939e194f203bf67a028a87fbe", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/23febab69e917d9939e194f203bf67a028a87fbe", "committedDate": "2020-09-10T23:07:10Z", "message": "add coverage\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23febab69e917d9939e194f203bf67a028a87fbe", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/23febab69e917d9939e194f203bf67a028a87fbe", "committedDate": "2020-09-10T23:07:10Z", "message": "add coverage\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "e85776cdff2ce64b9414e82fac33087f24255df5", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/e85776cdff2ce64b9414e82fac33087f24255df5", "committedDate": "2020-09-10T23:09:03Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mzc0NDE0", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1072#pullrequestreview-486374414", "createdAt": "2020-09-10T23:20:20Z", "commit": {"oid": "e85776cdff2ce64b9414e82fac33087f24255df5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzoyMDoyMVrOHQI7lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzoyMDo0OFrOHQI8NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NTU5MA==", "bodyText": "same misspell as #1071", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1072#discussion_r486685590", "createdAt": "2020-09-10T23:20:21Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/assertion/filter.cc", "diffHunk": "@@ -133,6 +135,111 @@ Http::FilterTrailersStatus AssertionFilter::decodeTrailers(Http::RequestTrailerM\n   return Http::FilterTrailersStatus::Continue;\n }\n \n+Http::FilterHeadersStatus AssertionFilter::encodeHeaders(Http::ResponseHeaderMap& headers,\n+                                                         bool end_stream) {\n+  config_->rootMatcher().onHttpResponseHeaders(headers, statuses_);\n+  auto& match_status = config_->rootMatcher().matchStatus(statuses_);\n+  if (!match_status.matches_ && !match_status.might_change_status_) {\n+    decoder_callbacks_->sendLocalReply(Http::Code::InternalServerError,\n+                                       \"Response Headers do not match configured expectations\",\n+                                       nullptr, absl::nullopt, \"\");\n+    return Http::FilterHeadersStatus::StopIteration;\n+  }\n+\n+  if (end_stream) {\n+    // Check if there are unsatisfied assertions about stream data.\n+    Buffer::OwnedImpl empty_buffer;\n+    config_->rootMatcher().onResponseBody(empty_buffer, statuses_);\n+    auto& match_status = config_->rootMatcher().matchStatus(statuses_);\n+    if (!match_status.matches_ && !match_status.might_change_status_) {\n+      decoder_callbacks_->sendLocalReply(Http::Code::InternalServerError,\n+                                         \"Response Body does not match configured expectations\",\n+                                         nullptr, absl::nullopt, \"\");\n+      return Http::FilterHeadersStatus::StopIteration;\n+    }\n+\n+    // Check of there are unsatisfied assertions about stream trailers.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e85776cdff2ce64b9414e82fac33087f24255df5"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NTc0OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // DIVIDE\n          \n          \n            \n            // Response Pathway\n          \n      \n    \n    \n  \n\n?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1072#discussion_r486685748", "createdAt": "2020-09-10T23:20:48Z", "author": {"login": "junr03"}, "path": "test/common/extensions/filters/http/assertion/assertion_filter_test.cc", "diffHunk": "@@ -263,6 +263,240 @@ TEST_F(AssertionFilterTest, RequestTrailersNoMatch) {\n   EXPECT_EQ(Http::FilterTrailersStatus::StopIteration, filter_->decodeTrailers(request_trailers));\n }\n \n+// DIVIDE", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e85776cdff2ce64b9414e82fac33087f24255df5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mzc0OTg1", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1072#pullrequestreview-486374985", "createdAt": "2020-09-10T23:21:53Z", "commit": {"oid": "e85776cdff2ce64b9414e82fac33087f24255df5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e85776cdff2ce64b9414e82fac33087f24255df5", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/e85776cdff2ce64b9414e82fac33087f24255df5", "committedDate": "2020-09-10T23:09:03Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "1281430fa7be61fe4e1cf7be02bf2135b91b500e", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/1281430fa7be61fe4e1cf7be02bf2135b91b500e", "committedDate": "2020-09-10T23:29:53Z", "message": "typo and cleanup\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9598ca6d8223196cc79ee81fa69da4084a341ee", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/d9598ca6d8223196cc79ee81fa69da4084a341ee", "committedDate": "2020-09-11T17:56:01Z", "message": "assertion filter: add response assertion support\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6830b5195c019004a5ed6b29f1481828c0940bcc", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/6830b5195c019004a5ed6b29f1481828c0940bcc", "committedDate": "2020-09-11T17:56:01Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35cb7f4e21d08978823ab65ac219c1eea5220d80", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/35cb7f4e21d08978823ab65ac219c1eea5220d80", "committedDate": "2020-09-11T17:56:01Z", "message": "use InternalServerError for failed response assertions\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fc0ed145672ba539d6f45c86ae0c9011b7533f8", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/1fc0ed145672ba539d6f45c86ae0c9011b7533f8", "committedDate": "2020-09-11T17:56:01Z", "message": "update failure paths\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dd300895f29fa508850bb1ff90d5986b0c25b04", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/0dd300895f29fa508850bb1ff90d5986b0c25b04", "committedDate": "2020-09-11T17:56:01Z", "message": "small fix\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5cc00fe992b6665d0f9baff8867aa8556de0909", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/b5cc00fe992b6665d0f9baff8867aa8556de0909", "committedDate": "2020-09-11T17:56:01Z", "message": "add coverage\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e58d0d9aac560692d8988e6d94ca717afad80678", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/e58d0d9aac560692d8988e6d94ca717afad80678", "committedDate": "2020-09-11T17:56:01Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06e7d37aaf62520c63d7a3bee162a0a87c8a7167", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/06e7d37aaf62520c63d7a3bee162a0a87c8a7167", "committedDate": "2020-09-11T17:56:01Z", "message": "typo and cleanup\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1281430fa7be61fe4e1cf7be02bf2135b91b500e", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/1281430fa7be61fe4e1cf7be02bf2135b91b500e", "committedDate": "2020-09-10T23:29:53Z", "message": "typo and cleanup\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "06e7d37aaf62520c63d7a3bee162a0a87c8a7167", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/06e7d37aaf62520c63d7a3bee162a0a87c8a7167", "committedDate": "2020-09-11T17:56:01Z", "message": "typo and cleanup\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4013, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}