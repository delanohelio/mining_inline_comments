{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1NjI2MzE3", "number": 1086, "title": "jni: ensure we delete local refs", "bodyText": "Continuation from #1057.\nDoing an audit of all the JNI methods which call into a java context.\nSigned-off-by: Alan Chiu achiu@lyft.com\nFor an explanation of how to fill out the fields, please see the relevant section\nin PULL_REQUESTS.md\nDescription: jni: ensure we delete local refs\nRisk Level: moderate\nTesting: manually\nDocs Changes: n/a\nRelease Notes: n/a\n[Optional Fixes #Issue]\n[Optional Deprecated:]", "createdAt": "2020-09-12T01:18:37Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086", "merged": true, "mergeCommit": {"oid": "a6976a61e14543446909dfacb4ea8c8bde6d5b83"}, "closed": true, "closedAt": "2020-09-14T21:45:04Z", "author": {"login": "buildbreaker"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH_kHFAH2gAyNDg1NjI2MzE3Ojg5ZWJjN2EyNWUxZjE0NmRkYmRmZTBlOTk4YWRmZmRkMjcxNWMwNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI4PL5AFqTQ4ODA3MTM5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "89ebc7a25e1f146ddbdfe0e998adffdd2715c054", "author": {"user": {"login": "buildbreaker", "name": "Alan Chiu"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/89ebc7a25e1f146ddbdfe0e998adffdd2715c054", "committedDate": "2020-09-12T01:18:10Z", "message": "jni: ensure we delete local refs\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "277cc26d2a4f0851539aefa78a478f6b1afde1e5", "author": {"user": {"login": "buildbreaker", "name": "Alan Chiu"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/277cc26d2a4f0851539aefa78a478f6b1afde1e5", "committedDate": "2020-09-12T01:19:13Z", "message": "space\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341", "author": {"user": {"login": "buildbreaker", "name": "Alan Chiu"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/a148ed9a3d072c9ceef895653a0e1e76bf98e341", "committedDate": "2020-09-12T01:27:03Z", "message": "fix\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTkzNzg4", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#pullrequestreview-487193788", "createdAt": "2020-09-12T01:59:23Z", "commit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMTo1OToyNFrOHQxsKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMTo1OToyNFrOHQxsKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1MzM4Ng==", "bodyText": "Exactly one of on_error, on_complete, or on_cancel should be called for every stream. Those should be the only place we delete j_context like this.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487353386", "createdAt": "2020-09-12T01:59:24Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -133,6 +135,10 @@ static void* jvm_on_headers(const char* method, envoy_headers headers, bool end_\n                                          end_stream ? JNI_TRUE : JNI_FALSE);\n \n   env->DeleteLocalRef(jcls_JvmCallbackContext);\n+  if (end_stream) {\n+    env->DeleteGlobalRef(j_context);\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTkzODYy", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#pullrequestreview-487193862", "createdAt": "2020-09-12T02:00:22Z", "commit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMjowMDoyMlrOHQxsrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMjowMDoyMlrOHQxsrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1MzUxNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              if (end_stream) {\n          \n          \n            \n                env->DeleteGlobalRef(j_context);\n          \n          \n            \n              }", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487353517", "createdAt": "2020-09-12T02:00:22Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -190,6 +210,10 @@ static void* jvm_on_data(const char* method, envoy_data data, bool end_stream, v\n   data.release(data.context);\n   env->DeleteLocalRef(j_data);\n   env->DeleteLocalRef(jcls_JvmCallbackContext);\n+  if (end_stream) {\n+    env->DeleteGlobalRef(j_context);\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTkzOTEz", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#pullrequestreview-487193913", "createdAt": "2020-09-12T02:01:11Z", "commit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMjowMToxMVrOHQxs8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMjowMToxMVrOHQxs8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1MzU4NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              env->DeleteGlobalRef(j_context);", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487353585", "createdAt": "2020-09-12T02:01:11Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -244,6 +282,8 @@ static void* jvm_on_trailers(const char* method, envoy_headers trailers, void* c\n   jobject result = env->CallObjectMethod(j_context, jmid_onTrailers, (jlong)trailers.length);\n \n   env->DeleteLocalRef(jcls_JvmCallbackContext);\n+  env->DeleteGlobalRef(j_context);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTk0MzU2", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#pullrequestreview-487194356", "createdAt": "2020-09-12T02:06:52Z", "commit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMjowNjo1M1rOHQxvMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMjowNjo1M1rOHQxvMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1NDE2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // released automatically. Manual book keeping is required for these methods.\n          \n          \n            \n            // released automatically. Manual bookkeeping is required for these methods.\n          \n      \n    \n    \n  \n\nTrivia: \"bookkeeping\" is the only English word with three pairs of double letters in a row.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487354160", "createdAt": "2020-09-12T02:06:53Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -116,6 +116,8 @@ static void pass_headers(JNIEnv* env, envoy_headers headers, jobject j_context)\n }\n \n // Platform callback implementation\n+// These methods call jvm methods which means the local references created will not be\n+// released automatically. Manual book keeping is required for these methods.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTk0NDIw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#pullrequestreview-487194420", "createdAt": "2020-09-12T02:07:56Z", "commit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMjowNzo1NlrOHQxvhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMlQwMjowNzo1NlrOHQxvhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM1NDI0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              if (end_stream) {\n          \n          \n            \n                env->DeleteGlobalRef(j_context);\n          \n          \n            \n              }", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#discussion_r487354246", "createdAt": "2020-09-12T02:07:56Z", "author": {"login": "goaway"}, "path": "library/common/jni/jni_interface.cc", "diffHunk": "@@ -133,6 +135,10 @@ static void* jvm_on_headers(const char* method, envoy_headers headers, bool end_\n                                          end_stream ? JNI_TRUE : JNI_FALSE);\n \n   env->DeleteLocalRef(jcls_JvmCallbackContext);\n+  if (end_stream) {\n+    env->DeleteGlobalRef(j_context);\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a148ed9a3d072c9ceef895653a0e1e76bf98e341"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "967e957309ab9d6d7809c155c9555ed42c3ff6b5", "author": {"user": {"login": "buildbreaker", "name": "Alan Chiu"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/967e957309ab9d6d7809c155c9555ed42c3ff6b5", "committedDate": "2020-09-14T17:34:46Z", "message": "fix\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "166cc5b51c2bba82c20a1d0eba483e67d5c11202", "author": {"user": {"login": "buildbreaker", "name": "Alan Chiu"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/166cc5b51c2bba82c20a1d0eba483e67d5c11202", "committedDate": "2020-09-14T17:35:50Z", "message": "spelling\n\nSigned-off-by: Alan Chiu <achiu@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MDcxMzk0", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1086#pullrequestreview-488071394", "createdAt": "2020-09-14T19:19:54Z", "commit": {"oid": "166cc5b51c2bba82c20a1d0eba483e67d5c11202"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4020, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}