{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMjc2NDEx", "number": 771, "title": "stats: add segmentation of stats via virtual clusters", "bodyText": "Description: Virtual Clusters allow Envoy Mobile to emit stats based on matching criteria. This allows users to single out important traffic for their application. This PR adds an API to the client builder to add virtual cluster configuration and emission of virtual cluster stats.\nNote: the client builder API exposed here is not ideal #770 tracks enhancing this.\nRisk Level: low\nTesting: unit tests, and local stats test. #769 tracks adding CI tests for stats\nDocs Changes: added docs for the new API.\nSigned-off-by: Jose Nino jnino@lyft.com", "createdAt": "2020-03-24T21:57:26Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771", "merged": true, "mergeCommit": {"oid": "16f5fe71a18bc83c52a20545278f71773ee56357"}, "closed": true, "closedAt": "2020-03-26T19:52:52Z", "author": {"login": "junr03"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ6KLggH2gAyMzkzMjc2NDExOjIwYTkyNjZjM2NmYTI4ODk3ZDcwMzZkMmNiOTQxOWViOTUzZjlmMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRhbsvgFqTM4MjM1MzI2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "20a9266c3cfa28897d7036d2cb9419eb953f9f33", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/20a9266c3cfa28897d7036d2cb9419eb953f9f33", "committedDate": "2020-03-24T21:54:29Z", "message": "stats: add segmentation of stats via virtual clusters\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/fa68b6cc3e8af142055119c9a2824e7e1d4766dc", "committedDate": "2020-03-24T21:59:35Z", "message": "docs\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzI5MTY5", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#pullrequestreview-380729169", "createdAt": "2020-03-24T22:02:02Z", "commit": {"oid": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowMjowM1rOF7ExqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowMjowM1rOF7ExqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4ODU1Mw==", "bodyText": "Is there an example if a json_config or is it just a list of strings?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397488553", "createdAt": "2020-03-24T22:02:03Z", "author": {"login": "buildbreaker"}, "path": "docs/root/api/starting_envoy.rst", "diffHunk": "@@ -163,6 +163,27 @@ This information is sent as metadata when flushing stats.\n   // Swift\n   builder.addAppId(\"com.mydomain.myapp)\n \n+~~~~~~~~~~~~~~~~~~~~~~\n+``addVirtualClusters``\n+~~~~~~~~~~~~~~~~~~~~~~\n+\n+Specify the virtual clusters config for Envoy Mobile's configuration.\n+The configuration is expected as a JSON list.\n+This functionality is used for stat segmentation.\n+\n+.. attention::\n+\n+    This API is non-ideal as it exposes lower-level internals of Envoy than desired by this project.\n+    https://github.com/lyft/envoy-mobile/issues/770 tracks enhancing this API.\n+\n+**Example**::\n+\n+  // Kotlin\n+  builder.addVirtualClusters(\"[{json_config}]\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzMwMTYy", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#pullrequestreview-380730162", "createdAt": "2020-03-24T22:03:56Z", "commit": {"oid": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowMzo1NlrOF7E1Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowMzo1NlrOF7E1Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4OTQzMQ==", "bodyText": "You should be able to use :issue: here", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397489431", "createdAt": "2020-03-24T22:03:56Z", "author": {"login": "rebello95"}, "path": "docs/root/api/starting_envoy.rst", "diffHunk": "@@ -163,6 +163,27 @@ This information is sent as metadata when flushing stats.\n   // Swift\n   builder.addAppId(\"com.mydomain.myapp)\n \n+~~~~~~~~~~~~~~~~~~~~~~\n+``addVirtualClusters``\n+~~~~~~~~~~~~~~~~~~~~~~\n+\n+Specify the virtual clusters config for Envoy Mobile's configuration.\n+The configuration is expected as a JSON list.\n+This functionality is used for stat segmentation.\n+\n+.. attention::\n+\n+    This API is non-ideal as it exposes lower-level internals of Envoy than desired by this project.\n+    https://github.com/lyft/envoy-mobile/issues/770 tracks enhancing this API.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzMwNTIy", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#pullrequestreview-380730522", "createdAt": "2020-03-24T22:04:35Z", "commit": {"oid": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowNDozNVrOF7E2Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowNDozNVrOF7E2Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4OTc2Nw==", "bodyText": "May be worth specifying more details here (JSON list of virtual clusters?)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397489767", "createdAt": "2020-03-24T22:04:35Z", "author": {"login": "rebello95"}, "path": "library/java/src/io/envoyproxy/envoymobile/engine/EnvoyConfiguration.java", "diffHunk": "@@ -23,10 +24,11 @@\n    * @param statsFlushSeconds            interval at which to flush Envoy stats.\n    * @param appVersion                   the App Version of the App using this Envoy Client.\n    * @param appId                        the App ID of the App using this Envoy Client.\n+   * @param virtualClusters              the virtual cluster config.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzMyODA4", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#pullrequestreview-380732808", "createdAt": "2020-03-24T22:09:05Z", "commit": {"oid": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowOTowNVrOF7E-Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowOTowNVrOF7E-Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MTc1NA==", "bodyText": "I'm a little concerned that even though this is temporary, consumers can easily incorrectly add clusters. What do you think about doing something like this:\nprivate var virtualClusters = [String]()\n\nfunc addVirtualCluster(_ virtualCluster: String) -> EnvoyClientBuilder {\n  self.virtualClusters.append(virtualCluster)\n  return self\n}\n\nThen later you can pass it down as \"[\\(self.virtualClusters.joined(separator: \",\")]\"\nWDYT?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#discussion_r397491754", "createdAt": "2020-03-24T22:09:05Z", "author": {"login": "rebello95"}, "path": "library/swift/src/EnvoyClientBuilder.swift", "diffHunk": "@@ -20,6 +20,7 @@ public final class EnvoyClientBuilder: NSObject {\n   private var statsFlushSeconds: UInt32 = 60\n   private var appVersion: String = \"unspecified\"\n   private var appId: String = \"unspecified\"\n+  private var virtualClusters: String = \"[]\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa68b6cc3e8af142055119c9a2824e7e1d4766dc"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d14d4c76bbb2c9e5d441c4a36ecf3e3682be87c1", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/d14d4c76bbb2c9e5d441c4a36ecf3e3682be87c1", "committedDate": "2020-03-24T23:30:00Z", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e1e9181a10d3874a16edfe22cff9a8fd801d397", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/0e1e9181a10d3874a16edfe22cff9a8fd801d397", "committedDate": "2020-03-25T00:59:43Z", "message": "update envoy\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNTQ1NTQ2", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#pullrequestreview-381545546", "createdAt": "2020-03-25T21:20:41Z", "commit": {"oid": "0e1e9181a10d3874a16edfe22cff9a8fd801d397"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "200b923e8924e37424a878c180e38f35b5caed36", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/200b923e8924e37424a878c180e38f35b5caed36", "committedDate": "2020-03-26T19:07:46Z", "message": "Merge branch 'master' into virtual-clusters\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzUzMTAy", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#pullrequestreview-382353102", "createdAt": "2020-03-26T19:39:38Z", "commit": {"oid": "200b923e8924e37424a878c180e38f35b5caed36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzUzMjYw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/771#pullrequestreview-382353260", "createdAt": "2020-03-26T19:39:55Z", "commit": {"oid": "200b923e8924e37424a878c180e38f35b5caed36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4320, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}