{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMjEzODc3", "number": 1129, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNjo0ODowN1rOEtIkrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxOTo0NjoyM1rOEv8yWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NzYxODM3OnYy", "diffSide": "RIGHT", "path": "library/objective-c/BUILD", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNjo0ODowN1rOHgwX7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNzo1ODozNVrOHheuAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEwOTAzNg==", "bodyText": "Should this be added as a dependency somewhere?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r504109036", "createdAt": "2020-10-13T16:48:07Z", "author": {"login": "rebello95"}, "path": "library/objective-c/BUILD", "diffHunk": "@@ -32,6 +31,15 @@ objc_library(\n     ],\n )\n \n+objc_library(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ca1b9e8d4374e99f49c083eaceb5536015c3cb9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2ODM1Mw==", "bodyText": "(was wip) :)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r504868353", "createdAt": "2020-10-14T17:58:35Z", "author": {"login": "goaway"}, "path": "library/objective-c/BUILD", "diffHunk": "@@ -32,6 +31,15 @@ objc_library(\n     ],\n )\n \n+objc_library(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEwOTAzNg=="}, "originalCommit": {"oid": "0ca1b9e8d4374e99f49c083eaceb5536015c3cb9"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2Mjg0MzI0OnYy", "diffSide": "RIGHT", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxOTozNDoxNlrOHhiFYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMzoxMDozMlrOHieklQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkyMzQ4OQ==", "bodyText": "I want to call out that there is a potential shutdown race here, but it all depends on timing (I guess, obviously). We don't retain the filter and so when Envoy is being torn down, it's possible the filter is torn down before the dispatcher, in which case everything is fine. If the inverse happens, however, then there's narrow window here where we could successfully acquire the filter and attempt to access the dispatcher, which is already gone.\nAs I shared when we discussed in person, there are a few solutions to this. We could allow the dispatcher itself to be shared and locked (this is seems ideal to me, since we would never have a garbage reference here or anywhere else we needed to call in from platform code on an arbitrary thread). We could lock the top-level engine object, but the downside is that all incoming calls would need access to it (and indeed, there's not an obvious reason a filter should have access to it, let alone a mechanism to make it available short of ugly hacks). And finally, we could take ownership of the dispatcher and have it be something passed into Envoy to ensure it was always valid. (There are other advantages to this last approach, and it might be desirable eventually regardless, but it would initially require non-trivial changes to Envoy.)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r504923489", "createdAt": "2020-10-14T19:34:16Z", "author": {"login": "goaway"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -325,7 +369,20 @@ PlatformBridgeFilter::encodeTrailers(Http::ResponseTrailerMap& trailers) {\n   return status;\n }\n \n+void PlatformBridgeFilter::resumeDecoding() {\n+  auto weak_self = weak_from_this();\n+  dispatcher_.post([weak_self]() -> void {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a595ad45a084da39ff06749dc95b807b2c194d9"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NzE0NA==", "bodyText": "can we leave a todo in the code linking to an issue that we can track for any of the solutions you list?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505887144", "createdAt": "2020-10-15T21:55:16Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -325,7 +369,20 @@ PlatformBridgeFilter::encodeTrailers(Http::ResponseTrailerMap& trailers) {\n   return status;\n }\n \n+void PlatformBridgeFilter::resumeDecoding() {\n+  auto weak_self = weak_from_this();\n+  dispatcher_.post([weak_self]() -> void {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkyMzQ4OQ=="}, "originalCommit": {"oid": "7a595ad45a084da39ff06749dc95b807b2c194d9"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkxNDUxNw==", "bodyText": "yes", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505914517", "createdAt": "2020-10-15T23:10:32Z", "author": {"login": "goaway"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -325,7 +369,20 @@ PlatformBridgeFilter::encodeTrailers(Http::ResponseTrailerMap& trailers) {\n   return status;\n }\n \n+void PlatformBridgeFilter::resumeDecoding() {\n+  auto weak_self = weak_from_this();\n+  dispatcher_.post([weak_self]() -> void {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkyMzQ4OQ=="}, "originalCommit": {"oid": "7a595ad45a084da39ff06749dc95b807b2c194d9"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2ODcxNDY0OnYy", "diffSide": "RIGHT", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTozNjo0MFrOHicLMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwNDo0ODo0MVrOHj8h_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NTI1MQ==", "bodyText": "nit: I wonder if we should move the static helpers to their own utility file.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505875251", "createdAt": "2020-10-15T21:36:40Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -17,14 +17,38 @@ namespace Extensions {\n namespace HttpFilters {\n namespace PlatformBridge {\n \n+static void envoy_filter_release_callbacks(const void* context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkyMjQ2Mw==", "bodyText": "Well, they're static, so they're not accessible ouside this file. And we don't need them to be, since they're just what we use to set the function pointers on the struct.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505922463", "createdAt": "2020-10-15T23:35:31Z", "author": {"login": "goaway"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -17,14 +17,38 @@ namespace Extensions {\n namespace HttpFilters {\n namespace PlatformBridge {\n \n+static void envoy_filter_release_callbacks(const void* context) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NTI1MQ=="}, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ1Mzk0OA==", "bodyText": "We could include them in a bare header, but I suppose my preference is to put them here, to limit their visibility strictly to this file.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r507453948", "createdAt": "2020-10-19T04:48:41Z", "author": {"login": "goaway"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -17,14 +17,38 @@ namespace Extensions {\n namespace HttpFilters {\n namespace PlatformBridge {\n \n+static void envoy_filter_release_callbacks(const void* context) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg3NTI1MQ=="}, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2ODc2NTE1OnYy", "diffSide": "RIGHT", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTo0OTowOFrOHicsDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMzozNDoyOFrOHifCbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4MzY2MQ==", "bodyText": "we should have an inline comment about the ownership model", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505883661", "createdAt": "2020-10-15T21:49:08Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -44,6 +68,24 @@ PlatformBridgeFilter::PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr c\n   ASSERT(platform_filter_.instance_context,\n          fmt::format(\"init_filter unsuccessful for {}\", filter_name_));\n   iteration_state_ = IterationState::Ongoing;\n+\n+  if (platform_filter_.set_request_callbacks) {\n+    platform_request_callbacks_.resume_iteration = envoy_filter_callback_resume_decoding;\n+    platform_request_callbacks_.release_callbacks = envoy_filter_release_callbacks;\n+    platform_request_callbacks_.callback_context =\n+        new PlatformBridgeFilterWeakPtr{weak_from_this()};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkyMjE1OQ==", "bodyText": "Sure.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505922159", "createdAt": "2020-10-15T23:34:28Z", "author": {"login": "goaway"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -44,6 +68,24 @@ PlatformBridgeFilter::PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr c\n   ASSERT(platform_filter_.instance_context,\n          fmt::format(\"init_filter unsuccessful for {}\", filter_name_));\n   iteration_state_ = IterationState::Ongoing;\n+\n+  if (platform_filter_.set_request_callbacks) {\n+    platform_request_callbacks_.resume_iteration = envoy_filter_callback_resume_decoding;\n+    platform_request_callbacks_.release_callbacks = envoy_filter_release_callbacks;\n+    platform_request_callbacks_.callback_context =\n+        new PlatformBridgeFilterWeakPtr{weak_from_this()};", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4MzY2MQ=="}, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2ODc2OTM2OnYy", "diffSide": "RIGHT", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTo1MDowM1rOHicujA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMzozNDoxOVrOHifCRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NDMwMA==", "bodyText": "The absence of this assignment was a bug, right?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505884300", "createdAt": "2020-10-15T21:50:03Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -172,6 +214,7 @@ Http::FilterDataStatus PlatformBridgeFilter::onData(Buffer::Instance& data, bool\n       data.drain(data.length());\n       data.addBufferFragment(*Buffer::BridgeFragment::createBridgeFragment(result.data));\n     }\n+    iteration_state_ = IterationState::Ongoing;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkyMjExOQ==", "bodyText": "It was, though not one we would have encountered yet. I am adding coverage for it.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505922119", "createdAt": "2020-10-15T23:34:19Z", "author": {"login": "goaway"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -172,6 +214,7 @@ Http::FilterDataStatus PlatformBridgeFilter::onData(Buffer::Instance& data, bool\n       data.drain(data.length());\n       data.addBufferFragment(*Buffer::BridgeFragment::createBridgeFragment(result.data));\n     }\n+    iteration_state_ = IterationState::Ongoing;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NDMwMA=="}, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2ODc4MDA2OnYy", "diffSide": "RIGHT", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTo1MjozOVrOHic1bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMzoxNzo1N1rOHieuVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjA2MA==", "bodyText": "nit: usually weak_this in the Envoy codebase", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505886060", "createdAt": "2020-10-15T21:52:39Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -325,7 +369,20 @@ PlatformBridgeFilter::encodeTrailers(Http::ResponseTrailerMap& trailers) {\n   return status;\n }\n \n+void PlatformBridgeFilter::resumeDecoding() {\n+  auto weak_self = weak_from_this();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkxNzAxMw==", "bodyText": "I referenced the cache filter for this, and it used \"self\". (shrug emoji)\nI have no preference.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505917013", "createdAt": "2020-10-15T23:17:57Z", "author": {"login": "goaway"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -325,7 +369,20 @@ PlatformBridgeFilter::encodeTrailers(Http::ResponseTrailerMap& trailers) {\n   return status;\n }\n \n+void PlatformBridgeFilter::resumeDecoding() {\n+  auto weak_self = weak_from_this();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NjA2MA=="}, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2ODc5MDU2OnYy", "diffSide": "RIGHT", "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTo1NjozM1rOHic7ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMzowODozN1rOHieh5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NzY1MQ==", "bodyText": "In other parts of the filter we have assertions about invalid combination of actions vs filter state. I want to hear your thoughts about why here we have a no-op.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505887651", "createdAt": "2020-10-15T21:56:33Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -325,7 +369,20 @@ PlatformBridgeFilter::encodeTrailers(Http::ResponseTrailerMap& trailers) {\n   return status;\n }\n \n+void PlatformBridgeFilter::resumeDecoding() {\n+  auto weak_self = weak_from_this();\n+  dispatcher_.post([weak_self]() -> void {\n+    if (auto self = weak_self.lock()) {\n+      self->onResumeDecoding();\n+    }\n+  });\n+}\n+\n void PlatformBridgeFilter::onResumeDecoding() {\n+  if (iteration_state_ == IterationState::Ongoing) {\n+    return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkxMzgzMQ==", "bodyText": "In my view, It's expected that this could happen, and it shouldn't be treated as an error. Say you have a filter that halts iteration for the next data chunk only for up to a 30s timeout and then resumes regardless. You'd need to resume asynchronously after the 30 seconds are up, but you might get the next data chunk right around then too. The ordering of the dispatch of those two events is unpredictable. You would know if the async call won during your on-data call, because you'd have received an on-resume call (on the same thread - the stream/filter thread). But if the inverse was true, and you wanted to proceed, you'd have no way to abort the already-dispatched asynchronous call (at least not without making the implementation a whole lot more complicated). This allows you to use async resume in conjunction with sync resume without a whole lot of extra bookkeeping in the filter implementation and said complexity in the implementation.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505913831", "createdAt": "2020-10-15T23:08:37Z", "author": {"login": "goaway"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.cc", "diffHunk": "@@ -325,7 +369,20 @@ PlatformBridgeFilter::encodeTrailers(Http::ResponseTrailerMap& trailers) {\n   return status;\n }\n \n+void PlatformBridgeFilter::resumeDecoding() {\n+  auto weak_self = weak_from_this();\n+  dispatcher_.post([weak_self]() -> void {\n+    if (auto self = weak_self.lock()) {\n+      self->onResumeDecoding();\n+    }\n+  });\n+}\n+\n void PlatformBridgeFilter::onResumeDecoding() {\n+  if (iteration_state_ == IterationState::Ongoing) {\n+    return;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NzY1MQ=="}, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2ODc5NDk0OnYy", "diffSide": "RIGHT", "path": "test/common/extensions/filters/http/platform_bridge/platform_bridge_filter_test.cc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTo1ODozMlrOHic-fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMzoxMDoxN1rOHiekPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4ODM4Mg==", "bodyText": "Missing tests, right?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505888382", "createdAt": "2020-10-15T21:58:32Z", "author": {"login": "junr03"}, "path": "test/common/extensions/filters/http/platform_bridge/platform_bridge_filter_test.cc", "diffHunk": "@@ -1,3 +1,4 @@\n+#include \"test/mocks/event/mocks.h\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkxNDQyOQ==", "bodyText": "But coverage isn't failing! ;)\nIn all seriousness, there's not a lot extra to cover here, but I am going to add coverage to cause the on-resume tests to be triggered by an \"async callback\", and basic coverage of callback state management. Also that bug you noted that's fixed in this PR.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r505914429", "createdAt": "2020-10-15T23:10:17Z", "author": {"login": "goaway"}, "path": "test/common/extensions/filters/http/platform_bridge/platform_bridge_filter_test.cc", "diffHunk": "@@ -1,3 +1,4 @@\n+#include \"test/mocks/event/mocks.h\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4ODM4Mg=="}, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MzUxMjU4OnYy", "diffSide": "RIGHT", "path": "library/objective-c/EnvoyHTTPFilterCallbacksImpl.h", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxODo1ODoyMVrOHjMfQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwMTowMjoxNVrOHjzXGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY2NjgxOQ==", "bodyText": "So multiple objc header files work now? If so, maybe we can (in a separate PR) look into splitting up the EnvoyEngine.h file?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r506666819", "createdAt": "2020-10-16T18:58:21Z", "author": {"login": "rebello95"}, "path": "library/objective-c/EnvoyHTTPFilterCallbacksImpl.h", "diffHunk": "@@ -0,0 +1,12 @@\n+#import <Foundation/Foundation.h>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzMwMzcwNA==", "bodyText": "Not quite. Private headers can be used either by listing them as srcs or by moving them to a separate library target. But anything exposed to Swift still needs to be in the single header (because that becomes the bridge header and we hit a clang error with transitive imports).", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r507303704", "createdAt": "2020-10-19T01:02:15Z", "author": {"login": "goaway"}, "path": "library/objective-c/EnvoyHTTPFilterCallbacksImpl.h", "diffHunk": "@@ -0,0 +1,12 @@\n+#import <Foundation/Foundation.h>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY2NjgxOQ=="}, "originalCommit": {"oid": "c27baef52adab4f73208f82036ad97140d0597dc"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NzE0NDU2OnYy", "diffSide": "RIGHT", "path": "library/common/extensions/filters/http/platform_bridge/filter.h", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxOTo0NjoyM1rOHlOVvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDozMDoxOFrOHlP3Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc5NDMwMw==", "bodyText": "should the onResume callbacks below be made private now that we have the async triggers exposed?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r508794303", "createdAt": "2020-10-20T19:46:23Z", "author": {"login": "junr03"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.h", "diffHunk": "@@ -46,9 +46,18 @@ enum class IterationState { Ongoing, Stopped };\n  * For more information on implementing platform filters, see the docs.\n  */\n class PlatformBridgeFilter final : public Http::PassThroughFilter,\n-                                   Logger::Loggable<Logger::Id::filter> {\n+                                   public Logger::Loggable<Logger::Id::filter>,\n+                                   public std::enable_shared_from_this<PlatformBridgeFilter> {\n public:\n-  PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config);\n+  PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config, Event::Dispatcher& dispatcher);\n+\n+  // Asynchronously trigger resumption of filter iteration, if applicable.\n+  // This is a no-op if filter iteration is already ongoing.\n+  void resumeDecoding();\n+\n+  // Asynchronously trigger resumption of filter iteration, if applicable.\n+  // This is a no-op if filter iteration is already ongoing.\n+  void resumeEncoding();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76ae59f70b92b03de7e7296adc97bf13e1e3e48b"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxODg2NA==", "bodyText": "It could be, though right now its visibility aligns with the other on* functions in the class (which perhaps could arguably all be made private).", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r508818864", "createdAt": "2020-10-20T20:29:33Z", "author": {"login": "goaway"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.h", "diffHunk": "@@ -46,9 +46,18 @@ enum class IterationState { Ongoing, Stopped };\n  * For more information on implementing platform filters, see the docs.\n  */\n class PlatformBridgeFilter final : public Http::PassThroughFilter,\n-                                   Logger::Loggable<Logger::Id::filter> {\n+                                   public Logger::Loggable<Logger::Id::filter>,\n+                                   public std::enable_shared_from_this<PlatformBridgeFilter> {\n public:\n-  PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config);\n+  PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config, Event::Dispatcher& dispatcher);\n+\n+  // Asynchronously trigger resumption of filter iteration, if applicable.\n+  // This is a no-op if filter iteration is already ongoing.\n+  void resumeDecoding();\n+\n+  // Asynchronously trigger resumption of filter iteration, if applicable.\n+  // This is a no-op if filter iteration is already ongoing.\n+  void resumeEncoding();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc5NDMwMw=="}, "originalCommit": {"oid": "76ae59f70b92b03de7e7296adc97bf13e1e3e48b"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxOTI3NQ==", "bodyText": "Actually, I'm mistaken, they're already private. Let me move it.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1129#discussion_r508819275", "createdAt": "2020-10-20T20:30:18Z", "author": {"login": "goaway"}, "path": "library/common/extensions/filters/http/platform_bridge/filter.h", "diffHunk": "@@ -46,9 +46,18 @@ enum class IterationState { Ongoing, Stopped };\n  * For more information on implementing platform filters, see the docs.\n  */\n class PlatformBridgeFilter final : public Http::PassThroughFilter,\n-                                   Logger::Loggable<Logger::Id::filter> {\n+                                   public Logger::Loggable<Logger::Id::filter>,\n+                                   public std::enable_shared_from_this<PlatformBridgeFilter> {\n public:\n-  PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config);\n+  PlatformBridgeFilter(PlatformBridgeFilterConfigSharedPtr config, Event::Dispatcher& dispatcher);\n+\n+  // Asynchronously trigger resumption of filter iteration, if applicable.\n+  // This is a no-op if filter iteration is already ongoing.\n+  void resumeDecoding();\n+\n+  // Asynchronously trigger resumption of filter iteration, if applicable.\n+  // This is a no-op if filter iteration is already ongoing.\n+  void resumeEncoding();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc5NDMwMw=="}, "originalCommit": {"oid": "76ae59f70b92b03de7e7296adc97bf13e1e3e48b"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 657, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}