{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4ODA2ODk4", "number": 813, "title": "error handling: add attempt counts to the library's error types", "bodyText": "Description: this PR updates the error objects in the library to contain an attempt count. Additionally it wires up the attempt count as reported via envoy headers to the error object used by the Http::Dispatcher.\nRisk Level: low - no breaking API changes.\nTesting: unit tests, plus local end-to-end tests.\nDocs Changes: updated the types docstrings\nSigned-off-by: Jose Nino jnino@lyft.com", "createdAt": "2020-04-24T23:27:05Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813", "merged": true, "mergeCommit": {"oid": "d5d08aedad2a6059fb35dd87e5434138b4066ea0"}, "closed": true, "closedAt": "2020-04-28T14:08:21Z", "author": {"login": "junr03"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABca5Wv8gH2gAyNDA4ODA2ODk4OmFkM2JmNzU3MWMwNGY5MjAyZmJkZmQ1OTMzZjY4OTI0NmZiNmNmZDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb4acIAFqTQwMTQxMDI2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ad3bf7571c04f9202fbdfd5933f689246fb6cfd2", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/ad3bf7571c04f9202fbdfd5933f689246fb6cfd2", "committedDate": "2020-04-24T22:37:33Z", "message": "first pass\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b806deb0ca0796296142a0cac8a9a8e468b8d625", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/b806deb0ca0796296142a0cac8a9a8e468b8d625", "committedDate": "2020-04-24T23:23:18Z", "message": "tests\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4be12e39be3e58af6ea3d90c15ab8c14b0cdc676", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/4be12e39be3e58af6ea3d90c15ab8c14b0cdc676", "committedDate": "2020-04-24T23:24:37Z", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19b1e37ba1617934f458e10e779dafe3e69e9275", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/19b1e37ba1617934f458e10e779dafe3e69e9275", "committedDate": "2020-04-24T23:31:50Z", "message": "swiftlint\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "678e45339f906c82a8f2996716e756e0d10f5e96", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/678e45339f906c82a8f2996716e756e0d10f5e96", "committedDate": "2020-04-24T23:38:00Z", "message": "fix\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzI1ODAw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#pullrequestreview-400325800", "createdAt": "2020-04-24T23:41:32Z", "commit": {"oid": "678e45339f906c82a8f2996716e756e0d10f5e96"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMzo0MTozMlrOGLswaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMzo0MTozMlrOGLswaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMDgwOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      val msg = String(\"failed with error after \" + error.attemptCount + \" attempts: \" + error.message)\n          \n          \n            \n                      Log.d(\"MainActivity\", msg)\n          \n          \n            \n                      Log.d(\"MainActivity\", \"failed with error after ${error.attemptCount} attempts: ${error.message}\")", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r414920809", "createdAt": "2020-04-24T23:41:32Z", "author": {"login": "buildbreaker"}, "path": "examples/kotlin/hello_world/MainActivity.kt", "diffHunk": "@@ -103,7 +103,9 @@ class MainActivity : Activity() {\n           Unit\n         }\n         .onError { error ->\n-          recyclerView.post { viewAdapter.add(Failure(\"failed with error \" + error.message)) }\n+          val msg = String(\"failed with error after \" + error.attemptCount + \" attempts: \" + error.message)\n+          Log.d(\"MainActivity\", msg)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "678e45339f906c82a8f2996716e756e0d10f5e96"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzI1ODcx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#pullrequestreview-400325871", "createdAt": "2020-04-24T23:41:49Z", "commit": {"oid": "678e45339f906c82a8f2996716e756e0d10f5e96"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMzo0MTo0OVrOGLsw2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMzo0MTo0OVrOGLsw2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMDkyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          String msg = new String(\"failed with error after \" + error.getAttemptCount() +\n          \n          \n            \n                                                  \" attempts: \" + error.getMessage());\n          \n          \n            \n                          Log.d(\"MainActivity\", msg);\n          \n          \n            \n                          Log.d(\"MainActivity\", \"failed with error after \" + error.getAttemptCount() +\n          \n          \n            \n                                                  \" attempts: \" + error.getMessage());", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r414920923", "createdAt": "2020-04-24T23:41:49Z", "author": {"login": "buildbreaker"}, "path": "examples/java/hello_world/MainActivity.java", "diffHunk": "@@ -104,8 +104,10 @@ private void makeRequest() {\n               return Unit.INSTANCE;\n             })\n             .onError((error) -> {\n-              recyclerView.post(\n-                  () -> viewAdapter.add(new Failure(\"failed with error \" + error.getMessage())));\n+              String msg = new String(\"failed with error after \" + error.getAttemptCount() +\n+                                      \" attempts: \" + error.getMessage());\n+              Log.d(\"MainActivity\", msg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "678e45339f906c82a8f2996716e756e0d10f5e96"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzI3MjA5", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#pullrequestreview-400327209", "createdAt": "2020-04-24T23:47:39Z", "commit": {"oid": "678e45339f906c82a8f2996716e756e0d10f5e96"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMzo0NzozOVrOGLs3NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMDoxNTowM1rOGLtUHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyMjU0OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    failed within Envoy library after \\(error.attemptCount) attempts: \\(error.message)\n          \n          \n            \n                    Request failed after \\(error.attemptCount) attempts: \\(error.message)\n          \n      \n    \n    \n  \n\nTo be consistent with the others", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r414922548", "createdAt": "2020-04-24T23:47:39Z", "author": {"login": "rebello95"}, "path": "examples/swift/hello_world/ViewController.swift", "diffHunk": "@@ -65,7 +65,9 @@ final class ViewController: UITableViewController {\n         NSLog(\"Response data (\\(requestID)): \\(data.count) bytes\")\n       }\n       .onError { [weak self] error in\n-        let message = \"failed within Envoy library: \\(error.message)\"\n+        let message = \"\"\"\n+        failed within Envoy library after \\(error.attemptCount) attempts: \\(error.message)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "678e45339f906c82a8f2996716e756e0d10f5e96"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyOTgxOA==", "bodyText": "Seems like this should probably be 1 technically \ud83e\udd14 it's kind of arbitrary here I suppose since the request could have been retried", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r414929818", "createdAt": "2020-04-25T00:14:29Z", "author": {"login": "rebello95"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/GRPCResponseHandler.kt", "diffHunk": "@@ -123,7 +123,7 @@ class GRPCResponseHandler(\n         val compressionFlag = byteArray[0]\n         // TODO: Support gRPC compression https://github.com/lyft/envoy-mobile/issues/501.\n         if (compressionFlag.compareTo(0) != 0) {\n-          errorClosure(EnvoyError(0, \"Unable to read compressed gRPC response message\"))\n+          errorClosure(EnvoyError(0, \"Unable to read compressed gRPC response message\", 0))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "678e45339f906c82a8f2996716e756e0d10f5e96"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDkyOTk1MQ==", "bodyText": "Thi\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param errorCode,    the envoy_error_code_t.\n          \n          \n            \n               * @param errorCode,    the error code.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r414929951", "createdAt": "2020-04-25T00:15:03Z", "author": {"login": "rebello95"}, "path": "library/java/src/io/envoyproxy/envoymobile/engine/JvmCallbackContext.java", "diffHunk": "@@ -127,14 +127,15 @@ public void run() {\n   /**\n    * Dispatches error received from the JNI layer up to the platform.\n    *\n-   * @param message,   the error message.\n-   * @param errorCode, the envoy_error_code_t.\n+   * @param errorCode,    the envoy_error_code_t.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "678e45339f906c82a8f2996716e756e0d10f5e96"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8a1416fdecac3bcf8846011765d9ca2d31dfc8c", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/e8a1416fdecac3bcf8846011765d9ca2d31dfc8c", "committedDate": "2020-04-27T22:10:51Z", "message": "optional\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMzY1MDY3", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#pullrequestreview-401365067", "createdAt": "2020-04-27T22:13:05Z", "commit": {"oid": "e8a1416fdecac3bcf8846011765d9ca2d31dfc8c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMjoxMzowNVrOGM58Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMjoxODoxNFrOGM6GGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE4NTQ0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    var message: String\n          \n          \n            \n                    let message: String\n          \n      \n    \n    \n  \n\nCompiler enforces that this is set exactly once here", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416185443", "createdAt": "2020-04-27T22:13:05Z", "author": {"login": "rebello95"}, "path": "examples/swift/hello_world/ViewController.swift", "diffHunk": "@@ -65,7 +65,13 @@ final class ViewController: UITableViewController {\n         NSLog(\"Response data (\\(requestID)): \\(data.count) bytes\")\n       }\n       .onError { [weak self] error in\n-        let message = \"failed within Envoy library: \\(error.message)\"\n+        var message: String", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8a1416fdecac3bcf8846011765d9ca2d31dfc8c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE4NTYzNg==", "bodyText": "What does this change?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416185636", "createdAt": "2020-04-27T22:13:27Z", "author": {"login": "rebello95"}, "path": "library/common/jni_interface.cc", "diffHunk": "@@ -209,7 +209,7 @@ static void jvm_on_error(envoy_error error, void* context) {\n   jobject j_context = static_cast<jobject>(context);\n \n   jclass jcls_JvmObserverContext = env->GetObjectClass(j_context);\n-  jmethodID jmid_onError = env->GetMethodID(jcls_JvmObserverContext, \"onError\", \"([BI)V\");\n+  jmethodID jmid_onError = env->GetMethodID(jcls_JvmObserverContext, \"onError\", \"(I[BI)V\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8a1416fdecac3bcf8846011765d9ca2d31dfc8c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE4NzkyOQ==", "bodyText": "You need to use UInt32(exactly: attemptCount) here to prevent crashes in case attemptCount is out of bounds. If you want, you could then additionally remove the ternary, as UInt32(exactly: attemptCount) will also return nil if the value is negative, but you may also want to keep it for clarity \ud83e\udd37", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#discussion_r416187929", "createdAt": "2020-04-27T22:18:14Z", "author": {"login": "rebello95"}, "path": "library/swift/src/ResponseHandler.swift", "diffHunk": "@@ -66,8 +66,9 @@ public final class ResponseHandler: NSObject {\n     @escaping (_ error: EnvoyError) -> Void)\n     -> ResponseHandler\n   {\n-    self.underlyingCallbacks.onError = { errorCode, message in\n-      closure(EnvoyError(errorCode: errorCode, message: message, cause: nil))\n+    self.underlyingCallbacks.onError = { errorCode, message, attemptCount in\n+      closure(EnvoyError(errorCode: errorCode, message: message,\n+                         attemptCount: attemptCount < 0 ? nil : UInt32(attemptCount), cause: nil))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8a1416fdecac3bcf8846011765d9ca2d31dfc8c"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8881a88f5fae21d955d7abcd41b4768c6e29a2d", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/d8881a88f5fae21d955d7abcd41b4768c6e29a2d", "committedDate": "2020-04-28T00:04:09Z", "message": "comments\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNDEwMjYx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/813#pullrequestreview-401410261", "createdAt": "2020-04-28T00:05:36Z", "commit": {"oid": "d8881a88f5fae21d955d7abcd41b4768c6e29a2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4200, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}