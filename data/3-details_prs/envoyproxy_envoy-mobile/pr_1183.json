{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwOTQ4NzEy", "number": 1183, "title": "stats: adds metrics sink with ack", "bodyText": "Description: Replace the metrics sink from the envoy one to a custom one. The custom metrics sink comes with ack function on the grpc stream. This change is based on upstream envoy change: envoyproxy/envoy#13919\nRisk Level: High\nTesting: Local and ci unit tests and integration tests\nCo-authored-by: Jose Nino jnino@lyft.com\nSigned-off-by: Jingwei Hao jingweih@lyft.com", "createdAt": "2020-11-14T02:50:30Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183", "merged": true, "mergeCommit": {"oid": "2593d002845a1384514cf5cb3447ebf4e5915e48"}, "closed": true, "closedAt": "2021-02-03T17:52:41Z", "author": {"login": "jingwei99"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk6gh4ABqjQwOTczODg3NzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd2SEvggBqjQyODE2NDI3NTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72c208ec4b7df490d8b618f551d575962cb54fcb", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/72c208ec4b7df490d8b618f551d575962cb54fcb", "committedDate": "2020-11-14T02:49:48Z", "message": "stats: adds metrics sink with ack\n\nCo-authored-by: Jose Nino jnino@lyft.com\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}, "afterCommit": {"oid": "e403a78e62383eec358e5095a5a783b307836512", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/e403a78e62383eec358e5095a5a783b307836512", "committedDate": "2020-12-10T21:48:00Z", "message": "stats: adds metrics sink with ack\n\nCo-authored-by: Jose Nino jnino@lyft.com\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e403a78e62383eec358e5095a5a783b307836512", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/e403a78e62383eec358e5095a5a783b307836512", "committedDate": "2020-12-10T21:48:00Z", "message": "stats: adds metrics sink with ack\n\nCo-authored-by: Jose Nino jnino@lyft.com\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}, "afterCommit": {"oid": "8b4e7dfcd19f68452acab7903d120a44c96a64ee", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/8b4e7dfcd19f68452acab7903d120a44c96a64ee", "committedDate": "2021-01-14T20:13:51Z", "message": "rebase & update\n\nSigned-off-by: Jingwei Hao <jingwei.hao@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "add787d5908be5969f7069e745c7884dd7ff5110", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/add787d5908be5969f7069e745c7884dd7ff5110", "committedDate": "2021-01-19T23:00:10Z", "message": "rebase\n\nSigned-off-by: Jingwei Hao <jingwei.hao@gmail.com>"}, "afterCommit": {"oid": "166577c9661ecf7adaec5146f41e5bf7a28dff2d", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/166577c9661ecf7adaec5146f41e5bf7a28dff2d", "committedDate": "2021-01-19T23:57:10Z", "message": "sign\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc0NjI2MjQy", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#pullrequestreview-574626242", "createdAt": "2021-01-22T21:16:35Z", "commit": {"oid": "166577c9661ecf7adaec5146f41e5bf7a28dff2d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQyMToxNjozNVrOIY1oVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMlQyMToxODowNFrOIY1rZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjkxNTQxMw==", "bodyText": "nit: I would make this field 2.\nAlso lets document what this field is for.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#discussion_r562915413", "createdAt": "2021-01-22T21:16:35Z", "author": {"login": "junr03"}, "path": "library/common/extensions/stat_sinks/metrics_service/service.proto", "diffHunk": "@@ -0,0 +1,34 @@\n+syntax = \"proto3\";\n+\n+package envoymobile.extensions.stat_sinks.metrics_service;\n+\n+import \"envoy/config/core/v3/base.proto\";\n+import \"metrics.proto\";\n+import \"validate/validate.proto\";\n+\n+service EnvoyMobileMetricsService {\n+  rpc EnvoyMobileStreamMetrics(stream EnvoyMobileStreamMetricsMessage)\n+      returns (stream EnvoyMobileStreamMetricsResponse) {\n+  }\n+}\n+\n+message EnvoyMobileStreamMetricsResponse {\n+  string batch_id = 1;\n+}\n+\n+message EnvoyMobileStreamMetricsMessage {\n+\n+  message Identifier {\n+    // The node sending metrics over the stream.\n+    envoy.config.core.v3.Node node = 1 [(validate.rules).message = {required: true}];\n+  }\n+\n+  // Identifier data effectively is a structured metadata. As a performance optimization this will\n+  // only be sent in the first message on the stream.\n+  Identifier identifier = 1;\n+\n+  // A list of metric entries\n+  repeated io.prometheus.client.MetricFamily envoy_metrics = 2;\n+\n+  string batch_id = 3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "166577c9661ecf7adaec5146f41e5bf7a28dff2d"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjkxNjE5Ng==", "bodyText": "I am going to put up a PR today to reduce some of the stats we are emitting (and no longer need), as this config effectively doubles the amount of stats emitted", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#discussion_r562916196", "createdAt": "2021-01-22T21:18:04Z", "author": {"login": "junr03"}, "path": "library/common/config_template.cc", "diffHunk": "@@ -207,6 +207,13 @@ stats_flush_interval: {{ stats_flush_interval_seconds }}s\n       grpc_service:\n         envoy_grpc:\n           cluster_name: stats\n+  - name: envoy.stat_sinks.metrics_service.mobile", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "166577c9661ecf7adaec5146f41e5bf7a28dff2d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgwNzcyNjUx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#pullrequestreview-580772651", "createdAt": "2021-02-01T21:18:07Z", "commit": {"oid": "00370f14cda8f6054c38b2f85ad94ed623ec8863"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMVQyMToxODowN1rOId03Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMVQyMToxODoxOVrOId03tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODE0NTc0Mw==", "bodyText": "comment", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#discussion_r568145743", "createdAt": "2021-02-01T21:18:07Z", "author": {"login": "junr03"}, "path": "library/common/extensions/stat_sinks/metrics_service/service.proto", "diffHunk": "@@ -0,0 +1,35 @@\n+syntax = \"proto3\";\n+\n+package envoymobile.extensions.stat_sinks.metrics_service;\n+\n+import \"envoy/config/core/v3/base.proto\";\n+import \"metrics.proto\";\n+import \"validate/validate.proto\";\n+\n+service EnvoyMobileMetricsService {\n+  rpc EnvoyMobileStreamMetrics(stream EnvoyMobileStreamMetricsMessage)\n+      returns (stream EnvoyMobileStreamMetricsResponse) {\n+  }\n+}\n+\n+message EnvoyMobileStreamMetricsResponse {\n+  string batch_id = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00370f14cda8f6054c38b2f85ad94ed623ec8863"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODE0NTg0NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // Identifier for the current envoy_metrics batch\n          \n          \n            \n              // Identifier for the current envoy_metrics batch.\n          \n      \n    \n    \n  \n\nSame below.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/1183#discussion_r568145845", "createdAt": "2021-02-01T21:18:19Z", "author": {"login": "junr03"}, "path": "library/common/extensions/stat_sinks/metrics_service/service.proto", "diffHunk": "@@ -0,0 +1,35 @@\n+syntax = \"proto3\";\n+\n+package envoymobile.extensions.stat_sinks.metrics_service;\n+\n+import \"envoy/config/core/v3/base.proto\";\n+import \"metrics.proto\";\n+import \"validate/validate.proto\";\n+\n+service EnvoyMobileMetricsService {\n+  rpc EnvoyMobileStreamMetrics(stream EnvoyMobileStreamMetricsMessage)\n+      returns (stream EnvoyMobileStreamMetricsResponse) {\n+  }\n+}\n+\n+message EnvoyMobileStreamMetricsResponse {\n+  string batch_id = 1;\n+}\n+\n+message EnvoyMobileStreamMetricsMessage {\n+\n+  message Identifier {\n+    // The node sending metrics over the stream.\n+    envoy.config.core.v3.Node node = 1 [(validate.rules).message = {required: true}];\n+  }\n+\n+  // Identifier data effectively is a structured metadata. As a performance optimization this will\n+  // only be sent in the first message on the stream.\n+  Identifier identifier = 1;\n+\n+  // Identifier for the current envoy_metrics batch", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00370f14cda8f6054c38b2f85ad94ed623ec8863"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58b4ac4f863163724114911c2b1bcfd04fbbdcc9", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/58b4ac4f863163724114911c2b1bcfd04fbbdcc9", "committedDate": "2021-02-01T21:31:11Z", "message": "Merge branch 'main' into grpc_streamer"}, "afterCommit": {"oid": "dbe930e55b84a021a9a37daa19d0abf1b398076b", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/dbe930e55b84a021a9a37daa19d0abf1b398076b", "committedDate": "2021-02-01T21:58:25Z", "message": "comment\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71e580310ab761e1c65927d402c09ccd0628ba57", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/71e580310ab761e1c65927d402c09ccd0628ba57", "committedDate": "2021-02-02T20:51:57Z", "message": "stats: adds metrics sink with ack\n\nCo-authored-by: Jose Nino jnino@lyft.com\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb379f78835ab99b7b97d916b66ce0ecb9e80186", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/cb379f78835ab99b7b97d916b66ce0ecb9e80186", "committedDate": "2021-02-02T20:51:57Z", "message": "sign\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21520ddd4233140076ceb6f3274039aa1ae353fd", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/21520ddd4233140076ceb6f3274039aa1ae353fd", "committedDate": "2021-02-02T20:51:57Z", "message": "comment\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20988f1852781872c1b30b13d32a093bd83a684d", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/20988f1852781872c1b30b13d32a093bd83a684d", "committedDate": "2021-02-02T20:51:57Z", "message": "comment\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3bb6c5aa01af110d7ec6c422db1dfec3b908e779", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/3bb6c5aa01af110d7ec6c422db1dfec3b908e779", "committedDate": "2021-02-01T23:21:56Z", "message": "Trigger Build\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}, "afterCommit": {"oid": "20988f1852781872c1b30b13d32a093bd83a684d", "author": {"user": {"login": "jingwei99", "name": "Jingwei"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/20988f1852781872c1b30b13d32a093bd83a684d", "committedDate": "2021-02-02T20:51:57Z", "message": "comment\n\nSigned-off-by: Jingwei Hao <jingweih@lyft.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3914, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}