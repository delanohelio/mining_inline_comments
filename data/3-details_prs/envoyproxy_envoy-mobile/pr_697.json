{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NTc4NDQ3", "number": 697, "title": "upsteam protocol: add the ability to decide what protocol to use for upstream requests", "bodyText": "Description: this PR adds the ability to decide what protocol to use for upstream requests. Note that this will be unnecessary once ALPN works for upstream requests (#502)\nRisk Level: low\nTesting: updated unit tests\nDocs Changes: updated docs\nFixes #679\nSigned-off-by: Jose Nino jnino@lyft.com", "createdAt": "2020-02-20T06:40:56Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697", "merged": true, "mergeCommit": {"oid": "92f9bf25eff6edf925f47eebd1ddfe6f6957af1e"}, "closed": true, "closedAt": "2020-02-21T18:13:02Z", "author": {"login": "junr03"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGE4jQgH2gAyMzc3NTc4NDQ3OjYwMmVjZjA1NDkyYjcwYWVlM2JiM2UwMzBjYTEyYjRhODdmY2IxYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGjjNnAFqTM2MjgwOTA5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "602ecf05492b70aee3bb3e030ca12b4a87fcb1a4", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/602ecf05492b70aee3bb3e030ca12b4a87fcb1a4", "committedDate": "2020-02-20T06:11:01Z", "message": "upstream protocol: add the ability to use h2\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b4e7eb8774953ba56be68b5b0f1432687fd1c44", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/4b4e7eb8774953ba56be68b5b0f1432687fd1c44", "committedDate": "2020-02-20T06:12:59Z", "message": "build files\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/9369b6c4c2fc73672790b2ff51b99b991aaa54ad", "committedDate": "2020-02-20T06:34:52Z", "message": "examples\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNjYzNzk1", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-361663795", "createdAt": "2020-02-20T06:45:18Z", "commit": {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNjo0NToxOFrOFsHtxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNjo0NToxOFrOFsHtxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgwODA2OA==", "bodyText": "I'd suggest moving this out of the constructor, and adding it via a builder method.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r381808068", "createdAt": "2020-02-20T06:45:18Z", "author": {"login": "goaway"}, "path": "docs/root/api/http.rst", "diffHunk": "@@ -17,15 +17,15 @@ a previously created :ref:`Envoy instance <api_starting_envoy>`.\n \n **Kotlin**::\n \n-  val request = RequestBuilder(RequestMethod.POST, \"https\", \"api.envoyproxy.io\", \"/foo\")\n+  val request = RequestBuilder(RequestMethod.POST, \"https\", \"api.envoyproxy.io\", \"/foo\", upstreamHttpProtocol = UpstreamRequestProtocol.HTTP2)\n     .addRetryPolicy(RetryPolicy(...))\n     .addHeader(\"x-custom-header\", \"foobar\")\n     ...\n     .build()\n \n **Swift**::\n \n-  let request = RequestBuilder(method: .post, scheme: \"https\", authority: \"api.envoyproxy.io\", path: \"/foo\")\n+  let request = RequestBuilder(method: .post, scheme: \"https\", authority: \"api.envoyproxy.io\", path: \"/foo\", upstreamHttpProtocol: .http2)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNjY0NzI2", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-361664726", "createdAt": "2020-02-20T06:47:50Z", "commit": {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNjo0Nzo1MVrOFsHzMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNjo0Nzo1MVrOFsHzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgwOTQ1OA==", "bodyText": "I propose simplifying this with a x-envoy-mobile-force-h2 header. If a header with this name is present assume inferred h2 support, if not, default to h1.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r381809458", "createdAt": "2020-02-20T06:47:51Z", "author": {"login": "goaway"}, "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -477,19 +477,38 @@ const LowerCaseString ClusterHeader{\"x-envoy-mobile-cluster\"};\n const std::string BaseCluster = \"base\";\n const std::string BaseWlanCluster = \"base_wlan\";\n const std::string BaseWwanCluster = \"base_wwan\";\n+const LowerCaseString H2UpstreamHeader{\"x-envoy-mobile-upstream-protocol\"};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28b703339f6ee5181f1055f16f69eea7e12a3e7a", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/28b703339f6ee5181f1055f16f69eea7e12a3e7a", "committedDate": "2020-02-20T06:49:00Z", "message": "uncomment\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNjY1MjIx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-361665221", "createdAt": "2020-02-20T06:49:22Z", "commit": {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNjo0OToyMlrOFsH2YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNjo0OToyMlrOFsH2YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgxMDI3Mg==", "bodyText": "nit: this would actually be one less line of code if you just used literals ;)", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r381810272", "createdAt": "2020-02-20T06:49:22Z", "author": {"login": "goaway"}, "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -477,19 +477,38 @@ const LowerCaseString ClusterHeader{\"x-envoy-mobile-cluster\"};\n const std::string BaseCluster = \"base\";\n const std::string BaseWlanCluster = \"base_wlan\";\n const std::string BaseWwanCluster = \"base_wwan\";\n+const LowerCaseString H2UpstreamHeader{\"x-envoy-mobile-upstream-protocol\"};\n+const std::string H2Suffix = \"_h2\";\n+const std::string BaseClusterH2 = BaseCluster + H2Suffix;\n+const std::string BaseWlanClusterH2 = BaseWlanCluster + H2Suffix;\n+const std::string BaseWwanClusterH2 = BaseWwanCluster + H2Suffix;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNjY1NzA2", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-361665706", "createdAt": "2020-02-20T06:50:40Z", "commit": {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNjo1MDo0MFrOFsH5cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNjo1MDo0MFrOFsH5cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgxMTA1Nw==", "bodyText": "Can drop this enum if we just use a single header to force h2 (which is sort of non-standard anyways and only works with known destinations).", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r381811057", "createdAt": "2020-02-20T06:50:40Z", "author": {"login": "goaway"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/UpstreamHttpProtocol.kt", "diffHunk": "@@ -0,0 +1,9 @@\n+package io.envoyproxy.envoymobile\n+\n+/**\n+ * Available upstream http protocols.\n+ */\n+enum class UpstreamHttpProtocol(internal val stringValue: String) {\n+  HTTP1(\"http1\"),\n+  HTTP2(\"http2\"),\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNjY1OTQ0", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-361665944", "createdAt": "2020-02-20T06:51:22Z", "commit": {"oid": "9369b6c4c2fc73672790b2ff51b99b991aaa54ad"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6db464daf997befd9b2b428d50f0fb09b6067a3b", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/6db464daf997befd9b2b428d50f0fb09b6067a3b", "committedDate": "2020-02-20T17:30:14Z", "message": "Merge branch 'master' into h2\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "088ce93868d7eef83e61f9348b035644ed23d6b6", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/088ce93868d7eef83e61f9348b035644ed23d6b6", "committedDate": "2020-02-20T17:35:17Z", "message": "fix\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTAwNjMw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362100630", "createdAt": "2020-02-20T17:39:02Z", "commit": {"oid": "088ce93868d7eef83e61f9348b035644ed23d6b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNzozOTowMlrOFsczlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNzozOTowMlrOFsczlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE1MzYyMw==", "bodyText": "do you think it's worth asserting in the else case if the caller specifies a value that's unsupported?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382153623", "createdAt": "2020-02-20T17:39:02Z", "author": {"login": "rebello95"}, "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -478,19 +478,38 @@ const LowerCaseString ClusterHeader{\"x-envoy-mobile-cluster\"};\n const std::string BaseCluster = \"base\";\n const std::string BaseWlanCluster = \"base_wlan\";\n const std::string BaseWwanCluster = \"base_wwan\";\n+const LowerCaseString H2UpstreamHeader{\"x-envoy-mobile-upstream-protocol\"};\n+const std::string H2Suffix = \"_h2\";\n+const std::string BaseClusterH2 = BaseCluster + H2Suffix;\n+const std::string BaseWlanClusterH2 = BaseWlanCluster + H2Suffix;\n+const std::string BaseWwanClusterH2 = BaseWwanCluster + H2Suffix;\n } // namespace\n \n-void Dispatcher::attachPreferredNetwork(HeaderMap& headers) {\n+void Dispatcher::setDestinationCluster(HeaderMap& headers) {\n+\n+  // Determine upstream protocol. Use http2 if selected for explicitly, otherwise (any other value,\n+  // absence of value) select http1.\n+  // TODO(junr03): once http3 is available this would probably benefit from some sort of struct that\n+  // maps to appropriate cluster names. However, with only two options (http1/2) this suffices.\n+  bool use_h2_cluster{};\n+  const HeaderEntry* entry = headers.get(H2UpstreamHeader);\n+  if (entry) {\n+    if (entry->value() == \"http2\") {\n+      use_h2_cluster = true;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088ce93868d7eef83e61f9348b035644ed23d6b6"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTAxMTQ5", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362101149", "createdAt": "2020-02-20T17:39:48Z", "commit": {"oid": "088ce93868d7eef83e61f9348b035644ed23d6b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNzozOTo0OFrOFsc1JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNzozOTo0OFrOFsc1JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE1NDAyMA==", "bodyText": "nit: I think we should prefer HTTP over Http on all of these, in line with how we use MS for milliseconds over Ms. wdyt?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382154020", "createdAt": "2020-02-20T17:39:48Z", "author": {"login": "rebello95"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/Request.kt", "diffHunk": "@@ -7,12 +7,14 @@ package io.envoyproxy.envoymobile\n  * @param scheme The URL scheme for the request (i.e., \"https\").\n  * @param authority The URL authority for the request (i.e., \"api.foo.com\").\n  * @param path The URL path for the request (i.e., \"/foo\").\n+ * @param upstreamHttpProtocol The protcol version to use for upstream requests.\n  */\n data class Request internal constructor(\n     val method: RequestMethod,\n     val scheme: String,\n     val authority: String,\n     val path: String,\n+    val upstreamHttpProtocol: UpstreamHttpProtocol,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088ce93868d7eef83e61f9348b035644ed23d6b6"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTAyMDcx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362102071", "createdAt": "2020-02-20T17:41:10Z", "commit": {"oid": "088ce93868d7eef83e61f9348b035644ed23d6b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNzo0MToxMFrOFsc4EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNzo0MToxMFrOFsc4EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE1NDc2OA==", "bodyText": "Changing this to a builder as @goaway suggested would allow for reverting a lot of these test changes", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382154768", "createdAt": "2020-02-20T17:41:10Z", "author": {"login": "rebello95"}, "path": "library/kotlin/test/io/envoyproxy/envoymobile/RequestMapperTest.kt", "diffHunk": "@@ -123,7 +145,7 @@ class RequestMapperTest {\n         perRetryTimeoutMS = 9001)\n     val retryPolicyHeaders = retryPolicy.outboundHeaders()\n \n-    val requestHeaders = RequestBuilder(method = RequestMethod.POST, scheme = \"https\", authority = \"api.foo.com\", path = \"/foo\")\n+    val requestHeaders = RequestBuilder(method = RequestMethod.POST, scheme = \"https\", authority = \"api.foo.com\", path = \"/foo\", upstreamHttpProtocol = UpstreamHttpProtocol.HTTP2)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088ce93868d7eef83e61f9348b035644ed23d6b6"}, "originalPosition": 117}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65d757e3f9a5580b5300e03aff214a2ff40db42b", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/65d757e3f9a5580b5300e03aff214a2ff40db42b", "committedDate": "2020-02-20T21:04:49Z", "message": "move out of constructor\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98522685049351405eabb9607de26f13010a9192", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/98522685049351405eabb9607de26f13010a9192", "committedDate": "2020-02-20T21:10:54Z", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e0d1e681c325f1684045e8da8425d67a33ebf36", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/5e0d1e681c325f1684045e8da8425d67a33ebf36", "committedDate": "2020-02-20T21:24:28Z", "message": "examples\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjQ2MTg3", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362246187", "createdAt": "2020-02-20T21:28:07Z", "commit": {"oid": "5e0d1e681c325f1684045e8da8425d67a33ebf36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMToyODowN1rOFsjwCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMToyODowN1rOFsjwCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI2NzQwMg==", "bodyText": "moving below for consistent ordering with swift", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382267402", "createdAt": "2020-02-20T21:28:07Z", "author": {"login": "junr03"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/RequestBuilder.kt", "diffHunk": "@@ -22,16 +22,8 @@ class RequestBuilder(\n   // Retry policy to use for this request.\n   private var retryPolicy: RetryPolicy? = null\n \n-  /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e0d1e681c325f1684045e8da8425d67a33ebf36"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "059025d7d54a189ce1fc1f8557bc872aaa29052d", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/059025d7d54a189ce1fc1f8557bc872aaa29052d", "committedDate": "2020-02-20T21:29:26Z", "message": "java\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/e9f87fcfa9a6a0637523073d027b980d266b731b", "committedDate": "2020-02-20T21:50:08Z", "message": "fix\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjY0ODU5", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362264859", "createdAt": "2020-02-20T21:59:46Z", "commit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMTo1OTo0NlrOFsknXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMTo1OTo0NlrOFsknXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MTU2NA==", "bodyText": "Can we update objc/java too?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382281564", "createdAt": "2020-02-20T21:59:46Z", "author": {"login": "rebello95"}, "path": "examples/swift/hello_world/ViewController.swift", "diffHunk": "@@ -49,7 +49,9 @@ final class ViewController: UITableViewController {\n     let requestID = self.requestCount\n     let request = RequestBuilder(method: .get, scheme: kRequestScheme,\n                                  authority: kRequestAuthority,\n-                                 path: kRequestPath).build()\n+                                 path: kRequestPath, upstreamHttpProtocol: .http2)\n+        .addUpstreamHttpProtocol(.http2)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjY2NjA3", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362266607", "createdAt": "2020-02-20T22:02:49Z", "commit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowMjo0OVrOFsksyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowMjo0OVrOFsksyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4Mjk1NQ==", "bodyText": "Also seems like this should be use_h2_cluster = entry->value() == \"http2\"", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382282955", "createdAt": "2020-02-20T22:02:49Z", "author": {"login": "rebello95"}, "path": "library/common/http/dispatcher.cc", "diffHunk": "@@ -478,19 +478,38 @@ const LowerCaseString ClusterHeader{\"x-envoy-mobile-cluster\"};\n const std::string BaseCluster = \"base\";\n const std::string BaseWlanCluster = \"base_wlan\";\n const std::string BaseWwanCluster = \"base_wwan\";\n+const LowerCaseString H2UpstreamHeader{\"x-envoy-mobile-upstream-protocol\"};\n+const std::string H2Suffix = \"_h2\";\n+const std::string BaseClusterH2 = BaseCluster + H2Suffix;\n+const std::string BaseWlanClusterH2 = BaseWlanCluster + H2Suffix;\n+const std::string BaseWwanClusterH2 = BaseWwanCluster + H2Suffix;\n } // namespace\n \n-void Dispatcher::attachPreferredNetwork(HeaderMap& headers) {\n+void Dispatcher::setDestinationCluster(HeaderMap& headers) {\n+\n+  // Determine upstream protocol. Use http2 if selected for explicitly, otherwise (any other value,\n+  // absence of value) select http1.\n+  // TODO(junr03): once http3 is available this would probably benefit from some sort of struct that\n+  // maps to appropriate cluster names. However, with only two options (http1/2) this suffices.\n+  bool use_h2_cluster{};\n+  const HeaderEntry* entry = headers.get(H2UpstreamHeader);\n+  if (entry) {\n+    if (entry->value() == \"http2\") {\n+      use_h2_cluster = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjY3NTE4", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362267518", "createdAt": "2020-02-20T22:04:16Z", "commit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowNDoxNlrOFskvnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowNDoxNlrOFskvnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MzY3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              fun `not adding upstream http protocol should have null body in request`() {\n          \n          \n            \n              fun `not adding upstream http protocol should have null upstream protocol in request`() {", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382283677", "createdAt": "2020-02-20T22:04:16Z", "author": {"login": "rebello95"}, "path": "library/kotlin/test/io/envoyproxy/envoymobile/RequestBuilderTest.kt", "diffHunk": "@@ -24,6 +24,25 @@ class RequestBuilderTest {\n     assertThat(request.retryPolicy).isNull()\n   }\n \n+  @Test\n+  fun `adding upstream http protocol should have hint present in request`() {\n+\n+    val retryPolicy = RetryPolicy(maxRetryCount = 23, retryOn = listOf(RetryRule.STATUS_5XX, RetryRule.CONNECT_FAILURE), perRetryTimeoutMS = 1234)\n+    val request = RequestBuilder(method = RequestMethod.POST, scheme = \"https\", authority = \"api.foo.com\", path = \"foo\")\n+        .addUpstreamHttpProtocol(UpstreamHttpProtocol.HTTP2)\n+        .build()\n+\n+    assertThat(request.upstreamHttpProtocol).isEqualTo(UpstreamHttpProtocol.HTTP2)\n+  }\n+\n+  @Test\n+  fun `not adding upstream http protocol should have null body in request`() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjY3ODQ5", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362267849", "createdAt": "2020-02-20T22:04:52Z", "commit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowNDo1MlrOFskwmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowNDo1MlrOFskwmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4MzkyOQ==", "bodyText": "I'd probably make this a different test or update the name of the test", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382283929", "createdAt": "2020-02-20T22:04:52Z", "author": {"login": "rebello95"}, "path": "library/kotlin/test/io/envoyproxy/envoymobile/RequestMapperTest.kt", "diffHunk": "@@ -57,24 +77,29 @@ class RequestMapperTest {\n   fun `invalid semicolon prefixed header keys are filtered out of outbound request headers`() {\n     val requestHeaders = RequestBuilder(method = RequestMethod.POST, scheme = \"https\", authority = \"api.foo.com\", path = \"/foo\")\n         .addHeader(\":restricted\", \"value\")\n+        .addHeader(\"x-envoy-mobile-test\", \"value\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjY4NTc4", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362268578", "createdAt": "2020-02-20T22:06:11Z", "commit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowNjoxMVrOFskyyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowNjoxMVrOFskyyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDQ5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            private let kRestrictedHeaderPrefix = [\":\", \"x-envoy-mobile\"]\n          \n          \n            \n            private let kRestrictedHeaderPrefixes = [\":\", \"x-envoy-mobile\"]", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382284491", "createdAt": "2020-02-20T22:06:11Z", "author": {"login": "rebello95"}, "path": "library/swift/src/RequestMapper.swift", "diffHunk": "@@ -1,4 +1,4 @@\n-private let kRestrictedHeaderPrefix = \":\"\n+private let kRestrictedHeaderPrefix = [\":\", \"x-envoy-mobile\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjY4ODcw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362268870", "createdAt": "2020-02-20T22:06:45Z", "commit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowNjo0NVrOFskzuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowNjo0NVrOFskzuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDcyOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /// String representation of the log level.\n          \n          \n            \n              /// String representation of the protocol.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382284729", "createdAt": "2020-02-20T22:06:45Z", "author": {"login": "rebello95"}, "path": "library/swift/src/UpstreamHttpProtocol.swift", "diffHunk": "@@ -0,0 +1,18 @@\n+import Foundation\n+\n+/// Available upstream http protocols.\n+@objc\n+public enum UpstreamHttpProtocol: Int {\n+  case http1\n+  case http2\n+\n+  /// String representation of the log level.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjY4OTEz", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362268913", "createdAt": "2020-02-20T22:06:51Z", "commit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowNjo1MVrOFskz5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjowNjo1MVrOFskz5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4NDc3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            /// Available upstream http protocols.\n          \n          \n            \n            /// Available upstream HTTP protocols.", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382284772", "createdAt": "2020-02-20T22:06:51Z", "author": {"login": "rebello95"}, "path": "library/swift/src/UpstreamHttpProtocol.swift", "diffHunk": "@@ -0,0 +1,18 @@\n+import Foundation\n+\n+/// Available upstream http protocols.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f87fcfa9a6a0637523073d027b980d266b731b"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86c55fa72aa6c7383bfa1524958efae8885f209c", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/86c55fa72aa6c7383bfa1524958efae8885f209c", "committedDate": "2020-02-20T23:12:15Z", "message": "polish\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4c65c16d3e2e550e1a8b6f1c723faf778b5595e", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/d4c65c16d3e2e550e1a8b6f1c723faf778b5595e", "committedDate": "2020-02-20T23:15:45Z", "message": "fmt\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1719bfafd1c9aba5d874ee4c5abf699a2b7fa80f", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/1719bfafd1c9aba5d874ee4c5abf699a2b7fa80f", "committedDate": "2020-02-20T23:43:54Z", "message": "example comment\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzE4MDA3", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362318007", "createdAt": "2020-02-20T23:52:12Z", "commit": {"oid": "1719bfafd1c9aba5d874ee4c5abf699a2b7fa80f"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzo1MjoxMlrOFsnRTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMzo1MjoxMlrOFsnRTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMyNTA3MA==", "bodyText": "Up to you but using this might be more readable: !entry.key.startsWith(\":\") && !entry.key.startsWith(\"x-envoy-mobile\")", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#discussion_r382325070", "createdAt": "2020-02-20T23:52:12Z", "author": {"login": "rebello95"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/RequestMapper.kt", "diffHunk": "@@ -4,13 +4,17 @@ internal fun Request.outboundHeaders(): Map<String, List<String>> {\n   val retryPolicyHeaders = retryPolicy?.outboundHeaders() ?: emptyMap()\n \n   val result = mutableMapOf<String, List<String>>()\n-  result.putAll(headers.filter { entry -> !entry.key.startsWith(\":\") })\n+  result.putAll(headers.filter { entry -> !(entry.key.startsWith(\":\") || entry.key.startsWith(\"x-envoy-mobile\"))})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1719bfafd1c9aba5d874ee4c5abf699a2b7fa80f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95cbe86eefa700869ddb2b4601f8d6fd65950e53", "author": {"user": {"login": "junr03", "name": "Jose Ulises Nino Rivera"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/95cbe86eefa700869ddb2b4601f8d6fd65950e53", "committedDate": "2020-02-21T00:14:13Z", "message": "demorgans\n\nSigned-off-by: Jose Nino <jnino@lyft.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a30fab9932e3e4bd0af7e08452428e234de461bd", "author": {"user": {"login": "rebello95", "name": "Michael Rebello"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/a30fab9932e3e4bd0af7e08452428e234de461bd", "committedDate": "2020-02-21T17:35:48Z", "message": "fix example\n\nSigned-off-by: Michael Rebello <me@michaelrebello.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODA5MDkx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/697#pullrequestreview-362809091", "createdAt": "2020-02-21T17:54:46Z", "commit": {"oid": "a30fab9932e3e4bd0af7e08452428e234de461bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4288, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}