{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NjIwMjY4", "number": 971, "title": "filters: wire data and trailers for iOS", "bodyText": "Description: Completes end-to-end functionality for bridged platform filters on iOS. Factors out duplication in objective-c bridging functions.\nRisk Level: Moderate\nTesting: Local end-to-end\nSigned-off-by: Mike Schore mike.schore@gmail.com", "createdAt": "2020-07-23T10:36:09Z", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971", "merged": true, "mergeCommit": {"oid": "563d316e43320c46e1d8a7924ecea5fe3db0edec"}, "closed": true, "closedAt": "2020-07-25T06:56:50Z", "author": {"login": "goaway"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc37M0XgBqjM1ODI0MDUyODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4QQYggBqjM1ODU5NDUzMDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0e6e6fec772b1e73653a99181d3be10c2d2935a", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/b0e6e6fec772b1e73653a99181d3be10c2d2935a", "committedDate": "2020-07-23T10:34:51Z", "message": "filters: wire data and trailers for iOS\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "7e583c5fedca2cea2f57da575b10ce47e812fee1", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/7e583c5fedca2cea2f57da575b10ce47e812fee1", "committedDate": "2020-07-24T03:10:05Z", "message": "filters: wire data and trailers for iOS\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTAwNzQy", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#pullrequestreview-455100742", "createdAt": "2020-07-24T18:29:42Z", "commit": {"oid": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODoyOTo0MlrOG25oJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODoyOTo0MlrOG25oJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyMDQ1NA==", "bodyText": "I intend to eventually remove this when we have more direct integration coverage of this functionality in CI, based on the approach @junr03 has proposed with the ValidationFilter (name TBD? ExpectationFilter? RequirementsFilter? SatisfactionFilter.).", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460220454", "createdAt": "2020-07-24T18:29:42Z", "author": {"login": "goaway"}, "path": "examples/swift/hello_world/DemoFilter.swift", "diffHunk": "@@ -17,6 +17,7 @@ struct DemoFilter: ResponseFilter {\n   func setResponseFilterCallbacks(_ callbacks: ResponseFilterCallbacks) {}\n \n   func onResponseData(_ body: Data, endStream: Bool) -> FilterDataStatus {\n+    NSLog(\"Saw data chunk of length \\(body.count)\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTQzNDEx", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#pullrequestreview-455143411", "createdAt": "2020-07-24T19:44:26Z", "commit": {"oid": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxOTo0NDoyNlrOG27sQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxOTo1MTo0NVrOG275Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1NDI3Mg==", "bodyText": "sg, do you mind leaving a TODO?\nAssertionFilter? So many options!", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460254272", "createdAt": "2020-07-24T19:44:26Z", "author": {"login": "junr03"}, "path": "examples/swift/hello_world/DemoFilter.swift", "diffHunk": "@@ -17,6 +17,7 @@ struct DemoFilter: ResponseFilter {\n   func setResponseFilterCallbacks(_ callbacks: ResponseFilterCallbacks) {}\n \n   func onResponseData(_ body: Data, endStream: Bool) -> FilterDataStatus {\n+    NSLog(\"Saw data chunk of length \\(body.count)\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyMDQ1NA=="}, "originalCommit": {"oid": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI1NzU1NA==", "bodyText": "we were always releasing right after the transformation call, right? Now I can't remember why https://github.com/lyft/envoy-mobile/pull/971/files#diff-0fdd94f3084afc47d1b505544703ca0dL41 existed in the first place? i.e there was not a site (is there one in this PR and I am blind to it) where we conditionally released?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460257554", "createdAt": "2020-07-24T19:51:45Z", "author": {"login": "junr03"}, "path": "library/objective-c/EnvoyEngineImpl.m", "diffHunk": "@@ -95,13 +44,68 @@ static envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n   }\n \n   EnvoyHeaders *platformHeaders = to_ios_headers(headers);\n-  release_envoy_headers(headers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTU2NjMz", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#pullrequestreview-455156633", "createdAt": "2020-07-24T20:09:01Z", "commit": {"oid": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDowOTowMVrOG28VRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDoxMzoxM1rOG28bZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NDc3NA==", "bodyText": "Can we use typed keys here instead of id?", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460264774", "createdAt": "2020-07-24T20:09:01Z", "author": {"login": "rebello95"}, "path": "library/objective-c/EnvoyBridgeUtility.h", "diffHunk": "@@ -0,0 +1,68 @@\n+#import <Foundation/Foundation.h>\n+\n+#import \"library/common/types/c_types.h\"\n+\n+static inline envoy_data toNativeData(NSData *data) {\n+  uint8_t *native_bytes = (uint8_t *)safe_malloc(sizeof(uint8_t) * data.length);\n+  memcpy(native_bytes, data.bytes, data.length);\n+  envoy_data ret = {data.length, native_bytes, free, native_bytes};\n+  return ret;\n+}\n+\n+static inline envoy_data toManagedNativeString(NSString *s) {\n+  size_t length = s.length;\n+  uint8_t *native_string = (uint8_t *)safe_malloc(sizeof(uint8_t) * length);\n+  memcpy(native_string, s.UTF8String, length);\n+  envoy_data ret = {length, native_string, free, native_string};\n+  return ret;\n+}\n+\n+static inline envoy_headers toNativeHeaders(EnvoyHeaders *headers) {\n+  envoy_header_size_t length = 0;\n+  for (id headerKey in headers) {\n+    length += [headers[headerKey] count];\n+  }\n+  envoy_header *header_array = (envoy_header *)safe_malloc(sizeof(envoy_header) * length);\n+  envoy_header_size_t header_index = 0;\n+  for (id headerKey in headers) {\n+    NSArray *headerList = headers[headerKey];\n+    for (id headerValue in headerList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NjI1Mg==", "bodyText": "We had actually dropped this deliberately since it wasn't something we thought was needed yet. What was the reasoning for adding it back? If we want to keep it, we should also add it to the Android interfaces", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460266252", "createdAt": "2020-07-24T20:12:58Z", "author": {"login": "rebello95"}, "path": "library/swift/src/filters/FilterDataStatus.swift", "diffHunk": "@@ -21,4 +21,17 @@ public enum FilterDataStatus {\n   /// This should be called by filters which must parse a larger block of the incoming data before\n   /// continuing processing.\n   case stopIterationAndBuffer(Data)\n+\n+  /// Do not iterate to any of the remaining filters in the chain, and do not internally buffer\n+  /// data.\n+  ///\n+  /// This filter will continue to be called with new chunks of data.\n+  ///\n+  /// Returning `continue` from `onRequestData()`/`onResponseData()` or calling\n+  /// `continueRequest()`/`continueResponse()` MUST be called when continued filter iteration is\n+  /// desired.\n+  ///\n+  /// This may be called by filters which must parse a larger block of the incoming data before\n+  /// continuing processing, and will handle their own buffering.\n+  case stopIterationNoBuffer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI2NjM0MA==", "bodyText": "Suggested change", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460266340", "createdAt": "2020-07-24T20:13:13Z", "author": {"login": "rebello95"}, "path": "library/swift/src/filters/Filter.swift", "diffHunk": "@@ -50,6 +75,32 @@ extension EnvoyHTTPFilter {\n           return [kEnvoyFilterHeadersStatusStopIteration, headers.headers]\n         }\n       }\n+\n+      self.onResponseData = { data, endStream in\n+        let result = responseFilter.onResponseData(data, endStream: endStream)\n+        switch result {\n+        case .continue(let data):\n+          return [kEnvoyFilterDataStatusContinue, data]\n+        case .stopIterationAndBuffer(let data):\n+          return [kEnvoyFilterDataStatusStopIterationAndBuffer, data]\n+        case .stopIterationNoBuffer:\n+          // TODO(goaway): this probably shouldn't return any associated data, but bridge code\n+          // would need to be updated to handle nil. Alternatively, when an unmodified flag is\n+          // added, that could suffice here, too.\n+          return [kEnvoyFilterDataStatusStopIterationNoBuffer, data]\n+        }\n+      }\n+\n+      self.onResponseTrailers = { envoyTrailers in\n+        let result = responseFilter.onResponseTrailers(ResponseTrailers(headers: envoyTrailers))\n+        switch result {\n+        case .continue(let trailers):\n+          return [kEnvoyFilterTrailersStatusContinue, trailers.headers]\n+        case .stopIteration(let trailers):\n+          return [kEnvoyFilterTrailersStatusStopIteration, trailers.headers]\n+        }\n+      }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc21ab2f81591093e2b2735ec8ea4c6703dc906"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjM1NzIw", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#pullrequestreview-455235720", "createdAt": "2020-07-24T23:43:45Z", "commit": {"oid": "6f3694986bfdba836e15f00974e5d2964db8bde3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzo0Mzo0NVrOG3AbVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzo0Mzo0NVrOG3AbVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMzMTg2Mg==", "bodyText": "Missing closing comment */ \ud83d\ude43", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#discussion_r460331862", "createdAt": "2020-07-24T23:43:45Z", "author": {"login": "rebello95"}, "path": "library/kotlin/src/io/envoyproxy/envoymobile/filters/FilterDataStatus.kt", "diffHunk": "@@ -30,4 +30,18 @@ sealed class FilterDataStatus {\n    * continuing processing.\n    */\n   class StopIterationAndBuffer(val data: ByteBuffer) : FilterDataStatus()\n+\n+  /**\n+   * Do not iterate to any of the remaining filters in the chain, and do not internally buffer\n+   * data.\n+   *\n+   * This filter will continue to be called with new chunks of data.\n+   *\n+   * Returning `Continue` from `onRequestData()`/`onResponseData()` or calling\n+   * `continueRequest()`/`continueResponse()` MUST be called when continued filter iteration is\n+   * desired.\n+   *\n+   * This may be called by filters which must parse a larger block of the incoming data before\n+   * continuing processing, and will handle their own buffering.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f3694986bfdba836e15f00974e5d2964db8bde3"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjM4Mzk5", "url": "https://github.com/envoyproxy/envoy-mobile/pull/971#pullrequestreview-455238399", "createdAt": "2020-07-24T23:57:58Z", "commit": {"oid": "8e16604d177f77fe4d4e97039cd436c66684d998"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dee9d2329d4fad71489bc97cdac016090b6347c6", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/dee9d2329d4fad71489bc97cdac016090b6347c6", "committedDate": "2020-07-25T03:41:58Z", "message": "filters: wire data and trailers for iOS\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "856b043a99fc7a5d67da7ec6aaafc6fdcd57aceb", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/856b043a99fc7a5d67da7ec6aaafc6fdcd57aceb", "committedDate": "2020-07-25T03:41:58Z", "message": "add output to example app logs\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "083af729e54a5f33a6f82f8bce9cbee11bfd0f73", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/083af729e54a5f33a6f82f8bce9cbee11bfd0f73", "committedDate": "2020-07-25T03:41:58Z", "message": "this one's for you, Jose\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b9361b2214707bc929ff26a2c5d83884bda2418", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/1b9361b2214707bc929ff26a2c5d83884bda2418", "committedDate": "2020-07-25T03:41:58Z", "message": "format\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a06c2ef3d35ec143f235f9c56d9cc4d609d9ce04", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/a06c2ef3d35ec143f235f9c56d9cc4d609d9ce04", "committedDate": "2020-07-25T03:41:58Z", "message": "updates for comments\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23d841502dc55ee1a41e4a8c5cce7cdff4297924", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/23d841502dc55ee1a41e4a8c5cce7cdff4297924", "committedDate": "2020-07-25T03:41:58Z", "message": "additional updates for comments\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca775c6b3836652cc99fc34511de91b9c26e254b", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/ca775c6b3836652cc99fc34511de91b9c26e254b", "committedDate": "2020-07-25T03:41:58Z", "message": "typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e16604d177f77fe4d4e97039cd436c66684d998", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/8e16604d177f77fe4d4e97039cd436c66684d998", "committedDate": "2020-07-24T23:47:35Z", "message": "typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}, "afterCommit": {"oid": "ca775c6b3836652cc99fc34511de91b9c26e254b", "author": {"user": {"login": "goaway", "name": "Mike Schore"}}, "url": "https://github.com/envoyproxy/envoy-mobile/commit/ca775c6b3836652cc99fc34511de91b9c26e254b", "committedDate": "2020-07-25T03:41:58Z", "message": "typo\n\nSigned-off-by: Mike Schore <mike.schore@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4118, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}