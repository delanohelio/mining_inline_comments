{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwMTc5MDU4", "number": 763, "title": "Add metrics to track event processing time and time spent between polls", "bodyText": "Important: DO NOT REPORT SECURITY ISSUES DIRECTLY ON GITHUB.\nFor reporting security issues and contributing security fixes,\nplease, email security@linkedin.com instead, as described in\nthe contribution guidelines.\nPlease, take a minute to review the contribution guidelines at:\nhttps://github.com/linkedin/Brooklin/blob/master/CONTRIBUTING.md", "createdAt": "2020-10-08T20:47:27Z", "url": "https://github.com/linkedin/brooklin/pull/763", "merged": true, "mergeCommit": {"oid": "afb573545b491aa9153f4d1dd62e114dee969c30"}, "closed": true, "closedAt": "2020-10-12T19:29:25Z", "author": {"login": "somandal"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQnQ30gH2gAyNTAwMTc5MDU4OjkxYmMwYTgyNjAzYWU5OTkxNzlkNGVkMzgzYjFkMjE1YmU2ZWZiNmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR5HfTgFqTUwNjg2MzU2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "91bc0a82603ae999179d4ed383b1d215be6efb6c", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/91bc0a82603ae999179d4ed383b1d215be6efb6c", "committedDate": "2020-10-08T20:04:45Z", "message": "Add metrics to track event processing time and time spent between polls"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MTkyMTgy", "url": "https://github.com/linkedin/brooklin/pull/763#pullrequestreview-505192182", "createdAt": "2020-10-08T21:52:24Z", "commit": {"oid": "91bc0a82603ae999179d4ed383b1d215be6efb6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTo1MjoyNFrOHexsOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTo1MjoyNFrOHexsOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMzQ2NA==", "bodyText": "can you make this name generic and avoid using Histogram?", "url": "https://github.com/linkedin/brooklin/pull/763#discussion_r502033464", "createdAt": "2020-10-08T21:52:24Z", "author": {"login": "vmaheshw"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaBasedConnectorTask.java", "diffHunk": "@@ -102,7 +103,7 @@\n   protected final boolean _pausePartitionOnError;\n   protected final Duration _pauseErrorPartitionDuration;\n   protected final long _processingDelayLogThresholdMillis;\n-  protected final boolean _enablePollDurationMillisMetric;\n+  protected final boolean _enableAdditionalHistogramMetrics;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91bc0a82603ae999179d4ed383b1d215be6efb6c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79462b656e981aa4fe436e77a08f3d604f17a665", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/79462b656e981aa4fe436e77a08f3d604f17a665", "committedDate": "2020-10-08T22:01:34Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MTk3NDYz", "url": "https://github.com/linkedin/brooklin/pull/763#pullrequestreview-505197463", "createdAt": "2020-10-08T22:02:49Z", "commit": {"oid": "91bc0a82603ae999179d4ed383b1d215be6efb6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowMjo0OVrOHex87Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowMjo0OVrOHex87Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNzc0MQ==", "bodyText": "The name is slightly misleading. should there be a total somewhere in the name to be clear that it is not per event Processing time, but the total processing time of all the events received in one poll? One more suggestion, should we average here and add (total time/ total events), so it will give clear idea how much time we are spending to process per record. There is one more metric that might be needed how much time the producer send call took even though we know it is asynchronous. We can add that in future, if we see eventProcessingTime to be the culprint.", "url": "https://github.com/linkedin/brooklin/pull/763#discussion_r502037741", "createdAt": "2020-10-08T22:02:49Z", "author": {"login": "vmaheshw"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/KafkaBasedConnectorTaskMetrics.java", "diffHunk": "@@ -40,6 +40,10 @@\n   public static final String NUM_TOPICS = \"numTopics\";\n   // keeps track of how long it takes to return from poll()\n   public static final String POLL_DURATION_MS = \"pollDurationMs\";\n+  // keeps track of how long processing takes between polls\n+  public static final String TIME_SPENT_BETWEEN_POLLS_MS = \"timeSpentBetweenPollsMs\";\n+  // keeps track of how long processing and sending all events received on poll takes\n+  public static final String EVENT_PROCESSING_TIME_MS = \"eventProcessingTimeMs\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91bc0a82603ae999179d4ed383b1d215be6efb6c"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a86deda0ae4e296854af13d8b3fa44d2bd9a607f", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/a86deda0ae4e296854af13d8b3fa44d2bd9a607f", "committedDate": "2020-10-08T22:26:12Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjEyMzY1", "url": "https://github.com/linkedin/brooklin/pull/763#pullrequestreview-505212365", "createdAt": "2020-10-08T22:35:14Z", "commit": {"oid": "a86deda0ae4e296854af13d8b3fa44d2bd9a607f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODYyNjI4", "url": "https://github.com/linkedin/brooklin/pull/763#pullrequestreview-506862628", "createdAt": "2020-10-12T19:24:49Z", "commit": {"oid": "a86deda0ae4e296854af13d8b3fa44d2bd9a607f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxOToyNDo0OVrOHgKilg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxOToyNDo0OVrOHgKilg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ4OTE3NA==", "bodyText": "I dont think we will encounter a case where records count is 0 cause processRecords is called if records is not empty. Saying that its a good check to have.", "url": "https://github.com/linkedin/brooklin/pull/763#discussion_r503489174", "createdAt": "2020-10-12T19:24:49Z", "author": {"login": "vishwajith-s"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaBasedConnectorTask.java", "diffHunk": "@@ -515,9 +520,14 @@ protected void processRecords(ConsumerRecords<?, ?> records, Instant readTime) {\n     // send the batch out the other end\n     translateAndSendBatch(records, readTime);\n \n-    if (System.currentTimeMillis() - readTime.toEpochMilli() > _processingDelayLogThresholdMillis) {\n+    long processingTimeMillis = System.currentTimeMillis() - readTime.toEpochMilli();\n+    if (processingTimeMillis > _processingDelayLogThresholdMillis) {\n       _consumerMetrics.updateProcessingAboveThreshold(1);\n     }\n+\n+    if (_enableAdditionalMetrics) {\n+      _consumerMetrics.updatePerEventProcessingTimeMs(records.count() == 0 ? 0 : processingTimeMillis / records.count());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a86deda0ae4e296854af13d8b3fa44d2bd9a607f"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODYzNTY5", "url": "https://github.com/linkedin/brooklin/pull/763#pullrequestreview-506863569", "createdAt": "2020-10-12T19:26:44Z", "commit": {"oid": "a86deda0ae4e296854af13d8b3fa44d2bd9a607f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 298, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}