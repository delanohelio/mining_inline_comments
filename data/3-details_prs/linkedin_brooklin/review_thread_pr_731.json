{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNjI0NTAw", "number": 731, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozMTowMVrOEPWjug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDo1NTozOFrOEPW1tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTMzNjkwOnYy", "diffSide": "RIGHT", "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozMTowMVrOGzBUXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozMTowMVrOGzBUXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MjE1Ng==", "bodyText": "nit: space between topic and :\nString topic : cookieTopics", "url": "https://github.com/linkedin/brooklin/pull/731#discussion_r456152156", "createdAt": "2020-07-17T00:31:01Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -1142,7 +1142,44 @@ public void testFlowControlDisabled() throws Exception {\n         \"did not shut down on time\");\n   }\n \n-  @Test (enabled = false) // Test disabled since it has been flaky\n+  @Test\n+  public void testAutoPauseOnSendError() throws Exception {\n+    String[] cookieTopics = new String[] {\n+        \"MacadamiaWhiteChocolateCookie\",\n+        \"AlmondCookie\",\n+        \"ChocolateChipCookie\",\n+        \"SaltyCaramelCookie\"\n+    };\n+\n+    for (String topic: cookieTopics) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e59013c4cf5be05eb50cecd842748dba9f6f8b63"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTMzODMyOnYy", "diffSide": "RIGHT", "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozMTo1MFrOGzBVNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozMTo1MFrOGzBVNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MjM3NQ==", "bodyText": "nit: fix comment to discuss cookie instead of Pizza", "url": "https://github.com/linkedin/brooklin/pull/731#discussion_r456152375", "createdAt": "2020-07-17T00:31:50Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -1142,7 +1142,44 @@ public void testFlowControlDisabled() throws Exception {\n         \"did not shut down on time\");\n   }\n \n-  @Test (enabled = false) // Test disabled since it has been flaky\n+  @Test\n+  public void testAutoPauseOnSendError() throws Exception {\n+    String[] cookieTopics = new String[] {\n+        \"MacadamiaWhiteChocolateCookie\",\n+        \"AlmondCookie\",\n+        \"ChocolateChipCookie\",\n+        \"SaltyCaramelCookie\"\n+    };\n+\n+    for (String topic: cookieTopics) {\n+      createTopic(_zkUtils, topic);\n+    }\n+\n+    // create a datastream to consume from topics ending in \"Pizza\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e59013c4cf5be05eb50cecd842748dba9f6f8b63"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTM0MzQxOnYy", "diffSide": "RIGHT", "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozNDo1NFrOGzBYIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozNDo1NFrOGzBYIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MzEyMQ==", "bodyText": "I'd still add the following assertion:\n// verify that none of the events were sent because of send error Assert.assertTrue(datastreamProducer.getEvents().isEmpty(), \"No events should have been successfully sent\");", "url": "https://github.com/linkedin/brooklin/pull/731#discussion_r456153121", "createdAt": "2020-07-17T00:34:54Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -1142,7 +1142,44 @@ public void testFlowControlDisabled() throws Exception {\n         \"did not shut down on time\");\n   }\n \n-  @Test (enabled = false) // Test disabled since it has been flaky\n+  @Test\n+  public void testAutoPauseOnSendError() throws Exception {\n+    String[] cookieTopics = new String[] {\n+        \"MacadamiaWhiteChocolateCookie\",\n+        \"AlmondCookie\",\n+        \"ChocolateChipCookie\",\n+        \"SaltyCaramelCookie\"\n+    };\n+\n+    for (String topic: cookieTopics) {\n+      createTopic(_zkUtils, topic);\n+    }\n+\n+    // create a datastream to consume from topics ending in \"Pizza\"\n+    Datastream datastream = KafkaMirrorMakerConnectorTestUtils.createDatastream(\"cookieStream\", _broker, \"\\\\w+Cookie\");\n+\n+    DatastreamTaskImpl task = new DatastreamTaskImpl(Collections.singletonList(datastream));\n+    MockDatastreamEventProducer datastreamProducer = new MockDatastreamEventProducer((r) -> true);\n+    task.setEventProducer(datastreamProducer);\n+\n+    KafkaMirrorMakerConnectorTask connectorTask =\n+        KafkaMirrorMakerConnectorTestUtils.createFlushlessKafkaMirrorMakerConnectorTask(task, true, 50, 100,\n+            Duration.ofDays(1));\n+    KafkaMirrorMakerConnectorTestUtils.runKafkaMirrorMakerConnectorTask(connectorTask);\n+\n+    for (String topic: cookieTopics) {\n+      KafkaMirrorMakerConnectorTestUtils.produceEvents(topic, 1, _kafkaCluster);\n+    }\n+\n+    Assert.assertTrue(PollUtils.poll(() -> connectorTask.getAutoPausedSourcePartitions().size() == cookieTopics.length, POLL_PERIOD_MS, POLL_TIMEOUT_MS),\n+        \"All topics should have had auto-paused partitions\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e59013c4cf5be05eb50cecd842748dba9f6f8b63"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTM0NDk0OnYy", "diffSide": "RIGHT", "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozNTozNVrOGzBY6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozNTozNVrOGzBY6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MzMyMg==", "bodyText": "nit: space between topic and :\nString topic : cookieTopics", "url": "https://github.com/linkedin/brooklin/pull/731#discussion_r456153322", "createdAt": "2020-07-17T00:35:35Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -1142,7 +1142,44 @@ public void testFlowControlDisabled() throws Exception {\n         \"did not shut down on time\");\n   }\n \n-  @Test (enabled = false) // Test disabled since it has been flaky\n+  @Test\n+  public void testAutoPauseOnSendError() throws Exception {\n+    String[] cookieTopics = new String[] {\n+        \"MacadamiaWhiteChocolateCookie\",\n+        \"AlmondCookie\",\n+        \"ChocolateChipCookie\",\n+        \"SaltyCaramelCookie\"\n+    };\n+\n+    for (String topic: cookieTopics) {\n+      createTopic(_zkUtils, topic);\n+    }\n+\n+    // create a datastream to consume from topics ending in \"Pizza\"\n+    Datastream datastream = KafkaMirrorMakerConnectorTestUtils.createDatastream(\"cookieStream\", _broker, \"\\\\w+Cookie\");\n+\n+    DatastreamTaskImpl task = new DatastreamTaskImpl(Collections.singletonList(datastream));\n+    MockDatastreamEventProducer datastreamProducer = new MockDatastreamEventProducer((r) -> true);\n+    task.setEventProducer(datastreamProducer);\n+\n+    KafkaMirrorMakerConnectorTask connectorTask =\n+        KafkaMirrorMakerConnectorTestUtils.createFlushlessKafkaMirrorMakerConnectorTask(task, true, 50, 100,\n+            Duration.ofDays(1));\n+    KafkaMirrorMakerConnectorTestUtils.runKafkaMirrorMakerConnectorTask(connectorTask);\n+\n+    for (String topic: cookieTopics) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e59013c4cf5be05eb50cecd842748dba9f6f8b63"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTM0NjUzOnYy", "diffSide": "RIGHT", "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozNjoyNVrOGzBZ1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNjo0ODowOVrOGzaCig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MzU1Ng==", "bodyText": "can you print the list of topics in the auto pause list when printing the reason for failure? Will be easier to compare which topics were auto-paused and which weren't", "url": "https://github.com/linkedin/brooklin/pull/731#discussion_r456153556", "createdAt": "2020-07-17T00:36:25Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -1142,7 +1142,44 @@ public void testFlowControlDisabled() throws Exception {\n         \"did not shut down on time\");\n   }\n \n-  @Test (enabled = false) // Test disabled since it has been flaky\n+  @Test\n+  public void testAutoPauseOnSendError() throws Exception {\n+    String[] cookieTopics = new String[] {\n+        \"MacadamiaWhiteChocolateCookie\",\n+        \"AlmondCookie\",\n+        \"ChocolateChipCookie\",\n+        \"SaltyCaramelCookie\"\n+    };\n+\n+    for (String topic: cookieTopics) {\n+      createTopic(_zkUtils, topic);\n+    }\n+\n+    // create a datastream to consume from topics ending in \"Pizza\"\n+    Datastream datastream = KafkaMirrorMakerConnectorTestUtils.createDatastream(\"cookieStream\", _broker, \"\\\\w+Cookie\");\n+\n+    DatastreamTaskImpl task = new DatastreamTaskImpl(Collections.singletonList(datastream));\n+    MockDatastreamEventProducer datastreamProducer = new MockDatastreamEventProducer((r) -> true);\n+    task.setEventProducer(datastreamProducer);\n+\n+    KafkaMirrorMakerConnectorTask connectorTask =\n+        KafkaMirrorMakerConnectorTestUtils.createFlushlessKafkaMirrorMakerConnectorTask(task, true, 50, 100,\n+            Duration.ofDays(1));\n+    KafkaMirrorMakerConnectorTestUtils.runKafkaMirrorMakerConnectorTask(connectorTask);\n+\n+    for (String topic: cookieTopics) {\n+      KafkaMirrorMakerConnectorTestUtils.produceEvents(topic, 1, _kafkaCluster);\n+    }\n+\n+    Assert.assertTrue(PollUtils.poll(() -> connectorTask.getAutoPausedSourcePartitions().size() == cookieTopics.length, POLL_PERIOD_MS, POLL_TIMEOUT_MS),\n+        \"All topics should have had auto-paused partitions\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e59013c4cf5be05eb50cecd842748dba9f6f8b63"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU1NzE5NA==", "bodyText": "The code that does the auto pause already prints that. I don't think it will be useful.", "url": "https://github.com/linkedin/brooklin/pull/731#discussion_r456557194", "createdAt": "2020-07-17T16:48:09Z", "author": {"login": "jzakaryan"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -1142,7 +1142,44 @@ public void testFlowControlDisabled() throws Exception {\n         \"did not shut down on time\");\n   }\n \n-  @Test (enabled = false) // Test disabled since it has been flaky\n+  @Test\n+  public void testAutoPauseOnSendError() throws Exception {\n+    String[] cookieTopics = new String[] {\n+        \"MacadamiaWhiteChocolateCookie\",\n+        \"AlmondCookie\",\n+        \"ChocolateChipCookie\",\n+        \"SaltyCaramelCookie\"\n+    };\n+\n+    for (String topic: cookieTopics) {\n+      createTopic(_zkUtils, topic);\n+    }\n+\n+    // create a datastream to consume from topics ending in \"Pizza\"\n+    Datastream datastream = KafkaMirrorMakerConnectorTestUtils.createDatastream(\"cookieStream\", _broker, \"\\\\w+Cookie\");\n+\n+    DatastreamTaskImpl task = new DatastreamTaskImpl(Collections.singletonList(datastream));\n+    MockDatastreamEventProducer datastreamProducer = new MockDatastreamEventProducer((r) -> true);\n+    task.setEventProducer(datastreamProducer);\n+\n+    KafkaMirrorMakerConnectorTask connectorTask =\n+        KafkaMirrorMakerConnectorTestUtils.createFlushlessKafkaMirrorMakerConnectorTask(task, true, 50, 100,\n+            Duration.ofDays(1));\n+    KafkaMirrorMakerConnectorTestUtils.runKafkaMirrorMakerConnectorTask(connectorTask);\n+\n+    for (String topic: cookieTopics) {\n+      KafkaMirrorMakerConnectorTestUtils.produceEvents(topic, 1, _kafkaCluster);\n+    }\n+\n+    Assert.assertTrue(PollUtils.poll(() -> connectorTask.getAutoPausedSourcePartitions().size() == cookieTopics.length, POLL_PERIOD_MS, POLL_TIMEOUT_MS),\n+        \"All topics should have had auto-paused partitions\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MzU1Ng=="}, "originalCommit": {"oid": "e59013c4cf5be05eb50cecd842748dba9f6f8b63"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTM0ODY3OnYy", "diffSide": "RIGHT", "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozNzo0NVrOGzBbIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozNzo0NVrOGzBbIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1Mzg5MA==", "bodyText": "\ud83d\ude0b", "url": "https://github.com/linkedin/brooklin/pull/731#discussion_r456153890", "createdAt": "2020-07-17T00:37:45Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -1142,7 +1142,44 @@ public void testFlowControlDisabled() throws Exception {\n         \"did not shut down on time\");\n   }\n \n-  @Test (enabled = false) // Test disabled since it has been flaky\n+  @Test\n+  public void testAutoPauseOnSendError() throws Exception {\n+    String[] cookieTopics = new String[] {\n+        \"MacadamiaWhiteChocolateCookie\",\n+        \"AlmondCookie\",\n+        \"ChocolateChipCookie\",\n+        \"SaltyCaramelCookie\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e59013c4cf5be05eb50cecd842748dba9f6f8b63"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NTM4Mjk0OnYy", "diffSide": "RIGHT", "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDo1NTozOFrOGzBuIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDo1NTozOFrOGzBuIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1ODc1Mg==", "bodyText": "While you're at it, can you also fix these logs? They all print \"yummyTopic\" even though we check for the other topics.", "url": "https://github.com/linkedin/brooklin/pull/731#discussion_r456158752", "createdAt": "2020-07-17T00:55:38Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -1184,8 +1221,6 @@ public void testInFlightMessageCount() throws Exception {\n \n     // verify the states response returned by diagnostics endpoint contains correct counts\n     KafkaDatastreamStatesResponse statesResponse = connectorTask.getKafkaDatastreamStatesResponse();\n-    Assert.assertEquals(statesResponse.getAutoPausedPartitions().size(), 3,\n-        \"All topics should have had auto-paused partitions\");\n     Assert.assertEquals(\n         statesResponse.getInFlightMessageCounts().get(new FlushlessEventProducerHandler.SourcePartition(yummyTopic, 0)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e59013c4cf5be05eb50cecd842748dba9f6f8b63"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1029, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}