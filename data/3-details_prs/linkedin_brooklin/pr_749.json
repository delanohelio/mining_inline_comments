{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMTQyMTY2", "number": 749, "title": "Fix stickyMulticast strategy to avoid assigning the same task to multiple instances", "bodyText": "Currently, whenever the leader is updating the assignments, it first adds the assignments to the instances and then remove the assignments to ensure that we don't lose the task nodes in case of server crash/thread interruption.\nThe behavior we are seeing that if the new assignment update has some task moving from one live instance-1 to another live instance-2 and after adding the task in the live-instance-2 assignment if there is a thread interruption and does not let the leader to remove the task from live instance-1 assignment, the next leader does not check if there is any duplicate in the task between two live instances which results in exception in leaderDoAssignment.\nSolving this problem by removing the duplicate assignments from new assignment.", "createdAt": "2020-09-09T21:16:37Z", "url": "https://github.com/linkedin/brooklin/pull/749", "merged": true, "mergeCommit": {"oid": "b883a3c95b81ef56cee92952d3fc66d7b809e1a3"}, "closed": true, "closedAt": "2020-09-11T00:43:26Z", "author": {"login": "vmaheshw"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABboAf5CAH2gAyNDgzMTQyMTY2OmMzMWNkNGExNWNjOGRkNjliMGE2NTNkYmU0MjAxZGU5MzRlYTZkNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHqVnuAFqTQ4NjM5ODM1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "author": {"user": {"login": "vmaheshw", "name": "Vaibhav Maheshwari"}}, "url": "https://github.com/linkedin/brooklin/commit/c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "committedDate": "2019-11-18T20:06:44Z", "message": "Merge pull request #1 from linkedin/master\n\nPull latest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3004d104a697e619b0715de5c135e7544fb4d25", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/f3004d104a697e619b0715de5c135e7544fb4d25", "committedDate": "2020-08-13T19:09:21Z", "message": "Merge branch 'master' of github.com:vmaheshw/Brooklin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cd579e1cf9f4c5fc4c02951f21b29c75899e67d", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/0cd579e1cf9f4c5fc4c02951f21b29c75899e67d", "committedDate": "2020-09-09T19:59:54Z", "message": "Merge branch 'master' of github.com:linkedin/brooklin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20615997279acbc5238ab5720484cdc58017f5fa", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/20615997279acbc5238ab5720484cdc58017f5fa", "committedDate": "2020-09-09T21:08:52Z", "message": "Fix stickyMulticast strategy to not have same task assigning the same task"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDQ2NjIx", "url": "https://github.com/linkedin/brooklin/pull/749#pullrequestreview-485446621", "createdAt": "2020-09-09T22:29:42Z", "commit": {"oid": "20615997279acbc5238ab5720484cdc58017f5fa"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMjoyOTo0MlrOHPcdlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMjozMDowMVrOHPceAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk1NzAxMw==", "bodyText": "nit: ToMoreThanOneInstance", "url": "https://github.com/linkedin/brooklin/pull/749#discussion_r485957013", "createdAt": "2020-09-09T22:29:42Z", "author": {"login": "ahmedahamid"}, "path": "datastream-server/src/test/java/com/linkedin/datastream/server/assignment/TestStickyMulticastStrategy.java", "diffHunk": "@@ -282,6 +282,23 @@ public void testDontCreateNewTasksWhenInstanceChanged() {\n     Assert.assertTrue(oldAssignmentTasks.containsAll(newAssignmentTasks));\n   }\n \n+  @Test\n+  public void testSameTaskIsNotAssignedToAnyTwoInstances() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20615997279acbc5238ab5720484cdc58017f5fa"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk1NzEyMg==", "bodyText": "Please add a comment explaining why the test is doing this step.", "url": "https://github.com/linkedin/brooklin/pull/749#discussion_r485957122", "createdAt": "2020-09-09T22:30:01Z", "author": {"login": "ahmedahamid"}, "path": "datastream-server/src/test/java/com/linkedin/datastream/server/assignment/TestStickyMulticastStrategy.java", "diffHunk": "@@ -282,6 +282,23 @@ public void testDontCreateNewTasksWhenInstanceChanged() {\n     Assert.assertTrue(oldAssignmentTasks.containsAll(newAssignmentTasks));\n   }\n \n+  @Test\n+  public void testSameTaskIsNotAssignedToAnyTwoInstances() {\n+    String[] instances = new String[]{\"instance1\", \"instance2\", \"instance3\"};\n+    int numDatastreams = 5;\n+    List<DatastreamGroup> datastreams = generateDatastreams(\"ds\", numDatastreams);\n+    StickyMulticastStrategy strategy = new StickyMulticastStrategy(Optional.empty(), Optional.empty());\n+    Map<String, Set<DatastreamTask>> assignment =\n+        strategy.assign(datastreams, Arrays.asList(instances), new HashMap<>());\n+    assignment.get(\"instance1\").addAll(assignment.get(\"instance2\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20615997279acbc5238ab5720484cdc58017f5fa"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MjYyMTMw", "url": "https://github.com/linkedin/brooklin/pull/749#pullrequestreview-486262130", "createdAt": "2020-09-10T19:52:26Z", "commit": {"oid": "20615997279acbc5238ab5720484cdc58017f5fa"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ebebf79767309bdd2dbed4f00cee35669728652", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/9ebebf79767309bdd2dbed4f00cee35669728652", "committedDate": "2020-09-10T21:37:50Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzQ1MzAw", "url": "https://github.com/linkedin/brooklin/pull/749#pullrequestreview-486345300", "createdAt": "2020-09-10T22:10:39Z", "commit": {"oid": "9ebebf79767309bdd2dbed4f00cee35669728652"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mzk4MzU1", "url": "https://github.com/linkedin/brooklin/pull/749#pullrequestreview-486398355", "createdAt": "2020-09-11T00:34:20Z", "commit": {"oid": "9ebebf79767309bdd2dbed4f00cee35669728652"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 283, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}