{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNDM1NzA3", "number": 684, "title": "Spawn threads to stop tasks during the onAssignmentChange() code path  in AbstractKafkaConnector", "bodyText": "Currently in onAssignmentChange(), we mark removed tasks for shutdown and then let them stop naturally. This can lead to situations where the task is taking too long or stuck indefinitely (e.g. producer.flush() can get stuck). Such tasks are problematic. Instead, we should try to force stop these tasks. onAssignmentChange() is not expected to block for long by the Coordinator, due to which a separate thread should be spawned to deal with stopping tasks.", "createdAt": "2020-02-11T01:32:53Z", "url": "https://github.com/linkedin/brooklin/pull/684", "merged": true, "mergeCommit": {"oid": "918d21d1e7e62b588aa9e843c7ae76003762634a"}, "closed": true, "closedAt": "2020-02-11T19:56:59Z", "author": {"login": "somandal"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDHeEZAH2gAyMzczNDM1NzA3OjZhZTcxMTkwNDIwNTliYjZiMTQ2ZDM2YWUwZGJjZTQ2OTNmYTNhOWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDWvWSgFqTM1NjkyNDY3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6ae7119042059bb6b146d36ae0dbce4693fa3a9e", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/6ae7119042059bb6b146d36ae0dbce4693fa3a9e", "committedDate": "2020-02-11T01:30:02Z", "message": "Spawn threads to stop tasks during the onAssignmentChange() code path in AbstractKafkaConnector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzgyOTEx", "url": "https://github.com/linkedin/brooklin/pull/684#pullrequestreview-356382911", "createdAt": "2020-02-11T01:51:45Z", "commit": {"oid": "6ae7119042059bb6b146d36ae0dbce4693fa3a9e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2ODQ2NTYw", "url": "https://github.com/linkedin/brooklin/pull/684#pullrequestreview-356846560", "createdAt": "2020-02-11T17:22:20Z", "commit": {"oid": "6ae7119042059bb6b146d36ae0dbce4693fa3a9e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNzoyMjoyMFrOFoR-iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNzoyMjoyMFrOFoR-iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc4MTg5OQ==", "bodyText": "This will throw ConcurrentModificationException while iterating the loop.", "url": "https://github.com/linkedin/brooklin/pull/684#discussion_r377781899", "createdAt": "2020-02-11T17:22:20Z", "author": {"login": "vmaheshw"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -142,6 +151,7 @@ public synchronized void onAssignmentChange(List<DatastreamTask> tasks) {\n           // Make sure to replace the DatastreamTask with most up to date info\n           // This is necessary because DatastreamTaskImpl.hashCode() does not take into account all the\n           // fields/properties of the DatastreamTask (e.g. dependencies).\n+          _runningTasks.remove(task);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae7119042059bb6b146d36ae0dbce4693fa3a9e"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTA3NTU1", "url": "https://github.com/linkedin/brooklin/pull/684#pullrequestreview-356907555", "createdAt": "2020-02-11T18:52:32Z", "commit": {"oid": "6ae7119042059bb6b146d36ae0dbce4693fa3a9e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxODo1MjozMlrOFoU70g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxODo1MjozMlrOFoU70g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgzMDM1NA==", "bodyText": "typo: This will force cleanup", "url": "https://github.com/linkedin/brooklin/pull/684#discussion_r377830354", "createdAt": "2020-02-11T18:52:32Z", "author": {"login": "DEEPTHIKORAT"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -128,10 +133,14 @@ public synchronized void onAssignmentChange(List<DatastreamTask> tasks) {\n \n       for (DatastreamTask task : toCancel) {\n         ConnectorTaskEntry connectorTaskEntry = _runningTasks.remove(task);\n-        // Stopping the connectorTask. This only marks the connector task as shutdown and does not actually wait for\n-        // the connector task to stop. onAssignmentChange() must be completed quickly, otherwise the Coordinator\n-        // kills the assignment threads.\n-        connectorTaskEntry.getConnectorTask().stop();\n+        // Spawn a separate thread to attempt stopping the connectorTask. The connectorTask will be canceled if it\n+        // does not stop within a certain amount of time. This is force cleanup of connectorTasks which take too long", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ae7119042059bb6b146d36ae0dbce4693fa3a9e"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTEwMjE3", "url": "https://github.com/linkedin/brooklin/pull/684#pullrequestreview-356910217", "createdAt": "2020-02-11T18:56:32Z", "commit": {"oid": "6ae7119042059bb6b146d36ae0dbce4693fa3a9e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe2876dcd0c7ab55d292f091189e384b7ea76c37", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/fe2876dcd0c7ab55d292f091189e384b7ea76c37", "committedDate": "2020-02-11T19:01:18Z", "message": "Fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTE1Mzk1", "url": "https://github.com/linkedin/brooklin/pull/684#pullrequestreview-356915395", "createdAt": "2020-02-11T19:04:00Z", "commit": {"oid": "fe2876dcd0c7ab55d292f091189e384b7ea76c37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTI0Njcz", "url": "https://github.com/linkedin/brooklin/pull/684#pullrequestreview-356924673", "createdAt": "2020-02-11T19:17:29Z", "commit": {"oid": "fe2876dcd0c7ab55d292f091189e384b7ea76c37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 375, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}