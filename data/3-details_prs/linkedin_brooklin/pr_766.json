{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNjM0ODAw", "number": 766, "title": "Add sourcePartition to the record metadata. EventProducer should track high latency TopicPartitions via source partition", "bodyText": "We recently added a feature to track high latency TopicPartitions in the EventProducer and log them at X minute intervals. When we enabled this feature, we saw that though the task only consumed from one partition of a given topic, the logs indicated there were records with high latency for multiple partitions.\nOn further investigation, we found that the TopicPartition key used to track high latency events used the partition returned via the RecordMetadata in the send callback, which is the destination Kafka topic's partition. Since key based partitioning is often used, keys may land up being written to a different partition than the source.\nThis latency log is only useful if it helps us identify the source TopicPartitions with the highest latency. This PR adds support to track the source TopicPartition using the BrooklinEnvelope's metadata, which can then be extracted when calling the send callback to ensure that the EventProducer has data about the source partition for tracking purposes. It is okay to default the source partition to -1 if no source partition is found as not all connectors may need this feature. This PR adds this support for the KafkaConnector and KafkaMirrorMakerConnector.\nEarlier PR where we added eventIndex to the DatastreamRecordMetadata: #669\nImportant: DO NOT REPORT SECURITY ISSUES DIRECTLY ON GITHUB.\nFor reporting security issues and contributing security fixes,\nplease, email security@linkedin.com instead, as described in\nthe contribution guidelines.\nPlease, take a minute to review the contribution guidelines at:\nhttps://github.com/linkedin/Brooklin/blob/master/CONTRIBUTING.md", "createdAt": "2020-10-14T20:53:41Z", "url": "https://github.com/linkedin/brooklin/pull/766", "merged": true, "mergeCommit": {"oid": "318a1d4de0f0976b8682d26d627408b7fcbd0875"}, "closed": true, "closedAt": "2020-10-14T23:06:36Z", "author": {"login": "somandal"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSjZNUgH2gAyNTAzNjM0ODAwOjRlNjBhMTg1MTE2MDVkM2UzZDg3NzEyMTczZmNkMWNmYjg1ZTIzNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSk2UTgFqTUwODgxMDIwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4e60a18511605d3e3d87712173fcd1cfb85e2354", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/4e60a18511605d3e3d87712173fcd1cfb85e2354", "committedDate": "2020-10-14T20:42:05Z", "message": "Add sourcePartition to the record metadata. EventProducer should track high latency TopicPartitions via source partition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzI3OTgx", "url": "https://github.com/linkedin/brooklin/pull/766#pullrequestreview-508727981", "createdAt": "2020-10-14T21:05:53Z", "commit": {"oid": "4e60a18511605d3e3d87712173fcd1cfb85e2354"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTowNTo1NFrOHhlChA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTowNTo1NFrOHhlChA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MTkwOA==", "bodyText": "I wonder if metadata.put(\"kafka-origin-partition\", partitionStr); from line 129 is being used anywhere", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504971908", "createdAt": "2020-10-14T21:05:54Z", "author": {"login": "celiakung"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/KafkaConnectorTask.java", "diffHunk": "@@ -141,6 +141,7 @@ protected DatastreamProducerRecord translate(ConsumerRecord<?, ?> fromKafka, Ins\n       metadata.put(BrooklinEnvelopeMetadataConstants.EVENT_TIMESTAMP, String.valueOf(readTime.toEpochMilli()));\n       eventsSourceTimestamp = fromKafka.timestamp();\n     }\n+    metadata.put(BrooklinEnvelopeMetadataConstants.SOURCE_PARTITION, partitionStr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e60a18511605d3e3d87712173fcd1cfb85e2354"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzI5MzY4", "url": "https://github.com/linkedin/brooklin/pull/766#pullrequestreview-508729368", "createdAt": "2020-10-14T21:08:09Z", "commit": {"oid": "4e60a18511605d3e3d87712173fcd1cfb85e2354"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTowODowOVrOHhlGmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTowODozNFrOHhlHaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3Mjk1Mg==", "bodyText": "Suggest to update param docs & clarify that \"partition\" is destination Kafka topic partition", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504972952", "createdAt": "2020-10-14T21:08:09Z", "author": {"login": "celiakung"}, "path": "datastream-server-api/src/main/java/com/linkedin/datastream/server/api/transport/DatastreamRecordMetadata.java", "diffHunk": "@@ -14,9 +14,10 @@\n   private final int _partition;\n   private final String _checkpoint;\n   private final int _eventIndex;\n+  private final int _sourcePartition;\n \n   /**\n-   * Construct an instance of DatastreamRecordMetadata. Defaults the event index to 0.\n+   * Construct an instance of DatastreamRecordMetadata. Defaults the event index to 0 and source partition to -1.\n    * @param  checkpoint checkpoint string\n    * @param topic Kafka topic name\n    * @param partition Kafka topic partition", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e60a18511605d3e3d87712173fcd1cfb85e2354"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MzA3NQ==", "bodyText": "Suggest clarifying this is destination", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504973075", "createdAt": "2020-10-14T21:08:24Z", "author": {"login": "celiakung"}, "path": "datastream-server-api/src/main/java/com/linkedin/datastream/server/api/transport/DatastreamRecordMetadata.java", "diffHunk": "@@ -34,12 +36,14 @@ public DatastreamRecordMetadata(String checkpoint, String topic, int partition)\n    * @param topic Kafka topic name\n    * @param partition Kafka topic partition", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e60a18511605d3e3d87712173fcd1cfb85e2354"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MzE2MA==", "bodyText": "Partition -> Destination Partition ?", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r504973160", "createdAt": "2020-10-14T21:08:34Z", "author": {"login": "celiakung"}, "path": "datastream-server-api/src/main/java/com/linkedin/datastream/server/api/transport/DatastreamRecordMetadata.java", "diffHunk": "@@ -71,9 +75,16 @@ public int getEventIndex() {\n     return _eventIndex;\n   }\n \n+  /**\n+   * Partition number from which the record was consumed.\n+   */\n+  public int getSourcePartition() {\n+    return _sourcePartition;\n+  }\n+\n   @Override\n   public String toString() {\n-    return String.format(\"Checkpoint: %s, Topic: %s, Partition: %d, Event Index: %d\", _checkpoint, _topic, _partition,\n-        _eventIndex);\n+    return String.format(\"Checkpoint: %s, Topic: %s, Partition: %d, Event Index: %d, Source Partition: %d\", _checkpoint,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e60a18511605d3e3d87712173fcd1cfb85e2354"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13cec012ba224c4ce7dc24e4dfa92bddda893a70", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/13cec012ba224c4ce7dc24e4dfa92bddda893a70", "committedDate": "2020-10-14T21:13:45Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzQ1OTI1", "url": "https://github.com/linkedin/brooklin/pull/766#pullrequestreview-508745925", "createdAt": "2020-10-14T21:20:23Z", "commit": {"oid": "13cec012ba224c4ce7dc24e4dfa92bddda893a70"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODEwMjA3", "url": "https://github.com/linkedin/brooklin/pull/766#pullrequestreview-508810207", "createdAt": "2020-10-14T22:20:13Z", "commit": {"oid": "13cec012ba224c4ce7dc24e4dfa92bddda893a70"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMjoyMDoxNFrOHhn0wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMjoyMzozMlrOHhn-Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxNzUzNw==", "bodyText": "Nit: Is it possible to merge this constant with \"kafka-origin-offset\"? It feels like we have some redundancy in metadata fields otherwise.", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r505017537", "createdAt": "2020-10-14T22:20:14Z", "author": {"login": "jzakaryan"}, "path": "datastream-common/src/main/java/com/linkedin/datastream/common/BrooklinEnvelopeMetadataConstants.java", "diffHunk": "@@ -36,4 +36,7 @@\n \n   // Timestamp of the event when it was written in the last leg (i.e. the Source of the connector)\n   public static final String SOURCE_TIMESTAMP = \"SourceTimestamp\";\n+\n+  // Source partition number from where the event was generated\n+  public static final String SOURCE_PARTITION = \"SourcePartition\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13cec012ba224c4ce7dc24e4dfa92bddda893a70"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxOTk1MQ==", "bodyText": "Nit: It may be worth renaming partition to destinationPartition to make it explicit to the users.", "url": "https://github.com/linkedin/brooklin/pull/766#discussion_r505019951", "createdAt": "2020-10-14T22:23:32Z", "author": {"login": "jzakaryan"}, "path": "datastream-server-api/src/main/java/com/linkedin/datastream/server/api/transport/DatastreamRecordMetadata.java", "diffHunk": "@@ -71,9 +75,16 @@ public int getEventIndex() {\n     return _eventIndex;\n   }\n \n+  /**\n+   * Partition number from which the record was consumed.\n+   */\n+  public int getSourcePartition() {\n+    return _sourcePartition;\n+  }\n+\n   @Override\n   public String toString() {\n-    return String.format(\"Checkpoint: %s, Topic: %s, Partition: %d, Event Index: %d\", _checkpoint, _topic, _partition,\n-        _eventIndex);\n+    return String.format(\"Checkpoint: %s, Topic: %s, Destination Partition: %d, Event Index: %d, Source Partition: %d\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13cec012ba224c4ce7dc24e4dfa92bddda893a70"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 306, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}