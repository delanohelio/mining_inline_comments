{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MTE2Mzky", "number": 740, "title": "Add metric to count number of Nanny Task restarts for BMM", "bodyText": "", "createdAt": "2020-08-11T13:47:53Z", "url": "https://github.com/linkedin/brooklin/pull/740", "merged": true, "mergeCommit": {"oid": "7280a3a94235d0805c6707679a041382f7e6cf41"}, "closed": true, "closedAt": "2020-08-18T16:27:01Z", "author": {"login": "vishwajith-s"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYQxbWAH2gAyNDY2MTE2MzkyOmIyNWE4OTUwYzIyMGZkNmJjNTZhNDkzZTU0YjUzZDZlZmIwMDc1MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAJDY8gFqTQ2OTU5MDc1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b25a8950c220fd6bc56a493e54b53d6efb007535", "author": {"user": {"login": "vishwajith-s", "name": "Vishwajith Shivappa"}}, "url": "https://github.com/linkedin/brooklin/commit/b25a8950c220fd6bc56a493e54b53d6efb007535", "committedDate": "2020-04-16T18:12:44Z", "message": "Add espresso key schema to the datastream metadata\n\nThis patch just adds the constant. The actual change will be done\nin the brooklin-server."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8df3a94268018b5fba22aa55458a80ba0ae93f63", "author": {"user": {"login": "vishwajith-s", "name": "Vishwajith Shivappa"}}, "url": "https://github.com/linkedin/brooklin/commit/8df3a94268018b5fba22aa55458a80ba0ae93f63", "committedDate": "2020-08-11T00:58:13Z", "message": "Merge branch 'master' of github.com:linkedin/brooklin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjIyNzI3", "url": "https://github.com/linkedin/brooklin/pull/740#pullrequestreview-465222727", "createdAt": "2020-08-11T16:15:15Z", "commit": {"oid": "d339fe5024579db9dbcb9c64b476a4b5c39a2395"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjoxNToxNVrOG-_QXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjo0NDo1NlrOG_AZsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMTI3Ng==", "bodyText": "Since this is an abstract class which needs to be extended by actual Connectors, can we take a metrics prefix as input and use that to construct the metrics instead? This way, the metrics will be more meaningful, and it'll be easier to differentiate between different connectors that use this as their base.\nYou can look at AbstractKafkaBasedConnectorTask to see how connector tasks that extend it construct and pass their metrics prefix. We do want both the extending class name and the connector name to be part of the metrics prefix. This is because we have many connectors which use the same class.", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468701276", "createdAt": "2020-08-11T16:15:15Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -73,6 +77,11 @@\n   private static final Duration SHUTDOWN_EXECUTOR_SHUTDOWN_TIMEOUT = Duration.ofSeconds(30);\n   static final Duration MIN_DAEMON_THREAD_STARTUP_DELAY = Duration.ofMinutes(2);\n \n+  private static final String MODULE = AbstractKafkaConnector.class.getSimpleName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d339fe5024579db9dbcb9c64b476a4b5c39a2395"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMzI5Mg==", "bodyText": "Since this is an abstract class, you need to fix all the extenders of this class to call super.getMetricsInfos() in their override of getMetricsInfos(), along with their existing code to return all metrics, otherwise this metric won't be picked up by them. Any in-house Connectors need to be fixed too.", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468703292", "createdAt": "2020-08-11T16:18:24Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -553,4 +564,12 @@ public AbstractKafkaBasedConnectorTask getConnectorTask() {\n       return _task;\n     }\n   }\n+\n+  @Override\n+  public List<BrooklinMetricInfo> getMetricInfos() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d339fe5024579db9dbcb9c64b476a4b5c39a2395"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcxMDM4OA==", "bodyText": "Connector already implements MetricsAware, so you don't need to here", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468710388", "createdAt": "2020-08-11T16:29:10Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -64,7 +68,7 @@\n  *  <li>Restarting stalled {@link DatastreamTask}s</li>\n  * </ul>\n  */\n-public abstract class AbstractKafkaConnector implements Connector, DiagnosticsAware {\n+public abstract class AbstractKafkaConnector implements Connector, DiagnosticsAware, MetricsAware {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d339fe5024579db9dbcb9c64b476a4b5c39a2395"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcxNDY0Mg==", "bodyText": "@ahmedahamid is there a recommendation on when to use a gauge vs. a counter?", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468714642", "createdAt": "2020-08-11T16:35:58Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -229,6 +239,7 @@ protected void restartDeadTasks() {\n         _logger.warn(\"Creating a new connector task for the datastream task {}\", datastreamTask);\n         _runningTasks.put(datastreamTask, createKafkaConnectorTask(datastreamTask));\n       });\n+      _dynamicMetricsManager.createOrUpdateCounter(MODULE, NUM_TASK_RESTARTS, deadDatastreamTasks.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d339fe5024579db9dbcb9c64b476a4b5c39a2395"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyMDA0OQ==", "bodyText": "Once you move to using the metrics prefix, you'll need to modify this. Plus you should use a regex for matching:\n<metrics prefix> + MetricsAware.KEY_REGEX + <metrics name>", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468720049", "createdAt": "2020-08-11T16:44:56Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -553,4 +564,12 @@ public AbstractKafkaBasedConnectorTask getConnectorTask() {\n       return _task;\n     }\n   }\n+\n+  @Override\n+  public List<BrooklinMetricInfo> getMetricInfos() {\n+    List<BrooklinMetricInfo> metrics = new ArrayList<>();\n+    metrics.add(new BrooklinMeterInfo(buildMetricName(NUM_TASK_RESTARTS)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d339fe5024579db9dbcb9c64b476a4b5c39a2395"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "author": {"user": {"login": "vishwajith-s", "name": "Vishwajith Shivappa"}}, "url": "https://github.com/linkedin/brooklin/commit/d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "committedDate": "2020-08-11T18:32:10Z", "message": "Add metric to count number of Task restarts for BMM\n\nMetric tracks the number of task restarts done by nanny thread in\ncase of AbstractKafkaConnector."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d339fe5024579db9dbcb9c64b476a4b5c39a2395", "author": {"user": {"login": "vishwajith-s", "name": "Vishwajith Shivappa"}}, "url": "https://github.com/linkedin/brooklin/commit/d339fe5024579db9dbcb9c64b476a4b5c39a2395", "committedDate": "2020-08-11T13:27:29Z", "message": "Add metric to count number of Task restarts for BMM\n\nMetric tracks the number of task restarts done by nanny thread in\ncase of AbstractKafkaConnector."}, "afterCommit": {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "author": {"user": {"login": "vishwajith-s", "name": "Vishwajith Shivappa"}}, "url": "https://github.com/linkedin/brooklin/commit/d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9", "committedDate": "2020-08-11T18:32:10Z", "message": "Add metric to count number of Task restarts for BMM\n\nMetric tracks the number of task restarts done by nanny thread in\ncase of AbstractKafkaConnector."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MzMzODcw", "url": "https://github.com/linkedin/brooklin/pull/740#pullrequestreview-465333870", "createdAt": "2020-08-11T18:42:01Z", "commit": {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxODo0MjowMVrOG_Eiow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxODo0MjowMVrOG_Eiow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc4Nzg3NQ==", "bodyText": "Do we need to add regex here? Is this right? @somandal @ahmedahamid", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468787875", "createdAt": "2020-08-11T18:42:01Z", "author": {"login": "vishwajith-s"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -229,6 +245,7 @@ protected void restartDeadTasks() {\n         _logger.warn(\"Creating a new connector task for the datastream task {}\", datastreamTask);\n         _runningTasks.put(datastreamTask, createKafkaConnectorTask(datastreamTask));\n       });\n+      _dynamicMetricsManager.createOrUpdateCounter(_metricsPrefix, NUM_TASK_RESTARTS, deadDatastreamTasks.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjUwMTkw", "url": "https://github.com/linkedin/brooklin/pull/740#pullrequestreview-465250190", "createdAt": "2020-08-11T16:49:28Z", "commit": {"oid": "d339fe5024579db9dbcb9c64b476a4b5c39a2395"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjo0OToyOFrOG_AkpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzoxMTowOVrOG_qs6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyMjg1Mg==", "bodyText": "MetricsAware is redundant here; Connector is MetricsAware", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468722852", "createdAt": "2020-08-11T16:49:28Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -64,7 +68,7 @@\n  *  <li>Restarting stalled {@link DatastreamTask}s</li>\n  * </ul>\n  */\n-public abstract class AbstractKafkaConnector implements Connector, DiagnosticsAware {\n+public abstract class AbstractKafkaConnector implements Connector, DiagnosticsAware, MetricsAware {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d339fe5024579db9dbcb9c64b476a4b5c39a2395"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc2MjY0Nw==", "bodyText": "Not strictly related to your PR but would be nice to do: you can change the visibility of this field to protected so subtypes can utilize it. I know of one extender that currently needs it, i.e. KafkaMirrorMakerConnector, and it's maintaining a similar private field. It would be nice to have extenders use this field instead.", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468762647", "createdAt": "2020-08-11T17:57:01Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -73,6 +77,11 @@\n   private static final Duration SHUTDOWN_EXECUTOR_SHUTDOWN_TIMEOUT = Duration.ofSeconds(30);\n   static final Duration MIN_DAEMON_THREAD_STARTUP_DELAY = Duration.ofMinutes(2);\n \n+  private static final String MODULE = AbstractKafkaConnector.class.getSimpleName();\n+  private static final String NUM_TASK_RESTARTS = \"numTaskRestarts\";\n+\n+  private final DynamicMetricsManager _dynamicMetricsManager;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d339fe5024579db9dbcb9c64b476a4b5c39a2395"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk4MzU2MA==", "bodyText": "It's almost correct.\n\n\nThe metric's MBean name will be <_metricsPrefix>.<NUM_TASK_RESTARTS>\n\n\nThe corresponding BrooklinMetricInfo object we return from getMetricInfos() will have a nameOrRegex of: <concreteClassName>.<_metricsPrefix>([-.\\w\\d]+)\\.<NUM_TASK_RESTARTS>\nThis is the value returned by:\nbuildMetricName(_metricsPrefix + MetricsAware.KEY_REGEX + NUM_TASK_RESTARTS)\nIn case you're wondering, the <concreteClassName> prefix above is prepended by buildMetricName() itself (that's what this overload does).\n\n\nThe way it works is that the regex in (2) has to match the metric's MBean in (1), which won't happen right now because the regex (a) has an extra <concreteClassName> prefix and (b) expects a string (i.e. ([-.\\w\\d]+)\\.) between <_metricsPrefix> and <NUM_TASK_RESTARTS>\n\n\nIn fact, they do not match in TestAbstractKafkaConnector.testConnectorRestartCalled() when I step into it with a debugger. The metric's MBean is test.TestKafkaConnector.numTaskRestarts but the BrooklinMetricInfo's nameOrRegex is TestKafkaConnector.test.TestKafkaConnector([-.\\w\\d]+)\\.numTaskRestarts\n\n\nThere's a few different ways to resolve this but let me suggest this: how about we let AbstractKafkaConnector itself decide the metrics prefix?\n\nThis class has all the necessary ingredients; it knows the connector name and it can get the concrete class name by calling this.getClass().getSimpleName()\nDoing that would eliminate the redundancy entailed by having every subtype call generateMetricsPrefix() to pass its return value to super.\n\nIf you like the idea, here are some more details:\n\nIt won't be straightforward/ideal to use regexes with the metric you're adding because its name has no variable parts (like a datastream or topic name), it's just <metricsPrefix>.<NUM_TASK_RESTARTS>\nConsequently, you can use _dynamicMetricsManager.registerMetric() to create the metric's MBean (e.g. in the ctor or when start() is called), use _dynamicMetricsManager.createOrUpdate() when you need to update the metric, and return a BrooklinMetricInfo object from getMetricInfos() whose nameOrRegex is decided by buildMetricName(_metricsPrefix, NUM_TASK_RESTARTS)\nThis way, the metric's MBean and the corresponding BrooklinMetricInfo will both have the name <metricsPrefix>.<NUM_TASK_RESTARTS>\nOne last thing to note is that the specific BrooklinMetricInfo subtype you use in getMetricInfos() must match the metric type (e.g. BrooklinMeterInfo for meters, BrooklinCounterInfo for counters ... etc).", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r468983560", "createdAt": "2020-08-12T03:28:01Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -229,6 +245,7 @@ protected void restartDeadTasks() {\n         _logger.warn(\"Creating a new connector task for the datastream task {}\", datastreamTask);\n         _runningTasks.put(datastreamTask, createKafkaConnectorTask(datastreamTask));\n       });\n+      _dynamicMetricsManager.createOrUpdateCounter(_metricsPrefix, NUM_TASK_RESTARTS, deadDatastreamTasks.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc4Nzg3NQ=="}, "originalCommit": {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQwODE1Nw==", "bodyText": "Sonam left me a question about counters vs. gauges but GitHub won't allow me to comment on it for some reason \u2014 they're roughly comparable but this ingraphs wiki page seems to suggest we should be using gauges for values that would increase and decrease over time (which seems to be the case for the metric this PR is adding). A similar comment has been made in response to the same question on the repo of the metrics library we're using.", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r469408157", "createdAt": "2020-08-12T17:02:36Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -229,6 +245,7 @@ protected void restartDeadTasks() {\n         _logger.warn(\"Creating a new connector task for the datastream task {}\", datastreamTask);\n         _runningTasks.put(datastreamTask, createKafkaConnectorTask(datastreamTask));\n       });\n+      _dynamicMetricsManager.createOrUpdateCounter(_metricsPrefix, NUM_TASK_RESTARTS, deadDatastreamTasks.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxMzA5OQ==", "bodyText": "This should be BrooklinCounterInfo if the metric is a counter.", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r469413099", "createdAt": "2020-08-12T17:11:09Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -553,4 +570,12 @@ public AbstractKafkaBasedConnectorTask getConnectorTask() {\n       return _task;\n     }\n   }\n+\n+  @Override\n+  public List<BrooklinMetricInfo> getMetricInfos() {\n+    List<BrooklinMetricInfo> metrics = new ArrayList<>();\n+    metrics.add(new BrooklinMeterInfo(buildMetricName(_metricsPrefix + MetricsAware.KEY_REGEX + NUM_TASK_RESTARTS)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MTE5OTQ1", "url": "https://github.com/linkedin/brooklin/pull/740#pullrequestreview-466119945", "createdAt": "2020-08-12T17:20:27Z", "commit": {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzoyMDoyN1rOG_rDUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzoyMDoyN1rOG_rDUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxODgzMg==", "bodyText": "@ahmedahamid and @vishwajith-s I just noticed that callers of this pass the \"connectorName\" when fetching metrics from the connectorTask. Should we also only return metrics for a given \"connectorName\" here?", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r469418832", "createdAt": "2020-08-12T17:20:27Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -553,4 +570,12 @@ public AbstractKafkaBasedConnectorTask getConnectorTask() {\n       return _task;\n     }\n   }\n+\n+  @Override\n+  public List<BrooklinMetricInfo> getMetricInfos() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4e1c7ad61bca05abf4d58a8fc07f05b323d26f9"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09816fcc7f99bc4d5c6fe7bc505e1bb735c0d59d", "author": {"user": {"login": "vishwajith-s", "name": "Vishwajith Shivappa"}}, "url": "https://github.com/linkedin/brooklin/commit/09816fcc7f99bc4d5c6fe7bc505e1bb735c0d59d", "committedDate": "2020-08-17T20:58:50Z", "message": "Addressed comments from Ahmed and Sonam\n\n* Rectified the mbean and msensor name mismatch\n* Converted the counter to gauge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88358a12e0d66fd2a321ddd485b6650806740e6c", "author": {"user": {"login": "vishwajith-s", "name": "Vishwajith Shivappa"}}, "url": "https://github.com/linkedin/brooklin/commit/88358a12e0d66fd2a321ddd485b6650806740e6c", "committedDate": "2020-08-17T21:27:46Z", "message": "Rearranged import orders"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTIzMzgx", "url": "https://github.com/linkedin/brooklin/pull/740#pullrequestreview-468923381", "createdAt": "2020-08-18T00:58:16Z", "commit": {"oid": "88358a12e0d66fd2a321ddd485b6650806740e6c"}, "state": "DISMISSED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMDo1ODoxNlrOHB_qHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMToxNTo1MFrOHB_82g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1MzU5OQ==", "bodyText": "nit: prefer using Apache commons lang3 (just change the import to lang3)\nThis would entail adding the following dependency in build.gradle under\nproject(':datastream-kafka-connector') {\n    ....\n    compile \"org.apache.commons:commons-lang3:$commonslang3Version\"", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471853599", "createdAt": "2020-08-18T00:58:16Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -28,6 +28,7 @@\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.stream.Collectors;\n \n+import org.apache.commons.lang.StringUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88358a12e0d66fd2a321ddd485b6650806740e6c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1NDA0OQ==", "bodyText": "Could you please have KafkaMirrorMakerConnector use this field instead of the private one it's maintaining against the same object (KafkaMirrorMakerConnector.java line 77)?", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471854049", "createdAt": "2020-08-18T00:59:53Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -73,6 +77,11 @@\n   private static final Duration SHUTDOWN_EXECUTOR_SHUTDOWN_TIMEOUT = Duration.ofSeconds(30);\n   static final Duration MIN_DAEMON_THREAD_STARTUP_DELAY = Duration.ofMinutes(2);\n \n+  private static final String NUM_TASK_RESTARTS = \"numTaskRestarts\";\n+  private long _numTaskRestarts = 0;\n+  private final String _metricsPrefix;\n+\n+  protected final DynamicMetricsManager _dynamicMetricsManager;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88358a12e0d66fd2a321ddd485b6650806740e6c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1NTM1Nw==", "bodyText": "_numTaskRestarts will be accessed by different threads (for reading and writing). I suggest marking it volatile.", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471855357", "createdAt": "2020-08-18T01:04:42Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/AbstractKafkaConnector.java", "diffHunk": "@@ -118,6 +127,10 @@ public AbstractKafkaConnector(String connectorName, Properties config, GroupIdCo\n     _clusterName = clusterName;\n     _config = new KafkaBasedConnectorConfig(config);\n     _groupIdConstructor = groupIdConstructor;\n+    _dynamicMetricsManager = DynamicMetricsManager.getInstance();\n+    _metricsPrefix = StringUtils.isBlank(connectorName) ? this.getClass().getSimpleName()\n+        : connectorName + \".\" + this.getClass().getSimpleName();\n+    _dynamicMetricsManager.registerGauge(_metricsPrefix, NUM_TASK_RESTARTS, () -> _numTaskRestarts);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88358a12e0d66fd2a321ddd485b6650806740e6c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1ODM5NA==", "bodyText": "By default, this verification won't include metrics that do not start with the class name of the metricsAware object in question, i.e. it won't consider the metric test.TestKafkaConnector.numTaskRestarts because it doesn't start with TestKafkaConnector. To have it include that metric, you'll need to pass in a predicate that explicitly includes such metrics, e.g. s -> s.startsWith(\"test\")", "url": "https://github.com/linkedin/brooklin/pull/740#discussion_r471858394", "createdAt": "2020-08-18T01:15:50Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/TestAbstractKafkaConnector.java", "diffHunk": "@@ -50,6 +62,16 @@ public void testConnectorRestartCalled() {\n         Duration.ofSeconds(10).toMillis());\n     Assert.assertTrue(connector.getCreateTaskCalled() >= 3);\n \n+    // Verify metric for nanny task restarts get incremented\n+    Gauge<Long> metric = DynamicMetricsManager.getInstance()\n+        .getMetric(\"test\" + \".\" + TestKafkaConnector.class.getSimpleName() + \".\" + \"numTaskRestarts\");\n+    Assert.assertNotNull(metric);\n+    Assert.assertEquals(metric.getValue(), Long.valueOf(1));\n+\n+    // Verify that metrics created through DynamicMetricsManager match those returned by getMetricInfos() given the\n+    // connector name of interest.\n+    MetricsTestUtils.verifyMetrics(connector, DynamicMetricsManager.getInstance());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88358a12e0d66fd2a321ddd485b6650806740e6c"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24bf41816f0f6cd05e36ecd8a3f1ff83c7ffabb1", "author": {"user": {"login": "vishwajith-s", "name": "Vishwajith Shivappa"}}, "url": "https://github.com/linkedin/brooklin/commit/24bf41816f0f6cd05e36ecd8a3f1ff83c7ffabb1", "committedDate": "2020-08-18T12:55:51Z", "message": "Addressed comments from Ahmed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTAyNDM1", "url": "https://github.com/linkedin/brooklin/pull/740#pullrequestreview-469502435", "createdAt": "2020-08-18T14:18:48Z", "commit": {"oid": "24bf41816f0f6cd05e36ecd8a3f1ff83c7ffabb1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTkwNzUx", "url": "https://github.com/linkedin/brooklin/pull/740#pullrequestreview-469590751", "createdAt": "2020-08-18T15:50:05Z", "commit": {"oid": "24bf41816f0f6cd05e36ecd8a3f1ff83c7ffabb1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 908, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}