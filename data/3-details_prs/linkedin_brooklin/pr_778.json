{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MDIzMjI0", "number": 778, "title": "Fix discrepancy in Gauge Metrics in PartitionMetrics and KafkaBasedConnectorTaskMetrics", "bodyText": "Gauge metrics use a supplier function to get the latest value. For aggregate gauge metrics, we use a static object to have only one supplier function across all the tasks in the host. For task level gauge metrics, we maintain a local supplier function within the task object. This works fine as long as the key is different for each task. For KafkaMirrorMakerConnectorTask object, the metrics key is datastream name and not task name, which means if there are multiple tasks of the same datastream group on the same host, they will have conflict and gauge will return incorrect/unpredictable result.\nTo solve this problem, making the gauge level supplier as a static object, so that there will be only one copy of the supplier function per key and we will not see the discrepancy in the result.\nI was able to reproduce the problem by extending the unit-tests. The unit-tests pass after the fix. This problem also exists for PartitionMetrics which has 2 gauge metrics \"numPartitions\" and \"numStuckPartitions\".", "createdAt": "2020-11-06T23:15:44Z", "url": "https://github.com/linkedin/brooklin/pull/778", "merged": true, "mergeCommit": {"oid": "e40a69f0819d87c45d46f18743d61c7e5a56d024"}, "closed": true, "closedAt": "2020-11-10T23:07:54Z", "author": {"login": "vmaheshw"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABboAf5CAH2gAyNTE3MDIzMjI0OmMzMWNkNGExNWNjOGRkNjliMGE2NTNkYmU0MjAxZGU5MzRlYTZkNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbRU_LAFqTUyNzY2ODMyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "author": {"user": {"login": "vmaheshw", "name": "Vaibhav Maheshwari"}}, "url": "https://github.com/linkedin/brooklin/commit/c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "committedDate": "2019-11-18T20:06:44Z", "message": "Merge pull request #1 from linkedin/master\n\nPull latest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79ffa91188aa16ebcb2e9c1e55d4b9a8911b9c36", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/79ffa91188aa16ebcb2e9c1e55d4b9a8911b9c36", "committedDate": "2020-11-02T20:44:50Z", "message": "Merge branch 'master' of github.com:linkedin/brooklin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c47e8db35da7f88ba331cae00cc408fa0081ca0", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/7c47e8db35da7f88ba331cae00cc408fa0081ca0", "committedDate": "2020-11-06T19:39:11Z", "message": "Fix Gauge metrics in KafkaBasedConnectorTaskMetrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4dae044620138e3dc622545cae02825530ca4e8", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/f4dae044620138e3dc622545cae02825530ca4e8", "committedDate": "2020-11-06T23:07:48Z", "message": "Fix unit-tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDkxMTY5", "url": "https://github.com/linkedin/brooklin/pull/778#pullrequestreview-527491169", "createdAt": "2020-11-10T18:33:22Z", "commit": {"oid": "f4dae044620138e3dc622545cae02825530ca4e8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODozMzoyM1rOHwp9cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODozNzoyNVrOHwqGXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc4MTE3MA==", "bodyText": "Once concern I have here is what if two threads update these metrics at the same time? Since these aren't atomic anymore, will that be something to worry about? Same for the numTopics variable for the numTopics metric.", "url": "https://github.com/linkedin/brooklin/pull/778#discussion_r520781170", "createdAt": "2020-11-10T18:33:23Z", "author": {"login": "somandal"}, "path": "datastream-common/src/main/java/com/linkedin/datastream/connectors/CommonConnectorMetrics.java", "diffHunk": "@@ -186,23 +187,30 @@ protected void deregisterAggregates() {\n     static final String NUM_PARTITIONS = \"numPartitions\";\n \n     // Per consumer metrics\n-    final AtomicLong _numStuckPartitions = new AtomicLong(0);\n-    final AtomicLong _numPartitions = new AtomicLong(0);\n     final Meter _rebalanceRate;\n \n     // Aggregated metrics\n     final Meter _aggregatedRebalanceRate;\n \n+    final String _fullMetricsKey;\n+\n     // Map from connector class name to its stuck and total partition counter\n     // This is needed for Gauge metrics which need long-typed suppliers.\n+    static final Map<String, AtomicLong> NUM_STUCK_PARTITIONS_PER_METRIC_KEY = new ConcurrentHashMap<>();\n+    static final Map<String, AtomicLong> NUM_PARTITIONS_PER_METRIC_KEY = new ConcurrentHashMap<>();\n     static final Map<String, AtomicLong> AGGREGATED_NUM_STUCK_PARTITIONS = new ConcurrentHashMap<>();\n     static final Map<String, AtomicLong> AGGREGATED_NUM_PARTITIONS = new ConcurrentHashMap<>();\n+    private long _numStuckPartitions = 0;\n+    private long _numPartitions = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4dae044620138e3dc622545cae02825530ca4e8"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc4MzQ1NQ==", "bodyText": "Same concern about these no longer being atomic, and what happens if multiple threads try to update any of these at the same time? Can't they race and cause incorrect updates?", "url": "https://github.com/linkedin/brooklin/pull/778#discussion_r520783455", "createdAt": "2020-11-10T18:37:25Z", "author": {"login": "somandal"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/KafkaBasedConnectorTaskMetrics.java", "diffHunk": "@@ -54,28 +55,48 @@\n   private static final Map<String, AtomicLong> AGGREGATED_NUM_AUTO_PAUSED_PARTITIONS_WAITING_FOR_DEST_TOPIC =\n       new ConcurrentHashMap<>();\n \n-  private final AtomicLong _numConfigPausedPartitions = new AtomicLong(0);\n-  private final AtomicLong _numAutoPausedPartitionsOnError = new AtomicLong(0);\n-  private final AtomicLong _numAutoPausedPartitionsOnInFlightMessages = new AtomicLong(0);\n-  private final AtomicLong _numAutoPausedPartitionsAwaitingDestTopic = new AtomicLong(0);\n-  private final AtomicLong _numTopics = new AtomicLong(0);\n+  private static final Map<String, AtomicLong> NUM_TOPICS_PER_METRIC_KEY = new ConcurrentHashMap<>();\n+  private static final Map<String, AtomicLong> NUM_CONFIG_PAUSED_PARTITIONS_PER_METRIC_KEY = new ConcurrentHashMap<>();\n+  private static final Map<String, AtomicLong> NUM_AUTO_PAUSED_PARTITIONS_ON_ERROR_PER_METRIC_KEY =\n+      new ConcurrentHashMap<>();\n+  private static final Map<String, AtomicLong> NUM_AUTO_PAUSED_PARTITIONS_ON_INFLIGHT_MESSAGES_PER_METRIC_KEY =\n+      new ConcurrentHashMap<>();\n+  private static final Map<String, AtomicLong> NUM_AUTO_PAUSED_PARTITIONS_WAITING_FOR_DEST_TOPIC_PER_METRIC_KEY =\n+      new ConcurrentHashMap<>();\n+\n+  private long _numConfigPausedPartitions = 0;\n+  private long _numAutoPausedPartitionsOnError = 0;\n+  private long _numAutoPausedPartitionsOnInFlightMessages = 0;\n+  private long _numAutoPausedPartitionsAwaitingDestTopic = 0;\n+  private long _numTopics = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4dae044620138e3dc622545cae02825530ca4e8"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9daffe5d54e5bee8ea9d4350bb2884bd2a74f31f", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/9daffe5d54e5bee8ea9d4350bb2884bd2a74f31f", "committedDate": "2020-11-10T18:54:16Z", "message": "Change local state from long to AtomicLong"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTMyNTQx", "url": "https://github.com/linkedin/brooklin/pull/778#pullrequestreview-527532541", "createdAt": "2020-11-10T19:20:32Z", "commit": {"oid": "9daffe5d54e5bee8ea9d4350bb2884bd2a74f31f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjY4MzIw", "url": "https://github.com/linkedin/brooklin/pull/778#pullrequestreview-527668320", "createdAt": "2020-11-10T22:44:30Z", "commit": {"oid": "9daffe5d54e5bee8ea9d4350bb2884bd2a74f31f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 336, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}