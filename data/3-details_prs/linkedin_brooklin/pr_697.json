{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5Nzc5OTgy", "number": 697, "title": "Improve partitionV2 logging in DatastreamTaskImpl.", "bodyText": "Currently, partition as Array List is converted into String list in partitionV2 and partitionV2 is used for assignment. The task will 2000 partitions show up in logs as 1,2,3....,1999,2000. which takes up most of the log file and make it difficult to debug. Summarizing this to [1-2000] will save log space and  allow efficient debugging.", "createdAt": "2020-04-06T17:04:10Z", "url": "https://github.com/linkedin/brooklin/pull/697", "merged": true, "mergeCommit": {"oid": "963bf43ae4de723c680476e0cf1749d9ead5f4e7"}, "closed": true, "closedAt": "2020-04-06T22:29:36Z", "author": {"login": "vmaheshw"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABboAf5CAH2gAyMzk5Nzc5OTgyOmMzMWNkNGExNWNjOGRkNjliMGE2NTNkYmU0MjAxZGU5MzRlYTZkNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVFXbAAFqTM4ODYyMTU4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "author": {"user": {"login": "vmaheshw", "name": "Vaibhav Maheshwari"}}, "url": "https://github.com/linkedin/brooklin/commit/c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "committedDate": "2019-11-18T20:06:44Z", "message": "Merge pull request #1 from linkedin/master\n\nPull latest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0acfc3b283728d8fd72495cad2eec60f95140bc1", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/0acfc3b283728d8fd72495cad2eec60f95140bc1", "committedDate": "2020-04-06T02:01:20Z", "message": "Merge branch 'master' of github.com:linkedin/brooklin into HEAD"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adecb62138b4751e0a735c8f83487729d6be346f", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/adecb62138b4751e0a735c8f83487729d6be346f", "committedDate": "2020-04-06T16:59:15Z", "message": "Improve partitionV2 logging in DatastreamTaskImpl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDc4MjM1", "url": "https://github.com/linkedin/brooklin/pull/697#pullrequestreview-388478235", "createdAt": "2020-04-06T17:44:20Z", "commit": {"oid": "adecb62138b4751e0a735c8f83487729d6be346f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNzo0NDoyMFrOGBi8_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNzo1NzoxNlrOGBjb7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI3NDQyOQ==", "bodyText": "I think more context is necessary here for when _partitions vs. _partitionsV2 is used. Partition managed uses _partitionsV2 and puts in the full name of the Topic-Partition, due to which the log cannot be reduced in this way.\nI'd also question whether we should avoid populating _partitionsV2 altogether for any tasks that are not Partition managed. This can be explored as part of another PR though (maybe open a ticket for this)", "url": "https://github.com/linkedin/brooklin/pull/697#discussion_r404274429", "createdAt": "2020-04-06T17:44:20Z", "author": {"login": "somandal"}, "path": "datastream-server/src/main/java/com/linkedin/datastream/server/DatastreamTaskImpl.java", "diffHunk": "@@ -436,8 +436,25 @@ public int hashCode() {\n   @Override\n   public String toString() {\n     // toString() is mainly for logging purpose, feel free to modify the content/format\n-    return String.format(\"%s(%s), partitionsV2=%s, partitions=%s, dependencies=%s\", getDatastreamTaskName(), _connectorType,\n-        String.join(\",\", _partitionsV2), LogUtils.logNumberArrayInRange(_partitions), _dependencies);\n+    // If _partitions is populated, it is replicated into _partitionsV2 for assignment. However,\n+    // if _partitions is not populated, we can assume that only _partitionsV2 is populated.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adecb62138b4751e0a735c8f83487729d6be346f"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI3NTc4MA==", "bodyText": "The format string is used in 3 places now. Create a local variable/member constant FORMAT_STRING?", "url": "https://github.com/linkedin/brooklin/pull/697#discussion_r404275780", "createdAt": "2020-04-06T17:46:32Z", "author": {"login": "somandal"}, "path": "datastream-server/src/main/java/com/linkedin/datastream/server/DatastreamTaskImpl.java", "diffHunk": "@@ -436,8 +436,25 @@ public int hashCode() {\n   @Override\n   public String toString() {\n     // toString() is mainly for logging purpose, feel free to modify the content/format\n-    return String.format(\"%s(%s), partitionsV2=%s, partitions=%s, dependencies=%s\", getDatastreamTaskName(), _connectorType,\n-        String.join(\",\", _partitionsV2), LogUtils.logNumberArrayInRange(_partitions), _dependencies);\n+    // If _partitions is populated, it is replicated into _partitionsV2 for assignment. However,\n+    // if _partitions is not populated, we can assume that only _partitionsV2 is populated.\n+    if (_partitions.size() > 0) {\n+      try {\n+        List<Integer> partitionList = _partitionsV2.stream().map(Integer::parseInt).collect(Collectors.toList());\n+\n+        return String.format(\"%s(%s), partitionsV2=%s, partitions=%s, dependencies=%s\", getDatastreamTaskName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adecb62138b4751e0a735c8f83487729d6be346f"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MjM0OQ==", "bodyText": "Remove the return log from here. It's the same as the one outside the if() block. Let it drop into the return outside the if() block.", "url": "https://github.com/linkedin/brooklin/pull/697#discussion_r404282349", "createdAt": "2020-04-06T17:57:16Z", "author": {"login": "somandal"}, "path": "datastream-server/src/main/java/com/linkedin/datastream/server/DatastreamTaskImpl.java", "diffHunk": "@@ -436,8 +436,25 @@ public int hashCode() {\n   @Override\n   public String toString() {\n     // toString() is mainly for logging purpose, feel free to modify the content/format\n-    return String.format(\"%s(%s), partitionsV2=%s, partitions=%s, dependencies=%s\", getDatastreamTaskName(), _connectorType,\n-        String.join(\",\", _partitionsV2), LogUtils.logNumberArrayInRange(_partitions), _dependencies);\n+    // If _partitions is populated, it is replicated into _partitionsV2 for assignment. However,\n+    // if _partitions is not populated, we can assume that only _partitionsV2 is populated.\n+    if (_partitions.size() > 0) {\n+      try {\n+        List<Integer> partitionList = _partitionsV2.stream().map(Integer::parseInt).collect(Collectors.toList());\n+\n+        return String.format(\"%s(%s), partitionsV2=%s, partitions=%s, dependencies=%s\", getDatastreamTaskName(),\n+            _connectorType, LogUtils.logNumberArrayInRange(partitionList), LogUtils.logNumberArrayInRange(_partitions),\n+            _dependencies);\n+      } catch (NumberFormatException e) {\n+        LOG.error(e.getMessage());\n+        return String.format(\"%s(%s), partitionsV2=%s, partitions=%s, dependencies=%s\", getDatastreamTaskName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adecb62138b4751e0a735c8f83487729d6be346f"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "266df6749cb8df13ad455464534cd9a323aa02fe", "author": {"user": null}, "url": "https://github.com/linkedin/brooklin/commit/266df6749cb8df13ad455464534cd9a323aa02fe", "committedDate": "2020-04-06T19:13:15Z", "message": "Address Review Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTk1MTEx", "url": "https://github.com/linkedin/brooklin/pull/697#pullrequestreview-388595111", "createdAt": "2020-04-06T20:33:00Z", "commit": {"oid": "266df6749cb8df13ad455464534cd9a323aa02fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjE4MDM0", "url": "https://github.com/linkedin/brooklin/pull/697#pullrequestreview-388618034", "createdAt": "2020-04-06T21:07:45Z", "commit": {"oid": "266df6749cb8df13ad455464534cd9a323aa02fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMTowNzo0NVrOGBp8AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMTowNzo0NVrOGBp8AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM4ODg2NQ==", "bodyText": "can this check be (if (!StringUtils.isBlank(_partitionsV2)) since only v2 is being referenced within the conditional statement?", "url": "https://github.com/linkedin/brooklin/pull/697#discussion_r404388865", "createdAt": "2020-04-06T21:07:45Z", "author": {"login": "DEEPTHIKORAT"}, "path": "datastream-server/src/main/java/com/linkedin/datastream/server/DatastreamTaskImpl.java", "diffHunk": "@@ -436,8 +438,21 @@ public int hashCode() {\n   @Override\n   public String toString() {\n     // toString() is mainly for logging purpose, feel free to modify the content/format\n-    return String.format(\"%s(%s), partitionsV2=%s, partitions=%s, dependencies=%s\", getDatastreamTaskName(), _connectorType,\n-        String.join(\",\", _partitionsV2), LogUtils.logNumberArrayInRange(_partitions), _dependencies);\n+    // When DatastreamTaskImpl is created using constructor that passes _partitionsV2, _partitions is not populated.\n+    // When DatastreamTaskImpl is created using constructor that passes _partitions, _partitionsV2 is also populated.\n+    // So, if _partitions is not populated, we can assume that only _partitionsV2 is populated.\n+    String partitionsV2FormatLog = String.join(\",\", _partitionsV2);\n+    if (_partitions.size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "266df6749cb8df13ad455464534cd9a323aa02fe"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjIxNTg0", "url": "https://github.com/linkedin/brooklin/pull/697#pullrequestreview-388621584", "createdAt": "2020-04-06T21:13:37Z", "commit": {"oid": "266df6749cb8df13ad455464534cd9a323aa02fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 405, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}