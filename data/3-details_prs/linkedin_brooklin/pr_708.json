{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyMzY4MDM3", "number": 708, "title": "Retry task release in postShutdownHook in KafkaMirrorMakerConnectorTask on interrupt", "bodyText": "Releasing the lock for partition-managed BMM gets an interrupted exception if the producer flush() is interrupted. Due to this the lock is not released, and the next task is never able to get the lock and doesn't run, causing stopped partitions. Since partition-managed does its own partition assignment, if some tasks are unable to run, those partitions are never consumed from. The only way to recover from this is to restart the affected host(s) or the full cluster to clear out the ephemeral nodes.\nThis PR gracefully handles interrupt exceptions, allowing the finally block to complete without worrying about having been interrupted.", "createdAt": "2020-05-02T00:08:39Z", "url": "https://github.com/linkedin/brooklin/pull/708", "merged": true, "mergeCommit": {"oid": "daf4c2c3f46aa5b36b6899adae21ae79ac80b698"}, "closed": true, "closedAt": "2020-05-04T19:46:13Z", "author": {"login": "somandal"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdKl-egH2gAyNDEyMzY4MDM3OjMyNzFkMTdkNmM5MTI5NjlmMzJiODVkMGEwNmY0N2E1MzMyZmYxYzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceE3ArgFqTQwNTI5MjI3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3271d17d6c912969f32b85d0a06f47a5332ff1c4", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/3271d17d6c912969f32b85d0a06f47a5332ff1c4", "committedDate": "2020-05-01T23:50:25Z", "message": "Allow finally block to complete in spite of interrupt exception in AbstractKafkaBasedConnectorTask"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "268b697542fe938319da12e9a8e3d1dbe4b536c4", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/268b697542fe938319da12e9a8e3d1dbe4b536c4", "committedDate": "2020-05-01T23:53:43Z", "message": "Minor fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dde3129bc89baafcec974e50a1e5279275e6d959", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/dde3129bc89baafcec974e50a1e5279275e6d959", "committedDate": "2020-05-02T03:08:15Z", "message": "Address review comments and move interrupt handling to postShutdownHook()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2c641ad484ac60ba55c9dd812aa5c3f8bf5f35f", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/e2c641ad484ac60ba55c9dd812aa5c3f8bf5f35f", "committedDate": "2020-05-02T03:10:00Z", "message": "Minor cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NzE1MjUw", "url": "https://github.com/linkedin/brooklin/pull/708#pullrequestreview-404715250", "createdAt": "2020-05-04T05:27:25Z", "commit": {"oid": "e2c641ad484ac60ba55c9dd812aa5c3f8bf5f35f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwNToyNzoyNlrOGPzF7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwNjoyNToxMVrOGPz4Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTIxODkyNQ==", "bodyText": "nit: Please print the attempt number as well.", "url": "https://github.com/linkedin/brooklin/pull/708#discussion_r419218925", "createdAt": "2020-05-04T05:27:26Z", "author": {"login": "vmaheshw"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/mirrormaker/KafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -382,10 +383,27 @@ protected void maybeCommitOffsets(Consumer<?, ?> consumer, boolean hardCommit) {\n   @Override\n   protected void postShutdownHook() {\n     if (_enablePartitionAssignment) {\n-      // The task lock should only be released when it is absolutely safe (we can guarantee that the task cannot\n-      // consume any further). The shutdown process must complete and the consumer must be closed.\n-      LOG.info(\"Releasing the lock on datastreamTask: {}\", _datastreamTask);\n-      _datastreamTask.release();\n+      boolean isInterrupted = false;\n+      for (int numAttempts = 0; numAttempts < 3; ++numAttempts) {\n+        try {\n+          // The task lock should only be released when it is absolutely safe (we can guarantee that the task cannot\n+          // consume any further). The shutdown process must complete and the consumer must be closed.\n+          LOG.info(\"Releasing the lock on datastreamTask: {}, isInterrupted: {}\", _datastreamTask, isInterrupted);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c641ad484ac60ba55c9dd812aa5c3f8bf5f35f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTIyMTk4MA==", "bodyText": "This finally should be outside the for loop, otherwise this code will not work. The thread interrupt status will get cleared in the catch and immediately will be set again in finally.", "url": "https://github.com/linkedin/brooklin/pull/708#discussion_r419221980", "createdAt": "2020-05-04T05:44:05Z", "author": {"login": "vmaheshw"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/mirrormaker/KafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -382,10 +383,27 @@ protected void maybeCommitOffsets(Consumer<?, ?> consumer, boolean hardCommit) {\n   @Override\n   protected void postShutdownHook() {\n     if (_enablePartitionAssignment) {\n-      // The task lock should only be released when it is absolutely safe (we can guarantee that the task cannot\n-      // consume any further). The shutdown process must complete and the consumer must be closed.\n-      LOG.info(\"Releasing the lock on datastreamTask: {}\", _datastreamTask);\n-      _datastreamTask.release();\n+      boolean isInterrupted = false;\n+      for (int numAttempts = 0; numAttempts < 3; ++numAttempts) {\n+        try {\n+          // The task lock should only be released when it is absolutely safe (we can guarantee that the task cannot\n+          // consume any further). The shutdown process must complete and the consumer must be closed.\n+          LOG.info(\"Releasing the lock on datastreamTask: {}, isInterrupted: {}\", _datastreamTask, isInterrupted);\n+          _datastreamTask.release();\n+          return;\n+        } catch (ZkInterruptedException e) {\n+          LOG.warn(\"Releasing the task lock failed for datastreamTask: {}, retrying\", _datastreamTask);\n+          if (Thread.currentThread().isInterrupted()) {\n+            // The interrupted status of the current thread must be reset to allow the task lock to be released\n+            isInterrupted = Thread.interrupted();\n+          }\n+        } finally {\n+          if (isInterrupted) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c641ad484ac60ba55c9dd812aa5c3f8bf5f35f"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTIyMzIyMQ==", "bodyText": "This name is confusing since it is very similar to Thread.currentThread().isInterrupted(). May be a slightly different name with revert as prefix.", "url": "https://github.com/linkedin/brooklin/pull/708#discussion_r419223221", "createdAt": "2020-05-04T05:49:38Z", "author": {"login": "vmaheshw"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/mirrormaker/KafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -382,10 +383,27 @@ protected void maybeCommitOffsets(Consumer<?, ?> consumer, boolean hardCommit) {\n   @Override\n   protected void postShutdownHook() {\n     if (_enablePartitionAssignment) {\n-      // The task lock should only be released when it is absolutely safe (we can guarantee that the task cannot\n-      // consume any further). The shutdown process must complete and the consumer must be closed.\n-      LOG.info(\"Releasing the lock on datastreamTask: {}\", _datastreamTask);\n-      _datastreamTask.release();\n+      boolean isInterrupted = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c641ad484ac60ba55c9dd812aa5c3f8bf5f35f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTIzMTc5MQ==", "bodyText": "This test will not cover the interrupted exception piece. Can you check if there is a way to add that in the test as well?", "url": "https://github.com/linkedin/brooklin/pull/708#discussion_r419231791", "createdAt": "2020-05-04T06:25:11Z", "author": {"login": "vmaheshw"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -325,6 +333,72 @@ public void testPartitionManagedLockReleaseOnConsumerCloseException() throws Exc\n     Assert.assertTrue(releaseCall.await(10, TimeUnit.SECONDS), \"DatastreamTask never released\");\n   }\n \n+  static class KafkaMirrorMakerConnectorTaskTest extends KafkaMirrorMakerConnectorTask {\n+    boolean postShutdownHookExceptionCaught;\n+\n+    /**\n+     * Constructor for TestInterruptKafkaMirrorMakerConnectorTask\n+     * @param config Task configuration properties\n+     * @param task Datastream task\n+     * @param connectorName Connector name\n+     * @param isFlushlessModeEnabled true if {@value KafkaMirrorMakerConnector#IS_FLUSHLESS_MODE_ENABLED}\n+     *                               is set to true for the connector identified with {@code connectorName}\n+     * @param groupIdConstructor Kafka consumer group ID constructor\n+     */\n+    public KafkaMirrorMakerConnectorTaskTest(KafkaBasedConnectorConfig config, DatastreamTask task,\n+        String connectorName, boolean isFlushlessModeEnabled, GroupIdConstructor groupIdConstructor) {\n+      super(config, task, connectorName, isFlushlessModeEnabled, groupIdConstructor);\n+    }\n+\n+    @Override\n+    protected void postShutdownHook() {\n+      try {\n+        super.postShutdownHook();\n+      } catch (Exception e) {\n+        postShutdownHookExceptionCaught = true;\n+      }\n+    }\n+\n+    boolean isPostShutdownHookExceptionCaught() {\n+      return postShutdownHookExceptionCaught;\n+    }\n+  }\n+\n+  @Test\n+  public void testPartitionManagedLockReleaseOnInterruptException() throws InterruptedException {\n+    Datastream datastream = KafkaMirrorMakerConnectorTestUtils.createDatastream(\"pizzaStream\", _broker, \"\\\\w+Pizza\");\n+    DatastreamTaskImpl task = new DatastreamTaskImpl(Collections.singletonList(datastream));\n+    DatastreamEventProducer mockDatastreamEventProducer = mock(DatastreamEventProducer.class);\n+    doThrow(InterruptException.class).when(mockDatastreamEventProducer).flush();\n+    doNothing().when(mockDatastreamEventProducer).send(any(DatastreamProducerRecord.class), any(SendCallback.class));\n+    task.setEventProducer(mockDatastreamEventProducer);\n+\n+    KafkaBasedConnectorConfig connectorConfig = new KafkaBasedConnectorConfigBuilder()\n+        .setConsumerFactory(new LiKafkaConsumerFactory())\n+        .setCommitIntervalMillis(10000)\n+        .setEnablePartitionManaged(true)\n+        .build();\n+\n+    ZkAdapter zkAdatper = new ZkAdapter(_kafkaCluster.getZkConnection(), \"testCluster\", null,\n+        ZkClient.DEFAULT_SESSION_TIMEOUT, ZkClient.DEFAULT_CONNECTION_TIMEOUT, null);\n+    task.setZkAdapter(zkAdatper);\n+    zkAdatper.connect();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c641ad484ac60ba55c9dd812aa5c3f8bf5f35f"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e80bf2671e9b03f6305dc5085a533117a663e86", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/9e80bf2671e9b03f6305dc5085a533117a663e86", "committedDate": "2020-05-04T18:00:31Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjM0NDc2", "url": "https://github.com/linkedin/brooklin/pull/708#pullrequestreview-405234476", "createdAt": "2020-05-04T18:21:41Z", "commit": {"oid": "9e80bf2671e9b03f6305dc5085a533117a663e86"}, "state": "DISMISSED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODoyMTo0MVrOGQMgig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODozMzoyMVrOGQM8Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzNTMzOA==", "bodyText": "Just a suggestion, please feel free to ignore if you don't like it: would it be nicer if wrote this as:\nboolean resetInterrupted = false;\n\ntry {\n    for (int numAttempts = 1; numAttempts <= 3; ++numAttempts) {\n        try {\n            ...\n            _datastreamTask.release();\n            break;\n        } catch (ZkInterruptedException e) {\n            ...\n        }\n    }\n} finally {\n    if (resetInterrupted) {\n        // Setting the status of the thread back to interrupted\n        Thread.currentThread().interrupt();\n    }\n}\nSimply put: an outer try/finally for resetting interruption status and an inner try/catch for retrying lock release. Writing it this way spares you having to add a second catch clause with a break statement or an explicit throw.", "url": "https://github.com/linkedin/brooklin/pull/708#discussion_r419635338", "createdAt": "2020-05-04T18:21:41Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/main/java/com/linkedin/datastream/connectors/kafka/mirrormaker/KafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -382,10 +383,36 @@ protected void maybeCommitOffsets(Consumer<?, ?> consumer, boolean hardCommit) {\n   @Override\n   protected void postShutdownHook() {\n     if (_enablePartitionAssignment) {\n-      // The task lock should only be released when it is absolutely safe (we can guarantee that the task cannot\n-      // consume any further). The shutdown process must complete and the consumer must be closed.\n-      LOG.info(\"Releasing the lock on datastreamTask: {}\", _datastreamTask);\n-      _datastreamTask.release();\n+      DatastreamRuntimeException exception = null;\n+      boolean resetInterrupted = false;\n+      for (int numAttempts = 1; numAttempts <= 3; ++numAttempts) {\n+        try {\n+          // The task lock should only be released when it is absolutely safe (we can guarantee that the task cannot\n+          // consume any further). The shutdown process must complete and the consumer must be closed.\n+          LOG.info(\"Releasing the lock on datastreamTask: {}, was thread interrupted: {}, attempt: {}\", _datastreamTask,\n+              resetInterrupted, numAttempts);\n+          _datastreamTask.release();\n+          break;\n+        } catch (ZkInterruptedException e) {\n+          LOG.warn(\"Releasing the task lock failed for datastreamTask: {}, retrying\", _datastreamTask);\n+          if (Thread.currentThread().isInterrupted()) {\n+            // The interrupted status of the current thread must be reset to allow the task lock to be released\n+            resetInterrupted = Thread.interrupted();\n+          }\n+        } catch (Exception e) {\n+          exception = new DatastreamRuntimeException(\"Failed to perform post shutdown actions\", e);\n+          break;\n+        }\n+      }\n+\n+      if (resetInterrupted) {\n+        // Setting the status of the thread back to interrupted\n+        Thread.currentThread().interrupt();\n+      }\n+\n+      if (exception != null) {\n+        throw exception;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e80bf2671e9b03f6305dc5085a533117a663e86"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzNjkzMQ==", "bodyText": "private", "url": "https://github.com/linkedin/brooklin/pull/708#discussion_r419636931", "createdAt": "2020-05-04T18:24:25Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -325,6 +333,109 @@ public void testPartitionManagedLockReleaseOnConsumerCloseException() throws Exc\n     Assert.assertTrue(releaseCall.await(10, TimeUnit.SECONDS), \"DatastreamTask never released\");\n   }\n \n+  static class KafkaMirrorMakerConnectorTaskTest extends KafkaMirrorMakerConnectorTask {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e80bf2671e9b03f6305dc5085a533117a663e86"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzNzE2Mg==", "bodyText": "Remove the javadocs?", "url": "https://github.com/linkedin/brooklin/pull/708#discussion_r419637162", "createdAt": "2020-05-04T18:24:45Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -325,6 +333,109 @@ public void testPartitionManagedLockReleaseOnConsumerCloseException() throws Exc\n     Assert.assertTrue(releaseCall.await(10, TimeUnit.SECONDS), \"DatastreamTask never released\");\n   }\n \n+  static class KafkaMirrorMakerConnectorTaskTest extends KafkaMirrorMakerConnectorTask {\n+    boolean postShutdownHookExceptionCaught;\n+\n+    /**\n+     * Constructor for TestInterruptKafkaMirrorMakerConnectorTask\n+     * @param config Task configuration properties\n+     * @param task Datastream task\n+     * @param connectorName Connector name\n+     * @param isFlushlessModeEnabled true if {@value KafkaMirrorMakerConnector#IS_FLUSHLESS_MODE_ENABLED}\n+     *                               is set to true for the connector identified with {@code connectorName}\n+     * @param groupIdConstructor Kafka consumer group ID constructor\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e80bf2671e9b03f6305dc5085a533117a663e86"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzNzQ1NQ==", "bodyText": "private", "url": "https://github.com/linkedin/brooklin/pull/708#discussion_r419637455", "createdAt": "2020-05-04T18:25:13Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -325,6 +333,109 @@ public void testPartitionManagedLockReleaseOnConsumerCloseException() throws Exc\n     Assert.assertTrue(releaseCall.await(10, TimeUnit.SECONDS), \"DatastreamTask never released\");\n   }\n \n+  static class KafkaMirrorMakerConnectorTaskTest extends KafkaMirrorMakerConnectorTask {\n+    boolean postShutdownHookExceptionCaught;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e80bf2671e9b03f6305dc5085a533117a663e86"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzODUzNg==", "bodyText": "Did you need this line? I think doing nothing is Mockito's default behavior (unless otherwise instructed)", "url": "https://github.com/linkedin/brooklin/pull/708#discussion_r419638536", "createdAt": "2020-05-04T18:26:58Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -325,6 +333,109 @@ public void testPartitionManagedLockReleaseOnConsumerCloseException() throws Exc\n     Assert.assertTrue(releaseCall.await(10, TimeUnit.SECONDS), \"DatastreamTask never released\");\n   }\n \n+  static class KafkaMirrorMakerConnectorTaskTest extends KafkaMirrorMakerConnectorTask {\n+    boolean postShutdownHookExceptionCaught;\n+\n+    /**\n+     * Constructor for TestInterruptKafkaMirrorMakerConnectorTask\n+     * @param config Task configuration properties\n+     * @param task Datastream task\n+     * @param connectorName Connector name\n+     * @param isFlushlessModeEnabled true if {@value KafkaMirrorMakerConnector#IS_FLUSHLESS_MODE_ENABLED}\n+     *                               is set to true for the connector identified with {@code connectorName}\n+     * @param groupIdConstructor Kafka consumer group ID constructor\n+     */\n+    public KafkaMirrorMakerConnectorTaskTest(KafkaBasedConnectorConfig config, DatastreamTask task,\n+        String connectorName, boolean isFlushlessModeEnabled, GroupIdConstructor groupIdConstructor) {\n+      super(config, task, connectorName, isFlushlessModeEnabled, groupIdConstructor);\n+    }\n+\n+    @Override\n+    protected void postShutdownHook() {\n+      try {\n+        super.postShutdownHook();\n+      } catch (Exception e) {\n+        postShutdownHookExceptionCaught = true;\n+      }\n+    }\n+\n+    boolean isPostShutdownHookExceptionCaught() {\n+      return postShutdownHookExceptionCaught;\n+    }\n+  }\n+\n+  @Test\n+  public void testPartitionManagedLockReleaseOnInterruptException() throws InterruptedException {\n+    Datastream datastream = KafkaMirrorMakerConnectorTestUtils.createDatastream(\"pizzaStream\", _broker, \"\\\\w+Pizza\");\n+    DatastreamTaskImpl task = new DatastreamTaskImpl(Collections.singletonList(datastream));\n+    DatastreamEventProducer mockDatastreamEventProducer = mock(DatastreamEventProducer.class);\n+    doThrow(InterruptException.class).when(mockDatastreamEventProducer).flush();\n+    doNothing().when(mockDatastreamEventProducer).send(any(DatastreamProducerRecord.class), any(SendCallback.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e80bf2671e9b03f6305dc5085a533117a663e86"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY0MjQzMA==", "bodyText": "Would it better if we replaced this bit with\nThread connectorThread = KafkaMirrorMakerConnectorTestUtils.runKafkaMirrorMakerConnectorTask(connectorTask);\nAfter changing that method to have it return the thread it creates?", "url": "https://github.com/linkedin/brooklin/pull/708#discussion_r419642430", "createdAt": "2020-05-04T18:33:21Z", "author": {"login": "ahmedahamid"}, "path": "datastream-kafka-connector/src/test/java/com/linkedin/datastream/connectors/kafka/mirrormaker/TestKafkaMirrorMakerConnectorTask.java", "diffHunk": "@@ -325,6 +333,109 @@ public void testPartitionManagedLockReleaseOnConsumerCloseException() throws Exc\n     Assert.assertTrue(releaseCall.await(10, TimeUnit.SECONDS), \"DatastreamTask never released\");\n   }\n \n+  static class KafkaMirrorMakerConnectorTaskTest extends KafkaMirrorMakerConnectorTask {\n+    boolean postShutdownHookExceptionCaught;\n+\n+    /**\n+     * Constructor for TestInterruptKafkaMirrorMakerConnectorTask\n+     * @param config Task configuration properties\n+     * @param task Datastream task\n+     * @param connectorName Connector name\n+     * @param isFlushlessModeEnabled true if {@value KafkaMirrorMakerConnector#IS_FLUSHLESS_MODE_ENABLED}\n+     *                               is set to true for the connector identified with {@code connectorName}\n+     * @param groupIdConstructor Kafka consumer group ID constructor\n+     */\n+    public KafkaMirrorMakerConnectorTaskTest(KafkaBasedConnectorConfig config, DatastreamTask task,\n+        String connectorName, boolean isFlushlessModeEnabled, GroupIdConstructor groupIdConstructor) {\n+      super(config, task, connectorName, isFlushlessModeEnabled, groupIdConstructor);\n+    }\n+\n+    @Override\n+    protected void postShutdownHook() {\n+      try {\n+        super.postShutdownHook();\n+      } catch (Exception e) {\n+        postShutdownHookExceptionCaught = true;\n+      }\n+    }\n+\n+    boolean isPostShutdownHookExceptionCaught() {\n+      return postShutdownHookExceptionCaught;\n+    }\n+  }\n+\n+  @Test\n+  public void testPartitionManagedLockReleaseOnInterruptException() throws InterruptedException {\n+    Datastream datastream = KafkaMirrorMakerConnectorTestUtils.createDatastream(\"pizzaStream\", _broker, \"\\\\w+Pizza\");\n+    DatastreamTaskImpl task = new DatastreamTaskImpl(Collections.singletonList(datastream));\n+    DatastreamEventProducer mockDatastreamEventProducer = mock(DatastreamEventProducer.class);\n+    doThrow(InterruptException.class).when(mockDatastreamEventProducer).flush();\n+    doNothing().when(mockDatastreamEventProducer).send(any(DatastreamProducerRecord.class), any(SendCallback.class));\n+    task.setEventProducer(mockDatastreamEventProducer);\n+\n+    KafkaBasedConnectorConfig connectorConfig = new KafkaBasedConnectorConfigBuilder()\n+        .setConsumerFactory(new LiKafkaConsumerFactory())\n+        .setCommitIntervalMillis(10000)\n+        .setEnablePartitionManaged(true)\n+        .build();\n+\n+    ZkAdapter zkAdatper = new ZkAdapter(_kafkaCluster.getZkConnection(), \"testCluster\", null,\n+        ZkClient.DEFAULT_SESSION_TIMEOUT, ZkClient.DEFAULT_CONNECTION_TIMEOUT, null);\n+    task.setZkAdapter(zkAdatper);\n+    zkAdatper.connect();\n+\n+    KafkaMirrorMakerConnectorTaskTest connectorTask = new KafkaMirrorMakerConnectorTaskTest(connectorConfig, task, \"\",\n+        false, new KafkaMirrorMakerGroupIdConstructor(false, \"testCluster\"));\n+    Thread connectorThread = new Thread(connectorTask, \"connector thread\");\n+    connectorThread.setDaemon(true);\n+    AtomicReference<Throwable> uncaughtException = new AtomicReference<>();\n+    connectorThread.setUncaughtExceptionHandler((t, e) -> uncaughtException.set(e));\n+    connectorThread.start();\n+    if (!connectorTask.awaitStart(60, TimeUnit.SECONDS)) {\n+      Assert.fail(\"connector did not start within timeout\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e80bf2671e9b03f6305dc5085a533117a663e86"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bd6795be1e93f6f44518a96fbfcb2af9b2f779f", "author": {"user": {"login": "somandal", "name": "Sonam Mandal"}}, "url": "https://github.com/linkedin/brooklin/commit/4bd6795be1e93f6f44518a96fbfcb2af9b2f779f", "committedDate": "2020-05-04T18:57:10Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjY5OTY4", "url": "https://github.com/linkedin/brooklin/pull/708#pullrequestreview-405269968", "createdAt": "2020-05-04T19:10:46Z", "commit": {"oid": "4bd6795be1e93f6f44518a96fbfcb2af9b2f779f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjkyMjc0", "url": "https://github.com/linkedin/brooklin/pull/708#pullrequestreview-405292274", "createdAt": "2020-05-04T19:43:31Z", "commit": {"oid": "4bd6795be1e93f6f44518a96fbfcb2af9b2f779f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 855, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}