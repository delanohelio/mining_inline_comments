{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MjQzNjQ2", "number": 186, "title": "Ut fix", "bodyText": "Description of changes:\n\nAdding readAndUpdateMutesRcasDuringStart() invoked during the controller start(). This method is invoked after graph initialization and before the RCASchedulerTask is initialized. This allows for a clean way to update the mutedRCA list within the Analysis graph.\nFixing the readAndUpdateMutedRcas() UT.\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-05-06T17:52:09Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186", "merged": true, "mergeCommit": {"oid": "549b71911700331d63bae94be4942905a87ca304"}, "closed": true, "closedAt": "2020-05-14T17:56:10Z", "author": {"login": "khushbr"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcejCkzAH2gAyNDE0MjQzNjQ2Ojg4YzM3NDhiYzgzODdiYThiYzZlMDcyYTgzY2I1MGY3YzlkM2EwN2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchRTnuAFqTQxMjA1MjE3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "88c3748bc8387ba8bc6e072a83cb50f7c9d3a07e", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/88c3748bc8387ba8bc6e072a83cb50f7c9d3a07e", "committedDate": "2020-05-06T06:53:18Z", "message": "Adding Fix for flaky behavior of readAndUpdateMutedRcas() UT and handling a race condition in scheduler and mutedRCA"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aee2c29be66808e6afc68eaac4ae3f9b7323179a", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/aee2c29be66808e6afc68eaac4ae3f9b7323179a", "committedDate": "2020-05-06T17:48:42Z", "message": "Adding WaitFor to accomodate for any delays in test running"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODY5MDY0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#pullrequestreview-406869064", "createdAt": "2020-05-06T18:15:29Z", "commit": {"oid": "aee2c29be66808e6afc68eaac4ae3f9b7323179a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODoxNToyOVrOGRfgcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODoxNToyOVrOGRfgcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NTE4Ng==", "bodyText": "I don't see that we are validating that there are Java classes with these names ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r420995186", "createdAt": "2020-05-06T18:15:29Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -275,6 +275,17 @@ private void readRcaEnabledFromConf() {\n         });\n   }\n \n+  private void readAndUpdateMutesRcasDuringStart() {\n+    try {\n+      Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+      rcasForMute.forEach(mutedRca -> Stats.getInstance().addToMutedGraphNodes(mutedRca));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2c29be66808e6afc68eaac4ae3f9b7323179a"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTAxNjg4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#pullrequestreview-406901688", "createdAt": "2020-05-06T18:59:35Z", "commit": {"oid": "aee2c29be66808e6afc68eaac4ae3f9b7323179a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODo1OTozNVrOGRhI_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODo1OTozNVrOGRhI_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyMTk1MA==", "bodyText": "There is an edge case where both readAndUpdateMutesRcas and readAndUpdateMutesRcasDuringStart can try to update the muted Rca list back to back. So we would try to read in rca.conf twice.\nThis will happen when rca was turned on and then off. Then between the two muted rcas update checks interval, some does both the things - adds a new muted rca and then turns on the rca.\nreadAndUpdateMutesRcasDuringStart should ever be read at the start of the process itself. That's the time when RCA graph is not constructed and we cannot validate the new new muted RCAs. For any other updated to the muted list, the periodic rca.conf update checker will take care of it.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r421021950", "createdAt": "2020-05-06T18:59:35Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -150,7 +150,7 @@ private void start() {\n       List<ConnectedComponent> connectedComponents = RcaUtil.getAnalysisGraphComponents(rcaConf);\n \n       // Mute the rca nodes after the graph creation and before the scheduler start\n-      readAndUpdateMutesRcas();\n+      readAndUpdateMutesRcasDuringStart();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2c29be66808e6afc68eaac4ae3f9b7323179a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b47ff6bb94963f04a035e9d25fb5b2737fc5c37", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9b47ff6bb94963f04a035e9d25fb5b2737fc5c37", "committedDate": "2020-05-09T02:30:28Z", "message": "Adding Validation check within readAndUpdateMutesRcasDuringStart()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da1635b1a077528c885d9f063e355bb09ffebf30", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/da1635b1a077528c885d9f063e355bb09ffebf30", "committedDate": "2020-05-11T21:56:34Z", "message": "Removing the Validation check within readAndUpdateMutesRcasDuringStart(), falling back on checks within readAndUpdateMutesRcas() to handle the start-up incorrect rca name scenario"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NjA0MzAz", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#pullrequestreview-409604303", "createdAt": "2020-05-11T23:41:59Z", "commit": {"oid": "da1635b1a077528c885d9f063e355bb09ffebf30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMzo0MTo1OVrOGTxHNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMzo0MTo1OVrOGTxHNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MDc4OA==", "bodyText": "Will it make sense to rewrite updateMutedGraphNodes as do two things:\n\nclear()\naddAll(nodeNames)\n\nAnd just call that here instead of iterating through rcasForMute ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r423380788", "createdAt": "2020-05-11T23:41:59Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -268,13 +268,35 @@ private void readRcaEnabledFromConf() {\n             String nextLine = sc.nextLine();\n             rcaEnabled = Boolean.parseBoolean(nextLine);\n           } catch (IOException e) {\n-            LOG.error(\"Error reading file '{}': {}\", filePath.toString(), e.getMessage());\n+            LOG.error(\"Error reading file '{}': {}\", filePath.toString(), e);\n             e.printStackTrace();\n             rcaEnabled = rcaEnabledDefaultValue;\n           }\n         });\n   }\n \n+  private void readAndUpdateMutesRcasDuringStart() {\n+    try {\n+      /* We have an edge case where both `readAndUpdateMutesRcas()` and `readAndUpdateMutesRcasDuringStart()`\n+       * can try to update the muted Rca list back to back, reading rca.conf twice. This will happen when rca\n+       * was turned off and then on.\n+       *\n+       * <p> `readAndUpdateMutesRcasDuringStart()` should only be read at the start of the process, when\n+       * RCA graph is not constructed and we cannot validate the new new muted RCAs. For any other update\n+       * to the muted list, the periodic rca.conf update checker will take care of it.\n+       *\n+       */\n+      if (lastModifiedTimeInMillisInMemory == 0) {\n+        Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+        rcasForMute.forEach(mutedRca -> Stats.getInstance().addToMutedGraphNodes(mutedRca));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da1635b1a077528c885d9f063e355bb09ffebf30"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "879fabd66b2705d78ee95d3ee86796ade59ef4f0", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/879fabd66b2705d78ee95d3ee86796ade59ef4f0", "committedDate": "2020-05-12T00:04:01Z", "message": "Replacing updateMutedGraphNodes() with addToMutedGraphNodes() inside readAndUpdateMutesRcasDuringStart()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTAzNDUz", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#pullrequestreview-410503453", "createdAt": "2020-05-13T00:04:12Z", "commit": {"oid": "879fabd66b2705d78ee95d3ee86796ade59ef4f0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMDowNDoxM1rOGUdFJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMDowNDoxM1rOGUdFJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMTE1OQ==", "bodyText": "updateMutedGraphNodes retains the intersection of the elements in the original and what's provided if provided element is nonEmpty or else it adds them all.\nBecause the muted rcas in the rca.conf is the final list, we should just clear the old elements and the new ones right ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r424101159", "createdAt": "2020-05-13T00:04:13Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -288,7 +288,7 @@ private void readAndUpdateMutesRcasDuringStart() {\n        */\n       if (lastModifiedTimeInMillisInMemory == 0) {\n         Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n-        rcasForMute.forEach(mutedRca -> Stats.getInstance().addToMutedGraphNodes(mutedRca));\n+        Stats.getInstance().updateMutedGraphNodes(rcasForMute);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "879fabd66b2705d78ee95d3ee86796ade59ef4f0"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afed113f18822fbe55256ee399b7d98e2bdca7bd", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/afed113f18822fbe55256ee399b7d98e2bdca7bd", "committedDate": "2020-05-13T23:56:06Z", "message": "Adding UT and updating readAndUpdateMutesRcasDuringStart()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDMzNjcx", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#pullrequestreview-411433671", "createdAt": "2020-05-14T03:03:05Z", "commit": {"oid": "afed113f18822fbe55256ee399b7d98e2bdca7bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDM2Mzcx", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#pullrequestreview-412036371", "createdAt": "2020-05-14T17:34:55Z", "commit": {"oid": "afed113f18822fbe55256ee399b7d98e2bdca7bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzozNDo1NVrOGVnG-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzozNDo1NVrOGVnG-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMxNDA0Mw==", "bodyText": "Why do we need to handle exception here ? This make it quite confusing as we are not throwing any exceptions in between I assume ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r425314043", "createdAt": "2020-05-14T17:34:55Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -268,13 +268,35 @@ private void readRcaEnabledFromConf() {\n             String nextLine = sc.nextLine();\n             rcaEnabled = Boolean.parseBoolean(nextLine);\n           } catch (IOException e) {\n-            LOG.error(\"Error reading file '{}': {}\", filePath.toString(), e.getMessage());\n+            LOG.error(\"Error reading file '{}': {}\", filePath.toString(), e);\n             e.printStackTrace();\n             rcaEnabled = rcaEnabledDefaultValue;\n           }\n         });\n   }\n \n+  private void readAndUpdateMutesRcasDuringStart() {\n+    try {\n+      /* We have an edge case where both `readAndUpdateMutesRcas()` and `readAndUpdateMutesRcasDuringStart()`\n+       * can try to update the muted Rca list back to back, reading rca.conf twice. This will happen when rca\n+       * was turned off and then on.\n+       *\n+       * <p> `readAndUpdateMutesRcasDuringStart()` should only be read at the start of the process, when\n+       * RCA graph is not constructed and we cannot validate the new new muted RCAs. For any other update\n+       * to the muted list, the periodic rca.conf update checker will take care of it.\n+       *\n+       */\n+      if (lastModifiedTimeInMillisInMemory == 0) {\n+        Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+        Stats.getInstance().updateMutedGraphNodes(rcasForMute);\n+        LOG.info(\"Updated the muted RCA Graph to : {}\", rcaConf.getMutedRcaList());\n+      }\n+    } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afed113f18822fbe55256ee399b7d98e2bdca7bd"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDUyMTc3", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#pullrequestreview-412052177", "createdAt": "2020-05-14T17:55:24Z", "commit": {"oid": "afed113f18822fbe55256ee399b7d98e2bdca7bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 995, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}