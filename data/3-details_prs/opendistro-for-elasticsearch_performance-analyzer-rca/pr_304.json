{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NTIxNjYx", "number": 304, "title": "[bugfix] update the ClusterDetailsEventProcessor only when it is valid.", "bodyText": "There was a bug where we were updating the ClusterDetailsEventProcessor before it was filled with data. This fixes it and some other cases where we can run into NPE.\nIssue #: #305\nDescription of changes: ReaderMetricsProcessor skips updating the ClusterDetails every other time this is when the AppContext will be set with a cluster details that says the current node role is unknown. This would be the reason the RCA rest API would complain about the current node not being the elected master.\nThe change in the node role can also cause the RcaScheduler to not start up.\nTests: Tested it on docker where the error was reported.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-07-24T22:54:36Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304", "merged": true, "mergeCommit": {"oid": "4647e2a5f47ef1157fdd454c882268513462a8a7"}, "closed": true, "closedAt": "2020-07-24T23:53:55Z", "author": {"login": "yojs"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4MQ2_gFqTQ1NTIyNjMyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4M7kZAFqTQ1NTIzNjg5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjI2MzI1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#pullrequestreview-455226325", "createdAt": "2020-07-24T23:03:06Z", "commit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzowMzowNlrOG2_5Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzowMzowNlrOG2_5Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMyMzExNQ==", "bodyText": "This is generally an anti pattern. Is there a reason you're throwing away the stacktrace?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#discussion_r460323115", "createdAt": "2020-07-24T23:03:06Z", "author": {"login": "sidheart"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -362,7 +362,7 @@ private JsonElement readTemperatureProfileRca(String rca) {\n         response.addNestedSummaryList(nodeLevelDimSummary);\n       }\n     } catch (DataAccessException dex) {\n-      LOG.error(\"Failed to read temperature profile RCA for {}\", rca, dex);\n+      LOG.warn(\"Failed to read temperature profile RCA for {}. Msg: {}\", rca, dex.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjI3MzYz", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#pullrequestreview-455227363", "createdAt": "2020-07-24T23:06:55Z", "commit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzowNjo1NVrOG2_8uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzowNjo1NVrOG2_8uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMyNDAyNw==", "bodyText": "should we also call the default constructor this() here in case something else needs to be initialized in AppContext ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#discussion_r460324027", "createdAt": "2020-07-24T23:06:55Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/AppContext.java", "diffHunk": "@@ -38,6 +38,10 @@ public AppContext() {\n     this.clusterDetailsEventProcessor = null;\n   }\n \n+  public AppContext(AppContext other) {\n+    this.clusterDetailsEventProcessor = new ClusterDetailsEventProcessor(other.clusterDetailsEventProcessor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjI3NTQ3", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#pullrequestreview-455227547", "createdAt": "2020-07-24T23:07:46Z", "commit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzowNzo0NlrOG2_9XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzowNzo0NlrOG2_9XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMyNDE4OA==", "bodyText": "same as above", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#discussion_r460324188", "createdAt": "2020-07-24T23:07:46Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ClusterDetailsEventProcessor.java", "diffHunk": "@@ -40,6 +40,19 @@\n    */\n   private volatile ImmutableList<NodeDetails> nodesDetails = null;\n \n+  public ClusterDetailsEventProcessor() {}\n+\n+  public ClusterDetailsEventProcessor(final ClusterDetailsEventProcessor other) {\n+    if (other.nodesDetails != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e42a12f4e85d8db057fd8a34e177c9eea0ebddf2", "author": {"user": {"login": "yojs", "name": "Joydeep Sinha"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e42a12f4e85d8db057fd8a34e177c9eea0ebddf2", "committedDate": "2020-07-24T23:09:21Z", "message": "[bugfix] update the ClusterDetailsEventProcessor only when it is valid.\n\nThere was a bug where we were updating the ClusterDetailsEventProcessor before it was filled with data. This fixes it and some other cases where we can run into NPE."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c741d9c059ba674da29d9216b2ef2fbd730977e6", "author": {"user": {"login": "yojs", "name": "Joydeep Sinha"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/c741d9c059ba674da29d9216b2ef2fbd730977e6", "committedDate": "2020-07-24T23:09:21Z", "message": "Making the argument final"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjI4MjQ1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#pullrequestreview-455228245", "createdAt": "2020-07-24T23:10:01Z", "commit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzoxMDowMVrOG2__wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzoxMDowMVrOG2__wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMyNDgwMQ==", "bodyText": "should we add a few comments here to explain why we want to do this check ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#discussion_r460324801", "createdAt": "2020-07-24T23:10:01Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -466,6 +463,10 @@ is ready so it starts to read that file (go back two windows and\n \n     emitMetrics(currWindowStartTime);\n \n+    if (appContext != null && !clusterDetailsEventsProcessor.getNodesDetails().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjI4NDMw", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#pullrequestreview-455228430", "createdAt": "2020-07-24T23:10:44Z", "commit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzoxMDo0NFrOG3AAag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzoxMDo0NFrOG3AAag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMyNDk3MA==", "bodyText": "Nit: use a builder for this instead of an alloc + copy\nImmutableList.Builder builder = new ImmutableList.Builder<NodeDetails>();\nfor (final NodeDetails oldDetails : other.nodesDetails) {\n        builder.add(new NodeDetails(oldDetails));\n}\nthis.nodesDetails = builder.build();", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#discussion_r460324970", "createdAt": "2020-07-24T23:10:44Z", "author": {"login": "sidheart"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ClusterDetailsEventProcessor.java", "diffHunk": "@@ -40,6 +40,19 @@\n    */\n   private volatile ImmutableList<NodeDetails> nodesDetails = null;\n \n+  public ClusterDetailsEventProcessor() {}\n+\n+  public ClusterDetailsEventProcessor(final ClusterDetailsEventProcessor other) {\n+    if (other.nodesDetails != null) {\n+      List<NodeDetails> nodeDetails = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjI4NzI1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#pullrequestreview-455228725", "createdAt": "2020-07-24T23:11:57Z", "commit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzoxMTo1OFrOG3ABiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMzoxMTo1OFrOG3ABiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMyNTI1Ng==", "bodyText": "Nit: Annotate with @nonnull or add null check", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#discussion_r460325256", "createdAt": "2020-07-24T23:11:58Z", "author": {"login": "sidheart"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ClusterDetailsEventProcessor.java", "diffHunk": "@@ -148,6 +161,13 @@ public NodeDetails(AllMetrics.NodeRole role, String id, String hostAddress, bool\n       this.role = role.toString();\n     }\n \n+    public NodeDetails(NodeDetails other) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c4d2a9057c155c6ceb2b5d095b3dbba819d6a67"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a44c832a46779e502221bba12fb4c4ece664b5f", "author": {"user": {"login": "yojs", "name": "Joydeep Sinha"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1a44c832a46779e502221bba12fb4c4ece664b5f", "committedDate": "2020-07-24T23:41:31Z", "message": "Addressing PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0bd836de33e43f425623b527f479c929949e197e", "author": {"user": {"login": "yojs", "name": "Joydeep Sinha"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0bd836de33e43f425623b527f479c929949e197e", "committedDate": "2020-07-24T23:05:05Z", "message": "Making the argument final"}, "afterCommit": {"oid": "1a44c832a46779e502221bba12fb4c4ece664b5f", "author": {"user": {"login": "yojs", "name": "Joydeep Sinha"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1a44c832a46779e502221bba12fb4c4ece664b5f", "committedDate": "2020-07-24T23:41:31Z", "message": "Addressing PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjM2MTU0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#pullrequestreview-455236154", "createdAt": "2020-07-24T23:46:07Z", "commit": {"oid": "1a44c832a46779e502221bba12fb4c4ece664b5f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjM2ODk0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/304#pullrequestreview-455236894", "createdAt": "2020-07-24T23:49:46Z", "commit": {"oid": "1a44c832a46779e502221bba12fb4c4ece664b5f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1113, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}