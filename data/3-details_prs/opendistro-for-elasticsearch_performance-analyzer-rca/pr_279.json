{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMzkzMTI4", "number": 279, "title": "Rest mutual auth fix", "bodyText": "Issue #, if available: #278\nDescription of changes: Adds configurable auth to REST endpoints\nTests: TestNetServer\nCode coverage percentage for this patch: See CodeCov report\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-07-16T18:04:33Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/279", "merged": true, "mergeCommit": {"oid": "9152a23af091670ddf35e767fbbd3d53b1dab9c7"}, "closed": true, "closedAt": "2020-07-27T17:37:18Z", "author": {"login": "sidheart"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc13odDABqjM1NTkyMzQ0NzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5FB1vAFqTQ1NTk3NjUxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8865b572dbbe034d9337dd6849aa14377641d86", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a8865b572dbbe034d9337dd6849aa14377641d86", "committedDate": "2020-07-16T17:58:40Z", "message": "Fix merge issue with WireHopperTest"}, "afterCommit": {"oid": "b881fc828476c7deb8ed81768db75a790821fe2e", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b881fc828476c7deb8ed81768db75a790821fe2e", "committedDate": "2020-07-17T17:52:23Z", "message": "Fix merge issue with WireHopperTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af001b6099a392b4af7daf1c44fd85b927d26fec", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/af001b6099a392b4af7daf1c44fd85b927d26fec", "committedDate": "2020-07-21T18:12:04Z", "message": "Add required mutual auth to gRPC Server/Client\n\nPreviously we had 1 sided TLS on the server side. Data between the\nclient and server was send over an encrypted channel, but any client\ncould make requests to the server.\n\nThis commit changes the behavior so that only clients with the matching\ncertificates can make requests to the server when TLS is enabled. This\ncommit does NOT add support for installing a trust manager. That must be\nadded in the future."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0b6804081c6bc40602f86400e8a0ab9edce6537", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d0b6804081c6bc40602f86400e8a0ab9edce6537", "committedDate": "2020-07-21T18:12:04Z", "message": "Add full mutual auth to gRPC client/server and augment tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f545e2cc13526a22524cdc95293fb87ca38d9ed2", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f545e2cc13526a22524cdc95293fb87ca38d9ed2", "committedDate": "2020-07-21T18:19:16Z", "message": "Implement mutual auth for the REST endpoints\n\nThis commit makes the PerformanceAnalyzerWebServer authenticate clients\nif the user specifies a certificate authority. It also properly sets up\nthe server's identity, so that any clients can authenticate the server."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de2cb4db6329563d33ac2beff2708e4e59304dfc", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/de2cb4db6329563d33ac2beff2708e4e59304dfc", "committedDate": "2020-07-21T18:19:21Z", "message": "Fix merge issue with WireHopperTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28033f241ced960acb4a06af77f2c87335388ea6", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/28033f241ced960acb4a06af77f2c87335388ea6", "committedDate": "2020-07-21T18:19:21Z", "message": "Fixing up PerformanceAnalyzerWebServerTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8894129c2a17e1fa2cc1c6acdf395f82c1aebf21", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/8894129c2a17e1fa2cc1c6acdf395f82c1aebf21", "committedDate": "2020-07-21T18:19:21Z", "message": "Modify gradle.yml for testing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67d53d591292cb71ea0d526851e12763e7c9af30", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/67d53d591292cb71ea0d526851e12763e7c9af30", "committedDate": "2020-07-21T18:02:42Z", "message": "Modify gradle.yml for testing"}, "afterCommit": {"oid": "8894129c2a17e1fa2cc1c6acdf395f82c1aebf21", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/8894129c2a17e1fa2cc1c6acdf395f82c1aebf21", "committedDate": "2020-07-21T18:19:21Z", "message": "Modify gradle.yml for testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dea63c469011a2236be81bbe071b0bde83ca6dd7", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/dea63c469011a2236be81bbe071b0bde83ca6dd7", "committedDate": "2020-07-21T18:31:05Z", "message": "Remove info log flooding from testing gradle.yml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTA1OTM3", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/279#pullrequestreview-455105937", "createdAt": "2020-07-24T18:38:33Z", "commit": {"oid": "dea63c469011a2236be81bbe071b0bde83ca6dd7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODozODozM1rOG254Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxODozODozM1rOG254Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNDU5MA==", "bodyText": "nit: additional space. static  class -> static class", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/279#discussion_r460224590", "createdAt": "2020-07-24T18:38:33Z", "author": {"login": "ktkrg"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/PerformanceAnalyzerWebServer.java", "diffHunk": "@@ -66,8 +71,34 @@ public static HttpServer createInternalServer(String portFromSetting, String hos\n     return null;\n   }\n \n+  /**\n+   * ClientAuthConfigurator makes the server perform client authentication if the user has set up a\n+   * certificate authority\n+   */\n+  private static  class ClientAuthConfigurator extends HttpsConfigurator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dea63c469011a2236be81bbe071b0bde83ca6dd7"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTcxMDE5", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/279#pullrequestreview-455971019", "createdAt": "2020-07-27T17:03:45Z", "commit": {"oid": "dea63c469011a2236be81bbe071b0bde83ca6dd7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzowMzo0NVrOG3rfqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzowMzo0NVrOG3rfqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNzQ4Mg==", "bodyText": "Do you plan to wrap up the TODO in this PR or in a follow up ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/279#discussion_r461037482", "createdAt": "2020-07-27T17:03:45Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/PerformanceAnalyzerWebServer.java", "diffHunk": "@@ -81,38 +112,30 @@ private static HttpServer createHttpsServer(int readerPort, String bindHost) thr\n       server = HttpsServer.create(new InetSocketAddress(InetAddress.getLoopbackAddress(), readerPort), INCOMING_QUEUE_LENGTH);\n     }\n \n-    TrustManager[] trustAllCerts =\n-        new TrustManager[] {\n-            new X509TrustManager() {\n-\n-              public X509Certificate[] getAcceptedIssuers() {\n-                return null;\n-              }\n-\n-              public void checkClientTrusted(X509Certificate[] certs, String authType) {}\n-\n-              public void checkServerTrusted(X509Certificate[] certs, String authType) {}\n-            }\n-        };\n-\n-    HostnameVerifier allHostsValid =\n-        new HostnameVerifier() {\n-          public boolean verify(String hostname, SSLSession session) {\n-            return true;\n-          }\n-        };\n-\n     // Install the all-trusting trust manager\n     SSLContext sslContext = SSLContext.getInstance(\"TLSv1.2\");\n \n     KeyStore ks = CertificateUtils.createKeyStore();\n     KeyManagerFactory kmf = KeyManagerFactory.getInstance(\"NewSunX509\");\n     kmf.init(ks, CertificateUtils.IN_MEMORY_PWD.toCharArray());\n-    sslContext.init(kmf.getKeyManagers(), trustAllCerts, null);\n+    sslContext.init(kmf.getKeyManagers(), CertificateUtils.getTrustManagers(true), null);\n+    server.setHttpsConfigurator(new ClientAuthConfigurator(sslContext));\n+\n+\n+    // TODO ask ktkrg why this is necessary", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dea63c469011a2236be81bbe071b0bde83ca6dd7"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTc2NTEy", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/279#pullrequestreview-455976512", "createdAt": "2020-07-27T17:11:18Z", "commit": {"oid": "dea63c469011a2236be81bbe071b0bde83ca6dd7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1083, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}