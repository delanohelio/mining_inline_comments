{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3OTk1NjI5", "number": 314, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOToyNzoxMFrOES9JSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjo0MzowOVrOETdCcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MzExNjI3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOToyNzoxMFrOG4bOsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOToyNzoxMFrOG4bOsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgxOTU2OA==", "bodyText": "resource object read from QueueRejctionRca is threadpool + queue rejection. That is not the metric we want to read here. What we want to read from node config cache is threadpool + queue capacity", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/314#discussion_r461819568", "createdAt": "2020-07-28T19:27:10Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -91,11 +92,11 @@ private void configureActionPriority() {\n    * <p>Action relevance decided based on user configured priorities for now, this can be modified\n    * to consume better signals going forward.\n    */\n-  private Action computeBestAction(NodeKey esNode, ResourceEnum threadPool) {\n+  private Action computeBestAction(NodeKey esNode, Resource resource) {\n     Action action = null;\n     for (String actionName : actionsByUserPriority) {\n       action =\n-          getAction(actionName, esNode, threadPool, getNodeQueueCapacity(esNode, threadPool), true);\n+        getAction(actionName, esNode, resource.getResourceEnum(), getNodeQueueCapacity(esNode, resource), true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e767cd2688e036ac9c602bd468b039a01570136"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MzEyMDI2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOToyODoxOFrOG4bRIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOToyODoxOFrOG4bRIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgyMDE5NA==", "bodyText": "as I mentioned above, we don't have to change the input argument of this function. What we can do instead is to map queue rejection -> queue capacity", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/314#discussion_r461820194", "createdAt": "2020-07-28T19:28:18Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -120,11 +124,15 @@ private ModifyQueueCapacityAction configureQueueCapacity(NodeKey esNode, Resourc\n     return null;\n   }\n \n-  private int getNodeQueueCapacity(NodeKey esNode, ResourceEnum threadPool) {\n-    // TODO: use NodeConfigurationRca to return capacity, for now returning defaults\n-    if (threadPool.equals(ResourceEnum.SEARCH_THREADPOOL)) {\n-      return 1000;\n+  private int getNodeQueueCapacity(NodeKey esNode, Resource resource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e767cd2688e036ac9c602bd468b039a01570136"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MzEyMjYxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOToyOTowM1rOG4bSqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzozMDoyOFrOG4jRKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgyMDU4NQ==", "bodyText": "remove QueueRejectionClusterRca from the constructor as we don't consume anything directly from QueueRejectionClusterRca", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/314#discussion_r461820585", "createdAt": "2020-07-28T19:29:03Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -17,31 +17,32 @@\n \n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ModifyQueueCapacityAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.ResourceEnum;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.QueueRejectionClusterRca;\n-\n import java.util.ArrayList;\n import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n \n // This is a sample decider implementation to finalize decision maker interfaces.\n // TODO: 1. Read action priorities from a configurable yml\n-// TODO: 2. Read current queue capacity from NodeConfigurationRca (PR #252)\n \n public class QueueHealthDecider extends Decider {\n \n+  private static final Logger LOG = LogManager.getLogger(Decider.class);\n   public static final String NAME = \"queue_health\";\n \n   private QueueRejectionClusterRca queueRejectionRca;\n   List<String> actionsByUserPriority = new ArrayList<>();\n   private int counter = 0;\n \n   public QueueHealthDecider(long evalIntervalSeconds, int decisionFrequency, QueueRejectionClusterRca queueRejectionClusterRca) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e767cd2688e036ac9c602bd468b039a01570136"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MDE1Mg==", "bodyText": "Don't we rely on QueueRejectionClusterRca flow units to check whether a thread pool queue is healthy/unhealthy - @rguo-aws ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/314#discussion_r461950152", "createdAt": "2020-07-28T23:27:15Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -17,31 +17,32 @@\n \n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ModifyQueueCapacityAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.ResourceEnum;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.QueueRejectionClusterRca;\n-\n import java.util.ArrayList;\n import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n \n // This is a sample decider implementation to finalize decision maker interfaces.\n // TODO: 1. Read action priorities from a configurable yml\n-// TODO: 2. Read current queue capacity from NodeConfigurationRca (PR #252)\n \n public class QueueHealthDecider extends Decider {\n \n+  private static final Logger LOG = LogManager.getLogger(Decider.class);\n   public static final String NAME = \"queue_health\";\n \n   private QueueRejectionClusterRca queueRejectionRca;\n   List<String> actionsByUserPriority = new ArrayList<>();\n   private int counter = 0;\n \n   public QueueHealthDecider(long evalIntervalSeconds, int decisionFrequency, QueueRejectionClusterRca queueRejectionClusterRca) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgyMDU4NQ=="}, "originalCommit": {"oid": "9e767cd2688e036ac9c602bd468b039a01570136"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MTI3Mw==", "bodyText": "Yes resolved this with ruizhen!", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/314#discussion_r461951273", "createdAt": "2020-07-28T23:30:28Z", "author": {"login": "aditjind"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -17,31 +17,32 @@\n \n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ModifyQueueCapacityAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.ResourceEnum;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.QueueRejectionClusterRca;\n-\n import java.util.ArrayList;\n import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n \n // This is a sample decider implementation to finalize decision maker interfaces.\n // TODO: 1. Read action priorities from a configurable yml\n-// TODO: 2. Read current queue capacity from NodeConfigurationRca (PR #252)\n \n public class QueueHealthDecider extends Decider {\n \n+  private static final Logger LOG = LogManager.getLogger(Decider.class);\n   public static final String NAME = \"queue_health\";\n \n   private QueueRejectionClusterRca queueRejectionRca;\n   List<String> actionsByUserPriority = new ArrayList<>();\n   private int counter = 0;\n \n   public QueueHealthDecider(long evalIntervalSeconds, int decisionFrequency, QueueRejectionClusterRca queueRejectionClusterRca) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgyMDU4NQ=="}, "originalCommit": {"oid": "9e767cd2688e036ac9c602bd468b039a01570136"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mzk3NTEzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzoyODoyMlrOG4jOWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMzozOToxNFrOG4jcTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MDU1Mw==", "bodyText": "Minor: This is bit of a code smell. Can we raise an exception here instead and handle it gracefully at the caller? Instead of overloading the meaning of return value?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/314#discussion_r461950553", "createdAt": "2020-07-28T23:28:22Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -121,10 +126,16 @@ private ModifyQueueCapacityAction configureQueueCapacity(NodeKey esNode, Resourc\n   }\n \n   private int getNodeQueueCapacity(NodeKey esNode, ResourceEnum threadPool) {\n-    // TODO: use NodeConfigurationRca to return capacity, for now returning defaults\n-    if (threadPool.equals(ResourceEnum.SEARCH_THREADPOOL)) {\n-      return 1000;\n+    try {\n+      return (int) getAppContext().getNodeConfigCache().get(esNode, Resource.newBuilder()\n+              .setResourceEnum(threadPool)\n+              .setMetricEnum(MetricEnum.QUEUE_CAPACITY).build());\n+    } catch (Exception e) {\n+      LOG.error(\"Exception while reading values from Node Config Cache\", e);\n     }\n-    return 100;\n+    // No action if value not present in the cache.\n+    // Assumption here is the cache has been wiped off due to\n+    // unforeseen events and we dont want to trigger any action.\n+    return -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "693244f496b8f6de9f48fed6413fec8e866a83cc"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1NDEyNQ==", "bodyText": "Done", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/314#discussion_r461954125", "createdAt": "2020-07-28T23:39:14Z", "author": {"login": "aditjind"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -121,10 +126,16 @@ private ModifyQueueCapacityAction configureQueueCapacity(NodeKey esNode, Resourc\n   }\n \n   private int getNodeQueueCapacity(NodeKey esNode, ResourceEnum threadPool) {\n-    // TODO: use NodeConfigurationRca to return capacity, for now returning defaults\n-    if (threadPool.equals(ResourceEnum.SEARCH_THREADPOOL)) {\n-      return 1000;\n+    try {\n+      return (int) getAppContext().getNodeConfigCache().get(esNode, Resource.newBuilder()\n+              .setResourceEnum(threadPool)\n+              .setMetricEnum(MetricEnum.QUEUE_CAPACITY).build());\n+    } catch (Exception e) {\n+      LOG.error(\"Exception while reading values from Node Config Cache\", e);\n     }\n-    return 100;\n+    // No action if value not present in the cache.\n+    // Assumption here is the cache has been wiped off due to\n+    // unforeseen events and we dont want to trigger any action.\n+    return -1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MDU1Mw=="}, "originalCommit": {"oid": "693244f496b8f6de9f48fed6413fec8e866a83cc"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODI5MTgzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjoyMzoxNFrOG5MWpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjo0MDo1N1rOG5MxAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyNDQyMA==", "bodyText": "This will return an IllegalArgumentException if the NodeKey is not present. We should add handling for it.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/314#discussion_r462624420", "createdAt": "2020-07-29T22:23:14Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -121,10 +134,8 @@ private ModifyQueueCapacityAction configureQueueCapacity(NodeKey esNode, Resourc\n   }\n \n   private int getNodeQueueCapacity(NodeKey esNode, ResourceEnum threadPool) {\n-    // TODO: use NodeConfigurationRca to return capacity, for now returning defaults\n-    if (threadPool.equals(ResourceEnum.SEARCH_THREADPOOL)) {\n-      return 1000;\n-    }\n-    return 100;\n+      return (int) getAppContext().getNodeConfigCache().get(esNode, Resource.newBuilder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c11071fffab778df90ddbe7318aa50630e9ddc"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMTE3MA==", "bodyText": "I have handled exceptions in the caller of this function. It will result in no action being taken on the cluster.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/314#discussion_r462631170", "createdAt": "2020-07-29T22:40:57Z", "author": {"login": "aditjind"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -121,10 +134,8 @@ private ModifyQueueCapacityAction configureQueueCapacity(NodeKey esNode, Resourc\n   }\n \n   private int getNodeQueueCapacity(NodeKey esNode, ResourceEnum threadPool) {\n-    // TODO: use NodeConfigurationRca to return capacity, for now returning defaults\n-    if (threadPool.equals(ResourceEnum.SEARCH_THREADPOOL)) {\n-      return 1000;\n-    }\n-    return 100;\n+      return (int) getAppContext().getNodeConfigCache().get(esNode, Resource.newBuilder()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyNDQyMA=="}, "originalCommit": {"oid": "68c11071fffab778df90ddbe7318aa50630e9ddc"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODM0MTYxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjo0MzowOVrOG5M0MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjo0MzowOVrOG5M0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMTk4NA==", "bodyText": "nit: should we add a throws keyword here ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/314#discussion_r462631984", "createdAt": "2020-07-29T22:43:09Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/QueueHealthDecider.java", "diffHunk": "@@ -121,10 +134,8 @@ private ModifyQueueCapacityAction configureQueueCapacity(NodeKey esNode, Resourc\n   }\n \n   private int getNodeQueueCapacity(NodeKey esNode, ResourceEnum threadPool) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68c11071fffab778df90ddbe7318aa50630e9ddc"}, "originalPosition": 62}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2298, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}