{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNjI5NzQ4", "number": 287, "title": "Implement Action Flip Flop Detection in the Publisher", "bodyText": "Issue #: #286\nDescription of changes:\nWe don't want to rubber-band when applying Actions (e.g. applying a CPU\nincrease right after we apply a CPU decrease).\nThis commit implements logic which allows the Publisher to reject\nActions which flip flop.\nTests:\n\nTimeExpiringSetTest - Verifies that the underlying TimedFlipFlopDetector collection works as expected\nPublisherTest - Verifies that the publisher rejects flip flopping actions\nTimedFlipFlopDetectorTest - Verifies that the FlipFlopDetector implementation works as expected\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-07-17T00:32:36Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287", "merged": true, "mergeCommit": {"oid": "99ba548c258a7de5abefc5c804e37bc7ef119468"}, "closed": true, "closedAt": "2020-07-27T22:54:45Z", "author": {"login": "sidheart"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3JpELgBqjM1NzIzNDUwMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5J7IhAFqTQ1NjE4OTEzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dd455b15bdb1091b0cfbd2cd95ee6e029c29ea37", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/dd455b15bdb1091b0cfbd2cd95ee6e029c29ea37", "committedDate": "2020-07-17T00:58:26Z", "message": "Actually record executed actions in the Publisher"}, "afterCommit": {"oid": "ae89583ac19096f1d6d353c63e195f6f74c08cfe", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ae89583ac19096f1d6d353c63e195f6f74c08cfe", "committedDate": "2020-07-21T17:25:21Z", "message": "Actually record executed actions in the Publisher"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae89583ac19096f1d6d353c63e195f6f74c08cfe", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ae89583ac19096f1d6d353c63e195f6f74c08cfe", "committedDate": "2020-07-21T17:25:21Z", "message": "Actually record executed actions in the Publisher"}, "afterCommit": {"oid": "df5ad950dc8feeec2c971d3e063897a973861eb4", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/df5ad950dc8feeec2c971d3e063897a973861eb4", "committedDate": "2020-07-21T17:38:39Z", "message": "Actually record executed actions in the Publisher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzIxMTU4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#pullrequestreview-453721158", "createdAt": "2020-07-22T22:11:12Z", "commit": {"oid": "e9f53d19cf020a59d1dd96e8c5e6cdd69ddf7034"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMjoxMToxMlrOG12A4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMjoyNjoxMFrOG12YLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExMjY3NQ==", "bodyText": "Rename a -> prev and b -> curr or something on those lines to make it less ambiguous?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r459112675", "createdAt": "2020-07-22T22:11:12Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/TimedFlipFlopDetector.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collections.TimeExpiringSet;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Impact;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * A {@link FlipFlopDetector} whose recorded actions expire after a given period of time.\n+ *\n+ * <p>This class defines a flip flop as an {@link Impact#DECREASES_PRESSURE}s followed by an\n+ * {@link Impact#INCREASES_PRESSURE}s to be a flip flops.\n+ *\n+ * <p>This class stores a {@link TimeExpiringSet} of {@link ImpactVector}s per {@link NodeKey}\n+ * that are used to determine these flip flops.\n+ */\n+public class TimedFlipFlopDetector implements FlipFlopDetector {\n+    private Map<NodeKey, TimeExpiringSet<ImpactVector>> flipFlopMap;\n+    private long expiryDuration;\n+    private TimeUnit expiryUnit;\n+\n+    public TimedFlipFlopDetector(long duration, TimeUnit unit) {\n+        flipFlopMap = new HashMap<>();\n+        this.expiryDuration = duration;\n+        this.expiryUnit = unit;\n+    }\n+\n+    /**\n+     * Tests if (a,b) is a flip flopping sequence of impacts.\n+     *\n+     * <p>Only an increase following a decrease is considered a flip flop\n+     *\n+     * @param a The first impact that would be applied\n+     * @param b The subsequent impact that would be applied\n+     * @return Whether or not (a,b) is a flip flopping sequence of impacts\n+     */\n+    protected boolean isFlipFlopImpact(Impact a, Impact b) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f53d19cf020a59d1dd96e8c5e6cdd69ddf7034"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExMzYwMw==", "bodyText": "For the system, the first impact vector has already been applied, right? It's the second one that we are now evaluating for flip-flopping. I understand that writing it this way keeps this method independent of the system, but it's also confusing. Pls consider renaming/modifying the doc strings.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r459113603", "createdAt": "2020-07-22T22:13:45Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/TimedFlipFlopDetector.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collections.TimeExpiringSet;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Impact;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * A {@link FlipFlopDetector} whose recorded actions expire after a given period of time.\n+ *\n+ * <p>This class defines a flip flop as an {@link Impact#DECREASES_PRESSURE}s followed by an\n+ * {@link Impact#INCREASES_PRESSURE}s to be a flip flops.\n+ *\n+ * <p>This class stores a {@link TimeExpiringSet} of {@link ImpactVector}s per {@link NodeKey}\n+ * that are used to determine these flip flops.\n+ */\n+public class TimedFlipFlopDetector implements FlipFlopDetector {\n+    private Map<NodeKey, TimeExpiringSet<ImpactVector>> flipFlopMap;\n+    private long expiryDuration;\n+    private TimeUnit expiryUnit;\n+\n+    public TimedFlipFlopDetector(long duration, TimeUnit unit) {\n+        flipFlopMap = new HashMap<>();\n+        this.expiryDuration = duration;\n+        this.expiryUnit = unit;\n+    }\n+\n+    /**\n+     * Tests if (a,b) is a flip flopping sequence of impacts.\n+     *\n+     * <p>Only an increase following a decrease is considered a flip flop\n+     *\n+     * @param a The first impact that would be applied\n+     * @param b The subsequent impact that would be applied\n+     * @return Whether or not (a,b) is a flip flopping sequence of impacts\n+     */\n+    protected boolean isFlipFlopImpact(Impact a, Impact b) {\n+        return a.equals(Impact.DECREASES_PRESSURE) && b.equals(Impact.INCREASES_PRESSURE);\n+    }\n+\n+    /**\n+     * Returns true if the impact for a given Dimension in v is a flip flop Impact when compared to\n+     * the impact for a given dimension in u\n+     *\n+     * <p>e.g. for u = (HEAP: INCREASE, CPU: DECREASE), v = (HEAP: DECREASE, CPU: INCREASE)\n+     * (u,v) is a flip flop vector because a CPU: DECREASE followed by a CPU: INCREASE is a flip\n+     * flop impact\n+     *\n+     * @param u The first impact vector that would be applied", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f53d19cf020a59d1dd96e8c5e6cdd69ddf7034"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExMzg2OQ==", "bodyText": "nit: Rename u, v to something more verbose?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r459113869", "createdAt": "2020-07-22T22:14:27Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/TimedFlipFlopDetector.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collections.TimeExpiringSet;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Impact;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * A {@link FlipFlopDetector} whose recorded actions expire after a given period of time.\n+ *\n+ * <p>This class defines a flip flop as an {@link Impact#DECREASES_PRESSURE}s followed by an\n+ * {@link Impact#INCREASES_PRESSURE}s to be a flip flops.\n+ *\n+ * <p>This class stores a {@link TimeExpiringSet} of {@link ImpactVector}s per {@link NodeKey}\n+ * that are used to determine these flip flops.\n+ */\n+public class TimedFlipFlopDetector implements FlipFlopDetector {\n+    private Map<NodeKey, TimeExpiringSet<ImpactVector>> flipFlopMap;\n+    private long expiryDuration;\n+    private TimeUnit expiryUnit;\n+\n+    public TimedFlipFlopDetector(long duration, TimeUnit unit) {\n+        flipFlopMap = new HashMap<>();\n+        this.expiryDuration = duration;\n+        this.expiryUnit = unit;\n+    }\n+\n+    /**\n+     * Tests if (a,b) is a flip flopping sequence of impacts.\n+     *\n+     * <p>Only an increase following a decrease is considered a flip flop\n+     *\n+     * @param a The first impact that would be applied\n+     * @param b The subsequent impact that would be applied\n+     * @return Whether or not (a,b) is a flip flopping sequence of impacts\n+     */\n+    protected boolean isFlipFlopImpact(Impact a, Impact b) {\n+        return a.equals(Impact.DECREASES_PRESSURE) && b.equals(Impact.INCREASES_PRESSURE);\n+    }\n+\n+    /**\n+     * Returns true if the impact for a given Dimension in v is a flip flop Impact when compared to\n+     * the impact for a given dimension in u\n+     *\n+     * <p>e.g. for u = (HEAP: INCREASE, CPU: DECREASE), v = (HEAP: DECREASE, CPU: INCREASE)\n+     * (u,v) is a flip flop vector because a CPU: DECREASE followed by a CPU: INCREASE is a flip\n+     * flop impact\n+     *\n+     * @param u The first impact vector that would be applied\n+     * @param v The subsequent impact vector that would be applied\n+     * @return true if the impact for a given Dimension in v is a flip flop Impact when compared to\n+     *      the impact for a given dimension in u\n+     */\n+    protected boolean isFlipFlopVector(ImpactVector u, ImpactVector v) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f53d19cf020a59d1dd96e8c5e6cdd69ddf7034"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNjIwOA==", "bodyText": "nit: can remove the comment as method calls are self explanatory", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r459116208", "createdAt": "2020-07-22T22:20:00Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -67,13 +74,13 @@ public boolean isCooledOff(Action action) {\n \n   @Override\n   public EmptyFlowUnit operate() {\n-    // TODO: Pass through implementation, need to add dampening, action flip-flop\n-    // avoidance, state persistence etc.\n+    // TODO: Need to add dampening, avoidance, state persistence etc.\n     Decision decision = collator.getFlowUnits().get(0);\n     for (Action action : decision.getActions()) {\n-      if (isCooledOff(action)) { // Only execute actions which have passed their cool off period\n+      if (isCooledOff(action) && !flipFlopDetector.isFlipFlop(action)) { // Only execute actions which have passed their cool off period", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f53d19cf020a59d1dd96e8c5e6cdd69ddf7034"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExODA2NA==", "bodyText": "Nice, like how you keep this extensible.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r459118064", "createdAt": "2020-07-22T22:24:45Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/TimedFlipFlopDetector.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collections.TimeExpiringSet;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Impact;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * A {@link FlipFlopDetector} whose recorded actions expire after a given period of time.\n+ *\n+ * <p>This class defines a flip flop as an {@link Impact#DECREASES_PRESSURE}s followed by an\n+ * {@link Impact#INCREASES_PRESSURE}s to be a flip flops.\n+ *\n+ * <p>This class stores a {@link TimeExpiringSet} of {@link ImpactVector}s per {@link NodeKey}\n+ * that are used to determine these flip flops.\n+ */\n+public class TimedFlipFlopDetector implements FlipFlopDetector {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f53d19cf020a59d1dd96e8c5e6cdd69ddf7034"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExODYzNw==", "bodyText": "This is good, it was important to consider impact vectors from all prior actions on the node (within the time window). Glad that you've addressed it.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r459118637", "createdAt": "2020-07-22T22:26:10Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/TimedFlipFlopDetector.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collections.TimeExpiringSet;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Impact;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * A {@link FlipFlopDetector} whose recorded actions expire after a given period of time.\n+ *\n+ * <p>This class defines a flip flop as an {@link Impact#DECREASES_PRESSURE}s followed by an\n+ * {@link Impact#INCREASES_PRESSURE}s to be a flip flops.\n+ *\n+ * <p>This class stores a {@link TimeExpiringSet} of {@link ImpactVector}s per {@link NodeKey}\n+ * that are used to determine these flip flops.\n+ */\n+public class TimedFlipFlopDetector implements FlipFlopDetector {\n+    private Map<NodeKey, TimeExpiringSet<ImpactVector>> flipFlopMap;\n+    private long expiryDuration;\n+    private TimeUnit expiryUnit;\n+\n+    public TimedFlipFlopDetector(long duration, TimeUnit unit) {\n+        flipFlopMap = new HashMap<>();\n+        this.expiryDuration = duration;\n+        this.expiryUnit = unit;\n+    }\n+\n+    /**\n+     * Tests if (a,b) is a flip flopping sequence of impacts.\n+     *\n+     * <p>Only an increase following a decrease is considered a flip flop\n+     *\n+     * @param a The first impact that would be applied\n+     * @param b The subsequent impact that would be applied\n+     * @return Whether or not (a,b) is a flip flopping sequence of impacts\n+     */\n+    protected boolean isFlipFlopImpact(Impact a, Impact b) {\n+        return a.equals(Impact.DECREASES_PRESSURE) && b.equals(Impact.INCREASES_PRESSURE);\n+    }\n+\n+    /**\n+     * Returns true if the impact for a given Dimension in v is a flip flop Impact when compared to\n+     * the impact for a given dimension in u\n+     *\n+     * <p>e.g. for u = (HEAP: INCREASE, CPU: DECREASE), v = (HEAP: DECREASE, CPU: INCREASE)\n+     * (u,v) is a flip flop vector because a CPU: DECREASE followed by a CPU: INCREASE is a flip\n+     * flop impact\n+     *\n+     * @param u The first impact vector that would be applied\n+     * @param v The subsequent impact vector that would be applied\n+     * @return true if the impact for a given Dimension in v is a flip flop Impact when compared to\n+     *      the impact for a given dimension in u\n+     */\n+    protected boolean isFlipFlopVector(ImpactVector u, ImpactVector v) {\n+        Map<Dimension, Impact> currentImpact = v.getImpact();\n+        for (Map.Entry<Dimension, Impact> impactEntry : u.getImpact().entrySet()) {\n+            Dimension dim = impactEntry.getKey();\n+            Impact vImpact = currentImpact.get(dim);\n+            if (isFlipFlopImpact(impactEntry.getValue(), vImpact)) {\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * Records an action's various {@link ImpactVector}s so that they may be used for future flip\n+     * flop tests\n+     *\n+     * @param action The action to record\n+     */\n+    @Override\n+    public void recordAction(Action action) {\n+        for (Map.Entry<NodeKey, ImpactVector> entry : action.impact().entrySet()) {\n+            flipFlopMap.compute(entry.getKey(), (k, v) -> {\n+                if (v == null) {\n+                    v = new TimeExpiringSet<>(expiryDuration, expiryUnit);\n+                }\n+                v.add(entry.getValue());\n+                return v;\n+            });\n+        }\n+    }\n+\n+    /**\n+     * Returns true if for any NodeKey, ImpactVector pair (k, v) in action, v clashes with any of\n+     * the {@link ImpactVector}s currently associated with k.\n+     *\n+     * @param action The {@link Action} to test\n+     * @return true if applying the action would cause a flip flop\n+     */\n+    @Override\n+    public boolean isFlipFlop(Action action) {\n+        for (Map.Entry<NodeKey, ImpactVector> entry : action.impact().entrySet()) {\n+            TimeExpiringSet<ImpactVector> previousImpacts = flipFlopMap.get(entry.getKey());\n+            if (previousImpacts == null) {\n+                continue;\n+            }\n+            // Weakly-consistent iteration over the previousImpacts\n+            // If one of these impacts expires during our iteration we may incorrectly determine\n+            // action to be a flip flop until the subsequent call of this function. This is OK for\n+            // our use case since we're always erring on the side of stability\n+            for (ImpactVector impactVector : previousImpacts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9f53d19cf020a59d1dd96e8c5e6cdd69ddf7034"}, "originalPosition": 106}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9f53d19cf020a59d1dd96e8c5e6cdd69ddf7034", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e9f53d19cf020a59d1dd96e8c5e6cdd69ddf7034", "committedDate": "2020-07-21T18:01:40Z", "message": "Fix import lexicographical order"}, "afterCommit": {"oid": "290f6aeb5d1f1bacb8ccab5eca9b2f62429af92d", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/290f6aeb5d1f1bacb8ccab5eca9b2f62429af92d", "committedDate": "2020-07-23T21:55:42Z", "message": "Edit comments and param names for ease of reading"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDE1MTk5", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#pullrequestreview-456015199", "createdAt": "2020-07-27T18:04:40Z", "commit": {"oid": "290f6aeb5d1f1bacb8ccab5eca9b2f62429af92d"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODowNDo0MFrOG3tphw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODo0MDo0MFrOG3u3xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3Mjc3NQ==", "bodyText": "License information missing. Please take care to update the license to use 2020 as the year.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r461072775", "createdAt": "2020-07-27T18:04:40Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/collections/TimeExpiringSet.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.collections;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "290f6aeb5d1f1bacb8ccab5eca9b2f62429af92d"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3NTQyOQ==", "bodyText": "nit: \"Stores a set of elements which are automatically removed from the Set after a given time period.\", can we update this to \"Caches a set of elements which are automatically evicted based on the cache TTL\"\nJust to keep it consistent with Cache terminologies.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r461075429", "createdAt": "2020-07-27T18:09:35Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/collections/TimeExpiringSet.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.collections;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import java.util.Iterator;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Stores a set of elements which are automatically removed from the Set after a given time period.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "290f6aeb5d1f1bacb8ccab5eca9b2f62429af92d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA3NjUyNw==", "bodyText": "Can we rename duration to a more appropriate variable name?  expiryTimeout perhaps ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r461076527", "createdAt": "2020-07-27T18:11:37Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/collections/TimeExpiringSet.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.collections;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import java.util.Iterator;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Stores a set of elements which are automatically removed from the Set after a given time period.\n+ *\n+ * <p>Subsequent calls to add with the same element refresh the expiry period for that element.\n+ */\n+public class TimeExpiringSet<E> implements Iterable<E> {\n+  private Cache<E, E> cache;\n+\n+  /**\n+   * Allocates a new TimeExpiringSet whose elements expire after the given time period\n+   * @param duration The magnitude of the expiry duration\n+   * @param unit The unit of the expiry duration\n+   */\n+  public TimeExpiringSet(long duration, TimeUnit unit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "290f6aeb5d1f1bacb8ccab5eca9b2f62429af92d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4ODA3MA==", "bodyText": "Do you think we will need the resource name for which the flip flop happened ?\nSo, for for prev = (HEAP: INCREASE, CPU: INCREASE), curr = (HEAP: DECREASE, CPU: INCREASE), we can return HEAP instead of Boolean value ?\nWhat I want to understand is if we use(or might use in future) this information anywhere.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r461088070", "createdAt": "2020-07-27T18:32:03Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/TimedFlipFlopDetector.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collections.TimeExpiringSet;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Impact;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * A {@link FlipFlopDetector} whose recorded actions expire after a given period of time.\n+ *\n+ * <p>This class defines a flip flop as an {@link Impact#DECREASES_PRESSURE}s followed by an\n+ * {@link Impact#INCREASES_PRESSURE}s to be a flip flops.\n+ *\n+ * <p>This class stores a {@link TimeExpiringSet} of {@link ImpactVector}s per {@link NodeKey}\n+ * that are used to determine these flip flops.\n+ */\n+public class TimedFlipFlopDetector implements FlipFlopDetector {\n+    private Map<NodeKey, TimeExpiringSet<ImpactVector>> flipFlopMap;\n+    private long expiryDuration;\n+    private TimeUnit expiryUnit;\n+\n+    public TimedFlipFlopDetector(long duration, TimeUnit unit) {\n+        flipFlopMap = new HashMap<>();\n+        this.expiryDuration = duration;\n+        this.expiryUnit = unit;\n+    }\n+\n+    /**\n+     * Tests if (prev, curr) is a flip flopping sequence of impacts.\n+     *\n+     * <p>Only an increase following a decrease is considered a flip flop. Therefore, if\n+     * prev decreases pressure and curr increases pressure, then (prev, curr) is a flip flop.\n+     *\n+     * @param prev The {@link Impact} that curr is compared against\n+     * @param curr The {@link Impact} that you'd like to test and apply\n+     * @return Whether or not (prev, curr) is a flip flopping sequence of impacts\n+     */\n+    protected boolean isFlipFlopImpact(Impact prev, Impact curr) {\n+        return prev.equals(Impact.DECREASES_PRESSURE) && curr.equals(Impact.INCREASES_PRESSURE);\n+    }\n+\n+    /**\n+     * Returns true if the impact for any given Dimension in prev is a flip flop Impact when compared to\n+     * the impact for a given dimension in prev\n+     *\n+     * <p>e.g. for prev = (HEAP: INCREASE, CPU: DECREASE), curr = (HEAP: DECREASE, CPU: INCREASE)\n+     * (prev, curr) is a flip flop vector because a CPU: DECREASE followed by a CPU: INCREASE is a flip\n+     * flop impact. Note that (HEAP: DECREASE) followed by (CPU: INCREASE) is not a flip flop\n+     * because HEAP =/= CPU.\n+     *\n+     * @param prev The first {@link ImpactVector}. Its Impacts appear on the LHS of calls to\n+     *             {@link this#isFlipFlopImpact(Impact, Impact)}\n+     * @param curr The second {@link ImpactVector}. Its Impacts appear on the RHS of calls to\n+     *            {@link this#isFlipFlopImpact(Impact, Impact)}.\n+     * @return true if the impact for any given Dimension in curr is a flip flop Impact when compared to\n+     *      the impact for a given dimension in prev\n+     */\n+    protected boolean isFlipFlopVector(ImpactVector prev, ImpactVector curr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "290f6aeb5d1f1bacb8ccab5eca9b2f62429af92d"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5MDA5Nw==", "bodyText": "+1.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r461090097", "createdAt": "2020-07-27T18:35:44Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/TimedFlipFlopDetector.java", "diffHunk": "@@ -0,0 +1,114 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collections.TimeExpiringSet;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Impact;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * A {@link FlipFlopDetector} whose recorded actions expire after a given period of time.\n+ *\n+ * <p>This class defines a flip flop as an {@link Impact#DECREASES_PRESSURE}s followed by an\n+ * {@link Impact#INCREASES_PRESSURE}s to be a flip flops.\n+ *\n+ * <p>This class stores a {@link TimeExpiringSet} of {@link ImpactVector}s per {@link NodeKey}\n+ * that are used to determine these flip flops.\n+ */\n+public class TimedFlipFlopDetector implements FlipFlopDetector {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExODA2NA=="}, "originalCommit": {"oid": "e9f53d19cf020a59d1dd96e8c5e6cdd69ddf7034"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5MjgwNA==", "bodyText": "Might want to update this TODO.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#discussion_r461092804", "createdAt": "2020-07-27T18:40:40Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -33,13 +37,16 @@\n   private final long initTime;\n \n   private Collator collator;\n+  private FlipFlopDetector flipFlopDetector;\n   private boolean isMuted = false;\n   private Map<String, Long> actionToExecutionTime;\n \n   public Publisher(int evalIntervalSeconds, Collator collator) {\n     super(0, evalIntervalSeconds);\n     this.collator = collator;\n     this.actionToExecutionTime = new HashMap<>();\n+    // TODO please bring in guice so we can configure this with DI", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "290f6aeb5d1f1bacb8ccab5eca9b2f62429af92d"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87a81ddae1f54b8b41ed0f629035a99da94a8a8e", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/87a81ddae1f54b8b41ed0f629035a99da94a8a8e", "committedDate": "2020-07-27T20:50:41Z", "message": "Implement Action flip flop detection for the Publisher\n\nWe don't want to rubber-band when applying Actions (e.g. applying a CPU\nincrease right after we apply a CPU decrease).\n\nThis commit implements logic which allows the Publisher to reject\nActions which flip flop."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24f12af93dc56c37d5754999cd9c71ea809ca623", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/24f12af93dc56c37d5754999cd9c71ea809ca623", "committedDate": "2020-07-27T20:50:41Z", "message": "Actually record executed actions in the Publisher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa6189a0cf316e95034003d7750de5e09fb075aa", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/fa6189a0cf316e95034003d7750de5e09fb075aa", "committedDate": "2020-07-27T20:50:41Z", "message": "Fix import lexicographical order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d17bbf2b69041c67dd6cd3d8c48e1db9cc8cd41b", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d17bbf2b69041c67dd6cd3d8c48e1db9cc8cd41b", "committedDate": "2020-07-27T20:50:41Z", "message": "Edit comments and param names for ease of reading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06f69a47502e8383f59bab6195ea63484a628b84", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/06f69a47502e8383f59bab6195ea63484a628b84", "committedDate": "2020-07-27T20:50:41Z", "message": "Add copyright notice to new files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f34ed6c95008ce755f4ee0b466349a3d0071e161", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f34ed6c95008ce755f4ee0b466349a3d0071e161", "committedDate": "2020-07-27T20:50:41Z", "message": "Address khushbr PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "290f6aeb5d1f1bacb8ccab5eca9b2f62429af92d", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/290f6aeb5d1f1bacb8ccab5eca9b2f62429af92d", "committedDate": "2020-07-23T21:55:42Z", "message": "Edit comments and param names for ease of reading"}, "afterCommit": {"oid": "f34ed6c95008ce755f4ee0b466349a3d0071e161", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f34ed6c95008ce755f4ee0b466349a3d0071e161", "committedDate": "2020-07-27T20:50:41Z", "message": "Address khushbr PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTg5MTMy", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/287#pullrequestreview-456189132", "createdAt": "2020-07-27T22:53:30Z", "commit": {"oid": "f34ed6c95008ce755f4ee0b466349a3d0071e161"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1089, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}