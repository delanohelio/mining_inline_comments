{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNjIxNDc0", "number": 208, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODo0MToyOVrOD_zPVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOTo0NTo0NFrOEAphYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MjI2Mzg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotshard/HotShardRca.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODo0MToyOVrOGarcug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMjoyMjo1M1rOGayTCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYyODAyNg==", "bodyText": "We are gathering metrics at shard level here and at each iteration we are creating a new object. I wonder how much garbage we are creating here. We should try to reuse objects.\nIn the RCA periodic samplers, we should add a metric to get the gc count and duration metrics.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/208#discussion_r430628026", "createdAt": "2020-05-26T18:41:29Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotshard/HotShardRca.java", "diffHunk": "@@ -106,14 +110,18 @@ private void consumeFlowUnit(final MetricFlowUnit metricFlowUnit, final String m\n                                  final HashMap<IndexShardKey, SlidingWindow<SlidingWindowData>> metricMap) {\n         for (Record record : metricFlowUnit.getData()) {\n             try {\n-                IndexShardKey indexShardKey = IndexShardKey.buildIndexShardKey(record);\n-                double usage = record.getValue(MetricsDB.SUM, Double.class);\n-                SlidingWindow<SlidingWindowData> usageDeque = metricMap.get(indexShardKey);\n-                if (null == usageDeque) {\n-                    usageDeque = new SlidingWindow<>(SLIDING_WINDOW_IN_SECONDS, TimeUnit.SECONDS);\n-                    metricMap.put(indexShardKey, usageDeque);\n+                String indexName = record.getValue(INDEX_NAME.toString(), String.class);\n+                Integer shardId = record.getValue(SHARD_ID.toString(), Integer.class);\n+                if (indexName != null &&  shardId != null) {\n+                    IndexShardKey indexShardKey = IndexShardKey.buildIndexShardKey(record);\n+                    double usage = record.getValue(MetricsDB.SUM, Double.class);\n+                    SlidingWindow<SlidingWindowData> usageDeque = metricMap.get(indexShardKey);\n+                    if (null == usageDeque) {\n+                        usageDeque = new SlidingWindow<>(SLIDING_WINDOW_IN_SECONDS, TimeUnit.SECONDS);\n+                        metricMap.put(indexShardKey, usageDeque);\n+                    }\n+                    usageDeque.next(new SlidingWindowData(this.clock.millis(), usage));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c25db51201245b4ca702e518e93356848dcb467a"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc0MDIzNQ==", "bodyText": "Created an issue for this #213", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/208#discussion_r430740235", "createdAt": "2020-05-26T22:22:53Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotshard/HotShardRca.java", "diffHunk": "@@ -106,14 +110,18 @@ private void consumeFlowUnit(final MetricFlowUnit metricFlowUnit, final String m\n                                  final HashMap<IndexShardKey, SlidingWindow<SlidingWindowData>> metricMap) {\n         for (Record record : metricFlowUnit.getData()) {\n             try {\n-                IndexShardKey indexShardKey = IndexShardKey.buildIndexShardKey(record);\n-                double usage = record.getValue(MetricsDB.SUM, Double.class);\n-                SlidingWindow<SlidingWindowData> usageDeque = metricMap.get(indexShardKey);\n-                if (null == usageDeque) {\n-                    usageDeque = new SlidingWindow<>(SLIDING_WINDOW_IN_SECONDS, TimeUnit.SECONDS);\n-                    metricMap.put(indexShardKey, usageDeque);\n+                String indexName = record.getValue(INDEX_NAME.toString(), String.class);\n+                Integer shardId = record.getValue(SHARD_ID.toString(), Integer.class);\n+                if (indexName != null &&  shardId != null) {\n+                    IndexShardKey indexShardKey = IndexShardKey.buildIndexShardKey(record);\n+                    double usage = record.getValue(MetricsDB.SUM, Double.class);\n+                    SlidingWindow<SlidingWindowData> usageDeque = metricMap.get(indexShardKey);\n+                    if (null == usageDeque) {\n+                        usageDeque = new SlidingWindow<>(SLIDING_WINDOW_IN_SECONDS, TimeUnit.SECONDS);\n+                        metricMap.put(indexShardKey, usageDeque);\n+                    }\n+                    usageDeque.next(new SlidingWindowData(this.clock.millis(), usage));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYyODAyNg=="}, "originalCommit": {"oid": "c25db51201245b4ca702e518e93356848dcb467a"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MjI3OTMxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotshard/HotShardClusterRca.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODo0NjowNFrOGarmpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMTo1OTo1NFrOGaxxTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDU2NA==", "bodyText": "We have a lot of instanceof scattered around. It might be worth while to create an enum type of Summaries and then we can compare against an enum value", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/208#discussion_r430630564", "createdAt": "2020-05-26T18:46:04Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotshard/HotShardClusterRca.java", "diffHunk": "@@ -90,17 +95,21 @@ private void populateResourceInfoTable(String indexName, NodeShardKey nodeShardK\n     private void consumeFlowUnit(ResourceFlowUnit resourceFlowUnit) {\n         String nodeId = ((HotNodeSummary) resourceFlowUnit.getResourceSummary()).getNodeID();\n         HotNodeSummary hotNodeSummary = ((HotNodeSummary) resourceFlowUnit.getResourceSummary());\n-        for (HotShardSummary hotShardSummary : hotNodeSummary.getHotShardSummaryList()) {\n-            String indexName = hotShardSummary.getIndexName();\n-            NodeShardKey nodeShardKey = new NodeShardKey(nodeId, hotShardSummary.getShardId());\n-            // 1. Populate CPU Table\n-            populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getCpuUtilization(), cpuUtilizationInfoTable);\n+        for (GenericSummary summary : hotNodeSummary.getNestedSummaryList()) {\n+            if (summary instanceof HotShardSummary) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c25db51201245b4ca702e518e93356848dcb467a"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDczMTU5Nw==", "bodyText": "Agreed, have created an issue to track it #212", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/208#discussion_r430731597", "createdAt": "2020-05-26T21:59:54Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotshard/HotShardClusterRca.java", "diffHunk": "@@ -90,17 +95,21 @@ private void populateResourceInfoTable(String indexName, NodeShardKey nodeShardK\n     private void consumeFlowUnit(ResourceFlowUnit resourceFlowUnit) {\n         String nodeId = ((HotNodeSummary) resourceFlowUnit.getResourceSummary()).getNodeID();\n         HotNodeSummary hotNodeSummary = ((HotNodeSummary) resourceFlowUnit.getResourceSummary());\n-        for (HotShardSummary hotShardSummary : hotNodeSummary.getHotShardSummaryList()) {\n-            String indexName = hotShardSummary.getIndexName();\n-            NodeShardKey nodeShardKey = new NodeShardKey(nodeId, hotShardSummary.getShardId());\n-            // 1. Populate CPU Table\n-            populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getCpuUtilization(), cpuUtilizationInfoTable);\n+        for (GenericSummary summary : hotNodeSummary.getNestedSummaryList()) {\n+            if (summary instanceof HotShardSummary) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMDU2NA=="}, "originalCommit": {"oid": "c25db51201245b4ca702e518e93356848dcb467a"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MjI4NDM1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotshard/HotShardClusterRca.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODo0NzozNlrOGarp-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMTo1MDo0N1rOGaxi7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMTQxNg==", "bodyText": "remove ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/208#discussion_r430631416", "createdAt": "2020-05-26T18:47:36Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotshard/HotShardClusterRca.java", "diffHunk": "@@ -90,17 +95,21 @@ private void populateResourceInfoTable(String indexName, NodeShardKey nodeShardK\n     private void consumeFlowUnit(ResourceFlowUnit resourceFlowUnit) {\n         String nodeId = ((HotNodeSummary) resourceFlowUnit.getResourceSummary()).getNodeID();\n         HotNodeSummary hotNodeSummary = ((HotNodeSummary) resourceFlowUnit.getResourceSummary());\n-        for (HotShardSummary hotShardSummary : hotNodeSummary.getHotShardSummaryList()) {\n-            String indexName = hotShardSummary.getIndexName();\n-            NodeShardKey nodeShardKey = new NodeShardKey(nodeId, hotShardSummary.getShardId());\n-            // 1. Populate CPU Table\n-            populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getCpuUtilization(), cpuUtilizationInfoTable);\n+        for (GenericSummary summary : hotNodeSummary.getNestedSummaryList()) {\n+            if (summary instanceof HotShardSummary) {\n+                HotShardSummary hotShardSummary = (HotShardSummary) summary;\n+                String indexName = hotShardSummary.getIndexName();\n+                NodeShardKey nodeShardKey = new NodeShardKey(nodeId, hotShardSummary.getShardId());\n+                // 1. Populate CPU Table\n+                populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getCpuUtilization(), cpuUtilizationInfoTable);\n \n-            // 2. Populate ioTotThroughput Table\n-            populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getIOThroughput(), IOThroughputInfoTable);\n+                // 2. Populate ioTotThroughput Table\n+                populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getIOThroughput(), IOThroughputInfoTable);\n \n-            // 3. Populate ioTotSysCallrate Table\n-            populateResourceInfoTable(indexName,nodeShardKey, hotShardSummary.getIOSysCallrate(), IOSysCallRateInfoTable);\n+                // 3. Populate ioTotSysCallrate Table\n+                populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getIOSysCallrate(), IOSysCallRateInfoTable);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c25db51201245b4ca702e518e93356848dcb467a"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyNzkxNw==", "bodyText": "Done. Removed the comments.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/208#discussion_r430727917", "createdAt": "2020-05-26T21:50:47Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotshard/HotShardClusterRca.java", "diffHunk": "@@ -90,17 +95,21 @@ private void populateResourceInfoTable(String indexName, NodeShardKey nodeShardK\n     private void consumeFlowUnit(ResourceFlowUnit resourceFlowUnit) {\n         String nodeId = ((HotNodeSummary) resourceFlowUnit.getResourceSummary()).getNodeID();\n         HotNodeSummary hotNodeSummary = ((HotNodeSummary) resourceFlowUnit.getResourceSummary());\n-        for (HotShardSummary hotShardSummary : hotNodeSummary.getHotShardSummaryList()) {\n-            String indexName = hotShardSummary.getIndexName();\n-            NodeShardKey nodeShardKey = new NodeShardKey(nodeId, hotShardSummary.getShardId());\n-            // 1. Populate CPU Table\n-            populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getCpuUtilization(), cpuUtilizationInfoTable);\n+        for (GenericSummary summary : hotNodeSummary.getNestedSummaryList()) {\n+            if (summary instanceof HotShardSummary) {\n+                HotShardSummary hotShardSummary = (HotShardSummary) summary;\n+                String indexName = hotShardSummary.getIndexName();\n+                NodeShardKey nodeShardKey = new NodeShardKey(nodeId, hotShardSummary.getShardId());\n+                // 1. Populate CPU Table\n+                populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getCpuUtilization(), cpuUtilizationInfoTable);\n \n-            // 2. Populate ioTotThroughput Table\n-            populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getIOThroughput(), IOThroughputInfoTable);\n+                // 2. Populate ioTotThroughput Table\n+                populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getIOThroughput(), IOThroughputInfoTable);\n \n-            // 3. Populate ioTotSysCallrate Table\n-            populateResourceInfoTable(indexName,nodeShardKey, hotShardSummary.getIOSysCallrate(), IOSysCallRateInfoTable);\n+                // 3. Populate ioTotSysCallrate Table\n+                populateResourceInfoTable(indexName, nodeShardKey, hotShardSummary.getIOSysCallrate(), IOSysCallRateInfoTable);\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMTQxNg=="}, "originalCommit": {"oid": "c25db51201245b4ca702e518e93356848dcb467a"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MTE1NzQ3OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ResourceHeatMapGraphTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOTo0NTo0NFrOGcD93g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOTo0NTo0NFrOGcD93g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA3ODMwMg==", "bodyText": "remove ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/208#discussion_r432078302", "createdAt": "2020-05-28T19:45:44Z", "author": {"login": "yojs"}, "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ResourceHeatMapGraphTest.java", "diffHunk": "@@ -503,4 +520,131 @@ private void testJsonResponse(String jsonResponse) {\n             Assert.assertEquals(0, node.get(\"IO_WriteSyscallRate_num_shards\").getAsInt());\n         }\n     }\n-}\n\\ No newline at end of file\n+\n+    private static class AnalysisGraphHotShard extends ElasticSearchAnalysisGraph {\n+        @Override\n+        public void construct() {\n+            Metric cpuUtilization = new CPU_Utilization(1);\n+            Metric ioTotThroughput = new IO_TotThroughput(1);\n+            Metric ioTotSyscallRate = new IO_TotalSyscallRate(1);\n+\n+            cpuUtilization.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+            ioTotThroughput.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+            ioTotSyscallRate.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+            addLeaf(cpuUtilization);\n+            addLeaf(ioTotThroughput);\n+            addLeaf(ioTotSyscallRate);\n+\n+            // High CPU Utilization RCA\n+            HotShardRca hotShardRca = new HotShardRca(1, 1, cpuUtilization, ioTotThroughput, ioTotSyscallRate);\n+            hotShardRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+            hotShardRca.addAllUpstreams(Arrays.asList(cpuUtilization, ioTotThroughput, ioTotSyscallRate));\n+\n+            // Hot Shard Cluster RCA which consumes the above\n+            HotShardClusterRca hotShardClusterRca = new HotShardClusterRca(1, hotShardRca);\n+            hotShardClusterRca.addTag(TAG_LOCUS, LOCUS_MASTER_NODE);\n+            hotShardClusterRca.addAllUpstreams(Collections.singletonList(hotShardRca));\n+            hotShardClusterRca.addTag(TAG_AGGREGATE_UPSTREAM, LOCUS_DATA_NODE);\n+        }\n+    }\n+\n+    @Test\n+    public void testHotShardClusterApiResponse() {\n+        AnalysisGraph analysisGraph = new AnalysisGraphHotShard();\n+        List<ConnectedComponent> connectedComponents =\n+                RcaUtil.getAnalysisGraphComponents(analysisGraph);\n+        RcaTestHelper.setEvaluationTimeForAllNodes(connectedComponents, 1);\n+\n+        String dataNodeRcaConf = Paths.get(RcaConsts.TEST_CONFIG_PATH, \"rca.conf\").toString();\n+\n+        RcaConf rcaConf = new RcaConf(dataNodeRcaConf);\n+        SubscriptionManager subscriptionManager =\n+                new SubscriptionManager(new GRPCConnectionManager(false));\n+        subscriptionManager.setCurrentLocus(rcaConf.getTagMap().get(\"locus\"));\n+\n+        WireHopper wireHopper = new WireHopper(new NodeStateManager(), clientServers.getNetClient(),\n+                subscriptionManager,\n+                networkThreadPoolReference,\n+                new ReceivedFlowUnitStore(rcaConf.getPerVertexBufferLength()));\n+\n+        RCASchedulerTask rcaSchedulerTaskData =\n+                new RCASchedulerTask(\n+                        1000,\n+                        Executors.newFixedThreadPool(THREADS),\n+                        connectedComponents,\n+                        reader,\n+                        persistable,\n+                        rcaConf,\n+                        wireHopper);\n+        AllMetrics.NodeRole nodeRole = AllMetrics.NodeRole.DATA;\n+        RcaTestHelper.setMyIp(\"192.168.0.1\", nodeRole);\n+        rcaSchedulerTaskData.run();\n+\n+        String masterNodeRcaConf =\n+                Paths.get(RcaConsts.TEST_CONFIG_PATH, \"rca_elected_master.conf\").toString();\n+        RcaConf rcaConf2 = new RcaConf(masterNodeRcaConf);\n+        SubscriptionManager subscriptionManager2 =\n+                new SubscriptionManager(new GRPCConnectionManager(false));\n+        subscriptionManager2.setCurrentLocus(rcaConf2.getTagMap().get(\"locus\"));\n+\n+        WireHopper wireHopper2 = new WireHopper(new NodeStateManager(), clientServers.getNetClient(),\n+                subscriptionManager2,\n+                networkThreadPoolReference,\n+                new ReceivedFlowUnitStore(rcaConf.getPerVertexBufferLength()));\n+\n+        RCASchedulerTask rcaSchedulerTaskMaster =\n+                new RCASchedulerTask(\n+                        1000,\n+                        Executors.newFixedThreadPool(THREADS),\n+                        connectedComponents,\n+                        reader,\n+                        persistable,\n+                        rcaConf2,\n+                        wireHopper2);\n+        AllMetrics.NodeRole nodeRole2 = AllMetrics.NodeRole.ELECTED_MASTER;\n+        RcaTestHelper.setMyIp(\"1c\", nodeRole2);\n+        rcaSchedulerTaskMaster.run();\n+\n+        URL url = null;\n+        try {\n+            url = new URL(\"http://localhost:9600\" + Util.RCA_QUERY_URL + \"?name=\" + HotShardClusterRca.RCA_TABLE_NAME);\n+        } catch (MalformedURLException e) {\n+            e.printStackTrace();\n+            Assert.fail();\n+        }\n+\n+        try {\n+            HttpURLConnection con = (HttpURLConnection) url.openConnection();\n+            con.setRequestMethod(\"GET\");\n+\n+            int status = con.getResponseCode();\n+            System.out.println(\"Response status: \" + status);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1076e7920245e53a62f83fcd91e2e05ce1808562"}, "originalPosition": 201}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2463, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}