{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMzc0MTgz", "number": 506, "title": "Fix actions not muting", "bodyText": "Fixes #:\n#505\nDescription of changes:\nThis PR fixes the bug where actions that were overridden to be disabled do not end up being marked as muted. The reason for this behavior is because the RCA controller, while updating the list of muted components, updates the graph nodes directly for RCAs, and deciders, it updates the list of muted actions in the AppContext.\nHowever, the AppContext updated by the RcaController and the AppContext used by the RcaScheduler are different. The Scheduler only gets a snapshot of the AppContext during its initialization as it uses that AppContext to determine staleness, and never gets an updated AppContext till the scheduler is restarted.\nThis causes the update to go missing in the AppContext used by the RcaScheduler which eventually manifests as an unmuted action(when muting an action is involved). The fix basically exposes a new method from the scheduler to get the updated list of muted actions that it should pass down to the Actions through its AppContext.\nTests:\nUnit tests, tested on docker with HeapSizeIncreaseAction.\nIf new tests are added, how long do the new ones take to complete\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-10-31T05:02:26Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/506", "merged": true, "mergeCommit": {"oid": "c5fd658727b55c158a026db88d8f944290434b19"}, "closed": true, "closedAt": "2020-11-06T17:03:57Z", "author": {"login": "ktkrg"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdX0ARLgH2gAyNTEzMzc0MTgzOjU5NDk3ZDcwYjM2ZmM1NmU4NWE2ZTkxZDIwMjk0ZmRlNzA1YmFjZDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZmwpOAFqTUyNDU1MzQzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "59497d70b36fc56e85a6e91d20294fde705bacd0", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/59497d70b36fc56e85a6e91d20294fde705bacd0", "committedDate": "2020-10-31T04:52:51Z", "message": "Fix actions not muting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMTQ2MzEx", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/506#pullrequestreview-522146311", "createdAt": "2020-11-03T01:45:24Z", "commit": {"oid": "59497d70b36fc56e85a6e91d20294fde705bacd0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwMTo0NToyNFrOHsdyBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwMTo0NToyNFrOHsdyBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM4NzMzMg==", "bodyText": "This fixes this issue but we can run into such inconsistencies where changes may not reflect until a scheduler restart. Can the scheduler use a reference of the AppContext of RcaController instead of a copy ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/506#discussion_r516387332", "createdAt": "2020-11-03T01:45:24Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -410,7 +409,15 @@ private boolean updateMutedComponents() {\n \n       LOG.info(\"Updating the muted graph nodes to : {}\", graphNodesForMute);\n       Stats.getInstance().updateMutedGraphNodes(graphNodesForMute);\n+      // We need to update muted actions in two places. One is in the controller which could\n+      // potentially serve as a snapshot when creating a new rca scheduler, and the other place\n+      // is in the rca scheduler itself. The scheduler maintains a snapshot of the appcontext(see\n+      // the comment above near scheduler instantiation) that it uses to determine staleness. It\n+      // also happens to be the appcontext that will be passed to the graph nodes.\n       appContext.updateMutedActions(actionsForMute);\n+      if (rcaScheduler != null) {\n+        rcaScheduler.updateAppContextWithMutedActions(actionsForMute);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59497d70b36fc56e85a6e91d20294fde705bacd0"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTIyOTg0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/506#pullrequestreview-522922984", "createdAt": "2020-11-03T22:33:22Z", "commit": {"oid": "59497d70b36fc56e85a6e91d20294fde705bacd0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMjozMzoyMlrOHtC2oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMjozMzoyMlrOHtC2oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5NDcyMA==", "bodyText": "We will have to handle the case of changed role for the RCAScheduler. we can do the cleanup for a follow up PR. This is a bug fix, so I won't block this on the proper fix.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/506#discussion_r516994720", "createdAt": "2020-11-03T22:33:22Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -410,7 +409,15 @@ private boolean updateMutedComponents() {\n \n       LOG.info(\"Updating the muted graph nodes to : {}\", graphNodesForMute);\n       Stats.getInstance().updateMutedGraphNodes(graphNodesForMute);\n+      // We need to update muted actions in two places. One is in the controller which could\n+      // potentially serve as a snapshot when creating a new rca scheduler, and the other place\n+      // is in the rca scheduler itself. The scheduler maintains a snapshot of the appcontext(see\n+      // the comment above near scheduler instantiation) that it uses to determine staleness. It\n+      // also happens to be the appcontext that will be passed to the graph nodes.\n       appContext.updateMutedActions(actionsForMute);\n+      if (rcaScheduler != null) {\n+        rcaScheduler.updateAppContextWithMutedActions(actionsForMute);\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM4NzMzMg=="}, "originalCommit": {"oid": "59497d70b36fc56e85a6e91d20294fde705bacd0"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NTUzNDM1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/506#pullrequestreview-524553435", "createdAt": "2020-11-05T18:34:52Z", "commit": {"oid": "59497d70b36fc56e85a6e91d20294fde705bacd0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 810, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}