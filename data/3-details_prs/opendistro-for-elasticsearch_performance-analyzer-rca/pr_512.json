{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MTUzNjAy", "number": 512, "title": "Enable temperature profile", "bodyText": "Fixes #: Enable Node Temperature RCA. This PR enables the Node Temperature RCA on the cluster.\nDescription of changes: This commit enables the temperature Profile and refactors the code which removes the healthy/unhealthy context of the dimensional RCAs. Also adds comments and checks for values of Flow Units in the Individual RCAs & Group RCAs. Also change the use to ShardIndexKey instead of Shard ID and Index ID separately.\nTests: Tested on Docker. Sample Output:\nNode 1:\n[root@391ae37d34b6 tmp]# curl --url \"localhost:9600/_opendistro/_performanceanalyzer/rca?name=NodeTemperatureRca&local=true\" -XGET | python -m json.tool \n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   459  100   459    0     0   2244      0 --:--:-- --:--:-- --:--:--  2250\n{\n    \"NodeTemperatureRca\": [\n        {\n            \"CompactNodeSummary\": [\n                {\n                    \"CPU_Utilization_mean\": 0,\n                    \"CPU_Utilization_num_shards\": 0,\n                    \"CPU_Utilization_total\": 0.0,\n                    \"Heap_AllocRate_mean\": 0,\n                    \"Heap_AllocRate_num_shards\": 0,\n                    \"Heap_AllocRate_total\": 0.0,\n                    \"Shard_Size_In_Bytes_mean\": 3,\n                    \"Shard_Size_In_Bytes_num_shards\": 3,\n                    \"Shard_Size_In_Bytes_total\": 23449682.0,\n                    \"host_address\": \"172.29.0.2\",\n                    \"node_id\": \"SqlWFl9BR02Bz0gVcFS8qQ\"\n                }\n            ],\n            \"rca_name\": \"NodeTemperatureRca\",\n            \"state\": \"unknown\",\n            \"timestamp\": 1605582526245\n        }\n    ]\n}\n\n\nNode 2:\n[root@ef8562eeb2ed tmp]# curl --url \"localhost:9600/_opendistro/_performanceanalyzer/rca?name=NodeTemperatureRca&local=true\" -XGET | python -m json.tool \n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   459  100   459    0     0   9945      0 --:--:-- --:--:-- --:--:-- 10200\n{\n    \"NodeTemperatureRca\": [\n        {\n            \"CompactNodeSummary\": [\n                {\n                    \"CPU_Utilization_mean\": 0,\n                    \"CPU_Utilization_num_shards\": 0,\n                    \"CPU_Utilization_total\": 0.0,\n                    \"Heap_AllocRate_mean\": 0,\n                    \"Heap_AllocRate_num_shards\": 0,\n                    \"Heap_AllocRate_total\": 0.0,\n                    \"Shard_Size_In_Bytes_mean\": 5,\n                    \"Shard_Size_In_Bytes_num_shards\": 2,\n                    \"Shard_Size_In_Bytes_total\": 15918349.0,\n                    \"host_address\": \"172.29.0.3\",\n                    \"node_id\": \"XyinFukETiaOdwfSkGnM8w\"\n                }\n            ],\n            \"rca_name\": \"NodeTemperatureRca\",\n            \"state\": \"unknown\",\n            \"timestamp\": 1605582517354\n        }\n    ]\n}\n\nAllTemperatureDimensions have also been enabled.\nIf new tests are added, how long do the new ones take to complete\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-11-10T01:55:54Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/512", "merged": true, "mergeCommit": {"oid": "b167300b5e816408f689887c68843ce9bd99b17a"}, "closed": true, "closedAt": "2021-02-10T04:21:24Z", "author": {"login": "aditjind"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbP_blgBqjM5ODA5Njg0Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd4mF3yAFqTU4NzE2NzMzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c61d9fb8491b4e6de0fa2b353d67ba23e262552d", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/c61d9fb8491b4e6de0fa2b353d67ba23e262552d", "committedDate": "2020-11-10T21:01:23Z", "message": "Fixing UTs"}, "afterCommit": {"oid": "4f6ba05cc8a3adcb9c7e851d91871feead3ba587", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4f6ba05cc8a3adcb9c7e851d91871feead3ba587", "committedDate": "2020-11-10T21:09:31Z", "message": "Fixing UTs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b55debb1b9921da3b79228e78d9fde75b729ff1", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/8b55debb1b9921da3b79228e78d9fde75b729ff1", "committedDate": "2020-11-12T04:16:23Z", "message": "Adding Comments"}, "afterCommit": {"oid": "50ee030d20355810033fc25dfc1c764b1d79e21b", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/50ee030d20355810033fc25dfc1c764b1d79e21b", "committedDate": "2020-11-12T04:31:39Z", "message": "Enabling Temperature Profile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNzU1ODQ2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/512#pullrequestreview-533755846", "createdAt": "2020-11-18T18:28:34Z", "commit": {"oid": "3c1ce26c9bc6970c8577e9e9396fb29e385e5d89"}, "state": "DISMISSED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxODoyODozNFrOH18WzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxODozMTowMlrOH18dBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyNTQ1Mw==", "bodyText": "Awesome ! great comment", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/512#discussion_r526325453", "createdAt": "2020-11-18T18:28:34Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/temperature/NodeLevelDimensionalSummary.java", "diffHunk": "@@ -60,6 +62,14 @@\n     private final NodeLevelZoneSummary[] zoneProfiles;\n     private int numberOfShards;\n \n+    // Mean Temperature is a mean of the normalized heat of the resource used across shards on the node.\n+    // e.g. if there are 10 shards on the node and the normalized sum of the resource used", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c1ce26c9bc6970c8577e9e9396fb29e385e5d89"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyNTY1MQ==", "bodyText": "typo: this -> the ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/512#discussion_r526325651", "createdAt": "2020-11-18T18:28:56Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/temperature/NodeLevelDimensionalSummary.java", "diffHunk": "@@ -60,6 +62,14 @@\n     private final NodeLevelZoneSummary[] zoneProfiles;\n     private int numberOfShards;\n \n+    // Mean Temperature is a mean of the normalized heat of the resource used across shards on the node.\n+    // e.g. if there are 10 shards on the node and the normalized sum of the resource used\n+    // across shards is 33. The mean would be 3.3\n+    // This aim is the balance this parameter across the nodes and have as little delta", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c1ce26c9bc6970c8577e9e9396fb29e385e5d89"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyNjUwMg==", "bodyText": "This is a good change. Thanks a lot", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/512#discussion_r526326502", "createdAt": "2020-11-18T18:30:11Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/temperature/ShardStore.java", "diffHunk": "@@ -32,44 +31,26 @@\n     private static final Logger LOG = LogManager.getLogger(ShardStore.class);\n \n     /**\n-     * The key for the outer map is indexName. The key for inner map is the ShardID. Given an\n-     * indexName and shardId, a shard can be uniquely identified.\n-     *\n-     * <p>TODO: Try replace with 'IndexShardKey' after\n-     * https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/141\n-     * is merged.\n+     * The key for the map is indexShardKey Given an IndexShardKey a shard can be uniquely identified.\n      */\n-    Map<String, Map<Integer, ShardProfileSummary>> list;\n+    Map<IndexShardKey, ShardProfileSummary> shardToShardProfileMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c1ce26c9bc6970c8577e9e9396fb29e385e5d89"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyNzA0NQ==", "bodyText": "Let's use the new Object persisting mechanism", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/512#discussion_r526327045", "createdAt": "2020-11-18T18:31:02Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -915,13 +915,11 @@ private synchronized JsonElement readTemperatureProfileRca(String rca) {\n       // made from a data node, it returns a 400 saying it can only be queried from the elected\n       // master.\n       if (rca.equals(ClusterTemperatureRca.TABLE_NAME)) {\n-        Field<Integer> foreignKeyField = DSL.field(\n-            SQLiteQueryUtils.getPrimaryKeyColumnName(ResourceFlowUnit.RCA_TABLE_NAME),\n-            Integer.class);\n-        SelectJoinStep<Record> query = SQLiteQueryUtils\n-            .buildSummaryQuery(create, ClusterTemperatureSummary.TABLE_NAME,\n-                mostRecentRecord.get(primaryKeyField),\n-                foreignKeyField);\n+        SelectJoinStep<Record> query = SQLiteQueryUtils.buildSummaryQuery(\n+            create,\n+            ClusterTemperatureSummary.TABLE_NAME,\n+            mostRecentRecord.get(primaryKeyField),\n+            primaryKeyField);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c1ce26c9bc6970c8577e9e9396fb29e385e5d89"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f55bce8f9724b2c7b917ec62b2bf826db2c7d08", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0f55bce8f9724b2c7b917ec62b2bf826db2c7d08", "committedDate": "2021-02-09T19:38:15Z", "message": "Enabling Temperature Profile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59dc62d9f027bc0a403221aab75b42b0c57fc17d", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/59dc62d9f027bc0a403221aab75b42b0c57fc17d", "committedDate": "2021-02-09T19:38:16Z", "message": "Adding Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5f1f98bc20ca6cede60ddc85b757364e63a1b3a", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e5f1f98bc20ca6cede60ddc85b757364e63a1b3a", "committedDate": "2021-02-09T19:38:16Z", "message": "CheckStyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3208dfd9672e4215dd715af2f410def9eba21ff8", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3208dfd9672e4215dd715af2f410def9eba21ff8", "committedDate": "2021-02-09T19:38:16Z", "message": "Muting Cluster Temperature RCA"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d9c1b98ba380fdcbc4319e16b643ac9c009e4d7", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1d9c1b98ba380fdcbc4319e16b643ac9c009e4d7", "committedDate": "2021-02-09T19:38:16Z", "message": "Updating the Confs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f4e07627c2d3d68df1937154e584f0001007e8d", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/7f4e07627c2d3d68df1937154e584f0001007e8d", "committedDate": "2021-02-09T19:38:16Z", "message": "Adding Comments and Enabling Cluster Temperature RCA"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fe14dba880ad648c5be83c8ba6161f813f551fb", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0fe14dba880ad648c5be83c8ba6161f813f551fb", "committedDate": "2021-02-09T19:38:16Z", "message": "Disabling Cluster Temperature Profile & Enabling Node Temperature Profile"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c1ce26c9bc6970c8577e9e9396fb29e385e5d89", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3c1ce26c9bc6970c8577e9e9396fb29e385e5d89", "committedDate": "2020-11-17T03:15:13Z", "message": "Disabling Cluster Temperature Profile & Enabling Node Temperature Profile"}, "afterCommit": {"oid": "0fe14dba880ad648c5be83c8ba6161f813f551fb", "author": {"user": null}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0fe14dba880ad648c5be83c8ba6161f813f551fb", "committedDate": "2021-02-09T19:38:16Z", "message": "Disabling Cluster Temperature Profile & Enabling Node Temperature Profile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg3MTE2NTg4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/512#pullrequestreview-587116588", "createdAt": "2021-02-09T23:33:53Z", "commit": {"oid": "0fe14dba880ad648c5be83c8ba6161f813f551fb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wOVQyMzozMzo1M1rOIixJnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wOVQyMzozMzo1M1rOIixJnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzMyNzc3Mw==", "bodyText": "@yojs  : Can you add more details here? Let's create a separate Issue and work on it given this PR is old. @yujias0706", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/512#discussion_r573327773", "createdAt": "2021-02-09T23:33:53Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -915,13 +915,11 @@ private synchronized JsonElement readTemperatureProfileRca(String rca) {\n       // made from a data node, it returns a 400 saying it can only be queried from the elected\n       // master.\n       if (rca.equals(ClusterTemperatureRca.TABLE_NAME)) {\n-        Field<Integer> foreignKeyField = DSL.field(\n-            SQLiteQueryUtils.getPrimaryKeyColumnName(ResourceFlowUnit.RCA_TABLE_NAME),\n-            Integer.class);\n-        SelectJoinStep<Record> query = SQLiteQueryUtils\n-            .buildSummaryQuery(create, ClusterTemperatureSummary.TABLE_NAME,\n-                mostRecentRecord.get(primaryKeyField),\n-                foreignKeyField);\n+        SelectJoinStep<Record> query = SQLiteQueryUtils.buildSummaryQuery(\n+            create,\n+            ClusterTemperatureSummary.TABLE_NAME,\n+            mostRecentRecord.get(primaryKeyField),\n+            primaryKeyField);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyNzA0NQ=="}, "originalCommit": {"oid": "3c1ce26c9bc6970c8577e9e9396fb29e385e5d89"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg3MTY3MzMw", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/512#pullrequestreview-587167330", "createdAt": "2021-02-10T01:19:48Z", "commit": {"oid": "0fe14dba880ad648c5be83c8ba6161f813f551fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 814, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}