{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NTcxMjQ3", "number": 312, "title": "Adding Cache Max Size to Node Config Collector and adding Node Config Collector to ElasticSearchAnalysisGraph", "bodyText": "Issue #: #311\nDescription of changes:\n\nAdd the Cache MaxSize metric to Node Config Collector. The collector will cache these metric values inside the configCache (accessible via AppContext), which is how the cache decider will get access to them.\nAdd the Node Config Collector to Analysis Graph.\n\nTests: Unit Tests, tested on local stack.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-07-28T05:42:47Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/312", "merged": true, "mergeCommit": {"oid": "33a1d75401b4ea41e14ccbf8f8bb3bfb144dee9f"}, "closed": true, "closedAt": "2020-07-28T19:22:17Z", "author": {"login": "khushbr"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5PrgsAH2gAyNDU3NTcxMjQ3OjdjMzM5MDRlYTNjMzc3ZjcxYmQ4ODViNjM1NWMwZGZjY2I1Y2ZiYTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5bfAQAFqTQ1NjkzNjI0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7c33904ea3c377f71bd885b6355c0dfccb5cfba3", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/7c33904ea3c377f71bd885b6355c0dfccb5cfba3", "committedDate": "2020-07-28T05:35:52Z", "message": "Adding Cache Max Size to Node Config Collector and adding Node Config Collector to ElasticSearchAnalysisGraph"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2ODk5MTY1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/312#pullrequestreview-456899165", "createdAt": "2020-07-28T18:29:02Z", "commit": {"oid": "7c33904ea3c377f71bd885b6355c0dfccb5cfba3"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODoyOTowMlrOG4ZNTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODozMjo0OVrOG4ZV9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4NjQ0NQ==", "bodyText": "is there any specific reason to not follow the naming convention ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/312#discussion_r461786445", "createdAt": "2020-07-28T18:29:02Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/metrics/AllMetrics.java", "diffHunk": "@@ -194,9 +204,9 @@ public String toString() {\n     }\n \n     public static class Constants {\n-      public static final String FIELD_DATA_CACHE_NAME = \"Field_Data_Cache\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c33904ea3c377f71bd885b6355c0dfccb5cfba3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4NjYyMA==", "bodyText": "remove ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/312#discussion_r461786620", "createdAt": "2020-07-28T18:29:21Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/collector/NodeConfigCollector.java", "diffHunk": "@@ -69,6 +76,29 @@ private void collectQueueCapacity(MetricFlowUnit flowUnit) {\n     }\n   }\n \n+  private void collectCacheMaxSize(MetricFlowUnit cacheMaxSize) {\n+    double fieldDataCacheMaxSize = SQLParsingUtil.readDataFromSqlResult(cacheMaxSize.getData(),\n+            CACHE_TYPE.getField(), CacheType.FIELD_DATA_CACHE.toString(), MetricsDB.MAX);\n+    LOG.info(\"MOCHI, Field Data cache max size is {}\", fieldDataCacheMaxSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c33904ea3c377f71bd885b6355c0dfccb5cfba3"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4NjcyNQ==", "bodyText": "remove this line ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/312#discussion_r461786725", "createdAt": "2020-07-28T18:29:33Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/collector/NodeConfigCollector.java", "diffHunk": "@@ -69,6 +76,29 @@ private void collectQueueCapacity(MetricFlowUnit flowUnit) {\n     }\n   }\n \n+  private void collectCacheMaxSize(MetricFlowUnit cacheMaxSize) {\n+    double fieldDataCacheMaxSize = SQLParsingUtil.readDataFromSqlResult(cacheMaxSize.getData(),\n+            CACHE_TYPE.getField(), CacheType.FIELD_DATA_CACHE.toString(), MetricsDB.MAX);\n+    LOG.info(\"MOCHI, Field Data cache max size is {}\", fieldDataCacheMaxSize);\n+\n+    if (!Double.isNaN(fieldDataCacheMaxSize)) {\n+      configResult.put(ResourceUtil.FIELD_DATA_CACHE_MAX_SIZE, fieldDataCacheMaxSize);\n+    }\n+    else {\n+      LOG.error(\"Field Data cache max size is NaN\");\n+    }\n+\n+    double shardRequestCacheMaxSize = SQLParsingUtil.readDataFromSqlResult(cacheMaxSize.getData(),\n+            CACHE_TYPE.getField(), CacheType.SHARD_REQUEST_CACHE.toString(), MetricsDB.MAX);\n+    LOG.info(\"MOCHI, Shard Request cache max size is {}\", shardRequestCacheMaxSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c33904ea3c377f71bd885b6355c0dfccb5cfba3"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc4ODY2MQ==", "bodyText": "can we also add the node config cluster RCA altogether ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/312#discussion_r461788661", "createdAt": "2020-07-28T18:32:49Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ElasticSearchAnalysisGraph.java", "diffHunk": "@@ -180,6 +183,19 @@ public void construct() {\n     queueHealthDecider.addTag(TAG_LOCUS, LOCUS_MASTER_NODE);\n     queueHealthDecider.addAllUpstreams(Collections.singletonList(queueRejectionClusterRca));\n \n+    // Node Config Collector\n+    ThreadPool_QueueCapacity queueCapacity = new ThreadPool_QueueCapacity();\n+    queueCapacity.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(queueCapacity);\n+\n+    Cache_Max_Size cacheMaxSize =  new Cache_Max_Size(EVALUATION_INTERVAL_SECONDS);\n+    cacheMaxSize.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(cacheMaxSize);\n+\n+    NodeConfigCollector nodeConfigCollector = new NodeConfigCollector(RCA_PERIOD, queueCapacity, cacheMaxSize);\n+    nodeConfigCollector.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    nodeConfigCollector.addAllUpstreams(Arrays.asList(threadpool_RejectedReqs, cacheMaxSize));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c33904ea3c377f71bd885b6355c0dfccb5cfba3"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTA3MjM2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/312#pullrequestreview-456907236", "createdAt": "2020-07-28T18:40:18Z", "commit": {"oid": "7c33904ea3c377f71bd885b6355c0dfccb5cfba3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0MDoxOFrOG4Zmxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0MDoxOFrOG4Zmxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5Mjk2Nw==", "bodyText": "I thought cache max size was in bytes.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/312#discussion_r461792967", "createdAt": "2020-07-28T18:40:18Z", "author": {"login": "sruti1312"}, "path": "src/main/proto/inter_node_rpc_service.proto", "diffHunk": "@@ -94,6 +94,7 @@ enum MetricEnum {\n   // cache\n   CACHE_EVICTION = 10 [(additional_fields).name = \"cache eviction\", (additional_fields).description = \"cache eviction count\"];\n   CACHE_HIT = 11 [(additional_fields).name = \"cache hit\", (additional_fields).description = \"cache hit count\"];\n+  CACHE_MAX_SIZE = 12 [(additional_fields).name = \"cache max size\", (additional_fields).description = \"max cache size in KB\"];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c33904ea3c377f71bd885b6355c0dfccb5cfba3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0d600d3a3762f675ea714134b4deec40c6c77a3", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a0d600d3a3762f675ea714134b4deec40c6c77a3", "committedDate": "2020-07-28T18:52:02Z", "message": "Addressing the CR comments, adding NodeConfigClusterCollector to Analysis Graph and removing Redundant log statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b370348396b7655826904532b9edac34fd0909b", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/6b370348396b7655826904532b9edac34fd0909b", "committedDate": "2020-07-28T19:03:11Z", "message": "Address the PR comment, updating the resource description in .proto"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTI4MTQw", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/312#pullrequestreview-456928140", "createdAt": "2020-07-28T19:10:03Z", "commit": {"oid": "6b370348396b7655826904532b9edac34fd0909b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTM2MjQ2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/312#pullrequestreview-456936246", "createdAt": "2020-07-28T19:21:04Z", "commit": {"oid": "6b370348396b7655826904532b9edac34fd0909b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 829, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}