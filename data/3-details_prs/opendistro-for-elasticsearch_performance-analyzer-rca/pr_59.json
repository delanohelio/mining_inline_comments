{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyODk1NjA5", "number": 59, "title": "Refactor networking layer", "bodyText": "Issue #, if available:\n#58\nDescription of changes:\nThe PR contains these main changes.\n\n\nChange the network layer implementation to use the threadpool pattern.\nThe PR introduces 4 new networking components. Sender, Receiver pair for sending and receiving flowunits and another sender, receiver pair for sending and receiving subscriptions. Each of these components encapsulates a queue, a threadpool, and a task. The task  is executed on a thread in the threadpool periodically. The task first drains the queue out and processes the messages dequeued.\nThe interfaces that were used previously are replaced by enqueue operations. The wirehopper now simply enqueues flow units it needs to send instead of actually sending the message itself. And when wirehopper needs to get values from the network, it reads it off of a queue that the receiver component wrote to. Similarly for sending subscriptions and receiving subscription requests, there are components that do so by enqueuing and dequeuing rather than operate on them directly.\n\n\nAdd SpotBugs to run static code analysis on the codebase\nCurrently, the codebase has no static checking configured, this will help catch issues earlier in the development process. The ignoreFailures value is set to true because there are violations by code not related to RCA.\n\n\nLog metrics for certain RCA events\nCurrently, we don't have any metrics on RCA health. This PR adds a couple of basic ones around networking.\n\n\nMake cross thread references thread safe\nSome of the objects were being updated in one thread and read in another without making sure the updates were visible. This change will make sure the updates to such references are made visible to another thread reading.\n\n\nPrevent scheduler from restarting if stopped due to an error\nCurrently, if the scheduler stopped while RCA was enabled, the nanny would go and resurrect the scheduler. If the scheduler had stopped due to an exception, the nanny resurrecting the scheduler will make it happen in a loop. This change will make sure that we don't restart if the scheduler was stopped due to an exception.\n\n\nTests:\nTested on a docker (2 nodes) running OpenDistroForElasticsearch.\nEnsured that:\n\nRCA API returns the HighHeapUsageClusterRca correctly.\n\ncurl localhost:9600/_opendistro/_performanceanalyzer/rca\n{\"HighHeapUsageClusterRca\":[[1,\"1579042863995\",\"healthy\"],[2,\"1579043018074\",\"healthy\"],[3,\"1579043078004\",\"healthy\"],[4,\"1579043137931\",\"healthy\"],[5,\"1579043197861\",\"healthy\"],[6,\"1579043257794\",\"healthy\"],[7,\"1579043317725\",\"healthy\"],[8,\"1579043377658\",\"healthy\"],[9,\"1579043437590\",\"healthy\"],[10,\"1579043497521\",\"healthy\"],[11,\"1579043557454\",\"healthy\"],[12,\"1579043617385\",\"healthy\"],[13,\"1579043677317\",\"healthy\"],[14,\"1579043737252\",\"healthy\"],[15,\"1579043797182\",\"healthy\"],[16,\"1579043857114\",\"healthy\"],[17,\"1579043917049\",\"healthy\"],[18,\"1579043976977\",\"healthy\"],[19,\"1579044036910\",\"healthy\"],[20,\"1579044096842\",\"healthy\"],[21,\"1579044156774\",\"healthy\"],[22,\"1579044216706\",\"healthy\"],[23,\"1579044276638\",\"healthy\"],[24,\"1579044336570\",\"healthy\"],[25,\"1579044519123\",\"healthy\"],[26,\"1579044647711\",\"healthy\"],[27,\"1579045674390\",\"healthy\"],[28,\"1579045734321\",\"healthy\"],[29,\"1579045794252\",\"healthy\"],[30,\"1579045854183\",\"healthy\"],[31,\"1579045914114\",\"healthy\"],[32,\"1579045974044\",\"healthy\"],[33,\"1579046033975\",\"healthy\"],[34,\"1579046093906\",\"healthy\"],[35,\"1579046153837\",\"healthy\"],[36,\"1579046213767\",\"healthy\"],[37,\"1579046273699\",\"healthy\"],[38,\"1579046333628\",\"healthy\"],[39,\"1579046393566\",\"healthy\"]]}\n\n\nPerfTop shows graphs correctly.\n\nCode coverage percentage for this patch:\n52% line coverage, 44% branch coverage.\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-01-15T00:02:44Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59", "merged": true, "mergeCommit": {"oid": "5fa7d5f0ddcb492d04c8a96953a6f0fce6df470f"}, "closed": true, "closedAt": "2020-01-22T23:19:14Z", "author": {"login": "ktkrg"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbyAtwLgH2gAyMzYyODk1NjA5OmU2MjJlMWZmMjU4NTYyYjE4MjIwZjZkOTcxYWVmMTU4ZTgzYzE1Njc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8-NUlgFqTM0Njk3MTg1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e622e1ff258562b18220f6d971aef158e83c1567", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e622e1ff258562b18220f6d971aef158e83c1567", "committedDate": "2019-12-19T22:01:07Z", "message": "Make node class generic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d3cde28ff1fe6ce6d5bbd93ee1cfa04532c0c1f", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1d3cde28ff1fe6ce6d5bbd93ee1cfa04532c0c1f", "committedDate": "2019-12-19T23:54:55Z", "message": "Remove duplicated task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "530596e16d7b6668a5c9f2f151e5abca36d77f51", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/530596e16d7b6668a5c9f2f151e5abca36d77f51", "committedDate": "2019-12-20T00:09:14Z", "message": "Change graph nodes in the graph to use typed version of the Rca class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60bf5e1e7f6ec6ca52ec58a27d2156fdacb1c6e2", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/60bf5e1e7f6ec6ca52ec58a27d2156fdacb1c6e2", "committedDate": "2020-01-06T18:34:37Z", "message": "Merge branch 'master' of github.com:opendistro-for-elasticsearch/performance-analyzer-rca into generic-node-type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35f21ea841f2e4a2f0f1c24ab5e8f633c70ddabb", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/35f21ea841f2e4a2f0f1c24ab5e8f633c70ddabb", "committedDate": "2020-01-06T19:28:36Z", "message": "Added documentation and split the generateFlowUnitsFromLocal method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f186c4051880551cf050da28adf71021fba376fe", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f186c4051880551cf050da28adf71021fba376fe", "committedDate": "2020-01-10T04:13:57Z", "message": "Merge branch 'master' of github.com:opendistro-for-elasticsearch/performance-analyzer-rca into thr_safe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "924fe7eee86de69415e65f028a764d4e3e0f9add", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/924fe7eee86de69415e65f028a764d4e3e0f9add", "committedDate": "2020-01-14T02:34:30Z", "message": "Change execution model of the networking layer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c0d1a0ff6db05315fc7d7c82b7a2d1e2c9f9fc6", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/5c0d1a0ff6db05315fc7d7c82b7a2d1e2c9f9fc6", "committedDate": "2020-01-14T03:18:55Z", "message": "Merge branch 'master' of github.com:opendistro-for-elasticsearch/performance-analyzer-rca into thr_safe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0331de6ff3434cd8b4e04b3171f391be3abad5c1", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0331de6ff3434cd8b4e04b3171f391be3abad5c1", "committedDate": "2020-01-14T19:01:18Z", "message": "Refactor networking code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f661ef63756ae55282de4cb5c14f2a6c2ee2dd61", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f661ef63756ae55282de4cb5c14f2a6c2ee2dd61", "committedDate": "2020-01-14T22:47:16Z", "message": "Handle stop gracefully for the network activities"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b5e87a91406d1baf35ee8a76c8dedae9c9f86081", "committedDate": "2020-01-14T22:56:24Z", "message": "Fix unit test and undo date format change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyOTI2MDE4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#pullrequestreview-342926018", "createdAt": "2020-01-15T00:28:40Z", "commit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMDoyODo0MFrOFdqHhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwMDo1MzozNVrOFdqfqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0MzA3Ng==", "bodyText": "Let's add a line of comment for public method", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r366643076", "createdAt": "2020-01-15T00:28:40Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCConnectionManager.java", "diffHunk": "@@ -43,24 +47,37 @@\n   private static final Logger LOG = LogManager.getLogger(GRPCConnectionManager.class);\n   private static final String EMPTY_STRING = \"\";\n \n-  private Map<String, ManagedChannel> perHostChannelMap = new HashMap<>();\n-  private Map<String, InterNodeRpcServiceGrpc.InterNodeRpcServiceStub> perHostClientStubMap =\n-      new HashMap<>();\n+  private ConcurrentMap<String, AtomicReference<ManagedChannel>> perHostChannelMap =\n+      new ConcurrentHashMap<>();\n+  private ConcurrentMap<String, AtomicReference<InterNodeRpcServiceStub>> perHostClientStubMap =\n+      new ConcurrentHashMap<>();\n \n   private final boolean shouldUseHttps;\n \n   public GRPCConnectionManager(final boolean shouldUseHttps) {\n     this.shouldUseHttps = shouldUseHttps;\n   }\n \n-  public InterNodeRpcServiceGrpc.InterNodeRpcServiceStub getClientStubForHost(\n+  public InterNodeRpcServiceStub getClientStubForHost(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0MzQ4Mg==", "bodyText": "For a synchronized method, can we add the callers/threads ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r366643482", "createdAt": "2020-01-15T00:30:03Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCConnectionManager.java", "diffHunk": "@@ -43,24 +47,37 @@\n   private static final Logger LOG = LogManager.getLogger(GRPCConnectionManager.class);\n   private static final String EMPTY_STRING = \"\";\n \n-  private Map<String, ManagedChannel> perHostChannelMap = new HashMap<>();\n-  private Map<String, InterNodeRpcServiceGrpc.InterNodeRpcServiceStub> perHostClientStubMap =\n-      new HashMap<>();\n+  private ConcurrentMap<String, AtomicReference<ManagedChannel>> perHostChannelMap =\n+      new ConcurrentHashMap<>();\n+  private ConcurrentMap<String, AtomicReference<InterNodeRpcServiceStub>> perHostClientStubMap =\n+      new ConcurrentHashMap<>();\n \n   private final boolean shouldUseHttps;\n \n   public GRPCConnectionManager(final boolean shouldUseHttps) {\n     this.shouldUseHttps = shouldUseHttps;\n   }\n \n-  public InterNodeRpcServiceGrpc.InterNodeRpcServiceStub getClientStubForHost(\n+  public InterNodeRpcServiceStub getClientStubForHost(\n       final String remoteHost) {\n     if (perHostClientStubMap.containsKey(remoteHost)) {\n-      return perHostClientStubMap.get(remoteHost);\n+      return perHostClientStubMap.get(remoteHost).get();\n     }\n+    return addOrUpdateClientStubForHost(remoteHost);\n+  }\n \n-    final InterNodeRpcServiceGrpc.InterNodeRpcServiceStub stub = buildStubForHost(remoteHost);\n-    perHostClientStubMap.put(remoteHost, stub);\n+  private synchronized InterNodeRpcServiceStub addOrUpdateClientStubForHost(final String remoteHost) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0NTkyMg==", "bodyText": "Is this comment relevant ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r366645922", "createdAt": "2020-01-15T00:40:06Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetClient.java", "diffHunk": "@@ -83,27 +103,36 @@ public void flushStream(final String remoteHost) {\n   }\n \n   private void closeAllDataStreams() {\n-    for (Map.Entry<String, StreamObserver<FlowUnitMessage>> entry :\n+    for (Map.Entry<String, AtomicReference<StreamObserver<FlowUnitMessage>>> entry :\n         perHostOpenDataStreamMap.entrySet()) {\n       LOG.debug(\"Closing stream for host: {}\", entry.getKey());\n       // Sending an onCompleted should trigger the subscriber's node state manager\n       // and cause this host to be put under observation.f\n-      entry.getValue().onCompleted();\n+      entry.getValue().get().onCompleted();\n       perHostOpenDataStreamMap.remove(entry.getKey());\n     }\n   }\n \n   private StreamObserver<FlowUnitMessage> getDataStreamForHost(\n       final String remoteHost, final StreamObserver<PublishResponse> serverResponseStream) {\n     if (perHostOpenDataStreamMap.containsKey(remoteHost)) {\n-      return perHostOpenDataStreamMap.get(remoteHost);\n+      return perHostOpenDataStreamMap.get(remoteHost).get();\n     }\n+    return addOrUpdateDataStreamForHost(remoteHost, serverResponseStream);\n+  }\n \n+  private synchronized StreamObserver<FlowUnitMessage> addOrUpdateDataStreamForHost(\n+      final String remoteHost, final StreamObserver<PublishResponse> serverResponseStream) {\n     InterNodeRpcServiceGrpc.InterNodeRpcServiceStub stub =\n         connectionManager.getClientStubForHost(remoteHost);\n     final StreamObserver<FlowUnitMessage> dataStream = stub.publish(serverResponseStream);\n-\n-    perHostOpenDataStreamMap.put(remoteHost, dataStream);\n+    if (perHostOpenDataStreamMap.get(remoteHost) == null) {\n+      // happens-before: updating AtomicReference.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0OTI1OQ==", "bodyText": "can we use perHostOpenDataStreamMap.getOrDefault(remoteHost, new AtomicReference<>(dataStream)).set(dataStream) ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r366649259", "createdAt": "2020-01-15T00:53:35Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetClient.java", "diffHunk": "@@ -83,27 +103,36 @@ public void flushStream(final String remoteHost) {\n   }\n \n   private void closeAllDataStreams() {\n-    for (Map.Entry<String, StreamObserver<FlowUnitMessage>> entry :\n+    for (Map.Entry<String, AtomicReference<StreamObserver<FlowUnitMessage>>> entry :\n         perHostOpenDataStreamMap.entrySet()) {\n       LOG.debug(\"Closing stream for host: {}\", entry.getKey());\n       // Sending an onCompleted should trigger the subscriber's node state manager\n       // and cause this host to be put under observation.f\n-      entry.getValue().onCompleted();\n+      entry.getValue().get().onCompleted();\n       perHostOpenDataStreamMap.remove(entry.getKey());\n     }\n   }\n \n   private StreamObserver<FlowUnitMessage> getDataStreamForHost(\n       final String remoteHost, final StreamObserver<PublishResponse> serverResponseStream) {\n     if (perHostOpenDataStreamMap.containsKey(remoteHost)) {\n-      return perHostOpenDataStreamMap.get(remoteHost);\n+      return perHostOpenDataStreamMap.get(remoteHost).get();\n     }\n+    return addOrUpdateDataStreamForHost(remoteHost, serverResponseStream);\n+  }\n \n+  private synchronized StreamObserver<FlowUnitMessage> addOrUpdateDataStreamForHost(\n+      final String remoteHost, final StreamObserver<PublishResponse> serverResponseStream) {\n     InterNodeRpcServiceGrpc.InterNodeRpcServiceStub stub =\n         connectionManager.getClientStubForHost(remoteHost);\n     final StreamObserver<FlowUnitMessage> dataStream = stub.publish(serverResponseStream);\n-\n-    perHostOpenDataStreamMap.put(remoteHost, dataStream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNTM3NjU4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#pullrequestreview-343537658", "createdAt": "2020-01-15T21:36:18Z", "commit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "state": "COMMENTED", "comments": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMTozNjoxOFrOFeHNXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMjozMzowNVrOFeIoDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExOTcxMQ==", "bodyText": "Should we be more specific and say Network buffers ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367119711", "createdAt": "2020-01-15T21:36:18Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/collectors/StatExceptionCode.java", "diffHunk": "@@ -33,6 +33,8 @@\n   READER_PARSER_ERROR(\"ReaderParserError\"),\n   READER_RESTART_PROCESSING(\"ReaderRestartProcessing\"),\n   RCA_SCHEDULER_RESTART_PROCESSING(\"RCASchedulerRestartProcessing\"),\n+  RCA_NETWORK_ERROR(\"RcaNetworkError\"),\n+  RCA_BUFFER_FULL_ERROR(\"RcaBufferFullError\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyMDI0MQ==", "bodyText": "I know we haven't been doing it, but we should add a comment for what the members are used for ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367120241", "createdAt": "2020-01-15T21:37:39Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCConnectionManager.java", "diffHunk": "@@ -43,24 +47,37 @@\n   private static final Logger LOG = LogManager.getLogger(GRPCConnectionManager.class);\n   private static final String EMPTY_STRING = \"\";\n \n-  private Map<String, ManagedChannel> perHostChannelMap = new HashMap<>();\n-  private Map<String, InterNodeRpcServiceGrpc.InterNodeRpcServiceStub> perHostClientStubMap =\n-      new HashMap<>();\n+  private ConcurrentMap<String, AtomicReference<ManagedChannel>> perHostChannelMap =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyMTk3NA==", "bodyText": "If we throw an exception here and don't send the subscription, will we retry later. Can we add a comment to that effect ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367121974", "createdAt": "2020-01-15T21:41:47Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetClient.java", "diffHunk": "@@ -41,26 +48,39 @@ public NetClient(final GRPCConnectionManager connectionManager) {\n     this.connectionManager = connectionManager;\n   }\n \n-  private Map<String, StreamObserver<FlowUnitMessage>> perHostOpenDataStreamMap = new HashMap<>();\n+  private ConcurrentMap<String, AtomicReference<StreamObserver<FlowUnitMessage>>> perHostOpenDataStreamMap =\n+      new ConcurrentHashMap<>();\n \n   public void subscribe(\n       final String remoteHost,\n       final SubscribeMessage subscribeMessage,\n       StreamObserver<SubscribeResponse> serverResponseStream) {\n     LOG.debug(\"Trying to send intent message to {}\", remoteHost);\n-    connectionManager\n-        .getClientStubForHost(remoteHost)\n-        .subscribe(subscribeMessage, serverResponseStream);\n+    try {\n+      connectionManager\n+          .getClientStubForHost(remoteHost)\n+          .subscribe(subscribeMessage, serverResponseStream);\n+    } catch (StatusRuntimeException sre) {\n+      LOG.error(\"Encountered an error trying to subscribe. Status: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyNTUxOQ==", "bodyText": "Lets add the constant to RcaConsts class", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367125519", "createdAt": "2020-01-15T21:49:57Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -313,16 +342,35 @@ private void start() {\n       Queryable db = new MetricsDBProvider();\n       ThresholdMain thresholdMain = new ThresholdMain(RcaConsts.THRESHOLDS_PATH, rcaConf);\n       Persistable persistable = PersistenceFactory.create(rcaConf);\n+      ThreadFactory networkThreadFactory =\n+          new ThreadFactoryBuilder().setNameFormat(\"rca-net-%d\").setDaemon(true).build();\n+      networkActivitiesThreadPool = new ScheduledThreadPoolExecutor(\n+          3, networkThreadFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyNzIxMw==", "bodyText": "It might make sense to increase that timeout ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367127213", "createdAt": "2020-01-15T21:53:59Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -338,16 +386,60 @@ private void start() {\n     }\n   }\n \n+  private SubscriptionReceiver buildSubscriptionReceiver(\n+      final ScheduledExecutorService subscriptionReceiverThreadPool) {\n+    NetworkRequestQueue<CompositeSubscribeRequest> rxQ = new NetworkRequestQueue<>();\n+    SubscriptionReceiverTask subscriptionReceiverTask =\n+        new SubscriptionReceiverTask(subscriptionManager, rxQ);\n+    return new SubscriptionReceiver(rxQ, subscriptionReceiverThreadPool, subscriptionReceiverTask);\n+  }\n+\n+  private SubscriptionSender buildSubscriptionSender(\n+      final ScheduledExecutorService subscriptionSendThreadPool) {\n+    NetworkRequestQueue<IntentMsg> txBroadcastQ = new NetworkRequestQueue<>();\n+    NetworkRequestQueue<UnicastIntentMsg> txUnicastQ = new NetworkRequestQueue<>();\n+    SubscriptionSendTask subscriptionSendTask = new SubscriptionSendTask(subscriptionManager,\n+        txBroadcastQ, txUnicastQ, rcaNetClient);\n+    return new SubscriptionSender(txBroadcastQ, txUnicastQ,\n+        subscriptionSendTask, subscriptionSendThreadPool);\n+  }\n+\n+  private Sender buildSender(final ScheduledExecutorService sendThreadPool) {\n+    NetworkRequestQueue<DataMsg> txQ = new NetworkRequestQueue<>();\n+    SendTask sendTask = new SendTask(subscriptionManager, txQ, rcaNetClient);\n+    return new Sender(txQ, sendTask, sendThreadPool);\n+  }\n+\n+  private Receiver buildReceiver(final ScheduledExecutorService recvThreadPool) {\n+    NetworkRequestQueue<FlowUnitMessage> rxQ = new NetworkRequestQueue<>();\n+    ReceivedFlowUnitStore receivedFlowUnitStore = new ReceivedFlowUnitStore();\n+    ReceiveTask receiveTask = new ReceiveTask(rxQ, receivedFlowUnitStore, nodeStateManager);\n+\n+    return new Receiver(rxQ, recvThreadPool, receivedFlowUnitStore, receiveTask);\n+  }\n+\n   private void stop() {\n     rcaScheduler.shutdown();\n     rcaNetClient.shutdown();\n     rcaNetServer.shutdown();\n+    networkActivitiesThreadPool.shutdown();\n+    try {\n+      networkActivitiesThreadPool.awaitTermination(1, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyNzg1Ng==", "bodyText": "Is this really an exception ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367127856", "createdAt": "2020-01-15T21:55:37Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -338,16 +386,60 @@ private void start() {\n     }\n   }\n \n+  private SubscriptionReceiver buildSubscriptionReceiver(\n+      final ScheduledExecutorService subscriptionReceiverThreadPool) {\n+    NetworkRequestQueue<CompositeSubscribeRequest> rxQ = new NetworkRequestQueue<>();\n+    SubscriptionReceiverTask subscriptionReceiverTask =\n+        new SubscriptionReceiverTask(subscriptionManager, rxQ);\n+    return new SubscriptionReceiver(rxQ, subscriptionReceiverThreadPool, subscriptionReceiverTask);\n+  }\n+\n+  private SubscriptionSender buildSubscriptionSender(\n+      final ScheduledExecutorService subscriptionSendThreadPool) {\n+    NetworkRequestQueue<IntentMsg> txBroadcastQ = new NetworkRequestQueue<>();\n+    NetworkRequestQueue<UnicastIntentMsg> txUnicastQ = new NetworkRequestQueue<>();\n+    SubscriptionSendTask subscriptionSendTask = new SubscriptionSendTask(subscriptionManager,\n+        txBroadcastQ, txUnicastQ, rcaNetClient);\n+    return new SubscriptionSender(txBroadcastQ, txUnicastQ,\n+        subscriptionSendTask, subscriptionSendThreadPool);\n+  }\n+\n+  private Sender buildSender(final ScheduledExecutorService sendThreadPool) {\n+    NetworkRequestQueue<DataMsg> txQ = new NetworkRequestQueue<>();\n+    SendTask sendTask = new SendTask(subscriptionManager, txQ, rcaNetClient);\n+    return new Sender(txQ, sendTask, sendThreadPool);\n+  }\n+\n+  private Receiver buildReceiver(final ScheduledExecutorService recvThreadPool) {\n+    NetworkRequestQueue<FlowUnitMessage> rxQ = new NetworkRequestQueue<>();\n+    ReceivedFlowUnitStore receivedFlowUnitStore = new ReceivedFlowUnitStore();\n+    ReceiveTask receiveTask = new ReceiveTask(rxQ, receivedFlowUnitStore, nodeStateManager);\n+\n+    return new Receiver(rxQ, recvThreadPool, receivedFlowUnitStore, receiveTask);\n+  }\n+\n   private void stop() {\n     rcaScheduler.shutdown();\n     rcaNetClient.shutdown();\n     rcaNetServer.shutdown();\n+    networkActivitiesThreadPool.shutdown();\n+    try {\n+      networkActivitiesThreadPool.awaitTermination(1, TimeUnit.SECONDS);\n+    } catch (InterruptedException e) {\n+      LOG.warn(\"Awaiting termination interrupted. {}\", e.getCause(), e);\n+      networkActivitiesThreadPool.shutdownNow();\n+    }\n+    flowUnitSender.stop();\n+    flowUnitReceiver.stop();\n+    subscriptionSender.stop();\n+    subscriptionReceiver.stop();\n     removeRcaRequestHandler();\n   }\n \n   private void restart() {\n     stop();\n     start();\n+    StatsCollector.instance().logException(StatExceptionCode.RCA_SCHEDULER_RESTART_PROCESSING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 213}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyODAyOA==", "bodyText": "Can we add doc comments for the class ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367128028", "createdAt": "2020-01-15T21:55:57Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/messages/UnicastIntentMsg.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.messages;\n+\n+import java.util.Map;\n+\n+public class UnicastIntentMsg extends IntentMsg {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzNjUxNg==", "bodyText": "Do you think instead of making it a program constant, we make it part of rca.conf ? So that changing this does not require a code deployment just a PA restart", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367136516", "createdAt": "2020-01-15T22:16:56Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/NetworkRequestQueue.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n+\n+import com.google.common.collect.ImmutableList;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ArrayBlockingQueue;\n+import java.util.concurrent.BlockingQueue;\n+\n+/**\n+ * Class that represents a custom bounded and concurrent queue.\n+ */\n+public class NetworkRequestQueue<T> {\n+\n+  private static final int DEFAULT_MAX_Q_SIZE = 200;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzNjgzMQ==", "bodyText": "Do we want to remove all the happens-before comments ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367136831", "createdAt": "2020-01-15T22:17:39Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/NetworkRequestQueue.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n+\n+import com.google.common.collect.ImmutableList;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ArrayBlockingQueue;\n+import java.util.concurrent.BlockingQueue;\n+\n+/**\n+ * Class that represents a custom bounded and concurrent queue.\n+ */\n+public class NetworkRequestQueue<T> {\n+\n+  private static final int DEFAULT_MAX_Q_SIZE = 200;\n+\n+  private final BlockingQueue<T> messageQueue;\n+\n+  public NetworkRequestQueue() {\n+    this(DEFAULT_MAX_Q_SIZE);\n+  }\n+\n+  public NetworkRequestQueue(final int queueSize) {\n+    this.messageQueue = new ArrayBlockingQueue<>(queueSize);\n+  }\n+\n+  /**\n+   * Adds a message to the queue if not full.\n+   *\n+   * @param message The message that needs to be enqueued..\n+   * @return true if successfully enqueued, false otherwise.\n+   */\n+  public boolean offer(final T message) {\n+    // happens-before (java.util.concurrent collection)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzNzY5Nw==", "bodyText": "Shouldn't we drain out all the queues, otherwise at restart we will send a bunch of stale messages in the send queue", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367137697", "createdAt": "2020-01-15T22:19:45Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/Receiver.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.FlowUnitMessage;\n+import com.google.common.collect.ImmutableList;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Networking component that handles receiving of flow units.\n+ */\n+public class Receiver {\n+\n+  private static final Logger LOG = LogManager.getLogger(Receiver.class);\n+  private final NetworkRequestQueue<FlowUnitMessage> rxQ;\n+  private final ScheduledExecutorService threadPool;\n+  private final ReceivedFlowUnitStore receivedFlowUnitStore;\n+  private final ReceiveTask recvTask;\n+\n+  public Receiver(\n+      final NetworkRequestQueue<FlowUnitMessage> rxQ,\n+      final ScheduledExecutorService threadPool,\n+      final ReceivedFlowUnitStore receivedFlowUnitStore,\n+      final ReceiveTask recvTask) {\n+    this.rxQ = rxQ;\n+    this.threadPool = threadPool;\n+    this.receivedFlowUnitStore = receivedFlowUnitStore;\n+    this.recvTask = recvTask;\n+  }\n+\n+  public void start() {\n+    threadPool.scheduleAtFixedRate(recvTask, 0, 250, TimeUnit.MILLISECONDS);\n+  }\n+\n+  public void stop() {\n+    // drain out the queue to stop processing.\n+    rxQ.drain();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0MTM3Nw==", "bodyText": "doc comment for the class", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367141377", "createdAt": "2020-01-15T22:28:58Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/SubscriptionManager.java", "diffHunk": "@@ -15,64 +15,36 @@\n \n package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n \n-import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.SubscribeMessage;\n-import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.SubscribeResponse;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.SubscribeResponse.SubscriptionStatus;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.GRPCConnectionManager;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n-import io.grpc.stub.StreamObserver;\n-import java.util.HashMap;\n+import com.google.common.collect.ImmutableSet;\n+import java.util.Collections;\n import java.util.HashSet;\n-import java.util.List;\n-import java.util.Map;\n import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n public class SubscriptionManager {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0MTgwNQ==", "bodyText": "For dumpStats, should we also say the amount of payload each queue has ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367141805", "createdAt": "2020-01-15T22:30:07Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/SubscriptionManager.java", "diffHunk": "@@ -110,30 +70,36 @@ public SubscriptionStatus addSubscriber(\n \n     Set<String> currentSubscribers = subscriberMap.getOrDefault(graphNode, new HashSet<>());\n     currentSubscribers.add(subscriberHostAddress);\n+    // happens-before: update to a java.util.concurrent collection. Updated value will be visible\n+    // to subsequent reads.\n     subscriberMap.put(graphNode, currentSubscribers);\n \n     LOG.debug(\"locus matched. Added subscriber {} for {}\", subscriberHostAddress, graphNode);\n     return SubscriptionStatus.SUCCESS;\n   }\n \n   public boolean isNodeSubscribed(final String graphNode) {\n+    // happens-before: reading from a java.util.concurrent collection which guarantees read\n+    // reflects most recent completed update.\n     return subscriberMap.containsKey(graphNode);\n   }\n \n-  public Set<String> getSubscribersFor(final String graphNode) {\n-    return subscriberMap.getOrDefault(graphNode, new HashSet<>());\n+  public ImmutableSet<String> getSubscribersFor(final String graphNode) {\n+    // happens-before: ImmutableSet - final field semantics. Reading from java.util.concurrent\n+    // collection.\n+    return ImmutableSet.copyOf(subscriberMap.getOrDefault(graphNode, new HashSet<>()));\n   }\n \n-  private void addPublisher(final String graphNode, final String publisherHostAddress) {\n-    LOG.debug(\"Added publisher: {} for graphNode: {}\", publisherHostAddress, graphNode);\n+  public synchronized void addPublisher(final String graphNode, final String publisherHostAddress) {\n+    LOG.info(\"Added publisher: {} for graphNode: {}\", publisherHostAddress, graphNode);\n \n     final Set<String> currentPublishers = publisherMap.getOrDefault(graphNode, new HashSet<>());\n     currentPublishers.add(publisherHostAddress);\n     publisherMap.put(graphNode, currentPublishers);\n   }\n \n   public void dumpStats() {\n-    LOG.debug(\"Subbscribers: {}\", subscriberMap);\n+    LOG.debug(\"Subscribers: {}\", subscriberMap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0MjIxNg==", "bodyText": "How did we arrive at this number ? Can we move this to RcaConst class ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367142216", "createdAt": "2020-01-15T22:31:14Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/SubscriptionReceiver.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n+\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Networking component that handles receiving subscriptions.\n+ */\n+public class SubscriptionReceiver {\n+\n+  private static final Logger LOG = LogManager.getLogger(SubscriptionReceiver.class);\n+  private final NetworkRequestQueue<CompositeSubscribeRequest> rxQ;\n+  private final ScheduledExecutorService threadPool;\n+  private final SubscriptionReceiverTask subscriptionReceiverTask;\n+\n+  public SubscriptionReceiver(\n+      NetworkRequestQueue<CompositeSubscribeRequest> rxQ,\n+      ScheduledExecutorService threadPool,\n+      SubscriptionReceiverTask subscriptionReceiverTask) {\n+    this.rxQ = rxQ;\n+    this.threadPool = threadPool;\n+    this.subscriptionReceiverTask = subscriptionReceiverTask;\n+  }\n+\n+  public boolean enqueue(final CompositeSubscribeRequest compositeSubscribeRequest) {\n+    return rxQ.offer(compositeSubscribeRequest);\n+  }\n+\n+  public void start() {\n+    threadPool.scheduleAtFixedRate(subscriptionReceiverTask, 0, 250, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0MjQyNA==", "bodyText": "Probably we should drain all queues ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367142424", "createdAt": "2020-01-15T22:31:47Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/SubscriptionReceiver.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n+\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Networking component that handles receiving subscriptions.\n+ */\n+public class SubscriptionReceiver {\n+\n+  private static final Logger LOG = LogManager.getLogger(SubscriptionReceiver.class);\n+  private final NetworkRequestQueue<CompositeSubscribeRequest> rxQ;\n+  private final ScheduledExecutorService threadPool;\n+  private final SubscriptionReceiverTask subscriptionReceiverTask;\n+\n+  public SubscriptionReceiver(\n+      NetworkRequestQueue<CompositeSubscribeRequest> rxQ,\n+      ScheduledExecutorService threadPool,\n+      SubscriptionReceiverTask subscriptionReceiverTask) {\n+    this.rxQ = rxQ;\n+    this.threadPool = threadPool;\n+    this.subscriptionReceiverTask = subscriptionReceiverTask;\n+  }\n+\n+  public boolean enqueue(final CompositeSubscribeRequest compositeSubscribeRequest) {\n+    return rxQ.offer(compositeSubscribeRequest);\n+  }\n+\n+  public void start() {\n+    threadPool.scheduleAtFixedRate(subscriptionReceiverTask, 0, 250, TimeUnit.MILLISECONDS);\n+  }\n+\n+  public void stop() {\n+    // drain out the queue to stop processing.\n+    rxQ.drain();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0Mjg3NQ==", "bodyText": "change the log message ? kk", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367142875", "createdAt": "2020-01-15T22:32:59Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/SubscriptionSendTask.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.SubscribeMessage;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.messages.IntentMsg;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.messages.UnicastIntentMsg;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Class that handles sending of subscription requests from the queue.\n+ */\n+public class SubscriptionSendTask implements Runnable {\n+\n+  private static final Logger LOG = LogManager.getLogger(SubscriptionSendTask.class);\n+  private final SubscriptionManager subscriptionManager;\n+  private final NetworkRequestQueue<IntentMsg> txBroadcastQ;\n+  private final NetworkRequestQueue<UnicastIntentMsg> txUnicastQ;\n+  private final NetClient netClient;\n+\n+  public SubscriptionSendTask(final SubscriptionManager subscriptionManager,\n+      final NetworkRequestQueue<IntentMsg> txBroadcastQ, final NetworkRequestQueue<UnicastIntentMsg> txUnicastQ,\n+      final NetClient netClient) {\n+    this.subscriptionManager = subscriptionManager;\n+    this.txBroadcastQ = txBroadcastQ;\n+    this.txUnicastQ = txUnicastQ;\n+    this.netClient = netClient;\n+  }\n+\n+  /**\n+   * When an object implementing interface <code>Runnable</code> is used to create a thread,\n+   * starting the thread causes the object's\n+   * <code>run</code> method to be called in that separately executing\n+   * thread.\n+   *\n+   * <p>The general contract of the method <code>run</code> is that it may take any action whatsoever.\n+   *\n+   * @see Thread#run()\n+   */\n+  @Override\n+  public void run() {\n+    // Handle broadcasting subscription.\n+    for (final IntentMsg intentMsg : txBroadcastQ.drain()) {\n+      LOG.info(\"kk: Draining subscribe-broadcast TxQ\");\n+      final String requesterGraphNode = intentMsg.getRequesterNode();\n+      final String destinationGraphNode = intentMsg.getDestinationNode();\n+      final Map<String, String> tags = intentMsg.getRcaConfTags();\n+\n+      for (final String remoteHost : getAllRemoteHosts()) {\n+        sendSubscribeRequest(remoteHost, requesterGraphNode, destinationGraphNode, tags);\n+      }\n+    }\n+\n+    // Handle unicasting\n+    for (final UnicastIntentMsg intentMsg : txUnicastQ.drain()) {\n+      LOG.info(\"kk: Draining subscribe-unicast TxQ\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0MjkyNA==", "bodyText": "same", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367142924", "createdAt": "2020-01-15T22:33:05Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/SubscriptionSendTask.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.SubscribeMessage;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.messages.IntentMsg;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.messages.UnicastIntentMsg;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Class that handles sending of subscription requests from the queue.\n+ */\n+public class SubscriptionSendTask implements Runnable {\n+\n+  private static final Logger LOG = LogManager.getLogger(SubscriptionSendTask.class);\n+  private final SubscriptionManager subscriptionManager;\n+  private final NetworkRequestQueue<IntentMsg> txBroadcastQ;\n+  private final NetworkRequestQueue<UnicastIntentMsg> txUnicastQ;\n+  private final NetClient netClient;\n+\n+  public SubscriptionSendTask(final SubscriptionManager subscriptionManager,\n+      final NetworkRequestQueue<IntentMsg> txBroadcastQ, final NetworkRequestQueue<UnicastIntentMsg> txUnicastQ,\n+      final NetClient netClient) {\n+    this.subscriptionManager = subscriptionManager;\n+    this.txBroadcastQ = txBroadcastQ;\n+    this.txUnicastQ = txUnicastQ;\n+    this.netClient = netClient;\n+  }\n+\n+  /**\n+   * When an object implementing interface <code>Runnable</code> is used to create a thread,\n+   * starting the thread causes the object's\n+   * <code>run</code> method to be called in that separately executing\n+   * thread.\n+   *\n+   * <p>The general contract of the method <code>run</code> is that it may take any action whatsoever.\n+   *\n+   * @see Thread#run()\n+   */\n+  @Override\n+  public void run() {\n+    // Handle broadcasting subscription.\n+    for (final IntentMsg intentMsg : txBroadcastQ.drain()) {\n+      LOG.info(\"kk: Draining subscribe-broadcast TxQ\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNTQ3NjUw", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#pullrequestreview-343547650", "createdAt": "2020-01-15T21:54:04Z", "commit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMTo1NDowNVrOFeHqxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMzoxNjozMFrOFeJhNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyNzIzOA==", "bodyText": "Change to log.debug", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367127238", "createdAt": "2020-01-15T21:54:05Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetServer.java", "diffHunk": "@@ -138,12 +138,13 @@ private Server buildHttpsServer() {\n   @Override\n   public void subscribe(\n       final SubscribeMessage request, final StreamObserver<SubscribeResponse> responseObserver) {\n-    LOG.debug(\"subscribe received\");\n+    LOG.info(\"kk: subscribe received\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyODI1NA==", "bodyText": "Why do we need 3 threads here?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367128254", "createdAt": "2020-01-15T21:56:25Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -313,16 +342,35 @@ private void start() {\n       Queryable db = new MetricsDBProvider();\n       ThresholdMain thresholdMain = new ThresholdMain(RcaConsts.THRESHOLDS_PATH, rcaConf);\n       Persistable persistable = PersistenceFactory.create(rcaConf);\n+      ThreadFactory networkThreadFactory =\n+          new ThreadFactoryBuilder().setNameFormat(\"rca-net-%d\").setDaemon(true).build();\n+      networkActivitiesThreadPool = new ScheduledThreadPoolExecutor(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyODk0MA==", "bodyText": "Can you add some documentation or an interface around start and stop functions. What is supposed to happen when these functions are called?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367128940", "createdAt": "2020-01-15T21:58:01Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -313,16 +342,35 @@ private void start() {\n       Queryable db = new MetricsDBProvider();\n       ThresholdMain thresholdMain = new ThresholdMain(RcaConsts.THRESHOLDS_PATH, rcaConf);\n       Persistable persistable = PersistenceFactory.create(rcaConf);\n+      ThreadFactory networkThreadFactory =\n+          new ThreadFactoryBuilder().setNameFormat(\"rca-net-%d\").setDaemon(true).build();\n+      networkActivitiesThreadPool = new ScheduledThreadPoolExecutor(\n+          3, networkThreadFactory);\n+      flowUnitSender = buildSender(networkActivitiesThreadPool);\n+      flowUnitSender.start();\n+\n+      flowUnitReceiver = buildReceiver(networkActivitiesThreadPool);\n+      flowUnitReceiver.start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzMTQxNA==", "bodyText": "Why 200?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367131414", "createdAt": "2020-01-15T22:04:13Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/NetworkRequestQueue.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n+\n+import com.google.common.collect.ImmutableList;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ArrayBlockingQueue;\n+import java.util.concurrent.BlockingQueue;\n+\n+/**\n+ * Class that represents a custom bounded and concurrent queue.\n+ */\n+public class NetworkRequestQueue<T> {\n+\n+  private static final int DEFAULT_MAX_Q_SIZE = 200;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzNTEyOA==", "bodyText": "We can use a long here instead of AtomicLong as that will simplify the code.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367135128", "createdAt": "2020-01-15T22:13:34Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/NodeStateManager.java", "diffHunk": "@@ -21,24 +21,45 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n+import javax.annotation.concurrent.ThreadSafe;\n \n+/**\n+ * Manages the subscription state for the nodes in the graph.\n+ */\n public class NodeStateManager {\n   private static final long MS_IN_S = 1000;\n   private static final long MS_IN_FIVE_SECONDS = 5 * MS_IN_S;\n   private static final String SEPARATOR = \".\";\n \n-  private Map<String, Long> lastReceivedTimestampMap = new HashMap<>();\n+  private ConcurrentMap<String, AtomicLong> lastReceivedTimestampMap = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0MjA2Mw==", "bodyText": "Instead of polling for tasks we should directly post the task into the threadpool using the execute function.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367142063", "createdAt": "2020-01-15T22:30:50Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -313,16 +342,35 @@ private void start() {\n       Queryable db = new MetricsDBProvider();\n       ThresholdMain thresholdMain = new ThresholdMain(RcaConsts.THRESHOLDS_PATH, rcaConf);\n       Persistable persistable = PersistenceFactory.create(rcaConf);\n+      ThreadFactory networkThreadFactory =\n+          new ThreadFactoryBuilder().setNameFormat(\"rca-net-%d\").setDaemon(true).build();\n+      networkActivitiesThreadPool = new ScheduledThreadPoolExecutor(\n+          3, networkThreadFactory);\n+      flowUnitSender = buildSender(networkActivitiesThreadPool);\n+      flowUnitSender.start();\n+\n+      flowUnitReceiver = buildReceiver(networkActivitiesThreadPool);\n+      flowUnitReceiver.start();\n+\n+      subscriptionSender = buildSubscriptionSender(networkActivitiesThreadPool);\n+      subscriptionSender.start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0NTI4Mw==", "bodyText": "We dont need to update map on each enqueue. We can use a putifAbsent.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367145283", "createdAt": "2020-01-15T22:39:43Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/ReceivedFlowUnitStore.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.FlowUnitMessage;\n+import com.google.common.collect.ImmutableList;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ArrayBlockingQueue;\n+import java.util.concurrent.BlockingQueue;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+\n+/**\n+ * An intermediate buffer that holds flow units received for different vertices from across the\n+ * cluster.\n+ */\n+public class ReceivedFlowUnitStore {\n+\n+  private static final int DEFAULT_PER_NODE_FLOWUNIT_Q_SIZE = 200;\n+  private ConcurrentMap<String, BlockingQueue<FlowUnitMessage>> flowUnitMap =\n+      new ConcurrentHashMap<>();\n+  private final int perNodeFlowUnitQSize;\n+\n+  public ReceivedFlowUnitStore() {\n+    this(DEFAULT_PER_NODE_FLOWUNIT_Q_SIZE);\n+  }\n+\n+  public ReceivedFlowUnitStore(final int perNodeFlowUnitQSize) {\n+    this.perNodeFlowUnitQSize = perNodeFlowUnitQSize;\n+  }\n+\n+  public boolean enqueue(final String graphNode, final FlowUnitMessage flowUnitMessage) {\n+    BlockingQueue<FlowUnitMessage> existingQueue = flowUnitMap.get(graphNode);\n+    if (existingQueue == null) {\n+      existingQueue = new ArrayBlockingQueue<>(perNodeFlowUnitQSize);\n+    }\n+\n+    boolean retValue = existingQueue.offer(flowUnitMessage);\n+    flowUnitMap.put(graphNode, existingQueue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE1NzU1OQ==", "bodyText": "What change did we make here?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367157559", "createdAt": "2020-01-15T23:16:30Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ReaderMetricsProcessor.java", "diffHunk": "@@ -344,10 +344,35 @@ private void emitMasterMetrics(long prevWindowStartTime, MetricsDB metricsDB) {\n           masterEventMetricsMap.get(prevWindowStartTime);\n       MetricsEmitter.emitMasterEventMetrics(metricsDB, preMasterEventSnapshot);\n     } else {\n-      LOG.info(\"Master snapshot for the previous window does not exist. Not emitting metrics.\");\n+      LOG.debug(\"Master snapshot for the previous window does not exist. Not emitting metrics.\");\n     }\n   }\n \n+  void parseMasterEventMetrics(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNTg4MzEx", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#pullrequestreview-343588311", "createdAt": "2020-01-15T23:22:29Z", "commit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMzoyMjoyOVrOFeJnxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQyMzoyODo0MFrOFeJutA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE1OTIzNg==", "bodyText": "How do we handle publish failure?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367159236", "createdAt": "2020-01-15T23:22:29Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/net/SendTask.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.net;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.PublishResponse;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.PublishResponse.PublishResponseStatus;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.net.NetClient;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.GenericFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.messages.DataMsg;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import io.grpc.stub.StreamObserver;\n+import java.util.Set;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Class that processes flow units that need to be sent from the queue.\n+ */\n+public class SendTask implements Runnable {\n+\n+  private static final Logger LOG = LogManager.getLogger(SendTask.class);\n+  private final SubscriptionManager subscriptionManager;\n+  private final NetworkRequestQueue<DataMsg> txQ;\n+  private final NetClient netClient;\n+\n+  public SendTask(final SubscriptionManager subscriptionManager, final NetworkRequestQueue<DataMsg> txQ,\n+      final NetClient netClient) {\n+    this.subscriptionManager = subscriptionManager;\n+    this.txQ = txQ;\n+    this.netClient = netClient;\n+  }\n+\n+  /**\n+   * When an object implementing interface <code>Runnable</code> is used to create a thread,\n+   * starting the thread causes the object's\n+   * <code>run</code> method to be called in that separately executing\n+   * thread.\n+   * The general contract of the method <code>run</code> is that it may take any action whatsoever.\n+   *\n+   * @see Thread#run()\n+   */\n+  @Override\n+  public void run() {\n+    for (final DataMsg dataMsg : txQ.drain()) {\n+      final String sourceNode = dataMsg.getSourceNode();\n+      final String esNode;\n+      final NodeDetails currentNode = ClusterDetailsEventProcessor.getCurrentNodeDetails();\n+      if (currentNode != null) {\n+        esNode = currentNode.getHostAddress();\n+      } else {\n+        LOG.error(\"Could not get current host address from cluster level metrics reader.\");\n+        esNode = \"\";\n+      }\n+      if (subscriptionManager.isNodeSubscribed(sourceNode)) {\n+        final Set<String> downstreamHostAddresses = subscriptionManager\n+            .getSubscribersFor(sourceNode);\n+        LOG.debug(\"{} has downstream subscribers: {}\", sourceNode, downstreamHostAddresses);\n+        for (final String downstreamHostAddress : downstreamHostAddresses) {\n+          for (final GenericFlowUnit flowUnit : dataMsg.getFlowUnits()) {\n+            netClient.publish(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE2MDIzNQ==", "bodyText": "What happens to stale connections? When do we throw them away? Can we have connection failures where we re-establish a connection?\nThe case we need to test is -\n\nNode joins cluster.\nYou are streaming metrics.\nNode leaves cluster temporarily and then joins back.\nWill we create a new connection and stream data?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367160235", "createdAt": "2020-01-15T23:26:00Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetClient.java", "diffHunk": "@@ -41,26 +48,39 @@ public NetClient(final GRPCConnectionManager connectionManager) {\n     this.connectionManager = connectionManager;\n   }\n \n-  private Map<String, StreamObserver<FlowUnitMessage>> perHostOpenDataStreamMap = new HashMap<>();\n+  private ConcurrentMap<String, AtomicReference<StreamObserver<FlowUnitMessage>>> perHostOpenDataStreamMap =\n+      new ConcurrentHashMap<>();\n \n   public void subscribe(\n       final String remoteHost,\n       final SubscribeMessage subscribeMessage,\n       StreamObserver<SubscribeResponse> serverResponseStream) {\n     LOG.debug(\"Trying to send intent message to {}\", remoteHost);\n-    connectionManager\n-        .getClientStubForHost(remoteHost)\n-        .subscribe(subscribeMessage, serverResponseStream);\n+    try {\n+      connectionManager\n+          .getClientStubForHost(remoteHost)\n+          .subscribe(subscribeMessage, serverResponseStream);\n+    } catch (StatusRuntimeException sre) {\n+      LOG.error(\"Encountered an error trying to subscribe. Status: {}\",\n+          sre.getStatus(), sre);\n+      StatsCollector.instance().logException(StatExceptionCode.RCA_NETWORK_ERROR);\n+    }\n   }\n \n   public void publish(\n       final String remoteHost,\n       final FlowUnitMessage flowUnitMessage,\n       final StreamObserver<PublishResponse> serverResponseStream) {\n     LOG.debug(\"Publishing {} data to {}\", flowUnitMessage.getGraphNode(), remoteHost);\n-    final StreamObserver<FlowUnitMessage> stream =\n-        getDataStreamForHost(remoteHost, serverResponseStream);\n-    stream.onNext(flowUnitMessage);\n+    try {\n+      final StreamObserver<FlowUnitMessage> stream =\n+          getDataStreamForHost(remoteHost, serverResponseStream);\n+      stream.onNext(flowUnitMessage);\n+    } catch (StatusRuntimeException sre) {\n+      LOG.error(\"Encountered an error trying to publish a flow unit. Status: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE2MTAxMg==", "bodyText": "We should also track cluster membership changes to add/remove nodes.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r367161012", "createdAt": "2020-01-15T23:28:40Z", "author": {"login": "ditac"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetClient.java", "diffHunk": "@@ -41,26 +48,39 @@ public NetClient(final GRPCConnectionManager connectionManager) {\n     this.connectionManager = connectionManager;\n   }\n \n-  private Map<String, StreamObserver<FlowUnitMessage>> perHostOpenDataStreamMap = new HashMap<>();\n+  private ConcurrentMap<String, AtomicReference<StreamObserver<FlowUnitMessage>>> perHostOpenDataStreamMap =\n+      new ConcurrentHashMap<>();\n \n   public void subscribe(\n       final String remoteHost,\n       final SubscribeMessage subscribeMessage,\n       StreamObserver<SubscribeResponse> serverResponseStream) {\n     LOG.debug(\"Trying to send intent message to {}\", remoteHost);\n-    connectionManager\n-        .getClientStubForHost(remoteHost)\n-        .subscribe(subscribeMessage, serverResponseStream);\n+    try {\n+      connectionManager\n+          .getClientStubForHost(remoteHost)\n+          .subscribe(subscribeMessage, serverResponseStream);\n+    } catch (StatusRuntimeException sre) {\n+      LOG.error(\"Encountered an error trying to subscribe. Status: {}\",\n+          sre.getStatus(), sre);\n+      StatsCollector.instance().logException(StatExceptionCode.RCA_NETWORK_ERROR);\n+    }\n   }\n \n   public void publish(\n       final String remoteHost,\n       final FlowUnitMessage flowUnitMessage,\n       final StreamObserver<PublishResponse> serverResponseStream) {\n     LOG.debug(\"Publishing {} data to {}\", flowUnitMessage.getGraphNode(), remoteHost);\n-    final StreamObserver<FlowUnitMessage> stream =\n-        getDataStreamForHost(remoteHost, serverResponseStream);\n-    stream.onNext(flowUnitMessage);\n+    try {\n+      final StreamObserver<FlowUnitMessage> stream =\n+          getDataStreamForHost(remoteHost, serverResponseStream);\n+      stream.onNext(flowUnitMessage);\n+    } catch (StatusRuntimeException sre) {\n+      LOG.error(\"Encountered an error trying to publish a flow unit. Status: {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE2MDIzNQ=="}, "originalCommit": {"oid": "b5e87a91406d1baf35ee8a76c8dedae9c9f86081"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc3f519a0b0694eef0545cd3eee6c191e3a9f8dd", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/cc3f519a0b0694eef0545cd3eee6c191e3a9f8dd", "committedDate": "2020-01-17T18:09:34Z", "message": "1. Replace multiple queues with one task queue.\n2. Added more documentation around the classes added.\n3. Other PR comment suggestions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6d7e201a2d5415bdac61cabcf8c72c063cd330a", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e6d7e201a2d5415bdac61cabcf8c72c063cd330a", "committedDate": "2020-01-17T18:20:00Z", "message": "Merge branch 'master' of github.com:opendistro-for-elasticsearch/performance-analyzer-rca into thr_safe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTUyMjIx", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#pullrequestreview-346152221", "createdAt": "2020-01-21T19:58:45Z", "commit": {"oid": "e6d7e201a2d5415bdac61cabcf8c72c063cd330a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7800b9adb306aee3d81742234d0cca4d00fd8706", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/7800b9adb306aee3d81742234d0cca4d00fd8706", "committedDate": "2020-01-21T23:37:26Z", "message": "Add support to handle more error cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37bf890a5fa0e5ba5a703a600fa88798e6355615", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/37bf890a5fa0e5ba5a703a600fa88798e6355615", "committedDate": "2020-01-21T23:37:37Z", "message": "Merge branch 'master' of github.com:opendistro-for-elasticsearch/performance-analyzer-rca into thr_safe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b23ddcb429e1935d81515299eaeb8a9cefb703e", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/6b23ddcb429e1935d81515299eaeb8a9cefb703e", "committedDate": "2020-01-22T01:04:46Z", "message": "Added more documentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MzU0Nzg2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#pullrequestreview-346354786", "createdAt": "2020-01-22T05:38:15Z", "commit": {"oid": "6b23ddcb429e1935d81515299eaeb8a9cefb703e"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwNTozODoxNVrOFgRBQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwNTo1ODozMVrOFgRRpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM3NzYwMg==", "bodyText": "rca.conf supports comments. We can add a couple of lines where this config is used and what can be the repercussions of setting it too high or too low", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r369377602", "createdAt": "2020-01-22T05:38:15Z", "author": {"login": "yojs"}, "path": "pa_config/rca.conf", "diffHunk": "@@ -10,6 +10,10 @@\n \n   \"new-threshold-check-minutes\": 30,\n \n+  \"network-queue-length\": 200,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b23ddcb429e1935d81515299eaeb8a9cefb703e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM3NzcyNg==", "bodyText": "Similarly for this one too", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r369377726", "createdAt": "2020-01-22T05:38:55Z", "author": {"login": "yojs"}, "path": "pa_config/rca_idle_master.conf", "diffHunk": "@@ -9,6 +9,8 @@\n   \"new-rca-check-minutes\": 60,\n \n   \"new-threshold-check-minutes\": 30,\n+  \"network-queue-length\": 200,\n+  \"max-flow-units-per-vertex-buffer\": 200,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b23ddcb429e1935d81515299eaeb8a9cefb703e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM3ODE1Mw==", "bodyText": "separate these with a newline ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r369378153", "createdAt": "2020-01-22T05:41:13Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/collectors/StatExceptionCode.java", "diffHunk": "@@ -33,7 +33,10 @@\n   READER_PARSER_ERROR(\"ReaderParserError\"),\n   READER_RESTART_PROCESSING(\"ReaderRestartProcessing\"),\n   RCA_SCHEDULER_RESTART_PROCESSING(\"RCASchedulerRestartProcessing\"),\n-  OTHER(\"Other\");\n+  RCA_NETWORK_ERROR(\"RcaNetworkError\"),\n+  RCA_VERTEX_RX_BUFFER_FULL_ERROR(\"RcaVertexRxBufferFullError\"),\n+  RCA_NETWORK_THREADPOOL_QUEUE_FULL_ERROR(\"RcaNetworkThreadpoolQueueFullError\"),\n+  OTHER(\"Other\"), RCA_SCHEDULER_STOPPED_ERROR(\"RcaSchedulerStoppedError\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b23ddcb429e1935d81515299eaeb8a9cefb703e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM3OTMxMA==", "bodyText": "Are these lines well formatted ? Maybe this change is not intended  ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r369379310", "createdAt": "2020-01-22T05:46:45Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCConnectionManager.java", "diffHunk": "@@ -114,11 +128,12 @@ private ManagedChannel buildInsecureChannel(final String remoteHost) {\n   private ManagedChannel buildSecureChannel(final String remoteHost) {\n     try {\n       return NettyChannelBuilder.forAddress(remoteHost, Util.RPC_PORT)\n-          .sslContext(\n-              GrpcSslContexts.forClient()\n-                  .trustManager(InsecureTrustManagerFactory.INSTANCE)\n-                  .build())\n-          .build();\n+                                .sslContext(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b23ddcb429e1935d81515299eaeb8a9cefb703e"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4MDUzMQ==", "bodyText": "I am thinking, if it would be a better idea to buffer this request until we are ready and then heed to it. Given than every node can start and die on their own, we might want to minimize packet transfers if we can. what do you think ? We should definitely add a comment saying that this is safe  and the node that sent it will re-send it again in future and we will act on it then or something along those lines", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r369380531", "createdAt": "2020-01-22T05:52:24Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetServer.java", "diffHunk": "@@ -138,12 +138,13 @@ private Server buildHttpsServer() {\n   @Override\n   public void subscribe(\n       final SubscribeMessage request, final StreamObserver<SubscribeResponse> responseObserver) {\n-    LOG.debug(\"subscribe received\");\n     if (subscribeHandler != null) {\n       subscribeHandler.handleSubscriptionRequest(request, responseObserver);\n+    } else {\n+      LOG.error(\"Subscribe request received before handler is set.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b23ddcb429e1935d81515299eaeb8a9cefb703e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4MTMxNg==", "bodyText": "A comment maybe ? :)", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r369381316", "createdAt": "2020-01-22T05:56:29Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -109,6 +119,9 @@\n   private TimeUnit timeUnit;\n   private List<Thread> exceptionHandlerThreads;\n   private List<ScheduledFuture<?>> pollingExecutors;\n+  private boolean shutdownRequested;\n+  private AtomicReference<ExecutorService> networkThreadPoolReference = new AtomicReference<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b23ddcb429e1935d81515299eaeb8a9cefb703e"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM4MTc5OQ==", "bodyText": "Do we really need this added complexity to set the queue size dynamically ? we can make it require a restart ?\nWhat happens when the old executor was executing and this thread sees a configuration change and tries to update the pool, will we ever be running the same code across two threads ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#discussion_r369381799", "createdAt": "2020-01-22T05:58:31Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -316,16 +334,21 @@ private void start() {\n       Queryable db = new MetricsDBProvider();\n       ThresholdMain thresholdMain = new ThresholdMain(RcaConsts.THRESHOLDS_PATH, rcaConf);\n       Persistable persistable = PersistenceFactory.create(rcaConf);\n+      networkThreadPoolReference.set(buildNetworkThreadPool(rcaConf.getNetworkQueueLength()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b23ddcb429e1935d81515299eaeb8a9cefb703e"}, "originalPosition": 119}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d3b4e338918fdc3f7bb86ea60a256b3c5571637", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3d3b4e338918fdc3f7bb86ea60a256b3c5571637", "committedDate": "2020-01-22T20:05:33Z", "message": "Added copyright and documented fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24e1ecbf5b4659f576855ac61e466b7c43270d31", "author": {"user": {"login": "ktkrg", "name": "Karthik Kumarguru"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/24e1ecbf5b4659f576855ac61e466b7c43270d31", "committedDate": "2020-01-22T21:53:52Z", "message": "Added comments in the conf files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTcxODUy", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/59#pullrequestreview-346971852", "createdAt": "2020-01-22T23:19:03Z", "commit": {"oid": "24e1ecbf5b4659f576855ac61e466b7c43270d31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1127, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}