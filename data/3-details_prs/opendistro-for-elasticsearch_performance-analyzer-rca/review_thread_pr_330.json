{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwNzE5NDYw", "number": 330, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNjozMzozMFrOEUrMMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODowNzoxOFrOEUtNjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTE0NjA5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cache/CacheUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNjozMzozMFrOG7AcKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDo1MDoyNFrOG7ISng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyNjM3OQ==", "bodyText": "Can any of these Record values be NaN?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/330#discussion_r464526379", "createdAt": "2020-08-03T16:33:30Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cache/CacheUtil.java", "diffHunk": "@@ -15,44 +15,64 @@\n \n package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cache;\n \n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n+import org.jooq.Record;\n+import org.jooq.Result;\n \n public class CacheUtil {\n     private static final Logger LOG = LogManager.getLogger(CacheUtil.class);\n \n     public static Double getTotalSizeInKB(final Metric cacheSizeGroupByOperation) {\n-        double sizeTotalInKB = 0;\n+        double totalSizeInKB = 0;\n \n         if (cacheSizeGroupByOperation.getFlowUnits().size() > 0) {\n             // we expect the Metric to have single flow unit since it is consumed locally\n             MetricFlowUnit flowUnit = cacheSizeGroupByOperation.getFlowUnits().get(0);\n             if (flowUnit.isEmpty() || flowUnit.getData() == null) {\n-                return sizeTotalInKB;\n+                return totalSizeInKB;\n             }\n \n-            // since the flow unit data is aggregated, we should have a single value\n+            // since the flow unit data is aggregated by index, summing the size across indices\n             if (flowUnit.getData().size() > 0) {\n-                double size = flowUnit.getData().get(0).getValue(MetricsDB.SUM, Double.class);\n-                if (Double.isNaN(size)) {\n-                    LOG.error(\"Failed to parse metric in FlowUnit from {}\", cacheSizeGroupByOperation.getClass().getName());\n-                } else {\n-                    sizeTotalInKB += size / 1024.0;\n-                }\n+                Result<Record> records = flowUnit.getData();\n+                double size = records.stream().mapToDouble(\n+                        record -> record.getValue(MetricsDB.SUM, Double.class)).sum();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19e1e06072b73b682464350bac73b42f59d1165e"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1NTAwNg==", "bodyText": "Yes, they can be NaN.\nAdded to throw IllegalArgumentException in case totalSizeInKB is NaN.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/330#discussion_r464655006", "createdAt": "2020-08-03T20:50:24Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cache/CacheUtil.java", "diffHunk": "@@ -15,44 +15,64 @@\n \n package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cache;\n \n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n+import org.jooq.Record;\n+import org.jooq.Result;\n \n public class CacheUtil {\n     private static final Logger LOG = LogManager.getLogger(CacheUtil.class);\n \n     public static Double getTotalSizeInKB(final Metric cacheSizeGroupByOperation) {\n-        double sizeTotalInKB = 0;\n+        double totalSizeInKB = 0;\n \n         if (cacheSizeGroupByOperation.getFlowUnits().size() > 0) {\n             // we expect the Metric to have single flow unit since it is consumed locally\n             MetricFlowUnit flowUnit = cacheSizeGroupByOperation.getFlowUnits().get(0);\n             if (flowUnit.isEmpty() || flowUnit.getData() == null) {\n-                return sizeTotalInKB;\n+                return totalSizeInKB;\n             }\n \n-            // since the flow unit data is aggregated, we should have a single value\n+            // since the flow unit data is aggregated by index, summing the size across indices\n             if (flowUnit.getData().size() > 0) {\n-                double size = flowUnit.getData().get(0).getValue(MetricsDB.SUM, Double.class);\n-                if (Double.isNaN(size)) {\n-                    LOG.error(\"Failed to parse metric in FlowUnit from {}\", cacheSizeGroupByOperation.getClass().getName());\n-                } else {\n-                    sizeTotalInKB += size / 1024.0;\n-                }\n+                Result<Record> records = flowUnit.getData();\n+                double size = records.stream().mapToDouble(\n+                        record -> record.getValue(MetricsDB.SUM, Double.class)).sum();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyNjM3OQ=="}, "originalCommit": {"oid": "19e1e06072b73b682464350bac73b42f59d1165e"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTE1NDAwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cache/CacheUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNjozNTo1MVrOG7AhFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDozNzoxNlrOG7H6UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyNzYzOQ==", "bodyText": "Can we throw an exception here instead? I try to avoid overloading return values with error codes in java. Off the top of my head, if cache size ever is less than 1KB, we cannot distinguish between that and error values.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/330#discussion_r464527639", "createdAt": "2020-08-03T16:35:51Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cache/CacheUtil.java", "diffHunk": "@@ -15,44 +15,64 @@\n \n package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cache;\n \n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n+import org.jooq.Record;\n+import org.jooq.Result;\n \n public class CacheUtil {\n     private static final Logger LOG = LogManager.getLogger(CacheUtil.class);\n \n     public static Double getTotalSizeInKB(final Metric cacheSizeGroupByOperation) {\n-        double sizeTotalInKB = 0;\n+        double totalSizeInKB = 0;\n \n         if (cacheSizeGroupByOperation.getFlowUnits().size() > 0) {\n             // we expect the Metric to have single flow unit since it is consumed locally\n             MetricFlowUnit flowUnit = cacheSizeGroupByOperation.getFlowUnits().get(0);\n             if (flowUnit.isEmpty() || flowUnit.getData() == null) {\n-                return sizeTotalInKB;\n+                return totalSizeInKB;\n             }\n \n-            // since the flow unit data is aggregated, we should have a single value\n+            // since the flow unit data is aggregated by index, summing the size across indices\n             if (flowUnit.getData().size() > 0) {\n-                double size = flowUnit.getData().get(0).getValue(MetricsDB.SUM, Double.class);\n-                if (Double.isNaN(size)) {\n-                    LOG.error(\"Failed to parse metric in FlowUnit from {}\", cacheSizeGroupByOperation.getClass().getName());\n-                } else {\n-                    sizeTotalInKB += size / 1024.0;\n-                }\n+                Result<Record> records = flowUnit.getData();\n+                double size = records.stream().mapToDouble(\n+                        record -> record.getValue(MetricsDB.SUM, Double.class)).sum();\n+                totalSizeInKB += getSizeInKB(size);\n             }\n         }\n-        return sizeTotalInKB;\n+        return totalSizeInKB;\n+    }\n+\n+    public static Double getSizeInKB(double sizeinBytes) {\n+        double sizeInKB = 0;\n+        if (Double.isNaN(sizeinBytes)) {\n+            LOG.error(\"getSizeInKB called with NaN value\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19e1e06072b73b682464350bac73b42f59d1165e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODc4NQ==", "bodyText": "Makes sense, updating to throw exception here.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/330#discussion_r464648785", "createdAt": "2020-08-03T20:37:16Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cache/CacheUtil.java", "diffHunk": "@@ -15,44 +15,64 @@\n \n package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cache;\n \n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n+import org.jooq.Record;\n+import org.jooq.Result;\n \n public class CacheUtil {\n     private static final Logger LOG = LogManager.getLogger(CacheUtil.class);\n \n     public static Double getTotalSizeInKB(final Metric cacheSizeGroupByOperation) {\n-        double sizeTotalInKB = 0;\n+        double totalSizeInKB = 0;\n \n         if (cacheSizeGroupByOperation.getFlowUnits().size() > 0) {\n             // we expect the Metric to have single flow unit since it is consumed locally\n             MetricFlowUnit flowUnit = cacheSizeGroupByOperation.getFlowUnits().get(0);\n             if (flowUnit.isEmpty() || flowUnit.getData() == null) {\n-                return sizeTotalInKB;\n+                return totalSizeInKB;\n             }\n \n-            // since the flow unit data is aggregated, we should have a single value\n+            // since the flow unit data is aggregated by index, summing the size across indices\n             if (flowUnit.getData().size() > 0) {\n-                double size = flowUnit.getData().get(0).getValue(MetricsDB.SUM, Double.class);\n-                if (Double.isNaN(size)) {\n-                    LOG.error(\"Failed to parse metric in FlowUnit from {}\", cacheSizeGroupByOperation.getClass().getName());\n-                } else {\n-                    sizeTotalInKB += size / 1024.0;\n-                }\n+                Result<Record> records = flowUnit.getData();\n+                double size = records.stream().mapToDouble(\n+                        record -> record.getValue(MetricsDB.SUM, Double.class)).sum();\n+                totalSizeInKB += getSizeInKB(size);\n             }\n         }\n-        return sizeTotalInKB;\n+        return totalSizeInKB;\n+    }\n+\n+    public static Double getSizeInKB(double sizeinBytes) {\n+        double sizeInKB = 0;\n+        if (Double.isNaN(sizeinBytes)) {\n+            LOG.error(\"getSizeInKB called with NaN value\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyNzYzOQ=="}, "originalCommit": {"oid": "19e1e06072b73b682464350bac73b42f59d1165e"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTE2MjU5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cache/CacheUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNjozODoxMFrOG7AmSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDoyNDoxN1rOG7HiLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyODk2OQ==", "bodyText": "Again, why don't we just throw the exception and let callers handle it their way. If we want to prevent it from breaking code, we should throw a checked exception here.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/330#discussion_r464528969", "createdAt": "2020-08-03T16:38:10Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cache/CacheUtil.java", "diffHunk": "@@ -15,44 +15,64 @@\n \n package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cache;\n \n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n+import org.jooq.Record;\n+import org.jooq.Result;\n \n public class CacheUtil {\n     private static final Logger LOG = LogManager.getLogger(CacheUtil.class);\n \n     public static Double getTotalSizeInKB(final Metric cacheSizeGroupByOperation) {\n-        double sizeTotalInKB = 0;\n+        double totalSizeInKB = 0;\n \n         if (cacheSizeGroupByOperation.getFlowUnits().size() > 0) {\n             // we expect the Metric to have single flow unit since it is consumed locally\n             MetricFlowUnit flowUnit = cacheSizeGroupByOperation.getFlowUnits().get(0);\n             if (flowUnit.isEmpty() || flowUnit.getData() == null) {\n-                return sizeTotalInKB;\n+                return totalSizeInKB;\n             }\n \n-            // since the flow unit data is aggregated, we should have a single value\n+            // since the flow unit data is aggregated by index, summing the size across indices\n             if (flowUnit.getData().size() > 0) {\n-                double size = flowUnit.getData().get(0).getValue(MetricsDB.SUM, Double.class);\n-                if (Double.isNaN(size)) {\n-                    LOG.error(\"Failed to parse metric in FlowUnit from {}\", cacheSizeGroupByOperation.getClass().getName());\n-                } else {\n-                    sizeTotalInKB += size / 1024.0;\n-                }\n+                Result<Record> records = flowUnit.getData();\n+                double size = records.stream().mapToDouble(\n+                        record -> record.getValue(MetricsDB.SUM, Double.class)).sum();\n+                totalSizeInKB += getSizeInKB(size);\n             }\n         }\n-        return sizeTotalInKB;\n+        return totalSizeInKB;\n+    }\n+\n+    public static Double getSizeInKB(double sizeinBytes) {\n+        double sizeInKB = 0;\n+        if (Double.isNaN(sizeinBytes)) {\n+            LOG.error(\"getSizeInKB called with NaN value\");\n+        } else {\n+            sizeInKB = sizeinBytes / 1024.0;\n+        }\n+        return sizeInKB;\n+    }\n+\n+    public static double getCacheMaxSize(AppContext appContext, NodeKey esNode, Resource cacheResource) {\n+        try {\n+            return appContext.getNodeConfigCache().get(esNode, cacheResource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19e1e06072b73b682464350bac73b42f59d1165e"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0MjYwNw==", "bodyText": "We will run into IllegalArgumentException in case the cacheResource is not present for the given esNode in the Cache Config. This behavior is common to only the first run post the RCA enable since the cache hasn't been formed yet\nThus, rather than throwing an exception, we are just logging(added now) that the expected resource is currently not available.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/330#discussion_r464642607", "createdAt": "2020-08-03T20:24:17Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cache/CacheUtil.java", "diffHunk": "@@ -15,44 +15,64 @@\n \n package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cache;\n \n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n+import org.jooq.Record;\n+import org.jooq.Result;\n \n public class CacheUtil {\n     private static final Logger LOG = LogManager.getLogger(CacheUtil.class);\n \n     public static Double getTotalSizeInKB(final Metric cacheSizeGroupByOperation) {\n-        double sizeTotalInKB = 0;\n+        double totalSizeInKB = 0;\n \n         if (cacheSizeGroupByOperation.getFlowUnits().size() > 0) {\n             // we expect the Metric to have single flow unit since it is consumed locally\n             MetricFlowUnit flowUnit = cacheSizeGroupByOperation.getFlowUnits().get(0);\n             if (flowUnit.isEmpty() || flowUnit.getData() == null) {\n-                return sizeTotalInKB;\n+                return totalSizeInKB;\n             }\n \n-            // since the flow unit data is aggregated, we should have a single value\n+            // since the flow unit data is aggregated by index, summing the size across indices\n             if (flowUnit.getData().size() > 0) {\n-                double size = flowUnit.getData().get(0).getValue(MetricsDB.SUM, Double.class);\n-                if (Double.isNaN(size)) {\n-                    LOG.error(\"Failed to parse metric in FlowUnit from {}\", cacheSizeGroupByOperation.getClass().getName());\n-                } else {\n-                    sizeTotalInKB += size / 1024.0;\n-                }\n+                Result<Record> records = flowUnit.getData();\n+                double size = records.stream().mapToDouble(\n+                        record -> record.getValue(MetricsDB.SUM, Double.class)).sum();\n+                totalSizeInKB += getSizeInKB(size);\n             }\n         }\n-        return sizeTotalInKB;\n+        return totalSizeInKB;\n+    }\n+\n+    public static Double getSizeInKB(double sizeinBytes) {\n+        double sizeInKB = 0;\n+        if (Double.isNaN(sizeinBytes)) {\n+            LOG.error(\"getSizeInKB called with NaN value\");\n+        } else {\n+            sizeInKB = sizeinBytes / 1024.0;\n+        }\n+        return sizeInKB;\n+    }\n+\n+    public static double getCacheMaxSize(AppContext appContext, NodeKey esNode, Resource cacheResource) {\n+        try {\n+            return appContext.getNodeConfigCache().get(esNode, cacheResource);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyODk2OQ=="}, "originalCommit": {"oid": "19e1e06072b73b682464350bac73b42f59d1165e"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTQ3NzI0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ElasticSearchAnalysisGraph.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODowNzoxOFrOG7DnJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDoxNDo1M1rOG7HRTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3ODM0MA==", "bodyText": "shardRequestCacheNodeRca needs to be connected to shardRequestCacheEvictions leaf node as well right?\nArrays.asList(All the metrics this node is consuming)?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/330#discussion_r464578340", "createdAt": "2020-08-03T18:07:18Z", "author": {"login": "sruti1312"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ElasticSearchAnalysisGraph.java", "diffHunk": "@@ -203,6 +212,58 @@ public void construct() {\n     nodeConfigClusterCollector.addAllUpstreams(Collections.singletonList(nodeConfigCollector));\n     nodeConfigClusterCollector.addTag(TAG_AGGREGATE_UPSTREAM, LOCUS_DATA_NODE);\n \n+    // Field Data Cache RCA\n+    Metric fieldDataCacheEvictions = new Cache_FieldData_Eviction(EVALUATION_INTERVAL_SECONDS);\n+    fieldDataCacheEvictions.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(fieldDataCacheEvictions);\n+\n+    Metric fieldDataCacheSizeGroupByOperation = new AggregateMetric(EVALUATION_INTERVAL_SECONDS,\n+            Cache_FieldData_Size.NAME,\n+            AggregateFunction.SUM,\n+            MetricsDB.MAX, ShardStatsDerivedDimension.INDEX_NAME.toString());\n+    fieldDataCacheSizeGroupByOperation.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(fieldDataCacheSizeGroupByOperation);\n+\n+    FieldDataCacheRca fieldDataCacheNodeRca = new FieldDataCacheRca(RCA_PERIOD,\n+            fieldDataCacheEvictions,\n+            fieldDataCacheSizeGroupByOperation);\n+    fieldDataCacheNodeRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    fieldDataCacheNodeRca.addAllUpstreams(Collections.singletonList(fieldDataCacheEvictions));\n+\n+    FieldDataCacheClusterRca fieldDataCacheClusterRca = new FieldDataCacheClusterRca(RCA_PERIOD, fieldDataCacheNodeRca);\n+    fieldDataCacheClusterRca.addTag(TAG_LOCUS, LOCUS_MASTER_NODE);\n+    fieldDataCacheClusterRca.addAllUpstreams(Collections.singletonList(fieldDataCacheNodeRca));\n+    fieldDataCacheClusterRca.addTag(TAG_AGGREGATE_UPSTREAM, LOCUS_DATA_NODE);\n+\n+    // Shard Request Cache RCA\n+    Metric shardRequestCacheEvictions = new Cache_Request_Eviction(EVALUATION_INTERVAL_SECONDS);\n+    shardRequestCacheEvictions.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(shardRequestCacheEvictions);\n+    Metric shardRequestHits = new Cache_Request_Hit(EVALUATION_INTERVAL_SECONDS);\n+    shardRequestHits.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(shardRequestHits);\n+\n+    Metric shardRequestCacheSizeGroupByOperation = new AggregateMetric(EVALUATION_INTERVAL_SECONDS,\n+            Cache_Request_Size.NAME,\n+            AggregateFunction.SUM,\n+            MetricsDB.MAX, ShardStatsDerivedDimension.INDEX_NAME.toString());\n+    shardRequestCacheSizeGroupByOperation.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(shardRequestCacheSizeGroupByOperation);\n+\n+    ShardRequestCacheRca shardRequestCacheNodeRca = new ShardRequestCacheRca(RCA_PERIOD,\n+            shardRequestCacheEvictions,\n+            shardRequestHits,\n+            shardRequestCacheSizeGroupByOperation);\n+    shardRequestCacheNodeRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    shardRequestCacheNodeRca.addAllUpstreams(Collections.singletonList(shardRequestHits));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19e1e06072b73b682464350bac73b42f59d1165e"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4MTQ3OQ==", "bodyText": "Thank You for catching this issue, we need to add remainder metrics as well.  Adding them.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/330#discussion_r464581479", "createdAt": "2020-08-03T18:13:32Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ElasticSearchAnalysisGraph.java", "diffHunk": "@@ -203,6 +212,58 @@ public void construct() {\n     nodeConfigClusterCollector.addAllUpstreams(Collections.singletonList(nodeConfigCollector));\n     nodeConfigClusterCollector.addTag(TAG_AGGREGATE_UPSTREAM, LOCUS_DATA_NODE);\n \n+    // Field Data Cache RCA\n+    Metric fieldDataCacheEvictions = new Cache_FieldData_Eviction(EVALUATION_INTERVAL_SECONDS);\n+    fieldDataCacheEvictions.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(fieldDataCacheEvictions);\n+\n+    Metric fieldDataCacheSizeGroupByOperation = new AggregateMetric(EVALUATION_INTERVAL_SECONDS,\n+            Cache_FieldData_Size.NAME,\n+            AggregateFunction.SUM,\n+            MetricsDB.MAX, ShardStatsDerivedDimension.INDEX_NAME.toString());\n+    fieldDataCacheSizeGroupByOperation.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(fieldDataCacheSizeGroupByOperation);\n+\n+    FieldDataCacheRca fieldDataCacheNodeRca = new FieldDataCacheRca(RCA_PERIOD,\n+            fieldDataCacheEvictions,\n+            fieldDataCacheSizeGroupByOperation);\n+    fieldDataCacheNodeRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    fieldDataCacheNodeRca.addAllUpstreams(Collections.singletonList(fieldDataCacheEvictions));\n+\n+    FieldDataCacheClusterRca fieldDataCacheClusterRca = new FieldDataCacheClusterRca(RCA_PERIOD, fieldDataCacheNodeRca);\n+    fieldDataCacheClusterRca.addTag(TAG_LOCUS, LOCUS_MASTER_NODE);\n+    fieldDataCacheClusterRca.addAllUpstreams(Collections.singletonList(fieldDataCacheNodeRca));\n+    fieldDataCacheClusterRca.addTag(TAG_AGGREGATE_UPSTREAM, LOCUS_DATA_NODE);\n+\n+    // Shard Request Cache RCA\n+    Metric shardRequestCacheEvictions = new Cache_Request_Eviction(EVALUATION_INTERVAL_SECONDS);\n+    shardRequestCacheEvictions.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(shardRequestCacheEvictions);\n+    Metric shardRequestHits = new Cache_Request_Hit(EVALUATION_INTERVAL_SECONDS);\n+    shardRequestHits.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(shardRequestHits);\n+\n+    Metric shardRequestCacheSizeGroupByOperation = new AggregateMetric(EVALUATION_INTERVAL_SECONDS,\n+            Cache_Request_Size.NAME,\n+            AggregateFunction.SUM,\n+            MetricsDB.MAX, ShardStatsDerivedDimension.INDEX_NAME.toString());\n+    shardRequestCacheSizeGroupByOperation.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(shardRequestCacheSizeGroupByOperation);\n+\n+    ShardRequestCacheRca shardRequestCacheNodeRca = new ShardRequestCacheRca(RCA_PERIOD,\n+            shardRequestCacheEvictions,\n+            shardRequestHits,\n+            shardRequestCacheSizeGroupByOperation);\n+    shardRequestCacheNodeRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    shardRequestCacheNodeRca.addAllUpstreams(Collections.singletonList(shardRequestHits));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3ODM0MA=="}, "originalCommit": {"oid": "19e1e06072b73b682464350bac73b42f59d1165e"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYzODI4NQ==", "bodyText": "Fixed both FieldDataCacheRca and ShardRequestCacheRca", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/330#discussion_r464638285", "createdAt": "2020-08-03T20:14:53Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ElasticSearchAnalysisGraph.java", "diffHunk": "@@ -203,6 +212,58 @@ public void construct() {\n     nodeConfigClusterCollector.addAllUpstreams(Collections.singletonList(nodeConfigCollector));\n     nodeConfigClusterCollector.addTag(TAG_AGGREGATE_UPSTREAM, LOCUS_DATA_NODE);\n \n+    // Field Data Cache RCA\n+    Metric fieldDataCacheEvictions = new Cache_FieldData_Eviction(EVALUATION_INTERVAL_SECONDS);\n+    fieldDataCacheEvictions.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(fieldDataCacheEvictions);\n+\n+    Metric fieldDataCacheSizeGroupByOperation = new AggregateMetric(EVALUATION_INTERVAL_SECONDS,\n+            Cache_FieldData_Size.NAME,\n+            AggregateFunction.SUM,\n+            MetricsDB.MAX, ShardStatsDerivedDimension.INDEX_NAME.toString());\n+    fieldDataCacheSizeGroupByOperation.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(fieldDataCacheSizeGroupByOperation);\n+\n+    FieldDataCacheRca fieldDataCacheNodeRca = new FieldDataCacheRca(RCA_PERIOD,\n+            fieldDataCacheEvictions,\n+            fieldDataCacheSizeGroupByOperation);\n+    fieldDataCacheNodeRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    fieldDataCacheNodeRca.addAllUpstreams(Collections.singletonList(fieldDataCacheEvictions));\n+\n+    FieldDataCacheClusterRca fieldDataCacheClusterRca = new FieldDataCacheClusterRca(RCA_PERIOD, fieldDataCacheNodeRca);\n+    fieldDataCacheClusterRca.addTag(TAG_LOCUS, LOCUS_MASTER_NODE);\n+    fieldDataCacheClusterRca.addAllUpstreams(Collections.singletonList(fieldDataCacheNodeRca));\n+    fieldDataCacheClusterRca.addTag(TAG_AGGREGATE_UPSTREAM, LOCUS_DATA_NODE);\n+\n+    // Shard Request Cache RCA\n+    Metric shardRequestCacheEvictions = new Cache_Request_Eviction(EVALUATION_INTERVAL_SECONDS);\n+    shardRequestCacheEvictions.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(shardRequestCacheEvictions);\n+    Metric shardRequestHits = new Cache_Request_Hit(EVALUATION_INTERVAL_SECONDS);\n+    shardRequestHits.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(shardRequestHits);\n+\n+    Metric shardRequestCacheSizeGroupByOperation = new AggregateMetric(EVALUATION_INTERVAL_SECONDS,\n+            Cache_Request_Size.NAME,\n+            AggregateFunction.SUM,\n+            MetricsDB.MAX, ShardStatsDerivedDimension.INDEX_NAME.toString());\n+    shardRequestCacheSizeGroupByOperation.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    addLeaf(shardRequestCacheSizeGroupByOperation);\n+\n+    ShardRequestCacheRca shardRequestCacheNodeRca = new ShardRequestCacheRca(RCA_PERIOD,\n+            shardRequestCacheEvictions,\n+            shardRequestHits,\n+            shardRequestCacheSizeGroupByOperation);\n+    shardRequestCacheNodeRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    shardRequestCacheNodeRca.addAllUpstreams(Collections.singletonList(shardRequestHits));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3ODM0MA=="}, "originalCommit": {"oid": "19e1e06072b73b682464350bac73b42f59d1165e"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2330, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}