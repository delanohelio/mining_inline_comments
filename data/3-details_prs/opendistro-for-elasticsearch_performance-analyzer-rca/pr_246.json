{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0OTE0MDcw", "number": 246, "title": "Add a base class for cluster RCA and derive QueueRejectionClusterRca from it", "bodyText": "Issue #, if available:\nDescription of changes:\n\nAdd a baseline cluster level RCA\nDerive a QueueRejectionClusterRca which is the cluster level RCA for Queue rejection RCA from this base class\nadd UTs\n\nTests:\ntested on docker\nCode coverage percentage for this patch:\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-06-16T01:08:42Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246", "merged": true, "mergeCommit": {"oid": "be3f87ca2ae5f286aab7dff7895dfb682f228d0a"}, "closed": true, "closedAt": "2020-06-26T17:57:18Z", "author": {"login": "rguo-aws"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqrAeIAH2gAyNDM0OTE0MDcwOmRjYzBkYTZiOWE4MjFhYWI5MTk5NWEyMmNiOTBhMTc1ZjY0NTliZDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvHGEMgFqTQzODQ4OTY0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dcc0da6b9a821aab91995a22cb90a175f6459bd2", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/dcc0da6b9a821aab91995a22cb90a175f6459bd2", "committedDate": "2020-06-12T22:57:20Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "858c9e0bfc0d996fb1c533ad8b8d9b4a963d83f5", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/858c9e0bfc0d996fb1c533ad8b8d9b4a963d83f5", "committedDate": "2020-06-15T18:22:55Z", "message": "Merge remote-tracking branch 'origin' into rguo-cluster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d914a0840548abf537f84eef6b09a92d9b141ff", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4d914a0840548abf537f84eef6b09a92d9b141ff", "committedDate": "2020-06-16T01:01:25Z", "message": "Add a base class for cluster RCA BaseClusterRca"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d4118d6eb9b0f4cd77960684f97984aa462e6375", "committedDate": "2020-06-17T01:58:25Z", "message": "add support for subscribing multiple rca"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MTE0NjA4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#pullrequestreview-437114608", "createdAt": "2020-06-25T01:40:54Z", "commit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwMTo0MDo1NFrOGoongQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwMzo0NzoxOVrOGoqZFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2MTY5Nw==", "bodyText": "Can we add documentation around the table dimensions, for example, not sure what does the String denote here.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445261697", "createdAt": "2020-06-25T01:40:54Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/BaseClusterRca.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashBasedTable;\n+import com.google.common.collect.Table;\n+import java.time.Clock;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * This is a generic cluster level RCA which subscripts a single upstream node level RCA.\n+ * This cluster RCA maintains a Table to keep track of flowunits sending from different nodes across\n+ * the cluster. This table is a two dimensional table indexed by (NodeKey, Rca Name). This RCA will\n+ * mark the cluster as unhealthy if the flowunits from any data nodes are unhealthy.\n+ * <p></p>\n+ * A few protected variables that can be overridden by derived class:\n+ * numOfFlowUnitsInMap : number of consecutive flowunits stored in hashtable. Default is 1\n+ * collectFromMasterNode : whether this RCA collect flowunit from master nodes.\n+ * expirationTimeWindow : time window to determine whether flowunit in hashmap becomes stale\n+ */\n+public class BaseClusterRca extends Rca<ResourceFlowUnit<HotClusterSummary>> {\n+  private static final int DEFAULT_NUM_OF_FLOWUNITS = 1;\n+  private static final long TIMESTAMP_EXPIRATION_IN_MILLIS = TimeUnit.MINUTES.toMillis(10);\n+  private final List<Rca<ResourceFlowUnit<HotNodeSummary>>> nodeRcas;\n+  private final Table<NodeKey, String, LinkedList<ResourceFlowUnit<HotNodeSummary>>> nodeTable;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2NzkyMA==", "bodyText": "Execute pollFirst() until the size of linkedList is less than equal to numOfFlowUnitsInMap ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445267920", "createdAt": "2020-06-25T02:06:09Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/BaseClusterRca.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashBasedTable;\n+import com.google.common.collect.Table;\n+import java.time.Clock;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * This is a generic cluster level RCA which subscripts a single upstream node level RCA.\n+ * This cluster RCA maintains a Table to keep track of flowunits sending from different nodes across\n+ * the cluster. This table is a two dimensional table indexed by (NodeKey, Rca Name). This RCA will\n+ * mark the cluster as unhealthy if the flowunits from any data nodes are unhealthy.\n+ * <p></p>\n+ * A few protected variables that can be overridden by derived class:\n+ * numOfFlowUnitsInMap : number of consecutive flowunits stored in hashtable. Default is 1\n+ * collectFromMasterNode : whether this RCA collect flowunit from master nodes.\n+ * expirationTimeWindow : time window to determine whether flowunit in hashmap becomes stale\n+ */\n+public class BaseClusterRca extends Rca<ResourceFlowUnit<HotClusterSummary>> {\n+  private static final int DEFAULT_NUM_OF_FLOWUNITS = 1;\n+  private static final long TIMESTAMP_EXPIRATION_IN_MILLIS = TimeUnit.MINUTES.toMillis(10);\n+  private final List<Rca<ResourceFlowUnit<HotNodeSummary>>> nodeRcas;\n+  private final Table<NodeKey, String, LinkedList<ResourceFlowUnit<HotNodeSummary>>> nodeTable;\n+  private final int rcaPeriod;\n+  private int counter;\n+  protected Clock clock;\n+  protected int numOfFlowUnitsInMap;\n+  protected boolean collectFromMasterNode;\n+  protected long expirationTimeWindow;\n+\n+\n+  @SafeVarargs\n+  public <R extends Rca<ResourceFlowUnit<HotNodeSummary>>> BaseClusterRca(final int rcaPeriod,\n+      final R... nodeRca) {\n+    super(5);\n+    this.rcaPeriod = rcaPeriod;\n+    this.counter = 0;\n+    this.clock = Clock.systemUTC();\n+    this.numOfFlowUnitsInMap = DEFAULT_NUM_OF_FLOWUNITS;\n+    this.nodeTable = HashBasedTable.create();\n+    this.collectFromMasterNode = false;\n+    this.expirationTimeWindow = TIMESTAMP_EXPIRATION_IN_MILLIS;\n+    this.nodeRcas = Arrays.asList(nodeRca);\n+  }\n+\n+  @VisibleForTesting\n+  public void setClock(Clock clock) {\n+    this.clock = clock;\n+  }\n+\n+  @VisibleForTesting\n+  public void setCollectFromMasterNode(boolean collectFromMasterNode) {\n+    this.collectFromMasterNode = collectFromMasterNode;\n+  }\n+\n+  //add upstream flowunits collected from different nodes into Table\n+  private void addUpstreamFlowUnits(Rca<ResourceFlowUnit<HotNodeSummary>> nodeRca) {\n+    List<ResourceFlowUnit<HotNodeSummary>> flowUnits = nodeRca.getFlowUnits();\n+    for (ResourceFlowUnit<HotNodeSummary> flowUnit : flowUnits) {\n+      if (flowUnit.isEmpty()) {\n+        continue;\n+      }\n+      HotNodeSummary nodeSummary = flowUnit.getSummary();\n+      NodeKey nodeKey = new NodeKey(nodeSummary.getNodeID(), nodeSummary.getHostAddress());\n+\n+      if (nodeTable.get(nodeKey, nodeRca.name()) == null) {\n+        nodeTable.put(nodeKey, nodeRca.name(), new LinkedList<>());\n+      }\n+      LinkedList<ResourceFlowUnit<HotNodeSummary>> linkedList = nodeTable.get(nodeKey, nodeRca.name());\n+      linkedList.addLast(flowUnit);\n+      if (linkedList.size() > numOfFlowUnitsInMap) {\n+        linkedList.pollFirst();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2OTAwNw==", "bodyText": "Do we need NodeKey here or just  Host IP Address should be enough ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445269007", "createdAt": "2020-06-25T02:10:31Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/BaseClusterRca.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashBasedTable;\n+import com.google.common.collect.Table;\n+import java.time.Clock;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * This is a generic cluster level RCA which subscripts a single upstream node level RCA.\n+ * This cluster RCA maintains a Table to keep track of flowunits sending from different nodes across\n+ * the cluster. This table is a two dimensional table indexed by (NodeKey, Rca Name). This RCA will\n+ * mark the cluster as unhealthy if the flowunits from any data nodes are unhealthy.\n+ * <p></p>\n+ * A few protected variables that can be overridden by derived class:\n+ * numOfFlowUnitsInMap : number of consecutive flowunits stored in hashtable. Default is 1\n+ * collectFromMasterNode : whether this RCA collect flowunit from master nodes.\n+ * expirationTimeWindow : time window to determine whether flowunit in hashmap becomes stale\n+ */\n+public class BaseClusterRca extends Rca<ResourceFlowUnit<HotClusterSummary>> {\n+  private static final int DEFAULT_NUM_OF_FLOWUNITS = 1;\n+  private static final long TIMESTAMP_EXPIRATION_IN_MILLIS = TimeUnit.MINUTES.toMillis(10);\n+  private final List<Rca<ResourceFlowUnit<HotNodeSummary>>> nodeRcas;\n+  private final Table<NodeKey, String, LinkedList<ResourceFlowUnit<HotNodeSummary>>> nodeTable;\n+  private final int rcaPeriod;\n+  private int counter;\n+  protected Clock clock;\n+  protected int numOfFlowUnitsInMap;\n+  protected boolean collectFromMasterNode;\n+  protected long expirationTimeWindow;\n+\n+\n+  @SafeVarargs\n+  public <R extends Rca<ResourceFlowUnit<HotNodeSummary>>> BaseClusterRca(final int rcaPeriod,\n+      final R... nodeRca) {\n+    super(5);\n+    this.rcaPeriod = rcaPeriod;\n+    this.counter = 0;\n+    this.clock = Clock.systemUTC();\n+    this.numOfFlowUnitsInMap = DEFAULT_NUM_OF_FLOWUNITS;\n+    this.nodeTable = HashBasedTable.create();\n+    this.collectFromMasterNode = false;\n+    this.expirationTimeWindow = TIMESTAMP_EXPIRATION_IN_MILLIS;\n+    this.nodeRcas = Arrays.asList(nodeRca);\n+  }\n+\n+  @VisibleForTesting\n+  public void setClock(Clock clock) {\n+    this.clock = clock;\n+  }\n+\n+  @VisibleForTesting\n+  public void setCollectFromMasterNode(boolean collectFromMasterNode) {\n+    this.collectFromMasterNode = collectFromMasterNode;\n+  }\n+\n+  //add upstream flowunits collected from different nodes into Table\n+  private void addUpstreamFlowUnits(Rca<ResourceFlowUnit<HotNodeSummary>> nodeRca) {\n+    List<ResourceFlowUnit<HotNodeSummary>> flowUnits = nodeRca.getFlowUnits();\n+    for (ResourceFlowUnit<HotNodeSummary> flowUnit : flowUnits) {\n+      if (flowUnit.isEmpty()) {\n+        continue;\n+      }\n+      HotNodeSummary nodeSummary = flowUnit.getSummary();\n+      NodeKey nodeKey = new NodeKey(nodeSummary.getNodeID(), nodeSummary.getHostAddress());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI2OTkwOQ==", "bodyText": "How are we getting this list of nodes within Cluster? Are we polling ES here?\nIf yes, then we should definitely move this to use ClusterDetailsEventProcessor now then later.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445269909", "createdAt": "2020-06-25T02:14:21Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/BaseClusterRca.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashBasedTable;\n+import com.google.common.collect.Table;\n+import java.time.Clock;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * This is a generic cluster level RCA which subscripts a single upstream node level RCA.\n+ * This cluster RCA maintains a Table to keep track of flowunits sending from different nodes across\n+ * the cluster. This table is a two dimensional table indexed by (NodeKey, Rca Name). This RCA will\n+ * mark the cluster as unhealthy if the flowunits from any data nodes are unhealthy.\n+ * <p></p>\n+ * A few protected variables that can be overridden by derived class:\n+ * numOfFlowUnitsInMap : number of consecutive flowunits stored in hashtable. Default is 1\n+ * collectFromMasterNode : whether this RCA collect flowunit from master nodes.\n+ * expirationTimeWindow : time window to determine whether flowunit in hashmap becomes stale\n+ */\n+public class BaseClusterRca extends Rca<ResourceFlowUnit<HotClusterSummary>> {\n+  private static final int DEFAULT_NUM_OF_FLOWUNITS = 1;\n+  private static final long TIMESTAMP_EXPIRATION_IN_MILLIS = TimeUnit.MINUTES.toMillis(10);\n+  private final List<Rca<ResourceFlowUnit<HotNodeSummary>>> nodeRcas;\n+  private final Table<NodeKey, String, LinkedList<ResourceFlowUnit<HotNodeSummary>>> nodeTable;\n+  private final int rcaPeriod;\n+  private int counter;\n+  protected Clock clock;\n+  protected int numOfFlowUnitsInMap;\n+  protected boolean collectFromMasterNode;\n+  protected long expirationTimeWindow;\n+\n+\n+  @SafeVarargs\n+  public <R extends Rca<ResourceFlowUnit<HotNodeSummary>>> BaseClusterRca(final int rcaPeriod,\n+      final R... nodeRca) {\n+    super(5);\n+    this.rcaPeriod = rcaPeriod;\n+    this.counter = 0;\n+    this.clock = Clock.systemUTC();\n+    this.numOfFlowUnitsInMap = DEFAULT_NUM_OF_FLOWUNITS;\n+    this.nodeTable = HashBasedTable.create();\n+    this.collectFromMasterNode = false;\n+    this.expirationTimeWindow = TIMESTAMP_EXPIRATION_IN_MILLIS;\n+    this.nodeRcas = Arrays.asList(nodeRca);\n+  }\n+\n+  @VisibleForTesting\n+  public void setClock(Clock clock) {\n+    this.clock = clock;\n+  }\n+\n+  @VisibleForTesting\n+  public void setCollectFromMasterNode(boolean collectFromMasterNode) {\n+    this.collectFromMasterNode = collectFromMasterNode;\n+  }\n+\n+  //add upstream flowunits collected from different nodes into Table\n+  private void addUpstreamFlowUnits(Rca<ResourceFlowUnit<HotNodeSummary>> nodeRca) {\n+    List<ResourceFlowUnit<HotNodeSummary>> flowUnits = nodeRca.getFlowUnits();\n+    for (ResourceFlowUnit<HotNodeSummary> flowUnit : flowUnits) {\n+      if (flowUnit.isEmpty()) {\n+        continue;\n+      }\n+      HotNodeSummary nodeSummary = flowUnit.getSummary();\n+      NodeKey nodeKey = new NodeKey(nodeSummary.getNodeID(), nodeSummary.getHostAddress());\n+\n+      if (nodeTable.get(nodeKey, nodeRca.name()) == null) {\n+        nodeTable.put(nodeKey, nodeRca.name(), new LinkedList<>());\n+      }\n+      LinkedList<ResourceFlowUnit<HotNodeSummary>> linkedList = nodeTable.get(nodeKey, nodeRca.name());\n+      linkedList.addLast(flowUnit);\n+      if (linkedList.size() > numOfFlowUnitsInMap) {\n+        linkedList.pollFirst();\n+      }\n+    }\n+  }\n+\n+  private List<NodeDetails> getClusterNodesDetails() {\n+    if (collectFromMasterNode) {\n+      return ClusterDetailsEventProcessor.getNodesDetails();\n+    }\n+    else {\n+      return ClusterDetailsEventProcessor.getDataNodesDetails();\n+    }\n+  }\n+\n+  // TODO : we might need to change this function later to use EventListener\n+  // to update the nodeMap whenever the ClusterDetailsEventProcessor is updated\n+  // so we don't have to keep polling the NodeDetails in every time window.\n+  private void removeInactiveNodeFromNodeMap() {\n+    Set<String> nodeIdSet = new HashSet<>();\n+    List<NodeKey> inactiveNodes = new ArrayList<>();\n+    for (NodeDetails nodeDetail : getClusterNodesDetails()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI3MTMwMg==", "bodyText": "We can add a log statement here describing the inactiveNodes and their removal from nodeTable", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445271302", "createdAt": "2020-06-25T02:20:12Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/BaseClusterRca.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashBasedTable;\n+import com.google.common.collect.Table;\n+import java.time.Clock;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * This is a generic cluster level RCA which subscripts a single upstream node level RCA.\n+ * This cluster RCA maintains a Table to keep track of flowunits sending from different nodes across\n+ * the cluster. This table is a two dimensional table indexed by (NodeKey, Rca Name). This RCA will\n+ * mark the cluster as unhealthy if the flowunits from any data nodes are unhealthy.\n+ * <p></p>\n+ * A few protected variables that can be overridden by derived class:\n+ * numOfFlowUnitsInMap : number of consecutive flowunits stored in hashtable. Default is 1\n+ * collectFromMasterNode : whether this RCA collect flowunit from master nodes.\n+ * expirationTimeWindow : time window to determine whether flowunit in hashmap becomes stale\n+ */\n+public class BaseClusterRca extends Rca<ResourceFlowUnit<HotClusterSummary>> {\n+  private static final int DEFAULT_NUM_OF_FLOWUNITS = 1;\n+  private static final long TIMESTAMP_EXPIRATION_IN_MILLIS = TimeUnit.MINUTES.toMillis(10);\n+  private final List<Rca<ResourceFlowUnit<HotNodeSummary>>> nodeRcas;\n+  private final Table<NodeKey, String, LinkedList<ResourceFlowUnit<HotNodeSummary>>> nodeTable;\n+  private final int rcaPeriod;\n+  private int counter;\n+  protected Clock clock;\n+  protected int numOfFlowUnitsInMap;\n+  protected boolean collectFromMasterNode;\n+  protected long expirationTimeWindow;\n+\n+\n+  @SafeVarargs\n+  public <R extends Rca<ResourceFlowUnit<HotNodeSummary>>> BaseClusterRca(final int rcaPeriod,\n+      final R... nodeRca) {\n+    super(5);\n+    this.rcaPeriod = rcaPeriod;\n+    this.counter = 0;\n+    this.clock = Clock.systemUTC();\n+    this.numOfFlowUnitsInMap = DEFAULT_NUM_OF_FLOWUNITS;\n+    this.nodeTable = HashBasedTable.create();\n+    this.collectFromMasterNode = false;\n+    this.expirationTimeWindow = TIMESTAMP_EXPIRATION_IN_MILLIS;\n+    this.nodeRcas = Arrays.asList(nodeRca);\n+  }\n+\n+  @VisibleForTesting\n+  public void setClock(Clock clock) {\n+    this.clock = clock;\n+  }\n+\n+  @VisibleForTesting\n+  public void setCollectFromMasterNode(boolean collectFromMasterNode) {\n+    this.collectFromMasterNode = collectFromMasterNode;\n+  }\n+\n+  //add upstream flowunits collected from different nodes into Table\n+  private void addUpstreamFlowUnits(Rca<ResourceFlowUnit<HotNodeSummary>> nodeRca) {\n+    List<ResourceFlowUnit<HotNodeSummary>> flowUnits = nodeRca.getFlowUnits();\n+    for (ResourceFlowUnit<HotNodeSummary> flowUnit : flowUnits) {\n+      if (flowUnit.isEmpty()) {\n+        continue;\n+      }\n+      HotNodeSummary nodeSummary = flowUnit.getSummary();\n+      NodeKey nodeKey = new NodeKey(nodeSummary.getNodeID(), nodeSummary.getHostAddress());\n+\n+      if (nodeTable.get(nodeKey, nodeRca.name()) == null) {\n+        nodeTable.put(nodeKey, nodeRca.name(), new LinkedList<>());\n+      }\n+      LinkedList<ResourceFlowUnit<HotNodeSummary>> linkedList = nodeTable.get(nodeKey, nodeRca.name());\n+      linkedList.addLast(flowUnit);\n+      if (linkedList.size() > numOfFlowUnitsInMap) {\n+        linkedList.pollFirst();\n+      }\n+    }\n+  }\n+\n+  private List<NodeDetails> getClusterNodesDetails() {\n+    if (collectFromMasterNode) {\n+      return ClusterDetailsEventProcessor.getNodesDetails();\n+    }\n+    else {\n+      return ClusterDetailsEventProcessor.getDataNodesDetails();\n+    }\n+  }\n+\n+  // TODO : we might need to change this function later to use EventListener\n+  // to update the nodeMap whenever the ClusterDetailsEventProcessor is updated\n+  // so we don't have to keep polling the NodeDetails in every time window.\n+  private void removeInactiveNodeFromNodeMap() {\n+    Set<String> nodeIdSet = new HashSet<>();\n+    List<NodeKey> inactiveNodes = new ArrayList<>();\n+    for (NodeDetails nodeDetail : getClusterNodesDetails()) {\n+      nodeIdSet.add(nodeDetail.getId());\n+    }\n+    for (NodeKey nodeKey : nodeTable.rowKeySet()) {\n+      if (!nodeIdSet.contains(nodeKey.getNodeId())) {\n+        inactiveNodes.add(nodeKey);\n+      }\n+    }\n+    inactiveNodes.forEach(nodeKey -> nodeTable.row(nodeKey).clear());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI3MzE2Mg==", "bodyText": "generateFlowUnit() is invoked after removeInactiveNodeFromNodeMap(), where we refresh the active node lists.\nWe shouldn't be refreshing the list again here while generating flow units but instead, the consumer(decider) should take care of discarding any flowunits from inactive nodes.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445273162", "createdAt": "2020-06-25T02:27:57Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/BaseClusterRca.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashBasedTable;\n+import com.google.common.collect.Table;\n+import java.time.Clock;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * This is a generic cluster level RCA which subscripts a single upstream node level RCA.\n+ * This cluster RCA maintains a Table to keep track of flowunits sending from different nodes across\n+ * the cluster. This table is a two dimensional table indexed by (NodeKey, Rca Name). This RCA will\n+ * mark the cluster as unhealthy if the flowunits from any data nodes are unhealthy.\n+ * <p></p>\n+ * A few protected variables that can be overridden by derived class:\n+ * numOfFlowUnitsInMap : number of consecutive flowunits stored in hashtable. Default is 1\n+ * collectFromMasterNode : whether this RCA collect flowunit from master nodes.\n+ * expirationTimeWindow : time window to determine whether flowunit in hashmap becomes stale\n+ */\n+public class BaseClusterRca extends Rca<ResourceFlowUnit<HotClusterSummary>> {\n+  private static final int DEFAULT_NUM_OF_FLOWUNITS = 1;\n+  private static final long TIMESTAMP_EXPIRATION_IN_MILLIS = TimeUnit.MINUTES.toMillis(10);\n+  private final List<Rca<ResourceFlowUnit<HotNodeSummary>>> nodeRcas;\n+  private final Table<NodeKey, String, LinkedList<ResourceFlowUnit<HotNodeSummary>>> nodeTable;\n+  private final int rcaPeriod;\n+  private int counter;\n+  protected Clock clock;\n+  protected int numOfFlowUnitsInMap;\n+  protected boolean collectFromMasterNode;\n+  protected long expirationTimeWindow;\n+\n+\n+  @SafeVarargs\n+  public <R extends Rca<ResourceFlowUnit<HotNodeSummary>>> BaseClusterRca(final int rcaPeriod,\n+      final R... nodeRca) {\n+    super(5);\n+    this.rcaPeriod = rcaPeriod;\n+    this.counter = 0;\n+    this.clock = Clock.systemUTC();\n+    this.numOfFlowUnitsInMap = DEFAULT_NUM_OF_FLOWUNITS;\n+    this.nodeTable = HashBasedTable.create();\n+    this.collectFromMasterNode = false;\n+    this.expirationTimeWindow = TIMESTAMP_EXPIRATION_IN_MILLIS;\n+    this.nodeRcas = Arrays.asList(nodeRca);\n+  }\n+\n+  @VisibleForTesting\n+  public void setClock(Clock clock) {\n+    this.clock = clock;\n+  }\n+\n+  @VisibleForTesting\n+  public void setCollectFromMasterNode(boolean collectFromMasterNode) {\n+    this.collectFromMasterNode = collectFromMasterNode;\n+  }\n+\n+  //add upstream flowunits collected from different nodes into Table\n+  private void addUpstreamFlowUnits(Rca<ResourceFlowUnit<HotNodeSummary>> nodeRca) {\n+    List<ResourceFlowUnit<HotNodeSummary>> flowUnits = nodeRca.getFlowUnits();\n+    for (ResourceFlowUnit<HotNodeSummary> flowUnit : flowUnits) {\n+      if (flowUnit.isEmpty()) {\n+        continue;\n+      }\n+      HotNodeSummary nodeSummary = flowUnit.getSummary();\n+      NodeKey nodeKey = new NodeKey(nodeSummary.getNodeID(), nodeSummary.getHostAddress());\n+\n+      if (nodeTable.get(nodeKey, nodeRca.name()) == null) {\n+        nodeTable.put(nodeKey, nodeRca.name(), new LinkedList<>());\n+      }\n+      LinkedList<ResourceFlowUnit<HotNodeSummary>> linkedList = nodeTable.get(nodeKey, nodeRca.name());\n+      linkedList.addLast(flowUnit);\n+      if (linkedList.size() > numOfFlowUnitsInMap) {\n+        linkedList.pollFirst();\n+      }\n+    }\n+  }\n+\n+  private List<NodeDetails> getClusterNodesDetails() {\n+    if (collectFromMasterNode) {\n+      return ClusterDetailsEventProcessor.getNodesDetails();\n+    }\n+    else {\n+      return ClusterDetailsEventProcessor.getDataNodesDetails();\n+    }\n+  }\n+\n+  // TODO : we might need to change this function later to use EventListener\n+  // to update the nodeMap whenever the ClusterDetailsEventProcessor is updated\n+  // so we don't have to keep polling the NodeDetails in every time window.\n+  private void removeInactiveNodeFromNodeMap() {\n+    Set<String> nodeIdSet = new HashSet<>();\n+    List<NodeKey> inactiveNodes = new ArrayList<>();\n+    for (NodeDetails nodeDetail : getClusterNodesDetails()) {\n+      nodeIdSet.add(nodeDetail.getId());\n+    }\n+    for (NodeKey nodeKey : nodeTable.rowKeySet()) {\n+      if (!nodeIdSet.contains(nodeKey.getNodeId())) {\n+        inactiveNodes.add(nodeKey);\n+      }\n+    }\n+    inactiveNodes.forEach(nodeKey -> nodeTable.row(nodeKey).clear());\n+  }\n+\n+  /**\n+   * generate flowunit for downstream based on the flowunits this RCA collects in hashmap\n+   * flowunits with timestamp beyond expirationTimeWindow time frame are  considered\n+   * as stale and ignored by this RCA.\n+   * @return flowunit for downstream vertices\n+   */\n+  private ResourceFlowUnit<HotClusterSummary> generateFlowUnit() {\n+    List<HotNodeSummary> unhealthyNodeSummaries = new ArrayList<>();\n+    long timestamp = clock.millis();\n+    List<NodeDetails> clusterNodesDetails = getClusterNodesDetails();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI3Nzk0NA==", "bodyText": "Suppose a node went down and came back up, the node will have the same hostAddress but the nodeId would change.\nSo, for such a case, we should ideally not treat this node as a new node and thus, match here based on the hostAddress. Thoughts?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445277944", "createdAt": "2020-06-25T02:48:17Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/NodeKey.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+public class NodeKey {\n+  private final String nodeId;\n+  private final String hostAddress;\n+\n+  public NodeKey(String nodeId, String hostAddress) {\n+    this.nodeId = nodeId;\n+    this.hostAddress = hostAddress;\n+  }\n+\n+  public String getNodeId() {\n+    return nodeId;\n+  }\n+\n+  public String getHostAddress() {\n+    return hostAddress;\n+  }\n+\n+  @Override\n+  public boolean equals(Object obj) {\n+    if (obj instanceof NodeKey) {\n+      NodeKey key = (NodeKey)obj;\n+      return nodeId.equals(key.getNodeId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI3ODYyNw==", "bodyText": "String based hashCode methods are inconsistent across different process and machines. Can we use something like below :\nHashCodeBuilder(17, 37)\n            .append(nodeId)\n            .toHashCode();", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445278627", "createdAt": "2020-06-25T02:51:04Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/NodeKey.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+public class NodeKey {\n+  private final String nodeId;\n+  private final String hostAddress;\n+\n+  public NodeKey(String nodeId, String hostAddress) {\n+    this.nodeId = nodeId;\n+    this.hostAddress = hostAddress;\n+  }\n+\n+  public String getNodeId() {\n+    return nodeId;\n+  }\n+\n+  public String getHostAddress() {\n+    return hostAddress;\n+  }\n+\n+  @Override\n+  public boolean equals(Object obj) {\n+    if (obj instanceof NodeKey) {\n+      NodeKey key = (NodeKey)obj;\n+      return nodeId.equals(key.getNodeId());\n+    }\n+    return false;\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    return nodeId.hashCode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI5MDc3Mw==", "bodyText": "We can 2 things here:\n\ndeclare the table nodeTable as protected, so in case we want to add other functionality in the sub class, we have access to nodeTable\nInstead of declaring the table in base class, we declare it in subclass and pass it around as a parameter.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445290773", "createdAt": "2020-06-25T03:47:19Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/BaseClusterRca.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashBasedTable;\n+import com.google.common.collect.Table;\n+import java.time.Clock;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * This is a generic cluster level RCA which subscripts a single upstream node level RCA.\n+ * This cluster RCA maintains a Table to keep track of flowunits sending from different nodes across\n+ * the cluster. This table is a two dimensional table indexed by (NodeKey, Rca Name). This RCA will\n+ * mark the cluster as unhealthy if the flowunits from any data nodes are unhealthy.\n+ * <p></p>\n+ * A few protected variables that can be overridden by derived class:\n+ * numOfFlowUnitsInMap : number of consecutive flowunits stored in hashtable. Default is 1\n+ * collectFromMasterNode : whether this RCA collect flowunit from master nodes.\n+ * expirationTimeWindow : time window to determine whether flowunit in hashmap becomes stale\n+ */\n+public class BaseClusterRca extends Rca<ResourceFlowUnit<HotClusterSummary>> {\n+  private static final int DEFAULT_NUM_OF_FLOWUNITS = 1;\n+  private static final long TIMESTAMP_EXPIRATION_IN_MILLIS = TimeUnit.MINUTES.toMillis(10);\n+  private final List<Rca<ResourceFlowUnit<HotNodeSummary>>> nodeRcas;\n+  private final Table<NodeKey, String, LinkedList<ResourceFlowUnit<HotNodeSummary>>> nodeTable;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NzYzNDIz", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#pullrequestreview-437763423", "createdAt": "2020-06-25T18:42:28Z", "commit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxODo0MjoyOFrOGpHPtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxODo0NDowMlrOGpHWAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc2MzUwOQ==", "bodyText": "Should this class also keep track of the fact that all NodeLevel RCAs are received within a time window or mark the node as unhealthy for missing heartbeat ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445763509", "createdAt": "2020-06-25T18:42:28Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/BaseClusterRca.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashBasedTable;\n+import com.google.common.collect.Table;\n+import java.time.Clock;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * This is a generic cluster level RCA which subscripts a single upstream node level RCA.\n+ * This cluster RCA maintains a Table to keep track of flowunits sending from different nodes across\n+ * the cluster. This table is a two dimensional table indexed by (NodeKey, Rca Name). This RCA will\n+ * mark the cluster as unhealthy if the flowunits from any data nodes are unhealthy.\n+ * <p></p>\n+ * A few protected variables that can be overridden by derived class:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc2NTEyMA==", "bodyText": "If we are building a base class for all RCA types, can we keep the HotClusterSummary part generic so that TemperatureProfile RCAs can make use of it as well ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r445765120", "createdAt": "2020-06-25T18:44:02Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/BaseClusterRca.java", "diffHunk": "@@ -0,0 +1,227 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashBasedTable;\n+import com.google.common.collect.Table;\n+import java.time.Clock;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * This is a generic cluster level RCA which subscripts a single upstream node level RCA.\n+ * This cluster RCA maintains a Table to keep track of flowunits sending from different nodes across\n+ * the cluster. This table is a two dimensional table indexed by (NodeKey, Rca Name). This RCA will\n+ * mark the cluster as unhealthy if the flowunits from any data nodes are unhealthy.\n+ * <p></p>\n+ * A few protected variables that can be overridden by derived class:\n+ * numOfFlowUnitsInMap : number of consecutive flowunits stored in hashtable. Default is 1\n+ * collectFromMasterNode : whether this RCA collect flowunit from master nodes.\n+ * expirationTimeWindow : time window to determine whether flowunit in hashmap becomes stale\n+ */\n+public class BaseClusterRca extends Rca<ResourceFlowUnit<HotClusterSummary>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4118d6eb9b0f4cd77960684f97984aa462e6375"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e02f212b22190dcc0b7cc38c8f4cd2d6079ae0e", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/8e02f212b22190dcc0b7cc38c8f4cd2d6079ae0e", "committedDate": "2020-06-25T21:01:22Z", "message": "Merge remote-tracking branch 'origin/master' into rguo-cluster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97a182bc7fff91a9cf26fa2b8c0aff8ee8be3139", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/97a182bc7fff91a9cf26fa2b8c0aff8ee8be3139", "committedDate": "2020-06-25T21:59:25Z", "message": "Address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4288e7885672ea7e09ded900f3650d85b190b3d5", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4288e7885672ea7e09ded900f3650d85b190b3d5", "committedDate": "2020-06-26T01:16:27Z", "message": "Address more PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDc1MDQ2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#pullrequestreview-438475046", "createdAt": "2020-06-26T17:33:00Z", "commit": {"oid": "4288e7885672ea7e09ded900f3650d85b190b3d5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzozMzowMFrOGppHnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzozMzowMFrOGppHnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMxODQ5Mg==", "bodyText": "Can't this be done inside the above for loop?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r446318492", "createdAt": "2020-06-26T17:33:00Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/BaseClusterRca.java", "diffHunk": "@@ -0,0 +1,237 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor.NodeDetails;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashBasedTable;\n+import com.google.common.collect.Table;\n+import java.time.Clock;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * This is a generic cluster level RCA which subscripts upstream node level RCAs and generate a flowunit\n+ * with cluster level summary that concludes the healthiness of the cluster in terms of those node level RCAs.\n+ * This cluster RCA maintains a Table to keep track of flowunits sending from different nodes across\n+ * the cluster. This table is a two dimensional table indexed by (NodeKey, Rca Name) and each cells stores\n+ * that last numOfFlowUnitsInMap flowunits it receives. This RCA will\n+ * mark the cluster as unhealthy if the flowunits from any data nodes are unhealthy.\n+ * <p></p>\n+ * A few protected variables that can be overridden by derived class:\n+ * numOfFlowUnitsInMap : number of consecutive flowunits stored in hashtable. Default is 1\n+ * collectFromMasterNode : whether this RCA collect flowunit from master nodes.\n+ * expirationTimeWindow : time window to determine whether flowunit in hashmap becomes stale\n+ * method that can be overriden :\n+ * generateNodeSummary(NodeKey) : how do we want to parse the table and generate summary for one node.\n+ */\n+public class BaseClusterRca extends Rca<ResourceFlowUnit<HotClusterSummary>> {\n+\n+  private static final Logger LOG = LogManager.getLogger(BaseClusterRca.class);\n+  private static final int DEFAULT_NUM_OF_FLOWUNITS = 1;\n+  private static final long TIMESTAMP_EXPIRATION_IN_MILLIS = TimeUnit.MINUTES.toMillis(10);\n+  private final List<Rca<ResourceFlowUnit<HotNodeSummary>>> nodeRcas;\n+  // two dimensional table indexed by (NodeKey, Rca Name) => last numOfFlowUnitsInMap flowunits\n+  protected final Table<NodeKey, String, LinkedList<ResourceFlowUnit<HotNodeSummary>>> nodeTable;\n+  private final int rcaPeriod;\n+  private int counter;\n+  protected Clock clock;\n+  protected int numOfFlowUnitsInMap;\n+  protected boolean collectFromMasterNode;\n+  protected long expirationTimeWindow;\n+\n+\n+  @SafeVarargs\n+  public <R extends Rca<ResourceFlowUnit<HotNodeSummary>>> BaseClusterRca(final int rcaPeriod,\n+      final R... nodeRca) {\n+    super(5);\n+    this.rcaPeriod = rcaPeriod;\n+    this.counter = 0;\n+    this.clock = Clock.systemUTC();\n+    this.numOfFlowUnitsInMap = DEFAULT_NUM_OF_FLOWUNITS;\n+    this.nodeTable = HashBasedTable.create();\n+    this.collectFromMasterNode = false;\n+    this.expirationTimeWindow = TIMESTAMP_EXPIRATION_IN_MILLIS;\n+    this.nodeRcas = Arrays.asList(nodeRca);\n+  }\n+\n+  @VisibleForTesting\n+  public void setClock(Clock clock) {\n+    this.clock = clock;\n+  }\n+\n+  @VisibleForTesting\n+  public void setCollectFromMasterNode(boolean collectFromMasterNode) {\n+    this.collectFromMasterNode = collectFromMasterNode;\n+  }\n+\n+  //add upstream flowunits collected from different nodes into Table\n+  private void addUpstreamFlowUnits(Rca<ResourceFlowUnit<HotNodeSummary>> nodeRca) {\n+    List<ResourceFlowUnit<HotNodeSummary>> flowUnits = nodeRca.getFlowUnits();\n+    for (ResourceFlowUnit<HotNodeSummary> flowUnit : flowUnits) {\n+      if (flowUnit.isEmpty()) {\n+        continue;\n+      }\n+      HotNodeSummary nodeSummary = flowUnit.getSummary();\n+      NodeKey nodeKey = new NodeKey(nodeSummary.getNodeID(), nodeSummary.getHostAddress());\n+\n+      if (nodeTable.get(nodeKey, nodeRca.name()) == null) {\n+        nodeTable.put(nodeKey, nodeRca.name(), new LinkedList<>());\n+      }\n+      LinkedList<ResourceFlowUnit<HotNodeSummary>> linkedList = nodeTable.get(nodeKey, nodeRca.name());\n+      linkedList.addLast(flowUnit);\n+      if (linkedList.size() > numOfFlowUnitsInMap) {\n+        linkedList.pollFirst();\n+      }\n+    }\n+  }\n+\n+  private List<NodeDetails> getClusterNodesDetails() {\n+    if (collectFromMasterNode) {\n+      return ClusterDetailsEventProcessor.getNodesDetails();\n+    }\n+    else {\n+      return ClusterDetailsEventProcessor.getDataNodesDetails();\n+    }\n+  }\n+\n+  // TODO : we might need to change this function later to use EventListener\n+  // to update the nodeMap whenever the ClusterDetailsEventProcessor is updated\n+  // so we don't have to keep polling the NodeDetails in every time window.\n+  private void removeInactiveNodeFromNodeMap() {\n+    Set<String> nodeIdSet = new HashSet<>();\n+    List<NodeKey> inactiveNodes = new ArrayList<>();\n+    for (NodeDetails nodeDetail : getClusterNodesDetails()) {\n+      nodeIdSet.add(nodeDetail.getId());\n+    }\n+    for (NodeKey nodeKey : nodeTable.rowKeySet()) {\n+      if (!nodeIdSet.contains(nodeKey.getNodeId())) {\n+        inactiveNodes.add(nodeKey);\n+        LOG.info(\"RCA: remove node {} from node map\", nodeKey);\n+      }\n+    }\n+    inactiveNodes.forEach(nodeKey -> nodeTable.row(nodeKey).clear());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4288e7885672ea7e09ded900f3650d85b190b3d5"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDg5NjQ0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#pullrequestreview-438489644", "createdAt": "2020-06-26T17:56:17Z", "commit": {"oid": "4288e7885672ea7e09ded900f3650d85b190b3d5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzo1NjoxN1rOGppyyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNzo1NjoxN1rOGppyyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyOTU0NQ==", "bodyText": "Great that we updated the equals and hashCode method here to include hostAddress", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/246#discussion_r446329545", "createdAt": "2020-06-26T17:56:17Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/cluster/NodeKey.java", "diffHunk": "@@ -36,13 +38,25 @@ public String getHostAddress() {\n   public boolean equals(Object obj) {\n     if (obj instanceof NodeKey) {\n       NodeKey key = (NodeKey)obj;\n-      return nodeId.equals(key.getNodeId());\n+      return nodeId.equals(key.getNodeId()) && hostAddress.equals(key.getHostAddress());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4288e7885672ea7e09ded900f3650d85b190b3d5"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1047, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}