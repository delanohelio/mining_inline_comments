{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MjQwMDE2", "number": 254, "title": "Add required mutual auth to gRPC Server/Client", "bodyText": "Issue #, if available: 253\nDescription of changes:\nPreviously we had 1 sided TLS on the server side. Data between the\nclient and server was send over an encrypted channel, but any client\ncould make requests to the server.\nThis commit changes the behavior so that only clients with the matching\ncertificates can make requests to the server when TLS is enabled. This\ncommit does NOT add support for installing a trust manager. That must be\nadded in the future.\nTests:\n\nGRPCTest verifies that when https is enabled, an authenticated client is capable of making\nrequests, but an unauthenticated client is rejected.\n\nCode coverage percentage for this patch:\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-06-23T00:12:12Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254", "merged": true, "mergeCommit": {"oid": "b39d25278b1708256b61776ccbc62f129e433cb7"}, "closed": true, "closedAt": "2020-07-14T21:59:08Z", "author": {"login": "sidheart"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuy2u1AFqTQzNzc0NzMzNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc08WoXAH2gAyNDM4MjQwMDE2Ojg3ZTE4ZTNjMzBmYjFiMWUzNzY4YTgwNGE1ZjZmNmNmMTNjODMzMDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NzQ3MzM3", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#pullrequestreview-437747337", "createdAt": "2020-06-25T18:21:06Z", "commit": {"oid": "14b22c7aa1d54b83243440b5b8b07dc9989fd6f3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxODoyMTowNlrOGpGfdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxODoyMTowNlrOGpGfdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc1MTE1Nw==", "bodyText": "This is awesome. Thanks for adding UTs around it", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r445751157", "createdAt": "2020-06-25T18:21:06Z", "author": {"login": "yojs"}, "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.net;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14b22c7aa1d54b83243440b5b8b07dc9989fd6f3"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2OTM5MDQ1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#pullrequestreview-436939045", "createdAt": "2020-06-24T19:22:21Z", "commit": {"oid": "14b22c7aa1d54b83243440b5b8b07dc9989fd6f3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxOToyMjoyMVrOGof3xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNzoyODo0OFrOGqICEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTExODQwNA==", "bodyText": "Do we need these changes for this PR? Are we saying we will take up to 4GB of heap to build this component? :)", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r445118404", "createdAt": "2020-06-24T19:22:21Z", "author": {"login": "ktkrg"}, "path": "gradle.properties", "diffHunk": "@@ -13,4 +13,5 @@\n #  permissions and limitations under the License.\n #\n \n-localPaDir=../performance-analyzer\n\\ No newline at end of file\n+localPaDir=../performance-analyzer\n+org.gradle.jvmargs=-Xmx4096m -XX:MaxPermSize=256m", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14b22c7aa1d54b83243440b5b8b07dc9989fd6f3"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc5NTk1Ng==", "bodyText": "Let's not force this on our customers to use the same cert as both server and client certs. They can have different certs for client and server authentication, so lets make this configurable.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r446795956", "createdAt": "2020-06-29T06:20:33Z", "author": {"login": "ktkrg"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCConnectionManager.java", "diffHunk": "@@ -145,12 +149,14 @@ private ManagedChannel buildInsecureChannel(final String remoteHost) {\n \n   private ManagedChannel buildSecureChannel(final String remoteHost) {\n     try {\n+      File certFile = CertificateUtils.getCertificateFile();\n+      File pkeyFile = CertificateUtils.getPrivateKeyFile();\n       return NettyChannelBuilder.forAddress(remoteHost, Util.RPC_PORT)\n                                 .sslContext(\n                                     GrpcSslContexts.forClient()\n-                                                   .trustManager(\n-                                                       InsecureTrustManagerFactory.INSTANCE)\n-                                                   .build())\n+                                            .trustManager(InsecureTrustManagerFactory.INSTANCE)\n+                                            .keyManager(certFile, pkeyFile)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14b22c7aa1d54b83243440b5b8b07dc9989fd6f3"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgyNDk3Ng==", "bodyText": "Are you sure you tested this change? We don't want to stop the server, it'll kill perftop and the ability to query metrics as well. If you want to change the behavior, I'd suggest we create a new issue and address this the right way in a new PR.\nFor the short term, you can consider renaming the method to removeRcaHandlers() or something like that.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r446824976", "createdAt": "2020-06-29T07:28:48Z", "author": {"login": "ktkrg"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetServer.java", "diffHunk": "@@ -234,5 +246,14 @@ public void stop() {\n     // Remove handlers.\n     sendDataHandler = null;\n     subscribeHandler = null;\n+\n+    if (server != null) {\n+      server.shutdown();\n+      try {\n+        server.awaitTermination(1, TimeUnit.MINUTES);\n+      } catch (InterruptedException e) {\n+        server.shutdownNow();\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14b22c7aa1d54b83243440b5b8b07dc9989fd6f3"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDIxNDA2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#pullrequestreview-448421406", "createdAt": "2020-07-14T19:59:07Z", "commit": {"oid": "4b13b629f440275c9eb01562ba41decebb01404b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxOTo1OTowN1rOGxjHsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxOTo1OTowN1rOGxjHsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYwODgxNw==", "bodyText": "nit: whitespace off by one.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r454608817", "createdAt": "2020-07-14T19:59:07Z", "author": {"login": "ktkrg"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCConnectionManager.java", "diffHunk": "@@ -140,26 +171,26 @@ private ManagedChannel buildChannelForHost(final String remoteHost) {\n   }\n \n   private ManagedChannel buildInsecureChannel(final String remoteHost) {\n-    return ManagedChannelBuilder.forAddress(remoteHost, Util.RPC_PORT).usePlaintext().build();\n+    return ManagedChannelBuilder.forAddress(remoteHost, this.port).usePlaintext().build();\n   }\n \n-  private ManagedChannel buildSecureChannel(final String remoteHost) {\n-    try {\n-      return NettyChannelBuilder.forAddress(remoteHost, Util.RPC_PORT)\n-                                .sslContext(\n-                                    GrpcSslContexts.forClient()\n-                                                   .trustManager(\n-                                                       InsecureTrustManagerFactory.INSTANCE)\n-                                                   .build())\n-                                .build();\n-    } catch (SSLException e) {\n-      LOG.error(\"Unable to build an SSL gRPC client. Exception: {}\", e.getMessage());\n-      e.printStackTrace();\n-\n-      // Wrap the SSL Exception in a generic RTE and re-throw.\n-      throw new RuntimeException(e);\n-    }\n-  }\n+   private ManagedChannel buildSecureChannel(final String remoteHost) {\n+     try {\n+       SslContextBuilder sslContextBuilder = GrpcSslContexts.forClient().keyManager(certFile, pkeyFile);\n+       if (trustedCasFile != null) {\n+         sslContextBuilder.trustManager(trustedCasFile);\n+       }\n+       return NettyChannelBuilder.forAddress(remoteHost, this.port)\n+               .sslContext(sslContextBuilder.build())\n+               .build();\n+     } catch (SSLException e) {\n+       LOG.error(\"Unable to build an SSL gRPC client. Exception: {}\", e.getMessage());\n+       e.printStackTrace();\n+\n+       // Wrap the SSL Exception in a generic RTE and re-throw.\n+       throw new RuntimeException(e);\n+     }\n+   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b13b629f440275c9eb01562ba41decebb01404b"}, "originalPosition": 107}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDI4NTcw", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#pullrequestreview-448428570", "createdAt": "2020-07-14T20:10:10Z", "commit": {"oid": "4b13b629f440275c9eb01562ba41decebb01404b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMDoxMDoxMFrOGxjeXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMDoxMDoxMFrOGxjeXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxNDYyMQ==", "bodyText": "You need to propagate the interrupted status when catching an InterruptedException by calling Thread.currentThread().interrupt() after channel.shutdownNow();", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r454614621", "createdAt": "2020-07-14T20:10:10Z", "author": {"login": "ktkrg"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/GRPCConnectionManager.java", "diffHunk": "@@ -177,7 +208,15 @@ private void removeAllStubs() {\n   private void terminateAllConnections() {\n     for (Map.Entry<String, AtomicReference<ManagedChannel>> entry : perHostChannelMap.entrySet()) {\n       LOG.debug(\"shutting down connection to host: {}\", entry.getKey());\n-      entry.getValue().get().shutdownNow();\n+      ManagedChannel channel = entry.getValue().get();\n+      channel.shutdownNow();\n+      try {\n+        channel.awaitTermination(1, TimeUnit.MINUTES);\n+      } catch (InterruptedException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b13b629f440275c9eb01562ba41decebb01404b"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDM1MTY3", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#pullrequestreview-448435167", "createdAt": "2020-07-14T20:20:18Z", "commit": {"oid": "4b13b629f440275c9eb01562ba41decebb01404b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMDoyMDoxOFrOGxjydQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMDoyMDoxOFrOGxjydQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxOTc2NQ==", "bodyText": "Same comment as above. You need to propagate the interrupted status by calling Thread.currentThread().interrupt();", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#discussion_r454619765", "createdAt": "2020-07-14T20:20:18Z", "author": {"login": "ktkrg"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/net/NetServer.java", "diffHunk": "@@ -235,4 +254,17 @@ public void stop() {\n     sendDataHandler = null;\n     subscribeHandler = null;\n   }\n+\n+  public void shutdown() {\n+    stop();\n+    // Actually stop the server\n+    if (server != null) {\n+      server.shutdown();\n+      try {\n+        server.awaitTermination(1, TimeUnit.MINUTES);\n+      } catch (InterruptedException e) {\n+        server.shutdownNow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b13b629f440275c9eb01562ba41decebb01404b"}, "originalPosition": 137}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDM2MjYz", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/254#pullrequestreview-448436263", "createdAt": "2020-07-14T20:21:55Z", "commit": {"oid": "4b13b629f440275c9eb01562ba41decebb01404b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "784dce09527833f70be14466d8f61f0472bb8b81", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/784dce09527833f70be14466d8f61f0472bb8b81", "committedDate": "2020-07-14T20:27:54Z", "message": "Add required mutual auth to gRPC Server/Client\n\nPreviously we had 1 sided TLS on the server side. Data between the\nclient and server was send over an encrypted channel, but any client\ncould make requests to the server.\n\nThis commit changes the behavior so that only clients with the matching\ncertificates can make requests to the server when TLS is enabled. This\ncommit does NOT add support for installing a trust manager. That must be\nadded in the future."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0313e315b586e4cf6f1eee64b53841282221bd6", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/c0313e315b586e4cf6f1eee64b53841282221bd6", "committedDate": "2020-07-14T20:27:54Z", "message": "Add full mutual auth to gRPC client/server and augment tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73d110eaf9dc742d1d4f93ca63d84cefa8a95445", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/73d110eaf9dc742d1d4f93ca63d84cefa8a95445", "committedDate": "2020-07-14T20:29:39Z", "message": "Address PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b13b629f440275c9eb01562ba41decebb01404b", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4b13b629f440275c9eb01562ba41decebb01404b", "committedDate": "2020-07-01T17:48:09Z", "message": "Add full mutual auth to gRPC client/server and augment tests"}, "afterCommit": {"oid": "73d110eaf9dc742d1d4f93ca63d84cefa8a95445", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/73d110eaf9dc742d1d4f93ca63d84cefa8a95445", "committedDate": "2020-07-14T20:29:39Z", "message": "Address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "710e229eb49029e602ea2295f1140d362983352f", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/710e229eb49029e602ea2295f1140d362983352f", "committedDate": "2020-07-14T20:39:01Z", "message": "Make GRPCTest work with a testing port"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87e18e3c30fb1b1e3768a804a5f6f6cf13c83305", "author": {"user": {"login": "sidheart", "name": "Sid Narayan"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/87e18e3c30fb1b1e3768a804a5f6f6cf13c83305", "committedDate": "2020-07-14T20:49:10Z", "message": "Increase nonTLSGetMetricsFails() timeout"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1053, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}