{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2MTU3ODE0", "number": 402, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoxMDoyNVrOEeZKnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoyNDowNVrOEeZbmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMzA1MDUyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyCacheMaxSizeAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoxMDoyNVrOHKBRkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMTowNDozOVrOHKJLrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2ODY5MQ==", "bodyText": "maybe it would be better to pass CacheActionConfig in builder ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480268691", "createdAt": "2020-08-31T17:10:25Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyCacheMaxSizeAction.java", "diffHunk": "@@ -153,34 +158,46 @@ public ResourceEnum getCacheType() {\n     private Long currentCacheMaxSizeInBytes;\n     private Long desiredCacheMaxSizeInBytes;\n     private Long heapMaxSizeInBytes;\n+    private final long upperBoundInBytes;\n+    private final long lowerBoundInBytes;\n \n     private Builder(\n         final NodeKey esNode,\n         final ResourceEnum cacheType,\n         final AppContext appContext,\n-        double upperBoundThreshold) {\n+        final RcaConf conf) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5ODI1NQ==", "bodyText": "That was the original thought. But I went with this approach for the following reasons -\n\nConsumers should not have to handle which config to pass to which object. The object should be able to self extract its own relevant config.\nWanted to keep doors open for the action to consume configs outside of CacheActionConfig if needed in future.\n\nPassing a subset config only makes it harder to do things with the config going forward (including refactoring). e.g. deciders holding only DeciderConfig made it impossible to pass action specific config to actions. Just passing the parent everywhere and letting consumers extract what they need made sense to me.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480398255", "createdAt": "2020-08-31T21:04:39Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyCacheMaxSizeAction.java", "diffHunk": "@@ -153,34 +158,46 @@ public ResourceEnum getCacheType() {\n     private Long currentCacheMaxSizeInBytes;\n     private Long desiredCacheMaxSizeInBytes;\n     private Long heapMaxSizeInBytes;\n+    private final long upperBoundInBytes;\n+    private final long lowerBoundInBytes;\n \n     private Builder(\n         final NodeKey esNode,\n         final ResourceEnum cacheType,\n         final AppContext appContext,\n-        double upperBoundThreshold) {\n+        final RcaConf conf) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2ODY5MQ=="}, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMzA1NzY1OnYy", "diffSide": "LEFT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyQueueCapacityAction.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoxMjo0MFrOHKBWDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo0Mzo1OFrOHKN7ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2OTgzNg==", "bodyText": "I think we will still need those two methods. The JVM decider will try to override upperbound for caches / queues", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480269836", "createdAt": "2020-08-31T17:12:40Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyQueueCapacityAction.java", "diffHunk": "@@ -193,33 +180,21 @@ public Builder stepSize(int stepSize) {\n       return this;\n     }\n \n-    public Builder upperBound(int upperBound) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM5ODkxNg==", "bodyText": "I have a fn to override to max and min bounds, and another to increase/decrease. I think it is too much for the decider to calculate and come up with exact values in between that it must override to. Let me know why you think otherwise.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480398916", "createdAt": "2020-08-31T21:06:06Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyQueueCapacityAction.java", "diffHunk": "@@ -193,33 +180,21 @@ public Builder stepSize(int stepSize) {\n       return this;\n     }\n \n-    public Builder upperBound(int upperBound) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2OTgzNg=="}, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxMTAzNA==", "bodyText": "the benefit of exposing upper/lower bound to decider is it allows decider to tune some certain action within a sub range of the entire {lower, upper} range. Let me use JVM decider as an example.\nSo the fielddata cache has a range of 0.02 - 0.4 but in JVM decider, if we only want to tune the fielddata cache within 0.2 - 0.4, the decider can override the builder to do so.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480411034", "createdAt": "2020-08-31T21:32:27Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyQueueCapacityAction.java", "diffHunk": "@@ -193,33 +180,21 @@ public Builder stepSize(int stepSize) {\n       return this;\n     }\n \n-    public Builder upperBound(int upperBound) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2OTgzNg=="}, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ2NzY4NA==", "bodyText": "We decided to expose this setter, I'll make the required changes. Documenting our reasoning here:\nThere can be several reasons for high old heap usage, cache and queues cover only a subset of them. Currently however, these are the only ones we are looking at. The heap health decider bucketizes an unhealthy heap into 3 levels: level-1 unhealthy, level-2 unhealthy, and level-3 unhealthy; with level-3 being where heap is worst hit.\nAt level-1 unhealthy (heap usage ~60-70%), we want to downsize queues and caches, but to a soft lower bound, not to the absolute hard lower bound. This is so that we don't over-penalize the only resources we are able to tune.\nAt level-3 unhealthy (heap usage >~90%), the same argument can hold, but now we know for sure that there are several other objects contesting for heap space, which is causing the 90% heap usage. So we tune down caches and queues to as much as possible, which is the hard lower bound provided by setDesiredCacheMaxSizeToMin().\nAs a side note, we should separately see if these soft level based lower bounds should be present within deciders or within the *ActionConfig objects.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480467684", "createdAt": "2020-08-31T23:18:25Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyQueueCapacityAction.java", "diffHunk": "@@ -193,33 +180,21 @@ public Builder stepSize(int stepSize) {\n       return this;\n     }\n \n-    public Builder upperBound(int upperBound) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2OTgzNg=="}, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ3NjA0Mg==", "bodyText": "We should pick this up as a separate PR. The soft and hard bounds should be attributes of action config objects itself, so that they can have corresponding overrides in rca.conf, and we don't maintain and pass separate bound values from deciders.\nInstead of exposing the lowerBound() setter, we should expose a useSoftLowerBound() setter, with soft lower bound being read from rca.conf. Created #406", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480476042", "createdAt": "2020-08-31T23:43:58Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/ModifyQueueCapacityAction.java", "diffHunk": "@@ -193,33 +180,21 @@ public Builder stepSize(int stepSize) {\n       return this;\n     }\n \n-    public Builder upperBound(int upperBound) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2OTgzNg=="}, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 118}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMzA4MzM0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/NestedConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoyMDo1MlrOHKBl4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMTozMDoyNFrOHKJ5KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI3Mzg5MQ==", "bodyText": "Add nullable annotation to this function ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480273891", "createdAt": "2020-08-31T17:20:52Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/NestedConfig.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core;\n+\n+import java.util.Map;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class NestedConfig {\n+\n+  private static final Logger LOG = LogManager.getLogger(NestedConfig.class);\n+\n+  private String key;\n+  private Map<String, Object> value;\n+\n+  public NestedConfig(String key, Map<String, Object> parentConfig) {\n+    this.key = key;\n+    this.value = null;\n+    if (parentConfig != null) {\n+      try {\n+        //noinspection unchecked\n+        value = (Map<String, Object>) parentConfig.get(key);\n+      } catch (ClassCastException e) {\n+        LOG.error(\"rca.conf contains invalid value for key: [{}], trace : [{}]\", key, e.getMessage());\n+      }\n+    }\n+  }\n+\n+  public String getKey() {\n+    return key;\n+  }\n+\n+  public Map<String, Object> getValue() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwOTg5Nw==", "bodyText": "Done", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480409897", "createdAt": "2020-08-31T21:30:24Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/NestedConfig.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core;\n+\n+import java.util.Map;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class NestedConfig {\n+\n+  private static final Logger LOG = LogManager.getLogger(NestedConfig.class);\n+\n+  private String key;\n+  private Map<String, Object> value;\n+\n+  public NestedConfig(String key, Map<String, Object> parentConfig) {\n+    this.key = key;\n+    this.value = null;\n+    if (parentConfig != null) {\n+      try {\n+        //noinspection unchecked\n+        value = (Map<String, Object>) parentConfig.get(key);\n+      } catch (ClassCastException e) {\n+        LOG.error(\"rca.conf contains invalid value for key: [{}], trace : [{}]\", key, e.getMessage());\n+      }\n+    }\n+  }\n+\n+  public String getKey() {\n+    return key;\n+  }\n+\n+  public Map<String, Object> getValue() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI3Mzg5MQ=="}, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMzA5MjM0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/configs/CacheActionConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoyMzoyOVrOHKBrMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoyMzoyOVrOHKBrMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI3NTI0OA==", "bodyText": "we should define the default value as a static variable ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480275248", "createdAt": "2020-08-31T17:23:29Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/configs/CacheActionConfig.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.configs;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.ResourceEnum;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.Config;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NestedConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Defines config for cache related actions.\n+ *\n+ * <p>Configs are expected in the following json format:\n+ * {\n+ *   \"action-config-settings\": {\n+ *     // Cache Max Size bounds are expressed as %age of JVM heap size\n+ *     \"cache-settings\": {\n+ *       \"fielddata\": {\n+ *         \"upper-bound\": 0.4,\n+ *         \"lower-bound\": 0.1\n+ *       },\n+ *       \"shard-request\": {\n+ *         \"upper-bound\": 0.05,\n+ *         \"lower-bound\": 0.01\n+ *       }\n+ *     }\n+ *   }\n+ * }\n+ */\n+public class CacheActionConfig {\n+\n+  private static final Logger LOG = LogManager.getLogger(CacheActionConfig.class);\n+\n+  private NestedConfig cacheSettingsConfig;\n+  private FieldDataCacheConfig fieldDataCacheConfig;\n+  private ShardRequestCacheConfig shardRequestCacheConfig;\n+  private Map<ResourceEnum, ThresholdConfig<Double>> thresholdConfigMap;\n+\n+  public CacheActionConfig(RcaConf conf) {\n+    Map<String, Object> actionConfig = conf.getActionConfigSettings();\n+    cacheSettingsConfig = new NestedConfig(\"cache-settings\", actionConfig);\n+    fieldDataCacheConfig = new FieldDataCacheConfig(cacheSettingsConfig);\n+    shardRequestCacheConfig = new ShardRequestCacheConfig(cacheSettingsConfig);\n+    createThresholdConfigMap();\n+  }\n+\n+  public ThresholdConfig<Double> getThresholdConfig(ResourceEnum cacheType) {\n+    if (!thresholdConfigMap.containsKey(cacheType)) {\n+      String msg = \"Threshold config requested for unknown cache type: \" + cacheType.toString();\n+      LOG.error(msg);\n+      throw new IllegalArgumentException(msg);\n+    }\n+    return thresholdConfigMap.get(cacheType);\n+  }\n+\n+  private void createThresholdConfigMap() {\n+    Map<ResourceEnum, ThresholdConfig<Double>> configMap = new HashMap<>();\n+    configMap.put(ResourceEnum.FIELD_DATA_CACHE, fieldDataCacheConfig);\n+    configMap.put(ResourceEnum.SHARD_REQUEST_CACHE, shardRequestCacheConfig);\n+    thresholdConfigMap = Collections.unmodifiableMap(configMap);\n+  }\n+\n+  private static class FieldDataCacheConfig implements ThresholdConfig<Double> {\n+\n+    private Config<Double> fieldDataCacheUpperBound;\n+    private Config<Double> fieldDataCacheLowerBound;\n+\n+    public FieldDataCacheConfig(NestedConfig cacheSettingsConfig) {\n+      NestedConfig fieldDataCacheConfig = new NestedConfig(\"fielddata\", cacheSettingsConfig.getValue());\n+      fieldDataCacheUpperBound = new Config<>(\"upper-bound\", fieldDataCacheConfig.getValue(),\n+          0.4, (s) -> (s > 0), Double.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMzA5NDAyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/configs/QueueActionConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoyNDowNVrOHKBsQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNzoyNDowNVrOHKBsQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI3NTUyMQ==", "bodyText": "same as above", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/402#discussion_r480275521", "createdAt": "2020-08-31T17:24:05Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/configs/QueueActionConfig.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.configs;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.ResourceEnum;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.Config;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NestedConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Defines config for threadpool queue related actions\n+ *\n+ * <p>Configs are expected in the following json format:\n+ * {\n+ *   \"action-config-settings\": {\n+ *     // Queue Capacity bounds are expressed as absolute queue size\n+ *     \"queue-settings\": {\n+ *       \"search\": {\n+ *         \"upper-bound\": 3000,\n+ *         \"lower-bound\": 1000\n+ *       },\n+ *       \"write\": {\n+ *         \"upper-bound\": 1000,\n+ *         \"lower-bound\": 50\n+ *       }\n+ *     }\n+ * }\n+ */\n+public class QueueActionConfig {\n+\n+  private static final Logger LOG = LogManager.getLogger(QueueActionConfig.class);\n+\n+  private NestedConfig queueSettingsConfig;\n+  private SearchQueueConfig searchQueueConfig;\n+  private WriteQueueConfig writeQueueConfig;\n+  private Map<ResourceEnum, ThresholdConfig<Integer>> thresholdConfigMap;\n+\n+  public QueueActionConfig(RcaConf conf) {\n+    Map<String, Object> actionConfig = conf.getActionConfigSettings();\n+    queueSettingsConfig = new NestedConfig(\"queue-settings\", actionConfig);\n+    searchQueueConfig = new SearchQueueConfig(queueSettingsConfig);\n+    writeQueueConfig = new WriteQueueConfig(queueSettingsConfig);\n+    createThresholdConfigMap();\n+  }\n+\n+  public ThresholdConfig<Integer> getThresholdConfig(ResourceEnum threadPool) {\n+    if (!thresholdConfigMap.containsKey(threadPool)) {\n+      String msg = \"Threshold config requested for unknown threadpool queue: \" + threadPool.toString();\n+      LOG.error(msg);\n+      throw new IllegalArgumentException(msg);\n+    }\n+    return thresholdConfigMap.get(threadPool);\n+  }\n+\n+  private void createThresholdConfigMap() {\n+    Map<ResourceEnum, ThresholdConfig<Integer>> configMap = new HashMap<>();\n+    configMap.put(ResourceEnum.SEARCH_THREADPOOL, searchQueueConfig);\n+    configMap.put(ResourceEnum.WRITE_THREADPOOL, writeQueueConfig);\n+    thresholdConfigMap = Collections.unmodifiableMap(configMap);\n+  }\n+\n+  private static class SearchQueueConfig implements ThresholdConfig<Integer> {\n+\n+    private Config<Integer> searchQueueUpperBound;\n+    private Config<Integer> searchQueueLowerBound;\n+\n+    public SearchQueueConfig(NestedConfig queueSettingsConfig) {\n+      NestedConfig searchQueueConfig = new NestedConfig(\"search\", queueSettingsConfig.getValue());\n+      searchQueueUpperBound = new Config<>(\"upper-bound\", searchQueueConfig.getValue(),\n+          3000, (s) -> (s >= 0), Integer.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d72d38819d0d5883b74b3d50b48c32bdb328dcfa"}, "originalPosition": 88}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2381, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}