{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MjI2NjY0", "number": 455, "title": "Adding the Support of Retrieving Actions Persisted via an API", "bodyText": "Fixes #: Adding the Support of Retrieving Actions Persisted via an API #469\nDescription of changes: Return the last persisted action set in the SQL table via an API which would be used by monitoring to detect the actions triggered on a cluster.\nTests:  Testing done on Docker\nAPI Behavior when there is are actions published:\nLast Few Entries in the SQL table:\n46|18.18.18.18,123.123.123.123|0|MockAction2|1602305937764|18,123|MockSummary|0|0\n47|168.168.168.168,31.31.31.31|0|MockAction3|1602305937778|168,31|MockSummary|0|0\n48|12.12.12.12,143.143.143.143|0|MockAction2|1602305937778|12,143|MockSummary|0|0\n49|133.133.133.133,114.114.114.114|0|MockAction1|1602305942275|133,114|MockSummary|0|0\n50|11.11.11.11,125.125.125.125|0|MockAction2|1602305942275|11,125|MockSummary|0|0\n51|162.162.162.162,31.31.31.31|0|MockAction3|1602305942284|162,31|MockSummary|0|0\n52|18.18.18.18,148.148.148.148|0|MockAction2|1602305942284|18,148|MockSummary|0|0sqlite> \n\nResponse of the API (gives just the entries with the max timestamp):\n[root@bebd00b62f74 elasticsearch]# curl --url \"localhost:9600/_opendistro/_performanceanalyzer/actions\" -XGET\n{\n    \"LastSuggestedActionSet\": [\n        {\n            \"actionName\": \"MockAction1\",\n            \"actionable\": false,\n            \"coolOffPeriod\": 10,\n            \"muted\": false,\n            \"nodeIds\": \"1,11\",\n            \"nodeIps\": \"1.1.1.1,11.11.11.11\",\n            \"summary\": \"MockSummary\",\n            \"timestamp\": 1602538860025\n        },\n        {\n            \"actionName\": \"MockAction2\",\n            \"actionable\": false,\n            \"coolOffPeriod\": 20,\n            \"muted\": false,\n            \"nodeIds\": \"2,22\",\n            \"nodeIps\": \"2.2.2.2,22.22.22.22\",\n            \"summary\": \"MockSummary\",\n            \"timestamp\": 1602538860025\n        },\n        {\n            \"actionName\": \"MockAction1\",\n            \"actionable\": false,\n            \"coolOffPeriod\": 30,\n            \"muted\": false,\n            \"nodeIds\": \"1,11\",\n            \"nodeIps\": \"1.1.1.1,11.11.11.11\",\n            \"summary\": \"MockSummary\",\n            \"timestamp\": 1602538860025\n        },\n        {\n            \"actionName\": \"MockAction2\",\n            \"actionable\": false,\n            \"coolOffPeriod\": 40,\n            \"muted\": false,\n            \"nodeIds\": \"2,22\",\n            \"nodeIps\": \"2.2.2.2,22.22.22.22\",\n            \"summary\": \"MockSummary\",\n            \"timestamp\": 1602538860025\n        }\n    ]\n}\n[root@bebd00b62f74 elasticsearch]# \n\nAPI Behavior when there is are no actions published:\nsqlite> .tables\nRCA\n\n[root@357cbfdc6872 elasticsearch]# curl --url \"localhost:9600/_opendistro/_performanceanalyzer/actions\" -XGET | python -m json.tool \n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100    29  100    29    0     0   3722      0 --:--:-- --:--:-- --:--:--  4142\n{\n    \"LastSuggestedActionSet\": []\n}\n\nBuild:\n> Task :spotbugsMain\nWarning at xsl:variable on line 348 column 57 of default.xsl:\n  SXWN9001: A variable with no following sibling instructions has no effect\nWarning at xsl:variable on line 351 column 57 of default.xsl:\n  SXWN9001: A variable with no following sibling instructions has no effect\n\nDeprecated Gradle features were used in this build, making it incompatible with Gradle 7.0.\nUse '--warning-mode all' to show the individual deprecation warnings.\nSee https://docs.gradle.org/6.5/userguide/command_line_interface.html#sec:command_line_warnings\n\n**BUILD SUCCESSFUL in 31m 0s**\n19 actionable tasks: 19 executed\n\naditjind@3c22fbd31611 performance-analyzer-rca % **./gradlew spotBugsMain**\n\n> Configure project :\npa in dir: (../performance-analyzer) will be built.\nPA repo located at '../performance-analyzer' will be used.\n\nDeprecated Gradle features were used in this build, making it incompatible with Gradle 7.0.\nUse '--warning-mode all' to show the individual deprecation warnings.\nSee https://docs.gradle.org/6.5/userguide/command_line_interface.html#sec:command_line_warnings\n\nBUILD SUCCESSFUL in 1s\n6 actionable tasks: 6 up-to-date\naditjind@3c22fbd31611 performance-analyzer-rca % **./gradlew checkStyleMain**\n\n> Configure project :\npa in dir: (../performance-analyzer) will be built.\nPA repo located at '../performance-analyzer' will be used.\n\nDeprecated Gradle features were used in this build, making it incompatible with Gradle 7.0.\nUse '--warning-mode all' to show the individual deprecation warnings.\nSee https://docs.gradle.org/6.5/userguide/command_line_interface.html#sec:command_line_warnings\n\nBUILD SUCCESSFUL in 828ms\n\n\n\nIf new tests are added, how long do the new ones take to complete\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-10-06T02:44:43Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455", "merged": true, "mergeCommit": {"oid": "f8e0535de9204759b0eb18b65063e9c0ecdc59af"}, "closed": true, "closedAt": "2020-10-14T19:37:30Z", "author": {"login": "aditjind"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP8jhQAH2gAyNDk4MjI2NjY0OjNjNzM1NTA2NDk4NDVkYzM2NWU2YmYyZjRlNjczZmU0YTZjMDkzZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdShtkpgFqTUwODYzMDQ1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3c73550649845dc365e6bf2f4e673fe4a6c093e8", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3c73550649845dc365e6bf2f4e673fe4a6c093e8", "committedDate": "2020-10-06T18:19:12Z", "message": "Adding the Support of Retrieving Actions Persisted via an API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76", "committedDate": "2020-10-06T18:19:12Z", "message": "Fixing SpotBugs Errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce02eab2112e999319634869083aa26864bc1a20", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ce02eab2112e999319634869083aa26864bc1a20", "committedDate": "2020-10-06T03:03:45Z", "message": "Fixing SpotBugs Errors"}, "afterCommit": {"oid": "e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76", "committedDate": "2020-10-06T18:19:12Z", "message": "Fixing SpotBugs Errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzQ2MDg2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-503346086", "createdAt": "2020-10-06T20:47:49Z", "commit": {"oid": "e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDo0Nzo0OVrOHdZWPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDo0Nzo0OVrOHdZWPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU4NjA0NA==", "bodyText": "This exchange.close() should be outside the else {} so that we close the object for all requests. Please change this for QueryRcaRequestHandler as well.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r500586044", "createdAt": "2020-10-06T20:47:49Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryActionRequestHandler.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.Persistable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import com.google.gson.JsonObject;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+\n+public class QueryActionRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+    private static final Logger LOG = LogManager.getLogger(QueryActionRequestHandler.class);\n+    private Persistable persistable;\n+    private AppContext appContext;\n+\n+    public QueryActionRequestHandler(final AppContext appContext) {\n+        this.appContext = appContext;\n+    }\n+\n+    @Override\n+    public void handle(HttpExchange exchange) throws IOException {\n+        String requestMethod = exchange.getRequestMethod();\n+\n+        if (requestMethod.equalsIgnoreCase(\"GET\")) {\n+            LOG.debug(\"Action Query handler called.\");\n+            exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+            try {\n+                synchronized (this) {\n+                    String query = exchange.getRequestURI().getQuery();\n+                    handleActionRequest(exchange);\n+                }\n+            } catch (InvalidParameterException e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.getMessage() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_BAD_REQUEST);\n+            } catch (Exception e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.toString() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_INTERNAL_ERROR);\n+            }\n+        } else {\n+            exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+            exchange.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2c5d2a3dac6755f5e6307c45afc1b52b9b4fb76"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5d4f81b3acf9088ee0f49361caea1e5bd622370", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f5d4f81b3acf9088ee0f49361caea1e5bd622370", "committedDate": "2020-10-08T00:00:31Z", "message": "Adding the Support for Action Set to have same Time Stamp and retrieve support for the latest time stamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17b3c2545292b4926a088e1a2f0a518528146566", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/17b3c2545292b4926a088e1a2f0a518528146566", "committedDate": "2020-10-08T00:03:58Z", "message": "Fixing CheckStyle Errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa15808f318e731ccd209843f72fc496e92839db", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/aa15808f318e731ccd209843f72fc496e92839db", "committedDate": "2020-10-08T00:07:39Z", "message": "Addressing Checkstyle Errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MzY3OTA3", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-504367907", "createdAt": "2020-10-08T01:15:00Z", "commit": {"oid": "aa15808f318e731ccd209843f72fc496e92839db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMToxNTowMFrOHeKvTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMToxNTowMFrOHeKvTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM5NTI3Ng==", "bodyText": "Should we change the name as readLast or latest or something indicating as such ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r501395276", "createdAt": "2020-10-08T01:15:00Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/Persistable.java", "diffHunk": "@@ -67,6 +67,22 @@\n   <T> @Nullable T read(Class<T> clz)\n       throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException;\n \n+\n+  /**\n+   * This API reads all the rows from the table for the latest timestamp corresponding to the Object.\n+   * @param clz The Class whose Object is desired.\n+   * @param <T> The generic type of the class\n+   * @return An instantiated Object of the class with the fields populated with the data from the latest row in the table and other\n+   *     referenced tables or null if the table does not exist yet.\n+   * @throws NoSuchMethodException If the expected setter does not exist.\n+   * @throws IllegalAccessException If the setter is not Public\n+   * @throws InvocationTargetException If invoking the setter by reflection threw an exception.\n+   * @throws InstantiationException Creating an Object of the class failed for some reason.\n+   * @throws DataAccessException Thrown by the DB layer.\n+   */\n+  <T> @Nullable List<T> readForTimestamp(Class<T> clz)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa15808f318e731ccd209843f72fc496e92839db"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b878968bd6113c8f8a771e14cdcfb79539340292", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b878968bd6113c8f8a771e14cdcfb79539340292", "committedDate": "2020-10-08T20:23:18Z", "message": "Renaming Variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce1d532877ad5590c2b2b1ad8c41f075863f94ea", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ce1d532877ad5590c2b2b1ad8c41f075863f94ea", "committedDate": "2020-10-08T20:41:08Z", "message": "Added WaitFor() in UTs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6e757b70b99ad64705955d451a7d9327cd2acc5", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e6e757b70b99ad64705955d451a7d9327cd2acc5", "committedDate": "2020-10-08T20:44:59Z", "message": "Fixing CheckStyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f727dcddbbc895ceb20977e2a81775c90a1ad02", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0f727dcddbbc895ceb20977e2a81775c90a1ad02", "committedDate": "2020-10-08T23:44:53Z", "message": "Fix UT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b28671d7eb9f62de6cd934dd9a60dc085c0fcfd", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9b28671d7eb9f62de6cd934dd9a60dc085c0fcfd", "committedDate": "2020-10-09T02:47:29Z", "message": "Adding UTs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d062b112b1e976dc872b385f5a43a78b20539e47", "committedDate": "2020-10-09T02:54:26Z", "message": "Fixing CheckStyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1OTk2MjU4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-505996258", "createdAt": "2020-10-09T21:21:43Z", "commit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMToyMTo0NFrOHfY9JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTozNTozOFrOHfZQIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3Njc3Mw==", "bodyText": "Can you create an issue to add this new URL to the readme with some documentation ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502676773", "createdAt": "2020-10-09T21:21:44Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/core/Util.java", "diffHunk": "@@ -27,6 +27,7 @@\n   private static final Logger LOG = LogManager.getLogger(Util.class);\n   public static final String METRICS_QUERY_URL = \"/_opendistro/_performanceanalyzer/metrics\";\n   public static final String RCA_QUERY_URL = \"/_opendistro/_performanceanalyzer/rca\";\n+  public static final String ACTIONS_QUERY_URL = \"/_opendistro/_performanceanalyzer/actions\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3ODUyNQ==", "bodyText": "I am thinking if we should just keep it simple and join them with comma as delimiter ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502678525", "createdAt": "2020-10-09T21:26:46Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java", "diffHunk": "@@ -41,33 +42,35 @@ public PublisherEventsPersistor(final Persistable persistable) {\n         this.persistable = persistable;\n     }\n \n-    public void persistAction(final Action action) {\n+    public void persistAction(final List<Action> actionsPublished) {\n         long timestamp = Instant.now().toEpochMilli();\n-        LOG.debug(\"Action: [{}] published to persistor publisher.\", action.name());\n-        PerformanceAnalyzerApp.RCA_RUNTIME_METRICS_AGGREGATOR.updateStat(\n-                RcaRuntimeMetrics.ACTIONS_PUBLISHED, action.name(), 1);\n-        if (action.impactedNodes() != null) {\n-            final String nodeIds = action.impactedNodes().stream()\n-                                           .map(n -> n.getNodeId().toString())\n-                                           .collect(Collectors.joining(\",\", \"{\", \"}\"));\n-            final String nodeIps = action.impactedNodes().stream()\n-                                           .map(n -> n.getHostAddress().toString())\n-                                           .collect(Collectors.joining(\",\", \"{\", \"}\"));\n-            final PersistedAction actionsSummary = new PersistedAction();\n-            actionsSummary.setActionName(action.name());\n-            actionsSummary.setNodeIds(nodeIds);\n-            actionsSummary.setNodeIps(nodeIps);\n-            actionsSummary.setActionable(action.isActionable());\n-            actionsSummary.setCoolOffPeriod(action.coolOffPeriodInMillis());\n-            actionsSummary.setMuted(action.isMuted());\n-            actionsSummary.setSummary(action.summary());\n-            actionsSummary.setTimestamp(timestamp);\n-            try {\n-                persistable.write(actionsSummary);\n-            } catch (Exception e) {\n-                LOG.error(\"Unable to write publisher events to sqlite\", e);\n-                PerformanceAnalyzerApp.ERRORS_AND_EXCEPTIONS_AGGREGATOR.updateStat(\n-                        ExceptionsAndErrors.EXCEPTION_IN_PERSIST, action.name(), 1);\n+        for (Action action : actionsPublished) {\n+            LOG.debug(\"Action: [{}] published to persistor publisher.\", action.name());\n+            PerformanceAnalyzerApp.RCA_RUNTIME_METRICS_AGGREGATOR.updateStat(\n+                    RcaRuntimeMetrics.ACTIONS_PUBLISHED, action.name(), 1);\n+            if (action.impactedNodes() != null) {\n+                final String nodeIds = action.impactedNodes().stream()\n+                        .map(n -> n.getNodeId().toString())\n+                        .collect(Collectors.joining(\",\", \"{\", \"}\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDAwMw==", "bodyText": "Should we call it action group ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502680003", "createdAt": "2020-10-09T21:30:45Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -260,7 +259,40 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n       // We always expect one row whether we query for the latest row or we query for a row by the rowID.\n       throw new IllegalStateException(\"Expected one row, found: '\" + recordList + \"'\");\n     }\n-    Record record = recordList.get(0);\n+    return readFields(clz, recordList.get(0), tableName);\n+  }\n+\n+  @Override\n+  public synchronized <T> @org.checkerframework.checker.nullness.qual.Nullable List<T> readLatestGroup(Class<T> clz)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDg0Ng==", "bodyText": "There is no order by desc clause. Can you explain how the sorting is happening ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502680846", "createdAt": "2020-10-09T21:33:20Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -260,7 +259,40 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n       // We always expect one row whether we query for the latest row or we query for a row by the rowID.\n       throw new IllegalStateException(\"Expected one row, found: '\" + recordList + \"'\");\n     }\n-    Record record = recordList.get(0);\n+    return readFields(clz, recordList.get(0), tableName);\n+  }\n+\n+  @Override\n+  public synchronized <T> @org.checkerframework.checker.nullness.qual.Nullable List<T> readLatestGroup(Class<T> clz)\n+          throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException {\n+    String tableName = getTableNameFromClassName(clz);\n+    Field<String> actionName = DSL.field(PersistedAction.SQL_SCHEMA_CONSTANTS.ACTION_COL_NAME, String.class);\n+    List<Record> maxTimeStampRecordList;\n+\n+    try {\n+      // Fetch the latest rows with the last timestamp.\n+      maxTimeStampRecordList = create.select().from(tableName).groupBy(actionName).fetch();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MTYzMw==", "bodyText": "Is this still a todo ? We are taking care of it at persistence layer, right ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502681633", "createdAt": "2020-10-09T21:35:38Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryActionRequestHandler.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.Persistable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonObject;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.List;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+\n+public class QueryActionRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+    private static final Logger LOG = LogManager.getLogger(QueryActionRequestHandler.class);\n+    private Persistable persistable;\n+    private AppContext appContext;\n+\n+    public QueryActionRequestHandler(final AppContext appContext) {\n+        this.appContext = appContext;\n+    }\n+\n+    @Override\n+    public void handle(HttpExchange exchange) throws IOException {\n+        String requestMethod = exchange.getRequestMethod();\n+\n+        if (requestMethod.equalsIgnoreCase(\"GET\")) {\n+            LOG.debug(\"Action Query handler called.\");\n+            exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+            try {\n+                synchronized (this) {\n+                    String query = exchange.getRequestURI().getQuery();\n+                    handleActionRequest(exchange);\n+                }\n+            } catch (InvalidParameterException e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.getMessage() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_BAD_REQUEST);\n+            } catch (Exception e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.toString() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_INTERNAL_ERROR);\n+            }\n+        } else {\n+            exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+        }\n+        exchange.close();\n+    }\n+\n+    private void handleActionRequest(HttpExchange exchange)\n+            throws IOException {\n+        //check if we are querying from elected master\n+        if (!validNodeRole()) {\n+            JsonObject errResponse = new JsonObject();\n+            errResponse.addProperty(\"error\", \"Node being queried is not elected master.\");\n+            sendResponse(exchange, errResponse.toString(),\n+                    HttpURLConnection.HTTP_BAD_REQUEST);\n+            return;\n+        }\n+\n+        String response = getActionData(persistable).toString();\n+        sendResponse(exchange, response, HttpURLConnection.HTTP_OK);\n+    }\n+\n+    private JsonObject getActionData(Persistable persistable) {\n+        LOG.debug(\"Action: in getActionData\");\n+        JsonObject result = new JsonObject();\n+        if (persistable != null) {\n+            try {\n+                // TODO: Read Last suggested Action Set", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDEzNjEx", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-506013611", "createdAt": "2020-10-09T22:14:22Z", "commit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMjoxNDoyM1rOHfZxog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMjozNToxOFrOHfaHAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5MDIxMA==", "bodyText": "This API seems generic and not specific to actions. we could call it readLatestEntrySet ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502690210", "createdAt": "2020-10-09T22:14:23Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -260,7 +259,40 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n       // We always expect one row whether we query for the latest row or we query for a row by the rowID.\n       throw new IllegalStateException(\"Expected one row, found: '\" + recordList + \"'\");\n     }\n-    Record record = recordList.get(0);\n+    return readFields(clz, recordList.get(0), tableName);\n+  }\n+\n+  @Override\n+  public synchronized <T> @org.checkerframework.checker.nullness.qual.Nullable List<T> readLatestGroup(Class<T> clz)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDAwMw=="}, "originalCommit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5MTUyOQ==", "bodyText": "+1, i didn't understand how this query is working - why is it doing a group by on actionName? where/how did it pick the latest TS value?\ncan you (for our understanding) provide the SQL counterpart for this query?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502691529", "createdAt": "2020-10-09T22:19:45Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -260,7 +259,40 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n       // We always expect one row whether we query for the latest row or we query for a row by the rowID.\n       throw new IllegalStateException(\"Expected one row, found: '\" + recordList + \"'\");\n     }\n-    Record record = recordList.get(0);\n+    return readFields(clz, recordList.get(0), tableName);\n+  }\n+\n+  @Override\n+  public synchronized <T> @org.checkerframework.checker.nullness.qual.Nullable List<T> readLatestGroup(Class<T> clz)\n+          throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException {\n+    String tableName = getTableNameFromClassName(clz);\n+    Field<String> actionName = DSL.field(PersistedAction.SQL_SCHEMA_CONSTANTS.ACTION_COL_NAME, String.class);\n+    List<Record> maxTimeStampRecordList;\n+\n+    try {\n+      // Fetch the latest rows with the last timestamp.\n+      maxTimeStampRecordList = create.select().from(tableName).groupBy(actionName).fetch();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDg0Ng=="}, "originalCommit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5MjE4Nw==", "bodyText": "This exchange.close() is also needed in the QueryRcaRequestHandler I think. Can you change it there as well?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502692187", "createdAt": "2020-10-09T22:22:25Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rest/QueryActionRequestHandler.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rest;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.collectors.StatExceptionCode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.Persistable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import com.google.gson.JsonArray;\n+import com.google.gson.JsonObject;\n+import com.sun.net.httpserver.HttpExchange;\n+import com.sun.net.httpserver.HttpHandler;\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.security.InvalidParameterException;\n+import java.util.List;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.logging.log4j.util.Supplier;\n+\n+public class QueryActionRequestHandler extends MetricsHandler implements HttpHandler {\n+\n+    private static final Logger LOG = LogManager.getLogger(QueryActionRequestHandler.class);\n+    private Persistable persistable;\n+    private AppContext appContext;\n+\n+    public QueryActionRequestHandler(final AppContext appContext) {\n+        this.appContext = appContext;\n+    }\n+\n+    @Override\n+    public void handle(HttpExchange exchange) throws IOException {\n+        String requestMethod = exchange.getRequestMethod();\n+\n+        if (requestMethod.equalsIgnoreCase(\"GET\")) {\n+            LOG.debug(\"Action Query handler called.\");\n+            exchange.getResponseHeaders().set(\"Content-Type\", \"application/json\");\n+\n+            try {\n+                synchronized (this) {\n+                    String query = exchange.getRequestURI().getQuery();\n+                    handleActionRequest(exchange);\n+                }\n+            } catch (InvalidParameterException e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.getMessage() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_BAD_REQUEST);\n+            } catch (Exception e) {\n+                LOG.error(\n+                        (Supplier<?>)\n+                                () ->\n+                                        new ParameterizedMessage(\n+                                                \"QueryException {} ExceptionCode: {}.\",\n+                                                e.toString(),\n+                                                StatExceptionCode.REQUEST_ERROR.toString()),\n+                        e);\n+                String response = \"{\\\"error\\\":\\\"\" + e.toString() + \"\\\"}\";\n+                sendResponse(exchange, response, HttpURLConnection.HTTP_INTERNAL_ERROR);\n+            }\n+        } else {\n+            exchange.sendResponseHeaders(HttpURLConnection.HTTP_NOT_FOUND, -1);\n+        }\n+        exchange.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY5NTY4MQ==", "bodyText": "Can we check that the table itself had 4 action entries at this point with 2 different sets of timestamps?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502695681", "createdAt": "2020-10-09T22:35:18Z", "author": {"login": "vigyasharma"}, "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistorTest.java", "diffHunk": "@@ -47,23 +47,68 @@ public void cleanup() throws IOException {\n     }\n \n     @Test\n-    public void actionPublished() throws InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException {\n-        final MockAction mockAction = new MockAction();\n-\n-        publisherEventsPersistor.persistAction(mockAction);\n-\n-        PersistedAction actionsSummary = persistable.read(PersistedAction.class);\n+    public void actionPublished() throws Exception {\n+        final MockAction mockAction1 = new MockAction(\"MockAction1\", new ArrayList<String>() {\n+            {\n+                add(\"1\");\n+                add(\"11\");\n+            }});\n+        final MockAction mockAction2 = new MockAction(\"MockAction2\", new ArrayList<String>() {\n+            {\n+                add(\"2\");\n+                add(\"33\");\n+            }});\n+        List<Action> mockActions = new ArrayList<>();\n+        mockActions.add(mockAction1);\n+        mockActions.add(mockAction2);\n+        mockActions.clear();\n+\n+        publisherEventsPersistor.persistAction(mockActions);\n+\n+        final MockAction mockAction3 = new MockAction(\"MockAction3\",new ArrayList<String>() {\n+            {\n+                add(\"3\");\n+                add(\"33\");\n+            }});\n+        final MockAction mockAction4 = new MockAction(\"MockAction4\",new ArrayList<String>() {\n+            {\n+                add(\"4\");\n+                add(\"44\");\n+            }});\n+        mockActions.add(mockAction3);\n+        mockActions.add(mockAction4);\n+\n+        publisherEventsPersistor.persistAction(mockActions);\n+\n+        WaitFor.waitFor(() -> persistable.readLatestGroup(PersistedAction.class).size() == 2, 5,\n+                TimeUnit.SECONDS);\n+        List<PersistedAction> actionsSummary = persistable.readLatestGroup(PersistedAction.class);\n         Assert.assertNotNull(actionsSummary);\n-        Assert.assertEquals(actionsSummary.getActionName(), mockAction.name());\n-        Assert.assertEquals(actionsSummary.getNodeIds(), \"{1,2}\");\n-        Assert.assertEquals(actionsSummary.getNodeIps(), \"{1.1.1.1,2.2.2.2}\");\n-        Assert.assertEquals(actionsSummary.isActionable(), mockAction.isActionable());\n-        Assert.assertEquals(actionsSummary.getCoolOffPeriod(), mockAction.coolOffPeriodInMillis());\n-        Assert.assertEquals(actionsSummary.isMuted(), mockAction.isMuted());\n-        Assert.assertEquals(actionsSummary.getSummary(), mockAction.summary());\n+        Assert.assertEquals(actionsSummary.size(), 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d062b112b1e976dc872b385f5a43a78b20539e47"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e65336f6f2ac242aa4784867c159f9291b7b2a8", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1e65336f6f2ac242aa4784867c159f9291b7b2a8", "committedDate": "2020-10-10T05:14:49Z", "message": "Addressing CR Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f09657b2794ffbb6e33843a2ccc05b384fba80e0", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f09657b2794ffbb6e33843a2ccc05b384fba80e0", "committedDate": "2020-10-10T05:54:35Z", "message": "Making API Generic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjQzMjg1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-506243285", "createdAt": "2020-10-12T01:24:38Z", "commit": {"oid": "f09657b2794ffbb6e33843a2ccc05b384fba80e0"}, "state": "DISMISSED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMToyNDozOFrOHfsb1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwMTo0Mzo0M1rOHfso5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5NTkyNg==", "bodyText": "Minor: Can you pretty-format the action body here to make it more readable in markdown?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502995926", "createdAt": "2020-10-12T01:24:38Z", "author": {"login": "vigyasharma"}, "path": "README.md", "diffHunk": "@@ -124,6 +124,25 @@ In order to get the temperature of a particular node, we can use:\n \n `curl \"localhost:9600/_opendistro/_performanceanalyzer/rca?name=AllTemperatureDimensions&local=true\"`\n \n+## Actions API\n+This API provides the last suggested action set via the Decision Maker framework. All the suggested action sets are persisted in the SQL tables. This API provides the action set which was published with the latest timestamp.\n+\n+\n+### SAMPLE REQUEST\n+\n+GET `_opendistro/_performanceanalyzer/actions`\n+\n+The sample response from above api\n+\n+```\n+{\n+    \"LastSuggestedActionSet\": \"[{\\\"nodeIps\\\":\\\"{1.1.1.1,2.2.2.2}\\\",\\\"muted\\\":false,\\\"actionName\\\":\\\"M1\\\",\\\"timestamp\\\":1602190468123,\\\"nodeIds\\\":\\\"{1,2}\\\",\\\"summary\\\":\\\"MockSummary\\\",\\\"actionable\\\":false,\\\"coolOffPeriod\\\":0},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f09657b2794ffbb6e33843a2ccc05b384fba80e0"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5NjU3MA==", "bodyText": "Since you are trying to keep this fn generic (not specific to latest timestamp), this variable should also not be timestamp specific. Maybe something on the lines of recordsWithMaxFieldValue", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502996570", "createdAt": "2020-10-12T01:28:11Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -263,15 +265,15 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n   }\n \n   @Override\n-  public synchronized <T> @org.checkerframework.checker.nullness.qual.Nullable List<T> readLatestGroup(Class<T> clz)\n+  public synchronized <T, E> @org.checkerframework.checker.nullness.qual.Nullable List<T> readAllForMaxField(Class<T> clz, Field<E> field)\n           throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException {\n     String tableName = getTableNameFromClassName(clz);\n-    Field<String> actionName = DSL.field(PersistedAction.SQL_SCHEMA_CONSTANTS.ACTION_COL_NAME, String.class);\n     List<Record> maxTimeStampRecordList;\n \n     try {\n       // Fetch the latest rows with the last timestamp.\n-      maxTimeStampRecordList = create.select().from(tableName).groupBy(actionName).fetch();\n+      maxTimeStampRecordList = create.select().from(tableName).where(DSL.field(field)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f09657b2794ffbb6e33843a2ccc05b384fba80e0"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5NzI2NA==", "bodyText": "Also let's add an actual action output in this API doc instead of a mock action. The actual action is more informative and helpful, for e.g. the summary field itself is actually a json containing all the action fields for the queue and cache actions.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502997264", "createdAt": "2020-10-12T01:32:12Z", "author": {"login": "vigyasharma"}, "path": "README.md", "diffHunk": "@@ -124,6 +124,25 @@ In order to get the temperature of a particular node, we can use:\n \n `curl \"localhost:9600/_opendistro/_performanceanalyzer/rca?name=AllTemperatureDimensions&local=true\"`\n \n+## Actions API\n+This API provides the last suggested action set via the Decision Maker framework. All the suggested action sets are persisted in the SQL tables. This API provides the action set which was published with the latest timestamp.\n+\n+\n+### SAMPLE REQUEST\n+\n+GET `_opendistro/_performanceanalyzer/actions`\n+\n+The sample response from above api\n+\n+```\n+{\n+    \"LastSuggestedActionSet\": \"[{\\\"nodeIps\\\":\\\"{1.1.1.1,2.2.2.2}\\\",\\\"muted\\\":false,\\\"actionName\\\":\\\"M1\\\",\\\"timestamp\\\":1602190468123,\\\"nodeIds\\\":\\\"{1,2}\\\",\\\"summary\\\":\\\"MockSummary\\\",\\\"actionable\\\":false,\\\"coolOffPeriod\\\":0},\n+                                {\\\"nodeIps\\\":\\\"{1.1.1.1,2.2.2.2}\\\",\\\"muted\\\":false,\\\"actionName\\\":\\\"M2\\\",\\\"timestamp\\\":1602190468123,\\\"nodeIds\\\":\\\"{1,2}\\\",\\\"summary\\\":\\\"MockSummary\\\",\\\"actionable\\\":false,\\\"coolOffPeriod\\\":0}]\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f09657b2794ffbb6e33843a2ccc05b384fba80e0"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5ODI4Nw==", "bodyText": "For the sake of testing sql query correctness, can we also add some out of order actions, i.e. publish another set of actions with an older timestamp after this one. We don't expect the publisher code to do that right now, but since these are unit tests, it will validate the sql query against any unexpected future changes.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502998287", "createdAt": "2020-10-12T01:38:15Z", "author": {"login": "vigyasharma"}, "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistorTest.java", "diffHunk": "@@ -78,20 +78,23 @@ public void actionPublished() throws Exception {\n         mockActions.add(mockAction3);\n         mockActions.add(mockAction4);\n \n-        publisherEventsPersistor.persistAction(mockActions);\n+        publisherEventsPersistor.persistAction(mockActions, 987654321);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f09657b2794ffbb6e33843a2ccc05b384fba80e0"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5OTI3MA==", "bodyText": "We should also test the generality by adding a UT for some other (non-timestamp) field and checking that we get all fields with max value.\nFWIW, I think it's also ok to make this function only timestamp specific and get all records with the latest timestamp value instead of a generic max-field value.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r502999270", "createdAt": "2020-10-12T01:43:43Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -263,15 +265,15 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n   }\n \n   @Override\n-  public synchronized <T> @org.checkerframework.checker.nullness.qual.Nullable List<T> readLatestGroup(Class<T> clz)\n+  public synchronized <T, E> @org.checkerframework.checker.nullness.qual.Nullable List<T> readAllForMaxField(Class<T> clz, Field<E> field)\n           throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException {\n     String tableName = getTableNameFromClassName(clz);\n-    Field<String> actionName = DSL.field(PersistedAction.SQL_SCHEMA_CONSTANTS.ACTION_COL_NAME, String.class);\n     List<Record> maxTimeStampRecordList;\n \n     try {\n       // Fetch the latest rows with the last timestamp.\n-      maxTimeStampRecordList = create.select().from(tableName).groupBy(actionName).fetch();\n+      maxTimeStampRecordList = create.select().from(tableName).where(DSL.field(field)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk5NjU3MA=="}, "originalCommit": {"oid": "f09657b2794ffbb6e33843a2ccc05b384fba80e0"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4b2a9cda152cf3d46edba658c99d172f78ef58d", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f4b2a9cda152cf3d46edba658c99d172f78ef58d", "committedDate": "2020-10-12T21:49:11Z", "message": "Adding UTs for generic API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9322b2ed5db31cb76a7cb0e731b7a4f37858b333", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9322b2ed5db31cb76a7cb0e731b7a4f37858b333", "committedDate": "2020-10-12T21:58:43Z", "message": "CheckStyle Errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "795e598b735b1005b0ec7a588be11a40ed91b52c", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/795e598b735b1005b0ec7a588be11a40ed91b52c", "committedDate": "2020-10-12T22:35:06Z", "message": "Modified UTs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8465c9b9993e83512ecdb4674e63404f1316390", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a8465c9b9993e83512ecdb4674e63404f1316390", "committedDate": "2020-10-12T22:42:21Z", "message": "Modifying API DOC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b18425c19b8ff91bb742a85905212fadbd9cc80a", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b18425c19b8ff91bb742a85905212fadbd9cc80a", "committedDate": "2020-10-12T22:45:34Z", "message": "API Doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b7f1e3d84c6d6460293ade9ad147f27c756601b", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2b7f1e3d84c6d6460293ade9ad147f27c756601b", "committedDate": "2020-10-13T01:01:04Z", "message": "Removing Changes from README"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDczODIy", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-507073822", "createdAt": "2020-10-13T05:13:40Z", "commit": {"oid": "2b7f1e3d84c6d6460293ade9ad147f27c756601b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3ODYyNTk5", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-507862599", "createdAt": "2020-10-13T22:07:18Z", "commit": {"oid": "2b7f1e3d84c6d6460293ade9ad147f27c756601b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjowNzoxOFrOHg7L8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjowNzoxOFrOHg7L8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjE5Mg==", "bodyText": "I don't have a strong opinion either way - i think the old format was also ok.\nBut this format is expected by multiple integ tests. Are they passing with your changes? Please confirm and update any breaking ITs.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r504286192", "createdAt": "2020-10-13T22:07:18Z", "author": {"login": "vigyasharma"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java", "diffHunk": "@@ -41,33 +41,34 @@ public PublisherEventsPersistor(final Persistable persistable) {\n         this.persistable = persistable;\n     }\n \n-    public void persistAction(final Action action) {\n-        long timestamp = Instant.now().toEpochMilli();\n-        LOG.debug(\"Action: [{}] published to persistor publisher.\", action.name());\n-        PerformanceAnalyzerApp.RCA_RUNTIME_METRICS_AGGREGATOR.updateStat(\n-                RcaRuntimeMetrics.ACTIONS_PUBLISHED, action.name(), 1);\n-        if (action.impactedNodes() != null) {\n-            final String nodeIds = action.impactedNodes().stream()\n-                                           .map(n -> n.getNodeId().toString())\n-                                           .collect(Collectors.joining(\",\", \"{\", \"}\"));\n-            final String nodeIps = action.impactedNodes().stream()\n-                                           .map(n -> n.getHostAddress().toString())\n-                                           .collect(Collectors.joining(\",\", \"{\", \"}\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b7f1e3d84c6d6460293ade9ad147f27c756601b"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9aeab5bb3c1d7ebdb09dddc5e66c56c4f9d4dab", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f9aeab5bb3c1d7ebdb09dddc5e66c56c4f9d4dab", "committedDate": "2020-10-13T22:52:17Z", "message": "Reverting to Old Format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3OTA2ODkw", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-507906890", "createdAt": "2020-10-13T23:57:39Z", "commit": {"oid": "f9aeab5bb3c1d7ebdb09dddc5e66c56c4f9d4dab"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMzo1NzozOVrOHg9e3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwMDowMDo1NVrOHg9iuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMzgwNQ==", "bodyText": "I am unsure if we want to write an error log with full stack trace here because jooq can throw DataAccessException if a user queries for a table that does not exist.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r504323805", "createdAt": "2020-10-13T23:57:39Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -260,7 +261,40 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n       // We always expect one row whether we query for the latest row or we query for a row by the rowID.\n       throw new IllegalStateException(\"Expected one row, found: '\" + recordList + \"'\");\n     }\n-    Record record = recordList.get(0);\n+    return readFields(clz, recordList.get(0), tableName);\n+  }\n+\n+  @Override\n+  public synchronized <T, E> @org.checkerframework.checker.nullness.qual.Nullable List<T> readAllForMaxField(Class<T> clz, Field<E> field)\n+          throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException {\n+    String tableName = getTableNameFromClassName(clz);\n+    List<Record> recordsWithMaxFieldValue;\n+\n+    try {\n+      // Fetch the latest rows with the last timestamp.\n+      recordsWithMaxFieldValue = create.select().from(tableName).where(DSL.field(field)\n+              .eq(create.select(max(field)).from(tableName))).fetch();\n+    } catch (DataAccessException dex) {\n+      LOG.error(\"Error querying table {}\", tableName, dex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9aeab5bb3c1d7ebdb09dddc5e66c56c4f9d4dab"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyNDc5Mw==", "bodyText": "This method is called from the RestHandler class. For that class to construct a Field and send it over, couples the request handler with the schema on the persistence layer, moreover with jooq, the library. Can we have them specify the name of the field and we convert the name to Field in the implementer of this method ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#discussion_r504324793", "createdAt": "2020-10-14T00:00:55Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/Persistable.java", "diffHunk": "@@ -67,6 +68,22 @@\n   <T> @Nullable T read(Class<T> clz)\n       throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, DataAccessException;\n \n+\n+  /**\n+   * This API reads all the rows from the table corresponding to the maximum value in the field Object.\n+   * @param clz The Class whose Object is desired.\n+   * @param <T> The generic type of the class.\n+   * @param field DSL field for which the maximum value is desired.\n+   * @return A List of instantiated Objects of the class with the fields populated with the data from the corresponding rows in the table.\n+   * @throws NoSuchMethodException If the expected setter does not exist.\n+   * @throws IllegalAccessException If the setter is not Public\n+   * @throws InvocationTargetException If invoking the setter by reflection threw an exception.\n+   * @throws InstantiationException Creating an Object of the class failed for some reason.\n+   * @throws DataAccessException Thrown by the DB layer.\n+   */\n+  <T, E> @Nullable List<T> readAllForMaxField(Class<T> clz, Field<E> field)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9aeab5bb3c1d7ebdb09dddc5e66c56c4f9d4dab"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2adc61df133c3382310edbeda6298d12588b5a76", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2adc61df133c3382310edbeda6298d12588b5a76", "committedDate": "2020-10-14T03:11:33Z", "message": "Separating the Request Handler layer and the persistance layer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98093587038a62290e53c1a6cae55aaeaf6e2378", "author": {"user": {"login": "aditjind", "name": "Aditya Jindal"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/98093587038a62290e53c1a6cae55aaeaf6e2378", "committedDate": "2020-10-14T03:33:43Z", "message": "CheckStyle Again"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NTM2NDI5", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-508536429", "createdAt": "2020-10-14T16:42:02Z", "commit": {"oid": "98093587038a62290e53c1a6cae55aaeaf6e2378"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjI5MjAx", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-508629201", "createdAt": "2020-10-14T18:42:42Z", "commit": {"oid": "98093587038a62290e53c1a6cae55aaeaf6e2378"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjMwNDU1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/455#pullrequestreview-508630455", "createdAt": "2020-10-14T18:44:31Z", "commit": {"oid": "98093587038a62290e53c1a6cae55aaeaf6e2378"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 966, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}