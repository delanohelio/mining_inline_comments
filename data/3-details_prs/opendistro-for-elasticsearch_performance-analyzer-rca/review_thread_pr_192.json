{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NjkwMDIy", "number": 192, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMToyOTo1N1rOD8SqpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTo1MDozMlrOD8qWLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTQ2OTgxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMToyOTo1N1rOGVJBHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOTozMDo0NFrOGVrKOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMTAyMw==", "bodyText": "(GenericSummary) method.invoke(null, record);, is the null required here?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r424821023", "createdAt": "2020-05-14T01:29:57Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -218,42 +215,39 @@ public synchronized RcaResponse readRca(String rca) {\n \n   private void readSummary(GenericSummary upperLevelSummary, int upperLevelPrimaryKey) {\n     String upperLevelTable = upperLevelSummary.getTableName();\n+    List<Class<? extends GenericSummary>> clazzList = SQLiteQueryUtils.getNestedTableMap().getOrDefault(upperLevelSummary.getClass(), null);\n+\n     // stop the recursion here if the table does not have any nested summary.\n-    if (!SQLiteQueryUtils.getNestedTableMap().containsKey(upperLevelTable)) {\n+    if (clazzList == null) {\n       return;\n     }\n-    String currLevelTable = SQLiteQueryUtils.getNestedTableMap().get(upperLevelTable);\n-    Field<Integer> foreignKeyField = DSL.field(\n-        SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n-    SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n-        .buildSummaryQuery(create, currLevelTable, upperLevelPrimaryKey, foreignKeyField);\n-    try {\n-      Result<Record> recordList = rcaQuery.fetch();\n-      for (Record record : recordList) {\n-        GenericSummary summary = null;\n-        if (upperLevelSummary instanceof RcaResponse) {\n-          summary = HotClusterSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotClusterSummary) {\n-          summary = HotNodeSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotNodeSummary) {\n-          summary = HotResourceSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotResourceSummary) {\n-          summary = TopConsumerSummary.buildSummary(record);\n-        }\n-        if (summary != null) {\n-          Field<Integer> primaryKeyField = DSL.field(\n-              SQLiteQueryUtils.getPrimaryKeyColumnName(summary.getTableName()), Integer.class);\n-          readSummary(summary, record.get(primaryKeyField));\n-          upperLevelSummary.addNestedSummaryList(summary);\n+    for (Class<? extends GenericSummary> clazz : clazzList) {\n+      Field<Integer> foreignKeyField = DSL.field(\n+          SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n+      SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n+          .buildSummaryQuery(create, clazz.getSimpleName(), upperLevelPrimaryKey, foreignKeyField);\n+      try {\n+        Result<Record> recordList = rcaQuery.fetch();\n+        for (Record record : recordList) {\n+          Method method = clazz.getMethod(\"buildSummary\", Record.class);\n+          GenericSummary summary = (GenericSummary) method.invoke(null, record);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d4f4ce22fa7b3422f9fb2e158c9dbfb4f0b2ee0"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4MDQwOA==", "bodyText": "yes. because buildSummary is a static method", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r425380408", "createdAt": "2020-05-14T19:30:44Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -218,42 +215,39 @@ public synchronized RcaResponse readRca(String rca) {\n \n   private void readSummary(GenericSummary upperLevelSummary, int upperLevelPrimaryKey) {\n     String upperLevelTable = upperLevelSummary.getTableName();\n+    List<Class<? extends GenericSummary>> clazzList = SQLiteQueryUtils.getNestedTableMap().getOrDefault(upperLevelSummary.getClass(), null);\n+\n     // stop the recursion here if the table does not have any nested summary.\n-    if (!SQLiteQueryUtils.getNestedTableMap().containsKey(upperLevelTable)) {\n+    if (clazzList == null) {\n       return;\n     }\n-    String currLevelTable = SQLiteQueryUtils.getNestedTableMap().get(upperLevelTable);\n-    Field<Integer> foreignKeyField = DSL.field(\n-        SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n-    SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n-        .buildSummaryQuery(create, currLevelTable, upperLevelPrimaryKey, foreignKeyField);\n-    try {\n-      Result<Record> recordList = rcaQuery.fetch();\n-      for (Record record : recordList) {\n-        GenericSummary summary = null;\n-        if (upperLevelSummary instanceof RcaResponse) {\n-          summary = HotClusterSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotClusterSummary) {\n-          summary = HotNodeSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotNodeSummary) {\n-          summary = HotResourceSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotResourceSummary) {\n-          summary = TopConsumerSummary.buildSummary(record);\n-        }\n-        if (summary != null) {\n-          Field<Integer> primaryKeyField = DSL.field(\n-              SQLiteQueryUtils.getPrimaryKeyColumnName(summary.getTableName()), Integer.class);\n-          readSummary(summary, record.get(primaryKeyField));\n-          upperLevelSummary.addNestedSummaryList(summary);\n+    for (Class<? extends GenericSummary> clazz : clazzList) {\n+      Field<Integer> foreignKeyField = DSL.field(\n+          SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n+      SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n+          .buildSummaryQuery(create, clazz.getSimpleName(), upperLevelPrimaryKey, foreignKeyField);\n+      try {\n+        Result<Record> recordList = rcaQuery.fetch();\n+        for (Record record : recordList) {\n+          Method method = clazz.getMethod(\"buildSummary\", Record.class);\n+          GenericSummary summary = (GenericSummary) method.invoke(null, record);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMTAyMw=="}, "originalCommit": {"oid": "9d4f4ce22fa7b3422f9fb2e158c9dbfb4f0b2ee0"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTQ3MjE4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMTozMToxNlrOGVJChQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOTozMTo0MFrOGVrL2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMTM4MQ==", "bodyText": "Consider adding a metric here.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r424821381", "createdAt": "2020-05-14T01:31:16Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -218,42 +215,39 @@ public synchronized RcaResponse readRca(String rca) {\n \n   private void readSummary(GenericSummary upperLevelSummary, int upperLevelPrimaryKey) {\n     String upperLevelTable = upperLevelSummary.getTableName();\n+    List<Class<? extends GenericSummary>> clazzList = SQLiteQueryUtils.getNestedTableMap().getOrDefault(upperLevelSummary.getClass(), null);\n+\n     // stop the recursion here if the table does not have any nested summary.\n-    if (!SQLiteQueryUtils.getNestedTableMap().containsKey(upperLevelTable)) {\n+    if (clazzList == null) {\n       return;\n     }\n-    String currLevelTable = SQLiteQueryUtils.getNestedTableMap().get(upperLevelTable);\n-    Field<Integer> foreignKeyField = DSL.field(\n-        SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n-    SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n-        .buildSummaryQuery(create, currLevelTable, upperLevelPrimaryKey, foreignKeyField);\n-    try {\n-      Result<Record> recordList = rcaQuery.fetch();\n-      for (Record record : recordList) {\n-        GenericSummary summary = null;\n-        if (upperLevelSummary instanceof RcaResponse) {\n-          summary = HotClusterSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotClusterSummary) {\n-          summary = HotNodeSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotNodeSummary) {\n-          summary = HotResourceSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotResourceSummary) {\n-          summary = TopConsumerSummary.buildSummary(record);\n-        }\n-        if (summary != null) {\n-          Field<Integer> primaryKeyField = DSL.field(\n-              SQLiteQueryUtils.getPrimaryKeyColumnName(summary.getTableName()), Integer.class);\n-          readSummary(summary, record.get(primaryKeyField));\n-          upperLevelSummary.addNestedSummaryList(summary);\n+    for (Class<? extends GenericSummary> clazz : clazzList) {\n+      Field<Integer> foreignKeyField = DSL.field(\n+          SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n+      SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n+          .buildSummaryQuery(create, clazz.getSimpleName(), upperLevelPrimaryKey, foreignKeyField);\n+      try {\n+        Result<Record> recordList = rcaQuery.fetch();\n+        for (Record record : recordList) {\n+          Method method = clazz.getMethod(\"buildSummary\", Record.class);\n+          GenericSummary summary = (GenericSummary) method.invoke(null, record);\n+          if (summary != null) {\n+            Field<Integer> primaryKeyField = DSL.field(\n+                SQLiteQueryUtils.getPrimaryKeyColumnName(summary.getTableName()), Integer.class);\n+            readSummary(summary, record.get(primaryKeyField));\n+            upperLevelSummary.addNestedSummaryList(summary);\n+          }\n         }\n       }\n-    }\n-    catch (DataAccessException de) {\n-      // it is totally fine if we fail to read some certain tables as some types of summaries might be missing\n-      LOG.warn(\"Fail to read Summary table : {}, query = {},  exceptions : {}\", currLevelTable, rcaQuery.toString(), de.getStackTrace());\n+      catch (DataAccessException de) {\n+        // it is totally fine if we fail to read some certain tables as some types of summaries might be missing\n+        LOG.warn(\"Fail to read Summary table : {}, query = {},  exceptions : {}\",\n+            clazz.getSimpleName(), rcaQuery.toString(), de.getStackTrace());\n+      } catch (Exception e) {\n+        // we might got a reflection issue if running into this. Check the NestedTableMap and make sure\n+        // the summary class has been added.\n+        LOG.error(\"Fail to use reflection to build GenericSummary, trace = {}\", e.getStackTrace());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d4f4ce22fa7b3422f9fb2e158c9dbfb4f0b2ee0"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4MDgyNw==", "bodyText": "I don't think we need to add a metric here. we will only run into this if there is a bug in this code which doesn't needs to be shown up in the metric.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r425380827", "createdAt": "2020-05-14T19:31:40Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -218,42 +215,39 @@ public synchronized RcaResponse readRca(String rca) {\n \n   private void readSummary(GenericSummary upperLevelSummary, int upperLevelPrimaryKey) {\n     String upperLevelTable = upperLevelSummary.getTableName();\n+    List<Class<? extends GenericSummary>> clazzList = SQLiteQueryUtils.getNestedTableMap().getOrDefault(upperLevelSummary.getClass(), null);\n+\n     // stop the recursion here if the table does not have any nested summary.\n-    if (!SQLiteQueryUtils.getNestedTableMap().containsKey(upperLevelTable)) {\n+    if (clazzList == null) {\n       return;\n     }\n-    String currLevelTable = SQLiteQueryUtils.getNestedTableMap().get(upperLevelTable);\n-    Field<Integer> foreignKeyField = DSL.field(\n-        SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n-    SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n-        .buildSummaryQuery(create, currLevelTable, upperLevelPrimaryKey, foreignKeyField);\n-    try {\n-      Result<Record> recordList = rcaQuery.fetch();\n-      for (Record record : recordList) {\n-        GenericSummary summary = null;\n-        if (upperLevelSummary instanceof RcaResponse) {\n-          summary = HotClusterSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotClusterSummary) {\n-          summary = HotNodeSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotNodeSummary) {\n-          summary = HotResourceSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotResourceSummary) {\n-          summary = TopConsumerSummary.buildSummary(record);\n-        }\n-        if (summary != null) {\n-          Field<Integer> primaryKeyField = DSL.field(\n-              SQLiteQueryUtils.getPrimaryKeyColumnName(summary.getTableName()), Integer.class);\n-          readSummary(summary, record.get(primaryKeyField));\n-          upperLevelSummary.addNestedSummaryList(summary);\n+    for (Class<? extends GenericSummary> clazz : clazzList) {\n+      Field<Integer> foreignKeyField = DSL.field(\n+          SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n+      SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n+          .buildSummaryQuery(create, clazz.getSimpleName(), upperLevelPrimaryKey, foreignKeyField);\n+      try {\n+        Result<Record> recordList = rcaQuery.fetch();\n+        for (Record record : recordList) {\n+          Method method = clazz.getMethod(\"buildSummary\", Record.class);\n+          GenericSummary summary = (GenericSummary) method.invoke(null, record);\n+          if (summary != null) {\n+            Field<Integer> primaryKeyField = DSL.field(\n+                SQLiteQueryUtils.getPrimaryKeyColumnName(summary.getTableName()), Integer.class);\n+            readSummary(summary, record.get(primaryKeyField));\n+            upperLevelSummary.addNestedSummaryList(summary);\n+          }\n         }\n       }\n-    }\n-    catch (DataAccessException de) {\n-      // it is totally fine if we fail to read some certain tables as some types of summaries might be missing\n-      LOG.warn(\"Fail to read Summary table : {}, query = {},  exceptions : {}\", currLevelTable, rcaQuery.toString(), de.getStackTrace());\n+      catch (DataAccessException de) {\n+        // it is totally fine if we fail to read some certain tables as some types of summaries might be missing\n+        LOG.warn(\"Fail to read Summary table : {}, query = {},  exceptions : {}\",\n+            clazz.getSimpleName(), rcaQuery.toString(), de.getStackTrace());\n+      } catch (Exception e) {\n+        // we might got a reflection issue if running into this. Check the NestedTableMap and make sure\n+        // the summary class has been added.\n+        LOG.error(\"Fail to use reflection to build GenericSummary, trace = {}\", e.getStackTrace());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMTM4MQ=="}, "originalCommit": {"oid": "9d4f4ce22fa7b3422f9fb2e158c9dbfb4f0b2ee0"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTM0OTA0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/util/SQLiteQueryUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTo1MDoyMlrOGVvenQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMDowNjoxMFrOGVyLOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1MTE2NQ==", "bodyText": "I think the nesting should be internal to each top level summary rather than in the util class.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r425451165", "createdAt": "2020-05-14T21:50:22Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/util/SQLiteQueryUtils.java", "diffHunk": "@@ -48,24 +48,36 @@\n  * A utility class to query cluster, node and resource level summary for a rca\n  */\n public class SQLiteQueryUtils {\n-  private static final Map<String, String> nestedTableMap;\n+  private static final Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> nestedTableMap;\n   private static final Map<String, String> temperatureProfileNestedSummaryMap;\n   private static final Set<String> clusterLevelRCA;\n   private static final Set<String> temperatureProfileRCASet;\n \n-  // to map table => its nested table\n-  // e.g. HotClusterSummary => HotNodeSummary\n-  static {\n-    Map<String, String> tableMap = new HashMap<>();\n-    tableMap.put(ClusterTemperatureSummary.TABLE_NAME, ClusterDimensionalSummary.TABLE_NAME);\n \n-    tableMap.put(ResourceFlowUnit.RCA_TABLE_NAME, HOT_CLUSTER_SUMMARY_TABLE);\n-    tableMap.put(HOT_CLUSTER_SUMMARY_TABLE, HOT_NODE_SUMMARY_TABLE);\n-    tableMap.put(HOT_NODE_SUMMARY_TABLE, HOT_RESOURCE_SUMMARY_TABLE);\n-    tableMap.put(HOT_RESOURCE_SUMMARY_TABLE, TOP_CONSUMER_SUMMARY_TABLE);\n+  // mapping between table => its nested table\n+  // RCA API query\n+  // |\n+  // RcaResponse -- HotClusterSummary -- HotNodeSummary -- HotResourceSummary -- TopConsumerSummary\n+  //                                                   |\n+  //                                                    -- HotShardSummary\n+  static {\n+    Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> tableMap = new HashMap<>();\n+    tableMap.put(RcaResponse.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotClusterSummary.class)));\n+    tableMap.put(HotClusterSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotNodeSummary.class)));\n+    tableMap.put(HotNodeSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotResourceSummary.class)));\n+    tableMap.put(HotResourceSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        TopConsumerSummary.class)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04992c9045828493da6bf1771f15f43b96923f2a"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5NTM1NA==", "bodyText": "thanks for pointing this out. yeah this is indeed a much cleaner implementation. I have added the list to each summary class", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r425495354", "createdAt": "2020-05-15T00:06:10Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/util/SQLiteQueryUtils.java", "diffHunk": "@@ -48,24 +48,36 @@\n  * A utility class to query cluster, node and resource level summary for a rca\n  */\n public class SQLiteQueryUtils {\n-  private static final Map<String, String> nestedTableMap;\n+  private static final Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> nestedTableMap;\n   private static final Map<String, String> temperatureProfileNestedSummaryMap;\n   private static final Set<String> clusterLevelRCA;\n   private static final Set<String> temperatureProfileRCASet;\n \n-  // to map table => its nested table\n-  // e.g. HotClusterSummary => HotNodeSummary\n-  static {\n-    Map<String, String> tableMap = new HashMap<>();\n-    tableMap.put(ClusterTemperatureSummary.TABLE_NAME, ClusterDimensionalSummary.TABLE_NAME);\n \n-    tableMap.put(ResourceFlowUnit.RCA_TABLE_NAME, HOT_CLUSTER_SUMMARY_TABLE);\n-    tableMap.put(HOT_CLUSTER_SUMMARY_TABLE, HOT_NODE_SUMMARY_TABLE);\n-    tableMap.put(HOT_NODE_SUMMARY_TABLE, HOT_RESOURCE_SUMMARY_TABLE);\n-    tableMap.put(HOT_RESOURCE_SUMMARY_TABLE, TOP_CONSUMER_SUMMARY_TABLE);\n+  // mapping between table => its nested table\n+  // RCA API query\n+  // |\n+  // RcaResponse -- HotClusterSummary -- HotNodeSummary -- HotResourceSummary -- TopConsumerSummary\n+  //                                                   |\n+  //                                                    -- HotShardSummary\n+  static {\n+    Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> tableMap = new HashMap<>();\n+    tableMap.put(RcaResponse.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotClusterSummary.class)));\n+    tableMap.put(HotClusterSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotNodeSummary.class)));\n+    tableMap.put(HotNodeSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotResourceSummary.class)));\n+    tableMap.put(HotResourceSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        TopConsumerSummary.class)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1MTE2NQ=="}, "originalCommit": {"oid": "04992c9045828493da6bf1771f15f43b96923f2a"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTM0OTU2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/util/SQLiteQueryUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTo1MDozMlrOGVve8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMDowNjoxOFrOGVyLYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1MTI0OQ==", "bodyText": "remove ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r425451249", "createdAt": "2020-05-14T21:50:32Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/util/SQLiteQueryUtils.java", "diffHunk": "@@ -48,24 +48,36 @@\n  * A utility class to query cluster, node and resource level summary for a rca\n  */\n public class SQLiteQueryUtils {\n-  private static final Map<String, String> nestedTableMap;\n+  private static final Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> nestedTableMap;\n   private static final Map<String, String> temperatureProfileNestedSummaryMap;\n   private static final Set<String> clusterLevelRCA;\n   private static final Set<String> temperatureProfileRCASet;\n \n-  // to map table => its nested table\n-  // e.g. HotClusterSummary => HotNodeSummary\n-  static {\n-    Map<String, String> tableMap = new HashMap<>();\n-    tableMap.put(ClusterTemperatureSummary.TABLE_NAME, ClusterDimensionalSummary.TABLE_NAME);\n \n-    tableMap.put(ResourceFlowUnit.RCA_TABLE_NAME, HOT_CLUSTER_SUMMARY_TABLE);\n-    tableMap.put(HOT_CLUSTER_SUMMARY_TABLE, HOT_NODE_SUMMARY_TABLE);\n-    tableMap.put(HOT_NODE_SUMMARY_TABLE, HOT_RESOURCE_SUMMARY_TABLE);\n-    tableMap.put(HOT_RESOURCE_SUMMARY_TABLE, TOP_CONSUMER_SUMMARY_TABLE);\n+  // mapping between table => its nested table\n+  // RCA API query\n+  // |\n+  // RcaResponse -- HotClusterSummary -- HotNodeSummary -- HotResourceSummary -- TopConsumerSummary\n+  //                                                   |\n+  //                                                    -- HotShardSummary\n+  static {\n+    Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> tableMap = new HashMap<>();\n+    tableMap.put(RcaResponse.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotClusterSummary.class)));\n+    tableMap.put(HotClusterSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotNodeSummary.class)));\n+    tableMap.put(HotNodeSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotResourceSummary.class)));\n+    tableMap.put(HotResourceSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        TopConsumerSummary.class)));\n+\n+    //temperature profiling mapping\n+    tableMap.put(ClusterTemperatureSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        ClusterDimensionalSummary.class)));\n     nestedTableMap = Collections.unmodifiableMap(tableMap);\n   }\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04992c9045828493da6bf1771f15f43b96923f2a"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5NTM5Mg==", "bodyText": "removed", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r425495392", "createdAt": "2020-05-15T00:06:18Z", "author": {"login": "rguo-aws"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/util/SQLiteQueryUtils.java", "diffHunk": "@@ -48,24 +48,36 @@\n  * A utility class to query cluster, node and resource level summary for a rca\n  */\n public class SQLiteQueryUtils {\n-  private static final Map<String, String> nestedTableMap;\n+  private static final Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> nestedTableMap;\n   private static final Map<String, String> temperatureProfileNestedSummaryMap;\n   private static final Set<String> clusterLevelRCA;\n   private static final Set<String> temperatureProfileRCASet;\n \n-  // to map table => its nested table\n-  // e.g. HotClusterSummary => HotNodeSummary\n-  static {\n-    Map<String, String> tableMap = new HashMap<>();\n-    tableMap.put(ClusterTemperatureSummary.TABLE_NAME, ClusterDimensionalSummary.TABLE_NAME);\n \n-    tableMap.put(ResourceFlowUnit.RCA_TABLE_NAME, HOT_CLUSTER_SUMMARY_TABLE);\n-    tableMap.put(HOT_CLUSTER_SUMMARY_TABLE, HOT_NODE_SUMMARY_TABLE);\n-    tableMap.put(HOT_NODE_SUMMARY_TABLE, HOT_RESOURCE_SUMMARY_TABLE);\n-    tableMap.put(HOT_RESOURCE_SUMMARY_TABLE, TOP_CONSUMER_SUMMARY_TABLE);\n+  // mapping between table => its nested table\n+  // RCA API query\n+  // |\n+  // RcaResponse -- HotClusterSummary -- HotNodeSummary -- HotResourceSummary -- TopConsumerSummary\n+  //                                                   |\n+  //                                                    -- HotShardSummary\n+  static {\n+    Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> tableMap = new HashMap<>();\n+    tableMap.put(RcaResponse.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotClusterSummary.class)));\n+    tableMap.put(HotClusterSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotNodeSummary.class)));\n+    tableMap.put(HotNodeSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotResourceSummary.class)));\n+    tableMap.put(HotResourceSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        TopConsumerSummary.class)));\n+\n+    //temperature profiling mapping\n+    tableMap.put(ClusterTemperatureSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        ClusterDimensionalSummary.class)));\n     nestedTableMap = Collections.unmodifiableMap(tableMap);\n   }\n \n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1MTI0OQ=="}, "originalCommit": {"oid": "04992c9045828493da6bf1771f15f43b96923f2a"}, "originalPosition": 68}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2458, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}