{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNDMwNTk2", "number": 282, "title": "Fix PersistFlowUnitAndSummaryTest", "bodyText": "Issue #, if available:\n#284\nDescription of changes:\nFix PersistFlowUnitAndSummaryTest in UTs\nWe found three issue when debugging this UT:\n\ndb contention. need to run those two UT tests in sequential order\nDataAcessExecption is not handled  when persistor trys to create a new table\nthe graph defined in UT was wrong. the node tag need to be changed with MASTER_DATA\n\nTests:\nCode coverage percentage for this patch:\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-07-16T19:01:03Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/282", "merged": true, "mergeCommit": {"oid": "b0304089c8e943df2b58bf303323a6bba43fb079"}, "closed": true, "closedAt": "2020-07-16T21:27:51Z", "author": {"login": "rguo-aws"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1j4wGAH2gAyNDUwNDMwNTk2OjliYTExMWJkNWVmY2M3YjcwMDZhNzZmOGJhYjMzYWM4YTQxZDA3YjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1mGhVgFqTQ1MDIyODc4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ba111bd5efcc7b7006a76f8bab33ac8a41d07b4", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9ba111bd5efcc7b7006a76f8bab33ac8a41d07b4", "committedDate": "2020-07-16T18:52:44Z", "message": "Fix PersistFlowUnitAndSummaryTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a16048d1a39e7838e3df0cd9dc39ea700d0f8e5", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/7a16048d1a39e7838e3df0cd9dc39ea700d0f8e5", "committedDate": "2020-07-16T18:53:33Z", "message": "update gradle.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e03329b8fef61d457b21ce3bc5d5693989bc75", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/20e03329b8fef61d457b21ce3bc5d5693989bc75", "committedDate": "2020-07-16T19:00:21Z", "message": "revert changes made in gradle.yml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMTM3NjMx", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/282#pullrequestreview-450137631", "createdAt": "2020-07-16T19:12:47Z", "commit": {"oid": "20e03329b8fef61d457b21ce3bc5d5693989bc75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMTM4Njgx", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/282#pullrequestreview-450138681", "createdAt": "2020-07-16T19:14:11Z", "commit": {"oid": "20e03329b8fef61d457b21ce3bc5d5693989bc75"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxOToxNDoxMVrOGy43BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxOToxOToxNVrOGy5Byg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxMzU3Mg==", "bodyText": "Shouldn't this be error ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/282#discussion_r456013572", "createdAt": "2020-07-16T19:14:11Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PersistorBase.java", "diffHunk": "@@ -211,7 +212,7 @@ private void rotateRegisterGarbageThenCreateNewDB(RotationType type) throws IOEx\n       T flowUnit, String tableName) throws SQLException, IOException {\n     try {\n         tryWriteFlowUnit(flowUnit, tableName);\n-    } catch (SQLException e) {\n+    } catch (SQLException | DataAccessException e) {\n       LOG.info(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20e03329b8fef61d457b21ce3bc5d5693989bc75"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxNjMzMA==", "bodyText": "I see that HighHeapUsageClusterRcaX node is created in the construct but it is removed from verification here. Can you add a code-comment with the reason ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/282#discussion_r456016330", "createdAt": "2020-07-16T19:19:15Z", "author": {"login": "yojs"}, "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PersistFlowUnitAndSummaryTest.java", "diffHunk": "@@ -176,35 +176,44 @@ private AppContext createAppContextWithDataNodes(String nodeName, NodeRole role)\n     return appContext;\n   }\n \n+  /**\n+   * Add testPersistSummaryOnDataNode() and testPersistSummaryOnMasterNode() into a single UT\n+   * This will force both tests to run in sequential and can avoid access contention to the\n+   * same db file.\n+   * @throws Exception SQL exception\n+   */\n   @Test\n-  public void testPersistSummaryOnDataNode() throws Exception {\n-    AppContext appContext = createAppContextWithDataNodes(\"node1\", NodeRole.DATA);\n-\n-    AnalysisGraph graph = new DataNodeGraph();\n+  public void testPersisSummary() throws Exception {\n     RcaConf rcaConf = new RcaConf(Paths.get(RcaConsts.TEST_CONFIG_PATH, \"rca.conf\").toString());\n+    RcaConf masterRcaConf = new RcaConf(Paths.get(RcaConsts.TEST_CONFIG_PATH, \"rca_elected_master.conf\").toString());\n     Persistable persistable = PersistenceFactory.create(rcaConf);\n+    testPersistSummaryOnDataNode(rcaConf, persistable);\n+    testPersistSummaryOnMasterNode(masterRcaConf, persistable);\n+    persistable.close();\n+  }\n+\n+  private void testPersistSummaryOnDataNode(RcaConf rcaConf, Persistable persistable) throws Exception {\n+    AppContext appContext = createAppContextWithDataNodes(\"node1\", NodeRole.DATA, false);\n+\n+    AnalysisGraph graph = new DataNodeGraph();\n     RCAScheduler scheduler = startScheduler(rcaConf, graph, persistable, this.queryable, appContext);\n     // Wait at most 1 minute for the persisted data to show up with the correct contents\n     WaitFor.waitFor(() -> {\n       String readTableStr = persistable.read();\n       System.out.println(readTableStr);\n       if (readTableStr != null) {\n         return readTableStr.contains(\"HotResourceSummary\") && readTableStr.contains(\"DummyYoungGenRca\")\n-                && readTableStr.contains(\"HotNodeSummary\") && readTableStr.contains(\"HotNodeRcaX\")\n-                && readTableStr.contains(\"HighHeapUsageClusterRcaX\");\n+                && readTableStr.contains(\"HotNodeSummary\") && readTableStr.contains(\"HotNodeRcaX\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20e03329b8fef61d457b21ce3bc5d5693989bc75"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdc92d022774a5f44bd2a049201c8f1d881ae746", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/cdc92d022774a5f44bd2a049201c8f1d881ae746", "committedDate": "2020-07-16T20:37:42Z", "message": "Address PR comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acc8dc259039e8a0e591b30f683cb3875c2df049", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/acc8dc259039e8a0e591b30f683cb3875c2df049", "committedDate": "2020-07-16T20:40:22Z", "message": "Add comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMjI4Nzg0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/282#pullrequestreview-450228784", "createdAt": "2020-07-16T21:27:36Z", "commit": {"oid": "acc8dc259039e8a0e591b30f683cb3875c2df049"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1086, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}