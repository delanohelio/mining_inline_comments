{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMzg4NDU2", "number": 168, "title": "Muting API", "bodyText": "Description of changes: The RcaController thread will check the muted_rcas.conf file and update the Analysis Graph for muted RCAs. Plugged into existing code to disable reading metrics if node is Muted.\nAdded UTs\nIncoporated PR Feedback\n\nThe API behavior : The API will be invoked with full list of RCAs that are expected to be muted. The input will be provided as a comma separated string, similar to \"CPU_Utilization, Heap_AllocRate\". The API implementation takes care of validating the RCA names provided in the input and any leading/trailing spaces.\nIf API is invoked with at least 1 valid RCA, the muted RCA Graph is updated to retain only this valid RCA(s).\nIf API is invoked with an empty string, the muted RCA Graph is updated and all previous existing RCAs in the graph are removed.\nIf API is invoked with an all invalid RCAs, no action is taken.\n\nTests: UT, Dev Stack Testing\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-04-28T22:13:20Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168", "merged": true, "mergeCommit": {"oid": "967708be2b43efbe4952e79bb21d6f60d998d704"}, "closed": true, "closedAt": "2020-04-29T01:37:14Z", "author": {"login": "khushbr"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccJiatAH2gAyNDEwMzg4NDU2OjM5MmY4OTQ0YzZhZTU5NWY3ZmYwZWE3M2FiNTQ1ZDYyMTlhMzYxMDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccOUkdAFqTQwMjMxOTQwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "392f8944c6ae595f7ff0ea73ab545d6219a36102", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/392f8944c6ae595f7ff0ea73ab545d6219a36102", "committedDate": "2020-04-28T20:02:42Z", "message": "Addressing CR comments, part -2. Separating the rca.conf files for testing Muted RCAs and making chaged to RcaController"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2ff4559489b6c42aee4904247248d173d135ef7", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/c2ff4559489b6c42aee4904247248d173d135ef7", "committedDate": "2020-04-28T22:03:14Z", "message": "Addressing PR Comments, Part-3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMjU1Mzgx", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#pullrequestreview-402255381", "createdAt": "2020-04-28T22:24:19Z", "commit": {"oid": "c2ff4559489b6c42aee4904247248d173d135ef7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMjoyNDoxOVrOGNpPfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMjoyODoxNlrOGNpVfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MDM4Mw==", "bodyText": "getAllNodes() is an expensive call. It should only be called if nodeNames is uninitialized.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r416960383", "createdAt": "2020-04-28T22:24:19Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/ConnectedComponent.java", "diffHunk": "@@ -114,4 +117,10 @@ public void addLeafNode(Node node) {\n     }\n     return dependencyOrderedNodes;\n   }\n+\n+  public Set<String> getNodeNames() {\n+    getAllNodes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ff4559489b6c42aee4904247248d173d135ef7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MTQyNw==", "bodyText": "I don't get it, why can't we just call getNodeNames() instead of calling the expensive method getAnalysisGraphComponents ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r416961427", "createdAt": "2020-04-28T22:26:58Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -253,6 +261,51 @@ private void readRcaEnabledFromConf() {\n             rcaEnabled = rcaEnabledDefaultValue;\n           }\n         });\n+\n+    // If RCA is enabled, update Analysis graph with Muted RCAs value\n+    if (rcaEnabled) {\n+      LOG.debug(\"Updating Analysis Graph with Muted RCAs\");\n+      readAndUpdateMutesRcas();\n+    }\n+  }\n+\n+  /**\n+   * Reads the mutedRCAList value from the rca.conf file, performs validation on the param value\n+   * provided and on successful validation, updates the AnalysisGraph with muted RCA value.\n+   *\n+   * <p>In case all the RCAs in param value are incorrect, return without any update.\n+   */\n+  private void readAndUpdateMutesRcas() {\n+    // If the rca config file has been updated since the lastModifiedTimeInMillisInMemory in memory,\n+    // refresh the `muted-rcas` value from rca config file.\n+    long lastModifiedTimeInMillisOnDisk = rcaConf.getLastModifiedTime();\n+    if (lastModifiedTimeInMillisOnDisk > lastModifiedTimeInMillisInMemory) {\n+      try {\n+        Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+        LOG.info(\"RCAs provided for muting : {}\", rcasForMute);\n+\n+        Set<String> graphNodeNames = new HashSet<>();\n+        RcaUtil.getAnalysisGraphComponents(rcaConf).forEach(\n+                connectedComponent -> graphNodeNames.addAll(connectedComponent.getNodeNames()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ff4559489b6c42aee4904247248d173d135ef7"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MTkxNw==", "bodyText": "Ideally this one should be:\nrcasForMute.retainAll(getNodeNames());, right ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r416961917", "createdAt": "2020-04-28T22:28:16Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -253,6 +261,51 @@ private void readRcaEnabledFromConf() {\n             rcaEnabled = rcaEnabledDefaultValue;\n           }\n         });\n+\n+    // If RCA is enabled, update Analysis graph with Muted RCAs value\n+    if (rcaEnabled) {\n+      LOG.debug(\"Updating Analysis Graph with Muted RCAs\");\n+      readAndUpdateMutesRcas();\n+    }\n+  }\n+\n+  /**\n+   * Reads the mutedRCAList value from the rca.conf file, performs validation on the param value\n+   * provided and on successful validation, updates the AnalysisGraph with muted RCA value.\n+   *\n+   * <p>In case all the RCAs in param value are incorrect, return without any update.\n+   */\n+  private void readAndUpdateMutesRcas() {\n+    // If the rca config file has been updated since the lastModifiedTimeInMillisInMemory in memory,\n+    // refresh the `muted-rcas` value from rca config file.\n+    long lastModifiedTimeInMillisOnDisk = rcaConf.getLastModifiedTime();\n+    if (lastModifiedTimeInMillisOnDisk > lastModifiedTimeInMillisInMemory) {\n+      try {\n+        Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+        LOG.info(\"RCAs provided for muting : {}\", rcasForMute);\n+\n+        Set<String> graphNodeNames = new HashSet<>();\n+        RcaUtil.getAnalysisGraphComponents(rcaConf).forEach(\n+                connectedComponent -> graphNodeNames.addAll(connectedComponent.getNodeNames()));\n+\n+        // Update rcasForMute to retain only valid RCAs\n+        rcasForMute.retainAll(graphNodeNames);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ff4559489b6c42aee4904247248d173d135ef7"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMjk1OTgw", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#pullrequestreview-402295980", "createdAt": "2020-04-29T00:10:38Z", "commit": {"oid": "c2ff4559489b6c42aee4904247248d173d135ef7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwMDoxMDozOVrOGNrjWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwMDoxMDozOVrOGNrjWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk5ODIzNQ==", "bodyText": "nit: suggest renaming this(and other instances) to node muting instead of rca muting. We're not restricting this to just rca nodes anywhere.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r416998235", "createdAt": "2020-04-29T00:10:39Z", "author": {"login": "ktkrg"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -253,6 +261,51 @@ private void readRcaEnabledFromConf() {\n             rcaEnabled = rcaEnabledDefaultValue;\n           }\n         });\n+\n+    // If RCA is enabled, update Analysis graph with Muted RCAs value\n+    if (rcaEnabled) {\n+      LOG.debug(\"Updating Analysis Graph with Muted RCAs\");\n+      readAndUpdateMutesRcas();\n+    }\n+  }\n+\n+  /**\n+   * Reads the mutedRCAList value from the rca.conf file, performs validation on the param value\n+   * provided and on successful validation, updates the AnalysisGraph with muted RCA value.\n+   *\n+   * <p>In case all the RCAs in param value are incorrect, return without any update.\n+   */\n+  private void readAndUpdateMutesRcas() {\n+    // If the rca config file has been updated since the lastModifiedTimeInMillisInMemory in memory,\n+    // refresh the `muted-rcas` value from rca config file.\n+    long lastModifiedTimeInMillisOnDisk = rcaConf.getLastModifiedTime();\n+    if (lastModifiedTimeInMillisOnDisk > lastModifiedTimeInMillisInMemory) {\n+      try {\n+        Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+        LOG.info(\"RCAs provided for muting : {}\", rcasForMute);\n+\n+        Set<String> graphNodeNames = new HashSet<>();\n+        RcaUtil.getAnalysisGraphComponents(rcaConf).forEach(\n+                connectedComponent -> graphNodeNames.addAll(connectedComponent.getNodeNames()));\n+\n+        // Update rcasForMute to retain only valid RCAs\n+        rcasForMute.retainAll(graphNodeNames);\n+\n+        // If rcasForMute post validation is empty but rcaConf.getMutedRcaList() is not empty\n+        // all the input RCAs are incorrect, return.\n+        if (rcasForMute.isEmpty() && !rcaConf.getMutedRcaList().isEmpty()) {\n+          LOG.error(\"Incorrect RCA(s): {}, cannot be muted. Valid RCAs: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ff4559489b6c42aee4904247248d173d135ef7"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "288e883d1ef5a3f67d6e0f23d8725f5a41e9af06", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/288e883d1ef5a3f67d6e0f23d8725f5a41e9af06", "committedDate": "2020-04-29T01:27:23Z", "message": "Addressing PR Comments, Part-4"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMzE5NDA2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#pullrequestreview-402319406", "createdAt": "2020-04-29T01:37:06Z", "commit": {"oid": "288e883d1ef5a3f67d6e0f23d8725f5a41e9af06"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1224, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}