{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExMjY1OTEw", "number": 178, "title": "Handle race condition between RCA Scheduler start and RCA Node muting", "bodyText": "Description of changes: Ideally, the RCA Node muting should be performed after the graph creation and before the RCA Scheduler starts.  When RCA nodes are muted before the graph creation, we get the following error :\nPerformanceAnalyzer.log.2020-04-30-01:[2020-04-30T01:00:43,236][ERROR][c.a.o.e.p.r.RcaController] Incorrect RCA(s): [HighHeapUsageClusterRca, HotNodeRca], cannot be muted. Valid RCAs: [], Muted RCAs: []\nPerformanceAnalyzer.log.2020-04-30-01:[2020-04-30T01:17:35,339][ERROR][c.a.o.e.p.r.RcaController] Incorrect RCA(s): [HighHeapUsageClusterRca], cannot be muted. Valid RCAs: [], Muted RCAs: null\n\nSo, now :\n\nInvoking readAndUpdateMutesRcas() as part of start(), after the graph creation to ensure that muted RCAs are present for the first run when scheduler comes up.\nChecking as part readAndUpdateMutesRcas() for graphNodes as non-empty (indicative of graph creation)\n\nAlso, added a metric to track MuteRcaError\n\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-04-30T08:54:01Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/178", "merged": true, "mergeCommit": {"oid": "59386cfa99292d1c7fff063769c49b13f99a31a0"}, "closed": true, "closedAt": "2020-04-30T23:56:15Z", "author": {"login": "khushbr"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcciTMfAH2gAyNDExMjY1OTEwOmUzMTY3NjQwZmRjZWI3YzZkOTQxNjZlMzE4OTE5NmU0MmYyNTgyZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcc2EzggFqTQwMzk1MzQ1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e3167640fdceb7c6d94166e3189196e42f2582fa", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e3167640fdceb7c6d94166e3189196e42f2582fa", "committedDate": "2020-04-30T00:53:42Z", "message": "Adding metric for RCA Mute Error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e017620a5e72564738a46f91f2d52047aee9ccd3", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e017620a5e72564738a46f91f2d52047aee9ccd3", "committedDate": "2020-04-30T08:28:59Z", "message": "Handling the race condition between RCA Scheduler start and RCA Node muting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01f3f8223b9892a335a65d3dc18efd84cfd43e3e", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/01f3f8223b9892a335a65d3dc18efd84cfd43e3e", "committedDate": "2020-04-30T08:51:20Z", "message": "Fixing Checkstyle error and adding a metric for RCA_MUTE_ERROR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNTkyNTIw", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/178#pullrequestreview-403592520", "createdAt": "2020-04-30T14:46:02Z", "commit": {"oid": "01f3f8223b9892a335a65d3dc18efd84cfd43e3e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3829a51a705a485d0eb9dd704ccb471bef318e56", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3829a51a705a485d0eb9dd704ccb471bef318e56", "committedDate": "2020-04-30T23:16:23Z", "message": "Making the mutedRcas as List of String in JSON"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzOTQ3ODEy", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/178#pullrequestreview-403947812", "createdAt": "2020-04-30T23:39:08Z", "commit": {"oid": "3829a51a705a485d0eb9dd704ccb471bef318e56"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMzozOTowOFrOGO98lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMzo0MToxMlrOGO9-1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0ODE4Mw==", "bodyText": "Do we not want this instead -\n\"muted-rcas\": [\"CPU_Utilization\", \"Heap_AllocRate\"] ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/178#discussion_r418348183", "createdAt": "2020-04-30T23:39:08Z", "author": {"login": "yojs"}, "path": "src/test/resources/rca/rca_muted.conf", "diffHunk": "@@ -44,5 +44,5 @@\n     \"rotation-period-seconds\": 21600\n   },\n \n-  \"muted-rcas\": \"CPU_Utilization, Heap_AllocRate\"\n+  \"muted-rcas\": [\"CPU_Utilization, Heap_AllocRate\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3829a51a705a485d0eb9dd704ccb471bef318e56"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0ODc1Nw==", "bodyText": "typo: readAndUpdateMutedRcas instead ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/178#discussion_r418348757", "createdAt": "2020-04-30T23:41:12Z", "author": {"login": "yojs"}, "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaControllerTest.java", "diffHunk": "@@ -162,9 +169,39 @@ public void readRcaEnabledFromConf() throws IOException {\n     Assert.assertTrue(RcaController.isRcaEnabled());\n   }\n \n+  @Test\n+  public void readAndUpdateMutesRcasBeforeGraphCreation() throws Exception {\n+    Method readAndUpdateMutesRcas = rcaController.getClass()\n+            .getDeclaredMethod(\"readAndUpdateMutesRcas\", null);\n+    readAndUpdateMutesRcas.setAccessible(true);\n+\n+    String rcaConfPath = Paths.get(RcaConsts.TEST_CONFIG_PATH, \"rca_muted.conf\").toString();\n+    Field rcaConfField = rcaController.getClass().getDeclaredField(\"rcaConf\");\n+    rcaConfField.setAccessible(true);\n+    rcaConfField.set(rcaController, new RcaConf(rcaConfPath));\n+    updateConfFileForMutedRcas(rcaConfPath, Arrays.asList(\"CPU_Utilization\", \"Heap_AllocRate\"));\n+\n+    Field mutedGraphNodesField = Stats.class.getDeclaredField(\"mutedGraphNodes\");\n+    mutedGraphNodesField.setAccessible(true);\n+    mutedGraphNodesField.set(Stats.getInstance(), null);\n+    Set<String> initialComponentSet = ConnectedComponent.getNodeNames();\n+    Whitebox.setInternalState(ConnectedComponent.class, \"nodeNames\", new HashSet<>());\n+\n+    readAndUpdateMutesRcas.invoke(rcaController);\n+    Assert.assertNull(Stats.getInstance().getMutedGraphNodes());\n+\n+    // Re-set back to initialComponentSet\n+    Whitebox.setInternalState(ConnectedComponent.class, \"nodeNames\", initialComponentSet);\n+  }\n+\n   @Test\n   public void readAndUpdateMutesRcas() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3829a51a705a485d0eb9dd704ccb471bef318e56"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0898237d5e6b16e4e37cd437c2348df90a917129", "author": {"user": {"login": "khushbr", "name": "Khushboo Rajput"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0898237d5e6b16e4e37cd437c2348df90a917129", "committedDate": "2020-04-30T23:50:48Z", "message": "Addressing the PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzOTUyMjIy", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/178#pullrequestreview-403952222", "createdAt": "2020-04-30T23:52:15Z", "commit": {"oid": "0898237d5e6b16e4e37cd437c2348df90a917129"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzOTUzNDUy", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/178#pullrequestreview-403953452", "createdAt": "2020-04-30T23:56:05Z", "commit": {"oid": "0898237d5e6b16e4e37cd437c2348df90a917129"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1236, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}