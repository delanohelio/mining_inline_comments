{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NjkwMDIy", "number": 192, "title": "Change the static summary table mapping to support 1 to n mapping", "bodyText": "Issue #, if available:\nDescription of changes:\nChange the static summary table mapping to support 1 to n mapping. Now the summary can have different types of summary object in its nested summary list.\ni.e.\nWe can attach both HotResourceSummary and HotShardSummary to HotNodeSummary.\nTests:\ntested on docker\nCode coverage percentage for this patch:\nBy submitting this pull request, I confirm that my contribution is made under the terms of the Apache 2.0 license.", "createdAt": "2020-05-14T00:59:34Z", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192", "merged": true, "mergeCommit": {"oid": "d0ccbcc3854765c5c42a319c07067330804b44ef"}, "closed": true, "closedAt": "2020-05-20T21:42:54Z", "author": {"login": "rguo-aws"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchCuZKAH2gAyNDE3NjkwMDIyOjlkNGY0Y2UyMmZhN2IzNDIyZjlmYjJlMTU4YzlkYmZiNGYwYjJlZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjQJ98AFqTQxNTczNTg2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d4f4ce22fa7b3422f9fb2e158c9dbfb4f0b2ee0", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9d4f4ce22fa7b3422f9fb2e158c9dbfb4f0b2ee0", "committedDate": "2020-05-14T00:56:04Z", "message": "Change the static summary table mapping to support 1 to n mapping"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDA1ODk5", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#pullrequestreview-411405899", "createdAt": "2020-05-14T01:29:56Z", "commit": {"oid": "9d4f4ce22fa7b3422f9fb2e158c9dbfb4f0b2ee0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMToyOTo1N1rOGVJBHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMTozMToxNlrOGVJChQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMTAyMw==", "bodyText": "(GenericSummary) method.invoke(null, record);, is the null required here?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r424821023", "createdAt": "2020-05-14T01:29:57Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -218,42 +215,39 @@ public synchronized RcaResponse readRca(String rca) {\n \n   private void readSummary(GenericSummary upperLevelSummary, int upperLevelPrimaryKey) {\n     String upperLevelTable = upperLevelSummary.getTableName();\n+    List<Class<? extends GenericSummary>> clazzList = SQLiteQueryUtils.getNestedTableMap().getOrDefault(upperLevelSummary.getClass(), null);\n+\n     // stop the recursion here if the table does not have any nested summary.\n-    if (!SQLiteQueryUtils.getNestedTableMap().containsKey(upperLevelTable)) {\n+    if (clazzList == null) {\n       return;\n     }\n-    String currLevelTable = SQLiteQueryUtils.getNestedTableMap().get(upperLevelTable);\n-    Field<Integer> foreignKeyField = DSL.field(\n-        SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n-    SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n-        .buildSummaryQuery(create, currLevelTable, upperLevelPrimaryKey, foreignKeyField);\n-    try {\n-      Result<Record> recordList = rcaQuery.fetch();\n-      for (Record record : recordList) {\n-        GenericSummary summary = null;\n-        if (upperLevelSummary instanceof RcaResponse) {\n-          summary = HotClusterSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotClusterSummary) {\n-          summary = HotNodeSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotNodeSummary) {\n-          summary = HotResourceSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotResourceSummary) {\n-          summary = TopConsumerSummary.buildSummary(record);\n-        }\n-        if (summary != null) {\n-          Field<Integer> primaryKeyField = DSL.field(\n-              SQLiteQueryUtils.getPrimaryKeyColumnName(summary.getTableName()), Integer.class);\n-          readSummary(summary, record.get(primaryKeyField));\n-          upperLevelSummary.addNestedSummaryList(summary);\n+    for (Class<? extends GenericSummary> clazz : clazzList) {\n+      Field<Integer> foreignKeyField = DSL.field(\n+          SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n+      SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n+          .buildSummaryQuery(create, clazz.getSimpleName(), upperLevelPrimaryKey, foreignKeyField);\n+      try {\n+        Result<Record> recordList = rcaQuery.fetch();\n+        for (Record record : recordList) {\n+          Method method = clazz.getMethod(\"buildSummary\", Record.class);\n+          GenericSummary summary = (GenericSummary) method.invoke(null, record);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d4f4ce22fa7b3422f9fb2e158c9dbfb4f0b2ee0"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMTM4MQ==", "bodyText": "Consider adding a metric here.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r424821381", "createdAt": "2020-05-14T01:31:16Z", "author": {"login": "khushbr"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -218,42 +215,39 @@ public synchronized RcaResponse readRca(String rca) {\n \n   private void readSummary(GenericSummary upperLevelSummary, int upperLevelPrimaryKey) {\n     String upperLevelTable = upperLevelSummary.getTableName();\n+    List<Class<? extends GenericSummary>> clazzList = SQLiteQueryUtils.getNestedTableMap().getOrDefault(upperLevelSummary.getClass(), null);\n+\n     // stop the recursion here if the table does not have any nested summary.\n-    if (!SQLiteQueryUtils.getNestedTableMap().containsKey(upperLevelTable)) {\n+    if (clazzList == null) {\n       return;\n     }\n-    String currLevelTable = SQLiteQueryUtils.getNestedTableMap().get(upperLevelTable);\n-    Field<Integer> foreignKeyField = DSL.field(\n-        SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n-    SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n-        .buildSummaryQuery(create, currLevelTable, upperLevelPrimaryKey, foreignKeyField);\n-    try {\n-      Result<Record> recordList = rcaQuery.fetch();\n-      for (Record record : recordList) {\n-        GenericSummary summary = null;\n-        if (upperLevelSummary instanceof RcaResponse) {\n-          summary = HotClusterSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotClusterSummary) {\n-          summary = HotNodeSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotNodeSummary) {\n-          summary = HotResourceSummary.buildSummary(record);\n-        }\n-        else if (upperLevelSummary instanceof HotResourceSummary) {\n-          summary = TopConsumerSummary.buildSummary(record);\n-        }\n-        if (summary != null) {\n-          Field<Integer> primaryKeyField = DSL.field(\n-              SQLiteQueryUtils.getPrimaryKeyColumnName(summary.getTableName()), Integer.class);\n-          readSummary(summary, record.get(primaryKeyField));\n-          upperLevelSummary.addNestedSummaryList(summary);\n+    for (Class<? extends GenericSummary> clazz : clazzList) {\n+      Field<Integer> foreignKeyField = DSL.field(\n+          SQLiteQueryUtils.getPrimaryKeyColumnName(upperLevelTable), Integer.class);\n+      SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils\n+          .buildSummaryQuery(create, clazz.getSimpleName(), upperLevelPrimaryKey, foreignKeyField);\n+      try {\n+        Result<Record> recordList = rcaQuery.fetch();\n+        for (Record record : recordList) {\n+          Method method = clazz.getMethod(\"buildSummary\", Record.class);\n+          GenericSummary summary = (GenericSummary) method.invoke(null, record);\n+          if (summary != null) {\n+            Field<Integer> primaryKeyField = DSL.field(\n+                SQLiteQueryUtils.getPrimaryKeyColumnName(summary.getTableName()), Integer.class);\n+            readSummary(summary, record.get(primaryKeyField));\n+            upperLevelSummary.addNestedSummaryList(summary);\n+          }\n         }\n       }\n-    }\n-    catch (DataAccessException de) {\n-      // it is totally fine if we fail to read some certain tables as some types of summaries might be missing\n-      LOG.warn(\"Fail to read Summary table : {}, query = {},  exceptions : {}\", currLevelTable, rcaQuery.toString(), de.getStackTrace());\n+      catch (DataAccessException de) {\n+        // it is totally fine if we fail to read some certain tables as some types of summaries might be missing\n+        LOG.warn(\"Fail to read Summary table : {}, query = {},  exceptions : {}\",\n+            clazz.getSimpleName(), rcaQuery.toString(), de.getStackTrace());\n+      } catch (Exception e) {\n+        // we might got a reflection issue if running into this. Check the NestedTableMap and make sure\n+        // the summary class has been added.\n+        LOG.error(\"Fail to use reflection to build GenericSummary, trace = {}\", e.getStackTrace());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d4f4ce22fa7b3422f9fb2e158c9dbfb4f0b2ee0"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTI2Mzky", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#pullrequestreview-412126392", "createdAt": "2020-05-14T19:39:21Z", "commit": {"oid": "9d4f4ce22fa7b3422f9fb2e158c9dbfb4f0b2ee0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c2cc593ee20a5063fa2adc79435f562415f8087", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/6c2cc593ee20a5063fa2adc79435f562415f8087", "committedDate": "2020-05-14T19:48:32Z", "message": "Merge remote-tracking branch 'origin' into rguo-1-to-n-summary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04992c9045828493da6bf1771f15f43b96923f2a", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/04992c9045828493da6bf1771f15f43b96923f2a", "committedDate": "2020-05-14T19:54:53Z", "message": "fix conflict"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMjEwNzA2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#pullrequestreview-412210706", "createdAt": "2020-05-14T21:50:22Z", "commit": {"oid": "04992c9045828493da6bf1771f15f43b96923f2a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTo1MDoyMlrOGVvenQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMTo1MDozMlrOGVve8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1MTE2NQ==", "bodyText": "I think the nesting should be internal to each top level summary rather than in the util class.", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r425451165", "createdAt": "2020-05-14T21:50:22Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/util/SQLiteQueryUtils.java", "diffHunk": "@@ -48,24 +48,36 @@\n  * A utility class to query cluster, node and resource level summary for a rca\n  */\n public class SQLiteQueryUtils {\n-  private static final Map<String, String> nestedTableMap;\n+  private static final Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> nestedTableMap;\n   private static final Map<String, String> temperatureProfileNestedSummaryMap;\n   private static final Set<String> clusterLevelRCA;\n   private static final Set<String> temperatureProfileRCASet;\n \n-  // to map table => its nested table\n-  // e.g. HotClusterSummary => HotNodeSummary\n-  static {\n-    Map<String, String> tableMap = new HashMap<>();\n-    tableMap.put(ClusterTemperatureSummary.TABLE_NAME, ClusterDimensionalSummary.TABLE_NAME);\n \n-    tableMap.put(ResourceFlowUnit.RCA_TABLE_NAME, HOT_CLUSTER_SUMMARY_TABLE);\n-    tableMap.put(HOT_CLUSTER_SUMMARY_TABLE, HOT_NODE_SUMMARY_TABLE);\n-    tableMap.put(HOT_NODE_SUMMARY_TABLE, HOT_RESOURCE_SUMMARY_TABLE);\n-    tableMap.put(HOT_RESOURCE_SUMMARY_TABLE, TOP_CONSUMER_SUMMARY_TABLE);\n+  // mapping between table => its nested table\n+  // RCA API query\n+  // |\n+  // RcaResponse -- HotClusterSummary -- HotNodeSummary -- HotResourceSummary -- TopConsumerSummary\n+  //                                                   |\n+  //                                                    -- HotShardSummary\n+  static {\n+    Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> tableMap = new HashMap<>();\n+    tableMap.put(RcaResponse.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotClusterSummary.class)));\n+    tableMap.put(HotClusterSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotNodeSummary.class)));\n+    tableMap.put(HotNodeSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotResourceSummary.class)));\n+    tableMap.put(HotResourceSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        TopConsumerSummary.class)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04992c9045828493da6bf1771f15f43b96923f2a"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1MTI0OQ==", "bodyText": "remove ?", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#discussion_r425451249", "createdAt": "2020-05-14T21:50:32Z", "author": {"login": "yojs"}, "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/util/SQLiteQueryUtils.java", "diffHunk": "@@ -48,24 +48,36 @@\n  * A utility class to query cluster, node and resource level summary for a rca\n  */\n public class SQLiteQueryUtils {\n-  private static final Map<String, String> nestedTableMap;\n+  private static final Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> nestedTableMap;\n   private static final Map<String, String> temperatureProfileNestedSummaryMap;\n   private static final Set<String> clusterLevelRCA;\n   private static final Set<String> temperatureProfileRCASet;\n \n-  // to map table => its nested table\n-  // e.g. HotClusterSummary => HotNodeSummary\n-  static {\n-    Map<String, String> tableMap = new HashMap<>();\n-    tableMap.put(ClusterTemperatureSummary.TABLE_NAME, ClusterDimensionalSummary.TABLE_NAME);\n \n-    tableMap.put(ResourceFlowUnit.RCA_TABLE_NAME, HOT_CLUSTER_SUMMARY_TABLE);\n-    tableMap.put(HOT_CLUSTER_SUMMARY_TABLE, HOT_NODE_SUMMARY_TABLE);\n-    tableMap.put(HOT_NODE_SUMMARY_TABLE, HOT_RESOURCE_SUMMARY_TABLE);\n-    tableMap.put(HOT_RESOURCE_SUMMARY_TABLE, TOP_CONSUMER_SUMMARY_TABLE);\n+  // mapping between table => its nested table\n+  // RCA API query\n+  // |\n+  // RcaResponse -- HotClusterSummary -- HotNodeSummary -- HotResourceSummary -- TopConsumerSummary\n+  //                                                   |\n+  //                                                    -- HotShardSummary\n+  static {\n+    Map<Class<? extends GenericSummary>, List<Class<? extends GenericSummary>>> tableMap = new HashMap<>();\n+    tableMap.put(RcaResponse.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotClusterSummary.class)));\n+    tableMap.put(HotClusterSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotNodeSummary.class)));\n+    tableMap.put(HotNodeSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        HotResourceSummary.class)));\n+    tableMap.put(HotResourceSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        TopConsumerSummary.class)));\n+\n+    //temperature profiling mapping\n+    tableMap.put(ClusterTemperatureSummary.class, Collections.unmodifiableList(Collections.singletonList(\n+        ClusterDimensionalSummary.class)));\n     nestedTableMap = Collections.unmodifiableMap(tableMap);\n   }\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04992c9045828493da6bf1771f15f43b96923f2a"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52a5fccd0c143eca324648ed6ffdff1924ea1c9d", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/52a5fccd0c143eca324648ed6ffdff1924ea1c9d", "committedDate": "2020-05-15T00:05:01Z", "message": "address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3043d06a23420cafce4e868929464ab722f375cc", "author": {"user": {"login": "rguo-aws", "name": "Ruizhen Guo"}}, "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3043d06a23420cafce4e868929464ab722f375cc", "committedDate": "2020-05-20T20:34:18Z", "message": "Remove reflection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NzM1ODY0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/192#pullrequestreview-415735864", "createdAt": "2020-05-20T21:42:49Z", "commit": {"oid": "3043d06a23420cafce4e868929464ab722f375cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1001, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}