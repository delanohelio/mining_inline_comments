{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MjEyMDM1", "number": 367, "title": "Publish Kernel zip and update initial setup steps", "bodyText": "Issue #, if available:\nDescription of changes:\n\nUpdate easysetup\n\nAdd opt-out option to set up system service\nImplement systemd service setup\nEasysetup calls KernelAlts to set up root/alts/current explicitly, with assumptions on the initial launching path. Unit and integration tests are not impacted.\n\n\nPreparation for UAT\n\nUpload Kernel zip to S3\nExtend loader script to stay running unless error so that UAT can run loader script directly without setting up system service\n\n\n\nWhy is this change necessary:\nHow was this change tested:\nManually tested easysetup on Ubuntu instance\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-08-14T22:42:42Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367", "merged": true, "mergeCommit": {"oid": "a47ef9cca46ba88d9ebb442c9af4c39d09085d67"}, "closed": true, "closedAt": "2020-08-25T01:48:34Z", "author": {"login": "hui-yang"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_6L6agBqjM2NjM4NDMxNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCNMEfAFqTQ3NDAzNzQ2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0dba2d8218259ffa213a0f6cfb09940dffd034f", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b0dba2d8218259ffa213a0f6cfb09940dffd034f", "committedDate": "2020-08-14T22:34:23Z", "message": "Publish Kernel zip and update initial setup steps"}, "afterCommit": {"oid": "264fc933d2b81035955bdddc8764ea3995800cef", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/264fc933d2b81035955bdddc8764ea3995800cef", "committedDate": "2020-08-17T22:29:06Z", "message": "Publish Kernel zip and update initial setup steps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "264fc933d2b81035955bdddc8764ea3995800cef", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/264fc933d2b81035955bdddc8764ea3995800cef", "committedDate": "2020-08-17T22:29:06Z", "message": "Publish Kernel zip and update initial setup steps"}, "afterCommit": {"oid": "d72283d03050758d454c5717396f9aac1dc4144c", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d72283d03050758d454c5717396f9aac1dc4144c", "committedDate": "2020-08-17T23:21:28Z", "message": "Publish Kernel zip and update initial setup steps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d72283d03050758d454c5717396f9aac1dc4144c", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d72283d03050758d454c5717396f9aac1dc4144c", "committedDate": "2020-08-17T23:21:28Z", "message": "Publish Kernel zip and update initial setup steps"}, "afterCommit": {"oid": "96f69f7cc6bf00448afb078ca7d822ec4114d39f", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/96f69f7cc6bf00448afb078ca7d822ec4114d39f", "committedDate": "2020-08-18T00:41:20Z", "message": "Publish Kernel zip and update initial setup steps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ace9c4431db9ac20a632dc82112f1ba6aca16b92", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ace9c4431db9ac20a632dc82112f1ba6aca16b92", "committedDate": "2020-08-18T01:11:27Z", "message": "Publish Kernel zip and update initial setup steps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96f69f7cc6bf00448afb078ca7d822ec4114d39f", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/96f69f7cc6bf00448afb078ca7d822ec4114d39f", "committedDate": "2020-08-18T00:41:20Z", "message": "Publish Kernel zip and update initial setup steps"}, "afterCommit": {"oid": "ace9c4431db9ac20a632dc82112f1ba6aca16b92", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ace9c4431db9ac20a632dc82112f1ba6aca16b92", "committedDate": "2020-08-18T01:11:27Z", "message": "Publish Kernel zip and update initial setup steps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb1375c722921e4d4f4f84223a803ff2888f95a0", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cb1375c722921e4d4f4f84223a803ff2888f95a0", "committedDate": "2020-08-18T17:35:29Z", "message": "Merge branch 'master' into ku12"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NzAyNjEw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#pullrequestreview-469702610", "createdAt": "2020-08-18T18:06:59Z", "commit": {"oid": "cb1375c722921e4d4f4f84223a803ff2888f95a0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODowNjo1OVrOHCgJGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxODowOTowN1rOHCgNuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4NTgxNw==", "bodyText": "Why cp instead of jar? The jar we build can be run directly.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r472385817", "createdAt": "2020-08-18T18:06:59Z", "author": {"login": "MikeDombo"}, "path": "scripts/loader", "diffHunk": "@@ -13,64 +11,61 @@ LAUNCH_DIR=\"$GG_ROOT/alts/current\"\n CONFIG_FILE=\"\"\n \n launch_kernel() {\n-  if [[ ! -d ${LAUNCH_DIR} ]] ; then\n+  if [ ! -d ${LAUNCH_DIR} ] ; then\n     echo FATAL: No Kernel found!\n     exit 1\n   fi\n \n-  JVM_OPTIONS=$(cat \"$LAUNCH_DIR/launch.params\")\n+  if [ -f \"${LAUNCH_DIR}/launch.params\" ] ; then\n+    JVM_OPTIONS=$(cat \"$LAUNCH_DIR/launch.params\")\n+  fi\n \n   OPTIONS=\"--root $GG_ROOT\"\n-  if [[ ! -z ${CONFIG_FILE} ]]; then\n+  if [ ! -z ${CONFIG_FILE} ]; then\n     OPTIONS=\"$OPTIONS --config $CONFIG_FILE\"\n   fi\n   echo \"jvm options: \"${JVM_OPTIONS}\n   echo \"kernel options: \"${OPTIONS}\n-  java ${JVM_OPTIONS} -cp \"$LAUNCH_DIR/distro/lib/*\" com.aws.iot.evergreen.kernel.KernelCommandLine ${OPTIONS}\n+  java ${JVM_OPTIONS} -Dlog.store=FILE -Dlog.storeName=\"$GG_ROOT/logs/evergreen.log\" -cp \"$LAUNCH_DIR/distro/lib/*\" com.aws.iot.evergreen.kernel.KernelCommandLine ${OPTIONS}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb1375c722921e4d4f4f84223a803ff2888f95a0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4NzAwMQ==", "bodyText": "also needs TES related parameters right? Since TES isn't optional for cloud connection", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r472387001", "createdAt": "2020-08-18T18:09:07Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/README.md", "diffHunk": "@@ -33,3 +33,16 @@ OPTIONS\n \t--install-cli, -ic \t\tY/N Indicate if you want to install Evergreen device CLI. {}\n ```\n \n+## Set up steps with Greengrass zip file\n+This workflow has been implemented for Ubuntu. Use as a reference.\n+```\n+# Move GreengrassCore-2.0.0.zip to test device\n+# Set up aws creds\n+unzip GreengrassCore-2.0.0.zip -d GreengrassCore\n+java -Droot=~/gg_home -Dlog.level=ERROR -jar ./GreengrassCore/lib/Evergreen.jar --provision true --aws-region us-east-1 --thing-name test-device", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb1375c722921e4d4f4f84223a803ff2888f95a0"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b52d85759eebb1fe77bc470489df4bf7dd59c21f", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b52d85759eebb1fe77bc470489df4bf7dd59c21f", "committedDate": "2020-08-18T20:18:13Z", "message": "Merge branch 'master' into ku12"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e34406dbae67c9c1469d4751d4545c184e8b7180", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e34406dbae67c9c1469d4751d4545c184e8b7180", "committedDate": "2020-08-19T17:45:36Z", "message": "Merge branch 'master' into ku12"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODAwMTUx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#pullrequestreview-471800151", "createdAt": "2020-08-20T16:40:58Z", "commit": {"oid": "e34406dbae67c9c1469d4751d4545c184e8b7180"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNjo0MDo1OFrOHEKQkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzowMTo0NlrOHELOyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEyNDQzNQ==", "bodyText": "Why is jar name not deterministic?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r474124435", "createdAt": "2020-08-20T16:40:58Z", "author": {"login": "leaf94"}, "path": "scripts/loader", "diffHunk": "@@ -13,64 +11,61 @@ LAUNCH_DIR=\"$GG_ROOT/alts/current\"\n CONFIG_FILE=\"\"\n \n launch_kernel() {\n-  if [[ ! -d ${LAUNCH_DIR} ]] ; then\n+  if [ ! -d ${LAUNCH_DIR} ] ; then\n     echo FATAL: No Kernel found!\n     exit 1\n   fi\n \n-  JVM_OPTIONS=$(cat \"$LAUNCH_DIR/launch.params\")\n+  if [ -f \"${LAUNCH_DIR}/launch.params\" ] ; then\n+    JVM_OPTIONS=$(cat \"$LAUNCH_DIR/launch.params\")\n+  fi\n \n   OPTIONS=\"--root $GG_ROOT\"\n-  if [[ ! -z ${CONFIG_FILE} ]]; then\n+  if [ ! -z ${CONFIG_FILE} ]; then\n     OPTIONS=\"$OPTIONS --config $CONFIG_FILE\"\n   fi\n   echo \"jvm options: \"${JVM_OPTIONS}\n   echo \"kernel options: \"${OPTIONS}\n-  java ${JVM_OPTIONS} -cp \"$LAUNCH_DIR/distro/lib/*\" com.aws.iot.evergreen.kernel.KernelCommandLine ${OPTIONS}\n+  java ${JVM_OPTIONS} -Dlog.store=FILE -Dlog.storeName=\"$GG_ROOT/logs/evergreen.log\" -cp \"$LAUNCH_DIR/distro/lib/*\" com.aws.iot.evergreen.kernel.KernelCommandLine ${OPTIONS}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4NTgxNw=="}, "originalCommit": {"oid": "cb1375c722921e4d4f4f84223a803ff2888f95a0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzOTcxOA==", "bodyText": "This might be able to be entirely moved to Kernel::parseArgs", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r474139718", "createdAt": "2020-08-20T17:00:37Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java", "diffHunk": "@@ -93,7 +89,7 @@ public void launch() {\n         startupAllServices();\n     }\n \n-    private void initConfigAndTlog() {\n+    void initConfigAndTlog() {\n         Path transactionLogPath = kernel.getConfigPath().resolve(\"config.tlog\");\n         Path configurationFile = kernel.getConfigPath().resolve(\"config.yaml\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34406dbae67c9c1469d4751d4545c184e8b7180"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0MDM2MQ==", "bodyText": "Nice... Now the provision override drawback is also eliminated. I will update the README after you merge this in. Please remind me afterwards~", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r474140361", "createdAt": "2020-08-20T17:01:46Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -499,8 +501,17 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n         return rootPackageNameAndVersionMap;\n     }\n \n+    /**\n+     * Parse kernel arguments and initialized configuration.\n+     *\n+     * @param args CLI args\n+     * @return Kernel instance\n+     */\n     public Kernel parseArgs(String... args) {\n         kernelCommandLine.parseArgs(args);\n+\n+        config.lookupTopics(SERVICES_NAMESPACE_TOPIC, MAIN_SERVICE_NAME, SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n+        kernelLifecycle.initConfigAndTlog();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e34406dbae67c9c1469d4751d4545c184e8b7180"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a003428cf1b60cb58473324f8a0bb2fbd6a24fed", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a003428cf1b60cb58473324f8a0bb2fbd6a24fed", "committedDate": "2020-08-24T17:02:43Z", "message": "Merge remote-tracking branch 'origin/master' into ku12"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "924bea326025de95240b2275ac25855ef7b70bbc", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/924bea326025de95240b2275ac25855ef7b70bbc", "committedDate": "2020-08-24T17:26:55Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b172bb2a4b74fa73a948f3e3689dd54765106007", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b172bb2a4b74fa73a948f3e3689dd54765106007", "committedDate": "2020-08-24T17:15:33Z", "message": "Address comments"}, "afterCommit": {"oid": "924bea326025de95240b2275ac25855ef7b70bbc", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/924bea326025de95240b2275ac25855ef7b70bbc", "committedDate": "2020-08-24T17:26:55Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNzE1MjAz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#pullrequestreview-473715203", "createdAt": "2020-08-24T17:34:30Z", "commit": {"oid": "924bea326025de95240b2275ac25855ef7b70bbc"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNzozNDozMFrOHFvdTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNzozNzowNFrOHFvi6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4MjQ3Ng==", "bodyText": "why is this a separate platform? Systemd isn't a platform, but something which can be installed on multiple different platforms.\nI'd probably have a separate inheritance hierarchy for this feature set. It can still be accessible through the platform instance, but it shouldn't be in the same hierarchy.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r475782476", "createdAt": "2020-08-24T17:34:30Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/util/platforms/Platform.java", "diffHunk": "@@ -27,17 +34,44 @@ public static synchronized Platform getInstance() {\n             INSTANCE = new WindowsPlatform();\n         } else if (PlatformResolver.RANKS.get().containsKey(\"qnx\")) {\n             INSTANCE = new QNXPlatform();\n+        } else if (SystemServiceManager.SYSTEMD.equals(getSystemServiceManager())) {\n+            INSTANCE = new SystemdUnixPlatform();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924bea326025de95240b2275ac25855ef7b70bbc"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4MzU5OQ==", "bodyText": "use shellrunner?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r475783599", "createdAt": "2020-08-24T17:36:30Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/util/platforms/SystemdUnixPlatform.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.util.platforms;\n+\n+import com.aws.iot.evergreen.kernel.KernelAlternatives;\n+import com.aws.iot.evergreen.util.Exec;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+\n+public class SystemdUnixPlatform extends UnixPlatform {\n+    private static final String PID_FILE_PARAM = \"REPLACE_WITH_GG_LOADER_PID_FILE\";\n+    private static final String LOADER_FILE_PARAM = \"REPLACE_WITH_GG_LOADER_FILE\";\n+    private static final String SERVICE_CONFIG_FILE_PATH = \"/etc/systemd/system/greengrass.service\";\n+    private static final String SED_CMD = \"sed -i -e \\\"s#%s#%s#g\\\" %s\";\n+\n+    @Override\n+    public boolean setupSystemService(KernelAlternatives kernelAlternatives) {\n+        try {\n+            kernelAlternatives.setupInitLaunchDirIfAbsent();\n+            Path serviceConfig = kernelAlternatives.getServiceTemplatePath();\n+            runCommand(String.format(SED_CMD, PID_FILE_PARAM, kernelAlternatives.getLoaderPidPath(), serviceConfig));\n+            runCommand(String.format(SED_CMD, LOADER_FILE_PARAM, kernelAlternatives.getLoaderPath(), serviceConfig));\n+            runCommand(String.format(\"sudo cp %s %s\", serviceConfig, SERVICE_CONFIG_FILE_PATH));\n+            runCommand(\"sudo systemctl daemon-reload\");\n+            runCommand(\"sudo systemctl unmask greengrass.service\");\n+            runCommand(\"sudo systemctl start greengrass.service\");\n+            runCommand(\"sudo systemctl enable greengrass.service\");\n+            logger.atInfo().log(\"Successfully set up systemd service\");\n+            return true;\n+        } catch (IOException | InterruptedException | URISyntaxException e) {\n+            logger.atError().log(\"Failed to set up systemd service\", e);\n+        }\n+        return false;\n+    }\n+\n+    private boolean runCommand(String command) throws IOException, InterruptedException {\n+        return new Exec()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924bea326025de95240b2275ac25855ef7b70bbc"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc4MzkxNA==", "bodyText": "can we put this into an afterEach so it can't be forgotten?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r475783914", "createdAt": "2020-08-24T17:37:04Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelperTest.java", "diffHunk": "@@ -192,6 +193,7 @@ public void GIVEN_test_tes_role_config_WHEN_role_info_provided_THEN_add_config_t\n         assertEquals(\"roleAliasName\", kernel.getConfig()\n                 .lookup(SERVICES_NAMESPACE_TOPIC, TOKEN_EXCHANGE_SERVICE_TOPICS, PARAMETERS_CONFIG_KEY,\n                         IOT_ROLE_ALIAS_TOPIC).getOnce());\n+        kernel.shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924bea326025de95240b2275ac25855ef7b70bbc"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cfee17c35eaeaf430dcb828eef2ed3aed0aaf7b", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1cfee17c35eaeaf430dcb828eef2ed3aed0aaf7b", "committedDate": "2020-08-24T21:16:05Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a3dcfbf85860a95ee278ca9d2f3d3224bcdc868", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a3dcfbf85860a95ee278ca9d2f3d3224bcdc868", "committedDate": "2020-08-24T21:17:00Z", "message": "Merge remote-tracking branch 'origin/master' into ku12"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczODY5Mzg1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#pullrequestreview-473869385", "createdAt": "2020-08-24T21:28:06Z", "commit": {"oid": "1a3dcfbf85860a95ee278ca9d2f3d3224bcdc868"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMToyODowNlrOHF265Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMToyODowNlrOHF265Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkwNDc0MQ==", "bodyText": "why are these running as sudo? Won't the kernel be running as root at this point? Systems may not have sudo, or won't be configured with passwordless sudo, so I'd maybe just make it a requirement that GG is running as root for this feature.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r475904741", "createdAt": "2020-08-24T21:28:06Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/util/orchestration/SystemdUtils.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.util.orchestration;\n+\n+import com.aws.iot.evergreen.kernel.KernelAlternatives;\n+import com.aws.iot.evergreen.util.Exec;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+\n+public class SystemdUtils extends SystemServiceUtils {\n+    private static final String PID_FILE_PARAM = \"REPLACE_WITH_GG_LOADER_PID_FILE\";\n+    private static final String LOADER_FILE_PARAM = \"REPLACE_WITH_GG_LOADER_FILE\";\n+    private static final String SERVICE_CONFIG_FILE_PATH = \"/etc/systemd/system/greengrass.service\";\n+    private static final String SED_CMD = \"sed -i -e \\\"s#%s#%s#g\\\" %s\";\n+\n+    @Override\n+    public boolean setupSystemService(KernelAlternatives kernelAlternatives) {\n+        try {\n+            kernelAlternatives.setupInitLaunchDirIfAbsent();\n+            Path serviceConfig = kernelAlternatives.getServiceTemplatePath();\n+            runCommand(String.format(SED_CMD, PID_FILE_PARAM, kernelAlternatives.getLoaderPidPath(), serviceConfig));\n+            runCommand(String.format(SED_CMD, LOADER_FILE_PARAM, kernelAlternatives.getLoaderPath(), serviceConfig));\n+            runCommand(String.format(\"sudo cp %s %s\", serviceConfig, SERVICE_CONFIG_FILE_PATH));\n+            runCommand(\"sudo systemctl daemon-reload\");\n+            runCommand(\"sudo systemctl unmask greengrass.service\");\n+            runCommand(\"sudo systemctl start greengrass.service\");\n+            runCommand(\"sudo systemctl enable greengrass.service\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a3dcfbf85860a95ee278ca9d2f3d3224bcdc868"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczODY5NTIw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#pullrequestreview-473869520", "createdAt": "2020-08-24T21:28:22Z", "commit": {"oid": "1a3dcfbf85860a95ee278ca9d2f3d3224bcdc868"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMToyODoyMlrOHF27Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMToyODoyMlrOHF27Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkwNDg0Ng==", "bodyText": "unused?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r475904846", "createdAt": "2020-08-24T21:28:22Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/util/platforms/Platform.java", "diffHunk": "@@ -6,11 +6,14 @@\n package com.aws.iot.evergreen.util.platforms;\n \n import com.aws.iot.evergreen.config.PlatformResolver;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.util.Exec;\n \n import java.io.IOException;\n \n public abstract class Platform {\n+    protected static final Logger logger = LogManager.getLogger(Platform.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a3dcfbf85860a95ee278ca9d2f3d3224bcdc868"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczODcwMDUy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#pullrequestreview-473870052", "createdAt": "2020-08-24T21:29:14Z", "commit": {"oid": "1a3dcfbf85860a95ee278ca9d2f3d3224bcdc868"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMToyOToxNFrOHF287Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMToyOToxNFrOHF287Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkwNTI2MQ==", "bodyText": "this is the test change, where's the source change?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r475905261", "createdAt": "2020-08-24T21:29:14Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/easysetup/EvergreenSetupTest.java", "diffHunk": "@@ -56,7 +55,6 @@ void GIVEN_setup_script_WHEN_script_is_used_with_short_arg_notations_THEN_setup_\n         verify(deviceProvisioningHelper, times(1)).updateKernelConfigWithIotConfiguration(any(), any(), any());\n         verify(deviceProvisioningHelper, times(1)).setupIoTRoleForTes(any(), any(), any());\n         verify(deviceProvisioningHelper, times(1)).updateKernelConfigWithTesRoleInfo(any(), any());\n-        verify(deviceProvisioningHelper, times(1)).setUpEmptyPackagesForFirstPartyServices();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a3dcfbf85860a95ee278ca9d2f3d3224bcdc868"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c240453ea771698461860dd210508174115f6c66", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c240453ea771698461860dd210508174115f6c66", "committedDate": "2020-08-24T21:53:03Z", "message": "Address comments on sudo commands and clean up method which creates empty components"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczODgzMTk3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#pullrequestreview-473883197", "createdAt": "2020-08-24T21:53:26Z", "commit": {"oid": "1a3dcfbf85860a95ee278ca9d2f3d3224bcdc868"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94b3110042abc9daa4e5a743ad3f922faab05022", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/94b3110042abc9daa4e5a743ad3f922faab05022", "committedDate": "2020-08-24T23:45:36Z", "message": "Merge remote-tracking branch 'origin/master' into ku12"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80a879019e0539067fc07371fbba8d5b41932709", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/80a879019e0539067fc07371fbba8d5b41932709", "committedDate": "2020-08-24T23:58:38Z", "message": "Update .gitignore and github jobs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "946c19afe9b12bdd4bc0e9104d965a88c9e568ff", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/946c19afe9b12bdd4bc0e9104d965a88c9e568ff", "committedDate": "2020-08-25T00:57:47Z", "message": "Address comments to refactor system service utils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MDI1MDMy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#pullrequestreview-474025032", "createdAt": "2020-08-25T01:05:35Z", "commit": {"oid": "946c19afe9b12bdd4bc0e9104d965a88c9e568ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MDI2MDE4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#pullrequestreview-474026018", "createdAt": "2020-08-25T01:09:02Z", "commit": {"oid": "946c19afe9b12bdd4bc0e9104d965a88c9e568ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMTowOTowMlrOHF-U6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwMTowOTowMlrOHF-U6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyNjA4OQ==", "bodyText": "why are we using sed? Let's use java", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#discussion_r476026089", "createdAt": "2020-08-25T01:09:02Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/util/orchestration/SystemdUtils.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.util.orchestration;\n+\n+import com.aws.iot.evergreen.kernel.KernelAlternatives;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Exec;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+\n+public class SystemdUtils implements SystemServiceUtils {\n+    protected static final Logger logger = LogManager.getLogger(SystemdUtils.class);\n+    private static final String PID_FILE_PARAM = \"REPLACE_WITH_GG_LOADER_PID_FILE\";\n+    private static final String LOADER_FILE_PARAM = \"REPLACE_WITH_GG_LOADER_FILE\";\n+    private static final String SERVICE_CONFIG_FILE_PATH = \"/etc/systemd/system/greengrass.service\";\n+    private static final String SED_CMD = \"sed -i -e \\\"s#%s#%s#g\\\" %s\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "946c19afe9b12bdd4bc0e9104d965a88c9e568ff"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MDM3NDY5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/367#pullrequestreview-474037469", "createdAt": "2020-08-25T01:47:02Z", "commit": {"oid": "946c19afe9b12bdd4bc0e9104d965a88c9e568ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2087, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}