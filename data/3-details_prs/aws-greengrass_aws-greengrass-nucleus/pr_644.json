{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3OTYwMDk3", "number": 644, "title": "support Node type change in merge configuration Topics", "bodyText": "Currently nodeTypeChanged is effectively same as 'removed'. Subscribers need to resubscribe to the new Node.\nThis is due to the different Watcher interface between Subscriber and ChildChanged.\nIssue #, if available:\nDescription of changes:\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-09T18:37:23Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644", "merged": true, "mergeCommit": {"oid": "94e47d6ed98a784cb6976b9d2f48ae7c59e6c248"}, "closed": true, "closedAt": "2020-11-10T22:51:26Z", "author": {"login": "ShirleyZheng92"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda5TsdAFqTUyNjU0Mzk2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbRDm3gFqTUyNzY1Nzc5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTQzOTYx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-526543961", "createdAt": "2020-11-09T18:40:06Z", "commit": {"oid": "71f82c3fc6ba33af99a8bf9a3b19df3e7488398b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODo0MDowN1rOHv8UAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODo0NToxOFrOHv8gBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzMzI4MQ==", "bodyText": "why is the value null? Why wouldn't this save the new value?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520033281", "createdAt": "2020-11-09T18:40:07Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/config/ConfigurationWriter.java", "diffHunk": "@@ -152,6 +152,8 @@ public synchronized void childChanged(WhatHappened what, Node n) {\n             tlogline = new Tlogline(t.getModtime(), t.path(), WhatHappened.changed, t.getOnce());\n         } else if (what == WhatHappened.childRemoved) {\n             tlogline = new Tlogline(n.getModtime(), n.path(), WhatHappened.removed, null);\n+        } else if (what == WhatHappened.nodeTypeChanged) {\n+            tlogline = new Tlogline(n.getModtime(), n.path(), WhatHappened.nodeTypeChanged, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71f82c3fc6ba33af99a8bf9a3b19df3e7488398b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNDc0Nw==", "bodyText": "without your change, does this test fail with the error that nodes cannot change type?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520034747", "createdAt": "2020-11-09T18:42:34Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/greengrass/config/ConfigurationTest.java", "diffHunk": "@@ -637,6 +637,101 @@ void GIVEN_config_update_WHEN_merge_update_interleave_THEN_expect_merge_correct(\n         assertEquals(now, config.findNode(\"nodeToBeMerged\", \"key3\").modtime);\n     }\n \n+\n+    @Test\n+    void GIVEN_config_update_WHEN_node_type_change_THEN_expect_merge_correct() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71f82c3fc6ba33af99a8bf9a3b19df3e7488398b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNTgxNg==", "bodyText": "The what here is only from childChanged so if your child changed doesn't propagate this what type, then this is useless.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520035816", "createdAt": "2020-11-09T18:44:26Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/config/ConfigurationWriter.java", "diffHunk": "@@ -152,6 +152,8 @@ public synchronized void childChanged(WhatHappened what, Node n) {\n             tlogline = new Tlogline(t.getModtime(), t.path(), WhatHappened.changed, t.getOnce());\n         } else if (what == WhatHappened.childRemoved) {\n             tlogline = new Tlogline(n.getModtime(), n.path(), WhatHappened.removed, null);\n+        } else if (what == WhatHappened.nodeTypeChanged) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71f82c3fc6ba33af99a8bf9a3b19df3e7488398b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAzNjM1OA==", "bodyText": "Why do we need a new type? You were modeling this before as a remove and then an add, so what does this type do differently when it seems that you're just removing it on L77.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520036358", "createdAt": "2020-11-09T18:45:18Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/config/ConfigurationReader.java", "diffHunk": "@@ -62,6 +62,19 @@ public static void mergeTLogInto(Configuration config, Reader reader, boolean fo\n                         } else {\n                             n.remove(tlogline.timestamp);\n                         }\n+                    } else if (WhatHappened.nodeTypeChanged.equals(tlogline.action)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71f82c3fc6ba33af99a8bf9a3b19df3e7488398b"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "71f82c3fc6ba33af99a8bf9a3b19df3e7488398b", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/71f82c3fc6ba33af99a8bf9a3b19df3e7488398b", "committedDate": "2020-11-09T18:34:43Z", "message": "Add NodeTypeChange in configuration WhatHappened event\n\nCurrently nodeTypeChanged is effectively same as 'removed'. Subscribers need to resubscribe to the new Node.\nThis is due to the different Watcher interface between Subscriber and ChildChanged."}, "afterCommit": {"oid": "6cb6974ccb512030a8416319919f93a4144a19e4", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6cb6974ccb512030a8416319919f93a4144a19e4", "committedDate": "2020-11-09T20:41:40Z", "message": "Support node type change in merge topics\n\nSupport node type change in merge topics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjM4ODYw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-526638860", "createdAt": "2020-11-09T20:44:09Z", "commit": {"oid": "6cb6974ccb512030a8416319919f93a4144a19e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Njc1Njcy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-526675672", "createdAt": "2020-11-09T21:39:17Z", "commit": {"oid": "d67a1be0293fa0521d6cf4545c932805bb67a9f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTozOToxN1rOHwCpdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTozOToxN1rOHwCpdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzNzA3OA==", "bodyText": "Since this branch is removed, the original mergeChild code path will go to line 311-314. Is that the correct behavior? Should mergeChild also remove the previous child (line311)?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520137078", "createdAt": "2020-11-09T21:39:17Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -281,28 +281,6 @@ private void updateChild(CaseInsensitiveString key, Object value,\n             childMergeBehavior = mergeBehavior;\n         }\n \n-        switch (childMergeBehavior.getDefaultBehavior()) {\n-            case MERGE:\n-                mergeChild(key, value, childMergeBehavior);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d67a1be0293fa0521d6cf4545c932805bb67a9f4"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjkwODc3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-526690877", "createdAt": "2020-11-09T22:02:37Z", "commit": {"oid": "d67a1be0293fa0521d6cf4545c932805bb67a9f4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Njk5NTc5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-526699579", "createdAt": "2020-11-09T22:17:01Z", "commit": {"oid": "d67a1be0293fa0521d6cf4545c932805bb67a9f4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d67a1be0293fa0521d6cf4545c932805bb67a9f4", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d67a1be0293fa0521d6cf4545c932805bb67a9f4", "committedDate": "2020-11-09T21:08:58Z", "message": "Merge branch 'master' into nodeTypeChange"}, "afterCommit": {"oid": "2df740880ec08e3fab0ee8a1b03c8ebaf848268e", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2df740880ec08e3fab0ee8a1b03c8ebaf848268e", "committedDate": "2020-11-09T22:55:14Z", "message": "Add documentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODExNjY2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-526811666", "createdAt": "2020-11-10T02:44:55Z", "commit": {"oid": "2df740880ec08e3fab0ee8a1b03c8ebaf848268e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTUyMDk2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-527552096", "createdAt": "2020-11-10T19:47:29Z", "commit": {"oid": "77ced0918c8d6cd698c9f7159041864b97c487ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOTo0NzoyOVrOHwtBtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOTo0NzoyOVrOHwtBtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzMTQxNA==", "bodyText": "why? If you're adding an interior node, then we want that event!", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520831414", "createdAt": "2020-11-10T19:47:29Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -281,43 +281,55 @@ private void updateChild(CaseInsensitiveString key, Object value,\n             childMergeBehavior = mergeBehavior;\n         }\n \n-        switch (childMergeBehavior.getDefaultBehavior()) {\n-            case MERGE:\n-                mergeChild(key, value, childMergeBehavior);\n-                break;\n-            case REPLACE:\n-                replaceChild(key, value, childMergeBehavior);\n-                break;\n-            default:\n-        }\n-    }\n-\n-    private void mergeChild(CaseInsensitiveString key, Object value,\n-                            @NonNull UpdateBehaviorTree mergeBehavior) {\n-        if (value instanceof Map) {\n-            createInteriorChild(key).updateFromMap((Map) value, mergeBehavior);\n-        } else {\n-            createLeafChild(key).withNewerValue(mergeBehavior.getTimestampToUse(), value, false, true);\n-        }\n-    }\n-\n-    private void replaceChild(CaseInsensitiveString key, Object value,\n-                              @Nonnull UpdateBehaviorTree childMergeBehavior) {\n         Node existingChild = children.get(key);\n         // if new node is a container node\n         if (value instanceof Map) {\n-            // if existing child is a leaf node\n-            if (existingChild != null && !(existingChild instanceof Topics)) {\n-                remove(existingChild);\n+            // if existing child is a container node\n+            if (existingChild == null || existingChild instanceof Topics) {\n+                createInteriorChild(key).updateFromMap((Map) value, childMergeBehavior);\n+            } else {\n+                // not calling remove() to avoid WhatHappened.removed event\n+                if (!children.remove(new CaseInsensitiveString(existingChild.getName()), existingChild)) {\n+                    logger.atError(\"config-node-child-remove-error\").kv(\"thisNode\", toString())\n+                            .kv(\"childNode\", existingChild.getName())\n+                            .log();\n+                    return;\n+                }\n+                context.runOnPublishQueue(() -> {\n+                    this.childChanged(WhatHappened.childRemoved, existingChild);\n+                });\n+                // not calling createInteriorChild() to avoid WhatHappened.interiorAdded event", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77ced0918c8d6cd698c9f7159041864b97c487ee"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTU0MTQw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-527554140", "createdAt": "2020-11-10T19:50:16Z", "commit": {"oid": "77ced0918c8d6cd698c9f7159041864b97c487ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOTo1MDoxNlrOHwtIVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOTo1MDoxNlrOHwtIVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgzMzEwOA==", "bodyText": "I don't understand why this logic just got so much more complicated than yesterday. Why so many changes to just copy over the watchers list?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520833108", "createdAt": "2020-11-10T19:50:16Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -281,43 +281,55 @@ private void updateChild(CaseInsensitiveString key, Object value,\n             childMergeBehavior = mergeBehavior;\n         }\n \n-        switch (childMergeBehavior.getDefaultBehavior()) {\n-            case MERGE:\n-                mergeChild(key, value, childMergeBehavior);\n-                break;\n-            case REPLACE:\n-                replaceChild(key, value, childMergeBehavior);\n-                break;\n-            default:\n-        }\n-    }\n-\n-    private void mergeChild(CaseInsensitiveString key, Object value,\n-                            @NonNull UpdateBehaviorTree mergeBehavior) {\n-        if (value instanceof Map) {\n-            createInteriorChild(key).updateFromMap((Map) value, mergeBehavior);\n-        } else {\n-            createLeafChild(key).withNewerValue(mergeBehavior.getTimestampToUse(), value, false, true);\n-        }\n-    }\n-\n-    private void replaceChild(CaseInsensitiveString key, Object value,\n-                              @Nonnull UpdateBehaviorTree childMergeBehavior) {\n         Node existingChild = children.get(key);\n         // if new node is a container node\n         if (value instanceof Map) {\n-            // if existing child is a leaf node\n-            if (existingChild != null && !(existingChild instanceof Topics)) {\n-                remove(existingChild);\n+            // if existing child is a container node", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77ced0918c8d6cd698c9f7159041864b97c487ee"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "77ced0918c8d6cd698c9f7159041864b97c487ee", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77ced0918c8d6cd698c9f7159041864b97c487ee", "committedDate": "2020-11-10T19:38:57Z", "message": "Address comments. Copy subscribers over to new node"}, "afterCommit": {"oid": "5c8c721afe1c6931a529ca92a6bae2b348a2eaf0", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5c8c721afe1c6931a529ca92a6bae2b348a2eaf0", "committedDate": "2020-11-10T20:18:07Z", "message": "Address comments. Copy subscribers over to new node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14204761b517722de38b3ca3e10e03f30e112b11", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/14204761b517722de38b3ca3e10e03f30e112b11", "committedDate": "2020-11-10T20:27:28Z", "message": "Support node type change in merge topics\n\nSupport node type change in merge topics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce3aa87da3a8a8ce9edc2addff2cefd4beb3acf0", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ce3aa87da3a8a8ce9edc2addff2cefd4beb3acf0", "committedDate": "2020-11-10T20:27:28Z", "message": "Add documentation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c8c721afe1c6931a529ca92a6bae2b348a2eaf0", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5c8c721afe1c6931a529ca92a6bae2b348a2eaf0", "committedDate": "2020-11-10T20:18:07Z", "message": "Address comments. Copy subscribers over to new node"}, "afterCommit": {"oid": "26869275513fbe64d83d3ca495ce9dca04be0f57", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/26869275513fbe64d83d3ca495ce9dca04be0f57", "committedDate": "2020-11-10T20:32:29Z", "message": "Address comments. Copy subscribers over to new node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6818262f066c56b25929d369ba87be5df363c1b7", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6818262f066c56b25929d369ba87be5df363c1b7", "committedDate": "2020-11-10T20:41:02Z", "message": "Address comments. Copy subscribers over to new node"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26869275513fbe64d83d3ca495ce9dca04be0f57", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/26869275513fbe64d83d3ca495ce9dca04be0f57", "committedDate": "2020-11-10T20:32:29Z", "message": "Address comments. Copy subscribers over to new node"}, "afterCommit": {"oid": "6818262f066c56b25929d369ba87be5df363c1b7", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6818262f066c56b25929d369ba87be5df363c1b7", "committedDate": "2020-11-10T20:41:02Z", "message": "Address comments. Copy subscribers over to new node"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjE2ODk2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-527616896", "createdAt": "2020-11-10T21:21:19Z", "commit": {"oid": "6818262f066c56b25929d369ba87be5df363c1b7"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMToyMToxOVrOHwwEQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMToyMTozNlrOHwwEzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MTIxOA==", "bodyText": "nit\nformatting", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520881218", "createdAt": "2020-11-10T21:21:19Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -281,43 +281,32 @@ private void updateChild(CaseInsensitiveString key, Object value,\n             childMergeBehavior = mergeBehavior;\n         }\n \n-        switch (childMergeBehavior.getDefaultBehavior()) {\n-            case MERGE:\n-                mergeChild(key, value, childMergeBehavior);\n-                break;\n-            case REPLACE:\n-                replaceChild(key, value, childMergeBehavior);\n-                break;\n-            default:\n-        }\n-    }\n-\n-    private void mergeChild(CaseInsensitiveString key, Object value,\n-                            @NonNull UpdateBehaviorTree mergeBehavior) {\n-        if (value instanceof Map) {\n-            createInteriorChild(key).updateFromMap((Map) value, mergeBehavior);\n-        } else {\n-            createLeafChild(key).withNewerValue(mergeBehavior.getTimestampToUse(), value, false, true);\n-        }\n-    }\n-\n-    private void replaceChild(CaseInsensitiveString key, Object value,\n-                              @Nonnull UpdateBehaviorTree childMergeBehavior) {\n         Node existingChild = children.get(key);\n         // if new node is a container node\n         if (value instanceof Map) {\n-            // if existing child is a leaf node\n-            if (existingChild != null && !(existingChild instanceof Topics)) {\n+            // if existing child is a container node\n+            if (existingChild == null || existingChild instanceof Topics) {\n+                createInteriorChild(key).updateFromMap((Map) value, childMergeBehavior);\n+            } else {\n                 remove(existingChild);\n+                Topics newNode = createInteriorChild(key);\n+                for (Watcher watcher: existingChild.watchers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6818262f066c56b25929d369ba87be5df363c1b7"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MTM1OQ==", "bodyText": "formatting", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520881359", "createdAt": "2020-11-10T21:21:36Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -281,43 +281,32 @@ private void updateChild(CaseInsensitiveString key, Object value,\n             childMergeBehavior = mergeBehavior;\n         }\n \n-        switch (childMergeBehavior.getDefaultBehavior()) {\n-            case MERGE:\n-                mergeChild(key, value, childMergeBehavior);\n-                break;\n-            case REPLACE:\n-                replaceChild(key, value, childMergeBehavior);\n-                break;\n-            default:\n-        }\n-    }\n-\n-    private void mergeChild(CaseInsensitiveString key, Object value,\n-                            @NonNull UpdateBehaviorTree mergeBehavior) {\n-        if (value instanceof Map) {\n-            createInteriorChild(key).updateFromMap((Map) value, mergeBehavior);\n-        } else {\n-            createLeafChild(key).withNewerValue(mergeBehavior.getTimestampToUse(), value, false, true);\n-        }\n-    }\n-\n-    private void replaceChild(CaseInsensitiveString key, Object value,\n-                              @Nonnull UpdateBehaviorTree childMergeBehavior) {\n         Node existingChild = children.get(key);\n         // if new node is a container node\n         if (value instanceof Map) {\n-            // if existing child is a leaf node\n-            if (existingChild != null && !(existingChild instanceof Topics)) {\n+            // if existing child is a container node\n+            if (existingChild == null || existingChild instanceof Topics) {\n+                createInteriorChild(key).updateFromMap((Map) value, childMergeBehavior);\n+            } else {\n                 remove(existingChild);\n+                Topics newNode = createInteriorChild(key);\n+                for (Watcher watcher: existingChild.watchers) {\n+                    newNode.addWatcher(watcher);\n+                }\n+                newNode.updateFromMap((Map) value, childMergeBehavior);\n             }\n-            createInteriorChild(key).updateFromMap((Map) value, childMergeBehavior);\n         // if new node is a leaf node\n         } else {\n-            // if existing child is a container node\n-            if (existingChild != null && !(existingChild instanceof Topic)) {\n+            if (existingChild == null || existingChild instanceof Topic) {\n+                createLeafChild(key).withNewerValue(childMergeBehavior.getTimestampToUse(), value, false, true);\n+            } else {\n                 remove(existingChild);\n+                Topic newNode = createLeafChild(key);\n+                for (Watcher watcher: existingChild.watchers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6818262f066c56b25929d369ba87be5df363c1b7"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f741945e213d30441416b45b0405bebddb0bdf48", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f741945e213d30441416b45b0405bebddb0bdf48", "committedDate": "2020-11-10T22:12:36Z", "message": "Merge branch 'master' of https://github.com/aws/aws-greengrass-kernel into nodeTypeChange"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd3d3edf9aefb08e22ca02a41ecbb563fd904e06", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd3d3edf9aefb08e22ca02a41ecbb563fd904e06", "committedDate": "2020-11-10T22:14:12Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0565f8afcef5421b41fb026942ffcd2c3e2baaa", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f0565f8afcef5421b41fb026942ffcd2c3e2baaa", "committedDate": "2020-11-10T21:57:12Z", "message": "Merge branch 'master' into nodeTypeChange"}, "afterCommit": {"oid": "fd3d3edf9aefb08e22ca02a41ecbb563fd904e06", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd3d3edf9aefb08e22ca02a41ecbb563fd904e06", "committedDate": "2020-11-10T22:14:12Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjUxMTAx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-527651101", "createdAt": "2020-11-10T22:14:10Z", "commit": {"oid": "f0565f8afcef5421b41fb026942ffcd2c3e2baaa"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMjoxNDoxMFrOHwxspA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMjoxNDoxMFrOHwxspA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkwNzk0MA==", "bodyText": "Thanks for updating this!", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#discussion_r520907940", "createdAt": "2020-11-10T22:14:10Z", "author": {"login": "fengwang666"}, "path": "CONFIGURE_COMPONENT_README.md", "diffHunk": "@@ -121,6 +121,13 @@ At every level,\n 2. If a key doesn't exist, then key-value pair that is merging in will be added. Note a key that is not existed in the default value,\n could also be added.\n \n+#### 2.3.3 MERGE - The change between a 'leaf' node and a 'container node'\n+1. If a config node has children, it's a 'container' node.\n+1. If a config node has value while not having children, it's a 'leaf' node.\n+1. If during a MERGE, a node type changed between 'leaf' and 'container', the old node will be removed and new node will be created.\n+ Subscribers of the old node will be copied over to new node.\n+ Parent node subscribers will be notified of 'childRemoved' event.\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0565f8afcef5421b41fb026942ffcd2c3e2baaa"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjU3Nzky", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/644#pullrequestreview-527657792", "createdAt": "2020-11-10T22:25:31Z", "commit": {"oid": "fd3d3edf9aefb08e22ca02a41ecbb563fd904e06"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2613, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}