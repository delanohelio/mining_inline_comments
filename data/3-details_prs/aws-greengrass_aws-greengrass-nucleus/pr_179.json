{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyOTUyODIz", "number": 179, "title": "Make Flake Finder more debuggable, fix PMD running multiple times", "bodyText": "Issue #, if available:\nDescription of changes:\nFlake finder was failing because PMD was finding more than the allowed 1 issue when run a second time. This is due to PMD executing on the newly compile integration test classes which it had not seen before. This change fixes or suppresses PMD warnings, it also changes the execution order so that we have checkstyle, compile source, compile tests, pmd, spotbugs, run unit, run integration.\nThis change also makes flake finder much easier to debug when our command fails, but does not result in test result XML files (like when PMD fails). It does this by writing stdout and stderr to files in the failed_tests directory.\nWhy is this change necessary:\nHow was this change tested:\nTested locally and by setting flake finder to run on pull requests. I ran it when this PR was a draft and saw that it was able to run more than twice (due to previous PMD failures it would always fail on the second run).\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-14T03:47:05Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/179", "merged": true, "mergeCommit": {"oid": "19fa682413e3bc28d8222e17938561fdba166400"}, "closed": true, "closedAt": "2020-04-14T18:27:01Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXbfi7ABqjMyMjkzOTMwMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXnwgOgFqTM5MzE4NTk4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "411418481f48b1b73ddebe8e8b2a11e51dd7c1c6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/411418481f48b1b73ddebe8e8b2a11e51dd7c1c6", "committedDate": "2020-04-14T03:46:54Z", "message": "Make Flake Finder more debuggable"}, "afterCommit": {"oid": "d1bff27bee38c00790dbb1d4027777ca392929e6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d1bff27bee38c00790dbb1d4027777ca392929e6", "committedDate": "2020-04-14T04:08:08Z", "message": "Make Flake Finder more debuggable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1bff27bee38c00790dbb1d4027777ca392929e6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d1bff27bee38c00790dbb1d4027777ca392929e6", "committedDate": "2020-04-14T04:08:08Z", "message": "Make Flake Finder more debuggable"}, "afterCommit": {"oid": "bec680a341170742cc4c3477113e06bceddb6f4a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bec680a341170742cc4c3477113e06bceddb6f4a", "committedDate": "2020-04-14T04:23:37Z", "message": "Make Flake Finder more debuggable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bec680a341170742cc4c3477113e06bceddb6f4a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bec680a341170742cc4c3477113e06bceddb6f4a", "committedDate": "2020-04-14T04:23:37Z", "message": "Make Flake Finder more debuggable"}, "afterCommit": {"oid": "5b8cf8278a7d859dc4a8bd30368867cb837ab596", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b8cf8278a7d859dc4a8bd30368867cb837ab596", "committedDate": "2020-04-14T04:28:29Z", "message": "Make Flake Finder more debuggable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMTEwNzYz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/179#pullrequestreview-393110763", "createdAt": "2020-04-14T16:45:47Z", "commit": {"oid": "5b8cf8278a7d859dc4a8bd30368867cb837ab596"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjo0NTo0N1rOGFXqOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjo0NTo0N1rOGFXqOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4MzcwNw==", "bodyText": "A quick reformat on this file, please!", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/179#discussion_r408283707", "createdAt": "2020-04-14T16:45:47Z", "author": {"login": "leaf94"}, "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -102,32 +103,34 @@ public void startup() {\n     }\n \n     @Test\n-    void GIVEN_a_service_WHEN_reportState_THEN_all_state_changes_are_notified() throws InterruptedException {\n+    void GIVEN_a_service_WHEN_reportState_THEN_all_state_changes_are_notified() throws InterruptedException,\n+            IOException {\n         ScheduledThreadPoolExecutor ses = new ScheduledThreadPoolExecutor(2);\n         ExecutorService cachedPool = Executors.newCachedThreadPool();\n         CountDownLatch cd = new CountDownLatch(2);\n \n-        Context context = new Context();\n-        context.put(ScheduledThreadPoolExecutor.class, ses);\n-        context.put(ScheduledExecutorService.class, ses);\n-        context.put(Executor.class, cachedPool);\n-        context.put(ExecutorService.class, cachedPool);\n-        context.put(ThreadPoolExecutor.class, ses);\n-        context.put(CountDownLatch.class, cd);\n-\n-        final AtomicInteger n = new AtomicInteger(0);\n-        context.addGlobalStateChangeListener((service, oldState, newState) -> {\n-            if (n.incrementAndGet() >= NUM * 2) {\n-                cd.countDown();\n-            }\n-        });\n+        try(Context context = new Context()) {\n+            context.put(ScheduledThreadPoolExecutor.class, ses);\n+            context.put(ScheduledExecutorService.class, ses);\n+            context.put(Executor.class, cachedPool);\n+            context.put(ExecutorService.class, cachedPool);\n+            context.put(ThreadPoolExecutor.class, ses);\n+            context.put(CountDownLatch.class, cd);\n+\n+            final AtomicInteger n = new AtomicInteger(0);\n+            context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+                if (n.incrementAndGet() >= NUM * 2) {\n+                    cd.countDown();\n+                }\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b8cf8278a7d859dc4a8bd30368867cb837ab596"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abfa3c211a05cc46a2213f961a726d9e4f2bf625", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/abfa3c211a05cc46a2213f961a726d9e4f2bf625", "committedDate": "2020-04-14T17:43:29Z", "message": "Make Flake Finder more debuggable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b8cf8278a7d859dc4a8bd30368867cb837ab596", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b8cf8278a7d859dc4a8bd30368867cb837ab596", "committedDate": "2020-04-14T04:28:29Z", "message": "Make Flake Finder more debuggable"}, "afterCommit": {"oid": "abfa3c211a05cc46a2213f961a726d9e4f2bf625", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/abfa3c211a05cc46a2213f961a726d9e4f2bf625", "committedDate": "2020-04-14T17:43:29Z", "message": "Make Flake Finder more debuggable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMTc2ODI4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/179#pullrequestreview-393176828", "createdAt": "2020-04-14T18:12:46Z", "commit": {"oid": "abfa3c211a05cc46a2213f961a726d9e4f2bf625"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxODoxMjo0NlrOGFa--g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxODoxMjo1N1rOGFa_dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMzODE3MA==", "bodyText": "Do we plan to live with this violation?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/179#discussion_r408338170", "createdAt": "2020-04-14T18:12:46Z", "author": {"login": "shaguptashaikh"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -101,6 +101,7 @@ void GIVEN_expected_stdout_patterns_WHEN_kernel_launches_THEN_all_expected_patte\n         kernel.shutdown();\n     }\n \n+    @SuppressWarnings(\"PMD.AssignmentInOperand\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abfa3c211a05cc46a2213f961a726d9e4f2bf625"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMzODI5NA==", "bodyText": "Same as above", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/179#discussion_r408338294", "createdAt": "2020-04-14T18:12:57Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -106,6 +106,7 @@ public void startup() throws InterruptedException {\n         }\n     }\n \n+    @SuppressWarnings(\"PMD.CloseResource\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abfa3c211a05cc46a2213f961a726d9e4f2bf625"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMTg1OTg3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/179#pullrequestreview-393185987", "createdAt": "2020-04-14T18:25:37Z", "commit": {"oid": "abfa3c211a05cc46a2213f961a726d9e4f2bf625"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2113, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}