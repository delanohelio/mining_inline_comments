{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5ODk3OTIz", "number": 737, "title": "Improve logging of systemd setup", "bodyText": "Issue #, if available:\nDescription of changes:\n\nsystemd setup happens after kernel.shutdown which closes logger context so that none of systemd setup logs are logged. Move kernel.shutdown after systemd setup.\nAdd more logging\n\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-01T00:45:09Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/737", "merged": true, "mergeCommit": {"oid": "8cee479e992adcda67ecba40988bf8a75602ff4c"}, "closed": true, "closedAt": "2020-12-04T02:30:30Z", "author": {"login": "hui-yang"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhvIdjgFqTU0MTQwOTEyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiuHf4gH2gAyNTI5ODk3OTIzOjVmYjNmNzBiNTc1YmI5YjNkZWNmYWY3OWQyMGVlZTAyYzIyZDRiZDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDA5MTI3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/737#pullrequestreview-541409127", "createdAt": "2020-12-01T00:51:30Z", "commit": {"oid": "4fb5891e8609d0747e9c5db7d1dd15da1f85d1d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo1MTozMVrOH8TyHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDo1MTozMVrOH8TyHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwMDczMg==", "bodyText": "would be better if you use the UserDecorator to build these commands. They don't need sudo if kernel is already running as root (which is the common case)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/737#discussion_r533000732", "createdAt": "2020-12-01T00:51:31Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/util/orchestration/SystemdUtils.java", "diffHunk": "@@ -21,25 +21,38 @@\n     private static final String PID_FILE_PARAM = \"REPLACE_WITH_GG_LOADER_PID_FILE\";\n     private static final String LOADER_FILE_PARAM = \"REPLACE_WITH_GG_LOADER_FILE\";\n     private static final String SERVICE_CONFIG_FILE_PATH = \"/etc/systemd/system/greengrass.service\";\n+    private static final String LOG_EVENT_NAME = \"systemd-setup\";\n \n     @Override\n     public boolean setupSystemService(KernelAlternatives kernelAlternatives) {\n+        logger.atDebug(LOG_EVENT_NAME).log(\"Start systemd setup\");\n         try {\n             kernelAlternatives.setupInitLaunchDirIfAbsent();\n+\n+            Path serviceTemplate = kernelAlternatives.getServiceTemplatePath();\n+            if (!Files.exists(serviceTemplate)) {\n+                throw new IOException(\"Missing service template file at: \" + serviceTemplate);\n+            }\n+            Path loaderPath = kernelAlternatives.getLoaderPath();\n+            if (!Files.exists(serviceTemplate)) {\n+                throw new IOException(\"Missing loader file at: \" + loaderPath);\n+            }\n+\n             Path serviceConfig = kernelAlternatives.getServiceConfigPath();\n-            interpolateServiceTemplate(kernelAlternatives.getServiceTemplatePath(), serviceConfig, kernelAlternatives);\n+            interpolateServiceTemplate(serviceTemplate, serviceConfig, kernelAlternatives);\n \n             runCommand(String.format(\"sudo cp %s %s\", serviceConfig, SERVICE_CONFIG_FILE_PATH));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fb5891e8609d0747e9c5db7d1dd15da1f85d1d0"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDA5MTk0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/737#pullrequestreview-541409194", "createdAt": "2020-12-01T00:51:43Z", "commit": {"oid": "4fb5891e8609d0747e9c5db7d1dd15da1f85d1d0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65e6b724eed64a975ab745f348d46901ad802971", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/65e6b724eed64a975ab745f348d46901ad802971", "committedDate": "2020-12-02T23:50:21Z", "message": "Improve logging of systemd setup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec1f6910ab8dd3800b207135145b10e6212e4dec", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ec1f6910ab8dd3800b207135145b10e6212e4dec", "committedDate": "2020-12-03T00:54:05Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b420c824efb6f6cf66d75a0d63ee6d70dbd8fd7", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b420c824efb6f6cf66d75a0d63ee6d70dbd8fd7", "committedDate": "2020-12-02T17:56:25Z", "message": "Merge branch 'master' into systemd-log"}, "afterCommit": {"oid": "ec1f6910ab8dd3800b207135145b10e6212e4dec", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ec1f6910ab8dd3800b207135145b10e6212e4dec", "committedDate": "2020-12-03T00:54:05Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzcwODYy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/737#pullrequestreview-543370862", "createdAt": "2020-12-03T01:26:06Z", "commit": {"oid": "ec1f6910ab8dd3800b207135145b10e6212e4dec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f21ffc9ff1ba30d6913f0c7048e190ec2478add6", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f21ffc9ff1ba30d6913f0c7048e190ec2478add6", "committedDate": "2020-12-03T17:57:52Z", "message": "Merge branch 'master' into systemd-log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8db6802f5767a3f2ed8164dd6e86985637321d0", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a8db6802f5767a3f2ed8164dd6e86985637321d0", "committedDate": "2020-12-03T21:00:37Z", "message": "Merge branch 'master' into systemd-log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6fd9513ca3caed6e2da0cfb94e922981488b83e", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f6fd9513ca3caed6e2da0cfb94e922981488b83e", "committedDate": "2020-12-03T23:50:29Z", "message": "Merge branch 'master' into systemd-log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTc2NzEw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/737#pullrequestreview-544576710", "createdAt": "2020-12-04T00:44:32Z", "commit": {"oid": "f6fd9513ca3caed6e2da0cfb94e922981488b83e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fb3f70b575bb9b3decfaf79d20eee02c22d4bd3", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5fb3f70b575bb9b3decfaf79d20eee02c22d4bd3", "committedDate": "2020-12-04T02:14:29Z", "message": "Merge branch 'master' into systemd-log"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2775, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}