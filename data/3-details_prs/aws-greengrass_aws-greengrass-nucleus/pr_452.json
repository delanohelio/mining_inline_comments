{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NDEzNjM5", "number": 452, "title": "Authorization bug fixes", "bodyText": "Description of changes:\n\nRenamed the auth module to be authorization\nFixed a bug in AuthorizationHandler where policies were retained after removal of the component/ACL. Now we clear only all policyTypes that are not present in the new reloaded parsed ACL list.\nAdded two new integration tests to test for this.\n\nWhy is this change necessary:\n\nNoticed failing UATs where components/ACLs were removed and deployed and checked to ensure removal.\n\nHow was this change tested:\nRan all integ tests + relevant unit tests; tested locally with the UATS. Corresponding CR: https://code.amazon.com/reviews/CR-34359550/revisions/1#/diff\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n[x ] Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-18T16:15:06Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452", "merged": true, "mergeCommit": {"oid": "db9928759e6ca5c2359f92a9c7f7b9cde336003d"}, "closed": true, "closedAt": "2020-09-23T01:29:17Z", "author": {"login": "avipinku"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKIEzhAFqTQ5MTYwODk5Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLh4n3gFqTQ5Mzk0MDk2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjA4OTkz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-491608993", "createdAt": "2020-09-18T16:20:57Z", "commit": {"oid": "845155d1b3f83f9e1d53cbf231df134484ccb40b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoyMDo1OFrOHUTw5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoyMDo1OFrOHUTw5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1NzM4MA==", "bodyText": "don't undo Fahad's work at speeding things up by reusing the same kernel", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r491057380", "createdAt": "2020-09-18T16:20:58Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCPubSubTest.java", "diffHunk": "@@ -59,25 +71,21 @@\n     @BeforeAll\n     static void startKernel() throws InterruptedException {\n         System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n-        kernel = prepareKernelFromConfigFile(\"pubsub.yaml\", IPCPubSubTest.class, \"SubscribeAndPublish\");\n     }\n \n-    @AfterAll\n-    static void stopKernel() {\n+    @AfterEach\n+    void stopKernel() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "845155d1b3f83f9e1d53cbf231df134484ccb40b"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjEwOTQz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-491610943", "createdAt": "2020-09-18T16:23:39Z", "commit": {"oid": "845155d1b3f83f9e1d53cbf231df134484ccb40b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoyMzozOVrOHUT2_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoyMzozOVrOHUT2_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1ODk0Mw==", "bodyText": "remove this", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r491058943", "createdAt": "2020-09-18T16:23:39Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/authorization/AuthorizationHandler.java", "diffHunk": "@@ -65,20 +65,19 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n         Map<String, List<AuthorizationPolicy>> componentNameToPolicies = policyParser.parseAllAuthorizationPolicies(\n                 kernel);\n         for (Map.Entry<String, List<AuthorizationPolicy>> acl : componentNameToPolicies.entrySet()) {\n-            this.loadAuthorizationPolicies(acl.getKey(), acl.getValue(), false);\n+            this.loadAuthorizationPolicies(acl.getKey(), acl.getValue());\n         }\n \n-        //Load default policy for TES\n-        this.loadAuthorizationPolicies(TOKEN_EXCHANGE_SERVICE_TOPICS,\n-                getDefaultPolicyForService(AUTHZ_TES_OPERATION),\n-                false);\n+        //Load default policies\n+        addDefaultPolicies();\n \n         //Subscribe to future auth config updates\n         this.kernel.getConfig().getRoot().subscribe(\n                 (why, newv) -> {\n                     if (newv == null) {\n                         return;\n                     }\n+                    logger.atInfo(newv.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "845155d1b3f83f9e1d53cbf231df134484ccb40b"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjExNjE0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-491611614", "createdAt": "2020-09-18T16:24:31Z", "commit": {"oid": "845155d1b3f83f9e1d53cbf231df134484ccb40b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoyNDozMlrOHUT45w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoyNDozMlrOHUT45w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1OTQzMQ==", "bodyText": "during this time period, requests are being wrongly dropped.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r491059431", "createdAt": "2020-09-18T16:24:32Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/authorization/AuthorizationHandler.java", "diffHunk": "@@ -105,10 +104,19 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n                     //TODO: Add more sophisticated logic to specifically update policies scoped to this component,\n                     // instead of reloading everything on every update.\n                     // https://issues-iad.amazon.com/issues/V243584397\n-                    Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n+\n+                    final Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n                             .parseAllAuthorizationPolicies(kernel);\n+\n+                    //Delete all policies before reloading\n+                    componentToAuthZConfig.clear();\n+                    authModule.deleteAllPermissions();\n+\n+                    //Add back in the relevant default policies\n+                    addDefaultPolicies();\n+\n                     for (Map.Entry<String, List<AuthorizationPolicy>> acl : reloadedPolicies.entrySet()) {\n-                        this.loadAuthorizationPolicies(acl.getKey(), acl.getValue(), true);\n+                        this.loadAuthorizationPolicies(acl.getKey(), acl.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "845155d1b3f83f9e1d53cbf231df134484ccb40b"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjEyMTUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-491612153", "createdAt": "2020-09-18T16:25:21Z", "commit": {"oid": "845155d1b3f83f9e1d53cbf231df134484ccb40b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoyNToyMVrOHUT6yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoyNToyMVrOHUT6yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1OTkxMw==", "bodyText": "flip this. Expected then actual", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r491059913", "createdAt": "2020-09-18T16:25:21Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/authorization/AuthorizationModuleTest.java", "diffHunk": "@@ -96,9 +96,8 @@ void Given_authZmodule_WHEN_given_component_and_clear_permissions_THEN_delete_pe\n                 fail(\"Encountered exception \", e);\n             }\n         });\n-        String componentToRemove = \"ComponentB\";\n-        module.deletePermissionsWithDestination(componentToRemove);\n-        assertEquals(module.permissions.get(\"ComponentB\").size(), 0);\n+        module.deleteAllPermissions();\n+        assertEquals(module.permissions.size(), 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "845155d1b3f83f9e1d53cbf231df134484ccb40b"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "845155d1b3f83f9e1d53cbf231df134484ccb40b", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/845155d1b3f83f9e1d53cbf231df134484ccb40b", "committedDate": "2020-09-18T16:15:49Z", "message": "Removed old pubsub authorization config files"}, "afterCommit": {"oid": "06b5a4a0eecd4397c7c3c04fd7cc2980b29c5500", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/06b5a4a0eecd4397c7c3c04fd7cc2980b29c5500", "committedDate": "2020-09-18T20:24:51Z", "message": "Responded to feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06b5a4a0eecd4397c7c3c04fd7cc2980b29c5500", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/06b5a4a0eecd4397c7c3c04fd7cc2980b29c5500", "committedDate": "2020-09-18T20:24:51Z", "message": "Responded to feedback"}, "afterCommit": {"oid": "f16b92b3b403d803ad4574c5d3a7edf62fa54fee", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f16b92b3b403d803ad4574c5d3a7edf62fa54fee", "committedDate": "2020-09-21T21:40:02Z", "message": "Responded to feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f16b92b3b403d803ad4574c5d3a7edf62fa54fee", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f16b92b3b403d803ad4574c5d3a7edf62fa54fee", "committedDate": "2020-09-21T21:40:02Z", "message": "Responded to feedback"}, "afterCommit": {"oid": "c6665ce5e5ecea415a1c63ba384644e842aa92f7", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6665ce5e5ecea415a1c63ba384644e842aa92f7", "committedDate": "2020-09-21T21:54:55Z", "message": "Responded to feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDE4NzE4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-493018718", "createdAt": "2020-09-21T22:16:22Z", "commit": {"oid": "c6665ce5e5ecea415a1c63ba384644e842aa92f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoxNjoyMlrOHVkT2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoxNjoyMlrOHVkT2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3NzA0OA==", "bodyText": "if order matter, use the order junit annotations, otherwise it is likely to break", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r492377048", "createdAt": "2020-09-21T22:16:22Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/ipc/IPCPubSubRemovalTest.java", "diffHunk": "@@ -0,0 +1,280 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.greengrass.integrationtests.ipc;\n+\n+import com.aws.greengrass.authorization.AuthorizationModule;\n+import com.aws.greengrass.authorization.Permission;\n+import com.aws.greengrass.componentmanager.exceptions.PackageDownloadException;\n+import com.aws.greengrass.config.Topic;\n+import com.aws.greengrass.config.Topics;\n+import com.aws.greengrass.dependency.State;\n+import com.aws.greengrass.ipc.IPCClient;\n+import com.aws.greengrass.ipc.IPCClientImpl;\n+import com.aws.greengrass.ipc.config.KernelIPCClientConfig;\n+import com.aws.greengrass.ipc.services.cli.Cli;\n+import com.aws.greengrass.ipc.services.cli.CliImpl;\n+import com.aws.greengrass.ipc.services.cli.models.CreateLocalDeploymentRequest;\n+import com.aws.greengrass.ipc.services.cli.models.CreateLocalDeploymentResponse;\n+import com.aws.greengrass.ipc.services.cli.models.UpdateRecipesAndArtifactsRequest;\n+import com.aws.greengrass.ipc.services.pubsub.PubSub;\n+import com.aws.greengrass.ipc.services.pubsub.PubSubException;\n+import com.aws.greengrass.ipc.services.pubsub.PubSubImpl;\n+import com.aws.greengrass.lifecyclemanager.Kernel;\n+import com.aws.greengrass.testcommons.testutilities.GGExtension;\n+import com.aws.greengrass.util.Pair;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static com.aws.greengrass.componentmanager.KernelConfigResolver.PARAMETERS_CONFIG_KEY;\n+import static com.aws.greengrass.integrationtests.ipc.IPCTestUtils.getIPCConfigForService;\n+import static com.aws.greengrass.integrationtests.ipc.IPCTestUtils.prepareKernelFromConfigFile;\n+import static com.aws.greengrass.integrationtests.ipc.IPCTestUtils.waitForDeploymentToBeSuccessful;\n+import static com.aws.greengrass.integrationtests.ipc.IPCTestUtils.waitForServiceToComeInState;\n+import static com.aws.greengrass.ipc.modules.PubSubIPCService.PUB_SUB_SERVICE_NAME;\n+import static com.aws.greengrass.lifecyclemanager.GreengrassService.ACCESS_CONTROL_NAMESPACE_TOPIC;\n+import static com.aws.greengrass.testcommons.testutilities.ExceptionLogProtector.ignoreExceptionOfType;\n+import static com.aws.greengrass.testcommons.testutilities.ExceptionLogProtector.ignoreExceptionUltimateCauseWithMessage;\n+import static com.aws.greengrass.testcommons.testutilities.ExceptionLogProtector.ignoreExceptionWithMessage;\n+import static com.aws.greengrass.testcommons.testutilities.TestUtils.asyncAssertOnConsumer;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(GGExtension.class)\n+class IPCPubSubRemovalTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6665ce5e5ecea415a1c63ba384644e842aa92f7"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDE4OTEw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-493018910", "createdAt": "2020-09-21T22:16:51Z", "commit": {"oid": "c6665ce5e5ecea415a1c63ba384644e842aa92f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoxNjo1MVrOHVkUfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoxNjo1MVrOHVkUfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3NzIxMg==", "bodyText": "keep this as static and afterall", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r492377212", "createdAt": "2020-09-21T22:16:51Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/ipc/IPCPubSubTest.java", "diffHunk": "@@ -59,25 +53,21 @@\n     @BeforeAll\n     static void startKernel() throws InterruptedException {\n         System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n-        kernel = prepareKernelFromConfigFile(\"pubsub.yaml\", IPCPubSubTest.class, \"SubscribeAndPublish\");\n     }\n \n-    @AfterAll\n-    static void stopKernel() {\n+    @AfterEach\n+    void stopKernel() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6665ce5e5ecea415a1c63ba384644e842aa92f7"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDIwNzEy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-493020712", "createdAt": "2020-09-21T22:20:51Z", "commit": {"oid": "c6665ce5e5ecea415a1c63ba384644e842aa92f7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoyMDo1MlrOHVkapQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMjoyMjo1OVrOHVkdwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3ODc4OQ==", "bodyText": "don't use this", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r492378789", "createdAt": "2020-09-21T22:20:52Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -12,6 +12,7 @@\n import com.aws.greengrass.logging.api.Logger;\n import com.aws.greengrass.logging.impl.LogManager;\n import com.aws.greengrass.util.Utils;\n+import lombok.Synchronized;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6665ce5e5ecea415a1c63ba384644e842aa92f7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3ODkxNA==", "bodyText": "just use normal sync. public synchronized boolean ...", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r492378914", "createdAt": "2020-09-21T22:21:12Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -126,6 +133,7 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n      * @return whether the input combination is a valid flow.\n      * @throws AuthorizationException when flow is not authorized.\n      */\n+    @Synchronized", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6665ce5e5ecea415a1c63ba384644e842aa92f7"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3OTE1Ng==", "bodyText": "what about what we discussed re: deleting policies and synchronization?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r492379156", "createdAt": "2020-09-21T22:21:47Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -107,10 +106,18 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n                     //TODO: Add more sophisticated logic to specifically update policies scoped to this component,\n                     // instead of reloading everything on every update.\n                     // https://issues-iad.amazon.com/issues/V243584397\n-                    Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n+\n+                    final Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n                             .parseAllAuthorizationPolicies(kernel);\n+\n+                    //Delete all policies before reloading\n+                    clearPolicies();\n+\n+                    //Add back in the relevant default policies\n+                    addDefaultPolicies();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6665ce5e5ecea415a1c63ba384644e842aa92f7"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3OTU4NQ==", "bodyText": "your synchronization strategy is still wrong. Use a ReentrantReadWriteLock. Use the readlock for isAuthorized and wrap the writelock around this whole block of L109-121", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r492379585", "createdAt": "2020-09-21T22:22:59Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -107,10 +106,18 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n                     //TODO: Add more sophisticated logic to specifically update policies scoped to this component,\n                     // instead of reloading everything on every update.\n                     // https://issues-iad.amazon.com/issues/V243584397\n-                    Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n+\n+                    final Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n                             .parseAllAuthorizationPolicies(kernel);\n+\n+                    //Delete all policies before reloading\n+                    clearPolicies();\n+\n+                    //Add back in the relevant default policies\n+                    addDefaultPolicies();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM3OTE1Ng=="}, "originalCommit": {"oid": "c6665ce5e5ecea415a1c63ba384644e842aa92f7"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5f7d93cae75f18b3cc3d91fc4c6a2a03aa82d56", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a5f7d93cae75f18b3cc3d91fc4c6a2a03aa82d56", "committedDate": "2020-09-21T23:23:59Z", "message": "Added ReentrantLock to control synchronization"}, "afterCommit": {"oid": "ef3594643af75a1e9428aba3bc7ebf0d90ad2585", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ef3594643af75a1e9428aba3bc7ebf0d90ad2585", "committedDate": "2020-09-22T20:23:59Z", "message": "Delete only policies not present in reloaded diff"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTIxMjQ0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-493921244", "createdAt": "2020-09-22T23:53:11Z", "commit": {"oid": "ef3594643af75a1e9428aba3bc7ebf0d90ad2585"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMzo1MzoxMlrOHWQNuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMzo1MzoxMlrOHWQNuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA5NjM3OQ==", "bodyText": "We can move the lock() here. We do not need that for parsing the config.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r493096379", "createdAt": "2020-09-22T23:53:12Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -103,14 +104,34 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n                         return;\n                     }\n \n-                    //Reload all policies\n-                    //TODO: Add more sophisticated logic to specifically update policies scoped to this component,\n-                    // instead of reloading everything on every update.\n-                    // https://issues-iad.amazon.com/issues/V243584397\n-                    Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n-                            .parseAllAuthorizationPolicies(kernel);\n-                    for (Map.Entry<String, List<AuthorizationPolicy>> acl : reloadedPolicies.entrySet()) {\n-                        this.loadAuthorizationPolicies(acl.getKey(), acl.getValue(), true);\n+                    try {\n+                        rwLock.writeLock().lock();\n+\n+                        //Reload all policies\n+                        //TODO: Add more sophisticated logic to specifically update policies scoped to this component,\n+                        // instead of reloading everything on every update.\n+                        // https://issues-iad.amazon.com/issues/V243584397\n+                        Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n+                                .parseAllAuthorizationPolicies(kernel);\n+\n+                        for (Map.Entry<String, List<AuthorizationPolicy>> masterPolicyList :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef3594643af75a1e9428aba3bc7ebf0d90ad2585"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTIyNDM1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-493922435", "createdAt": "2020-09-22T23:56:36Z", "commit": {"oid": "ef3594643af75a1e9428aba3bc7ebf0d90ad2585"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMzo1NjozNlrOHWQRyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMzo1NjozNlrOHWQRyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA5NzQxNw==", "bodyText": "This will also remove default policies like TES?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r493097417", "createdAt": "2020-09-22T23:56:36Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -103,14 +104,34 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n                         return;\n                     }\n \n-                    //Reload all policies\n-                    //TODO: Add more sophisticated logic to specifically update policies scoped to this component,\n-                    // instead of reloading everything on every update.\n-                    // https://issues-iad.amazon.com/issues/V243584397\n-                    Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n-                            .parseAllAuthorizationPolicies(kernel);\n-                    for (Map.Entry<String, List<AuthorizationPolicy>> acl : reloadedPolicies.entrySet()) {\n-                        this.loadAuthorizationPolicies(acl.getKey(), acl.getValue(), true);\n+                    try {\n+                        rwLock.writeLock().lock();\n+\n+                        //Reload all policies\n+                        //TODO: Add more sophisticated logic to specifically update policies scoped to this component,\n+                        // instead of reloading everything on every update.\n+                        // https://issues-iad.amazon.com/issues/V243584397\n+                        Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n+                                .parseAllAuthorizationPolicies(kernel);\n+\n+                        for (Map.Entry<String, List<AuthorizationPolicy>> masterPolicyList :\n+                                componentToAuthZConfig.entrySet()) {\n+                            String policyType = masterPolicyList.getKey();\n+                            if (!reloadedPolicies.containsKey(policyType)) {\n+                                //If the policyType already exists and was not reparsed correctly and/or removed from\n+                                //the newly parsed list, delete it from our store since it is now an unwanted relic\n+                                componentToAuthZConfig.remove(policyType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef3594643af75a1e9428aba3bc7ebf0d90ad2585"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTI4MjM0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-493928234", "createdAt": "2020-09-23T00:14:47Z", "commit": {"oid": "ef3594643af75a1e9428aba3bc7ebf0d90ad2585"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwMDoxNDo0OFrOHWQmFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwMDoxNDo0OFrOHWQmFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMjYxNQ==", "bodyText": "use try-with-resources and our LockScope", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#discussion_r493102615", "createdAt": "2020-09-23T00:14:48Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -103,14 +104,34 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n                         return;\n                     }\n \n-                    //Reload all policies\n-                    //TODO: Add more sophisticated logic to specifically update policies scoped to this component,\n-                    // instead of reloading everything on every update.\n-                    // https://issues-iad.amazon.com/issues/V243584397\n-                    Map<String, List<AuthorizationPolicy>> reloadedPolicies = policyParser\n-                            .parseAllAuthorizationPolicies(kernel);\n-                    for (Map.Entry<String, List<AuthorizationPolicy>> acl : reloadedPolicies.entrySet()) {\n-                        this.loadAuthorizationPolicies(acl.getKey(), acl.getValue(), true);\n+                    try {\n+                        rwLock.writeLock().lock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef3594643af75a1e9428aba3bc7ebf0d90ad2585"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e05201d11bc2832aa7718563c9dc461b8210266", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2e05201d11bc2832aa7718563c9dc461b8210266", "committedDate": "2020-09-23T00:50:37Z", "message": "Authorization bug fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7516ef118f135b6ba1ea9f0eec2937bc2366fe4", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b7516ef118f135b6ba1ea9f0eec2937bc2366fe4", "committedDate": "2020-09-23T00:50:37Z", "message": "Delete only policies not present in reloaded diff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3659f8875224978a734c87b34cfb8c1ca801f43", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a3659f8875224978a734c87b34cfb8c1ca801f43", "committedDate": "2020-09-23T00:50:37Z", "message": "Responded to feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef3594643af75a1e9428aba3bc7ebf0d90ad2585", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ef3594643af75a1e9428aba3bc7ebf0d90ad2585", "committedDate": "2020-09-22T20:23:59Z", "message": "Delete only policies not present in reloaded diff"}, "afterCommit": {"oid": "a3659f8875224978a734c87b34cfb8c1ca801f43", "author": {"user": {"login": "avipinku", "name": "Ashay Vipinkumar"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a3659f8875224978a734c87b34cfb8c1ca801f43", "committedDate": "2020-09-23T00:50:37Z", "message": "Responded to feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTM5NDQz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-493939443", "createdAt": "2020-09-23T00:53:56Z", "commit": {"oid": "a3659f8875224978a734c87b34cfb8c1ca801f43"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTQwOTYw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/452#pullrequestreview-493940960", "createdAt": "2020-09-23T00:59:08Z", "commit": {"oid": "a3659f8875224978a734c87b34cfb8c1ca801f43"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2983, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}