{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMDg3Mjk2", "number": 176, "title": "Add e2e test for fixing a BROKEN service", "bodyText": "Issue #, if available:\nDescription of changes:\nAdd an E2E test for fixing a BROKEN service.\nWhy is this change necessary:\nHow was this change tested:\nmvn clean verify\nAlso ran E2E tests locally.\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-10T22:11:31Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176", "merged": true, "mergeCommit": {"oid": "1675f3bfc3ed3dc5bbd9af10320d943d55c7db07"}, "closed": true, "closedAt": "2020-04-11T00:35:16Z", "author": {"login": "fengwang666"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWYimmAH2gAyNDAyMDg3Mjk2OmI1ZDc2MWRiYTI5MGVjM2QxYWM0NzA3ZTZmOWJlYjEwMDg2MTVkOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWahsYgFqTM5MTcxNjQxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b5d761dba290ec3d1ac4707e6f9beb1008615d93", "author": {"user": {"login": "fengwang666", "name": "Feng Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b5d761dba290ec3d1ac4707e6f9beb1008615d93", "committedDate": "2020-04-10T22:07:56Z", "message": "Add e2e test for fixing a BROKEN service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjg3MzUy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#pullrequestreview-391687352", "createdAt": "2020-04-10T22:13:48Z", "commit": {"oid": "b5d761dba290ec3d1ac4707e6f9beb1008615d93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMjoxMzo0OFrOGEHLNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMjoxMzo0OFrOGEHLNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2NTA0Nw==", "bodyText": "I assume this was for testing locally? We do want to clean.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#discussion_r406965047", "createdAt": "2020-04-10T22:13:48Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -78,8 +78,8 @@ void afterEach() {\n     @AfterAll\n     static void afterAll() {\n         // Cleanup all IoT thing resources we created\n-        Utils.cleanAllCreatedThings();\n-        Utils.cleanAllCreatedJobs();\n+        // Utils.cleanAllCreatedThings();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5d761dba290ec3d1ac4707e6f9beb1008615d93"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjg3NzA2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#pullrequestreview-391687706", "createdAt": "2020-04-10T22:15:01Z", "commit": {"oid": "b5d761dba290ec3d1ac4707e6f9beb1008615d93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMjoxNTowMlrOGEHMfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMjoxNTowMlrOGEHMfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2NTM3Mg==", "bodyText": "Should we unwrap the execution exception to determine if it is retryable or not?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#discussion_r406965372", "createdAt": "2020-04-10T22:15:02Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -56,9 +56,9 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n             kernel.mergeInNewConfig(document.getDeploymentId(), document.getTimestamp(), newConfig).get();\n             logger.atInfo().setEventType(DEPLOYMENT_TASK_EVENT_TYPE)\n                     .addKeyValue(\"deploymentId\", document.getDeploymentId()).log(\"Finish deployment task\");\n-        } catch (PackageVersionConflictException | UnexpectedPackagingException e) {\n+        } catch (PackageVersionConflictException | UnexpectedPackagingException | ExecutionException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5d761dba290ec3d1ac4707e6f9beb1008615d93"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjg4NDky", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#pullrequestreview-391688492", "createdAt": "2020-04-10T22:17:50Z", "commit": {"oid": "b5d761dba290ec3d1ac4707e6f9beb1008615d93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMjoxNzo1MFrOGEHPKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMjoxNzo1MFrOGEHPKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk2NjA1Ng==", "bodyText": "I think I have a fix here: https://github.com/aws/aws-greengrass-kernel/pull/175/files#diff-ed690837067a5ad8d1e95dbc8da15ae8R287\nMaking it return true will use break in the state machine. That way the state machine will wait for the next event instead of spinning here.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#discussion_r406966056", "createdAt": "2020-04-10T22:17:50Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -289,9 +290,13 @@ private boolean handleCurrentStateBroken(Optional<State> desiredState) {\n         // we'll transition out of BROKEN state to give it a new chance.\n         if (State.NEW.equals(desiredState.get())) {\n             updateStateAndBroadcast(State.NEW);\n-        } else {\n-            logger.atError().setEventType(\"service-broken\")\n-                    .log(\"service is broken. Deployment is needed\");\n+        }\n+        // TODO: (fengwa@) Fix this temporary hack of reducing the busy loop spinning.\n+        try {\n+            Thread.sleep(Duration.ofSeconds(10L).toMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5d761dba290ec3d1ac4707e6f9beb1008615d93"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "098abedadad9720f33750bd9a6782b3305d07fb3", "author": {"user": {"login": "fengwang666", "name": "Feng Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/098abedadad9720f33750bd9a6782b3305d07fb3", "committedDate": "2020-04-10T22:49:17Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjk3NzAz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#pullrequestreview-391697703", "createdAt": "2020-04-10T22:54:36Z", "commit": {"oid": "098abedadad9720f33750bd9a6782b3305d07fb3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d0da2e97b60ac125d847b7dfd895370bc238f4f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3d0da2e97b60ac125d847b7dfd895370bc238f4f", "committedDate": "2020-04-10T23:20:45Z", "message": "Merge branch 'master' into e2e-test-for-broken-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f23f5dbbbe488572ee613a5e5243e3e11a56f5e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2f23f5dbbbe488572ee613a5e5243e3e11a56f5e", "committedDate": "2020-04-11T00:18:23Z", "message": "Merge branch 'master' into e2e-test-for-broken-service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzE1Mzcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#pullrequestreview-391715373", "createdAt": "2020-04-11T00:19:18Z", "commit": {"oid": "2f23f5dbbbe488572ee613a5e5243e3e11a56f5e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzE2NDEy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/176#pullrequestreview-391716412", "createdAt": "2020-04-11T00:26:45Z", "commit": {"oid": "2f23f5dbbbe488572ee613a5e5243e3e11a56f5e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2107, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}