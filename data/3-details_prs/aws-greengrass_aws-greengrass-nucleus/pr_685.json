{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwOTUwMjIz", "number": 685, "title": "Synchronize access to mqtt connection, more thread safety", "bodyText": "Issue #, if available:\nDescription of changes:\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-14T03:04:37Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/685", "merged": true, "mergeCommit": {"oid": "76f34806ef1b03a98c47965212bdfc14d11fb59a"}, "closed": true, "closedAt": "2020-11-14T03:39:32Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcS5-mAFqTUzMDU0OTI0Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcTVadAFqTUzMDU1MDk4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTQ5MjQz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/685#pullrequestreview-530549243", "createdAt": "2020-11-14T03:08:44Z", "commit": {"oid": "653d3fb820f8928033d2868e0be4aaf6d2bba085"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMzowODo0NFrOHzHyAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMzowODo0NFrOHzHyAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM2NjkxMg==", "bodyText": "Shouldn't this be removed from line 216?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/685#discussion_r523366912", "createdAt": "2020-11-14T03:08:44Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/mqttclient/MqttClient.java", "diffHunk": "@@ -214,6 +217,12 @@ protected MqttClient(DeviceConfiguration deviceConfiguration,\n                     return;\n                 }\n \n+                // Only reconnect when the region changed if the proxy exists\n+                if (node.childOf(DEVICE_PARAM_AWS_REGION)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "653d3fb820f8928033d2868e0be4aaf6d2bba085"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "653d3fb820f8928033d2868e0be4aaf6d2bba085", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/653d3fb820f8928033d2868e0be4aaf6d2bba085", "committedDate": "2020-11-14T03:04:14Z", "message": "Synchronize access to mqtt connection, more thread safety"}, "afterCommit": {"oid": "b959978b483192ed05d6422201cb78f379885363", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b959978b483192ed05d6422201cb78f379885363", "committedDate": "2020-11-14T03:17:03Z", "message": "Synchronize access to mqtt connection, more thread safety"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0ebb6a6d70dc737125c75d5eec6c60e1a7e7561", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d0ebb6a6d70dc737125c75d5eec6c60e1a7e7561", "committedDate": "2020-11-14T03:23:37Z", "message": "Synchronize access to mqtt connection, more thread safety"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b959978b483192ed05d6422201cb78f379885363", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b959978b483192ed05d6422201cb78f379885363", "committedDate": "2020-11-14T03:17:03Z", "message": "Synchronize access to mqtt connection, more thread safety"}, "afterCommit": {"oid": "d0ebb6a6d70dc737125c75d5eec6c60e1a7e7561", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d0ebb6a6d70dc737125c75d5eec6c60e1a7e7561", "committedDate": "2020-11-14T03:23:37Z", "message": "Synchronize access to mqtt connection, more thread safety"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTUwMjEy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/685#pullrequestreview-530550212", "createdAt": "2020-11-14T03:24:26Z", "commit": {"oid": "b959978b483192ed05d6422201cb78f379885363"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTUwMzgx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/685#pullrequestreview-530550381", "createdAt": "2020-11-14T03:27:06Z", "commit": {"oid": "d0ebb6a6d70dc737125c75d5eec6c60e1a7e7561"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMzoyNzowNlrOHzH4eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMzoyNzowNlrOHzH4eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM2ODU2OA==", "bodyText": "Does publish need to be synchronized?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/685#discussion_r523368568", "createdAt": "2020-11-14T03:27:06Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/mqttclient/AwsIotMqttClient.java", "diffHunk": "@@ -100,31 +99,46 @@ public void onConnectionResumed(boolean sessionPresent) {\n     CompletableFuture<Integer> subscribe(String topic, QualityOfService qos) {\n         return connect().thenCompose((b) -> {\n             logger.atDebug().kv(TOPIC_KEY, topic).kv(QOS_KEY, qos.name()).log(\"Subscribing to topic\");\n-            return connection.subscribe(topic, qos).thenApply((i) -> {\n-                subscriptionTopics.put(topic, qos);\n-                return i;\n-            });\n+            synchronized (this) {\n+                throwIfNotConnected();\n+                return connection.subscribe(topic, qos).thenApply((i) -> {\n+                    subscriptionTopics.put(topic, qos);\n+                    return i;\n+                });\n+            }\n         });\n     }\n \n     CompletableFuture<Integer> unsubscribe(String topic) {\n         return connect().thenCompose((b) -> {\n             logger.atDebug().kv(TOPIC_KEY, topic).log(\"Unsubscribing from topic\");\n-            return connection.unsubscribe(topic).thenApply((i) -> {\n-                subscriptionTopics.remove(topic);\n-                return i;\n-            });\n+            synchronized (this) {\n+                throwIfNotConnected();\n+                return connection.unsubscribe(topic).thenApply((i) -> {\n+                    subscriptionTopics.remove(topic);\n+                    return i;\n+                });\n+            }\n         });\n     }\n \n     CompletableFuture<Integer> publish(MqttMessage message, QualityOfService qos, boolean retain) {\n         return connect().thenCompose((b) -> {\n             logger.atTrace().kv(TOPIC_KEY, message.getTopic()).kv(QOS_KEY, qos.name()).kv(\"retain\", retain)\n                     .log(\"Publishing message\");\n-            return connection.publish(message, qos, retain);\n+            synchronized (this) {\n+                throwIfNotConnected();\n+                return connection.publish(message, qos, retain);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0ebb6a6d70dc737125c75d5eec6c60e1a7e7561"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTUwNTIz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/685#pullrequestreview-530550523", "createdAt": "2020-11-14T03:29:33Z", "commit": {"oid": "d0ebb6a6d70dc737125c75d5eec6c60e1a7e7561"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTUwOTg0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/685#pullrequestreview-530550984", "createdAt": "2020-11-14T03:38:42Z", "commit": {"oid": "d0ebb6a6d70dc737125c75d5eec6c60e1a7e7561"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2690, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}