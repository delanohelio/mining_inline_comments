{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NjAzNzk2", "number": 305, "title": "Support kernel update deployments with restart/reboot", "bodyText": "Issue #, if available:\nDescription of changes:\n\nKernel can detect ongoing deployment on launch\nDeployment Service can pick up the information and resume the deployment task\nRelated to additional changes here #309\n\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-07-14T02:26:45Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305", "merged": true, "mergeCommit": {"oid": "65eda98110ffe48fc0c86b60734fc6e8cb4ef2fc"}, "closed": true, "closedAt": "2020-07-24T19:18:33Z", "author": {"login": "hui-yang"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0ugYogFqTQ0Nzc4MDU5OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4I-l9gFqTQ1NDU4OTg5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NzgwNTk5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#pullrequestreview-447780599", "createdAt": "2020-07-14T04:41:09Z", "commit": {"oid": "f20c237cd26eeaa3544dccb238570de10ff194cb"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTgyMTgx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#pullrequestreview-451982181", "createdAt": "2020-07-20T21:46:42Z", "commit": {"oid": "f20c237cd26eeaa3544dccb238570de10ff194cb"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMTo0Njo0MlrOG0gaFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMTo1NDoxMFrOG0gmpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMDEwMA==", "bodyText": "why subtype for type DeploymentStage?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r457710100", "createdAt": "2020-07-20T21:46:42Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/KernelUpdateDeploymentTask.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment;\n+\n+import com.aws.iot.evergreen.deployment.exceptions.ServiceUpdateException;\n+import com.aws.iot.evergreen.deployment.model.BaseDeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.Deployment;\n+import com.aws.iot.evergreen.deployment.model.DeploymentResult;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import lombok.AllArgsConstructor;\n+\n+import static com.aws.iot.evergreen.deployment.model.Deployment.DeploymentStage.KERNEL_ACTIVATION;\n+import static com.aws.iot.evergreen.deployment.model.Deployment.DeploymentStage.KERNEL_ROLLBACK;\n+\n+@AllArgsConstructor\n+public class KernelUpdateDeploymentTask implements BaseDeploymentTask {\n+    private Kernel kernel;\n+    private final Logger logger;\n+    private Deployment deployment;\n+\n+    @Override\n+    public DeploymentResult call() {\n+        Deployment.DeploymentStage subtype = deployment.getDeploymentStage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f20c237cd26eeaa3544dccb238570de10ff194cb"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMjI4Nw==", "bodyText": "naming - BaseXXX implies inheritance. For polymorphism, I'd name the interface as \"DeploymentTask\" directly and have different \"DeploymentTask\" such as \"UpdateKernelDeploymentTask\" vs \"ComponentDeploymentTask\".", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r457712287", "createdAt": "2020-07-20T21:51:37Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/BaseDeploymentTask.java", "diffHunk": "@@ -0,0 +1,16 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment.model;\n+\n+import com.aws.iot.evergreen.deployment.exceptions.NonRetryableDeploymentTaskFailureException;\n+import com.aws.iot.evergreen.deployment.exceptions.RetryableDeploymentTaskFailureException;\n+\n+import java.util.concurrent.Callable;\n+\n+public interface BaseDeploymentTask extends Callable<DeploymentResult> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f20c237cd26eeaa3544dccb238570de10ff194cb"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMzMxOQ==", "bodyText": "Some comments to indicate the reason for each stage?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r457713319", "createdAt": "2020-07-20T21:54:10Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "diffHunk": "@@ -45,9 +50,31 @@ public Deployment(DeploymentType deploymentType, String id, boolean isCancelled)\n         this.deploymentType = deploymentType;\n         this.id = id;\n         this.isCancelled = isCancelled;\n+        this.deploymentStage = DeploymentStage.DEFAULT;\n+    }\n+\n+    /**\n+     * Constructor for resuming deployments after Kernel restarts.\n+     *\n+     * @param deploymentDetails deployment document object\n+     * @param deploymentType deployment type\n+     * @param id deployment id\n+     * @param deploymentStage deployment stage, only applicable to deployments which require Kernel restart\n+     */\n+    public Deployment(DeploymentDocument deploymentDetails, DeploymentType deploymentType, String id,\n+                      DeploymentStage deploymentStage) {\n+        this.deploymentDocumentObj = deploymentDetails;\n+        this.deploymentType = deploymentType;\n+        this.id = id;\n+        this.deploymentStage = deploymentStage;\n     }\n \n     public enum DeploymentType {\n         IOT_JOBS, LOCAL\n     }\n+\n+    public enum DeploymentStage {\n+        DEFAULT, BOOTSTRAP, KERNEL_ACTIVATION, KERNEL_ROLLBACK", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f20c237cd26eeaa3544dccb238570de10ff194cb"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e43798b2d18621f86d245794bf53b890332f862", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2e43798b2d18621f86d245794bf53b890332f862", "committedDate": "2020-07-22T20:08:54Z", "message": "Support kernel update deployments with restart/reboot"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f20c237cd26eeaa3544dccb238570de10ff194cb", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f20c237cd26eeaa3544dccb238570de10ff194cb", "committedDate": "2020-07-14T02:24:31Z", "message": "Support kernel update deployments with restart/reboot"}, "afterCommit": {"oid": "c0ca24027d57145a2c8afa6dc707976a5eee550e", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c0ca24027d57145a2c8afa6dc707976a5eee550e", "committedDate": "2020-07-22T20:53:19Z", "message": "Add readme and address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0ca24027d57145a2c8afa6dc707976a5eee550e", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c0ca24027d57145a2c8afa6dc707976a5eee550e", "committedDate": "2020-07-22T20:53:19Z", "message": "Add readme and address comments"}, "afterCommit": {"oid": "a57973c7728e9560b6592c3abf8342aa0132ac39", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a57973c7728e9560b6592c3abf8342aa0132ac39", "committedDate": "2020-07-22T21:04:56Z", "message": "Add readme and address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a57973c7728e9560b6592c3abf8342aa0132ac39", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a57973c7728e9560b6592c3abf8342aa0132ac39", "committedDate": "2020-07-22T21:04:56Z", "message": "Add readme and address comments"}, "afterCommit": {"oid": "809f071783929a50dec9a3f1163611229a312443", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/809f071783929a50dec9a3f1163611229a312443", "committedDate": "2020-07-22T21:24:04Z", "message": "Add readme and address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03d5eb663971d7fa44617bda8e357eae2bf96b0a", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/03d5eb663971d7fa44617bda8e357eae2bf96b0a", "committedDate": "2020-07-22T21:26:31Z", "message": "Add readme and address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "809f071783929a50dec9a3f1163611229a312443", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/809f071783929a50dec9a3f1163611229a312443", "committedDate": "2020-07-22T21:24:04Z", "message": "Add readme and address comments"}, "afterCommit": {"oid": "03d5eb663971d7fa44617bda8e357eae2bf96b0a", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/03d5eb663971d7fa44617bda8e357eae2bf96b0a", "committedDate": "2020-07-22T21:26:31Z", "message": "Add readme and address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzg3MzM4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#pullrequestreview-453787338", "createdAt": "2020-07-23T01:26:36Z", "commit": {"oid": "03d5eb663971d7fa44617bda8e357eae2bf96b0a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c784db32487cf45eaa1ebc5ba635328be45ad40", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7c784db32487cf45eaa1ebc5ba635328be45ad40", "committedDate": "2020-07-23T22:23:15Z", "message": "Merge branch 'master' into kernel-update-deployment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTg5ODk5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#pullrequestreview-454589899", "createdAt": "2020-07-24T01:16:30Z", "commit": {"oid": "7c784db32487cf45eaa1ebc5ba635328be45ad40"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMToxNjozMFrOG2gkfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNTowMjowMlrOG2jMPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwOTkxNw==", "bodyText": "If the task isn't performed yet (eg in the wait for safe to update stage), will this disallow cancelling such tasks?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r459809917", "createdAt": "2020-07-24T01:16:30Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -281,11 +283,13 @@ private void finishCurrentDeployment() throws InterruptedException {\n     @SuppressWarnings(\"PMD.NullAssignment\")\n     private void cancelCurrentDeployment() {\n         if (currentDeploymentTaskMetadata.getDeploymentResultFuture() != null) {\n-            if (currentDeploymentTaskMetadata.getDeploymentResultFuture().isDone()) {\n-                logger.atInfo().log(\"Deployment already finished processing, cannot cancel now\");\n+            if (currentDeploymentTaskMetadata.getDeploymentResultFuture().isDone()\n+                    || !currentDeploymentTaskMetadata.isCancellable()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c784db32487cf45eaa1ebc5ba635328be45ad40"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg1Mjg2Mw==", "bodyText": "Having both Obj and string looks confusing to me", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r459852863", "createdAt": "2020-07-24T05:02:02Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "diffHunk": "@@ -7,18 +7,22 @@\n \n import lombok.EqualsAndHashCode;\n import lombok.Getter;\n+import lombok.Setter;\n import lombok.ToString;\n \n @Getter\n @EqualsAndHashCode(onlyExplicitlyIncluded = true)\n @ToString\n public class Deployment {\n+    @Setter\n+    private DeploymentDocument deploymentDocumentObj;\n     private String deploymentDocument;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c784db32487cf45eaa1ebc5ba635328be45ad40"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2874, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}