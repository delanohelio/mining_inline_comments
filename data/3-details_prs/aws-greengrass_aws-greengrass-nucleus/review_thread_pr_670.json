{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMDUxMDgy", "number": 670, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODoxNTo1N1rOE4Sb7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoxMDoyNFrOE4X5zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDU3NzczOnYy", "diffSide": "LEFT", "path": "aws.greengrass.Nucleus.yaml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODoxNTo1N1rOHyHqIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODoxNTo1N1rOHyHqIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMxNjMyMA==", "bodyText": "Noticed inconsistencies between the naming here and the actual naming used in the DeviceConfiguration, so it's better to remove these from here because we don't always remember to change it here if it changes in the code, this was here just so if customers see this recipe they know what things they can change", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522316320", "createdAt": "2020-11-12T18:15:57Z", "author": {"login": "shaguptashaikh"}, "path": "aws.greengrass.Nucleus.yaml", "diffHunk": "@@ -8,18 +8,6 @@ ComponentVersion: '1.0.0'\n ComponentConfiguration:\n   DefaultConfiguration:\n     jvmOptions: -Xms512m -Xmx512m\n-    iotDataEndpoint: \"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739da653a2fc7d86c2fb6d596a0a9f542bb5553b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDY2OTg5OnYy", "diffSide": "LEFT", "path": "aws.greengrass.Nucleus.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODozOToyNVrOHyIijg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoyMTowNVrOHyQ4fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMDc2Ng==", "bodyText": "by removing all of these, the console won't be able to show any configuration, we'll have to just rely on our documentation to explain all the options. Is that desirable?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522330766", "createdAt": "2020-11-12T18:39:25Z", "author": {"login": "MikeDombo"}, "path": "aws.greengrass.Nucleus.yaml", "diffHunk": "@@ -8,18 +8,6 @@ ComponentVersion: '1.0.0'\n ComponentConfiguration:\n   DefaultConfiguration:\n     jvmOptions: -Xms512m -Xmx512m\n-    iotDataEndpoint: \"\"\n-    iotCredEndpoint: \"\"\n-    privateKeyPath: \"\"\n-    certificateFilePath: \"\"\n-    rootCaPath: \"\"\n-    awsRegion: \"\"\n-    iotRoleAlias: \"\"\n-    mqtt: {}\n-    networkProxy: {}\n-    runWithDefault: {}\n-    deploymentPollingFrequency: 15L\n-    componentStoreMaxSize: 10_000_000_000L", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75ef437de2efa68c25c4d94f8fa3177936842a98"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ2NzQ1Mg==", "bodyText": "If it helps console highlight the config it then it should stay", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522467452", "createdAt": "2020-11-12T22:21:05Z", "author": {"login": "shaguptashaikh"}, "path": "aws.greengrass.Nucleus.yaml", "diffHunk": "@@ -8,18 +8,6 @@ ComponentVersion: '1.0.0'\n ComponentConfiguration:\n   DefaultConfiguration:\n     jvmOptions: -Xms512m -Xmx512m\n-    iotDataEndpoint: \"\"\n-    iotCredEndpoint: \"\"\n-    privateKeyPath: \"\"\n-    certificateFilePath: \"\"\n-    rootCaPath: \"\"\n-    awsRegion: \"\"\n-    iotRoleAlias: \"\"\n-    mqtt: {}\n-    networkProxy: {}\n-    runWithDefault: {}\n-    deploymentPollingFrequency: 15L\n-    componentStoreMaxSize: 10_000_000_000L", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMDc2Ng=="}, "originalCommit": {"oid": "75ef437de2efa68c25c4d94f8fa3177936842a98"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDY3OTM2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MTozOVrOHyIoMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MTozOVrOHyIoMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMjIwOQ==", "bodyText": "let's get rid of this context crap. We can just use the device configuration or any of the many other methods to get the URL", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522332209", "createdAt": "2020-11-12T18:41:39Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -24,54 +26,75 @@\n import org.apache.http.conn.ssl.SSLConnectionSocketFactory;\n \n import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n import java.security.GeneralSecurityException;\n import java.security.KeyStore;\n import java.security.PrivateKey;\n import java.security.cert.Certificate;\n import java.security.cert.X509Certificate;\n import java.util.List;\n import javax.inject.Inject;\n-import javax.inject.Named;\n import javax.net.ssl.KeyManager;\n import javax.net.ssl.KeyManagerFactory;\n import javax.net.ssl.SSLContext;\n import javax.net.ssl.TrustManager;\n import javax.net.ssl.TrustManagerFactory;\n import javax.security.auth.x500.X500Principal;\n \n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_AWS_REGION;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_ROOT_CA_PATH;\n+\n @Getter\n @SuppressWarnings(\"PMD.ConfusingTernary\")\n public class GreengrassComponentServiceClientFactory {\n \n     public static final String CONTEXT_COMPONENT_SERVICE_ENDPOINT = \"greengrassServiceEndpoint\";\n     private static final Logger logger = LogManager.getLogger(GreengrassComponentServiceClientFactory.class);\n \n-    private final AWSEvergreen cmsClient;\n+    private AWSEvergreen cmsClient;\n \n     /**\n      * Constructor with custom endpoint/region configuration.\n      *\n-     * @param greengrassServiceEndpoint String containing service endpoint\n+     * @param context Context object\n      * @param deviceConfiguration       Device configuration\n      */\n     @Inject\n-    public GreengrassComponentServiceClientFactory(\n-            @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration) {\n+    public GreengrassComponentServiceClientFactory(Context context, DeviceConfiguration deviceConfiguration) {\n+        configureClient((String) context.getvIfExists(CONTEXT_COMPONENT_SERVICE_ENDPOINT).get(), deviceConfiguration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75ef437de2efa68c25c4d94f8fa3177936842a98"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDY4NTYxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MzozMlrOHyIscA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MzozMlrOHyIscA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMzI5Ng==", "bodyText": "let's get rid of this.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522333296", "createdAt": "2020-11-12T18:43:32Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java", "diffHunk": "@@ -554,10 +555,14 @@ private void setupCloudEndpoint() {\n             throw new RuntimeException(e);\n         }\n \n-        String region = Coerce.toString(deviceConfiguration.getAWSRegion());\n-        String endpoint = RegionUtils.getGreengrassDataPlaneEndpoint(region, stage);\n-        logger.atInfo().log(\"Configured to use Greengrass endpoint: {}\", endpoint);\n-        context.put(CONTEXT_COMPONENT_SERVICE_ENDPOINT, endpoint);\n+        deviceConfiguration.getAWSRegion().subscribe((what, node) -> {\n+            String region = Coerce.toString(node);\n+            if (Utils.isNotEmpty(region)) {\n+                String endpoint = RegionUtils.getGreengrassDataPlaneEndpoint(region, stage);\n+                logger.atInfo().log(\"Configured to use Greengrass endpoint: {}\", endpoint);\n+                context.put(CONTEXT_COMPONENT_SERVICE_ENDPOINT, endpoint);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75ef437de2efa68c25c4d94f8fa3177936842a98"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NTQ3MzQzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoxMDoyNFrOHyQS4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoyNToxMlrOHyRFhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ1NzgyNQ==", "bodyText": "Why || of validString? Is this trying to check if any of these settings changed and then validate those?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522457825", "createdAt": "2020-11-12T22:10:24Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -11,70 +11,93 @@\n import com.amazonaws.client.builder.AwsClientBuilder.EndpointConfiguration;\n import com.amazonaws.services.evergreen.AWSEvergreen;\n import com.amazonaws.services.evergreen.AWSEvergreenClientBuilder;\n+import com.aws.greengrass.config.Node;\n import com.aws.greengrass.deployment.DeviceConfiguration;\n import com.aws.greengrass.logging.api.Logger;\n import com.aws.greengrass.logging.impl.LogManager;\n import com.aws.greengrass.util.Coerce;\n import com.aws.greengrass.util.EncryptionUtils;\n+import com.aws.greengrass.util.IotSdkClientFactory;\n import com.aws.greengrass.util.ProxyUtils;\n+import com.aws.greengrass.util.RegionUtils;\n import com.aws.greengrass.util.Utils;\n+import com.aws.greengrass.util.exceptions.InvalidEnvironmentStageException;\n import com.aws.greengrass.util.exceptions.TLSAuthException;\n import lombok.Getter;\n import org.apache.http.conn.ssl.NoopHostnameVerifier;\n import org.apache.http.conn.ssl.SSLConnectionSocketFactory;\n \n import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n import java.security.GeneralSecurityException;\n import java.security.KeyStore;\n import java.security.PrivateKey;\n import java.security.cert.Certificate;\n import java.security.cert.X509Certificate;\n import java.util.List;\n import javax.inject.Inject;\n-import javax.inject.Named;\n import javax.net.ssl.KeyManager;\n import javax.net.ssl.KeyManagerFactory;\n import javax.net.ssl.SSLContext;\n import javax.net.ssl.TrustManager;\n import javax.net.ssl.TrustManagerFactory;\n import javax.security.auth.x500.X500Principal;\n \n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_AWS_REGION;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_ROOT_CA_PATH;\n+\n @Getter\n @SuppressWarnings(\"PMD.ConfusingTernary\")\n public class GreengrassComponentServiceClientFactory {\n \n-    public static final String CONTEXT_COMPONENT_SERVICE_ENDPOINT = \"greengrassServiceEndpoint\";\n     private static final Logger logger = LogManager.getLogger(GreengrassComponentServiceClientFactory.class);\n \n-    private final AWSEvergreen cmsClient;\n+    private AWSEvergreen cmsClient;\n \n     /**\n      * Constructor with custom endpoint/region configuration.\n      *\n-     * @param greengrassServiceEndpoint String containing service endpoint\n      * @param deviceConfiguration       Device configuration\n      */\n     @Inject\n-    public GreengrassComponentServiceClientFactory(\n-            @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration) {\n+    public GreengrassComponentServiceClientFactory(DeviceConfiguration deviceConfiguration) {\n+        configureClient(deviceConfiguration);\n+        deviceConfiguration.onAnyChange((what, node) -> {\n+            if (validString(node, DEVICE_PARAM_AWS_REGION) || validPath(node, DEVICE_PARAM_ROOT_CA_PATH) || validPath(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d2c5346522d345e4c6a0339285fd24cbd5dfeee"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3MDc5MQ==", "bodyText": "Sort of, our integ tests sometimes set these to empty strings or strings which are invalid paths and this subscriber gets invoked, this is not intended to be full fledged validation though because I think that will require much more effort", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522470791", "createdAt": "2020-11-12T22:25:12Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -11,70 +11,93 @@\n import com.amazonaws.client.builder.AwsClientBuilder.EndpointConfiguration;\n import com.amazonaws.services.evergreen.AWSEvergreen;\n import com.amazonaws.services.evergreen.AWSEvergreenClientBuilder;\n+import com.aws.greengrass.config.Node;\n import com.aws.greengrass.deployment.DeviceConfiguration;\n import com.aws.greengrass.logging.api.Logger;\n import com.aws.greengrass.logging.impl.LogManager;\n import com.aws.greengrass.util.Coerce;\n import com.aws.greengrass.util.EncryptionUtils;\n+import com.aws.greengrass.util.IotSdkClientFactory;\n import com.aws.greengrass.util.ProxyUtils;\n+import com.aws.greengrass.util.RegionUtils;\n import com.aws.greengrass.util.Utils;\n+import com.aws.greengrass.util.exceptions.InvalidEnvironmentStageException;\n import com.aws.greengrass.util.exceptions.TLSAuthException;\n import lombok.Getter;\n import org.apache.http.conn.ssl.NoopHostnameVerifier;\n import org.apache.http.conn.ssl.SSLConnectionSocketFactory;\n \n import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n import java.security.GeneralSecurityException;\n import java.security.KeyStore;\n import java.security.PrivateKey;\n import java.security.cert.Certificate;\n import java.security.cert.X509Certificate;\n import java.util.List;\n import javax.inject.Inject;\n-import javax.inject.Named;\n import javax.net.ssl.KeyManager;\n import javax.net.ssl.KeyManagerFactory;\n import javax.net.ssl.SSLContext;\n import javax.net.ssl.TrustManager;\n import javax.net.ssl.TrustManagerFactory;\n import javax.security.auth.x500.X500Principal;\n \n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_AWS_REGION;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_ROOT_CA_PATH;\n+\n @Getter\n @SuppressWarnings(\"PMD.ConfusingTernary\")\n public class GreengrassComponentServiceClientFactory {\n \n-    public static final String CONTEXT_COMPONENT_SERVICE_ENDPOINT = \"greengrassServiceEndpoint\";\n     private static final Logger logger = LogManager.getLogger(GreengrassComponentServiceClientFactory.class);\n \n-    private final AWSEvergreen cmsClient;\n+    private AWSEvergreen cmsClient;\n \n     /**\n      * Constructor with custom endpoint/region configuration.\n      *\n-     * @param greengrassServiceEndpoint String containing service endpoint\n      * @param deviceConfiguration       Device configuration\n      */\n     @Inject\n-    public GreengrassComponentServiceClientFactory(\n-            @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration) {\n+    public GreengrassComponentServiceClientFactory(DeviceConfiguration deviceConfiguration) {\n+        configureClient(deviceConfiguration);\n+        deviceConfiguration.onAnyChange((what, node) -> {\n+            if (validString(node, DEVICE_PARAM_AWS_REGION) || validPath(node, DEVICE_PARAM_ROOT_CA_PATH) || validPath(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ1NzgyNQ=="}, "originalCommit": {"oid": "5d2c5346522d345e4c6a0339285fd24cbd5dfeee"}, "originalPosition": 66}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 230, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}