{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MjQ5MDIw", "number": 427, "title": "Add TES role policy creation in easysetup, remove cmsClient", "bodyText": "Issue #, if available:\nDescription of changes:\nAdd command line argument for creating and attaching IAM policy for TES.\nRemove unused cmsClient from DeviceProvisioningHelper\nWhy is this change necessary:\nTo provide easy way to create and attach policy to IAM role for TES\nHow was this change tested:\nRan on my laptop and verified the required items are created from AWS console.\nEvergreenSetupTest updated.\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-10T19:31:10Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427", "merged": true, "mergeCommit": {"oid": "6d75f68e85e033bd4ebe0f953b1b1d84cef5db60"}, "closed": true, "closedAt": "2020-09-15T01:15:36Z", "author": {"login": "tilo-chen"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHmC2wgFqTQ4NjI1MDMyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI9T0QgFqTQ4ODI1NjA4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MjUwMzI1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#pullrequestreview-486250325", "createdAt": "2020-09-10T19:34:13Z", "commit": {"oid": "301480c1750a980632dd8ee082dcb901e7afef1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxOTozNDoxM1rOHQC62Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxOTozNDoxM1rOHQC62Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU4NzA5Nw==", "bodyText": "Recommendation generated by Amazon CodeGuru Reviewer. Leave feedback on this recommendation by replying to the comment or by reacting to the comment using emoji.\nProblem: While wrapping the caught exception into a custom one, information about the caught exception is being lost, including information about the stack trace of the exception.\nFix: If the caught exception object does not contain sensitive information, consider passing it as the \"rootCause\" or inner exception parameter to the constructor of the new exception before throwing the new exception. (Note that not all exception constructors support inner exceptions. Use a wrapper exception that supports inner exceptions.)\nLearn more", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#discussion_r486587097", "createdAt": "2020-09-10T19:34:13Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/EvergreenSetup.java", "diffHunk": "@@ -228,6 +240,19 @@ void parseArgs() {\n                 case TES_ROLE_NAME_ARG_SHORT:\n                     this.tesRoleName = getArg();\n                     break;\n+                case TES_ROLE_POLICY_NAME_ARG:\n+                case TES_ROLE_POLICY_NAME_ARG_SHORT:\n+                    this.tesRolePolicyName = getArg();\n+                    break;\n+                case TES_ROLE_POLICY_DOC_ARG:\n+                case TES_ROLE_POLICY_DOC_ARG_SHORT:\n+                    try {\n+                        this.tesRolePolicyDoc = Utils.loadParamMaybeFile(getArg());\n+                    } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "301480c1750a980632dd8ee082dcb901e7afef1a"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41931239a82175f494b844781cf1054144eedf53", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/41931239a82175f494b844781cf1054144eedf53", "committedDate": "2020-09-10T20:32:39Z", "message": "add tes role policy creation in easysetup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "301480c1750a980632dd8ee082dcb901e7afef1a", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/301480c1750a980632dd8ee082dcb901e7afef1a", "committedDate": "2020-09-10T19:29:24Z", "message": "update test"}, "afterCommit": {"oid": "41931239a82175f494b844781cf1054144eedf53", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/41931239a82175f494b844781cf1054144eedf53", "committedDate": "2020-09-10T20:32:39Z", "message": "add tes role policy creation in easysetup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mjk1NTMw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#pullrequestreview-486295530", "createdAt": "2020-09-10T20:43:11Z", "commit": {"oid": "41931239a82175f494b844781cf1054144eedf53"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDo0MzoxMlrOHQFC1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDo0MzoxMlrOHQFC1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYyMTkwOQ==", "bodyText": "It might be better to not fail the setup for this, instead we could just log something like this and move on - Could not create role policy because it already exists, please attach it to the IAM role if it isn't attached already.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#discussion_r486621909", "createdAt": "2020-09-10T20:43:12Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -300,6 +294,33 @@ public void setupIoTRoleForTes(String roleName, String roleAliasName, String cer\n         iotClient.attachPolicy(attachPolicyRequest);\n     }\n \n+    /**\n+     * Creates IAM policy using specified name and document. Attach the policy to given IAM role name.\n+     *\n+     * @param roleName           name of target role\n+     * @param rolePolicyName     name of policy to create and attach\n+     * @param rolePolicyDocument document of policy to create and attach\n+     * @return ARN of created policy\n+     */\n+    public String createAndAttachRolePolicy(String roleName, String rolePolicyName, String rolePolicyDocument) {\n+        String tesRolePolicyArn;\n+        try {\n+            CreatePolicyResponse createPolicyResponse = iamClient.createPolicy(\n+                    software.amazon.awssdk.services.iam.model.CreatePolicyRequest.builder().policyName(rolePolicyName)\n+                            .policyDocument(rolePolicyDocument).build());\n+            tesRolePolicyArn = createPolicyResponse.policy().arn();\n+            outStream.printf(\"IAM role policy for TES \\\"%s\\\" created%n\", rolePolicyName);\n+        } catch (EntityAlreadyExistsException e) {\n+            // TODO get and reuse the policy. non trivial because we can only get IAM policy by ARN\n+            throw new RuntimeException(String.format(\"TES role policy named %s already exists\", rolePolicyName), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41931239a82175f494b844781cf1054144eedf53"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mjk2MzUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#pullrequestreview-486296353", "createdAt": "2020-09-10T20:44:25Z", "commit": {"oid": "41931239a82175f494b844781cf1054144eedf53"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDo0NDoyNVrOHQFFUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDo0NDoyNVrOHQFFUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYyMjU0Nw==", "bodyText": "Do we still need this?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#discussion_r486622547", "createdAt": "2020-09-10T20:44:25Z", "author": {"login": "shaguptashaikh"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -402,24 +399,17 @@ protected void setupTesRoleAndAlias() throws InterruptedException, ServiceLoadEx\n         try {\n             deviceProvisioningHelper\n                     .setupIoTRoleForTes(TES_ROLE_NAME, TES_ROLE_ALIAS_NAME, thingInfo.getCertificateArn());\n+            tesRolePolicyArn = deviceProvisioningHelper\n+                    .createAndAttachRolePolicy(TES_ROLE_NAME, TES_ROLE_POLICY_NAME, TES_ROLE_POLICY_DOCUMENT);\n             deviceProvisioningHelper.updateKernelConfigWithTesRoleInfo(kernel, TES_ROLE_ALIAS_NAME);\n-\n-            CreatePolicyResponse createPolicyResponse = iamClient.createPolicy(\n-                    CreatePolicyRequest.builder().policyName(TES_ROLE_POLICY_NAME)\n-                            .policyDocument(TES_ROLE_POLICY_DOCUMENT)\n-                            .description(\"Defines permissions to access AWS services for E2E test device TES role\")\n-                            .build());\n-            tesRolePolicyArn = createPolicyResponse.policy().arn();\n-            iamClient.attachRolePolicy(AttachRolePolicyRequest.builder().roleName(TES_ROLE_NAME)\n-                    .policyArn(tesRolePolicyArn).build());\n         } catch (EntityAlreadyExistsException e) {\n             // No-op if resources already exist\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41931239a82175f494b844781cf1054144eedf53"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0decbc45b13734ef16fe9b6f977e501f0f73d57", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e0decbc45b13734ef16fe9b6f977e501f0f73d57", "committedDate": "2020-09-10T21:22:17Z", "message": "make policy arn optional. remove unused"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzIxMzIw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#pullrequestreview-486321320", "createdAt": "2020-09-10T21:24:51Z", "commit": {"oid": "e0decbc45b13734ef16fe9b6f977e501f0f73d57"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "215ae8b3ee8148b751ad9cec16627228790b4b84", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/215ae8b3ee8148b751ad9cec16627228790b4b84", "committedDate": "2020-09-11T18:03:42Z", "message": "Merge branch 'master' into easysetup-create-policy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDI3NTc0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#pullrequestreview-487027574", "createdAt": "2020-09-11T18:23:15Z", "commit": {"oid": "215ae8b3ee8148b751ad9cec16627228790b4b84"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODoyMzoxNVrOHQpPNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODoyMzoxNVrOHQpPNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIxNDkwMw==", "bodyText": "is this clean up order ok? as deleteRole happens before detachRolePolicy?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#discussion_r487214903", "createdAt": "2020-09-11T18:23:15Z", "author": {"login": "hui-yang"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -429,9 +415,12 @@ protected void setupTesRoleAndAlias() throws InterruptedException, ServiceLoadEx\n     protected static void cleanUpTesRoleAndAlias() {\n         try {\n             iotClient.deleteRoleAlias(DeleteRoleAliasRequest.builder().roleAlias(TES_ROLE_ALIAS_NAME).build());\n-            iamClient.detachRolePolicy(DetachRolePolicyRequest.builder().roleName(TES_ROLE_NAME).policyArn(tesRolePolicyArn).build());\n             iamClient.deleteRole(DeleteRoleRequest.builder().roleName(TES_ROLE_NAME).build());\n-            iamClient.deletePolicy(DeletePolicyRequest.builder().policyArn(tesRolePolicyArn).build());\n+\n+            if (tesRolePolicyArn.isPresent()) {\n+                iamClient.detachRolePolicy(DetachRolePolicyRequest.builder().roleName(TES_ROLE_NAME).policyArn(tesRolePolicyArn.get()).build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "215ae8b3ee8148b751ad9cec16627228790b4b84"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ea68608153e781a3709a41e925f8aec901b35a8", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ea68608153e781a3709a41e925f8aec901b35a8", "committedDate": "2020-09-11T18:39:00Z", "message": "fix cleanup order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDQyNzk5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#pullrequestreview-487042799", "createdAt": "2020-09-11T18:47:59Z", "commit": {"oid": "2ea68608153e781a3709a41e925f8aec901b35a8"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDg4ODQ0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#pullrequestreview-487088844", "createdAt": "2020-09-11T20:00:50Z", "commit": {"oid": "2ea68608153e781a3709a41e925f8aec901b35a8"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0af30c9582885b92ff715c96ffc5201b14a31ecf", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0af30c9582885b92ff715c96ffc5201b14a31ecf", "committedDate": "2020-09-14T20:38:03Z", "message": "Merge branch 'master' into easysetup-create-policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6a8fb54fd2de435899dcf495b2c87b68351caa0", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6a8fb54fd2de435899dcf495b2c87b68351caa0", "committedDate": "2020-09-14T23:25:34Z", "message": "fix e2e test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43a8e7aa6164af7096e2ffe990d6823ac19c836e", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/43a8e7aa6164af7096e2ffe990d6823ac19c836e", "committedDate": "2020-09-14T23:49:16Z", "message": "Merge branch 'master' into easysetup-create-policy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjUyNzE2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#pullrequestreview-488252716", "createdAt": "2020-09-15T01:03:10Z", "commit": {"oid": "43a8e7aa6164af7096e2ffe990d6823ac19c836e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjU2MDg4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/427#pullrequestreview-488256088", "createdAt": "2020-09-15T01:14:29Z", "commit": {"oid": "43a8e7aa6164af7096e2ffe990d6823ac19c836e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3287, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}