{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3OTQyNDkz", "number": 643, "title": "Setup script", "bodyText": "Issue #, if available:\nDescription of changes:\nChanges for #610 that had to be reverted for breaking UATs and some fixes in addition to fix UAT cases\nWhy is this change necessary:\nHow was this change tested:\nSetup works & Component-34-T1,T2 Deployment-1,2,3,12 UATs pass on linux\nUATs that require privileges fail both on the mac and dev-desktop due to known issue\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-09T18:05:57Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643", "merged": true, "mergeCommit": {"oid": "c3217e5d41a909e5fad44f64fe627980dd33dae0"}, "closed": true, "closedAt": "2020-11-10T03:36:22Z", "author": {"login": "shaguptashaikh"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda40FBAFqTUyNjUyMTkxMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbALDmAH2gAyNTE3OTQyNDkzOjI4NzRlMGJmNTBlZTAwZTdhYTMzNjkzZTUwZTE1YWIxNjhkNGYyN2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTIxOTEw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#pullrequestreview-526521910", "createdAt": "2020-11-09T18:10:50Z", "commit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/44ef77988dd44c9ef4c32882f9b8aca130ed463b", "committedDate": "2020-11-09T18:03:51Z", "message": "Fixes for user and group handling in setup"}, "afterCommit": {"oid": "02a0a5cf10c2dd1fdbd69897027569ea3d94d7e9", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/02a0a5cf10c2dd1fdbd69897027569ea3d94d7e9", "committedDate": "2020-11-09T18:18:44Z", "message": "Fixes for user and group handling in setup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTIyMzkw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#pullrequestreview-526522390", "createdAt": "2020-11-09T18:11:28Z", "commit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoxMToyOVrOHv7T9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoxNDoyOVrOHv7akw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjg4Nw==", "bodyText": "can't you just use Exec.sh here?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520016887", "createdAt": "2020-11-09T18:11:29Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java", "diffHunk": "@@ -324,6 +325,21 @@ public UnixRunWithGenerator getRunWithGenerator() {\n         return runWithGenerator;\n     }\n \n+    @Override\n+    public void createUser(String user) throws IOException, InterruptedException {\n+        runCmd(\"useradd -r -m \" + user, o -> {}, \"Failed to create user\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNzQ1Nw==", "bodyText": "you can combine this into one if statement, or immediately return if not the super user instead of having nested ifs", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520017457", "createdAt": "2020-11-09T18:12:26Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/easysetup/GreengrassSetup.java", "diffHunk": "@@ -393,31 +344,66 @@ private String getArg() {\n     void provision(Kernel kernel) throws IOException, DeviceConfigurationException {\n         outStream.printf(\"Provisioning AWS IoT resources for the device with IoT Thing Name: [%s]...%n\", thingName);\n         final ThingInfo thingInfo =\n-                deviceProvisioningHelper.createThing(deviceProvisioningHelper.getIotClient(), policyName, thingName);\n+                deviceProvisioningHelper.createThing(deviceProvisioningHelper.getIotClient(), thingName);\n         outStream.printf(\"Successfully provisioned AWS IoT resources for the device with IoT Thing Name: [%s]!%n\",\n                 thingName);\n         if (!Utils.isEmpty(thingGroupName)) {\n             outStream.printf(\"Adding IoT Thing [%s] into Thing Group: [%s]...%n\", thingName, thingGroupName);\n-                deviceProvisioningHelper.addThingToGroup(deviceProvisioningHelper.getIotClient(), thingName,\n-                        thingGroupName);\n+            deviceProvisioningHelper\n+                    .addThingToGroup(deviceProvisioningHelper.getIotClient(), thingName, thingGroupName);\n             outStream.printf(\"Successfully added Thing into Thing Group: [%s]%n\", thingGroupName);\n         }\n-\n-        // TODO: [P41215965]: setupTes should not be an arg anymore since role alias is required, need to remove\n-        //  this arg and always pass either user specified or a default role alias\n-        if (setupTes) {\n-            outStream.println(\"Setting up resources for TokenExchangeService...\");\n-            deviceProvisioningHelper.setupIoTRoleForTes(tesRoleName, tesRoleAliasName, thingInfo.getCertificateArn());\n-            if (tesRolePolicyName != null && tesRolePolicyDoc != null) {\n-                deviceProvisioningHelper.createAndAttachRolePolicy(tesRoleName, tesRolePolicyName, tesRolePolicyDoc);\n-            }\n-        }\n-        outStream.println(\"Configuring kernel with provisioned resource details...\");\n+        outStream.printf(\"Setting up resources for %s ... %n\", TokenExchangeService.TOKEN_EXCHANGE_SERVICE_TOPICS);\n+        deviceProvisioningHelper.setupIoTRoleForTes(tesRoleName, tesRoleAliasName, thingInfo.getCertificateArn());\n+        deviceProvisioningHelper.createAndAttachRolePolicy(tesRoleName);\n+        outStream.println(\"Configuring Nucleus with provisioned resource details...\");\n         deviceProvisioningHelper.updateKernelConfigWithIotConfiguration(kernel, thingInfo, awsRegion, tesRoleAliasName);\n         outStream.println(\"Successfully configured kernel with provisioned resource details!\");\n+        if (deployDevTools) {\n+            deviceProvisioningHelper.createInitialDeploymentIfNeeded(thingInfo, thingGroupName);\n+        }\n \n     }\n \n+    @SuppressWarnings(\"PMD.PreserveStackTrace\")\n+    private void setComponentDefaultUserAndGroup() {\n+        try {\n+            Platform platform = Platform.getInstance();\n+            // If not super user and default user option is not provided, the current user will be used\n+            // as the default user so we do not need to create anything here\n+            if (platform.lookupCurrentUser().isSuperUser()) {\n+                if (Utils.isEmpty(defaultUser) || GGC_USER.equals(defaultUser)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "originalPosition": 315}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxODU3OQ==", "bodyText": "can't you just use Exec.sh here?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520018579", "createdAt": "2020-11-09T18:14:29Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/util/platforms/unix/DarwinPlatform.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util.platforms.unix;\n+\n+import java.io.IOException;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class DarwinPlatform extends UnixPlatform {\n+    private static String CREATE_USER_CMD_PREFIX = \"sudo dscl . -create /Users/\";\n+    private static String AVAILABLE_UNIQUE_ID_CMD =\n+            \"dscl . -list /Users UniqueID | awk '{print $2}' | sort -ug | tail -1\";\n+    private static String CREATE_GROUP_CMD_PREFIX = \"sudo dscl . -create /Groups/\";\n+    private static String AVAILABLE_GID_CMD = \"dscl . -list /Groups gid | awk '{print $2}' | sort -ug | tail -1\";\n+    private static String ADD_USER_TO_GROUP_CMD_PREFIX = \"sudo dscl . -append /Groups/\";\n+\n+    @Override\n+    public void createUser(String user) throws IOException, InterruptedException {\n+        AtomicLong uniqueUid = new AtomicLong();\n+        runCmd(AVAILABLE_UNIQUE_ID_CMD, o -> {\n+            uniqueUid.set(Long.parseLong(o.toString().replaceAll(\"\\\\n\", \"\")) + 1L);\n+        }, \"Cannot get a unique id for creating user\");\n+        runCmd(CREATE_USER_CMD_PREFIX + user, o -> {}, \"Failed to create user\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Njg1MDk0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#pullrequestreview-526685094", "createdAt": "2020-11-09T21:53:44Z", "commit": {"oid": "02a0a5cf10c2dd1fdbd69897027569ea3d94d7e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1Mzo0NVrOHwDGWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1Mzo0NVrOHwDGWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDQ3NA==", "bodyText": "swap the arguments here then - your message should come first, not the command.\nI think you would actually be better off doing something like:\nlogger.atError()\n.kv(\"stdout\", output)\n.kv(\"stderr\", err)\n.kv(\"command\", cmdStr)\n.log(\"Error running command\")\nthrow new IOException(msg);\n\nAlso, should you catch IOException too - Runtime.getRuntime().exec() will throw IOException if an error occurs - if it does your message gets lost", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520144474", "createdAt": "2020-11-09T21:53:45Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java", "diffHunk": "@@ -397,6 +413,27 @@ public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IO\n         }\n     }\n \n+    protected void runCmd(String cmdStr, Consumer<CharSequence> out, String msg)\n+            throws IOException, InterruptedException {\n+        try (Exec exec = new Exec()) {\n+            StringBuilder output = new StringBuilder();\n+            StringBuilder error = new StringBuilder();\n+            Optional<Integer> exit = exec.withExec(cmdStr.split(\" \"))\n+                    .withShell()\n+                    .withOut(o -> {\n+                        out.accept(o);\n+                        output.append(o);\n+                    }).withErr(e -> {\n+                        error.append(e);\n+                    }).exec();\n+            if (!exit.isPresent() || exit.get() != 0) {\n+                throw new IOException(String.format(\n+                        String.format(\"%s - command: %s, output: %s , error: %s \", cmdStr, msg, output.toString(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02a0a5cf10c2dd1fdbd69897027569ea3d94d7e9"}, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40d43d835712acda206ef0c06265fdea6663cad7", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/40d43d835712acda206ef0c06265fdea6663cad7", "committedDate": "2020-11-09T23:02:53Z", "message": "Merge branch 'master' into setup-script"}, "afterCommit": {"oid": "1975ea0238e38dcee28afe5210bcd5fd6d4a27aa", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1975ea0238e38dcee28afe5210bcd5fd6d4a27aa", "committedDate": "2020-11-09T23:21:02Z", "message": "Fixes for user and group handling in setup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzM2NjM0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#pullrequestreview-526736634", "createdAt": "2020-11-09T23:28:23Z", "commit": {"oid": "9ba34ceab5549080157ef65ef7a066bc874d8b9c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzM2NjQ0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#pullrequestreview-526736644", "createdAt": "2020-11-09T23:28:24Z", "commit": {"oid": "9ba34ceab5549080157ef65ef7a066bc874d8b9c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzQwNjY0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#pullrequestreview-526740664", "createdAt": "2020-11-09T23:37:43Z", "commit": {"oid": "9ba34ceab5549080157ef65ef7a066bc874d8b9c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ccd57e1496e294269f00376b5ad868d61ac9802", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ccd57e1496e294269f00376b5ad868d61ac9802", "committedDate": "2020-11-10T01:27:57Z", "message": "Revert \"Revert \"Setup script changes (#610)\" (#641)\"\n\nThis reverts commit c7698ff5da0945972597e22be2015fd251640f96."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0681064a1682dae6cc90b0962d5805c4122381d0", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0681064a1682dae6cc90b0962d5805c4122381d0", "committedDate": "2020-11-10T01:27:57Z", "message": "Fixes for user and group handling in setup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6264786ab47cef0daff307f636e5998bdaf6b65", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6264786ab47cef0daff307f636e5998bdaf6b65", "committedDate": "2020-11-10T01:27:57Z", "message": "Update Cli component name, change condition, change macos group"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07af5bf992e8ad15b808794750ec1d1173722a08", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/07af5bf992e8ad15b808794750ec1d1173722a08", "committedDate": "2020-11-10T00:20:14Z", "message": "Merge branch 'master' into setup-script"}, "afterCommit": {"oid": "c6264786ab47cef0daff307f636e5998bdaf6b65", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6264786ab47cef0daff307f636e5998bdaf6b65", "committedDate": "2020-11-10T01:27:57Z", "message": "Update Cli component name, change condition, change macos group"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzkyMTUx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#pullrequestreview-526792151", "createdAt": "2020-11-10T01:48:16Z", "commit": {"oid": "c6264786ab47cef0daff307f636e5998bdaf6b65"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Nzk4MDU1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#pullrequestreview-526798055", "createdAt": "2020-11-10T02:05:43Z", "commit": {"oid": "c6264786ab47cef0daff307f636e5998bdaf6b65"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48261e1142f1c1f6127728f4b1edbafc4de6ba45", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/48261e1142f1c1f6127728f4b1edbafc4de6ba45", "committedDate": "2020-11-10T02:06:01Z", "message": "Merge branch 'master' into setup-script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2874e0bf50ee00e7aa33693e50e15ab168d4f27c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2874e0bf50ee00e7aa33693e50e15ab168d4f27c", "committedDate": "2020-11-10T02:45:16Z", "message": "Merge branch 'master' into setup-script"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2610, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}