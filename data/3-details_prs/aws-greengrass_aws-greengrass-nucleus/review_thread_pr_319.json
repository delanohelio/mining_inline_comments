{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNjQ0MDQ0", "number": 319, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzo0MTozNlrOEPii0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzo0MTozNlrOEPii0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NzMwMDY1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzo0MTozNlrOGzTeyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNjowMDoyMlrOGzYjJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0OTczOQ==", "bodyText": "The IotClient can be built using desired retry settings as the AWS SDK provides that out of the box, please switch to using that for the client being passed at line 185 https://github.com/aws/aws-greengrass-kernel/blob/master/src/main/java/com/aws/iot/evergreen/util/IotSdkClientFactory.java#L69- . BaseRetryableAccessor was meant to be used for non AWS SDK based clients that would need custom retry logic.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#discussion_r456449739", "createdAt": "2020-07-17T13:41:36Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -180,7 +186,12 @@ public void cleanThing(IotClient client, ThingInfo thing) {\n         client.detachThingPrincipal(\n                 DetachThingPrincipalRequest.builder().thingName(thing.thingName).principal(thing.certificateArn)\n                         .build());\n-        client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build());\n+        // Retry deleteThing when getting \"still attached to one or more principals\" InvalidRequestException\n+        // as the detachThingPrincipal call is async\n+        BaseRetryableAccessor accessor = new BaseRetryableAccessor();\n+        accessor.retry(RETRY_COUNT, BACKOFF_MILLIS,\n+                () -> client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d50608f4e0696eadece98638dd1be1eaa9b8d2a4"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUyNjI3OQ==", "bodyText": "Should I make all the iotclient in the e2e tests retry on InvalidRequestException? I intended to just wait for the detach call to be finished here, which might take several seconds in background.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#discussion_r456526279", "createdAt": "2020-07-17T15:48:40Z", "author": {"login": "youtuyy"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -180,7 +186,12 @@ public void cleanThing(IotClient client, ThingInfo thing) {\n         client.detachThingPrincipal(\n                 DetachThingPrincipalRequest.builder().thingName(thing.thingName).principal(thing.certificateArn)\n                         .build());\n-        client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build());\n+        // Retry deleteThing when getting \"still attached to one or more principals\" InvalidRequestException\n+        // as the detachThingPrincipal call is async\n+        BaseRetryableAccessor accessor = new BaseRetryableAccessor();\n+        accessor.retry(RETRY_COUNT, BACKOFF_MILLIS,\n+                () -> client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build()),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0OTczOQ=="}, "originalCommit": {"oid": "d50608f4e0696eadece98638dd1be1eaa9b8d2a4"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUzMjc3Mg==", "bodyText": "That sounds okay", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#discussion_r456532772", "createdAt": "2020-07-17T16:00:22Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -180,7 +186,12 @@ public void cleanThing(IotClient client, ThingInfo thing) {\n         client.detachThingPrincipal(\n                 DetachThingPrincipalRequest.builder().thingName(thing.thingName).principal(thing.certificateArn)\n                         .build());\n-        client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build());\n+        // Retry deleteThing when getting \"still attached to one or more principals\" InvalidRequestException\n+        // as the detachThingPrincipal call is async\n+        BaseRetryableAccessor accessor = new BaseRetryableAccessor();\n+        accessor.retry(RETRY_COUNT, BACKOFF_MILLIS,\n+                () -> client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build()),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0OTczOQ=="}, "originalCommit": {"oid": "d50608f4e0696eadece98638dd1be1eaa9b8d2a4"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4418, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}