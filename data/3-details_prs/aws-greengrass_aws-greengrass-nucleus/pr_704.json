{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNTkzNzMx", "number": 704, "title": "Unsubscribe on shutdown", "bodyText": "Issue #, if available:\n\nSubscription timeouts happen when nucleus starts while there are already jobs waiting in the queue.\nsubscriptions are persisted across nucleus restarts due to mqtt client using same session. On shutdown the subscription handlers are killed but the client has subscriptions when the nucleus restarts\n\nDescription of changes:\n\nChanged the order of subscriptions so that there are handlers for job description before notification subscription is created. This solves the timeout issue.\nUnsubscribing from Iot Jobs topics in deployment service shutdown. This should keep the session clean.\n\nWhy is this change necessary:\nHow was this change tested:\nManually ran GGC using the jar. Created cloud deployments and ran following scenarios:\n\nstart nucleus, create deployment (supposed to succeed), deployment succeeded, restart nucleus manually. Did not see deployment replaying\nstart nucleus, create deployment (supposed to fail), deployment failed, restart nucleus manually. Did not see deployment replaying\ncreate a deployment (supposed to fail), start nucleus, deployment failed, create another deployment (supposed to fail), deployment failed.\n\nObserved no timeouts and no replaying of deployments in above scenarios with these changes.\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-19T00:23:17Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704", "merged": true, "mergeCommit": {"oid": "b5a51a8b3f8c772aa02238c06b7b9b6cd1aaa251"}, "closed": true, "closedAt": "2020-12-04T01:42:05Z", "author": {"login": "abanthiy"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd248xgH2gAyNTIzNTkzNzMxOjMzMjQyODI1NzlhMGYzMjU3YzkzYWE5ODFmMmFjZDkyMzNkZjg3YWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABditmsRgFqTU0NDU5NjE3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3324282579a0f3257c93aa981f2acd9233df87af", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3324282579a0f3257c93aa981f2acd9233df87af", "committedDate": "2020-11-18T23:38:07Z", "message": "Unsubscribing to Iot Jobs topics when DeploymentService shuts down"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba2f0f41d2ede7148765e54041281ae785a34b73", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba2f0f41d2ede7148765e54041281ae785a34b73", "committedDate": "2020-11-19T00:14:11Z", "message": "Reversing the order of subscriptions to Iot Jobs to avoid subscription timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTkwMDQx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#pullrequestreview-533990041", "createdAt": "2020-11-19T00:30:05Z", "commit": {"oid": "ba2f0f41d2ede7148765e54041281ae785a34b73"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5f210381bccbf9c46f0cb684b20a372fd8fd043", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d5f210381bccbf9c46f0cb684b20a372fd8fd043", "committedDate": "2020-11-19T01:07:01Z", "message": "Fixing tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "115777631e68342e8cb240f6ad013c8b9f9e1db2", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/115777631e68342e8cb240f6ad013c8b9f9e1db2", "committedDate": "2020-11-19T01:01:40Z", "message": "Fixing tests"}, "afterCommit": {"oid": "d5f210381bccbf9c46f0cb684b20a372fd8fd043", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d5f210381bccbf9c46f0cb684b20a372fd8fd043", "committedDate": "2020-11-19T01:07:01Z", "message": "Fixing tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODc1NDk1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#pullrequestreview-536875495", "createdAt": "2020-11-23T21:55:17Z", "commit": {"oid": "d5f210381bccbf9c46f0cb684b20a372fd8fd043"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMTo1NToxOFrOH4g5Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMTo1NToxOFrOH4g5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAyMTIzNQ==", "bodyText": "Use the constants in IotJobsClientWrapper? It's changed to gg namespace now", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r529021235", "createdAt": "2020-11-23T21:55:18Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -521,6 +540,30 @@ protected void subscribeToGetNextJobDescription(Consumer<DescribeJobExecutionRes\n         }\n     }\n \n+    private void unsubscribeFromJobDescription() {\n+        if (connection != null) {\n+            String topic = \"$aws/things/{thingName}/jobs/{jobId}/get/accepted\";\n+            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n+            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n+            connection.unsubscribe(topic);\n+\n+            topic = \"$aws/things/{thingName}/jobs/{jobId}/get/rejected\";\n+            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n+            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n+            connection.unsubscribe(topic);\n+\n+            topic = \"$aws/things/{thingName}/jobs/{jobId}/namespace-cust-deployment/get/accepted\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5f210381bccbf9c46f0cb684b20a372fd8fd043"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4554d6d778fd76b374c7229bb3f3d0d2d2b05c9f", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4554d6d778fd76b374c7229bb3f3d0d2d2b05c9f", "committedDate": "2020-12-03T18:34:08Z", "message": "Merge branch 'master' into unsubscribeOnShutdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "914738fab307abf252896fe6926d7b0e689140f1", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/914738fab307abf252896fe6926d7b0e689140f1", "committedDate": "2020-12-03T20:01:18Z", "message": "use custom namespace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDI3ODU2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#pullrequestreview-544427856", "createdAt": "2020-12-03T20:46:54Z", "commit": {"oid": "914738fab307abf252896fe6926d7b0e689140f1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5c690b2ef2d5d1290dd23697f3cd6205a4adc983", "committedDate": "2020-12-03T20:54:01Z", "message": "Merge branch 'master' into unsubscribeOnShutdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDQwODMw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#pullrequestreview-544440830", "createdAt": "2020-12-03T20:55:09Z", "commit": {"oid": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDo1NToxMFrOH-yhhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDo1OTozMVrOH-y8Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwMTU0Mw==", "bodyText": "not used?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535601543", "createdAt": "2020-12-03T20:55:10Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -91,6 +94,9 @@\n     //This value needs to be revisited and set to more realistic numbers\n     private static final long TIMEOUT_FOR_IOT_JOBS_OPERATIONS_SECONDS = Duration.ofMinutes(1).getSeconds();\n     private static final String JOB_ID_LOG_KEY_NAME = \"JobId\";\n+    private static final String THING_NAME_PLACEHOLDER = \"{thingName}\";\n+    private static final String JOB_ID_PLACEHOLDER = \"{jobId}\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwODM2Nw==", "bodyText": "I'm not familiar with this. Will $next be replaced by any deployment ID?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535608367", "createdAt": "2020-12-03T20:59:31Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -475,6 +495,18 @@ protected void subscribeToGetNextJobDescription(Consumer<DescribeJobExecutionRes\n         }\n     }\n \n+    private void unsubscribeFromJobDescription() {\n+        if (connection != null) {\n+            String topic = String.format(JOB_DESCRIBE_ACCEPTED_TOPIC,\n+                    Coerce.toString(deviceConfiguration.getThingName()), NEXT_JOB_LITERAL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67b633a5ade6967f295fded35aeab3a06649e129", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/67b633a5ade6967f295fded35aeab3a06649e129", "committedDate": "2020-12-03T21:10:04Z", "message": "addressed comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDU4MzQw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#pullrequestreview-544458340", "createdAt": "2020-12-03T21:20:38Z", "commit": {"oid": "67b633a5ade6967f295fded35aeab3a06649e129"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dcc1cec42cac162ab566bbbb44c090f551fdfcb", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0dcc1cec42cac162ab566bbbb44c090f551fdfcb", "committedDate": "2020-12-04T00:04:25Z", "message": "Merge branch 'master' into unsubscribeOnShutdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTg1NzM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#pullrequestreview-544585736", "createdAt": "2020-12-04T01:09:18Z", "commit": {"oid": "0dcc1cec42cac162ab566bbbb44c090f551fdfcb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTkwOTU1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#pullrequestreview-544590955", "createdAt": "2020-12-04T01:23:34Z", "commit": {"oid": "0dcc1cec42cac162ab566bbbb44c090f551fdfcb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMToyMzozNFrOH-8mpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMToyMzozNFrOH-8mpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc2NjY5NA==", "bodyText": "Shouldn't this comment be above line422? Also probably want to add a bit more context on why we need to subscribe to job description before event notification. The whole jobs call pattern is not very obvious. Is it documented somewhere?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535766694", "createdAt": "2020-12-04T01:23:34Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -409,13 +415,25 @@ public void requestNextPendingJobDocument() {\n      * @throws ConnectionUnavailableException When connection to cloud is not available\n      */\n     public void subscribeToJobsTopics() {\n-        subscribeToEventNotifications(eventHandler);\n+\n         subscribeToGetNextJobDescription(describeJobExecutionResponseConsumer, rejectedError -> {\n             logger.error(\"Job subscription got rejected\", rejectedError);\n         });\n+        subscribeToEventNotifications(eventHandler);\n+        // To receive the description of jobs which were created before the subscription was created (before the device\n+        // came online)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dcc1cec42cac162ab566bbbb44c090f551fdfcb"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTk2MTc3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#pullrequestreview-544596177", "createdAt": "2020-12-04T01:38:39Z", "commit": {"oid": "0dcc1cec42cac162ab566bbbb44c090f551fdfcb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2717, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}