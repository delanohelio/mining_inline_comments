{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5ODc5NDc5", "number": 159, "reviewThreads": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDoxNzoyMFrODvSf3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMjoxMToyNVrODwLxTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTEyNzMzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDoxNzoyMFrOGBoQ3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMDowNjo0NVrOGBuUrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2MTQzNw==", "bodyText": "Not sure this method is needed, but in any case you should remove the this as that will cause a PMD violation.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404361437", "createdAt": "2020-04-06T20:17:20Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -866,6 +790,10 @@ public String getName() {\n         return config == null ? getClass().getSimpleName() : config.getName();\n     }\n \n+    public Node getServiceChildConfig(String configKey) {\n+        return this.config.getChild(configKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c411f0f2188fedf3a2cb30eb4cd1e58408428e0"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2MDcxNw==", "bodyText": "Done", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404460717", "createdAt": "2020-04-07T00:06:45Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -866,6 +790,10 @@ public String getName() {\n         return config == null ? getClass().getSimpleName() : config.getName();\n     }\n \n+    public Node getServiceChildConfig(String configKey) {\n+        return this.config.getChild(configKey);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2MTQzNw=="}, "originalCommit": {"oid": "8c411f0f2188fedf3a2cb30eb4cd1e58408428e0"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTEzMTE0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDoxODoyMVrOGBoTGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMDowNjo0MFrOGBuUmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2MjAxMA==", "bodyText": "I know this was there before, but I don't think we have any empty catches anymore, so let's get rid of this.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404362010", "createdAt": "2020-04-06T20:18:21Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -664,4 +667,82 @@ private void removeServices(List<String> serviceToRemove) throws InterruptedExce\n                 .collect(Collectors.toList());\n \n     }\n+\n+\n+    /**\n+     * Locate an EvergreenService by name in the kernel context.\n+     *\n+     * @param name    name of the service to find\n+     * @return found service or null\n+     * @throws ServiceLoadException if service cannot load\n+     */\n+    @SuppressWarnings({\"checkstyle:emptycatchblock\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c411f0f2188fedf3a2cb30eb4cd1e58408428e0"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2MDY5OQ==", "bodyText": "Done", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404460699", "createdAt": "2020-04-07T00:06:40Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -664,4 +667,82 @@ private void removeServices(List<String> serviceToRemove) throws InterruptedExce\n                 .collect(Collectors.toList());\n \n     }\n+\n+\n+    /**\n+     * Locate an EvergreenService by name in the kernel context.\n+     *\n+     * @param name    name of the service to find\n+     * @return found service or null\n+     * @throws ServiceLoadException if service cannot load\n+     */\n+    @SuppressWarnings({\"checkstyle:emptycatchblock\"})", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2MjAxMA=="}, "originalCommit": {"oid": "8c411f0f2188fedf3a2cb30eb4cd1e58408428e0"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTE0MzM4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDoyMTo1M1rOGBoamg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMDowNjozNFrOGBuUfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2MzkzMA==", "bodyText": "I do wonder if this should be a separate top-level key like \"services\" we can have \"parameters\", instead of being under each package. Because I think we will want a global param store for things like secrets and directory paths which are not unique to a package, but can be substituted in many locations.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404363930", "createdAt": "2020-04-06T20:21:53Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +194,21 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(String packageName) {\n+        try {\n+            EvergreenService service = kernel.locate(packageName);\n+            Node parametersConfig = service.getServiceChildConfig(PARAMETERS_CONFIG_KEY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c411f0f2188fedf3a2cb30eb4cd1e58408428e0"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2MDY2OA==", "bodyText": "That can be done, although the secrets and directory paths will be controlled by the kernel or package manager and will not need to be updated on each deployment and based on changes to individual services. For package parameters IMO, they need to be added/updated when their respective services are and should also be removed when the services are removed, so in practice it's much cleaner to do that at the service level. Imagine you have a service being removed that was a dependency of some other service, our current deployment workflow will automatically remove that config(i.e. the kernel handles it), but if parameters are stored separately, it will need to be aware of the service being removed and remove the parameters based on that, it's probably the complexity we don't necessarily need right now", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404460668", "createdAt": "2020-04-07T00:06:34Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +194,21 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(String packageName) {\n+        try {\n+            EvergreenService service = kernel.locate(packageName);\n+            Node parametersConfig = service.getServiceChildConfig(PARAMETERS_CONFIG_KEY);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2MzkzMA=="}, "originalCommit": {"oid": "8c411f0f2188fedf3a2cb30eb4cd1e58408428e0"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTE0NTQzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDoyMjozMFrOGBob2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMDowMToxMVrOGBuOVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2NDI1MA==", "bodyText": "Use your public static const for \"parameters\"?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404364250", "createdAt": "2020-04-06T20:22:30Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -131,9 +143,12 @@ public void GIVEN_deployment_for_existing_package_WHEN_config_resolution_request\n \n         when(packageStore.getRecipe(rootPackageIdentifier)).thenReturn(rootPackage);\n         when(kernel.getMain()).thenReturn(mainService);\n+        when(kernel.locate(TEST_INPUT_PACKAGE_A)).thenReturn(alreadyRunningService);\n         when(mainService.getName()).thenReturn(\"main\");\n         when(mainService.getDependencies()).thenReturn(Collections.singletonMap(alreadyRunningService, State.RUNNING));\n         when(alreadyRunningService.getName()).thenReturn(TEST_INPUT_PACKAGE_A);\n+        when(alreadyRunningService.getServiceChildConfig(\"parameters\")).thenReturn(alreadyRunningServiceParametersConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c411f0f2188fedf3a2cb30eb4cd1e58408428e0"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1OTA5Mw==", "bodyText": "Done", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404459093", "createdAt": "2020-04-07T00:01:11Z", "author": {"login": "shaguptashaikh"}, "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -131,9 +143,12 @@ public void GIVEN_deployment_for_existing_package_WHEN_config_resolution_request\n \n         when(packageStore.getRecipe(rootPackageIdentifier)).thenReturn(rootPackage);\n         when(kernel.getMain()).thenReturn(mainService);\n+        when(kernel.locate(TEST_INPUT_PACKAGE_A)).thenReturn(alreadyRunningService);\n         when(mainService.getName()).thenReturn(\"main\");\n         when(mainService.getDependencies()).thenReturn(Collections.singletonMap(alreadyRunningService, State.RUNNING));\n         when(alreadyRunningService.getName()).thenReturn(TEST_INPUT_PACKAGE_A);\n+        when(alreadyRunningService.getServiceChildConfig(\"parameters\")).thenReturn(alreadyRunningServiceParametersConfig);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2NDI1MA=="}, "originalCommit": {"oid": "8c411f0f2188fedf3a2cb30eb4cd1e58408428e0"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwOTE1MDE3OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDoyMzo0M1rOGBoeqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMDowMTowNVrOGBuOQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2NDk3MA==", "bodyText": "Use IsEqual http://hamcrest.org/JavaHamcrest/javadoc/1.3/org/hamcrest/core/IsEqual.html.\nInstead of .equals() which won't give you a very good error.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404364970", "createdAt": "2020-04-06T20:23:43Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -190,7 +206,59 @@ public void GIVEN_deployment_with_parameters_set_WHEN_config_resolution_requeste\n                 (Map<String, String>) getServiceInstallCommand(TEST_INPUT_PACKAGE_A, servicesConfig);\n \n         assertThat(\"If parameter value was set in deployment, it should be used\",\n-                   serviceInstallCommand.get(LIFECYCLE_SCRIPT_KEY)\n+                serviceInstallCommand.get(LIFECYCLE_SCRIPT_KEY)\n+                        .equals(\"echo installing service in Package PackageA with param PackageA_Param_1_value\"));\n+\n+        assertThat(\"If not parameter value was set in deployment, the default value should be used\",\n+                getServiceRunCommand(TEST_INPUT_PACKAGE_A, servicesConfig)\n+                        .equals(\"echo running service in Package PackageA with param PackageA_Param_2_default_value\"));\n+\n+    }\n+\n+    @Test\n+    public void GIVEN_deployment_with_params_not_set_WHEN_previous_deployment_had_params_THEN_use_params_from_previous_deployment()\n+            throws Exception {\n+        // GIVEN\n+        PackageIdentifier rootPackageIdentifier =\n+                new PackageIdentifier(TEST_INPUT_PACKAGE_A, new Semver(\"1.2\", Semver.SemverType.NPM));\n+        List<PackageIdentifier> packagesToDeploy = Arrays.asList(rootPackageIdentifier);\n+\n+        Package rootPackage = getPackage(TEST_INPUT_PACKAGE_A, \"1.2\", Collections.emptyMap(),\n+                getSimpleParameterMap(TEST_INPUT_PACKAGE_A));\n+\n+        DeploymentPackageConfiguration rootPackageDeploymentConfig =\n+                new DeploymentPackageConfiguration(TEST_INPUT_PACKAGE_A, \"1.2\", \">1.0\", Collections.emptySet(),\n+                        Collections.emptyList());\n+        DeploymentDocument document = DeploymentDocument.builder().rootPackages(Arrays.asList(TEST_INPUT_PACKAGE_A))\n+                .deploymentPackageConfigurationList(Arrays.asList(rootPackageDeploymentConfig)).build();\n+\n+        when(packageStore.getRecipe(rootPackageIdentifier)).thenReturn(rootPackage);\n+        when(kernel.getMain()).thenReturn(mainService);\n+        when(kernel.locate(TEST_INPUT_PACKAGE_A)).thenReturn(alreadyRunningService);\n+        when(mainService.getName()).thenReturn(\"main\");\n+        when(mainService.getDependencies()).thenReturn(Collections.singletonMap(alreadyRunningService, State.RUNNING));\n+        when(alreadyRunningService.getName()).thenReturn(TEST_INPUT_PACKAGE_A);\n+        when(alreadyRunningService.getServiceChildConfig(\"parameters\")).thenReturn(alreadyRunningServiceParametersConfig);\n+        when(alreadyRunningServiceParametersConfig.getOnce()).thenReturn(new HashSet<>(\n+                Arrays.asList(new PackageParameter(\"PackageA_Param_1\", \"PackageA_Param_1_value\", \"STRING\"))));\n+\n+        // WHEN\n+        KernelConfigResolver kernelConfigResolver = new KernelConfigResolver(packageStore, kernel);\n+        Map<Object, Object> resolvedConfig =\n+                kernelConfigResolver.resolve(packagesToDeploy, document, Arrays.asList(TEST_INPUT_PACKAGE_A));\n+\n+        // THEN\n+        // service config\n+        Map<Object, Object> servicesConfig = (Map<Object, Object>) resolvedConfig.get(\"services\");\n+        assertThat(\"Must contain main service\", servicesConfig.containsKey(\"main\"));\n+        assertThat(\"Must contain top level package service\", servicesConfig.containsKey(TEST_INPUT_PACKAGE_A));\n+\n+        // parameter interpolation\n+        Map<String, String> serviceInstallCommand =\n+                (Map<String, String>) getServiceInstallCommand(TEST_INPUT_PACKAGE_A, servicesConfig);\n+\n+        assertThat(\"If parameter value was set in deployment, it should be used\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c411f0f2188fedf3a2cb30eb4cd1e58408428e0"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1OTA3Mw==", "bodyText": "Done", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404459073", "createdAt": "2020-04-07T00:01:05Z", "author": {"login": "shaguptashaikh"}, "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -190,7 +206,59 @@ public void GIVEN_deployment_with_parameters_set_WHEN_config_resolution_requeste\n                 (Map<String, String>) getServiceInstallCommand(TEST_INPUT_PACKAGE_A, servicesConfig);\n \n         assertThat(\"If parameter value was set in deployment, it should be used\",\n-                   serviceInstallCommand.get(LIFECYCLE_SCRIPT_KEY)\n+                serviceInstallCommand.get(LIFECYCLE_SCRIPT_KEY)\n+                        .equals(\"echo installing service in Package PackageA with param PackageA_Param_1_value\"));\n+\n+        assertThat(\"If not parameter value was set in deployment, the default value should be used\",\n+                getServiceRunCommand(TEST_INPUT_PACKAGE_A, servicesConfig)\n+                        .equals(\"echo running service in Package PackageA with param PackageA_Param_2_default_value\"));\n+\n+    }\n+\n+    @Test\n+    public void GIVEN_deployment_with_params_not_set_WHEN_previous_deployment_had_params_THEN_use_params_from_previous_deployment()\n+            throws Exception {\n+        // GIVEN\n+        PackageIdentifier rootPackageIdentifier =\n+                new PackageIdentifier(TEST_INPUT_PACKAGE_A, new Semver(\"1.2\", Semver.SemverType.NPM));\n+        List<PackageIdentifier> packagesToDeploy = Arrays.asList(rootPackageIdentifier);\n+\n+        Package rootPackage = getPackage(TEST_INPUT_PACKAGE_A, \"1.2\", Collections.emptyMap(),\n+                getSimpleParameterMap(TEST_INPUT_PACKAGE_A));\n+\n+        DeploymentPackageConfiguration rootPackageDeploymentConfig =\n+                new DeploymentPackageConfiguration(TEST_INPUT_PACKAGE_A, \"1.2\", \">1.0\", Collections.emptySet(),\n+                        Collections.emptyList());\n+        DeploymentDocument document = DeploymentDocument.builder().rootPackages(Arrays.asList(TEST_INPUT_PACKAGE_A))\n+                .deploymentPackageConfigurationList(Arrays.asList(rootPackageDeploymentConfig)).build();\n+\n+        when(packageStore.getRecipe(rootPackageIdentifier)).thenReturn(rootPackage);\n+        when(kernel.getMain()).thenReturn(mainService);\n+        when(kernel.locate(TEST_INPUT_PACKAGE_A)).thenReturn(alreadyRunningService);\n+        when(mainService.getName()).thenReturn(\"main\");\n+        when(mainService.getDependencies()).thenReturn(Collections.singletonMap(alreadyRunningService, State.RUNNING));\n+        when(alreadyRunningService.getName()).thenReturn(TEST_INPUT_PACKAGE_A);\n+        when(alreadyRunningService.getServiceChildConfig(\"parameters\")).thenReturn(alreadyRunningServiceParametersConfig);\n+        when(alreadyRunningServiceParametersConfig.getOnce()).thenReturn(new HashSet<>(\n+                Arrays.asList(new PackageParameter(\"PackageA_Param_1\", \"PackageA_Param_1_value\", \"STRING\"))));\n+\n+        // WHEN\n+        KernelConfigResolver kernelConfigResolver = new KernelConfigResolver(packageStore, kernel);\n+        Map<Object, Object> resolvedConfig =\n+                kernelConfigResolver.resolve(packagesToDeploy, document, Arrays.asList(TEST_INPUT_PACKAGE_A));\n+\n+        // THEN\n+        // service config\n+        Map<Object, Object> servicesConfig = (Map<Object, Object>) resolvedConfig.get(\"services\");\n+        assertThat(\"Must contain main service\", servicesConfig.containsKey(\"main\"));\n+        assertThat(\"Must contain top level package service\", servicesConfig.containsKey(TEST_INPUT_PACKAGE_A));\n+\n+        // parameter interpolation\n+        Map<String, String> serviceInstallCommand =\n+                (Map<String, String>) getServiceInstallCommand(TEST_INPUT_PACKAGE_A, servicesConfig);\n+\n+        assertThat(\"If parameter value was set in deployment, it should be used\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2NDk3MA=="}, "originalCommit": {"oid": "8c411f0f2188fedf3a2cb30eb4cd1e58408428e0"}, "originalPosition": 146}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMjgxNjc5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjoyNDoyM1rOGCLwxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMjoyODoxNlrOGCYavA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk0MzA0NQ==", "bodyText": "expose config via a getter and use functions in topics to search for sub keys? I have added find/findtopics/lookup and loouptopics to Topics class in my PR", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404943045", "createdAt": "2020-04-07T16:24:23Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -866,6 +790,10 @@ public String getName() {\n         return config == null ? getClass().getSimpleName() : config.getName();\n     }\n \n+    public Node getServiceChildConfig(String configKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc7aa8027648d552985375532cf829bea3e46b71"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE1MDM5Ng==", "bodyText": "As discussed offline, I've made this change and I'm using the existing getChild method that works for this code, let me know if you have any concerns", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405150396", "createdAt": "2020-04-07T22:28:16Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -866,6 +790,10 @@ public String getName() {\n         return config == null ? getClass().getSimpleName() : config.getName();\n     }\n \n+    public Node getServiceChildConfig(String configKey) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk0MzA0NQ=="}, "originalCommit": {"oid": "fc7aa8027648d552985375532cf829bea3e46b71"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzA4MzUyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzoyODozOVrOGCOZow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo0MjoyNVrOGCO72w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NjI3NQ==", "bodyText": "So how does a package parameter get removed then? is it safe to assume that a missing parameter is not because it got deleted?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404986275", "createdAt": "2020-04-07T17:28:39Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -169,7 +175,10 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         // If values for parameters were set in deployment they should be used\n         Set<PackageParameter> resolvedParams = new HashSet<>(getParametersFromDeployment(document, pkg));\n \n-        // Use defaults for parameters for which no values were set in deployment\n+        // If not set in deployment, use values from previous deployments that were stored in config\n+        resolvedParams.addAll(getParametersStoredInConfig(pkg.getPackageName()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc7aa8027648d552985375532cf829bea3e46b71"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5MDU0OQ==", "bodyText": "Oops, I seem to have missed that, although, when parameters get removed, even if they stay in Kernel config they will not affect the service because they will not be interpolated anywhere, but even with that, if something gets removed from recipe it should be removed from the config too, I'll address that", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404990549", "createdAt": "2020-04-07T17:35:13Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -169,7 +175,10 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         // If values for parameters were set in deployment they should be used\n         Set<PackageParameter> resolvedParams = new HashSet<>(getParametersFromDeployment(document, pkg));\n \n-        // Use defaults for parameters for which no values were set in deployment\n+        // If not set in deployment, use values from previous deployments that were stored in config\n+        resolvedParams.addAll(getParametersStoredInConfig(pkg.getPackageName()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NjI3NQ=="}, "originalCommit": {"oid": "fc7aa8027648d552985375532cf829bea3e46b71"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5NTAzNQ==", "bodyText": "Done", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r404995035", "createdAt": "2020-04-07T17:42:25Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -169,7 +175,10 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         // If values for parameters were set in deployment they should be used\n         Set<PackageParameter> resolvedParams = new HashSet<>(getParametersFromDeployment(document, pkg));\n \n-        // Use defaults for parameters for which no values were set in deployment\n+        // If not set in deployment, use values from previous deployments that were stored in config\n+        resolvedParams.addAll(getParametersStoredInConfig(pkg.getPackageName()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NjI3NQ=="}, "originalCommit": {"oid": "fc7aa8027648d552985375532cf829bea3e46b71"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzM3MjMzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODo0NDoxMlrOGCRQNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo0ODo0M1rOGC6PUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzMzAxNA==", "bodyText": "Should we perhaps be storing them as key-value pairs so that they are translated into Topics which we can subscribe to? That way we can lookup specific parameters using find and lookup, as well as subscribe to their change.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405033014", "createdAt": "2020-04-07T18:44:12Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +198,18 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(String packageName) {\n+        try {\n+            EvergreenService service = kernel.locate(packageName);\n+            Topic parametersConfig = service.getServiceConfig().lookup(PARAMETERS_CONFIG_KEY);\n+            return (Set<PackageParameter>) parametersConfig.getOnce();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d3b76e2778cd3a84fb0a7622408166011acd26"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE0OTg1NQ==", "bodyText": "I personally like that idea very much and wanted to do that since the beginning, but we need to finalize the package parameters+custom kernel config our package recipe model to get it right. currently both are agnostic of eacc other. Also the kernel config syntax expects these key value pairs under a new parent key called 'custom' anyway https://quip-amazon.com/35xMAtuSgvha/Evergreen-Kernel-Configuration-Schema which is no different than storing package parameters under the parameters config key. I believe we should still be able to subscribe to updates to the overall parameters config? I would like to have the above things clarified first before storing them as plain key-value pairs, I can do that as a follow up, does that work?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405149855", "createdAt": "2020-04-07T22:26:53Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +198,18 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(String packageName) {\n+        try {\n+            EvergreenService service = kernel.locate(packageName);\n+            Topic parametersConfig = service.getServiceConfig().lookup(PARAMETERS_CONFIG_KEY);\n+            return (Set<PackageParameter>) parametersConfig.getOnce();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzMzAxNA=="}, "originalCommit": {"oid": "e0d3b76e2778cd3a84fb0a7622408166011acd26"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNDUzMA==", "bodyText": "I made a change to store parameters as plain config key value pairs", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405704530", "createdAt": "2020-04-08T17:48:43Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +198,18 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(String packageName) {\n+        try {\n+            EvergreenService service = kernel.locate(packageName);\n+            Topic parametersConfig = service.getServiceConfig().lookup(PARAMETERS_CONFIG_KEY);\n+            return (Set<PackageParameter>) parametersConfig.getOnce();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzMzAxNA=="}, "originalCommit": {"oid": "e0d3b76e2778cd3a84fb0a7622408166011acd26"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzM4MDAzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODo0NjozMlrOGCRVMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMjoyOTowMFrOGCYb9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzNDI5MA==", "bodyText": "Use hamcrest: http://hamcrest.org/JavaHamcrest/javadoc/1.3/org/hamcrest/collection/IsMapContaining.html#hasKey(K)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405034290", "createdAt": "2020-04-07T18:46:32Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -190,12 +208,66 @@ public void GIVEN_deployment_with_parameters_set_WHEN_config_resolution_requeste\n                 (Map<String, String>) getServiceInstallCommand(TEST_INPUT_PACKAGE_A, servicesConfig);\n \n         assertThat(\"If parameter value was set in deployment, it should be used\",\n-                   serviceInstallCommand.get(LIFECYCLE_SCRIPT_KEY)\n-                        .equals(\"echo installing service in Package PackageA with param PackageA_Param_1_value\"));\n+                serviceInstallCommand.get(LIFECYCLE_SCRIPT_KEY),\n+                equalTo(\"echo installing service in Package PackageA \" + \"with param PackageA_Param_1_value\"));\n+\n+        assertThat(\"If not parameter value was set in deployment, the default value should be used\",\n+                getServiceRunCommand(TEST_INPUT_PACKAGE_A, servicesConfig),\n+                equalTo(\"echo running service in Package \" + \"PackageA with param PackageA_Param_2_default_value\"));\n+\n+    }\n+\n+    @Test\n+    public void GIVEN_deployment_with_params_not_set_WHEN_previous_deployment_had_params_THEN_use_params_from_previous_deployment()\n+            throws Exception {\n+        // GIVEN\n+        PackageIdentifier rootPackageIdentifier =\n+                new PackageIdentifier(TEST_INPUT_PACKAGE_A, new Semver(\"1.2\", Semver.SemverType.NPM));\n+        List<PackageIdentifier> packagesToDeploy = Arrays.asList(rootPackageIdentifier);\n+\n+        Package rootPackage = getPackage(TEST_INPUT_PACKAGE_A, \"1.2\", Collections.emptyMap(),\n+                getSimpleParameterMap(TEST_INPUT_PACKAGE_A));\n+\n+        DeploymentPackageConfiguration rootPackageDeploymentConfig =\n+                new DeploymentPackageConfiguration(TEST_INPUT_PACKAGE_A, \"1.2\", \">1.0\", Collections.emptySet(),\n+                        Collections.emptyList());\n+        DeploymentDocument document = DeploymentDocument.builder().rootPackages(Arrays.asList(TEST_INPUT_PACKAGE_A))\n+                .deploymentPackageConfigurationList(Arrays.asList(rootPackageDeploymentConfig)).build();\n+\n+        when(packageStore.getRecipe(rootPackageIdentifier)).thenReturn(rootPackage);\n+        when(kernel.getMain()).thenReturn(mainService);\n+        when(kernel.locate(TEST_INPUT_PACKAGE_A)).thenReturn(alreadyRunningService);\n+        when(mainService.getName()).thenReturn(\"main\");\n+        when(mainService.getDependencies()).thenReturn(Collections.singletonMap(alreadyRunningService, State.RUNNING));\n+        when(alreadyRunningService.getName()).thenReturn(TEST_INPUT_PACKAGE_A);\n+        when(alreadyRunningService.getServiceConfig()).thenReturn(alreadyRunningServiceConfig);\n+        when(alreadyRunningServiceConfig.lookup(KernelConfigResolver.PARAMETERS_CONFIG_KEY))\n+                .thenReturn(alreadyRunningServiceParametersConfig);\n+        when(alreadyRunningServiceParametersConfig.getOnce()).thenReturn(new HashSet<>(\n+                Arrays.asList(new PackageParameter(\"PackageA_Param_1\", \"PackageA_Param_1_value\", \"STRING\"))));\n+\n+        // WHEN\n+        KernelConfigResolver kernelConfigResolver = new KernelConfigResolver(packageStore, kernel);\n+        Map<Object, Object> resolvedConfig =\n+                kernelConfigResolver.resolve(packagesToDeploy, document, Arrays.asList(TEST_INPUT_PACKAGE_A));\n+\n+        // THEN\n+        // service config\n+        Map<Object, Object> servicesConfig = (Map<Object, Object>) resolvedConfig.get(\"services\");\n+        assertThat(\"Must contain main service\", servicesConfig.containsKey(\"main\"));\n+        assertThat(\"Must contain top level package service\", servicesConfig.containsKey(TEST_INPUT_PACKAGE_A));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d3b76e2778cd3a84fb0a7622408166011acd26"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE1MDcxMQ==", "bodyText": "Done", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405150711", "createdAt": "2020-04-07T22:29:00Z", "author": {"login": "shaguptashaikh"}, "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -190,12 +208,66 @@ public void GIVEN_deployment_with_parameters_set_WHEN_config_resolution_requeste\n                 (Map<String, String>) getServiceInstallCommand(TEST_INPUT_PACKAGE_A, servicesConfig);\n \n         assertThat(\"If parameter value was set in deployment, it should be used\",\n-                   serviceInstallCommand.get(LIFECYCLE_SCRIPT_KEY)\n-                        .equals(\"echo installing service in Package PackageA with param PackageA_Param_1_value\"));\n+                serviceInstallCommand.get(LIFECYCLE_SCRIPT_KEY),\n+                equalTo(\"echo installing service in Package PackageA \" + \"with param PackageA_Param_1_value\"));\n+\n+        assertThat(\"If not parameter value was set in deployment, the default value should be used\",\n+                getServiceRunCommand(TEST_INPUT_PACKAGE_A, servicesConfig),\n+                equalTo(\"echo running service in Package \" + \"PackageA with param PackageA_Param_2_default_value\"));\n+\n+    }\n+\n+    @Test\n+    public void GIVEN_deployment_with_params_not_set_WHEN_previous_deployment_had_params_THEN_use_params_from_previous_deployment()\n+            throws Exception {\n+        // GIVEN\n+        PackageIdentifier rootPackageIdentifier =\n+                new PackageIdentifier(TEST_INPUT_PACKAGE_A, new Semver(\"1.2\", Semver.SemverType.NPM));\n+        List<PackageIdentifier> packagesToDeploy = Arrays.asList(rootPackageIdentifier);\n+\n+        Package rootPackage = getPackage(TEST_INPUT_PACKAGE_A, \"1.2\", Collections.emptyMap(),\n+                getSimpleParameterMap(TEST_INPUT_PACKAGE_A));\n+\n+        DeploymentPackageConfiguration rootPackageDeploymentConfig =\n+                new DeploymentPackageConfiguration(TEST_INPUT_PACKAGE_A, \"1.2\", \">1.0\", Collections.emptySet(),\n+                        Collections.emptyList());\n+        DeploymentDocument document = DeploymentDocument.builder().rootPackages(Arrays.asList(TEST_INPUT_PACKAGE_A))\n+                .deploymentPackageConfigurationList(Arrays.asList(rootPackageDeploymentConfig)).build();\n+\n+        when(packageStore.getRecipe(rootPackageIdentifier)).thenReturn(rootPackage);\n+        when(kernel.getMain()).thenReturn(mainService);\n+        when(kernel.locate(TEST_INPUT_PACKAGE_A)).thenReturn(alreadyRunningService);\n+        when(mainService.getName()).thenReturn(\"main\");\n+        when(mainService.getDependencies()).thenReturn(Collections.singletonMap(alreadyRunningService, State.RUNNING));\n+        when(alreadyRunningService.getName()).thenReturn(TEST_INPUT_PACKAGE_A);\n+        when(alreadyRunningService.getServiceConfig()).thenReturn(alreadyRunningServiceConfig);\n+        when(alreadyRunningServiceConfig.lookup(KernelConfigResolver.PARAMETERS_CONFIG_KEY))\n+                .thenReturn(alreadyRunningServiceParametersConfig);\n+        when(alreadyRunningServiceParametersConfig.getOnce()).thenReturn(new HashSet<>(\n+                Arrays.asList(new PackageParameter(\"PackageA_Param_1\", \"PackageA_Param_1_value\", \"STRING\"))));\n+\n+        // WHEN\n+        KernelConfigResolver kernelConfigResolver = new KernelConfigResolver(packageStore, kernel);\n+        Map<Object, Object> resolvedConfig =\n+                kernelConfigResolver.resolve(packagesToDeploy, document, Arrays.asList(TEST_INPUT_PACKAGE_A));\n+\n+        // THEN\n+        // service config\n+        Map<Object, Object> servicesConfig = (Map<Object, Object>) resolvedConfig.get(\"services\");\n+        assertThat(\"Must contain main service\", servicesConfig.containsKey(\"main\"));\n+        assertThat(\"Must contain top level package service\", servicesConfig.containsKey(TEST_INPUT_PACKAGE_A));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzNDI5MA=="}, "originalCommit": {"oid": "e0d3b76e2778cd3a84fb0a7622408166011acd26"}, "originalPosition": 145}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzU3NzI3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/DependencyResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzozNDowNVrOGC5uTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo0ODowOVrOGC6N-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NjA3Nw==", "bodyText": "Can this be null?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405696077", "createdAt": "2020-04-08T17:34:05Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/DependencyResolver.java", "diffHunk": "@@ -331,11 +330,8 @@ private void mergeActiveRootPackages(Set<String> rootPackagesToResolve,\n \n \n     protected Optional<String> getServiceVersion(final EvergreenService service) {\n-        Node versionNode = service.config.getChild(KernelConfigResolver.VERSION_CONFIG_KEY);\n-        if (versionNode instanceof Topic) {\n-            return Optional.of(((Topic) versionNode).getOnce().toString());\n-        }\n-        return Optional.empty();\n+        Topic version = service.getServiceConfig().lookup(KernelConfigResolver.VERSION_CONFIG_KEY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5d7eb1e5031ef4acb90b9d131c0087577d9c49d"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNDE4Ng==", "bodyText": "It can be null in case of internal Evergreen services like ipc, deployment service etc but this code will never try to access a version for those, although I have added the null check just in case", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405704186", "createdAt": "2020-04-08T17:48:09Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/DependencyResolver.java", "diffHunk": "@@ -331,11 +330,8 @@ private void mergeActiveRootPackages(Set<String> rootPackagesToResolve,\n \n \n     protected Optional<String> getServiceVersion(final EvergreenService service) {\n-        Node versionNode = service.config.getChild(KernelConfigResolver.VERSION_CONFIG_KEY);\n-        if (versionNode instanceof Topic) {\n-            return Optional.of(((Topic) versionNode).getOnce().toString());\n-        }\n-        return Optional.empty();\n+        Topic version = service.getServiceConfig().lookup(KernelConfigResolver.VERSION_CONFIG_KEY);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NjA3Nw=="}, "originalCommit": {"oid": "c5d7eb1e5031ef4acb90b9d131c0087577d9c49d"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzU4NTY1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzozNjo0MVrOGC5z4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo0NTo1OFrOGC6JEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NzUwNA==", "bodyText": "Does this only apply to new package params which are introduced the this pkg version?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405697504", "createdAt": "2020-04-08T17:36:41Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -163,13 +168,21 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n \n     /*\n      * Resolve values to be used for all package parameters combining those coming from\n-     * deployment document and defaults for the rest.\n+     * deployment document, if not, those stored in the kernel config for previous\n+     * deployments and defaults for the rest.\n      */\n     private Set<PackageParameter> resolveParameterValuesToUse(DeploymentDocument document, Package pkg) {\n         // If values for parameters were set in deployment they should be used\n         Set<PackageParameter> resolvedParams = new HashSet<>(getParametersFromDeployment(document, pkg));\n \n-        // Use defaults for parameters for which no values were set in deployment\n+        // If not set in deployment, use values from previous deployments that were stored in config\n+        // Retain only those parameters which are still valid for the current version of the package\n+        Set<PackageParameter> parametersFromPreviousDeployments =\n+                getParametersStoredInConfig(pkg.getPackageName()).stream()\n+                        .filter(param -> pkg.getPackageParameters().contains(param)).collect(Collectors.toSet());\n+        resolvedParams.addAll(parametersFromPreviousDeployments);\n+\n+        // Use defaults for parameters for which no values were set in current or previous deployment\n         resolvedParams.addAll(pkg.getPackageParameters());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5d7eb1e5031ef4acb90b9d131c0087577d9c49d"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwMjkyOA==", "bodyText": "If there are new ones and param values are set, they will be used as done at line 175, if not set then at line 181, their defaults will be used. So it applies to any params old or new for which no value was ever set by the customer", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405702928", "createdAt": "2020-04-08T17:45:58Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -163,13 +168,21 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n \n     /*\n      * Resolve values to be used for all package parameters combining those coming from\n-     * deployment document and defaults for the rest.\n+     * deployment document, if not, those stored in the kernel config for previous\n+     * deployments and defaults for the rest.\n      */\n     private Set<PackageParameter> resolveParameterValuesToUse(DeploymentDocument document, Package pkg) {\n         // If values for parameters were set in deployment they should be used\n         Set<PackageParameter> resolvedParams = new HashSet<>(getParametersFromDeployment(document, pkg));\n \n-        // Use defaults for parameters for which no values were set in deployment\n+        // If not set in deployment, use values from previous deployments that were stored in config\n+        // Retain only those parameters which are still valid for the current version of the package\n+        Set<PackageParameter> parametersFromPreviousDeployments =\n+                getParametersStoredInConfig(pkg.getPackageName()).stream()\n+                        .filter(param -> pkg.getPackageParameters().contains(param)).collect(Collectors.toSet());\n+        resolvedParams.addAll(parametersFromPreviousDeployments);\n+\n+        // Use defaults for parameters for which no values were set in current or previous deployment\n         resolvedParams.addAll(pkg.getPackageParameters());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5NzUwNA=="}, "originalCommit": {"oid": "c5d7eb1e5031ef4acb90b9d131c0087577d9c49d"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzU5MDEwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzozNzo1MlrOGC52xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo0Njo0OFrOGC6K8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5ODI0NA==", "bodyText": "Do we need to handle the case when parametersConfig is null?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405698244", "createdAt": "2020-04-08T17:37:52Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +198,18 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(String packageName) {\n+        try {\n+            EvergreenService service = kernel.locate(packageName);\n+            Topic parametersConfig = service.getServiceConfig().lookup(PARAMETERS_CONFIG_KEY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5d7eb1e5031ef4acb90b9d131c0087577d9c49d"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwMzQwOA==", "bodyText": "Yeah, I just made a few changes which handle that case", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405703408", "createdAt": "2020-04-08T17:46:48Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +198,18 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(String packageName) {\n+        try {\n+            EvergreenService service = kernel.locate(packageName);\n+            Topic parametersConfig = service.getServiceConfig().lookup(PARAMETERS_CONFIG_KEY);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY5ODI0NA=="}, "originalCommit": {"oid": "c5d7eb1e5031ef4acb90b9d131c0087577d9c49d"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzYyMjUwOnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo0NzoxOVrOGC6MAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo1NDowM1rOGC6bcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwMzY4Mg==", "bodyText": "We already have this in the aftereach.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405703682", "createdAt": "2020-04-08T17:47:19Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -116,7 +115,8 @@ void GIVEN_blank_kernel_WHEN_deploy_new_services_e2e_THEN_new_services_deployed_\n         Utils.waitForJobToComplete(jobId, Duration.ofMinutes(2));\n         // Ensure that main is finished, which is its terminal state, so this means that all updates ought to be done\n         assertEquals(State.FINISHED, kernel.getMain().getState());\n-        assertEquals(State.FINISHED, EvergreenService.locate(kernel.context, \"CustomerApp\").getState());\n+        assertEquals(State.FINISHED, kernel.locate(\"CustomerApp\").getState());\n+        kernel.shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "206656ba1e5cbc97232f3dd87891d4d3834c1c03"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNzYzNQ==", "bodyText": "Yeah, that was a result of a rebase conflict, fixed it", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405707635", "createdAt": "2020-04-08T17:54:03Z", "author": {"login": "shaguptashaikh"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -116,7 +115,8 @@ void GIVEN_blank_kernel_WHEN_deploy_new_services_e2e_THEN_new_services_deployed_\n         Utils.waitForJobToComplete(jobId, Duration.ofMinutes(2));\n         // Ensure that main is finished, which is its terminal state, so this means that all updates ought to be done\n         assertEquals(State.FINISHED, kernel.getMain().getState());\n-        assertEquals(State.FINISHED, EvergreenService.locate(kernel.context, \"CustomerApp\").getState());\n+        assertEquals(State.FINISHED, kernel.locate(\"CustomerApp\").getState());\n+        kernel.shutdown();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwMzY4Mg=="}, "originalCommit": {"oid": "206656ba1e5cbc97232f3dd87891d4d3834c1c03"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzY0MDkwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo1MjoyMVrOGC6XgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxODoyMjowMlrOGC7b7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNjYyNA==", "bodyText": "typo: too many s. parameters", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405706624", "createdAt": "2020-04-08T17:52:21Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +193,37 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(Package pkg) {\n+        try {\n+            EvergreenService service = kernel.locate(pkg.getPackageName());\n+            Set<PackageParameter> parameterssStoredInConfig = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "206656ba1e5cbc97232f3dd87891d4d3834c1c03"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyNDE0MA==", "bodyText": "Fixed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405724140", "createdAt": "2020-04-08T18:22:02Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +193,37 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(Package pkg) {\n+        try {\n+            EvergreenService service = kernel.locate(pkg.getPackageName());\n+            Set<PackageParameter> parameterssStoredInConfig = new HashSet<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNjYyNA=="}, "originalCommit": {"oid": "206656ba1e5cbc97232f3dd87891d4d3834c1c03"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzY0NDA1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/PackageParameter.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo1MzoxNlrOGC6Zmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOTozMjozMFrOGC93Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNzE2Mg==", "bodyText": "nit:\njust use @getter?\nAlso, the name is a bit confusing since it seemed to me that this was getting the parameter value. But this is actually the parameter's type.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405707162", "createdAt": "2020-04-08T17:53:16Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/PackageParameter.java", "diffHunk": "@@ -46,5 +46,9 @@ public PackageParameter(@JsonProperty(\"name\") String name, @JsonProperty(\"value\"\n         ParameterType(final String val) {\n             this.parameterType = val;\n         }\n+\n+        public String getValue() {\n+            return parameterType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "206656ba1e5cbc97232f3dd87891d4d3834c1c03"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyNTAwNA==", "bodyText": "Using getter, yeah value in this context was the enum value, it was replaced with a getter now, although now when I use it, it becomes getType().getParameterType() which is also not nice to read, but I've left it that way now", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405725004", "createdAt": "2020-04-08T18:23:31Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/PackageParameter.java", "diffHunk": "@@ -46,5 +46,9 @@ public PackageParameter(@JsonProperty(\"name\") String name, @JsonProperty(\"value\"\n         ParameterType(final String val) {\n             this.parameterType = val;\n         }\n+\n+        public String getValue() {\n+            return parameterType;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNzE2Mg=="}, "originalCommit": {"oid": "206656ba1e5cbc97232f3dd87891d4d3834c1c03"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyNzc5Mw==", "bodyText": "Where is it used? Why do you want the stringy value of the type instead of the enum itself?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405727793", "createdAt": "2020-04-08T18:28:14Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/PackageParameter.java", "diffHunk": "@@ -46,5 +46,9 @@ public PackageParameter(@JsonProperty(\"name\") String name, @JsonProperty(\"value\"\n         ParameterType(final String val) {\n             this.parameterType = val;\n         }\n+\n+        public String getValue() {\n+            return parameterType;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNzE2Mg=="}, "originalCommit": {"oid": "206656ba1e5cbc97232f3dd87891d4d3834c1c03"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2Mzk0Mw==", "bodyText": "Because the old one with string is used for deployment doc deserialization directly using string values, I'm not sure if I can change it to use enum, I can give it s shot", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405763943", "createdAt": "2020-04-08T19:32:30Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/PackageParameter.java", "diffHunk": "@@ -46,5 +46,9 @@ public PackageParameter(@JsonProperty(\"name\") String name, @JsonProperty(\"value\"\n         ParameterType(final String val) {\n             this.parameterType = val;\n         }\n+\n+        public String getValue() {\n+            return parameterType;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNzE2Mg=="}, "originalCommit": {"oid": "206656ba1e5cbc97232f3dd87891d4d3834c1c03"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzkzNDg5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOToxMzo0MlrOGC9Qww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOTo1MjoyNFrOGC-gpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NDA1MQ==", "bodyText": "Why not create a new constructor for PackageParameter. I'm assuming that the existing constructor is just going to convert from string to ParameterType, which is pointless since we already have the type.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405754051", "createdAt": "2020-04-08T19:13:42Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +190,37 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(Package pkg) {\n+        try {\n+            EvergreenService service = kernel.locate(pkg.getPackageName());\n+            Set<PackageParameter> parametersStoredInConfig = new HashSet<>();\n+\n+            // Get only those parameters which are still valid for the current version of the package\n+            pkg.getPackageParameters().forEach(parameterFromRecipe -> {\n+                Optional<String> parameterValueStoredInConfig =\n+                        getParameterValueFromServiceConfig(service, parameterFromRecipe.getName());\n+                if (parameterValueStoredInConfig.isPresent()) {\n+                    parametersStoredInConfig\n+                            .add(new PackageParameter(parameterFromRecipe.getName(), parameterValueStoredInConfig.get(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbe6ea3241b87caba227c1bd140834ab0c372506"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc3NDUwMQ==", "bodyText": "Because the old one with string is used for deployment doc deserialization directly using string values, I'm not sure if I can change it to use enum, I can give it s shot", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405774501", "createdAt": "2020-04-08T19:52:24Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +190,37 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(Package pkg) {\n+        try {\n+            EvergreenService service = kernel.locate(pkg.getPackageName());\n+            Set<PackageParameter> parametersStoredInConfig = new HashSet<>();\n+\n+            // Get only those parameters which are still valid for the current version of the package\n+            pkg.getPackageParameters().forEach(parameterFromRecipe -> {\n+                Optional<String> parameterValueStoredInConfig =\n+                        getParameterValueFromServiceConfig(service, parameterFromRecipe.getName());\n+                if (parameterValueStoredInConfig.isPresent()) {\n+                    parametersStoredInConfig\n+                            .add(new PackageParameter(parameterFromRecipe.getName(), parameterValueStoredInConfig.get(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NDA1MQ=="}, "originalCommit": {"oid": "fbe6ea3241b87caba227c1bd140834ab0c372506"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxODMzODkwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMToxMjoxOFrOGDBKIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTozMzo0NlrOGDBzPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNzg5MQ==", "bodyText": "do we need to add the resolved params under a different root to avoid name clashes", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405817891", "createdAt": "2020-04-08T21:12:18Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -92,12 +92,13 @@\n         // then change the following code accordingly\n \n         // Generate dependencies\n-        // TODO : Only platform specific dependencies should be added once deployment document and\n-        // package recipe format supports platform wise dependency specification\n-\n         List<String> dependencyServiceNames = new ArrayList<>(pkg.getDependencies().keySet());\n         resolvedServiceConfig.put(SERVICE_DEPENDENCIES_CONFIG_KEY, dependencyServiceNames);\n+\n+        // State information for deployments\n         resolvedServiceConfig.put(VERSION_CONFIG_KEY, pkg.getVersion());\n+        resolvedParams.forEach(param -> resolvedServiceConfig.putIfAbsent(param.getName(), param.getValue()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f2a6b304b8fc5b0b250950d727a4493e9313229"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyMDQ3OQ==", "bodyText": "That's what we had done earlier but later decided to add them directly as service config. There can be naming clashes only if there is other config keys with those names, which is part of the custom config that we are not doing in 2020 like Michael pointed out earlier in his comment, so we shouldn't face name conflicts. Once we start supporting custom config and this becomes a problem we can reorganize this", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405820479", "createdAt": "2020-04-08T21:17:12Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -92,12 +92,13 @@\n         // then change the following code accordingly\n \n         // Generate dependencies\n-        // TODO : Only platform specific dependencies should be added once deployment document and\n-        // package recipe format supports platform wise dependency specification\n-\n         List<String> dependencyServiceNames = new ArrayList<>(pkg.getDependencies().keySet());\n         resolvedServiceConfig.put(SERVICE_DEPENDENCIES_CONFIG_KEY, dependencyServiceNames);\n+\n+        // State information for deployments\n         resolvedServiceConfig.put(VERSION_CONFIG_KEY, pkg.getVersion());\n+        resolvedParams.forEach(param -> resolvedServiceConfig.putIfAbsent(param.getName(), param.getValue()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNzg5MQ=="}, "originalCommit": {"oid": "3f2a6b304b8fc5b0b250950d727a4493e9313229"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyODQxMg==", "bodyText": "Sorry I had misunderstood the comment, the parameters are stored under the parameters key like you said, please take a quick look at the new revision", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405828412", "createdAt": "2020-04-08T21:33:46Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -92,12 +92,13 @@\n         // then change the following code accordingly\n \n         // Generate dependencies\n-        // TODO : Only platform specific dependencies should be added once deployment document and\n-        // package recipe format supports platform wise dependency specification\n-\n         List<String> dependencyServiceNames = new ArrayList<>(pkg.getDependencies().keySet());\n         resolvedServiceConfig.put(SERVICE_DEPENDENCIES_CONFIG_KEY, dependencyServiceNames);\n+\n+        // State information for deployments\n         resolvedServiceConfig.put(VERSION_CONFIG_KEY, pkg.getVersion());\n+        resolvedParams.forEach(param -> resolvedServiceConfig.putIfAbsent(param.getName(), param.getValue()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxNzg5MQ=="}, "originalCommit": {"oid": "3f2a6b304b8fc5b0b250950d727a4493e9313229"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxODM2MjU4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMToxOTozNVrOGDBYvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMToyMjo1MVrOGDBe1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyMTYyOQ==", "bodyText": "shouldn't his be kernel.locate(\"services\", \"packagename\") assuming package name = service name", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405821629", "createdAt": "2020-04-08T21:19:35Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +190,37 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(Package pkg) {\n+        try {\n+            EvergreenService service = kernel.locate(pkg.getPackageName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f2a6b304b8fc5b0b250950d727a4493e9313229"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyMzE4OA==", "bodyText": "No, the locate method automatically looks under the 'services' namespace, and yes package name is the same as the service name", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405823188", "createdAt": "2020-04-08T21:22:51Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -185,4 +190,37 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n         }\n         return Collections.emptySet();\n     }\n+\n+    /*\n+     * Get parameter values for a package stored in config that were set by customer in previous deployment.\n+     */\n+    private Set<PackageParameter> getParametersStoredInConfig(Package pkg) {\n+        try {\n+            EvergreenService service = kernel.locate(pkg.getPackageName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyMTYyOQ=="}, "originalCommit": {"oid": "3f2a6b304b8fc5b0b250950d727a4493e9313229"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxODUxMDEyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMjoxMTowOVrOGDCydg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMjoxNjoxN1rOGDC6EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0NDU5OA==", "bodyText": "Please don't add this ignore. It needs to be thought through better.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405844598", "createdAt": "2020-04-08T22:11:09Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -750,7 +669,7 @@ protected void shutdown() throws InterruptedException {\n      *\n      * @return future completes when the lifecycle thread shuts down.\n      */\n-    @SuppressWarnings(\"PMD.AvoidCatchingGenericException\")\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidGettingFutureWithoutTimeout\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f82c786a6ec82587b2567d90483710cd1f73ff"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0NjU0NQ==", "bodyText": "Removed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405846545", "createdAt": "2020-04-08T22:16:17Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -750,7 +669,7 @@ protected void shutdown() throws InterruptedException {\n      *\n      * @return future completes when the lifecycle thread shuts down.\n      */\n-    @SuppressWarnings(\"PMD.AvoidCatchingGenericException\")\n+    @SuppressWarnings({\"PMD.AvoidCatchingGenericException\", \"PMD.AvoidGettingFutureWithoutTimeout\"})", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0NDU5OA=="}, "originalCommit": {"oid": "43f82c786a6ec82587b2567d90483710cd1f73ff"}, "originalPosition": 130}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxODUxMDg0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMjoxMToyNVrOGDCy5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMjoxNjoyMFrOGDC6IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0NDcxMA==", "bodyText": "Same here.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405844710", "createdAt": "2020-04-08T22:11:25Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -658,11 +661,12 @@ protected void waitForServicesToStart(Set<EvergreenService> servicesToTrack,\n         }\n     }\n \n+    @SuppressWarnings(\"PMD.AvoidGettingFutureWithoutTimeout\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f82c786a6ec82587b2567d90483710cd1f73ff"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0NjU2MQ==", "bodyText": "Removed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/159#discussion_r405846561", "createdAt": "2020-04-08T22:16:20Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -658,11 +661,12 @@ protected void waitForServicesToStart(Set<EvergreenService> servicesToTrack,\n         }\n     }\n \n+    @SuppressWarnings(\"PMD.AvoidGettingFutureWithoutTimeout\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0NDcxMA=="}, "originalCommit": {"oid": "43f82c786a6ec82587b2567d90483710cd1f73ff"}, "originalPosition": 64}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 0, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}