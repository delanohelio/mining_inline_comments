{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDcxMjc4", "number": 100, "reviewThreads": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDowNTo0M1rODl-fgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzo0NDoyM1rODnLpzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ3Nzc5OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/resources/com/aws/iot/evergreen/integrationtests/ipc/ipc.yaml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDowNTo0M1rOFzK4zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDowNTo0M1rOFzK4zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMDA3Nw==", "bodyText": "remove these commented out things as it no longer applies.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389200077", "createdAt": "2020-03-07T00:05:43Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/resources/com/aws/iot/evergreen/integrationtests/ipc/ipc.yaml", "diffHunk": "@@ -1,27 +1,27 @@\n ---\n+services:\n+  #launchers:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ3OTczOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/dependency/Context.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDowNzoxMVrOFzK57Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMTowOTowNlrOFzLjKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMDM2NQ==", "bodyText": "Did you look at Crashable? James added that a little while back for having functions which can throw exceptions.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389200365", "createdAt": "2020-03-07T00:07:11Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/dependency/Context.java", "diffHunk": "@@ -400,7 +401,7 @@ public final synchronized T put(T v) {\n             }\n         }\n \n-        public final synchronized T computeIfEmpty(Function<Value, T> s) {\n+        public final synchronized <E extends Exception> T computeIfEmpty(ThrowsFunction<Value, T, E> s) throws E {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMDkyMg==", "bodyText": "Just took a look. Crashable doesn't return a value which we need to put into the map", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389210922", "createdAt": "2020-03-07T01:09:06Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/dependency/Context.java", "diffHunk": "@@ -400,7 +401,7 @@ public final synchronized T put(T v) {\n             }\n         }\n \n-        public final synchronized T computeIfEmpty(Function<Value, T> s) {\n+        public final synchronized <E extends Exception> T computeIfEmpty(ThrowsFunction<Value, T, E> s) throws E {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMDM2NQ=="}, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ4Mzk2OnYy", "diffSide": "LEFT", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxMDoyN1rOFzK8kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMTowOToyMVrOFzLjRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTA0MA==", "bodyText": "Delete all references to this search url list if we're not going to look anything up from it.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389201040", "createdAt": "2020-03-07T00:10:27Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -155,54 +157,38 @@ public synchronized void reportState(State newState) {\n      * @param context context to lookup the name in\n      * @param name    name of the service to find\n      * @return found service or null\n+     * @throws ServiceLoadException\n      */\n     @SuppressWarnings({\"checkstyle:emptycatchblock\"})\n-    public static EvergreenService locate(Context context, String name) {\n+    public static EvergreenService locate(Context context, String name) throws ServiceLoadException {\n         return context.getv(EvergreenService.class, name).computeIfEmpty(v -> {\n             Configuration configuration = context.get(Configuration.class);\n-            Topics topics = configuration.lookupTopics(Configuration.splitPath(name));\n-            assert (topics != null);\n-            if (topics.isEmpty()) {\n-                // No definition of this service was found in the config file.\n-                // weave config fragments in from elsewhere...\n-                Kernel kernel = context.get(Kernel.class);\n-                for (String serverUrl : kernel.getServiceServerURLList()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMDk1MQ==", "bodyText": "Sure", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389210951", "createdAt": "2020-03-07T01:09:21Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -155,54 +157,38 @@ public synchronized void reportState(State newState) {\n      * @param context context to lookup the name in\n      * @param name    name of the service to find\n      * @return found service or null\n+     * @throws ServiceLoadException\n      */\n     @SuppressWarnings({\"checkstyle:emptycatchblock\"})\n-    public static EvergreenService locate(Context context, String name) {\n+    public static EvergreenService locate(Context context, String name) throws ServiceLoadException {\n         return context.getv(EvergreenService.class, name).computeIfEmpty(v -> {\n             Configuration configuration = context.get(Configuration.class);\n-            Topics topics = configuration.lookupTopics(Configuration.splitPath(name));\n-            assert (topics != null);\n-            if (topics.isEmpty()) {\n-                // No definition of this service was found in the config file.\n-                // weave config fragments in from elsewhere...\n-                Kernel kernel = context.get(Kernel.class);\n-                for (String serverUrl : kernel.getServiceServerURLList()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTA0MA=="}, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ4NTU1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxMTozMFrOFzK9fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMTowOTozM1rOFzLjVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTI3Ng==", "bodyText": "You have a duplicate setCause", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389201276", "createdAt": "2020-03-07T00:11:30Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -213,59 +199,41 @@ public static EvergreenService locate(Context context, String name) {\n                     clazz = si.get(name);\n                 }\n             }\n+            // If found class, try to load service class from plugins.\n             if (clazz != null) {\n                 try {\n                     Constructor<?> ctor = clazz.getConstructor(Topics.class);\n-                    ret = (EvergreenService) ctor.newInstance(topics);\n+                    ret = (EvergreenService) ctor.newInstance(serviceRootTopics);\n                     if (clazz.getAnnotation(Singleton.class) != null) {\n                         context.put(ret.getClass(), v);\n                     }\n                     staticLogger.atInfo().setEventType(\"evergreen-service-loaded\")\n                             .addKeyValue(\"serviceName\", ret.getName()).log();\n                 } catch (Throwable ex) {\n-                    staticLogger.atError().setCause(ex).setEventType(\"evergreen-service-load-error\")\n+                    staticLogger.atError().setCause(ex).setEventType(\"evergreen-service-load-error\").setCause(ex)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMDk2NQ==", "bodyText": "Ooops.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389210965", "createdAt": "2020-03-07T01:09:33Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -213,59 +199,41 @@ public static EvergreenService locate(Context context, String name) {\n                     clazz = si.get(name);\n                 }\n             }\n+            // If found class, try to load service class from plugins.\n             if (clazz != null) {\n                 try {\n                     Constructor<?> ctor = clazz.getConstructor(Topics.class);\n-                    ret = (EvergreenService) ctor.newInstance(topics);\n+                    ret = (EvergreenService) ctor.newInstance(serviceRootTopics);\n                     if (clazz.getAnnotation(Singleton.class) != null) {\n                         context.put(ret.getClass(), v);\n                     }\n                     staticLogger.atInfo().setEventType(\"evergreen-service-loaded\")\n                             .addKeyValue(\"serviceName\", ret.getName()).log();\n                 } catch (Throwable ex) {\n-                    staticLogger.atError().setCause(ex).setEventType(\"evergreen-service-load-error\")\n+                    staticLogger.atError().setCause(ex).setEventType(\"evergreen-service-load-error\").setCause(ex)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTI3Ng=="}, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ4Njc4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxMjozOFrOFzK-Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxMjozOFrOFzK-Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTQ4Mw==", "bodyText": "This comment is misplaced, should be on 223. Here it should be \"if class not found and nothing found in config, then throw\"", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389201483", "createdAt": "2020-03-07T00:12:38Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -213,59 +199,41 @@ public static EvergreenService locate(Context context, String name) {\n                     clazz = si.get(name);\n                 }\n             }\n+            // If found class, try to load service class from plugins.\n             if (clazz != null) {\n                 try {\n                     Constructor<?> ctor = clazz.getConstructor(Topics.class);\n-                    ret = (EvergreenService) ctor.newInstance(topics);\n+                    ret = (EvergreenService) ctor.newInstance(serviceRootTopics);\n                     if (clazz.getAnnotation(Singleton.class) != null) {\n                         context.put(ret.getClass(), v);\n                     }\n                     staticLogger.atInfo().setEventType(\"evergreen-service-loaded\")\n                             .addKeyValue(\"serviceName\", ret.getName()).log();\n                 } catch (Throwable ex) {\n-                    staticLogger.atError().setCause(ex).setEventType(\"evergreen-service-load-error\")\n+                    staticLogger.atError().setCause(ex).setEventType(\"evergreen-service-load-error\").setCause(ex)\n                             .addKeyValue(\"className\", clazz.getName()).log(\"Can't create Evergreen Service instance\");\n-                    ret = errNode(context, name, \"Can't create code-backed service from \" + clazz.getSimpleName(), ex);\n+                    throw new ServiceLoadException(\"Can't create code-backed service from \" + clazz.getSimpleName());\n                 }\n-            } else if (topics.isEmpty()) {\n+            // if not found, initialize GenericExternalService", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ4ODY5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxNDowOVrOFzK_dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxNDowOVrOFzK_dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTc4MA==", "bodyText": "This log won't do any good since you haven't provided placeholders {}. This should be\nlogger.error(\"Unable to load service {}\", s, se), or use addKeyValue", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389201780", "createdAt": "2020-03-07T00:14:09Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -284,6 +285,8 @@ public Kernel launch() {\n             autostart.forEach(s -> {\n                 try {\n                     main.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                } catch (ServiceLoadException se) {\n+                    logger.atError().setCause(se).log(\"Unable to load service\", s, se);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ4OTM4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxNDo0OVrOFzK_4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxNDo0OVrOFzK_4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTg4OQ==", "bodyText": "Should we be throwing from here? I think so.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389201889", "createdAt": "2020-03-07T00:14:49Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -326,7 +329,11 @@ private boolean ensureCreated(Path p) {\n     public EvergreenService getMain() {\n         EvergreenService m = mainService;\n         if (m == null) {\n-            m = mainService = EvergreenService.locate(context, mainServiceName);\n+            try {\n+                m = mainService = EvergreenService.locate(context, mainServiceName);\n+            } catch (ServiceLoadException e) {\n+                logger.atError().log(\"Cannot get main service\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ5MTQ0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxNjoxNVrOFzLBCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMjowMzoxNVrOFz668w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjE4NA==", "bodyText": "Can we fail/succeed faster here instead of doing if-else? Otherwise it is hard to keep track of what is null and what that means.\nNeed to make sure that the future gets completed in this case.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389202184", "createdAt": "2020-03-07T00:16:15Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -576,37 +583,50 @@ private void addServiceSearchURL(Object url) {\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n-        Map<String, CountDownLatch> latches = new HashMap<>();\n-        newConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n-\n-        EvergreenService.GlobalStateChangeListener listener = (service, was) -> {\n-            if (newConfig.containsKey(service.getName()) && service.getState().equals(State.RUNNING)) {\n-                latches.get(service.getName()).countDown();\n-            }\n-            if (latches.values().stream().allMatch(c -> c.getCount() <= 0)) {\n-                totallyCompleteFuture.complete(null);\n-            }\n-        };\n-\n-        totallyCompleteFuture.thenRun(() -> {\n-            context.removeGlobalStateChangeListener(listener);\n-        });\n+        final EvergreenService.GlobalStateChangeListener listener;\n+        final Map<String, Object> serviceConfig;\n+\n+        if (newConfig.get(\"services\") == null) {\n+            listener = null;\n+            serviceConfig = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMTAzNQ==", "bodyText": "I don't know if it's valid if readMerge takes an empty Map", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389211035", "createdAt": "2020-03-07T01:10:07Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -576,37 +583,50 @@ private void addServiceSearchURL(Object url) {\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n-        Map<String, CountDownLatch> latches = new HashMap<>();\n-        newConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n-\n-        EvergreenService.GlobalStateChangeListener listener = (service, was) -> {\n-            if (newConfig.containsKey(service.getName()) && service.getState().equals(State.RUNNING)) {\n-                latches.get(service.getName()).countDown();\n-            }\n-            if (latches.values().stream().allMatch(c -> c.getCount() <= 0)) {\n-                totallyCompleteFuture.complete(null);\n-            }\n-        };\n-\n-        totallyCompleteFuture.thenRun(() -> {\n-            context.removeGlobalStateChangeListener(listener);\n-        });\n+        final EvergreenService.GlobalStateChangeListener listener;\n+        final Map<String, Object> serviceConfig;\n+\n+        if (newConfig.get(\"services\") == null) {\n+            listener = null;\n+            serviceConfig = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjE4NA=="}, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4NzA1OQ==", "bodyText": "Instead of setting to null, just return the completed future immediately.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389987059", "createdAt": "2020-03-09T22:03:15Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -576,37 +583,50 @@ private void addServiceSearchURL(Object url) {\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n-        Map<String, CountDownLatch> latches = new HashMap<>();\n-        newConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n-\n-        EvergreenService.GlobalStateChangeListener listener = (service, was) -> {\n-            if (newConfig.containsKey(service.getName()) && service.getState().equals(State.RUNNING)) {\n-                latches.get(service.getName()).countDown();\n-            }\n-            if (latches.values().stream().allMatch(c -> c.getCount() <= 0)) {\n-                totallyCompleteFuture.complete(null);\n-            }\n-        };\n-\n-        totallyCompleteFuture.thenRun(() -> {\n-            context.removeGlobalStateChangeListener(listener);\n-        });\n+        final EvergreenService.GlobalStateChangeListener listener;\n+        final Map<String, Object> serviceConfig;\n+\n+        if (newConfig.get(\"services\") == null) {\n+            listener = null;\n+            serviceConfig = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjE4NA=="}, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ5MjIwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxNzowM1rOFzLBhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxNzowM1rOFzLBhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjMwOA==", "bodyText": "Remove system outs.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389202308", "createdAt": "2020-03-07T00:17:03Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -576,37 +583,50 @@ private void addServiceSearchURL(Object url) {\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n-        Map<String, CountDownLatch> latches = new HashMap<>();\n-        newConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n-\n-        EvergreenService.GlobalStateChangeListener listener = (service, was) -> {\n-            if (newConfig.containsKey(service.getName()) && service.getState().equals(State.RUNNING)) {\n-                latches.get(service.getName()).countDown();\n-            }\n-            if (latches.values().stream().allMatch(c -> c.getCount() <= 0)) {\n-                totallyCompleteFuture.complete(null);\n-            }\n-        };\n-\n-        totallyCompleteFuture.thenRun(() -> {\n-            context.removeGlobalStateChangeListener(listener);\n-        });\n+        final EvergreenService.GlobalStateChangeListener listener;\n+        final Map<String, Object> serviceConfig;\n+\n+        if (newConfig.get(\"services\") == null) {\n+            listener = null;\n+            serviceConfig = null;\n+        } else {\n+            serviceConfig = (Map<String, Object>) newConfig.get(\"services\");\n+            Map<String, CountDownLatch> latches = new HashMap<>();\n+            serviceConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n+\n+            listener = (service, was) -> {\n+                System.err.println(String.format(\"get service %s update to %s\", service.getName(), service.getState()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ5NDk5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxOToyMVrOFzLDOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoxOToyMVrOFzLDOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjc0Nw==", "bodyText": "This TODO doesn't match the behavior since you don't have requestRestart here, but requestStart, so something needs to change.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389202747", "createdAt": "2020-03-07T00:19:21Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -576,37 +583,50 @@ private void addServiceSearchURL(Object url) {\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n-        Map<String, CountDownLatch> latches = new HashMap<>();\n-        newConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n-\n-        EvergreenService.GlobalStateChangeListener listener = (service, was) -> {\n-            if (newConfig.containsKey(service.getName()) && service.getState().equals(State.RUNNING)) {\n-                latches.get(service.getName()).countDown();\n-            }\n-            if (latches.values().stream().allMatch(c -> c.getCount() <= 0)) {\n-                totallyCompleteFuture.complete(null);\n-            }\n-        };\n-\n-        totallyCompleteFuture.thenRun(() -> {\n-            context.removeGlobalStateChangeListener(listener);\n-        });\n+        final EvergreenService.GlobalStateChangeListener listener;\n+        final Map<String, Object> serviceConfig;\n+\n+        if (newConfig.get(\"services\") == null) {\n+            listener = null;\n+            serviceConfig = null;\n+        } else {\n+            serviceConfig = (Map<String, Object>) newConfig.get(\"services\");\n+            Map<String, CountDownLatch> latches = new HashMap<>();\n+            serviceConfig.forEach((key, v) -> latches.put((String) key, new CountDownLatch(1)));\n+\n+            listener = (service, was) -> {\n+                System.err.println(String.format(\"get service %s update to %s\", service.getName(), service.getState()));\n+                if (serviceConfig.containsKey(service.getName()) && service.getState().equals(State.RUNNING)) {\n+                    latches.get(service.getName()).countDown();\n+                }\n+                if (latches.values().stream().allMatch(c -> c.getCount() <= 0)) {\n+                    totallyCompleteFuture.complete(null);\n+                }\n+            };\n+            totallyCompleteFuture.thenRun(() -> {\n+                context.removeGlobalStateChangeListener(listener);\n+            });\n+        }\n \n         context.get(UpdateSystemSafelyService.class).addUpdateAction(deploymentId, () -> {\n             context.runOnPublishQueueAndWait(() -> {\n                 try {\n                     mergeMap(timestamp, newConfig);\n-                    context.addGlobalStateChangeListener(listener);\n-\n-                    newConfig.keySet().forEach(serviceName -> {\n-                        EvergreenService eg = EvergreenService.locate(context, (String) serviceName);\n-                        if (eg == null) {\n-                            logger.error(\"Could not locate EvergreenService for modified service {}\", serviceName);\n-                        } else if (State.NEW.equals(eg.getState())) {\n-                            eg.requestStart();\n-                        }\n-                    });\n-\n+                    if (listener != null) {\n+                        context.addGlobalStateChangeListener(listener);\n+                        serviceConfig.keySet().forEach(serviceName -> {\n+                            try {\n+                                EvergreenService eg = EvergreenService.locate(context, serviceName);\n+                                // TODO: remove requestRestart here as each service will handle update behavior based on", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ5NjI5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/util/ThrowsFunction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoyMDoyMlrOFzLD-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMToxNzo0OFrOFzLn1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjkzOA==", "bodyText": "What is up with this link? Just use @link FunctionalInterface?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389202938", "createdAt": "2020-03-07T00:20:22Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/util/ThrowsFunction.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.aws.iot.evergreen.util;\n+\n+import java.util.Objects;\n+\n+\n+/**\n+ * Represents a function that accepts one argument and produces a result.\n+ *\n+ * <p>This is a <a href=\"package-summary.html\">functional interface</a>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMjExNw==", "bodyText": "Yeah I just copied from FunctionalInterface. Will remove", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389212117", "createdAt": "2020-03-07T01:17:48Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/util/ThrowsFunction.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.aws.iot.evergreen.util;\n+\n+import java.util.Objects;\n+\n+\n+/**\n+ * Represents a function that accepts one argument and produces a result.\n+ *\n+ * <p>This is a <a href=\"package-summary.html\">functional interface</a>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjkzOA=="}, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ5NzIyOnYy", "diffSide": "RIGHT", "path": "src/test/resources/com/aws/iot/evergreen/kernel/config.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDoyMDo1M1rOFzLEdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMToxNzo1NlrOFzLn6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMzA2MA==", "bodyText": "Remove all search list stuff since you removed the implementation.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389203060", "createdAt": "2020-03-07T00:20:53Z", "author": {"login": "MikeDombo"}, "path": "src/test/resources/com/aws/iot/evergreen/kernel/config.yaml", "diffHunk": "@@ -91,50 +89,35 @@ mqtt:\n           curl --silent -L https://bintray.com/artifact/download/andsel/generic/moquette-0.12.1.tar.gz | tar -zxf - -C $W;\n     shutdown:\n       unix: pkill -9  -f \"io[.]moquette[.]broker[.]Server\" || true\n-  mosquitto:\n-    startup:\n-      macos: brew services restart mosquitto\n-    install:\n-      macos:\n-        skipif: brew list | egrep -i -q mosquitto\n-        script:  brew install mosquitto\n-    shutdown:\n-      macos:\n-        script: brew services stop mosquitto\n-    requires:\n-      macos:\n-        homebrew\n-  tinyembeddedthing:\n-    installer: whatever\n \n-fallbackMain:  # This service only gets invoked if the main service fails to even begin to boot\n-  startup: echo sudo reboot -force   # TODO: this is stupid.  Should try to talk to cloud\n-broken:\n-  startup: exit -1\n-ticktock:\n-  run: echo tick-tock\n-  periodic: 2 seconds\n-setenv:\n-  ANSWER: 42\n-main:\n-  install:\n-    skipif: true\n-    all: echo All installed\n-  requires:\n-    macos: jdk11, git, hello-docker, hello-docker-nginx, mqtt, ticktock:INSTALLED\n-    linux: jdk11, git, mqtt, ticktock:INSTALLED # Remove docker dependency for github code check run due to docker install failure.\n-  xyzzy: localhttp, broken\n+  fallbackMain:  # This service only gets invoked if the main service fails to even begin to boot\n+    startup: echo sudo reboot -force   # TODO: this is stupid.  Should try to talk to cloud\n+  broken:\n+    startup: exit -1\n+  ticktock:\n+    run: echo tick-tock\n+    periodic: 2 seconds\n   setenv:\n-    JUSTME: fancy a spot of tea?\n-  run: |-\n-    echo $PATH\n-    pwd\n-    printenv\n-    while true; do\n-    date; sleep 5; echo RUNNING\n-    done\n-  download:\n-    hw.jar: http://foo/hw.jar\n-  args: -jar {hw.jar}\n-system:\n-  ServiceSearchList: https://raw.githubusercontent.com/JamesGosling/SailingForecast/master/docs/evg/\n\\ No newline at end of file\n+    ANSWER: 42\n+  main:\n+    install:\n+      skipif: true\n+      all: echo All installed\n+    requires:\n+      macos: jdk11, git, hello-docker, hello-docker-nginx, mqtt, ticktock:INSTALLED\n+      linux: jdk11, git, mqtt, ticktock:INSTALLED # Remove docker dependency for github code check run due to docker install failure.\n+    xyzzy: localhttp, broken\n+    setenv:\n+      JUSTME: fancy a spot of tea?\n+    run: |-\n+      echo $PATH\n+      pwd\n+      printenv\n+      while true; do\n+      date; sleep 5; echo RUNNING\n+      done\n+    download:\n+      hw.jar: http://foo/hw.jar\n+    args: -jar {hw.jar}\n+  system:\n+    ServiceSearchList: https://raw.githubusercontent.com/JamesGosling/SailingForecast/master/docs/evg/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 237}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMjEzNw==", "bodyText": "Sure", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r389212137", "createdAt": "2020-03-07T01:17:56Z", "author": {"login": "ShirleyZheng92"}, "path": "src/test/resources/com/aws/iot/evergreen/kernel/config.yaml", "diffHunk": "@@ -91,50 +89,35 @@ mqtt:\n           curl --silent -L https://bintray.com/artifact/download/andsel/generic/moquette-0.12.1.tar.gz | tar -zxf - -C $W;\n     shutdown:\n       unix: pkill -9  -f \"io[.]moquette[.]broker[.]Server\" || true\n-  mosquitto:\n-    startup:\n-      macos: brew services restart mosquitto\n-    install:\n-      macos:\n-        skipif: brew list | egrep -i -q mosquitto\n-        script:  brew install mosquitto\n-    shutdown:\n-      macos:\n-        script: brew services stop mosquitto\n-    requires:\n-      macos:\n-        homebrew\n-  tinyembeddedthing:\n-    installer: whatever\n \n-fallbackMain:  # This service only gets invoked if the main service fails to even begin to boot\n-  startup: echo sudo reboot -force   # TODO: this is stupid.  Should try to talk to cloud\n-broken:\n-  startup: exit -1\n-ticktock:\n-  run: echo tick-tock\n-  periodic: 2 seconds\n-setenv:\n-  ANSWER: 42\n-main:\n-  install:\n-    skipif: true\n-    all: echo All installed\n-  requires:\n-    macos: jdk11, git, hello-docker, hello-docker-nginx, mqtt, ticktock:INSTALLED\n-    linux: jdk11, git, mqtt, ticktock:INSTALLED # Remove docker dependency for github code check run due to docker install failure.\n-  xyzzy: localhttp, broken\n+  fallbackMain:  # This service only gets invoked if the main service fails to even begin to boot\n+    startup: echo sudo reboot -force   # TODO: this is stupid.  Should try to talk to cloud\n+  broken:\n+    startup: exit -1\n+  ticktock:\n+    run: echo tick-tock\n+    periodic: 2 seconds\n   setenv:\n-    JUSTME: fancy a spot of tea?\n-  run: |-\n-    echo $PATH\n-    pwd\n-    printenv\n-    while true; do\n-    date; sleep 5; echo RUNNING\n-    done\n-  download:\n-    hw.jar: http://foo/hw.jar\n-  args: -jar {hw.jar}\n-system:\n-  ServiceSearchList: https://raw.githubusercontent.com/JamesGosling/SailingForecast/master/docs/evg/\n\\ No newline at end of file\n+    ANSWER: 42\n+  main:\n+    install:\n+      skipif: true\n+      all: echo All installed\n+    requires:\n+      macos: jdk11, git, hello-docker, hello-docker-nginx, mqtt, ticktock:INSTALLED\n+      linux: jdk11, git, mqtt, ticktock:INSTALLED # Remove docker dependency for github code check run due to docker install failure.\n+    xyzzy: localhttp, broken\n+    setenv:\n+      JUSTME: fancy a spot of tea?\n+    run: |-\n+      echo $PATH\n+      pwd\n+      printenv\n+      while true; do\n+      date; sleep 5; echo RUNNING\n+      done\n+    download:\n+      hw.jar: http://foo/hw.jar\n+    args: -jar {hw.jar}\n+  system:\n+    ServiceSearchList: https://raw.githubusercontent.com/JamesGosling/SailingForecast/master/docs/evg/", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMzA2MA=="}, "originalCommit": {"oid": "cf2c6ed80b13c90819027629e7e7f5a39812655d"}, "originalPosition": 237}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMDQ3NTUxOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxOTo1ODo1N1rOF0e0rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMDozNzoyMFrOF0gECw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU3NTI3Ng==", "bodyText": "This is expected? Why have both name and full name in that case?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r390575276", "createdAt": "2020-03-10T19:58:57Z", "author": {"login": "chaurah"}, "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -47,7 +47,7 @@\n     void beforeEach() {\n         Mockito.when(config.createLeafChild(eq(\"_State\"))).thenReturn(stateTopic);\n         Mockito.when(config.createLeafChild(eq(\"requires\"))).thenReturn(requiresTopic);\n-        Mockito.when(config.getFullName()).thenReturn(EVERGREEN_SERVICE_FULL_NAME);\n+        Mockito.when(config.getName()).thenReturn(EVERGREEN_SERVICE_FULL_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc8822632c7287f4184651370c08dcb33276e186"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU5NTU5NQ==", "bodyText": "Full name is services.foo , name is foo", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r390595595", "createdAt": "2020-03-10T20:37:20Z", "author": {"login": "ShirleyZheng92"}, "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -47,7 +47,7 @@\n     void beforeEach() {\n         Mockito.when(config.createLeafChild(eq(\"_State\"))).thenReturn(stateTopic);\n         Mockito.when(config.createLeafChild(eq(\"requires\"))).thenReturn(requiresTopic);\n-        Mockito.when(config.getFullName()).thenReturn(EVERGREEN_SERVICE_FULL_NAME);\n+        Mockito.when(config.getName()).thenReturn(EVERGREEN_SERVICE_FULL_NAME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU3NTI3Ng=="}, "originalCommit": {"oid": "bc8822632c7287f4184651370c08dcb33276e186"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNDA4NDAxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/exceptions/ServiceLoadException.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzozNTo1M1rOF1BqMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzo1MTowMlrOF1CRAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0NjAzMg==", "bodyText": "I'd say the name isn't descriptive enough... Also Load is very generic... What kind of error are we trying to throw here? Unable to locate?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391146032", "createdAt": "2020-03-11T17:35:53Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/exceptions/ServiceLoadException.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.kernel.exceptions;\n+\n+public class ServiceLoadException extends Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c816b7c0aa898193c237b61a07213d66113b6586"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1NTk3MA==", "bodyText": "Unable to locate service, unable to find class, etc. Let's discuss the candidate names", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391155970", "createdAt": "2020-03-11T17:51:02Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/exceptions/ServiceLoadException.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.kernel.exceptions;\n+\n+public class ServiceLoadException extends Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0NjAzMg=="}, "originalCommit": {"oid": "c816b7c0aa898193c237b61a07213d66113b6586"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNDA5MTk3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzozNzo1NVrOF1BvZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzo1MDowMVrOF1COmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0NzM2NQ==", "bodyText": "I did notice the strange restarting behavior of SafeSystemUpdate service. Is this related to the flakiness of MergeConfigTest?\nAlso do we have a plan forward for the TODO? I think this one has high priority.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391147365", "createdAt": "2020-03-11T17:37:55Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -280,10 +281,19 @@ public Kernel launch() {\n             context.put(ShellRunner.class, context.get(ShellRunner.Dryrun.class));\n         }\n         try {\n-            EvergreenService main = getMain(); // Trigger boot  (!?!?)\n+            mainService = getMain();\n             autostart.forEach(s -> {\n                 try {\n-                    main.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                    if (!s.contains(\"SafeSystemUpdate\")) {\n+                        mainService.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                    } else {\n+                        // SafeSystemUpdate will reset to Installed after update.\n+                        // This is a hacky way to avoid restarting depending services.\n+                        // TODO: Find a proper way handle this situation.\n+                        mainService.addDependency(EvergreenService.locate(context, s), State.INSTALLED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c816b7c0aa898193c237b61a07213d66113b6586"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1NTM1NA==", "bodyText": "Probably not in this Sprint. This line remove unnecessary restarting services . I'm working on a separate PR on fixing config merge", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391155354", "createdAt": "2020-03-11T17:50:01Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -280,10 +281,19 @@ public Kernel launch() {\n             context.put(ShellRunner.class, context.get(ShellRunner.Dryrun.class));\n         }\n         try {\n-            EvergreenService main = getMain(); // Trigger boot  (!?!?)\n+            mainService = getMain();\n             autostart.forEach(s -> {\n                 try {\n-                    main.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                    if (!s.contains(\"SafeSystemUpdate\")) {\n+                        mainService.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                    } else {\n+                        // SafeSystemUpdate will reset to Installed after update.\n+                        // This is a hacky way to avoid restarting depending services.\n+                        // TODO: Find a proper way handle this situation.\n+                        mainService.addDependency(EvergreenService.locate(context, s), State.INSTALLED);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0NzM2NQ=="}, "originalCommit": {"oid": "c816b7c0aa898193c237b61a07213d66113b6586"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNDEwMDcxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzozOTo0OVrOF1B0xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzo1Mjo0NVrOF1CVQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0ODc0Mw==", "bodyText": "If root service isn't found, should this be an error?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391148743", "createdAt": "2020-03-11T17:39:49Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -155,117 +160,87 @@ public synchronized void reportState(State newState) {\n      * @param context context to lookup the name in\n      * @param name    name of the service to find\n      * @return found service or null\n+     * @throws ServiceLoadException if service cannot load\n      */\n     @SuppressWarnings({\"checkstyle:emptycatchblock\"})\n-    public static EvergreenService locate(Context context, String name) {\n+    public static EvergreenService locate(Context context, String name) throws ServiceLoadException {\n         return context.getv(EvergreenService.class, name).computeIfEmpty(v -> {\n             Configuration configuration = context.get(Configuration.class);\n-            Topics topics = configuration.lookupTopics(Configuration.splitPath(name));\n-            assert (topics != null);\n-            if (topics.isEmpty()) {\n-                // No definition of this service was found in the config file.\n-                // weave config fragments in from elsewhere...\n-                Kernel kernel = context.get(Kernel.class);\n-                for (String serverUrl : kernel.getServiceServerURLList()) {\n-                    if (topics.isEmpty()) {\n-                        try {\n-                            // TODO: should probably think hard about what file extension to use\n-                            // TODO: allow the file to be a zip package?\n-                            URL configUrl = new URL(serverUrl + name + \".evg\");\n-                            kernel.read(configUrl, false);\n-                            if (!topics.isEmpty()) {\n-                                staticLogger.atInfo().setEventType(\"service-config-found\")\n-                                        .addKeyValue(\"configURL\", configUrl).log(\"Found external service definition\");\n-                            }\n-                        } catch (IOException ignored) {\n-                        }\n-                    } else {\n-                        break;\n-                    }\n-                }\n-                if (topics.isEmpty()) {\n-                    topics.createLeafChild(\"run\").dflt(\"echo No definition found for \" + name + \";exit -1\");\n-                    staticLogger.atWarn().setEventType(\"service-config-not-found\").addKeyValue(\"serviceName\", name)\n-                            .log();\n-                }\n+            Topics serviceRootTopics = configuration.lookupTopics(SERVICES_NAMESPACE_TOPIC, name);\n+            if (serviceRootTopics == null || serviceRootTopics.isEmpty()) {\n+                staticLogger.atWarn().setEventType(\"service-config-not-found\").addKeyValue(\"serviceName\", name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c816b7c0aa898193c237b61a07213d66113b6586"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1NzA1OA==", "bodyText": "It's not an error, because some services like \"ipc\" or \" SafeSystemUpdate\" doesn't have config in the yaml file", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391157058", "createdAt": "2020-03-11T17:52:45Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -155,117 +160,87 @@ public synchronized void reportState(State newState) {\n      * @param context context to lookup the name in\n      * @param name    name of the service to find\n      * @return found service or null\n+     * @throws ServiceLoadException if service cannot load\n      */\n     @SuppressWarnings({\"checkstyle:emptycatchblock\"})\n-    public static EvergreenService locate(Context context, String name) {\n+    public static EvergreenService locate(Context context, String name) throws ServiceLoadException {\n         return context.getv(EvergreenService.class, name).computeIfEmpty(v -> {\n             Configuration configuration = context.get(Configuration.class);\n-            Topics topics = configuration.lookupTopics(Configuration.splitPath(name));\n-            assert (topics != null);\n-            if (topics.isEmpty()) {\n-                // No definition of this service was found in the config file.\n-                // weave config fragments in from elsewhere...\n-                Kernel kernel = context.get(Kernel.class);\n-                for (String serverUrl : kernel.getServiceServerURLList()) {\n-                    if (topics.isEmpty()) {\n-                        try {\n-                            // TODO: should probably think hard about what file extension to use\n-                            // TODO: allow the file to be a zip package?\n-                            URL configUrl = new URL(serverUrl + name + \".evg\");\n-                            kernel.read(configUrl, false);\n-                            if (!topics.isEmpty()) {\n-                                staticLogger.atInfo().setEventType(\"service-config-found\")\n-                                        .addKeyValue(\"configURL\", configUrl).log(\"Found external service definition\");\n-                            }\n-                        } catch (IOException ignored) {\n-                        }\n-                    } else {\n-                        break;\n-                    }\n-                }\n-                if (topics.isEmpty()) {\n-                    topics.createLeafChild(\"run\").dflt(\"echo No definition found for \" + name + \";exit -1\");\n-                    staticLogger.atWarn().setEventType(\"service-config-not-found\").addKeyValue(\"serviceName\", name)\n-                            .log();\n-                }\n+            Topics serviceRootTopics = configuration.lookupTopics(SERVICES_NAMESPACE_TOPIC, name);\n+            if (serviceRootTopics == null || serviceRootTopics.isEmpty()) {\n+                staticLogger.atWarn().setEventType(\"service-config-not-found\").addKeyValue(\"serviceName\", name);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0ODc0Mw=="}, "originalCommit": {"oid": "c816b7c0aa898193c237b61a07213d66113b6586"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNDEwMjM3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/config/Node.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzo0MDoxNVrOF1B13g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzo0MDoxNVrOF1B13g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0OTAyMg==", "bodyText": "Love this!!!", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391149022", "createdAt": "2020-03-11T17:40:15Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/config/Node.java", "diffHunk": "@@ -57,6 +57,10 @@ public String getFullName() {\n         return fnc;\n     }\n \n+    public String getName() {\n+        return name;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c816b7c0aa898193c237b61a07213d66113b6586"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNDExOTgxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzo0NDoyM1rOF1CAhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjozMToyN1rOF1LhTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1MTc0OA==", "bodyText": "Does newConfig has a services key? Is that change made to the UpdatingKernelState in deployment?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391151748", "createdAt": "2020-03-11T17:44:23Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -573,21 +587,29 @@ private void addServiceSearchURL(Object url) {\n      * @param newConfig    the map of new configuration\n      * @return future which completes only once the config is merged and all the services in the config are running\n      */\n+    @SuppressFBWarnings(\"NP_NONNULL_PARAM_VIOLATION\") // https://github.com/findbugsproject/findbugs/issues/79\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n+\n+        if (newConfig.get(\"services\") == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c816b7c0aa898193c237b61a07213d66113b6586"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMwNzU5OA==", "bodyText": "Updated", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/100#discussion_r391307598", "createdAt": "2020-03-11T22:31:27Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -573,21 +587,29 @@ private void addServiceSearchURL(Object url) {\n      * @param newConfig    the map of new configuration\n      * @return future which completes only once the config is merged and all the services in the config are running\n      */\n+    @SuppressFBWarnings(\"NP_NONNULL_PARAM_VIOLATION\") // https://github.com/findbugsproject/findbugs/issues/79\n     public Future<Void> mergeInNewConfig(String deploymentId, long timestamp, Map<Object, Object> newConfig) {\n         CompletableFuture<Void> totallyCompleteFuture = new CompletableFuture<>();\n \n+\n+        if (newConfig.get(\"services\") == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1MTc0OA=="}, "originalCommit": {"oid": "c816b7c0aa898193c237b61a07213d66113b6586"}, "originalPosition": 68}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4864, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}