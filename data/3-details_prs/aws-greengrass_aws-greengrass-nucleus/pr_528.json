{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNTg1MDU5", "number": 528, "title": "Named shadows for device deployment", "bodyText": "Issue #, if available:\nMove to using named shadows for device deployment.\nHow was this change tested:\nE2e tests.\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-14T19:16:00Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528", "merged": true, "mergeCommit": {"oid": "8c713e74ead9f386caba35e4cb42092b06675997"}, "closed": true, "closedAt": "2020-10-15T19:11:22Z", "author": {"login": "fahadmohammed01"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSiJX8gH2gAyNTAzNTg1MDU5OjNmZDcwZmI5NTE5ZDkzZGUyZGY5Yzc0NWIxYTJiODgxNTYzYThhZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS2ZcMAH2gAyNTAzNTg1MDU5Ojk0OTU5MWU1ZTY0YTY4ZDVlMTg5NTM2ZDcyZTIzMTBjZjI3NDViYzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3fd70fb9519d93de2df9c745b1a2b881563a8afc", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3fd70fb9519d93de2df9c745b1a2b881563a8afc", "committedDate": "2020-10-14T19:14:53Z", "message": "move to named shadows for device deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e783ba4ca143e84834f7690daa8e6c7d743afe46", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e783ba4ca143e84834f7690daa8e6c7d743afe46", "committedDate": "2020-10-14T19:17:08Z", "message": "Merge branch 'master' into use-named-shadows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjU0OTg4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528#pullrequestreview-508654988", "createdAt": "2020-10-14T19:19:04Z", "commit": {"oid": "3fd70fb9519d93de2df9c745b1a2b881563a8afc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxOToxOTowNFrOHhhjzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxOToxOTowNFrOHhhjzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxNDg5Mg==", "bodyText": "Recommendation generated by Amazon CodeGuru Reviewer. Leave feedback on this recommendation by replying to the comment or by reacting to the comment using emoji.\nProblem\nYou are using a ConcurrentLinkedQueue, but your usage of peek(), null check, and remove() may not be thread-safe at lines: 187, 190, 195, and 210. If the ConcurrentLinkedQueue contains only one element and two threads perform this same check at the same time , the second thread's call to remove() will throw NoSuchElementException.\nFix\nConsider using poll() (does not throw an exception, but it may return null, which you can check for) or handling the exception.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528#discussion_r504914892", "createdAt": "2020-10-14T19:19:04Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/deployment/ShadowDeploymentListener.java", "diffHunk": "@@ -193,10 +201,11 @@ private Boolean deploymentStatusChanged(Map<String, Object> deploymentDetails) {\n             try {\n                 ShadowState shadowState = new ShadowState();\n                 shadowState.reported = new HashMap<>(desired.getRight());\n-                UpdateShadowRequest updateShadowRequest = new UpdateShadowRequest();\n-                updateShadowRequest.thingName = thingName;\n-                updateShadowRequest.state = shadowState;\n-                iotShadowClient.PublishUpdateShadow(updateShadowRequest, QualityOfService.AT_LEAST_ONCE)\n+                UpdateNamedShadowRequest updateNamedShadowRequest = new UpdateNamedShadowRequest();\n+                updateNamedShadowRequest.shadowName = DEPLOYMENT_SHADOW_NAME;\n+                updateNamedShadowRequest.thingName = thingName;\n+                updateNamedShadowRequest.state = shadowState;\n+                iotShadowClient.PublishUpdateNamedShadow(updateNamedShadowRequest, QualityOfService.AT_LEAST_ONCE)\n                         .get(TIMEOUT_FOR_PUBLISHING_TO_TOPICS_SECONDS, TimeUnit.SECONDS);\n                 desiredStateQueue.remove();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fd70fb9519d93de2df9c745b1a2b881563a8afc"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxNDg5NQ==", "bodyText": "Recommendation generated by Amazon CodeGuru Reviewer. Leave feedback on this recommendation by replying to the comment or by reacting to the comment using emoji.\nProblem\nYou are using a ConcurrentLinkedQueue, but your usage of peek(), null check, and remove() may not be thread-safe at lines: 192, 195, 210, and 190. If the ConcurrentLinkedQueue contains only one element and two threads perform this same check at the same time , the second thread's call to remove() will throw NoSuchElementException.\nFix\nConsider using poll() (does not throw an exception, but it may return null, which you can check for) or handling the exception.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528#discussion_r504914895", "createdAt": "2020-10-14T19:19:04Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/deployment/ShadowDeploymentListener.java", "diffHunk": "@@ -193,10 +201,11 @@ private Boolean deploymentStatusChanged(Map<String, Object> deploymentDetails) {\n             try {\n                 ShadowState shadowState = new ShadowState();\n                 shadowState.reported = new HashMap<>(desired.getRight());\n-                UpdateShadowRequest updateShadowRequest = new UpdateShadowRequest();\n-                updateShadowRequest.thingName = thingName;\n-                updateShadowRequest.state = shadowState;\n-                iotShadowClient.PublishUpdateShadow(updateShadowRequest, QualityOfService.AT_LEAST_ONCE)\n+                UpdateNamedShadowRequest updateNamedShadowRequest = new UpdateNamedShadowRequest();\n+                updateNamedShadowRequest.shadowName = DEPLOYMENT_SHADOW_NAME;\n+                updateNamedShadowRequest.thingName = thingName;\n+                updateNamedShadowRequest.state = shadowState;\n+                iotShadowClient.PublishUpdateNamedShadow(updateNamedShadowRequest, QualityOfService.AT_LEAST_ONCE)\n                         .get(TIMEOUT_FOR_PUBLISHING_TO_TOPICS_SECONDS, TimeUnit.SECONDS);\n                 desiredStateQueue.remove();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fd70fb9519d93de2df9c745b1a2b881563a8afc"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjU4NTg4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528#pullrequestreview-508658588", "createdAt": "2020-10-14T19:24:18Z", "commit": {"oid": "e783ba4ca143e84834f7690daa8e6c7d743afe46"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjkzMTM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528#pullrequestreview-508693136", "createdAt": "2020-10-14T20:13:09Z", "commit": {"oid": "e783ba4ca143e84834f7690daa8e6c7d743afe46"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed63a058bc7cb59927ee40bd8a00d8609bb388d3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ed63a058bc7cb59927ee40bd8a00d8609bb388d3", "committedDate": "2020-10-14T20:30:53Z", "message": "Merge branch 'master' into use-named-shadows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab50c67eae369c609fe91250a2e84033c878c11d", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ab50c67eae369c609fe91250a2e84033c878c11d", "committedDate": "2020-10-14T20:47:52Z", "message": "disable flaky test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "640dfc1af03435a0807ac3e5402106f113151a87", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/640dfc1af03435a0807ac3e5402106f113151a87", "committedDate": "2020-10-14T21:53:50Z", "message": "Merge branch 'master' into use-named-shadows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODE0MTU0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528#pullrequestreview-508814154", "createdAt": "2020-10-14T22:28:57Z", "commit": {"oid": "640dfc1af03435a0807ac3e5402106f113151a87"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce02907561b608e466db562695786d574109c7b2", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ce02907561b608e466db562695786d574109c7b2", "committedDate": "2020-10-14T22:33:36Z", "message": "Merge branch 'master' into use-named-shadows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb8425f163c2839e18d98ada27ac363b0a6b76b2", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb8425f163c2839e18d98ada27ac363b0a6b76b2", "committedDate": "2020-10-14T22:58:55Z", "message": "Merge branch 'master' into use-named-shadows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODMwNTA1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/528#pullrequestreview-508830505", "createdAt": "2020-10-14T23:04:20Z", "commit": {"oid": "fb8425f163c2839e18d98ada27ac363b0a6b76b2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57f25557945e36842b135b28a45d080c457d24a1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/57f25557945e36842b135b28a45d080c457d24a1", "committedDate": "2020-10-15T00:07:19Z", "message": "Merge branch 'master' into use-named-shadows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4a193e2200d68953e13bf1f4c9b661d496d6ac2", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f4a193e2200d68953e13bf1f4c9b661d496d6ac2", "committedDate": "2020-10-15T16:14:21Z", "message": "Merge branch 'master' into use-named-shadows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd895915c23530701fba8f91a82f77169a7b60b5", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd895915c23530701fba8f91a82f77169a7b60b5", "committedDate": "2020-10-15T18:20:25Z", "message": "Merge branch 'master' into use-named-shadows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "949591e5e64a68d5e189536d72e2310cf2745bc8", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/949591e5e64a68d5e189536d72e2310cf2745bc8", "committedDate": "2020-10-15T18:50:32Z", "message": "Merge branch 'master' into use-named-shadows"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3159, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}