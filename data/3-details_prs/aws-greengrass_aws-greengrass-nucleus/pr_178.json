{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyOTI5ODg5", "number": 178, "title": "Add deployment e2e test under intermittent mqtt connection and multiple deployments", "bodyText": "Issue #, if available:\nDescription of changes:\nAdd 3 test cases:\n\nGIVEN the device receives a new deployment while it is connected\nWHEN mqtt disconnects and reconnects during the deployment\nTHEN job executes successfully on the device and eventually updates the status in the cloud\nGIVEN multiple deployments are created for a new device\nWHEN the device connects for the first time\nTHEN all the deployments execute successfully in order\nGIVEN an online device\nWHEN multiple deployments are created for this device\nTHEN all the deployments execute successfully in order\n\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-14T02:10:40Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178", "merged": true, "mergeCommit": {"oid": "3b4dc13e1d7b8b36155f9dcacb8eb305cc681669"}, "closed": true, "closedAt": "2020-04-23T22:13:47Z", "author": {"login": "hui-yang"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXbDSVAFqTM5MjU3ODcwNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcakZvugFqTM5OTUxMzg5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTc4NzA2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-392578706", "createdAt": "2020-04-14T03:25:05Z", "commit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMzoyNTowNVrOGE80Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMzozNzowOFrOGE9APA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg0Mzg5MA==", "bodyText": "443 isn't really MQTT, but more commonly HTTPS.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r407843890", "createdAt": "2020-04-14T03:25:05Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/NetworkUtils.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.config.PlatformResolver;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public abstract class NetworkUtils {\n+    protected final List<String> MQTT_PORTS = Arrays.asList(\"8883\", \"443\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg0NDE1NQ==", "bodyText": "Why not make this agnostic to the ports? Pass the ports in as varargs. Since the other methods are specific to what ports are enabled/disabled.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r407844155", "createdAt": "2020-04-14T03:26:11Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/NetworkUtilsLinux.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.util.Exec;\n+import lombok.AllArgsConstructor;\n+\n+@AllArgsConstructor\n+public class NetworkUtilsLinux extends NetworkUtils {\n+    private static final String enableOption = \"--insert\";\n+    private static final String disableOption = \"--delete\";\n+    private static final String commandFormat= \"sudo iptables %s OUTPUT -p tcp --dport %s -j REJECT && \" +\n+            \"sudo iptables %s INPUT -p tcp --sport %s -j REJECT\";\n+\n+    @Override\n+    public void disconnectMqtt() throws InterruptedException {\n+        modifyPolicy(enableOption, \"connection-loss\");\n+    }\n+\n+    @Override\n+    public void recoverMqtt() throws InterruptedException {\n+        modifyPolicy(disableOption, \"connection-recover\");\n+    }\n+\n+    private void modifyPolicy(String option, String eventName) throws InterruptedException {\n+        for (String port : MQTT_PORTS) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg0NDM5Mg==", "bodyText": "This is taking down the entire network, not the specific ports, right? Do we have a better option on mac to limit specific ports?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r407844392", "createdAt": "2020-04-14T03:27:16Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/NetworkUtilsMac.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.util.Exec;\n+import lombok.AllArgsConstructor;\n+\n+@AllArgsConstructor\n+public class NetworkUtilsMac extends NetworkUtils {\n+    private static final String commandFormat = \"sudo ifconfig en0 %s\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg0NDkwNw==", "bodyText": "this interface can just be Iterable.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r407844907", "createdAt": "2020-04-14T03:29:07Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -189,14 +258,12 @@ public static void downloadFileFromURL(String url, File f) throws IOException {\n     }\n \n     public static <T, E extends IotException> T retryIot(CrashableSupplier<T, E> func) {\n-        return retry(DEFAULT_RETRIES, DEFAULT_INITIAL_BACKOFF_MS, func, ThrottlingException.class,\n-                InternalException.class, InternalFailureException.class, LimitExceededException.class);\n+        return retry(DEFAULT_RETRIES, DEFAULT_INITIAL_BACKOFF_MS, func, retryableIoTExceptions);\n     }\n \n     @SuppressWarnings({\"PMD.AssignmentInOperand\", \"PMD.AvoidCatchingThrowable\"})\n-    @SafeVarargs\n     public static <T, E extends Throwable> T retry(int tries, int initialBackoffMillis, CrashableSupplier<T, E> func,\n-                                                   Class<? extends Throwable>... retryableExceptions) throws E {\n+                                                   Collection<Class<? extends Throwable>> retryableExceptions) throws E {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg0NTQ0Mw==", "bodyText": "Whenever we change properties like this, we should undo it in the after, so that it doens't have hard to debug effects.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r407845443", "createdAt": "2020-04-14T03:31:16Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.NetworkUtils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.crt.mqtt.MqttException;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MqttReconnectTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+\n+    private static final Duration DNS_CACHE_TTL = Duration.ofSeconds(10);\n+\n+    @BeforeEach\n+    void beforeEach() throws Exception {\n+        // Setting the JVM TTL for DNS Name Lookups. By default it's set to -1, i.e. DNS entries are never\n+        // refreshed until the JVM is restarted. In this test, we break the network connection in the middle. As\n+        // a result, the AWS endpoint will be resolved to an unknown host for a short period. Set the TTL here to make\n+        // sure the unknown host entries are cleared, otherwise we will get UnknownHostException from AWS SDK clients.\n+        java.security.Security.setProperty(\"networkaddress.cache.ttl\", Long.toString(DNS_CACHE_TTL.getSeconds()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg0Njk3Mg==", "bodyText": "Do we really need both this test and the online scenario? Surely if this one works, then so would the online version. While obviously this gives us even better assurance, I don't want us to have duplicate test cases so early on which may just be wasting time.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r407846972", "createdAt": "2020-04-14T03:37:08Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MultipleDeploymentsTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MultipleDeploymentsTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+    private static final Logger logger = LogManager.getLogger(MultipleDeploymentsTest.class);\n+\n+    @BeforeEach\n+    void beforeEach() throws IOException {\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MultipleDeploymentsTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_online_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        kernel.launch();\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+        for (DeploymentJobHelper helper : helpers) {\n+            helper.createJob(targets);\n+            Utils.waitForJobExecutionStatusToSatisfy(helper.jobId, thing.thingName, Duration.ofMinutes(1),\n+                    s -> s.ordinal() >= JobExecutionStatus.QUEUED.ordinal());\n+        }\n+\n+        // Wait for all jobs to finish\n+        for (DeploymentJobHelper helper : helpers) {\n+            assertTrue(helper.jobCompleted.await(2, TimeUnit.MINUTES), \"Deployment job timed out: \" + helper.jobId);\n+            Utils.waitForJobToComplete(helper.jobId, Duration.ofMinutes(2));\n+\n+            assertEquals(State.FINISHED, kernel.locate(helper.targetPkgName).getState());\n+            assertEquals(JobExecutionStatus.SUCCEEDED, Utils.iotClient.describeJobExecution(\n+                    DescribeJobExecutionRequest.builder().jobId(helper.jobId).thingName(thing.thingName).build())\n+                    .execution().status());\n+        }\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_offline_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order_eventually()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 118}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjMzOTM1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-394233935", "createdAt": "2020-04-16T01:07:48Z", "commit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMTowNzo0OFrOGGQ54Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMjo1NDowMlrOGGSq-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyMTYwMQ==", "bodyText": "I would prefer if this method just updates the kernel config and takes ThingInfo as an input parameter.   Would also rename the method to injectDeploymentConfigurationToKernel", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409221601", "createdAt": "2020-04-16T01:07:48Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -132,6 +178,29 @@ public static ThingInfo createThing() {\n         return info;\n     }\n \n+    public static ThingInfo setupIotResourcesAndInjectIntoKernel(Kernel kernel, Path tempRootDir) throws IOException {\n+        String rootCaFilePath = tempRootDir.resolve(\"rootCA.pem\").toString();\n+        String privateKeyFilePath = tempRootDir.resolve(\"privKey.key\").toString();\n+        String certificateFilePath = tempRootDir.resolve(\"thingCert.crt\").toString();\n+\n+        downloadRootCAToFile(new File(rootCaFilePath));\n+        ThingInfo thing = createThing();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyMjEwNw==", "bodyText": "In Utils, can we split this into two methods, one for provisioning the device (create Iot thing, certs, groups, add the device to group) and other for updating the deployment config in kernel.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409222107", "createdAt": "2020-04-16T01:09:37Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -80,12 +62,12 @@ void afterEach() {\n \n     private void launchKernel(String configFile) throws IOException, InterruptedException {\n         kernel = new Kernel().parseArgs(\"-i\", DeploymentE2ETest.class.getResource(configFile).toString());\n-        setupIotResourcesAndInjectIntoKernel();\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNDU2OQ==", "bodyText": "If we do not want to cache we can set it to 0 instead of setting it to 10?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409224569", "createdAt": "2020-04-16T01:18:31Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.NetworkUtils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.crt.mqtt.MqttException;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MqttReconnectTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+\n+    private static final Duration DNS_CACHE_TTL = Duration.ofSeconds(10);\n+\n+    @BeforeEach\n+    void beforeEach() throws Exception {\n+        // Setting the JVM TTL for DNS Name Lookups. By default it's set to -1, i.e. DNS entries are never\n+        // refreshed until the JVM is restarted. In this test, we break the network connection in the middle. As\n+        // a result, the AWS endpoint will be resolved to an unknown host for a short period. Set the TTL here to make\n+        // sure the unknown host entries are cleared, otherwise we will get UnknownHostException from AWS SDK clients.\n+        java.security.Security.setProperty(\"networkaddress.cache.ttl\", Long.toString(DNS_CACHE_TTL.getSeconds()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg0NTQ0Mw=="}, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNTU5MA==", "bodyText": "You can make these constants public and use them here instead - https://github.com/aws/aws-greengrass-kernel/blob/master/src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java#L58", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409225590", "createdAt": "2020-04-16T01:22:04Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.NetworkUtils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.crt.mqtt.MqttException;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MqttReconnectTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+\n+    private static final Duration DNS_CACHE_TTL = Duration.ofSeconds(10);\n+\n+    @BeforeEach\n+    void beforeEach() throws Exception {\n+        // Setting the JVM TTL for DNS Name Lookups. By default it's set to -1, i.e. DNS entries are never\n+        // refreshed until the JVM is restarted. In this test, we break the network connection in the middle. As\n+        // a result, the AWS endpoint will be resolved to an unknown host for a short period. Set the TTL here to make\n+        // sure the unknown host entries are cleared, otherwise we will get UnknownHostException from AWS SDK clients.\n+        java.security.Security.setProperty(\"networkaddress.cache.ttl\", Long.toString(DNS_CACHE_TTL.getSeconds()));\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MqttReconnectTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_new_deployment_while_device_online_WHEN_mqtt_disconnects_and_reconnects_THEN_job_executes_successfully()\n+            throws Exception {\n+        String jobId = UUID.randomUUID().toString();\n+\n+        CountDownLatch jobInProgress = new CountDownLatch(1);\n+        CountDownLatch jobCompleted = new CountDownLatch(1);\n+        CountDownLatch connectionInterrupted = new CountDownLatch(1);\n+\n+        // Subscribe to persisted deployment status\n+        Topics deploymentServiceTopics = kernel.lookupTopics(SERVICES_NAMESPACE_TOPIC, DEPLOYMENT_SERVICE_TOPICS);\n+        Topics processedDeployments = deploymentServiceTopics.createInteriorChild(PROCESSED_DEPLOYMENTS_TOPICS);\n+        processedDeployments.subscribe((whatHappened, newValue) -> {\n+            if (!(newValue instanceof Topic)) {\n+                return;\n+            }\n+            Map<String, Object> deploymentDetails = (HashMap) ((Topic) newValue).getOnce();\n+            if (!deploymentDetails.get(\"JobId\").toString().equals(jobId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNTg4Mg==", "bodyText": "What is stopping from creating a Thing group and putting that as a target?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409225882", "createdAt": "2020-04-16T01:23:11Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.NetworkUtils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.crt.mqtt.MqttException;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MqttReconnectTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+\n+    private static final Duration DNS_CACHE_TTL = Duration.ofSeconds(10);\n+\n+    @BeforeEach\n+    void beforeEach() throws Exception {\n+        // Setting the JVM TTL for DNS Name Lookups. By default it's set to -1, i.e. DNS entries are never\n+        // refreshed until the JVM is restarted. In this test, we break the network connection in the middle. As\n+        // a result, the AWS endpoint will be resolved to an unknown host for a short period. Set the TTL here to make\n+        // sure the unknown host entries are cleared, otherwise we will get UnknownHostException from AWS SDK clients.\n+        java.security.Security.setProperty(\"networkaddress.cache.ttl\", Long.toString(DNS_CACHE_TTL.getSeconds()));\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MqttReconnectTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_new_deployment_while_device_online_WHEN_mqtt_disconnects_and_reconnects_THEN_job_executes_successfully()\n+            throws Exception {\n+        String jobId = UUID.randomUUID().toString();\n+\n+        CountDownLatch jobInProgress = new CountDownLatch(1);\n+        CountDownLatch jobCompleted = new CountDownLatch(1);\n+        CountDownLatch connectionInterrupted = new CountDownLatch(1);\n+\n+        // Subscribe to persisted deployment status\n+        Topics deploymentServiceTopics = kernel.lookupTopics(SERVICES_NAMESPACE_TOPIC, DEPLOYMENT_SERVICE_TOPICS);\n+        Topics processedDeployments = deploymentServiceTopics.createInteriorChild(PROCESSED_DEPLOYMENTS_TOPICS);\n+        processedDeployments.subscribe((whatHappened, newValue) -> {\n+            if (!(newValue instanceof Topic)) {\n+                return;\n+            }\n+            Map<String, Object> deploymentDetails = (HashMap) ((Topic) newValue).getOnce();\n+            if (!deploymentDetails.get(\"JobId\").toString().equals(jobId)) {\n+                return;\n+            }\n+            String status = deploymentDetails.get(\"JobStatus\").toString();\n+            if (status.equals(\"IN_PROGRESS\")) {\n+                jobInProgress.countDown();\n+            } else if (jobInProgress.getCount() <= 0 && status.equals(\"SUCCEEDED\")) {\n+                jobCompleted.countDown();\n+            }\n+        });\n+\n+        // Create Job Doc\n+        String document = new ObjectMapper()\n+                .writeValueAsString(DeploymentDocument.builder().timestamp(System.currentTimeMillis())\n+                        .deploymentId(UUID.randomUUID().toString()).rootPackages(Arrays.asList(\"CustomerApp\"))\n+                        .deploymentPackageConfigurationList(Arrays.asList(\n+                                new DeploymentPackageConfiguration(\"CustomerApp\", \"1.0.0\", null, null, null)\n+                        )).build());\n+\n+        // Create job targeting our DUT\n+        String[] targets = {thing.thingArn};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzg5MA==", "bodyText": "Why do we need to check count of the latch here? Do we sometimes get this for both inprogress and complete updates?\nAlso, we need to check for timeout case as well, which is handled here - https://github.com/aws/aws-greengrass-kernel/blob/master/src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java#L358\nI would prefer making these log strings as constants in the DeploymentService and use those constants here. Otherwise this is fragile.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409227890", "createdAt": "2020-04-16T01:30:15Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.NetworkUtils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.crt.mqtt.MqttException;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MqttReconnectTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+\n+    private static final Duration DNS_CACHE_TTL = Duration.ofSeconds(10);\n+\n+    @BeforeEach\n+    void beforeEach() throws Exception {\n+        // Setting the JVM TTL for DNS Name Lookups. By default it's set to -1, i.e. DNS entries are never\n+        // refreshed until the JVM is restarted. In this test, we break the network connection in the middle. As\n+        // a result, the AWS endpoint will be resolved to an unknown host for a short period. Set the TTL here to make\n+        // sure the unknown host entries are cleared, otherwise we will get UnknownHostException from AWS SDK clients.\n+        java.security.Security.setProperty(\"networkaddress.cache.ttl\", Long.toString(DNS_CACHE_TTL.getSeconds()));\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MqttReconnectTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_new_deployment_while_device_online_WHEN_mqtt_disconnects_and_reconnects_THEN_job_executes_successfully()\n+            throws Exception {\n+        String jobId = UUID.randomUUID().toString();\n+\n+        CountDownLatch jobInProgress = new CountDownLatch(1);\n+        CountDownLatch jobCompleted = new CountDownLatch(1);\n+        CountDownLatch connectionInterrupted = new CountDownLatch(1);\n+\n+        // Subscribe to persisted deployment status\n+        Topics deploymentServiceTopics = kernel.lookupTopics(SERVICES_NAMESPACE_TOPIC, DEPLOYMENT_SERVICE_TOPICS);\n+        Topics processedDeployments = deploymentServiceTopics.createInteriorChild(PROCESSED_DEPLOYMENTS_TOPICS);\n+        processedDeployments.subscribe((whatHappened, newValue) -> {\n+            if (!(newValue instanceof Topic)) {\n+                return;\n+            }\n+            Map<String, Object> deploymentDetails = (HashMap) ((Topic) newValue).getOnce();\n+            if (!deploymentDetails.get(\"JobId\").toString().equals(jobId)) {\n+                return;\n+            }\n+            String status = deploymentDetails.get(\"JobStatus\").toString();\n+            if (status.equals(\"IN_PROGRESS\")) {\n+                jobInProgress.countDown();\n+            } else if (jobInProgress.getCount() <= 0 && status.equals(\"SUCCEEDED\")) {\n+                jobCompleted.countDown();\n+            }\n+        });\n+\n+        // Create Job Doc\n+        String document = new ObjectMapper()\n+                .writeValueAsString(DeploymentDocument.builder().timestamp(System.currentTimeMillis())\n+                        .deploymentId(UUID.randomUUID().toString()).rootPackages(Arrays.asList(\"CustomerApp\"))\n+                        .deploymentPackageConfigurationList(Arrays.asList(\n+                                new DeploymentPackageConfiguration(\"CustomerApp\", \"1.0.0\", null, null, null)\n+                        )).build());\n+\n+        // Create job targeting our DUT\n+        String[] targets = {thing.thingArn};\n+        Utils.createJobWithId(document, targets, jobId);\n+\n+        kernel.launch();\n+\n+        assertTrue(jobInProgress.await(2, TimeUnit.MINUTES));\n+        NetworkUtils networkUtils = NetworkUtils.getByPlatform();\n+        Consumer<EvergreenStructuredLogMessage> logListener = m -> {\n+            String message = m.getMessage();\n+            if (connectionInterrupted.getCount() > 0 && message != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMTc0Mg==", "bodyText": "Similar as before, whats missing from creating the group and adding that as target?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409231742", "createdAt": "2020-04-16T01:44:11Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MultipleDeploymentsTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MultipleDeploymentsTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+    private static final Logger logger = LogManager.getLogger(MultipleDeploymentsTest.class);\n+\n+    @BeforeEach\n+    void beforeEach() throws IOException {\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MultipleDeploymentsTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_online_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        kernel.launch();\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMjg4NA==", "bodyText": "If this class is meant to create different deployment documents then it should be named as DeploymentDocumentCreationHelper. Also it can be pulled out and used in both the test classes?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409232884", "createdAt": "2020-04-16T01:48:18Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MultipleDeploymentsTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MultipleDeploymentsTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+    private static final Logger logger = LogManager.getLogger(MultipleDeploymentsTest.class);\n+\n+    @BeforeEach\n+    void beforeEach() throws IOException {\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MultipleDeploymentsTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_online_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        kernel.launch();\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+        for (DeploymentJobHelper helper : helpers) {\n+            helper.createJob(targets);\n+            Utils.waitForJobExecutionStatusToSatisfy(helper.jobId, thing.thingName, Duration.ofMinutes(1),\n+                    s -> s.ordinal() >= JobExecutionStatus.QUEUED.ordinal());\n+        }\n+\n+        // Wait for all jobs to finish\n+        for (DeploymentJobHelper helper : helpers) {\n+            assertTrue(helper.jobCompleted.await(2, TimeUnit.MINUTES), \"Deployment job timed out: \" + helper.jobId);\n+            Utils.waitForJobToComplete(helper.jobId, Duration.ofMinutes(2));\n+\n+            assertEquals(State.FINISHED, kernel.locate(helper.targetPkgName).getState());\n+            assertEquals(JobExecutionStatus.SUCCEEDED, Utils.iotClient.describeJobExecution(\n+                    DescribeJobExecutionRequest.builder().jobId(helper.jobId).thingName(thing.thingName).build())\n+                    .execution().status());\n+        }\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_offline_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order_eventually()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+        for (DeploymentJobHelper helper : helpers) {\n+            helper.createJob(targets);\n+            Utils.waitForJobExecutionStatusToSatisfy(helper.jobId, thing.thingName, Duration.ofMinutes(1),\n+                    s -> s.ordinal() >= JobExecutionStatus.QUEUED.ordinal());\n+        }\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Start kernel and connect IoT cloud\n+        kernel.launch();\n+\n+        // Wait for all jobs to finish\n+        for (DeploymentJobHelper helper : helpers) {\n+            assertTrue(helper.jobCompleted.await(2, TimeUnit.MINUTES), \"Deployment job timed out: \" + helper.jobId);\n+            Utils.waitForJobToComplete(helper.jobId, Duration.ofMinutes(2));\n+\n+            assertEquals(State.FINISHED, kernel.locate(helper.targetPkgName).getState());\n+            assertEquals(JobExecutionStatus.SUCCEEDED, Utils.iotClient.describeJobExecution(\n+                    DescribeJobExecutionRequest.builder().jobId(helper.jobId).thingName(thing.thingName).build())\n+                    .execution().status());\n+        }\n+    }\n+\n+    private void subscribeToLocalDeploymentStatus(Kernel kernel, List<DeploymentJobHelper> helpers) {\n+        Topics deploymentServiceTopics = kernel.lookupTopics(SERVICES_NAMESPACE_TOPIC, DEPLOYMENT_SERVICE_TOPICS);\n+        Topics processedDeployments = deploymentServiceTopics.createInteriorChild(PROCESSED_DEPLOYMENTS_TOPICS);\n+        processedDeployments.subscribe((whatHappened, newValue) -> {\n+            if (!(newValue instanceof Topic)) {\n+                return;\n+            }\n+            Map<String, Object> deploymentDetails = (HashMap) ((Topic) newValue).getOnce();\n+            String jobId = deploymentDetails.get(PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID).toString();\n+            String status = deploymentDetails.get(PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS).toString();\n+\n+            for (int i = 0; i < helpers.size(); i++) {\n+                if (i > 0 && helpers.get(i - 1).jobCompleted.getCount() > 0) {\n+                    logger.atWarn().kv(\"jobId\", helpers.get(i-1).jobId).log(\"Waiting for deployment job to complete\");\n+                    break;\n+                }\n+                if (helpers.get(i).jobId.equals(jobId) && status.equals(\"SUCCEEDED\")) {\n+                    logger.atWarn().kv(\"jobId\", helpers.get(i).jobId).log(\"Deployment job has completed\");\n+                    helpers.get(i).jobCompleted.countDown();\n+                    break;\n+                }\n+            }\n+        });\n+    }\n+\n+    class DeploymentJobHelper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 176}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMzg1MQ==", "bodyText": "In addition to previous comment, I would not create the Iot Job in this method and only create the deployment document.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409233851", "createdAt": "2020-04-16T01:51:52Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MultipleDeploymentsTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MultipleDeploymentsTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+    private static final Logger logger = LogManager.getLogger(MultipleDeploymentsTest.class);\n+\n+    @BeforeEach\n+    void beforeEach() throws IOException {\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MultipleDeploymentsTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_online_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        kernel.launch();\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+        for (DeploymentJobHelper helper : helpers) {\n+            helper.createJob(targets);\n+            Utils.waitForJobExecutionStatusToSatisfy(helper.jobId, thing.thingName, Duration.ofMinutes(1),\n+                    s -> s.ordinal() >= JobExecutionStatus.QUEUED.ordinal());\n+        }\n+\n+        // Wait for all jobs to finish\n+        for (DeploymentJobHelper helper : helpers) {\n+            assertTrue(helper.jobCompleted.await(2, TimeUnit.MINUTES), \"Deployment job timed out: \" + helper.jobId);\n+            Utils.waitForJobToComplete(helper.jobId, Duration.ofMinutes(2));\n+\n+            assertEquals(State.FINISHED, kernel.locate(helper.targetPkgName).getState());\n+            assertEquals(JobExecutionStatus.SUCCEEDED, Utils.iotClient.describeJobExecution(\n+                    DescribeJobExecutionRequest.builder().jobId(helper.jobId).thingName(thing.thingName).build())\n+                    .execution().status());\n+        }\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_offline_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order_eventually()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+        for (DeploymentJobHelper helper : helpers) {\n+            helper.createJob(targets);\n+            Utils.waitForJobExecutionStatusToSatisfy(helper.jobId, thing.thingName, Duration.ofMinutes(1),\n+                    s -> s.ordinal() >= JobExecutionStatus.QUEUED.ordinal());\n+        }\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Start kernel and connect IoT cloud\n+        kernel.launch();\n+\n+        // Wait for all jobs to finish\n+        for (DeploymentJobHelper helper : helpers) {\n+            assertTrue(helper.jobCompleted.await(2, TimeUnit.MINUTES), \"Deployment job timed out: \" + helper.jobId);\n+            Utils.waitForJobToComplete(helper.jobId, Duration.ofMinutes(2));\n+\n+            assertEquals(State.FINISHED, kernel.locate(helper.targetPkgName).getState());\n+            assertEquals(JobExecutionStatus.SUCCEEDED, Utils.iotClient.describeJobExecution(\n+                    DescribeJobExecutionRequest.builder().jobId(helper.jobId).thingName(thing.thingName).build())\n+                    .execution().status());\n+        }\n+    }\n+\n+    private void subscribeToLocalDeploymentStatus(Kernel kernel, List<DeploymentJobHelper> helpers) {\n+        Topics deploymentServiceTopics = kernel.lookupTopics(SERVICES_NAMESPACE_TOPIC, DEPLOYMENT_SERVICE_TOPICS);\n+        Topics processedDeployments = deploymentServiceTopics.createInteriorChild(PROCESSED_DEPLOYMENTS_TOPICS);\n+        processedDeployments.subscribe((whatHappened, newValue) -> {\n+            if (!(newValue instanceof Topic)) {\n+                return;\n+            }\n+            Map<String, Object> deploymentDetails = (HashMap) ((Topic) newValue).getOnce();\n+            String jobId = deploymentDetails.get(PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID).toString();\n+            String status = deploymentDetails.get(PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS).toString();\n+\n+            for (int i = 0; i < helpers.size(); i++) {\n+                if (i > 0 && helpers.get(i - 1).jobCompleted.getCount() > 0) {\n+                    logger.atWarn().kv(\"jobId\", helpers.get(i-1).jobId).log(\"Waiting for deployment job to complete\");\n+                    break;\n+                }\n+                if (helpers.get(i).jobId.equals(jobId) && status.equals(\"SUCCEEDED\")) {\n+                    logger.atWarn().kv(\"jobId\", helpers.get(i).jobId).log(\"Deployment job has completed\");\n+                    helpers.get(i).jobCompleted.countDown();\n+                    break;\n+                }\n+            }\n+        });\n+    }\n+\n+    class DeploymentJobHelper {\n+        String jobId;\n+        CountDownLatch jobCompleted;\n+        String targetPkgName;\n+\n+        public DeploymentJobHelper(String pkgName) {\n+            jobId = UUID.randomUUID().toString();\n+            jobCompleted= new CountDownLatch(1);\n+            targetPkgName = pkgName;\n+        }\n+\n+        public void createJob(String[] targets) throws JsonProcessingException, TimeoutException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzMzkxMQ==", "bodyText": "Accept a list of target packages?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409233911", "createdAt": "2020-04-16T01:52:06Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MultipleDeploymentsTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MultipleDeploymentsTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+    private static final Logger logger = LogManager.getLogger(MultipleDeploymentsTest.class);\n+\n+    @BeforeEach\n+    void beforeEach() throws IOException {\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MultipleDeploymentsTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_online_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        kernel.launch();\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+        for (DeploymentJobHelper helper : helpers) {\n+            helper.createJob(targets);\n+            Utils.waitForJobExecutionStatusToSatisfy(helper.jobId, thing.thingName, Duration.ofMinutes(1),\n+                    s -> s.ordinal() >= JobExecutionStatus.QUEUED.ordinal());\n+        }\n+\n+        // Wait for all jobs to finish\n+        for (DeploymentJobHelper helper : helpers) {\n+            assertTrue(helper.jobCompleted.await(2, TimeUnit.MINUTES), \"Deployment job timed out: \" + helper.jobId);\n+            Utils.waitForJobToComplete(helper.jobId, Duration.ofMinutes(2));\n+\n+            assertEquals(State.FINISHED, kernel.locate(helper.targetPkgName).getState());\n+            assertEquals(JobExecutionStatus.SUCCEEDED, Utils.iotClient.describeJobExecution(\n+                    DescribeJobExecutionRequest.builder().jobId(helper.jobId).thingName(thing.thingName).build())\n+                    .execution().status());\n+        }\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_offline_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order_eventually()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+        for (DeploymentJobHelper helper : helpers) {\n+            helper.createJob(targets);\n+            Utils.waitForJobExecutionStatusToSatisfy(helper.jobId, thing.thingName, Duration.ofMinutes(1),\n+                    s -> s.ordinal() >= JobExecutionStatus.QUEUED.ordinal());\n+        }\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Start kernel and connect IoT cloud\n+        kernel.launch();\n+\n+        // Wait for all jobs to finish\n+        for (DeploymentJobHelper helper : helpers) {\n+            assertTrue(helper.jobCompleted.await(2, TimeUnit.MINUTES), \"Deployment job timed out: \" + helper.jobId);\n+            Utils.waitForJobToComplete(helper.jobId, Duration.ofMinutes(2));\n+\n+            assertEquals(State.FINISHED, kernel.locate(helper.targetPkgName).getState());\n+            assertEquals(JobExecutionStatus.SUCCEEDED, Utils.iotClient.describeJobExecution(\n+                    DescribeJobExecutionRequest.builder().jobId(helper.jobId).thingName(thing.thingName).build())\n+                    .execution().status());\n+        }\n+    }\n+\n+    private void subscribeToLocalDeploymentStatus(Kernel kernel, List<DeploymentJobHelper> helpers) {\n+        Topics deploymentServiceTopics = kernel.lookupTopics(SERVICES_NAMESPACE_TOPIC, DEPLOYMENT_SERVICE_TOPICS);\n+        Topics processedDeployments = deploymentServiceTopics.createInteriorChild(PROCESSED_DEPLOYMENTS_TOPICS);\n+        processedDeployments.subscribe((whatHappened, newValue) -> {\n+            if (!(newValue instanceof Topic)) {\n+                return;\n+            }\n+            Map<String, Object> deploymentDetails = (HashMap) ((Topic) newValue).getOnce();\n+            String jobId = deploymentDetails.get(PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID).toString();\n+            String status = deploymentDetails.get(PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS).toString();\n+\n+            for (int i = 0; i < helpers.size(); i++) {\n+                if (i > 0 && helpers.get(i - 1).jobCompleted.getCount() > 0) {\n+                    logger.atWarn().kv(\"jobId\", helpers.get(i-1).jobId).log(\"Waiting for deployment job to complete\");\n+                    break;\n+                }\n+                if (helpers.get(i).jobId.equals(jobId) && status.equals(\"SUCCEEDED\")) {\n+                    logger.atWarn().kv(\"jobId\", helpers.get(i).jobId).log(\"Deployment job has completed\");\n+                    helpers.get(i).jobCompleted.countDown();\n+                    break;\n+                }\n+            }\n+        });\n+    }\n+\n+    class DeploymentJobHelper {\n+        String jobId;\n+        CountDownLatch jobCompleted;\n+        String targetPkgName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 179}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzNTMwNg==", "bodyText": "For the SomeService package, should this be FINISHED or RUNNING? You can put the expected state in the Helper class you are creating.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409235306", "createdAt": "2020-04-16T01:57:03Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MultipleDeploymentsTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MultipleDeploymentsTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+    private static final Logger logger = LogManager.getLogger(MultipleDeploymentsTest.class);\n+\n+    @BeforeEach\n+    void beforeEach() throws IOException {\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MultipleDeploymentsTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_online_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        kernel.launch();\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+        for (DeploymentJobHelper helper : helpers) {\n+            helper.createJob(targets);\n+            Utils.waitForJobExecutionStatusToSatisfy(helper.jobId, thing.thingName, Duration.ofMinutes(1),\n+                    s -> s.ordinal() >= JobExecutionStatus.QUEUED.ordinal());\n+        }\n+\n+        // Wait for all jobs to finish\n+        for (DeploymentJobHelper helper : helpers) {\n+            assertTrue(helper.jobCompleted.await(2, TimeUnit.MINUTES), \"Deployment job timed out: \" + helper.jobId);\n+            Utils.waitForJobToComplete(helper.jobId, Duration.ofMinutes(2));\n+\n+            assertEquals(State.FINISHED, kernel.locate(helper.targetPkgName).getState());\n+            assertEquals(JobExecutionStatus.SUCCEEDED, Utils.iotClient.describeJobExecution(\n+                    DescribeJobExecutionRequest.builder().jobId(helper.jobId).thingName(thing.thingName).build())\n+                    .execution().status());\n+        }\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_offline_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order_eventually()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+        for (DeploymentJobHelper helper : helpers) {\n+            helper.createJob(targets);\n+            Utils.waitForJobExecutionStatusToSatisfy(helper.jobId, thing.thingName, Duration.ofMinutes(1),\n+                    s -> s.ordinal() >= JobExecutionStatus.QUEUED.ordinal());\n+        }\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Start kernel and connect IoT cloud\n+        kernel.launch();\n+\n+        // Wait for all jobs to finish\n+        for (DeploymentJobHelper helper : helpers) {\n+            assertTrue(helper.jobCompleted.await(2, TimeUnit.MINUTES), \"Deployment job timed out: \" + helper.jobId);\n+            Utils.waitForJobToComplete(helper.jobId, Duration.ofMinutes(2));\n+\n+            assertEquals(State.FINISHED, kernel.locate(helper.targetPkgName).getState());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIzNjc3Mw==", "bodyText": "These two tests are basically same, so no point keeping them both. I would keep the offline one here (since we already test online one in the other test). When we add tests for cancellation, that time we should cover different scenario for multiple jobs and device is online.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409236773", "createdAt": "2020-04-16T02:02:31Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MultipleDeploymentsTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MultipleDeploymentsTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+    private static final Logger logger = LogManager.getLogger(MultipleDeploymentsTest.class);\n+\n+    @BeforeEach\n+    void beforeEach() throws IOException {\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MultipleDeploymentsTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_online_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order()\n+            throws Exception {\n+        List<DeploymentJobHelper> helpers = Arrays.asList(\n+                new DeploymentJobHelper(\"GreenSignal\"),\n+                new DeploymentJobHelper(\"SomeService\"),\n+                new DeploymentJobHelper(\"CustomerApp\"));\n+\n+        kernel.launch();\n+\n+        subscribeToLocalDeploymentStatus(kernel, helpers);\n+\n+        // Create multiple jobs\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+        for (DeploymentJobHelper helper : helpers) {\n+            helper.createJob(targets);\n+            Utils.waitForJobExecutionStatusToSatisfy(helper.jobId, thing.thingName, Duration.ofMinutes(1),\n+                    s -> s.ordinal() >= JobExecutionStatus.QUEUED.ordinal());\n+        }\n+\n+        // Wait for all jobs to finish\n+        for (DeploymentJobHelper helper : helpers) {\n+            assertTrue(helper.jobCompleted.await(2, TimeUnit.MINUTES), \"Deployment job timed out: \" + helper.jobId);\n+            Utils.waitForJobToComplete(helper.jobId, Duration.ofMinutes(2));\n+\n+            assertEquals(State.FINISHED, kernel.locate(helper.targetPkgName).getState());\n+            assertEquals(JobExecutionStatus.SUCCEEDED, Utils.iotClient.describeJobExecution(\n+                    DescribeJobExecutionRequest.builder().jobId(helper.jobId).thingName(thing.thingName).build())\n+                    .execution().status());\n+        }\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_offline_device_WHEN_create_multiple_deployments_THEN_deployments_execute_successfully_in_order_eventually()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg0Njk3Mg=="}, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI0NDc2Nw==", "bodyText": "These are server ports, modify the name to indicate that. 443 is used in MQTT over websockets. Usually those are meant to be used when we need MQTT from browsers. We should not be using this but since we are not specifying the port, and choice of port depends if the platform has ALPN enabled or not, I would still keep it.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409244767", "createdAt": "2020-04-16T02:33:11Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/NetworkUtils.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.config.PlatformResolver;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public abstract class NetworkUtils {\n+    protected final List<String> MQTT_PORTS = Arrays.asList(\"8883\", \"443\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg0Mzg5MA=="}, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI0NTMxNQ==", "bodyText": "Do you need the destination port? You can only block what is coming from the server, and the client port is random.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409245315", "createdAt": "2020-04-16T02:35:18Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/NetworkUtilsLinux.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.util.Exec;\n+import lombok.AllArgsConstructor;\n+\n+@AllArgsConstructor\n+public class NetworkUtilsLinux extends NetworkUtils {\n+    private static final String enableOption = \"--insert\";\n+    private static final String disableOption = \"--delete\";\n+    private static final String commandFormat= \"sudo iptables %s OUTPUT -p tcp --dport %s -j REJECT && \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI0OTM4Ng==", "bodyText": "Is en0 the only interface through which communication was happening on the machines we are testing?\nIdeally we can find out which interface was being used and put that as down. You may use 'route -n get <mqtt_endpoint> | grep interface'  to get information about which interface is being used, but this may need to be done until all interfaces are blocked. I would say spend some time to see if it is quick, otherwise may not be worth spending time on this.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409249386", "createdAt": "2020-04-16T02:49:56Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/NetworkUtilsMac.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.util.Exec;\n+import lombok.AllArgsConstructor;\n+\n+@AllArgsConstructor\n+public class NetworkUtilsMac extends NetworkUtils {\n+    private static final String commandFormat = \"sudo ifconfig en0 %s\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg0NDM5Mg=="}, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1MDU1Mw==", "bodyText": "If there are two deployments with same id but different DeploymentType, they will be treated same, which is not desired. Include deploymentType for equals comparison as well.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r409250553", "createdAt": "2020-04-16T02:54:02Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "diffHunk": "@@ -6,13 +6,16 @@\n package com.aws.iot.evergreen.deployment.model;\n \n import lombok.AllArgsConstructor;\n+import lombok.EqualsAndHashCode;\n import lombok.Getter;\n \n @AllArgsConstructor\n @Getter\n+@EqualsAndHashCode(onlyExplicitlyIncluded = true)\n public class Deployment {\n     private String deploymentDocument;\n     private DeploymentType deploymentType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODA0ODE3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-395804817", "createdAt": "2020-04-17T22:19:16Z", "commit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjoxOToxNlrOGHeuog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjo0ODozMlrOGHfNAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5NjY3NA==", "bodyText": "Thanks! I should've made this into a FileUtils. It is useful!", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r410496674", "createdAt": "2020-04-17T22:19:16Z", "author": {"login": "leaf94"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -80,12 +62,12 @@ void afterEach() {\n \n     private void launchKernel(String configFile) throws IOException, InterruptedException {\n         kernel = new Kernel().parseArgs(\"-i\", DeploymentE2ETest.class.getResource(configFile).toString());\n-        setupIotResourcesAndInjectIntoKernel();\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n         kernel.launch();\n \n         Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n         // pre-load contents to package store\n-        copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5NzQ1Mw==", "bodyText": "I understand we need to do many wait in this test but can we make the timeout shorter? 10 minutes for a test to fail to too long for further maintenance...", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r410497453", "createdAt": "2020-04-17T22:22:14Z", "author": {"login": "leaf94"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.NetworkUtils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.crt.mqtt.MqttException;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MqttReconnectTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+\n+    private static final Duration DNS_CACHE_TTL = Duration.ofSeconds(10);\n+\n+    @BeforeEach\n+    void beforeEach() throws Exception {\n+        // Setting the JVM TTL for DNS Name Lookups. By default it's set to -1, i.e. DNS entries are never\n+        // refreshed until the JVM is restarted. In this test, we break the network connection in the middle. As\n+        // a result, the AWS endpoint will be resolved to an unknown host for a short period. Set the TTL here to make\n+        // sure the unknown host entries are cleared, otherwise we will get UnknownHostException from AWS SDK clients.\n+        java.security.Security.setProperty(\"networkaddress.cache.ttl\", Long.toString(DNS_CACHE_TTL.getSeconds()));\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MqttReconnectTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5Nzg4MA==", "bodyText": "Have we thought about making deloymentDetails a strongly typed POJO?\n\nYou can make these constants public and use them here instead - https://github.com/aws/aws-greengrass-kernel/blob/master/src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java#L58", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r410497880", "createdAt": "2020-04-17T22:23:43Z", "author": {"login": "leaf94"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.NetworkUtils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.crt.mqtt.MqttException;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MqttReconnectTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+\n+    private static final Duration DNS_CACHE_TTL = Duration.ofSeconds(10);\n+\n+    @BeforeEach\n+    void beforeEach() throws Exception {\n+        // Setting the JVM TTL for DNS Name Lookups. By default it's set to -1, i.e. DNS entries are never\n+        // refreshed until the JVM is restarted. In this test, we break the network connection in the middle. As\n+        // a result, the AWS endpoint will be resolved to an unknown host for a short period. Set the TTL here to make\n+        // sure the unknown host entries are cleared, otherwise we will get UnknownHostException from AWS SDK clients.\n+        java.security.Security.setProperty(\"networkaddress.cache.ttl\", Long.toString(DNS_CACHE_TTL.getSeconds()));\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MqttReconnectTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.packageStorePath);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+    }\n+\n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_new_deployment_while_device_online_WHEN_mqtt_disconnects_and_reconnects_THEN_job_executes_successfully()\n+            throws Exception {\n+        String jobId = UUID.randomUUID().toString();\n+\n+        CountDownLatch jobInProgress = new CountDownLatch(1);\n+        CountDownLatch jobCompleted = new CountDownLatch(1);\n+        CountDownLatch connectionInterrupted = new CountDownLatch(1);\n+\n+        // Subscribe to persisted deployment status\n+        Topics deploymentServiceTopics = kernel.lookupTopics(SERVICES_NAMESPACE_TOPIC, DEPLOYMENT_SERVICE_TOPICS);\n+        Topics processedDeployments = deploymentServiceTopics.createInteriorChild(PROCESSED_DEPLOYMENTS_TOPICS);\n+        processedDeployments.subscribe((whatHappened, newValue) -> {\n+            if (!(newValue instanceof Topic)) {\n+                return;\n+            }\n+            Map<String, Object> deploymentDetails = (HashMap) ((Topic) newValue).getOnce();\n+            if (!deploymentDetails.get(\"JobId\").toString().equals(jobId)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNTU5MA=="}, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMzQ3Nw==", "bodyText": "nit cmd -> platform", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r410503477", "createdAt": "2020-04-17T22:44:25Z", "author": {"login": "leaf94"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/NetworkUtils.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.config.PlatformResolver;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public abstract class NetworkUtils {\n+    protected final List<String> MQTT_PORTS = Arrays.asList(\"8883\", \"443\");\n+    protected static final Logger logger = LogManager.getLogger(NetworkUtils.class);\n+\n+    private enum Platform {\n+        UNKNOWN, LINUX, MACOS\n+    }\n+    private static final Platform cmd = initialize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNDA2MQ==", "bodyText": "If there are two deployments with same id but different DeploymentType, they will be treated same, which is not desired. Include deploymentType for equals comparison as well.\n\nWhat does it mean when two deployment with same id but different type?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r410504061", "createdAt": "2020-04-17T22:46:59Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "diffHunk": "@@ -6,13 +6,16 @@\n package com.aws.iot.evergreen.deployment.model;\n \n import lombok.AllArgsConstructor;\n+import lombok.EqualsAndHashCode;\n import lombok.Getter;\n \n @AllArgsConstructor\n @Getter\n+@EqualsAndHashCode(onlyExplicitlyIncluded = true)\n public class Deployment {\n     private String deploymentDocument;\n     private DeploymentType deploymentType;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1MDU1Mw=="}, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNDQ1MQ==", "bodyText": "When can this be null?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r410504451", "createdAt": "2020-04-17T22:48:32Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/DependencyResolver.java", "diffHunk": "@@ -267,10 +267,17 @@ private void mergeActiveRootPackages(Set<String> rootPackagesToResolve,\n \n     private String buildErrorMessage(final String pkgName, final Map<String, Semver> resolvedPackageNameToVersion,\n                                      final Map<String, String> versionConstraints) {\n-        Map<PackageIdentifier, String> pkgIdToVersionRequirements = new HashMap<>();\n-        versionConstraints.forEach((dependingPkgName, versionRequirement) -> pkgIdToVersionRequirements\n-                .put(new PackageIdentifier(dependingPkgName, resolvedPackageNameToVersion.get(dependingPkgName)),\n-                        versionRequirement));\n+        Map<String, String> pkgIdToVersionRequirements = new HashMap<>();\n+        versionConstraints.forEach((dependingPkgName, versionRequirement) -> {\n+            Semver dependingPkgVersion = resolvedPackageNameToVersion.get(dependingPkgName);\n+            if (dependingPkgVersion == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40da6c06c2c988fedec5ef37aa52e8292adcb82a", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/40da6c06c2c988fedec5ef37aa52e8292adcb82a", "committedDate": "2020-04-14T02:06:21Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}, "afterCommit": {"oid": "9ff6e64f71c986caf6f08cd029719a8a2e1d1790", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9ff6e64f71c986caf6f08cd029719a8a2e1d1790", "committedDate": "2020-04-21T17:45:49Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDI5NTEz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-398429513", "createdAt": "2020-04-22T17:44:02Z", "commit": {"oid": "9ff6e64f71c986caf6f08cd029719a8a2e1d1790"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo0NDowMlrOGKC9Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo0NDowMlrOGKC9Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NzM4Ng==", "bodyText": "isn't there an enum for this? If so, can we use that instead of the string?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r413187386", "createdAt": "2020-04-22T17:44:02Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MqttReconnectTest.java", "diffHunk": "@@ -0,0 +1,176 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.NetworkUtils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.crt.mqtt.MqttException;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.function.Consumer;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.UPDATE_DEPLOYMENT_STATUS_MQTT_ERROR_LOG;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.UPDATE_DEPLOYMENT_STATUS_TIMEOUT_ERROR_LOG;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(\"E2E\")\n+public class MqttReconnectTest {\n+    @TempDir\n+    static Path tempRootDir;\n+\n+    private static Kernel kernel;\n+    private static Utils.ThingInfo thing;\n+    private static String thingGroupArn;\n+    private static String dnsCacheTtlPropertyKey = \"networkaddress.cache.ttl\";\n+    private String dnsCacheTtlValue;\n+\n+    private static final Duration DNS_CACHE_TTL = Duration.ofSeconds(10);\n+\n+    @BeforeEach\n+    void beforeEach() throws Exception {\n+        // Setting the JVM TTL for DNS Name Lookups. By default it's set to -1, i.e. DNS entries are never\n+        // refreshed until the JVM is restarted. In this test, we break the network connection in the middle. As\n+        // a result, the AWS endpoint will be resolved to an unknown host for a short period. Set the TTL here to make\n+        // sure the unknown host entries are cleared, otherwise we will get UnknownHostException from AWS SDK clients.\n+        dnsCacheTtlValue = java.security.Security.getProperty(dnsCacheTtlPropertyKey);\n+        java.security.Security.setProperty(dnsCacheTtlPropertyKey, Long.toString(DNS_CACHE_TTL.getSeconds()));\n+\n+        System.setProperty(\"root\", tempRootDir.toAbsolutePath().toString());\n+\n+        kernel = new Kernel().parseArgs(\"-i\", MqttReconnectTest.class.getResource(\"blank_config.yaml\").toString());\n+        thing = Utils.setupIotResourcesAndInjectIntoKernel(kernel, tempRootDir);\n+        thingGroupArn = Utils.createThingGroupAndAddThing(thing);\n+\n+        Path localStoreContentPath = Paths.get(DeploymentE2ETest.class.getResource(\"local_store_content\").getPath());\n+        // pre-load contents to package store\n+        FileUtils.copyFolderRecursively(localStoreContentPath, kernel.getPackageStorePath());\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        // Reset to the configuration to previous setting or -1 so that DNS entries are never refreshed\n+        java.security.Security.setProperty(dnsCacheTtlPropertyKey, dnsCacheTtlValue == null ? \"-1\" : dnsCacheTtlValue);\n+\n+        if (kernel != null) {\n+            kernel.shutdown();\n+        }\n+        // Cleanup all IoT thing resources we created\n+        Utils.cleanAllCreatedThings();\n+        Utils.cleanAllCreatedJobs();\n+        Utils.cleanAllCreatedThingGroups();\n+    }\n+\n+    @Timeout(value = 5, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_new_deployment_while_device_online_WHEN_mqtt_disconnects_and_reconnects_THEN_job_executes_successfully()\n+            throws Exception {\n+        String jobId = UUID.randomUUID().toString();\n+\n+        CountDownLatch jobInProgress = new CountDownLatch(1);\n+        CountDownLatch jobCompleted = new CountDownLatch(1);\n+        CountDownLatch connectionInterrupted = new CountDownLatch(1);\n+\n+        // Subscribe to persisted deployment status\n+        Topics deploymentServiceTopics = kernel.getConfig().lookupTopics(SERVICES_NAMESPACE_TOPIC,\n+                DEPLOYMENT_SERVICE_TOPICS);\n+        Topics processedDeployments = deploymentServiceTopics.createInteriorChild(PROCESSED_DEPLOYMENTS_TOPICS);\n+        processedDeployments.subscribe((whatHappened, newValue) -> {\n+            if (!(newValue instanceof Topic)) {\n+                return;\n+            }\n+            Map<String, Object> deploymentDetails = (HashMap) ((Topic) newValue).getOnce();\n+            if (!deploymentDetails.get(PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID).toString().equals(jobId)) {\n+                return;\n+            }\n+            String status = deploymentDetails.get(PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS).toString();\n+            if (\"IN_PROGRESS\".equals(status)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ff6e64f71c986caf6f08cd029719a8a2e1d1790"}, "originalPosition": 121}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ff6e64f71c986caf6f08cd029719a8a2e1d1790", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9ff6e64f71c986caf6f08cd029719a8a2e1d1790", "committedDate": "2020-04-21T17:45:49Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}, "afterCommit": {"oid": "592501f2d5fd4050252550d99a0abb5979a415f9", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/592501f2d5fd4050252550d99a0abb5979a415f9", "committedDate": "2020-04-22T17:55:18Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "592501f2d5fd4050252550d99a0abb5979a415f9", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/592501f2d5fd4050252550d99a0abb5979a415f9", "committedDate": "2020-04-22T17:55:18Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}, "afterCommit": {"oid": "62a821ff5c2aecc31f9ec3e5924a8852cf59a8eb", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/62a821ff5c2aecc31f9ec3e5924a8852cf59a8eb", "committedDate": "2020-04-22T22:33:15Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NjQ4OTE3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-398648917", "createdAt": "2020-04-22T23:01:13Z", "commit": {"oid": "62a821ff5c2aecc31f9ec3e5924a8852cf59a8eb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMzowMToxNFrOGKPVPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMzoyMjoyMVrOGKP2PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM5MDE0MA==", "bodyText": "space before =", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r413390140", "createdAt": "2020-04-22T23:01:14Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/DeploymentJobDocumentHelper.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import java.util.Arrays;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+\n+public class DeploymentJobDocumentHelper {\n+    public String jobId;\n+    public CountDownLatch jobCompleted;\n+    public String targetPkgName;\n+\n+    public DeploymentJobDocumentHelper(String pkgName) {\n+        jobId = UUID.randomUUID().toString();\n+        jobCompleted= new CountDownLatch(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62a821ff5c2aecc31f9ec3e5924a8852cf59a8eb"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM5ODU4OA==", "bodyText": "Sorry if I am bringing this again and probably changing mind about naming, I feel DeploymentJob seems more apt name to me seeing what this class is doing. I think helper is an overloaded term and in my mind I expect only one helper object of a type in a class. But we initialize multiple helper of this type in the Test class, which does not look right to me. Replace this class name with DeploymentJob and the object names (in test class) with deploymentJob and see if it makes it more intuitive.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r413398588", "createdAt": "2020-04-22T23:22:21Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/DeploymentJobDocumentHelper.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.util;\n+\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.deployment.model.DeploymentPackageConfiguration;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import java.util.Arrays;\n+import java.util.UUID;\n+import java.util.concurrent.CountDownLatch;\n+\n+public class DeploymentJobDocumentHelper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62a821ff5c2aecc31f9ec3e5924a8852cf59a8eb"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62a821ff5c2aecc31f9ec3e5924a8852cf59a8eb", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/62a821ff5c2aecc31f9ec3e5924a8852cf59a8eb", "committedDate": "2020-04-22T22:33:15Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}, "afterCommit": {"oid": "9d2a994cdf40303e6349685a5ad465311a5a8d0f", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9d2a994cdf40303e6349685a5ad465311a5a8d0f", "committedDate": "2020-04-22T23:40:10Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NjY4OTY0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-398668964", "createdAt": "2020-04-22T23:53:35Z", "commit": {"oid": "9d2a994cdf40303e6349685a5ad465311a5a8d0f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d2a994cdf40303e6349685a5ad465311a5a8d0f", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9d2a994cdf40303e6349685a5ad465311a5a8d0f", "committedDate": "2020-04-22T23:40:10Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}, "afterCommit": {"oid": "c8575498175ecab096e14c3592a723180f5064df", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c8575498175ecab096e14c3592a723180f5064df", "committedDate": "2020-04-23T00:06:30Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4Njc0ODA5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-398674809", "createdAt": "2020-04-23T00:10:13Z", "commit": {"oid": "c8575498175ecab096e14c3592a723180f5064df"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4Njc1NTM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-398675536", "createdAt": "2020-04-23T00:12:23Z", "commit": {"oid": "c8575498175ecab096e14c3592a723180f5064df"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMDoxMjoyM1rOGKRAqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwMDoxMzoxOFrOGKRB5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQxNzY0MA==", "bodyText": "This class needs to use the EGExtension as well.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r413417640", "createdAt": "2020-04-23T00:12:23Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentCloudServiceIntegTest.java", "diffHunk": "@@ -41,7 +43,6 @@\n import java.util.List;\n import java.util.UUID;\n \n-import static com.aws.iot.evergreen.integrationtests.e2e.deployment.DeploymentE2ETest.copyFolderRecursively;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8575498175ecab096e14c3592a723180f5064df"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzQxNzk1Nw==", "bodyText": "Switch this to EGExtension.class which includes both log and processes protection.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#discussion_r413417957", "createdAt": "2020-04-23T00:13:18Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/MultipleDeploymentsTest.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.deployment;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.DeploymentJobHelper;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.FileUtils;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.testcommons.testutilities.ExceptionLogProtector;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Timeout;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+import software.amazon.awssdk.services.iot.model.DescribeJobExecutionRequest;\n+import software.amazon.awssdk.services.iot.model.JobExecutionStatus;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.time.Duration;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.aws.iot.evergreen.deployment.DeploymentService.DEPLOYMENT_SERVICE_TOPICS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_ID;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PERSISTED_DEPLOYMENT_STATUS_KEY_JOB_STATUS;\n+import static com.aws.iot.evergreen.deployment.DeploymentService.PROCESSED_DEPLOYMENTS_TOPICS;\n+import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICES_NAMESPACE_TOPIC;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(ExceptionLogProtector.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8575498175ecab096e14c3592a723180f5064df"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4Njc2NTc0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-398676574", "createdAt": "2020-04-23T00:15:28Z", "commit": {"oid": "c8575498175ecab096e14c3592a723180f5064df"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9e5e41eea8cef6433f0558ebf42cf31e45e0e62", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a9e5e41eea8cef6433f0558ebf42cf31e45e0e62", "committedDate": "2020-04-23T16:35:51Z", "message": "Merge branch 'master' into rds-e2e"}, "afterCommit": {"oid": "b561479cba635f2d6d4bc3a058fdd013763ab772", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b561479cba635f2d6d4bc3a058fdd013763ab772", "committedDate": "2020-04-23T17:10:06Z", "message": "messed up"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b561479cba635f2d6d4bc3a058fdd013763ab772", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b561479cba635f2d6d4bc3a058fdd013763ab772", "committedDate": "2020-04-23T17:10:06Z", "message": "messed up"}, "afterCommit": {"oid": "715075818782b433f590187027eba1ea8f6d4c28", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/715075818782b433f590187027eba1ea8f6d4c28", "committedDate": "2020-04-23T17:13:10Z", "message": "Attempt to make e2e consistently pass"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "228b297ad1bfc6f60c51b75c7824e811d8431587", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/228b297ad1bfc6f60c51b75c7824e811d8431587", "committedDate": "2020-04-23T18:48:10Z", "message": "Add deployment e2e test under intermittent mqtt connection and multiple deployments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb112c0e356771d32624cfe7d9ee57d86164f658", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb112c0e356771d32624cfe7d9ee57d86164f658", "committedDate": "2020-04-23T18:48:10Z", "message": "Attempt to make e2e consistently pass"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "715075818782b433f590187027eba1ea8f6d4c28", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/715075818782b433f590187027eba1ea8f6d4c28", "committedDate": "2020-04-23T17:13:10Z", "message": "Attempt to make e2e consistently pass"}, "afterCommit": {"oid": "fb112c0e356771d32624cfe7d9ee57d86164f658", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb112c0e356771d32624cfe7d9ee57d86164f658", "committedDate": "2020-04-23T18:48:10Z", "message": "Attempt to make e2e consistently pass"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NTEzMTY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-399513165", "createdAt": "2020-04-23T22:11:23Z", "commit": {"oid": "fb112c0e356771d32624cfe7d9ee57d86164f658"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NTEzODk5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/178#pullrequestreview-399513899", "createdAt": "2020-04-23T22:12:49Z", "commit": {"oid": "fb112c0e356771d32624cfe7d9ee57d86164f658"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2111, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}