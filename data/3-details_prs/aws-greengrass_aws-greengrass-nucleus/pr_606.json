{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MzYzODQw", "number": 606, "title": "Handle publish future exception", "bodyText": "Issue #, if available:\nDescription of changes:\nCheck if publish future completed exceptionally and throw ServiceError.\nIf it didn't complete exceptionally (spooled successfully), we return a response straightaway and don't wait for it to complete.\nWhy is this change necessary:\nHow was this change tested:\nUnit tests in MqttProxyIPCAgentTest and integ tests in IPCMqttProxyTest\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-02T22:16:39Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/606", "merged": true, "mergeCommit": {"oid": "fb9a427bbae1603a5470de29bbd8db5412e946c3"}, "closed": true, "closedAt": "2020-11-03T21:16:28Z", "author": {"login": "popanmol"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYsDMqAH2gAyNTE0MzYzODQwOmE1NDJlZmZhYWU4NzYxZWU1NDQ3MWVkYTY2YzJmMGY2YjJiNDlmODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY_gJagH2gAyNTE0MzYzODQwOjRiNGU2Y2QzMDhiMTc5ZGY5ODFkM2Y2OGI2ODIwYTJiM2U4MjBhN2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a542effaae8761ee54471eda66c2f0f6b2b49f80", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a542effaae8761ee54471eda66c2f0f6b2b49f80", "committedDate": "2020-11-02T22:10:44Z", "message": "Handle publish future exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fa9938023fce5517a24801dc953b503556440f4", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7fa9938023fce5517a24801dc953b503556440f4", "committedDate": "2020-11-02T22:24:26Z", "message": "Merge branch 'master' into mqtt-publish"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMDY1Njky", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/606#pullrequestreview-522065692", "createdAt": "2020-11-02T22:26:18Z", "commit": {"oid": "7fa9938023fce5517a24801dc953b503556440f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMjoyNjoxOVrOHsX_RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMjoyNjoxOVrOHsX_RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5MjQyMQ==", "bodyText": "The error log is more accurate to be \"Unable to add publish request to spooler\"", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/606#discussion_r516292421", "createdAt": "2020-11-02T22:26:19Z", "author": {"login": "awszztt"}, "path": "src/main/java/com/aws/greengrass/builtin/services/mqttproxy/MqttProxyIPCAgent.java", "diffHunk": "@@ -90,21 +89,23 @@ public PublishToIoTCoreResponse handleRequest(PublishToIoTCoreRequest request) {\n                 doAuthorization(this.getOperationModelContext().getOperationName(), serviceName, topic);\n             } catch (AuthorizationException e) {\n                 LOGGER.atError().cause(e).log();\n-                throw new UnauthorizedError(String.format(\"Authorization failed with error %s\", e.getMessage()));\n+                throw new UnauthorizedError(String.format(\"Authorization failed with error %s\", e));\n             }\n \n             PublishRequest publishRequest = PublishRequest.builder().payload(request.getPayload()).topic(topic)\n                     .retain(request.isRetain()).qos(getQualityOfServiceFromQOS(request.getQos())).build();\n             CompletableFuture<Integer> future = mqttClient.publish(publishRequest);\n \n-            // GG_NEEDS_REVIEW: TODO: replace this with a check that message is inserted in spooler queue\n-            try {\n-                future.get(mqttClient.getTimeout(), TimeUnit.MILLISECONDS);\n-            } catch (InterruptedException | ExecutionException | TimeoutException e) {\n-                LOGGER.atError().cause(e).kv(TOPIC_KEY, topic).kv(SERVICE_KEY, serviceName)\n-                        .log(\"Unable to publish to topic\");\n-                throw new ServiceError(String.format(\"Publish to topic %s failed with error %s\", topic,\n-                        e.getMessage()));\n+            if (future.isCompletedExceptionally()) {\n+                try {\n+                    future.get();\n+                } catch (InterruptedException ignore) {\n+                    // this won't happen since future already completed\n+                } catch (ExecutionException e) {\n+                    LOGGER.atError().cause(e).kv(TOPIC_KEY, topic).kv(SERVICE_KEY, serviceName)\n+                            .log(\"Unable to publish to topic\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa9938023fce5517a24801dc953b503556440f4"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMDcwMDk0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/606#pullrequestreview-522070094", "createdAt": "2020-11-02T22:31:18Z", "commit": {"oid": "7fa9938023fce5517a24801dc953b503556440f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMjozMToxOFrOHsYHwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMjozMToxOFrOHsYHwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5NDU5Mg==", "bodyText": "I did not get why this method should be deleted. The mqttClient.subscribe() mqttClient.unsubscribe are also involved this.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/606#discussion_r516294592", "createdAt": "2020-11-02T22:31:18Z", "author": {"login": "awszztt"}, "path": "src/main/java/com/aws/greengrass/mqttclient/MqttClient.java", "diffHunk": "@@ -547,10 +547,6 @@ public void addToCallbackEvents(MqttClientConnectionEvents callbacks) {\n         callbackEventManager.addToCallbackEvents(callbacks);\n     }\n \n-    public int getTimeout() {\n-        return Coerce.toInt(mqttTopics.findOrDefault(DEFAULT_MQTT_OPERATION_TIMEOUT, MQTT_OPERATION_TIMEOUT_KEY));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa9938023fce5517a24801dc953b503556440f4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMTAzMDg5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/606#pullrequestreview-522103089", "createdAt": "2020-11-02T23:26:06Z", "commit": {"oid": "7fa9938023fce5517a24801dc953b503556440f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMzoyNjowNlrOHsaMew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMzoyNjowNlrOHsaMew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMyODU3MQ==", "bodyText": "Can you add an integration test to make sure the appropriate error response is returned to the IPC client?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/606#discussion_r516328571", "createdAt": "2020-11-02T23:26:06Z", "author": {"login": "jbutler"}, "path": "src/main/java/com/aws/greengrass/builtin/services/mqttproxy/MqttProxyIPCAgent.java", "diffHunk": "@@ -90,21 +89,23 @@ public PublishToIoTCoreResponse handleRequest(PublishToIoTCoreRequest request) {\n                 doAuthorization(this.getOperationModelContext().getOperationName(), serviceName, topic);\n             } catch (AuthorizationException e) {\n                 LOGGER.atError().cause(e).log();\n-                throw new UnauthorizedError(String.format(\"Authorization failed with error %s\", e.getMessage()));\n+                throw new UnauthorizedError(String.format(\"Authorization failed with error %s\", e));\n             }\n \n             PublishRequest publishRequest = PublishRequest.builder().payload(request.getPayload()).topic(topic)\n                     .retain(request.isRetain()).qos(getQualityOfServiceFromQOS(request.getQos())).build();\n             CompletableFuture<Integer> future = mqttClient.publish(publishRequest);\n \n-            // GG_NEEDS_REVIEW: TODO: replace this with a check that message is inserted in spooler queue\n-            try {\n-                future.get(mqttClient.getTimeout(), TimeUnit.MILLISECONDS);\n-            } catch (InterruptedException | ExecutionException | TimeoutException e) {\n-                LOGGER.atError().cause(e).kv(TOPIC_KEY, topic).kv(SERVICE_KEY, serviceName)\n-                        .log(\"Unable to publish to topic\");\n-                throw new ServiceError(String.format(\"Publish to topic %s failed with error %s\", topic,\n-                        e.getMessage()));\n+            if (future.isCompletedExceptionally()) {\n+                try {\n+                    future.get();\n+                } catch (InterruptedException ignore) {\n+                    // this won't happen since future already completed\n+                } catch (ExecutionException e) {\n+                    LOGGER.atError().cause(e).kv(TOPIC_KEY, topic).kv(SERVICE_KEY, serviceName)\n+                            .log(\"Unable to publish to topic\");\n+                    throw new ServiceError(String.format(\"Publish to topic %s failed with error %s\", topic, e));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa9938023fce5517a24801dc953b503556440f4"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3600a443192ce4484d6c7b764e23f6f3ffabbc4e", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3600a443192ce4484d6c7b764e23f6f3ffabbc4e", "committedDate": "2020-11-03T00:56:11Z", "message": "integ test for publish error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56cdee019dd65ce82e2668a008ade90c1ea489e0", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/56cdee019dd65ce82e2668a008ade90c1ea489e0", "committedDate": "2020-11-03T00:58:27Z", "message": "Merge branch 'master' into mqtt-publish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "123c997823d54378d63b56900355f6acc09ed7bf", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/123c997823d54378d63b56900355f6acc09ed7bf", "committedDate": "2020-11-03T01:41:16Z", "message": "Merge branch 'master' into mqtt-publish"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNzU2MjIy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/606#pullrequestreview-522756222", "createdAt": "2020-11-03T18:08:51Z", "commit": {"oid": "123c997823d54378d63b56900355f6acc09ed7bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b99bcae9956a41602ac692144c54ed4c0f21ce51", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b99bcae9956a41602ac692144c54ed4c0f21ce51", "committedDate": "2020-11-03T18:09:02Z", "message": "Merge branch 'master' into mqtt-publish"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODYxOTgx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/606#pullrequestreview-522861981", "createdAt": "2020-11-03T20:47:06Z", "commit": {"oid": "b99bcae9956a41602ac692144c54ed4c0f21ce51"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b4e6cd308b179df981d3f68b6820a2b3e820a7b", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4b4e6cd308b179df981d3f68b6820a2b3e820a7b", "committedDate": "2020-11-03T20:50:33Z", "message": "Merge branch 'master' into mqtt-publish"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2897, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}