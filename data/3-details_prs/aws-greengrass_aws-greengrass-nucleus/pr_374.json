{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMzAxODE3", "number": 374, "title": "Run kernel.locate in dependency order", "bodyText": "Issue #, if available:\nhttps://sim.amazon.com/issues/64505441-2b25-4892-84dd-fdbb40947b1b\nDescription of changes:\nRecursively calls locate on dependencies of services (if they have any). This forces the services to be located in dependency order. This resolves an issue for plugins in that the plugin must be loaded before the dependencies are loaded. This wasn't guaranteed before due to arbitrary ordering to locate calls. Now it will be properly ordered so the plugin will always get added to the kernel before its dependencies.\nAlso fixes occasional NPE in EvergreenService.close\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-08-19T17:07:21Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/374", "merged": true, "mergeCommit": {"oid": "07c5b59bccea045f6025265ddf5dce72c90b0f65"}, "closed": true, "closedAt": "2020-08-19T20:21:55Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAe0QgABqjM2NzE4Mzg1OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAherugFqTQ3MDg2MzA2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "456be7835822444deb15625ad9148864555ef32a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/456be7835822444deb15625ad9148864555ef32a", "committedDate": "2020-08-19T17:04:46Z", "message": "Run kernel.locate in dependency order"}, "afterCommit": {"oid": "01261b653a2c2bfbaa882147c89ad0e27acf7ae9", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/01261b653a2c2bfbaa882147c89ad0e27acf7ae9", "committedDate": "2020-08-19T17:11:21Z", "message": "Run kernel.locate in dependency order"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01261b653a2c2bfbaa882147c89ad0e27acf7ae9", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/01261b653a2c2bfbaa882147c89ad0e27acf7ae9", "committedDate": "2020-08-19T17:11:21Z", "message": "Run kernel.locate in dependency order"}, "afterCommit": {"oid": "83df3f9c91b28a86a4f9362a1f854c4c790e6903", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/83df3f9c91b28a86a4f9362a1f854c4c790e6903", "committedDate": "2020-08-19T17:20:51Z", "message": "Run kernel.locate in dependency order"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83df3f9c91b28a86a4f9362a1f854c4c790e6903", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/83df3f9c91b28a86a4f9362a1f854c4c790e6903", "committedDate": "2020-08-19T17:20:51Z", "message": "Run kernel.locate in dependency order"}, "afterCommit": {"oid": "1f63cbecd722aafe278c421826e8f012ed8e5858", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1f63cbecd722aafe278c421826e8f012ed8e5858", "committedDate": "2020-08-19T17:25:00Z", "message": "Run kernel.locate in dependency order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b42d793d08b02fff12a1a9b9b01c880b49793df", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b42d793d08b02fff12a1a9b9b01c880b49793df", "committedDate": "2020-08-19T17:39:10Z", "message": "Run kernel.locate in dependency order"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f63cbecd722aafe278c421826e8f012ed8e5858", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1f63cbecd722aafe278c421826e8f012ed8e5858", "committedDate": "2020-08-19T17:25:00Z", "message": "Run kernel.locate in dependency order"}, "afterCommit": {"oid": "8b42d793d08b02fff12a1a9b9b01c880b49793df", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b42d793d08b02fff12a1a9b9b01c880b49793df", "committedDate": "2020-08-19T17:39:10Z", "message": "Run kernel.locate in dependency order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzEzNTk5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/374#pullrequestreview-470713599", "createdAt": "2020-08-19T18:02:42Z", "commit": {"oid": "8b42d793d08b02fff12a1a9b9b01c880b49793df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODowMjo0MlrOHDTRMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxODowMjo0MlrOHDTRMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIyMzQ3NQ==", "bodyText": "If the component has a SOFT dependency, do we need to throw service load exception during locate?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/374#discussion_r473223475", "createdAt": "2020-08-19T18:02:42Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -353,6 +357,22 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n \n             Class<?> clazz = null;\n             if (serviceRootTopics != null) {\n+\n+                // Try locating all the dependencies first so that they'll all exist prior to their dependant.\n+                // This is to fix an ordering problem with plugins such as lambda manager. The plugin needs to be\n+                // located *before* the dependant is located so that the plugin has its jar loaded into the classloader.\n+                Topic dependenciesTopic = serviceRootTopics.findLeafChild(SERVICE_DEPENDENCIES_NAMESPACE_TOPIC);\n+                if (dependenciesTopic != null && dependenciesTopic.getOnce() instanceof Collection) {\n+                    try {\n+                        for (Pair<String, DependencyType> p : EvergreenService\n+                                .parseDependencies((Collection<String>) dependenciesTopic.getOnce())) {\n+                            locate(p.getLeft());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b42d793d08b02fff12a1a9b9b01c880b49793df"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzQ5NzUx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/374#pullrequestreview-470749751", "createdAt": "2020-08-19T18:56:00Z", "commit": {"oid": "8b42d793d08b02fff12a1a9b9b01c880b49793df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwODYzMDYx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/374#pullrequestreview-470863061", "createdAt": "2020-08-19T20:17:37Z", "commit": {"oid": "8b42d793d08b02fff12a1a9b9b01c880b49793df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2094, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}