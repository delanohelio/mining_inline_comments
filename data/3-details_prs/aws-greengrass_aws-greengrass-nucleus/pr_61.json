{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0NjA1NDA3", "number": 61, "title": "Move platform resolving into separate java class.", "bodyText": "Platform resolve will happen before config yaml file is loaded into\nmemory.\nIssue #, if available:\nDescription of changes:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-02-13T00:13:14Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/61", "merged": true, "mergeCommit": {"oid": "4d3cc58a1f604d2c88d8367a748edc0e1c143b61"}, "closed": true, "closedAt": "2020-02-14T00:50:02Z", "author": {"login": "ShirleyZheng92"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDvpIPgFqTM1Nzg4MDIzNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEEpkMAFqTM1ODY1MTIxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODgwMjM3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/61#pullrequestreview-357880237", "createdAt": "2020-02-13T00:18:18Z", "commit": {"oid": "e476889ef9891d3b610bf859bd13bba28aad563f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMDoxODoxOVrOFpDGug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMDoxODoxOVrOFpDGug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4NjgxMA==", "bodyText": "Please create SIM and add link here.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/61#discussion_r378586810", "createdAt": "2020-02-13T00:18:19Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -617,29 +539,22 @@ public String getName() {\n \n     @Override\n     public void postInject() {\n-        addDependency(config.getChild(\"requires\"));\n-    }\n-\n-    public boolean addDependency(Node d) {\n-        boolean ret = false;\n-        if (d instanceof Topics) {\n-            d = pickByOS((Topics) d);\n-        }\n+        Node d = config.getChild(\"requires\");\n         if (d instanceof Topic) {\n             String ds = ((Topic) d).getOnce().toString();\n             Matcher m = DEP_PARSE.matcher(ds);\n             while (m.find()) {\n                 addDependency(m.group(1), m.group(3));\n-                ret = true;\n             }\n             if (!m.hitEnd()) {\n                 errored(\"bad dependency syntax\", ds);\n             }\n+        } else {\n+            // TODO: invalidate the config file", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e476889ef9891d3b610bf859bd13bba28aad563f"}, "originalPosition": 130}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODgwODE5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/61#pullrequestreview-357880819", "createdAt": "2020-02-13T00:20:04Z", "commit": {"oid": "e476889ef9891d3b610bf859bd13bba28aad563f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e476889ef9891d3b610bf859bd13bba28aad563f", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e476889ef9891d3b610bf859bd13bba28aad563f", "committedDate": "2020-02-13T00:12:22Z", "message": "Move platform resolving into separate java class.\n\nPlatform resolve will happen before config yaml file is loaded into\nmemory."}, "afterCommit": {"oid": "57c338cb137f5d207e74875d9822af2014a436f9", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/57c338cb137f5d207e74875d9822af2014a436f9", "committedDate": "2020-02-13T00:50:34Z", "message": "Move platform resolving into separate java class.\n\nPlatform resolve will happen before config yaml file is loaded into\nmemory."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57c338cb137f5d207e74875d9822af2014a436f9", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/57c338cb137f5d207e74875d9822af2014a436f9", "committedDate": "2020-02-13T00:50:34Z", "message": "Move platform resolving into separate java class.\n\nPlatform resolve will happen before config yaml file is loaded into\nmemory."}, "afterCommit": {"oid": "5649786b0f46e66c196c8692a092878b1d7fba01", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5649786b0f46e66c196c8692a092878b1d7fba01", "committedDate": "2020-02-13T00:54:29Z", "message": "Move platform resolving into separate java class.\n\nPlatform resolve will happen before config yaml file is loaded into\nmemory."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5649786b0f46e66c196c8692a092878b1d7fba01", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5649786b0f46e66c196c8692a092878b1d7fba01", "committedDate": "2020-02-13T00:54:29Z", "message": "Move platform resolving into separate java class.\n\nPlatform resolve will happen before config yaml file is loaded into\nmemory."}, "afterCommit": {"oid": "84a07099749d6642fc6e7c18174923c052459045", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/84a07099749d6642fc6e7c18174923c052459045", "committedDate": "2020-02-13T00:55:13Z", "message": "Move platform resolving into separate java class.\n\nPlatform resolve will happen before config yaml file is loaded into\nmemory."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ba5737fb1fc6fbfed6f006c089d87e5b35f4b3b", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1ba5737fb1fc6fbfed6f006c089d87e5b35f4b3b", "committedDate": "2020-02-13T01:16:56Z", "message": "Move platform resolving into separate java class.\n\nPlatform resolve will happen before config yaml file is loaded into\nmemory."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84a07099749d6642fc6e7c18174923c052459045", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/84a07099749d6642fc6e7c18174923c052459045", "committedDate": "2020-02-13T00:55:13Z", "message": "Move platform resolving into separate java class.\n\nPlatform resolve will happen before config yaml file is loaded into\nmemory."}, "afterCommit": {"oid": "1ba5737fb1fc6fbfed6f006c089d87e5b35f4b3b", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1ba5737fb1fc6fbfed6f006c089d87e5b35f4b3b", "committedDate": "2020-02-13T01:16:56Z", "message": "Move platform resolving into separate java class.\n\nPlatform resolve will happen before config yaml file is loaded into\nmemory."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0807be3dce10d23d5af303211801243386d616f2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0807be3dce10d23d5af303211801243386d616f2", "committedDate": "2020-02-13T17:31:09Z", "message": "Merge branch 'master' into platformResolv"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NTU5Mjk4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/61#pullrequestreview-358559298", "createdAt": "2020-02-13T21:20:55Z", "commit": {"oid": "0807be3dce10d23d5af303211801243386d616f2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMToyMDo1NVrOFpj8_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMToyODozOVrOFpkK_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEyNDk5MA==", "bodyText": "We could avoid static block by doing:\n private static final Set<String> SUPPORTED_PLATFORMS = ImmutableList.of(all\", \"any\", \"unix\",...);\n private static final Set<String> SUPPORTED_PLATFORMS = initializeRanks();", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/61#discussion_r379124990", "createdAt": "2020-02-13T21:20:55Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/config/PlatformResolver.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package com.aws.iot.evergreen.config;\n+\n+import com.aws.iot.evergreen.util.Exec;\n+\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+public class PlatformResolver {\n+\n+    private static final Set<String> SUPPORTED_PLATFORMS = new HashSet<>();\n+    private static final HashMap<String, Integer> RANKS = new HashMap<>();\n+\n+    static {\n+        initialize();\n+    }\n+\n+    @edu.umd.cs.findbugs.annotations.SuppressFBWarnings(\n+            value = \"DMI_HARDCODED_ABSOLUTE_FILENAME\")\n+    private static void initialize() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0807be3dce10d23d5af303211801243386d616f2"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEyODU3Mg==", "bodyText": "I understand we want to provide our own RANKS for unit testing purpose, but then this unit test for this public static method loses its functionality if we do so. Say we accidentally changed the RANKS wrongly in the source code, this unit test will be not be able to catch it...\nLet's have a quick offline discussion!", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/61#discussion_r379128572", "createdAt": "2020-02-13T21:28:39Z", "author": {"login": "leaf94"}, "path": "src/test/java/com/aws/iot/evergreen/config/PlatformResolverTest.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package com.aws.iot.evergreen.config;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+import com.fasterxml.jackson.jr.ob.JSON;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.InputStream;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+public class PlatformResolverTest {\n+    ObjectMapper mapper = new ObjectMapper();\n+    private static Method platformResolveInternalMethod;\n+\n+    @BeforeAll\n+    public static void setup() throws NoSuchMethodException {\n+        Class[] cArg = new Class[2];\n+        cArg[0] = Map.class;\n+        cArg[1] = Map.class;\n+\n+        platformResolveInternalMethod = PlatformResolver.class.getDeclaredMethod(\"resolvePlatform\", cArg);\n+        platformResolveInternalMethod.setAccessible(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0807be3dce10d23d5af303211801243386d616f2"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c81653ee4aeef6d0c3dcfa6688e1f5eadead0ce", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7c81653ee4aeef6d0c3dcfa6688e1f5eadead0ce", "committedDate": "2020-02-13T22:38:44Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjUxMjE0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/61#pullrequestreview-358651214", "createdAt": "2020-02-14T00:46:48Z", "commit": {"oid": "7c81653ee4aeef6d0c3dcfa6688e1f5eadead0ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2480, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}