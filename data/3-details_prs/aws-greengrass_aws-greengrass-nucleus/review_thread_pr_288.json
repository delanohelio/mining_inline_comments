{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4ODkwNTY1", "number": 288, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToyODo1MFrOEIL8mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDo0NToyOVrOEIhdiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDE5ODAzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMToyODo1MFrOGn_3mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDozODo0OVrOGoiR_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5NDA3NQ==", "bodyText": "Instead of passing a wrong date, can we just skip sending expiration at all?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r444594075", "createdAt": "2020-06-24T01:28:50Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.aws.iot.evergreen.deployment.DeviceConfiguration;\n+import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider.X509CredentialsProviderBuilder;\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.ClientTlsContext;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.io.TlsContextOptions;\n+\n+import java.util.Date;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Inject;\n+\n+public class CredentialsProviderBuilder {\n+    private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n+    private X509CredentialsProviderBuilder x509builder;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param deviceConfiguration Device configuration helper getting cert and keys for mTLS\n+     * @throws DeviceConfigurationException When unable to initialize this manager.\n+     */\n+    @Inject\n+    CredentialsProviderBuilder(final DeviceConfiguration deviceConfiguration) throws DeviceConfigurationException {\n+        this.x509builder = initCredentialsProviderBuilder(deviceConfiguration);\n+    }\n+\n+    private X509CredentialsProviderBuilder initCredentialsProviderBuilder(DeviceConfiguration deviceConfiguration)\n+            throws DeviceConfigurationException {\n+        final String certPath = Coerce.toString(deviceConfiguration.getCertificateFilePath());\n+        final String keyPath = Coerce.toString(deviceConfiguration.getPrivateKeyFilePath());\n+        final String caPath = Coerce.toString(deviceConfiguration.getRootCAFilePath());\n+        final String thingName = Coerce.toString(deviceConfiguration.getThingName());\n+        final String credEndpoint = Coerce.toString(deviceConfiguration.getIotCredentialEndpoint());\n+        try (EventLoopGroup eventLoopGroup = new EventLoopGroup(1);\n+            HostResolver resolver = new HostResolver(eventLoopGroup);\n+            ClientBootstrap clientBootstrap = new ClientBootstrap(eventLoopGroup, resolver);\n+            TlsContextOptions tlsCtxOptions = TlsContextOptions.createWithMtlsFromPath(certPath, keyPath)) {\n+            // TODO: Proxy support\n+            tlsCtxOptions.overrideDefaultTrustStoreFromPath(null, caPath);\n+            try (ClientTlsContext tlsContext = new ClientTlsContext(tlsCtxOptions)) {\n+                x509builder = new X509CredentialsProvider.X509CredentialsProviderBuilder()\n+                        .withClientBootstrap(clientBootstrap)\n+                        .withTlsContext(tlsContext)\n+                        .withEndpoint(credEndpoint)\n+                        .withThingName(thingName);\n+                return x509builder;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Sets the role alias to fetch credentials through.\n+     * @param roleAlias name of the role alias to use\n+     */\n+    public void withRoleAlias(String roleAlias) {\n+        x509builder.withRoleAlias(roleAlias);\n+    }\n+\n+    /**\n+     * To fetch credential.\n+     * @return AWS IoT credential\n+     * @throws AWSIotException when fetching credentials fails\n+     */\n+    public Credentials getCredentials() throws AWSIotException {\n+        Credentials credentials;\n+        try (X509CredentialsProvider provider = x509builder.build()) {\n+            CompletableFuture<Credentials> future = provider.getCredentials();\n+            credentials = future.get();\n+        } catch (InterruptedException | ExecutionException e) {\n+            LOGGER.error(\"Getting AWS IOT credentials failed with error {} \", e);\n+            throw new AWSIotException(e);\n+        }\n+        return credentials;\n+    }\n+\n+    /**\n+     * To fetch expiry.\n+     * @return Expiration date of the credential\n+     * @throws AWSIotException when fetching expiration fails\n+     */\n+    public Date getCredentialsExpiration() throws AWSIotException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f12132ecb88d3508b1d86ba3087b3c1324423d47"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1Nzg4NQ==", "bodyText": "We would need to test if that would break the SDK, but i think it would.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445157885", "createdAt": "2020-06-24T20:38:49Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.aws.iot.evergreen.deployment.DeviceConfiguration;\n+import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider.X509CredentialsProviderBuilder;\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.ClientTlsContext;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.io.TlsContextOptions;\n+\n+import java.util.Date;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Inject;\n+\n+public class CredentialsProviderBuilder {\n+    private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n+    private X509CredentialsProviderBuilder x509builder;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param deviceConfiguration Device configuration helper getting cert and keys for mTLS\n+     * @throws DeviceConfigurationException When unable to initialize this manager.\n+     */\n+    @Inject\n+    CredentialsProviderBuilder(final DeviceConfiguration deviceConfiguration) throws DeviceConfigurationException {\n+        this.x509builder = initCredentialsProviderBuilder(deviceConfiguration);\n+    }\n+\n+    private X509CredentialsProviderBuilder initCredentialsProviderBuilder(DeviceConfiguration deviceConfiguration)\n+            throws DeviceConfigurationException {\n+        final String certPath = Coerce.toString(deviceConfiguration.getCertificateFilePath());\n+        final String keyPath = Coerce.toString(deviceConfiguration.getPrivateKeyFilePath());\n+        final String caPath = Coerce.toString(deviceConfiguration.getRootCAFilePath());\n+        final String thingName = Coerce.toString(deviceConfiguration.getThingName());\n+        final String credEndpoint = Coerce.toString(deviceConfiguration.getIotCredentialEndpoint());\n+        try (EventLoopGroup eventLoopGroup = new EventLoopGroup(1);\n+            HostResolver resolver = new HostResolver(eventLoopGroup);\n+            ClientBootstrap clientBootstrap = new ClientBootstrap(eventLoopGroup, resolver);\n+            TlsContextOptions tlsCtxOptions = TlsContextOptions.createWithMtlsFromPath(certPath, keyPath)) {\n+            // TODO: Proxy support\n+            tlsCtxOptions.overrideDefaultTrustStoreFromPath(null, caPath);\n+            try (ClientTlsContext tlsContext = new ClientTlsContext(tlsCtxOptions)) {\n+                x509builder = new X509CredentialsProvider.X509CredentialsProviderBuilder()\n+                        .withClientBootstrap(clientBootstrap)\n+                        .withTlsContext(tlsContext)\n+                        .withEndpoint(credEndpoint)\n+                        .withThingName(thingName);\n+                return x509builder;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Sets the role alias to fetch credentials through.\n+     * @param roleAlias name of the role alias to use\n+     */\n+    public void withRoleAlias(String roleAlias) {\n+        x509builder.withRoleAlias(roleAlias);\n+    }\n+\n+    /**\n+     * To fetch credential.\n+     * @return AWS IoT credential\n+     * @throws AWSIotException when fetching credentials fails\n+     */\n+    public Credentials getCredentials() throws AWSIotException {\n+        Credentials credentials;\n+        try (X509CredentialsProvider provider = x509builder.build()) {\n+            CompletableFuture<Credentials> future = provider.getCredentials();\n+            credentials = future.get();\n+        } catch (InterruptedException | ExecutionException e) {\n+            LOGGER.error(\"Getting AWS IOT credentials failed with error {} \", e);\n+            throw new AWSIotException(e);\n+        }\n+        return credentials;\n+    }\n+\n+    /**\n+     * To fetch expiry.\n+     * @return Expiration date of the credential\n+     * @throws AWSIotException when fetching expiration fails\n+     */\n+    public Date getCredentialsExpiration() throws AWSIotException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU5NDA3NQ=="}, "originalCommit": {"oid": "f12132ecb88d3508b1d86ba3087b3c1324423d47"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MzA5NDM5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNzozNDozNFrOGocRDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNzozNDozNFrOGocRDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1OTM0MQ==", "bodyText": "this also needs to be reconfigurable if the device configuration changes.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445059341", "createdAt": "2020-06-24T17:34:34Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.aws.iot.evergreen.deployment.DeviceConfiguration;\n+import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider.X509CredentialsProviderBuilder;\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.ClientTlsContext;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.io.TlsContextOptions;\n+\n+import java.util.Date;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Inject;\n+\n+public class CredentialsProviderBuilder {\n+    private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n+    private X509CredentialsProviderBuilder x509builder;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param deviceConfiguration Device configuration helper getting cert and keys for mTLS\n+     * @throws DeviceConfigurationException When unable to initialize this manager.\n+     */\n+    @Inject\n+    CredentialsProviderBuilder(final DeviceConfiguration deviceConfiguration) throws DeviceConfigurationException {\n+        this.x509builder = initCredentialsProviderBuilder(deviceConfiguration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f12132ecb88d3508b1d86ba3087b3c1324423d47"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MzA5NzI1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/tes/TokenExchangeService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNzozNToyOFrOGocS_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNzozNToyOFrOGocS_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1OTgzOA==", "bodyText": "Please change the DEFAULT_PORT above to be 0 so that it randomly chooses a port. This will allow us to run more than 1 evergreen on a device.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445059838", "createdAt": "2020-06-24T17:35:28Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/tes/TokenExchangeService.java", "diffHunk": "@@ -27,16 +27,16 @@\n     private String iotRoleAlias;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f12132ecb88d3508b1d86ba3087b3c1324423d47"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MzcxMTUzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialRequestHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDo0MjowN1rOGoiYVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDo0MjowN1rOGoiYVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE1OTUwOQ==", "bodyText": "Nit: Lets just strip DOWNSTREAM from variables now.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445159509", "createdAt": "2020-06-24T20:42:07Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialRequestHandler.java", "diffHunk": "@@ -6,50 +6,42 @@\n import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.databind.DeserializationFeature;\n-import com.fasterxml.jackson.databind.JsonNode;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.sun.net.httpserver.HttpExchange;\n import com.sun.net.httpserver.HttpHandler;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n \n import java.io.IOException;\n import java.net.HttpURLConnection;\n+import java.nio.charset.StandardCharsets;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n import java.util.HashMap;\n+import java.util.Locale;\n import java.util.Map;\n \n public class CredentialRequestHandler implements HttpHandler {\n     private static final Logger LOGGER = LogManager.getLogger(CredentialRequestHandler.class);\n     public static final String IOT_CREDENTIALS_HTTP_VERB = \"GET\";\n-    private static final String CREDENTIALS_UPSTREAM_STR = \"credentials\";\n-    private static final String ACCESS_KEY_UPSTREAM_STR = \"accessKeyId\";\n     private static final String ACCESS_KEY_DOWNSTREAM_STR = \"AccessKeyId\";\n-    private static final String SECRET_ACCESS_UPSTREAM_STR = \"secretAccessKey\";\n     private static final String SECRET_ACCESS_DOWNSTREAM_STR = \"SecretAccessKey\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f12132ecb88d3508b1d86ba3087b3c1324423d47"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MzcxOTI5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDo0NDoyMFrOGoidDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDo0NDoyMFrOGoidDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2MDcxNw==", "bodyText": "You need to update the logger class?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445160717", "createdAt": "2020-06-24T20:44:20Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.aws.iot.evergreen.deployment.DeviceConfiguration;\n+import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider.X509CredentialsProviderBuilder;\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.ClientTlsContext;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.io.TlsContextOptions;\n+\n+import java.util.Date;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Inject;\n+\n+public class CredentialsProviderBuilder {\n+    private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f12132ecb88d3508b1d86ba3087b3c1324423d47"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MzcyMjk3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMDo0NToyOVrOGoifZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxODowMTowNlrOGpF0bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2MTMxOA==", "bodyText": "Do you also need to validate if credentials is not null before returning?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445161318", "createdAt": "2020-06-24T20:45:29Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.aws.iot.evergreen.deployment.DeviceConfiguration;\n+import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider.X509CredentialsProviderBuilder;\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.ClientTlsContext;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.io.TlsContextOptions;\n+\n+import java.util.Date;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Inject;\n+\n+public class CredentialsProviderBuilder {\n+    private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n+    private X509CredentialsProviderBuilder x509builder;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param deviceConfiguration Device configuration helper getting cert and keys for mTLS\n+     * @throws DeviceConfigurationException When unable to initialize this manager.\n+     */\n+    @Inject\n+    CredentialsProviderBuilder(final DeviceConfiguration deviceConfiguration) throws DeviceConfigurationException {\n+        this.x509builder = initCredentialsProviderBuilder(deviceConfiguration);\n+    }\n+\n+    private X509CredentialsProviderBuilder initCredentialsProviderBuilder(DeviceConfiguration deviceConfiguration)\n+            throws DeviceConfigurationException {\n+        final String certPath = Coerce.toString(deviceConfiguration.getCertificateFilePath());\n+        final String keyPath = Coerce.toString(deviceConfiguration.getPrivateKeyFilePath());\n+        final String caPath = Coerce.toString(deviceConfiguration.getRootCAFilePath());\n+        final String thingName = Coerce.toString(deviceConfiguration.getThingName());\n+        final String credEndpoint = Coerce.toString(deviceConfiguration.getIotCredentialEndpoint());\n+        try (EventLoopGroup eventLoopGroup = new EventLoopGroup(1);\n+            HostResolver resolver = new HostResolver(eventLoopGroup);\n+            ClientBootstrap clientBootstrap = new ClientBootstrap(eventLoopGroup, resolver);\n+            TlsContextOptions tlsCtxOptions = TlsContextOptions.createWithMtlsFromPath(certPath, keyPath)) {\n+            // TODO: Proxy support\n+            tlsCtxOptions.overrideDefaultTrustStoreFromPath(null, caPath);\n+            try (ClientTlsContext tlsContext = new ClientTlsContext(tlsCtxOptions)) {\n+                x509builder = new X509CredentialsProvider.X509CredentialsProviderBuilder()\n+                        .withClientBootstrap(clientBootstrap)\n+                        .withTlsContext(tlsContext)\n+                        .withEndpoint(credEndpoint)\n+                        .withThingName(thingName);\n+                return x509builder;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Sets the role alias to fetch credentials through.\n+     * @param roleAlias name of the role alias to use\n+     */\n+    public void withRoleAlias(String roleAlias) {\n+        x509builder.withRoleAlias(roleAlias);\n+    }\n+\n+    /**\n+     * To fetch credential.\n+     * @return AWS IoT credential\n+     * @throws AWSIotException when fetching credentials fails\n+     */\n+    public Credentials getCredentials() throws AWSIotException {\n+        Credentials credentials;\n+        try (X509CredentialsProvider provider = x509builder.build()) {\n+            CompletableFuture<Credentials> future = provider.getCredentials();\n+            credentials = future.get();\n+        } catch (InterruptedException | ExecutionException e) {\n+            LOGGER.error(\"Getting AWS IOT credentials failed with error {} \", e);\n+            throw new AWSIotException(e);\n+        }\n+        return credentials;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f12132ecb88d3508b1d86ba3087b3c1324423d47"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0MDE0Mw==", "bodyText": "We need to think about the error behavior for this library now, especially when network is not available, what kind of errors do we get.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/288#discussion_r445740143", "createdAt": "2020-06-25T18:01:06Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/iot/evergreen/tes/CredentialsProviderBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.tes;\n+\n+import com.aws.iot.evergreen.deployment.DeviceConfiguration;\n+import com.aws.iot.evergreen.deployment.exceptions.AWSIotException;\n+import com.aws.iot.evergreen.deployment.exceptions.DeviceConfigurationException;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Coerce;\n+import software.amazon.awssdk.crt.auth.credentials.Credentials;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider;\n+import software.amazon.awssdk.crt.auth.credentials.X509CredentialsProvider.X509CredentialsProviderBuilder;\n+import software.amazon.awssdk.crt.io.ClientBootstrap;\n+import software.amazon.awssdk.crt.io.ClientTlsContext;\n+import software.amazon.awssdk.crt.io.EventLoopGroup;\n+import software.amazon.awssdk.crt.io.HostResolver;\n+import software.amazon.awssdk.crt.io.TlsContextOptions;\n+\n+import java.util.Date;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import javax.inject.Inject;\n+\n+public class CredentialsProviderBuilder {\n+    private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n+    private X509CredentialsProviderBuilder x509builder;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param deviceConfiguration Device configuration helper getting cert and keys for mTLS\n+     * @throws DeviceConfigurationException When unable to initialize this manager.\n+     */\n+    @Inject\n+    CredentialsProviderBuilder(final DeviceConfiguration deviceConfiguration) throws DeviceConfigurationException {\n+        this.x509builder = initCredentialsProviderBuilder(deviceConfiguration);\n+    }\n+\n+    private X509CredentialsProviderBuilder initCredentialsProviderBuilder(DeviceConfiguration deviceConfiguration)\n+            throws DeviceConfigurationException {\n+        final String certPath = Coerce.toString(deviceConfiguration.getCertificateFilePath());\n+        final String keyPath = Coerce.toString(deviceConfiguration.getPrivateKeyFilePath());\n+        final String caPath = Coerce.toString(deviceConfiguration.getRootCAFilePath());\n+        final String thingName = Coerce.toString(deviceConfiguration.getThingName());\n+        final String credEndpoint = Coerce.toString(deviceConfiguration.getIotCredentialEndpoint());\n+        try (EventLoopGroup eventLoopGroup = new EventLoopGroup(1);\n+            HostResolver resolver = new HostResolver(eventLoopGroup);\n+            ClientBootstrap clientBootstrap = new ClientBootstrap(eventLoopGroup, resolver);\n+            TlsContextOptions tlsCtxOptions = TlsContextOptions.createWithMtlsFromPath(certPath, keyPath)) {\n+            // TODO: Proxy support\n+            tlsCtxOptions.overrideDefaultTrustStoreFromPath(null, caPath);\n+            try (ClientTlsContext tlsContext = new ClientTlsContext(tlsCtxOptions)) {\n+                x509builder = new X509CredentialsProvider.X509CredentialsProviderBuilder()\n+                        .withClientBootstrap(clientBootstrap)\n+                        .withTlsContext(tlsContext)\n+                        .withEndpoint(credEndpoint)\n+                        .withThingName(thingName);\n+                return x509builder;\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Sets the role alias to fetch credentials through.\n+     * @param roleAlias name of the role alias to use\n+     */\n+    public void withRoleAlias(String roleAlias) {\n+        x509builder.withRoleAlias(roleAlias);\n+    }\n+\n+    /**\n+     * To fetch credential.\n+     * @return AWS IoT credential\n+     * @throws AWSIotException when fetching credentials fails\n+     */\n+    public Credentials getCredentials() throws AWSIotException {\n+        Credentials credentials;\n+        try (X509CredentialsProvider provider = x509builder.build()) {\n+            CompletableFuture<Credentials> future = provider.getCredentials();\n+            credentials = future.get();\n+        } catch (InterruptedException | ExecutionException e) {\n+            LOGGER.error(\"Getting AWS IOT credentials failed with error {} \", e);\n+            throw new AWSIotException(e);\n+        }\n+        return credentials;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2MTMxOA=="}, "originalCommit": {"oid": "f12132ecb88d3508b1d86ba3087b3c1324423d47"}, "originalPosition": 88}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4358, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}