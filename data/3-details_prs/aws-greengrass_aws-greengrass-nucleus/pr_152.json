{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NzAyMjky", "number": 152, "title": "Add deployment dependency conflict e2e test", "bodyText": "Also fix a bug where deployment service does not report the error\n\nIssue #, if available:\nSIM: P34430967\nDescription of changes:\nAdd an e2e test for deployment where the new deployment has a conflict.\nWhy is this change necessary:\nAdd more e2e test coverage.\nHow was this change tested:\nAny additional information or context required to review the change:\nThis is still a WIP. In particular, I get timeout error when running the test in command line. I am only able to pass the test in debugger. But I want to send it out earlier for feedback.\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-02T17:02:25Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152", "merged": true, "mergeCommit": {"oid": "30c078a2bb50774e9115363246393ea77f8adc9d"}, "closed": true, "closedAt": "2020-04-07T17:04:18Z", "author": {"login": "fufranci"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTvOugAH2gAyMzk3NzAyMjkyOjgwMjgyMTk4M2IwMTRkNzQ4MWM2N2NkYjYzNGQ3MzEyZTZlYTI3MDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVWWcVgFqTM4OTMxNTUwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "802821983b014d7481c67cdb634d7312e6ea2709", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/802821983b014d7481c67cdb634d7312e6ea2709", "committedDate": "2020-04-02T16:52:16Z", "message": "Add deployment dependency conflict e2e test\n\n* Also fix a bug where deployment service does not report the error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NjMxMjY0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#pullrequestreview-386631264", "createdAt": "2020-04-02T17:14:38Z", "commit": {"oid": "802821983b014d7481c67cdb634d7312e6ea2709"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNzoxNDozOFrOF_1NdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNzoxNDozOFrOF_1NdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ3NjQwNQ==", "bodyText": "These shouldn't really be needed for your test since your test is supposed to fail, so nothing will be merged anyway.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#discussion_r402476405", "createdAt": "2020-04-02T17:14:38Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -155,6 +156,53 @@ void GIVEN_kernel_running_with_deployed_services_WHEN_deployment_removes_package\n                 Utils.iotClient.describeJob(DescribeJobRequest.builder().jobId(jobId2).build()).job().status());\n     }\n \n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_kernel_running_with_deployed_services_WHEN_deployment_has_conflicts_THEN_job_should_fail_and_return_error()\n+            throws Exception {\n+        // Target our DUT for deployments\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+\n+        // First deployment to have some services running in Kernel\n+        String document1 = new ObjectMapper().writeValueAsString(\n+                DeploymentDocument.builder()\n+                        .timestamp(System.currentTimeMillis())\n+                        .deploymentId(UUID.randomUUID().toString())\n+                        .rootPackages(Arrays.asList(\"SomeService\"))\n+                        .deploymentPackageConfigurationList(Arrays.asList(\n+                                new DeploymentPackageConfiguration(\"SomeService\", \"1.0.0\", null, null, null)))\n+                        .build());\n+        String jobId1 = Utils.createJob(document1, targets);\n+        Utils.waitForJobToComplete(jobId1, Duration.ofMinutes(5));\n+\n+        // Second deployment contains dependency conflicts\n+        String document2 = new ObjectMapper().writeValueAsString(\n+                DeploymentDocument.builder()\n+                        .timestamp(System.currentTimeMillis())\n+                        .deploymentId(UUID.randomUUID().toString())\n+                        .rootPackages(Arrays.asList(\"SomeService\", \"SomeOldService\"))\n+                        .deploymentPackageConfigurationList(Arrays.asList(\n+                                new DeploymentPackageConfiguration(\"SomeService\", \"1.0.0\", null, null, null),\n+                                new DeploymentPackageConfiguration(\"SomeOldService\", \"0.9.0\", null, null, null)))\n+                        .build());\n+        String jobId2 = Utils.createJob(document2, targets);\n+        Utils.waitForJobToComplete(jobId2, Duration.ofMinutes(5));\n+\n+        // Ensure that main is finished, which is its terminal state, so this means that all updates ought to be done\n+        assertEquals(State.FINISHED, kernel.getMain().getState());\n+        assertEquals(State.FINISHED, EvergreenService.locate(kernel.context, \"SomeService\").getState());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802821983b014d7481c67cdb634d7312e6ea2709"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NjMyODcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#pullrequestreview-386632873", "createdAt": "2020-04-02T17:16:47Z", "commit": {"oid": "802821983b014d7481c67cdb634d7312e6ea2709"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNzoxNjo0N1rOF_1ShA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNzoxNjo0N1rOF_1ShA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ3NzcwMA==", "bodyText": "To limit flakiness, I don't think our initial provisioning should be through IoT jobs. I'd suggest instead that you setup the kernel's initial state through a config.yaml file that contains the SomeService.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#discussion_r402477700", "createdAt": "2020-04-02T17:16:47Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -155,6 +156,53 @@ void GIVEN_kernel_running_with_deployed_services_WHEN_deployment_removes_package\n                 Utils.iotClient.describeJob(DescribeJobRequest.builder().jobId(jobId2).build()).job().status());\n     }\n \n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)\n+    @Test\n+    void GIVEN_kernel_running_with_deployed_services_WHEN_deployment_has_conflicts_THEN_job_should_fail_and_return_error()\n+            throws Exception {\n+        // Target our DUT for deployments\n+        // TODO: Eventually switch this to target using Thing Group instead of individual Thing\n+        String[] targets = {thing.thingArn};\n+\n+        // First deployment to have some services running in Kernel\n+        String document1 = new ObjectMapper().writeValueAsString(\n+                DeploymentDocument.builder()\n+                        .timestamp(System.currentTimeMillis())\n+                        .deploymentId(UUID.randomUUID().toString())\n+                        .rootPackages(Arrays.asList(\"SomeService\"))\n+                        .deploymentPackageConfigurationList(Arrays.asList(\n+                                new DeploymentPackageConfiguration(\"SomeService\", \"1.0.0\", null, null, null)))\n+                        .build());\n+        String jobId1 = Utils.createJob(document1, targets);\n+        Utils.waitForJobToComplete(jobId1, Duration.ofMinutes(5));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802821983b014d7481c67cdb634d7312e6ea2709"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64245a2babe930084825e02a4744090bda77bf38", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/64245a2babe930084825e02a4744090bda77bf38", "committedDate": "2020-04-03T06:26:47Z", "message": "* Remove unnecessary asserts\n* Test should not shutdown kernel. It is done in `afterAll`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f92ac8c15e36d7a4286305c8a8c4beabaac1970", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f92ac8c15e36d7a4286305c8a8c4beabaac1970", "committedDate": "2020-04-03T07:00:02Z", "message": "Merge branch 'master' into deployment_conflict_e2e"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00061903876a7aa61baabdccb7808451c2e4e224", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/00061903876a7aa61baabdccb7808451c2e4e224", "committedDate": "2020-04-03T22:15:10Z", "message": "Use a config file that already contains SomeService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60246f3744aed9a89dd565d5b952a6f6a6a96162", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/60246f3744aed9a89dd565d5b952a6f6a6a96162", "committedDate": "2020-04-03T22:18:50Z", "message": "Merge remote-tracking branch 'origin/master' into deployment_conflict_e2e"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NjE5MTc5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#pullrequestreview-387619179", "createdAt": "2020-04-03T22:39:49Z", "commit": {"oid": "60246f3744aed9a89dd565d5b952a6f6a6a96162"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMjozOTo0OVrOGArudg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMjozOTo0OVrOGArudg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM2OTU5MA==", "bodyText": "No shutdown? We need to stop the kernel after all tests.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#discussion_r403369590", "createdAt": "2020-04-03T22:39:49Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -100,7 +105,6 @@ void GIVEN_blank_kernel_WHEN_deploy_new_services_e2e_THEN_new_services_deployed_\n         // Ensure that main is finished, which is its terminal state, so this means that all updates ought to be done\n         assertEquals(State.FINISHED, kernel.getMain().getState());\n         assertEquals(State.FINISHED, EvergreenService.locate(kernel.context, \"CustomerApp\").getState());\n-        kernel.shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60246f3744aed9a89dd565d5b952a6f6a6a96162"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NjIwMDg0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#pullrequestreview-387620084", "createdAt": "2020-04-03T22:42:56Z", "commit": {"oid": "60246f3744aed9a89dd565d5b952a6f6a6a96162"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ceb924fd5e2b90cc299179e5214c05d62abb61c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5ceb924fd5e2b90cc299179e5214c05d62abb61c", "committedDate": "2020-04-04T01:15:46Z", "message": "Merge branch 'master' into deployment_conflict_e2e"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1a3eae57fcae5de6517ad8b893e210af9295ea7", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d1a3eae57fcae5de6517ad8b893e210af9295ea7", "committedDate": "2020-04-06T05:45:21Z", "message": "Add back `injectKernelPackageManagementDependencies`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDU2ODYz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#pullrequestreview-388456863", "createdAt": "2020-04-06T17:16:21Z", "commit": {"oid": "d1a3eae57fcae5de6517ad8b893e210af9295ea7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDY4NTQ3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#pullrequestreview-388468547", "createdAt": "2020-04-06T17:31:21Z", "commit": {"oid": "d1a3eae57fcae5de6517ad8b893e210af9295ea7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjI4MTYw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#pullrequestreview-388628160", "createdAt": "2020-04-06T21:23:56Z", "commit": {"oid": "d1a3eae57fcae5de6517ad8b893e210af9295ea7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMToyMzo1NlrOGBqc3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMToyMzo1NlrOGBqc3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NzI3Ng==", "bodyText": "Let's cut down all these timeouts. In practice, when they pass, they don't take more than 2-3 minutes. Have a look at a successful test in GitHub actions and then set the timeout based on that.\nProbably should update the Utils.waitForJobToComplete timeout to be the 2-3 minutes. Then remove this @Timeout. The default timeout is 5 minutes per test, so let's stick with that by removing this annotation and then decreasing how long the test itself waits.\nApply the change to all the tests in this class.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#discussion_r404397276", "createdAt": "2020-04-06T21:23:56Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -152,6 +161,39 @@ void GIVEN_kernel_running_with_deployed_services_WHEN_deployment_removes_package\n                 Utils.iotClient.describeJob(DescribeJobRequest.builder().jobId(jobId2).build()).job().status());\n     }\n \n+    @Timeout(value = 10, unit = TimeUnit.MINUTES)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1a3eae57fcae5de6517ad8b893e210af9295ea7"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "085aeadc8948a903e16018bbf361a49cf0a121f7", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/085aeadc8948a903e16018bbf361a49cf0a121f7", "committedDate": "2020-04-06T23:32:30Z", "message": "Move kernel.shutdown() to afterEach."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8694a99006667c5c330b7299b7005e0bdcdf043e", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8694a99006667c5c330b7299b7005e0bdcdf043e", "committedDate": "2020-04-06T23:34:11Z", "message": "Merge remote-tracking branch 'origin/master' into deployment_conflict_e2e"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3beb05fd3ca21001fabdab4cd3292dea200c000", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e3beb05fd3ca21001fabdab4cd3292dea200c000", "committedDate": "2020-04-07T00:25:17Z", "message": "Remove timeout per test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61797eea17c27c7fd7ad0526cd7c7eb6932871f7", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/61797eea17c27c7fd7ad0526cd7c7eb6932871f7", "committedDate": "2020-04-07T05:12:25Z", "message": "Add sleep after kernel.launch()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63cc7adc81643de8fa150269b59326f2f0ae14b6", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/63cc7adc81643de8fa150269b59326f2f0ae14b6", "committedDate": "2020-04-07T05:13:13Z", "message": "Merge remote-tracking branch 'origin/master' into deployment_conflict_e2e"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzkyMDAy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#pullrequestreview-388792002", "createdAt": "2020-04-07T05:24:04Z", "commit": {"oid": "63cc7adc81643de8fa150269b59326f2f0ae14b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzE1NTA4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/152#pullrequestreview-389315508", "createdAt": "2020-04-07T17:00:55Z", "commit": {"oid": "63cc7adc81643de8fa150269b59326f2f0ae14b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2406, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}