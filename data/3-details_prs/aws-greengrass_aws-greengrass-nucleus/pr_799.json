{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNTIyNDc1", "number": 799, "title": "fix(deployment): Handle deployment cancellation correctly when deployment is not yet registered with UpdateSystemPolicyService", "bodyText": "fix(e2e): Add 1 TPS limit to GCS createComponent calls for test component creation\nfix(benchmark): Remove benchmark workflow\nIssue #, if available:\n#798\n[See issue for details]\nDescription of changes:\nCorrectly handle the stage deployment is in when evaluating if it can be cancelled. There was a regression introduced in device deployment handling which causes the evaluation to not work in cases when deployment is not yet registered in the UpdateSystemPolicyService's pendingActions queue, i.e. while deployment is still in dependency resolution/download artifacts stage.\nWhy is this change necessary:\nNecessary to ensure deployment cancellation can be handled correctly\nHow was this change tested:\nAdded a new E2E test GIVEN_deployment_in_dependency_resolution_stage_WHEN_cancel_event_received_THEN_deployment_should_be_cancelled, tested that it passes\nmvn surefire:test@integration-tests -Dgroups=\"E2E\" -DexcludedGroups=\"\" -Dsurefire.argLine=\"\" -Dtest=DeploymentE2ETest#GIVEN_deployment_in_dependency_resolution_stage_WHEN_cancel_event_received_THEN_deployment_should_be_cancelled\n\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-17T00:33:31Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799", "merged": true, "mergeCommit": {"oid": "95ca6e23559047f8ff1b8eb2c510b9093ca85fb4"}, "closed": true, "closedAt": "2020-12-17T02:06:56Z", "author": {"login": "shaguptashaikh"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm4mAKgBqjQxMjI2Mzk0ODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm5XFxAFqTU1NDIxNzAxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b08b9a9b5953bd81aee615ac4f06d23317e8db7b", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b08b9a9b5953bd81aee615ac4f06d23317e8db7b", "committedDate": "2020-12-17T00:25:16Z", "message": "fix(cancellation): Condition to check if deployment can be cancelled should evaluate to true if deployment has not started config merge yet\nfix(e2e): Add 1 TPS limit to GCS createComponent calls for test component creation"}, "afterCommit": {"oid": "eeccc874ab076c403ce16ccdad7b1dc7ec29faee", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eeccc874ab076c403ce16ccdad7b1dc7ec29faee", "committedDate": "2020-12-17T00:42:23Z", "message": "fix(cancellation): Condition to check if deployment can be cancelled should evaluate to true if deployment has not started config merge yet\nfix(e2e): Add 1 TPS limit to GCS createComponent calls for test component creation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f793e6bdd1f5943b1684fba3c6ae55edd8230443", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f793e6bdd1f5943b1684fba3c6ae55edd8230443", "committedDate": "2020-12-17T00:52:12Z", "message": "fix(cancellation): Condition to check if deployment can be cancelled should evaluate to true if deployment has not started config merge yet\nfix(e2e): Add 1 TPS limit to GCS createComponent calls for test component creation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eeccc874ab076c403ce16ccdad7b1dc7ec29faee", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eeccc874ab076c403ce16ccdad7b1dc7ec29faee", "committedDate": "2020-12-17T00:42:23Z", "message": "fix(cancellation): Condition to check if deployment can be cancelled should evaluate to true if deployment has not started config merge yet\nfix(e2e): Add 1 TPS limit to GCS createComponent calls for test component creation"}, "afterCommit": {"oid": "f793e6bdd1f5943b1684fba3c6ae55edd8230443", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f793e6bdd1f5943b1684fba3c6ae55edd8230443", "committedDate": "2020-12-17T00:52:12Z", "message": "fix(cancellation): Condition to check if deployment can be cancelled should evaluate to true if deployment has not started config merge yet\nfix(e2e): Add 1 TPS limit to GCS createComponent calls for test component creation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjA0MjQz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#pullrequestreview-554204243", "createdAt": "2020-12-17T01:01:06Z", "commit": {"oid": "f793e6bdd1f5943b1684fba3c6ae55edd8230443"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMTowMTowNlrOIHf4Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMTowMTowNlrOIHf4Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDczMzI0Ng==", "bodyText": "What happens if the action is in progress, like mentioned in the javadoc?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#discussion_r544733246", "createdAt": "2020-12-17T01:01:06Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/UpdateSystemPolicyService.java", "diffHunk": "@@ -116,7 +117,8 @@ public boolean discardPendingUpdateAction(String tag) {\n         }\n         // Signal components that they can resume their work since the update is not going to happen\n         lifecycleIPCAgent.sendPostComponentUpdateEvent(new PostComponentUpdateEvent());\n-        return pendingActions.remove(tag) != null;\n+        pendingActions.remove(tag);\n+        return true;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f793e6bdd1f5943b1684fba3c6ae55edd8230443"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjEwOTIw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#pullrequestreview-554210920", "createdAt": "2020-12-17T01:18:54Z", "commit": {"oid": "f793e6bdd1f5943b1684fba3c6ae55edd8230443"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjEyNjU5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#pullrequestreview-554212659", "createdAt": "2020-12-17T01:23:45Z", "commit": {"oid": "f793e6bdd1f5943b1684fba3c6ae55edd8230443"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMToyMzo0NlrOIHgYww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMToyMzo0NlrOIHgYww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MTU3MQ==", "bodyText": "Why not just use ConcurrentHashMap?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#discussion_r544741571", "createdAt": "2020-12-17T01:23:46Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/UpdateSystemPolicyService.java", "diffHunk": "@@ -47,7 +48,7 @@\n     // String identifies the action, the pair consist of timeout and an action. The timeout\n     // represents the value in seconds the kernel will wait for components to respond to\n     // an precomponent update event\n-    private final Map<String, UpdateAction> pendingActions = new LinkedHashMap<>();\n+    private final Map<String, UpdateAction> pendingActions = Collections.synchronizedMap(new LinkedHashMap<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f793e6bdd1f5943b1684fba3c6ae55edd8230443"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d69ddc2a41ad31553c1ae2862066f7082c0847f8", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d69ddc2a41ad31553c1ae2862066f7082c0847f8", "committedDate": "2020-12-17T01:34:19Z", "message": "fix(benchmark):Remove benchmark workflow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjE2NzQx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#pullrequestreview-554216741", "createdAt": "2020-12-17T01:35:20Z", "commit": {"oid": "d69ddc2a41ad31553c1ae2862066f7082c0847f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjE2ODg1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#pullrequestreview-554216885", "createdAt": "2020-12-17T01:35:45Z", "commit": {"oid": "d69ddc2a41ad31553c1ae2862066f7082c0847f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjE3MDE3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/799#pullrequestreview-554217017", "createdAt": "2020-12-17T01:36:10Z", "commit": {"oid": "d69ddc2a41ad31553c1ae2862066f7082c0847f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2591, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}