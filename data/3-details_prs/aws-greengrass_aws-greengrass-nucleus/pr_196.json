{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NzA5NzAz", "number": 196, "title": "[PMD] AvoidGettingFutureWithoutTimeout in removing/closing a service", "bodyText": "Issue #, if available:\nhttps://sim.amazon.com/issues/P34897047\nDescription of changes:\n\nUse Future#get with timeout.\nHandle TimeoutException\n\nWhy is this change necessary:\n\nCalling Future#get without timeout could block the calling thread forever.\n\nHow was this change tested:\n\nmvn clean pmd:check\nmvn clean package\n\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-21T14:25:36Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196", "merged": true, "mergeCommit": {"oid": "1ccdf8267910fe1ed35fdad78f610c78aba18b8a"}, "closed": true, "closedAt": "2020-04-22T15:52:15Z", "author": {"login": "fufranci"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZ0W1yAH2gAyNDA2NzA5NzAzOjY4NzlmMjMyZGIyM2E0NDczZDFkM2RjYzliMGFhMjNkMDlhN2FiY2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaKUxRgFqTM5ODMzMDg5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6879f232db23a4473d1d3dcc9b0aa23d09a7abcb", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6879f232db23a4473d1d3dcc9b0aa23d09a7abcb", "committedDate": "2020-04-21T14:14:12Z", "message": "[PMD] AvoidGettingFutureWithoutTimeout in removing/closing a service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDY5NDM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#pullrequestreview-397469436", "createdAt": "2020-04-21T16:26:32Z", "commit": {"oid": "6879f232db23a4473d1d3dcc9b0aa23d09a7abcb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjoyNjozMlrOGJNHOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjoyNjozMlrOGJNHOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwNTIxMQ==", "bodyText": "don't add the suppression because it is wrong. Please just delete the rule from the xml files since the rule is broken.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#discussion_r412305211", "createdAt": "2020-04-21T16:26:32Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -202,6 +202,7 @@ private void enqueueStateEvent(Object event) {\n         }\n     }\n \n+    @SuppressWarnings(\"PMD.AvoidGettingFutureWithoutTimeout\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6879f232db23a4473d1d3dcc9b0aa23d09a7abcb"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "589c51896e133292c5c2890f7039f73cfe5aafba", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/589c51896e133292c5c2890f7039f73cfe5aafba", "committedDate": "2020-04-21T18:34:13Z", "message": "Remove the AvoidGettingFutureWithoutTimeout rule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bda792f575d22e72ef644d567c6eeb83e042de1f", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bda792f575d22e72ef644d567c6eeb83e042de1f", "committedDate": "2020-04-21T19:18:57Z", "message": "Merge remote-tracking branch 'origin/master' into AvoidGettingFutureWithoutTimeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjI3NDgy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#pullrequestreview-397627482", "createdAt": "2020-04-21T19:54:42Z", "commit": {"oid": "bda792f575d22e72ef644d567c6eeb83e042de1f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3Njc0ODk3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#pullrequestreview-397674897", "createdAt": "2020-04-21T21:05:43Z", "commit": {"oid": "bda792f575d22e72ef644d567c6eeb83e042de1f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTowNTo0NFrOGJYc8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTowNTo0NFrOGJYc8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ5MDk5Mw==", "bodyText": "not sure we can put a timeout here.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#discussion_r412490993", "createdAt": "2020-04-21T21:05:44Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -47,9 +51,7 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n \n             List<PackageIdentifier> desiredPackages = dependencyResolver\n                     .resolveDependencies(deploymentDocument, rootPackages);\n-            // Block this without timeout because a device can be offline and it can take quite a long time\n-            // to download a package.\n-            packageStore.preparePackages(desiredPackages).get();\n+            packageStore.preparePackages(desiredPackages).get(TIMEOUT_MINUTES, TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda792f575d22e72ef644d567c6eeb83e042de1f"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjkwMjA2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#pullrequestreview-397690206", "createdAt": "2020-04-21T21:29:49Z", "commit": {"oid": "bda792f575d22e72ef644d567c6eeb83e042de1f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMToyOTo0OVrOGJZUFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTozMjo1N1rOGJZaew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUwNTExMA==", "bodyText": "Why 30 seconds?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#discussion_r412505110", "createdAt": "2020-04-21T21:29:49Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -35,6 +37,7 @@\n     public static final String MERGE_CONFIG_EVENT_KEY = \"merge-config\";\n \n     private static final Logger logger = LogManager.getLogger(DeploymentConfigMerger.class);\n+    private static final int TIMEOUT_SECONDS = 30;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda792f575d22e72ef644d567c6eeb83e042de1f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUwNTk2Nw==", "bodyText": "The original comment already explain why timeout is not needed here. 30 second is very likely not sufficient for a deployment to finish.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#discussion_r412505967", "createdAt": "2020-04-21T21:31:19Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -215,14 +217,11 @@ private void connectToAWSIot() throws InterruptedException {\n \n     }\n \n-    @SuppressWarnings({\"PMD.NullAssignment\", \"PMD.AvoidGettingFutureWithoutTimeout\"})\n+    @SuppressWarnings(\"PMD.NullAssignment\")\n     private void finishCurrentDeployment() throws InterruptedException {\n         logger.atInfo().kv(JOB_ID_LOG_KEY_NAME, currentJobId).log(\"Current deployment finished\");\n         try {\n-            //No timeout is set here. Detection of error is delegated to downstream components like\n-            // dependency resolver, package downloader, kernel which will have more visibility\n-            // if something is going wrong\n-            currentProcessStatus.get();\n+            currentProcessStatus.get(TIMEOUT_SECONDS, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda792f575d22e72ef644d567c6eeb83e042de1f"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUwNjc0Nw==", "bodyText": "Didn't the comment already explain? We don't need a timeout here.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#discussion_r412506747", "createdAt": "2020-04-21T21:32:57Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -47,9 +51,7 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n \n             List<PackageIdentifier> desiredPackages = dependencyResolver\n                     .resolveDependencies(deploymentDocument, rootPackages);\n-            // Block this without timeout because a device can be offline and it can take quite a long time\n-            // to download a package.\n-            packageStore.preparePackages(desiredPackages).get();\n+            packageStore.preparePackages(desiredPackages).get(TIMEOUT_MINUTES, TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ5MDk5Mw=="}, "originalCommit": {"oid": "bda792f575d22e72ef644d567c6eeb83e042de1f"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "963b25f3a0b359e7c0c8b70229bce2dcfb4fcdb8", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/963b25f3a0b359e7c0c8b70229bce2dcfb4fcdb8", "committedDate": "2020-04-21T22:25:59Z", "message": "Undo the timeout changes related to deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3948df35725d3c65c01610c0499d0e119912c1c7", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3948df35725d3c65c01610c0499d0e119912c1c7", "committedDate": "2020-04-21T22:26:41Z", "message": "Merge remote-tracking branch 'origin/master' into AvoidGettingFutureWithoutTimeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3Nzk0MTY0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#pullrequestreview-397794164", "createdAt": "2020-04-22T02:09:46Z", "commit": {"oid": "3948df35725d3c65c01610c0499d0e119912c1c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjowOTo0NlrOGJgHGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjowOTo0NlrOGJgHGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxNjQ3Mg==", "bodyText": "I'm not sure if we should remove this. Can we keep it and just add SuppressWarnings in the few places we don't need timeout? I think in the majority of cases we want to enforce a timeout.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#discussion_r412616472", "createdAt": "2020-04-22T02:09:46Z", "author": {"login": "fengwang666"}, "path": "codestyle/pmd-eg-ruleset.xml", "diffHunk": "@@ -79,26 +79,6 @@\n     </rule>\n     <rule ref=\"category/java/security.xml\">\n     </rule>\n-    <rule name=\"AvoidGettingFutureWithoutTimeout\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3948df35725d3c65c01610c0499d0e119912c1c7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9fd91262eb3166b49af893ca09bc4940a1488e8", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a9fd91262eb3166b49af893ca09bc4940a1488e8", "committedDate": "2020-04-22T04:02:42Z", "message": "Merge remote-tracking branch 'origin/master' into AvoidGettingFutureWithoutTimeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODU5NTY3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#pullrequestreview-397859567", "createdAt": "2020-04-22T05:46:05Z", "commit": {"oid": "a9fd91262eb3166b49af893ca09bc4940a1488e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MzMwODkw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/196#pullrequestreview-398330890", "createdAt": "2020-04-22T15:49:51Z", "commit": {"oid": "a9fd91262eb3166b49af893ca09bc4940a1488e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2140, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}