{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5MDE2NTY1", "number": 790, "title": "Fixing a race condition during validate config", "bodyText": "Issue #, if available:\nComponent responds very quickly to the validate config request. By this time the nucleus does not seem to have added the responseFuture entry into the map. This results in failure of sendConfigValidationReport request to fail.\nSample failed test run - https://tim-files.amazon.com/amazon.qtt.tod/runs/31ba847b-b1e6-475a-b66c-9dfae6fdd8b1/brazil-e2e-tests/report-feature_5_1110295403.html\nDescription of changes:\nPutting the responseFuture into the map before sending request to the component.\nWhy is this change necessary:\nHow was this change tested:\nCannot reproduce locally.\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-13T20:39:35Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/790", "merged": true, "mergeCommit": {"oid": "93b673711c73886d173c361df4ee46def99f0a4d"}, "closed": true, "closedAt": "2020-12-13T22:54:48Z", "author": {"login": "abanthiy"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdl3V4rgFqTU1MDk1Nzg1NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdl4n4ugFqTU1MDk2NTk3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTU3ODU1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/790#pullrequestreview-550957855", "createdAt": "2020-12-13T20:41:07Z", "commit": {"oid": "7ea0ce4e40ffc77ae1271deb16f81db6136d1725"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e27172de6f6b602027f9c6f70a6905af4bbaa75", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0e27172de6f6b602027f9c6f70a6905af4bbaa75", "committedDate": "2020-12-13T20:42:48Z", "message": "Fixing a race condition during validate config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ea0ce4e40ffc77ae1271deb16f81db6136d1725", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7ea0ce4e40ffc77ae1271deb16f81db6136d1725", "committedDate": "2020-12-13T20:32:58Z", "message": "Fixing a race condition during validate config"}, "afterCommit": {"oid": "0e27172de6f6b602027f9c6f70a6905af4bbaa75", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0e27172de6f6b602027f9c6f70a6905af4bbaa75", "committedDate": "2020-12-13T20:42:48Z", "message": "Fixing a race condition during validate config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTYwNDQx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/790#pullrequestreview-550960441", "createdAt": "2020-12-13T21:09:21Z", "commit": {"oid": "0e27172de6f6b602027f9c6f70a6905af4bbaa75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QyMTowOToyMVrOIE5bSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QyMTowOToyMVrOIE5bSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjAwNjA4OA==", "bodyText": "Don't we remove all the todos as part of the open source effort? @jbutler", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/790#discussion_r542006088", "createdAt": "2020-12-13T21:09:21Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/builtin/services/configstore/ConfigStoreIPCEventStreamAgent.java", "diffHunk": "@@ -524,13 +524,15 @@ public boolean validateConfiguration(String componentName, String deploymentId,\n             throws ValidateEventRegistrationException {\n         for (Map.Entry<String, BiConsumer<String, Map<String, Object>>> e : configValidationListeners.entrySet()) {\n             if (e.getKey().equals(componentName)) {\n+                Pair componentToDeploymentId = new Pair<>(componentName, deploymentId);\n                 try {\n+                    configValidationReportFutures.put(componentToDeploymentId, reportFuture);\n                     e.getValue().accept(deploymentId, configuration);\n-                    configValidationReportFutures.put(new Pair<>(componentName, deploymentId), reportFuture);\n                     return true;\n                 } catch (Exception ex) {\n                     // TODO: [P41211196]: Retries, timeouts & and better exception handling in sending server event to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e27172de6f6b602027f9c6f70a6905af4bbaa75"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTYwNzEw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/790#pullrequestreview-550960710", "createdAt": "2020-12-13T21:12:30Z", "commit": {"oid": "0e27172de6f6b602027f9c6f70a6905af4bbaa75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTY1OTcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/790#pullrequestreview-550965973", "createdAt": "2020-12-13T22:10:41Z", "commit": {"oid": "0e27172de6f6b602027f9c6f70a6905af4bbaa75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2581, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}