{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MTQ0ODgx", "number": 540, "title": "Cleanup websocket proxy, add timeout to event loop shutdown future to\u2026", "bodyText": "\u2026 prevent hanging\nIssue #, if available:\nDescription of changes:\nCleanup the websocket options which don't apply. Add timeout to event loop shutdown future which was causing it to hang on shutdown forever.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-16T23:22:34Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540", "merged": true, "mergeCommit": {"oid": "02b9467d04e752529521141049301ef26626a214"}, "closed": true, "closedAt": "2020-10-17T00:55:04Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTO_I_AFqTUxMDg0NjM1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTPkvPAFqTUxMDg1Mzk0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODQ2MzUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#pullrequestreview-510846353", "createdAt": "2020-10-16T23:29:25Z", "commit": {"oid": "10ce33dca572c18ee608479a63adedfe32da61e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzoyOToyNVrOHjSRsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzoyOToyNVrOHjSRsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MTY0OQ==", "bodyText": "Do you think it's worth giving a hint about the potential permissions required? Maybe link to the same app?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#discussion_r506761649", "createdAt": "2020-10-16T23:29:25Z", "author": {"login": "philcali"}, "path": "src/main/java/com/aws/greengrass/iot/IotConnectionManager.java", "diffHunk": "@@ -102,11 +102,13 @@ public void close() {\n         resolver.close();\n         eventLoopGroup.close();\n         try {\n-            eventLoopGroup.getShutdownCompleteFuture().get();\n+            eventLoopGroup.getShutdownCompleteFuture().get(2, TimeUnit.SECONDS);\n         } catch (InterruptedException e) {\n             Thread.currentThread().interrupt();\n         } catch (ExecutionException e) {\n             LOGGER.atError().log(\"Error shutting down event loop\", e);\n+        } catch (TimeoutException e) {\n+            LOGGER.atError().log(\"Timed out shutting down event loop\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10ce33dca572c18ee608479a63adedfe32da61e4"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODQ3Mjg0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#pullrequestreview-510847284", "createdAt": "2020-10-16T23:33:32Z", "commit": {"oid": "10ce33dca572c18ee608479a63adedfe32da61e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzozMzozMlrOHjSVKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzozMzozMlrOHjSVKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MjUzOQ==", "bodyText": "Extract 2 to a constant. Also, why 2 seconds? How long should it take?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#discussion_r506762539", "createdAt": "2020-10-16T23:33:32Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/iot/IotConnectionManager.java", "diffHunk": "@@ -102,11 +102,13 @@ public void close() {\n         resolver.close();\n         eventLoopGroup.close();\n         try {\n-            eventLoopGroup.getShutdownCompleteFuture().get();\n+            eventLoopGroup.getShutdownCompleteFuture().get(2, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10ce33dca572c18ee608479a63adedfe32da61e4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODQ3NjA1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#pullrequestreview-510847605", "createdAt": "2020-10-16T23:34:58Z", "commit": {"oid": "10ce33dca572c18ee608479a63adedfe32da61e4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODQ3ODEz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#pullrequestreview-510847813", "createdAt": "2020-10-16T23:36:01Z", "commit": {"oid": "10ce33dca572c18ee608479a63adedfe32da61e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzozNjowMVrOHjSXMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzozNjowMVrOHjSXMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MzA1OA==", "bodyText": "Maybe I miss something here, aren't we suppose to use the certificate? Why are we using TES Role?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#discussion_r506763058", "createdAt": "2020-10-16T23:36:01Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/mqttclient/MqttClient.java", "diffHunk": "@@ -139,32 +139,31 @@ public MqttClient(Kernel kernel, DeviceConfiguration deviceConfiguration, Execut\n                         Coerce.toString(deviceConfiguration.getRootCAFilePath()));\n \n                 try (ClientTlsContext x509TlsContext = new ClientTlsContext(x509TlsOptions)) {\n-                    this.credentialsProvider = new X509CredentialsProvider.X509CredentialsProviderBuilder()\n-                            .withClientBootstrap(clientBootstrap)\n-                            .withTlsContext(x509TlsContext)\n-                            .withEndpoint(Coerce.toString(deviceConfiguration.getIotCredentialEndpoint()))\n-                            .withRoleAlias(tesRoleAlias)\n-                            .withThingName(Coerce.toString(deviceConfiguration.getThingName()))\n-                            .withProxyOptions(httpProxyOptions)\n-                            .build();\n+                    this.credentialsProvider =\n+                            new X509CredentialsProvider.X509CredentialsProviderBuilder()\n+                                    .withClientBootstrap(clientBootstrap).withTlsContext(x509TlsContext)\n+                                    .withEndpoint(Coerce.toString(deviceConfiguration.getIotCredentialEndpoint()))\n+                                    .withRoleAlias(tesRoleAlias)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10ce33dca572c18ee608479a63adedfe32da61e4"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODQ5NTAx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#pullrequestreview-510849501", "createdAt": "2020-10-16T23:44:36Z", "commit": {"oid": "10ce33dca572c18ee608479a63adedfe32da61e4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10ce33dca572c18ee608479a63adedfe32da61e4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/10ce33dca572c18ee608479a63adedfe32da61e4", "committedDate": "2020-10-16T23:21:43Z", "message": "Cleanup websocket proxy, add timeout to event loop shutdown future to prevent hanging"}, "afterCommit": {"oid": "fe01e3cfa0105cabc2f977cf8d804b2c7965abde", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fe01e3cfa0105cabc2f977cf8d804b2c7965abde", "committedDate": "2020-10-16T23:45:21Z", "message": "Cleanup websocket proxy, add timeout to event loop shutdown future to prevent hanging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODUwMDY3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#pullrequestreview-510850067", "createdAt": "2020-10-16T23:47:42Z", "commit": {"oid": "fe01e3cfa0105cabc2f977cf8d804b2c7965abde"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzo0Nzo0M1rOHjSfeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzo0Nzo0M1rOHjSfeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2NTE3OA==", "bodyText": "Beautiful", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#discussion_r506765178", "createdAt": "2020-10-16T23:47:43Z", "author": {"login": "philcali"}, "path": "src/main/java/com/aws/greengrass/mqttclient/AwsIotMqttClient.java", "diffHunk": "@@ -150,25 +146,32 @@ void reconnect() throws TimeoutException, ExecutionException, InterruptedExcepti\n         // Always use the builder provider here so that the builder is updated with whatever\n         // the latest device config is\n         try (AwsIotMqttConnectionBuilder builder = builderProvider.get()) {\n-            if (credentialsProvider != null) {\n-                builder.withWebsocketCredentialsProvider(credentialsProvider);\n-            }\n             builder.withConnectionEventCallbacks(connectionEventCallback);\n             builder.withClientId(clientId);\n \n             connection = builder.build();\n             // Set message handler for this connection to be our global message handler in MqttClient.\n             // The handler will then send out the message to all subscribers after appropriate filtering.\n             connection.onMessage(messageHandler);\n-            logger.atDebug().log(\"Connecting to AWS IoT Core\");\n+            logger.atInfo().log(\"Connecting to AWS IoT Core\");\n             return connection.connect().thenApply((sessionPresent) -> {\n                 currentlyConnected.set(true);\n-                logger.atDebug().kv(\"sessionPresent\", sessionPresent).log(\"Successfully connected to AWS IoT Core\");\n+                logger.atInfo().kv(\"sessionPresent\", sessionPresent).log(\"Successfully connected to AWS IoT Core\");\n \n                 if (!sessionPresent) {\n                     resubscribe();\n                 }\n                 return sessionPresent;\n+            }).whenComplete((session, error) -> {\n+                if (error != null) {\n+                    logger.atError().log(\"Unable to connect to AWS IoT Core\", error);\n+                    if (ProxyUtils.getProxyConfiguration() != null) {\n+                        logger.atInfo().log(\"You are using a proxy which uses a websocket connection and \"\n+                                + \"TokenExchangeService credentials. Verify that the IAM role which the IoT Role \"\n+                                + \"Alias is aliasing has a policy which allows for iot:Connect, iot:Subscribe, \"\n+                                + \"iot:Publish, iot:Receive, iot:GetThingShadow, and iot:UpdateThingShadow.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe01e3cfa0105cabc2f977cf8d804b2c7965abde"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODUwMDg2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#pullrequestreview-510850086", "createdAt": "2020-10-16T23:47:50Z", "commit": {"oid": "fe01e3cfa0105cabc2f977cf8d804b2c7965abde"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73040b0fedfa5fd35533e53f4dc3e50d9140fcf1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/73040b0fedfa5fd35533e53f4dc3e50d9140fcf1", "committedDate": "2020-10-16T23:48:45Z", "message": "Cleanup websocket proxy, add timeout to event loop shutdown future to prevent hanging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe01e3cfa0105cabc2f977cf8d804b2c7965abde", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fe01e3cfa0105cabc2f977cf8d804b2c7965abde", "committedDate": "2020-10-16T23:45:21Z", "message": "Cleanup websocket proxy, add timeout to event loop shutdown future to prevent hanging"}, "afterCommit": {"oid": "73040b0fedfa5fd35533e53f4dc3e50d9140fcf1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/73040b0fedfa5fd35533e53f4dc3e50d9140fcf1", "committedDate": "2020-10-16T23:48:45Z", "message": "Cleanup websocket proxy, add timeout to event loop shutdown future to prevent hanging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODUwMzUy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#pullrequestreview-510850352", "createdAt": "2020-10-16T23:49:14Z", "commit": {"oid": "73040b0fedfa5fd35533e53f4dc3e50d9140fcf1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODUzOTQ5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/540#pullrequestreview-510853949", "createdAt": "2020-10-17T00:10:30Z", "commit": {"oid": "73040b0fedfa5fd35533e53f4dc3e50d9140fcf1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2781, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}