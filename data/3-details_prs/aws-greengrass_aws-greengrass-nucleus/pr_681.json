{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNzQyMzY2", "number": 681, "title": "Fail deployment if nucleus version changes but nucleus is not top lev\u2026", "bodyText": "\u2026el component\nImplement option 2 from this discussion - https://quip-amazon.com/NOzOArSLbMw5/Nucleus-and-other-1P-Component-Versioning#dfN9CATKJeU This is so that if customers want to update the nucleus, they should explicitly add it to the deployment as a top level component. If customers have not made it a top level component, it's possible that they don't know the nucleus version is going to change in the deployment and may be surprised\nIssue #, if available:\nDescription of changes:\nWhy is this change necessary:\nHow was this change tested:\nNew unit tests, new UATs passing - https://code.amazon.com/reviews/CR-39106055\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-13T17:59:12Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681", "merged": true, "mergeCommit": {"oid": "f611f0fba1d50aa9244487f47e8a37fb085fb59f"}, "closed": true, "closedAt": "2020-11-20T18:36:40Z", "author": {"login": "shaguptashaikh"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcPL-LAFqTUzMDQ2NDUwMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdebgbMgH2gAyNTIwNzQyMzY2OjI1ZDkwZDRlODg3YzIyMGM0ZmIzYTNjMDE4OTMwZThiYWNmZTE5YWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDY0NTAy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#pullrequestreview-530464502", "createdAt": "2020-11-13T22:47:03Z", "commit": {"oid": "a39a14fb3f3fc20ea50af723ba7cf77f255895c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMjo0NzowM1rOHzB_Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMjo0NzowM1rOHzB_Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI3MTk2Ng==", "bodyText": "I think we will fix this case before reinvent, right?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#discussion_r523271966", "createdAt": "2020-11-13T22:47:03Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/DependencyResolver.java", "diffHunk": "@@ -91,12 +105,47 @@\n                             document.getDeploymentId())));\n         }\n \n+        if (nonExplicitNucleusUpdate(targetComponentsToResolve,\n+                resolvedComponents.entrySet().stream().map(Map.Entry::getValue).collect(Collectors.toList()))) {\n+            throw new PackagingException(\"The deployment attempts to update the nucleus version but no target \"\n+                    + \"component of type nucleus included as target component, please add the desired nucleus version\"\n+                    + \" as top level component if you wish to update the nucleus\");\n+        }\n+\n         logger.atInfo().setEventType(\"resolve-group-dependencies-finish\").kv(\"resolvedComponents\", resolvedComponents)\n                 .kv(COMPONENT_VERSION_REQUIREMENT_KEY, componentNameToVersionConstraints)\n                 .log(\"Finish resolving group dependencies\");\n         return new ArrayList<>(resolvedComponents.values());\n     }\n \n+    boolean nonExplicitNucleusUpdate(List<String> targetComponents,\n+                                     List<ComponentIdentifier> resolvedComponents) throws PackagingException {\n+        List<ComponentIdentifier> resolvedNucleusComponents = new ArrayList<>();\n+        for (ComponentIdentifier componentIdentifier : resolvedComponents) {\n+            if (ComponentType.NUCLEUS.equals(componentStore.getPackageRecipe(componentIdentifier).getComponentType())) {\n+                resolvedNucleusComponents.add(componentIdentifier);\n+            }\n+        }\n+        if (resolvedNucleusComponents.size() > 1) {\n+            throw new PackagingException(String.format(\"Deployment cannot have more than 1 component of type Nucleus \"\n+                    + \"%s\", Arrays.toString(resolvedNucleusComponents.toArray())));\n+        }\n+        if (resolvedNucleusComponents.isEmpty()) {\n+            return false;\n+        }\n+        Optional<GreengrassService> activeNucleusOption = kernel.orderedDependencies().stream()\n+                .filter(s -> ComponentType.NUCLEUS.name().equals(s.getServiceType())).findFirst();\n+        if (!activeNucleusOption.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a39a14fb3f3fc20ea50af723ba7cf77f255895c8"}, "originalPosition": 82}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "949526ebe13591110de6b72f989eca1980903d54", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/949526ebe13591110de6b72f989eca1980903d54", "committedDate": "2020-11-17T17:16:29Z", "message": "Merge branch 'master' into nucleus-dr"}, "afterCommit": {"oid": "f7dc67508dbf90c4f81920e6803f92c486f874be", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f7dc67508dbf90c4f81920e6803f92c486f874be", "committedDate": "2020-11-17T17:21:34Z", "message": "Use newly decided nucleus version 2.0.0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjUyNzM0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#pullrequestreview-532652734", "createdAt": "2020-11-17T18:08:26Z", "commit": {"oid": "f7dc67508dbf90c4f81920e6803f92c486f874be"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODg3MjMx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#pullrequestreview-532887231", "createdAt": "2020-11-17T23:06:49Z", "commit": {"oid": "f7dc67508dbf90c4f81920e6803f92c486f874be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzowNjo0OVrOH1PKog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzowNjo0OVrOH1PKog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4NTA1OA==", "bodyText": "Can this actually happen here? Would the dependency resolution already detect it and fail the deployment?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#discussion_r525585058", "createdAt": "2020-11-17T23:06:49Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/componentmanager/DependencyResolver.java", "diffHunk": "@@ -91,12 +105,47 @@\n                             document.getDeploymentId())));\n         }\n \n+        if (nonExplicitNucleusUpdate(targetComponentsToResolve,\n+                resolvedComponents.entrySet().stream().map(Map.Entry::getValue).collect(Collectors.toList()))) {\n+            throw new PackagingException(\"The deployment attempts to update the nucleus version but no target \"\n+                    + \"component of type nucleus included as target component, please add the desired nucleus version\"\n+                    + \" as top level component if you wish to update the nucleus\");\n+        }\n+\n         logger.atInfo().setEventType(\"resolve-group-dependencies-finish\").kv(\"resolvedComponents\", resolvedComponents)\n                 .kv(COMPONENT_VERSION_REQUIREMENT_KEY, componentNameToVersionConstraints)\n                 .log(\"Finish resolving group dependencies\");\n         return new ArrayList<>(resolvedComponents.values());\n     }\n \n+    boolean nonExplicitNucleusUpdate(List<String> targetComponents,\n+                                     List<ComponentIdentifier> resolvedComponents) throws PackagingException {\n+        List<ComponentIdentifier> resolvedNucleusComponents = new ArrayList<>();\n+        for (ComponentIdentifier componentIdentifier : resolvedComponents) {\n+            if (ComponentType.NUCLEUS.equals(componentStore.getPackageRecipe(componentIdentifier).getComponentType())) {\n+                resolvedNucleusComponents.add(componentIdentifier);\n+            }\n+        }\n+        if (resolvedNucleusComponents.size() > 1) {\n+            throw new PackagingException(String.format(\"Deployment cannot have more than 1 component of type Nucleus \"\n+                    + \"%s\", Arrays.toString(resolvedNucleusComponents.toArray())));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7dc67508dbf90c4f81920e6803f92c486f874be"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODk2NjQ3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#pullrequestreview-532896647", "createdAt": "2020-11-17T23:26:37Z", "commit": {"oid": "f7dc67508dbf90c4f81920e6803f92c486f874be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzoyNjozN1rOH1Ppsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzoyNjozN1rOH1Ppsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5MzAxMQ==", "bodyText": "hmmm...I found this a bit difficult to read. Would it be more clear if combining these two conditions?\nreturn !resolvedNucleus.equals(new ComponentIdentifier(activeNucleus.getServiceName(), activeNucleusVersion)) && !targetComponents.contains(resolvedNucleus.getName())", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#discussion_r525593011", "createdAt": "2020-11-17T23:26:37Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/componentmanager/DependencyResolver.java", "diffHunk": "@@ -91,12 +105,47 @@\n                             document.getDeploymentId())));\n         }\n \n+        if (nonExplicitNucleusUpdate(targetComponentsToResolve,\n+                resolvedComponents.entrySet().stream().map(Map.Entry::getValue).collect(Collectors.toList()))) {\n+            throw new PackagingException(\"The deployment attempts to update the nucleus version but no target \"\n+                    + \"component of type nucleus included as target component, please add the desired nucleus version\"\n+                    + \" as top level component if you wish to update the nucleus\");\n+        }\n+\n         logger.atInfo().setEventType(\"resolve-group-dependencies-finish\").kv(\"resolvedComponents\", resolvedComponents)\n                 .kv(COMPONENT_VERSION_REQUIREMENT_KEY, componentNameToVersionConstraints)\n                 .log(\"Finish resolving group dependencies\");\n         return new ArrayList<>(resolvedComponents.values());\n     }\n \n+    boolean nonExplicitNucleusUpdate(List<String> targetComponents,\n+                                     List<ComponentIdentifier> resolvedComponents) throws PackagingException {\n+        List<ComponentIdentifier> resolvedNucleusComponents = new ArrayList<>();\n+        for (ComponentIdentifier componentIdentifier : resolvedComponents) {\n+            if (ComponentType.NUCLEUS.equals(componentStore.getPackageRecipe(componentIdentifier).getComponentType())) {\n+                resolvedNucleusComponents.add(componentIdentifier);\n+            }\n+        }\n+        if (resolvedNucleusComponents.size() > 1) {\n+            throw new PackagingException(String.format(\"Deployment cannot have more than 1 component of type Nucleus \"\n+                    + \"%s\", Arrays.toString(resolvedNucleusComponents.toArray())));\n+        }\n+        if (resolvedNucleusComponents.isEmpty()) {\n+            return false;\n+        }\n+        Optional<GreengrassService> activeNucleusOption = kernel.orderedDependencies().stream()\n+                .filter(s -> ComponentType.NUCLEUS.name().equals(s.getServiceType())).findFirst();\n+        if (!activeNucleusOption.isPresent()) {\n+            return false;\n+        }\n+        GreengrassService activeNucleus = activeNucleusOption.get();\n+        Semver activeNucleusVersion = new Semver(Coerce.toString(activeNucleus.getServiceConfig().find(VERSION_KEY)));\n+        ComponentIdentifier resolvedNucleus = resolvedNucleusComponents.get(0);\n+        if (resolvedNucleus.equals(new ComponentIdentifier(activeNucleus.getServiceName(), activeNucleusVersion))) {\n+            return false;\n+        }\n+        return !targetComponents.contains(resolvedNucleus.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7dc67508dbf90c4f81920e6803f92c486f874be"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODk3Mjgw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#pullrequestreview-532897280", "createdAt": "2020-11-17T23:27:57Z", "commit": {"oid": "f7dc67508dbf90c4f81920e6803f92c486f874be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzoyNzo1N1rOH1Prkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzoyNzo1N1rOH1Prkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5MzQ5MA==", "bodyText": "It would be nice to include the existing nucleus version and resolved nucleus version in the exception.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#discussion_r525593490", "createdAt": "2020-11-17T23:27:57Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/componentmanager/DependencyResolver.java", "diffHunk": "@@ -91,12 +105,47 @@\n                             document.getDeploymentId())));\n         }\n \n+        if (nonExplicitNucleusUpdate(targetComponentsToResolve,\n+                resolvedComponents.entrySet().stream().map(Map.Entry::getValue).collect(Collectors.toList()))) {\n+            throw new PackagingException(\"The deployment attempts to update the nucleus version but no target \"\n+                    + \"component of type nucleus included as target component, please add the desired nucleus version\"\n+                    + \" as top level component if you wish to update the nucleus\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7dc67508dbf90c4f81920e6803f92c486f874be"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "296ff372dfb5aa27035031096fa6a446ad39f99f", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/296ff372dfb5aa27035031096fa6a446ad39f99f", "committedDate": "2020-11-18T01:55:48Z", "message": "Fail deployment if nucleus version changes but nucleus is not top level component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a3cabcea5db98ea9bae56322a64313606063e90", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7a3cabcea5db98ea9bae56322a64313606063e90", "committedDate": "2020-11-18T01:55:48Z", "message": "Use newly decided nucleus version 2.0.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b52d7567c217b5c0e65dcb122ba5256603c1da98", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b52d7567c217b5c0e65dcb122ba5256603c1da98", "committedDate": "2020-11-18T01:55:48Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7dc67508dbf90c4f81920e6803f92c486f874be", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f7dc67508dbf90c4f81920e6803f92c486f874be", "committedDate": "2020-11-17T17:21:34Z", "message": "Use newly decided nucleus version 2.0.0"}, "afterCommit": {"oid": "b52d7567c217b5c0e65dcb122ba5256603c1da98", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b52d7567c217b5c0e65dcb122ba5256603c1da98", "committedDate": "2020-11-18T01:55:48Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNjE0ODg1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#pullrequestreview-533614885", "createdAt": "2020-11-18T16:15:18Z", "commit": {"oid": "b52d7567c217b5c0e65dcb122ba5256603c1da98"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNjE1MjI1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#pullrequestreview-533615225", "createdAt": "2020-11-18T16:15:40Z", "commit": {"oid": "b52d7567c217b5c0e65dcb122ba5256603c1da98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNzM1NzY5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/681#pullrequestreview-533735769", "createdAt": "2020-11-18T18:03:23Z", "commit": {"oid": "b52d7567c217b5c0e65dcb122ba5256603c1da98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c291555e306a2c735d0f68a06a1aa922246b8c38", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c291555e306a2c735d0f68a06a1aa922246b8c38", "committedDate": "2020-11-20T03:37:05Z", "message": "Merge branch 'master' into nucleus-dr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25d90d4e887c220c4fb3a3c018930e8bacfe19ab", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/25d90d4e887c220c4fb3a3c018930e8bacfe19ab", "committedDate": "2020-11-20T18:17:49Z", "message": "Merge branch 'master' into nucleus-dr"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2687, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}