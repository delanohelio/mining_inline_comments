{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNTU4OTQy", "number": 388, "title": "Improve initial directory setup, s3 publish, etc", "bodyText": "Issue #, if available:\nDescription of changes:\n\nMove initial launch dir setup outside of system service setup.\nUpdate component name in recipe file\nPublish zip file to a new S3 path for UAT\n\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-08-25T23:32:58Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/388", "merged": true, "mergeCommit": {"oid": "2fdeec411303adfd3b236489309183755df884fc"}, "closed": true, "closedAt": "2020-08-26T19:39:31Z", "author": {"login": "hui-yang"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCf6cxgFqTQ3NTA1NDg4Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCxA6rAFqTQ3NTc5NjcxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MDU0ODgz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/388#pullrequestreview-475054883", "createdAt": "2020-08-25T23:35:59Z", "commit": {"oid": "38d21719bd81e359f48c51554e79c67e8a4ad18c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQyMzozNTo1OVrOHGxeJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQyMzozNTo1OVrOHGxeJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg2NDAzNw==", "bodyText": "Recommendation generated by Amazon CodeGuru Reviewer. Leave feedback on this recommendation by replying to the comment or by reacting to the comment using emoji.\nProblem: InterruptedException is ignored. This can delay thread shutdown and clear the thread\u2019s interrupt status. Only code that implements a thread\u2019s interruption policy can swallow an interruption request.\nFix: Rethrow the InterruptedException or reinterrupt the current thread using Thread.currentThread().interrupt() so that higher-level interrupt handlers can function correctly.\nIf you are wrapping the InterruptedException inside a RuntimeException, call Thread.currentThread().interrupt() before throwing the RuntimeException.\nLearn more about interrupts and dealing with InterruptedException", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/388#discussion_r476864037", "createdAt": "2020-08-25T23:35:59Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/util/orchestration/SystemdUtils.java", "diffHunk": "@@ -35,7 +34,7 @@ public boolean setupSystemService(KernelAlternatives kernelAlternatives) {\n             runCommand(\"systemctl enable greengrass.service\");\n             logger.atInfo().log(\"Successfully set up systemd service\");\n             return true;\n-        } catch (IOException | InterruptedException | URISyntaxException e) {\n+        } catch (IOException | InterruptedException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d21719bd81e359f48c51554e79c67e8a4ad18c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30e1120a5e316832ec05c781bd1311abd716d0b0", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/30e1120a5e316832ec05c781bd1311abd716d0b0", "committedDate": "2020-08-25T23:40:38Z", "message": "Improve initial directory setup, s3 publish, etc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38d21719bd81e359f48c51554e79c67e8a4ad18c", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/38d21719bd81e359f48c51554e79c67e8a4ad18c", "committedDate": "2020-08-25T23:29:57Z", "message": "Improve initial directory setup, s3 publish, etc"}, "afterCommit": {"oid": "30e1120a5e316832ec05c781bd1311abd716d0b0", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/30e1120a5e316832ec05c781bd1311abd716d0b0", "committedDate": "2020-08-25T23:40:38Z", "message": "Improve initial directory setup, s3 publish, etc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d3525292c0cd615a2b1e06bc1d85b4af3972e22", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9d3525292c0cd615a2b1e06bc1d85b4af3972e22", "committedDate": "2020-08-26T17:51:14Z", "message": "Merge branch 'master' into ku-init-dir"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NzQ0NDE0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/388#pullrequestreview-475744414", "createdAt": "2020-08-26T18:21:07Z", "commit": {"oid": "9d3525292c0cd615a2b1e06bc1d85b4af3972e22"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODoyMTowOFrOHHYMFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODoyMTozOFrOHHYNHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5ODM5MQ==", "bodyText": "shouldn't this cause a bigger failure?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/388#discussion_r477498391", "createdAt": "2020-08-26T18:21:08Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelAlternatives.java", "diffHunk": "@@ -65,6 +67,12 @@ public KernelAlternatives(Path kernelAltsPath) {\n         this.currentDir = kernelAltsPath.resolve(CURRENT_DIR).toAbsolutePath();\n         this.oldDir = kernelAltsPath.resolve(OLD_DIR).toAbsolutePath();\n         this.brokenDir = kernelAltsPath.resolve(BROKEN_DIR).toAbsolutePath();\n+\n+        try {\n+            setupInitLaunchDirIfAbsent();\n+        } catch (IOException e) {\n+            logger.atError().log(\"Unable to setup Kernel launch directory\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d3525292c0cd615a2b1e06bc1d85b4af3972e22"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5ODY1Mw==", "bodyText": "remove `", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/388#discussion_r477498653", "createdAt": "2020-08-26T18:21:38Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelAlternatives.java", "diffHunk": "@@ -100,27 +108,43 @@ public boolean isLaunchDirSetup() {\n      * @throws IOException on I/O error\n      * @throws URISyntaxException if unable to determine source path of the Jar file\n      */\n-    public void setupInitLaunchDirIfAbsent() throws IOException, URISyntaxException {\n+    public void setupInitLaunchDirIfAbsent() throws IOException {\n         if (isLaunchDirSetup()) {\n             return;\n         }\n+        Path unpackDir;\n+        try {\n+            unpackDir = locateCurrentKernelUnpackDir();\n+        } catch (IOException | URISyntaxException e) {\n+            logger.atError().log(\"Unable to setup Kernel launch directory\", e);\n+            return;\n+        }\n         Path initialLaunchDir = altsDir.resolve(INITIAL_SETUP_DIR);\n         Utils.createPaths(initialLaunchDir);\n \n-        setupLinkToDirectory(initialLaunchDir.resolve(KERNEL_DISTRIBUTION_DIR), locateCurrentKernelUnpackDir());\n+        setupLinkToDirectory(initialLaunchDir.resolve(KERNEL_DISTRIBUTION_DIR), unpackDir);\n         setupLinkToDirectory(currentDir, initialLaunchDir);\n     }\n \n+    /**\n+     * Locate launch directory of Kernel, assuming unpack directory tree as below.\n+     * \u251c\u2500\u2500 bin\n+     * \u2502   \u251c\u2500\u2500 greengrass.service\n+     * \u2502   \u2514\u2500\u2500 loader\n+     * \u2514\u2500\u2500 lib\n+     *     \u2514\u2500\u2500 Evergreen.jar\n+     */\n+    @SuppressFBWarnings(value = \"NP_NULL_ON_SOME_PATH_FROM_RETURN_VALUE\", justification = \"Spotbugs false positive\")\n     private Path locateCurrentKernelUnpackDir() throws IOException, URISyntaxException {\n-        // TODO: validate file directory tree. Assuming unpackDir/lib/kernel.jar for now\n         Path parentDir = new File(KernelAlternatives.class.getProtectionDomain().getCodeSource().getLocation()\n                 .toURI()).toPath().getParent();\n-        if (parentDir == null || ! Files.exists(parentDir)) {\n+        if (parentDir == null || ! Files.exists(parentDir)\n+                || parentDir.getFileName() != null && !KERNEL_LIB_DIR.equals(parentDir.getFileName().toString())) {\n             throw new IOException(\"Unable to locate the parent directory of Kernel Jar file\");\n         }\n         Path unpackDir = parentDir.getParent();\n-        if (unpackDir == null || ! Files.exists(unpackDir)) {\n-            throw new IOException(\"Unable to locate the unpack directory of Kernel artifacts\");\n+        if (unpackDir == null || ! Files.exists(unpackDir) || !Files.isDirectory(unpackDir.resolve(KERNEL_BIN_DIR))) {\n+            throw new IOException(\"Unable to locate the unpack directory of Kernel artifacts`\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d3525292c0cd615a2b1e06bc1d85b4af3972e22"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NzUyNTY3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/388#pullrequestreview-475752567", "createdAt": "2020-08-26T18:32:50Z", "commit": {"oid": "9d3525292c0cd615a2b1e06bc1d85b4af3972e22"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "979f31746c146e0bd9426fa31d04b6262bb51d88", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/979f31746c146e0bd9426fa31d04b6262bb51d88", "committedDate": "2020-08-26T18:41:28Z", "message": "Fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NzkyMDQy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/388#pullrequestreview-475792042", "createdAt": "2020-08-26T19:24:26Z", "commit": {"oid": "979f31746c146e0bd9426fa31d04b6262bb51d88"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1Nzk2NzE5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/388#pullrequestreview-475796719", "createdAt": "2020-08-26T19:31:26Z", "commit": {"oid": "979f31746c146e0bd9426fa31d04b6262bb51d88"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3203, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}