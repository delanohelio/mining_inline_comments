{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MzQyNjk2", "number": 709, "title": "Fix multiple kernel update bugs", "bodyText": "Issue #, if available:\nP41828435\nDescription of changes:\n\nIn loader, avoid unintentionally deleting launch directory during flip_link, which might be actively used by other symlinks\nClose tlog before merging configuration in kernel update. Without the fix, if unexpected crashes happen before launch directory link is flipped, kernel will restart into tlog with new config but won't know about the deployment execution.\nMake GreengrassService.close non-final so that Lambda can override the behavior\nWhen cleanup launch directory (alts/init in the example below), Utils.deleteFileRecursively will follow the link alts/init/distro and clean up all files under /private/var/folders/lm/gb8hmh3j6gvf5yf04fhmq0w0fjxd22/T/kernel-unzip3642652400857784954, but we only want to clean the symlink and files directly under alts/init. This is the root cause of P41828435.\n\n\u251c\u2500\u2500 alts\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 current -> /Volumes/workplace/UAT/src/EvergreenFeatures/test_result/1b4f43b7c940a12716847468cb154af147739083/alts/init\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 init\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 distro -> /private/var/folders/lm/gb8hmh3j6gvf5yf04fhmq0w0fjxd22/T/kernel-unzip3642652400857784954\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 launch.params\n\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-20T01:09:31Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/709", "merged": true, "mergeCommit": {"oid": "e45bab8f76d7f3c98a811a418ffaa2af9815ea77"}, "closed": true, "closedAt": "2020-11-20T18:14:31Z", "author": {"login": "hui-yang"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeM2JZAH2gAyNTI0MzQyNjk2OjhiNTAzN2IxNmFjOWI0NGNjYmM2MTFlYzZjMGJmNDdiNThlMTc4ZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeao1lAFqTUzNTYyMjc5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1", "committedDate": "2020-11-20T01:12:58Z", "message": "Fix multiple kernel update bugs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e5a7d26da3104603e2cb109122851e1a1b01d4e", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4e5a7d26da3104603e2cb109122851e1a1b01d4e", "committedDate": "2020-11-20T01:00:39Z", "message": "Fix multiple kernel update bugs"}, "afterCommit": {"oid": "8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1", "committedDate": "2020-11-20T01:12:58Z", "message": "Fix multiple kernel update bugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MDEzNTM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/709#pullrequestreview-535013536", "createdAt": "2020-11-20T01:43:13Z", "commit": {"oid": "8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMTo0MzoxM1rOH26TSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMTo0MzoxM1rOH26TSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM0MDM2MA==", "bodyText": "why close the tlog? The merge on L71 won't get persisted. Is that intentional?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/709#discussion_r527340360", "createdAt": "2020-11-20T01:43:13Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/deployment/activator/KernelUpdateActivator.java", "diffHunk": "@@ -62,15 +62,18 @@ public void activate(Map<String, Object> newConfig, Deployment deployment,\n         }\n \n         DeploymentDocument deploymentDocument = deployment.getDeploymentDocumentObj();\n-        // Wait for all services to close\n-        kernel.getContext().get(KernelLifecycle.class).stopAllServices(30);\n+        KernelLifecycle lifecycle = kernel.getContext().get(KernelLifecycle.class);\n+        // Preserve tlog state before launch directory is updated to reflect ongoing deployment.\n+        lifecycle.getTlog().close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MDE5MDI4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/709#pullrequestreview-535019028", "createdAt": "2020-11-20T01:59:38Z", "commit": {"oid": "8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjIyNzk2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/709#pullrequestreview-535622796", "createdAt": "2020-11-20T17:17:06Z", "commit": {"oid": "8b5037b16ac9b44ccbc611ec6c0bf47b58e178f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2726, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}