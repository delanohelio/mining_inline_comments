{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0OTc4MzYy", "number": 713, "title": "Only log in pubsub when it actually subscribes or unsubscribes", "bodyText": "Issue #, if available:\nDescription of changes:\nPrevent logging pubsub requests which are no-ops (subscribing when already subscribed, unsubscribing when not subscribed).\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-20T22:08:58Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/713", "merged": true, "mergeCommit": {"oid": "0e00f09993da75007d23becaa19b840551224dff"}, "closed": true, "closedAt": "2020-11-21T00:27:41Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdee19NgFqTUzNTgxMDk3Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdegx9vAFqTUzNTg1NjI4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODEwOTc2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/713#pullrequestreview-535810976", "createdAt": "2020-11-20T22:11:03Z", "commit": {"oid": "70294da835bc68992e91cf48bd5314369c7e64b2"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODEyNjg0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/713#pullrequestreview-535812684", "createdAt": "2020-11-20T22:14:49Z", "commit": {"oid": "70294da835bc68992e91cf48bd5314369c7e64b2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMjoxNDo0OVrOH3iiPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQyMjoxNDo0OVrOH3iiPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5OTU1MA==", "bodyText": "why is unsub at debug while subscribe is info? I'd prefer if both were info", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/713#discussion_r527999550", "createdAt": "2020-11-20T22:14:49Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/builtin/services/pubsub/PubSubIPCEventStreamAgent.java", "diffHunk": "@@ -84,8 +85,14 @@ public void subscribe(String topic, Consumer<PublishEvent> cb, String serviceNam\n      * @param serviceName name of the service unsubscribing.\n      */\n     public void unsubscribe(String topic, Consumer<PublishEvent> cb, String serviceName) {\n-        log.atDebug().kv(COMPONENT_NAME, serviceName).log(\"Unsubscribing from topic {}\", topic);\n-        listeners.computeIfPresent(topic, (s, objects) -> objects.remove(cb) && objects.isEmpty() ? null : objects);\n+        AtomicBoolean removed = new AtomicBoolean(false);\n+        listeners.computeIfPresent(topic, (s, objects) -> {\n+            removed.set(objects.remove(cb));\n+            return objects.isEmpty() ? null : objects;\n+        });\n+        if (removed.get()) {\n+            log.atDebug().kv(COMPONENT_NAME, serviceName).log(\"Unsubscribed from topic {}\", topic);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70294da835bc68992e91cf48bd5314369c7e64b2"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70294da835bc68992e91cf48bd5314369c7e64b2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/70294da835bc68992e91cf48bd5314369c7e64b2", "committedDate": "2020-11-20T22:08:22Z", "message": "Only log in pubsub when it actually subscribes or unsubscribes"}, "afterCommit": {"oid": "fbe4bf22d79d5a1b76372656700c946d21ba1bc6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fbe4bf22d79d5a1b76372656700c946d21ba1bc6", "committedDate": "2020-11-20T22:16:03Z", "message": "Only log in pubsub when it actually subscribes or unsubscribes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODE1NzI1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/713#pullrequestreview-535815725", "createdAt": "2020-11-20T22:21:27Z", "commit": {"oid": "fbe4bf22d79d5a1b76372656700c946d21ba1bc6"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa46c2cff5d26a64ae17d46114dab312daa0aac1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aa46c2cff5d26a64ae17d46114dab312daa0aac1", "committedDate": "2020-11-20T23:58:15Z", "message": "Only log in pubsub when it actually subscribes or unsubscribes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fbe4bf22d79d5a1b76372656700c946d21ba1bc6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fbe4bf22d79d5a1b76372656700c946d21ba1bc6", "committedDate": "2020-11-20T22:16:03Z", "message": "Only log in pubsub when it actually subscribes or unsubscribes"}, "afterCommit": {"oid": "aa46c2cff5d26a64ae17d46114dab312daa0aac1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aa46c2cff5d26a64ae17d46114dab312daa0aac1", "committedDate": "2020-11-20T23:58:15Z", "message": "Only log in pubsub when it actually subscribes or unsubscribes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODU2MDcx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/713#pullrequestreview-535856071", "createdAt": "2020-11-21T00:25:33Z", "commit": {"oid": "aa46c2cff5d26a64ae17d46114dab312daa0aac1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODU2Mjg2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/713#pullrequestreview-535856286", "createdAt": "2020-11-21T00:26:30Z", "commit": {"oid": "aa46c2cff5d26a64ae17d46114dab312daa0aac1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2729, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}