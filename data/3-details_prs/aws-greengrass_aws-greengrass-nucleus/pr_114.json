{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MTAxOTE3", "number": 114, "title": "Move lifecycle keywords for services from config root to under 'lifecycle' key", "bodyText": "Issue #, if available:\nhttps://issues.amazon.com/issues/P33898016\nDescription of changes:\nMove lifecycle keywords for services from config root to under 'lifecycle' key\nWhy is this change necessary:\nRequired as a part of this design change - https://quip-amazon.com/35xMAtuSgvha/Evergreen-Kernel-Configuration-Schema#aeM9CAMettB\nHow was this change tested:\nUnit/integration tests updated to match\nNOTE: This PR depends on #115\nFurther changes needed in future PRs:\n\nRemove support for 'skipif' (Separate PR since there are many test files which have skipif, want to keep PR size down)\nValidate keywords under lifecycle (Not a part of this sprint, separate task)\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-03-14T01:37:55Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114", "merged": true, "mergeCommit": {"oid": "1025a7764cd61f79f2d043f11dc760990650cff8"}, "closed": true, "closedAt": "2020-03-16T17:53:34Z", "author": {"login": "chaurah"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNa89mgFqTM3NDY4NzY5Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOR5F1AFqTM3NTQ1MTU3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Njg3Njky", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#pullrequestreview-374687692", "createdAt": "2020-03-14T01:44:07Z", "commit": {"oid": "88c498ac50e856c163262c6c4cac67c2207b9809"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMTo0NDowOFrOF2XFvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMTo0ODozM1rOF2XG_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTcyNw==", "bodyText": "Let's make anything new private and we need to go back and make all the other public stuff private as well.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392545727", "createdAt": "2020-03-14T01:44:08Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -82,6 +83,9 @@\n     // Service logger instance\n     protected final Logger logger;\n \n+    // Service lifecycle Topics\n+    public final Topics lifecycle;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88c498ac50e856c163262c6c4cac67c2207b9809"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTkzNw==", "bodyText": "Instead of wrapping this as a list, use the set and fix the cast. Changing the cast to Iterable should resolve our casting issues. I already checked and we're not using it as a list, we only iterate so it is a simple change to make.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392545937", "createdAt": "2020-03-14T01:46:48Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -85,8 +90,7 @@\n         // Generate dependencies\n         // TODO : Only platform specific dependencies should be added once deployment document and\n         // package recipe format supports platform wise dependency specification\n-        Set<String> dependencyServiceNames = pkg.getDependencies().keySet();\n-        resolvedServiceConfig.put(SERVICE_DEPENDENCIES_CONFIG_KEY, String.join(\", \", dependencyServiceNames));\n+        resolvedServiceConfig.put(SERVICE_DEPENDENCIES_CONFIG_KEY, new ArrayList<>(pkg.getDependencies().keySet()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88c498ac50e856c163262c6c4cac67c2207b9809"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTk1OQ==", "bodyText": "All these can stay as sets.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392545959", "createdAt": "2020-03-14T01:47:23Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -130,15 +134,15 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n      */\n     private Map<Object, Object> getUpdatedMainConfig(Set<PackageIdentifier> rootPackagesToRemove,\n                                                      DeploymentDocument document) {\n-        Set<String> kernelDependencies =\n+        List<String> kernelDependencies =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88c498ac50e856c163262c6c4cac67c2207b9809"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NjA0Ng==", "bodyText": "This is not necessarily a string. Our lifecycle keys will have subkeys themselves", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#discussion_r392546046", "createdAt": "2020-03-14T01:48:33Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -282,13 +283,13 @@ private String getServiceInstallCommand(String serviceName, Map<Object, Object>\n         return getValueForLifecycleKey(LIFECYCLE_INSTALL_KEY, serviceName, config);\n     }\n \n-    private Set<String> getServiceDependencies(String serviceName, Map<Object, Object> config) {\n-        return new HashSet<>(Arrays.asList(\n-                getValueForLifecycleKey(KERNEL_CONFIG_SERVICE_DEPENDENCIES_KEY, serviceName, config).split(\", \")));\n+    private List<String> getServiceDependencies(String serviceName, Map<Object, Object> config) {\n+        return (List<String>)getLifecycleConfig(serviceName, config).get(KERNEL_CONFIG_SERVICE_DEPENDENCIES_KEY);\n     }\n \n-    private String getValueForLifecycleKey(String key, String servicename, Map<Object, Object> config) {\n-        return (String) getLifecycleConfig(servicename, config).get(key);\n+    private String getValueForLifecycleKey(String key, String serviceName, Map<Object, Object> config) {\n+        Map<Object, Object> map = getLifecycleConfig(serviceName, config);\n+        return (String)((Map<Object, Object>)map.get(LIFECYCLE_CONFIG_ROOT_KEY)).get(key);\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88c498ac50e856c163262c6c4cac67c2207b9809"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88c498ac50e856c163262c6c4cac67c2207b9809", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/88c498ac50e856c163262c6c4cac67c2207b9809", "committedDate": "2020-03-14T01:33:13Z", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key"}, "afterCommit": {"oid": "7e8f995d1d4a66ab12dd14d4ef7d684a88253b40", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7e8f995d1d4a66ab12dd14d4ef7d684a88253b40", "committedDate": "2020-03-14T01:51:31Z", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e8f995d1d4a66ab12dd14d4ef7d684a88253b40", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7e8f995d1d4a66ab12dd14d4ef7d684a88253b40", "committedDate": "2020-03-14T01:51:31Z", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key"}, "afterCommit": {"oid": "cbb736f86770aefe794f9f235b8156d2dcb45163", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cbb736f86770aefe794f9f235b8156d2dcb45163", "committedDate": "2020-03-14T03:07:24Z", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3386b6fa6ed31e1167ddbb9a901b9a6d49f79ff", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b3386b6fa6ed31e1167ddbb9a901b9a6d49f79ff", "committedDate": "2020-03-14T03:25:20Z", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbb736f86770aefe794f9f235b8156d2dcb45163", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cbb736f86770aefe794f9f235b8156d2dcb45163", "committedDate": "2020-03-14T03:07:24Z", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key"}, "afterCommit": {"oid": "b3386b6fa6ed31e1167ddbb9a901b9a6d49f79ff", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b3386b6fa6ed31e1167ddbb9a901b9a6d49f79ff", "committedDate": "2020-03-14T03:25:20Z", "message": "Move lifecycle keywords for services from config root to under 'lifecycle' key"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Njk0MzA3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#pullrequestreview-374694307", "createdAt": "2020-03-14T03:30:46Z", "commit": {"oid": "b3386b6fa6ed31e1167ddbb9a901b9a6d49f79ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NDUxNTc5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/114#pullrequestreview-375451579", "createdAt": "2020-03-16T17:51:46Z", "commit": {"oid": "b3386b6fa6ed31e1167ddbb9a901b9a6d49f79ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2339, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}