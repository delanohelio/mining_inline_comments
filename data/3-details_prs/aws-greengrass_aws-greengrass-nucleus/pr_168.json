{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMTA0Mzcx", "number": 168, "title": "Refactor: Split EvergreenService and Lifecycle", "bodyText": "Issue #, if available:\nDescription of changes:\nRefactored EvergreenService by splitting out state machine (lifecycle) related functionality into a separate class: Lifecycle. That class was then further refactored by extracting methods from the large nested mess of switch statements. Each method is now named as handleCurrentState<STATE> and handleStateTransition<STATE>To<STATE> so it is very clear exactly what is happening just by the method names. Both classes are still pretty big (each over 500 lines), but this is certainly an improvement from 1 enormous class.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-08T22:06:05Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168", "merged": true, "mergeCommit": {"oid": "86fb5d164247478f1e48ab9eb8c0a9e3e7c499b1"}, "closed": true, "closedAt": "2020-04-09T23:23:52Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVvcz9ABqjMyMTYwNTM5Nzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWE911gFqTM5MTE5MDM3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37deb6138ef32686fbfba3aa570a9fed2ffe95d9", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/37deb6138ef32686fbfba3aa570a9fed2ffe95d9", "committedDate": "2020-04-08T22:05:36Z", "message": "Refactor: Split EvergreenService and Lifecycle"}, "afterCommit": {"oid": "2a2b3a185e02b48eeeeec837291ac0de9f64689f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2a2b3a185e02b48eeeeec837291ac0de9f64689f", "committedDate": "2020-04-08T22:15:23Z", "message": "Refactor: Split EvergreenService and Lifecycle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a2b3a185e02b48eeeeec837291ac0de9f64689f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2a2b3a185e02b48eeeeec837291ac0de9f64689f", "committedDate": "2020-04-08T22:15:23Z", "message": "Refactor: Split EvergreenService and Lifecycle"}, "afterCommit": {"oid": "1816d832067d7e49c44920b75ed0dcae11d14d1c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1816d832067d7e49c44920b75ed0dcae11d14d1c", "committedDate": "2020-04-08T22:49:07Z", "message": "Refactor: Split EvergreenService and Lifecycle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDAyOTk5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#pullrequestreview-390402999", "createdAt": "2020-04-08T23:42:51Z", "commit": {"oid": "2a2b3a185e02b48eeeeec837291ac0de9f64689f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMzo0MzoxM1rOGDEu7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMzo0MzoxM1rOGDEu7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3NjQ2MA==", "bodyText": "do we always continue in INSTALLED?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#discussion_r405876460", "createdAt": "2020-04-08T23:43:13Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -0,0 +1,572 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import lombok.Getter;\n+\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ArrayBlockingQueue;\n+import java.util.concurrent.BlockingQueue;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+import javax.annotation.Nonnull;\n+\n+@SuppressFBWarnings(value = \"JLM_JSR166_UTILCONCURRENT_MONITORENTER\",\n+        justification = \"We're synchronizing on the desired state list which is fine\")\n+public class Lifecycle {\n+    public static final String SERVICE_INVALID_STATE_ERROR = \"service-invalid-state-error\";\n+    private final EvergreenService evergreenService;\n+    private final Topic stateTopic;\n+    private final Logger logger;\n+    private Future backingTask = CompletableFuture.completedFuture(null);\n+    private String backingTaskName;\n+    private State prevState;\n+    @Getter\n+    private Future<?> lifecycleFuture;\n+    // A state event can be a state transition event, or a desired state updated notification.\n+    // TODO: make class of StateEvent instead of generic object.\n+    private final BlockingQueue<Object> stateEventQueue = new ArrayBlockingQueue<>(1);\n+    private final Object stateEventLock = new Object();\n+    // DesiredStateList is used to set desired path of state transition.\n+    // Eg. Start a service will need DesiredStateList to be <RUNNING>\n+    // ReInstall a service will set DesiredStateList to <FINISHED->NEW->RUNNING>\n+    private final List<State> desiredStateList = new CopyOnWriteArrayList<>();\n+    private static final Set<State> ALLOWED_STATES_FOR_REPORTING =\n+            new HashSet<>(Arrays.asList(State.RUNNING, State.ERRORED, State.FINISHED));\n+    private final AtomicBoolean isClosed = new AtomicBoolean(false);\n+\n+    /**\n+     * Constructor for lifecycle.\n+     *\n+     * @param evergreenService service that this is the lifecycle for\n+     * @param state            service's state topic\n+     */\n+    public Lifecycle(EvergreenService evergreenService, Topic state) {\n+        this.evergreenService = evergreenService;\n+        this.prevState = State.NEW;\n+        this.stateTopic = state;\n+        this.logger = evergreenService.getLogger();\n+    }\n+\n+    private void updateStateAndBroadcast(State newState) {\n+        final State currentState = evergreenService.getState();\n+\n+        if (newState.equals(currentState)) {\n+            return;\n+        }\n+\n+        // TODO: Add validation\n+        logger.atInfo().setEventType(\"service-set-state\").kv(EvergreenService.CURRENT_STATE_METRIC_NAME, currentState)\n+                .kv(\"newState\", newState).log();\n+\n+        // Sync on State.class to make sure the order of setValue and globalNotifyStateChanged are consistent\n+        // across different services.\n+        synchronized (State.class) {\n+            prevState = currentState;\n+            stateTopic.withValue(newState);\n+            evergreenService.getContext().globalNotifyStateChanged(evergreenService, prevState, newState);\n+        }\n+    }\n+\n+    /**\n+     * public API for service to report state. Allowed state are RUNNING, FINISHED, ERRORED.\n+     *\n+     * @param newState reported state from the service which should eventually be set as the service's\n+     *                 actual state\n+     */\n+    synchronized void reportState(State newState) {\n+        logger.atInfo().setEventType(\"service-report-state\").kv(\"newState\", newState).log();\n+        if (!ALLOWED_STATES_FOR_REPORTING.contains(newState)) {\n+            logger.atError().setEventType(SERVICE_INVALID_STATE_ERROR).kv(\"newState\", newState)\n+                    .log(\"Invalid report state\");\n+        }\n+        // TODO: Add more validations\n+\n+        if (evergreenService.getState().equals(State.INSTALLED) && newState.equals(State.FINISHED)) {\n+            // if a service doesn't have any run logic, request stop on service to clean up DesiredStateList\n+            requestStop();\n+        }\n+\n+        enqueueStateEvent(newState);\n+    }\n+\n+    private Optional<State> getReportState() {\n+        Object top = stateEventQueue.poll();\n+        if (top instanceof State) {\n+            return Optional.of((State) top);\n+        }\n+        return Optional.empty();\n+    }\n+\n+    /**\n+     * Returns true if the service has reached its desired state.\n+     *\n+     * @return\n+     */\n+    public boolean reachedDesiredState() {\n+        synchronized (desiredStateList) {\n+            return desiredStateList.isEmpty()\n+                    // when reachedDesiredState() is called in global state listener,\n+                    // service lifecycle thread hasn't drained the desiredStateList yet.\n+                    // Therefore adding this check.\n+                    || desiredStateList.stream().allMatch(s -> s == evergreenService.getState());\n+        }\n+    }\n+\n+    private Optional<State> peekOrRemoveFirstDesiredState(State activeState) {\n+        synchronized (desiredStateList) {\n+            if (desiredStateList.isEmpty()) {\n+                return Optional.empty();\n+            }\n+            State first = desiredStateList.get(0);\n+            if (first.equals(activeState)) {\n+                desiredStateList.remove(first);\n+                // ignore remove() return value as it's possible that desiredStateList update\n+            }\n+            return Optional.ofNullable(first);\n+        }\n+    }\n+\n+    void setDesiredState(State... state) {\n+        // Set desiredStateList and override existing desiredStateList.\n+        synchronized (desiredStateList) {\n+            List<State> newStateList = Arrays.asList(state);\n+            if (newStateList.equals(desiredStateList)) {\n+                return;\n+            }\n+            desiredStateList.clear();\n+            desiredStateList.addAll(newStateList);\n+            // try insert to the queue, if queue full doesn't block.\n+            enqueueStateEvent(\"DesiredStateUpdated\");\n+        }\n+    }\n+\n+    @SuppressFBWarnings(\"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\")\n+    private void enqueueStateEvent(Object event) {\n+        synchronized (stateEventLock) {\n+            if (event instanceof State) {\n+                // override existing reportState\n+                stateEventQueue.clear();\n+                stateEventQueue.offer(event);\n+            } else {\n+                stateEventQueue.offer(event);\n+\n+                // Ignore returned value of offer().\n+                // If enqueue isn't successful, the event queue has contents and there is no need to send another\n+                // trigger to process state transition.\n+            }\n+        }\n+    }\n+\n+    void startStateTransition() throws InterruptedException {\n+        while (!(isClosed.get() && evergreenService.getState().isClosable())) {\n+            Optional<State> desiredState;\n+            State current = evergreenService.getState();\n+            logger.atInfo().setEventType(\"service-state-transition-start\")\n+                    .kv(EvergreenService.CURRENT_STATE_METRIC_NAME, current).log();\n+\n+            // if already in desired state, remove the head of desired state list.\n+            desiredState = peekOrRemoveFirstDesiredState(current);\n+            while (desiredState.isPresent() && desiredState.get().equals(current)) {\n+                desiredState = peekOrRemoveFirstDesiredState(current);\n+            }\n+            AtomicReference<Future> triggerTimeOutReference = new AtomicReference<>();\n+            switch (current) {\n+                case BROKEN:\n+                    return;\n+                case NEW:\n+                    if (handleCurrentStateNew(desiredState)) {\n+                        break;\n+                    }\n+                    continue;\n+                case INSTALLED:\n+                    if (handleCurrentStateInstalled(desiredState, triggerTimeOutReference)) {\n+                        break;\n+                    }\n+                    continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1816d832067d7e49c44920b75ed0dcae11d14d1c"}, "originalPosition": 205}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDAzNzkw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#pullrequestreview-390403790", "createdAt": "2020-04-08T23:45:13Z", "commit": {"oid": "1816d832067d7e49c44920b75ed0dcae11d14d1c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMzo0NToxM1rOGDExWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMzo0NjozNVrOGDEyvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3NzA4MQ==", "bodyText": "NIT: i believe you reverted Feng's change", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#discussion_r405877081", "createdAt": "2020-04-08T23:45:13Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -793,11 +373,8 @@ private boolean dependersExited(List<EvergreenService> dependers) {\n \n     private boolean dependencyReady() {\n         List<EvergreenService> ret =\n-                dependencies.entrySet()\n-                        .stream()\n-                        .filter(e -> !dependencyReady(e.getKey(), e.getValue().startWhen))\n-                        .map(Map.Entry::getKey)\n-                        .collect(Collectors.toList());\n+                dependencies.entrySet().stream().filter(e -> !dependencyReady(e.getKey(), e.getValue().startWhen))\n+                        .map(Map.Entry::getKey).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1816d832067d7e49c44920b75ed0dcae11d14d1c"}, "originalPosition": 623}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3NzQzOA==", "bodyText": "I feel LifecycletTopic can be a field in lifecycle class", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#discussion_r405877438", "createdAt": "2020-04-08T23:46:35Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -970,21 +531,12 @@ public boolean satisfiedBy(Set<EvergreenService> ready) {\n         return ready.containsAll(dependencies.keySet());\n     }\n \n-    public enum RunStatus {\n-        OK, NothingDone, Errored\n-    }\n-\n-    public interface GlobalStateChangeListener {\n-        void globalServiceStateChanged(EvergreenService l, State oldState, State newState);\n+    protected Topics getLifecycleTopic() {\n+        return config.findInteriorChild(SERVICE_LIFECYCLE_NAMESPACE_TOPIC);\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1816d832067d7e49c44920b75ed0dcae11d14d1c"}, "originalPosition": 684}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1816d832067d7e49c44920b75ed0dcae11d14d1c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1816d832067d7e49c44920b75ed0dcae11d14d1c", "committedDate": "2020-04-08T22:49:07Z", "message": "Refactor: Split EvergreenService and Lifecycle"}, "afterCommit": {"oid": "6f4a6393042932e7c999e3bfb78bdd5eaa85a77e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f4a6393042932e7c999e3bfb78bdd5eaa85a77e", "committedDate": "2020-04-09T01:07:24Z", "message": "Refactor: Split EvergreenService and Lifecycle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDQ4MTQx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#pullrequestreview-390448141", "createdAt": "2020-04-09T02:14:00Z", "commit": {"oid": "6f4a6393042932e7c999e3bfb78bdd5eaa85a77e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjoxNDowMFrOGDHPHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMjoxOTo1NlrOGDHU9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkxNzQ3MA==", "bodyText": "This seems unused in this class now, could just move it to Lifecycle class and make it a private constant there", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#discussion_r405917470", "createdAt": "2020-04-09T02:14:00Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -57,43 +46,25 @@\n     public static final String TIMEOUT_NAMESPACE_TOPIC = \"timeout\";\n     public static final Integer DEFAULT_INSTALL_STAGE_TIMEOUT_IN_SEC = 120;\n     public static final Integer DEFAULT_STARTUP_STAGE_TIMEOUT_IN_SEC = 120;\n-    private static final String CURRENT_STATE_METRIC_NAME = \"currentState\";\n-    private static final String INVALID_STATE_ERROR_EVENT = \"service-invalid-state-error\";\n+    static final String CURRENT_STATE_METRIC_NAME = \"currentState\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f4a6393042932e7c999e3bfb78bdd5eaa85a77e"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkxODk2Ng==", "bodyText": "Nit- I would pass in the logger to the constructor of Lifecycle or make it default, that way it is accessible only where you intend it to be, a public getter method exposes it to everyone, and doing that for the logger instance is a bit odd", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#discussion_r405918966", "createdAt": "2020-04-09T02:19:56Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -57,43 +46,25 @@\n     public static final String TIMEOUT_NAMESPACE_TOPIC = \"timeout\";\n     public static final Integer DEFAULT_INSTALL_STAGE_TIMEOUT_IN_SEC = 120;\n     public static final Integer DEFAULT_STARTUP_STAGE_TIMEOUT_IN_SEC = 120;\n-    private static final String CURRENT_STATE_METRIC_NAME = \"currentState\";\n-    private static final String INVALID_STATE_ERROR_EVENT = \"service-invalid-state-error\";\n+    static final String CURRENT_STATE_METRIC_NAME = \"currentState\";\n \n     protected final Topics config;\n     public Context context;\n \n-    private final Object dependencyReadyLock = new Object();\n-    private final Object dependersExitedLock = new Object();\n     private final Topic state;\n+    private final Lifecycle lifecycle;\n+    private final Object dependersExitedLock = new Object();\n     private Throwable error;\n-    private Future backingTask = CompletableFuture.completedFuture(null);\n-    private String backingTaskName;\n     private Periodicity periodicityInformation;\n-    private State prevState = State.NEW;\n-    private Future<?> lifecycleFuture;\n-    private final AtomicBoolean isClosed = new AtomicBoolean(false);\n-\n-    // A state event can be a state transition event, or a desired state updated notification.\n-    // TODO: make class of StateEvent instead of generic object.\n-    private final BlockingQueue<Object> stateEventQueue = new ArrayBlockingQueue<>(1);\n-    private final Object stateEventLock = new Object();\n-\n-    // DesiredStateList is used to set desired path of state transition.\n-    // Eg. Start a service will need DesiredStateList to be <RUNNING>\n-    // ReInstall a service will set DesiredStateList to <FINISHED->NEW->RUNNING>\n-    private final List<State> desiredStateList = new CopyOnWriteArrayList<>();\n-\n-    private static final Set<State> ALLOWED_STATES_FOR_REPORTING =\n-            new HashSet<>(Arrays.asList(State.RUNNING, State.ERRORED, State.FINISHED));\n+    private final Object dependencyReadyLock = new Object();\n \n     // dependencies that are explicitly declared by customer in config store.\n     private final Topic externalDependenciesTopic;\n     // Services that this service depends on.\n     // Includes both explicit declared dependencies and implicit ones added through 'autoStart' and @Inject annotation.\n     protected final ConcurrentHashMap<EvergreenService, DependencyInfo> dependencies = new ConcurrentHashMap<>();\n-\n     // Service logger instance\n+    @Getter", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f4a6393042932e7c999e3bfb78bdd5eaa85a77e"}, "originalPosition": 81}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f4a6393042932e7c999e3bfb78bdd5eaa85a77e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f4a6393042932e7c999e3bfb78bdd5eaa85a77e", "committedDate": "2020-04-09T01:07:24Z", "message": "Refactor: Split EvergreenService and Lifecycle"}, "afterCommit": {"oid": "5dd1dc30befd4dd962643f27d9e9d85e80eb1ab9", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5dd1dc30befd4dd962643f27d9e9d85e80eb1ab9", "committedDate": "2020-04-09T18:33:32Z", "message": "Refactor: Split EvergreenService and Lifecycle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5dd1dc30befd4dd962643f27d9e9d85e80eb1ab9", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5dd1dc30befd4dd962643f27d9e9d85e80eb1ab9", "committedDate": "2020-04-09T18:33:32Z", "message": "Refactor: Split EvergreenService and Lifecycle"}, "afterCommit": {"oid": "b5f8fc2bc4bd29e573dfe8e40ade029e1bf3a0dc", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b5f8fc2bc4bd29e573dfe8e40ade029e1bf3a0dc", "committedDate": "2020-04-09T20:28:20Z", "message": "Refactor: Split EvergreenService and Lifecycle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTU1NTk4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#pullrequestreview-391155598", "createdAt": "2020-04-09T21:48:58Z", "commit": {"oid": "b5f8fc2bc4bd29e573dfe8e40ade029e1bf3a0dc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDgzNzYy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#pullrequestreview-391083762", "createdAt": "2020-04-09T19:47:35Z", "commit": {"oid": "1816d832067d7e49c44920b75ed0dcae11d14d1c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62ff57b548c3db99882bded24494c348260c19a7", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/62ff57b548c3db99882bded24494c348260c19a7", "committedDate": "2020-04-09T22:47:45Z", "message": "Refactor: Split EvergreenService and Lifecycle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5f8fc2bc4bd29e573dfe8e40ade029e1bf3a0dc", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b5f8fc2bc4bd29e573dfe8e40ade029e1bf3a0dc", "committedDate": "2020-04-09T20:28:20Z", "message": "Refactor: Split EvergreenService and Lifecycle"}, "afterCommit": {"oid": "62ff57b548c3db99882bded24494c348260c19a7", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/62ff57b548c3db99882bded24494c348260c19a7", "committedDate": "2020-04-09T22:47:45Z", "message": "Refactor: Split EvergreenService and Lifecycle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTg1NTAy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#pullrequestreview-391185502", "createdAt": "2020-04-09T23:04:04Z", "commit": {"oid": "62ff57b548c3db99882bded24494c348260c19a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzowNDowNVrOGDsOjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzowNDowNVrOGDsOjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyMzUzMg==", "bodyText": "Seems this reverted Feng's change?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#discussion_r406523532", "createdAt": "2020-04-09T23:04:05Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/config/Topic.java", "diffHunk": "@@ -115,16 +115,8 @@ public void fire(WhatHappened what) {\n                 .addKeyValue(\"reason\", what.name()).log();\n         if (watchers != null) {\n             for (Watcher s : watchers) {\n-                try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62ff57b548c3db99882bded24494c348260c19a7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTg4NTc2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#pullrequestreview-391188576", "createdAt": "2020-04-09T23:13:33Z", "commit": {"oid": "62ff57b548c3db99882bded24494c348260c19a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTg3MjEw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#pullrequestreview-391187210", "createdAt": "2020-04-09T23:09:28Z", "commit": {"oid": "62ff57b548c3db99882bded24494c348260c19a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzowOToyOVrOGDsULg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzowOToyOVrOGDsULg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyNDk3NA==", "bodyText": "Curious, does this have to be on method level?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#discussion_r406524974", "createdAt": "2020-04-09T23:09:29Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -0,0 +1,633 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import lombok.Getter;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.concurrent.ArrayBlockingQueue;\n+import java.util.concurrent.BlockingQueue;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+import javax.annotation.Nonnull;\n+\n+@SuppressFBWarnings(value = \"JLM_JSR166_UTILCONCURRENT_MONITORENTER\",\n+        justification = \"We're synchronizing on the desired state list which is fine\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62ff57b548c3db99882bded24494c348260c19a7"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTkwMzcw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/168#pullrequestreview-391190370", "createdAt": "2020-04-09T23:19:35Z", "commit": {"oid": "62ff57b548c3db99882bded24494c348260c19a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2432, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}