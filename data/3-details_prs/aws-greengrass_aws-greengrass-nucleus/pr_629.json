{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NDY3Nzky", "number": 629, "title": "Waiting for Ipc shutdown and elg close which should be fixed with lat\u2026", "bodyText": "\u2026est CRT. Updated SDK lib\nIssue #, if available:\nDescription of changes:\nNew Crt lib (updated in GG s3 repo) solves the ipc shutdown wait issue. Enabling IPC shutdown wait in this PR. Updating the SDK code to latest as well\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-06T03:21:02Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629", "merged": true, "mergeCommit": {"oid": "c79f353efd22324a166d3809099999cc59092cef"}, "closed": true, "closedAt": "2020-11-06T05:55:12Z", "author": {"login": "abanthiy"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZufLnAFqTUyNDgzNDk1Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZwbbwgFqTUyNDg3MjM5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODM0OTU3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#pullrequestreview-524834957", "createdAt": "2020-11-06T03:34:20Z", "commit": {"oid": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMzozNDoyMFrOHue_xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMzozNDo1N1rOHufAVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDM5MQ==", "bodyText": "use SLF4J?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518504391", "createdAt": "2020-11-06T03:34:20Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/DebugLoggingOperationHandler.java", "diffHunk": "@@ -6,18 +6,17 @@\n package software.amazon.awssdk.eventstreamrpc;\n \n import com.google.gson.Gson;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n import software.amazon.awssdk.eventstreamrpc.model.EventStreamJsonMessage;\n \n import java.nio.charset.StandardCharsets;\n+import java.util.logging.Logger;\n \n /**\n  * Useful to set as a handler for an operation with no implementation yet.\n  */\n public class DebugLoggingOperationHandler extends OperationContinuationHandler\n         <EventStreamJsonMessage, EventStreamJsonMessage, EventStreamJsonMessage, EventStreamJsonMessage> {\n-    private static final Logger LOGGER = LoggerFactory.getLogger(DebugLoggingOperationHandler.class);\n+    private static final Logger LOGGER = Logger.getLogger(DebugLoggingOperationHandler.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDQzNA==", "bodyText": "use SLF4J?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518504434", "createdAt": "2020-11-06T03:34:30Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/IpcServer.java", "diffHunk": "@@ -18,13 +23,8 @@\n import software.amazon.awssdk.crt.io.SocketOptions;\n import software.amazon.awssdk.crt.io.TlsContextOptions;\n \n-import java.util.Set;\n-import java.util.concurrent.CompletableFuture;\n-import java.util.concurrent.atomic.AtomicBoolean;\n-import java.util.stream.Collectors;\n-\n public class IpcServer implements AutoCloseable {\n-    private static final Logger LOGGER = LoggerFactory.getLogger(IpcServer.class);\n+    private static final Logger LOGGER = Logger.getLogger(IpcServer.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNDUzNQ==", "bodyText": "remove system out", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518504535", "createdAt": "2020-11-06T03:34:57Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/IpcServer.java", "diffHunk": "@@ -58,6 +58,7 @@ public void runServer() {\n         }\n         serverBootstrap = new ServerBootstrap(eventLoopGroup);\n         tlsContext = tlsContextOptions != null ? new ServerTlsContext(tlsContextOptions) : null;\n+        System.out.println(\"Hostname: \" + hostname);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODM2Njk4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#pullrequestreview-524836698", "createdAt": "2020-11-06T03:41:04Z", "commit": {"oid": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMzo0MTowNFrOHufFwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMzo0MTowNFrOHufFwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNTkyMg==", "bodyText": "A better log might be: \"Error while waiting for IPC shutdown to finish\"\nThere's no reason to introduce \"ELG\" here", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518505922", "createdAt": "2020-11-06T03:41:04Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -225,15 +226,22 @@ private AuthenticationData ipcAuthenticationHandler(byte[] payload) {\n     }\n \n     @Override\n-    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    @SuppressWarnings({\"PMD.AvoidCatchingThrowable\", \"PMD.AvoidCatchingGenericException\"})\n     public void close() {\n-        // GG_NEEDS_REVIEW: TODO: Future does not complete, wait on them when fixed.\n         if (ipcServer != null) {\n-            ipcServer.stopServer();\n+            try {\n+                ipcServer.stopServer().get(10, TimeUnit.SECONDS);\n+            } catch (Exception e) {\n+                logger.atError().setCause(e).log(\"Error stopping IPC server\");\n+            }\n         }\n         if (eventLoopGroup != null) {\n             eventLoopGroup.close();\n-            // GG_NEEDS_REVIEW: TODO: Wait for ELG to close. Right now the future does not complete, thus timing out.\n+            try {\n+                eventLoopGroup.getShutdownCompleteFuture().get(10, TimeUnit.SECONDS);\n+            } catch (Exception e) {\n+                logger.atError().setCause(e).log(\"Error waiting for ELG to close\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODM3MTYy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#pullrequestreview-524837162", "createdAt": "2020-11-06T03:42:48Z", "commit": {"oid": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMzo0Mjo0OFrOHufHNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwMzo0Mjo0OFrOHufHNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUwNjI5NA==", "bodyText": "where does 10s come from?\nIs this going to be a problem on slow devices?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518506294", "createdAt": "2020-11-06T03:42:48Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -225,15 +226,22 @@ private AuthenticationData ipcAuthenticationHandler(byte[] payload) {\n     }\n \n     @Override\n-    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    @SuppressWarnings({\"PMD.AvoidCatchingThrowable\", \"PMD.AvoidCatchingGenericException\"})\n     public void close() {\n-        // GG_NEEDS_REVIEW: TODO: Future does not complete, wait on them when fixed.\n         if (ipcServer != null) {\n-            ipcServer.stopServer();\n+            try {\n+                ipcServer.stopServer().get(10, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "committedDate": "2020-11-06T04:56:19Z", "message": "Waiting for Ipc shutdown and elg close which should be fixed with latest CRT. Updated SDK lib"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c626c73d6d8b742d0ad3a16d2ae3037318fd9a80", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c626c73d6d8b742d0ad3a16d2ae3037318fd9a80", "committedDate": "2020-11-06T03:19:09Z", "message": "Waiting for Ipc shutdown and elg close which should be fixed with latest CRT. Updated SDK lib"}, "afterCommit": {"oid": "c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d", "committedDate": "2020-11-06T04:56:19Z", "message": "Waiting for Ipc shutdown and elg close which should be fixed with latest CRT. Updated SDK lib"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODU4Njgw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#pullrequestreview-524858680", "createdAt": "2020-11-06T05:03:54Z", "commit": {"oid": "c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNTowMzo1NFrOHugQrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNTowMzo1NFrOHugQrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUyNTEwMQ==", "bodyText": "close() is called when greengrass is shutting down, waiting 2 minutes is unreasonable IMO", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#discussion_r518525101", "createdAt": "2020-11-06T05:03:54Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -225,15 +226,22 @@ private AuthenticationData ipcAuthenticationHandler(byte[] payload) {\n     }\n \n     @Override\n-    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    @SuppressWarnings({\"PMD.AvoidCatchingThrowable\", \"PMD.AvoidCatchingGenericException\"})\n     public void close() {\n-        // GG_NEEDS_REVIEW: TODO: Future does not complete, wait on them when fixed.\n         if (ipcServer != null) {\n-            ipcServer.stopServer();\n+            try {\n+                ipcServer.stopServer().get(2, TimeUnit.MINUTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6ca7f689ff615c6f99cfb12d5e52658aaa43d6d"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77a8ab3a536ddb0583a9d2c7a77e9870728a02c1", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77a8ab3a536ddb0583a9d2c7a77e9870728a02c1", "committedDate": "2020-11-06T05:27:19Z", "message": "Removing the wait on Ipc server shutdown. Works on mac but does not on linux. Revisit in next PR"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4330e037b4ff9f89a629dc10360e38e1289b556", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b4330e037b4ff9f89a629dc10360e38e1289b556", "committedDate": "2020-11-06T05:22:16Z", "message": "Removing the wait on Ipc server shutdown. Works on mac but does not on linux. Revisit in next PR"}, "afterCommit": {"oid": "77a8ab3a536ddb0583a9d2c7a77e9870728a02c1", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77a8ab3a536ddb0583a9d2c7a77e9870728a02c1", "committedDate": "2020-11-06T05:27:19Z", "message": "Removing the wait on Ipc server shutdown. Works on mac but does not on linux. Revisit in next PR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODY5NDAx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#pullrequestreview-524869401", "createdAt": "2020-11-06T05:40:33Z", "commit": {"oid": "77a8ab3a536ddb0583a9d2c7a77e9870728a02c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODcyMzk3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/629#pullrequestreview-524872397", "createdAt": "2020-11-06T05:50:45Z", "commit": {"oid": "77a8ab3a536ddb0583a9d2c7a77e9870728a02c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2942, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}