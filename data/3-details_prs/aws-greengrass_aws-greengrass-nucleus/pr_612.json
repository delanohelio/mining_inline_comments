{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0OTk3Mjk4", "number": 612, "title": "Pass kernel restart flag to component update check; Improve deployment artifact directory handling", "bodyText": "Issue #, if available:\n[P41214442]\n[P41331947]\nDescription of changes:\n\nAddress TODO to pass kernel restart flag to Pre-component-update check via IPC\nImprove deployment directory handling to address errors like below (symlink is not setup correctly if directory exists already). Additionally, on failures in the directory setup, immediately mark deployment as failed.\n\n    2020 Sep 28 18:00:19,679+0000 [ERROR] (pool-4-thread-12) DeploymentService: Unable to create deployment directory. {serviceName=DeploymentService, currentState=RUNNING}\n    java.io.IOException: Deployment details can not be saved to directory /home/ec2-user/testResults/85e7c6732f07d6d5cdbc5737f99ea6d2215ea810/deployments/ongoing\n    \tat com.aws.greengrass.deployment.DeploymentDirectoryManager.writeDeploymentMetadata(DeploymentDirectoryManager.java:116)\n    \tat com.aws.greengrass.deployment.DeploymentService.createNewDeployment(DeploymentService.java:363)\n    \tat com.aws.greengrass.deployment.DeploymentService.startup(DeploymentService.java:204)\n    \tat com.aws.greengrass.lifecyclemanager.Lifecycle.lambda$handleStateTransitionStartingToRunningAsync$8(Lifecycle.java:488)\n    \tat java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n    \tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n    \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n    \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n    \tat java.lang.Thread.run(Thread.java:748)\n\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-03T21:20:11Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612", "merged": true, "mergeCommit": {"oid": "75ad338d96632f5f22daee23725540475a51a38a"}, "closed": true, "closedAt": "2020-11-04T00:58:50Z", "author": {"login": "hui-yang"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZAAdxgFqTUyMjg4NTE2NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZDBSmAFqTUyMjk3NTk5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODg1MTY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#pullrequestreview-522885165", "createdAt": "2020-11-03T21:24:56Z", "commit": {"oid": "85fc15ac82bd3fae8acf7830213a28f95ae6e50b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMToyNDo1NlrOHtA_ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMToyNToxN1rOHtBACQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2NDIwMg==", "bodyText": "why do we ignore this!? This is what Feng hit, we had some ioexception which was logged, but it just kept going.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#discussion_r516964202", "createdAt": "2020-11-03T21:24:56Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -397,11 +397,11 @@ private void createNewDeployment(Deployment deployment) {\n         deploymentStatusKeeper.persistAndPublishDeploymentStatus(deployment.getId(), deployment.getDeploymentType(),\n                 JobStatus.IN_PROGRESS.toString(), new HashMap<>());\n         try {\n-            deploymentDirectoryManager.createNewDeploymentDirectoryIfNotExists(\n+            deploymentDirectoryManager.createNewDeploymentDirectory(\n                     deployment.getDeploymentDocumentObj().getDeploymentId());\n             deploymentDirectoryManager.writeDeploymentMetadata(deployment);\n         } catch (IOException ioException) {\n-            logger.atError().log(\"Unable to create deployment directory\", ioException);\n+            logger.atError().log(\"Unable to create deployment directory. Ignoring\", ioException);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85fc15ac82bd3fae8acf7830213a28f95ae6e50b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2NDM2MQ==", "bodyText": "add the deployment ID in here too", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#discussion_r516964361", "createdAt": "2020-11-03T21:25:17Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/UpdateAction.java", "diffHunk": "@@ -0,0 +1,16 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.lifecyclemanager;\n+\n+import com.aws.greengrass.dependency.Crashable;\n+import lombok.Value;\n+\n+@Value\n+public class UpdateAction {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85fc15ac82bd3fae8acf7830213a28f95ae6e50b"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTU4NDg1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#pullrequestreview-522958485", "createdAt": "2020-11-03T23:59:54Z", "commit": {"oid": "85fc15ac82bd3fae8acf7830213a28f95ae6e50b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTYzOTQy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#pullrequestreview-522963942", "createdAt": "2020-11-04T00:16:39Z", "commit": {"oid": "85fc15ac82bd3fae8acf7830213a28f95ae6e50b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a69d2da59cfb636750534afe9854fdc590b327b", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a69d2da59cfb636750534afe9854fdc590b327b", "committedDate": "2020-11-04T00:27:19Z", "message": "Pass kernel restart flag to component update check; Improve deployment artifact directory handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f9412d39efa543d00d189054fbc4a5cb7002eb9", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f9412d39efa543d00d189054fbc4a5cb7002eb9", "committedDate": "2020-11-04T00:27:19Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ddb9e61c6ee8ab2c5cc0e1bb35d59769bcaa8630", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ddb9e61c6ee8ab2c5cc0e1bb35d59769bcaa8630", "committedDate": "2020-11-04T00:18:30Z", "message": "Merge branch 'master' into ku-todo"}, "afterCommit": {"oid": "6f9412d39efa543d00d189054fbc4a5cb7002eb9", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f9412d39efa543d00d189054fbc4a5cb7002eb9", "committedDate": "2020-11-04T00:27:19Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTczMDM3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#pullrequestreview-522973037", "createdAt": "2020-11-04T00:46:35Z", "commit": {"oid": "6f9412d39efa543d00d189054fbc4a5cb7002eb9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMDo0NjozNVrOHtFckA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMDo0NjozNVrOHtFckA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAzNzIwMA==", "bodyText": "will this update the job status? The job status was just updated to be in progress on L400", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#discussion_r517037200", "createdAt": "2020-11-04T00:46:35Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -398,11 +399,16 @@ private void createNewDeployment(Deployment deployment) {\n         deploymentStatusKeeper.persistAndPublishDeploymentStatus(deployment.getId(), deployment.getDeploymentType(),\n                 JobStatus.IN_PROGRESS.toString(), new HashMap<>());\n         try {\n-            deploymentDirectoryManager.createNewDeploymentDirectoryIfNotExists(\n+            deploymentDirectoryManager.createNewDeploymentDirectory(\n                     deployment.getDeploymentDocumentObj().getDeploymentId());\n             deploymentDirectoryManager.writeDeploymentMetadata(deployment);\n         } catch (IOException ioException) {\n             logger.atError().log(\"Unable to create deployment directory\", ioException);\n+            CompletableFuture<DeploymentResult> process = new CompletableFuture<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f9412d39efa543d00d189054fbc4a5cb7002eb9"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTc0MjU1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#pullrequestreview-522974255", "createdAt": "2020-11-04T00:50:34Z", "commit": {"oid": "6f9412d39efa543d00d189054fbc4a5cb7002eb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTc1OTkx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/612#pullrequestreview-522975991", "createdAt": "2020-11-04T00:56:28Z", "commit": {"oid": "6f9412d39efa543d00d189054fbc4a5cb7002eb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2911, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}