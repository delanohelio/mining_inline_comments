{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMDU2OTI3", "number": 754, "title": "Smarter unarchive to only overwrite missing or changed files", "bodyText": "Issue #, if available:\nDescription of changes:\nFixes JVM crash due to overwriting the running JAR file when unarchiving during a deployment. We previously always unarchived no matter what, because the unarchived artifacts don't have digests which we can validate against, so since we don't know if the previous attempt to unarchive was actually succesful, we just go and do it again.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-03T19:44:19Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/754", "merged": true, "mergeCommit": {"oid": "bd2649379b322010629847d07d69e0f1d27bb445"}, "closed": true, "closedAt": "2020-12-03T20:49:16Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdipFDKgFqTU0NDM4NTIyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdipRhBAFqTU0NDQwODM0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Mzg1MjIx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/754#pullrequestreview-544385221", "createdAt": "2020-12-03T20:22:17Z", "commit": {"oid": "4641b26d45a6c8f99b6790e77d205ab5f8fedf26"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDoyMjoxN1rOH-wTaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDoyMjoxN1rOH-wTaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU2NTE2MA==", "bodyText": "Can we go one step further and cache the crc together with the unarchived artifacts? Then we don't need to compute the CRC every time. Only compute again if the cache CRC doesn't match with the one in the zip.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/754#discussion_r535565160", "createdAt": "2020-12-03T20:22:17Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/componentmanager/Unarchiver.java", "diffHunk": "@@ -41,8 +45,13 @@ static void unzip(File zipFile, File destDir) throws IOException {\n                     Utils.createPaths(newFile.toPath());\n                 } else {\n                     Utils.createPaths(newFile.getParentFile().toPath());\n-                    try (OutputStream fos = Files.newOutputStream(newFile.toPath())) {\n-                        IOUtils.copy(zis, fos);\n+                    // Only unarchive when the destination file doesn't exist, the file sizes don't match, or the\n+                    // CRCs don't match\n+                    if (!newFile.exists() || zipEntry.getCrc() == -1 || zipEntry.getSize() != newFile.length()\n+                            || zipEntry.getCrc() != crc32(newFile)) {\n+                        try (OutputStream fos = Files.newOutputStream(newFile.toPath())) {\n+                            IOUtils.copy(zis, fos);\n+                        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4641b26d45a6c8f99b6790e77d205ab5f8fedf26"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d65a5a34df653ee01c422e6b280e744778f76bea", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d65a5a34df653ee01c422e6b280e744778f76bea", "committedDate": "2020-12-03T20:33:17Z", "message": "Smarter unarchive to only overwrite missing or changed files"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4641b26d45a6c8f99b6790e77d205ab5f8fedf26", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4641b26d45a6c8f99b6790e77d205ab5f8fedf26", "committedDate": "2020-12-03T19:43:05Z", "message": "Smarter unarchive to only overwrite missing or changed files"}, "afterCommit": {"oid": "d65a5a34df653ee01c422e6b280e744778f76bea", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d65a5a34df653ee01c422e6b280e744778f76bea", "committedDate": "2020-12-03T20:33:17Z", "message": "Smarter unarchive to only overwrite missing or changed files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDA0MzM1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/754#pullrequestreview-544404335", "createdAt": "2020-12-03T20:33:49Z", "commit": {"oid": "d65a5a34df653ee01c422e6b280e744778f76bea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDA4MzQ4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/754#pullrequestreview-544408348", "createdAt": "2020-12-03T20:35:54Z", "commit": {"oid": "d65a5a34df653ee01c422e6b280e744778f76bea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2527, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}