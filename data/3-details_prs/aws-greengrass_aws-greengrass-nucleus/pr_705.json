{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNjg3OTE4", "number": 705, "title": "Move telemetry config to system settings.", "bodyText": "Issue #, if available:\nDescription of changes:\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-19T05:32:09Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705", "merged": true, "mergeCommit": {"oid": "1221ae8e25d4f7d35340e8ba3a42fdf7227a368b"}, "closed": true, "closedAt": "2020-11-25T23:21:23Z", "author": {"login": "nikkhilmuthye"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd8PcsgBqjQwMTQwODA3NTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgF-lpAH2gAyNTIzNjg3OTE4OmFkM2JjM2ZmMWNlZWVmYWNhOGZkMTkxMjk5NDhiODI0ODE0MTllMGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4420058e08f4978bd2432437c052b8d7925d1779", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4420058e08f4978bd2432437c052b8d7925d1779", "committedDate": "2020-11-19T05:30:37Z", "message": "Move telemetry config to system settings."}, "afterCommit": {"oid": "8f98836185f814127067f7624397552f10129be8", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8f98836185f814127067f7624397552f10129be8", "committedDate": "2020-11-19T05:52:04Z", "message": "Move telemetry config to system settings."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f98836185f814127067f7624397552f10129be8", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8f98836185f814127067f7624397552f10129be8", "committedDate": "2020-11-19T05:52:04Z", "message": "Move telemetry config to system settings."}, "afterCommit": {"oid": "1559bc201d797bcd3c35bac41a938956c7b06ede", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1559bc201d797bcd3c35bac41a938956c7b06ede", "committedDate": "2020-11-19T17:28:05Z", "message": "Move telemetry config to system settings."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/095f1fc41e7613f9598bf087b96e66784303453a", "committedDate": "2020-11-19T18:00:23Z", "message": "Move telemetry config to system settings."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1559bc201d797bcd3c35bac41a938956c7b06ede", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1559bc201d797bcd3c35bac41a938956c7b06ede", "committedDate": "2020-11-19T17:28:05Z", "message": "Move telemetry config to system settings."}, "afterCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/095f1fc41e7613f9598bf087b96e66784303453a", "committedDate": "2020-11-19T18:00:23Z", "message": "Move telemetry config to system settings."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NzE2ODkw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#pullrequestreview-534716890", "createdAt": "2020-11-19T18:07:46Z", "commit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxODowNzo0NlrOH2rQmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxODowNzo0NlrOH2rQmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5MzkxNQ==", "bodyText": "Let's get in the habit of JavaDoc'ing what this property is", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527093915", "createdAt": "2020-11-19T18:07:46Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -80,6 +71,9 @@ public void onConnectionResumed(boolean sessionPresent) {\n         }\n     };\n     private String thingName;\n+    @Setter // Needed for integration tests.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NzE3NTQ1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#pullrequestreview-534717545", "createdAt": "2020-11-19T18:08:36Z", "commit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxODowODozN1rOH2rSeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxODoyODo1M1rOH2sEiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5NDM5NA==", "bodyText": "One of the reasons why I don't like justified text like this is because a parameter can cause a large block change :(", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527094394", "createdAt": "2020-11-19T18:08:37Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -103,15 +97,16 @@ public TelemetryAgent(Topics topics, MqttClient mqttClient, DeviceConfiguration\n     /**\n      * Constructor for the class.\n      *\n-     * @param topics                                root configuration topic for this service\n-     * @param mqttClient                            {@link MqttClient}\n-     * @param deviceConfiguration                   {@link DeviceConfiguration}\n-     * @param ma                                    {@link MetricsAggregator}\n-     * @param sme                                   {@link SystemMetricsEmitter}\n-     * @param kme                                   {@link KernelMetricsEmitter}\n-     * @param ses                                   {@link ScheduledExecutorService}\n-     * @param periodicPublishMetricsIntervalSec     interval for cadence based telemetry publish.\n-     * @param periodicAggregateMetricsIntervalSec   interval for cadence based telemetry metrics aggregation.*/\n+     * @param topics                              root configuration topic for this service", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5NDkwNw==", "bodyText": "There are too many inputs into this, you need a builder class (c/o Lombok) In particular, it is easy to mix parameters up and have a valid constructor.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527094907", "createdAt": "2020-11-19T18:09:23Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -103,15 +97,16 @@ public TelemetryAgent(Topics topics, MqttClient mqttClient, DeviceConfiguration\n     /**\n      * Constructor for the class.\n      *\n-     * @param topics                                root configuration topic for this service\n-     * @param mqttClient                            {@link MqttClient}\n-     * @param deviceConfiguration                   {@link DeviceConfiguration}\n-     * @param ma                                    {@link MetricsAggregator}\n-     * @param sme                                   {@link SystemMetricsEmitter}\n-     * @param kme                                   {@link KernelMetricsEmitter}\n-     * @param ses                                   {@link ScheduledExecutorService}\n-     * @param periodicPublishMetricsIntervalSec     interval for cadence based telemetry publish.\n-     * @param periodicAggregateMetricsIntervalSec   interval for cadence based telemetry metrics aggregation.*/\n+     * @param topics                              root configuration topic for this service\n+     * @param mqttClient                          {@link MqttClient}\n+     * @param deviceConfiguration                 {@link DeviceConfiguration}\n+     * @param ma                                  {@link MetricsAggregator}\n+     * @param sme                                 {@link SystemMetricsEmitter}\n+     * @param kme                                 {@link KernelMetricsEmitter}\n+     * @param ses                                 {@link ScheduledExecutorService}\n+     * @param periodicPublishMetricsIntervalSec   interval for cadence based telemetry publish.\n+     * @param periodicAggregateMetricsIntervalSec interval for cadence based telemetry metrics aggregation.\n+     */\n     public TelemetryAgent(Topics topics, MqttClient mqttClient, DeviceConfiguration deviceConfiguration,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5ODc2MA==", "bodyText": "builder().build() pattern generally makes sense for an immutable object. It seems this is mutable. Given this is mutable, I have concerns with thread safety. You have synchronized sections below, but it is not maintainable because it is easy for someone to get wrong. Making this structure immutable, and make this property an AtomicReference to make it maintainable thread safe.\nAlso note when you get the parameters, get the structure first, use config = currentConfiguration.get(); then act on config, don't do currentConfiguration.get().fieldAccess();", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527098760", "createdAt": "2020-11-19T18:15:15Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -80,6 +71,9 @@ public void onConnectionResumed(boolean sessionPresent) {\n         }\n     };\n     private String thingName;\n+    @Setter // Needed for integration tests.\n+    @Getter(AccessLevel.PACKAGE) // Needed for unit tests.\n+    private final TelemetryConfiguration currentConfiguration = TelemetryConfiguration.builder().build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5OTI3Mg==", "bodyText": "Aside, how do you succeed having a setter on a final field?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527099272", "createdAt": "2020-11-19T18:16:06Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -80,6 +71,9 @@ public void onConnectionResumed(boolean sessionPresent) {\n         }\n     };\n     private String thingName;\n+    @Setter // Needed for integration tests.\n+    @Getter(AccessLevel.PACKAGE) // Needed for unit tests.\n+    private final TelemetryConfiguration currentConfiguration = TelemetryConfiguration.builder().build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5ODc2MA=="}, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwMzQxMw==", "bodyText": "For example here, in general, synchronized() should be avoided in favor of better atomic abstractions, but sometimes necessary. It's easy for future developers to forget they need this.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527103413", "createdAt": "2020-11-19T18:22:37Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -186,11 +191,16 @@ void schedulePeriodicPublishMetrics(boolean isReconfigured) {\n         if (isReconfigured) {\n             synchronized (periodicPublishMetricsInProgressLock) {\n                 Instant lastPeriodicPubTime = Instant.ofEpochMilli(Coerce.toLong(getPeriodicPublishTimeTopic()));\n-                if (lastPeriodicPubTime.plusSeconds(periodicPublishMetricsIntervalSec).isBefore(Instant.now())) {\n+                if (lastPeriodicPubTime.plusSeconds(currentConfiguration.getPeriodicPublishMetricsIntervalSec())\n+                        .isBefore(Instant.now())) {\n                     publishPeriodicMetrics();\n                 }\n             }\n         }\n+        int periodicPublishMetricsIntervalSec;\n+        synchronized (currentConfiguration) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNDAwOA==", "bodyText": "Is it ok to not do this check? is it sufficient to re-schedule on field change?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527104008", "createdAt": "2020-11-19T18:23:41Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -254,56 +264,69 @@ private void cancelJob(ScheduledFuture<?> future, Object lock, boolean immediate\n     }\n \n     @Override\n-    public void startup() throws InterruptedException {\n-        config.lookup(PARAMETERS_CONFIG_KEY, TELEMETRY_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicAggregateMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicAggregateMetricsIntervalSec < DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicAggregateMetricsIntervalAndSchedule(newPeriodicAggregateMetricsIntervalSec);\n-                });\n-        config.lookup(PARAMETERS_CONFIG_KEY, TELEMETRY_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicPublishMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicPublishMetricsIntervalSec < DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicPublishMetricsIntervalAndScheduleTask(newPeriodicPublishMetricsIntervalSec);\n-                });\n+    public void postInject() {\n+        Topics configurationTopics = deviceConfiguration.getTelemetryConfigurationTopics();\n+        configurationTopics.subscribe((why, newv) -> {\n+            TelemetryConfiguration newTelemetryConfiguration =\n+                    TelemetryConfiguration.fromPojo(configurationTopics.toPOJO());\n+            if (newTelemetryConfiguration.isEnabled()) {\n+                // If the current aggregation interval is different from the new interval, then reschedule\n+                // the periodic aggregation task\n+                if (currentConfiguration == null || currentConfiguration.getPeriodicAggregateMetricsIntervalSec()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 177}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNDM3Mw==", "bodyText": "These need to be combined together, difficult to maintain and follow for correctness.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527104373", "createdAt": "2020-11-19T18:24:22Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -254,56 +264,69 @@ private void cancelJob(ScheduledFuture<?> future, Object lock, boolean immediate\n     }\n \n     @Override\n-    public void startup() throws InterruptedException {\n-        config.lookup(PARAMETERS_CONFIG_KEY, TELEMETRY_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicAggregateMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicAggregateMetricsIntervalSec < DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicAggregateMetricsIntervalAndSchedule(newPeriodicAggregateMetricsIntervalSec);\n-                });\n-        config.lookup(PARAMETERS_CONFIG_KEY, TELEMETRY_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicPublishMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicPublishMetricsIntervalSec < DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicPublishMetricsIntervalAndScheduleTask(newPeriodicPublishMetricsIntervalSec);\n-                });\n+    public void postInject() {\n+        Topics configurationTopics = deviceConfiguration.getTelemetryConfigurationTopics();\n+        configurationTopics.subscribe((why, newv) -> {\n+            TelemetryConfiguration newTelemetryConfiguration =\n+                    TelemetryConfiguration.fromPojo(configurationTopics.toPOJO());\n+            if (newTelemetryConfiguration.isEnabled()) {\n+                // If the current aggregation interval is different from the new interval, then reschedule\n+                // the periodic aggregation task\n+                if (currentConfiguration == null || currentConfiguration.getPeriodicAggregateMetricsIntervalSec()\n+                        != newTelemetryConfiguration.getPeriodicAggregateMetricsIntervalSec()) {\n+                    setPeriodicAggregateMetricsIntervalAndSchedule(newTelemetryConfiguration\n+                            .getPeriodicAggregateMetricsIntervalSec());\n+                }\n+                // If the current publish interval is different from the new interval, then reschedule\n+                // the publish aggregation task\n+                if (currentConfiguration == null || currentConfiguration.getPeriodicPublishMetricsIntervalSec()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 184}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNDg5Ng==", "bodyText": "What happens if disabled, but jobs don't exist, does right thing happen?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527104896", "createdAt": "2020-11-19T18:25:09Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -254,56 +264,69 @@ private void cancelJob(ScheduledFuture<?> future, Object lock, boolean immediate\n     }\n \n     @Override\n-    public void startup() throws InterruptedException {\n-        config.lookup(PARAMETERS_CONFIG_KEY, TELEMETRY_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicAggregateMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicAggregateMetricsIntervalSec < DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicAggregateMetricsIntervalAndSchedule(newPeriodicAggregateMetricsIntervalSec);\n-                });\n-        config.lookup(PARAMETERS_CONFIG_KEY, TELEMETRY_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicPublishMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicPublishMetricsIntervalSec < DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicPublishMetricsIntervalAndScheduleTask(newPeriodicPublishMetricsIntervalSec);\n-                });\n+    public void postInject() {\n+        Topics configurationTopics = deviceConfiguration.getTelemetryConfigurationTopics();\n+        configurationTopics.subscribe((why, newv) -> {\n+            TelemetryConfiguration newTelemetryConfiguration =\n+                    TelemetryConfiguration.fromPojo(configurationTopics.toPOJO());\n+            if (newTelemetryConfiguration.isEnabled()) {\n+                // If the current aggregation interval is different from the new interval, then reschedule\n+                // the periodic aggregation task\n+                if (currentConfiguration == null || currentConfiguration.getPeriodicAggregateMetricsIntervalSec()\n+                        != newTelemetryConfiguration.getPeriodicAggregateMetricsIntervalSec()) {\n+                    setPeriodicAggregateMetricsIntervalAndSchedule(newTelemetryConfiguration\n+                            .getPeriodicAggregateMetricsIntervalSec());\n+                }\n+                // If the current publish interval is different from the new interval, then reschedule\n+                // the publish aggregation task\n+                if (currentConfiguration == null || currentConfiguration.getPeriodicPublishMetricsIntervalSec()\n+                        != newTelemetryConfiguration.getPeriodicPublishMetricsIntervalSec()) {\n+                    setPeriodicPublishMetricsIntervalAndScheduleTask(newTelemetryConfiguration\n+                            .getPeriodicPublishMetricsIntervalSec());\n+                }\n+            } else {\n+                // If telemetry is not enabled, then cancel the futures.\n+                for (PeriodicMetricsEmitter emitter : periodicMetricsEmitters) {\n+                    cancelJob(emitter.future, periodicAggregateMetricsInProgressLock, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 192}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNTYwNQ==", "bodyText": "This code is repetitive with shutdown() merge into common code (DRY)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527105605", "createdAt": "2020-11-19T18:26:19Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -254,56 +264,69 @@ private void cancelJob(ScheduledFuture<?> future, Object lock, boolean immediate\n     }\n \n     @Override\n-    public void startup() throws InterruptedException {\n-        config.lookup(PARAMETERS_CONFIG_KEY, TELEMETRY_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicAggregateMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicAggregateMetricsIntervalSec < DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicAggregateMetricsIntervalAndSchedule(newPeriodicAggregateMetricsIntervalSec);\n-                });\n-        config.lookup(PARAMETERS_CONFIG_KEY, TELEMETRY_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicPublishMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicPublishMetricsIntervalSec < DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicPublishMetricsIntervalAndScheduleTask(newPeriodicPublishMetricsIntervalSec);\n-                });\n+    public void postInject() {\n+        Topics configurationTopics = deviceConfiguration.getTelemetryConfigurationTopics();\n+        configurationTopics.subscribe((why, newv) -> {\n+            TelemetryConfiguration newTelemetryConfiguration =\n+                    TelemetryConfiguration.fromPojo(configurationTopics.toPOJO());\n+            if (newTelemetryConfiguration.isEnabled()) {\n+                // If the current aggregation interval is different from the new interval, then reschedule\n+                // the periodic aggregation task\n+                if (currentConfiguration == null || currentConfiguration.getPeriodicAggregateMetricsIntervalSec()\n+                        != newTelemetryConfiguration.getPeriodicAggregateMetricsIntervalSec()) {\n+                    setPeriodicAggregateMetricsIntervalAndSchedule(newTelemetryConfiguration\n+                            .getPeriodicAggregateMetricsIntervalSec());\n+                }\n+                // If the current publish interval is different from the new interval, then reschedule\n+                // the publish aggregation task\n+                if (currentConfiguration == null || currentConfiguration.getPeriodicPublishMetricsIntervalSec()\n+                        != newTelemetryConfiguration.getPeriodicPublishMetricsIntervalSec()) {\n+                    setPeriodicPublishMetricsIntervalAndScheduleTask(newTelemetryConfiguration\n+                            .getPeriodicPublishMetricsIntervalSec());\n+                }\n+            } else {\n+                // If telemetry is not enabled, then cancel the futures.\n+                for (PeriodicMetricsEmitter emitter : periodicMetricsEmitters) {\n+                    cancelJob(emitter.future, periodicAggregateMetricsInProgressLock, true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNDg5Ng=="}, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 192}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNjIyMw==", "bodyText": "Make @value and treat this as one immutable structure to make thread safety easier.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527106223", "createdAt": "2020-11-19T18:27:16Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryConfiguration.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.telemetry;\n+\n+import com.aws.greengrass.testing.TestFeatureParameters;\n+import com.aws.greengrass.util.Coerce;\n+import lombok.Builder;\n+import lombok.Data;\n+\n+import java.util.Map;\n+\n+import static com.aws.greengrass.telemetry.TelemetryAgent.DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC;\n+import static com.aws.greengrass.telemetry.TelemetryAgent.DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC;\n+import static com.aws.greengrass.telemetry.TelemetryAgent.TELEMETRY_TEST_PERIODIC_AGGREGATE_INTERVAL_SEC;\n+import static com.aws.greengrass.telemetry.TelemetryAgent.TELEMETRY_TEST_PERIODIC_PUBLISH_INTERVAL_SEC;\n+\n+@Data", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNjYyMQ==", "bodyText": "Create a (static) method that takes configuration and products a structure from that configuration to make this easier to maintain.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527106621", "createdAt": "2020-11-19T18:27:56Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryConfiguration.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.telemetry;\n+\n+import com.aws.greengrass.testing.TestFeatureParameters;\n+import com.aws.greengrass.util.Coerce;\n+import lombok.Builder;\n+import lombok.Data;\n+\n+import java.util.Map;\n+\n+import static com.aws.greengrass.telemetry.TelemetryAgent.DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC;\n+import static com.aws.greengrass.telemetry.TelemetryAgent.DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC;\n+import static com.aws.greengrass.telemetry.TelemetryAgent.TELEMETRY_TEST_PERIODIC_AGGREGATE_INTERVAL_SEC;\n+import static com.aws.greengrass.telemetry.TelemetryAgent.TELEMETRY_TEST_PERIODIC_PUBLISH_INTERVAL_SEC;\n+\n+@Data", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNjIyMw=="}, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNzIwOA==", "bodyText": "This seems to be duplicative with the fromPojo() how do you make this simpler?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r527107208", "createdAt": "2020-11-19T18:28:53Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -254,56 +264,69 @@ private void cancelJob(ScheduledFuture<?> future, Object lock, boolean immediate\n     }\n \n     @Override\n-    public void startup() throws InterruptedException {\n-        config.lookup(PARAMETERS_CONFIG_KEY, TELEMETRY_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicAggregateMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicAggregateMetricsIntervalSec < DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicAggregateMetricsIntervalAndSchedule(newPeriodicAggregateMetricsIntervalSec);\n-                });\n-        config.lookup(PARAMETERS_CONFIG_KEY, TELEMETRY_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicPublishMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicPublishMetricsIntervalSec < DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicPublishMetricsIntervalAndScheduleTask(newPeriodicPublishMetricsIntervalSec);\n-                });\n+    public void postInject() {\n+        Topics configurationTopics = deviceConfiguration.getTelemetryConfigurationTopics();\n+        configurationTopics.subscribe((why, newv) -> {\n+            TelemetryConfiguration newTelemetryConfiguration =\n+                    TelemetryConfiguration.fromPojo(configurationTopics.toPOJO());\n+            if (newTelemetryConfiguration.isEnabled()) {\n+                // If the current aggregation interval is different from the new interval, then reschedule\n+                // the periodic aggregation task\n+                if (currentConfiguration == null || currentConfiguration.getPeriodicAggregateMetricsIntervalSec()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNDAwOA=="}, "originalCommit": {"oid": "095f1fc41e7613f9598bf087b96e66784303453a"}, "originalPosition": 177}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e67852e75c16247172958fbb86d102a8fe73cc9", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9e67852e75c16247172958fbb86d102a8fe73cc9", "committedDate": "2020-11-19T23:37:00Z", "message": "Address PR comments."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "153cacd4418234001f9afff5adaa475b604ea715", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/153cacd4418234001f9afff5adaa475b604ea715", "committedDate": "2020-11-19T23:24:13Z", "message": "Address PR comments."}, "afterCommit": {"oid": "9e67852e75c16247172958fbb86d102a8fe73cc9", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9e67852e75c16247172958fbb86d102a8fe73cc9", "committedDate": "2020-11-19T23:37:00Z", "message": "Address PR comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c727b7e5dd286c0da1acc2fa67363190fab0e6fa", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c727b7e5dd286c0da1acc2fa67363190fab0e6fa", "committedDate": "2020-11-20T00:40:55Z", "message": "Merge branch 'master' into telemetryConfigInSysSettings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjUwOTIx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#pullrequestreview-535650921", "createdAt": "2020-11-20T17:49:57Z", "commit": {"oid": "c727b7e5dd286c0da1acc2fa67363190fab0e6fa"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NzA2Njc2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#pullrequestreview-537706676", "createdAt": "2020-11-24T16:43:30Z", "commit": {"oid": "c727b7e5dd286c0da1acc2fa67363190fab0e6fa"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjo0MzozMFrOH5Lovg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjo0MzozMFrOH5Lovg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyMTUzNA==", "bodyText": "Something I struggle with here is why do we not just rely on postInject()? are you doing this to engineer around unit testing? If so, this feels counter productive. I think there's some room for simplification here, but let's schedule that for post re:Invent.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r529721534", "createdAt": "2020-11-24T16:43:30Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -103,34 +100,42 @@ public TelemetryAgent(Topics topics, MqttClient mqttClient, DeviceConfiguration\n     /**\n      * Constructor for the class.\n      *\n-     * @param topics                                root configuration topic for this service\n-     * @param mqttClient                            {@link MqttClient}\n-     * @param deviceConfiguration                   {@link DeviceConfiguration}\n-     * @param ma                                    {@link MetricsAggregator}\n-     * @param sme                                   {@link SystemMetricsEmitter}\n-     * @param kme                                   {@link KernelMetricsEmitter}\n-     * @param ses                                   {@link ScheduledExecutorService}\n-     * @param periodicPublishMetricsIntervalSec     interval for cadence based telemetry publish.\n-     * @param periodicAggregateMetricsIntervalSec   interval for cadence based telemetry metrics aggregation.*/\n-    public TelemetryAgent(Topics topics, MqttClient mqttClient, DeviceConfiguration deviceConfiguration,\n-                          MetricsAggregator ma, SystemMetricsEmitter sme, KernelMetricsEmitter kme,\n-                          ScheduledExecutorService ses, int periodicPublishMetricsIntervalSec,\n-                          int periodicAggregateMetricsIntervalSec) {\n+     * @param topics                              root configuration topic for this service\n+     * @param mqttClient                          {@link MqttClient}\n+     * @param deviceConfiguration                 {@link DeviceConfiguration}\n+     * @param ma                                  {@link MetricsAggregator}\n+     * @param sme                                 {@link SystemMetricsEmitter}\n+     * @param kme                                 {@link KernelMetricsEmitter}\n+     * @param ses                                 {@link ScheduledExecutorService}\n+     * @param periodicPublishMetricsIntervalSec   interval for cadence based telemetry publish.\n+     * @param periodicAggregateMetricsIntervalSec interval for cadence based telemetry metrics aggregation.\n+     */\n+    TelemetryAgent(Topics topics, MqttClient mqttClient, DeviceConfiguration deviceConfiguration,\n+                   MetricsAggregator ma, SystemMetricsEmitter sme, KernelMetricsEmitter kme,\n+                   ScheduledExecutorService ses, int periodicPublishMetricsIntervalSec,\n+                   int periodicAggregateMetricsIntervalSec) {\n         super(topics);\n         this.mqttClient = mqttClient;\n         this.publisher = new MqttChunkedPayloadPublisher<>(this.mqttClient);\n         this.publisher.setMaxPayloadLengthBytes(MAX_PAYLOAD_LENGTH_BYTES);\n         this.ses = ses;\n         this.metricsAggregator = ma;\n+        this.deviceConfiguration = deviceConfiguration;\n         this.thingName = Coerce.toString(deviceConfiguration.getThingName());\n-        this.periodicAggregateMetricsIntervalSec = TestFeatureParameters.retrieveWithDefault(Double.class,\n+        int finalPeriodicAggregateMetricsIntervalSec = TestFeatureParameters.retrieveWithDefault(Double.class,\n                 TELEMETRY_TEST_PERIODIC_AGGREGATE_INTERVAL_SEC, periodicAggregateMetricsIntervalSec).intValue();\n-        this.periodicPublishMetricsIntervalSec = TestFeatureParameters.retrieveWithDefault(Double.class,\n+        int finalPeriodicPublishMetricsIntervalSec = TestFeatureParameters.retrieveWithDefault(Double.class,\n                 TELEMETRY_TEST_PERIODIC_PUBLISH_INTERVAL_SEC, periodicPublishMetricsIntervalSec).intValue();\n+        currentConfiguration.set(TelemetryConfiguration.builder()\n+                .periodicAggregateMetricsIntervalSec(finalPeriodicAggregateMetricsIntervalSec)\n+                .periodicPublishMetricsIntervalSec(finalPeriodicPublishMetricsIntervalSec)\n+                .build());\n         periodicMetricsEmitters.add(sme);\n         periodicMetricsEmitters.add(kme);\n         getPeriodicAggregateTimeTopic();\n         getPeriodicPublishTimeTopic();\n+        schedulePeriodicAggregateMetrics(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c727b7e5dd286c0da1acc2fa67363190fab0e6fa"}, "originalPosition": 114}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9393713e88c2fdcc0470b0034ec4efe94d11748e", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9393713e88c2fdcc0470b0034ec4efe94d11748e", "committedDate": "2020-11-24T17:43:44Z", "message": "Merge branch 'master' into telemetryConfigInSysSettings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd53e90e4f3fd76406be920ddc0e236a2b7a425f", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd53e90e4f3fd76406be920ddc0e236a2b7a425f", "committedDate": "2020-11-24T17:56:51Z", "message": "Remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODAzOTcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#pullrequestreview-537803973", "createdAt": "2020-11-24T18:41:15Z", "commit": {"oid": "fd53e90e4f3fd76406be920ddc0e236a2b7a425f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODo0MToxNVrOH5QV1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODo0MzozMlrOH5QbQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODYxNQ==", "bodyText": "I'd prefer just enabled", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r529798615", "createdAt": "2020-11-24T18:41:15Z", "author": {"login": "MikeDombo"}, "path": "README_CONFIG_SCHEMA.md", "diffHunk": "@@ -175,6 +175,10 @@ services:\n         format: TEXT\n         outputDirectory: /path/to/logs/directory\n         outputType: FILE\n+      telemetry:\n+        isEnabled: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd53e90e4f3fd76406be920ddc0e236a2b7a425f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5ODgxOQ==", "bodyText": "use the full word Seconds", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r529798819", "createdAt": "2020-11-24T18:41:32Z", "author": {"login": "MikeDombo"}, "path": "README_CONFIG_SCHEMA.md", "diffHunk": "@@ -175,6 +175,10 @@ services:\n         format: TEXT\n         outputDirectory: /path/to/logs/directory\n         outputType: FILE\n+      telemetry:\n+        isEnabled: true\n+        periodicAggregateMetricsIntervalSec: 3600", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd53e90e4f3fd76406be920ddc0e236a2b7a425f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwMDAwMg==", "bodyText": "Don't do all of this in postInject do it in the startup instead so that it doesn't block.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r529800002", "createdAt": "2020-11-24T18:43:32Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -254,56 +266,73 @@ private void cancelJob(ScheduledFuture<?> future, Object lock, boolean immediate\n     }\n \n     @Override\n-    public void startup() throws InterruptedException {\n-        config.lookup(CONFIGURATION_CONFIG_KEY, TELEMETRY_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicAggregateMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicAggregateMetricsIntervalSec < DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicAggregateMetricsIntervalAndSchedule(newPeriodicAggregateMetricsIntervalSec);\n-                });\n-        config.lookup(CONFIGURATION_CONFIG_KEY, TELEMETRY_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicPublishMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicPublishMetricsIntervalSec < DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicPublishMetricsIntervalAndScheduleTask(newPeriodicPublishMetricsIntervalSec);\n-                });\n+    public void postInject() {\n+        Topics configurationTopics = deviceConfiguration.getTelemetryConfigurationTopics();\n+        configurationTopics.subscribe((why, newv) -> {\n+            TelemetryConfiguration newTelemetryConfiguration =\n+                    TelemetryConfiguration.fromPojo(configurationTopics.toPOJO());\n+            TelemetryConfiguration configuration = currentConfiguration.get();\n+            boolean aggregateMetricsIntervalSecChanged = false;\n+            boolean publishMetricsIntervalSecChanged = false;\n+            if (newTelemetryConfiguration.isEnabled()) {\n+                // If the current aggregation interval is different from the new interval, then reschedule\n+                // the periodic aggregation task\n+                aggregateMetricsIntervalSecChanged = configuration.getPeriodicAggregateMetricsIntervalSec()\n+                        != newTelemetryConfiguration.getPeriodicAggregateMetricsIntervalSec();\n+                // If the current publish interval is different from the new interval, then reschedule\n+                // the publish aggregation task\n+                publishMetricsIntervalSecChanged = configuration.getPeriodicPublishMetricsIntervalSec()\n+                        != newTelemetryConfiguration.getPeriodicPublishMetricsIntervalSec();\n+            } else {\n+                // If telemetry is not enabled, then cancel the futures.\n+                cancelAllJobs();\n+            }\n+            currentConfiguration.set(newTelemetryConfiguration);\n+            if (aggregateMetricsIntervalSecChanged) {\n+                schedulePeriodicAggregateMetrics(true);\n+            }\n+            if (publishMetricsIntervalSecChanged) {\n+                schedulePeriodicPublishMetrics(true);\n+            }\n+        });\n         updateThingNameAndPublishTopic(thingName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd53e90e4f3fd76406be920ddc0e236a2b7a425f"}, "originalPosition": 229}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODA2ODky", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#pullrequestreview-537806892", "createdAt": "2020-11-24T18:45:17Z", "commit": {"oid": "fd53e90e4f3fd76406be920ddc0e236a2b7a425f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec95b71fc29b2ec258b5273d4782cb4d8b9a6e24", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ec95b71fc29b2ec258b5273d4782cb4d8b9a6e24", "committedDate": "2020-11-24T19:37:35Z", "message": "Address PR comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9519656ef2bd1f9960109249286c41331cdd7dfe", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9519656ef2bd1f9960109249286c41331cdd7dfe", "committedDate": "2020-11-24T20:05:22Z", "message": "Merge branch 'master' into telemetryConfigInSysSettings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODY2MjMw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#pullrequestreview-537866230", "createdAt": "2020-11-24T20:09:28Z", "commit": {"oid": "9519656ef2bd1f9960109249286c41331cdd7dfe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMDowOToyOFrOH5TXgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMDowOToyOFrOH5TXgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0ODE5Mg==", "bodyText": "why are you scheduling this? Just submit or execute it.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#discussion_r529848192", "createdAt": "2020-11-24T20:09:28Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/telemetry/TelemetryAgent.java", "diffHunk": "@@ -254,56 +266,78 @@ private void cancelJob(ScheduledFuture<?> future, Object lock, boolean immediate\n     }\n \n     @Override\n-    public void startup() throws InterruptedException {\n-        config.lookup(CONFIGURATION_CONFIG_KEY, TELEMETRY_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicAggregateMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicAggregateMetricsIntervalSec < DEFAULT_PERIODIC_AGGREGATE_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicAggregateMetricsIntervalAndSchedule(newPeriodicAggregateMetricsIntervalSec);\n-                });\n-        config.lookup(CONFIGURATION_CONFIG_KEY, TELEMETRY_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .dflt(DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC)\n-                .subscribe((why, newv) -> {\n-                    int newPeriodicPublishMetricsIntervalSec = Coerce.toInt(newv);\n-                    // Do not update the scheduled interval if it is less than the default.\n-                    if (newPeriodicPublishMetricsIntervalSec < DEFAULT_PERIODIC_PUBLISH_INTERVAL_SEC) {\n-                        return;\n-                    }\n-                    setPeriodicPublishMetricsIntervalAndScheduleTask(newPeriodicPublishMetricsIntervalSec);\n-                });\n-        updateThingNameAndPublishTopic(thingName);\n-        schedulePeriodicAggregateMetrics(false);\n-        schedulePeriodicPublishMetrics(false);\n-        mqttClient.addToCallbackEvents(callbacks);\n-        TestFeatureParameters.registerHandlerCallback(this.getName(), this::handleTestFeatureParametersHandlerChange);\n-        super.startup();\n+    public void postInject() {\n+        ses.schedule(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9519656ef2bd1f9960109249286c41331cdd7dfe"}, "originalPosition": 207}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70029002d63896a7c7f47a94f496e57049801b39", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/70029002d63896a7c7f47a94f496e57049801b39", "committedDate": "2020-11-25T00:06:08Z", "message": "PR comments."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "683a5dfe44adfd9c34531e87f2e43fcf5c55726e", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/683a5dfe44adfd9c34531e87f2e43fcf5c55726e", "committedDate": "2020-11-24T20:59:00Z", "message": "PR comments."}, "afterCommit": {"oid": "70029002d63896a7c7f47a94f496e57049801b39", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/70029002d63896a7c7f47a94f496e57049801b39", "committedDate": "2020-11-25T00:06:08Z", "message": "PR comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f5a912d79097528bbb30f49da758e711ea1c54c", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4f5a912d79097528bbb30f49da758e711ea1c54c", "committedDate": "2020-11-25T00:06:21Z", "message": "Merge branch 'master' into telemetryConfigInSysSettings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDY3MDI4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#pullrequestreview-538067028", "createdAt": "2020-11-25T00:18:47Z", "commit": {"oid": "4f5a912d79097528bbb30f49da758e711ea1c54c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e323616fd6498c68aa4e1eba1140cd7b8594ed4e", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e323616fd6498c68aa4e1eba1140cd7b8594ed4e", "committedDate": "2020-11-25T16:46:41Z", "message": "Merge branch 'master' into telemetryConfigInSysSettings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NzMwMzMz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/705#pullrequestreview-538730333", "createdAt": "2020-11-25T17:46:33Z", "commit": {"oid": "e323616fd6498c68aa4e1eba1140cd7b8594ed4e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad3bc3ff1ceeefaca8fd19129948b82481419e0f", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ad3bc3ff1ceeefaca8fd19129948b82481419e0f", "committedDate": "2020-11-25T22:20:42Z", "message": "Merge branch 'master' into telemetryConfigInSysSettings"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2720, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}