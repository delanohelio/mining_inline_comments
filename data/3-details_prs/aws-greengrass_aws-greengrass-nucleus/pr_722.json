{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MTY0MTYx", "number": 722, "title": "Recipe in json format", "bodyText": "Issue #, if available:\nDescription of changes:\nSupport the recipe sent from cloud in JSON format\nBut local storage is still in YAML format\nWhy is this change necessary:\nhttps://i.amazon.com/issues/GG-33458\navoid YAML truncation during transportation\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-24T04:28:50Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722", "merged": true, "mergeCommit": {"oid": "d303c4091597cbe159531f5a7e8e4c60e8a58409"}, "closed": true, "closedAt": "2020-11-25T23:38:51Z", "author": {"login": "wikimonkey"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfge6igH2gAyNTI2MTY0MTYxOmJkNzBjMTNjMmNiODBhMzdhM2U0OGI0MTQzOWQ4Y2U0N2NlMWFjZmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgG2fxAH2gAyNTI2MTY0MTYxOmM5ZjEyYzVlZjYxZGQyODE0M2M0ODJjYThkNjYyNzM0NTYyMWFiY2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bd70c13c2cb80a37a3e48b41439d8ce47ce1acfe", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bd70c13c2cb80a37a3e48b41439d8ce47ce1acfe", "committedDate": "2020-11-24T02:39:37Z", "message": "parse recipe in JSON format sent from cloud"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e4e7625cf34ba92648b98734775c33c6f2382bb", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3e4e7625cf34ba92648b98734775c33c6f2382bb", "committedDate": "2020-11-24T04:26:51Z", "message": "specify format when parsing recipe string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "700ca2eca339f11faef02c8239655ba93c934f91", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/700ca2eca339f11faef02c8239655ba93c934f91", "committedDate": "2020-11-24T04:31:05Z", "message": "correct typing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f58f3e0f3a6b746555fbcc3ffe14051a93a097", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/51f58f3e0f3a6b746555fbcc3ffe14051a93a097", "committedDate": "2020-11-24T04:32:26Z", "message": "remove unused file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NzA1ODk3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#pullrequestreview-537705897", "createdAt": "2020-11-24T16:42:38Z", "commit": {"oid": "51f58f3e0f3a6b746555fbcc3ffe14051a93a097"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjo0MjozOFrOH5LmcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjo0NTowNVrOH5LtNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyMDk0NQ==", "bodyText": "why change this? the id looks more correct from signature perspective.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r529720945", "createdAt": "2020-11-24T16:42:38Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -204,24 +204,39 @@ private ComponentIdentifier negotiateVersionWithCloud(String componentName,\n                             + \"satisfying requirement '%s'.\", componentName, versionRequirements), e);\n         }\n \n-        ComponentIdentifier resolvedComponentId =\n-                new ComponentIdentifier(resolvedComponentVersion.getComponentName(),\n-                        new Semver(resolvedComponentVersion.getComponentVersion()));\n+        ComponentIdentifier resolvedComponentId = new ComponentIdentifier(resolvedComponentVersion.getComponentName(),\n+                new Semver(resolvedComponentVersion.getComponentVersion()));\n         String downloadedRecipeContent = StandardCharsets.UTF_8.decode(resolvedComponentVersion.getRecipe()).toString();\n+        com.amazon.aws.iot.greengrass.component.common.ComponentRecipe downloadedRecipe;\n+        try {\n+            downloadedRecipe = RecipeLoader.parseRecipe(downloadedRecipeContent, RecipeLoader.RecipeFormat.JSON);\n+        } catch (PackageLoadingException e) {\n+            // TODO remove this backoff operation once cloud switch to send JSON recipe\n+            downloadedRecipe = RecipeLoader.parseRecipe(downloadedRecipeContent, RecipeLoader.RecipeFormat.YAML);\n+        }\n \n         // Save the recipe digest for plugin in a secure place, before persisting recipe\n-        storeRecipeDigestSecurelyForPlugin(resolvedComponentId, downloadedRecipeContent);\n+        storeRecipeDigestSecurelyForPlugin(downloadedRecipe, downloadedRecipeContent);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f58f3e0f3a6b746555fbcc3ffe14051a93a097"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyMjY3OQ==", "bodyText": "Ah! Could you do me favor and not change the signature now? Otherwise rebasing #697 is going to be very painful!!!", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r529722679", "createdAt": "2020-11-24T16:45:05Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -76,13 +76,17 @@ public ComponentStore(NucleusPaths nucleusPaths, PlatformResolver platformResolv\n     /**\n      * Creates or updates a package recipe in the package store on the disk.\n      *\n-     * @param pkgId         the id for the component\n-     * @param recipeContent recipe content to save\n+     * @param componentRecipe raw component recipe\n      * @throws PackageLoadingException if fails to write the package recipe to disk.\n      */\n-    void savePackageRecipe(@NonNull ComponentIdentifier pkgId, String recipeContent) throws PackageLoadingException {\n+    void saveComponentRecipe(@NonNull com.amazon.aws.iot.greengrass.component.common.ComponentRecipe componentRecipe)\n+            throws PackageLoadingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f58f3e0f3a6b746555fbcc3ffe14051a93a097"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85e3459812b1f47f03840cb1b6ca58ce112cf054", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/85e3459812b1f47f03840cb1b6ca58ce112cf054", "committedDate": "2020-11-24T17:37:32Z", "message": "add back savePackageRecipe method of component store, used by the other components"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c46cf6c9d0b2a1924ae1484463b92a281d0f0edb", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c46cf6c9d0b2a1924ae1484463b92a281d0f0edb", "committedDate": "2020-11-24T19:50:28Z", "message": "Merge remote-tracking branch 'origin/master' into recipe-in-json-format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6238bea352b821ab338b3088b831d372d59acc5", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b6238bea352b821ab338b3088b831d372d59acc5", "committedDate": "2020-11-24T19:54:11Z", "message": "fix broken unit tests from merging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93d8eebc4c5a334fffaa4190f66e8b0d8db8a98d", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/93d8eebc4c5a334fffaa4190f66e8b0d8db8a98d", "committedDate": "2020-11-24T20:08:34Z", "message": "Merge branch 'master' into recipe-in-json-format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c68c5e249b513f825d3d924ebcef26b670ab984", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9c68c5e249b513f825d3d924ebcef26b670ab984", "committedDate": "2020-11-25T00:05:00Z", "message": "Merge branch 'master' into recipe-in-json-format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6244521f0cb44ff5d7c2d50d27dd7ebd8d43ac7c", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6244521f0cb44ff5d7c2d50d27dd7ebd8d43ac7c", "committedDate": "2020-11-25T07:19:12Z", "message": "Merge branch 'master' into recipe-in-json-format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37159fc25ba5060e79606fcd7c3196d1dcc4145c", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/37159fc25ba5060e79606fcd7c3196d1dcc4145c", "committedDate": "2020-11-25T18:12:26Z", "message": "Merge branch 'master' into recipe-in-json-format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d7e47c3f2a84fa6becdcdb56bfd3ec6ec31624f", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7d7e47c3f2a84fa6becdcdb56bfd3ec6ec31624f", "committedDate": "2020-11-25T21:41:20Z", "message": "Merge branch 'master' into recipe-in-json-format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5647a214943746105d93a35ea3a46fc40ba70430", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5647a214943746105d93a35ea3a46fc40ba70430", "committedDate": "2020-11-25T22:29:59Z", "message": "Merge branch 'master' into recipe-in-json-format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODkwMTEx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#pullrequestreview-538890111", "createdAt": "2020-11-25T22:46:46Z", "commit": {"oid": "5647a214943746105d93a35ea3a46fc40ba70430"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODk2NjA2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#pullrequestreview-538896606", "createdAt": "2020-11-25T23:06:18Z", "commit": {"oid": "5647a214943746105d93a35ea3a46fc40ba70430"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMzowNjoxOFrOH6GhBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMzowNjoxOFrOH6GhBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4NjIxMw==", "bodyText": "Maybe check file suffix is better :)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r530686213", "createdAt": "2020-11-25T23:06:18Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/greengrass/componentmanager/converter/RecipeLoader.java", "diffHunk": "@@ -76,7 +94,8 @@ public RecipeLoader(PlatformResolver platformResolver) {\n      */\n     public Optional<ComponentRecipe> loadFromFile(String recipeFileContent) throws PackageLoadingException {\n \n-        com.amazon.aws.iot.greengrass.component.common.ComponentRecipe componentRecipe = parseRecipe(recipeFileContent);\n+        com.amazon.aws.iot.greengrass.component.common.ComponentRecipe componentRecipe =\n+                parseRecipe(recipeFileContent, RecipeFormat.YAML);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5647a214943746105d93a35ea3a46fc40ba70430"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODk3OTQ0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#pullrequestreview-538897944", "createdAt": "2020-11-25T23:10:33Z", "commit": {"oid": "5647a214943746105d93a35ea3a46fc40ba70430"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMzoxMDozM1rOH6GlhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMzoxMDozM1rOH6GlhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4NzM2NQ==", "bodyText": "Can we remove this method?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#discussion_r530687365", "createdAt": "2020-11-25T23:10:33Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -204,24 +204,39 @@ private ComponentIdentifier negotiateVersionWithCloud(String componentName,\n                             + \"satisfying requirement '%s'.\", componentName, versionRequirements), e);\n         }\n \n-        ComponentIdentifier resolvedComponentId =\n-                new ComponentIdentifier(resolvedComponentVersion.getComponentName(),\n-                        new Semver(resolvedComponentVersion.getComponentVersion()));\n+        ComponentIdentifier resolvedComponentId = new ComponentIdentifier(resolvedComponentVersion.getComponentName(),\n+                new Semver(resolvedComponentVersion.getComponentVersion()));\n         String downloadedRecipeContent = StandardCharsets.UTF_8.decode(resolvedComponentVersion.getRecipe()).toString();\n+        com.amazon.aws.iot.greengrass.component.common.ComponentRecipe downloadedRecipe;\n+        try {\n+            downloadedRecipe = RecipeLoader.parseRecipe(downloadedRecipeContent, RecipeLoader.RecipeFormat.JSON);\n+        } catch (PackageLoadingException e) {\n+            // TODO remove this backoff operation once cloud switch to send JSON recipe\n+            downloadedRecipe = RecipeLoader.parseRecipe(downloadedRecipeContent, RecipeLoader.RecipeFormat.YAML);\n+        }\n \n         // Save the recipe digest for plugin in a secure place, before persisting recipe\n-        storeRecipeDigestSecurelyForPlugin(resolvedComponentId, downloadedRecipeContent);\n+        storeRecipeDigestSecurelyForPlugin(downloadedRecipe, downloadedRecipeContent);\n \n         // Save the recipe\n         boolean saveContent = true;\n         Optional<String> recipeContentOnDevice = componentStore.findComponentRecipeContent(resolvedComponentId);\n \n-        if (recipeContentOnDevice.filter(recipe -> recipe.equals(downloadedRecipeContent)).isPresent()) {\n+        com.amazon.aws.iot.greengrass.component.common.ComponentRecipe finalDownloadedRecipe = downloadedRecipe;\n+        if (recipeContentOnDevice.map(recipeContent -> {\n+            try {\n+                return RecipeLoader.parseRecipe(recipeContent, RecipeLoader.RecipeFormat.YAML);\n+            } catch (PackageLoadingException e) {\n+                // if fail to parse local recipe, treat it as not presented\n+                logger.atDebug().setCause(e).kv(\"componentId\", resolvedComponentId).log(\"Failed to parse local recipe\");\n+                return null;\n+            }\n+        }).filter(recipe -> recipe.equals(finalDownloadedRecipe)).isPresent()) {\n             saveContent = false;\n         }\n \n         if (saveContent) {\n-            componentStore.savePackageRecipe(resolvedComponentId, downloadedRecipeContent);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5647a214943746105d93a35ea3a46fc40ba70430"}, "originalPosition": 116}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODk4MTcx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/722#pullrequestreview-538898171", "createdAt": "2020-11-25T23:11:18Z", "commit": {"oid": "5647a214943746105d93a35ea3a46fc40ba70430"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9f12c5ef61dd28143c482ca8d6627345621abcf", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c9f12c5ef61dd28143c482ca8d6627345621abcf", "committedDate": "2020-11-25T23:21:46Z", "message": "Merge branch 'master' into recipe-in-json-format"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2744, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}