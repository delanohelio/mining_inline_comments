{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMjkzMDk1", "number": 223, "title": "Dynamic config changes in deployments", "bodyText": "Issue #, if available:\nhttps://sim.amazon.com/issues/P35314981\nDescription of changes:\nChange default behavior for service config changes from always restarting service to restarting only when needed\nWhy is this change necessary:\nTo support deployments that change service config without restarting deployments\nhttps://quip-amazon.com/mld0ATVx17YK/Dynamically-reload-config-without-restarting-Evergreen-service\nHow was this change tested:\nInteg tests\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-05T03:57:36Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223", "merged": true, "mergeCommit": {"oid": "e503d73fbf5a3f9c85008bce5e5f17bbf2232ad8"}, "closed": true, "closedAt": "2020-05-07T17:26:20Z", "author": {"login": "shaguptashaikh"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceL8OigBqjMzMDI1MTA4OTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfAllNgFqTQwNzY3ODA2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e612ca72764b2412cfa59e5108afc99c66a5759d", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e612ca72764b2412cfa59e5108afc99c66a5759d", "committedDate": "2020-05-05T03:54:30Z", "message": "Dynamic config changes in deployments"}, "afterCommit": {"oid": "a077a93668fe2b72e198cc86362fc028b36470b6", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a077a93668fe2b72e198cc86362fc028b36470b6", "committedDate": "2020-05-05T03:58:25Z", "message": "Dynamic config changes in deployments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a077a93668fe2b72e198cc86362fc028b36470b6", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a077a93668fe2b72e198cc86362fc028b36470b6", "committedDate": "2020-05-05T03:58:25Z", "message": "Dynamic config changes in deployments"}, "afterCommit": {"oid": "5f6aeb6b949f0493079831b123de3ba6b8b694e1", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5f6aeb6b949f0493079831b123de3ba6b8b694e1", "committedDate": "2020-05-05T04:01:21Z", "message": "Dynamic config changes in deployments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f6aeb6b949f0493079831b123de3ba6b8b694e1", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5f6aeb6b949f0493079831b123de3ba6b8b694e1", "committedDate": "2020-05-05T04:01:21Z", "message": "Dynamic config changes in deployments"}, "afterCommit": {"oid": "040d6edd5f5a3cd40fd777e14b419236b5b3845b", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/040d6edd5f5a3cd40fd777e14b419236b5b3845b", "committedDate": "2020-05-05T16:54:34Z", "message": "Dynamic config changes in deployments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1OTg4MzY0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#pullrequestreview-405988364", "createdAt": "2020-05-05T17:08:01Z", "commit": {"oid": "5f6aeb6b949f0493079831b123de3ba6b8b694e1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzoxMjoyM1rOGQzZRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzoxNjo1NFrOGQzkrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI3MjQ1Mg==", "bodyText": "childOf(\"Dependencies\") is already handled in EvergreenService.initDependenciesTopic() .\nGenericExternalService should only handle lifecycle scripts change.\nc.subscribe((what, child) -> {\n  if (child.childOf(VERSION_CONFIG_KEY)) {\n    requestReinstall();\n  }\n  if (!child.childOf(\"lifecycle\")) {\n    return;\n  }\n  if (child.childOf(\"shutdown\")) {\n    return;\n  }\n  if (child.childOf(\"install\")) {\n    requestReinstall();\n    return; \n  }\n  requestRestart();\n}", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420272452", "createdAt": "2020-05-05T17:12:23Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -75,8 +75,11 @@ public GenericExternalService(Topics c) {\n                 requestReinstall();\n                 return;\n             }\n-            // By default for any change, just restart the service\n-            requestRestart();\n+\n+            // Restart service for changes to the lifecycle config or if dependencies changed\n+            if (child.childOf(\"lifecycle\") || child.childOf(\"dependencies\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "040d6edd5f5a3cd40fd777e14b419236b5b3845b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI3NDI4OA==", "bodyText": "why we need a for loop here? can we simplify it to\nresolvedServiceConfig.put(CUSTOM_CONFIG_NAMESPACE, interpolate(packageRecipe.getCustomConfig(), resolvedParams);", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420274288", "createdAt": "2020-05-05T17:15:07Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -92,6 +92,12 @@\n         for (Map.Entry<String, Object> configKVPair : packageRecipe.getLifecycle().entrySet()) {\n             resolvedLifecycleConfig.put(configKVPair.getKey(), interpolate(configKVPair.getValue(), resolvedParams));\n         }\n+        resolvedServiceConfig.put(EvergreenService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC, resolvedLifecycleConfig);\n+\n+        for (Map.Entry<String, Object> configKVPair : packageRecipe.getCustomConfig().entrySet()) {\n+            resolvedCustomConfig.put(configKVPair.getKey(), interpolate(configKVPair.getValue(), resolvedParams));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "040d6edd5f5a3cd40fd777e14b419236b5b3845b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI3NTM3NQ==", "bodyText": "mismatch in @JsonProperty and field name customConfig ?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420275375", "createdAt": "2020-05-05T17:16:54Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/PackageRecipe.java", "diffHunk": "@@ -88,7 +80,8 @@ public PackageRecipe(@JsonProperty(\"RecipeTemplateVersion\") RecipeTemplateVersio\n                          @JsonProperty(\"Artifacts\") List<String> artifacts,\n                          @JsonProperty(\"Dependencies\") @JsonDeserialize(\n                                  using = MapFieldDeserializer.class) Map<String, String> dependencies,\n-                         @JsonProperty(\"Requires\") List<String> requires) {\n+                         @JsonProperty(\"Lifecycle\") @JsonDeserialize(\n+                                 using = MapFieldDeserializer.class) Map<String, Object> customConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "040d6edd5f5a3cd40fd777e14b419236b5b3845b"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1OTk4NDg4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#pullrequestreview-405998488", "createdAt": "2020-05-05T17:21:13Z", "commit": {"oid": "040d6edd5f5a3cd40fd777e14b419236b5b3845b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzoyMToxM1rOGQzvQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzoyMToxM1rOGQzvQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI3ODA4Mw==", "bodyText": "don't change this. This test is purposefully changing setenv. Change your implementation to work with this test.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420278083", "createdAt": "2020-05-05T17:21:13Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -123,18 +124,17 @@ void GIVEN_kernel_running_single_service_WHEN_merge_changes_service_THEN_service\n         deploymentConfigMerger.mergeInNewConfig(testDeploymentDocument(), new HashMap<Object, Object>() {{\n             put(SERVICES_NAMESPACE_TOPIC, new HashMap<Object, Object>() {{\n                 put(\"main\", new HashMap<Object, Object>() {{\n-                    put(\"setenv\", new HashMap<Object, Object>() {{\n-                        put(\"HELLO\", \"redefined\");\n+                    put(\"lifecycle\", new HashMap<Object, Object>() {{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "040d6edd5f5a3cd40fd777e14b419236b5b3845b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1OTk4ODE3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#pullrequestreview-405998817", "createdAt": "2020-05-05T17:21:43Z", "commit": {"oid": "040d6edd5f5a3cd40fd777e14b419236b5b3845b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzoyMTo0M1rOGQzwSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzoyMTo0M1rOGQzwSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI3ODM0Nw==", "bodyText": "when future complete, the deployment already finished. You don't need a countDownlatch for serviceWithCustomConfigRestarted, boolean should be enough", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420278347", "createdAt": "2020-05-05T17:21:43Z", "author": {"login": "ShirleyZheng92"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -466,6 +466,47 @@ void GIVEN_a_running_service_is_not_disruptable_WHEN_deployed_THEN_deployment_wa\n         }\n     }\n \n+    @Test\n+    void GIVEN_a_running_service_has_custom_config_WHEN_deployed_THEN_service_does_not_restart() throws Throwable {\n+        // GIVEN\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"service_with_custom_config.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch mainRunning = new CountDownLatch(1);\n+        kernel.getMain().getStateTopic().subscribe((WhatHappened what, Topic t) -> {\n+            if (t.getOnce().equals(State.RUNNING)) {\n+                mainRunning.countDown();\n+            }\n+        });\n+\n+        // wait for main to finish\n+        assertTrue(mainRunning.await(10, TimeUnit.SECONDS));\n+\n+        CountDownLatch serviceWithCustomConfigRestarted = new CountDownLatch(1);\n+\n+        kernel.getContext().addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"service_with_custom_config\") && newState.equals(State.INSTALLED)) {\n+                serviceWithCustomConfigRestarted.countDown();\n+            }\n+        });\n+\n+        Map<Object, Object> kernelConfig = new HashMap<>(kernel.getConfig().toPOJO());\n+        Map<String, Map> servicesConfig = (Map<String, Map>) kernelConfig.get(SERVICES_NAMESPACE_TOPIC);\n+        Map<String, Object> serviceWithCustomConfigDef = (Map<String, Object>) servicesConfig.get(\"service_with_custom_config\");\n+        Map<String, Object> customConfig = (Map<String, Object>) serviceWithCustomConfigDef.get(CUSTOM_CONFIG_NAMESPACE);\n+        customConfig.put(\"my_custom_key\", \"my_custom_changed_value\");\n+\n+        Future<DeploymentResult> future =\n+                deploymentConfigMerger.mergeInNewConfig(testDeploymentDocument(), kernelConfig);\n+\n+        future.get(20, TimeUnit.SECONDS);\n+\n+        // Service won't see any change in state\n+        assertFalse(serviceWithCustomConfigRestarted.await(60, TimeUnit.SECONDS));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "040d6edd5f5a3cd40fd777e14b419236b5b3845b"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1OTk5Mjg3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#pullrequestreview-405999287", "createdAt": "2020-05-05T17:22:19Z", "commit": {"oid": "040d6edd5f5a3cd40fd777e14b419236b5b3845b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzoyMjoyMFrOGQzxwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNzoyMjoyMFrOGQzxwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI3ODcyMg==", "bodyText": "this test will take 60 seconds no matter what. Can we have a better way that doesn't take 1 minute?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420278722", "createdAt": "2020-05-05T17:22:20Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -466,6 +466,47 @@ void GIVEN_a_running_service_is_not_disruptable_WHEN_deployed_THEN_deployment_wa\n         }\n     }\n \n+    @Test\n+    void GIVEN_a_running_service_has_custom_config_WHEN_deployed_THEN_service_does_not_restart() throws Throwable {\n+        // GIVEN\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"service_with_custom_config.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch mainRunning = new CountDownLatch(1);\n+        kernel.getMain().getStateTopic().subscribe((WhatHappened what, Topic t) -> {\n+            if (t.getOnce().equals(State.RUNNING)) {\n+                mainRunning.countDown();\n+            }\n+        });\n+\n+        // wait for main to finish\n+        assertTrue(mainRunning.await(10, TimeUnit.SECONDS));\n+\n+        CountDownLatch serviceWithCustomConfigRestarted = new CountDownLatch(1);\n+\n+        kernel.getContext().addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"service_with_custom_config\") && newState.equals(State.INSTALLED)) {\n+                serviceWithCustomConfigRestarted.countDown();\n+            }\n+        });\n+\n+        Map<Object, Object> kernelConfig = new HashMap<>(kernel.getConfig().toPOJO());\n+        Map<String, Map> servicesConfig = (Map<String, Map>) kernelConfig.get(SERVICES_NAMESPACE_TOPIC);\n+        Map<String, Object> serviceWithCustomConfigDef = (Map<String, Object>) servicesConfig.get(\"service_with_custom_config\");\n+        Map<String, Object> customConfig = (Map<String, Object>) serviceWithCustomConfigDef.get(CUSTOM_CONFIG_NAMESPACE);\n+        customConfig.put(\"my_custom_key\", \"my_custom_changed_value\");\n+\n+        Future<DeploymentResult> future =\n+                deploymentConfigMerger.mergeInNewConfig(testDeploymentDocument(), kernelConfig);\n+\n+        future.get(20, TimeUnit.SECONDS);\n+\n+        // Service won't see any change in state\n+        assertFalse(serviceWithCustomConfigRestarted.await(60, TimeUnit.SECONDS));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "040d6edd5f5a3cd40fd777e14b419236b5b3845b"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MjM1NTAz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#pullrequestreview-406235503", "createdAt": "2020-05-06T00:05:00Z", "commit": {"oid": "6c4a81d044272522b5a287eac634784cff563c67"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwMDowNTowMFrOGQ_9OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwMDoxNjoyMFrOGRAJbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3ODI2NQ==", "bodyText": "Add similar tests for updating version and other stuff to make sure that it does do the restart/reinstall?\nNot blocking this PR.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420478265", "createdAt": "2020-05-06T00:05:00Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -64,4 +70,35 @@ void GIVEN_service_with_timeout_WHEN_timeout_expires_THEN_move_service_to_errore\n         assertTrue(ServicesAErroredLatch.await(5, TimeUnit.SECONDS));\n         assertTrue(ServicesBErroredLatch.await(5, TimeUnit.SECONDS));\n     }\n+\n+    @Test\n+    void GIVEN_service_with_dynamically_loaded_config_WHEN_dynamic_config_changes_THEN_service_does_not_restart()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4a81d044272522b5a287eac634784cff563c67"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3ODYwOA==", "bodyText": "Please make sure all references in code to \"setenv\" are updated to this const. (I haven't looked through your changes yet, but please do ensure they're all changed.)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420478608", "createdAt": "2020-05-06T00:06:22Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -40,6 +40,8 @@\n     public static final String SERVICES_NAMESPACE_TOPIC = \"services\";\n     public static final String SERVICE_LIFECYCLE_NAMESPACE_TOPIC = \"lifecycle\";\n     public static final String SERVICE_NAME_KEY = \"serviceName\";\n+    public static final String CUSTOM_CONFIG_NAMESPACE = \"custom\";\n+    public static final String SETENV_CONFIG_NAMESPACE = \"setenv\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4a81d044272522b5a287eac634784cff563c67"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3OTAzNw==", "bodyText": "Yes, they definitely should be.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420479037", "createdAt": "2020-05-06T00:07:56Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -92,6 +93,15 @@\n         for (Map.Entry<String, Object> configKVPair : packageRecipe.getLifecycle().entrySet()) {\n             resolvedLifecycleConfig.put(configKVPair.getKey(), interpolate(configKVPair.getValue(), resolvedParams));\n         }\n+        resolvedServiceConfig.put(EvergreenService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC, resolvedLifecycleConfig);\n+\n+        for (Map.Entry<String, Object> configKVPair : packageRecipe.getCustomConfig().entrySet()) {\n+            resolvedCustomConfig.put(configKVPair.getKey(), interpolate(configKVPair.getValue(), resolvedParams));\n+        }\n+        resolvedServiceConfig.put(CUSTOM_CONFIG_NAMESPACE, resolvedCustomConfig);\n+\n+        // TODO : Should environment variables be configurable using package parameters?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4a81d044272522b5a287eac634784cff563c67"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ4MTM4OQ==", "bodyText": "Should these be converted over to dependencies?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420481389", "createdAt": "2020-05-06T00:16:20Z", "author": {"login": "MikeDombo"}, "path": "src/test/resources/com/aws/iot/evergreen/packagemanager/test_packages/MonitoringService-1.0.0/recipe.yaml", "diffHunk": "@@ -30,5 +30,4 @@ Dependencies:\n     Cool-Database: '1.0'\n   macos:\n     mac-log: '1.0'\n-Requires:\n-  - homebrew\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4a81d044272522b5a287eac634784cff563c67"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MjQ0NjI2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#pullrequestreview-406244626", "createdAt": "2020-05-06T00:36:39Z", "commit": {"oid": "6c4a81d044272522b5a287eac634784cff563c67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwMDozNjozOVrOGRAe-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwMDozNjozOVrOGRAe-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ4NjkwNQ==", "bodyText": "instead of sleeping here, if you run a callback on the publish thread then you can be assured that your config change is done with all of its callbacks and perform the verify at that point. But be aware that any assertions you put into the publish thread won't work; you'll need another way of failing the test if they fail, such as a future or countdownlatch.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r420486905", "createdAt": "2020-05-06T00:36:39Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -64,4 +70,35 @@ void GIVEN_service_with_timeout_WHEN_timeout_expires_THEN_move_service_to_errore\n         assertTrue(ServicesAErroredLatch.await(5, TimeUnit.SECONDS));\n         assertTrue(ServicesBErroredLatch.await(5, TimeUnit.SECONDS));\n     }\n+\n+    @Test\n+    void GIVEN_service_with_dynamically_loaded_config_WHEN_dynamic_config_changes_THEN_service_does_not_restart()\n+            throws Exception {\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"service_with_dynamic_config.yaml\").toString());\n+        CountDownLatch mainRunning = new CountDownLatch(1);\n+        kernel.getContext().addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"main\") && newState.equals(State.RUNNING)) {\n+                mainRunning.countDown();\n+            }\n+        });\n+        kernel.launch();\n+\n+        assertTrue(mainRunning.await(5, TimeUnit.SECONDS));\n+\n+        GenericExternalService service = spy((GenericExternalService) kernel.locate(\"service_with_dynamic_config\"));\n+        assertEquals(State.RUNNING, service.getState());\n+\n+        Topics serviceConfig = service.getServiceConfig();\n+\n+        serviceConfig.find(\"custom\", \"my_custom_key\").withValue(\"my_custom_initial_value\");\n+\n+        // Wait for the published topic update to be processed\n+        Thread.sleep(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4a81d044272522b5a287eac634784cff563c67"}, "originalPosition": 51}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c4a81d044272522b5a287eac634784cff563c67", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6c4a81d044272522b5a287eac634784cff563c67", "committedDate": "2020-05-05T23:58:31Z", "message": "Addressed comments"}, "afterCommit": {"oid": "fedcc13b83256221208eb354ef82db801facc572", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fedcc13b83256221208eb354ef82db801facc572", "committedDate": "2020-05-07T02:21:23Z", "message": "Dynamic config changes in deployments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MTE5NTM4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#pullrequestreview-407119538", "createdAt": "2020-05-07T03:02:33Z", "commit": {"oid": "fedcc13b83256221208eb354ef82db801facc572"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMzowMjozM1rOGRssZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwMzowMjozM1rOGRssZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMTIzNg==", "bodyText": "Not needed in this PR, but do we interpolate for everything? ie. Can I reference package parameters in my run: or install: or any other lifecycle? I think we ought to if we don't so that customers can pass in data through command line args instead of only environment variables.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#discussion_r421211236", "createdAt": "2020-05-07T03:02:33Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -78,20 +80,27 @@\n         PackageRecipe packageRecipe = packageStore.getPackageRecipe(packageIdentifier);\n \n         Map<Object, Object> resolvedServiceConfig = new HashMap<>();\n-        Map<Object, Object> resolvedLifecycleConfig = new HashMap<>();\n-\n-        resolvedServiceConfig.put(EvergreenService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC, resolvedLifecycleConfig);\n-\n-        // TODO : Package recipe format is not in alignment with the changed Kernel config syntax,\n-        // which leads to inconsistent naming, e.g. lifecycle per new Kernel config syntax is one of several config\n-        // keys while per current package recipe format it's the entire config for that package\n-        // These inconsistencies need to be addressed\n \n         // Interpolate parameters\n+        Map<Object, Object> resolvedLifecycleConfig = new HashMap<>();\n         Set<PackageParameter> resolvedParams = resolveParameterValuesToUse(document, packageRecipe);\n         for (Map.Entry<String, Object> configKVPair : packageRecipe.getLifecycle().entrySet()) {\n             resolvedLifecycleConfig.put(configKVPair.getKey(), interpolate(configKVPair.getValue(), resolvedParams));\n         }\n+        resolvedServiceConfig.put(EvergreenService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC, resolvedLifecycleConfig);\n+\n+        Map<Object, Object> resolvedCustomConfig = new HashMap<>();\n+        for (Map.Entry<String, Object> configKVPair : packageRecipe.getCustomConfig().entrySet()) {\n+            resolvedCustomConfig.put(configKVPair.getKey(), interpolate(configKVPair.getValue(), resolvedParams));\n+        }\n+        resolvedServiceConfig.put(CUSTOM_CONFIG_NAMESPACE, resolvedCustomConfig);\n+\n+        Map<String, String> resolvedSetEnvConfig = new HashMap<>();\n+        for (Map.Entry<String, String> configKVPair : packageRecipe.getEnvironmentVariables().entrySet()) {\n+            resolvedSetEnvConfig.put(configKVPair.getKey(), (String) interpolate(configKVPair.getValue(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fedcc13b83256221208eb354ef82db801facc572"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28cf6124ddeee0571bff0d10abbefb122170fcb8", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/28cf6124ddeee0571bff0d10abbefb122170fcb8", "committedDate": "2020-05-07T16:29:40Z", "message": "Dynamic config changes in deployments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fedcc13b83256221208eb354ef82db801facc572", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fedcc13b83256221208eb354ef82db801facc572", "committedDate": "2020-05-07T02:21:23Z", "message": "Dynamic config changes in deployments"}, "afterCommit": {"oid": "28cf6124ddeee0571bff0d10abbefb122170fcb8", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/28cf6124ddeee0571bff0d10abbefb122170fcb8", "committedDate": "2020-05-07T16:29:40Z", "message": "Dynamic config changes in deployments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NjQzMTM3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#pullrequestreview-407643137", "createdAt": "2020-05-07T16:32:52Z", "commit": {"oid": "28cf6124ddeee0571bff0d10abbefb122170fcb8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3Njc4MDY2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/223#pullrequestreview-407678066", "createdAt": "2020-05-07T17:18:47Z", "commit": {"oid": "28cf6124ddeee0571bff0d10abbefb122170fcb8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2173, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}