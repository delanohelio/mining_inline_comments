{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyMDg1ODg1", "number": 581, "title": "Integrate create deployment", "bodyText": "Issue #, if available:\nDescription of changes:\nCo-authored with @ShirleyZheng92\n\nIntegrate with new FCS\u2019s CreateDeployment\nFlip to new GCS xxxComponentVersion API\nparameters  -> DefaultConfiguration in updated E2E test.\n\nSorry this becomes a big PR but changes are straightforward. The only place needs people to pay some attention is the new converter which converts the new data plane\u2019s contract with FCS to nucleus\u2019s core deployment document: link\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-29T07:48:49Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581", "merged": true, "mergeCommit": {"oid": "d8b2128e3889fd68efd6e066449e5f69fdd032da"}, "closed": true, "closedAt": "2020-11-04T02:36:37Z", "author": {"login": "leaf94"}, "timelineItems": {"totalCount": 50, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXA8eggH2gAyNTEyMDg1ODg1OjFlZTc0OTY4ODRlYjlkNjQ5MzJlOGZjZWQ4M2UyOWZmMjNmZWY0MWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZEK6ggFqTUyMzAwMDQwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ee7496884eb9d64932e8fced83e29ff23fef41a", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1ee7496884eb9d64932e8fced83e29ff23fef41a", "committedDate": "2020-10-28T17:23:33Z", "message": "initial commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "800b2e36cd2d27bc29f125cbe61c3b92abc5d2ed", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/800b2e36cd2d27bc29f125cbe61c3b92abc5d2ed", "committedDate": "2020-10-29T07:48:11Z", "message": "yes. it works."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6586cdb2682300b836b83fbff3924d9e38da9b85", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6586cdb2682300b836b83fbff3924d9e38da9b85", "committedDate": "2020-10-29T08:02:42Z", "message": "pmd"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc9a6b12ea5f4df8b7d03e77bb95eeb570d08526", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dc9a6b12ea5f4df8b7d03e77bb95eeb570d08526", "committedDate": "2020-10-30T05:35:21Z", "message": "Updated e2e tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2c547be04a8ae278187a9a203ef1ed5be58dd17", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f2c547be04a8ae278187a9a203ef1ed5be58dd17", "committedDate": "2020-10-30T18:28:45Z", "message": "Update integ&e2e test recipe"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8e81f26babd9a3999f18e4d038b3b38dd71cbb3", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f8e81f26babd9a3999f18e4d038b3b38dd71cbb3", "committedDate": "2020-10-30T17:33:35Z", "message": "Update integ&e2e test recipe"}, "afterCommit": {"oid": "f2c547be04a8ae278187a9a203ef1ed5be58dd17", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f2c547be04a8ae278187a9a203ef1ed5be58dd17", "committedDate": "2020-10-30T18:28:45Z", "message": "Update integ&e2e test recipe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5205b7fc96386ff32657e9fe4f3f41867e59ee9", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d5205b7fc96386ff32657e9fe4f3f41867e59ee9", "committedDate": "2020-10-30T22:17:21Z", "message": "finish unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3df199f283df2d62b0b5a55fb5c92940a53f067", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b3df199f283df2d62b0b5a55fb5c92940a53f067", "committedDate": "2020-10-30T22:17:33Z", "message": "Merge branch 'integrate_create_deployment' of github.com:aws/aws-greengrass-kernel into integrate_create_deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "166d534baecbe117001e0b12e169e0ef1f45167e", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/166d534baecbe117001e0b12e169e0ef1f45167e", "committedDate": "2020-10-30T23:04:27Z", "message": "more tests migration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f60e7972f31cee301029f0c83e7c85130ab494e3", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f60e7972f31cee301029f0c83e7c85130ab494e3", "committedDate": "2020-11-02T20:18:50Z", "message": "update to use latest AWS SDK with brazil artifact version 1.0.354"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6db62a38035ae67a9ab04637f03f3f97454a1a5", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6db62a38035ae67a9ab04637f03f3f97454a1a5", "committedDate": "2020-11-02T20:29:14Z", "message": "Merge remote-tracking branch 'origin/master' into integrate_create_deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33ec0923719130df995722b7e77d1d61ed2eee92", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/33ec0923719130df995722b7e77d1d61ed2eee92", "committedDate": "2020-11-02T20:29:31Z", "message": "merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "622338f8f20f6faed7ee371b00a6ec40432ed572", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/622338f8f20f6faed7ee371b00a6ec40432ed572", "committedDate": "2020-11-02T20:34:50Z", "message": "merge fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd8849ab08252bfe6c87f6dee6bc69026d0017e8", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dd8849ab08252bfe6c87f6dee6bc69026d0017e8", "committedDate": "2020-11-02T21:40:23Z", "message": "Merge branch 'master' into integrate_create_deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a167e0d9c24e52026044c77b3d6ca39ed5be1d6", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4a167e0d9c24e52026044c77b3d6ca39ed5be1d6", "committedDate": "2020-11-03T06:23:43Z", "message": "Merge branch 'master' into integrate_create_deployment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMjI4MDIw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522228020", "createdAt": "2020-11-03T07:09:58Z", "commit": {"oid": "4a167e0d9c24e52026044c77b3d6ca39ed5be1d6"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwNzowOTo1OFrOHsiNlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwNzowOTo1OFrOHsiNlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ1OTkyNw==", "bodyText": "Too many auto formatting :) Here is the real change.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516459927", "createdAt": "2020-11-03T07:09:58Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -465,9 +467,24 @@ private DeploymentDocument parseAndValidateJobDocument(Deployment deployment) th\n                     break;\n                 case IOT_JOBS:\n                 case SHADOW:\n-                    FleetConfiguration config = SerializerFactory.getJsonObjectMapper()\n-                            .readValue(jobDocumentString, FleetConfiguration.class);\n-                    document = DeploymentDocumentConverter.convertFromFleetConfiguration(config);\n+                    JsonNode jsonNode =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a167e0d9c24e52026044c77b3d6ca39ed5be1d6"}, "originalPosition": 221}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36a71253de3cb6d29647cc90135ebf3b5a0a75e3", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/36a71253de3cb6d29647cc90135ebf3b5a0a75e3", "committedDate": "2020-11-03T07:50:32Z", "message": "Small fix on DeploymentE2ETest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e3410acdc946e96770ffdfa6158f11492f16ea3", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0e3410acdc946e96770ffdfa6158f11492f16ea3", "committedDate": "2020-11-03T18:21:12Z", "message": "Merge remote-tracking branch 'origin/master' into integrate_create_deployment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36a71253de3cb6d29647cc90135ebf3b5a0a75e3", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/36a71253de3cb6d29647cc90135ebf3b5a0a75e3", "committedDate": "2020-11-03T07:50:32Z", "message": "Small fix on DeploymentE2ETest"}, "afterCommit": {"oid": "047f5f242fe57e894ed35b1a5772cc08db2fef34", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/047f5f242fe57e894ed35b1a5772cc08db2fef34", "committedDate": "2020-11-03T18:28:16Z", "message": "Small fix on DeploymentE2ETest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c71c112f5c1724ed2258ecf9683d9f2621074ba9", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c71c112f5c1724ed2258ecf9683d9f2621074ba9", "committedDate": "2020-11-03T19:14:01Z", "message": "works now"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e55074e1b595bb6917159f2904995b20a194bad", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3e55074e1b595bb6917159f2904995b20a194bad", "committedDate": "2020-11-03T19:01:27Z", "message": "Merge branch 'master' into integrate_create_deployment"}, "afterCommit": {"oid": "c71c112f5c1724ed2258ecf9683d9f2621074ba9", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c71c112f5c1724ed2258ecf9683d9f2621074ba9", "committedDate": "2020-11-03T19:14:01Z", "message": "works now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bb0415d3e46175d4d144f1bebeb778e7d3ed770", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6bb0415d3e46175d4d144f1bebeb778e7d3ed770", "committedDate": "2020-11-03T20:08:44Z", "message": "minor fix for pending actin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d1335d897d18367668cc3895bc6a2b26e5358067", "committedDate": "2020-11-03T20:09:59Z", "message": "minor fix for pending actin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODU4NTU3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522858557", "createdAt": "2020-11-03T20:41:12Z", "commit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMDo0MToxMlrOHs_suA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMDo0NjoyNVrOHs_2Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0MzAzMg==", "bodyText": "Do we have an enum yet for these target types?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516943032", "createdAt": "2020-11-03T20:41:12Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -372,38 +370,34 @@ private static void cleanUpTestComponentArtifactsFromS3() {\n     }\n \n     @SuppressWarnings(\"PMD.LinguisticNaming\")\n-    protected PublishConfigurationResult setAndPublishFleetConfiguration(SetConfigurationRequest setRequest) {\n+    protected CreateDeploymentResult draftAndCreateDeployment(CreateDeploymentRequest createDeploymentRequest) {\n \n         // update package name with random suffix to avoid conflict in cloud\n-        Map<String, PackageMetaData> updatedPkgMetadata = new HashMap<>();\n-        setRequest.getPackages().forEach((key, val) -> updatedPkgMetadata.put(getTestComponentNameInCloud(key), val));\n-        setRequest.setPackages(updatedPkgMetadata);\n+        Map<String, ComponentInfo> updatedPkgMetadata = new HashMap<>();\n+        createDeploymentRequest.getComponents().forEach((key, val) -> updatedPkgMetadata.put(getTestComponentNameInCloud(key), val));\n+        createDeploymentRequest.setComponents(updatedPkgMetadata);\n \n         // set default value\n-        if (setRequest.getDeploymentPolicies() == null) {\n-            setRequest.withDeploymentPolicies(new DeploymentPolicies()\n-                    .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120))\n-                    .withComponentUpdatePolicy(\n-                            new ComponentUpdatePolicy().withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS)\n-                                    .withTimeout(120))\n-                    .withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING));\n+        if (createDeploymentRequest.getTargetName() == null) {\n+            createDeploymentRequest.withTargetName(thingGroupName);\n         }\n-\n-        logger.atInfo().kv(\"setRequest\", setRequest).log();\n-        SetConfigurationResult setResult = greengrassClient.setConfiguration(setRequest);\n-        logger.atInfo().kv(\"setResult\", setResult).log();\n-\n-        PublishConfigurationRequest publishRequest = new PublishConfigurationRequest()\n-                .withTargetName(setRequest.getTargetName())\n-                .withTargetType(setRequest.getTargetType())\n-                .withRevisionId(setResult.getRevisionId());\n-        logger.atInfo().kv(\"publishRequest\", publishRequest).log();\n-        PublishConfigurationResult publishResult = greengrassClient.publishConfiguration(publishRequest);\n-        logger.atInfo().kv(\"publishResult\", publishResult).log();\n-        if (setRequest.getTargetType().equals(THING_GROUP_TARGET_TYPE)) {\n-            createdIotJobIds.add(publishResult.getJobId());\n+        if (createDeploymentRequest.getTargetType() == null) {\n+            createDeploymentRequest.withTargetType(THING_GROUP_TARGET_TYPE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NTMxMQ==", "bodyText": "why is this the default? Should the default be to wait forever?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516945311", "createdAt": "2020-11-03T20:46:00Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/deployment/model/ComponentUpdatePolicy.java", "diffHunk": "@@ -23,8 +23,9 @@\n @EqualsAndHashCode\n @ToString\n public class ComponentUpdatePolicy {\n+\n     @JsonProperty(\"Timeout\")\n-    private Integer timeout;\n+    private Integer timeout = 60;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NTUwMw==", "bodyText": "not sure this is the correct default.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516945503", "createdAt": "2020-11-03T20:46:25Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/deployment/model/DeploymentDocument.java", "diffHunk": "@@ -51,10 +51,12 @@\n     private Long timestamp;\n \n     @JsonProperty(\"FailureHandlingPolicy\")\n-    private FailureHandlingPolicy failureHandlingPolicy;\n+    @Builder.Default\n+    private FailureHandlingPolicy failureHandlingPolicy = FailureHandlingPolicy.ROLLBACK;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODYzODA4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522863808", "createdAt": "2020-11-03T20:50:00Z", "commit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMDo1MDowMFrOHs_9WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMDo1MDowMFrOHs_9WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NzI4OQ==", "bodyText": "change these to the new format too: {artifacts:path} so we can get rid of the old format soon.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516947289", "createdAt": "2020-11-03T20:50:00Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/resources/com/aws/greengrass/integrationtests/ipc/recipes/Component1-1.0.0.yaml", "diffHunk": "@@ -3,19 +3,22 @@ ComponentName: Component1\n ComponentDescription: Test Component\n ComponentPublisher: Me\n ComponentVersion: '1.0.0'\n+ComponentConfiguration:\n+  DefaultConfiguration:\n+    Message: 'World'\n+\n Manifests:\n+  - Platform:\n+      os: windows\n+    Lifecycle:\n+      run: |-\n+        powershell -command echo {configuration:/Message}; sleep -m 100\n+    Artifacts:\n+      - URI: greengrass:run.sh\n   - Platform:\n       os: all\n-    Parameters:\n-      - name: Message\n-        value: 'World'\n-        type: STRING\n     Lifecycle:\n-      run:\n-        windows:\n-          powershell -command echo {{params:Message.value}}; sleep -m 100\n-        posix:\n-          sh {{artifacts:path}}/run.sh; echo {{params:Message.value}}; sleep 100\n-\n+      run: |-\n+        sh {{artifacts:path}}/run.sh; echo {configuration:/Message}; sleep 100", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODY0MjYx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522864261", "createdAt": "2020-11-03T20:50:49Z", "commit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMDo1MDo0OVrOHs_-0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMDo1MDo0OVrOHs_-0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0NzY2Nw==", "bodyText": "flip this .equals so that a NPE isn't possible", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516947667", "createdAt": "2020-11-03T20:50:49Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -197,17 +200,17 @@ protected void startup() throws InterruptedException {\n                 if (deployment.getDeploymentType().equals(DeploymentType.SHADOW)) {\n                     // A new device deployment invalidates the previous deployment, cancel the ongoing device deployment\n                     // and wait till the new device deployment can be picked up.\n-                    if (currentDeploymentTaskMetadata != null\n-                            && currentDeploymentTaskMetadata.getDeploymentType().equals(DeploymentType.SHADOW)) {\n+                    if (currentDeploymentTaskMetadata != null && currentDeploymentTaskMetadata.getDeploymentType()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODY0NjM3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522864637", "createdAt": "2020-11-03T20:51:25Z", "commit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMDo1MToyNVrOHtAAGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMDo1MToyNVrOHtAAGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk0Nzk5Mw==", "bodyText": "needs a space before the need", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r516947993", "createdAt": "2020-11-03T20:51:25Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -356,13 +358,13 @@ private void cancelCurrentDeployment() {\n                 } else {\n                     logger.atInfo().kv(DEPLOYMENT_ID_LOG_KEY_NAME, currentDeploymentTaskMetadata.getDeploymentId())\n                             .log(\"Deployment is in a stage where it cannot be cancelled,\"\n-                                    + \"need to wait for it to finish\");\n+                                         + \"need to wait for it to finish\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1335d897d18367668cc3895bc6a2b26e5358067"}, "originalPosition": 148}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6717c926fa87bc03416625e51e263840ecf85cd9", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6717c926fa87bc03416625e51e263840ecf85cd9", "committedDate": "2020-11-03T20:53:56Z", "message": "fix on DeploymentE2ETest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b69e1ba2035ba0c7878db775bcafe92f1cf4cbd", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0b69e1ba2035ba0c7878db775bcafe92f1cf4cbd", "committedDate": "2020-11-03T21:08:12Z", "message": "Merge remote-tracking branch 'origin/master' into integrate_create_deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc22e971f3ea63a27e05fd9c8bdb2a2c98d27fa", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dcc22e971f3ea63a27e05fd9c8bdb2a2c98d27fa", "committedDate": "2020-11-03T21:25:16Z", "message": "Merge branch 'master' into integrate_create_deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "341e49c76fa7e3b4d56f13c8f21b9c862589df4a", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/341e49c76fa7e3b4d56f13c8f21b9c862589df4a", "committedDate": "2020-11-03T21:32:55Z", "message": "pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b3f69574af3b5eb1fe824c9a7b2d31ab5d67cda", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0b3f69574af3b5eb1fe824c9a7b2d31ab5d67cda", "committedDate": "2020-11-04T00:21:29Z", "message": "minor fix with Ashay's help"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81ca90fa8f98e3b0ad9341a899e6894f2eba0697", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/81ca90fa8f98e3b0ad9341a899e6894f2eba0697", "committedDate": "2020-11-04T00:27:55Z", "message": "Merge branch 'master' into integrate_create_deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5aa4bd11a94d818d44ea2f49d6e76d44eac8ede2", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5aa4bd11a94d818d44ea2f49d6e76d44eac8ede2", "committedDate": "2020-11-04T00:58:40Z", "message": "my bad. committed wrong code. It will pass this time."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "358a102b80099fed7e22034de61785cf38f56172", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/358a102b80099fed7e22034de61785cf38f56172", "committedDate": "2020-11-04T01:00:04Z", "message": "Merge branch 'master' into integrate_create_deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ebdbca049716460c9d8c344232001eb4e9d4b410", "committedDate": "2020-11-04T01:02:32Z", "message": "merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTgzODM1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522983835", "createdAt": "2020-11-04T01:22:23Z", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMToyMjoyM1rOHtGBZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMToyMjoyM1rOHtGBZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA0NjYzMA==", "bodyText": "DeploymentConfiguration -> camel case", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517046630", "createdAt": "2020-11-04T01:22:23Z", "author": {"login": "shaguptashaikh"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -177,10 +177,10 @@ public void onStreamClosed() {\n     }\n \n     private void submitSampleJobDocument(URI uri, String arn, DeploymentType type) throws Exception {\n-        FleetConfiguration fleetConfiguration = OBJECT_MAPPER.readValue(new File(uri), FleetConfiguration.class);\n-        fleetConfiguration.setCreationTimestamp(System.currentTimeMillis());\n-        fleetConfiguration.setConfigurationArn(arn);\n-        Deployment deployment = new Deployment(OBJECT_MAPPER.writeValueAsString(fleetConfiguration), type, fleetConfiguration.getConfigurationArn());\n+        Configuration DeploymentConfiguration = OBJECT_MAPPER.readValue(new File(uri), Configuration.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTg5ODEx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522989811", "createdAt": "2020-11-04T01:40:58Z", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo0MDo1OFrOHtGVVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo0MDo1OFrOHtGVVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1MTczNA==", "bodyText": "why is this needed? and the string is an identifier / tag for the update action so it's just the deployment id", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517051734", "createdAt": "2020-11-04T01:40:58Z", "author": {"login": "shaguptashaikh"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -674,44 +657,62 @@ public void onStreamClosed() {\n \n             // Second deployment to update the service which is currently running an important task so deployment should\n             // keep waiting for a safe time to update\n-            SetConfigurationRequest setRequest2 = new SetConfigurationRequest().withTargetName(thingGroupName).withTargetType(THING_GROUP_TARGET_TYPE).withDeploymentPolicies(new DeploymentPolicies()\n-                    .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120)).withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING)\n-                    .withComponentUpdatePolicy(new ComponentUpdatePolicy().withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS).withTimeout(120)))\n-                    .addPackagesEntry(\"NonDisruptableService\", new PackageMetaData().withRootComponent(true).withVersion(\"1.0.1\"));\n-            PublishConfigurationResult publishResult2 = setAndPublishFleetConfiguration(setRequest2);\n-            IotJobsUtils.waitForJobExecutionStatusToSatisfy(iotClient, publishResult2.getJobId(), thingInfo\n-                    .getThingName(), Duration.ofMinutes(3), s -> s.equals(JobExecutionStatus.IN_PROGRESS));\n+            CreateDeploymentRequest createDeploymentRequest2 = new CreateDeploymentRequest()\n+                    .withDeploymentPolicies(new DeploymentPolicies()\n+                            .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120))\n+                            .withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING).withComponentUpdatePolicy(\n+                                    new ComponentUpdatePolicy()\n+                                            .withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS)\n+                                            .withTimeout(120)))\n+                    .addComponentsEntry(\"NonDisruptableService\", new ComponentInfo().withVersion(\"1.0.1\"));\n+            CreateDeploymentResult result2 = draftAndCreateDeployment(createDeploymentRequest2);\n+            IotJobsUtils.waitForJobExecutionStatusToSatisfy(iotClient, result2.getJobId(), thingInfo.getThingName(),\n+                    Duration.ofMinutes(3), s -> s.equals(JobExecutionStatus.IN_PROGRESS));\n \n             // Create one more deployment so that it's queued in cloud\n-            SetConfigurationRequest setRequest3 = new SetConfigurationRequest().withTargetName(thingGroupName).withTargetType(THING_GROUP_TARGET_TYPE).withDeploymentPolicies(new DeploymentPolicies()\n-                    .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120)).withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING)\n-                    .withComponentUpdatePolicy(new ComponentUpdatePolicy().withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS).withTimeout(120)))\n-                    .addPackagesEntry(\"NonDisruptableService\", new PackageMetaData().withRootComponent(true).withVersion(\"1.0.1\"));\n-            PublishConfigurationResult publishResult3 = setAndPublishFleetConfiguration(setRequest3);\n+            CreateDeploymentRequest createDeploymentRequest3 = new CreateDeploymentRequest()\n+                    .withDeploymentPolicies(new DeploymentPolicies()\n+                            .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120))\n+                            .withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING).withComponentUpdatePolicy(\n+                                    new ComponentUpdatePolicy()\n+                                            .withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS)\n+                                            .withTimeout(120)))\n+                    .addComponentsEntry(\"NonDisruptableService\", new ComponentInfo().withVersion(\"1.0.1\"));\n+            CreateDeploymentResult result3 = draftAndCreateDeployment(createDeploymentRequest3);\n \n             // Wait for the second deployment to start waiting for safe time to update and\n             // then cancel it's corresponding job from cloud\n             assertTrue(updateRegistered.await(60, TimeUnit.SECONDS));\n-            assertTrue(kernel.getContext().get(UpdateSystemSafelyService.class).hasPendingUpdateAction(publishResult2.getConfigurationArn()));\n+            UpdateSystemSafelyService updateSystemSafelyService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            assertThat(\"The UpdateSystemService should have one pending action.\",\n+                    updateSystemSafelyService.getPendingActions(),\n+                    IsCollectionWithSize.hasSize(1));\n+            // Get the value of the pending Action\n+            String pendingAction = updateSystemSafelyService.getPendingActions().iterator().next();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "originalPosition": 517}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTg5OTU4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522989958", "createdAt": "2020-11-04T01:41:31Z", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo0MTozMVrOHtGV3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo0MTozMVrOHtGV3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1MTg2OA==", "bodyText": "Same here, why do we need it?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517051868", "createdAt": "2020-11-04T01:41:31Z", "author": {"login": "shaguptashaikh"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -674,44 +657,62 @@ public void onStreamClosed() {\n \n             // Second deployment to update the service which is currently running an important task so deployment should\n             // keep waiting for a safe time to update\n-            SetConfigurationRequest setRequest2 = new SetConfigurationRequest().withTargetName(thingGroupName).withTargetType(THING_GROUP_TARGET_TYPE).withDeploymentPolicies(new DeploymentPolicies()\n-                    .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120)).withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING)\n-                    .withComponentUpdatePolicy(new ComponentUpdatePolicy().withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS).withTimeout(120)))\n-                    .addPackagesEntry(\"NonDisruptableService\", new PackageMetaData().withRootComponent(true).withVersion(\"1.0.1\"));\n-            PublishConfigurationResult publishResult2 = setAndPublishFleetConfiguration(setRequest2);\n-            IotJobsUtils.waitForJobExecutionStatusToSatisfy(iotClient, publishResult2.getJobId(), thingInfo\n-                    .getThingName(), Duration.ofMinutes(3), s -> s.equals(JobExecutionStatus.IN_PROGRESS));\n+            CreateDeploymentRequest createDeploymentRequest2 = new CreateDeploymentRequest()\n+                    .withDeploymentPolicies(new DeploymentPolicies()\n+                            .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120))\n+                            .withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING).withComponentUpdatePolicy(\n+                                    new ComponentUpdatePolicy()\n+                                            .withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS)\n+                                            .withTimeout(120)))\n+                    .addComponentsEntry(\"NonDisruptableService\", new ComponentInfo().withVersion(\"1.0.1\"));\n+            CreateDeploymentResult result2 = draftAndCreateDeployment(createDeploymentRequest2);\n+            IotJobsUtils.waitForJobExecutionStatusToSatisfy(iotClient, result2.getJobId(), thingInfo.getThingName(),\n+                    Duration.ofMinutes(3), s -> s.equals(JobExecutionStatus.IN_PROGRESS));\n \n             // Create one more deployment so that it's queued in cloud\n-            SetConfigurationRequest setRequest3 = new SetConfigurationRequest().withTargetName(thingGroupName).withTargetType(THING_GROUP_TARGET_TYPE).withDeploymentPolicies(new DeploymentPolicies()\n-                    .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120)).withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING)\n-                    .withComponentUpdatePolicy(new ComponentUpdatePolicy().withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS).withTimeout(120)))\n-                    .addPackagesEntry(\"NonDisruptableService\", new PackageMetaData().withRootComponent(true).withVersion(\"1.0.1\"));\n-            PublishConfigurationResult publishResult3 = setAndPublishFleetConfiguration(setRequest3);\n+            CreateDeploymentRequest createDeploymentRequest3 = new CreateDeploymentRequest()\n+                    .withDeploymentPolicies(new DeploymentPolicies()\n+                            .withConfigurationValidationPolicy(new ConfigurationValidationPolicy().withTimeout(120))\n+                            .withFailureHandlingPolicy(FailureHandlingPolicy.DO_NOTHING).withComponentUpdatePolicy(\n+                                    new ComponentUpdatePolicy()\n+                                            .withAction(ComponentUpdatePolicyAction.NOTIFY_COMPONENTS)\n+                                            .withTimeout(120)))\n+                    .addComponentsEntry(\"NonDisruptableService\", new ComponentInfo().withVersion(\"1.0.1\"));\n+            CreateDeploymentResult result3 = draftAndCreateDeployment(createDeploymentRequest3);\n \n             // Wait for the second deployment to start waiting for safe time to update and\n             // then cancel it's corresponding job from cloud\n             assertTrue(updateRegistered.await(60, TimeUnit.SECONDS));\n-            assertTrue(kernel.getContext().get(UpdateSystemSafelyService.class).hasPendingUpdateAction(publishResult2.getConfigurationArn()));\n+            UpdateSystemSafelyService updateSystemSafelyService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            assertThat(\"The UpdateSystemService should have one pending action.\",\n+                    updateSystemSafelyService.getPendingActions(),\n+                    IsCollectionWithSize.hasSize(1));\n+            // Get the value of the pending Action\n+            String pendingAction = updateSystemSafelyService.getPendingActions().iterator().next();\n \n             // GG_NEEDS_REVIEW: TODO : Call Fleet configuration service's cancel API when ready instead of calling IoT Jobs API\n-            IotJobsUtils.cancelJob(iotClient, publishResult2.getJobId());\n+            IotJobsUtils.cancelJob(iotClient, result2.getJobId());\n \n             // Wait for indication that cancellation has gone through\n             assertTrue(deploymentCancelled.await(240, TimeUnit.SECONDS));\n-            assertFalse(kernel.getContext().get(UpdateSystemSafelyService.class).hasPendingUpdateAction(publishResult2.getConfigurationArn()));\n+            // the third deployment may have reached device.\n+            Set<String> pendingActions = updateSystemSafelyService.getPendingActions();\n+            if (pendingActions.size() == 1) {\n+                String newPendingAction = pendingActions.iterator().next();\n+                assertNotEquals(pendingAction, newPendingAction, \"The UpdateSystemService's one pending action should be be replaced.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "originalPosition": 530}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4756f8fdabc2c561d7828b02c199516f3589190e", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4756f8fdabc2c561d7828b02c199516f3589190e", "committedDate": "2020-11-04T01:41:36Z", "message": "pr comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTkyMzM0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522992334", "createdAt": "2020-11-04T01:49:50Z", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo0OTo1MFrOHtGeEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo0OTo1MFrOHtGeEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1Mzk2OQ==", "bodyText": "For TODOs we need to create SIMs in this folder for tracking them appropriately if they are release blockers, and this does sound like something we should clean up before release? https://issues.amazon.com/issues/search?q=status%3A(Open)+in%3A(09c8bedb-c771-4a5b-a8a8-409bc1758e3d)&sort=lastUpdatedDate+desc&selectedDocument=54e3fb2d-e2d0-48db-a2db-067d4121c09d Not blocking the CR but a SIM needs to be created for it", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517053969", "createdAt": "2020-11-04T01:49:50Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/deployment/DeploymentService.java", "diffHunk": "@@ -472,9 +475,24 @@ private DeploymentDocument parseAndValidateJobDocument(Deployment deployment) th\n                     break;\n                 case IOT_JOBS:\n                 case SHADOW:\n-                    FleetConfiguration config = SerializerFactory.getJsonObjectMapper()\n-                            .readValue(jobDocumentString, FleetConfiguration.class);\n-                    document = DeploymentDocumentConverter.convertFromFleetConfiguration(config);\n+                    JsonNode jsonNode =\n+                            SerializerFactory.getJsonObjectMapper().readValue(jobDocumentString, JsonNode.class);\n+\n+                    if (jsonNode.has(\"packages\")) {\n+                        // If \"packages\" exists, the document is in the old format, which is\n+                        // the result of Set/PublishConfiguration\n+                        // TODO remove after migrating off Set/PublishConfiguration", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "originalPosition": 228}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTkzMzI3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522993327", "createdAt": "2020-11-04T01:53:13Z", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo1MzoxM1rOHtGhTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo1MzoxM1rOHtGhTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NDc5OQ==", "bodyText": "I don't think this warning log should be added, it's should be at debug level at best, it's not going to be uncommon for customers to rely on defaults unless they have to change to some other value", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517054799", "createdAt": "2020-11-04T01:53:13Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -185,4 +197,116 @@ public static DeploymentDocument convertFromFleetConfiguration(FleetConfiguratio\n         });\n         return new ArrayList<>(packageConfigurations.values());\n     }\n+\n+    /**\n+     * Converts deployment configuration {@link Configuration} that is generated by CreateDeployment and gets sent down\n+     * via IoT Job and shadow to the Nucleus's core {@link DeploymentDocument}.\n+     *\n+     * @param config Fleet configuration that is generated by CreateDeployment and gets sent down via IoT Job and\n+     *               shadow\n+     * @return Nucleus's core {@link DeploymentDocument}\n+     * @throws InvalidRequestException if the deployment configuration is invalid\n+     */\n+    public static DeploymentDocument convertFromDeploymentConfiguration(Configuration config)\n+            throws InvalidRequestException {\n+\n+        Map<String, ComponentUpdate> components = config.getComponents();\n+        if (components == null || components.isEmpty()) {\n+            throw new InvalidRequestException(\"The deployment configuration doesn't specified components to deploy.\");\n+        }\n+\n+        DeploymentDocument.DeploymentDocumentBuilder builder =\n+                DeploymentDocument.builder().deploymentId(config.getConfigurationArn())\n+                        .deploymentPackageConfigurationList(convertComponents(config.getComponents()))\n+                        .groupName(parseGroupNameFromConfigurationArn(config)).timestamp(config.getCreationTimestamp());\n+\n+\n+        if (config.getFailureHandlingPolicy() == null) {\n+            // FailureHandlingPolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"FailureHandlingPolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTkzMzY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522993365", "createdAt": "2020-11-04T01:53:21Z", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo1MzoyMVrOHtGhbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo1MzoyMVrOHtGhbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NDgyOA==", "bodyText": "Same as above", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517054828", "createdAt": "2020-11-04T01:53:21Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -185,4 +197,116 @@ public static DeploymentDocument convertFromFleetConfiguration(FleetConfiguratio\n         });\n         return new ArrayList<>(packageConfigurations.values());\n     }\n+\n+    /**\n+     * Converts deployment configuration {@link Configuration} that is generated by CreateDeployment and gets sent down\n+     * via IoT Job and shadow to the Nucleus's core {@link DeploymentDocument}.\n+     *\n+     * @param config Fleet configuration that is generated by CreateDeployment and gets sent down via IoT Job and\n+     *               shadow\n+     * @return Nucleus's core {@link DeploymentDocument}\n+     * @throws InvalidRequestException if the deployment configuration is invalid\n+     */\n+    public static DeploymentDocument convertFromDeploymentConfiguration(Configuration config)\n+            throws InvalidRequestException {\n+\n+        Map<String, ComponentUpdate> components = config.getComponents();\n+        if (components == null || components.isEmpty()) {\n+            throw new InvalidRequestException(\"The deployment configuration doesn't specified components to deploy.\");\n+        }\n+\n+        DeploymentDocument.DeploymentDocumentBuilder builder =\n+                DeploymentDocument.builder().deploymentId(config.getConfigurationArn())\n+                        .deploymentPackageConfigurationList(convertComponents(config.getComponents()))\n+                        .groupName(parseGroupNameFromConfigurationArn(config)).timestamp(config.getCreationTimestamp());\n+\n+\n+        if (config.getFailureHandlingPolicy() == null) {\n+            // FailureHandlingPolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"FailureHandlingPolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");\n+        } else {\n+            builder.failureHandlingPolicy(convertFailureHandlingPolicy(config.getFailureHandlingPolicy()));\n+        }\n+\n+        if (config.getComponentUpdatePolicy() == null) {\n+            // ComponentUpdatePolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"ComponentUpdatePolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTk0ODkw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522994890", "createdAt": "2020-11-04T01:58:19Z", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo1ODoxOVrOHtGmcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo1ODoxOVrOHtGmcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NjExMg==", "bodyText": "Not sure if this is okay to do, thing group name and configuration arn are different strings, more importantly, this has to be some problem with our code on the cloud side if this arn is not present in the document, it's not a user error, so swallowing it is bad because it will not reveal service side issues but might mess up FSS metrics for customers. Also about using the thing name as group name, is that how we treat single device deployments? I thought we were using the default group for shadow deployments right?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517056112", "createdAt": "2020-11-04T01:58:19Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -185,4 +197,116 @@ public static DeploymentDocument convertFromFleetConfiguration(FleetConfiguratio\n         });\n         return new ArrayList<>(packageConfigurations.values());\n     }\n+\n+    /**\n+     * Converts deployment configuration {@link Configuration} that is generated by CreateDeployment and gets sent down\n+     * via IoT Job and shadow to the Nucleus's core {@link DeploymentDocument}.\n+     *\n+     * @param config Fleet configuration that is generated by CreateDeployment and gets sent down via IoT Job and\n+     *               shadow\n+     * @return Nucleus's core {@link DeploymentDocument}\n+     * @throws InvalidRequestException if the deployment configuration is invalid\n+     */\n+    public static DeploymentDocument convertFromDeploymentConfiguration(Configuration config)\n+            throws InvalidRequestException {\n+\n+        Map<String, ComponentUpdate> components = config.getComponents();\n+        if (components == null || components.isEmpty()) {\n+            throw new InvalidRequestException(\"The deployment configuration doesn't specified components to deploy.\");\n+        }\n+\n+        DeploymentDocument.DeploymentDocumentBuilder builder =\n+                DeploymentDocument.builder().deploymentId(config.getConfigurationArn())\n+                        .deploymentPackageConfigurationList(convertComponents(config.getComponents()))\n+                        .groupName(parseGroupNameFromConfigurationArn(config)).timestamp(config.getCreationTimestamp());\n+\n+\n+        if (config.getFailureHandlingPolicy() == null) {\n+            // FailureHandlingPolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"FailureHandlingPolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");\n+        } else {\n+            builder.failureHandlingPolicy(convertFailureHandlingPolicy(config.getFailureHandlingPolicy()));\n+        }\n+\n+        if (config.getComponentUpdatePolicy() == null) {\n+            // ComponentUpdatePolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"ComponentUpdatePolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");\n+        } else {\n+            builder.componentUpdatePolicy(convertComponentUpdatePolicy(config.getComponentUpdatePolicy()));\n+        }\n+\n+        return builder.build();\n+    }\n+\n+    private static String parseGroupNameFromConfigurationArn(Configuration config) {\n+        String groupName;\n+        try {\n+            // ConfigurationArn formats:\n+            // configuration:thing/<thing-name>\n+            // configuration:thinggroup/<thing-group-name>\n+            groupName = Arn.fromString(config.getConfigurationArn()).getResource().getResource();\n+        } catch (IllegalArgumentException e) {\n+            // so that it can proceed, rather than fail, when the format of configurationArn is wrong.\n+            groupName = config.getConfigurationArn();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTk1Mzk2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522995396", "createdAt": "2020-11-04T01:59:55Z", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo1OTo1NVrOHtGoIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMTo1OTo1NVrOHtGoIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA1NjU0Ng==", "bodyText": "So no non root components even if they have just configuration changes ?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#discussion_r517056546", "createdAt": "2020-11-04T01:59:55Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/deployment/converter/DeploymentDocumentConverter.java", "diffHunk": "@@ -185,4 +197,116 @@ public static DeploymentDocument convertFromFleetConfiguration(FleetConfiguratio\n         });\n         return new ArrayList<>(packageConfigurations.values());\n     }\n+\n+    /**\n+     * Converts deployment configuration {@link Configuration} that is generated by CreateDeployment and gets sent down\n+     * via IoT Job and shadow to the Nucleus's core {@link DeploymentDocument}.\n+     *\n+     * @param config Fleet configuration that is generated by CreateDeployment and gets sent down via IoT Job and\n+     *               shadow\n+     * @return Nucleus's core {@link DeploymentDocument}\n+     * @throws InvalidRequestException if the deployment configuration is invalid\n+     */\n+    public static DeploymentDocument convertFromDeploymentConfiguration(Configuration config)\n+            throws InvalidRequestException {\n+\n+        Map<String, ComponentUpdate> components = config.getComponents();\n+        if (components == null || components.isEmpty()) {\n+            throw new InvalidRequestException(\"The deployment configuration doesn't specified components to deploy.\");\n+        }\n+\n+        DeploymentDocument.DeploymentDocumentBuilder builder =\n+                DeploymentDocument.builder().deploymentId(config.getConfigurationArn())\n+                        .deploymentPackageConfigurationList(convertComponents(config.getComponents()))\n+                        .groupName(parseGroupNameFromConfigurationArn(config)).timestamp(config.getCreationTimestamp());\n+\n+\n+        if (config.getFailureHandlingPolicy() == null) {\n+            // FailureHandlingPolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"FailureHandlingPolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");\n+        } else {\n+            builder.failureHandlingPolicy(convertFailureHandlingPolicy(config.getFailureHandlingPolicy()));\n+        }\n+\n+        if (config.getComponentUpdatePolicy() == null) {\n+            // ComponentUpdatePolicy should be provided per contract with CreateDeployment API.\n+            // However if it is not, device could proceed with default for resilience.\n+            logger.atWarn().log(\"ComponentUpdatePolicy should be provided but is not provided. \"\n+                                        + \"Proceeding with default failure handling policy.\");\n+        } else {\n+            builder.componentUpdatePolicy(convertComponentUpdatePolicy(config.getComponentUpdatePolicy()));\n+        }\n+\n+        return builder.build();\n+    }\n+\n+    private static String parseGroupNameFromConfigurationArn(Configuration config) {\n+        String groupName;\n+        try {\n+            // ConfigurationArn formats:\n+            // configuration:thing/<thing-name>\n+            // configuration:thinggroup/<thing-group-name>\n+            groupName = Arn.fromString(config.getConfigurationArn()).getResource().getResource();\n+        } catch (IllegalArgumentException e) {\n+            // so that it can proceed, rather than fail, when the format of configurationArn is wrong.\n+            groupName = config.getConfigurationArn();\n+        }\n+        return groupName;\n+    }\n+\n+    private static List<DeploymentPackageConfiguration> convertComponents(\n+            @Nonnull Map<String, ComponentUpdate> components) {\n+        return components.entrySet().stream().map(e -> convertComponent(e.getKey(), e.getValue()))\n+                .collect(Collectors.toList());\n+    }\n+\n+    private static DeploymentPackageConfiguration convertComponent(String componentName,\n+            ComponentUpdate componentUpdate) {\n+\n+        return DeploymentPackageConfiguration.builder().packageName(componentName)\n+                .resolvedVersion(componentUpdate.getVersion().getValue())\n+                .rootComponent(true) // As of now, CreateDeployment API only gives root component", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "originalPosition": 119}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTk4Njk4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522998698", "createdAt": "2020-11-04T02:11:16Z", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTk5MTU1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-522999155", "createdAt": "2020-11-04T02:12:53Z", "commit": {"oid": "ebdbca049716460c9d8c344232001eb4e9d4b410"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "498674b3912c550217d273a2f7f0c2574873e4ad", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/498674b3912c550217d273a2f7f0c2574873e4ad", "committedDate": "2020-11-04T02:15:00Z", "message": "pr comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDAwMDY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-523000065", "createdAt": "2020-11-04T02:15:52Z", "commit": {"oid": "498674b3912c550217d273a2f7f0c2574873e4ad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDAwNDA4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/581#pullrequestreview-523000408", "createdAt": "2020-11-04T02:16:53Z", "commit": {"oid": "498674b3912c550217d273a2f7f0c2574873e4ad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2853, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}