{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NDg2MDYw", "number": 238, "title": "Fix tlog appending and add test", "bodyText": "Issue #, if available:\nDescription of changes:\nFixes the ConfigurationWriter which was broken because it implemented the Subscriber interface instead of the ChildChanged interface. Because of that it was not receiving any of the updates which happened to the config.\nI also added a basic test which verifies that the config can be recreated from the tlog.\nAdditionally, I set the kernel to read from the tlog first if it exists, instead of reading from the yaml file because the yaml file is never updated, so it won't have the most recent state.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-13T16:47:13Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238", "merged": true, "mergeCommit": {"oid": "8f889e37465df8c2ed59eaa706f07ea1bda6f294"}, "closed": true, "closedAt": "2020-05-13T18:10:44Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg8AVuAFqTQxMTEyODM2NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg81NggFqTQxMTE2NTUwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTI4MzY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#pullrequestreview-411128365", "createdAt": "2020-05-13T17:06:19Z", "commit": {"oid": "d8c7348d1c9214bb1637aa42bf80255e49bbbac9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzowNjoyMFrOGU7SYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzowNjoyMFrOGU7SYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5NjA2Ng==", "bodyText": "What's the reason Subscriber doesn't work?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424596066", "createdAt": "2020-05-13T17:06:20Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/iot/evergreen/config/ConfigurationWriter.java", "diffHunk": "@@ -21,7 +21,7 @@\n import static com.aws.iot.evergreen.util.Utils.appendLong;\n import static com.aws.iot.evergreen.util.Utils.flush;\n \n-public class ConfigurationWriter implements Closeable, Subscriber {\n+public class ConfigurationWriter implements Closeable, ChildChanged {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8c7348d1c9214bb1637aa42bf80255e49bbbac9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTUwMjc0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#pullrequestreview-411150274", "createdAt": "2020-05-13T17:34:57Z", "commit": {"oid": "d8c7348d1c9214bb1637aa42bf80255e49bbbac9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzozNDo1N1rOGU8Vqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzozNDo1N1rOGU8Vqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxMzI5MQ==", "bodyText": "Are these the same as line 47, 48, 49? Why do you need these twice?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424613291", "createdAt": "2020-05-13T17:34:57Z", "author": {"login": "fengwang666"}, "path": "src/test/java/com/aws/iot/evergreen/config/ConfigurationWriterTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.config;\n+\n+import com.aws.iot.evergreen.dependency.Context;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+\n+class ConfigurationWriterTest {\n+    @TempDir\n+    protected Path tempDir;\n+\n+    private Context context;\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        context = new Context();\n+    }\n+\n+    @AfterEach\n+    void afterEach() throws IOException {\n+        if (context != null) {\n+            context.close();\n+        }\n+    }\n+\n+    @Test\n+    void GIVEN_config_with_configuration_writer_WHEN_config_changes_made_THEN_written_to_tlog() throws IOException {\n+        Path tlog = tempDir.resolve(\"c.tlog\");\n+        Configuration config = new Configuration(context);\n+\n+        try (ConfigurationWriter writer = ConfigurationWriter.logTransactionsTo(config, tlog)) {\n+            writer.flushImmediately(true);\n+\n+            config.lookup(\"a\", \"b\", \"c\", \"d\", \"e\").withValue(\"Some Val\");\n+            config.lookup(\"a\", \"b\", \"c\", \"d\", \"e2\").withValue(2);\n+            context.runOnPublishQueueAndWait(() -> {\n+            }); // Block until publish queue is empty to ensure all changes have\n+            // been processed\n+            config.lookup(\"a\", \"b\", \"c\", \"d\", \"e\").withValue(\"New Val\");\n+            config.lookup(\"a\", \"b\", \"c\", \"d\", \"e3\").withValue(Arrays.asList(\"1\", \"2\", \"3\"));\n+            context.runOnPublishQueueAndWait(() -> {\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8c7348d1c9214bb1637aa42bf80255e49bbbac9"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTU2NTQy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#pullrequestreview-411156542", "createdAt": "2020-05-13T17:43:23Z", "commit": {"oid": "d8c7348d1c9214bb1637aa42bf80255e49bbbac9"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "272b5a9159c27a2b87818507cec837de4e739d64", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/272b5a9159c27a2b87818507cec837de4e739d64", "committedDate": "2020-05-13T17:49:54Z", "message": "Fix tlog appending and create test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8c7348d1c9214bb1637aa42bf80255e49bbbac9", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d8c7348d1c9214bb1637aa42bf80255e49bbbac9", "committedDate": "2020-05-13T16:42:21Z", "message": "Fix tlog appending and create test"}, "afterCommit": {"oid": "272b5a9159c27a2b87818507cec837de4e739d64", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/272b5a9159c27a2b87818507cec837de4e739d64", "committedDate": "2020-05-13T17:49:54Z", "message": "Fix tlog appending and create test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTY0NzE2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#pullrequestreview-411164716", "createdAt": "2020-05-13T17:54:12Z", "commit": {"oid": "272b5a9159c27a2b87818507cec837de4e739d64"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTcwNTE0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#pullrequestreview-411170514", "createdAt": "2020-05-13T18:01:48Z", "commit": {"oid": "272b5a9159c27a2b87818507cec837de4e739d64"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTY1NTAx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#pullrequestreview-411165501", "createdAt": "2020-05-13T17:55:11Z", "commit": {"oid": "272b5a9159c27a2b87818507cec837de4e739d64"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzo1NToxMVrOGU9FDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxODowMTo0OFrOGU9Upw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYyNTQyMw==", "bodyText": "How do we know if customers actually want to load config.yaml with local dev changes? Do they have to delete the transaction logs in this case?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424625423", "createdAt": "2020-05-13T17:55:11Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java", "diffHunk": "@@ -89,12 +89,13 @@ public void launch() {\n                 kernel.writeEffectiveConfig(configurationFile);\n                 Files.deleteIfExists(transactionLogPath);\n             } else {\n-                if (Files.exists(configurationFile)) {\n-                    kernel.getConfig().read(configurationFile);\n-                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "272b5a9159c27a2b87818507cec837de4e739d64"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYyOTQxNQ==", "bodyText": "I still don't get it why it didn't work earlier. Isn't deepForEachTopic going to add subscriber to leaf nodes?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/238#discussion_r424629415", "createdAt": "2020-05-13T18:01:48Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/config/ConfigurationWriter.java", "diffHunk": "@@ -116,6 +117,6 @@ public synchronized void published(WhatHappened what, Topic n) {\n     }\n \n     public void writeAll() { //TODO double check this\n-        conf.deepForEachTopic(n -> published(WhatHappened.childChanged, n));\n+        conf.deepForEachTopic(n -> childChanged(WhatHappened.childChanged, n));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "272b5a9159c27a2b87818507cec837de4e739d64"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2194, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}