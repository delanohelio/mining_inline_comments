{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMTMzNzcx", "number": 470, "title": "getIotClient(awsRegion, stage, credentialsProvider) API", "bodyText": "Issue #, if available:\nDescription of changes:\nAdd getIotClient(awsRegion, stage, credentialsProvider) API to IotSdkClientFactory\ncommon implementation for all getIotClient APIs\nWhy is this change necessary:\nHow was this change tested:\nmvn test\nmvn verify\ntested in a UAT with DCM\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-24T01:54:41Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470", "merged": true, "mergeCommit": {"oid": "4b769db111a5346fe8b941cac99635e1a579eb3d"}, "closed": true, "closedAt": "2020-09-25T18:56:42Z", "author": {"login": "popanmol"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdL3P-nAH2gAyNDkyMTMzNzcxOmYwNWY1MTlhZDY1ZDMxNTQ0ZDAyYmUyOGQ1N2MyZjM4N2U2ZjBhMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMafiFAH2gAyNDkyMTMzNzcxOjFmYjQzM2MwOWZiYjkwYzczMjFlNDFmODIwZTZkODgwYzNmNjg1ZGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f05f519ad65d31544d02be28d57c2f387e6f0a10", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f05f519ad65d31544d02be28d57c2f387e6f0a10", "committedDate": "2020-09-24T01:52:38Z", "message": "getIotClient(awsRegion, stage, credentialsProvider) API"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTc0NDk3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#pullrequestreview-495174497", "createdAt": "2020-09-24T02:18:06Z", "commit": {"oid": "f05f519ad65d31544d02be28d57c2f387e6f0a10"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMjoxODowN1rOHXHV9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMjoxODowN1rOHXHV9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5OTYwNw==", "bodyText": "Nit: make awsRegion of type Region and have getIotClient(Region, AwsCredentialsProvider) call this", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r493999607", "createdAt": "2020-09-24T02:18:07Z", "author": {"login": "jbutler"}, "path": "src/main/java/com/aws/greengrass/util/IotSdkClientFactory.java", "diffHunk": "@@ -73,6 +73,26 @@ public static IotClient getIotClient(Region awsRegion, AwsCredentialsProvider cr\n                 .overrideConfiguration(ClientOverrideConfiguration.builder().retryPolicy(retryPolicy).build()).build();\n     }\n \n+    /**\n+     * Build IotClient for desired region, stage and credentials.\n+     *\n+     * @param awsRegion           aws region\n+     * @param stage               {@link EnvironmentStage}\n+     * @param credentialsProvider credentials provider\n+     * @return\n+     */\n+    public static IotClient getIotClient(String awsRegion, EnvironmentStage stage,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f05f519ad65d31544d02be28d57c2f387e6f0a10"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0791551f5fd217956efd00cda30f84c896100302", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0791551f5fd217956efd00cda30f84c896100302", "committedDate": "2020-09-24T02:39:16Z", "message": "region and docstring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTg1ODUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#pullrequestreview-495185853", "createdAt": "2020-09-24T02:58:05Z", "commit": {"oid": "0791551f5fd217956efd00cda30f84c896100302"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTk0OTg1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#pullrequestreview-495194985", "createdAt": "2020-09-24T03:31:07Z", "commit": {"oid": "0791551f5fd217956efd00cda30f84c896100302"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMzozMTowN1rOHXIatw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMzozMTowN1rOHXIatw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxNzIwNw==", "bodyText": "the other implementations should call this one so we don't need to duplicate logic.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r494017207", "createdAt": "2020-09-24T03:31:07Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/util/IotSdkClientFactory.java", "diffHunk": "@@ -73,6 +73,27 @@ public static IotClient getIotClient(Region awsRegion, AwsCredentialsProvider cr\n                 .overrideConfiguration(ClientOverrideConfiguration.builder().retryPolicy(retryPolicy).build()).build();\n     }\n \n+    /**\n+     * Build IotClient for desired region, stage and credentials.\n+     *\n+     * @param awsRegion           aws region\n+     * @param stage               {@link EnvironmentStage}\n+     * @param credentialsProvider credentials provider\n+     * @return IotClient instance\n+     * @throws URISyntaxException when Iot endpoint is malformed\n+     */\n+    public static IotClient getIotClient(Region awsRegion, EnvironmentStage stage,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0791551f5fd217956efd00cda30f84c896100302"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d336ed1cde35258f64d6afaefbb2f2801d749e7c", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d336ed1cde35258f64d6afaefbb2f2801d749e7c", "committedDate": "2020-09-24T05:06:38Z", "message": "common implementation for all getIotClient APIs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjQ5NjI2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#pullrequestreview-495249626", "createdAt": "2020-09-24T06:19:28Z", "commit": {"oid": "d336ed1cde35258f64d6afaefbb2f2801d749e7c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzI3Mzcy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#pullrequestreview-495727372", "createdAt": "2020-09-24T16:03:25Z", "commit": {"oid": "d336ed1cde35258f64d6afaefbb2f2801d749e7c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjoyNDowNlrOHXi2Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjoyNjoyOFrOHXi8Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ1MDIwMg==", "bodyText": "Returning a default IotClient is probably not the correct thing to do in this case. This SHOULD never happen, but if something changed and it did, and the client still functioned (e.g. using credentials from a customer profile), then that could be very bad.\nWe definitely need explicit failure here. Either revert and duplicate code or bubble up the exception.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r494450202", "createdAt": "2020-09-24T16:24:06Z", "author": {"login": "jbutler"}, "path": "src/main/java/com/aws/greengrass/util/IotSdkClientFactory.java", "diffHunk": "@@ -69,8 +57,26 @@ public static IotClient getIotClient(String awsRegion, EnvironmentStage stage) t\n      * @return IotClient instance\n      */\n     public static IotClient getIotClient(Region awsRegion, AwsCredentialsProvider credentialsProvider) {\n-        return IotClient.builder().region(awsRegion).credentialsProvider(credentialsProvider)\n-                .overrideConfiguration(ClientOverrideConfiguration.builder().retryPolicy(retryPolicy).build()).build();\n+        try {\n+            return getIotClient(awsRegion, EnvironmentStage.PROD, credentialsProvider, Collections.emptySet());\n+        } catch (URISyntaxException e) {\n+            //this will never execute\n+            return IotClient.builder().build();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d336ed1cde35258f64d6afaefbb2f2801d749e7c"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ1MTAxMg==", "bodyText": "Nit: I realize this is only used in one place, but it's probably useful here still with a comment indicating this is the default retry policy used by all methods", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r494451012", "createdAt": "2020-09-24T16:25:21Z", "author": {"login": "jbutler"}, "path": "src/main/java/com/aws/greengrass/util/IotSdkClientFactory.java", "diffHunk": "@@ -31,13 +32,6 @@\n             Arrays.asList(ThrottlingException.class, InternalException.class, InternalFailureException.class,\n                     LimitExceededException.class));\n \n-    private static final RetryCondition retryCondition = OrRetryCondition", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d336ed1cde35258f64d6afaefbb2f2801d749e7c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ1MTc0Ng==", "bodyText": "Interestingly enough, this didn't previously use the default policy :) 5 retries instead of 10.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#discussion_r494451746", "createdAt": "2020-09-24T16:26:28Z", "author": {"login": "jbutler"}, "path": "src/main/java/com/aws/greengrass/util/IotSdkClientFactory.java", "diffHunk": "@@ -85,19 +91,42 @@ public static IotClient getIotClient(Region awsRegion, AwsCredentialsProvider cr\n     public static IotClient getIotClient(String awsRegion, EnvironmentStage stage,\n                                          Set<Class<? extends Exception>> additionalRetryableExceptions)\n             throws URISyntaxException {\n+        return getIotClient(Region.of(awsRegion), stage, null, additionalRetryableExceptions);\n+    }\n+\n+    /**\n+     * Build IotClient for desired region, stage and credentials with custom retry logic.\n+     * @param awsRegion                     aws region\n+     * @param stage                         {@link EnvironmentStage}\n+     * @param credentialsProvider           credentials provider\n+     * @param additionalRetryableExceptions additional exceptions to retry on\n+     * @return IotClient instance\n+     * @throws URISyntaxException when Iot endpoint is malformed\n+     */\n+    public static IotClient getIotClient(Region awsRegion, EnvironmentStage stage,\n+                                         AwsCredentialsProvider credentialsProvider,\n+                                         Set<Class<? extends Exception>> additionalRetryableExceptions)\n+            throws URISyntaxException {\n         Set<Class<? extends Exception>> allExceptionsToRetryOn = new HashSet<>();\n         allExceptionsToRetryOn.addAll(retryableIoTExceptions);\n         allExceptionsToRetryOn.addAll(additionalRetryableExceptions);\n-        IotClientBuilder iotClientBuilder = IotClient.builder().region(Region.of(awsRegion)).overrideConfiguration(\n-                ClientOverrideConfiguration.builder().retryPolicy(\n-                        RetryPolicy.builder().numRetries(5).backoffStrategy(BackoffStrategy.defaultThrottlingStrategy())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d336ed1cde35258f64d6afaefbb2f2801d749e7c"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "574cb926e5846db49af9f9cfc1dc96b603e4d45a", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/574cb926e5846db49af9f9cfc1dc96b603e4d45a", "committedDate": "2020-09-24T18:00:29Z", "message": "throw URISyntaxException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1ODMxNjgw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#pullrequestreview-495831680", "createdAt": "2020-09-24T18:12:58Z", "commit": {"oid": "574cb926e5846db49af9f9cfc1dc96b603e4d45a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1ODc3Mzgz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/470#pullrequestreview-495877383", "createdAt": "2020-09-24T19:12:43Z", "commit": {"oid": "574cb926e5846db49af9f9cfc1dc96b603e4d45a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b02568f27bef30d1b7c80ed7127aa353afd8ff1f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b02568f27bef30d1b7c80ed7127aa353afd8ff1f", "committedDate": "2020-09-25T07:07:56Z", "message": "Merge branch 'master' into iotclient-factory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e536a613a32a2d04a470a6a148993f61f7aad97", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5e536a613a32a2d04a470a6a148993f61f7aad97", "committedDate": "2020-09-25T18:02:54Z", "message": "Merge branch 'master' into iotclient-factory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ee4abb55adcf2629118e470b8140ab508a647e1", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6ee4abb55adcf2629118e470b8140ab508a647e1", "committedDate": "2020-09-25T18:41:43Z", "message": "Merge branch 'master' into iotclient-factory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "127a2964d2628cd04919ca05adc886f6e122864a", "author": {"user": {"login": "popanmol", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/127a2964d2628cd04919ca05adc886f6e122864a", "committedDate": "2020-09-25T18:42:39Z", "message": "number of retries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fb433c09fbb90c7321e41f820e6d880c3f685de", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1fb433c09fbb90c7321e41f820e6d880c3f685de", "committedDate": "2020-09-25T18:56:18Z", "message": "Merge branch 'master' into iotclient-factory"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3021, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}