{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MTExNjcx", "number": 543, "title": "Moonraker integration", "bodyText": "Issue #, if available:\nDescription of changes:\nIntegrate AWS IoT Moonraker endpoint for data plane API invocations. Sign and encrypt request with device private key and certificate as part of mutual TLS.\nWhy is this change necessary:\nDevice needs to move away from token based authentication before launch. As Moonraker endpoint is ready, this is to finalize data plane request path.\nHow was this change tested:\nTested locally with moonraker Beta and Gamma endpoint\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-19T16:28:46Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543", "merged": true, "mergeCommit": {"oid": "4b822e1dae791325bb08cb10a18653ba23bc6a25"}, "closed": true, "closedAt": "2020-10-30T20:29:49Z", "author": {"login": "wikimonkey"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUG8ozgFqTUxMTk1MTY5Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXszi2gFqTUyMTAxMjQwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTUxNjk2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#pullrequestreview-511951696", "createdAt": "2020-10-19T16:36:07Z", "commit": {"oid": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjozNjowOFrOHkXaTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjo0MDozN1rOHkXlTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NDM1MQ==", "bodyText": "needs proxy support too", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507894351", "createdAt": "2020-10-19T16:36:08Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -34,36 +51,104 @@\n      *\n      * @param greengrassServiceEndpoint String containing service endpoint\n      * @param deviceConfiguration       Device configuration\n-     * @param credentialsProvider       AWS Credentials provider for device credentials\n      */\n     @Inject\n     public GreengrassComponentServiceClientFactory(\n             @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration,\n-            LazyCredentialProvider credentialsProvider) {\n+            DeviceConfiguration deviceConfiguration) {\n+\n+        ClientConfiguration clientConfiguration = ProxyUtils.getClientConfiguration();\n+        try {\n+            configureClientMutualTLS(clientConfiguration, deviceConfiguration);\n+        } catch (TLSAuthException e) {\n+            logger.atWarn(\"configure-greengrass-mutual-auth\")\n+                    .log(\"Error during configure greengrass client mutual auth\", e);\n+        }\n         AWSEvergreenClientBuilder clientBuilder =\n-                AWSEvergreenClientBuilder.standard().withClientConfiguration(ProxyUtils.getClientConfiguration());\n+                AWSEvergreenClientBuilder.standard().withClientConfiguration(clientConfiguration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTEwNA==", "bodyText": "can we just have a null password? or empty array", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507895104", "createdAt": "2020-10-19T16:37:24Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -34,36 +51,104 @@\n      *\n      * @param greengrassServiceEndpoint String containing service endpoint\n      * @param deviceConfiguration       Device configuration\n-     * @param credentialsProvider       AWS Credentials provider for device credentials\n      */\n     @Inject\n     public GreengrassComponentServiceClientFactory(\n             @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration,\n-            LazyCredentialProvider credentialsProvider) {\n+            DeviceConfiguration deviceConfiguration) {\n+\n+        ClientConfiguration clientConfiguration = ProxyUtils.getClientConfiguration();\n+        try {\n+            configureClientMutualTLS(clientConfiguration, deviceConfiguration);\n+        } catch (TLSAuthException e) {\n+            logger.atWarn(\"configure-greengrass-mutual-auth\")\n+                    .log(\"Error during configure greengrass client mutual auth\", e);\n+        }\n         AWSEvergreenClientBuilder clientBuilder =\n-                AWSEvergreenClientBuilder.standard().withClientConfiguration(ProxyUtils.getClientConfiguration());\n+                AWSEvergreenClientBuilder.standard().withClientConfiguration(clientConfiguration);\n         String region = Coerce.toString(deviceConfiguration.getAWSRegion());\n \n         if (!Utils.isEmpty(region)) {\n             if (!Utils.isEmpty(greengrassServiceEndpoint)) {\n                 // Region and endpoint are both required when updating endpoint config\n-                logger.atInfo(\"initialize-cms-client\").addKeyValue(\"service-endpoint\", greengrassServiceEndpoint)\n+                logger.atInfo(\"initialize-greengrass-client\").addKeyValue(\"service-endpoint\", greengrassServiceEndpoint)\n                         .addKeyValue(\"service-region\", region).log();\n                 EndpointConfiguration endpointConfiguration =\n                         new EndpointConfiguration(greengrassServiceEndpoint, region);\n                 clientBuilder.withEndpointConfiguration(endpointConfiguration);\n             } else {\n                 // This section is to override default region if needed\n-                logger.atInfo(\"initialize-cms-client\").addKeyValue(\"service-region\", region).log();\n+                logger.atInfo(\"initialize-greengrass-client\").addKeyValue(\"service-region\", region).log();\n                 clientBuilder.withRegion(region);\n             }\n         }\n \n-        if (credentialsProvider != null) {\n-            clientBuilder.withCredentials(credentialsProvider);\n+        this.cmsClient = clientBuilder.build();\n+    }\n+\n+    private void configureClientMutualTLS(ClientConfiguration clientConfiguration,\n+                                          DeviceConfiguration deviceConfiguration) throws TLSAuthException {\n+        if (clientConfiguration == null) {\n+            return;\n+        }\n+        String certificatePath = Coerce.toString(deviceConfiguration.getCertificateFilePath());\n+        String privateKeyPath = Coerce.toString(deviceConfiguration.getPrivateKeyFilePath());\n+        String rootCAPath = Coerce.toString(deviceConfiguration.getRootCAFilePath());\n+        if (Utils.isEmpty(certificatePath) || Utils.isEmpty(privateKeyPath) || Utils.isEmpty(rootCAPath)) {\n+            return;\n+        }\n+\n+        TrustManager[] trustManagers = createTrustManagers(rootCAPath);\n+        KeyManager[] keyManagers = createKeyManagers(privateKeyPath, certificatePath);\n+        SSLContext sslContext = null;\n+        try {\n+            sslContext = SSLContext.getInstance(\"TLSv1.2\");\n+            sslContext.init(keyManagers, trustManagers, null);\n+        } catch (GeneralSecurityException e) {\n+            throw new TLSAuthException(\"Failed to initialize TLS context\", e);\n         }\n \n-        this.cmsClient = clientBuilder.build();\n+        SSLConnectionSocketFactory sslConnectionSocketFactory =\n+                new SSLConnectionSocketFactory(sslContext, NoopHostnameVerifier.INSTANCE);\n+        clientConfiguration.getApacheHttpClientConfig().setSslSocketFactory(sslConnectionSocketFactory);\n+    }\n+\n+    private TrustManager[] createTrustManagers(String rootCAPath) throws TLSAuthException {\n+        try {\n+            List<X509Certificate> trustCertificates = EncryptionUtils.loadX509Certificates(rootCAPath);\n+\n+            KeyStore tmKeyStore = KeyStore.getInstance(\"JKS\");\n+            tmKeyStore.load(null, null);\n+            for (X509Certificate certificate : trustCertificates) {\n+                X500Principal principal = certificate.getSubjectX500Principal();\n+                String name = principal.getName(\"RFC2253\");\n+                tmKeyStore.setCertificateEntry(name, certificate);\n+            }\n+            TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(\"X509\");\n+            trustManagerFactory.init(tmKeyStore);\n+            return trustManagerFactory.getTrustManagers();\n+        } catch (GeneralSecurityException | IOException e) {\n+            throw new TLSAuthException(\"Failed to get trust manager\", e);\n+        }\n+    }\n+\n+    private KeyManager[] createKeyManagers(String privateKeyPath, String certificatePath) throws TLSAuthException {\n+        try {\n+            List<X509Certificate> certificateChain = EncryptionUtils.loadX509Certificates(certificatePath);\n+\n+            PrivateKey privateKey = EncryptionUtils.loadPrivateKey(privateKeyPath);\n+\n+            KeyStore keyStore = KeyStore.getInstance(\"PKCS12\");\n+            keyStore.load(null);\n+            keyStore.setKeyEntry(\"private-key\", privateKey, \"password\".toCharArray(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTczMg==", "bodyText": "since we have this now, you should be able to remove greengrass permissions from the TES role that we create for customers (not the one we use in testing though)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507895732", "createdAt": "2020-10-19T16:38:23Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -154,7 +154,8 @@ public ThingInfo createThing(IotClient client, String policyName, String thingNa\n                     \"{\\n  \\\"Version\\\": \\\"2012-10-17\\\",\\n  \\\"Statement\\\": [\\n    {\\n\"\n                             + \"      \\\"Effect\\\": \\\"Allow\\\",\\n      \\\"Action\\\": [\\n\"\n                             + \"                \\\"iot:Connect\\\",\\n                \\\"iot:Publish\\\",\\n\"\n-                            + \"                \\\"iot:Subscribe\\\",\\n                \\\"iot:Receive\\\"\\n],\\n\"\n+                            + \"                \\\"iot:Subscribe\\\",\\n                \\\"iot:Receive\\\",\\n\"\n+                            + \"                \\\"greengrass:*\\\"\\n],\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NjQ1MA==", "bodyText": "yikes. Link to where you got this from.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507896450", "createdAt": "2020-10-19T16:39:28Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/util/EncryptionUtils.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.aws.greengrass.util;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyFactory;\n+import java.security.PrivateKey;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+import java.security.spec.PKCS8EncodedKeySpec;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+public final class EncryptionUtils {\n+\n+    private static final String PKCS_1_PEM_HEADER = \"-----BEGIN RSA PRIVATE KEY-----\";\n+    private static final String PKCS_1_PEM_FOOTER = \"-----END RSA PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_HEADER = \"-----BEGIN PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_FOOTER = \"-----END PRIVATE KEY-----\";\n+\n+    private EncryptionUtils() {\n+    }\n+\n+    /**\n+     * Populate a list of X509 encryption certificate objects from the given file path.\n+     *\n+     * @param certificatePath certificate file path\n+     * @return a list of X590 certificate objects\n+     * @throws IOException          file IO error\n+     * @throws CertificateException can't populate certificates\n+     */\n+    public static List<X509Certificate> loadX509Certificates(String certificatePath)\n+            throws IOException, CertificateException {\n+        try (InputStream certificateInputStream = Files.newInputStream(Paths.get(certificatePath))) {\n+            CertificateFactory factory = CertificateFactory.getInstance(\"X.509\");\n+            return new ArrayList<>(\n+                    (Collection<? extends X509Certificate>) factory.generateCertificates(certificateInputStream));\n+        }\n+    }\n+\n+    /**\n+     * Load a RSA private key from the given file path.\n+     *\n+     * @param keyPath key file path\n+     * @return a RSA private key\n+     * @throws IOException              file IO error\n+     * @throws GeneralSecurityException can't load private key\n+     */\n+    public static PrivateKey loadPrivateKey(String keyPath) throws IOException, GeneralSecurityException {\n+        byte[] keyBytes = Files.readAllBytes(Paths.get(keyPath));\n+        String keyString = new String(keyBytes, StandardCharsets.UTF_8);\n+\n+        if (keyString.contains(PKCS_1_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_1_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_1_PEM_FOOTER, \"\");\n+            return readPkcs1PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        if (keyString.contains(PKCS_8_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_8_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_8_PEM_FOOTER, \"\");\n+            return readPkcs8PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        return readPkcs8PrivateKey(keyBytes);\n+    }\n+\n+    private static PrivateKey readPkcs8PrivateKey(byte[] pkcs8Bytes) throws GeneralSecurityException {\n+        KeyFactory keyFactory = KeyFactory.getInstance(\"RSA\");\n+        PKCS8EncodedKeySpec keySpec = new PKCS8EncodedKeySpec(pkcs8Bytes);\n+        return keyFactory.generatePrivate(keySpec);\n+    }\n+\n+    private static PrivateKey readPkcs1PrivateKey(byte[] pkcs1Bytes) throws GeneralSecurityException {\n+        // We can't use Java internal APIs to parse ASN.1 structures, so we build a PKCS#8 key Java can understand\n+        int pkcs1Length = pkcs1Bytes.length;\n+        int totalLength = pkcs1Length + 22;\n+        byte[] pkcs8Header = {0x30, (byte) 0x82, (byte) ((totalLength >> 8) & 0xff), (byte) (totalLength & 0xff),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NjYwMA==", "bodyText": "use bouncycastle instead?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507896600", "createdAt": "2020-10-19T16:39:42Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/util/EncryptionUtils.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.aws.greengrass.util;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyFactory;\n+import java.security.PrivateKey;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+import java.security.spec.PKCS8EncodedKeySpec;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+public final class EncryptionUtils {\n+\n+    private static final String PKCS_1_PEM_HEADER = \"-----BEGIN RSA PRIVATE KEY-----\";\n+    private static final String PKCS_1_PEM_FOOTER = \"-----END RSA PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_HEADER = \"-----BEGIN PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_FOOTER = \"-----END PRIVATE KEY-----\";\n+\n+    private EncryptionUtils() {\n+    }\n+\n+    /**\n+     * Populate a list of X509 encryption certificate objects from the given file path.\n+     *\n+     * @param certificatePath certificate file path\n+     * @return a list of X590 certificate objects\n+     * @throws IOException          file IO error\n+     * @throws CertificateException can't populate certificates\n+     */\n+    public static List<X509Certificate> loadX509Certificates(String certificatePath)\n+            throws IOException, CertificateException {\n+        try (InputStream certificateInputStream = Files.newInputStream(Paths.get(certificatePath))) {\n+            CertificateFactory factory = CertificateFactory.getInstance(\"X.509\");\n+            return new ArrayList<>(\n+                    (Collection<? extends X509Certificate>) factory.generateCertificates(certificateInputStream));\n+        }\n+    }\n+\n+    /**\n+     * Load a RSA private key from the given file path.\n+     *\n+     * @param keyPath key file path\n+     * @return a RSA private key\n+     * @throws IOException              file IO error\n+     * @throws GeneralSecurityException can't load private key\n+     */\n+    public static PrivateKey loadPrivateKey(String keyPath) throws IOException, GeneralSecurityException {\n+        byte[] keyBytes = Files.readAllBytes(Paths.get(keyPath));\n+        String keyString = new String(keyBytes, StandardCharsets.UTF_8);\n+\n+        if (keyString.contains(PKCS_1_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_1_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_1_PEM_FOOTER, \"\");\n+            return readPkcs1PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        if (keyString.contains(PKCS_8_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_8_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_8_PEM_FOOTER, \"\");\n+            return readPkcs8PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        return readPkcs8PrivateKey(keyBytes);\n+    }\n+\n+    private static PrivateKey readPkcs8PrivateKey(byte[] pkcs8Bytes) throws GeneralSecurityException {\n+        KeyFactory keyFactory = KeyFactory.getInstance(\"RSA\");\n+        PKCS8EncodedKeySpec keySpec = new PKCS8EncodedKeySpec(pkcs8Bytes);\n+        return keyFactory.generatePrivate(keySpec);\n+    }\n+\n+    private static PrivateKey readPkcs1PrivateKey(byte[] pkcs1Bytes) throws GeneralSecurityException {\n+        // We can't use Java internal APIs to parse ASN.1 structures, so we build a PKCS#8 key Java can understand", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NzE2Ng==", "bodyText": "even though these keys won't do anything, appsec won't like it. Can we instead generate the key during the test?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r507897166", "createdAt": "2020-10-19T16:40:37Z", "author": {"login": "MikeDombo"}, "path": "src/test/resources/com/aws/greengrass/util/encryption/certificate-2048.pem", "diffHunk": "@@ -0,0 +1,19 @@\n+-----BEGIN CERTIFICATE-----\n+MIIDITCCAgmgAwIBAgIJANLIazc8xI4iMA0GCSqGSIb3DQEBBQUAMCcxJTAjBgNV", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e1ee33012101657c13bee05c8fb17ffeaff4bd"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "988229682398e57107778b310c95fe552ab46d2f", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/988229682398e57107778b310c95fe552ab46d2f", "committedDate": "2020-10-22T18:31:38Z", "message": "switch to use moonraker endpoint with mTLS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b56f6d65cc9cef0ae456705530f56ecfbd05713e", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b56f6d65cc9cef0ae456705530f56ecfbd05713e", "committedDate": "2020-10-22T18:31:42Z", "message": "fix integ tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22f7c35d4753196f8d7e45cbd77c596de0718fe2", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/22f7c35d4753196f8d7e45cbd77c596de0718fe2", "committedDate": "2020-10-22T18:31:42Z", "message": "remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "929ea35959a6da1833c30e0304c7b487583fbd65", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/929ea35959a6da1833c30e0304c7b487583fbd65", "committedDate": "2020-10-22T18:32:35Z", "message": "clean unused stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf65ad1a714fb92d9c1a2c3637c101a5340c967a", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cf65ad1a714fb92d9c1a2c3637c101a5340c967a", "committedDate": "2020-10-22T18:32:38Z", "message": "remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fe2c64841fc09c57bf0d234bd03e72130e9f99f", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4fe2c64841fc09c57bf0d234bd03e72130e9f99f", "committedDate": "2020-10-22T18:32:38Z", "message": "add reference to pkcs1 pkcs8 conversion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3541001eb9cef044b9139edaac2bdcf69a9f001c", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3541001eb9cef044b9139edaac2bdcf69a9f001c", "committedDate": "2020-10-22T18:33:08Z", "message": "change to generate key and certificate in unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40bc3a49ce33ab7ad260256344956f3ed7fb617d", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/40bc3a49ce33ab7ad260256344956f3ed7fb617d", "committedDate": "2020-10-22T18:33:59Z", "message": "Merge branch 'moonraker_integration' of https://github.com/aws/aws-greengrass-kernel into moonraker_integration"}, "afterCommit": {"oid": "3541001eb9cef044b9139edaac2bdcf69a9f001c", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3541001eb9cef044b9139edaac2bdcf69a9f001c", "committedDate": "2020-10-22T18:33:08Z", "message": "change to generate key and certificate in unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDMzODM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#pullrequestreview-515033836", "createdAt": "2020-10-22T19:04:09Z", "commit": {"oid": "3541001eb9cef044b9139edaac2bdcf69a9f001c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTowNDowOVrOHmv1DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOTowNDowOVrOHmv1DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM5MTU2NA==", "bodyText": "... I'd say if you didn't find this from Master Card, this is going to take days or weeks to implement. Great job...\nI assume this would be reliable as long as it works... But better to recheck with Device SDK's implementation - if we can find it.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r510391564", "createdAt": "2020-10-22T19:04:09Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/greengrass/util/EncryptionUtils.java", "diffHunk": "@@ -0,0 +1,105 @@\n+package com.aws.greengrass.util;\n+\n+import org.apache.commons.codec.binary.Base64;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyFactory;\n+import java.security.PrivateKey;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+import java.security.spec.PKCS8EncodedKeySpec;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+public final class EncryptionUtils {\n+\n+    private static final String PKCS_1_PEM_HEADER = \"-----BEGIN RSA PRIVATE KEY-----\";\n+    private static final String PKCS_1_PEM_FOOTER = \"-----END RSA PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_HEADER = \"-----BEGIN PRIVATE KEY-----\";\n+    private static final String PKCS_8_PEM_FOOTER = \"-----END PRIVATE KEY-----\";\n+\n+    private EncryptionUtils() {\n+    }\n+\n+    /**\n+     * Populate a list of X509 encryption certificate objects from the given file path.\n+     *\n+     * @param certificatePath certificate file path\n+     * @return a list of X590 certificate objects\n+     * @throws IOException          file IO error\n+     * @throws CertificateException can't populate certificates\n+     */\n+    public static List<X509Certificate> loadX509Certificates(String certificatePath)\n+            throws IOException, CertificateException {\n+        try (InputStream certificateInputStream = Files.newInputStream(Paths.get(certificatePath))) {\n+            CertificateFactory factory = CertificateFactory.getInstance(\"X.509\");\n+            return new ArrayList<>(\n+                    (Collection<? extends X509Certificate>) factory.generateCertificates(certificateInputStream));\n+        }\n+    }\n+\n+    /**\n+     * Load a RSA private key from the given file path.\n+     *\n+     * @param keyPath key file path\n+     * @return a RSA private key\n+     * @throws IOException              file IO error\n+     * @throws GeneralSecurityException can't load private key\n+     */\n+    public static PrivateKey loadPrivateKey(String keyPath) throws IOException, GeneralSecurityException {\n+        byte[] keyBytes = Files.readAllBytes(Paths.get(keyPath));\n+        String keyString = new String(keyBytes, StandardCharsets.UTF_8);\n+\n+        if (keyString.contains(PKCS_1_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_1_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_1_PEM_FOOTER, \"\");\n+            return readPkcs1PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        if (keyString.contains(PKCS_8_PEM_HEADER)) {\n+            keyString = keyString.replace(PKCS_8_PEM_HEADER, \"\");\n+            keyString = keyString.replace(PKCS_8_PEM_FOOTER, \"\");\n+            return readPkcs8PrivateKey(Base64.decodeBase64(keyString));\n+        }\n+\n+        return readPkcs8PrivateKey(keyBytes);\n+    }\n+\n+    private static PrivateKey readPkcs8PrivateKey(byte[] pkcs8Bytes) throws GeneralSecurityException {\n+        KeyFactory keyFactory = KeyFactory.getInstance(\"RSA\");\n+        PKCS8EncodedKeySpec keySpec = new PKCS8EncodedKeySpec(pkcs8Bytes);\n+        return keyFactory.generatePrivate(keySpec);\n+    }\n+\n+    private static PrivateKey readPkcs1PrivateKey(byte[] pkcs1Bytes) throws GeneralSecurityException {\n+        // We can't use Java internal APIs to parse ASN.1 structures, so we build a PKCS#8 key Java can understand\n+        int pkcs1Length = pkcs1Bytes.length;\n+        int totalLength = pkcs1Length + 22;\n+        // reference to https://github.com/Mastercard/client-encryption-java/blob/master/src/main/java/com/mastercard/developer/utils/EncryptionUtils.java#L95-L100\n+        // this method can save us from importing BouncyCastle as dependency\n+        byte[] pkcs8Header = {0x30, (byte) 0x82, (byte) ((totalLength >> 8) & 0xff), (byte) (totalLength & 0xff),\n+                // Sequence + total length\n+                0x2, 0x1, 0x0, // Integer (0)\n+                0x30, 0xD, 0x6, 0x9, 0x2A, (byte) 0x86, 0x48, (byte) 0x86, (byte) 0xF7, 0xD, 0x1, 0x1, 0x1, 0x5, 0x0,\n+                // Sequence: 1.2.840.113549.1.1.1, NULL\n+                0x4, (byte) 0x82, (byte) ((pkcs1Length >> 8) & 0xff), (byte) (pkcs1Length & 0xff)\n+                // Octet string + length\n+        };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3541001eb9cef044b9139edaac2bdcf69a9f001c"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1bcf2f44d4495a54688691bf63c707ee02b3222", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f1bcf2f44d4495a54688691bf63c707ee02b3222", "committedDate": "2020-10-22T20:11:20Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69f5a6582f4ad917767d87a925735a9e4554fa2d", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/69f5a6582f4ad917767d87a925735a9e4554fa2d", "committedDate": "2020-10-22T21:28:49Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa4a5f460d87a7cfc13e3ae019086dc4b6b5f4c6", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fa4a5f460d87a7cfc13e3ae019086dc4b6b5f4c6", "committedDate": "2020-10-23T06:36:47Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "322746718cfdc67d3e8c6d49d767bfe3cd6b93be", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/322746718cfdc67d3e8c6d49d767bfe3cd6b93be", "committedDate": "2020-10-23T17:45:00Z", "message": "switch to take http body of getComponentArtifact API since MR doesn't support http header forward"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97e099f63aa167e6b6ffc49e1994c9381aac712d", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/97e099f63aa167e6b6ffc49e1994c9381aac712d", "committedDate": "2020-10-23T18:33:44Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c42e4faf730aad77d2836f4156be12e3aa3411ef", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c42e4faf730aad77d2836f4156be12e3aa3411ef", "committedDate": "2020-10-26T16:23:41Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18af24d734fe708cb0d2104f85469ea34b0b0a6b", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/18af24d734fe708cb0d2104f85469ea34b0b0a6b", "committedDate": "2020-10-26T16:45:45Z", "message": "remove dead import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b1f4ba5d1cafba4b035add040502a9a7548df45", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3b1f4ba5d1cafba4b035add040502a9a7548df45", "committedDate": "2020-10-26T19:50:52Z", "message": "Merge remote-tracking branch 'origin/master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "191f983496a49567ce2a9ba59420b5e8760005f9", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/191f983496a49567ce2a9ba59420b5e8760005f9", "committedDate": "2020-10-27T00:51:59Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04646a47d472b0e4a7b8ca9dbc48a6942f8fa35b", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/04646a47d472b0e4a7b8ca9dbc48a6942f8fa35b", "committedDate": "2020-10-27T01:19:51Z", "message": "switch to beta endpoint temporarily"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "284e6eea5416b548bfe66fe0e5d21d961b594dc0", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/284e6eea5416b548bfe66fe0e5d21d961b594dc0", "committedDate": "2020-10-27T02:16:42Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d94b634b6f5802dcea8c37dcb9af9c2c5eabc4b0", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d94b634b6f5802dcea8c37dcb9af9c2c5eabc4b0", "committedDate": "2020-10-27T02:21:41Z", "message": "add copyright headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8545a209407aef29c6bcfdf325be6ca096ead3e", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f8545a209407aef29c6bcfdf325be6ca096ead3e", "committedDate": "2020-10-27T03:16:24Z", "message": "delete e2e test case not applicable any more"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTA4ODM3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#pullrequestreview-517908837", "createdAt": "2020-10-27T16:33:02Z", "commit": {"oid": "f8545a209407aef29c6bcfdf325be6ca096ead3e"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozMzowMlrOHpFqcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozMzowMlrOHpFqcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NjQ1MA==", "bodyText": "nice...", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#discussion_r512846450", "createdAt": "2020-10-27T16:33:02Z", "author": {"login": "leaf94"}, "path": "pom.xml", "diffHunk": "@@ -101,7 +101,7 @@\n         <dependency>\n             <groupId>com.amazonaws.services</groupId>\n             <artifactId>evergreen</artifactId>\n-            <version>1.0.0-SNAPSHOT</version>\n+            <version>1.0.0-MR-SNAPSHOT</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8545a209407aef29c6bcfdf325be6ca096ead3e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38f4a1dbbf7020a842dd651df01ead065e518c32", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/38f4a1dbbf7020a842dd651df01ead065e518c32", "committedDate": "2020-10-27T17:58:17Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e18069cb461df4acfbc0660b34d1d1f059546e5", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5e18069cb461df4acfbc0660b34d1d1f059546e5", "committedDate": "2020-10-27T17:58:28Z", "message": "switch back to gamma"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fae8ea8b438f1dcd9fa68ed19d7a0d07817b8ee", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0fae8ea8b438f1dcd9fa68ed19d7a0d07817b8ee", "committedDate": "2020-10-27T18:36:15Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDI2MzYw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#pullrequestreview-518026360", "createdAt": "2020-10-27T18:37:38Z", "commit": {"oid": "5e18069cb461df4acfbc0660b34d1d1f059546e5"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MTQ3NTg2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#pullrequestreview-518147586", "createdAt": "2020-10-27T21:01:30Z", "commit": {"oid": "0fae8ea8b438f1dcd9fa68ed19d7a0d07817b8ee"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8919f4da5873779f41e7b680ed0a02b24ecff9d", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e8919f4da5873779f41e7b680ed0a02b24ecff9d", "committedDate": "2020-10-27T21:01:50Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ff1f1536ecbba90923eaa33f0bbec12652cadee", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ff1f1536ecbba90923eaa33f0bbec12652cadee", "committedDate": "2020-10-29T17:02:58Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a0a5008c9cfb080431733a1067f2bde7d221196", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3a0a5008c9cfb080431733a1067f2bde7d221196", "committedDate": "2020-10-29T19:20:38Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fde5a3a7f085ab34f55b6dc3ef1602aa0a925ab", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0fde5a3a7f085ab34f55b6dc3ef1602aa0a925ab", "committedDate": "2020-10-30T00:02:34Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "899272aeeec881aeafeb2764a2b3b6683feac553", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/899272aeeec881aeafeb2764a2b3b6683feac553", "committedDate": "2020-10-30T00:27:37Z", "message": "remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5aed5b6687ec9b81ab051a365d40472bf6ceaf0f", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5aed5b6687ec9b81ab051a365d40472bf6ceaf0f", "committedDate": "2020-10-30T02:12:26Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "667aea0372d5eb40b89a7d4a76a4aecd1b6126ed", "author": {"user": {"login": "wikimonkey", "name": "Jason Wang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/667aea0372d5eb40b89a7d4a76a4aecd1b6126ed", "committedDate": "2020-10-30T17:48:13Z", "message": "Merge branch 'master' into moonraker_integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49410e58969340e7f45a9f44a1e607a0ce78c874", "author": {"user": null}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/49410e58969340e7f45a9f44a1e607a0ce78c874", "committedDate": "2020-10-30T19:04:48Z", "message": "ignore unrelated exception in fleet status service test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTk4OTU2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#pullrequestreview-520998956", "createdAt": "2020-10-30T20:05:38Z", "commit": {"oid": "49410e58969340e7f45a9f44a1e607a0ce78c874"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDEyNDA1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/543#pullrequestreview-521012405", "createdAt": "2020-10-30T20:29:37Z", "commit": {"oid": "49410e58969340e7f45a9f44a1e607a0ce78c874"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2785, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}