{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMzgxMjkw", "number": 596, "title": "Set artifact permissions according to recipe artifact permissions", "bodyText": "Issue #, if available:\nDescription of changes:\nSet the permissions based on whatever the recipe has for artifacts. Defaults to Readonly for user if not present.\nThis lets you specify artifacts as executable or world readable without having to do chmod.\nYou can still chmod artifacts in the recipe if you want though.\nPermission and PermissionType are copied from the common model.\nThis is backwards compatible - the previous code was setting everything to read only by default.\nWhy is this change necessary:\nHow was this change tested:\nRan unit, integ, and updated e2e tests\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-31T06:16:04Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596", "merged": true, "mergeCommit": {"oid": "452671cecaea8969d3db858ea073c1b97257998f"}, "closed": true, "closedAt": "2020-11-02T16:44:12Z", "author": {"login": "rbattle"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdX1K-bgH2gAyNTEzMzgxMjkwOjBhOTBhNjJmZTU3MTI0ZWRkOGI0YjQ0MDI4YzEyMjMyMzk4NTA0ZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYnXZKAFqTUyMTgwNTEzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a90a62fe57124edd8b4b44028c12232398504ed", "author": {"user": {"login": "rbattle", "name": "Robert Battle"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0a90a62fe57124edd8b4b44028c12232398504ed", "committedDate": "2020-10-31T06:14:27Z", "message": "Set artifact permissions according to recipe artifact permissions\n\nDefaults to Readonly for user if not present"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c199df3563d60f657f736f3d6e99c70cf9402be7", "author": {"user": {"login": "rbattle", "name": "Robert Battle"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c199df3563d60f657f736f3d6e99c70cf9402be7", "committedDate": "2020-10-31T06:16:14Z", "message": "Merge branch 'master' into artifact-perms"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMTE3ODgz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#pullrequestreview-521117883", "createdAt": "2020-10-31T06:42:52Z", "commit": {"oid": "c199df3563d60f657f736f3d6e99c70cf9402be7"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwNjo0Mjo1MlrOHrlbtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQwNjo0NjoyOVrOHrlc2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ2NDExOA==", "bodyText": "Indentation seems to be 8 spaces per tab, but our regular style is 4.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515464118", "createdAt": "2020-10-31T06:42:52Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/models/Permission.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.componentmanager.models;\n+\n+import com.aws.greengrass.util.FileSystemPermission;\n+import lombok.Builder;\n+import lombok.NonNull;\n+import lombok.Value;\n+\n+\n+/**\n+ * Permission settings for component artifacts. Read and Execute permissions can be set.\n+ * By default, the read permission is set to allow only the owner of the artifact on the disk and the execute permission\n+ * is set to NONE.\n+ */\n+@Value\n+@Builder\n+public class Permission {\n+        @NonNull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c199df3563d60f657f736f3d6e99c70cf9402be7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ2NDI2Mw==", "bodyText": "check s for null? Otherwise the toUppeCase can throw a NPE", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515464263", "createdAt": "2020-10-31T06:44:44Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/models/PermissionType.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.componentmanager.models;\n+\n+/**\n+ * Permission attribute to set. In Linux this corresponds to setting the User or Other bits of the standard POSIX\n+ * file permissions. In Windows this would correspond with modifying the ACL for owner and \"Everyone\" groups.\n+ */\n+public enum PermissionType {\n+    /**\n+     * No permissions.\n+     */\n+    NONE,\n+    /**\n+     * Owner of file has permission.\n+     */\n+    OWNER,\n+    /**\n+     * All users have permission.\n+     */\n+    ALL;\n+\n+    public static PermissionType fromString(String s) {\n+        return PermissionType.valueOf(s.toUpperCase());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c199df3563d60f657f736f3d6e99c70cf9402be7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ2NDQxMQ==", "bodyText": "add our GGExtension", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515464411", "createdAt": "2020-10-31T06:46:29Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/greengrass/util/PermissionsTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+import static com.aws.greengrass.testcommons.testutilities.Matchers.hasPermission;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+\n+@EnabledOnOs({OS.LINUX, OS.MAC})\n+class PermissionsTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c199df3563d60f657f736f3d6e99c70cf9402be7"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2a8009466858f72f2c6fb7d058e9a0697ddf824", "author": {"user": {"login": "rbattle", "name": "Robert Battle"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f2a8009466858f72f2c6fb7d058e9a0697ddf824", "committedDate": "2020-10-31T07:13:13Z", "message": "Cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMTUzMjM4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#pullrequestreview-521153238", "createdAt": "2020-10-31T16:51:49Z", "commit": {"oid": "f2a8009466858f72f2c6fb7d058e9a0697ddf824"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQxNjo1MTo0OVrOHrolnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMVQxNjo1OToxMlrOHrooRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNTgwNA==", "bodyText": "We don't model group as a permission type? How can the customer specify that an component can only be accessed by a group?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515515804", "createdAt": "2020-10-31T16:51:49Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/componentmanager/models/PermissionType.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.componentmanager.models;\n+\n+/**\n+ * Permission attribute to set. In Linux this corresponds to setting the User or Other bits of the standard POSIX\n+ * file permissions. In Windows this would correspond with modifying the ACL for owner and \"Everyone\" groups.\n+ */\n+public enum PermissionType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2a8009466858f72f2c6fb7d058e9a0697ddf824"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNjMyMw==", "bodyText": "Why is the group's permission set by the ALL instead of OWNER. Isn't group also a type of OWNER?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515516323", "createdAt": "2020-10-31T16:57:06Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/componentmanager/models/Permission.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.componentmanager.models;\n+\n+import com.aws.greengrass.util.FileSystemPermission;\n+import lombok.Builder;\n+import lombok.NonNull;\n+import lombok.Value;\n+\n+\n+/**\n+ * Permission settings for component artifacts. Read and Execute permissions can be set. By default, the read permission\n+ * is set to allow only the owner of the artifact on the disk and the execute permission is set to NONE.\n+ */\n+@Value\n+@Builder\n+public class Permission {\n+    @NonNull\n+    @Builder.Default\n+    PermissionType read = PermissionType.OWNER;\n+    @NonNull\n+    @Builder.Default\n+    PermissionType execute = PermissionType.NONE;\n+\n+    /**\n+     * Convert to file system permission.\n+     *\n+     * @return a permission.\n+     */\n+    public FileSystemPermission toFileSystemPermission() {\n+        return FileSystemPermission.builder()\n+                .ownerRead(true) // we always want owner to read\n+                .ownerExecute(execute == PermissionType.ALL || execute == PermissionType.OWNER)\n+                .groupRead(read == PermissionType.ALL)\n+                .groupExecute(execute == PermissionType.ALL)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2a8009466858f72f2c6fb7d058e9a0697ddf824"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUxNjQ4NQ==", "bodyText": "What happens if the nucleus is run with a non-root user?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#discussion_r515516485", "createdAt": "2020-10-31T16:59:12Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -346,9 +346,9 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n             }\n             File artifactFile = downloader.getArtifactFile(packageArtifactDirectory, artifact, componentIdentifier);\n             if (artifactFile != null) {\n-                // TODO: Change permissions - set world readable until artifact permissions can be set via model\n                 try {\n-                    Permissions.setArtifactPermission(artifactFile.toPath());\n+                    Permissions.setArtifactPermission(artifactFile.toPath(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2a8009466858f72f2c6fb7d058e9a0697ddf824"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b3f5fb02368383b4eb2553092a2fe5b03befb46", "author": {"user": {"login": "rbattle", "name": "Robert Battle"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0b3f5fb02368383b4eb2553092a2fe5b03befb46", "committedDate": "2020-11-02T03:42:50Z", "message": "Set group permissions when OWNER is specified. Set read permissions when execute is specified"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17a0ac68991e79d09f7e585b12f9efe985f9da6f", "author": {"user": {"login": "rbattle", "name": "Robert Battle"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/17a0ac68991e79d09f7e585b12f9efe985f9da6f", "committedDate": "2020-11-02T03:43:26Z", "message": "Merge remote-tracking branch 'origin/master' into artifact-perms"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMzIyOTM5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#pullrequestreview-521322939", "createdAt": "2020-11-02T04:16:13Z", "commit": {"oid": "17a0ac68991e79d09f7e585b12f9efe985f9da6f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMzI1NzU0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#pullrequestreview-521325754", "createdAt": "2020-11-02T04:30:02Z", "commit": {"oid": "17a0ac68991e79d09f7e585b12f9efe985f9da6f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "016138f4d34ff13a63f19811fe370cd3364d5315", "author": {"user": {"login": "rbattle", "name": "Robert Battle"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/016138f4d34ff13a63f19811fe370cd3364d5315", "committedDate": "2020-11-02T07:05:08Z", "message": "Fix E2E test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNzY1NDY0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#pullrequestreview-521765464", "createdAt": "2020-11-02T16:01:19Z", "commit": {"oid": "016138f4d34ff13a63f19811fe370cd3364d5315"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxODA1MTM4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/596#pullrequestreview-521805138", "createdAt": "2020-11-02T16:43:16Z", "commit": {"oid": "016138f4d34ff13a63f19811fe370cd3364d5315"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2881, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}