{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MDcyNjYz", "number": 646, "title": "Fix for rolling back when the previous state also had a broken component", "bodyText": "Issue #, if available:\nDescription of changes:\nUpdate to the rollback behavior so that it can ignore when components are broken after rolling back if they were broken before the new merge anyway.\nWhy is this change necessary:\nHow was this change tested:\nScenario:\nDeploy BrokenService without rollback so that it is persisted in a broken state\nDeploy BrokenService2 with rollback so that it breaks and then starts to rollback.\nWithout this change it would get stuck waiting for BrokenService to stop being broken, but now it can ignore the state since it was previously broken.\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-09T22:17:11Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/646", "merged": true, "mergeCommit": {"oid": "0fc30a0ecb5c543a8bc11a356ac39af2d5d76d2e"}, "closed": true, "closedAt": "2020-11-10T02:42:51Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda8fWogBqjM5NzYwNzg5NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda_8TQgFqTUyNjgwNjE3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2cf9e9ee017b3b7e1a26aa5cef757ce45c8c13a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d2cf9e9ee017b3b7e1a26aa5cef757ce45c8c13a", "committedDate": "2020-11-09T22:16:44Z", "message": "Fix for rolling back when the previous state also had a broken component"}, "afterCommit": {"oid": "52c13504965015f3d39e642619edd8e9a62eff2a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/52c13504965015f3d39e642619edd8e9a62eff2a", "committedDate": "2020-11-09T22:27:41Z", "message": "Fix for rolling back when the previous state also had a broken component"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52c13504965015f3d39e642619edd8e9a62eff2a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/52c13504965015f3d39e642619edd8e9a62eff2a", "committedDate": "2020-11-09T22:27:41Z", "message": "Fix for rolling back when the previous state also had a broken component"}, "afterCommit": {"oid": "da4974b3e9fc99a70df04e5cec983d8f9f1261f1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/da4974b3e9fc99a70df04e5cec983d8f9f1261f1", "committedDate": "2020-11-09T22:49:01Z", "message": "Fix for rolling back when the previous state also had a broken component"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da4974b3e9fc99a70df04e5cec983d8f9f1261f1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/da4974b3e9fc99a70df04e5cec983d8f9f1261f1", "committedDate": "2020-11-09T22:49:01Z", "message": "Fix for rolling back when the previous state also had a broken component"}, "afterCommit": {"oid": "334a7db66f84bc9dae0003b6697f917d0f511415", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/334a7db66f84bc9dae0003b6697f917d0f511415", "committedDate": "2020-11-09T23:04:44Z", "message": "Fix for rolling back when the previous state also had a broken component"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "334a7db66f84bc9dae0003b6697f917d0f511415", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/334a7db66f84bc9dae0003b6697f917d0f511415", "committedDate": "2020-11-09T23:04:44Z", "message": "Fix for rolling back when the previous state also had a broken component"}, "afterCommit": {"oid": "a95b5212d56b173f372ad67acff3685263378e37", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a95b5212d56b173f372ad67acff3685263378e37", "committedDate": "2020-11-09T23:18:00Z", "message": "Fix for rolling back when the previous state also had a broken component"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Nzc2NTcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/646#pullrequestreview-526776573", "createdAt": "2020-11-10T01:07:37Z", "commit": {"oid": "a95b5212d56b173f372ad67acff3685263378e37"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Nzg1MjIy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/646#pullrequestreview-526785222", "createdAt": "2020-11-10T01:28:45Z", "commit": {"oid": "a95b5212d56b173f372ad67acff3685263378e37"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMToyODo0NlrOHwIMIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMToyODo0NlrOHwIMIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIyNzg3NQ==", "bodyText": "Is it worth logging that these services are already broken and that we are not going to track them for failed rollback?\nThe services to track are logged below, but it could be useful info to log as another kv there that there are services we are ignoring. If there's a ton of logs between the services breaking and the deployment it may not be obvious.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/646#discussion_r520227875", "createdAt": "2020-11-10T01:28:46Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/deployment/activator/DefaultActivator.java", "diffHunk": "@@ -146,6 +146,10 @@ void rollback(DeploymentDocument deploymentDocument, CompletableFuture<Deploymen\n \n         try {\n             Set<GreengrassService> servicesToTrackForRollback = rollbackManager.servicesToTrack();\n+            // Don't track services if they were already broken before the rolled back deployment, because they'd\n+            // be expected to still be broken\n+            servicesToTrackForRollback.removeIf((s) ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a95b5212d56b173f372ad67acff3685263378e37"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Nzg1MzU2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/646#pullrequestreview-526785356", "createdAt": "2020-11-10T01:29:04Z", "commit": {"oid": "a95b5212d56b173f372ad67acff3685263378e37"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "393da8e341c594d43591ebca3962cc4d4af8f556", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/393da8e341c594d43591ebca3962cc4d4af8f556", "committedDate": "2020-11-10T01:45:17Z", "message": "Fix for rolling back when the previous state also had a broken component"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a95b5212d56b173f372ad67acff3685263378e37", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a95b5212d56b173f372ad67acff3685263378e37", "committedDate": "2020-11-09T23:18:00Z", "message": "Fix for rolling back when the previous state also had a broken component"}, "afterCommit": {"oid": "393da8e341c594d43591ebca3962cc4d4af8f556", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/393da8e341c594d43591ebca3962cc4d4af8f556", "committedDate": "2020-11-10T01:45:17Z", "message": "Fix for rolling back when the previous state also had a broken component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d97cf3d844c37e7ffc9d301ce0f0167e1db9304c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d97cf3d844c37e7ffc9d301ce0f0167e1db9304c", "committedDate": "2020-11-10T02:25:43Z", "message": "Merge branch 'master' into rollback-broken"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODA1Mjg1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/646#pullrequestreview-526805285", "createdAt": "2020-11-10T02:26:35Z", "commit": {"oid": "d97cf3d844c37e7ffc9d301ce0f0167e1db9304c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODA2MTc1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/646#pullrequestreview-526806175", "createdAt": "2020-11-10T02:29:09Z", "commit": {"oid": "d97cf3d844c37e7ffc9d301ce0f0167e1db9304c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2616, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}