{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MzIzNTU5", "number": 149, "title": "Package store cleanup", "bodyText": "Issue #, if available:\nDescription of changes:\nThis is the consolidation and cleanup work for our PackageStore, LocalPackageStore, PackageCache. Details are the folllowing:\n\n\nThe new PackageStore will be the foundation for package store APIs.\n\nRenamed from PackageCache.\nCopied over all currently used methods from LocalPackageStore to keep existing tests working.\nAdded the new method signature getPackageMetadata that we wants to implement.\nPublic APIs are:\n\npreparePackages\ngetRecipe\ngetPackageMetadata\n\n\n\n\n\nRenamed for  short-term references. Most likely they will be removed by end of this sprint.\n\nPackageStore -> PackageStoreDeprecated.\nLocalPackageStore -> LocalPackageStoreDeprecated.\n\n\n\nDependency Injection is fixed in DeploymentService and tests. No need to use @Setter or initialize separately.\n\n\nRemoved PackageManager, PackageRegistry and PackageRegistryImpl since we don't need them anymore.\n\n\nWhy is this change necessary:\nSo that we have 1 packageStore. Without breaking existing tests, we can start working on implementing the public APIs in parallel.\nHow was this change tested:\nmvn verify\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-02T02:34:44Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149", "merged": true, "mergeCommit": {"oid": "25dae279067cd0d3a5a826191bd69849a16c9fd4"}, "closed": true, "closedAt": "2020-04-02T19:02:03Z", "author": {"login": "leaf94"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTiVNfgH2gAyMzk3MzIzNTU5OmYzODNjYTVjMGNhMDgxMWRiM2MzMzY2YjgzNjBmYTFhMDNmMzAzZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTxDm-AFqTM4NjcxMTk1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f383ca5c0ca0811db3c3366b8360fa1a03f303f3", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f383ca5c0ca0811db3c3366b8360fa1a03f303f3", "committedDate": "2020-04-02T01:50:35Z", "message": "save"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c7a46a4f6bec7120e75fe4e725b1a1e23d3716d", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9c7a46a4f6bec7120e75fe4e725b1a1e23d3716d", "committedDate": "2020-04-02T01:51:42Z", "message": "save"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5de30b4e44ee590a90ccde4867b9bdbc280f1eb0", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5de30b4e44ee590a90ccde4867b9bdbc280f1eb0", "committedDate": "2020-04-02T02:09:04Z", "message": "all test passed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01e4ccc11e656bd92266bda5a0617625518d672a", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/01e4ccc11e656bd92266bda5a0617625518d672a", "committedDate": "2020-04-02T02:10:47Z", "message": "done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa54b13d22fb9fc8052e8fd9e8031df274e12dba", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fa54b13d22fb9fc8052e8fd9e8031df274e12dba", "committedDate": "2020-04-02T02:36:04Z", "message": "Merge branch 'master' into package_store_cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fd3ccec9f5612e93eab8f313d6e9226eb23a2cf", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2fd3ccec9f5612e93eab8f313d6e9226eb23a2cf", "committedDate": "2020-04-02T02:44:25Z", "message": "Add copyright header to PackageStore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MDczODcy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149#pullrequestreview-386073872", "createdAt": "2020-04-02T02:42:16Z", "commit": {"oid": "fa54b13d22fb9fc8052e8fd9e8031df274e12dba"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMjo0MjoxNlrOF_ZYNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMjo0NjoyOVrOF_ZcaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyMDQwNg==", "bodyText": "This needs to be injected from Config or something.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149#discussion_r402020406", "createdAt": "2020-04-02T02:42:16Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.aws.iot.evergreen.packagemanager;\n+\n+import com.aws.iot.evergreen.packagemanager.config.Constants;\n+import com.aws.iot.evergreen.packagemanager.exceptions.PackagingException;\n+import com.aws.iot.evergreen.packagemanager.exceptions.UnexpectedPackagingException;\n+import com.aws.iot.evergreen.packagemanager.exceptions.UnsupportedRecipeFormatException;\n+import com.aws.iot.evergreen.packagemanager.models.Package;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStoreDeprecated;\n+import com.aws.iot.evergreen.util.SerializerFactory;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.SemverException;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Future;\n+\n+@SuppressWarnings({\"PMD.AvoidPrintStackTrace\", \"PMD.IdenticalCatchBranches\"})\n+public class PackageStore {\n+    private static final Path LOCAL_CACHE_PATH =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa54b13d22fb9fc8052e8fd9e8031df274e12dba"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAyMTQ4MA==", "bodyText": "Where did all this go? Looks like this hasn't been copied over to PackageStore. Feels like we still need it, or am I wrong?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149#discussion_r402021480", "createdAt": "2020-04-02T02:46:29Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageManager.java", "diffHunk": "@@ -1,282 +0,0 @@\n-/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n- * SPDX-License-Identifier: Apache-2.0 */\n-\n-package com.aws.iot.evergreen.packagemanager;\n-\n-import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n-import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n-import com.aws.iot.evergreen.packagemanager.exceptions.PackageVersionConflictException;\n-import com.aws.iot.evergreen.packagemanager.exceptions.PackagingException;\n-import com.aws.iot.evergreen.packagemanager.models.Package;\n-import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n-import com.aws.iot.evergreen.packagemanager.models.PackageRegistryEntry;\n-import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n-import com.aws.iot.evergreen.packagemanager.plugins.PackageStore;\n-import com.vdurmont.semver4j.Semver;\n-\n-import java.io.IOException;\n-import java.nio.file.Path;\n-import java.nio.file.Paths;\n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.HashSet;\n-import java.util.LinkedList;\n-import java.util.Map;\n-import java.util.Optional;\n-import java.util.Queue;\n-import java.util.Set;\n-import java.util.concurrent.ExecutorService;\n-import java.util.concurrent.Executors;\n-import java.util.concurrent.Future;\n-import java.util.function.Function;\n-import java.util.stream.Collectors;\n-\n-public class PackageManager {\n-\n-    // TODO: Temporary hard coding, this should be initialized from config\n-    private static final Path CACHE_DIRECTORY = Paths.get(System.getProperty(\"user.dir\")).resolve(\"artifact_cache\");\n-    private static final Path LOCAL_PACKAGE_SOURCE =\n-            Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n-\n-    private final ExecutorService executorService = Executors.newSingleThreadExecutor();\n-\n-    private final PackageRegistry packageRegistry;\n-\n-    private final PackageStore localCache;\n-\n-    // TODO: Temporary, should be list of stores\n-    private final PackageStore mockPackageRepository;\n-\n-    /**\n-     * Constructor with hardcoded local cache and mock source paths.\n-     */\n-    public PackageManager() {\n-        this.localCache = new LocalPackageStore(CACHE_DIRECTORY);\n-        this.mockPackageRepository = new LocalPackageStore(LOCAL_PACKAGE_SOURCE);\n-        this.packageRegistry = new PackageRegistryImpl();\n-    }\n-\n-    //TODO mock package store in unit tests, remove this constructor\n-    @Deprecated\n-    PackageManager(final PackageRegistry packageRegistry, final Path cacheDirPath, final Path mockDirPath) {\n-        this.localCache = new LocalPackageStore(cacheDirPath);\n-        this.mockPackageRepository = new LocalPackageStore(mockDirPath);\n-        this.packageRegistry = packageRegistry;\n-    }\n-\n-    PackageManager(final PackageRegistry packageRegistry, PackageStore localCache, PackageStore mockRepository) {\n-        this.localCache = localCache;\n-        this.packageRegistry = packageRegistry;\n-        this.mockPackageRepository = mockRepository;\n-    }\n-\n-    /**\n-     * Given a set of proposed package dependency trees.\n-     *\n-     * @param proposedPackages The set of proposed packages to resolve dependencies for\n-     * @return the local resolved dependency tress in the future\n-     */\n-    public Future<Set<Package>> resolvePackages(Set<PackageMetadata> proposedPackages) {\n-        return executorService.submit(() -> resolveDependencies(proposedPackages));\n-    }\n-\n-    private Set<Package> resolveDependencies(Set<PackageMetadata> proposedPackages)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fd3ccec9f5612e93eab8f313d6e9226eb23a2cf"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54f3809eae99db16848d7d39b602c4c1103a1bfe", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/54f3809eae99db16848d7d39b602c4c1103a1bfe", "committedDate": "2020-04-02T04:53:57Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NTc4MTA5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149#pullrequestreview-386578109", "createdAt": "2020-04-02T16:08:37Z", "commit": {"oid": "54f3809eae99db16848d7d39b602c4c1103a1bfe"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c9ce7cbd3663ea7b73c777eed31c5357d02e329", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7c9ce7cbd3663ea7b73c777eed31c5357d02e329", "committedDate": "2020-04-02T17:00:42Z", "message": "Clean up used imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bd7e30f2287d9f9d51bc116b7e0d1dd8e105f3d", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8bd7e30f2287d9f9d51bc116b7e0d1dd8e105f3d", "committedDate": "2020-04-02T17:10:25Z", "message": "Clean up used imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NjYyNDI2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149#pullrequestreview-386662426", "createdAt": "2020-04-02T17:51:55Z", "commit": {"oid": "8bd7e30f2287d9f9d51bc116b7e0d1dd8e105f3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NzExOTU5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/149#pullrequestreview-386711959", "createdAt": "2020-04-02T18:59:56Z", "commit": {"oid": "8bd7e30f2287d9f9d51bc116b7e0d1dd8e105f3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2399, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}