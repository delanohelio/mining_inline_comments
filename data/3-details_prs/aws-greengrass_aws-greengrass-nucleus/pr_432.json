{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1MzM4ODM2", "number": 432, "title": "Lots and lots and lots of test fixes (See description)", "bodyText": "Issue #, if available:\nDescription of changes:\n\nReduces test time by 2 minutes for unit/integ\nFixes bug which prevented proper shutdown of a generic external service when the executor is interrupted.\nDisable broken e2e test.\nFlip common library back to master.\nFlip cloud endpoint back to gamma.\nCleans up threads created in unit tests to ensure they actually shutdown.\nUpdates Evergreen SDK\nUpdates E2E fleet safety policies\n\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-11T18:25:37Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/432", "merged": true, "mergeCommit": {"oid": "63f6e3ff6377a99b4cd30148c0a4709d367fe9f8"}, "closed": true, "closedAt": "2020-09-13T20:28:46Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH5tpQgBqjM3NTc1MDUyNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIjjWTgFqTQ4NzMzMjUxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "54b6d81c0eddcc576b4363d7f6d3260ceabc2a8d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/54b6d81c0eddcc576b4363d7f6d3260ceabc2a8d", "committedDate": "2020-09-11T18:25:17Z", "message": "Debug test run"}, "afterCommit": {"oid": "e92c83383e6b9f1256e059c4a45bfcab6885a387", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e92c83383e6b9f1256e059c4a45bfcab6885a387", "committedDate": "2020-09-11T18:28:51Z", "message": "Debug test run"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e92c83383e6b9f1256e059c4a45bfcab6885a387", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e92c83383e6b9f1256e059c4a45bfcab6885a387", "committedDate": "2020-09-11T18:28:51Z", "message": "Debug test run"}, "afterCommit": {"oid": "25a50750c8c9508efdd68e169b8114c4b2e73714", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/25a50750c8c9508efdd68e169b8114c4b2e73714", "committedDate": "2020-09-11T18:35:00Z", "message": "Debug test run"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "25a50750c8c9508efdd68e169b8114c4b2e73714", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/25a50750c8c9508efdd68e169b8114c4b2e73714", "committedDate": "2020-09-11T18:35:00Z", "message": "Debug test run"}, "afterCommit": {"oid": "7719031671eaac7f9616fe22dadaa900c1efc497", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7719031671eaac7f9616fe22dadaa900c1efc497", "committedDate": "2020-09-11T18:36:39Z", "message": "Debug test run"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7719031671eaac7f9616fe22dadaa900c1efc497", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7719031671eaac7f9616fe22dadaa900c1efc497", "committedDate": "2020-09-11T18:36:39Z", "message": "Debug test run"}, "afterCommit": {"oid": "385e997c9f2a47b38039151b8760a567a5e10747", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/385e997c9f2a47b38039151b8760a567a5e10747", "committedDate": "2020-09-11T18:40:44Z", "message": "Debug test run"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "385e997c9f2a47b38039151b8760a567a5e10747", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/385e997c9f2a47b38039151b8760a567a5e10747", "committedDate": "2020-09-11T18:40:44Z", "message": "Debug test run"}, "afterCommit": {"oid": "653aa3ead68d6ca90f4e8b4e0e0a31fd6961db56", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/653aa3ead68d6ca90f4e8b4e0e0a31fd6961db56", "committedDate": "2020-09-11T21:25:11Z", "message": "Cleanup threads in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9521ad8d05861f99145ece958bdbb7492e4bed00", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9521ad8d05861f99145ece958bdbb7492e4bed00", "committedDate": "2020-09-11T21:28:19Z", "message": "Cleanup threads in tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "653aa3ead68d6ca90f4e8b4e0e0a31fd6961db56", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/653aa3ead68d6ca90f4e8b4e0e0a31fd6961db56", "committedDate": "2020-09-11T21:25:11Z", "message": "Cleanup threads in tests"}, "afterCommit": {"oid": "9521ad8d05861f99145ece958bdbb7492e4bed00", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9521ad8d05861f99145ece958bdbb7492e4bed00", "committedDate": "2020-09-11T21:28:19Z", "message": "Cleanup threads in tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTY1NTU3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/432#pullrequestreview-487165557", "createdAt": "2020-09-11T22:56:55Z", "commit": {"oid": "9521ad8d05861f99145ece958bdbb7492e4bed00"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMjo1Njo1NVrOHQv8mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMjo1Njo1NVrOHQv8mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyNDgyNA==", "bodyText": "Add a comment to explain why we filter that one out.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/432#discussion_r487324824", "createdAt": "2020-09-11T22:56:55Z", "author": {"login": "abanthiy"}, "path": "src/test/java/com/aws/iot/evergreen/testcommons/testutilities/ThreadProtector.java", "diffHunk": "@@ -27,19 +27,29 @@\n \n     @Override\n     public void afterAll(ExtensionContext context) throws Exception {\n-        Set<Thread> threadSet = Thread.getAllStackTraces().keySet();\n-        List<String> liveThreads =\n-                threadSet.stream()\n-                        .filter(Thread::isAlive)\n-                        .filter(t -> t.getThreadGroup() != null && \"main\".equals(t.getThreadGroup().getName()))\n-                        .map(Thread::getName)\n-                        .filter(Objects::nonNull)\n-                        .filter(name -> !ALLOWED_THREAD_NAMES.contains(name))\n-                        .collect(Collectors.toList());\n+        List<Thread> liveThreads = getThreads();\n         if (!liveThreads.isEmpty()) {\n-            // Don't fail tests right now. Too many things would break.\n-            // fail(\"Threads are still running: \" + liveThreads);\n             System.err.println(\"Threads are still running: \" + liveThreads);\n+\n+            /*\n+            // Wait, then try again and see if they're still running\n+            Thread.sleep(2000);\n+            liveThreads = getThreads();\n+            if (!liveThreads.isEmpty()) {\n+                fail(\"Threads are still running: \" + liveThreads);\n+            }\n+             */\n         }\n     }\n+\n+    private List<Thread> getThreads() {\n+        Set<Thread> threadSet = Thread.getAllStackTraces().keySet();\n+        return threadSet.stream()\n+                .filter(Thread::isAlive)\n+                .filter(t -> t.getThreadGroup() != null && \"main\".equals(t.getThreadGroup().getName()))\n+                .filter(t -> Objects.nonNull(t.getName()))\n+                .filter(t -> !ALLOWED_THREAD_NAMES.contains(t.getName()))\n+                .filter(t -> !t.getName().contains(\"globalEventExecutor\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9521ad8d05861f99145ece958bdbb7492e4bed00"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTY1NTc0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/432#pullrequestreview-487165574", "createdAt": "2020-09-11T22:56:59Z", "commit": {"oid": "9521ad8d05861f99145ece958bdbb7492e4bed00"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8afb81e566b21be95e0124b5c40bdda722e0aa54", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8afb81e566b21be95e0124b5c40bdda722e0aa54", "committedDate": "2020-09-11T23:02:27Z", "message": "Update bootstrap test to not take 2 minutes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dc45465a3a955050b482666f749663645ff76a4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5dc45465a3a955050b482666f749663645ff76a4", "committedDate": "2020-09-11T23:37:44Z", "message": "Flip endpoints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e2f0496354120d46270e2b053da312cbec7d485", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1e2f0496354120d46270e2b053da312cbec7d485", "committedDate": "2020-09-11T23:07:11Z", "message": "Flip endpoints"}, "afterCommit": {"oid": "5dc45465a3a955050b482666f749663645ff76a4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5dc45465a3a955050b482666f749663645ff76a4", "committedDate": "2020-09-11T23:37:44Z", "message": "Flip endpoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "652a2f5cd98c51512b3248c44c75de69c8b323ae", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/652a2f5cd98c51512b3248c44c75de69c8b323ae", "committedDate": "2020-09-12T00:15:06Z", "message": "Disable broken test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd67e33e7e21f68d71c9444fd0bb98400c2b5c10", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bd67e33e7e21f68d71c9444fd0bb98400c2b5c10", "committedDate": "2020-09-11T23:56:53Z", "message": "Disable broken test"}, "afterCommit": {"oid": "652a2f5cd98c51512b3248c44c75de69c8b323ae", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/652a2f5cd98c51512b3248c44c75de69c8b323ae", "committedDate": "2020-09-12T00:15:06Z", "message": "Disable broken test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a574b11c6411895e58a91694ba1827d9df3a8315", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a574b11c6411895e58a91694ba1827d9df3a8315", "committedDate": "2020-09-12T03:40:23Z", "message": "Generic external service safer shutdown when interrupted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc35fdac34fde007c76be04fcb1785b897836554", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cc35fdac34fde007c76be04fcb1785b897836554", "committedDate": "2020-09-12T02:46:32Z", "message": "Waiting for tasks to finish when shutting down executor."}, "afterCommit": {"oid": "a574b11c6411895e58a91694ba1827d9df3a8315", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a574b11c6411895e58a91694ba1827d9df3a8315", "committedDate": "2020-09-12T03:40:23Z", "message": "Generic external service safer shutdown when interrupted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7acb81a7ac8e534022beb9ac04878ed24660a538", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7acb81a7ac8e534022beb9ac04878ed24660a538", "committedDate": "2020-09-12T05:13:11Z", "message": "Fix E2E tests with updated client"}, "afterCommit": {"oid": "c0d2f58ab0f673d77bb2d7a6c97ef57e24d54bcc", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c0d2f58ab0f673d77bb2d7a6c97ef57e24d54bcc", "committedDate": "2020-09-12T05:41:40Z", "message": "Fix E2E tests with updated client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feff173dbef397084325f5ae8d0b2066cfddc1cc", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/feff173dbef397084325f5ae8d0b2066cfddc1cc", "committedDate": "2020-09-12T05:49:24Z", "message": "Fix E2E tests with updated client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0d2f58ab0f673d77bb2d7a6c97ef57e24d54bcc", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c0d2f58ab0f673d77bb2d7a6c97ef57e24d54bcc", "committedDate": "2020-09-12T05:41:40Z", "message": "Fix E2E tests with updated client"}, "afterCommit": {"oid": "feff173dbef397084325f5ae8d0b2066cfddc1cc", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/feff173dbef397084325f5ae8d0b2066cfddc1cc", "committedDate": "2020-09-12T05:49:24Z", "message": "Fix E2E tests with updated client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzMyNTEx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/432#pullrequestreview-487332511", "createdAt": "2020-09-13T19:13:55Z", "commit": {"oid": "feff173dbef397084325f5ae8d0b2066cfddc1cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3299, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}