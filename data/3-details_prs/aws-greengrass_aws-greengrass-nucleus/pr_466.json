{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMjQ1ODY1", "number": 466, "title": "More robust handling of timeouts in MqttClient", "bodyText": "Issue #, if available:\nDescription of changes:\nThe CRT MQTT library doesn't have any timeouts, and timeouts in Java don't affect it at all (nor do future cancellations).\nThis change embraces the async nature more, and adds listeners in the futures to wait for them to either complete or fail and take the correct actions at those points. This approach was discussed with Bret Ambrose and Dengke Tang from the SDK team.\nAlso, renames TES to \"aws.greengrass.TokenExchangeService\".\nWhy is this change necessary:\nThis change will resolve the issue of incorrect assuming that a subscription failed, when it may have actually succeeded and we receive messages from it.\nHow was this change tested:\nUpdated unit tests, added new test to verify that even after timing out, if a future is completed then the \"then\" methods are called.\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-22T23:30:35Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466", "merged": true, "mergeCommit": {"oid": "3e3b1b571dc5857aff5403f61e710a218fba6520"}, "closed": true, "closedAt": "2020-09-23T16:08:36Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLhl_fAFqTQ5MzkyNDU0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLumregFqTQ5NDgwNDI0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTI0NTQy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466#pullrequestreview-493924542", "createdAt": "2020-09-23T00:03:03Z", "commit": {"oid": "f81d55c51e90a8599071adf560410fe5a9794205"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwMDowMzowM1rOHWQZVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwMDoxMDo1MlrOHWQiCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA5OTM1MA==", "bodyText": "Why do you need .get() on this one?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466#discussion_r493099350", "createdAt": "2020-09-23T00:03:03Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/mqttclient/AwsIotMqttClient.java", "diffHunk": "@@ -155,15 +165,15 @@ void reconnect() throws TimeoutException, ExecutionException, InterruptedExcepti\n         }\n     }\n \n-    private int getTimeout() {\n+    int getTimeout() {\n         return Coerce.toInt(mqttTopics.findOrDefault(\n                 MqttClient.DEFAULT_MQTT_OPERATION_TIMEOUT, MqttClient.MQTT_OPERATION_TIMEOUT_KEY));\n     }\n \n     private void resubscribe() {\n         subscriptionTopics.forEach((key, value) -> {\n             try {\n-                subscribe(key, value);\n+                subscribe(key, value).get(getTimeout(), TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f81d55c51e90a8599071adf560410fe5a9794205"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMTU3Nw==", "bodyText": "same here. Is timeout needed?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466#discussion_r493101577", "createdAt": "2020-09-23T00:10:52Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/mqttclient/MqttClient.java", "diffHunk": "@@ -194,11 +195,17 @@ public synchronized void subscribe(SubscribeRequest request)\n             try (LockScope scope = LockScope.lock(connectionLock.readLock())) {\n                 // Connection isn't null, so we should subscribe to the topic\n                 if (connection != null) {\n-                    connection.subscribe(request.getTopic(), request.getQos());\n-                    subscriptionTopics.put(new MqttTopic(request.getTopic()), connection);\n+                    AwsIotMqttClient finalConnection = connection;\n+                    connection.subscribe(request.getTopic(), request.getQos()).whenComplete((i, t) -> {\n+                        if (t == null) {\n+                            subscriptionTopics.put(new MqttTopic(request.getTopic()), finalConnection);\n+                        } else {\n+                            subscriptions.remove(request);\n+                        }\n+                    }).get(connection.getTimeout(), TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f81d55c51e90a8599071adf560410fe5a9794205"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9155d12333f18797f1316e1b8903120bcd5895b6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9155d12333f18797f1316e1b8903120bcd5895b6", "committedDate": "2020-09-23T02:02:52Z", "message": "More robust handling of timeouts in MqttClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed52f30605a54b196b882a1565129c6ec9712936", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ed52f30605a54b196b882a1565129c6ec9712936", "committedDate": "2020-09-23T02:02:52Z", "message": "Fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f81d55c51e90a8599071adf560410fe5a9794205", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f81d55c51e90a8599071adf560410fe5a9794205", "committedDate": "2020-09-22T23:36:08Z", "message": "Fix test"}, "afterCommit": {"oid": "ae0a239639ade5500a4c1bf3de08dbdb4404d809", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ae0a239639ade5500a4c1bf3de08dbdb4404d809", "committedDate": "2020-09-23T02:08:43Z", "message": "Log errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae0a239639ade5500a4c1bf3de08dbdb4404d809", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ae0a239639ade5500a4c1bf3de08dbdb4404d809", "committedDate": "2020-09-23T02:08:43Z", "message": "Log errors"}, "afterCommit": {"oid": "649affe743d92e40f473f04882521e6b2c4f9ece", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/649affe743d92e40f473f04882521e6b2c4f9ece", "committedDate": "2020-09-23T02:16:20Z", "message": "Log errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff93886338d957ae56b3da09138a9d307b0e3b0f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ff93886338d957ae56b3da09138a9d307b0e3b0f", "committedDate": "2020-09-23T03:01:18Z", "message": "Log errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "649affe743d92e40f473f04882521e6b2c4f9ece", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/649affe743d92e40f473f04882521e6b2c4f9ece", "committedDate": "2020-09-23T02:16:20Z", "message": "Log errors"}, "afterCommit": {"oid": "ff93886338d957ae56b3da09138a9d307b0e3b0f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ff93886338d957ae56b3da09138a9d307b0e3b0f", "committedDate": "2020-09-23T03:01:18Z", "message": "Log errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc851b821a15969aa4dcc87f7bc633f05ede4695", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cc851b821a15969aa4dcc87f7bc633f05ede4695", "committedDate": "2020-09-23T03:41:00Z", "message": "Update for windows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb7a70cbaa5ad13813fe35167945613c8f6d3f30", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb7a70cbaa5ad13813fe35167945613c8f6d3f30", "committedDate": "2020-09-23T06:08:41Z", "message": "Correct order of iot http status code setting"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc851b821a15969aa4dcc87f7bc633f05ede4695", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cc851b821a15969aa4dcc87f7bc633f05ede4695", "committedDate": "2020-09-23T03:41:00Z", "message": "Update for windows"}, "afterCommit": {"oid": "fb7a70cbaa5ad13813fe35167945613c8f6d3f30", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb7a70cbaa5ad13813fe35167945613c8f6d3f30", "committedDate": "2020-09-23T06:08:41Z", "message": "Correct order of iot http status code setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25874e206631fedb357ee86065710d7f3183ea73", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/25874e206631fedb357ee86065710d7f3183ea73", "committedDate": "2020-09-23T06:25:50Z", "message": "Merge branch 'mqtt-timeout' of https://github.com/aws/aws-greengrass-kernel into mqtt-timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MjgwNjUw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466#pullrequestreview-494280650", "createdAt": "2020-09-23T06:50:38Z", "commit": {"oid": "25874e206631fedb357ee86065710d7f3183ea73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODA0MjQ5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/466#pullrequestreview-494804249", "createdAt": "2020-09-23T15:48:17Z", "commit": {"oid": "25874e206631fedb357ee86065710d7f3183ea73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3009, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}