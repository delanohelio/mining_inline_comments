{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMjI4MTc2", "number": 353, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNjoyMzozMFrOEVfEhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMzozOToxNFrOEWBuuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwOTY0NjE1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNjoyMzozMFrOG8RJsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMDoyNzowNVrOG9DF7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg0ODc1Mw==", "bodyText": "Nice refactor. Can we make Utils more generic? I think we already have our own FileUtils class?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465848753", "createdAt": "2020-08-05T16:23:30Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -56,21 +60,12 @@\n     public PackageStore(@Named(CONTEXT_PACKAGE_STORE_DIRECTORY) @NonNull Path packageStoreDirectory)\n             throws PackagingException {\n         this.recipeDirectory = packageStoreDirectory.resolve(RECIPE_DIRECTORY);\n-        if (!Files.exists(recipeDirectory)) {\n-            try {\n-                Files.createDirectories(recipeDirectory);\n-            } catch (IOException e) {\n-                throw new PackagingException(String.format(\"Failed to create recipe directory %s\", recipeDirectory), e);\n-            }\n-        }\n         this.artifactDirectory = packageStoreDirectory.resolve(ARTIFACT_DIRECTORY);\n-        if (!Files.exists(artifactDirectory)) {\n-            try {\n-                Files.createDirectories(artifactDirectory);\n-            } catch (IOException e) {\n-                throw new PackagingException(String.format(\"Failed to create artifact directory %s\", artifactDirectory),\n-                        e);\n-            }\n+        this.artifactsUnpackDirectory = packageStoreDirectory.resolve(ARTIFACTS_UNPACK_DIRECTORY);\n+        try {\n+            Utils.createPaths(recipeDirectory, artifactDirectory, artifactsUnpackDirectory);\n+        } catch (IOException e) {\n+            throw new PackagingException(\"Failed to create necessary directories for package store\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYzOTA3NQ==", "bodyText": "+1. If you plan to make this refactor in this PR, i'd prefer rename to createDirs() . But I'm ok with current PR now", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466639075", "createdAt": "2020-08-06T19:31:37Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -56,21 +60,12 @@\n     public PackageStore(@Named(CONTEXT_PACKAGE_STORE_DIRECTORY) @NonNull Path packageStoreDirectory)\n             throws PackagingException {\n         this.recipeDirectory = packageStoreDirectory.resolve(RECIPE_DIRECTORY);\n-        if (!Files.exists(recipeDirectory)) {\n-            try {\n-                Files.createDirectories(recipeDirectory);\n-            } catch (IOException e) {\n-                throw new PackagingException(String.format(\"Failed to create recipe directory %s\", recipeDirectory), e);\n-            }\n-        }\n         this.artifactDirectory = packageStoreDirectory.resolve(ARTIFACT_DIRECTORY);\n-        if (!Files.exists(artifactDirectory)) {\n-            try {\n-                Files.createDirectories(artifactDirectory);\n-            } catch (IOException e) {\n-                throw new PackagingException(String.format(\"Failed to create artifact directory %s\", artifactDirectory),\n-                        e);\n-            }\n+        this.artifactsUnpackDirectory = packageStoreDirectory.resolve(ARTIFACTS_UNPACK_DIRECTORY);\n+        try {\n+            Utils.createPaths(recipeDirectory, artifactDirectory, artifactsUnpackDirectory);\n+        } catch (IOException e) {\n+            throw new PackagingException(\"Failed to create necessary directories for package store\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg0ODc1Mw=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2Njk5MQ==", "bodyText": "There is no FileUtils yet, and Utils.createPaths is used at few other places. Push to another refactor ?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466666991", "createdAt": "2020-08-06T20:27:05Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -56,21 +60,12 @@\n     public PackageStore(@Named(CONTEXT_PACKAGE_STORE_DIRECTORY) @NonNull Path packageStoreDirectory)\n             throws PackagingException {\n         this.recipeDirectory = packageStoreDirectory.resolve(RECIPE_DIRECTORY);\n-        if (!Files.exists(recipeDirectory)) {\n-            try {\n-                Files.createDirectories(recipeDirectory);\n-            } catch (IOException e) {\n-                throw new PackagingException(String.format(\"Failed to create recipe directory %s\", recipeDirectory), e);\n-            }\n-        }\n         this.artifactDirectory = packageStoreDirectory.resolve(ARTIFACT_DIRECTORY);\n-        if (!Files.exists(artifactDirectory)) {\n-            try {\n-                Files.createDirectories(artifactDirectory);\n-            } catch (IOException e) {\n-                throw new PackagingException(String.format(\"Failed to create artifact directory %s\", artifactDirectory),\n-                        e);\n-            }\n+        this.artifactsUnpackDirectory = packageStoreDirectory.resolve(ARTIFACTS_UNPACK_DIRECTORY);\n+        try {\n+            Utils.createPaths(recipeDirectory, artifactDirectory, artifactsUnpackDirectory);\n+        } catch (IOException e) {\n+            throw new PackagingException(\"Failed to create necessary directories for package store\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg0ODc1Mw=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwOTc0MzA4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNjo0ODowOFrOG8SG4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMDoyNzowOVrOG9DGCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NDQxOA==", "bodyText": "Use the systemParameters instead of hardcoding these.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465864418", "createdAt": "2020-08-05T16:48:08Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -148,13 +150,19 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n     }\n \n     private String replace(String stringValue, PackageIdentifier packageIdentifier,\n-                           Set<PackageParameter> packageParameters) {\n+                           Set<PackageParameter> packageParameters) throws PackageLoadingException {\n         // Handle package parameters\n         for (final PackageParameter parameter : packageParameters) {\n             stringValue = stringValue\n                     .replace(String.format(PARAMETER_REFERENCE_FORMAT, parameter.getName()), parameter.getValue());\n         }\n \n+        //Handle directories\n+        stringValue = stringValue.replace(ARTIFACTS_UNPACK_DIRECTORY_PLACEHOLDER,\n+                packageStore.resolveAndSetupArtifactsUnpackDirectory(packageIdentifier).toAbsolutePath().toString());\n+        stringValue = stringValue.replace(KERNEL_ROOT_DIRECTORY_PLACEHOLDER,\n+                kernel.getRootPath().toAbsolutePath().toString());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NDQ0OQ==", "bodyText": "+1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465894449", "createdAt": "2020-08-05T17:39:49Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -148,13 +150,19 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n     }\n \n     private String replace(String stringValue, PackageIdentifier packageIdentifier,\n-                           Set<PackageParameter> packageParameters) {\n+                           Set<PackageParameter> packageParameters) throws PackageLoadingException {\n         // Handle package parameters\n         for (final PackageParameter parameter : packageParameters) {\n             stringValue = stringValue\n                     .replace(String.format(PARAMETER_REFERENCE_FORMAT, parameter.getName()), parameter.getValue());\n         }\n \n+        //Handle directories\n+        stringValue = stringValue.replace(ARTIFACTS_UNPACK_DIRECTORY_PLACEHOLDER,\n+                packageStore.resolveAndSetupArtifactsUnpackDirectory(packageIdentifier).toAbsolutePath().toString());\n+        stringValue = stringValue.replace(KERNEL_ROOT_DIRECTORY_PLACEHOLDER,\n+                kernel.getRootPath().toAbsolutePath().toString());\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NDQxOA=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NzAxOQ==", "bodyText": "Updated", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466667019", "createdAt": "2020-08-06T20:27:09Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -148,13 +150,19 @@ private Object interpolate(Object configValue, Set<PackageParameter> packagePara\n     }\n \n     private String replace(String stringValue, PackageIdentifier packageIdentifier,\n-                           Set<PackageParameter> packageParameters) {\n+                           Set<PackageParameter> packageParameters) throws PackageLoadingException {\n         // Handle package parameters\n         for (final PackageParameter parameter : packageParameters) {\n             stringValue = stringValue\n                     .replace(String.format(PARAMETER_REFERENCE_FORMAT, parameter.getName()), parameter.getValue());\n         }\n \n+        //Handle directories\n+        stringValue = stringValue.replace(ARTIFACTS_UNPACK_DIRECTORY_PLACEHOLDER,\n+                packageStore.resolveAndSetupArtifactsUnpackDirectory(packageIdentifier).toAbsolutePath().toString());\n+        stringValue = stringValue.replace(KERNEL_ROOT_DIRECTORY_PLACEHOLDER,\n+                kernel.getRootPath().toAbsolutePath().toString());\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NDQxOA=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwOTc0OTg2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNjo0OTo1M1rOG8SLKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNzozMTo1N1rOG8Trrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NTUxNA==", "bodyText": "How is this used? Does kernel decompress the file itself?\nFeng (IoT) Wang Yesterday at 9:40 PM\nCustomers should be able to specify the compression format of the artifact and the artifact downloader should unpack the artifacts. That\u2019s what I described in the original package downloader design: https://quip-amazon.com/aEbzAtwX1b1M/Evergreen-device-package-store#BJX9CAdFfH2\n5 replies\nMichael Dombrowski  12 hours ago\nIt says that it decompresses automatically, are we sure we want that? Or should it be an option?\nFeng (IoT) Wang  12 hours ago\nwe can make it configurable.\nMichael Dombrowski  12 hours ago\nuri: something\ndecompress: zip/gzip\nSomething like that?\nFeng (IoT) Wang  12 hours ago\nright. If a compression format is specified, such as zip or tar, then we can unzip/untar it. If it\u2019s not specified, then we do nothing.\nMichael Dombrowski  12 hours ago\nI'm good with that. Can work on it tomorrow. It'll need a cloud change too to add it to the recipe", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465865514", "createdAt": "2020-08-05T16:49:53Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -46,8 +48,10 @@\n \n     private final Path artifactDirectory;\n \n+    private final Path artifactsUnpackDirectory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg3MDgwMg==", "bodyText": "How this folder will be used: https://quip-amazon.com/vWhOAWhGwA6q/Kernel-Update-Design#PTP9CArJVKy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465870802", "createdAt": "2020-08-05T16:58:24Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -46,8 +48,10 @@\n \n     private final Path artifactDirectory;\n \n+    private final Path artifactsUnpackDirectory;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NTUxNA=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg3Mjg4NQ==", "bodyText": "So it doesn't automatically decompress?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465872885", "createdAt": "2020-08-05T17:01:45Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -46,8 +48,10 @@\n \n     private final Path artifactDirectory;\n \n+    private final Path artifactsUnpackDirectory;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NTUxNA=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg4OTUyOA==", "bodyText": "No. Component authors can define the unpacking in lifecycle steps, maybe install.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465889528", "createdAt": "2020-08-05T17:30:42Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -46,8 +48,10 @@\n \n     private final Path artifactDirectory;\n \n+    private final Path artifactsUnpackDirectory;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NTUxNA=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5MDIyMw==", "bodyText": "OK, I think I'm going to be adding that today for lambda, but it should also help your work", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465890223", "createdAt": "2020-08-05T17:31:57Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -46,8 +48,10 @@\n \n     private final Path artifactDirectory;\n \n+    private final Path artifactsUnpackDirectory;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg2NTUxNA=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwOTkwMTQ5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNzozMTo0NlrOG8TrVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxODozNToyNVrOG8V0ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5MDEzMg==", "bodyText": "What's the unpack directory for?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465890132", "createdAt": "2020-08-05T17:31:46Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -38,6 +39,7 @@\n     public static final String CONTEXT_PACKAGE_STORE_DIRECTORY = \"packageStoreDirectory\";\n     public static final String RECIPE_DIRECTORY = \"recipes\";\n     public static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+    public static final String ARTIFACTS_UNPACK_DIRECTORY = \"artifacts-unpack\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NzM1Mw==", "bodyText": "It's an optional directory for customers to unpack component artifacts. It's not enforced to be used", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465897353", "createdAt": "2020-08-05T17:44:49Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -38,6 +39,7 @@\n     public static final String CONTEXT_PACKAGE_STORE_DIRECTORY = \"packageStoreDirectory\";\n     public static final String RECIPE_DIRECTORY = \"recipes\";\n     public static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+    public static final String ARTIFACTS_UNPACK_DIRECTORY = \"artifacts-unpack\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5MDEzMg=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkxMDY3NA==", "bodyText": "Will kernel update unpack use this directory?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465910674", "createdAt": "2020-08-05T18:08:49Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -38,6 +39,7 @@\n     public static final String CONTEXT_PACKAGE_STORE_DIRECTORY = \"packageStoreDirectory\";\n     public static final String RECIPE_DIRECTORY = \"recipes\";\n     public static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+    public static final String ARTIFACTS_UNPACK_DIRECTORY = \"artifacts-unpack\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5MDEzMg=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkyNTI1OA==", "bodyText": "How unpack directory will be used: https://quip-amazon.com/vWhOAWhGwA6q/Kernel-Update-Design#PTP9CArJVKy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r465925258", "createdAt": "2020-08-05T18:35:25Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -38,6 +39,7 @@\n     public static final String CONTEXT_PACKAGE_STORE_DIRECTORY = \"packageStoreDirectory\";\n     public static final String RECIPE_DIRECTORY = \"recipes\";\n     public static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+    public static final String ARTIFACTS_UNPACK_DIRECTORY = \"artifacts-unpack\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5MDEzMg=="}, "originalCommit": {"oid": "0a272233661a26ae7cba7313c2d34abdc9593697"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNDk4MTczOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMToxMTozNlrOG9EbAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMTozMTo1MVrOG9E9mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4ODc2OQ==", "bodyText": "Why does this need to create the path? Our other artifact dir is created at some other time", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466688769", "createdAt": "2020-08-06T21:11:36Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -55,10 +60,18 @@ public KernelConfigResolver(PackageStore packageStore, Kernel kernel) {\n         this.kernel = kernel;\n \n         // More system parameters can be added over time by extending this map with new namespaces/keys\n-        HashMap<String, Function<PackageIdentifier, String>> artifactNamespace = new HashMap<>();\n-        artifactNamespace\n-                .put(\"path\", (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n-        systemParameters.put(\"artifacts\", artifactNamespace);\n+        HashMap<String, CrashableFunction<PackageIdentifier, String, PackageLoadingException>> artifactNamespace\n+                = new HashMap<>();\n+        artifactNamespace.put(\"path\",\n+                (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n+        artifactNamespace.put(\"unpackPath\",\n+                (id) -> packageStore.resolveAndSetupArtifactsUnpackDirectory(id).toAbsolutePath().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2986e6b429f9f8a5225b10adea1b1c2044a029bb"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5NzYyNA==", "bodyText": "artifacts directory is created for every component, unpack directory need not be created unless it is referred in the recipe.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466697624", "createdAt": "2020-08-06T21:31:51Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -55,10 +60,18 @@ public KernelConfigResolver(PackageStore packageStore, Kernel kernel) {\n         this.kernel = kernel;\n \n         // More system parameters can be added over time by extending this map with new namespaces/keys\n-        HashMap<String, Function<PackageIdentifier, String>> artifactNamespace = new HashMap<>();\n-        artifactNamespace\n-                .put(\"path\", (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n-        systemParameters.put(\"artifacts\", artifactNamespace);\n+        HashMap<String, CrashableFunction<PackageIdentifier, String, PackageLoadingException>> artifactNamespace\n+                = new HashMap<>();\n+        artifactNamespace.put(\"path\",\n+                (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n+        artifactNamespace.put(\"unpackPath\",\n+                (id) -> packageStore.resolveAndSetupArtifactsUnpackDirectory(id).toAbsolutePath().toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4ODc2OQ=="}, "originalCommit": {"oid": "2986e6b429f9f8a5225b10adea1b1c2044a029bb"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNDk4Mjk3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMToxMjowMFrOG9EbxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMTo1Mjo1OFrOG9FgEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4ODk2NQ==", "bodyText": "maybe \"decompressedPath\"?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466688965", "createdAt": "2020-08-06T21:12:00Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -55,10 +60,18 @@ public KernelConfigResolver(PackageStore packageStore, Kernel kernel) {\n         this.kernel = kernel;\n \n         // More system parameters can be added over time by extending this map with new namespaces/keys\n-        HashMap<String, Function<PackageIdentifier, String>> artifactNamespace = new HashMap<>();\n-        artifactNamespace\n-                .put(\"path\", (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n-        systemParameters.put(\"artifacts\", artifactNamespace);\n+        HashMap<String, CrashableFunction<PackageIdentifier, String, PackageLoadingException>> artifactNamespace\n+                = new HashMap<>();\n+        artifactNamespace.put(\"path\",\n+                (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n+        artifactNamespace.put(\"unpackPath\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2986e6b429f9f8a5225b10adea1b1c2044a029bb"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcwMjE0Ng==", "bodyText": "would adding decompressed give false impression that we actually decompress stuff?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466702146", "createdAt": "2020-08-06T21:42:46Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -55,10 +60,18 @@ public KernelConfigResolver(PackageStore packageStore, Kernel kernel) {\n         this.kernel = kernel;\n \n         // More system parameters can be added over time by extending this map with new namespaces/keys\n-        HashMap<String, Function<PackageIdentifier, String>> artifactNamespace = new HashMap<>();\n-        artifactNamespace\n-                .put(\"path\", (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n-        systemParameters.put(\"artifacts\", artifactNamespace);\n+        HashMap<String, CrashableFunction<PackageIdentifier, String, PackageLoadingException>> artifactNamespace\n+                = new HashMap<>();\n+        artifactNamespace.put(\"path\",\n+                (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n+        artifactNamespace.put(\"unpackPath\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4ODk2NQ=="}, "originalCommit": {"oid": "2986e6b429f9f8a5225b10adea1b1c2044a029bb"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcwMzU5Ng==", "bodyText": "I do want to decompress things for the customer. We want this feature for lambda", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466703596", "createdAt": "2020-08-06T21:46:16Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -55,10 +60,18 @@ public KernelConfigResolver(PackageStore packageStore, Kernel kernel) {\n         this.kernel = kernel;\n \n         // More system parameters can be added over time by extending this map with new namespaces/keys\n-        HashMap<String, Function<PackageIdentifier, String>> artifactNamespace = new HashMap<>();\n-        artifactNamespace\n-                .put(\"path\", (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n-        systemParameters.put(\"artifacts\", artifactNamespace);\n+        HashMap<String, CrashableFunction<PackageIdentifier, String, PackageLoadingException>> artifactNamespace\n+                = new HashMap<>();\n+        artifactNamespace.put(\"path\",\n+                (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n+        artifactNamespace.put(\"unpackPath\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4ODk2NQ=="}, "originalCommit": {"oid": "2986e6b429f9f8a5225b10adea1b1c2044a029bb"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcwNjQ0OA==", "bodyText": "renamed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466706448", "createdAt": "2020-08-06T21:52:58Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -55,10 +60,18 @@ public KernelConfigResolver(PackageStore packageStore, Kernel kernel) {\n         this.kernel = kernel;\n \n         // More system parameters can be added over time by extending this map with new namespaces/keys\n-        HashMap<String, Function<PackageIdentifier, String>> artifactNamespace = new HashMap<>();\n-        artifactNamespace\n-                .put(\"path\", (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n-        systemParameters.put(\"artifacts\", artifactNamespace);\n+        HashMap<String, CrashableFunction<PackageIdentifier, String, PackageLoadingException>> artifactNamespace\n+                = new HashMap<>();\n+        artifactNamespace.put(\"path\",\n+                (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());\n+        artifactNamespace.put(\"unpackPath\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4ODk2NQ=="}, "originalCommit": {"oid": "2986e6b429f9f8a5225b10adea1b1c2044a029bb"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTMxODQyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMzozNTo1MVrOG9Hmxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMDoyNjowOFrOG9Ic3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0MDkzNA==", "bodyText": "I don't think these need to be public", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466740934", "createdAt": "2020-08-06T23:35:51Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -42,6 +43,9 @@\n     private static final Logger LOGGER = LogManager.getLogger(KernelConfigResolver.class);\n     public static final String VERSION_CONFIG_KEY = \"version\";\n     public static final String PARAMETERS_CONFIG_KEY = \"parameters\";\n+    public static final String ARTIFACTS_NAMESPACE = \"artifacts\";\n+    public static final String KERNEL_NAMESPACE = \"kernel\";\n+    public static final String KERNEL_ROOT_PATH = \"rootPath\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e234e938f886f8f470a4f834ed0d9265de831e9"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc1NDc4Mg==", "bodyText": "updated", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466754782", "createdAt": "2020-08-07T00:26:08Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -42,6 +43,9 @@\n     private static final Logger LOGGER = LogManager.getLogger(KernelConfigResolver.class);\n     public static final String VERSION_CONFIG_KEY = \"version\";\n     public static final String PARAMETERS_CONFIG_KEY = \"parameters\";\n+    public static final String ARTIFACTS_NAMESPACE = \"artifacts\";\n+    public static final String KERNEL_NAMESPACE = \"kernel\";\n+    public static final String KERNEL_ROOT_PATH = \"rootPath\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0MDkzNA=="}, "originalCommit": {"oid": "9e234e938f886f8f470a4f834ed0d9265de831e9"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTMyMjY2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMzozODoxM1rOG9HpWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMDoyNjowMVrOG9Icug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0MTU5NA==", "bodyText": "change the unpack everywhere to decompressed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466741594", "createdAt": "2020-08-06T23:38:13Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -38,6 +39,7 @@\n     public static final String CONTEXT_PACKAGE_STORE_DIRECTORY = \"packageStoreDirectory\";\n     public static final String RECIPE_DIRECTORY = \"recipes\";\n     public static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+    public static final String ARTIFACTS_UNPACK_DIRECTORY = \"artifacts-unpack\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e234e938f886f8f470a4f834ed0d9265de831e9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc1NDc0Ng==", "bodyText": "updated", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466754746", "createdAt": "2020-08-07T00:26:01Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -38,6 +39,7 @@\n     public static final String CONTEXT_PACKAGE_STORE_DIRECTORY = \"packageStoreDirectory\";\n     public static final String RECIPE_DIRECTORY = \"recipes\";\n     public static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+    public static final String ARTIFACTS_UNPACK_DIRECTORY = \"artifacts-unpack\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0MTU5NA=="}, "originalCommit": {"oid": "9e234e938f886f8f470a4f834ed0d9265de831e9"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNTMyNDc1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQyMzozOToxNFrOG9HqoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwMDoyNTo1NVrOG9IcoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0MTkyMA==", "bodyText": "Format isn't necessary when you're just appending to the end, I think concatenation is faster in this case.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466741920", "createdAt": "2020-08-06T23:39:14Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -217,6 +211,25 @@ private Path resolveRecipePath(String packageName, Semver packageVersion) {\n         return recipeDirectory.resolve(String.format(RECIPE_FILE_NAME_FORMAT, packageName, packageVersion.getValue()));\n     }\n \n+    /**\n+     * Resolve the artifact unpack directory path and creates the directory if absent.\n+     * @param packageIdentifier packageIdentifier\n+     * @return artifact unpack directory path\n+     * @throws PackageLoadingException if un-able to create artifact unpack directory path\n+     */\n+    public Path resolveAndSetupArtifactsUnpackDirectory(@NonNull PackageIdentifier packageIdentifier)\n+            throws PackageLoadingException {\n+        Path path = artifactsUnpackDirectory.resolve(packageIdentifier.getName())\n+                .resolve(packageIdentifier.getVersion().getValue());\n+        try {\n+            Utils.createPaths(path);\n+            return path;\n+        } catch (IOException e) {\n+            throw new PackageLoadingException(String.format(\n+                    \"Failed to create artifact unpack directory for %s\", packageIdentifier.toString()), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e234e938f886f8f470a4f834ed0d9265de831e9"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc1NDcyMQ==", "bodyText": "I dont think that matters a lot, changed anyway", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/353#discussion_r466754721", "createdAt": "2020-08-07T00:25:55Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -217,6 +211,25 @@ private Path resolveRecipePath(String packageName, Semver packageVersion) {\n         return recipeDirectory.resolve(String.format(RECIPE_FILE_NAME_FORMAT, packageName, packageVersion.getValue()));\n     }\n \n+    /**\n+     * Resolve the artifact unpack directory path and creates the directory if absent.\n+     * @param packageIdentifier packageIdentifier\n+     * @return artifact unpack directory path\n+     * @throws PackageLoadingException if un-able to create artifact unpack directory path\n+     */\n+    public Path resolveAndSetupArtifactsUnpackDirectory(@NonNull PackageIdentifier packageIdentifier)\n+            throws PackageLoadingException {\n+        Path path = artifactsUnpackDirectory.resolve(packageIdentifier.getName())\n+                .resolve(packageIdentifier.getVersion().getValue());\n+        try {\n+            Utils.createPaths(path);\n+            return path;\n+        } catch (IOException e) {\n+            throw new PackageLoadingException(String.format(\n+                    \"Failed to create artifact unpack directory for %s\", packageIdentifier.toString()), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0MTkyMA=="}, "originalCommit": {"oid": "9e234e938f886f8f470a4f834ed0d9265de831e9"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4523, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}