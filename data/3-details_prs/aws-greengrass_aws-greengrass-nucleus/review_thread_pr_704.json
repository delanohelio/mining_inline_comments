{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNTkzNzMx", "number": 704, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMTo1NToxOFrOE8aYUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMToyMzozNFrOFAk8mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNzgyMjI2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMTo1NToxOFrOH4g5Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDowOTo1NlrOH-vf1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAyMTIzNQ==", "bodyText": "Use the constants in IotJobsClientWrapper? It's changed to gg namespace now", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r529021235", "createdAt": "2020-11-23T21:55:18Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -521,6 +540,30 @@ protected void subscribeToGetNextJobDescription(Consumer<DescribeJobExecutionRes\n         }\n     }\n \n+    private void unsubscribeFromJobDescription() {\n+        if (connection != null) {\n+            String topic = \"$aws/things/{thingName}/jobs/{jobId}/get/accepted\";\n+            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n+            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n+            connection.unsubscribe(topic);\n+\n+            topic = \"$aws/things/{thingName}/jobs/{jobId}/get/rejected\";\n+            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n+            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n+            connection.unsubscribe(topic);\n+\n+            topic = \"$aws/things/{thingName}/jobs/{jobId}/namespace-cust-deployment/get/accepted\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5f210381bccbf9c46f0cb684b20a372fd8fd043"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU1MTk1OQ==", "bodyText": "updated", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535551959", "createdAt": "2020-12-03T20:09:56Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -521,6 +540,30 @@ protected void subscribeToGetNextJobDescription(Consumer<DescribeJobExecutionRes\n         }\n     }\n \n+    private void unsubscribeFromJobDescription() {\n+        if (connection != null) {\n+            String topic = \"$aws/things/{thingName}/jobs/{jobId}/get/accepted\";\n+            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n+            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n+            connection.unsubscribe(topic);\n+\n+            topic = \"$aws/things/{thingName}/jobs/{jobId}/get/rejected\";\n+            topic = topic.replace(THING_NAME_PLACEHOLDER, Coerce.toString(deviceConfiguration.getThingName()));\n+            topic = topic.replace(JOB_ID_PLACEHOLDER, NEXT_JOB_LITERAL);\n+            connection.unsubscribe(topic);\n+\n+            topic = \"$aws/things/{thingName}/jobs/{jobId}/namespace-cust-deployment/get/accepted\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTAyMTIzNQ=="}, "originalCommit": {"oid": "d5f210381bccbf9c46f0cb684b20a372fd8fd043"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MDQxMjg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDo1NToxMFrOH-yhhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMTowODoyMFrOH-zsrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwMTU0Mw==", "bodyText": "not used?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535601543", "createdAt": "2020-12-03T20:55:10Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -91,6 +94,9 @@\n     //This value needs to be revisited and set to more realistic numbers\n     private static final long TIMEOUT_FOR_IOT_JOBS_OPERATIONS_SECONDS = Duration.ofMinutes(1).getSeconds();\n     private static final String JOB_ID_LOG_KEY_NAME = \"JobId\";\n+    private static final String THING_NAME_PLACEHOLDER = \"{thingName}\";\n+    private static final String JOB_ID_PLACEHOLDER = \"{jobId}\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYyMDc4Mw==", "bodyText": "yep, removed.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535620783", "createdAt": "2020-12-03T21:08:20Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -91,6 +94,9 @@\n     //This value needs to be revisited and set to more realistic numbers\n     private static final long TIMEOUT_FOR_IOT_JOBS_OPERATIONS_SECONDS = Duration.ofMinutes(1).getSeconds();\n     private static final String JOB_ID_LOG_KEY_NAME = \"JobId\";\n+    private static final String THING_NAME_PLACEHOLDER = \"{thingName}\";\n+    private static final String JOB_ID_PLACEHOLDER = \"{jobId}\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwMTU0Mw=="}, "originalCommit": {"oid": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MDQ1NDIyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDo1OTozMVrOH-y8Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMTowODoxN1rOH-zshQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwODM2Nw==", "bodyText": "I'm not familiar with this. Will $next be replaced by any deployment ID?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535608367", "createdAt": "2020-12-03T20:59:31Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -475,6 +495,18 @@ protected void subscribeToGetNextJobDescription(Consumer<DescribeJobExecutionRes\n         }\n     }\n \n+    private void unsubscribeFromJobDescription() {\n+        if (connection != null) {\n+            String topic = String.format(JOB_DESCRIBE_ACCEPTED_TOPIC,\n+                    Coerce.toString(deviceConfiguration.getThingName()), NEXT_JOB_LITERAL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYyMDc0MQ==", "bodyText": "We subscribe to DescribeJobExecutionAccepted and DescribeJobExecutionRejected using $next as job Id to get the next job.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535620741", "createdAt": "2020-12-03T21:08:17Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -475,6 +495,18 @@ protected void subscribeToGetNextJobDescription(Consumer<DescribeJobExecutionRes\n         }\n     }\n \n+    private void unsubscribeFromJobDescription() {\n+        if (connection != null) {\n+            String topic = String.format(JOB_DESCRIBE_ACCEPTED_TOPIC,\n+                    Coerce.toString(deviceConfiguration.getThingName()), NEXT_JOB_LITERAL);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwODM2Nw=="}, "originalCommit": {"oid": "5c690b2ef2d5d1290dd23697f3cd6205a4adc983"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MTQ5NjU5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMToyMzozNFrOH-8mpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMToyMzozNFrOH-8mpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc2NjY5NA==", "bodyText": "Shouldn't this comment be above line422? Also probably want to add a bit more context on why we need to subscribe to job description before event notification. The whole jobs call pattern is not very obvious. Is it documented somewhere?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/704#discussion_r535766694", "createdAt": "2020-12-04T01:23:34Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/deployment/IotJobsHelper.java", "diffHunk": "@@ -409,13 +415,25 @@ public void requestNextPendingJobDocument() {\n      * @throws ConnectionUnavailableException When connection to cloud is not available\n      */\n     public void subscribeToJobsTopics() {\n-        subscribeToEventNotifications(eventHandler);\n+\n         subscribeToGetNextJobDescription(describeJobExecutionResponseConsumer, rejectedError -> {\n             logger.error(\"Job subscription got rejected\", rejectedError);\n         });\n+        subscribeToEventNotifications(eventHandler);\n+        // To receive the description of jobs which were created before the subscription was created (before the device\n+        // came online)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dcc1cec42cac162ab566bbbb44c090f551fdfcb"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 275, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}