{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNzY1Mzg3", "number": 517, "title": "Set permissions on all paths", "bodyText": "Issue #, if available:\nDescription of changes:\nUsing the new Permissions class, actually set permissions for each path.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-12T19:22:39Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517", "merged": true, "mergeCommit": {"oid": "280e641f2617a0e4811a674c36d3d7e9d499aca5"}, "closed": true, "closedAt": "2020-10-13T16:11:05Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR5IojABqjM4NjgwMDkzMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSK6fygFqTUwNzYwNTI5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "892607a952000d6e5b234c349e7c0cde6b49f68d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/892607a952000d6e5b234c349e7c0cde6b49f68d", "committedDate": "2020-10-12T19:22:05Z", "message": "Set permissions on all paths"}, "afterCommit": {"oid": "01c05f61467dc9414fa28a3d04407e4bfe8d9c96", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/01c05f61467dc9414fa28a3d04407e4bfe8d9c96", "committedDate": "2020-10-12T19:27:50Z", "message": "Set permissions on all paths"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01c05f61467dc9414fa28a3d04407e4bfe8d9c96", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/01c05f61467dc9414fa28a3d04407e4bfe8d9c96", "committedDate": "2020-10-12T19:27:50Z", "message": "Set permissions on all paths"}, "afterCommit": {"oid": "e31e19f5124675787971a3efb7bbb19056275ed6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e31e19f5124675787971a3efb7bbb19056275ed6", "committedDate": "2020-10-12T20:04:01Z", "message": "Set permissions on all paths"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODg0ODE1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#pullrequestreview-506884815", "createdAt": "2020-10-12T20:06:42Z", "commit": {"oid": "01c05f61467dc9414fa28a3d04407e4bfe8d9c96"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDoxNzozN1rOHgL93w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDoxNzozN1rOHgL93w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxMjU0Mw==", "bodyText": "you are checking whether it is set in order to enable the read/write/execute bits, but this won't remove any bits that are already set by the umask when the file was created.\nI think you need to do\nf.setReadable(permissions.isOwnerRead(), true);\nf.setReadable(permissions.isOtherRead(), false);\nf.setWritable(permissions.isOwnerWrite(), true);\nf.setWritable(permissions.isOtherWrite(), false);\nf.setExecutable(permissions.isOwnerExecute(), true);\nf.setExecutable(permissions.isOtherExecute(), false);", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#discussion_r503512543", "createdAt": "2020-10-12T20:17:37Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/util/platforms/Platform.java", "diffHunk": "@@ -43,4 +46,52 @@ public abstract void killProcessAndChildren(Process process, boolean force)\n     public abstract String[] getShellForCommand(String command);\n \n     public abstract int exitCodeWhenCommandDoesNotExist();\n+\n+    /**\n+     * Set permissions on a path.\n+     *\n+     * @param permission permissions to set\n+     * @param path path to apply to\n+     * @throws IOException if any exception occurs while changing permissions\n+     */\n+    public void setPermissions(FileSystemPermission permission, Path path) throws IOException {\n+        // Just use builtin Java utilities to set permissions, we can expand this to do more in subclasses\n+        // as needed.\n+\n+        File f = path.toFile();\n+        if (!f.exists()) {\n+            throw new IOException(f + \" was expected to exist, but it does not exist\");\n+        }\n+        boolean happy = true;\n+        if (permission.isOwnerRead()) {\n+            happy = f.setReadable(true, true);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e31e19f5124675787971a3efb7bbb19056275ed6"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e31e19f5124675787971a3efb7bbb19056275ed6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e31e19f5124675787971a3efb7bbb19056275ed6", "committedDate": "2020-10-12T20:04:01Z", "message": "Set permissions on all paths"}, "afterCommit": {"oid": "32994bc26477be841e9dc007f8ef394eae8fa51f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/32994bc26477be841e9dc007f8ef394eae8fa51f", "committedDate": "2020-10-12T20:29:16Z", "message": "Set permissions on all paths"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32994bc26477be841e9dc007f8ef394eae8fa51f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/32994bc26477be841e9dc007f8ef394eae8fa51f", "committedDate": "2020-10-12T20:29:16Z", "message": "Set permissions on all paths"}, "afterCommit": {"oid": "0ac70d3fb664c2503ab2856a35ad4d99d51fdfd3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0ac70d3fb664c2503ab2856a35ad4d99d51fdfd3", "committedDate": "2020-10-12T20:30:45Z", "message": "Set permissions on all paths"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTAxMDcx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#pullrequestreview-506901071", "createdAt": "2020-10-12T20:34:45Z", "commit": {"oid": "0ac70d3fb664c2503ab2856a35ad4d99d51fdfd3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDozNDo0NVrOHgMYJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDozNDo0NVrOHgMYJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxOTI3MA==", "bodyText": "can this occur after setting the file permissions?\nAt least on snap, this will fail because the root user in snap does not have CAP_FOWNER (which allows you to do chmod operations on files not owned by yourself)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#discussion_r503519270", "createdAt": "2020-10-12T20:34:45Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/util/platforms/UnixPlatform.java", "diffHunk": "@@ -67,6 +68,15 @@ public int exitCodeWhenCommandDoesNotExist() {\n         return 127;\n     }\n \n+    @Override\n+    public void setPermissions(FileSystemPermission permission, Path path) throws IOException {\n+        if (permission.getOwnerUser() != null) {\n+            Files.setOwner(path, path.getFileSystem().getUserPrincipalLookupService()\n+                    .lookupPrincipalByName(permission.getOwnerUser()));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac70d3fb664c2503ab2856a35ad4d99d51fdfd3"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2565839dc9ad3bafaf542e10696c5e9c09bc81d4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2565839dc9ad3bafaf542e10696c5e9c09bc81d4", "committedDate": "2020-10-12T20:37:53Z", "message": "Set permissions on all paths"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ac70d3fb664c2503ab2856a35ad4d99d51fdfd3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0ac70d3fb664c2503ab2856a35ad4d99d51fdfd3", "committedDate": "2020-10-12T20:30:45Z", "message": "Set permissions on all paths"}, "afterCommit": {"oid": "2565839dc9ad3bafaf542e10696c5e9c09bc81d4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2565839dc9ad3bafaf542e10696c5e9c09bc81d4", "committedDate": "2020-10-12T20:37:53Z", "message": "Set permissions on all paths"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTA0MzY4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#pullrequestreview-506904368", "createdAt": "2020-10-12T20:41:18Z", "commit": {"oid": "2565839dc9ad3bafaf542e10696c5e9c09bc81d4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTY2NjE0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#pullrequestreview-506966614", "createdAt": "2020-10-12T23:02:30Z", "commit": {"oid": "2565839dc9ad3bafaf542e10696c5e9c09bc81d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMzowMjozMFrOHgP3cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMzowMjozMFrOHgP3cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3NjQzNQ==", "bodyText": "Have you thought using Java BitSet to represent these? Then you can use the normal linux file permission bits(e.g. 777) to initialize them, which I think it's more readable.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#discussion_r503576435", "createdAt": "2020-10-12T23:02:30Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/util/FileSystemPermission.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Builder;\n+import lombok.Value;\n+\n+import java.nio.file.attribute.PosixFilePermission;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Value\n+@Builder\n+@AllArgsConstructor\n+public class FileSystemPermission {\n+    String ownerUser;\n+    String ownerGroup;\n+    boolean ownerRead;\n+    boolean ownerWrite;\n+    boolean ownerExecute;\n+\n+    boolean groupRead;\n+    boolean groupWrite;\n+    boolean groupExecute;\n+\n+    boolean otherRead;\n+    boolean otherWrite;\n+    boolean otherExecute;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2565839dc9ad3bafaf542e10696c5e9c09bc81d4"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTc0NTAw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#pullrequestreview-506974500", "createdAt": "2020-10-12T23:27:51Z", "commit": {"oid": "25ac1fac7811404ba3aac306426bde934869bdc4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "25ac1fac7811404ba3aac306426bde934869bdc4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/25ac1fac7811404ba3aac306426bde934869bdc4", "committedDate": "2020-10-12T23:14:31Z", "message": "Reuse TES components"}, "afterCommit": {"oid": "492c354142b14161b445db5eabdf690d238d8c29", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/492c354142b14161b445db5eabdf690d238d8c29", "committedDate": "2020-10-12T23:39:07Z", "message": "Reuse TES components"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "492c354142b14161b445db5eabdf690d238d8c29", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/492c354142b14161b445db5eabdf690d238d8c29", "committedDate": "2020-10-12T23:39:07Z", "message": "Reuse TES components"}, "afterCommit": {"oid": "57be08f2b291d1c43eb599cd64631d15a1a14c3a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/57be08f2b291d1c43eb599cd64631d15a1a14c3a", "committedDate": "2020-10-13T00:34:45Z", "message": "Reuse TES components"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57be08f2b291d1c43eb599cd64631d15a1a14c3a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/57be08f2b291d1c43eb599cd64631d15a1a14c3a", "committedDate": "2020-10-13T00:34:45Z", "message": "Reuse TES components"}, "afterCommit": {"oid": "c3098f11ec34841d20df3bb49c0c05d55a820cbf", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c3098f11ec34841d20df3bb49c0c05d55a820cbf", "committedDate": "2020-10-13T00:40:49Z", "message": "Reuse TES components"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDU4NDA5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#pullrequestreview-507058409", "createdAt": "2020-10-13T04:19:57Z", "commit": {"oid": "c3098f11ec34841d20df3bb49c0c05d55a820cbf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNDoxOTo1OFrOHgU2kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNDoxOTo1OFrOHgU2kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY1ODEzMA==", "bodyText": "is this intentionally left commented rather than removing the call to the method?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#discussion_r503658130", "createdAt": "2020-10-13T04:19:58Z", "author": {"login": "rbattle"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -427,18 +421,18 @@ protected void setupTesRoleAndAlias() throws InterruptedException, ServiceLoadEx\n     }\n \n     protected static void cleanUpTesRoleAndAlias() {\n-        try {\n-            iotClient.deleteRoleAlias(DeleteRoleAliasRequest.builder().roleAlias(TES_ROLE_ALIAS_NAME).build());\n-\n-            if (tesRolePolicyArn.isPresent()) {\n-                iamClient.detachRolePolicy(DetachRolePolicyRequest.builder().roleName(TES_ROLE_NAME).policyArn(tesRolePolicyArn.get()).build());\n-                iamClient.deletePolicy(DeletePolicyRequest.builder().policyArn(tesRolePolicyArn.get()).build());\n-            }\n-\n-            iamClient.deleteRole(DeleteRoleRequest.builder().roleName(TES_ROLE_NAME).build());\n-        } catch (ResourceNotFoundException | NoSuchEntityException e) {\n-            logger.atInfo().addKeyValue(\"error-message\", e.getMessage()).log(\"Could not clean up TES resources\");\n-        }\n+//        try {\n+//            iotClient.deleteRoleAlias(DeleteRoleAliasRequest.builder().roleAlias(TES_ROLE_ALIAS_NAME).build());\n+//\n+//            if (tesRolePolicyArn.isPresent()) {\n+//                iamClient.detachRolePolicy(DetachRolePolicyRequest.builder().roleName(TES_ROLE_NAME).policyArn(tesRolePolicyArn.get()).build());\n+//                iamClient.deletePolicy(DeletePolicyRequest.builder().policyArn(tesRolePolicyArn.get()).build());\n+//            }\n+//\n+//            iamClient.deleteRole(DeleteRoleRequest.builder().roleName(TES_ROLE_NAME).build());\n+//        } catch (ResourceNotFoundException | NoSuchEntityException e) {\n+//            logger.atInfo().addKeyValue(\"error-message\", e.getMessage()).log(\"Could not clean up TES resources\");\n+//        }\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3098f11ec34841d20df3bb49c0c05d55a820cbf"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8e332e0ae2841f71c1675bec90fa5d8b8b66b54", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c8e332e0ae2841f71c1675bec90fa5d8b8b66b54", "committedDate": "2020-10-13T04:24:06Z", "message": "Reuse TES components"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3098f11ec34841d20df3bb49c0c05d55a820cbf", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c3098f11ec34841d20df3bb49c0c05d55a820cbf", "committedDate": "2020-10-13T00:40:49Z", "message": "Reuse TES components"}, "afterCommit": {"oid": "c8e332e0ae2841f71c1675bec90fa5d8b8b66b54", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c8e332e0ae2841f71c1675bec90fa5d8b8b66b54", "committedDate": "2020-10-13T04:24:06Z", "message": "Reuse TES components"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDY5MTY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#pullrequestreview-507069165", "createdAt": "2020-10-13T04:58:13Z", "commit": {"oid": "c8e332e0ae2841f71c1675bec90fa5d8b8b66b54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NjA1Mjkx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/517#pullrequestreview-507605291", "createdAt": "2020-10-13T16:10:49Z", "commit": {"oid": "c8e332e0ae2841f71c1675bec90fa5d8b8b66b54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3130, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}