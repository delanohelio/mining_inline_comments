{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NzEwNjc4", "number": 264, "title": "[Bug fix]Get rid of validation error message when initializing DeviceConfiguration object, fix arg names between setup and kernel command line", "bodyText": "Issue #, if available:\n1] When setting up DeviceConfiguration, due to the way the DeviceConfiguration utility is written, it used to lookup the config in Kernel context and immediately invoke validate method, even before any config values were set. This was due to the fact that it was originally intended to 'read' the config from kernel so it assumed that the config would already be set. But the setup script cannot use it as it is to set configuration because it tries to validate on constructor invocation.\n2] Setup script expects long arg names with two hyphens e.g. --thing-name, --root, --config etc vs KernelCommandLine expects long arg names with 1 hyphen e.g. -config, -root, this causes a mismatch between these two classes and the root and config args if specified with the long name were not being passed on to the kernel command line as intended, to fix it, all args are changed to have two hyphens for long arg names\n3] Add log statements for conveying the progress made by the script to the user\n4] Fix bug for the case when config is not specified, added integ test to verify it works\n5] Changed the TES role policy name to include roleAliasName as suffix so that if the role alias for the policy is being changed it can be accepted and a new role policy will be created and role alias will be attached to it.\n6] Create empty TES package only if the customer opts in for TES\n7] Added readme for script\nDescription of changes:\nWhy is this change necessary:\nHow was this change tested:\nNew/modified/existing tests passed\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-06-02T16:56:51Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264", "merged": true, "mergeCommit": {"oid": "6731f9eb21aa72b64605be8f80cabffb5069b50d"}, "closed": true, "closedAt": "2020-06-04T18:43:01Z", "author": {"login": "shaguptashaikh"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnX4kaABqjMzOTg2MjAwNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoBVYrgFqTQyNDY2MzE3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d863c6e9cf58868c7ef43ae6f4c0912a1dff78bd", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d863c6e9cf58868c7ef43ae6f4c0912a1dff78bd", "committedDate": "2020-06-02T16:49:59Z", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line"}, "afterCommit": {"oid": "f7ac3cf6e4724f92347ee60871d47965025fa945", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f7ac3cf6e4724f92347ee60871d47965025fa945", "committedDate": "2020-06-02T16:58:34Z", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7ac3cf6e4724f92347ee60871d47965025fa945", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f7ac3cf6e4724f92347ee60871d47965025fa945", "committedDate": "2020-06-02T16:58:34Z", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line"}, "afterCommit": {"oid": "02440e0edadd585dbff15a3777ee8cd0a597a544", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/02440e0edadd585dbff15a3777ee8cd0a597a544", "committedDate": "2020-06-02T16:59:54Z", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyODc5ODc1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#pullrequestreview-422879875", "createdAt": "2020-06-02T17:00:47Z", "commit": {"oid": "02440e0edadd585dbff15a3777ee8cd0a597a544"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02440e0edadd585dbff15a3777ee8cd0a597a544", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/02440e0edadd585dbff15a3777ee8cd0a597a544", "committedDate": "2020-06-02T16:59:54Z", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line"}, "afterCommit": {"oid": "e156945dadbaf1113b1f9306858eedfa13aa5b96", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e156945dadbaf1113b1f9306858eedfa13aa5b96", "committedDate": "2020-06-02T17:03:34Z", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e156945dadbaf1113b1f9306858eedfa13aa5b96", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e156945dadbaf1113b1f9306858eedfa13aa5b96", "committedDate": "2020-06-02T17:03:34Z", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line"}, "afterCommit": {"oid": "c849713069042c09804bb74cbd03fa7a61f16277", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c849713069042c09804bb74cbd03fa7a61f16277", "committedDate": "2020-06-02T17:11:21Z", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyODg5NTQz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#pullrequestreview-422889543", "createdAt": "2020-06-02T17:13:43Z", "commit": {"oid": "e156945dadbaf1113b1f9306858eedfa13aa5b96"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzoxNDowMVrOGd7uag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzoxNDowMVrOGd7uag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0MDQyNg==", "bodyText": "call validate here?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#discussion_r434040426", "createdAt": "2020-06-02T17:14:01Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeviceConfiguration.java", "diffHunk": "@@ -46,16 +46,53 @@\n     private final Validator regionValidator;\n \n     /**\n-     * Constructor.\n+     * Constructor used to read device cinfiguration from the config store.\n      *\n      * @param kernel Kernel to get config from\n      */\n     @Inject\n-    @SuppressWarnings(\"PMD.NullAssignment\")\n     public DeviceConfiguration(Kernel kernel) {\n         this.kernel = kernel;\n-        deTildeValidator = (newV, old) -> kernel.deTilde(Coerce.toString(newV));\n-        regionValidator = (newV, old) -> {\n+        deTildeValidator = getDeTildeValidator(kernel);\n+        regionValidator = getRegionValidator();\n+        validate();\n+    }\n+\n+    /**\n+     * Constructor to use when setting the device configuration to kernel config.\n+     *\n+     * @param kernel              kernel to set config for\n+     * @param thingName           IoT thing name\n+     * @param iotDataEndpoint     IoT data endpoint\n+     * @param iotCredEndpoint     IoT cert endpoint\n+     * @param privateKeyPath      private key location on device\n+     * @param certificateFilePath certificate location on device\n+     * @param rootCaFilePath      downloaded RootCA location on device\n+     * @param awsRegion           aws region for the device\n+     */\n+    public DeviceConfiguration(Kernel kernel, String thingName, String iotDataEndpoint, String iotCredEndpoint,\n+                               String privateKeyPath, String certificateFilePath, String rootCaFilePath,\n+                               String awsRegion) {\n+        this.kernel = kernel;\n+        deTildeValidator = getDeTildeValidator(kernel);\n+        regionValidator = getRegionValidator();\n+\n+        getThingName().withValue(thingName);\n+        getIotDataEndpoint().withValue(iotDataEndpoint);\n+        getCertificateFilePath().withValue(iotCredEndpoint);\n+        getPrivateKeyFilePath().withValue(privateKeyPath);\n+        getCertificateFilePath().withValue(certificateFilePath);\n+        getRootCAFilePath().withValue(rootCaFilePath);\n+        getAWSRegion().withValue(awsRegion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c849713069042c09804bb74cbd03fa7a61f16277"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c849713069042c09804bb74cbd03fa7a61f16277", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c849713069042c09804bb74cbd03fa7a61f16277", "committedDate": "2020-06-02T17:11:21Z", "message": "[Bug fixes] Get rid of device config validation error while setting device config and fix arg names between setup script and kernel command line"}, "afterCommit": {"oid": "c14b91f735bb05c126978f6e1642f1d26aef3b3e", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c14b91f735bb05c126978f6e1642f1d26aef3b3e", "committedDate": "2020-06-03T19:50:31Z", "message": "Validate device config while setting up in config store"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzODg0NTgx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#pullrequestreview-423884581", "createdAt": "2020-06-03T19:58:10Z", "commit": {"oid": "c14b91f735bb05c126978f6e1642f1d26aef3b3e"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOTo1ODoxMFrOGerQrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxOTo1ODoxMFrOGerQrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgxOTI0NQ==", "bodyText": "this isn't needed.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#discussion_r434819245", "createdAt": "2020-06-03T19:58:10Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -74,6 +75,20 @@ void GIVEN_config_missing_main_WHEN_kernel_launches_THEN_throw_RuntimeException(\n         assertThrows(RuntimeException.class, () -> kernel.launch());\n     }\n \n+    @Test\n+    void GIVEN_config_path_not_given_WHEN_kernel_launches_THEN_load_empty_main_service() throws Exception {\n+        // launch kernel without config arg\n+        kernel = new Kernel();\n+        kernel.parseArgs().toString();\n+        kernel.launch();\n+\n+        // verify\n+        EvergreenService mainService = kernel.locate(\"main\");\n+        assertNotNull(mainService);\n+\n+        kernel.shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14b91f735bb05c126978f6e1642f1d26aef3b3e"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzOTcyNjQ2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#pullrequestreview-423972646", "createdAt": "2020-06-03T22:09:56Z", "commit": {"oid": "c14b91f735bb05c126978f6e1642f1d26aef3b3e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c14b91f735bb05c126978f6e1642f1d26aef3b3e", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c14b91f735bb05c126978f6e1642f1d26aef3b3e", "committedDate": "2020-06-03T19:50:31Z", "message": "Validate device config while setting up in config store"}, "afterCommit": {"oid": "17523a1ee6fa7a30653c9e360644d295e1757385", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/17523a1ee6fa7a30653c9e360644d295e1757385", "committedDate": "2020-06-03T23:51:51Z", "message": "Validate device config while setting up in config store"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDE0MDY4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#pullrequestreview-424014068", "createdAt": "2020-06-03T23:58:10Z", "commit": {"oid": "17523a1ee6fa7a30653c9e360644d295e1757385"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NjQ2NTUy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#pullrequestreview-424646552", "createdAt": "2020-06-04T16:54:52Z", "commit": {"oid": "17523a1ee6fa7a30653c9e360644d295e1757385"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813f9ce278be1d00df39701e1f0c0c50040be3b4", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/813f9ce278be1d00df39701e1f0c0c50040be3b4", "committedDate": "2020-06-04T17:03:32Z", "message": "Fixes and enhancements to setup script"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17523a1ee6fa7a30653c9e360644d295e1757385", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/17523a1ee6fa7a30653c9e360644d295e1757385", "committedDate": "2020-06-03T23:51:51Z", "message": "Validate device config while setting up in config store"}, "afterCommit": {"oid": "813f9ce278be1d00df39701e1f0c0c50040be3b4", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/813f9ce278be1d00df39701e1f0c0c50040be3b4", "committedDate": "2020-06-04T17:03:32Z", "message": "Fixes and enhancements to setup script"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NjU4ODY4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#pullrequestreview-424658868", "createdAt": "2020-06-04T17:10:41Z", "commit": {"oid": "813f9ce278be1d00df39701e1f0c0c50040be3b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NjYzMTcw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/264#pullrequestreview-424663170", "createdAt": "2020-06-04T17:16:20Z", "commit": {"oid": "813f9ce278be1d00df39701e1f0c0c50040be3b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2237, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}