{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNDIyODI1", "number": 249, "title": "Fix race condition in run and shutdown which let zombies keep running", "bodyText": "Issue #, if available:\nDescription of changes:\nFixes a condition in that a script was able to start during \"run\", even though the service was currently \"finished\". Also adds a check in the exec of Exec so that it refuses to run anything if the thread is interrupted, this should help catch some more race conditions.\nRan GIVEN_service_install_fail_retry_succeed_WHEN_kernel_launches_THEN_service_install_succeeds 151 times to verify that the zombie processes are no longer an issue for it.\nAdditionally changes the RANKS in the platform resolver to be an atomic ref so that the test doesn't need to use reflection to set it. This resolves an issue where running all the tests in a loop would cause problems on subsequent runs due to the ranks having been modified on the previous execution.\nFixes deadlock when a service errors during shutdown due to a timeout, and adds a test to verify the functionality.\nRan all unit and integration (non-e2e) tests 30x without any errors.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-19T23:40:47Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249", "merged": true, "mergeCommit": {"oid": "1a73ae68771c239b4953cd7382194fcfb64aa517"}, "closed": true, "closedAt": "2020-05-20T18:05:15Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci9THqABqjMzNTQxMjEwOTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjNBVHgFqTQxNTU4NjUxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92164e6a2a19d2407878f9e259640e4a40159423", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/92164e6a2a19d2407878f9e259640e4a40159423", "committedDate": "2020-05-19T23:40:08Z", "message": "Fix race condition in run and shutdown which let zombies"}, "afterCommit": {"oid": "6f8f19c824afbb90e32ada1cd93aaeb38da928f4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f8f19c824afbb90e32ada1cd93aaeb38da928f4", "committedDate": "2020-05-19T23:44:28Z", "message": "Fix race condition in run and shutdown which let zombies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f8f19c824afbb90e32ada1cd93aaeb38da928f4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f8f19c824afbb90e32ada1cd93aaeb38da928f4", "committedDate": "2020-05-19T23:44:28Z", "message": "Fix race condition in run and shutdown which let zombies"}, "afterCommit": {"oid": "ee01a6a3e543c976392cb6ddab0eacfbbfdba1c4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ee01a6a3e543c976392cb6ddab0eacfbbfdba1c4", "committedDate": "2020-05-19T23:49:55Z", "message": "Fix race condition in run and shutdown which let zombies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee01a6a3e543c976392cb6ddab0eacfbbfdba1c4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ee01a6a3e543c976392cb6ddab0eacfbbfdba1c4", "committedDate": "2020-05-19T23:49:55Z", "message": "Fix race condition in run and shutdown which let zombies"}, "afterCommit": {"oid": "7664e68040020ba08c3c0c8821efc872eb5f62e7", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7664e68040020ba08c3c0c8821efc872eb5f62e7", "committedDate": "2020-05-19T23:53:27Z", "message": "Fix race condition in run and shutdown which let zombies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7664e68040020ba08c3c0c8821efc872eb5f62e7", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7664e68040020ba08c3c0c8821efc872eb5f62e7", "committedDate": "2020-05-19T23:53:27Z", "message": "Fix race condition in run and shutdown which let zombies"}, "afterCommit": {"oid": "ef514274a2402f9373c96b5a96f7a765be1f13d4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ef514274a2402f9373c96b5a96f7a765be1f13d4", "committedDate": "2020-05-19T23:56:49Z", "message": "Fix race condition in run and shutdown which let zombies"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTEwMjE1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#pullrequestreview-414910215", "createdAt": "2020-05-20T00:18:13Z", "commit": {"oid": "ef514274a2402f9373c96b5a96f7a765be1f13d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMDoxODoxM1rOGX3Ckw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMDoxODoxM1rOGX3Ckw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3MjIxMQ==", "bodyText": "I feel this should be right before L350", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r427672211", "createdAt": "2020-05-20T00:18:13Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -327,6 +328,11 @@ public void handleError() throws InterruptedException {\n     @SuppressWarnings(\"PMD.CloseResource\")\n     protected Pair<RunStatus, Exec> run(Topic t, String cmd, IntConsumer background, List<Exec> trackingList)\n             throws InterruptedException {\n+        // Don't run anything if the current thread is currently interrupted\n+        if (Thread.currentThread().isInterrupted()) {\n+            throw new InterruptedException();\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef514274a2402f9373c96b5a96f7a765be1f13d4"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c64f589885f74cfd386b7da078f2dbc0d944e932", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c64f589885f74cfd386b7da078f2dbc0d944e932", "committedDate": "2020-05-20T02:03:22Z", "message": "Fix race condition in run and shutdown which let zombies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5db55437208175b33530ab7e13252cc86652809", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a5db55437208175b33530ab7e13252cc86652809", "committedDate": "2020-05-20T02:03:22Z", "message": "Fix deadlock when service errors during shutdown"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41aa7f9fb90b8c5db040c191feb97ebb266bcb63", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/41aa7f9fb90b8c5db040c191feb97ebb266bcb63", "committedDate": "2020-05-20T02:03:09Z", "message": "Address PR comments"}, "afterCommit": {"oid": "1956067b7b4233e41370868d9553ee03900b2c34", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1956067b7b4233e41370868d9553ee03900b2c34", "committedDate": "2020-05-20T02:03:26Z", "message": "Address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cdc2dd72a2886c87b877e4177289c6aef599f3f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2cdc2dd72a2886c87b877e4177289c6aef599f3f", "committedDate": "2020-05-20T02:58:50Z", "message": "Address PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1956067b7b4233e41370868d9553ee03900b2c34", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1956067b7b4233e41370868d9553ee03900b2c34", "committedDate": "2020-05-20T02:03:26Z", "message": "Address PR comments"}, "afterCommit": {"oid": "2cdc2dd72a2886c87b877e4177289c6aef599f3f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2cdc2dd72a2886c87b877e4177289c6aef599f3f", "committedDate": "2020-05-20T02:58:50Z", "message": "Address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858", "committedDate": "2020-05-20T06:10:10Z", "message": "Try to fix tlog being closed and appended"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTQzNTk0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#pullrequestreview-415543594", "createdAt": "2020-05-20T17:06:52Z", "commit": {"oid": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzowNjo1MlrOGYVlNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzowNjo1MlrOGYVlNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE3MjU5OQ==", "bodyText": "why separating logger and static logger?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r428172599", "createdAt": "2020-05-20T17:06:52Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/util/Exec.java", "diffHunk": "@@ -101,6 +101,7 @@\n     private Copier stdoutc;\n     private final AtomicBoolean isClosed = new AtomicBoolean(false);\n     AtomicInteger numberOfCopiers;\n+    private Logger logger = staticLogger;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTc3NTEx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#pullrequestreview-415577511", "createdAt": "2020-05-20T17:51:37Z", "commit": {"oid": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzo1MTozN1rOGYXMvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzo1Mjo0NFrOGYXPiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE5OTEwMw==", "bodyText": "Exec is closed() when the timeout for the task is reached. Is cancelling the backing task the problem? Wouldn't InterruptedException be thrown for this scenario?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r428199103", "createdAt": "2020-05-20T17:51:37Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/util/Exec.java", "diffHunk": "@@ -308,6 +314,12 @@ public Exec withErr(Consumer<CharSequence> o) {\n \n     @SuppressWarnings(\"PMD.AvoidRethrowingException\")\n     private void exec() throws InterruptedException, IOException {\n+        // Don't run anything if the current thread is currently interrupted", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE5OTgxNg==", "bodyText": "Nice", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#discussion_r428199816", "createdAt": "2020-05-20T17:52:44Z", "author": {"login": "fahadmohammed01"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -79,6 +82,25 @@ void GIVEN_service_with_timeout_WHEN_timeout_expires_THEN_move_service_to_errore\n         assertTrue(ServicesBErroredLatch.await(5, TimeUnit.SECONDS));\n     }\n \n+    @Test\n+    void GIVEN_service_shutdown_with_timeout_WHEN_timeout_expires_THEN_service_still_closes()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTg2NTE5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/249#pullrequestreview-415586519", "createdAt": "2020-05-20T18:03:39Z", "commit": {"oid": "56f26fb007dbaa1312ec4bc0a2d7d5ad11f49858"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2214, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}