{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4Nzg0NDY2", "number": 244, "title": "Fix TES Dependency Injection", "bodyText": "Issue #, if available:\nDescription of changes:\nFixes dependency injection for TES and adds iotCredEndpoint to list of configurable device info along with the mqtt endpoint, cert paths, etc.\nThis make it possible to start TES as a service from kernel.locate. No new tests were added, Prateek will be adding more testing later.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-15T20:07:57Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244", "merged": true, "mergeCommit": {"oid": "2fea8a0962423e1b3b9df984cebbbd99811d50cc"}, "closed": true, "closedAt": "2020-05-18T20:22:25Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchn3d-AFqTQxMjkzNzc1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcilyphgFqTQxMzkxMTk2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTM3NzUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#pullrequestreview-412937753", "createdAt": "2020-05-15T20:12:28Z", "commit": {"oid": "6fbe5f76e9c33b58c0d03bcf58ad37900db3b9b7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fbe5f76e9c33b58c0d03bcf58ad37900db3b9b7", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6fbe5f76e9c33b58c0d03bcf58ad37900db3b9b7", "committedDate": "2020-05-15T19:38:52Z", "message": "Fix TES injection"}, "afterCommit": {"oid": "4fae6156de83b5c40371b33a6a5b97dff588f966", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4fae6156de83b5c40371b33a6a5b97dff588f966", "committedDate": "2020-05-15T21:07:06Z", "message": "Fix TES injection"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7abc2c812b70b036ca9c6d6d1288e47cbef1b795", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7abc2c812b70b036ca9c6d6d1288e47cbef1b795", "committedDate": "2020-05-15T21:13:31Z", "message": "Add update policy to pom"}, "afterCommit": {"oid": "5b6a502fa848cbba121ad2a30438d5a2464c1b8d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b6a502fa848cbba121ad2a30438d5a2464c1b8d", "committedDate": "2020-05-15T21:21:19Z", "message": "Add update policy to pom"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b6a502fa848cbba121ad2a30438d5a2464c1b8d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b6a502fa848cbba121ad2a30438d5a2464c1b8d", "committedDate": "2020-05-15T21:21:19Z", "message": "Add update policy to pom"}, "afterCommit": {"oid": "8d91f089369b1b196d0ae236ec4ea66f9cc4a1b3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8d91f089369b1b196d0ae236ec4ea66f9cc4a1b3", "committedDate": "2020-05-15T21:22:11Z", "message": "Add update policy to pom"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d91f089369b1b196d0ae236ec4ea66f9cc4a1b3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8d91f089369b1b196d0ae236ec4ea66f9cc4a1b3", "committedDate": "2020-05-15T21:22:11Z", "message": "Add update policy to pom"}, "afterCommit": {"oid": "023b7ae5dcd2991ce30e9ea550750cb4729722c5", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/023b7ae5dcd2991ce30e9ea550750cb4729722c5", "committedDate": "2020-05-15T21:24:21Z", "message": "Add update policy to pom"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "023b7ae5dcd2991ce30e9ea550750cb4729722c5", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/023b7ae5dcd2991ce30e9ea550750cb4729722c5", "committedDate": "2020-05-15T21:24:21Z", "message": "Add update policy to pom"}, "afterCommit": {"oid": "f20981a78b64a33a27308b47f6877818bf58f018", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f20981a78b64a33a27308b47f6877818bf58f018", "committedDate": "2020-05-15T21:26:54Z", "message": "Add update policy to pom"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f20981a78b64a33a27308b47f6877818bf58f018", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f20981a78b64a33a27308b47f6877818bf58f018", "committedDate": "2020-05-15T21:26:54Z", "message": "Add update policy to pom"}, "afterCommit": {"oid": "465c1578b5804b25fdd00e2c54fa2d4ad6280ebc", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/465c1578b5804b25fdd00e2c54fa2d4ad6280ebc", "committedDate": "2020-05-15T21:45:31Z", "message": "Add update policy to pom"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e69c763e259d47acb3344ab563c263c48e44967", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e69c763e259d47acb3344ab563c263c48e44967", "committedDate": "2020-05-16T00:01:26Z", "message": "Fix TES injection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "560fa96ec6c4fb9882ea531e5461542ffbb19de3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/560fa96ec6c4fb9882ea531e5461542ffbb19de3", "committedDate": "2020-05-16T00:01:37Z", "message": "Update shading to remove extra StaticLoggerBinding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "041f77bf31686187958fa83326e43fce059e4612", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/041f77bf31686187958fa83326e43fce059e4612", "committedDate": "2020-05-18T03:22:11Z", "message": "Update E2E tests to have cred endpoint"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd1fa153274f8fe5f685e8f389816284453543aa", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bd1fa153274f8fe5f685e8f389816284453543aa", "committedDate": "2020-05-18T02:25:47Z", "message": "Merge branch 'master' into tes-injection"}, "afterCommit": {"oid": "041f77bf31686187958fa83326e43fce059e4612", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/041f77bf31686187958fa83326e43fce059e4612", "committedDate": "2020-05-18T03:22:11Z", "message": "Update E2E tests to have cred endpoint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODUwNjQ2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#pullrequestreview-413850646", "createdAt": "2020-05-18T18:48:03Z", "commit": {"oid": "041f77bf31686187958fa83326e43fce059e4612"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODU5NjQ3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#pullrequestreview-413859647", "createdAt": "2020-05-18T19:00:14Z", "commit": {"oid": "041f77bf31686187958fa83326e43fce059e4612"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTowMDoxNFrOGXD0lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjo1OVrOGXEOBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzMzA0Ng==", "bodyText": "change name of @param", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426833046", "createdAt": "2020-05-18T19:00:14Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/tes/IotConnectionManager.java", "diffHunk": "@@ -24,31 +25,31 @@\n import java.util.concurrent.ExecutionException;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.TimeoutException;\n+import javax.inject.Inject;\n \n public class IotConnectionManager implements Closeable {\n     // TODO: Move Iot related classes to a central location\n     private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n     // TODO: ALPN support\n     private static final int IOT_PORT = 8443;\n     // Max wait time for device to establish mTLS connection with IOT core\n-    private static final long TIMEOUT_FOR_CONNECTION_SETUP_SECONDS = (long) Duration.ofMinutes(1).getSeconds();\n-    private final String iotEndpoint;\n+    private static final long TIMEOUT_FOR_CONNECTION_SETUP_SECONDS = Duration.ofMinutes(1).getSeconds();\n     private final HttpClientConnectionManager connManager;\n \n     /**\n      * Constructor.\n-     * @param iotEndpoint Iot cloud credentials endpoint for managing connections to.\n+     *\n      * @param deviceConfiguration Device configuration for getting cert and keys for mTLS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041f77bf31686187958fa83326e43fce059e4612"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTA0OA==", "bodyText": "Wondering if we should just rename this to dataEndpoint, to match with the terminology used in AWS docs. Similar change in DeviceConfiguration as well.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426839048", "createdAt": "2020-05-18T19:12:01Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -330,5 +321,18 @@ public static void updateKernelConfigWithIotConfiguration(Kernel kernel, Utils.T\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_PRIVATE_KEY_PATH).withValue(privKeyFilePath);\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_CERTIFICATE_FILE_PATH).withValue(certFilePath);\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_ROOT_CA_PATH).withValue(caFilePath);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_IOT_CRED_ENDPOINT).withValue(thing.credEndpoint);\n+    }\n+\n+    @AllArgsConstructor\n+    public static class ThingInfo {\n+        public String thingArn;\n+        public String thingName;\n+        public String certificateArn;\n+        public String certificateId;\n+        public String certificatePem;\n+        public KeyPair keyPair;\n+        public String endpoint;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041f77bf31686187958fa83326e43fce059e4612"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTM3Mg==", "bodyText": "clientEndpoint -> dataEndpoint", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426839372", "createdAt": "2020-05-18T19:12:38Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeviceConfigurationHelper.java", "diffHunk": "@@ -36,33 +37,38 @@\n \n     /**\n      * Retrieves the device configuration information from kernel config to communicate with Iot Cloud.\n+     *\n      * @return {@link DeviceConfiguration}\n      * @throws DeviceConfigurationException when configuration is not available for the device.\n      */\n     public DeviceConfiguration getDeviceConfiguration() throws DeviceConfigurationException {\n         String thingName = getStringParameterFromConfig(DEVICE_PARAM_THING_NAME);\n-        String certificateFilePath = kernelCommandLine.deTilde(\n-                getStringParameterFromConfig(DEVICE_PARAM_CERTIFICATE_FILE_PATH));\n+        String certificateFilePath =\n+                kernelCommandLine.deTilde(getStringParameterFromConfig(DEVICE_PARAM_CERTIFICATE_FILE_PATH));\n         String privateKeyPath = kernelCommandLine.deTilde(getStringParameterFromConfig(DEVICE_PARAM_PRIVATE_KEY_PATH));\n         String rootCAPath = kernelCommandLine.deTilde(getStringParameterFromConfig(DEVICE_PARAM_ROOT_CA_PATH));\n         String mqttClientEndpoint = getStringParameterFromConfig(DEVICE_PARAM_MQTT_CLIENT_ENDPOINT);\n-        validateDeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint);\n-        return new DeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint);\n+        String iotCredEndpoint = getStringParameterFromConfig(DEVICE_PARAM_IOT_CRED_ENDPOINT);\n+        validateDeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint,\n+                iotCredEndpoint);\n+        return new DeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint,\n+                iotCredEndpoint);\n     }\n \n     private String getStringParameterFromConfig(String parameterName) {\n         String paramValue = \"\";\n         //TODO: Update when device provisioning is implemented\n-        Topic childTopic = kernel.getConfig().lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC,\n-                DeploymentService.DEPLOYMENT_SERVICE_TOPICS).findLeafChild(parameterName);\n+        Topic childTopic = kernel.getConfig()\n+                .lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC, DeploymentService.DEPLOYMENT_SERVICE_TOPICS)\n+                .findLeafChild(parameterName);\n         if (childTopic != null && childTopic.getOnce() != null) {\n             paramValue = childTopic.getOnce().toString();\n         }\n         return paramValue;\n     }\n \n     private void validateDeviceConfiguration(String thingName, String certificateFilePath, String privateKeyPath,\n-                                             String rootCAPath, String clientEndpoint)\n+                                             String rootCAPath, String clientEndpoint, String iotCredEndpoint)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041f77bf31686187958fa83326e43fce059e4612"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTU1Ng==", "bodyText": "Renaming here to iotDataEndpoint", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426839556", "createdAt": "2020-05-18T19:12:59Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeviceConfiguration.java", "diffHunk": "@@ -18,4 +18,5 @@\n     private String privateKeyFilePath;\n     private String rootCAFilePath;\n     private String mqttClientEndpoint;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041f77bf31686187958fa83326e43fce059e4612"}, "originalPosition": 3}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b15f8767d1318829ecff4e22ef5bc76388b4a31", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4b15f8767d1318829ecff4e22ef5bc76388b4a31", "committedDate": "2020-05-18T19:24:19Z", "message": "Address PR comments"}, "afterCommit": {"oid": "488a3a302d296d17e46664d119df557a34c17578", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/488a3a302d296d17e46664d119df557a34c17578", "committedDate": "2020-05-18T19:33:39Z", "message": "Address PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "488a3a302d296d17e46664d119df557a34c17578", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/488a3a302d296d17e46664d119df557a34c17578", "committedDate": "2020-05-18T19:33:39Z", "message": "Address PR comments"}, "afterCommit": {"oid": "27f8158bf1c36d6f75c671cf99d6a03f25fa79ab", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/27f8158bf1c36d6f75c671cf99d6a03f25fa79ab", "committedDate": "2020-05-18T19:37:49Z", "message": "Address PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODk1Mjkw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#pullrequestreview-413895290", "createdAt": "2020-05-18T19:53:27Z", "commit": {"oid": "27f8158bf1c36d6f75c671cf99d6a03f25fa79ab"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a42d29fb5886267881ba33860f7fd712574c9166", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a42d29fb5886267881ba33860f7fd712574c9166", "committedDate": "2020-05-18T20:00:01Z", "message": "Address PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27f8158bf1c36d6f75c671cf99d6a03f25fa79ab", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/27f8158bf1c36d6f75c671cf99d6a03f25fa79ab", "committedDate": "2020-05-18T19:37:49Z", "message": "Address PR comments"}, "afterCommit": {"oid": "a42d29fb5886267881ba33860f7fd712574c9166", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a42d29fb5886267881ba33860f7fd712574c9166", "committedDate": "2020-05-18T20:00:01Z", "message": "Address PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTAxODc1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#pullrequestreview-413901875", "createdAt": "2020-05-18T20:04:06Z", "commit": {"oid": "a42d29fb5886267881ba33860f7fd712574c9166"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTExOTYy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#pullrequestreview-413911962", "createdAt": "2020-05-18T20:21:19Z", "commit": {"oid": "a42d29fb5886267881ba33860f7fd712574c9166"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2204, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}