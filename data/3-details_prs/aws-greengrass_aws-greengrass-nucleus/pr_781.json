{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2Mjk5NjQy", "number": 781, "title": "Fix for handling close stream from client", "bodyText": "Issue #, if available:\nWhen IPC client explicitly closed a stream, this was not handled correctly in server and the entire connection was being closed.\nDescription of changes:\nUpdated the SDK server to handler the closed stream correctly.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-10T22:25:38Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/781", "merged": true, "mergeCommit": {"oid": "4c81e4c26def1d36c27b6b206f55e8f288ac52d4"}, "closed": true, "closedAt": "2020-12-11T01:41:57Z", "author": {"login": "abanthiy"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk7ElfgFqTU0OTY1NTUxNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk91xVgFqTU0OTc0MjczMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NjU1NTE1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/781#pullrequestreview-549655515", "createdAt": "2020-12-10T22:27:54Z", "commit": {"oid": "76b3c4094f3586488fd12175351b16181a1e077d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMjoyNzo1NVrOIDgJow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMjoyNzo1NVrOIDgJow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU0MzM5NQ==", "bodyText": "why is this a warning? We have too many logs from IPC already IMO.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/781#discussion_r540543395", "createdAt": "2020-12-10T22:27:55Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/OperationContinuationHandler.java", "diffHunk": "@@ -41,7 +41,8 @@ public OperationContinuationHandler(final OperationContinuationHandlerContext co\n \n     @Override\n     final protected void onContinuationClosed() {\n-        LOGGER.debug(\"{} stream continuation closed.\", getOperationName());\n+        LOGGER.warn(\"{} stream continuation closed.\", getOperationName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76b3c4094f3586488fd12175351b16181a1e077d"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76b3c4094f3586488fd12175351b16181a1e077d", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/76b3c4094f3586488fd12175351b16181a1e077d", "committedDate": "2020-12-10T22:24:00Z", "message": "Fix for handling close stream from client"}, "afterCommit": {"oid": "fb87b6d22f16b3d119f29a9fa0d98fddd7f8d6fd", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb87b6d22f16b3d119f29a9fa0d98fddd7f8d6fd", "committedDate": "2020-12-10T22:46:01Z", "message": "Fix for handling close stream from client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb87b6d22f16b3d119f29a9fa0d98fddd7f8d6fd", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb87b6d22f16b3d119f29a9fa0d98fddd7f8d6fd", "committedDate": "2020-12-10T22:46:01Z", "message": "Fix for handling close stream from client"}, "afterCommit": {"oid": "667ae3b18bb21b9cb44e87353db6078a22fb3b24", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/667ae3b18bb21b9cb44e87353db6078a22fb3b24", "committedDate": "2020-12-10T22:50:36Z", "message": "Fix for handling close stream from client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Njg5MTgz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/781#pullrequestreview-549689183", "createdAt": "2020-12-10T23:19:15Z", "commit": {"oid": "667ae3b18bb21b9cb44e87353db6078a22fb3b24"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzoxOToxNVrOIDh7qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzo0OTowOVrOIDithA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3MjU4Nw==", "bodyText": "every request is a stream, right? seems too many info logs.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/781#discussion_r540572587", "createdAt": "2020-12-10T23:19:15Z", "author": {"login": "fengwang666"}, "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/OperationContinuationHandler.java", "diffHunk": "@@ -162,17 +163,17 @@ final protected OperationContinuationHandlerContext getContext () {\n      */\n     @Override\n     final public CompletableFuture<Void> closeStream() {\n-        LOGGER.debug(\"[{}] closing stream\", getOperationName());\n+        LOGGER.info(\"[{}] closing stream\", getOperationName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "667ae3b18bb21b9cb44e87353db6078a22fb3b24"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4NDk3Ng==", "bodyText": "Is this correct? In this parent class ServerConnectionContinuationHandler:\n    protected void onContinuationClosed() {\n        this.close();\n    }", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/781#discussion_r540584976", "createdAt": "2020-12-10T23:48:14Z", "author": {"login": "fengwang666"}, "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/OperationContinuationHandler.java", "diffHunk": "@@ -42,6 +42,7 @@ public OperationContinuationHandler(final OperationContinuationHandlerContext co\n     @Override\n     final protected void onContinuationClosed() {\n         LOGGER.debug(\"{} stream continuation closed.\", getOperationName());\n+        continuation.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "667ae3b18bb21b9cb44e87353db6078a22fb3b24"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4NTM0OA==", "bodyText": "This long if condition requires comments.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/781#discussion_r540585348", "createdAt": "2020-12-10T23:49:09Z", "author": {"login": "fengwang666"}, "path": "src/main/java/software/amazon/awssdk/eventstreamrpc/OperationContinuationHandler.java", "diffHunk": "@@ -242,21 +243,29 @@ private void invokeAfterHandleRequest() {\n     }\n \n     @Override\n-    final protected void onContinuationMessage(List<Header> list, byte[] bytes, MessageType messageType, int i) {\n+    final protected void onContinuationMessage(List<Header> list, byte[] bytes, MessageType messageType, int messageFlags) {\n         LOGGER.debug(\"Continuation native id: \" + continuation.getNativeHandle());\n-        final EventStreamRPCServiceModel serviceModel = getOperationModelContext().getServiceModel();\n \n+        //We can prevent a client from sending a request, and hanging up before receiving a response\n+        //but doing so will prevent any work from being done\n+        if (initialRequest == null && (messageFlags & MessageFlags.TerminateStream.getByteValue()) != 0) {\n+            LOGGER.warn(\"Not invoking \" + getOperationName() + \" operation for client request received with a terminate flag set to 1\");\n+            return;\n+        }\n+        final EventStreamRPCServiceModel serviceModel = getOperationModelContext().getServiceModel();\n         try {\n             if (initialRequest != null) {\n-                //TODO: FIX empty close messages arrive here and throw exception\n-                final StreamingRequestType streamEvent = serviceModel.fromJson(getStreamingRequestClass(), bytes);\n-                //exceptions occurring during this processing will result in closure of stream\n-                handleStreamEvent(streamEvent);\n+                if ((messageFlags & MessageFlags.TerminateStream.getByteValue()) != 0 && (bytes == null || bytes.length == 0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "667ae3b18bb21b9cb44e87353db6078a22fb3b24"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "667ae3b18bb21b9cb44e87353db6078a22fb3b24", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/667ae3b18bb21b9cb44e87353db6078a22fb3b24", "committedDate": "2020-12-10T22:50:36Z", "message": "Fix for handling close stream from client"}, "afterCommit": {"oid": "05b7d54140653b81ad130668cba4ca67112021b8", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/05b7d54140653b81ad130668cba4ca67112021b8", "committedDate": "2020-12-11T00:41:31Z", "message": "Fix for handling close stream from client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6133e76e1b6ca0a34a079f523329ad8e1246299", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d6133e76e1b6ca0a34a079f523329ad8e1246299", "committedDate": "2020-12-11T00:44:02Z", "message": "Fix for handling close stream from client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b6be61cab5b54bfca9bf128aea8c7a6e7714c14", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1b6be61cab5b54bfca9bf128aea8c7a6e7714c14", "committedDate": "2020-12-11T00:43:41Z", "message": "Merge branch 'master' into sdkServerFix"}, "afterCommit": {"oid": "d6133e76e1b6ca0a34a079f523329ad8e1246299", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d6133e76e1b6ca0a34a079f523329ad8e1246299", "committedDate": "2020-12-11T00:44:02Z", "message": "Fix for handling close stream from client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0722935ffd527e1a45f68db0e7d1c813ddbadabe", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0722935ffd527e1a45f68db0e7d1c813ddbadabe", "committedDate": "2020-12-11T00:55:16Z", "message": "Updating logging levels in SDK server code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NzM0Mjkw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/781#pullrequestreview-549734290", "createdAt": "2020-12-11T01:16:29Z", "commit": {"oid": "0722935ffd527e1a45f68db0e7d1c813ddbadabe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NzQyNzMx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/781#pullrequestreview-549742731", "createdAt": "2020-12-11T01:41:27Z", "commit": {"oid": "0722935ffd527e1a45f68db0e7d1c813ddbadabe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2569, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}