{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2OTQ2Njcx", "number": 437, "title": "Renamed safeupdatepolicy to componentupdatepolicy", "bodyText": "Issue #, if available:\n\nRenamed safeUpdatePolicy to componentUpdatePolicy\nMinor refactoring\nDescription of changes:\n\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-14T23:41:41Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437", "merged": true, "mergeCommit": {"oid": "0c638625b8fa7f374a7803da05c2edcd40f76f56"}, "closed": true, "closedAt": "2020-09-15T19:53:13Z", "author": {"login": "fahadmohammed01"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdI79ZAgH2gAyNDg2OTQ2NjcxOjRlZTZjNzdiZTk3YzNmNzY2OTliNTQ2NjhjNWNlNDljMjA3YjA2MDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJNRBrgFqTQ4OTAxOTM4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4ee6c77be97c3f76699b54668c5ce49c207b0602", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ee6c77be97c3f76699b54668c5ce49c207b0602", "committedDate": "2020-09-14T23:40:05Z", "message": "renamed safeupdatepolicy to componentupdatepolicy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af0f310a4e8468817cabdea4913b34d80483ec15", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/af0f310a4e8468817cabdea4913b34d80483ec15", "committedDate": "2020-09-14T23:41:48Z", "message": "Merge branch 'master' into componentUpdatePolicy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjI3NDc1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#pullrequestreview-488227475", "createdAt": "2020-09-14T23:44:02Z", "commit": {"oid": "af0f310a4e8468817cabdea4913b34d80483ec15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMzo0NDowMlrOHRrVAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMzo0NDowMlrOHRrVAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI5NzczMA==", "bodyText": "Why aren't we just using the SDK's model?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#discussion_r488297730", "createdAt": "2020-09-14T23:44:02Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/ComponentUpdatePolicy.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *   SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment.model;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import lombok.AllArgsConstructor;\n+import lombok.EqualsAndHashCode;\n+import lombok.Getter;\n+import lombok.NoArgsConstructor;\n+import lombok.Setter;\n+import lombok.ToString;\n+\n+@JsonInclude(JsonInclude.Include.NON_NULL)\n+@Getter\n+@Setter\n+@AllArgsConstructor\n+@NoArgsConstructor\n+@EqualsAndHashCode\n+@ToString\n+public class ComponentUpdatePolicy {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af0f310a4e8468817cabdea4913b34d80483ec15"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e7687eab95e0cc6a1558e0ebabe28ea07bf8a8d", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e7687eab95e0cc6a1558e0ebabe28ea07bf8a8d", "committedDate": "2020-09-15T00:29:51Z", "message": "fixed benchmark test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjQ3ODU3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#pullrequestreview-488247857", "createdAt": "2020-09-15T00:47:23Z", "commit": {"oid": "8e7687eab95e0cc6a1558e0ebabe28ea07bf8a8d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "533e46f2b0becabde96aca179737992e0c13ecd1", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/533e46f2b0becabde96aca179737992e0c13ecd1", "committedDate": "2020-09-15T00:49:41Z", "message": "removed import in benchmark test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjUyNDA3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#pullrequestreview-488252407", "createdAt": "2020-09-15T01:02:07Z", "commit": {"oid": "533e46f2b0becabde96aca179737992e0c13ecd1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMTowMjowN1rOHRstsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMTowMjowN1rOHRstsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyMDQzNQ==", "bodyText": "It's weird that we don't use tag as key anymore but still use it here and in discardPendingUpdateAction.\nCan we have something like this?\nprivate final Map<String, Pair<DeploymentDocument, Crashable>> pendingActions = new LinkedHashMap<>();", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#discussion_r488320435", "createdAt": "2020-09-15T01:02:07Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -98,21 +102,27 @@ protected synchronized void runUpdateActions() {\n      * @return true if there is a pending action for specified tag\n      */\n     public boolean hasPendingUpdateAction(String tag) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "533e46f2b0becabde96aca179737992e0c13ecd1"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c4d89101ae7ff53dda0d05d6d1099ec0f3410bd", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8c4d89101ae7ff53dda0d05d6d1099ec0f3410bd", "committedDate": "2020-09-15T02:23:42Z", "message": "addressed comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f7bd28e66e667729a35e4445fc399b2d955db4cc", "committedDate": "2020-09-15T02:24:43Z", "message": "Merge branch 'master' into componentUpdatePolicy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjgxMTA0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#pullrequestreview-488281104", "createdAt": "2020-09-15T02:34:42Z", "commit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjozNDo0MlrOHRuThg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjozNDo0MlrOHRuThg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0NjUwMg==", "bodyText": "nit - a precomponent event, is it 'precomponent update event'?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#discussion_r488346502", "createdAt": "2020-09-15T02:34:42Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -40,13 +43,18 @@\n @ImplementsService(name = \"SafeSystemUpdate\", autostart = true)\n @Singleton\n public class UpdateSystemSafelyService extends EvergreenService {\n-    private final Map<String, Crashable> pendingActions = new LinkedHashMap<>();\n+    // String identifies the action, the pair consist of timeout and an action. The timeout\n+    // represents the value in seconds the kernel will wait for components to respond to\n+    // an Precomponent event", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjgxNjcx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#pullrequestreview-488281671", "createdAt": "2020-09-15T02:36:34Z", "commit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjozNjozNFrOHRuVeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjozNjozNFrOHRuVeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0NzAwMA==", "bodyText": "This comment seems to be incomplete", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#discussion_r488347000", "createdAt": "2020-09-15T02:36:34Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -189,9 +169,43 @@ protected void startup() throws InterruptedException {\n         }\n     }\n \n-    //only for testing\n-    public void setDefaultTimeOutInMs(long defaultTimeOutInMs) {\n-        this.defaultTimeOutInMs = defaultTimeOutInMs;\n+    /*\n+     If multiple updates are present, get the max time-out. Currently", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc"}, "originalPosition": 131}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjgyNDQw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#pullrequestreview-488282440", "createdAt": "2020-09-15T02:39:08Z", "commit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjozOTowOFrOHRuYPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjozOTowOFrOHRuYPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0NzcwOA==", "bodyText": "Is it okay to fail silently when the component seems to have done its part by responding to the update event in a timely manner?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#discussion_r488347708", "createdAt": "2020-09-15T02:39:08Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -189,9 +169,43 @@ protected void startup() throws InterruptedException {\n         }\n     }\n \n-    //only for testing\n-    public void setDefaultTimeOutInMs(long defaultTimeOutInMs) {\n-        this.defaultTimeOutInMs = defaultTimeOutInMs;\n+    /*\n+     If multiple updates are present, get the max time-out. Currently\n+     */\n+    private long getMaxTimeoutInMillis() {\n+        Optional<Long> maxTimeoutInSec = pendingActions.values().stream()\n+                .map(pair -> pair.getLeft())\n+                .max(Long::compareTo);\n+        return TimeUnit.SECONDS.toMillis(maxTimeoutInSec.get());\n     }\n \n+    private long getTimeToReCheck(long timeout, List<Future<DeferUpdateRequest>> deferRequestFutures)\n+            throws InterruptedException {\n+        final long currentTimeMillis = clock.millis();\n+        long maxTimeToReCheck = currentTimeMillis;\n+        while ((clock.millis() - currentTimeMillis) < timeout && !deferRequestFutures.isEmpty()) {\n+            Iterator<Future<DeferUpdateRequest>> iterator = deferRequestFutures.iterator();\n+            while (iterator.hasNext()) {\n+                Future<DeferUpdateRequest> fut = iterator.next();\n+                if (fut.isDone()) {\n+                    try {\n+                        DeferUpdateRequest deferRequest = fut.get();\n+                        long timeToRecheck = currentTimeMillis + deferRequest.getRecheckTimeInMs();\n+                        if (timeToRecheck > maxTimeToReCheck) {\n+                            maxTimeToReCheck = timeToRecheck;\n+                            logger.atInfo().setEventType(\"service-update-deferred\")\n+                                    .log(\"deferred by {} for {} millis with message {}\",\n+                                            deferRequest.getMessage(), deferRequest.getRecheckTimeInMs(),\n+                                            deferRequest.getMessage());\n+                        }\n+                    } catch (ExecutionException e) {\n+                        logger.error(\"Failed to process component update request\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc"}, "originalPosition": 160}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjgzMzA0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#pullrequestreview-488283304", "createdAt": "2020-09-15T02:41:47Z", "commit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjo0MTo0N1rOHRubbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjo0MTo0N1rOHRubbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0ODUyNQ==", "bodyText": "wildcard?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#discussion_r488348525", "createdAt": "2020-09-15T02:41:47Z", "author": {"login": "shaguptashaikh"}, "path": "src/test/evergreen-kernel-benchmark/src/main/java/com/aws/iot/evergreen/jmh/packagemanager/DependencyResolverBenchmark.java", "diffHunk": "@@ -39,6 +40,8 @@\n import java.util.HashMap;\n import java.util.List;\n \n+import static com.aws.iot.evergreen.deployment.model.ComponentUpdatePolicyAction.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjgzODMw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#pullrequestreview-488283830", "createdAt": "2020-09-15T02:43:24Z", "commit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjo0MzoyNFrOHRudKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjo0MzoyNFrOHRudKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0ODk2OQ==", "bodyText": "Should this fail? This import doesn't seem consistent with the other imports which use the sdk model class", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#discussion_r488348969", "createdAt": "2020-09-15T02:43:24Z", "author": {"login": "shaguptashaikh"}, "path": "src/test/evergreen-kernel-benchmark/src/main/java/com/aws/iot/evergreen/jmh/packagemanager/DependencyResolverBenchmark.java", "diffHunk": "@@ -7,9 +7,10 @@\n \n import com.aws.iot.evergreen.config.Topics;\n import com.aws.iot.evergreen.deployment.DeploymentService;\n+import com.aws.iot.evergreen.deployment.model.ComponentUpdatePolicy;\n+import com.aws.iot.evergreen.deployment.model.ComponentUpdatePolicyAction;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7bd28e66e667729a35e4445fc399b2d955db4cc"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36276a7ac17e28ab43ac4178d2f5363476269f54", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/36276a7ac17e28ab43ac4178d2f5363476269f54", "committedDate": "2020-09-15T04:59:40Z", "message": "addressed comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0df3628e5eee097accb720c7c2f296dcc0923b5f", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0df3628e5eee097accb720c7c2f296dcc0923b5f", "committedDate": "2020-09-15T07:35:56Z", "message": "fixed benchmark test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63ddffde7fbdbffcd19b4c41933ec1c84f33c003", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/63ddffde7fbdbffcd19b4c41933ec1c84f33c003", "committedDate": "2020-09-15T17:45:59Z", "message": "confirming to cloud model"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4OTQ4NjEy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#pullrequestreview-488948612", "createdAt": "2020-09-15T18:22:32Z", "commit": {"oid": "63ddffde7fbdbffcd19b4c41933ec1c84f33c003"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MDE5Mzg0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/437#pullrequestreview-489019384", "createdAt": "2020-09-15T19:49:55Z", "commit": {"oid": "63ddffde7fbdbffcd19b4c41933ec1c84f33c003"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3308, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}