{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4OTY0OTEy", "number": 448, "title": "Changing GGC to use Iot pre-prod if configured to do so", "bodyText": "Issue #, if available:\nDescription of changes:\nMaking it configurable in setup to be able to specify the environment stage (beta/gamma/prod). Device will communicate with Iot pre-prod if it has been configured to do so. The E2E tests are will not talk to Gamma Iot.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-17T22:31:20Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448", "merged": true, "mergeCommit": {"oid": "6201d862293497d3b46337cfa44fea81abad6d33"}, "closed": true, "closedAt": "2020-09-21T16:41:22Z", "author": {"login": "abanthiy"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ41R7ABqjM3ODAxNzE0MDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLGI9SgFqTQ5Mjc5MzI2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8fa0d54fe587c255b4def368cfe5c1f5ce252448", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8fa0d54fe587c255b4def368cfe5c1f5ce252448", "committedDate": "2020-09-17T22:27:56Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "02c9bbc95e53eb0113a339c2017445102da67a99", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/02c9bbc95e53eb0113a339c2017445102da67a99", "committedDate": "2020-09-17T22:35:16Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMDMzNzQ4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#pullrequestreview-491033748", "createdAt": "2020-09-17T22:33:13Z", "commit": {"oid": "8fa0d54fe587c255b4def368cfe5c1f5ce252448"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjozMzoxM1rOHT3wug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo0MDoyNlrOHT36_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU5ODU4Ng==", "bodyText": "now that the endpoints are combined we should be able to remove this \"FCS_ENDPOINT\" and instead get the endpoint when we create the client, based on region and stage", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490598586", "createdAt": "2020-09-17T22:33:13Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -97,7 +98,7 @@\n  */\n @ExtendWith(EGExtension.class)\n public class BaseE2ETestCase implements AutoCloseable {\n-    private static final String FCS_ENDPOINT = \"https://bp5p2uvbx6.execute-api.us-east-1.amazonaws.com/Gamma\";\n+    private static final String FCS_ENDPOINT = \"https://evergreen-gamma.us-east-1.amazonaws.com\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fa0d54fe587c255b4def368cfe5c1f5ce252448"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwMDk2NQ==", "bodyText": "print the exception to stderr/stdout as well or rethrow. Otherwise it won't be clear because the logger will be going to files, but this should be user-facing.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490600965", "createdAt": "2020-09-17T22:39:49Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/EvergreenSetup.java", "diffHunk": "@@ -169,7 +178,13 @@ public EvergreenSetup(PrintStream outStream, PrintStream errStream, String... se\n     @SuppressWarnings(\n             {\"PMD.NullAssignment\", \"PMD.AvoidCatchingThrowable\", \"PMD.DoNotCallSystemExit\", \"PMD.SystemPrintln\"})\n     public static void main(String[] args) {\n-        EvergreenSetup evergreenSetup = new EvergreenSetup(System.out, System.err, args);\n+        EvergreenSetup evergreenSetup = null;\n+        try {\n+            evergreenSetup = new EvergreenSetup(System.out, System.err, args);\n+        } catch (URISyntaxException | InvalidEnvironmentStageException e) {\n+            logger.atError().setCause(e).log(\"Error while initializing Evergreen setup\");\n+            System.exit(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02c9bbc95e53eb0113a339c2017445102da67a99"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwMTIxMw==", "bodyText": "We should update the endpoint that we use and make it configurable.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490601213", "createdAt": "2020-09-17T22:40:26Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -97,7 +98,7 @@\n  */\n @ExtendWith(EGExtension.class)\n public class BaseE2ETestCase implements AutoCloseable {\n-    private static final String FCS_ENDPOINT = \"https://bp5p2uvbx6.execute-api.us-east-1.amazonaws.com/Gamma\";\n+    private static final String FCS_ENDPOINT = \"https://evergreen-gamma.us-east-1.amazonaws.com\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU5ODU4Ng=="}, "originalCommit": {"oid": "8fa0d54fe587c255b4def368cfe5c1f5ce252448"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02c9bbc95e53eb0113a339c2017445102da67a99", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/02c9bbc95e53eb0113a339c2017445102da67a99", "committedDate": "2020-09-17T22:35:16Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "cbb39fa4a2081ef3db6651af53698dc7dbdd9188", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cbb39fa4a2081ef3db6651af53698dc7dbdd9188", "committedDate": "2020-09-17T22:42:33Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbb39fa4a2081ef3db6651af53698dc7dbdd9188", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cbb39fa4a2081ef3db6651af53698dc7dbdd9188", "committedDate": "2020-09-17T22:42:33Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "f823bdc9c289c3192dd5b55744c0975b29a65f22", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f823bdc9c289c3192dd5b55744c0975b29a65f22", "committedDate": "2020-09-17T23:06:39Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMDUzNTQ4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#pullrequestreview-491053548", "createdAt": "2020-09-17T23:25:45Z", "commit": {"oid": "f823bdc9c289c3192dd5b55744c0975b29a65f22"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMzoyNTo0NVrOHT4zNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMzoyNjozM1rOHT40GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxNTYwNA==", "bodyText": "why?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490615604", "createdAt": "2020-09-17T23:25:45Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/EvergreenSetup.java", "diffHunk": "@@ -169,7 +180,8 @@ public EvergreenSetup(PrintStream outStream, PrintStream errStream, String... se\n     @SuppressWarnings(\n             {\"PMD.NullAssignment\", \"PMD.AvoidCatchingThrowable\", \"PMD.DoNotCallSystemExit\", \"PMD.SystemPrintln\"})\n     public static void main(String[] args) {\n-        EvergreenSetup evergreenSetup = new EvergreenSetup(System.out, System.err, args);\n+        EvergreenSetup evergreenSetup = null;\n+        evergreenSetup = new EvergreenSetup(System.out, System.err, args);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f823bdc9c289c3192dd5b55744c0975b29a65f22"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYxNTgzMw==", "bodyText": "make package-private since it is only in tests?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490615833", "createdAt": "2020-09-17T23:26:33Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/EvergreenSetup.java", "diffHunk": "@@ -110,7 +118,8 @@\n     private static final Logger logger = LogManager.getLogger(EvergreenSetup.class);\n     private final String[] setupArgs;\n     private final List<String> kernelArgs = new ArrayList<>();\n-    private final DeviceProvisioningHelper deviceProvisioningHelper;\n+    @Setter", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f823bdc9c289c3192dd5b55744c0975b29a65f22"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f823bdc9c289c3192dd5b55744c0975b29a65f22", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f823bdc9c289c3192dd5b55744c0975b29a65f22", "committedDate": "2020-09-17T23:06:39Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "5c3d1470a2ab773173dcaf4f9e5b07bce4e2be1d", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5c3d1470a2ab773173dcaf4f9e5b07bce4e2be1d", "committedDate": "2020-09-17T23:58:00Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c3d1470a2ab773173dcaf4f9e5b07bce4e2be1d", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5c3d1470a2ab773173dcaf4f9e5b07bce4e2be1d", "committedDate": "2020-09-17T23:58:00Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "19c0c7077f430d4c654fd5ed6b82c7f7b8f2b61f", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19c0c7077f430d4c654fd5ed6b82c7f7b8f2b61f", "committedDate": "2020-09-18T00:02:15Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19c0c7077f430d4c654fd5ed6b82c7f7b8f2b61f", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19c0c7077f430d4c654fd5ed6b82c7f7b8f2b61f", "committedDate": "2020-09-18T00:02:15Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "ce4952544ef8297a439d25714f2f6e17fd815b01", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ce4952544ef8297a439d25714f2f6e17fd815b01", "committedDate": "2020-09-18T00:12:37Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce4952544ef8297a439d25714f2f6e17fd815b01", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ce4952544ef8297a439d25714f2f6e17fd815b01", "committedDate": "2020-09-18T00:12:37Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "8afc20de873c76e6ead149a1668018126b48365f", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8afc20de873c76e6ead149a1668018126b48365f", "committedDate": "2020-09-18T00:15:31Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMDcxMjg1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#pullrequestreview-491071285", "createdAt": "2020-09-18T00:21:18Z", "commit": {"oid": "8afc20de873c76e6ead149a1668018126b48365f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMDoyMToxOFrOHT5xZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMDoyMToxOFrOHT5xZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzMTUyNw==", "bodyText": "This probably isn't accurate for prod.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490631527", "createdAt": "2020-09-18T00:21:18Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -64,26 +70,42 @@\n  */\n @Getter\n public class DeviceProvisioningHelper {\n+\n+    //evergreen-<stage>.<region>.amazonaws.com\n+    public static final String GREENGRASS_ENDPOINT_FORMAT = \"evergreen-%s.%s.amazonaws.com\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8afc20de873c76e6ead149a1668018126b48365f"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8afc20de873c76e6ead149a1668018126b48365f", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8afc20de873c76e6ead149a1668018126b48365f", "committedDate": "2020-09-18T00:15:31Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "ff2ba9864a2fab731a766d6b0bae0cb8fd806a6c", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ff2ba9864a2fab731a766d6b0bae0cb8fd806a6c", "committedDate": "2020-09-18T02:26:42Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMTEyMDc2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#pullrequestreview-491112076", "createdAt": "2020-09-18T02:40:58Z", "commit": {"oid": "ff2ba9864a2fab731a766d6b0bae0cb8fd806a6c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMjo0MDo1OFrOHT7-dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMjo0MjoyNlrOHT7_pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY2NzYzNg==", "bodyText": "These 2 FCS and GCS clients can be the same now that we have a shared endpoint.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490667636", "createdAt": "2020-09-18T02:40:58Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -145,13 +148,25 @@\n \n     protected Kernel kernel;\n \n-    protected static final IotClient iotClient = IotSdkClientFactory.getIotClient(GAMMA_REGION.toString(),\n-            new HashSet<>(Arrays.asList(InvalidRequestException.class, DeleteConflictException.class)));\n+    protected static IotClient iotClient;\n+\n+    static {\n+        try {\n+            iotClient = IotSdkClientFactory.getIotClient(GAMMA_REGION.toString(),\n+                        envStage,\n+                        new HashSet<>(Arrays.asList(InvalidRequestException.class, DeleteConflictException.class)));\n+        } catch (URISyntaxException e) {\n+            logger.atError().setCause(e).log(\"Caught exception while initializing Iot client\");\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    ;\n     private static AWSEvergreen fcsClient;\n     protected static final AWSEvergreen cmsClient = AWSEvergreenClientBuilder.standard()\n                                                                              .withEndpointConfiguration(\n                                                                                      new AwsClientBuilder.EndpointConfiguration(\n-                                                                                             DeviceProvisioningHelper.GCS_ENDPOINT,\n+                                                                                             String.format(STAGE_TO_ENDPOINT_FORMAT.get(envStage), GAMMA_REGION.toString()),\n                                                                                              GAMMA_REGION.toString()))\n                                                                              .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2ba9864a2fab731a766d6b0bae0cb8fd806a6c"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY2Nzc3NA==", "bodyText": "this can be removed, just get the gcs client", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490667774", "createdAt": "2020-09-18T02:41:34Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -340,7 +357,8 @@ private static void cleanUpTestComponentArtifactsFromS3() {\n     private static synchronized AWSEvergreen getFcsClient() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2ba9864a2fab731a766d6b0bae0cb8fd806a6c"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY2Nzk0Mw==", "bodyText": "default should be east-1 because that's all that evergreen is deployed to", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490667943", "createdAt": "2020-09-18T02:42:26Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelCommandLine.java", "diffHunk": "@@ -51,6 +55,8 @@\n \n     @Getter\n     private String providedConfigPathName;\n+    private String awsRegion = \"us-west-2\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2ba9864a2fab731a766d6b0bae0cb8fd806a6c"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMTEzNTM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#pullrequestreview-491113536", "createdAt": "2020-09-18T02:46:12Z", "commit": {"oid": "ff2ba9864a2fab731a766d6b0bae0cb8fd806a6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMjo0NjoxMlrOHT8Dbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMjo0NjoxMlrOHT8Dbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY2ODkxMQ==", "bodyText": "If the --region isn't specified, we should fallback to DeviceConfiguration.getRegion(). And if it is specified, then we should update the region in the DeviceConfiguration", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490668911", "createdAt": "2020-09-18T02:46:12Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelCommandLine.java", "diffHunk": "@@ -94,6 +100,14 @@ public void parseArgs(String... args) {\n                     rootAbsolutePath = getArg();\n                     Objects.requireNonNull(rootAbsolutePath, \"-r or --root requires an argument\");\n                     break;\n+                case \"--aws-region\":\n+                case \"-ar\":\n+                    awsRegion = getArg();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff2ba9864a2fab731a766d6b0bae0cb8fd806a6c"}, "originalPosition": 43}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff2ba9864a2fab731a766d6b0bae0cb8fd806a6c", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ff2ba9864a2fab731a766d6b0bae0cb8fd806a6c", "committedDate": "2020-09-18T02:26:42Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "1ca00e3898f660bbeb77430b6c05f6b3a0c97cc1", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1ca00e3898f660bbeb77430b6c05f6b3a0c97cc1", "committedDate": "2020-09-18T06:09:21Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ca00e3898f660bbeb77430b6c05f6b3a0c97cc1", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1ca00e3898f660bbeb77430b6c05f6b3a0c97cc1", "committedDate": "2020-09-18T06:09:21Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "6db99d993142919df9d118e5cccfc7e5da8cbce4", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6db99d993142919df9d118e5cccfc7e5da8cbce4", "committedDate": "2020-09-18T06:10:21Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMTkxNDQz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#pullrequestreview-491191443", "createdAt": "2020-09-18T06:46:46Z", "commit": {"oid": "6db99d993142919df9d118e5cccfc7e5da8cbce4"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNjo0Njo0NlrOHUAKNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNjo0ODozNFrOHUANdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDczNjE4Mw==", "bodyText": "does cloud prod actually work? We've only ever tested against gamma. Just wondering if the default should be gamma.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490736183", "createdAt": "2020-09-18T06:46:46Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelCommandLine.java", "diffHunk": "@@ -51,6 +57,8 @@\n \n     @Getter\n     private String providedConfigPathName;\n+    private String awsRegion = \"us-east-1\";\n+    private String envStage = \"prod\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6db99d993142919df9d118e5cccfc7e5da8cbce4"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDczNjYyMw==", "bodyText": "use kernel.getContext().get(DeviceConfiguration.class) (this may be problematic to call in the constructor though)? We should be using the same device configuration object everywhere", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490736623", "createdAt": "2020-09-18T06:47:40Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelCommandLine.java", "diffHunk": "@@ -68,6 +76,7 @@ public static void main(String[] args) {\n \n     public KernelCommandLine(Kernel kernel) {\n         this.kernel = kernel;\n+        this.deviceConfiguration = new DeviceConfiguration(kernel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6db99d993142919df9d118e5cccfc7e5da8cbce4"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDczNzAxMw==", "bodyText": "you don't need to nullcheck. It is never allowed to be null", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r490737013", "createdAt": "2020-09-18T06:48:34Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelCommandLine.java", "diffHunk": "@@ -109,10 +126,18 @@ public void parseArgs(String... args) {\n         kernel.getConfig().lookup(\"system\", \"rootpath\").dflt(rootAbsolutePath)\n                 .subscribe((whatHappened, topic) -> initPaths(Coerce.toString(topic)));\n \n-        // Endpoint for Beta CMS in us-east-1\n-        // TODO: Once service is available in multiple regions, this should not be a static config and\n-        // use the region value to determine endpoint\n-        kernel.getContext().put(CONTEXT_COMPONENT_SERVICE_ENDPOINT, GCS_ENDPOINT);\n+        if (deviceConfiguration.getAWSRegion() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6db99d993142919df9d118e5cccfc7e5da8cbce4"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjc4MDgx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#pullrequestreview-491678081", "createdAt": "2020-09-18T18:06:21Z", "commit": {"oid": "6db99d993142919df9d118e5cccfc7e5da8cbce4"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxODowNjoyMVrOHUXAig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxODowNzo0OVrOHUXDqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTExMDUzOA==", "bodyText": "Do we have these 2 new throws?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r491110538", "createdAt": "2020-09-18T18:06:21Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/EvergreenSetup.java", "diffHunk": "@@ -136,12 +148,13 @@\n      * @param outStream writer to use to send text response to user\n      * @param errStream writer to use to send error response to user\n      * @param setupArgs CLI args for setup script\n+     * @throws URISyntaxException when IotEndpoint is malformed\n+     * @throws InvalidEnvironmentStageException when the environment stage configured is invalid", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6db99d993142919df9d118e5cccfc7e5da8cbce4"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTExMTMzOA==", "bodyText": "Also do we need to update the other constructor below?\nEvergreenSetup(PrintStream outStream, PrintStream errStream, DeviceProvisioningHelper deviceProvisioningHelper, String... setupArgs)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r491111338", "createdAt": "2020-09-18T18:07:49Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/EvergreenSetup.java", "diffHunk": "@@ -136,12 +148,13 @@\n      * @param outStream writer to use to send text response to user\n      * @param errStream writer to use to send error response to user\n      * @param setupArgs CLI args for setup script\n+     * @throws URISyntaxException when IotEndpoint is malformed\n+     * @throws InvalidEnvironmentStageException when the environment stage configured is invalid", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTExMDUzOA=="}, "originalCommit": {"oid": "6db99d993142919df9d118e5cccfc7e5da8cbce4"}, "originalPosition": 56}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6db99d993142919df9d118e5cccfc7e5da8cbce4", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6db99d993142919df9d118e5cccfc7e5da8cbce4", "committedDate": "2020-09-18T06:10:21Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}, "afterCommit": {"oid": "87f27a6103b171a08283f00b981d37dc08d53d26", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/87f27a6103b171a08283f00b981d37dc08d53d26", "committedDate": "2020-09-18T19:03:11Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzk1Njc3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#pullrequestreview-491795677", "createdAt": "2020-09-18T21:39:58Z", "commit": {"oid": "eb243210570d02f12d94a7edd949a204b6bc29e4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0bf8813701b1de4073700b42b7e1ca5c88054ed", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f0bf8813701b1de4073700b42b7e1ca5c88054ed", "committedDate": "2020-09-20T03:42:47Z", "message": "Changing GGC to use Iot pre-prod if configured to do so"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb243210570d02f12d94a7edd949a204b6bc29e4", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eb243210570d02f12d94a7edd949a204b6bc29e4", "committedDate": "2020-09-18T21:39:46Z", "message": "Merge branch 'master' into configurablePreProd"}, "afterCommit": {"oid": "2669d4d3e37babb14e7509aed5d0c4dc721219f5", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2669d4d3e37babb14e7509aed5d0c4dc721219f5", "committedDate": "2020-09-20T03:43:11Z", "message": "Ignore unknown recipe properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d0db1863abedaa38e896c3baf399532e7b2a741", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3d0db1863abedaa38e896c3baf399532e7b2a741", "committedDate": "2020-09-20T03:51:45Z", "message": "Ignore unknown recipe properties"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2669d4d3e37babb14e7509aed5d0c4dc721219f5", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2669d4d3e37babb14e7509aed5d0c4dc721219f5", "committedDate": "2020-09-20T03:43:11Z", "message": "Ignore unknown recipe properties"}, "afterCommit": {"oid": "3d0db1863abedaa38e896c3baf399532e7b2a741", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3d0db1863abedaa38e896c3baf399532e7b2a741", "committedDate": "2020-09-20T03:51:45Z", "message": "Ignore unknown recipe properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMTcxMjU2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#pullrequestreview-492171256", "createdAt": "2020-09-20T04:26:17Z", "commit": {"oid": "2669d4d3e37babb14e7509aed5d0c4dc721219f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNzkzMjY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#pullrequestreview-492793265", "createdAt": "2020-09-21T16:36:49Z", "commit": {"oid": "3d0db1863abedaa38e896c3baf399532e7b2a741"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjozNjo1MFrOHVZYjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjozNjo1MFrOHVZYjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5ODAzMQ==", "bodyText": "[No need to change]\nwhy?\nTo keep device/cloud consistency, I can add this into the common serializer instead of just device side.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/448#discussion_r492198031", "createdAt": "2020-09-21T16:36:50Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/greengrass/componentmanager/converter/RecipeLoader.java", "diffHunk": "@@ -46,7 +47,9 @@\n         com.amazon.aws.iot.greengrass.component.common.ComponentRecipe componentRecipe;\n         try {\n             componentRecipe =\n-                    SerializerFactory.getRecipeSerializer().readValue(recipeFileContent,\n+                    SerializerFactory.getRecipeSerializer()\n+                            .disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d0db1863abedaa38e896c3baf399532e7b2a741"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2974, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}