{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMDU3MzQ5", "number": 52, "title": "Refactor EvergreenService with initial unit test", "bodyText": "Issue #, if available:\nDescription of changes:\n\nOrdered EvergreenService class fields and methods.\nExpand single-letter vars naming for better readability.\nAdded intiial unit test with Mockito, and Mockito JUnit5 Extenstion maven dependencies.\nGit ignore IntelliJ generated .idea folder\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-02-04T21:23:23Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52", "merged": true, "mergeCommit": {"oid": "374eb79c529fa56c37386adda6049d200703e346"}, "closed": true, "closedAt": "2020-02-06T00:16:39Z", "author": {"login": "leaf94"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBIR4tgH2gAyMzcxMDU3MzQ5OjczYmRiOTQ1ODk2ZWYyZWJlOGQ1OGM2ZDZlMTY1OGY5OGJlYjQyOWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBfT_fAH2gAyMzcxMDU3MzQ5OjU4NmMyYTc2ZGUzYmE3MDg3MWQxY2E4YzBmNzhhYmNlODJiN2I5YTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "73bdb945896ef2ebe8d58c6d6e1658f98beb429a", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/73bdb945896ef2ebe8d58c6d6e1658f98beb429a", "committedDate": "2020-02-04T21:18:47Z", "message": "Refactor EvergreenService with initial unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzEyODI5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#pullrequestreview-353312829", "createdAt": "2020-02-04T21:26:31Z", "commit": {"oid": "73bdb945896ef2ebe8d58c6d6e1658f98beb429a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMToyNjozMlrOFlkCDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMToyODoyOVrOFlkFkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMTk4Mg==", "bodyText": "I think these comments are pretty unnecessary.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r374931982", "createdAt": "2020-02-04T21:26:32Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -43,92 +43,57 @@\n \n @SuppressFBWarnings(value = \"DMI_HARDCODED_ABSOLUTE_FILENAME\", justification = \"Need hardcoded paths to find what OS we're on\")\n public class EvergreenService implements InjectionActions, Subscriber, Closeable {\n-    public static final String stateTopicName = \"_State\";\n-    private static final Pattern depParse = Pattern.compile(\" *([^,:;& ]+)(:([^,; ]+))?[,; ]*\");\n-    private static final HashMap<String, Integer> ranks = new HashMap<>();\n \n-    static {\n-        // figure out what OS we're running and add applicable tags\n-        // The more specific a tag is, the higher its rank should be\n-        // TODO: a loopy set of hacks\n-        ranks.put(\"all\", 0);\n-        ranks.put(\"any\", 0);\n-        if (Files.exists(Paths.get(\"/bin/bash\")) || Files.exists(Paths.get(\"/usr/bin/bash\"))) {\n-            ranks.put(\"unix\", 3);\n-            ranks.put(\"posix\", 3);\n-        }\n-        if (Files.exists(Paths.get(\"/proc\"))) {\n-            ranks.put(\"linux\", 10);\n-        }\n-        if (Files.exists(Paths.get(\"/usr/bin/apt-get\"))) {\n-            ranks.put(\"debian\", 11);\n-        }\n-        if (Exec.isWindows) {\n-            ranks.put(\"windows\", 5);\n-        }\n-        if (Files.exists(Paths.get(\"/usr/bin/yum\"))) {\n-            ranks.put(\"fedora\", 11);\n-        }\n-        String sysver = Exec.sh(\"uname -a\").toLowerCase();\n-        if (sysver.contains(\"ubuntu\")) {\n-            ranks.put(\"ubuntu\", 20);\n-        }\n-        if (sysver.contains(\"darwin\")) {\n-            ranks.put(\"macos\", 20);\n-        }\n-        if (sysver.contains(\"raspbian\")) {\n-            ranks.put(\"raspbian\", 22);\n-        }\n-        if (sysver.contains(\"qnx\")) {\n-            ranks.put(\"qnx\", 22);\n-        }\n-        if (sysver.contains(\"cygwin\")) {\n-            ranks.put(\"cygwin\", 22);\n-        }\n-        if (sysver.contains(\"freebsd\")) {\n-            ranks.put(\"freebsd\", 22);\n-        }\n-        if (sysver.contains(\"solaris\") || sysver.contains(\"sunos\")) {\n-            ranks.put(\"solaris\", 22);\n-        }\n-        try {\n-            ranks.put(InetAddress.getLocalHost().getHostName(), 99);\n-        } catch (UnknownHostException ex) {\n-        }\n-    }\n+    // static variables\n+    public static final String STATE_TOPIC_NAME = \"_State\";\n+    private static final Pattern DEP_PARSE = Pattern.compile(\" *([^,:;& ]+)(:([^,; ]+))?[,; ]*\");\n+    private static final Map<String, Integer> RANKS = buildRanks();\n \n+    // instance variables\n+    // public\n     public final Topics config;\n-    protected final CopyOnWriteArrayList<EvergreenService> explicitDependencies = new CopyOnWriteArrayList<>();\n-    final Object dependencyReadyLock = new Object();\n-    private final Topic state;\n     public Context context;\n+\n+    // protected", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73bdb945896ef2ebe8d58c6d6e1658f98beb429a"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDkzMjg4Mw==", "bodyText": "Anything here?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r374932883", "createdAt": "2020-02-04T21:28:29Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.config.Validator;\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.util.Log;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.InOrder;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+class EvergreenServiceTest {\n+\n+    public static final String STATE_TOPIC_NAME = \"_State\";\n+    private static final String EVERGREEN_SERVICE_FULL_NAME = \"EvergreenServiceFullName\";\n+\n+    private EvergreenService evergreenService;\n+\n+    @Mock\n+    private Topics config;\n+\n+    @Mock\n+    private Topic stateTopic;\n+\n+    @Mock\n+    private Context context;\n+\n+    @Mock\n+    private Log log;\n+\n+    @Captor\n+    private ArgumentCaptor<Validator> validatorArgumentCaptor;\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        Mockito.when(config.createLeafChild(Mockito.any())).thenReturn(stateTopic);\n+\n+        evergreenService = new EvergreenService(config);\n+        evergreenService.context = context;\n+    }\n+\n+    @Test\n+    void testConstructor() {\n+        // GIVEN\n+        // beforeEach\n+\n+        // WHEN\n+        // beforeEach", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73bdb945896ef2ebe8d58c6d6e1658f98beb429a"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75d3b57e309993add192282047d4be90e1cb11d2", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/75d3b57e309993add192282047d4be90e1cb11d2", "committedDate": "2020-02-05T01:17:58Z", "message": "Minor change in EvergreenServiceTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDE1ODM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#pullrequestreview-353415836", "createdAt": "2020-02-05T01:27:02Z", "commit": {"oid": "75d3b57e309993add192282047d4be90e1cb11d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46252a3d304e55290f22fd9bc24df2ceea55e11c", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/46252a3d304e55290f22fd9bc24df2ceea55e11c", "committedDate": "2020-02-05T02:00:45Z", "message": "Remove unnecessary comments per team's suggestion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDMxNjAz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#pullrequestreview-353431603", "createdAt": "2020-02-05T02:24:13Z", "commit": {"oid": "46252a3d304e55290f22fd9bc24df2ceea55e11c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzOTIxNTc3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#pullrequestreview-353921577", "createdAt": "2020-02-05T17:56:31Z", "commit": {"oid": "46252a3d304e55290f22fd9bc24df2ceea55e11c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzOTMxMTY3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#pullrequestreview-353931167", "createdAt": "2020-02-05T18:11:18Z", "commit": {"oid": "46252a3d304e55290f22fd9bc24df2ceea55e11c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxODoxMToxOFrOFmB6Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxODoxMToxOFrOFmB6Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQyMTQ3NA==", "bodyText": "Should use the latest: 3.2.4, and mockito core isn't needed, only this dep is required.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r375421474", "createdAt": "2020-02-05T18:11:18Z", "author": {"login": "MikeDombo"}, "path": "pom.xml", "diffHunk": "@@ -21,6 +21,18 @@\n             <version>5.5.2</version>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>org.mockito</groupId>\n+            <artifactId>mockito-core</artifactId>\n+            <version>2.21.0</version>\n+            <scope>test</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.mockito</groupId>\n+            <artifactId>mockito-junit-jupiter</artifactId>\n+            <version>2.23.0</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46252a3d304e55290f22fd9bc24df2ceea55e11c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzOTM0MzEy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#pullrequestreview-353934312", "createdAt": "2020-02-05T18:15:56Z", "commit": {"oid": "46252a3d304e55290f22fd9bc24df2ceea55e11c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxODoxNTo1NlrOFmCDww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxODoxNTo1NlrOFmCDww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQyMzkzOQ==", "bodyText": "For Greenlake we had the practice of putting the scenario into the test name such as \"GIVEN_a_service_in_new_WHEN_setState_to_installing_THEN_service_gets_installed\" or whatever. We don't necessarily need to follow that, but I would at least suggest explaining what is Given, what is the When, and what is the Then in your comments. Just having the blocks doesn't explain enough.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/52#discussion_r375423939", "createdAt": "2020-02-05T18:15:56Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/kernel/EvergreenServiceTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.config.Validator;\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.util.Log;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.InOrder;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+class EvergreenServiceTest {\n+\n+    public static final String STATE_TOPIC_NAME = \"_State\";\n+    private static final String EVERGREEN_SERVICE_FULL_NAME = \"EvergreenServiceFullName\";\n+\n+    private EvergreenService evergreenService;\n+\n+    @Mock\n+    private Topics config;\n+\n+    @Mock\n+    private Topic stateTopic;\n+\n+    @Mock\n+    private Context context;\n+\n+    @Mock\n+    private Log log;\n+\n+    @Captor\n+    private ArgumentCaptor<Validator> validatorArgumentCaptor;\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        Mockito.when(config.createLeafChild(Mockito.any())).thenReturn(stateTopic);\n+\n+        evergreenService = new EvergreenService(config);\n+        evergreenService.context = context;\n+    }\n+\n+    @Test\n+    void testConstructor() {\n+        // GIVEN\n+        // provided in the beforeEach\n+\n+        // WHEN\n+        // provided in the beforeEach\n+\n+        // THEN\n+        // verify config\n+        Assertions.assertSame(config, evergreenService.config);\n+        Mockito.verify(config).createLeafChild(STATE_TOPIC_NAME);\n+\n+        // verify stateTopic\n+        Mockito.verify(stateTopic).setParentNeedsToKnow(false);\n+        Mockito.verify(stateTopic).setValue(Long.MAX_VALUE, State.New);\n+        Mockito.verify(stateTopic).validate(validatorArgumentCaptor.capture());\n+        Mockito.verify(stateTopic).subscribe(evergreenService);\n+        Mockito.verifyNoMoreInteractions(stateTopic);\n+\n+        // verify validator\n+        Validator validator = validatorArgumentCaptor.getValue();\n+        State returnedState = (State) validator.validate(State.New, null);\n+        Assertions.assertSame(State.New, returnedState);\n+    }\n+\n+    @Test\n+    void getState() {\n+        Mockito.when(stateTopic.getOnce()).thenReturn(State.New);\n+\n+        Assertions.assertSame(State.New, evergreenService.getState());\n+\n+        Mockito.verify(stateTopic).getOnce();\n+    }\n+\n+    @Test\n+    void setState() {\n+        // GIVEN", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46252a3d304e55290f22fd9bc24df2ceea55e11c"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a01e323612e324a9c9adfcc9cd9be0de142df63", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7a01e323612e324a9c9adfcc9cd9be0de142df63", "committedDate": "2020-02-05T23:57:26Z", "message": "Change unit test methods name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "586c2a76de3ba70871d1ca8c0f78abce82b7b9a3", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/586c2a76de3ba70871d1ca8c0f78abce82b7b9a3", "committedDate": "2020-02-06T00:08:54Z", "message": "Merge branch 'master' into EGService_Refactor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2461, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}