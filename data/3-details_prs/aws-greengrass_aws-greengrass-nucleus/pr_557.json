{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MTEzMjM4", "number": 557, "title": "updating the CLIEventStreamAgent to copy recipe files in parity with \u2026", "bodyText": "\u2026old agent\nIssue #, if available:\nDescription of changes:\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-22T08:29:04Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/557", "merged": true, "mergeCommit": {"oid": "cdd5d7c9e2239a6e6455d5b40bce8d5653affc35"}, "closed": true, "closedAt": "2020-10-22T20:48:18Z", "author": {"login": "abanthiy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVDO9bAFqTUxNDgyMDQwMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVIRaJAFqTUxNTEwNjQ4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODIwNDAy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/557#pullrequestreview-514820402", "createdAt": "2020-10-22T14:55:42Z", "commit": {"oid": "a63f666235dab61f29975d850256db14a6fd0934"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "886636283f4dfb7149461772d3bd6cd5eaa6f8ca", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/886636283f4dfb7149461772d3bd6cd5eaa6f8ca", "committedDate": "2020-10-22T15:18:41Z", "message": "Merge branch 'master' into ipcCli"}, "afterCommit": {"oid": "7c55a7b34545f43a4fe47675fed742b5f3f5efe8", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7c55a7b34545f43a4fe47675fed742b5f3f5efe8", "committedDate": "2020-10-22T19:16:28Z", "message": "updating the CLIEventStreamAgent to copy recipe files in parity with old agent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDkwMzIx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/557#pullrequestreview-515090321", "createdAt": "2020-10-22T20:23:35Z", "commit": {"oid": "33a718a85a936f390cdd487e7ee8d2b0506bdd94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyMzozNVrOHmydIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoyMzozNVrOHmydIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzNDU5Mw==", "bodyText": "Do you need to also change file permissions at this point?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/557#discussion_r510434593", "createdAt": "2020-10-22T20:23:35Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/greengrass/builtin/services/cli/CLIEventStreamAgent.java", "diffHunk": "@@ -395,6 +395,43 @@ private void validateUpdateRecipesAndArtifactsRequest(UpdateRecipesAndArtifactsR\n                 throw new InvalidArgumentsError(\"Need to provide at least one of the directory paths to update\");\n             }\n         }\n+\n+        private void copyRecipes(Path from, Path to) throws IOException {\n+            for (Path r : Files.walk(from).collect(Collectors.toList())) {\n+                String ext = Utils.extension(r.toString());\n+                ComponentRecipe recipe = null;\n+                if (r.toFile().length() == 0) {\n+                    logger.atInfo().log(\"Skipping recipe file {} because it is empty\", r);\n+                    continue;\n+                }\n+                try {\n+                    switch (ext.toLowerCase()) {\n+                        case \"yaml\":\n+                        case \"yml\":\n+                            recipe = SerializerFactory.getRecipeSerializer().readValue(r.toFile(),\n+                                    ComponentRecipe.class);\n+                            break;\n+                        case \"json\":\n+                            recipe = SerializerFactory.getRecipeSerializerJson()\n+                                    .readValue(r.toFile(), ComponentRecipe.class);\n+                            break;\n+                        default:\n+                            break;\n+                    }\n+                } catch (IOException e) {\n+                    logger.atError().log(\"Error reading recipe file from {}\", r, e);\n+                }\n+\n+                if (recipe == null) {\n+                    continue;\n+                }\n+\n+                // Write the recipe as YAML with the proper filename into the store\n+                Path copyTo = to.resolve(String.format(RECIPE_FILE_NAME_FORMAT, recipe.getComponentName(),\n+                        recipe.getComponentVersion().getValue()));\n+                Files.write(copyTo, SerializerFactory.getRecipeSerializer().writeValueAsBytes(recipe));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33a718a85a936f390cdd487e7ee8d2b0506bdd94"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0348f9d1bd06699e3d3cf6bafc89c2f17bba16ec", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0348f9d1bd06699e3d3cf6bafc89c2f17bba16ec", "committedDate": "2020-10-22T20:28:06Z", "message": "updating the CLIEventStreamAgent to copy recipe files in parity with old agent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c974566a29195536f8ccf122b366643f057574ac", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c974566a29195536f8ccf122b366643f057574ac", "committedDate": "2020-10-22T20:28:06Z", "message": "Changing the crt version to 1.0.0-SNAPSHOT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33a718a85a936f390cdd487e7ee8d2b0506bdd94", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/33a718a85a936f390cdd487e7ee8d2b0506bdd94", "committedDate": "2020-10-22T20:18:04Z", "message": "Merge branch 'master' into ipcCli"}, "afterCommit": {"oid": "c974566a29195536f8ccf122b366643f057574ac", "author": {"user": {"login": "abanthiy", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c974566a29195536f8ccf122b366643f057574ac", "committedDate": "2020-10-22T20:28:06Z", "message": "Changing the crt version to 1.0.0-SNAPSHOT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDk3NjU2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/557#pullrequestreview-515097656", "createdAt": "2020-10-22T20:34:14Z", "commit": {"oid": "c974566a29195536f8ccf122b366643f057574ac"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozNDoxNFrOHmyy3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDozNDoxNFrOHmyy3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MDE1OA==", "bodyText": "nvm, I missed that we are reading in memory first.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/557#discussion_r510440158", "createdAt": "2020-10-22T20:34:14Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/greengrass/builtin/services/cli/CLIEventStreamAgent.java", "diffHunk": "@@ -395,6 +395,43 @@ private void validateUpdateRecipesAndArtifactsRequest(UpdateRecipesAndArtifactsR\n                 throw new InvalidArgumentsError(\"Need to provide at least one of the directory paths to update\");\n             }\n         }\n+\n+        private void copyRecipes(Path from, Path to) throws IOException {\n+            for (Path r : Files.walk(from).collect(Collectors.toList())) {\n+                String ext = Utils.extension(r.toString());\n+                ComponentRecipe recipe = null;\n+                if (r.toFile().length() == 0) {\n+                    logger.atInfo().log(\"Skipping recipe file {} because it is empty\", r);\n+                    continue;\n+                }\n+                try {\n+                    switch (ext.toLowerCase()) {\n+                        case \"yaml\":\n+                        case \"yml\":\n+                            recipe = SerializerFactory.getRecipeSerializer().readValue(r.toFile(),\n+                                    ComponentRecipe.class);\n+                            break;\n+                        case \"json\":\n+                            recipe = SerializerFactory.getRecipeSerializerJson()\n+                                    .readValue(r.toFile(), ComponentRecipe.class);\n+                            break;\n+                        default:\n+                            break;\n+                    }\n+                } catch (IOException e) {\n+                    logger.atError().log(\"Error reading recipe file from {}\", r, e);\n+                }\n+\n+                if (recipe == null) {\n+                    continue;\n+                }\n+\n+                // Write the recipe as YAML with the proper filename into the store\n+                Path copyTo = to.resolve(String.format(RECIPE_FILE_NAME_FORMAT, recipe.getComponentName(),\n+                        recipe.getComponentVersion().getValue()));\n+                Files.write(copyTo, SerializerFactory.getRecipeSerializer().writeValueAsBytes(recipe));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzNDU5Mw=="}, "originalCommit": {"oid": "33a718a85a936f390cdd487e7ee8d2b0506bdd94"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTA2NDgx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/557#pullrequestreview-515106481", "createdAt": "2020-10-22T20:47:54Z", "commit": {"oid": "c974566a29195536f8ccf122b366643f057574ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2816, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}