{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzOTUzNzc3", "number": 761, "title": "Get Nucleus version from property file included in zip, deploy CLI version=nucleus version", "bodyText": "Issue #, if available:\nDescription of changes:\nGet the version from nucleus.properties in <zipdir>/conf/nucleus.properties, this way we can inject the proper version from our CI pipeline. Additionally updates the deploy dev tools to deploy a CLI version which is equal to the Nucleus version.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-07T21:18:03Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761", "merged": true, "mergeCommit": {"oid": "7c3551546cef4304069a15785da3671db8f6e8bf"}, "closed": true, "closedAt": "2020-12-08T22:19:53Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj8dYjgFqTU0NjU1MTUzOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkRvNyAFqTU0NzY4MDE5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTUxNTM5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-546551539", "createdAt": "2020-12-07T21:29:10Z", "commit": {"oid": "9432ce3e6e32079a849770d8360f78a832c906ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMToyOToxMFrOIA7hog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMToyOToxMFrOIA7hog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0NjE3OA==", "bodyText": "I think here we should read from zip but then fall back to version in config file, instead of falling back to 2.0.0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r537846178", "createdAt": "2020-12-07T21:29:10Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/easysetup/GreengrassSetup.java", "diffHunk": "@@ -255,7 +254,9 @@ void performSetup() throws IOException, DeviceConfigurationException, URISyntaxE\n             return;\n         }\n         if (showVersion) {\n-            outStream.println(String.format(SHOW_VERSION_RESPONSE, KERNEL_VERSION));\n+            // Use getVersionFromZip so that we don't need to startup the kernel which is slow and will\n+            // start creating files and directories which may not be desired\n+            outStream.println(String.format(SHOW_VERSION_RESPONSE, DeviceConfiguration.getVersionFromZip()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9432ce3e6e32079a849770d8360f78a832c906ab"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9432ce3e6e32079a849770d8360f78a832c906ab", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9432ce3e6e32079a849770d8360f78a832c906ab", "committedDate": "2020-12-07T21:17:37Z", "message": "Get Nucleus version from property file included in zip"}, "afterCommit": {"oid": "0f44cd62c4f01bc30b12ce73004b3c53bb652b32", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0f44cd62c4f01bc30b12ce73004b3c53bb652b32", "committedDate": "2020-12-07T21:37:36Z", "message": "Get Nucleus version from property file included in zip"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTg0MDU1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-546584055", "createdAt": "2020-12-07T22:16:10Z", "commit": {"oid": "0f44cd62c4f01bc30b12ce73004b3c53bb652b32"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjoxNjoxMFrOIA9P4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjo0MDoyMVrOIA-FEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3NDQwMQ==", "bodyText": "Calling this \"nucleus.properties\" will be confusing as we also have properties on the config file. Better just call this \"nucleus.version\"", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r537874401", "createdAt": "2020-12-07T22:16:10Z", "author": {"login": "JamieHunter"}, "path": "conf/nucleus.properties", "diffHunk": "@@ -0,0 +1,6 @@\n+#", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f44cd62c4f01bc30b12ce73004b3c53bb652b32"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg4NTA3MA==", "bodyText": "Post re:Invent review: lets review how InterruptedException is handled - it seems fine here if thread exists, but this is often handled incorrectly.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r537885070", "createdAt": "2020-12-07T22:35:03Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/dependency/Context.java", "diffHunk": "@@ -66,7 +66,7 @@ public void run() {\n                     Runnable task = serialized.takeFirst();\n                     task.run();\n                 } catch (InterruptedException ie) {\n-                    logger.atWarn().log(\"Interrupted while running tasks. Publish thread will exit now.\");\n+                    logger.atInfo().log(\"Interrupted while running tasks. Publish thread will exit now.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f44cd62c4f01bc30b12ce73004b3c53bb652b32"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg4NTcwMQ==", "bodyText": "Echoing earlier comment - this can get confusing, in this case for someone viewing open source - what's properties and whats configuration - we need to be very explicit here.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r537885701", "createdAt": "2020-12-07T22:36:18Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -103,6 +107,7 @@\n     private Topics loggingTopics;\n     private LoggerConfiguration currentConfiguration;\n     private String nucleusComponentNameCache;\n+    private static final Properties NUCLEUS_PROPERTIES = new Properties();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f44cd62c4f01bc30b12ce73004b3c53bb652b32"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg4NzQwNw==", "bodyText": "Really bad name. I thought you was cracking open the zip file. You're getting version from ... really need a better name for this file.\ngetVersionFromVersionConfig\ngetVersionFromBuildMetadataFile\n...\nopen to other suggestions.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r537887407", "createdAt": "2020-12-07T22:39:22Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -463,6 +467,47 @@ private Topics getTopics(String parameterName) {\n                         CONFIGURATION_CONFIG_KEY, parameterName);\n     }\n \n+    /**\n+     * Get the nucleus version from the running configuration or nucleus zip.\n+     *\n+     * @return nucleus version\n+     */\n+    public String getNucleusVersion() {\n+        String version = null;\n+        // Prefer to get the version from the active config\n+        Topics componentTopic = kernel.findServiceTopic(getNucleusComponentName());\n+        if (componentTopic != null && componentTopic.find(VERSION_CONFIG_KEY) != null) {\n+            version = Coerce.toString(componentTopic.find(VERSION_CONFIG_KEY));\n+        }\n+        if (version == null) {\n+            return getVersionFromZip();\n+        } else {\n+            return version;\n+        }\n+    }\n+\n+    /**\n+     * Get the Nucleus version from the ZIP file.\n+     *\n+     * @return version from the zip file, or a default if the version can't be determined\n+     */\n+    public static String getVersionFromZip() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f44cd62c4f01bc30b12ce73004b3c53bb652b32"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg4NzgzNQ==", "bodyText": "\"nucleus.version\" magic name ... let's put magic names into constant (static final) fields.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r537887835", "createdAt": "2020-12-07T22:40:00Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -463,6 +467,47 @@ private Topics getTopics(String parameterName) {\n                         CONFIGURATION_CONFIG_KEY, parameterName);\n     }\n \n+    /**\n+     * Get the nucleus version from the running configuration or nucleus zip.\n+     *\n+     * @return nucleus version\n+     */\n+    public String getNucleusVersion() {\n+        String version = null;\n+        // Prefer to get the version from the active config\n+        Topics componentTopic = kernel.findServiceTopic(getNucleusComponentName());\n+        if (componentTopic != null && componentTopic.find(VERSION_CONFIG_KEY) != null) {\n+            version = Coerce.toString(componentTopic.find(VERSION_CONFIG_KEY));\n+        }\n+        if (version == null) {\n+            return getVersionFromZip();\n+        } else {\n+            return version;\n+        }\n+    }\n+\n+    /**\n+     * Get the Nucleus version from the ZIP file.\n+     *\n+     * @return version from the zip file, or a default if the version can't be determined\n+     */\n+    public static String getVersionFromZip() {\n+        try {\n+            try (InputStream is = Files\n+                    .newInputStream(locateCurrentKernelUnpackDir().resolve(\"conf\").resolve(\"nucleus.properties\"))) {\n+                NUCLEUS_PROPERTIES.load(is);\n+            }\n+\n+            String version = NUCLEUS_PROPERTIES.getProperty(\"nucleus.version\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f44cd62c4f01bc30b12ce73004b3c53bb652b32"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg4ODAxNw==", "bodyText": "We should give an error any time we fall back to returning constant version (again, magic string inline of code, we need to avoid doing this) so, here - log the error (and it is an error). At the \"return \"2.0.0\" - log at least a warning - with more information why we went down that path.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r537888017", "createdAt": "2020-12-07T22:40:21Z", "author": {"login": "JamieHunter"}, "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -463,6 +467,47 @@ private Topics getTopics(String parameterName) {\n                         CONFIGURATION_CONFIG_KEY, parameterName);\n     }\n \n+    /**\n+     * Get the nucleus version from the running configuration or nucleus zip.\n+     *\n+     * @return nucleus version\n+     */\n+    public String getNucleusVersion() {\n+        String version = null;\n+        // Prefer to get the version from the active config\n+        Topics componentTopic = kernel.findServiceTopic(getNucleusComponentName());\n+        if (componentTopic != null && componentTopic.find(VERSION_CONFIG_KEY) != null) {\n+            version = Coerce.toString(componentTopic.find(VERSION_CONFIG_KEY));\n+        }\n+        if (version == null) {\n+            return getVersionFromZip();\n+        } else {\n+            return version;\n+        }\n+    }\n+\n+    /**\n+     * Get the Nucleus version from the ZIP file.\n+     *\n+     * @return version from the zip file, or a default if the version can't be determined\n+     */\n+    public static String getVersionFromZip() {\n+        try {\n+            try (InputStream is = Files\n+                    .newInputStream(locateCurrentKernelUnpackDir().resolve(\"conf\").resolve(\"nucleus.properties\"))) {\n+                NUCLEUS_PROPERTIES.load(is);\n+            }\n+\n+            String version = NUCLEUS_PROPERTIES.getProperty(\"nucleus.version\");\n+            if (version != null) {\n+                return version;\n+            }\n+        } catch (IOException | URISyntaxException e) {\n+            logger.atWarn().log(\"Unable to determine Greengrass version\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f44cd62c4f01bc30b12ce73004b3c53bb652b32"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NjAxMjg3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-546601287", "createdAt": "2020-12-07T22:44:07Z", "commit": {"oid": "0f44cd62c4f01bc30b12ce73004b3c53bb652b32"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f44cd62c4f01bc30b12ce73004b3c53bb652b32", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0f44cd62c4f01bc30b12ce73004b3c53bb652b32", "committedDate": "2020-12-07T21:37:36Z", "message": "Get Nucleus version from property file included in zip"}, "afterCommit": {"oid": "a13980ba6bcb8b76218edc07d252b47360a6ca3c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a13980ba6bcb8b76218edc07d252b47360a6ca3c", "committedDate": "2020-12-07T22:49:59Z", "message": "PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a13980ba6bcb8b76218edc07d252b47360a6ca3c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a13980ba6bcb8b76218edc07d252b47360a6ca3c", "committedDate": "2020-12-07T22:49:59Z", "message": "PR comments"}, "afterCommit": {"oid": "0c1c4c90f9ba0889e53989287ec7e0dd04b57044", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0c1c4c90f9ba0889e53989287ec7e0dd04b57044", "committedDate": "2020-12-07T22:56:57Z", "message": "PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2Njk2MjE2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-546696216", "createdAt": "2020-12-08T02:24:42Z", "commit": {"oid": "2dde12ea30c3346499dfa534a0f14bb1430f37d2"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDQ3OTYx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-547447961", "createdAt": "2020-12-08T17:11:26Z", "commit": {"oid": "493f5da6ec6b4d61fdf49a7a8c64cd25c3310a89"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNzoxMToyNlrOIBqhoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNzoxMjozOVrOIBqmxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYxNjIyNA==", "bodyText": "Shouldn't this be the default version constant? If we change it, this test will break.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r538616224", "createdAt": "2020-12-08T17:11:26Z", "author": {"login": "JamieHunter"}, "path": "src/test/java/com/aws/greengrass/tes/TokenExchangeServiceTest.java", "diffHunk": "@@ -107,7 +106,7 @@ void setup() {\n         when(kernel.getConfig()).thenReturn(configuration);\n         Topics servicesTopics = Topics.of(context, SERVICES_NAMESPACE_TOPIC, null);\n         Topic componentTypeTopic = Topic.of(context, SERVICE_TYPE_TOPIC_KEY, ComponentType.NUCLEUS.name());\n-        Topic componentVersionTopic = Topic.of(context, VERSION_CONFIG_KEY, KernelVersion.KERNEL_VERSION);\n+        Topic componentVersionTopic = Topic.of(context, VERSION_CONFIG_KEY, \"2.0.0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "493f5da6ec6b4d61fdf49a7a8c64cd25c3310a89"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYxNzU0Mg==", "bodyText": "Feels iffy to me...", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r538617542", "createdAt": "2020-12-08T17:12:39Z", "author": {"login": "JamieHunter"}, "path": "src/test/java/com/aws/greengrass/testcommons/testutilities/ExceptionLogProtector.java", "diffHunk": "@@ -122,6 +122,7 @@ public void beforeEach(ExtensionContext context) throws Exception {\n         // Ignore error from MQTT during shutdown\n         ignoreExceptionUltimateCauseWithMessageSubstring(context, \"MQTT operation interrupted by connection shutdown\");\n         ignoreExceptionUltimateCauseWithMessageSubstring(context, \"Connection has started destroying process\");\n+        ignoreExceptionUltimateCauseWithMessage(context, \"Unable to locate the unpack directory of Kernel Jar file\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "493f5da6ec6b4d61fdf49a7a8c64cd25c3310a89"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDU3NDQz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-547457443", "createdAt": "2020-12-08T17:22:03Z", "commit": {"oid": "493f5da6ec6b4d61fdf49a7a8c64cd25c3310a89"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDgyNjg2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-547482686", "createdAt": "2020-12-08T17:52:03Z", "commit": {"oid": "875f527690076da3cd813c4630175fba7b93364a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNzo1MjowM1rOIBtMrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNzo1MjowM1rOIBtMrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY2MDAxMw==", "bodyText": "Do we need to add some comments on how this is being used?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r538660013", "createdAt": "2020-12-08T17:52:03Z", "author": {"login": "fengwang666"}, "path": "conf/nucleus-build.properties", "diffHunk": "@@ -0,0 +1,6 @@\n+#\n+# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+# SPDX-License-Identifier: Apache-2.0\n+#\n+\n+nucleus.version=2.0.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "875f527690076da3cd813c4630175fba7b93364a"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDkwNjUx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-547490651", "createdAt": "2020-12-08T18:01:35Z", "commit": {"oid": "875f527690076da3cd813c4630175fba7b93364a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODowMTozNVrOIBt0ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODowMTozNVrOIBt0ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY3MDE4MQ==", "bodyText": "Given that the version in the property file is not the preferred value and the real version can be overwritten by the version in the config (which I assume is from the nucleus recipe), is it correct to show the version in the property file here?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r538670181", "createdAt": "2020-12-08T18:01:35Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/easysetup/GreengrassSetup.java", "diffHunk": "@@ -255,7 +254,10 @@ void performSetup() throws IOException, DeviceConfigurationException, URISyntaxE\n             return;\n         }\n         if (showVersion) {\n-            outStream.println(String.format(SHOW_VERSION_RESPONSE, KERNEL_VERSION));\n+            // Use getVersionFromBuildMetadataFile so that we don't need to startup the kernel which is slow and will\n+            // start creating files and directories which may not be desired\n+            outStream.println(String.format(SHOW_VERSION_RESPONSE,\n+                    DeviceConfiguration.getVersionFromBuildMetadataFile()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "875f527690076da3cd813c4630175fba7b93364a"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDk0MzU2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-547494356", "createdAt": "2020-12-08T18:06:15Z", "commit": {"oid": "875f527690076da3cd813c4630175fba7b93364a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODowNjoxNVrOIBuGTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODowNjoxNVrOIBuGTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY3NDc2Nw==", "bodyText": "Is falling back to 2.0.0 desirable? I feel it can be even more dangerous. Let's say customers are running on 2.1.0, for some reason, the property file is deleted, now suddenly the device think the nucleus is 2.0.0, which can cause a lot of surprises.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#discussion_r538674767", "createdAt": "2020-12-08T18:06:15Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/deployment/DeviceConfiguration.java", "diffHunk": "@@ -463,6 +471,50 @@ private Topics getTopics(String parameterName) {\n                         CONFIGURATION_CONFIG_KEY, parameterName);\n     }\n \n+    /**\n+     * Get the nucleus version from the running configuration or nucleus zip.\n+     *\n+     * @return nucleus version\n+     */\n+    public String getNucleusVersion() {\n+        String version = null;\n+        // Prefer to get the version from the active config\n+        Topics componentTopic = kernel.findServiceTopic(getNucleusComponentName());\n+        if (componentTopic != null && componentTopic.find(VERSION_CONFIG_KEY) != null) {\n+            version = Coerce.toString(componentTopic.find(VERSION_CONFIG_KEY));\n+        }\n+        if (version == null) {\n+            return getVersionFromBuildMetadataFile();\n+        } else {\n+            return version;\n+        }\n+    }\n+\n+    /**\n+     * Get the Nucleus version from the ZIP file.\n+     *\n+     * @return version from the zip file, or a default if the version can't be determined\n+     */\n+    public static String getVersionFromBuildMetadataFile() {\n+        try {\n+            try (InputStream is = Files\n+                    .newInputStream(locateCurrentKernelUnpackDir().resolve(NUCLEUS_BUILD_METADATA_DIRECTORY)\n+                            .resolve(NUCLEUS_BUILD_METADATA_FILENAME))) {\n+                NUCLEUS_BUILD_PROPERTIES.load(is);\n+            }\n+\n+            String version = NUCLEUS_BUILD_PROPERTIES.getProperty(NUCLEUS_VERSION_BUILD_METADATA_KEY);\n+            if (version != null) {\n+                return version;\n+            }\n+        } catch (IOException | URISyntaxException e) {\n+            logger.atError().log(\"Unable to determine Greengrass version\", e);\n+        }\n+        logger.atError().log(\"Unable to determine Greengrass version from build metadata file. \"\n+                        + \"Build file not found, or version not found in file. Falling back to {}\", FALLBACK_VERSION);\n+        return FALLBACK_VERSION;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "875f527690076da3cd813c4630175fba7b93364a"}, "originalPosition": 116}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3003102b66c3623d4a60beb116731ae031f3eb3d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3003102b66c3623d4a60beb116731ae031f3eb3d", "committedDate": "2020-12-08T18:14:23Z", "message": "Get Nucleus version from property file included in zip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b85874f8be2e1b27cbbe1bd9b0eb7b7953be8ac", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1b85874f8be2e1b27cbbe1bd9b0eb7b7953be8ac", "committedDate": "2020-12-08T18:14:23Z", "message": "Install CLI version equal to Nucleus version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9b36ee00cb74b79d2dc600c4816ce19a2558538", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f9b36ee00cb74b79d2dc600c4816ce19a2558538", "committedDate": "2020-12-08T18:14:24Z", "message": "PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86abb14afd67bdadca573adaf4fe99881b27208b", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/86abb14afd67bdadca573adaf4fe99881b27208b", "committedDate": "2020-12-08T18:14:24Z", "message": "Remove GCS publish step"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "513cba76536934e2f6c17860e40ce916f1f5a2f1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/513cba76536934e2f6c17860e40ce916f1f5a2f1", "committedDate": "2020-12-08T18:14:24Z", "message": "Rename nucleus.properties to nucleus-build.properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52c03137042e4da96f19db5c28436da4a5e6f8f2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/52c03137042e4da96f19db5c28436da4a5e6f8f2", "committedDate": "2020-12-08T18:14:25Z", "message": "Add 3p license file, remove some stuff from our jar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28a66c262d505fae29ed3056ce7489092093f8dd", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/28a66c262d505fae29ed3056ce7489092093f8dd", "committedDate": "2020-12-08T18:28:04Z", "message": "Remove publish to EG bucket"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02ca9495bd8fd20f48bb64ea345bbf5d2bd6e495", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/02ca9495bd8fd20f48bb64ea345bbf5d2bd6e495", "committedDate": "2020-12-08T20:32:58Z", "message": "PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "875f527690076da3cd813c4630175fba7b93364a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/875f527690076da3cd813c4630175fba7b93364a", "committedDate": "2020-12-08T17:28:40Z", "message": "Merge branch 'master' into version-file"}, "afterCommit": {"oid": "02ca9495bd8fd20f48bb64ea345bbf5d2bd6e495", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/02ca9495bd8fd20f48bb64ea345bbf5d2bd6e495", "committedDate": "2020-12-08T20:32:58Z", "message": "PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjIwMzU3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-547620357", "createdAt": "2020-12-08T20:51:35Z", "commit": {"oid": "02ca9495bd8fd20f48bb64ea345bbf5d2bd6e495"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjQ0Mjcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-547644273", "createdAt": "2020-12-08T21:24:43Z", "commit": {"oid": "02ca9495bd8fd20f48bb64ea345bbf5d2bd6e495"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjgwMTk4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/761#pullrequestreview-547680198", "createdAt": "2020-12-08T22:18:28Z", "commit": {"oid": "02ca9495bd8fd20f48bb64ea345bbf5d2bd6e495"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2543, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}