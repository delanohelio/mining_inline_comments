{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNzgzMDU3", "number": 532, "title": "Fix periodic FSS integ test.", "bodyText": "Issue #, if available:\nDescription of changes:\nWhy is this change necessary:\nSince FSS adds an initial jitter when doing cadence based FSS data update, it is possible the first FSS data update won't have all the components informationl.\nHow was this change tested:\nInteg test passes.\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-15T03:54:21Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532", "merged": true, "mergeCommit": {"oid": "1a208db5b9f2fa13dbd610721f98a8e47c4bf6f4"}, "closed": true, "closedAt": "2020-10-15T17:49:15Z", "author": {"login": "nikkhilmuthye"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSpinDgH2gAyNTAzNzgzMDU3Ojk1YjY2M2ExOGQyOWQzNjBkZjNlYzRmODM5ZjFkMzU3ODI1NTJkYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS1bPuAFqTUwOTYyMTQ2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "95b663a18d29d360df3ec4f839f1d35782552dae", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/95b663a18d29d360df3ec4f839f1d35782552dae", "committedDate": "2020-10-15T03:51:47Z", "message": "Fix periodic FSS integ test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4OTE5OTMw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#pullrequestreview-508919930", "createdAt": "2020-10-15T03:57:20Z", "commit": {"oid": "95b663a18d29d360df3ec4f839f1d35782552dae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMzo1NzoyMFrOHhv5cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMzo1NzoyMFrOHhv5cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE0OTgxMQ==", "bodyText": "Does this test need to be so long? This will slow everyone down. Can you increase the publish interval for testing like we've done for deployment polling?\nBy decreasing the deployment polling from 15 seconds to 1 second our e2e tests cut in more than half from over 20 minutes to around 12.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505149811", "createdAt": "2020-10-15T03:57:20Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -105,37 +101,30 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch fssPublishLatch = new CountDownLatch(1);\n-        logListener = eslm -> {\n-            if (eslm.getEventType() != null && eslm.getEventType().equals(\"fss-status-update-published\")\n-                    && eslm.getMessage().equals(\"Status update published to FSS\")) {\n-                fssPublishLatch.countDown();\n-            }\n-        };\n-        Slf4jLogAdapter.addGlobalListener(logListener);\n \n-        assertTrue(fssPublishLatch.await(40, TimeUnit.SECONDS));\n+        // Sleep for more time than the FSS publish interval so that we have all the data.\n+        TimeUnit.SECONDS.sleep(50);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95b663a18d29d360df3ec4f839f1d35782552dae"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/63442d4017dab23c41b492d5a9aa7b2c27d1cbca", "committedDate": "2020-10-15T04:15:57Z", "message": "Don't sleep for a long time. Add logic to see the MQTT message sent."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4OTI2MzIy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#pullrequestreview-508926322", "createdAt": "2020-10-15T04:21:29Z", "commit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMToyOVrOHhwNzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMToyOVrOHhwNzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1NTAyMg==", "bodyText": "you're undoing your previous commit with this change\nhttps://github.com/aws/aws-greengrass-kernel/pull/529/files#diff-7289cfb6dadb15e34f5e9e655b451e930d7d48c2d18e035c5e7f26faa8061eb7L9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505155022", "createdAt": "2020-10-15T04:21:29Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/resources/com/aws/greengrass/integrationtests/status/smallPeriodicIntervalConfig.yaml", "diffHunk": "@@ -6,4 +6,4 @@ services:\n         all: echo All installed\n   FleetStatusService:\n     parameters:\n-      periodicUpdateIntervalSec: 30\n+      periodicUpdateIntervalSec: 10", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4OTI2OTA3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#pullrequestreview-508926907", "createdAt": "2020-10-15T04:23:31Z", "commit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMzozMVrOHhwPww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMzozMVrOHhwPww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1NTUyMw==", "bodyText": "return CompletableFuture.completeFuture(0) so the future has completed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505155523", "createdAt": "2020-10-15T04:23:31Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -105,37 +100,41 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch fssPublishLatch = new CountDownLatch(1);\n-        logListener = eslm -> {\n-            if (eslm.getEventType() != null && eslm.getEventType().equals(\"fss-status-update-published\")\n-                    && eslm.getMessage().equals(\"Status update published to FSS\")) {\n-                fssPublishLatch.countDown();\n+        CountDownLatch allComponentsInFssUpdate = new CountDownLatch(1);\n+\n+        when(mqttClient.publish(captor.capture())).thenAnswer(i -> {\n+            Object argument = i.getArgument(0);\n+            PublishRequest publishRequest = (PublishRequest) argument;\n+            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n+                    FleetStatusDetails.class);\n+            if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n+                allComponentsInFssUpdate.countDown();\n             }\n-        };\n-        Slf4jLogAdapter.addGlobalListener(logListener);\n+            return new CompletableFuture<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4OTI2OTMx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#pullrequestreview-508926931", "createdAt": "2020-10-15T04:23:36Z", "commit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMzozN1rOHhwP3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMzozN1rOHhwP3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1NTU1MQ==", "bodyText": "Nice!", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505155551", "createdAt": "2020-10-15T04:23:37Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -105,37 +100,41 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch fssPublishLatch = new CountDownLatch(1);\n-        logListener = eslm -> {\n-            if (eslm.getEventType() != null && eslm.getEventType().equals(\"fss-status-update-published\")\n-                    && eslm.getMessage().equals(\"Status update published to FSS\")) {\n-                fssPublishLatch.countDown();\n+        CountDownLatch allComponentsInFssUpdate = new CountDownLatch(1);\n+\n+        when(mqttClient.publish(captor.capture())).thenAnswer(i -> {\n+            Object argument = i.getArgument(0);\n+            PublishRequest publishRequest = (PublishRequest) argument;\n+            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n+                    FleetStatusDetails.class);\n+            if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n+                allComponentsInFssUpdate.countDown();\n             }\n-        };\n-        Slf4jLogAdapter.addGlobalListener(logListener);\n+            return new CompletableFuture<>();\n+        });\n \n-        assertTrue(fssPublishLatch.await(40, TimeUnit.SECONDS));\n-        verify(mqttClient, atLeastOnce()).publish(captor.capture());\n+        // Wait for some time for the publish request to have all the components update.\n+        assertTrue(allComponentsInFssUpdate.await(20, TimeUnit.SECONDS));\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0911de8677a17019edeace38465b54aa0e652650", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0911de8677a17019edeace38465b54aa0e652650", "committedDate": "2020-10-15T04:31:50Z", "message": "Address PR comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "290542d096a27126cea508b807464ad9d257d969", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/290542d096a27126cea508b807464ad9d257d969", "committedDate": "2020-10-15T15:21:31Z", "message": "Merge branch 'master' into fixFlakyFssIntegTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NDk5MzA1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#pullrequestreview-509499305", "createdAt": "2020-10-15T15:21:45Z", "commit": {"oid": "290542d096a27126cea508b807464ad9d257d969"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NjIxNDY0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#pullrequestreview-509621464", "createdAt": "2020-10-15T17:42:36Z", "commit": {"oid": "290542d096a27126cea508b807464ad9d257d969"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3162, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}