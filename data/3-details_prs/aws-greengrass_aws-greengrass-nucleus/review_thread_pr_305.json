{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NjAzNzk2", "number": 305, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMTo0Njo0MlrOEQYfcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNTowMjowMlrOERsmyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NjEzOTM5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/KernelUpdateDeploymentTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMTo0Njo0MlrOG0gaFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMTo0Njo0MlrOG0gaFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMDEwMA==", "bodyText": "why subtype for type DeploymentStage?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r457710100", "createdAt": "2020-07-20T21:46:42Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/KernelUpdateDeploymentTask.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment;\n+\n+import com.aws.iot.evergreen.deployment.exceptions.ServiceUpdateException;\n+import com.aws.iot.evergreen.deployment.model.BaseDeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.Deployment;\n+import com.aws.iot.evergreen.deployment.model.DeploymentResult;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import lombok.AllArgsConstructor;\n+\n+import static com.aws.iot.evergreen.deployment.model.Deployment.DeploymentStage.KERNEL_ACTIVATION;\n+import static com.aws.iot.evergreen.deployment.model.Deployment.DeploymentStage.KERNEL_ROLLBACK;\n+\n+@AllArgsConstructor\n+public class KernelUpdateDeploymentTask implements BaseDeploymentTask {\n+    private Kernel kernel;\n+    private final Logger logger;\n+    private Deployment deployment;\n+\n+    @Override\n+    public DeploymentResult call() {\n+        Deployment.DeploymentStage subtype = deployment.getDeploymentStage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f20c237cd26eeaa3544dccb238570de10ff194cb"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NjE1MzkxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/BaseDeploymentTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMTo1MTozN1rOG0ginw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwMDoxMjo0N1rOG1OLMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMjI4Nw==", "bodyText": "naming - BaseXXX implies inheritance. For polymorphism, I'd name the interface as \"DeploymentTask\" directly and have different \"DeploymentTask\" such as \"UpdateKernelDeploymentTask\" vs \"ComponentDeploymentTask\".", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r457712287", "createdAt": "2020-07-20T21:51:37Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/BaseDeploymentTask.java", "diffHunk": "@@ -0,0 +1,16 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment.model;\n+\n+import com.aws.iot.evergreen.deployment.exceptions.NonRetryableDeploymentTaskFailureException;\n+import com.aws.iot.evergreen.deployment.exceptions.RetryableDeploymentTaskFailureException;\n+\n+import java.util.concurrent.Callable;\n+\n+public interface BaseDeploymentTask extends Callable<DeploymentResult> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f20c237cd26eeaa3544dccb238570de10ff194cb"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1OTk1Mg==", "bodyText": "What about DeploymentTaskI? I tried to avoid unnecessary renaming of DeploymentTask in use", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r458459952", "createdAt": "2020-07-22T00:12:47Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/BaseDeploymentTask.java", "diffHunk": "@@ -0,0 +1,16 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.deployment.model;\n+\n+import com.aws.iot.evergreen.deployment.exceptions.NonRetryableDeploymentTaskFailureException;\n+import com.aws.iot.evergreen.deployment.exceptions.RetryableDeploymentTaskFailureException;\n+\n+import java.util.concurrent.Callable;\n+\n+public interface BaseDeploymentTask extends Callable<DeploymentResult> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMjI4Nw=="}, "originalCommit": {"oid": "f20c237cd26eeaa3544dccb238570de10ff194cb"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NjE2MDQ5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMTo1NDoxMFrOG0gmpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMTo1NDoxMFrOG0gmpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcxMzMxOQ==", "bodyText": "Some comments to indicate the reason for each stage?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r457713319", "createdAt": "2020-07-20T21:54:10Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "diffHunk": "@@ -45,9 +50,31 @@ public Deployment(DeploymentType deploymentType, String id, boolean isCancelled)\n         this.deploymentType = deploymentType;\n         this.id = id;\n         this.isCancelled = isCancelled;\n+        this.deploymentStage = DeploymentStage.DEFAULT;\n+    }\n+\n+    /**\n+     * Constructor for resuming deployments after Kernel restarts.\n+     *\n+     * @param deploymentDetails deployment document object\n+     * @param deploymentType deployment type\n+     * @param id deployment id\n+     * @param deploymentStage deployment stage, only applicable to deployments which require Kernel restart\n+     */\n+    public Deployment(DeploymentDocument deploymentDetails, DeploymentType deploymentType, String id,\n+                      DeploymentStage deploymentStage) {\n+        this.deploymentDocumentObj = deploymentDetails;\n+        this.deploymentType = deploymentType;\n+        this.id = id;\n+        this.deploymentStage = deploymentStage;\n     }\n \n     public enum DeploymentType {\n         IOT_JOBS, LOCAL\n     }\n+\n+    public enum DeploymentStage {\n+        DEFAULT, BOOTSTRAP, KERNEL_ACTIVATION, KERNEL_ROLLBACK", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f20c237cd26eeaa3544dccb238570de10ff194cb"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2OTYxNDAwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMToxNjozMFrOG2gkfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxOToxNzoyM1rOG268rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwOTkxNw==", "bodyText": "If the task isn't performed yet (eg in the wait for safe to update stage), will this disallow cancelling such tasks?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r459809917", "createdAt": "2020-07-24T01:16:30Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -281,11 +283,13 @@ private void finishCurrentDeployment() throws InterruptedException {\n     @SuppressWarnings(\"PMD.NullAssignment\")\n     private void cancelCurrentDeployment() {\n         if (currentDeploymentTaskMetadata.getDeploymentResultFuture() != null) {\n-            if (currentDeploymentTaskMetadata.getDeploymentResultFuture().isDone()) {\n-                logger.atInfo().log(\"Deployment already finished processing, cannot cancel now\");\n+            if (currentDeploymentTaskMetadata.getDeploymentResultFuture().isDone()\n+                    || !currentDeploymentTaskMetadata.isCancellable()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c784db32487cf45eaa1ebc5ba635328be45ad40"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0MjA5NQ==", "bodyText": "It is not allowed to cancel this task, because at this stage, bootstrap has finished and configuration has been merged, meaning it passed safe-update checked. Similar to default deployment, we also don't allow cancellation after config merge.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r460242095", "createdAt": "2020-07-24T19:17:23Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -281,11 +283,13 @@ private void finishCurrentDeployment() throws InterruptedException {\n     @SuppressWarnings(\"PMD.NullAssignment\")\n     private void cancelCurrentDeployment() {\n         if (currentDeploymentTaskMetadata.getDeploymentResultFuture() != null) {\n-            if (currentDeploymentTaskMetadata.getDeploymentResultFuture().isDone()) {\n-                logger.atInfo().log(\"Deployment already finished processing, cannot cancel now\");\n+            if (currentDeploymentTaskMetadata.getDeploymentResultFuture().isDone()\n+                    || !currentDeploymentTaskMetadata.isCancellable()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwOTkxNw=="}, "originalCommit": {"oid": "7c784db32487cf45eaa1ebc5ba635328be45ad40"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2OTkyMDc0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNTowMjowMlrOG2jMPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxOToxODoyNlrOG26-bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg1Mjg2Mw==", "bodyText": "Having both Obj and string looks confusing to me", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r459852863", "createdAt": "2020-07-24T05:02:02Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "diffHunk": "@@ -7,18 +7,22 @@\n \n import lombok.EqualsAndHashCode;\n import lombok.Getter;\n+import lombok.Setter;\n import lombok.ToString;\n \n @Getter\n @EqualsAndHashCode(onlyExplicitlyIncluded = true)\n @ToString\n public class Deployment {\n+    @Setter\n+    private DeploymentDocument deploymentDocumentObj;\n     private String deploymentDocument;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c784db32487cf45eaa1ebc5ba635328be45ad40"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0MjU0Mg==", "bodyText": "Agree. One option may be extending Deployment class. I can try to refactor in the next iteration.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/305#discussion_r460242542", "createdAt": "2020-07-24T19:18:26Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/Deployment.java", "diffHunk": "@@ -7,18 +7,22 @@\n \n import lombok.EqualsAndHashCode;\n import lombok.Getter;\n+import lombok.Setter;\n import lombok.ToString;\n \n @Getter\n @EqualsAndHashCode(onlyExplicitlyIncluded = true)\n @ToString\n public class Deployment {\n+    @Setter\n+    private DeploymentDocument deploymentDocumentObj;\n     private String deploymentDocument;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg1Mjg2Mw=="}, "originalCommit": {"oid": "7c784db32487cf45eaa1ebc5ba635328be45ad40"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4398, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}