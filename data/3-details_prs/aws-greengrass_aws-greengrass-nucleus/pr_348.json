{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNDU5MzAw", "number": 348, "title": "deflake DeploymentConfigMergingTest", "bodyText": "Issue #, if available:\nGIVEN_kernel_running_services_WHEN_merge_removes_service_THEN_removed_service_is_closed is flaky\nDescription of changes:\nrunOnPublishQueueAndWait will not wait if its is run on the publish Thread. Hence updateMap will run in parallel to other deployment actions like restart services/remove services and cause race conditions when remove service is called before the dependencies are updated.\nModified updateActionForDeployment to run on a thread other than the publish thread to ensure that all config update and their listeners trigger before deployment action like restart service/remove services are executed.\nHow was this change tested:\nRan the tests locally in a loop.\nChecklist:\n\n Updated or added new unit tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-08-04T00:21:18Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348", "merged": true, "mergeCommit": {"oid": "7390cf6518954f29c6bb1dd22f96a104189ff3d6"}, "closed": true, "closedAt": "2020-08-04T23:09:21Z", "author": {"login": "fahadmohammed01"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7bQKJAH2gAyNDYyNDU5MzAwOmI2MDJmMDZmMzA5YWU4MGNhODFlY2NjN2U1ZDYyMWExZGNjODBlZDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7u7sfgFqTQ2MTIzNTY3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b602f06f309ae80ca81eccc7e5d621a1dcc80ed6", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b602f06f309ae80ca81eccc7e5d621a1dcc80ed6", "committedDate": "2020-08-04T00:12:42Z", "message": "deflake DeploymentConfigMergingTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d95727f0e4233d5ad23a642cc31ca4f545d4bd8c", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d95727f0e4233d5ad23a642cc31ca4f545d4bd8c", "committedDate": "2020-08-04T00:20:53Z", "message": "removed outdated comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4502e17f3300d1a84598f93144a2f622e55a3d92", "committedDate": "2020-08-04T00:22:41Z", "message": "Merge branch 'master' into deflake-tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDIwNzcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-460420773", "createdAt": "2020-08-04T00:31:38Z", "commit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDozMTozOVrOG7M_Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDozMzozMFrOG7NBMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMTk5OA==", "bodyText": "Why remove this? Isn't this basically the whole point of the test?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464731998", "createdAt": "2020-08-04T00:31:39Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -408,29 +406,13 @@ void GIVEN_kernel_running_services_WHEN_merge_removes_service_THEN_removed_servi\n         lifecycle.put(LIFECYCLE_RUN_NAMESPACE_TOPIC,\n                 ((String) lifecycle.get(LIFECYCLE_RUN_NAMESPACE_TOPIC)).replace(\"5\", \"10\"));\n \n+        Future<DeploymentResult> deploymentFuture = deploymentConfigMerger.mergeInNewConfig(testDeploymentDocument(), currentConfig);\n \n-        deploymentConfigMerger.mergeInNewConfig(testDeploymentDocument(), currentConfig);\n-        AtomicBoolean isSleeperAClosed = new AtomicBoolean(false);\n-        CountDownLatch mainRestarted = new CountDownLatch(1);\n-        kernel.getContext().addGlobalStateChangeListener((service, oldState, newState) -> {\n-            if (\"sleeperA\".equals(service.getName()) && newState.isClosable()) {\n-                isSleeperAClosed.set(true);\n-            }\n-            if(isSleeperAClosed.get() && \"main\".equals(service.getName()) && newState.equals(State.RUNNING)){\n-                mainRestarted.countDown();\n-            }\n-        });\n-\n-        // wait for merge to complete\n-        //TODO: wait on the future returned by mergeInNewConfig. mainRestarted is required due to race condition\n-        // mentioned in DeploymentConfigMergerL120 is fixed.\n-        mainRestarted.await(30, TimeUnit.SECONDS);\n+        deploymentFuture.get(30, TimeUnit.SECONDS);\n         EvergreenService main = kernel.locate(\"main\");\n         assertEquals(State.RUNNING, main.getState());\n         EvergreenService sleeperB = kernel.locate(\"sleeperB\");\n         assertEquals(State.RUNNING, sleeperB.getState());\n-        //sleeperA should be closed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMjI5NA==", "bodyText": "Should the fix be to move that off of the publish thread?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464732294", "createdAt": "2020-08-04T00:32:45Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -64,9 +65,14 @@\n         CompletableFuture<DeploymentResult> totallyCompleteFuture = new CompletableFuture<>();\n \n         if (DeploymentSafetyPolicy.CHECK_SAFETY.equals(deploymentDocument.getDeploymentSafetyPolicy())) {\n-            kernel.getContext().get(UpdateSystemSafelyService.class)\n-                    .addUpdateAction(deploymentDocument.getDeploymentId(),\n-                            () -> updateActionForDeployment(newConfig, deploymentDocument, totallyCompleteFuture));\n+            UpdateSystemSafelyService updateService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            // running updateActionForDeployment in a separate thread so runOnPublishQueueAndWait would wait.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMjQ2Ng==", "bodyText": "Interesting find. What is the result of not having this change?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464732466", "createdAt": "2020-08-04T00:33:30Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -316,8 +316,12 @@ public void disruptionCompleted() {\n     @SuppressWarnings(\"PMD.AvoidCatchingGenericException\")\n     public final CompletableFuture<Void> close() {\n         CompletableFuture<Void> closeFuture = new CompletableFuture<>();\n+\n         context.get(Executor.class).execute(() -> {\n             logger.atInfo(\"service-close\").log(\"Service is now closing\");\n+            // removing listeners on dependencies\n+            dependencies.forEach((service, dependencyInfo) ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53731edcee9a988c57d3f8adaa976c964744985f", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/53731edcee9a988c57d3f8adaa976c964744985f", "committedDate": "2020-08-04T01:22:24Z", "message": "updated tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDM4MTQz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-460438143", "createdAt": "2020-08-04T01:32:26Z", "commit": {"oid": "53731edcee9a988c57d3f8adaa976c964744985f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTAyMjgz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-460502283", "createdAt": "2020-08-04T05:18:53Z", "commit": {"oid": "53731edcee9a988c57d3f8adaa976c964744985f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNToxODo1NFrOG7RdNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNToxODo1NFrOG7RdNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgwNTE3NQ==", "bodyText": "Will this still work as expected https://github.com/aws/aws-greengrass-kernel/blob/master/src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java#L80 ? I'm not sure how important this is though, i.e. whether we need to notify services that they can resume normal work", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464805175", "createdAt": "2020-08-04T05:18:54Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -64,9 +65,14 @@\n         CompletableFuture<DeploymentResult> totallyCompleteFuture = new CompletableFuture<>();\n \n         if (DeploymentSafetyPolicy.CHECK_SAFETY.equals(deploymentDocument.getDeploymentSafetyPolicy())) {\n-            kernel.getContext().get(UpdateSystemSafelyService.class)\n-                    .addUpdateAction(deploymentDocument.getDeploymentId(),\n-                            () -> updateActionForDeployment(newConfig, deploymentDocument, totallyCompleteFuture));\n+            UpdateSystemSafelyService updateService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            // running updateActionForDeployment in a separate thread so runOnPublishQueueAndWait would wait.\n+            // addUpdateAction is run on publish queue thread and when executing on publish queue thread\n+            // runOnPublishQueueAndWait does not wait.\n+            updateService.addUpdateAction(deploymentDocument.getDeploymentId(), () ->\n+                    kernel.getContext().get(Executor.class).execute(() ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53731edcee9a988c57d3f8adaa976c964744985f"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "392f8a8ce564a787ed83e40167229423b24ec430", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/392f8a8ce564a787ed83e40167229423b24ec430", "committedDate": "2020-08-04T17:15:24Z", "message": "Merge branch 'master' into deflake-tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDQ3NTQ3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-461047547", "createdAt": "2020-08-04T18:03:59Z", "commit": {"oid": "392f8a8ce564a787ed83e40167229423b24ec430"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e7c04475fd50f1c48d3c90795f95de07fdc64c31", "committedDate": "2020-08-04T20:36:21Z", "message": "update to run update action on executor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTU1NjE2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-461155616", "createdAt": "2020-08-04T20:38:25Z", "commit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDozODoyNVrOG7wpPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDozOToxMVrOG7wqvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjE1OQ==", "bodyText": "why not assertEquals? I've never used same, though I'd assume they're the same.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465316159", "createdAt": "2020-08-04T20:38:25Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -471,10 +472,13 @@ void GIVEN_a_running_service_is_not_disruptable_WHEN_deployed_THEN_deployment_wa\n                     \"Merge should not happen within 2 seconds\");\n             assertTrue(unsafeToUpdate.get(), \"Service should have been checked if it is safe to update immediately\");\n             assertFalse(safeToUpdate.get(), \"Service should not yet be safe to update\");\n+            assertSame(sawUpdatesCompleted.getCount(), 1l,\n+                    \"Service should not call update done yet\");\n \n-            future.get(20, TimeUnit.SECONDS);\n+            sawUpdatesCompleted.await(30, TimeUnit.SECONDS);\n             assertTrue(safeToUpdate.get(), \"Service should have been rechecked and be safe to update\");\n-            assertTrue(sawUpdatesCompleted.get(), \"Service should have been called when the update was done\");\n+            assertSame(sawUpdatesCompleted.getCount(), 0l,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjI3MA==", "bodyText": "you can just assert true here instead of on L480", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465316270", "createdAt": "2020-08-04T20:38:38Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -471,10 +472,13 @@ void GIVEN_a_running_service_is_not_disruptable_WHEN_deployed_THEN_deployment_wa\n                     \"Merge should not happen within 2 seconds\");\n             assertTrue(unsafeToUpdate.get(), \"Service should have been checked if it is safe to update immediately\");\n             assertFalse(safeToUpdate.get(), \"Service should not yet be safe to update\");\n+            assertSame(sawUpdatesCompleted.getCount(), 1l,\n+                    \"Service should not call update done yet\");\n \n-            future.get(20, TimeUnit.SECONDS);\n+            sawUpdatesCompleted.await(30, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjU0Mw==", "bodyText": "this doesn't log anything. You need to have .log()", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465316543", "createdAt": "2020-08-04T20:39:11Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -139,11 +141,15 @@ protected void startup() throws InterruptedException {\n                 Thread.sleep(maxt - now);\n             } else {\n                 logger.atDebug().setEventType(\"service-update-scheduled\").log();\n-                context.runOnPublishQueueAndWait(() -> {\n-                    logger.atInfo().setEventType(\"service-update-start\").log();\n-                    runUpdateActions();\n-                    logger.atInfo().setEventType(\"service-update-finish\").log();\n-                });\n+                try {\n+                    kernel.getContext().get(ExecutorService.class).submit(() -> {\n+                        logger.atInfo().setEventType(\"service-update-start\").log();\n+                        runUpdateActions();\n+                        logger.atInfo().setEventType(\"service-update-finish\").log();\n+                    }).get();\n+                } catch (InterruptedException | ExecutionException e) {\n+                    logger.atError(\"Run update actions was interrupted\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04358bc8a593e42bb5822065525fa426f75d715c", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/04358bc8a593e42bb5822065525fa426f75d715c", "committedDate": "2020-08-04T20:51:09Z", "message": "addressed comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0fb8ed09b97df5e034fd80602a8f2ff44127bd7", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c0fb8ed09b97df5e034fd80602a8f2ff44127bd7", "committedDate": "2020-08-04T21:04:25Z", "message": "fixed pmd issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTc0NTMz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-461174533", "createdAt": "2020-08-04T21:05:46Z", "commit": {"oid": "c0fb8ed09b97df5e034fd80602a8f2ff44127bd7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTowNTo0NlrOG7xfoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTowNTo0NlrOG7xfoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzMDA4MQ==", "bodyText": "[nit]\nJust use context instead of kernel.getContext()", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465330081", "createdAt": "2020-08-04T21:05:46Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -139,11 +141,16 @@ protected void startup() throws InterruptedException {\n                 Thread.sleep(maxt - now);\n             } else {\n                 logger.atDebug().setEventType(\"service-update-scheduled\").log();\n-                context.runOnPublishQueueAndWait(() -> {\n-                    logger.atInfo().setEventType(\"service-update-start\").log();\n-                    runUpdateActions();\n-                    logger.atInfo().setEventType(\"service-update-finish\").log();\n-                });\n+                try {\n+                    kernel.getContext().get(ExecutorService.class).submit(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0fb8ed09b97df5e034fd80602a8f2ff44127bd7"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTc0NTc4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-461174578", "createdAt": "2020-08-04T21:05:52Z", "commit": {"oid": "c0fb8ed09b97df5e034fd80602a8f2ff44127bd7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTgzNTA0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-461183504", "createdAt": "2020-08-04T21:20:56Z", "commit": {"oid": "c0fb8ed09b97df5e034fd80602a8f2ff44127bd7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTk1NzE2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-461195716", "createdAt": "2020-08-04T21:43:34Z", "commit": {"oid": "c0fb8ed09b97df5e034fd80602a8f2ff44127bd7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTo0MzozNFrOG7yjCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTo0MzozNFrOG7yjCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0NzMzNw==", "bodyText": "don't catch the interruption, let it bubble up because it means that we need to stop", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465347337", "createdAt": "2020-08-04T21:43:34Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -139,11 +141,16 @@ protected void startup() throws InterruptedException {\n                 Thread.sleep(maxt - now);\n             } else {\n                 logger.atDebug().setEventType(\"service-update-scheduled\").log();\n-                context.runOnPublishQueueAndWait(() -> {\n-                    logger.atInfo().setEventType(\"service-update-start\").log();\n-                    runUpdateActions();\n-                    logger.atInfo().setEventType(\"service-update-finish\").log();\n-                });\n+                try {\n+                    kernel.getContext().get(ExecutorService.class).submit(() -> {\n+                        logger.atInfo().setEventType(\"service-update-start\").log();\n+                        runUpdateActions();\n+                        logger.atInfo().setEventType(\"service-update-finish\").log();\n+                    }).get();\n+                } catch (InterruptedException | ExecutionException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0fb8ed09b97df5e034fd80602a8f2ff44127bd7"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "803f733cb86ecfa5571643b5b9fc2a3610d3b89f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/803f733cb86ecfa5571643b5b9fc2a3610d3b89f", "committedDate": "2020-08-04T21:57:12Z", "message": "Update UpdateSystemSafelyService.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67aee3f9cb6c1cc00a560706caba68f561b2d458", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/67aee3f9cb6c1cc00a560706caba68f561b2d458", "committedDate": "2020-08-04T22:02:44Z", "message": "throw Interrupted  exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMjM1NjAz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-461235603", "createdAt": "2020-08-04T23:08:15Z", "commit": {"oid": "67aee3f9cb6c1cc00a560706caba68f561b2d458"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMjM1Njcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#pullrequestreview-461235673", "createdAt": "2020-08-04T23:08:27Z", "commit": {"oid": "67aee3f9cb6c1cc00a560706caba68f561b2d458"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2984, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}