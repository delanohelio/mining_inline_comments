{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNTgzNjg2", "number": 527, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDowOToxN1rOEtpNNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTo1MToxNlrOEtrQDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2Mjk2NTAwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDowOToxN1rOHhjQmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDowOToxN1rOHhjQmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk0Mjc0NA==", "bodyText": "missing space in log message", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504942744", "createdAt": "2020-10-14T20:09:17Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -149,6 +149,10 @@ public long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentAr\n             return length;\n         } catch (IOException e) {\n             throw new PackageDownloadException(\"Failed to get download size\", e);\n+        } catch (PackageDownloadException e) {\n+            logger.atWarn(\"get-download-size-from-greengrass-repo\").log(\"failed getting size.\"\n+                    + \"continuing assuming size is 0\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8776020e8a37fedf49280b784322bd8bef1b40e5"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MzA5MTAzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/ArtifactDownloader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDo0Njo0MVrOHhkcJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDo0Njo0MVrOHhkcJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2MjA4NQ==", "bodyText": "this isn't getting the size?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504962085", "createdAt": "2020-10-14T20:46:41Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/ArtifactDownloader.java", "diffHunk": "@@ -144,13 +144,26 @@ public abstract File downloadToPath(ComponentIdentifier componentIdentifier, Com\n      *\n      * @param componentIdentifier package info\n      * @param artifact artifact info\n-     * @param saveToPath path of directory where the artifact is expected to exist\n+     * @param artifactDir path of directory where the artifact is expected to exist\n      * @return size of the artifact in bytes\n      * @throws InvalidArtifactUriException if provided info results in invalid URI\n      * @throws PackageDownloadException if error encountered\n      */\n     public abstract long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentArtifact artifact,\n-                                         Path saveToPath)\n+                                         Path artifactDir)\n             throws InvalidArtifactUriException, PackageDownloadException;\n+\n+    /**\n+     * Get the download size of an artifact file.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13ed7028ba0cd23eea89ae97cb907cb9fe455dbd"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MzIzMTM1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTozMTowN1rOHhlxVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTozMTowN1rOHhlxVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4Mzg5Mw==", "bodyText": "add a space before %d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504983893", "createdAt": "2020-10-14T21:31:07Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -349,36 +349,36 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n                                 usableSpaceBytes, DEFAULT_MIN_DISK_AVAIL_BYTES));\n             }\n             ArtifactDownloader downloader = selectArtifactDownloader(artifact.getArtifactUri());\n-            if (!downloader.downloadRequired(componentIdentifier, artifact, packageArtifactDirectory)) {\n-                continue;\n-            }\n-            long downloadSize = downloader.getDownloadSize(componentIdentifier, artifact, packageArtifactDirectory);\n-            long storeContentSize = componentStore.getContentSize();\n-            if (storeContentSize + downloadSize > DEFAULT_MAX_STORE_SIZE_BYTES) {\n-                throw new SizeLimitException(String.format(\n-                        \"Component store size limit reached: %d bytes existing, %d bytes needed,\"\n-                                + \"%d bytes maximum allowed total\", storeContentSize, downloadSize,\n-                        DEFAULT_MAX_STORE_SIZE_BYTES));\n-            }\n \n-            File downloadedFile;\n-            try {\n-                downloadedFile = downloader.downloadToPath(componentIdentifier, artifact, packageArtifactDirectory);\n-            } catch (IOException e) {\n-                throw new PackageDownloadException(\n-                        String.format(\"Failed to download package %s artifact %s\", componentIdentifier, artifact), e);\n+            if (downloader.downloadRequired(componentIdentifier, artifact, packageArtifactDirectory)) {\n+                long downloadSize = downloader.getDownloadSize(componentIdentifier, artifact, packageArtifactDirectory);\n+                long storeContentSize = componentStore.getContentSize();\n+                if (storeContentSize + downloadSize > DEFAULT_MAX_STORE_SIZE_BYTES) {\n+                    throw new SizeLimitException(String.format(\n+                            \"Component store size limit reached: %d bytes existing, %d bytes needed,\"\n+                                    + \"%d bytes maximum allowed total\", storeContentSize, downloadSize,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93a55625364fd92f72c62d38f7698dc97f14aac8"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MzI5OTk2OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/componentmanager/ComponentManagerIntegTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTo1MToxNlrOHhmclA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTo1MToxNlrOHhmclA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5NDk2NA==", "bodyText": "change this back", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504994964", "createdAt": "2020-10-14T21:51:16Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/componentmanager/ComponentManagerIntegTest.java", "diffHunk": "@@ -72,7 +73,7 @@ void GIVEN_component_with_archived_artifact_WHEN_prepareArtifacts_THEN_unarchive\n         kernel.getContext()\n               .get(ComponentManager.class)\n               .preparePackages(Collections.singletonList(ident))\n-              .get(10, TimeUnit.SECONDS);\n+              .get(1000000, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a52e62318fc480bb3076f53bfd078baa931d4cc"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 675, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}