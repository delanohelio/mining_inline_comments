{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3OTQyNDkz", "number": 643, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoxMToyOVrOE2498g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1Mzo0NVrOE299gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1OTkxOTIyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoxMToyOVrOHv7T9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOToxMjowNVrOHv9vQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjg4Nw==", "bodyText": "can't you just use Exec.sh here?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520016887", "createdAt": "2020-11-09T18:11:29Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java", "diffHunk": "@@ -324,6 +325,21 @@ public UnixRunWithGenerator getRunWithGenerator() {\n         return runWithGenerator;\n     }\n \n+    @Override\n+    public void createUser(String user) throws IOException, InterruptedException {\n+        runCmd(\"useradd -r -m \" + user, o -> {}, \"Failed to create user\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1NjY0MQ==", "bodyText": "It does use exec, created this method to keep the error handling common logic for whenever I have to use exec", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520056641", "createdAt": "2020-11-09T19:12:05Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java", "diffHunk": "@@ -324,6 +325,21 @@ public UnixRunWithGenerator getRunWithGenerator() {\n         return runWithGenerator;\n     }\n \n+    @Override\n+    public void createUser(String user) throws IOException, InterruptedException {\n+        runCmd(\"useradd -r -m \" + user, o -> {}, \"Failed to create user\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjg4Nw=="}, "originalCommit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1OTkyMjkxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/easysetup/GreengrassSetup.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoxMjoyNlrOHv7WMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOToxMjozOFrOHv9xHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNzQ1Nw==", "bodyText": "you can combine this into one if statement, or immediately return if not the super user instead of having nested ifs", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520017457", "createdAt": "2020-11-09T18:12:26Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/easysetup/GreengrassSetup.java", "diffHunk": "@@ -393,31 +344,66 @@ private String getArg() {\n     void provision(Kernel kernel) throws IOException, DeviceConfigurationException {\n         outStream.printf(\"Provisioning AWS IoT resources for the device with IoT Thing Name: [%s]...%n\", thingName);\n         final ThingInfo thingInfo =\n-                deviceProvisioningHelper.createThing(deviceProvisioningHelper.getIotClient(), policyName, thingName);\n+                deviceProvisioningHelper.createThing(deviceProvisioningHelper.getIotClient(), thingName);\n         outStream.printf(\"Successfully provisioned AWS IoT resources for the device with IoT Thing Name: [%s]!%n\",\n                 thingName);\n         if (!Utils.isEmpty(thingGroupName)) {\n             outStream.printf(\"Adding IoT Thing [%s] into Thing Group: [%s]...%n\", thingName, thingGroupName);\n-                deviceProvisioningHelper.addThingToGroup(deviceProvisioningHelper.getIotClient(), thingName,\n-                        thingGroupName);\n+            deviceProvisioningHelper\n+                    .addThingToGroup(deviceProvisioningHelper.getIotClient(), thingName, thingGroupName);\n             outStream.printf(\"Successfully added Thing into Thing Group: [%s]%n\", thingGroupName);\n         }\n-\n-        // TODO: [P41215965]: setupTes should not be an arg anymore since role alias is required, need to remove\n-        //  this arg and always pass either user specified or a default role alias\n-        if (setupTes) {\n-            outStream.println(\"Setting up resources for TokenExchangeService...\");\n-            deviceProvisioningHelper.setupIoTRoleForTes(tesRoleName, tesRoleAliasName, thingInfo.getCertificateArn());\n-            if (tesRolePolicyName != null && tesRolePolicyDoc != null) {\n-                deviceProvisioningHelper.createAndAttachRolePolicy(tesRoleName, tesRolePolicyName, tesRolePolicyDoc);\n-            }\n-        }\n-        outStream.println(\"Configuring kernel with provisioned resource details...\");\n+        outStream.printf(\"Setting up resources for %s ... %n\", TokenExchangeService.TOKEN_EXCHANGE_SERVICE_TOPICS);\n+        deviceProvisioningHelper.setupIoTRoleForTes(tesRoleName, tesRoleAliasName, thingInfo.getCertificateArn());\n+        deviceProvisioningHelper.createAndAttachRolePolicy(tesRoleName);\n+        outStream.println(\"Configuring Nucleus with provisioned resource details...\");\n         deviceProvisioningHelper.updateKernelConfigWithIotConfiguration(kernel, thingInfo, awsRegion, tesRoleAliasName);\n         outStream.println(\"Successfully configured kernel with provisioned resource details!\");\n+        if (deployDevTools) {\n+            deviceProvisioningHelper.createInitialDeploymentIfNeeded(thingInfo, thingGroupName);\n+        }\n \n     }\n \n+    @SuppressWarnings(\"PMD.PreserveStackTrace\")\n+    private void setComponentDefaultUserAndGroup() {\n+        try {\n+            Platform platform = Platform.getInstance();\n+            // If not super user and default user option is not provided, the current user will be used\n+            // as the default user so we do not need to create anything here\n+            if (platform.lookupCurrentUser().isSuperUser()) {\n+                if (Utils.isEmpty(defaultUser) || GGC_USER.equals(defaultUser)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "originalPosition": 315}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1NzExNw==", "bodyText": "Combined the ifs", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520057117", "createdAt": "2020-11-09T19:12:38Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/easysetup/GreengrassSetup.java", "diffHunk": "@@ -393,31 +344,66 @@ private String getArg() {\n     void provision(Kernel kernel) throws IOException, DeviceConfigurationException {\n         outStream.printf(\"Provisioning AWS IoT resources for the device with IoT Thing Name: [%s]...%n\", thingName);\n         final ThingInfo thingInfo =\n-                deviceProvisioningHelper.createThing(deviceProvisioningHelper.getIotClient(), policyName, thingName);\n+                deviceProvisioningHelper.createThing(deviceProvisioningHelper.getIotClient(), thingName);\n         outStream.printf(\"Successfully provisioned AWS IoT resources for the device with IoT Thing Name: [%s]!%n\",\n                 thingName);\n         if (!Utils.isEmpty(thingGroupName)) {\n             outStream.printf(\"Adding IoT Thing [%s] into Thing Group: [%s]...%n\", thingName, thingGroupName);\n-                deviceProvisioningHelper.addThingToGroup(deviceProvisioningHelper.getIotClient(), thingName,\n-                        thingGroupName);\n+            deviceProvisioningHelper\n+                    .addThingToGroup(deviceProvisioningHelper.getIotClient(), thingName, thingGroupName);\n             outStream.printf(\"Successfully added Thing into Thing Group: [%s]%n\", thingGroupName);\n         }\n-\n-        // TODO: [P41215965]: setupTes should not be an arg anymore since role alias is required, need to remove\n-        //  this arg and always pass either user specified or a default role alias\n-        if (setupTes) {\n-            outStream.println(\"Setting up resources for TokenExchangeService...\");\n-            deviceProvisioningHelper.setupIoTRoleForTes(tesRoleName, tesRoleAliasName, thingInfo.getCertificateArn());\n-            if (tesRolePolicyName != null && tesRolePolicyDoc != null) {\n-                deviceProvisioningHelper.createAndAttachRolePolicy(tesRoleName, tesRolePolicyName, tesRolePolicyDoc);\n-            }\n-        }\n-        outStream.println(\"Configuring kernel with provisioned resource details...\");\n+        outStream.printf(\"Setting up resources for %s ... %n\", TokenExchangeService.TOKEN_EXCHANGE_SERVICE_TOPICS);\n+        deviceProvisioningHelper.setupIoTRoleForTes(tesRoleName, tesRoleAliasName, thingInfo.getCertificateArn());\n+        deviceProvisioningHelper.createAndAttachRolePolicy(tesRoleName);\n+        outStream.println(\"Configuring Nucleus with provisioned resource details...\");\n         deviceProvisioningHelper.updateKernelConfigWithIotConfiguration(kernel, thingInfo, awsRegion, tesRoleAliasName);\n         outStream.println(\"Successfully configured kernel with provisioned resource details!\");\n+        if (deployDevTools) {\n+            deviceProvisioningHelper.createInitialDeploymentIfNeeded(thingInfo, thingGroupName);\n+        }\n \n     }\n \n+    @SuppressWarnings(\"PMD.PreserveStackTrace\")\n+    private void setComponentDefaultUserAndGroup() {\n+        try {\n+            Platform platform = Platform.getInstance();\n+            // If not super user and default user option is not provided, the current user will be used\n+            // as the default user so we do not need to create anything here\n+            if (platform.lookupCurrentUser().isSuperUser()) {\n+                if (Utils.isEmpty(defaultUser) || GGC_USER.equals(defaultUser)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNzQ1Nw=="}, "originalCommit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "originalPosition": 315}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1OTkyOTg0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/util/platforms/unix/DarwinPlatform.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxODoxNDoyOVrOHv7akw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOToxMjoxM1rOHv9vtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxODU3OQ==", "bodyText": "can't you just use Exec.sh here?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520018579", "createdAt": "2020-11-09T18:14:29Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/util/platforms/unix/DarwinPlatform.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util.platforms.unix;\n+\n+import java.io.IOException;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class DarwinPlatform extends UnixPlatform {\n+    private static String CREATE_USER_CMD_PREFIX = \"sudo dscl . -create /Users/\";\n+    private static String AVAILABLE_UNIQUE_ID_CMD =\n+            \"dscl . -list /Users UniqueID | awk '{print $2}' | sort -ug | tail -1\";\n+    private static String CREATE_GROUP_CMD_PREFIX = \"sudo dscl . -create /Groups/\";\n+    private static String AVAILABLE_GID_CMD = \"dscl . -list /Groups gid | awk '{print $2}' | sort -ug | tail -1\";\n+    private static String ADD_USER_TO_GROUP_CMD_PREFIX = \"sudo dscl . -append /Groups/\";\n+\n+    @Override\n+    public void createUser(String user) throws IOException, InterruptedException {\n+        AtomicLong uniqueUid = new AtomicLong();\n+        runCmd(AVAILABLE_UNIQUE_ID_CMD, o -> {\n+            uniqueUid.set(Long.parseLong(o.toString().replaceAll(\"\\\\n\", \"\")) + 1L);\n+        }, \"Cannot get a unique id for creating user\");\n+        runCmd(CREATE_USER_CMD_PREFIX + user, o -> {}, \"Failed to create user\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1Njc1OA==", "bodyText": "Same as above", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520056758", "createdAt": "2020-11-09T19:12:13Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/util/platforms/unix/DarwinPlatform.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util.platforms.unix;\n+\n+import java.io.IOException;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public class DarwinPlatform extends UnixPlatform {\n+    private static String CREATE_USER_CMD_PREFIX = \"sudo dscl . -create /Users/\";\n+    private static String AVAILABLE_UNIQUE_ID_CMD =\n+            \"dscl . -list /Users UniqueID | awk '{print $2}' | sort -ug | tail -1\";\n+    private static String CREATE_GROUP_CMD_PREFIX = \"sudo dscl . -create /Groups/\";\n+    private static String AVAILABLE_GID_CMD = \"dscl . -list /Groups gid | awk '{print $2}' | sort -ug | tail -1\";\n+    private static String ADD_USER_TO_GROUP_CMD_PREFIX = \"sudo dscl . -append /Groups/\";\n+\n+    @Override\n+    public void createUser(String user) throws IOException, InterruptedException {\n+        AtomicLong uniqueUid = new AtomicLong();\n+        runCmd(AVAILABLE_UNIQUE_ID_CMD, o -> {\n+            uniqueUid.set(Long.parseLong(o.toString().replaceAll(\"\\\\n\", \"\")) + 1L);\n+        }, \"Cannot get a unique id for creating user\");\n+        runCmd(CREATE_USER_CMD_PREFIX + user, o -> {}, \"Failed to create user\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxODU3OQ=="}, "originalCommit": {"oid": "44ef77988dd44c9ef4c32882f9b8aca130ed463b"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MDczNzMwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMTo1Mzo0NVrOHwDGWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMzoyNjowM1rOHwFnIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDQ3NA==", "bodyText": "swap the arguments here then - your message should come first, not the command.\nI think you would actually be better off doing something like:\nlogger.atError()\n.kv(\"stdout\", output)\n.kv(\"stderr\", err)\n.kv(\"command\", cmdStr)\n.log(\"Error running command\")\nthrow new IOException(msg);\n\nAlso, should you catch IOException too - Runtime.getRuntime().exec() will throw IOException if an error occurs - if it does your message gets lost", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520144474", "createdAt": "2020-11-09T21:53:45Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java", "diffHunk": "@@ -397,6 +413,27 @@ public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IO\n         }\n     }\n \n+    protected void runCmd(String cmdStr, Consumer<CharSequence> out, String msg)\n+            throws IOException, InterruptedException {\n+        try (Exec exec = new Exec()) {\n+            StringBuilder output = new StringBuilder();\n+            StringBuilder error = new StringBuilder();\n+            Optional<Integer> exit = exec.withExec(cmdStr.split(\" \"))\n+                    .withShell()\n+                    .withOut(o -> {\n+                        out.accept(o);\n+                        output.append(o);\n+                    }).withErr(e -> {\n+                        error.append(e);\n+                    }).exec();\n+            if (!exit.isPresent() || exit.get() != 0) {\n+                throw new IOException(String.format(\n+                        String.format(\"%s - command: %s, output: %s , error: %s \", cmdStr, msg, output.toString(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02a0a5cf10c2dd1fdbd69897027569ea3d94d7e9"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NTYzMg==", "bodyText": "Updated the sequence and catching the .exec() exceptions, although still including all details in the exception message instead of logging because the actual error in running the command is more important to include in the setup script output than the hardcoded message strings", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/643#discussion_r520185632", "createdAt": "2020-11-09T23:26:03Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java", "diffHunk": "@@ -397,6 +413,27 @@ public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IO\n         }\n     }\n \n+    protected void runCmd(String cmdStr, Consumer<CharSequence> out, String msg)\n+            throws IOException, InterruptedException {\n+        try (Exec exec = new Exec()) {\n+            StringBuilder output = new StringBuilder();\n+            StringBuilder error = new StringBuilder();\n+            Optional<Integer> exit = exec.withExec(cmdStr.split(\" \"))\n+                    .withShell()\n+                    .withOut(o -> {\n+                        out.accept(o);\n+                        output.append(o);\n+                    }).withErr(e -> {\n+                        error.append(e);\n+                    }).exec();\n+            if (!exit.isPresent() || exit.get() != 0) {\n+                throw new IOException(String.format(\n+                        String.format(\"%s - command: %s, output: %s , error: %s \", cmdStr, msg, output.toString(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0NDQ3NA=="}, "originalCommit": {"oid": "02a0a5cf10c2dd1fdbd69897027569ea3d94d7e9"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 188, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}