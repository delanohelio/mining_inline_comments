{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTQ2MjYx", "number": 125, "title": "Fix the race condition of setting the root.; Refactor kernel test; Clean up old performance reporting", "bodyText": "Issue #, if available:\nDescription of changes:\n\nFix the race condition of setting the root.\nA important note here:\n\nI think I finally \"unlocked\" the full power of Topic::subscribe by doing:\nlookup(\"system\", \"rootpath\").dflt(rootAbsolutePath)\n    .subscribe((whatHappened, topic) -> initPaths((String) topic.getOnce()));\nSince subscribe invokes the listener logic on the same thread for the first time. So this way, the initPaths logic remains at one place, clean, and consistent.\n\nUse LogListener to replace log file watcher. Removed all file related logic.\nExpected => ExpectedStdoutPattern.\nRename tests to GIVEN WHEN THEN style.\nOther cleanups here and there.\n\nWhy is this change necessary:\nSo that everyone can read and upgrade KernelTest.\nHow was this change tested:\nmvn verify\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-03-19T17:44:00Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125", "merged": true, "mergeCommit": {"oid": "c060125d208c5b741a49ab2deda07a83ed750feb"}, "closed": true, "closedAt": "2020-03-20T22:32:29Z", "author": {"login": "leaf94"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPHF89gH2gAyMzkxMTQ2MjYxOjFhYTU1MjliYjY2ZjQ0MzBiN2VkOTdjOWE3YmYxZjZhODQ1ZDA0ZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPoOtegFqTM3ODg0NDYxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1aa5529bb66f4430b7ed97c9a7bf1f6a845d04df", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1aa5529bb66f4430b7ed97c9a7bf1f6a845d04df", "committedDate": "2020-03-19T07:50:47Z", "message": "Refactor KernelTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b48391f64778912c90f9f3ce8158b4c19002d50b", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b48391f64778912c90f9f3ce8158b4c19002d50b", "committedDate": "2020-03-19T17:43:26Z", "message": "rename to src/it"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTYwMTUy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#pullrequestreview-377960152", "createdAt": "2020-03-19T17:52:24Z", "commit": {"oid": "b48391f64778912c90f9f3ce8158b4c19002d50b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzo1MjoyNFrOF4575A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzo1MjoyNFrOF4575A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxMzc5Ng==", "bodyText": "Let's get rid of reading from the log file here. Set it to console and refactor the test to use the log watcher capability.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#discussion_r395213796", "createdAt": "2020-03-19T17:52:24Z", "author": {"login": "MikeDombo"}, "path": "src/it/java/com/aws/iot/evergreen/it/kernel/KernelTest.java", "diffHunk": "@@ -22,48 +22,115 @@\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.TimeUnit;\n \n-import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.junit.jupiter.api.Assertions.fail;\n \n @ExtendWith(PerformanceReporting.class)\n class KernelTest extends AbstractBaseITCase {\n-    static final int[] gc = new int[10];\n-    static final CountDownLatch[] OK = new CountDownLatch[10];\n-    private static final Expected[] expectations = {new Expected(0, \"\\\"stdout\\\":\\\"RUNNING\\\"\", \"Main service\"),\n-            //new Expected(\"docs.docker.com/\", \"docker hello world\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"tick-tock\\\"\", \"periodic\", 3),\n-            new Expected(0, \"\\\"stdout\\\":\\\"ANSWER=42\\\"\", \"global setenv\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"EVERGREEN_UID=\", \"generated unique token\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"version: 0.12.1\\\"\", \"moquette mqtt server\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"JUSTME=fancy a spot of tea?\\\"\", \"local setenv in main service\"),\n-            new Expected(1, \"\\\"stdout\\\":\\\"NEWMAIN\\\"\", \"Assignment to 'run' script'\"),\n-            new Expected(2, \"\\\"stdout\\\":\\\"JUSTME=fancy a spot of coffee?\\\"\", \"merge yaml\"),\n-            new Expected(2, \"\\\"stdout\\\":\\\"I'm Frodo\\\"\", \"merge adding dependency\")};\n     private static final String LOG_FILE_NAME = \"KernelTest.log\";\n     private static final String LOG_FILE_PATH_NAME = tempRootDir.resolve(LOG_FILE_NAME).toAbsolutePath().toString();\n \n-    static {\n-        for (int i = gc.length; --i >= 0; ) {\n-            OK[i] = new CountDownLatch(gc[i]);\n-        }\n-    }\n+\n+    private static final ExpectedMessage[] EXPECTED_MESSAGES = {new ExpectedMessage(0, \"MAIN IS RUNNING\", \"Main service\"),\n+            //new ExpectedMessage(\"docs.docker.com/\", \"docker hello world\"),\n+            new ExpectedMessage(0, \"tick-tock\", \"periodic\", 3), new ExpectedMessage(0, \"ANSWER=42\", \"global setenv\"),\n+            new ExpectedMessage(0, \"EVERGREEN_UID=\", \"generated unique token\"),\n+            new ExpectedMessage(0, \"version: 0.12.1\", \"moquette mqtt server\"),\n+            new ExpectedMessage(0, \"JUSTME=fancy a spot of tea?\", \"local setenv in main service\"),\n+            new ExpectedMessage(1, \"NEWMAIN\", \"Assignment to 'run' script'\"),\n+            new ExpectedMessage(2, \"JUSTME=fancy a spot of coffee?\", \"merge yaml\"),\n+            new ExpectedMessage(2, \"I'm Frodo\", \"merge adding dependency\")};\n+\n+    private static final CountDownLatch[] COUNT_DOWN_LATCHES =\n+            {new CountDownLatch(6), new CountDownLatch(1), new CountDownLatch(2)};\n \n     @BeforeAll\n     static void beforeAll() {\n         // TODO Refactor with Log Listener\n         // override log store to a file for legacy kernel test to verify logs\n-        System.setProperty(\"log.fmt\", \"JSON\");\n         System.setProperty(\"log.store\", \"FILE\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b48391f64778912c90f9f3ce8158b4c19002d50b"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTYxMzAw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#pullrequestreview-377961300", "createdAt": "2020-03-19T17:53:49Z", "commit": {"oid": "b48391f64778912c90f9f3ce8158b4c19002d50b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzo1Mzo0OVrOF45_dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzo1NToxOFrOF46C-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxNDcwOQ==", "bodyText": "Combine these strings.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#discussion_r395214709", "createdAt": "2020-03-19T17:53:49Z", "author": {"login": "MikeDombo"}, "path": "src/it/java/com/aws/iot/evergreen/it/kernel/KernelTest.java", "diffHunk": "@@ -22,48 +22,115 @@\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.TimeUnit;\n \n-import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.junit.jupiter.api.Assertions.fail;\n \n @ExtendWith(PerformanceReporting.class)\n class KernelTest extends AbstractBaseITCase {\n-    static final int[] gc = new int[10];\n-    static final CountDownLatch[] OK = new CountDownLatch[10];\n-    private static final Expected[] expectations = {new Expected(0, \"\\\"stdout\\\":\\\"RUNNING\\\"\", \"Main service\"),\n-            //new Expected(\"docs.docker.com/\", \"docker hello world\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"tick-tock\\\"\", \"periodic\", 3),\n-            new Expected(0, \"\\\"stdout\\\":\\\"ANSWER=42\\\"\", \"global setenv\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"EVERGREEN_UID=\", \"generated unique token\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"version: 0.12.1\\\"\", \"moquette mqtt server\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"JUSTME=fancy a spot of tea?\\\"\", \"local setenv in main service\"),\n-            new Expected(1, \"\\\"stdout\\\":\\\"NEWMAIN\\\"\", \"Assignment to 'run' script'\"),\n-            new Expected(2, \"\\\"stdout\\\":\\\"JUSTME=fancy a spot of coffee?\\\"\", \"merge yaml\"),\n-            new Expected(2, \"\\\"stdout\\\":\\\"I'm Frodo\\\"\", \"merge adding dependency\")};\n     private static final String LOG_FILE_NAME = \"KernelTest.log\";\n     private static final String LOG_FILE_PATH_NAME = tempRootDir.resolve(LOG_FILE_NAME).toAbsolutePath().toString();\n \n-    static {\n-        for (int i = gc.length; --i >= 0; ) {\n-            OK[i] = new CountDownLatch(gc[i]);\n-        }\n-    }\n+\n+    private static final ExpectedMessage[] EXPECTED_MESSAGES = {new ExpectedMessage(0, \"MAIN IS RUNNING\", \"Main service\"),\n+            //new ExpectedMessage(\"docs.docker.com/\", \"docker hello world\"),\n+            new ExpectedMessage(0, \"tick-tock\", \"periodic\", 3), new ExpectedMessage(0, \"ANSWER=42\", \"global setenv\"),\n+            new ExpectedMessage(0, \"EVERGREEN_UID=\", \"generated unique token\"),\n+            new ExpectedMessage(0, \"version: 0.12.1\", \"moquette mqtt server\"),\n+            new ExpectedMessage(0, \"JUSTME=fancy a spot of tea?\", \"local setenv in main service\"),\n+            new ExpectedMessage(1, \"NEWMAIN\", \"Assignment to 'run' script'\"),\n+            new ExpectedMessage(2, \"JUSTME=fancy a spot of coffee?\", \"merge yaml\"),\n+            new ExpectedMessage(2, \"I'm Frodo\", \"merge adding dependency\")};\n+\n+    private static final CountDownLatch[] COUNT_DOWN_LATCHES =\n+            {new CountDownLatch(6), new CountDownLatch(1), new CountDownLatch(2)};\n \n     @BeforeAll\n     static void beforeAll() {\n         // TODO Refactor with Log Listener\n         // override log store to a file for legacy kernel test to verify logs\n-        System.setProperty(\"log.fmt\", \"JSON\");\n         System.setProperty(\"log.store\", \"FILE\");\n         System.setProperty(\"log.level\", \"INFO\");\n         System.setProperty(\"log.storeName\", LOG_FILE_PATH_NAME);\n         System.out.println(\"Storing log to: \" + LOG_FILE_PATH_NAME);\n     }\n \n     @Test\n-    void testErrorRetry() throws InterruptedException {\n+    void GIVEN_the_ultimate_config_WHEN_kernel_starts_THEN_services_starts_with_env_set() throws Exception {\n+\n+        // start logWatcher with a separate thread\n+        new Thread(getLogWatcher()).start();\n+\n+        // launch kernel\n         Kernel kernel = new Kernel();\n-        kernel.parseArgs(\"-i\", getClass().getResource(\"config_broken.yaml\").toString());\n+        kernel.parseArgs(\"-i\", this.getClass().getResource(\"config.yaml\").toString());\n+        kernel.launch();\n+\n+        testGroup(0);\n+        System.out.println(\"Group 0 passed, now for the harder stuff\");\n+\n+        kernel.find(\"services\", \"main\", \"lifecycle\", \"run\")\n+                .setValue(\"while true; do\\n\" + \"        date; sleep 5; echo NEWMAIN\\n\" + \"     \" + \"   done\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b48391f64778912c90f9f3ce8158b4c19002d50b"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxNTYxMQ==", "bodyText": "Why are we removing this stuff? I thought it was used in our assertions?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#discussion_r395215611", "createdAt": "2020-03-19T17:55:18Z", "author": {"login": "MikeDombo"}, "path": "src/it/resources/com/aws/iot/evergreen/it/kernel/config_broken.yaml", "diffHunk": "@@ -26,18 +26,10 @@ services:\n       install:\n         all: echo All installed\n       run: |-\n-        echo $PATH\n-        pwd\n-        printenv\n-        echo RUNNING\n+        echo main of config_broken is running\n         while true; do\n         date; sleep 5;\n         done\n-      download:\n-        hw.jar: http://foo/hw.jar\n     dependencies:\n       - installErrorRetry\n-      - runErrorRetry\n-    setenv:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b48391f64778912c90f9f3ce8158b4c19002d50b"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efe9617781170b71425f1de4463fd7adb8b33b1c", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/efe9617781170b71425f1de4463fd7adb8b33b1c", "committedDate": "2020-03-19T18:31:34Z", "message": "further rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65ed577466d56a990343b6d225db397e777270c3", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/65ed577466d56a990343b6d225db397e777270c3", "committedDate": "2020-03-19T19:00:23Z", "message": "Finally changed to use log listener. KernelTest gets simplified a lot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2592419ec199a8e00780181d2c17ac8f25a08cbd", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2592419ec199a8e00780181d2c17ac8f25a08cbd", "committedDate": "2020-03-19T19:17:59Z", "message": "Reverse renaming directory to review the diff for KernelTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b53dfebbbe5dd5a9726c2eaea0cb9e650fb2b88a", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b53dfebbbe5dd5a9726c2eaea0cb9e650fb2b88a", "committedDate": "2020-03-19T19:20:13Z", "message": "done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "252e644e26b5620c22f825c01e258584124412a3", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/252e644e26b5620c22f825c01e258584124412a3", "committedDate": "2020-03-19T19:21:58Z", "message": "done"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MDI2MDEx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#pullrequestreview-378026011", "createdAt": "2020-03-19T19:23:56Z", "commit": {"oid": "252e644e26b5620c22f825c01e258584124412a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b160244f56f491e6c393aa447582e20958890492", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b160244f56f491e6c393aa447582e20958890492", "committedDate": "2020-03-19T22:11:03Z", "message": "done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be040f30de0de9b45b54da69d8ddc259711fc74f", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/be040f30de0de9b45b54da69d8ddc259711fc74f", "committedDate": "2020-03-19T22:55:27Z", "message": "Clean up initial PerformanceReporting extention"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05804f4332b2b319d6c1f73d077f0b9947b85946", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/05804f4332b2b319d6c1f73d077f0b9947b85946", "committedDate": "2020-03-19T23:01:31Z", "message": "done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1509ba289f5e33f68b17ae5d438abb8ebbcbdcd", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e1509ba289f5e33f68b17ae5d438abb8ebbcbdcd", "committedDate": "2020-03-19T23:04:04Z", "message": "minor changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e1ee2a439a14c9ac285c2757d5d33a4b9d41599", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e1ee2a439a14c9ac285c2757d5d33a4b9d41599", "committedDate": "2020-03-19T23:23:18Z", "message": "Merge branch 'master' into refactor_kernel_test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3965b8d3e3405ef32e1f5fe0e7a1592e30d4e96b", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3965b8d3e3405ef32e1f5fe0e7a1592e30d4e96b", "committedDate": "2020-03-19T23:28:14Z", "message": "merge amit's pr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a51a90ab9ff2b624e12f4c25fd2bbb4017435d4c", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a51a90ab9ff2b624e12f4c25fd2bbb4017435d4c", "committedDate": "2020-03-19T23:47:18Z", "message": "merge amit's pr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MTY3NTEz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#pullrequestreview-378167513", "createdAt": "2020-03-19T23:49:10Z", "commit": {"oid": "e1509ba289f5e33f68b17ae5d438abb8ebbcbdcd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzo0OToxMFrOF5EHaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQyMzo1MTo0NlrOF5EJ_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MDU4NA==", "bodyText": "should this be inside the test case? same as COUNT_DOWN_LATCHES", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#discussion_r395380584", "createdAt": "2020-03-19T23:49:10Z", "author": {"login": "ShirleyZheng92"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -7,63 +7,104 @@\n import com.aws.iot.evergreen.integrationtests.AbstractBaseITCase;\n import com.aws.iot.evergreen.kernel.EvergreenService;\n import com.aws.iot.evergreen.kernel.Kernel;\n-import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n import com.fasterxml.jackson.jr.ob.JSON;\n-import org.junit.jupiter.api.BeforeAll;\n import org.junit.jupiter.api.Test;\n-import org.junit.jupiter.api.extension.ExtendWith;\n \n-import java.io.File;\n-import java.io.RandomAccessFile;\n import java.util.Arrays;\n import java.util.LinkedList;\n import java.util.Map;\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n \n-import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.junit.jupiter.api.Assertions.fail;\n \n-@ExtendWith(PerformanceReporting.class)\n class KernelTest extends AbstractBaseITCase {\n-    static final int[] gc = new int[10];\n-    static final CountDownLatch[] OK = new CountDownLatch[10];\n-    private static final Expected[] expectations = {new Expected(0, \"\\\"stdout\\\":\\\"RUNNING\\\"\", \"Main service\"),\n-            //new Expected(\"docs.docker.com/\", \"docker hello world\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"tick-tock\\\"\", \"periodic\", 3),\n-            new Expected(0, \"\\\"stdout\\\":\\\"ANSWER=42\\\"\", \"global setenv\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"EVERGREEN_UID=\", \"generated unique token\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"version: 0.12.1\\\"\", \"moquette mqtt server\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"JUSTME=fancy a spot of tea?\\\"\", \"local setenv in main service\"),\n-            new Expected(1, \"\\\"stdout\\\":\\\"NEWMAIN\\\"\", \"Assignment to 'run' script'\"),\n-            new Expected(2, \"\\\"stdout\\\":\\\"JUSTME=fancy a spot of coffee?\\\"\", \"merge yaml\"),\n-            new Expected(2, \"\\\"stdout\\\":\\\"I'm Frodo\\\"\", \"merge adding dependency\")};\n-    private static final String LOG_FILE_NAME = \"KernelTest.log\";\n-    private static final String LOG_FILE_PATH_NAME = tempRootDir.resolve(LOG_FILE_NAME).toAbsolutePath().toString();\n-\n-    static {\n-        for (int i = gc.length; --i >= 0; ) {\n-            OK[i] = new CountDownLatch(gc[i]);\n-        }\n+    private static final ExpectedStdoutPattern[] EXPECTED_MESSAGES =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1509ba289f5e33f68b17ae5d438abb8ebbcbdcd"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM4MTI0Ng==", "bodyText": "Arrow Anti Pattern", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#discussion_r395381246", "createdAt": "2020-03-19T23:51:46Z", "author": {"login": "ShirleyZheng92"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/KernelTest.java", "diffHunk": "@@ -7,63 +7,104 @@\n import com.aws.iot.evergreen.integrationtests.AbstractBaseITCase;\n import com.aws.iot.evergreen.kernel.EvergreenService;\n import com.aws.iot.evergreen.kernel.Kernel;\n-import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n import com.fasterxml.jackson.jr.ob.JSON;\n-import org.junit.jupiter.api.BeforeAll;\n import org.junit.jupiter.api.Test;\n-import org.junit.jupiter.api.extension.ExtendWith;\n \n-import java.io.File;\n-import java.io.RandomAccessFile;\n import java.util.Arrays;\n import java.util.LinkedList;\n import java.util.Map;\n import java.util.concurrent.CountDownLatch;\n import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n \n-import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.junit.jupiter.api.Assertions.fail;\n \n-@ExtendWith(PerformanceReporting.class)\n class KernelTest extends AbstractBaseITCase {\n-    static final int[] gc = new int[10];\n-    static final CountDownLatch[] OK = new CountDownLatch[10];\n-    private static final Expected[] expectations = {new Expected(0, \"\\\"stdout\\\":\\\"RUNNING\\\"\", \"Main service\"),\n-            //new Expected(\"docs.docker.com/\", \"docker hello world\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"tick-tock\\\"\", \"periodic\", 3),\n-            new Expected(0, \"\\\"stdout\\\":\\\"ANSWER=42\\\"\", \"global setenv\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"EVERGREEN_UID=\", \"generated unique token\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"version: 0.12.1\\\"\", \"moquette mqtt server\"),\n-            new Expected(0, \"\\\"stdout\\\":\\\"JUSTME=fancy a spot of tea?\\\"\", \"local setenv in main service\"),\n-            new Expected(1, \"\\\"stdout\\\":\\\"NEWMAIN\\\"\", \"Assignment to 'run' script'\"),\n-            new Expected(2, \"\\\"stdout\\\":\\\"JUSTME=fancy a spot of coffee?\\\"\", \"merge yaml\"),\n-            new Expected(2, \"\\\"stdout\\\":\\\"I'm Frodo\\\"\", \"merge adding dependency\")};\n-    private static final String LOG_FILE_NAME = \"KernelTest.log\";\n-    private static final String LOG_FILE_PATH_NAME = tempRootDir.resolve(LOG_FILE_NAME).toAbsolutePath().toString();\n-\n-    static {\n-        for (int i = gc.length; --i >= 0; ) {\n-            OK[i] = new CountDownLatch(gc[i]);\n-        }\n+    private static final ExpectedStdoutPattern[] EXPECTED_MESSAGES =\n+            {new ExpectedStdoutPattern(0, \"MAIN IS RUNNING\", \"Main service\"),\n+                    //new ExpectedStdoutPattern(\"docs.docker.com/\", \"docker hello world\"),\n+                    new ExpectedStdoutPattern(0, \"tick-tock\", \"periodic\", 3),\n+                    new ExpectedStdoutPattern(0, \"ANSWER=42\", \"global setenv\"),\n+                    new ExpectedStdoutPattern(0, \"EVERGREEN_UID=\", \"generated unique token\"),\n+                    new ExpectedStdoutPattern(0, \"version: 0.12.1\", \"moquette mqtt server\"),\n+                    new ExpectedStdoutPattern(0, \"JUSTME=fancy a spot of tea?\", \"local setenv in main service\"),\n+                    new ExpectedStdoutPattern(1, \"NEWMAIN\", \"Assignment to 'run' script'\"),\n+                    new ExpectedStdoutPattern(2, \"JUSTME=fancy a spot of coffee?\", \"merge yaml\"),\n+                    new ExpectedStdoutPattern(2, \"I'm Frodo\", \"merge adding dependency\")};\n+\n+    private static final CountDownLatch[] COUNT_DOWN_LATCHES =\n+            {new CountDownLatch(6), new CountDownLatch(1), new CountDownLatch(2)};\n+\n+    @Test\n+    void GIVEN_expected_stdout_patterns_WHEN_kernel_launches_THEN_all_expected_patterns_are_seen() throws Exception {\n+\n+        // add log listener to verify stdout pattern\n+        Consumer<EvergreenStructuredLogMessage> logListener = getLogListener();\n+        Log4jLogEventBuilder.addGlobalListener(logListener);\n+\n+        // launch kernel\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", this.getClass().getResource(\"config.yaml\").toString());\n+        kernel.launch();\n+\n+        testGroup(0);\n+        System.out.println(\"Group 0 passed, now for the harder stuff\");\n+\n+        kernel.find(\"services\", \"main\", \"lifecycle\", \"run\")\n+                .setValue(\"while true; do\\ndate; sleep 5; echo NEWMAIN\\ndone\");\n+        testGroup(1);\n+\n+        System.out.println(\"Group 1 passed, now merging delta.yaml\");\n+        kernel.mergeInNewConfig(\"ID\", System.currentTimeMillis(),\n+                (Map<Object, Object>) JSON.std.with(new YAMLFactory()).anyFrom(getClass().getResource(\"delta.yaml\")))\n+                .get(60, TimeUnit.SECONDS);\n+        testGroup(2);\n+        System.out.println(\"Group 2 passed. We made integrationtests.\");\n+\n+        // clean up\n+        Log4jLogEventBuilder.removeGlobalListener(logListener);\n+\n+        kernel.shutdown();\n     }\n \n-    @BeforeAll\n-    static void beforeAll() {\n-        // TODO Refactor with Log Listener\n-        // override log store to a file for legacy kernel test to verify logs\n-        System.setProperty(\"log.fmt\", \"JSON\");\n-        System.setProperty(\"log.store\", \"FILE\");\n-        System.setProperty(\"log.level\", \"INFO\");\n-        System.setProperty(\"log.storeName\", LOG_FILE_PATH_NAME);\n-        System.out.println(\"Storing log to: \" + LOG_FILE_PATH_NAME);\n+    private Consumer<EvergreenStructuredLogMessage> getLogListener() {\n+        return evergreenStructuredLogMessage -> {\n+            String stdoutStr = evergreenStructuredLogMessage.getContexts().get(\"stdout\");\n+\n+            if (stdoutStr != null && stdoutStr.length() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1509ba289f5e33f68b17ae5d438abb8ebbcbdcd"}, "originalPosition": 106}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d126bd5a9735c06d47053cf2a2493a743f06904", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0d126bd5a9735c06d47053cf2a2493a743f06904", "committedDate": "2020-03-20T01:49:30Z", "message": "done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4126c6ccc36bb4a3118052829146336cbed3829b", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4126c6ccc36bb4a3118052829146336cbed3829b", "committedDate": "2020-03-20T02:53:11Z", "message": "done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08baab7ddf5a0c40e835925c684696ddf6ef6155", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/08baab7ddf5a0c40e835925c684696ddf6ef6155", "committedDate": "2020-03-20T03:12:17Z", "message": "change shutdownNow to shutdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e9229317bc48d1f32cc02bbb112d7f0798df66d", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2e9229317bc48d1f32cc02bbb112d7f0798df66d", "committedDate": "2020-03-20T03:28:52Z", "message": "Add sout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acb6f6d498c3e426fe06ea878ffedae82de5a138", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/acb6f6d498c3e426fe06ea878ffedae82de5a138", "committedDate": "2020-03-20T04:22:58Z", "message": "I think I fixed it by initializing paths directly instead of using topic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec7d8ab25c1fbb4c69348891497dd890da7b795a", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ec7d8ab25c1fbb4c69348891497dd890da7b795a", "committedDate": "2020-03-20T16:35:22Z", "message": "Put Jacoco back"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd01d9f11934fd2fc95a2710719c35d788908449", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd01d9f11934fd2fc95a2710719c35d788908449", "committedDate": "2020-03-20T16:51:15Z", "message": "Final cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d6a939cf22e998f5ff1cce26941c419cf38a37d", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4d6a939cf22e998f5ff1cce26941c419cf38a37d", "committedDate": "2020-03-20T17:08:49Z", "message": "remove uploadToCW in CI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NzE3OTA0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#pullrequestreview-378717904", "createdAt": "2020-03-20T18:24:26Z", "commit": {"oid": "4d6a939cf22e998f5ff1cce26941c419cf38a37d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxODoyNDoyNlrOF5eyJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxODoyNDo1N1rOF5ezIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxNzUxMA==", "bodyText": "make this extend the baseit?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#discussion_r395817510", "createdAt": "2020-03-20T18:24:26Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -49,13 +47,12 @@\n import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.junit.jupiter.api.Assertions.fail;\n \n-@ExtendWith(PerformanceReporting.class)\n @TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n-public class DeploymentServiceIntegrationTest {\n+class DeploymentServiceIntegrationTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6a939cf22e998f5ff1cce26941c419cf38a37d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxNzc2Mg==", "bodyText": "why remove the extend?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#discussion_r395817762", "createdAt": "2020-03-20T18:24:57Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/ipc/IPCServicesTest.java", "diffHunk": "@@ -42,17 +41,21 @@\n import static org.junit.jupiter.api.Assertions.assertThrows;\n import static org.junit.jupiter.api.Assertions.assertTrue;\n \n-@ExtendWith(PerformanceReporting.class)\n-class IPCServicesTest extends AbstractBaseITCase {\n+class IPCServicesTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d6a939cf22e998f5ff1cce26941c419cf38a37d"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb13e833225ffe3dfc2bdcdbb732ba369ca1e15e", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eb13e833225ffe3dfc2bdcdbb732ba369ca1e15e", "committedDate": "2020-03-20T21:35:39Z", "message": "Use the full power of subsribe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e586ab7baf801913d71b40f33033f5ff87ed878d", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e586ab7baf801913d71b40f33033f5ff87ed878d", "committedDate": "2020-03-20T21:38:24Z", "message": "fix javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc4948e367f6290d8a883573a850548bad55ceb2", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bc4948e367f6290d8a883573a850548bad55ceb2", "committedDate": "2020-03-20T21:44:04Z", "message": "fix javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODQ0NjEy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/125#pullrequestreview-378844612", "createdAt": "2020-03-20T22:27:13Z", "commit": {"oid": "bc4948e367f6290d8a883573a850548bad55ceb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2357, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}