{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NTU4NDYz", "number": 665, "title": "Improve error recovery of kernel update", "bodyText": "Issue #, if available:\nDescription of changes:\n\nUse committable file for deployment artifacts.\nLoader to handle unexpected crashes during launch dir updates.\n\n\n Pending manual testing.\n\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-12T01:47:26Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665", "merged": true, "mergeCommit": {"oid": "c3e6cfcaeaee577a594350fc8ebd3fc97ea6efac"}, "closed": true, "closedAt": "2020-11-13T22:49:27Z", "author": {"login": "hui-yang"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdboz2xAFqTUyODY4MjY5MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcO8-NgFqTUzMDQ1OTA2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NjgyNjkx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#pullrequestreview-528682691", "createdAt": "2020-11-12T02:06:02Z", "commit": {"oid": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMjowNjowMlrOHxmZnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMjowNjowMlrOHxmZnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MTQyMQ==", "bodyText": "I'm pretty sure I added this once and it didn't work. Have you tested this to make sure it works as expected?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r521771421", "createdAt": "2020-11-12T02:06:02Z", "author": {"login": "MikeDombo"}, "path": "scripts/loader", "diffHunk": "@@ -24,7 +24,7 @@ launch_kernel() {\n     JVM_OPTIONS=$(cat \"$LAUNCH_DIR/launch.params\")\n   fi\n \n-  JVM_OPTIONS=\"$JVM_OPTIONS -Droot=$GG_ROOT\"\n+  JVM_OPTIONS=\"$JVM_OPTIONS -Droot=\\\"$GG_ROOT\\\"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NjgzOTUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#pullrequestreview-528683953", "createdAt": "2020-11-12T02:09:47Z", "commit": {"oid": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMjowOTo0N1rOHxmd5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMjoxMToxN1rOHxmf0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MjUxNg==", "bodyText": "use Files.exists instead", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r521772516", "createdAt": "2020-11-12T02:09:47Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelAlternatives.java", "diffHunk": "@@ -106,8 +115,11 @@ public Path getServiceConfigPath() {\n     }\n \n     public boolean isLaunchDirSetup() {\n-        // GG_NEEDS_REVIEW: TODO: check for file and directory corruptions\n-        return currentDir.toFile().exists();\n+        return validateLaunchDirSetup(currentDir);\n+    }\n+\n+    private boolean validateLaunchDirSetup(Path path) {\n+        return path.toFile().exists() && getLoaderPathFromLaunchDir(path).toFile().exists();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MjY3Ng==", "bodyText": "use deleteIfExists that way it won't complain if it doesn't exist.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r521772676", "createdAt": "2020-11-12T02:10:16Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelAlternatives.java", "diffHunk": "@@ -237,8 +255,12 @@ public void prepareBootstrap(String deploymentId) throws IOException {\n         Path existingLaunchDir = Files.readSymbolicLink(currentDir).toAbsolutePath();\n         copyFolderRecursively(existingLaunchDir, newLaunchDir, REPLACE_EXISTING, NOFOLLOW_LINKS, COPY_ATTRIBUTES);\n \n+        cleanup();\n+        setupLinkToDirectory(newDir, newLaunchDir);\n         setupLinkToDirectory(oldDir, existingLaunchDir);\n+        Files.delete(currentDir);\n         setupLinkToDirectory(currentDir, newLaunchDir);\n+        Files.delete(newDir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3Mjc0Mg==", "bodyText": "at least log?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r521772742", "createdAt": "2020-11-12T02:10:26Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelAlternatives.java", "diffHunk": "@@ -251,7 +273,21 @@ public void prepareBootstrap(String deploymentId) throws IOException {\n      */\n     public void setupLinkToDirectory(Path link, Path directory) throws IOException {\n         logger.atDebug().kv(\"link\", link).kv(\"directory\", directory).log(\"Set up link to directory\");\n-        Files.deleteIfExists(link);\n         Files.createSymbolicLink(link, directory);\n     }\n+\n+    private void cleanup() {\n+        try {\n+            Files.deleteIfExists(brokenDir);\n+        } catch (IOException ignore) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MzAwOA==", "bodyText": "definitely needs a unit test", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r521773008", "createdAt": "2020-11-12T02:11:17Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/util/CommitableReader.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.util;\n+\n+import com.aws.greengrass.logging.api.Logger;\n+import com.aws.greengrass.logging.impl.LogManager;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+public final class CommitableReader {\n+    private static final Logger logger = LogManager.getLogger(CommitableReader.class);\n+\n+    private final Path target;\n+    private final Path backup;\n+\n+    private CommitableReader(Path target, Path backup) {\n+        this.target = target;\n+        this.backup = backup;\n+    }\n+\n+    public static CommitableReader of(Path path) {\n+        return new CommitableReader(path, CommitableFile.getBackupFile(path));\n+    }\n+\n+    /**\n+     * Read and validate the content of the given CommitableFile.\n+     *\n+     * @param validator CrashableFunction to read and validate file content\n+     * @throws IOException on I/O error\n+     */\n+    public void read(CrashableFunction<InputStream, Void, IOException> validator) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ad9b4f528ed1a5155a648f43b2ad3a9b818274d4", "committedDate": "2020-11-12T01:13:43Z", "message": "Improve error recovery of kernel update"}, "afterCommit": {"oid": "34ec91e864b3da9c34757bb15a07bb1ed027a330", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/34ec91e864b3da9c34757bb15a07bb1ed027a330", "committedDate": "2020-11-12T20:06:36Z", "message": "Address comments; add unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34ec91e864b3da9c34757bb15a07bb1ed027a330", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/34ec91e864b3da9c34757bb15a07bb1ed027a330", "committedDate": "2020-11-12T20:06:36Z", "message": "Address comments; add unit tests"}, "afterCommit": {"oid": "789dc09db7a920692478bc4de94961b738d04761", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/789dc09db7a920692478bc4de94961b738d04761", "committedDate": "2020-11-12T20:31:56Z", "message": "Address comments; add unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDc2NDIy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#pullrequestreview-529476422", "createdAt": "2020-11-12T20:35:10Z", "commit": {"oid": "789dc09db7a920692478bc4de94961b738d04761"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozNToxMFrOHyNX1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMDozNToyOVrOHyNYaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQwOTk0MQ==", "bodyText": "deleteIfExists", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r522409941", "createdAt": "2020-11-12T20:35:10Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelAlternatives.java", "diffHunk": "@@ -208,6 +225,7 @@ public void prepareRollback() throws IOException {\n             return;\n         }\n         setupLinkToDirectory(brokenDir, Files.readSymbolicLink(currentDir).toAbsolutePath());\n+        Files.delete(currentDir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "789dc09db7a920692478bc4de94961b738d04761"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQxMDA4OQ==", "bodyText": "Even though you say that, I'd feel better if you just add the ifExists. Less room for throwing exceptions.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#discussion_r522410089", "createdAt": "2020-11-12T20:35:29Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelAlternatives.java", "diffHunk": "@@ -237,8 +255,12 @@ public void prepareBootstrap(String deploymentId) throws IOException {\n         Path existingLaunchDir = Files.readSymbolicLink(currentDir).toAbsolutePath();\n         copyFolderRecursively(existingLaunchDir, newLaunchDir, REPLACE_EXISTING, NOFOLLOW_LINKS, COPY_ATTRIBUTES);\n \n+        cleanup();\n+        setupLinkToDirectory(newDir, newLaunchDir);\n         setupLinkToDirectory(oldDir, existingLaunchDir);\n+        Files.delete(currentDir);\n         setupLinkToDirectory(currentDir, newLaunchDir);\n+        Files.delete(newDir);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3MjY3Ng=="}, "originalCommit": {"oid": "ad9b4f528ed1a5155a648f43b2ad3a9b818274d4"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50436eff9e1e388999bda40704d1fba3603cae28", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/50436eff9e1e388999bda40704d1fba3603cae28", "committedDate": "2020-11-12T21:59:30Z", "message": "Improve error recovery of kernel update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dbb23b3c1cc2d3260512f05615ddedaa2d90e1a", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7dbb23b3c1cc2d3260512f05615ddedaa2d90e1a", "committedDate": "2020-11-12T21:59:30Z", "message": "Address comments; add unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "789dc09db7a920692478bc4de94961b738d04761", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/789dc09db7a920692478bc4de94961b738d04761", "committedDate": "2020-11-12T20:31:56Z", "message": "Address comments; add unit tests"}, "afterCommit": {"oid": "030364636c01aafb2ea43aa366ab0ef15f76c886", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/030364636c01aafb2ea43aa366ab0ef15f76c886", "committedDate": "2020-11-12T21:59:30Z", "message": "More fixes; add inline comments for review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fe3a3f24db5eb97176dc27f7a4183da06334a00", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9fe3a3f24db5eb97176dc27f7a4183da06334a00", "committedDate": "2020-11-12T22:27:39Z", "message": "More fixes; add inline comments for review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "030364636c01aafb2ea43aa366ab0ef15f76c886", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/030364636c01aafb2ea43aa366ab0ef15f76c886", "committedDate": "2020-11-12T21:59:30Z", "message": "More fixes; add inline comments for review"}, "afterCommit": {"oid": "9fe3a3f24db5eb97176dc27f7a4183da06334a00", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9fe3a3f24db5eb97176dc27f7a4183da06334a00", "committedDate": "2020-11-12T22:27:39Z", "message": "More fixes; add inline comments for review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NjgyNzAx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#pullrequestreview-529682701", "createdAt": "2020-11-13T03:37:40Z", "commit": {"oid": "9fe3a3f24db5eb97176dc27f7a4183da06334a00"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a49bdefc23d65700aa6f5146fc3e28b5b59db65", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3a49bdefc23d65700aa6f5146fc3e28b5b59db65", "committedDate": "2020-11-13T03:37:46Z", "message": "Merge branch 'master' into ku-error-recovery"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDUxMTcy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#pullrequestreview-530451172", "createdAt": "2020-11-13T22:13:26Z", "commit": {"oid": "3a49bdefc23d65700aa6f5146fc3e28b5b59db65"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "825828f3056b9415d920149ca9c16a85c5fa699c", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/825828f3056b9415d920149ca9c16a85c5fa699c", "committedDate": "2020-11-13T22:15:57Z", "message": "Merge branch 'master' into ku-error-recovery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cba1a1ed3912f766e151eb5b7b413598ac0af650", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cba1a1ed3912f766e151eb5b7b413598ac0af650", "committedDate": "2020-11-13T22:26:44Z", "message": "Remove comments for review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDU4OTM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#pullrequestreview-530458936", "createdAt": "2020-11-13T22:32:03Z", "commit": {"oid": "cba1a1ed3912f766e151eb5b7b413598ac0af650"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDU5MDYw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/665#pullrequestreview-530459060", "createdAt": "2020-11-13T22:32:23Z", "commit": {"oid": "cba1a1ed3912f766e151eb5b7b413598ac0af650"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2652, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}