{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NjcyOTM4", "number": 561, "title": "Add timestamp to UpdateBehaviorTree to fix multi-group deployment", "bodyText": "Issue #, if available:\nDescription of changes:\nCurrently the config store's updateMap function takes in a single timestamp which will be applied to all the nodes which are modified. This change makes it possible to have different timestamps for each sub-tree and node in order to have correct merges. We will use the deployment document's timestamp only for the configuration part of the merge, everything else will be using the current time.\nWhy is this change necessary:\nHow was this change tested:\nAdded cases to unit tests, all existing tests pass, verified deployment 10 passes (ran 10 times with no failure)\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-23T03:26:54Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561", "merged": true, "mergeCommit": {"oid": "82cbaf04c690b8864c16e412c711cfbb3c508135"}, "closed": true, "closedAt": "2020-10-27T17:59:29Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWW1ssABqjM5MjE2MjM1MDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWs2fxgFqTUxNzk5NTA0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb308ec877a82946a8852081bc6a2e6d1226a3e2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb308ec877a82946a8852081bc6a2e6d1226a3e2", "committedDate": "2020-10-23T03:25:53Z", "message": "Add timestamp to UpdateBehaviorTree to fix multi-group deployment"}, "afterCommit": {"oid": "8b1bb72a1f2c1320a29c195daba8903530352267", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b1bb72a1f2c1320a29c195daba8903530352267", "committedDate": "2020-10-26T16:19:52Z", "message": "Add test cases for timestamp merge, force overwrite the timestamp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b1bb72a1f2c1320a29c195daba8903530352267", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b1bb72a1f2c1320a29c195daba8903530352267", "committedDate": "2020-10-26T16:19:52Z", "message": "Add test cases for timestamp merge, force overwrite the timestamp"}, "afterCommit": {"oid": "414ae01b14d8556f3972885a786f70d1a05b72cb", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/414ae01b14d8556f3972885a786f70d1a05b72cb", "committedDate": "2020-10-26T16:59:18Z", "message": "Add test cases for timestamp merge, force overwrite the timestamp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "414ae01b14d8556f3972885a786f70d1a05b72cb", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/414ae01b14d8556f3972885a786f70d1a05b72cb", "committedDate": "2020-10-26T16:59:18Z", "message": "Add test cases for timestamp merge, force overwrite the timestamp"}, "afterCommit": {"oid": "af903f7a385c34191d7b9586c88a2e4aa9a54d73", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/af903f7a385c34191d7b9586c88a2e4aa9a54d73", "committedDate": "2020-10-26T17:00:21Z", "message": "Add test cases for timestamp merge, force overwrite the timestamp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDA2Mjc0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#pullrequestreview-517006274", "createdAt": "2020-10-26T17:18:34Z", "commit": {"oid": "b92b2a5bfa2f9adb0c2751170740bdbe153489d1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b92b2a5bfa2f9adb0c2751170740bdbe153489d1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b92b2a5bfa2f9adb0c2751170740bdbe153489d1", "committedDate": "2020-10-26T17:10:02Z", "message": "Remove old API to fix build broken by SDK"}, "afterCommit": {"oid": "5c809e879cc414701ce0d2bc1a36cbbd91a2bfda", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5c809e879cc414701ce0d2bc1a36cbbd91a2bfda", "committedDate": "2020-10-26T17:18:38Z", "message": "Remove old API to fix build broken by SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c809e879cc414701ce0d2bc1a36cbbd91a2bfda", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5c809e879cc414701ce0d2bc1a36cbbd91a2bfda", "committedDate": "2020-10-26T17:18:38Z", "message": "Remove old API to fix build broken by SDK"}, "afterCommit": {"oid": "4ca55335fff97e131b6590e4cdcd86d43344e52f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ca55335fff97e131b6590e4cdcd86d43344e52f", "committedDate": "2020-10-26T17:56:05Z", "message": "Remove old API to fix build broken by SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ca55335fff97e131b6590e4cdcd86d43344e52f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ca55335fff97e131b6590e4cdcd86d43344e52f", "committedDate": "2020-10-26T17:56:05Z", "message": "Remove old API to fix build broken by SDK"}, "afterCommit": {"oid": "712776d269d7e7031a27b81fcf241e8968f6143c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/712776d269d7e7031a27b81fcf241e8968f6143c", "committedDate": "2020-10-26T19:00:33Z", "message": "Remove old API to fix build broken by SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "712776d269d7e7031a27b81fcf241e8968f6143c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/712776d269d7e7031a27b81fcf241e8968f6143c", "committedDate": "2020-10-26T19:00:33Z", "message": "Remove old API to fix build broken by SDK"}, "afterCommit": {"oid": "424f9ac8e5b500c22e87b6f9740c30f8c4920bf4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/424f9ac8e5b500c22e87b6f9740c30f8c4920bf4", "committedDate": "2020-10-26T19:06:54Z", "message": "Remove old API to fix build broken by SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdef9d6172697d0a4682248c0df054d2fc9652ed", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cdef9d6172697d0a4682248c0df054d2fc9652ed", "committedDate": "2020-10-26T19:40:46Z", "message": "Merge branch 'master' into timestamp"}, "afterCommit": {"oid": "a1f4d5b18e6c5b49e6a379be9e41d3443f8701c1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a1f4d5b18e6c5b49e6a379be9e41d3443f8701c1", "committedDate": "2020-10-26T20:30:47Z", "message": "Merge branch 'master' into timestamp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a1f4d5b18e6c5b49e6a379be9e41d3443f8701c1", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a1f4d5b18e6c5b49e6a379be9e41d3443f8701c1", "committedDate": "2020-10-26T20:30:47Z", "message": "Merge branch 'master' into timestamp"}, "afterCommit": {"oid": "814ab182f100906a9c052f001f015c842d75270b", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/814ab182f100906a9c052f001f015c842d75270b", "committedDate": "2020-10-26T21:02:14Z", "message": "Merge branch 'master' into timestamp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "814ab182f100906a9c052f001f015c842d75270b", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/814ab182f100906a9c052f001f015c842d75270b", "committedDate": "2020-10-26T21:02:14Z", "message": "Merge branch 'master' into timestamp"}, "afterCommit": {"oid": "d01cb76acd1de8b94d5b34b718f1e5fb74569222", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d01cb76acd1de8b94d5b34b718f1e5fb74569222", "committedDate": "2020-10-26T21:22:43Z", "message": "Merge branch 'master' into timestamp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d01cb76acd1de8b94d5b34b718f1e5fb74569222", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d01cb76acd1de8b94d5b34b718f1e5fb74569222", "committedDate": "2020-10-26T21:22:43Z", "message": "Merge branch 'master' into timestamp"}, "afterCommit": {"oid": "9c76e41d9077072c9cbb6c91cbdcce56514a69a2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9c76e41d9077072c9cbb6c91cbdcce56514a69a2", "committedDate": "2020-10-26T21:23:35Z", "message": "Remove old API to fix build broken by SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c76e41d9077072c9cbb6c91cbdcce56514a69a2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9c76e41d9077072c9cbb6c91cbdcce56514a69a2", "committedDate": "2020-10-26T21:23:35Z", "message": "Remove old API to fix build broken by SDK"}, "afterCommit": {"oid": "b302df91536e2dc351d4af11b8da8ae3f749d292", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b302df91536e2dc351d4af11b8da8ae3f749d292", "committedDate": "2020-10-26T21:27:25Z", "message": "Remove old API to fix build broken by SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b302df91536e2dc351d4af11b8da8ae3f749d292", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b302df91536e2dc351d4af11b8da8ae3f749d292", "committedDate": "2020-10-26T21:27:25Z", "message": "Remove old API to fix build broken by SDK"}, "afterCommit": {"oid": "4860dffa387a66e9b1c35ebf66486d3a93e249ce", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4860dffa387a66e9b1c35ebf66486d3a93e249ce", "committedDate": "2020-10-26T21:29:17Z", "message": "Remove old API to fix build broken by SDK"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTk5MzM0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#pullrequestreview-517199334", "createdAt": "2020-10-26T21:44:53Z", "commit": {"oid": "4860dffa387a66e9b1c35ebf66486d3a93e249ce"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTo0NDo1M1rOHojlLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTo0Njo0NVrOHojodw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODA0Nw==", "bodyText": "do you need the proposed == null && value == null? Objects.equals(null, null) is true so the first predicate should match", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512288047", "createdAt": "2020-10-26T21:44:53Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -147,24 +147,47 @@ public Topic withNewerValue(long proposedModtime, Number proposed) {\n         return withNewerValue(proposedModtime, proposed, false);\n     }\n \n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime          the last modified time of the value. If this is in the past, we do not update the\n+     *                                 value unless this is forced\n+     * @param proposed                 new value.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @return this\n+     */\n+    Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease) {\n+        return withNewerValue(proposedModtime, proposed, allowTimestampToDecrease, false);\n+    }\n+\n     /**\n      * Set the value of this topic to a new value.\n      *\n      * @param proposedModtime the last modified time of the value. If this is in the past, we do not update the value\n      *                       unless this is forced\n      * @param proposed        new value.\n-     * @param forceTimestamp indicate if the proposed time should be forced.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @param allowTimestampToIncrease allow the timestamp to go forward in time without changing the value\n      * @return this.\n      */\n-    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean forceTimestamp) {\n+    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease,\n+                                      boolean allowTimestampToIncrease) {\n         final Object currentValue = value;\n-        final long currentModtime = modtime;\n-        if (Objects.equals(proposed, currentValue) || !forceTimestamp && (proposedModtime < currentModtime)) {\n+        final long currentModTime = modtime;\n+        boolean timestampWouldIncrease = allowTimestampToIncrease && proposedModtime > currentModTime;\n+\n+        if ((Objects.equals(proposed, currentValue)\n+                || !allowTimestampToDecrease && (proposedModtime < currentModTime))\n+                && !timestampWouldIncrease || proposed == null && value == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4860dffa387a66e9b1c35ebf66486d3a93e249ce"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODQ1NA==", "bodyText": "why do you not want to allowTimestampToIncrease here? It seems contradictory in a method called withNewerValue?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512288454", "createdAt": "2020-10-26T21:45:42Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -147,24 +147,47 @@ public Topic withNewerValue(long proposedModtime, Number proposed) {\n         return withNewerValue(proposedModtime, proposed, false);\n     }\n \n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime          the last modified time of the value. If this is in the past, we do not update the\n+     *                                 value unless this is forced\n+     * @param proposed                 new value.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @return this\n+     */\n+    Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease) {\n+        return withNewerValue(proposedModtime, proposed, allowTimestampToDecrease, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4860dffa387a66e9b1c35ebf66486d3a93e249ce"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODg4Nw==", "bodyText": "should you use a clock here instead of System.currentTimeMillis() ? It could make it easier to mock/test", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512288887", "createdAt": "2020-10-26T21:46:45Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/config/Topics.java", "diffHunk": "@@ -373,8 +366,8 @@ public void remove(Node n) {\n      */\n     public void replaceAndWait(Map<String, Object> newValue) {\n         context.runOnPublishQueueAndWait(() ->\n-                updateFromMap(System.currentTimeMillis(), newValue,\n-                        new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.REPLACE))\n+                updateFromMap(newValue,\n+                        new UpdateBehaviorTree(UpdateBehaviorTree.UpdateBehavior.REPLACE, System.currentTimeMillis()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4860dffa387a66e9b1c35ebf66486d3a93e249ce"}, "originalPosition": 102}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4860dffa387a66e9b1c35ebf66486d3a93e249ce", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4860dffa387a66e9b1c35ebf66486d3a93e249ce", "committedDate": "2020-10-26T21:29:17Z", "message": "Remove old API to fix build broken by SDK"}, "afterCommit": {"oid": "6f142aa5719dbc283f8918dd1327910d27d32c3a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f142aa5719dbc283f8918dd1327910d27d32c3a", "committedDate": "2020-10-26T22:22:34Z", "message": "Remove old API to fix build broken by SDK"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MjE5NTcx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#pullrequestreview-517219571", "createdAt": "2020-10-26T22:23:35Z", "commit": {"oid": "6f142aa5719dbc283f8918dd1327910d27d32c3a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f142aa5719dbc283f8918dd1327910d27d32c3a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f142aa5719dbc283f8918dd1327910d27d32c3a", "committedDate": "2020-10-26T22:22:34Z", "message": "Remove old API to fix build broken by SDK"}, "afterCommit": {"oid": "6166d44c72d9eb006aa38ac164839b806987a1e4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6166d44c72d9eb006aa38ac164839b806987a1e4", "committedDate": "2020-10-26T22:25:31Z", "message": "Remove old API to fix build broken by SDK"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3Mjg2MzI2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#pullrequestreview-517286326", "createdAt": "2020-10-27T01:30:26Z", "commit": {"oid": "6166d44c72d9eb006aa38ac164839b806987a1e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMTozMDoyN1rOHooKLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMTozMDoyN1rOHooKLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM2MzA1NA==", "bodyText": "are there any unit tests on this class or is it all \"covered\" by other tests?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512363054", "createdAt": "2020-10-27T01:30:27Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -147,24 +147,49 @@ public Topic withNewerValue(long proposedModtime, Number proposed) {\n         return withNewerValue(proposedModtime, proposed, false);\n     }\n \n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime          the last modified time of the value. If this is in the past, we do not update the\n+     *                                 value unless this is forced\n+     * @param proposed                 new value.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @return this\n+     */\n+    Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease) {\n+        return withNewerValue(proposedModtime, proposed, allowTimestampToDecrease, false);\n+    }\n+\n     /**\n      * Set the value of this topic to a new value.\n      *\n      * @param proposedModtime the last modified time of the value. If this is in the past, we do not update the value\n      *                       unless this is forced\n      * @param proposed        new value.\n-     * @param forceTimestamp indicate if the proposed time should be forced.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @param allowTimestampToIncreaseWhenValueHasntChanged allow the timestamp to go forward in time even if the\n+     *                                                      proposed value is the same as the current value\n      * @return this.\n      */\n-    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean forceTimestamp) {\n+    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6166d44c72d9eb006aa38ac164839b806987a1e4"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzAwOTY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#pullrequestreview-517300965", "createdAt": "2020-10-27T02:17:51Z", "commit": {"oid": "6166d44c72d9eb006aa38ac164839b806987a1e4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NDEwOTQ2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#pullrequestreview-517410946", "createdAt": "2020-10-27T07:31:44Z", "commit": {"oid": "5ca8fa934f7cae5b38cea994f75fa2dc66f4b29e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzozMTo0NVrOHouevg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwNzozNToyMlrOHoulDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ2NjYyMg==", "bodyText": "why do we need allowTimestampToDecrease? when does timestamp value decrease", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512466622", "createdAt": "2020-10-27T07:31:45Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -149,24 +149,49 @@ public Topic withNewerValue(long proposedModtime, Number proposed) {\n         return withNewerValue(proposedModtime, proposed, false);\n     }\n \n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime          the last modified time of the value. If this is in the past, we do not update the\n+     *                                 value unless this is forced\n+     * @param proposed                 new value.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @return this\n+     */\n+    Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease) {\n+        return withNewerValue(proposedModtime, proposed, allowTimestampToDecrease, false);\n+    }\n+\n     /**\n      * Set the value of this topic to a new value.\n      *\n      * @param proposedModtime the last modified time of the value. If this is in the past, we do not update the value\n      *                       unless this is forced\n      * @param proposed        new value.\n-     * @param forceTimestamp indicate if the proposed time should be forced.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @param allowTimestampToIncreaseWhenValueHasntChanged allow the timestamp to go forward in time even if the\n+     *                                                      proposed value is the same as the current value\n      * @return this.\n      */\n-    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean forceTimestamp) {\n+    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca8fa934f7cae5b38cea994f75fa2dc66f4b29e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ2ODIzNw==", "bodyText": "Can you explain the different conditions handled here or break this if condition?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512468237", "createdAt": "2020-10-27T07:35:22Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -149,24 +149,49 @@ public Topic withNewerValue(long proposedModtime, Number proposed) {\n         return withNewerValue(proposedModtime, proposed, false);\n     }\n \n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime          the last modified time of the value. If this is in the past, we do not update the\n+     *                                 value unless this is forced\n+     * @param proposed                 new value.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @return this\n+     */\n+    Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease) {\n+        return withNewerValue(proposedModtime, proposed, allowTimestampToDecrease, false);\n+    }\n+\n     /**\n      * Set the value of this topic to a new value.\n      *\n      * @param proposedModtime the last modified time of the value. If this is in the past, we do not update the value\n      *                       unless this is forced\n      * @param proposed        new value.\n-     * @param forceTimestamp indicate if the proposed time should be forced.\n+     * @param allowTimestampToDecrease allow the timestamp to go back in time\n+     * @param allowTimestampToIncreaseWhenValueHasntChanged allow the timestamp to go forward in time even if the\n+     *                                                      proposed value is the same as the current value\n      * @return this.\n      */\n-    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean forceTimestamp) {\n+    synchronized Topic withNewerValue(long proposedModtime, final Object proposed, boolean allowTimestampToDecrease,\n+                                      boolean allowTimestampToIncreaseWhenValueHasntChanged) {\n         final Object currentValue = value;\n-        final long currentModtime = modtime;\n-        if (Objects.equals(proposed, currentValue) || !forceTimestamp && (proposedModtime < currentModtime)) {\n+        final long currentModTime = modtime;\n+        boolean timestampWouldIncrease =\n+                allowTimestampToIncreaseWhenValueHasntChanged && proposedModtime > currentModTime;\n+\n+        if ((Objects.equals(proposed, currentValue)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca8fa934f7cae5b38cea994f75fa2dc66f4b29e"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ca8fa934f7cae5b38cea994f75fa2dc66f4b29e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5ca8fa934f7cae5b38cea994f75fa2dc66f4b29e", "committedDate": "2020-10-27T03:25:28Z", "message": "Merge branch 'master' into timestamp"}, "afterCommit": {"oid": "77179b556316c9e856f09d1e9e83346e53187993", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77179b556316c9e856f09d1e9e83346e53187993", "committedDate": "2020-10-27T16:33:37Z", "message": "Save updated timestamp to tlog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "77179b556316c9e856f09d1e9e83346e53187993", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77179b556316c9e856f09d1e9e83346e53187993", "committedDate": "2020-10-27T16:33:37Z", "message": "Save updated timestamp to tlog"}, "afterCommit": {"oid": "b5891e1379b2679e9af7466def3c4c9807c751e6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b5891e1379b2679e9af7466def3c4c9807c751e6", "committedDate": "2020-10-27T16:57:09Z", "message": "Save updated timestamp to tlog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "079726da3a903884e2c673cb0cd9fef43ffc4e9d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/079726da3a903884e2c673cb0cd9fef43ffc4e9d", "committedDate": "2020-10-27T17:03:00Z", "message": "Add timestamp to UpdateBehaviorTree to fix multi-group deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad3fc21774e01e8ec14a9808189cc90bc4b49380", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ad3fc21774e01e8ec14a9808189cc90bc4b49380", "committedDate": "2020-10-27T17:03:00Z", "message": "Add test cases for timestamp merge, force overwrite the timestamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8b3772c4a39425e73fa5b9858d4c2e9f7ae3b45", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b8b3772c4a39425e73fa5b9858d4c2e9f7ae3b45", "committedDate": "2020-10-27T17:03:00Z", "message": "Remove old API to fix build broken by SDK"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5891e1379b2679e9af7466def3c4c9807c751e6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b5891e1379b2679e9af7466def3c4c9807c751e6", "committedDate": "2020-10-27T16:57:09Z", "message": "Save updated timestamp to tlog"}, "afterCommit": {"oid": "6884d9b7dc0ab62367045602399ccf884710089d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6884d9b7dc0ab62367045602399ccf884710089d", "committedDate": "2020-10-27T17:03:00Z", "message": "Save updated timestamp to tlog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTUyMzUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#pullrequestreview-517952353", "createdAt": "2020-10-27T17:14:39Z", "commit": {"oid": "6884d9b7dc0ab62367045602399ccf884710089d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNzoxNDozOVrOHpHf-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNzoxNDozOVrOHpHf-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3NjUzNw==", "bodyText": "can you give some more context on when you would want to be notified that the timestamp is updated?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#discussion_r512876537", "createdAt": "2020-10-27T17:14:39Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -179,7 +210,11 @@ synchronized Topic withNewerValue(long proposedModtime, final Object proposed, b\n \n         value = validated;\n         modtime = proposedModtime;\n-        context.runOnPublishQueue(() -> this.fire(WhatHappened.changed));\n+        if (changed) {\n+            context.runOnPublishQueue(() -> this.fire(WhatHappened.changed));\n+        } else {\n+            context.runOnPublishQueue(() -> this.fire(WhatHappened.timestampUpdated));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6884d9b7dc0ab62367045602399ccf884710089d"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTcyNzkz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#pullrequestreview-517972793", "createdAt": "2020-10-27T17:33:12Z", "commit": {"oid": "6884d9b7dc0ab62367045602399ccf884710089d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b861e40c945e3b5176ce79c56b117c4d9a99750", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1b861e40c945e3b5176ce79c56b117c4d9a99750", "committedDate": "2020-10-27T17:41:26Z", "message": "Save updated timestamp to tlog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6884d9b7dc0ab62367045602399ccf884710089d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6884d9b7dc0ab62367045602399ccf884710089d", "committedDate": "2020-10-27T17:03:00Z", "message": "Save updated timestamp to tlog"}, "afterCommit": {"oid": "1b861e40c945e3b5176ce79c56b117c4d9a99750", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1b861e40c945e3b5176ce79c56b117c4d9a99750", "committedDate": "2020-10-27T17:41:26Z", "message": "Save updated timestamp to tlog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTk0OTc2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#pullrequestreview-517994976", "createdAt": "2020-10-27T17:58:51Z", "commit": {"oid": "1b861e40c945e3b5176ce79c56b117c4d9a99750"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTk1MDQy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/561#pullrequestreview-517995042", "createdAt": "2020-10-27T17:58:55Z", "commit": {"oid": "1b861e40c945e3b5176ce79c56b117c4d9a99750"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2822, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}