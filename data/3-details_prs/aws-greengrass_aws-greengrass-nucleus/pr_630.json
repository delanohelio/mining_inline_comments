{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NTEyMTI3", "number": 630, "title": "Better process tree killing", "bodyText": "Issue #, if available:\nDescription of changes:\nRemoves usage of pkill since it only actually kills direct descendants and not grandchildren and more. Changes interface for killing processes so that we know all the pids that we tried to kill using SIGINT so that we can try again using SIGKILL. This way, if an intermediate process would die, all the children would be reparented to pid 1 which would make us lose track of them. This way we will still know that they are processes spawned by us, even if the process tree no longer reflects that.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-06T05:43:26Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630", "merged": true, "mergeCommit": {"oid": "d4acf6c422baf4fb440296396ea41e137d149d7e"}, "closed": true, "closedAt": "2020-11-06T18:27:22Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZwWI5ABqjM5NjU2MjU0OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ7RLLAFqTUyNTM5NTI5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c167612999855ebdbb98f89a0cc5548a446739ea", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c167612999855ebdbb98f89a0cc5548a446739ea", "committedDate": "2020-11-06T05:42:59Z", "message": "Better process tree killing"}, "afterCommit": {"oid": "6feed201673c76c633fd05c4eb2d5f64078115b7", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6feed201673c76c633fd05c4eb2d5f64078115b7", "committedDate": "2020-11-06T05:44:50Z", "message": "Better process tree killing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODc5Njc1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#pullrequestreview-524879675", "createdAt": "2020-11-06T06:13:21Z", "commit": {"oid": "6feed201673c76c633fd05c4eb2d5f64078115b7"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNjoxMzoyMVrOHuhW7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQwNjoxMzoyMVrOHuhW7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU0MzA4NQ==", "bodyText": "this won't work on mac/linux when nucleus is not running as root and processes are able to be run as other uses via sudo- but it arguably wasn't working very well before anyway", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#discussion_r518543085", "createdAt": "2020-11-06T06:13:21Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/util/platforms/unix/UnixPlatform.java", "diffHunk": "@@ -253,23 +253,20 @@ public UnixUserAttributes lookupCurrentUser() throws IOException {\n     }\n \n     @Override\n-    public void killProcessAndChildren(Process process, boolean force, UserDecorator userDecorator)\n+    public Set<Integer> killProcessAndChildren(Process process, boolean force, Set<Integer> additionalPids)\n             throws IOException, InterruptedException {\n         PidProcess pp = Processes.newPidProcess(process);\n \n-        logger.atDebug().log(\"Running pkill to kill child processes of pid {}\", pp.getPid());\n-        // Use pkill to kill all subprocesses under the main shell\n-        String[] cmd = {\"pkill\", \"-\" + (force ? SIGKILL : SIGINT), \"-P\", Integer.toString(pp.getPid())};\n-        if (userDecorator != null) {\n-            cmd = userDecorator.decorate(cmd);\n+        logger.atDebug().log(\"Killing child processes of pid {}\", pp.getPid());\n+        Set<Integer> pids = getChildPids(process);\n+        if (additionalPids != null) {\n+            pids.addAll(additionalPids);\n         }\n-        Process proc = Runtime.getRuntime().exec(cmd);\n-        proc.waitFor();\n-        if (proc.exitValue() != 0) {\n-            logger.atWarn().kv(\"pid\", pp.getPid()).kv(\"exit-code\", proc.exitValue())\n-                    .kv(STDOUT, inputStreamToString(proc.getInputStream()))\n-                    .kv(STDERR, inputStreamToString(proc.getErrorStream()))\n-                    .log(\"pkill exited non-zero (process not found or other error)\");\n+        for (Integer pid : pids) {\n+            PidProcess proc = Processes.newPidProcess(pid);\n+            if (proc.isAlive()) {\n+                proc.destroy(force);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feed201673c76c633fd05c4eb2d5f64078115b7"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6feed201673c76c633fd05c4eb2d5f64078115b7", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6feed201673c76c633fd05c4eb2d5f64078115b7", "committedDate": "2020-11-06T05:44:50Z", "message": "Better process tree killing"}, "afterCommit": {"oid": "531c89fdabbc7eb60febd51aa266b298a67145d2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/531c89fdabbc7eb60febd51aa266b298a67145d2", "committedDate": "2020-11-06T06:14:55Z", "message": "Better process tree killing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "531c89fdabbc7eb60febd51aa266b298a67145d2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/531c89fdabbc7eb60febd51aa266b298a67145d2", "committedDate": "2020-11-06T06:14:55Z", "message": "Better process tree killing"}, "afterCommit": {"oid": "f1a705705c0d819a519dcdd33c1da8e55824247b", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f1a705705c0d819a519dcdd33c1da8e55824247b", "committedDate": "2020-11-06T06:21:30Z", "message": "Better process tree killing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODg4ODIz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#pullrequestreview-524888823", "createdAt": "2020-11-06T06:39:58Z", "commit": {"oid": "f1a705705c0d819a519dcdd33c1da8e55824247b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1a705705c0d819a519dcdd33c1da8e55824247b", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f1a705705c0d819a519dcdd33c1da8e55824247b", "committedDate": "2020-11-06T06:21:30Z", "message": "Better process tree killing"}, "afterCommit": {"oid": "42d36864971c41b1f3a13eaf385f0fae4effcc33", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/42d36864971c41b1f3a13eaf385f0fae4effcc33", "committedDate": "2020-11-06T07:17:42Z", "message": "Better process tree killing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d374187c61a698c96e3aefac778ff3584b4c17f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2d374187c61a698c96e3aefac778ff3584b4c17f", "committedDate": "2020-11-06T07:47:11Z", "message": "Better process tree killing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42d36864971c41b1f3a13eaf385f0fae4effcc33", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/42d36864971c41b1f3a13eaf385f0fae4effcc33", "committedDate": "2020-11-06T07:17:42Z", "message": "Better process tree killing"}, "afterCommit": {"oid": "2d374187c61a698c96e3aefac778ff3584b4c17f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2d374187c61a698c96e3aefac778ff3584b4c17f", "committedDate": "2020-11-06T07:47:11Z", "message": "Better process tree killing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0OTIwNDk3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#pullrequestreview-524920497", "createdAt": "2020-11-06T07:50:55Z", "commit": {"oid": "42d36864971c41b1f3a13eaf385f0fae4effcc33"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fd0979a6fac90e863f09b6db3b48da999d01c5c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0fd0979a6fac90e863f09b6db3b48da999d01c5c", "committedDate": "2020-11-06T08:02:09Z", "message": "Merge branch 'master' into kill"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "569c161a496782f51153fcbf90d88a6b3ee30650", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/569c161a496782f51153fcbf90d88a6b3ee30650", "committedDate": "2020-11-06T08:26:01Z", "message": "Always kill children no matter what parent does"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "020100cb805d27e635194bf50cd96937e688ed0c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/020100cb805d27e635194bf50cd96937e688ed0c", "committedDate": "2020-11-06T16:47:35Z", "message": "Use symlink fix when path is 108"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzI4OTUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#pullrequestreview-525328953", "createdAt": "2020-11-06T16:54:52Z", "commit": {"oid": "569c161a496782f51153fcbf90d88a6b3ee30650"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjo1NDo1M1rOHu13cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjo1NDo1M1rOHu13cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3OTA4OA==", "bodyText": "2 seconds seems pretty short. Ideally this should be configurable. I'm okay to use a hardcoded value here for now, but I would extend the wait time, such as 30 seconds. Also add a log if the waitFor return false.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#discussion_r518879088", "createdAt": "2020-11-06T16:54:53Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/util/Exec.java", "diffHunk": "@@ -491,19 +493,22 @@ public synchronized void close() throws IOException {\n \n         Platform platformInstance = Platform.getInstance();\n \n+        Set<Integer> pids = Collections.emptySet();\n         try {\n-            platformInstance.killProcessAndChildren(p, false, userDecorator);\n+            pids = platformInstance.killProcessAndChildren(p, false, pids, userDecorator);\n             // TODO: [P41214162] configurable timeout\n-            if (!p.waitFor(2, TimeUnit.SECONDS)) {\n-                platformInstance.killProcessAndChildren(p, true, userDecorator);\n-                if (!p.waitFor(5, TimeUnit.SECONDS) && !isClosed.get()) {\n-                    throw new IOException(\"Could not stop \" + this);\n-                }\n+            // Wait for it to die, but ignore the outcome and just forcefully kill it and all its\n+            // children anyway. This way, any misbehaving children or grandchildren will be killed\n+            // whether or not the parent behaved appropriately.\n+            p.waitFor(2, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569c161a496782f51153fcbf90d88a6b3ee30650"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzM0Mzcw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#pullrequestreview-525334370", "createdAt": "2020-11-06T17:01:45Z", "commit": {"oid": "404cb3acd0f0d67b55b0460bd9b0b631dc7efff0"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "404cb3acd0f0d67b55b0460bd9b0b631dc7efff0", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/404cb3acd0f0d67b55b0460bd9b0b631dc7efff0", "committedDate": "2020-11-06T17:00:03Z", "message": "Address comment"}, "afterCommit": {"oid": "b19d13e98d403ad3384047380ee282f1a75cdd0c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b19d13e98d403ad3384047380ee282f1a75cdd0c", "committedDate": "2020-11-06T17:30:17Z", "message": "Address comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b19d13e98d403ad3384047380ee282f1a75cdd0c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b19d13e98d403ad3384047380ee282f1a75cdd0c", "committedDate": "2020-11-06T17:30:17Z", "message": "Address comment"}, "afterCommit": {"oid": "149926f465d8166dff139a5cccf5faed364cd59d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/149926f465d8166dff139a5cccf5faed364cd59d", "committedDate": "2020-11-06T17:50:52Z", "message": "Address comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5860a2b42f42c42d43457fb07bfb7cdf033526c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f5860a2b42f42c42d43457fb07bfb7cdf033526c", "committedDate": "2020-11-06T17:53:02Z", "message": "Address comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "149926f465d8166dff139a5cccf5faed364cd59d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/149926f465d8166dff139a5cccf5faed364cd59d", "committedDate": "2020-11-06T17:50:52Z", "message": "Address comment"}, "afterCommit": {"oid": "f5860a2b42f42c42d43457fb07bfb7cdf033526c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f5860a2b42f42c42d43457fb07bfb7cdf033526c", "committedDate": "2020-11-06T17:53:02Z", "message": "Address comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Mzg1MjM4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#pullrequestreview-525385238", "createdAt": "2020-11-06T18:13:24Z", "commit": {"oid": "f5860a2b42f42c42d43457fb07bfb7cdf033526c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzkzODM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#pullrequestreview-525393836", "createdAt": "2020-11-06T18:26:18Z", "commit": {"oid": "f5860a2b42f42c42d43457fb07bfb7cdf033526c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Mzk1Mjkx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/630#pullrequestreview-525395291", "createdAt": "2020-11-06T18:28:30Z", "commit": {"oid": "f5860a2b42f42c42d43457fb07bfb7cdf033526c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2945, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}