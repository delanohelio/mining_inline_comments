{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExOTkzMTgx", "number": 580, "title": "Proper config interpolation using timestamps", "bodyText": "Issue #, if available:\nDescription of changes:\nUse a Configuration object so that we can properly merge configuration with multiple differing timestamps on each level.\nAll tests are passing\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-29T03:53:47Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/580", "merged": true, "mergeCommit": {"oid": "a15b0a53d78322575041ba4043ebe5f0ef7e3980"}, "closed": true, "closedAt": "2020-10-29T22:02:34Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXJ_XVgBqjM5MzQzMjcyMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXZhz3gFqTUyMDEyMDU2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53e2a863c4da145af8283a3fa32e000c9fd3f27a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/53e2a863c4da145af8283a3fa32e000c9fd3f27a", "committedDate": "2020-10-29T03:52:38Z", "message": "Proper config interpolation using timestamps"}, "afterCommit": {"oid": "7e48c6936f79cbc420f0cca7d10c98b43fab89af", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7e48c6936f79cbc420f0cca7d10c98b43fab89af", "committedDate": "2020-10-29T03:55:42Z", "message": "Proper config interpolation using timestamps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e48c6936f79cbc420f0cca7d10c98b43fab89af", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7e48c6936f79cbc420f0cca7d10c98b43fab89af", "committedDate": "2020-10-29T03:55:42Z", "message": "Proper config interpolation using timestamps"}, "afterCommit": {"oid": "f54d9a5451d37a8fa015076df44e39f467676001", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f54d9a5451d37a8fa015076df44e39f467676001", "committedDate": "2020-10-29T03:59:36Z", "message": "Proper config interpolation using timestamps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f54d9a5451d37a8fa015076df44e39f467676001", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f54d9a5451d37a8fa015076df44e39f467676001", "committedDate": "2020-10-29T03:59:36Z", "message": "Proper config interpolation using timestamps"}, "afterCommit": {"oid": "8b1cb61a5380bf1739e371d539775f116c2cd3f3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b1cb61a5380bf1739e371d539775f116c2cd3f3", "committedDate": "2020-10-29T04:05:17Z", "message": "Proper config interpolation using timestamps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b1cb61a5380bf1739e371d539775f116c2cd3f3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b1cb61a5380bf1739e371d539775f116c2cd3f3", "committedDate": "2020-10-29T04:05:17Z", "message": "Proper config interpolation using timestamps"}, "afterCommit": {"oid": "80f3784c3c51434423f361ff5209836732692de7", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/80f3784c3c51434423f361ff5209836732692de7", "committedDate": "2020-10-29T05:39:35Z", "message": "Proper config interpolation using timestamps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80f3784c3c51434423f361ff5209836732692de7", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/80f3784c3c51434423f361ff5209836732692de7", "committedDate": "2020-10-29T05:39:35Z", "message": "Proper config interpolation using timestamps"}, "afterCommit": {"oid": "37a66bcd39e52803e020b6d48fb2b6e5d07e53b2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/37a66bcd39e52803e020b6d48fb2b6e5d07e53b2", "committedDate": "2020-10-29T16:21:00Z", "message": "Proper config interpolation using timestamps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37a66bcd39e52803e020b6d48fb2b6e5d07e53b2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/37a66bcd39e52803e020b6d48fb2b6e5d07e53b2", "committedDate": "2020-10-29T16:21:00Z", "message": "Proper config interpolation using timestamps"}, "afterCommit": {"oid": "e2bcba17e37d963a98a6be515dd94710486618a3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e2bcba17e37d963a98a6be515dd94710486618a3", "committedDate": "2020-10-29T16:46:15Z", "message": "Proper config interpolation using timestamps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2bcba17e37d963a98a6be515dd94710486618a3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e2bcba17e37d963a98a6be515dd94710486618a3", "committedDate": "2020-10-29T16:46:15Z", "message": "Proper config interpolation using timestamps"}, "afterCommit": {"oid": "47b15300c6da1756c43f5da8ca0ea75e8492335e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/47b15300c6da1756c43f5da8ca0ea75e8492335e", "committedDate": "2020-10-29T18:23:33Z", "message": "Add test case for resolving with different timestamps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d446a22eca9a73f4a10dfd2284bb1104ab8fbd12", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d446a22eca9a73f4a10dfd2284bb1104ab8fbd12", "committedDate": "2020-10-29T18:47:04Z", "message": "Simplify RESET behavior"}, "afterCommit": {"oid": "fb6bb5ad89f142037cf63c1a69031d6a429b9bbf", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb6bb5ad89f142037cf63c1a69031d6a429b9bbf", "committedDate": "2020-10-29T19:00:32Z", "message": "Simplify RESET behavior"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMDAxNzI2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/580#pullrequestreview-520001726", "createdAt": "2020-10-29T19:25:21Z", "commit": {"oid": "fb6bb5ad89f142037cf63c1a69031d6a429b9bbf"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61b952e412874e0e3be1b78f8e4f398520bfab8e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/61b952e412874e0e3be1b78f8e4f398520bfab8e", "committedDate": "2020-10-29T20:01:49Z", "message": "Proper config interpolation using timestamps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "791bbe4f046b12f85277399b6a93232757ab09bb", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/791bbe4f046b12f85277399b6a93232757ab09bb", "committedDate": "2020-10-29T20:01:50Z", "message": "Revert \"handle config update when default value is specified in the using Parameters: (#578)\"\n\nThis reverts commit 19958f5b58c11bbb668114aacccea8656d062ddd."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "041f82b0dccefb5be06207ea05e15ecbc9ab72f2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/041f82b0dccefb5be06207ea05e15ecbc9ab72f2", "committedDate": "2020-10-29T20:01:50Z", "message": "Add test case for resolving with different timestamps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4a24ba85932d0df49f07bbc9a4821436ec191a3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c4a24ba85932d0df49f07bbc9a4821436ec191a3", "committedDate": "2020-10-29T20:01:50Z", "message": "Simplify RESET behavior"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb6bb5ad89f142037cf63c1a69031d6a429b9bbf", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb6bb5ad89f142037cf63c1a69031d6a429b9bbf", "committedDate": "2020-10-29T19:00:32Z", "message": "Simplify RESET behavior"}, "afterCommit": {"oid": "c4a24ba85932d0df49f07bbc9a4821436ec191a3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c4a24ba85932d0df49f07bbc9a4821436ec191a3", "committedDate": "2020-10-29T20:01:50Z", "message": "Simplify RESET behavior"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMDkwOTE2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/580#pullrequestreview-520090916", "createdAt": "2020-10-29T21:11:37Z", "commit": {"oid": "c4a24ba85932d0df49f07bbc9a4821436ec191a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMDkzMzc1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/580#pullrequestreview-520093375", "createdAt": "2020-10-29T21:15:34Z", "commit": {"oid": "c4a24ba85932d0df49f07bbc9a4821436ec191a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMToxNTozNFrOHqvAOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMToxNTozNFrOHqvAOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU3MjM0NQ==", "bodyText": "Configuration is labelled as Deprecated.  What the reason of adding this if block?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/580#discussion_r514572345", "createdAt": "2020-10-29T21:15:34Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/componentmanager/KernelConfigResolver.java", "diffHunk": "@@ -251,6 +251,12 @@ public KernelConfigResolver(ComponentStore componentStore, Kernel kernel, Nucleu\n             DeploymentPackageConfiguration packageConfiguration = optionalDeploymentPackageConfig.get();\n             optionalConfigUpdate = Optional.ofNullable(packageConfiguration.getConfigurationUpdateOperation());\n \n+            if (!optionalConfigUpdate.isPresent() && packageConfiguration.getConfiguration() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4a24ba85932d0df49f07bbc9a4821436ec191a3"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTE4MDUw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/580#pullrequestreview-520118050", "createdAt": "2020-10-29T21:57:16Z", "commit": {"oid": "c4a24ba85932d0df49f07bbc9a4821436ec191a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMTo1NzoxNlrOHqwLAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQyMTo1NzoxNlrOHqwLAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDU5MTQ4OQ==", "bodyText": "Is there any side effect of merge the configuration here? For example, can a subscriber to a config key be triggered here?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/580#discussion_r514591489", "createdAt": "2020-10-29T21:57:16Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/componentmanager/KernelConfigResolver.java", "diffHunk": "@@ -275,140 +281,101 @@ public KernelConfigResolver(ComponentStore componentStore, Kernel kernel, Nucleu\n      *\n      * @param configurationUpdateOperation nullable component configuration update operation.\n      * @param componentRecipe              component recipe containing default configuration.\n+     * @param document                     deployment document\n      * @return resolved configuration for this component. non null.\n      */\n     private Map<String, Object> resolveConfigurationToApply(\n-            @Nullable ConfigurationUpdateOperation configurationUpdateOperation, ComponentRecipe componentRecipe) {\n+            @Nullable ConfigurationUpdateOperation configurationUpdateOperation, ComponentRecipe componentRecipe,\n+            DeploymentDocument document) {\n \n         // try read the running service config\n-        Map<String, Object> currentRunningConfig = null;\n-\n-        Topics serviceTopics = kernel.findServiceTopic(componentRecipe.getComponentName());\n-        if (serviceTopics != null) {\n-            Topics configuration = serviceTopics.findTopics(CONFIGURATION_CONFIG_KEY);\n-            if (configuration != null) {\n-                currentRunningConfig = configuration.toPOJO();\n+        try (Context context = new Context()) {\n+            Configuration currentRunningConfig = new Configuration(context);\n+\n+            // Copy from running config (if any)\n+            Topics serviceTopics = kernel.findServiceTopic(componentRecipe.getComponentName());\n+            if (serviceTopics != null) {\n+                Topics configuration = serviceTopics.findTopics(CONFIGURATION_CONFIG_KEY);\n+                if (configuration != null) {\n+                    currentRunningConfig.copyFrom(configuration);\n+                }\n             }\n-        }\n-\n-        // get default config\n-        JsonNode defaultConfig = Optional.ofNullable(componentRecipe.getComponentConfiguration())\n-                .map(ComponentConfiguration::getDefaultConfiguration)\n-                .orElse(MAPPER.createObjectNode()); // init null to be empty default config\n \n-        // no update\n-        if (configurationUpdateOperation == null) {\n-            if (currentRunningConfig == null) {\n-                // no update nor running config, so it should return return the default config.\n-                return MAPPER.convertValue(defaultConfig, Map.class);\n-            } else {\n-                // no update but there is running config, so it should return running config as is.\n-                return currentRunningConfig;\n+            // Remove keys which want to be reset to their default value\n+            if (configurationUpdateOperation != null) {\n+                removeKeysFromConfigWhichAreReset(currentRunningConfig, configurationUpdateOperation.getPathsToReset());\n             }\n-        }\n-\n-        // perform RESET and then MERGE in order\n-        Map<String, Object> resolvedConfig;\n-\n-        resolvedConfig = reset(currentRunningConfig, defaultConfig, configurationUpdateOperation.getPathsToReset());\n \n-        resolvedConfig = deepMerge(resolvedConfig, configurationUpdateOperation.getValueToMerge());\n+            // Merge in the defaults with timestamp 1 so that they don't overwrite any pre-existing values\n+            JsonNode defaultConfig = Optional.ofNullable(componentRecipe.getComponentConfiguration())\n+                    .map(ComponentConfiguration::getDefaultConfiguration)\n+                    .orElse(MAPPER.createObjectNode()); // init null to be empty default config\n+            // Merge in the defaults from the recipe using timestamp 1 to denote a default\n+            currentRunningConfig.mergeMap(1, MAPPER.convertValue(defaultConfig, Map.class));\n+            currentRunningConfig.context.runOnPublishQueueAndWait(() -> {});\n+\n+            // Merge in the requested config updates\n+            if (configurationUpdateOperation != null && configurationUpdateOperation.getValueToMerge() != null) {\n+                currentRunningConfig.mergeMap(document.getTimestamp(), configurationUpdateOperation.getValueToMerge());\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4a24ba85932d0df49f07bbc9a4821436ec191a3"}, "originalPosition": 146}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMTIwNTY5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/580#pullrequestreview-520120569", "createdAt": "2020-10-29T22:02:03Z", "commit": {"oid": "c4a24ba85932d0df49f07bbc9a4821436ec191a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2849, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}