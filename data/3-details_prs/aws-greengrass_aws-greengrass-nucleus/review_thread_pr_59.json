{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczODAxMTMy", "number": 59, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMDoxMzozNlrODgft4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMDoxODo1OFrODgfxRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NDAwNjcyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/builtin/services/lifecycle/LifecycleIPCAgent.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMDoxMzozNlrOFqu16g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMToyMjozN1rOFqv8Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1MTk3OA==", "bodyText": "NIT: I prefer pass the enum directly to sendAndReceive", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/59#discussion_r380351978", "createdAt": "2020-02-17T20:13:36Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/builtin/services/lifecycle/LifecycleIPCAgent.java", "diffHunk": "@@ -126,7 +125,7 @@ public void postInject() {\n                         ConnectionHandle connectionHandle =\n                                 router.getConnectionHandle(context, this::handleConnectionClosed);\n                         if (connectionHandle != null) {\n-                            connectionHandle.sendAndReceive(LIFECYCLE_SERVICE_NAME,\n+                            connectionHandle.sendAndReceive(BuiltInServiceDestinationCode.LIFECYCLE.getValue(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2bfa09b3347cd84db3f461415220a4a5d22b8bc"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM2OTk4Nw==", "bodyText": "As discussed offline, the reasoning here is that services can be dynamically added and not present in the enum at compile time. So that's why to use the int value directly instead of the enum.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/59#discussion_r380369987", "createdAt": "2020-02-17T21:22:37Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/builtin/services/lifecycle/LifecycleIPCAgent.java", "diffHunk": "@@ -126,7 +125,7 @@ public void postInject() {\n                         ConnectionHandle connectionHandle =\n                                 router.getConnectionHandle(context, this::handleConnectionClosed);\n                         if (connectionHandle != null) {\n-                            connectionHandle.sendAndReceive(LIFECYCLE_SERVICE_NAME,\n+                            connectionHandle.sendAndReceive(BuiltInServiceDestinationCode.LIFECYCLE.getValue(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1MTk3OA=="}, "originalCommit": {"oid": "a2bfa09b3347cd84db3f461415220a4a5d22b8bc"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NDAxNTQwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/ipc/handler/AuthHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMDoxODo1OFrOFqu7Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMToyMzoxNlrOFqv84g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1MzI5MQ==", "bodyText": "Should you disconnect after this?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/59#discussion_r380353291", "createdAt": "2020-02-17T20:18:58Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/ipc/handler/AuthHandler.java", "diffHunk": "@@ -72,6 +87,32 @@ public ConnectionContext doAuth(FrameReader.Message request) throws IPCClientNot\n             throw new IPCClientNotAuthorizedException(\"Auth token not found\");\n         }\n \n-        return new ConnectionContext(serviceName);\n+        return new ConnectionContext(serviceName, remoteAddress);\n+    }\n+\n+    void handleAuth(ChannelHandlerContext ctx, FrameReader.MessageFrame message) throws IOException {\n+        if (message.destination == BuiltInServiceDestinationCode.AUTH.getValue()) {\n+            try {\n+                ConnectionContext context = doAuth(message.message, ctx.channel().remoteAddress());\n+                ctx.channel().attr(IPCChannelHandler.CONNECTION_CONTEXT_KEY).set(context);\n+                log.note(\"Successfully authenticated client\", context);\n+                sendResponse(new FrameReader.Message(IPCUtil.encode(\n+                        GeneralResponse.builder().response(context.getServiceName()).error(GenericErrorCodes.Success)\n+                                .build())), message.requestId, message.destination, ctx, false);\n+                router.clientConnected(context, ctx.channel());\n+            } catch (Throwable t) {\n+                log.warn(\"Error while authenticating client\", ctx.channel().remoteAddress(), t);\n+                sendResponse(new FrameReader.Message(IPCUtil.encode(\n+                        GeneralResponse.builder().errorMessage(\"Error while authenticating client\")\n+                                .error(GenericErrorCodes.Unauthorized).build())), message.requestId,\n+                        message.destination, ctx, true);\n+            }\n+        } else {\n+            log.warn(\"Wrong destination for first packet from client\", ctx.channel().remoteAddress());\n+            sendResponse(new FrameReader.Message(IPCUtil.encode(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2bfa09b3347cd84db3f461415220a4a5d22b8bc"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM3MDE0Ng==", "bodyText": "As discussed offline, yes it should and does disconnect. That's the boolean flag at the end. Setting it to true means that it will disconnect the netty channel once we write the response.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/59#discussion_r380370146", "createdAt": "2020-02-17T21:23:16Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/ipc/handler/AuthHandler.java", "diffHunk": "@@ -72,6 +87,32 @@ public ConnectionContext doAuth(FrameReader.Message request) throws IPCClientNot\n             throw new IPCClientNotAuthorizedException(\"Auth token not found\");\n         }\n \n-        return new ConnectionContext(serviceName);\n+        return new ConnectionContext(serviceName, remoteAddress);\n+    }\n+\n+    void handleAuth(ChannelHandlerContext ctx, FrameReader.MessageFrame message) throws IOException {\n+        if (message.destination == BuiltInServiceDestinationCode.AUTH.getValue()) {\n+            try {\n+                ConnectionContext context = doAuth(message.message, ctx.channel().remoteAddress());\n+                ctx.channel().attr(IPCChannelHandler.CONNECTION_CONTEXT_KEY).set(context);\n+                log.note(\"Successfully authenticated client\", context);\n+                sendResponse(new FrameReader.Message(IPCUtil.encode(\n+                        GeneralResponse.builder().response(context.getServiceName()).error(GenericErrorCodes.Success)\n+                                .build())), message.requestId, message.destination, ctx, false);\n+                router.clientConnected(context, ctx.channel());\n+            } catch (Throwable t) {\n+                log.warn(\"Error while authenticating client\", ctx.channel().remoteAddress(), t);\n+                sendResponse(new FrameReader.Message(IPCUtil.encode(\n+                        GeneralResponse.builder().errorMessage(\"Error while authenticating client\")\n+                                .error(GenericErrorCodes.Unauthorized).build())), message.requestId,\n+                        message.destination, ctx, true);\n+            }\n+        } else {\n+            log.warn(\"Wrong destination for first packet from client\", ctx.channel().remoteAddress());\n+            sendResponse(new FrameReader.Message(IPCUtil.encode(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM1MzI5MQ=="}, "originalCommit": {"oid": "a2bfa09b3347cd84db3f461415220a4a5d22b8bc"}, "originalPosition": 85}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 76, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}