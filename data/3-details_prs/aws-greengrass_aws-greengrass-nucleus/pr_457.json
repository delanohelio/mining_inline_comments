{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NjYxODgw", "number": 457, "title": "Scope down config store types", "bodyText": "Issue #, if available:\nhttps://quip-amazon.com/Z44BAo8YQH8t/Greengrass-Config-Store-SerDes-Issues\nDescription of changes:\nScopes down what Topic can store using withValue to be able to store only String, Number, boolean, and lists of those things. This adds a good degree of safety against people mis-using the config store to store POJOs which won't be properly deserialized when the kernel restarts.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-19T04:20:49Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/457", "merged": true, "mergeCommit": {"oid": "3bbc2f072972da5d26c7c10329cb0f811d9ff11b"}, "closed": true, "closedAt": "2020-09-22T00:22:38Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKSs63ABqjM3ODQ3NjcxOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLL1jRgFqTQ5MzA0Mzc2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e03e285d9b7e052829d8e0fbbcbb11e789afd84a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e03e285d9b7e052829d8e0fbbcbb11e789afd84a", "committedDate": "2020-09-19T04:20:03Z", "message": "Force Topic to only store types that it can handle"}, "afterCommit": {"oid": "05cc5b38585607a6e32eb932a88795e9640ab3e8", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/05cc5b38585607a6e32eb932a88795e9640ab3e8", "committedDate": "2020-09-19T04:41:31Z", "message": "Force Topic to only store types that it can handle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05cc5b38585607a6e32eb932a88795e9640ab3e8", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/05cc5b38585607a6e32eb932a88795e9640ab3e8", "committedDate": "2020-09-19T04:41:31Z", "message": "Force Topic to only store types that it can handle"}, "afterCommit": {"oid": "21e84f30c074cb7ca20165e3e77b5d80176feb3b", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/21e84f30c074cb7ca20165e3e77b5d80176feb3b", "committedDate": "2020-09-19T05:34:33Z", "message": "Force Topic to only store types that it can handle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21e84f30c074cb7ca20165e3e77b5d80176feb3b", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/21e84f30c074cb7ca20165e3e77b5d80176feb3b", "committedDate": "2020-09-19T05:34:33Z", "message": "Force Topic to only store types that it can handle"}, "afterCommit": {"oid": "7face2cde20f973b9c897211db27fdd517d68161", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7face2cde20f973b9c897211db27fdd517d68161", "committedDate": "2020-09-19T06:07:24Z", "message": "Force Topic to only store types that it can handle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18eb928be60906ed53cb0411f8a477f69b222aaa", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/18eb928be60906ed53cb0411f8a477f69b222aaa", "committedDate": "2020-09-21T18:05:18Z", "message": "Force Topic to only store types that it can handle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7face2cde20f973b9c897211db27fdd517d68161", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7face2cde20f973b9c897211db27fdd517d68161", "committedDate": "2020-09-19T06:07:24Z", "message": "Force Topic to only store types that it can handle"}, "afterCommit": {"oid": "18eb928be60906ed53cb0411f8a477f69b222aaa", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/18eb928be60906ed53cb0411f8a477f69b222aaa", "committedDate": "2020-09-21T18:05:18Z", "message": "Force Topic to only store types that it can handle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4cbe7e3b67258cde2b3fa5e03b67b0b8e4ccb09", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a4cbe7e3b67258cde2b3fa5e03b67b0b8e4ccb09", "committedDate": "2020-09-21T20:04:13Z", "message": "Merge branch 'master' into config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a75cbf5ab811278c7254c8cb1dd3a736f9ee5db4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a75cbf5ab811278c7254c8cb1dd3a736f9ee5db4", "committedDate": "2020-09-21T21:03:44Z", "message": "Merge branch 'master' into config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTgxOTM4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/457#pullrequestreview-492981938", "createdAt": "2020-09-21T21:09:02Z", "commit": {"oid": "a4cbe7e3b67258cde2b3fa5e03b67b0b8e4ccb09"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTg4MTAy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/457#pullrequestreview-492988102", "createdAt": "2020-09-21T21:19:40Z", "commit": {"oid": "a75cbf5ab811278c7254c8cb1dd3a736f9ee5db4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMToxOTo0MFrOHVizSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMToxOTo0MFrOHVizSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM1MjMzMQ==", "bodyText": "Not needed for Boolean?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/457#discussion_r492352331", "createdAt": "2020-09-21T21:19:40Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/greengrass/config/Topic.java", "diffHunk": "@@ -72,18 +73,77 @@ public void appendTo(Appendable a) throws IOException {\n         a.append(String.valueOf(value));\n     }\n \n-    public Topic withValue(Object nv) {\n+    public Topic withValueChecked(Object nv) throws UnsupportedInputTypeException {\n+        return withValueChecked(System.currentTimeMillis(), nv);\n+    }\n+\n+    /**\n+     * Set value with checked exception if the type will not store properly.\n+     *\n+     * @param proposedModtime proposed modification time\n+     * @param nv value\n+     * @return this\n+     * @throws UnsupportedInputTypeException if the input value is unsupported\n+     */\n+    public Topic withValueChecked(long proposedModtime, Object nv) throws UnsupportedInputTypeException {\n+        if (nv == null || nv instanceof String || nv instanceof Number || nv instanceof Boolean || nv instanceof List) {\n+            return withNewerValue(proposedModtime, nv);\n+        }\n+        throw new UnsupportedInputTypeException(nv.getClass());\n+    }\n+\n+    private Topic withValue(Object nv) {\n         return withNewerValue(System.currentTimeMillis(), nv);\n     }\n \n+    public Topic withValue(String nv) {\n+        return withValue((Object) nv);\n+    }\n+\n+    public Topic withValue(Number nv) {\n+        return withValue((Object) nv);\n+    }\n+\n+    public Topic withValue(Boolean nv) {\n+        return withValue((Object) nv);\n+    }\n+\n+    public Topic withValue(List<String> nv) {\n+        return withValue((Object) nv);\n+    }\n+\n+    // Because of type erasure, the following overrides need to have different names\n+    public Topic withValueLN(List<Number> nv) {\n+        return withValue(nv);\n+    }\n+\n+    public Topic withValueLB(List<Boolean> nv) {\n+        return withValue(nv);\n+    }\n+\n+    Topic withNewerValue(long proposedModtime, final Object proposed) {\n+        return withNewerValue(proposedModtime, proposed, false);\n+    }\n+\n+    /**\n+     * Set the value of this topic to a new value.\n+     *\n+     * @param proposedModtime the last modified time of the value. If this is in the past, we do not update the value.\n+     * @param proposed        new value.\n+     * @return this.\n+     */\n+    public Topic withNewerValue(long proposedModtime, String proposed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a75cbf5ab811278c7254c8cb1dd3a736f9ee5db4"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDQzNzY0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/457#pullrequestreview-493043764", "createdAt": "2020-09-21T23:17:51Z", "commit": {"oid": "a75cbf5ab811278c7254c8cb1dd3a736f9ee5db4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2992, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}