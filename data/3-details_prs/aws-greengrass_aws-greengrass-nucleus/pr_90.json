{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNTYzMzgx", "number": 90, "title": "Add JUnit 5 Extension to Capture Runtime Metrics", "bodyText": "Issue #, if available:\nDescription of changes:\nCreate junitReport.json file containing runtime metrics from annotated test classes. These metrics include: max heap memory, max off-heap memory, and max loaded classes.\nWhy is this change necessary:\nThis change will enable us to collect metrics from test runs and compare memory usage between runs.\nHow was this change tested:\nAll unit and integ tests are passing and manually verified that the output file is created with proper output.\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-03-02T19:24:58Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90", "merged": true, "mergeCommit": {"oid": "93c5bb15db21e6e1e9ac69bc2dba3f1d4e716d93"}, "closed": true, "closedAt": "2020-03-03T17:56:30Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJy4cFABqjMwODkzMzE1MDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKGIQBAFqTM2ODE5NjQxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e557eb7b82cd1db4c9cf915144b5aaa0625f8b11", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e557eb7b82cd1db4c9cf915144b5aaa0625f8b11", "committedDate": "2020-03-02T19:24:28Z", "message": "Add extension"}, "afterCommit": {"oid": "1586358dae0010deb310948b43862cf114e76e3f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1586358dae0010deb310948b43862cf114e76e3f", "committedDate": "2020-03-02T19:27:18Z", "message": "Add extension"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1586358dae0010deb310948b43862cf114e76e3f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1586358dae0010deb310948b43862cf114e76e3f", "committedDate": "2020-03-02T19:27:18Z", "message": "Add extension"}, "afterCommit": {"oid": "44a03e771de5b1437834517ebb4765efeeee2509", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/44a03e771de5b1437834517ebb4765efeeee2509", "committedDate": "2020-03-02T19:31:21Z", "message": "Add extension"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44a03e771de5b1437834517ebb4765efeeee2509", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/44a03e771de5b1437834517ebb4765efeeee2509", "committedDate": "2020-03-02T19:31:21Z", "message": "Add extension"}, "afterCommit": {"oid": "1a488b70a61b6bfa332a7104e247b4eec1f1a6a8", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a488b70a61b6bfa332a7104e247b4eec1f1a6a8", "committedDate": "2020-03-02T20:03:00Z", "message": "Add extension"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NDgzOTY2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#pullrequestreview-367483966", "createdAt": "2020-03-02T19:56:01Z", "commit": {"oid": "1586358dae0010deb310948b43862cf114e76e3f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxOTo1NjoyM1rOFwtL1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxOTo1NjoyM1rOFwtL1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYxNjI3OA==", "bodyText": "Shouldn't this be true?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#discussion_r386616278", "createdAt": "2020-03-02T19:56:23Z", "author": {"login": "fengwang666"}, "path": "src/test/java/com/aws/iot/evergreen/extension/EGExtension.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.extension;\n+\n+import com.aws.iot.evergreen.util.Utils;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SequenceWriter;\n+import com.fasterxml.jackson.jr.ob.JSON;\n+import com.fasterxml.jackson.jr.ob.JSONObjectException;\n+import com.fasterxml.jackson.jr.ob.ValueIterator;\n+import lombok.AllArgsConstructor;\n+import org.junit.jupiter.api.extension.AfterTestExecutionCallback;\n+import org.junit.jupiter.api.extension.BeforeAllCallback;\n+import org.junit.jupiter.api.extension.BeforeTestExecutionCallback;\n+import org.junit.jupiter.api.extension.Extension;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.lang.management.ClassLoadingMXBean;\n+import java.lang.management.ManagementFactory;\n+import java.lang.management.MemoryMXBean;\n+import java.util.Map;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+public class EGExtension\n+        implements Extension, BeforeAllCallback, BeforeTestExecutionCallback, AfterTestExecutionCallback {\n+    private static final ExtensionContext.Namespace NAMESPACE =\n+            ExtensionContext.Namespace.create(\"com.aws.iot.evergreen.extension\");\n+    private static final ObjectMapper MAPPER = new ObjectMapper();\n+    private static final ScheduledExecutorService exec = new ScheduledThreadPoolExecutor(1);\n+    private static final MemoryMXBean MEMORY_BEAN = ManagementFactory.getMemoryMXBean();\n+    private static final ClassLoadingMXBean CLASS_BEAN = ManagementFactory.getClassLoadingMXBean();\n+    private ScheduledFuture<?> running;\n+    private static volatile boolean calledAlready;\n+    private static File reportFile;\n+\n+    @Override\n+    public void beforeTestExecution(ExtensionContext context) throws Exception {\n+        // Request that we first gc to make sure that we start as small as possible\n+        Runtime.getRuntime().gc();\n+        context.getStore(NAMESPACE).put(context.getDisplayName(), new RuntimeInfo(0, 0, 0));\n+\n+        // Refresh the stats every 50ms, taking the maximum of each value every time\n+        running = exec.scheduleAtFixedRate(() -> context.getStore(NAMESPACE).put(context.getDisplayName(),\n+                ((RuntimeInfo) context.getStore(NAMESPACE).get(context.getDisplayName()))\n+                        .max(new RuntimeInfo(MEMORY_BEAN.getHeapMemoryUsage().getUsed(),\n+                                MEMORY_BEAN.getNonHeapMemoryUsage().getUsed(), CLASS_BEAN.getLoadedClassCount()))), 0,\n+                50, TimeUnit.MILLISECONDS);\n+    }\n+\n+    @Override\n+    public void afterTestExecution(ExtensionContext context) throws Exception {\n+        running.cancel(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44a03e771de5b1437834517ebb4765efeeee2509"}, "originalPosition": 60}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a488b70a61b6bfa332a7104e247b4eec1f1a6a8", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a488b70a61b6bfa332a7104e247b4eec1f1a6a8", "committedDate": "2020-03-02T20:03:00Z", "message": "Add extension"}, "afterCommit": {"oid": "48a3b139e40157dbe2c1bcccae8bd2951d4fbcff", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/48a3b139e40157dbe2c1bcccae8bd2951d4fbcff", "committedDate": "2020-03-02T22:14:23Z", "message": "Add extension"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48a3b139e40157dbe2c1bcccae8bd2951d4fbcff", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/48a3b139e40157dbe2c1bcccae8bd2951d4fbcff", "committedDate": "2020-03-02T22:14:23Z", "message": "Add extension"}, "afterCommit": {"oid": "5d0d88231648fdce739d20e8e9ebed69ce085925", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5d0d88231648fdce739d20e8e9ebed69ce085925", "committedDate": "2020-03-02T22:15:15Z", "message": "Add extension"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d0d88231648fdce739d20e8e9ebed69ce085925", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5d0d88231648fdce739d20e8e9ebed69ce085925", "committedDate": "2020-03-02T22:15:15Z", "message": "Add extension"}, "afterCommit": {"oid": "a47e0f5256c84fa1fb514c8638b48d6770834038", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a47e0f5256c84fa1fb514c8638b48d6770834038", "committedDate": "2020-03-03T00:41:43Z", "message": "Add extension"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjQ0Mjc0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#pullrequestreview-367644274", "createdAt": "2020-03-03T01:19:30Z", "commit": {"oid": "a47e0f5256c84fa1fb514c8638b48d6770834038"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToxOTozMFrOFw1ODw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToyMDowMFrOFw1OmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0NzkxOQ==", "bodyText": "Should you give the extension a more explicit name, since it's about performance metrics?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#discussion_r386747919", "createdAt": "2020-03-03T01:19:30Z", "author": {"login": "wikimonkey"}, "path": "src/test/java/com/aws/iot/evergreen/extension/EGExtension.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.extension;\n+\n+import com.aws.iot.evergreen.util.Utils;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SequenceWriter;\n+import com.fasterxml.jackson.jr.ob.JSON;\n+import com.fasterxml.jackson.jr.ob.JSONObjectException;\n+import com.fasterxml.jackson.jr.ob.ValueIterator;\n+import lombok.AllArgsConstructor;\n+import org.junit.jupiter.api.extension.AfterTestExecutionCallback;\n+import org.junit.jupiter.api.extension.BeforeAllCallback;\n+import org.junit.jupiter.api.extension.BeforeTestExecutionCallback;\n+import org.junit.jupiter.api.extension.Extension;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.lang.management.ClassLoadingMXBean;\n+import java.lang.management.ManagementFactory;\n+import java.lang.management.MemoryMXBean;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+public class EGExtension", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47e0f5256c84fa1fb514c8638b48d6770834038"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0ODA1Ng==", "bodyText": "Can it be private?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#discussion_r386748056", "createdAt": "2020-03-03T01:20:00Z", "author": {"login": "wikimonkey"}, "path": "src/test/java/com/aws/iot/evergreen/extension/EGExtension.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.extension;\n+\n+import com.aws.iot.evergreen.util.Utils;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SequenceWriter;\n+import com.fasterxml.jackson.jr.ob.JSON;\n+import com.fasterxml.jackson.jr.ob.JSONObjectException;\n+import com.fasterxml.jackson.jr.ob.ValueIterator;\n+import lombok.AllArgsConstructor;\n+import org.junit.jupiter.api.extension.AfterTestExecutionCallback;\n+import org.junit.jupiter.api.extension.BeforeAllCallback;\n+import org.junit.jupiter.api.extension.BeforeTestExecutionCallback;\n+import org.junit.jupiter.api.extension.Extension;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.lang.management.ClassLoadingMXBean;\n+import java.lang.management.ManagementFactory;\n+import java.lang.management.MemoryMXBean;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+public class EGExtension\n+        implements Extension, BeforeAllCallback, BeforeTestExecutionCallback, AfterTestExecutionCallback {\n+    private static final ExtensionContext.Namespace NAMESPACE =\n+            ExtensionContext.Namespace.create(\"com.aws.iot.evergreen.extension\");\n+    private static final ObjectMapper MAPPER = new ObjectMapper();\n+    private static final ScheduledExecutorService exec = new ScheduledThreadPoolExecutor(1);\n+    private static final MemoryMXBean MEMORY_BEAN = ManagementFactory.getMemoryMXBean();\n+    private static final ClassLoadingMXBean CLASS_BEAN = ManagementFactory.getClassLoadingMXBean();\n+    private ScheduledFuture<?> running;\n+    private static File reportFile;\n+\n+    @Override\n+    public void beforeTestExecution(ExtensionContext context) throws Exception {\n+        // Request that we first gc to make sure that we start as small as possible\n+        Runtime.getRuntime().gc();\n+        context.getStore(NAMESPACE).put(context.getDisplayName(), new LinkedList<RuntimeInfo>());\n+\n+        // Refresh the stats every 50ms, taking the maximum of each value every time\n+        running = exec.scheduleAtFixedRate(() -> {\n+            ((List<RuntimeInfo>) context.getStore(NAMESPACE).get(context.getDisplayName()))\n+                    .add(new RuntimeInfo(MEMORY_BEAN.getHeapMemoryUsage().getUsed(),\n+                            MEMORY_BEAN.getNonHeapMemoryUsage().getUsed(), CLASS_BEAN.getLoadedClassCount()));\n+        }, 0, 50, TimeUnit.MILLISECONDS);\n+    }\n+\n+    @Override\n+    public void afterTestExecution(ExtensionContext context) throws Exception {\n+        running.cancel(false);\n+        List<RuntimeInfo> infoList = (List<RuntimeInfo>) context.getStore(NAMESPACE).get(context.getDisplayName());\n+        double maxHeapMemoryMB = infoList.stream().mapToLong(x -> x.heapMemory).max().getAsLong() / 1024.0 / 1024.0;\n+        double maxNonHeapMemoryMB =\n+                infoList.stream().mapToLong(x -> x.nonHeapMemory).max().getAsLong() / 1024.0 / 1024.0;\n+        long maxLoadedClassCount = infoList.stream().mapToLong(x -> x.loadedClassCount).max().getAsLong();\n+\n+        double avgHeapMemoryMB =\n+                infoList.stream().mapToLong(x -> x.heapMemory).average().getAsDouble() / 1024.0 / 1024.0;\n+        double avgNonHeapMemoryMB =\n+                infoList.stream().mapToLong(x -> x.nonHeapMemory).average().getAsDouble() / 1024.0 / 1024.0;\n+        double avgLoadedClassCount = infoList.stream().mapToLong(x -> x.loadedClassCount).average().getAsDouble();\n+\n+        Map<String, String> map = Utils.immutableMap(\"name\", context.getRequiredTestMethod().getName(), \"classname\",\n+                context.getRequiredTestClass().getName(), \"maxHeapMemoryMB\", maxHeapMemoryMB, \"maxNonHeapMemoryMB\",\n+                maxNonHeapMemoryMB, \"maxLoadedClassCount\", maxLoadedClassCount, \"avgHeapMemoryMB\", avgHeapMemoryMB,\n+                \"avgNonHeapMemoryMB\", avgNonHeapMemoryMB, \"avgLoadedClassCount\", avgLoadedClassCount);\n+\n+        ValueIterator<?> existing = null;\n+        try {\n+            existing = JSON.std.anySequenceFrom(reportFile);\n+        } catch (JSONObjectException ignored) {\n+        }\n+\n+        try (FileWriter fileWriter = new FileWriter(reportFile, false);\n+             SequenceWriter seqWriter = MAPPER.writer().writeValuesAsArray(fileWriter)) {\n+            if (existing != null) {\n+                seqWriter.writeAll(existing.readAll());\n+            }\n+            seqWriter.write(map);\n+        }\n+    }\n+\n+    @Override\n+    public void beforeAll(ExtensionContext context) throws Exception {\n+        File surefireReportDir = new File(System.getProperty(\"surefireReportDir\", \"target/surefire-reports\"));\n+        if (!surefireReportDir.exists()) {\n+            surefireReportDir.mkdirs();\n+        }\n+\n+        reportFile = surefireReportDir.toPath().resolve(\"junitReport.json\").toFile();\n+        if (!reportFile.exists()) {\n+            reportFile.createNewFile();\n+        }\n+    }\n+\n+    @AllArgsConstructor\n+    static class RuntimeInfo {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a47e0f5256c84fa1fb514c8638b48d6770834038"}, "originalPosition": 108}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a47e0f5256c84fa1fb514c8638b48d6770834038", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a47e0f5256c84fa1fb514c8638b48d6770834038", "committedDate": "2020-03-03T00:41:43Z", "message": "Add extension"}, "afterCommit": {"oid": "822d3dd80eac9d964086cae9d326bba809894387", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/822d3dd80eac9d964086cae9d326bba809894387", "committedDate": "2020-03-03T01:45:11Z", "message": "Add extension"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjU2NjY2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#pullrequestreview-367656666", "createdAt": "2020-03-03T01:59:31Z", "commit": {"oid": "a47e0f5256c84fa1fb514c8638b48d6770834038"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMjowMjo0NFrOFw189Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMjowMzozM1rOFw193w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1OTkyNQ==", "bodyText": "Hm what's the difference with @BeforeAll in Performance?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#discussion_r386759925", "createdAt": "2020-03-03T02:02:44Z", "author": {"login": "ShirleyZheng92"}, "path": "src/test/java/com/aws/iot/evergreen/extension/InitTest.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.extension;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+\n+public class InitTest {\n+    // This test case runs once per test suite execution before the suite starts.\n+    // Put logic here which should run only once before all tests.\n+    @Test\n+    public void init() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "822d3dd80eac9d964086cae9d326bba809894387"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1OTk5MA==", "bodyText": "Maybe name to InitTestSuite?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#discussion_r386759990", "createdAt": "2020-03-03T02:02:56Z", "author": {"login": "ShirleyZheng92"}, "path": "src/test/java/com/aws/iot/evergreen/extension/InitTest.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.extension;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+\n+public class InitTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "822d3dd80eac9d964086cae9d326bba809894387"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc2MDE1OQ==", "bodyText": "rename to performanceResultMap or perfResultMap", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#discussion_r386760159", "createdAt": "2020-03-03T02:03:33Z", "author": {"login": "ShirleyZheng92"}, "path": "src/test/java/com/aws/iot/evergreen/extension/PerformanceReporting.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.extension;\n+\n+import com.aws.iot.evergreen.util.Utils;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SequenceWriter;\n+import com.fasterxml.jackson.jr.ob.JSON;\n+import com.fasterxml.jackson.jr.ob.JSONObjectException;\n+import com.fasterxml.jackson.jr.ob.ValueIterator;\n+import lombok.AllArgsConstructor;\n+import org.junit.jupiter.api.extension.AfterTestExecutionCallback;\n+import org.junit.jupiter.api.extension.BeforeAllCallback;\n+import org.junit.jupiter.api.extension.BeforeTestExecutionCallback;\n+import org.junit.jupiter.api.extension.Extension;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.lang.management.ClassLoadingMXBean;\n+import java.lang.management.ManagementFactory;\n+import java.lang.management.MemoryMXBean;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+\n+public class PerformanceReporting\n+        implements Extension, BeforeAllCallback, BeforeTestExecutionCallback, AfterTestExecutionCallback {\n+    private static final ExtensionContext.Namespace NAMESPACE =\n+            ExtensionContext.Namespace.create(\"com.aws.iot.evergreen.extension\");\n+    private static final ObjectMapper MAPPER = new ObjectMapper();\n+    private static final ScheduledExecutorService exec = new ScheduledThreadPoolExecutor(1);\n+    private static final MemoryMXBean MEMORY_BEAN = ManagementFactory.getMemoryMXBean();\n+    private static final ClassLoadingMXBean CLASS_BEAN = ManagementFactory.getClassLoadingMXBean();\n+    private ScheduledFuture<?> running;\n+    private static File reportFile;\n+\n+    @Override\n+    public void beforeTestExecution(ExtensionContext context) throws Exception {\n+        // Request that we first gc to make sure that we start as small as possible\n+        Runtime.getRuntime().gc();\n+        context.getStore(NAMESPACE).put(context.getDisplayName(), new LinkedList<RuntimeInfo>());\n+\n+        // Refresh the stats every 50ms, taking the maximum of each value every time\n+        running = exec.scheduleAtFixedRate(() -> {\n+            ((List<RuntimeInfo>) context.getStore(NAMESPACE).get(context.getDisplayName()))\n+                    .add(new RuntimeInfo(MEMORY_BEAN.getHeapMemoryUsage().getUsed(),\n+                            MEMORY_BEAN.getNonHeapMemoryUsage().getUsed(), CLASS_BEAN.getLoadedClassCount()));\n+        }, 0, 50, TimeUnit.MILLISECONDS);\n+    }\n+\n+    @Override\n+    public void afterTestExecution(ExtensionContext context) throws Exception {\n+        running.cancel(false);\n+        List<RuntimeInfo> infoList = (List<RuntimeInfo>) context.getStore(NAMESPACE).get(context.getDisplayName());\n+        double maxHeapMemoryMB = infoList.stream().mapToLong(x -> x.heapMemory).max().getAsLong() / 1024.0 / 1024.0;\n+        double maxNonHeapMemoryMB =\n+                infoList.stream().mapToLong(x -> x.nonHeapMemory).max().getAsLong() / 1024.0 / 1024.0;\n+        long maxLoadedClassCount = infoList.stream().mapToLong(x -> x.loadedClassCount).max().getAsLong();\n+\n+        double avgHeapMemoryMB =\n+                infoList.stream().mapToLong(x -> x.heapMemory).average().getAsDouble() / 1024.0 / 1024.0;\n+        double avgNonHeapMemoryMB =\n+                infoList.stream().mapToLong(x -> x.nonHeapMemory).average().getAsDouble() / 1024.0 / 1024.0;\n+        double avgLoadedClassCount = infoList.stream().mapToLong(x -> x.loadedClassCount).average().getAsDouble();\n+\n+        Map<String, String> map = Utils.immutableMap(\"name\", context.getRequiredTestMethod().getName(), \"classname\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "822d3dd80eac9d964086cae9d326bba809894387"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95f38d4c4e5e3795c3967d68e6640de259944be4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/95f38d4c4e5e3795c3967d68e6640de259944be4", "committedDate": "2020-03-03T02:08:38Z", "message": "Add extension"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "822d3dd80eac9d964086cae9d326bba809894387", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/822d3dd80eac9d964086cae9d326bba809894387", "committedDate": "2020-03-03T01:45:11Z", "message": "Add extension"}, "afterCommit": {"oid": "95f38d4c4e5e3795c3967d68e6640de259944be4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/95f38d4c4e5e3795c3967d68e6640de259944be4", "committedDate": "2020-03-03T02:08:38Z", "message": "Add extension"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjY0MzY0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#pullrequestreview-367664364", "createdAt": "2020-03-03T02:25:44Z", "commit": {"oid": "95f38d4c4e5e3795c3967d68e6640de259944be4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MTk2NDE3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/90#pullrequestreview-368196417", "createdAt": "2020-03-03T17:53:46Z", "commit": {"oid": "95f38d4c4e5e3795c3967d68e6640de259944be4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2290, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}