{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNzgzMDU3", "number": 532, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMzo1NzoyMFrOEtxFtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMzozN1rOEtxUtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2NDI1NjU0OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMzo1NzoyMFrOHhv5cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMzo1NzoyMFrOHhv5cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE0OTgxMQ==", "bodyText": "Does this test need to be so long? This will slow everyone down. Can you increase the publish interval for testing like we've done for deployment polling?\nBy decreasing the deployment polling from 15 seconds to 1 second our e2e tests cut in more than half from over 20 minutes to around 12.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505149811", "createdAt": "2020-10-15T03:57:20Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -105,37 +101,30 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch fssPublishLatch = new CountDownLatch(1);\n-        logListener = eslm -> {\n-            if (eslm.getEventType() != null && eslm.getEventType().equals(\"fss-status-update-published\")\n-                    && eslm.getMessage().equals(\"Status update published to FSS\")) {\n-                fssPublishLatch.countDown();\n-            }\n-        };\n-        Slf4jLogAdapter.addGlobalListener(logListener);\n \n-        assertTrue(fssPublishLatch.await(40, TimeUnit.SECONDS));\n+        // Sleep for more time than the FSS publish interval so that we have all the data.\n+        TimeUnit.SECONDS.sleep(50);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95b663a18d29d360df3ec4f839f1d35782552dae"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2NDI5MTM2OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/resources/com/aws/greengrass/integrationtests/status/smallPeriodicIntervalConfig.yaml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMToyOVrOHhwNzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMjoxNFrOHhwOmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1NTAyMg==", "bodyText": "you're undoing your previous commit with this change\nhttps://github.com/aws/aws-greengrass-kernel/pull/529/files#diff-7289cfb6dadb15e34f5e9e655b451e930d7d48c2d18e035c5e7f26faa8061eb7L9", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505155022", "createdAt": "2020-10-15T04:21:29Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/resources/com/aws/greengrass/integrationtests/status/smallPeriodicIntervalConfig.yaml", "diffHunk": "@@ -6,4 +6,4 @@ services:\n         all: echo All installed\n   FleetStatusService:\n     parameters:\n-      periodicUpdateIntervalSec: 30\n+      periodicUpdateIntervalSec: 10", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1NTIyNg==", "bodyText": "Yep. I thought it would have fixed it. But this change will/should handle both the error cases...", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505155226", "createdAt": "2020-10-15T04:22:14Z", "author": {"login": "nikkhilmuthye"}, "path": "src/integrationtests/resources/com/aws/greengrass/integrationtests/status/smallPeriodicIntervalConfig.yaml", "diffHunk": "@@ -6,4 +6,4 @@ services:\n         all: echo All installed\n   FleetStatusService:\n     parameters:\n-      periodicUpdateIntervalSec: 30\n+      periodicUpdateIntervalSec: 10", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1NTAyMg=="}, "originalCommit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2NDI5NDc5OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMzozMVrOHhwPww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMzozMVrOHhwPww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1NTUyMw==", "bodyText": "return CompletableFuture.completeFuture(0) so the future has completed", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505155523", "createdAt": "2020-10-15T04:23:31Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -105,37 +100,41 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch fssPublishLatch = new CountDownLatch(1);\n-        logListener = eslm -> {\n-            if (eslm.getEventType() != null && eslm.getEventType().equals(\"fss-status-update-published\")\n-                    && eslm.getMessage().equals(\"Status update published to FSS\")) {\n-                fssPublishLatch.countDown();\n+        CountDownLatch allComponentsInFssUpdate = new CountDownLatch(1);\n+\n+        when(mqttClient.publish(captor.capture())).thenAnswer(i -> {\n+            Object argument = i.getArgument(0);\n+            PublishRequest publishRequest = (PublishRequest) argument;\n+            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n+                    FleetStatusDetails.class);\n+            if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n+                allComponentsInFssUpdate.countDown();\n             }\n-        };\n-        Slf4jLogAdapter.addGlobalListener(logListener);\n+            return new CompletableFuture<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2NDI5NDkyOnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMzozN1rOHhwP3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNDoyMzozN1rOHhwP3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1NTU1MQ==", "bodyText": "Nice!", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/532#discussion_r505155551", "createdAt": "2020-10-15T04:23:37Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/status/PeriodicFleetStatusServiceTest.java", "diffHunk": "@@ -105,37 +100,41 @@ void GIVEN_config_with_small_periodic_interval_WHEN_interval_elapses_THEN_status\n         ((Map) kernel.getContext().getvIfExists(Kernel.SERVICE_TYPE_TO_CLASS_MAP_KEY).get()).put(\"plugin\",\n                 GreengrassService.class.getName());\n         assertNotNull(deviceConfiguration.getThingName());\n-        CountDownLatch fssPublishLatch = new CountDownLatch(1);\n-        logListener = eslm -> {\n-            if (eslm.getEventType() != null && eslm.getEventType().equals(\"fss-status-update-published\")\n-                    && eslm.getMessage().equals(\"Status update published to FSS\")) {\n-                fssPublishLatch.countDown();\n+        CountDownLatch allComponentsInFssUpdate = new CountDownLatch(1);\n+\n+        when(mqttClient.publish(captor.capture())).thenAnswer(i -> {\n+            Object argument = i.getArgument(0);\n+            PublishRequest publishRequest = (PublishRequest) argument;\n+            FleetStatusDetails fleetStatusDetails = OBJECT_MAPPER.readValue(publishRequest.getPayload(),\n+                    FleetStatusDetails.class);\n+            if (componentNamesToCheck.size() == fleetStatusDetails.getComponentStatusDetails().size()) {\n+                allComponentsInFssUpdate.countDown();\n             }\n-        };\n-        Slf4jLogAdapter.addGlobalListener(logListener);\n+            return new CompletableFuture<>();\n+        });\n \n-        assertTrue(fssPublishLatch.await(40, TimeUnit.SECONDS));\n-        verify(mqttClient, atLeastOnce()).publish(captor.capture());\n+        // Wait for some time for the publish request to have all the components update.\n+        assertTrue(allComponentsInFssUpdate.await(20, TimeUnit.SECONDS));\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63442d4017dab23c41b492d5a9aa7b2c27d1cbca"}, "originalPosition": 60}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 679, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}