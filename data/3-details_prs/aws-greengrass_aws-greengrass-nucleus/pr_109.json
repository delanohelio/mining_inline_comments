{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2OTUyMDIy", "number": 109, "title": "Refine deduplicating logic in lifecycle change requests.", "bodyText": "When a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected.\nIssue #, if available:\nDescription of changes:\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-03-11T22:34:40Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109", "merged": true, "mergeCommit": {"oid": "9af750515537bc80a36f993aa23d99886a3eb94e"}, "closed": true, "closedAt": "2020-03-16T20:54:39Z", "author": {"login": "ShirleyZheng92"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMv-I3gFqTM3MzE5NzM0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOnbHMAFqTM3NjMxOTU3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTk3MzQy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-373197342", "createdAt": "2020-03-11T23:43:30Z", "commit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMzo0MzozMFrOF1M9Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMzo0NToxOVrOF1M_FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTEwNw==", "bodyText": "Why is this no longer threadsafe?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391331107", "createdAt": "2020-03-11T23:43:30Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -287,30 +287,30 @@ public boolean isPeriodic() {\n     }\n \n     private Optional<State> peekOrRemoveFirstDesiredState(State activeState) {\n-        if (desiredStateList.isEmpty()) {\n-            return Optional.empty();\n-        }\n-        State first = desiredStateList.get(0);\n-        if (first == activeState) {\n-            desiredStateList.remove(first);\n-            // ignore remove() return value as it's possible that desiredStateList update\n+        synchronized (desiredStateList) {\n+            if (desiredStateList.isEmpty()) {\n+                return Optional.empty();\n+            }\n+            State first = desiredStateList.get(0);\n+            if (first == activeState) {\n+                desiredStateList.remove(first);\n+                // ignore remove() return value as it's possible that desiredStateList update\n+            }\n+            return Optional.ofNullable(first);\n         }\n-        return Optional.ofNullable(first);\n     }\n \n     // Set desiredStateList and override existing desiredStateList.\n-    // Expect to have multi-thread access\n-    private synchronized void setDesiredState(State... state) {\n-        synchronized (desiredStateList) {\n-            List<State> newStateList = Arrays.asList(state);\n-            if (newStateList.equals(desiredStateList)) {\n-                return;\n-            }\n-            desiredStateList.clear();\n-            desiredStateList.addAll(newStateList);\n-            // try insert to the queue, if queue full doesn't block.\n-            enqueueStateEvent(\"DesiredStateUpdated\");\n+    // Not thread safe.\n+    private void setDesiredState(State... state) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTI5MA==", "bodyText": "make these all final as services should not be overriding their implementations.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391331290", "createdAt": "2020-03-11T23:44:04Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -332,28 +332,60 @@ private synchronized void enqueueStateEvent(Object event) {\n      * Start Service.\n      */\n     public void requestStart() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzMTYwNQ==", "bodyText": "Once you've set the desired state, isn't this done? Should it return from here?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391331605", "createdAt": "2020-03-11T23:45:19Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -332,28 +332,60 @@ private synchronized void enqueueStateEvent(Object event) {\n      * Start Service.\n      */\n     public void requestStart() {\n-        setDesiredState(State.RUNNING);\n+        synchronized (this.desiredStateList) {\n+            if (this.desiredStateList.isEmpty()) {\n+                this.setDesiredState(State.RUNNING);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjA0NTgz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-373204583", "createdAt": "2020-03-12T00:07:04Z", "commit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMDowNzowNFrOF1NW6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMDowNzowNFrOF1NW6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzNzcwNw==", "bodyText": "THEN?\nMissing the \"THEN\" clause for all these tests.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391337707", "createdAt": "2020-03-12T00:07:04Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/kernel/RequestLifecycleChangeTest.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import java.lang.reflect.Field;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGServiceTestUtil;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Assertions;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class RequestLifecycleChangeTest extends EGServiceTestUtil {\n+\n+    private EvergreenService evergreenService;\n+\n+    private static Field desiredStateListField;\n+    private List<State> desiredStateList;\n+\n+    @BeforeAll\n+    public static void setup() throws Exception {\n+        desiredStateListField = EvergreenService.class.getDeclaredField(\"desiredStateList\");\n+        desiredStateListField.setAccessible(true);\n+    }\n+\n+    @BeforeEach\n+    void beforeEach() throws Exception {\n+        Topics config = initializeMockedConfig();\n+        evergreenService = new EvergreenService(config);\n+        desiredStateList = (List<State>) desiredStateListField.get(evergreenService);\n+    }\n+\n+    @Test\n+    public void GIVEN_evergreenService_WHEN_requestStart_called() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNzgxOTA0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-373781904", "createdAt": "2020-03-12T17:58:51Z", "commit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNzo1ODo1MVrOF1pYxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNzo1ODo1MVrOF1pYxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5NjkzMg==", "bodyText": "I see you are making changes to sync strategy, can we have some documentation at the class level on the sycn strategy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391796932", "createdAt": "2020-03-12T17:58:51Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -357,28 +332,60 @@ private synchronized void enqueueStateEvent(Object event) {\n      * Start Service.\n      */\n     public void requestStart() {\n-        setDesiredState(State.RUNNING);\n+        synchronized (this.desiredStateList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "originalPosition": 248}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNzk4NzQ3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-373798747", "createdAt": "2020-03-12T18:23:00Z", "commit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODoyMzowMVrOF1qL6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODoyMzowMVrOF1qL6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgxMDAyNQ==", "bodyText": "shouldn't this be deleted?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391810025", "createdAt": "2020-03-12T18:23:01Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/state/UpdatingKernelState.java", "diffHunk": "@@ -58,8 +60,10 @@ public void proceed() throws DeploymentFailureException {\n         }\n \n         // merge config\n-        Map<Object, Object> resolvedConfig = deploymentContext.getResolvedKernelConfig();\n+        Map<Object, Object> resolvedConfig = new HashMap<>();\n+        resolvedConfig.put(EvergreenService.SERVICES_NAMESPACE_TOPIC, deploymentContext.getResolvedKernelConfig());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczOTE1MzUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-373915353", "createdAt": "2020-03-12T21:28:16Z", "commit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMToyODoxNlrOF1wANA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMToyODoxNlrOF1wANA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNTMzMg==", "bodyText": "Let's just fix the safe system update instead of putting in these hacks here. That service should either stay in running, or go to finished, or be periodic. However we do it, this is not the way to fix it.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391905332", "createdAt": "2020-03-12T21:28:16Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -280,10 +282,19 @@ public Kernel launch() {\n             context.put(ShellRunner.class, context.get(ShellRunner.Dryrun.class));\n         }\n         try {\n-            EvergreenService main = getMain(); // Trigger boot  (!?!?)\n+            mainService = getMain();\n             autostart.forEach(s -> {\n                 try {\n-                    main.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                    if (!s.contains(\"SafeSystemUpdate\")) {\n+                        mainService.addDependency(EvergreenService.locate(context, s), State.RUNNING);\n+                    } else {\n+                        // SafeSystemUpdate will reset to Installed after update.\n+                        // This is a hacky way to avoid restarting depending services.\n+                        // TODO: Find a proper way handle this situation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczOTE2MjEy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-373916212", "createdAt": "2020-03-12T21:29:52Z", "commit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMToyOTo1M1rOF1wFAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMToyOTo1M1rOF1wFAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwNjU2Mg==", "bodyText": "This should be static if possible because it should not be specific to an individual service; our config is global.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391906562", "createdAt": "2020-03-12T21:29:53Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -565,6 +580,10 @@ private void addServiceSearchURL(Object url) {\n         }\n     }\n \n+    public Topics findServiceTopic(String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczOTE3NTU1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-373917555", "createdAt": "2020-03-12T21:32:27Z", "commit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMTozMjoyN1rOF1wNLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMTozMjoyN1rOF1wNLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwODY1NA==", "bodyText": "newly created service don't auto-start, so this todo is not true. The requestStart is required only for new services.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r391908654", "createdAt": "2020-03-12T21:32:27Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -597,16 +624,17 @@ private void addServiceSearchURL(Object url) {\n                 try {\n                     mergeMap(timestamp, newConfig);\n                     context.addGlobalStateChangeListener(listener);\n-\n-                    newConfig.keySet().forEach(serviceName -> {\n-                        EvergreenService eg = EvergreenService.locate(context, (String) serviceName);\n-                        if (eg == null) {\n-                            logger.error(\"Could not locate EvergreenService for modified service {}\", serviceName);\n-                        } else if (State.NEW.equals(eg.getState())) {\n+                    serviceConfig.keySet().forEach(serviceName -> {\n+                        try {\n+                            EvergreenService eg = EvergreenService.locate(context, serviceName);\n+                            // TODO: remove requestStart here as each service will handle update behavior based on", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8"}, "originalPosition": 123}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f08bd5d402f5203ce975be538f8adebeb2e12ff8", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f08bd5d402f5203ce975be538f8adebeb2e12ff8", "committedDate": "2020-03-11T22:28:39Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}, "afterCommit": {"oid": "c82c527b8644431e5f5c2227ff479cd7a7459905", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c82c527b8644431e5f5c2227ff479cd7a7459905", "committedDate": "2020-03-12T21:28:07Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c82c527b8644431e5f5c2227ff479cd7a7459905", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c82c527b8644431e5f5c2227ff479cd7a7459905", "committedDate": "2020-03-12T21:28:07Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}, "afterCommit": {"oid": "3cdc55b6f3a9d45eef24fd579c6a0a5b3d9ab648", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3cdc55b6f3a9d45eef24fd579c6a0a5b3d9ab648", "committedDate": "2020-03-13T18:03:41Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3cdc55b6f3a9d45eef24fd579c6a0a5b3d9ab648", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3cdc55b6f3a9d45eef24fd579c6a0a5b3d9ab648", "committedDate": "2020-03-13T18:03:41Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}, "afterCommit": {"oid": "4994c3ae60f243b34371f00c7b44eef8fd3112fa", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4994c3ae60f243b34371f00c7b44eef8fd3112fa", "committedDate": "2020-03-13T19:12:28Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4994c3ae60f243b34371f00c7b44eef8fd3112fa", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4994c3ae60f243b34371f00c7b44eef8fd3112fa", "committedDate": "2020-03-13T19:12:28Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}, "afterCommit": {"oid": "a9d49488a9474c8d21acf59da8c6494808b302d8", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a9d49488a9474c8d21acf59da8c6494808b302d8", "committedDate": "2020-03-13T19:15:32Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTU3MjU0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-374557254", "createdAt": "2020-03-13T19:26:34Z", "commit": {"oid": "a9d49488a9474c8d21acf59da8c6494808b302d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTY5NjQ3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-374569647", "createdAt": "2020-03-13T19:50:56Z", "commit": {"oid": "a9d49488a9474c8d21acf59da8c6494808b302d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9d49488a9474c8d21acf59da8c6494808b302d8", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a9d49488a9474c8d21acf59da8c6494808b302d8", "committedDate": "2020-03-13T19:15:32Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}, "afterCommit": {"oid": "f992c80775fb9e166eda0e864e146a9a8f5b2728", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f992c80775fb9e166eda0e864e146a9a8f5b2728", "committedDate": "2020-03-16T19:15:30Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTE4NzQ1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-375518745", "createdAt": "2020-03-16T19:22:24Z", "commit": {"oid": "f992c80775fb9e166eda0e864e146a9a8f5b2728"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxOToyMjoyNFrOF3CrdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxOToyMjoyNFrOF3CrdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI1OTg5Mg==", "bodyText": "How about a blocking queue instead of wait/notify? Since we have a list of actions to perform anyway.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r393259892", "createdAt": "2020-03-16T19:22:24Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -59,8 +59,8 @@ public void removeDisruptableCheck(DisruptableCheck d) {\n     public synchronized void addUpdateAction(String tag, Crashable action) {\n         pendingActions.put(tag, action);\n         logger.atDebug().setEventType(\"register-service-update-action\").addKeyValue(\"action\", tag).log();\n-        if (!isPeriodic()) {\n-            requestStart();\n+        synchronized (pendingActions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f992c80775fb9e166eda0e864e146a9a8f5b2728"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f992c80775fb9e166eda0e864e146a9a8f5b2728", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f992c80775fb9e166eda0e864e146a9a8f5b2728", "committedDate": "2020-03-16T19:15:30Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}, "afterCommit": {"oid": "276539e1146220454e73b92355b20c3a1c0a2c91", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/276539e1146220454e73b92355b20c3a1c0a2c91", "committedDate": "2020-03-16T19:27:03Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9", "committedDate": "2020-03-16T19:27:29Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "276539e1146220454e73b92355b20c3a1c0a2c91", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/276539e1146220454e73b92355b20c3a1c0a2c91", "committedDate": "2020-03-16T19:27:03Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}, "afterCommit": {"oid": "1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9", "committedDate": "2020-03-16T19:27:29Z", "message": "Refine deduplicating logic in lifecycle change requests.\n\nWhen a service receives restart and start in sequence, 'start' may override the 'restart'.\nThis can cause merge-config doesn't restart service as expected."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTQxODA0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-375541804", "createdAt": "2020-03-16T19:58:23Z", "commit": {"oid": "1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MzE3Nzg0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-376317784", "createdAt": "2020-03-17T18:54:22Z", "commit": {"oid": "1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxODo1NDoyMlrOF3pzkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxODo1NDoyMlrOF3pzkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkwMDk0Ng==", "bodyText": "I know EvergreenService class is special but I still think we should avoid testing with checking an private field. As Jamie said,\n\nplease don\u2019t write unit tests that are \u201cIs the code implemented this way\u201d.\n\nChecking a private field basically makes the code needs to be implemented in a very particular way.\nMoreover, changing the content of a private field during the test actually changes the logic of real code, which defeats the purpose of unit test...", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#discussion_r393900946", "createdAt": "2020-03-17T18:54:22Z", "author": {"login": "leaf94"}, "path": "src/test/java/com/aws/iot/evergreen/kernel/RequestLifecycleChangeTest.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package com.aws.iot.evergreen.kernel;\n+\n+import java.lang.reflect.Field;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import com.aws.iot.evergreen.config.Topic;\n+import com.aws.iot.evergreen.config.Topics;\n+import com.aws.iot.evergreen.dependency.Context;\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGServiceTestUtil;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.Assertions;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class RequestLifecycleChangeTest extends EGServiceTestUtil {\n+\n+    private EvergreenService evergreenService;\n+\n+    private static Field desiredStateListField;\n+    private List<State> desiredStateList;\n+\n+    @BeforeAll\n+    public static void setup() throws Exception {\n+        desiredStateListField = EvergreenService.class.getDeclaredField(\"desiredStateList\");\n+        desiredStateListField.setAccessible(true);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MzE5NTcy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/109#pullrequestreview-376319572", "createdAt": "2020-03-17T18:56:56Z", "commit": {"oid": "1e2f186de35b3eefa3e8ad4038d487f4f8d3d9b9"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2330, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}