{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNTgzNjg2", "number": 527, "title": "Fix problem with unarchiving being skipped for local artifacts ", "bodyText": "Remove early check for if component download is required to fix UAT regression\nIssue #, if available:\nDescription of changes:\nUATs that use a local only public component artifact are failing because the recently added early downloadRequired? check skips unarchiving too.\nNOTES- In order to do this early check right, we also need filename and for public components, artifact filename needs to be derived from the content-disposition header. It's still buggy as it is because we fallback on the public component artifact uri's scheme specific part when the artifact doesb't exist in cloud here - https://github.com/aws/aws-greengrass-kernel/blob/5d5e55cba4bfae50bfbd47edcff573f32eb39770/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java#L123 This is in conflict with how we get filename in the happy case when the artifact does exist in cloud here - https://github.com/aws/aws-greengrass-kernel/blob/5d5e55cba4bfae50bfbd47edcff573f32eb39770/src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java#L201 . This needs to be sorted out as a follow up\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-14T19:13:15Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527", "merged": true, "mergeCommit": {"oid": "9b4171e752a0399ad2325925743ea8122b8cad89"}, "closed": true, "closedAt": "2020-10-14T22:56:22Z", "author": {"login": "shaguptashaikh"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSiM5iAFqTUwODY1NDc5Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSk9G4AH2gAyNTAzNTgzNjg2OjUyYzUwNzYxZmUyYTk4YmZhNWM4Yzg4NjYzMWU0ODlkYTY0YmUzMzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjU0Nzk2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#pullrequestreview-508654796", "createdAt": "2020-10-14T19:18:44Z", "commit": {"oid": "5c32276765e91091d97bed5c67fa70c613d20320"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NjkwNDgz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#pullrequestreview-508690483", "createdAt": "2020-10-14T20:09:16Z", "commit": {"oid": "8776020e8a37fedf49280b784322bd8bef1b40e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDowOToxN1rOHhjQmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDowOToxN1rOHhjQmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk0Mjc0NA==", "bodyText": "missing space in log message", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504942744", "createdAt": "2020-10-14T20:09:17Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -149,6 +149,10 @@ public long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentAr\n             return length;\n         } catch (IOException e) {\n             throw new PackageDownloadException(\"Failed to get download size\", e);\n+        } catch (PackageDownloadException e) {\n+            logger.atWarn(\"get-download-size-from-greengrass-repo\").log(\"failed getting size.\"\n+                    + \"continuing assuming size is 0\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8776020e8a37fedf49280b784322bd8bef1b40e5"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a27e0c39d4181f7f84f301e3d7e45b16a2c4b30", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a27e0c39d4181f7f84f301e3d7e45b16a2c4b30", "committedDate": "2020-10-14T20:10:52Z", "message": "Merge branch 'master' into unarchive-fix"}, "afterCommit": {"oid": "2ef1c4ed469e7e424bbd980791f92c68ea243a24", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ef1c4ed469e7e424bbd980791f92c68ea243a24", "committedDate": "2020-10-14T20:33:41Z", "message": "Remove early check for if component download is required to fix UAT regression"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ef1c4ed469e7e424bbd980791f92c68ea243a24", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ef1c4ed469e7e424bbd980791f92c68ea243a24", "committedDate": "2020-10-14T20:33:41Z", "message": "Remove early check for if component download is required to fix UAT regression"}, "afterCommit": {"oid": "ab0d1c114a700cdda35ce79d382d98fad2bc4c45", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ab0d1c114a700cdda35ce79d382d98fad2bc4c45", "committedDate": "2020-10-14T20:34:56Z", "message": "Fix problem with unarchiving being skipped for local artifacts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13ed7028ba0cd23eea89ae97cb907cb9fe455dbd", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/13ed7028ba0cd23eea89ae97cb907cb9fe455dbd", "committedDate": "2020-10-14T20:43:29Z", "message": "Fix problem with unarchiving being skipped for local artifacts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab0d1c114a700cdda35ce79d382d98fad2bc4c45", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ab0d1c114a700cdda35ce79d382d98fad2bc4c45", "committedDate": "2020-10-14T20:34:56Z", "message": "Fix problem with unarchiving being skipped for local artifacts"}, "afterCommit": {"oid": "13ed7028ba0cd23eea89ae97cb907cb9fe455dbd", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/13ed7028ba0cd23eea89ae97cb907cb9fe455dbd", "committedDate": "2020-10-14T20:43:29Z", "message": "Fix problem with unarchiving being skipped for local artifacts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzE1Mzk2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#pullrequestreview-508715396", "createdAt": "2020-10-14T20:46:41Z", "commit": {"oid": "13ed7028ba0cd23eea89ae97cb907cb9fe455dbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDo0Njo0MVrOHhkcJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMDo0Njo0MVrOHhkcJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2MjA4NQ==", "bodyText": "this isn't getting the size?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504962085", "createdAt": "2020-10-14T20:46:41Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/ArtifactDownloader.java", "diffHunk": "@@ -144,13 +144,26 @@ public abstract File downloadToPath(ComponentIdentifier componentIdentifier, Com\n      *\n      * @param componentIdentifier package info\n      * @param artifact artifact info\n-     * @param saveToPath path of directory where the artifact is expected to exist\n+     * @param artifactDir path of directory where the artifact is expected to exist\n      * @return size of the artifact in bytes\n      * @throws InvalidArtifactUriException if provided info results in invalid URI\n      * @throws PackageDownloadException if error encountered\n      */\n     public abstract long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentArtifact artifact,\n-                                         Path saveToPath)\n+                                         Path artifactDir)\n             throws InvalidArtifactUriException, PackageDownloadException;\n+\n+    /**\n+     * Get the download size of an artifact file.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13ed7028ba0cd23eea89ae97cb907cb9fe455dbd"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzI0NjM5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#pullrequestreview-508724639", "createdAt": "2020-10-14T21:00:36Z", "commit": {"oid": "13ed7028ba0cd23eea89ae97cb907cb9fe455dbd"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93a55625364fd92f72c62d38f7698dc97f14aac8", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/93a55625364fd92f72c62d38f7698dc97f14aac8", "committedDate": "2020-10-14T21:15:25Z", "message": "fix unarchiver test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4774484eaa83a10ce9007a3050995f811a04a926", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4774484eaa83a10ce9007a3050995f811a04a926", "committedDate": "2020-10-14T21:31:03Z", "message": "fix unarchiver integ test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NzY1OTc0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#pullrequestreview-508765974", "createdAt": "2020-10-14T21:31:07Z", "commit": {"oid": "93a55625364fd92f72c62d38f7698dc97f14aac8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTozMTowN1rOHhlxVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTozMTowN1rOHhlxVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4Mzg5Mw==", "bodyText": "add a space before %d", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504983893", "createdAt": "2020-10-14T21:31:07Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -349,36 +349,36 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n                                 usableSpaceBytes, DEFAULT_MIN_DISK_AVAIL_BYTES));\n             }\n             ArtifactDownloader downloader = selectArtifactDownloader(artifact.getArtifactUri());\n-            if (!downloader.downloadRequired(componentIdentifier, artifact, packageArtifactDirectory)) {\n-                continue;\n-            }\n-            long downloadSize = downloader.getDownloadSize(componentIdentifier, artifact, packageArtifactDirectory);\n-            long storeContentSize = componentStore.getContentSize();\n-            if (storeContentSize + downloadSize > DEFAULT_MAX_STORE_SIZE_BYTES) {\n-                throw new SizeLimitException(String.format(\n-                        \"Component store size limit reached: %d bytes existing, %d bytes needed,\"\n-                                + \"%d bytes maximum allowed total\", storeContentSize, downloadSize,\n-                        DEFAULT_MAX_STORE_SIZE_BYTES));\n-            }\n \n-            File downloadedFile;\n-            try {\n-                downloadedFile = downloader.downloadToPath(componentIdentifier, artifact, packageArtifactDirectory);\n-            } catch (IOException e) {\n-                throw new PackageDownloadException(\n-                        String.format(\"Failed to download package %s artifact %s\", componentIdentifier, artifact), e);\n+            if (downloader.downloadRequired(componentIdentifier, artifact, packageArtifactDirectory)) {\n+                long downloadSize = downloader.getDownloadSize(componentIdentifier, artifact, packageArtifactDirectory);\n+                long storeContentSize = componentStore.getContentSize();\n+                if (storeContentSize + downloadSize > DEFAULT_MAX_STORE_SIZE_BYTES) {\n+                    throw new SizeLimitException(String.format(\n+                            \"Component store size limit reached: %d bytes existing, %d bytes needed,\"\n+                                    + \"%d bytes maximum allowed total\", storeContentSize, downloadSize,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93a55625364fd92f72c62d38f7698dc97f14aac8"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b02d75f78a7a502fcf6c17c61b8049c11516e4d1", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b02d75f78a7a502fcf6c17c61b8049c11516e4d1", "committedDate": "2020-10-14T21:31:20Z", "message": "Merge branch 'master' into unarchive-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a52e62318fc480bb3076f53bfd078baa931d4cc", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a52e62318fc480bb3076f53bfd078baa931d4cc", "committedDate": "2020-10-14T21:43:01Z", "message": "Pretty comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3dde6bd1afa7eac9d6ad810378c8350ea92ab3d", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d3dde6bd1afa7eac9d6ad810378c8350ea92ab3d", "committedDate": "2020-10-14T21:38:50Z", "message": "Pretty comment"}, "afterCommit": {"oid": "1a52e62318fc480bb3076f53bfd078baa931d4cc", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a52e62318fc480bb3076f53bfd078baa931d4cc", "committedDate": "2020-10-14T21:43:01Z", "message": "Pretty comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4Nzk1NjM2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#pullrequestreview-508795636", "createdAt": "2020-10-14T21:51:15Z", "commit": {"oid": "1a52e62318fc480bb3076f53bfd078baa931d4cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTo1MToxNlrOHhmclA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMTo1MToxNlrOHhmclA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk5NDk2NA==", "bodyText": "change this back", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#discussion_r504994964", "createdAt": "2020-10-14T21:51:16Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/componentmanager/ComponentManagerIntegTest.java", "diffHunk": "@@ -72,7 +73,7 @@ void GIVEN_component_with_archived_artifact_WHEN_prepareArtifacts_THEN_unarchive\n         kernel.getContext()\n               .get(ComponentManager.class)\n               .preparePackages(Collections.singletonList(ident))\n-              .get(10, TimeUnit.SECONDS);\n+              .get(1000000, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a52e62318fc480bb3076f53bfd078baa931d4cc"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3738120eaf1dd8da9764aaa7b077c4640eab8bb", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c3738120eaf1dd8da9764aaa7b077c4640eab8bb", "committedDate": "2020-10-14T21:55:36Z", "message": "Minor comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c60dad6c0568ecf556ef2d7275f7e5602dde526", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3c60dad6c0568ecf556ef2d7275f7e5602dde526", "committedDate": "2020-10-14T21:56:09Z", "message": "Merge branch 'master' into unarchive-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODAwNjM0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#pullrequestreview-508800634", "createdAt": "2020-10-14T22:00:48Z", "commit": {"oid": "3c60dad6c0568ecf556ef2d7275f7e5602dde526"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODAwODc2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/527#pullrequestreview-508800876", "createdAt": "2020-10-14T22:01:14Z", "commit": {"oid": "3c60dad6c0568ecf556ef2d7275f7e5602dde526"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52c50761fe2a98bfa5c8c886631e489da64be335", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/52c50761fe2a98bfa5c8c886631e489da64be335", "committedDate": "2020-10-14T22:31:12Z", "message": "Merge branch 'master' into unarchive-fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3156, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}