{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NTQ4NzEx", "number": 239, "title": "Enable replacement in package recipe for {{artifacts:path}}", "bodyText": "Issue #, if available:\nDescription of changes:\nThis PR adds a new replacement which can be used in package recipes so that the recipe can get access to its artifacts. For example:\nLifecycle:\n    run: java -jar {{artifacts:path}}/StreamManager.jar -Xms1m -Xmx128m\nArtifacts:\n    - greengrass:StreamManager.jar\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-13T18:54:06Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/239", "merged": true, "mergeCommit": {"oid": "a098b11ae29432a6845bad1b8a12e93b8b6e6b2d"}, "closed": true, "closedAt": "2020-05-13T22:40:58Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg9nTkAH2gAyNDE3NTQ4NzExOjg2NTQ4YmVhNzEyMDM5ZmY2ZGJkY2RjNjhkYzM3MTI4Y2M0MGRkNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchAy8xAFqTQxMTM0ODg0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "86548bea712039ff6dbdcdc68dc37128cc40dd40", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/86548bea712039ff6dbdcdc68dc37128cc40dd40", "committedDate": "2020-05-13T18:58:48Z", "message": "Enable replacement in package recipe for {{artifacts:path}}"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "391938849a11747ce83b9ef87c304fb8fc71e276", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/391938849a11747ce83b9ef87c304fb8fc71e276", "committedDate": "2020-05-13T18:51:40Z", "message": "Enable replacement in package recipe for {{artifacts:path}}"}, "afterCommit": {"oid": "86548bea712039ff6dbdcdc68dc37128cc40dd40", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/86548bea712039ff6dbdcdc68dc37128cc40dd40", "committedDate": "2020-05-13T18:58:48Z", "message": "Enable replacement in package recipe for {{artifacts:path}}"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjc1MTk5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/239#pullrequestreview-411275199", "createdAt": "2020-05-13T20:29:09Z", "commit": {"oid": "86548bea712039ff6dbdcdc68dc37128cc40dd40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDoyOTowOVrOGVCXmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDoyOTowOVrOGVCXmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcxMjA5MQ==", "bodyText": "Nit - change the message", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/239#discussion_r424712091", "createdAt": "2020-05-13T20:29:09Z", "author": {"login": "shaguptashaikh"}, "path": "src/test/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolverTest.java", "diffHunk": "@@ -275,7 +276,46 @@ void GIVEN_deployment_with_params_not_set_WHEN_previous_deployment_had_params_TH\n         assertThat(\"If no parameter value was set in current/previous deployment, the default value should be used\",\n                 getServiceRunCommand(TEST_INPUT_PACKAGE_A, servicesConfig),\n                 equalTo(\"echo running service in Package PackageA with param PackageA_Param_2_default_value\"));\n+    }\n+\n+    @Test\n+    void GIVEN_deployment_with_artifact_WHEN_config_resolution_requested_THEN_artifact_path_should_be_interpolated()\n+            throws Exception {\n+        // GIVEN\n+        PackageIdentifier rootPackageIdentifier =\n+                new PackageIdentifier(TEST_INPUT_PACKAGE_A, new Semver(\"1.2\", Semver.SemverType.NPM));\n+        List<PackageIdentifier> packagesToDeploy = Arrays.asList(rootPackageIdentifier);\n+\n+        PackageRecipe rootPackageRecipe = new PackageRecipe(RecipeTemplateVersion.JAN_25_2020, TEST_INPUT_PACKAGE_A,\n+                rootPackageIdentifier.getVersion(), \"\", \"\", Collections.emptySet(), new HashMap<String, Object>() {{\n+            put(LIFECYCLE_RUN_KEY, \"java -jar {{artifacts:path}}/test.jar -x arg\");\n+        }}, Collections.emptyList(), Collections.emptyMap(), Collections.emptyMap(), Collections.emptyMap());\n+\n+        DeploymentPackageConfiguration rootPackageDeploymentConfig =\n+                new DeploymentPackageConfiguration(TEST_INPUT_PACKAGE_A, \"1.2\", \">1.0\", Collections.emptySet(),\n+                        Collections.emptyList());\n+        DeploymentDocument document = DeploymentDocument.builder().rootPackages(Arrays.asList(TEST_INPUT_PACKAGE_A))\n+                .deploymentPackageConfigurationList(Arrays.asList(rootPackageDeploymentConfig)).build();\n \n+        when(packageStore.getPackageRecipe(rootPackageIdentifier)).thenReturn(rootPackageRecipe);\n+        when(packageStore.resolveArtifactDirectoryPath(rootPackageIdentifier))\n+                .thenReturn(Paths.get(\"/packages/artifacts\"));\n+        when(kernel.getMain()).thenReturn(mainService);\n+        when(kernel.locate(any())).thenThrow(new ServiceLoadException(\"Service not found\"));\n+        when(mainService.getName()).thenReturn(\"main\");\n+        when(mainService.getDependencies()).thenReturn(Collections.emptyMap());\n+\n+        // WHEN\n+        KernelConfigResolver kernelConfigResolver = new KernelConfigResolver(packageStore, kernel);\n+        Map<Object, Object> resolvedConfig =\n+                kernelConfigResolver.resolve(packagesToDeploy, document, Arrays.asList(TEST_INPUT_PACKAGE_A));\n+\n+        // THEN\n+        Map<Object, Object> servicesConfig = (Map<Object, Object>) resolvedConfig.get(SERVICES_NAMESPACE_TOPIC);\n+\n+        assertThat(\"If no parameter value was set in deployment, the default value should be used\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86548bea712039ff6dbdcdc68dc37128cc40dd40"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8f222f38a46bc1502705c1457e0323812f93b9a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e8f222f38a46bc1502705c1457e0323812f93b9a", "committedDate": "2020-05-13T20:40:49Z", "message": "Generify string replacements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df47692be876777d03174f5665308ad5f8e50e82", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/df47692be876777d03174f5665308ad5f8e50e82", "committedDate": "2020-05-13T20:36:54Z", "message": "Generify string replacements"}, "afterCommit": {"oid": "e8f222f38a46bc1502705c1457e0323812f93b9a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e8f222f38a46bc1502705c1457e0323812f93b9a", "committedDate": "2020-05-13T20:40:49Z", "message": "Generify string replacements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjkxNzA3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/239#pullrequestreview-411291707", "createdAt": "2020-05-13T20:54:30Z", "commit": {"oid": "e8f222f38a46bc1502705c1457e0323812f93b9a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf62b4701a7aa2eaafe6570ab18c8214663ed53b", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bf62b4701a7aa2eaafe6570ab18c8214663ed53b", "committedDate": "2020-05-13T21:18:29Z", "message": "Merge branch 'master' into artifact-path-replacement"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzQ4NDgw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/239#pullrequestreview-411348480", "createdAt": "2020-05-13T22:40:12Z", "commit": {"oid": "bf62b4701a7aa2eaafe6570ab18c8214663ed53b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzQ4ODQ0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/239#pullrequestreview-411348844", "createdAt": "2020-05-13T22:41:14Z", "commit": {"oid": "bf62b4701a7aa2eaafe6570ab18c8214663ed53b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMjo0MToxNFrOGVGAWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMjo0MToxNFrOGVGAWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc3MTY3NA==", "bodyText": "Nice we get a fresh value every time!", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/239#discussion_r424771674", "createdAt": "2020-05-13T22:41:14Z", "author": {"login": "fufranci"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -33,23 +32,40 @@\n import static com.aws.iot.evergreen.kernel.EvergreenService.SERVICE_DEPENDENCIES_NAMESPACE_TOPIC;\n import static com.aws.iot.evergreen.kernel.EvergreenService.SETENV_CONFIG_NAMESPACE;\n \n-@AllArgsConstructor\n-@NoArgsConstructor\n public class KernelConfigResolver {\n \n     public static final String VERSION_CONFIG_KEY = \"version\";\n     protected static final String PARAMETERS_CONFIG_KEY = \"parameters\";\n-    private static final String PARAMETER_REFERENCE_FORMAT = \"{{params:%s.value}}\";\n+    private static final String INTERPOLATION_FORMAT = \"{{%s:%s}}\";\n+    private static final String PARAMETER_REFERENCE_FORMAT = String.format(INTERPOLATION_FORMAT, \"params\", \"%s.value\");\n+    // Map from Namespace -> Key -> Function which returns the replacement value\n+    private final Map<String, Map<String, Function<PackageIdentifier, String>>> systemParameters = new HashMap<>();\n \n+    private final PackageStore packageStore;\n+    private final Kernel kernel;\n+\n+    /**\n+     * Constructor.\n+     *\n+     * @param packageStore package store used to look up packages\n+     * @param kernel       kernel\n+     */\n     @Inject\n-    private PackageStore packageStore;\n-    @Inject\n-    private Kernel kernel;\n+    public KernelConfigResolver(PackageStore packageStore, Kernel kernel) {\n+        this.packageStore = packageStore;\n+        this.kernel = kernel;\n+\n+        // More system parameters can be added over time by extending this map with new namespaces/keys\n+        HashMap<String, Function<PackageIdentifier, String>> artifactNamespace = new HashMap<>();\n+        artifactNamespace\n+                .put(\"path\", (id) -> packageStore.resolveArtifactDirectoryPath(id).toAbsolutePath().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf62b4701a7aa2eaafe6570ab18c8214663ed53b"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2196, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}