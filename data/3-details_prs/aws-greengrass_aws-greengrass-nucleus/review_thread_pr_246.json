{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NjM2NTA4", "number": 246, "reviewThreads": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzoyNjo1OVrOD9fO_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzo0NzowN1rOEA-73A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODAxNDY5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzoyNjo1OVrOGXA2TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzozMDo1M1rOGXA-tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NDMzMw==", "bodyText": "Given our expected customer use case, I don't think that the default client will ever work because we don't expect customers to be setting the AWS environment variables. Can you just remove the default and then add our own values from the config store to L50?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r426784333", "createdAt": "2020-05-18T17:26:59Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "diffHunk": "@@ -35,21 +35,21 @@ public GreengrassPackageServiceClientFactory(\n         if (Utils.isEmpty(greengrassServiceEndpoint) || Utils.isEmpty(greengrassServiceRegion)) {\n             // Initialize default client, client builder determines endpoint configuration\n             // Will try to use default credential provider and environment region configuration\n-            logger.atInfo(\"initialize-pms-client\")\n+            logger.atInfo(\"initialize-cms-client\")\n                   .addKeyValue(\"service-endpoint\", \"default\")\n                   .addKeyValue(\"service-region\", \"default\")\n                   .log();\n-            this.pmsClient = AWSGreengrassPackageManagementClientBuilder.defaultClient();\n+            this.cmsClient = AWSGreengrassComponentManagementClientBuilder.defaultClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967eda08ae5903214cea3b9495487d9dfc7d67d5"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NjQ4NQ==", "bodyText": "Yes, going to standardize on region config always being present in context, preferably from config.yaml as we discussed.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r426786485", "createdAt": "2020-05-18T17:30:53Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "diffHunk": "@@ -35,21 +35,21 @@ public GreengrassPackageServiceClientFactory(\n         if (Utils.isEmpty(greengrassServiceEndpoint) || Utils.isEmpty(greengrassServiceRegion)) {\n             // Initialize default client, client builder determines endpoint configuration\n             // Will try to use default credential provider and environment region configuration\n-            logger.atInfo(\"initialize-pms-client\")\n+            logger.atInfo(\"initialize-cms-client\")\n                   .addKeyValue(\"service-endpoint\", \"default\")\n                   .addKeyValue(\"service-region\", \"default\")\n                   .log();\n-            this.pmsClient = AWSGreengrassPackageManagementClientBuilder.defaultClient();\n+            this.cmsClient = AWSGreengrassComponentManagementClientBuilder.defaultClient();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NDMzMw=="}, "originalCommit": {"oid": "967eda08ae5903214cea3b9495487d9dfc7d67d5"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODAxOTAwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/plugins/GreengrassRepositoryDownloader.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzoyODoyMFrOGXA5Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNzo1NjoxMlrOGXBzpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NTA4Mg==", "bodyText": "How is artifact name defined in the recipe? Right now the artifacts is just a list, should it become a map with names?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r426785082", "createdAt": "2020-05-18T17:28:20Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -70,17 +70,20 @@ HttpURLConnection connect(URL url) throws IOException {\n         return (HttpURLConnection) url.openConnection();\n     }\n \n-    String getArtifactDownloadURL(String packageArn, String artifactName) throws PackageDownloadException {\n-        GetArtifactRequest getArtifactRequest = new GetArtifactRequest().withArtifactName(artifactName)\n-                                                                        .withPackageARN(packageArn);\n+    String getArtifactDownloadURL(PackageIdentifier packageIdentifier, String artifactName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967eda08ae5903214cea3b9495487d9dfc7d67d5"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4ODg5Nw==", "bodyText": "Based on the way the recipe is defined, if it's a greengrass:(something) entry in the list, the something is artifact name.\nNot entirely happy with that format to be honest but we can iterate on that later on as well.\nEg: Monitoring service test package", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r426788897", "createdAt": "2020-05-18T17:35:28Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -70,17 +70,20 @@ HttpURLConnection connect(URL url) throws IOException {\n         return (HttpURLConnection) url.openConnection();\n     }\n \n-    String getArtifactDownloadURL(String packageArn, String artifactName) throws PackageDownloadException {\n-        GetArtifactRequest getArtifactRequest = new GetArtifactRequest().withArtifactName(artifactName)\n-                                                                        .withPackageARN(packageArn);\n+    String getArtifactDownloadURL(PackageIdentifier packageIdentifier, String artifactName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NTA4Mg=="}, "originalCommit": {"oid": "967eda08ae5903214cea3b9495487d9dfc7d67d5"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5MDIxMQ==", "bodyText": "OK, that doesn't make sense to me; the \"greengrass\" part of that isn't the \"name\" of the artifact, but the protocol/type used to download it. There should be the possibility to have multiple artifacts including multiple artifacts with \"greengrass:\".", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r426790211", "createdAt": "2020-05-18T17:37:58Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -70,17 +70,20 @@ HttpURLConnection connect(URL url) throws IOException {\n         return (HttpURLConnection) url.openConnection();\n     }\n \n-    String getArtifactDownloadURL(String packageArn, String artifactName) throws PackageDownloadException {\n-        GetArtifactRequest getArtifactRequest = new GetArtifactRequest().withArtifactName(artifactName)\n-                                                                        .withPackageARN(packageArn);\n+    String getArtifactDownloadURL(PackageIdentifier packageIdentifier, String artifactName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NTA4Mg=="}, "originalCommit": {"oid": "967eda08ae5903214cea3b9495487d9dfc7d67d5"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc5MjE3Mw==", "bodyText": "Nevermind, you mean that the stuff after the \"greengrass:\" is the artifact name. That makes sense.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r426792173", "createdAt": "2020-05-18T17:41:56Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -70,17 +70,20 @@ HttpURLConnection connect(URL url) throws IOException {\n         return (HttpURLConnection) url.openConnection();\n     }\n \n-    String getArtifactDownloadURL(String packageArn, String artifactName) throws PackageDownloadException {\n-        GetArtifactRequest getArtifactRequest = new GetArtifactRequest().withArtifactName(artifactName)\n-                                                                        .withPackageARN(packageArn);\n+    String getArtifactDownloadURL(PackageIdentifier packageIdentifier, String artifactName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NTA4Mg=="}, "originalCommit": {"oid": "967eda08ae5903214cea3b9495487d9dfc7d67d5"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgwMDAzOQ==", "bodyText": "I typed greengrass:something with the something in < brackets, got formatted out it seems :P fixing the comment above", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r426800039", "createdAt": "2020-05-18T17:56:12Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -70,17 +70,20 @@ HttpURLConnection connect(URL url) throws IOException {\n         return (HttpURLConnection) url.openConnection();\n     }\n \n-    String getArtifactDownloadURL(String packageArn, String artifactName) throws PackageDownloadException {\n-        GetArtifactRequest getArtifactRequest = new GetArtifactRequest().withArtifactName(artifactName)\n-                                                                        .withPackageARN(packageArn);\n+    String getArtifactDownloadURL(PackageIdentifier packageIdentifier, String artifactName)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc4NTA4Mg=="}, "originalCommit": {"oid": "967eda08ae5903214cea3b9495487d9dfc7d67d5"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NjY5NDg5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzoxODozMVrOGYV_zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxNzoxODozMVrOGYV_zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE3OTQwNg==", "bodyText": "\ud83d\ude02", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r428179406", "createdAt": "2020-05-20T17:18:31Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceClientFactory.java", "diffHunk": "@@ -19,7 +19,7 @@\n \n     private static final Logger logger = LogManager.getLogger(GreengrassPackageServiceClientFactory.class);\n \n-    private final AWSGreengrassPackageManagement pmsClient;\n+    private final AWSGreengrassComponentManagement cmsClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967eda08ae5903214cea3b9495487d9dfc7d67d5"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDAyNDYwOnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1ODozMFrOGZd4LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1ODozMFrOGZd4LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NzEwMA==", "bodyText": "this can error out, so maybe use try finally to make sure that both the kernel and component are cleaned no matter what.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r429357100", "createdAt": "2020-05-22T16:58:30Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.packagemanager;\n+\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(EGExtension.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+class PackageManagerIntegrationTest {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerIntegrationTest.class.getResource(\"onlyMain.yaml\").toString());\n+        kernel.getContext().put(\"greengrassServiceEndpoint\",\n+                                \"https://3w5ajog718.execute-api.us-east-1.amazonaws.com/Beta/\");\n+        kernel.getContext().put(\"greengrassServiceRegion\", \"us-east-1\");\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =\n+                Paths.get(PackageManagerIntegrationTest.class.getResource(\"test_packages\").toURI())\n+                     .resolve(\"KernelIntegTest-1.0.0\");\n+\n+        Path testRecipePath = testPackagePath.resolve(\"recipe.yaml\");\n+        ByteBuffer recipeBuf = ByteBuffer.wrap(Files.readAllBytes(testRecipePath));\n+        try {\n+            CreateComponentRequest createComponentRequest = new CreateComponentRequest().withRecipe(recipeBuf);\n+            CreateComponentResult createComponentResult = cmsClient.createComponent(createComponentRequest);\n+            assertEquals(\"DRAFT\", createComponentResult.getStatus());\n+\n+            CreateComponentArtifactUploadUrlRequest artifactUploadUrlRequest\n+                    = new CreateComponentArtifactUploadUrlRequest().withArtifactName(\"kernel_integ_test_artifact.txt\")\n+                                                                   .withComponentName(\"KernelIntegTest\")\n+                                                                   .withComponentVersion(\"1.0.0\");\n+            CreateComponentArtifactUploadUrlResult artifactUploadUrlResult\n+                    = cmsClient.createComponentArtifactUploadUrl(artifactUploadUrlRequest);\n+            URL s3PreSignedURL = new URL(artifactUploadUrlResult.getUrl());\n+            HttpURLConnection connection = (HttpURLConnection) s3PreSignedURL.openConnection();\n+            connection.setDoOutput(true);\n+            connection.setRequestMethod(\"PUT\");\n+            OutputStreamWriter out = new OutputStreamWriter(connection.getOutputStream());\n+            out.write(\"Integration test artifact for Evergreen Kernel\");\n+            out.close();\n+        } catch (Exception e) {\n+            System.out.println(e.toString());\n+        }\n+        */\n+    }\n+\n+    @AfterAll\n+    static void tearDown() {\n+        kernel.shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDAyNjkxOnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1OToyNFrOGZd5ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNjoxMjoxOVrOGbSeEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NzUwNw==", "bodyText": "do they only have east right now? Our tests are running in west.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r429357507", "createdAt": "2020-05-22T16:59:24Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.packagemanager;\n+\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(EGExtension.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+class PackageManagerIntegrationTest {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerIntegrationTest.class.getResource(\"onlyMain.yaml\").toString());\n+        kernel.getContext().put(\"greengrassServiceEndpoint\",\n+                                \"https://3w5ajog718.execute-api.us-east-1.amazonaws.com/Beta/\");\n+        kernel.getContext().put(\"greengrassServiceRegion\", \"us-east-1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI2NzM0Ng==", "bodyText": "Only us-east-1 for beta. For v1, we're linked to IoT for data plane and they only have beta in us-east-1. Not sure what we're doing for v2 in terms of other beta regions.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431267346", "createdAt": "2020-05-27T16:12:19Z", "author": {"login": "chaurah"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.packagemanager;\n+\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(EGExtension.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+class PackageManagerIntegrationTest {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerIntegrationTest.class.getResource(\"onlyMain.yaml\").toString());\n+        kernel.getContext().put(\"greengrassServiceEndpoint\",\n+                                \"https://3w5ajog718.execute-api.us-east-1.amazonaws.com/Beta/\");\n+        kernel.getContext().put(\"greengrassServiceRegion\", \"us-east-1\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NzUwNw=="}, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDAyNzczOnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1OTo0OFrOGZd6VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo1OTo0OFrOGZd6VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1NzY1Mw==", "bodyText": "if order doesn't matter, then remove the @Order", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r429357653", "createdAt": "2020-05-22T16:59:48Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.packagemanager;\n+\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(EGExtension.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+class PackageManagerIntegrationTest {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerIntegrationTest.class.getResource(\"onlyMain.yaml\").toString());\n+        kernel.getContext().put(\"greengrassServiceEndpoint\",\n+                                \"https://3w5ajog718.execute-api.us-east-1.amazonaws.com/Beta/\");\n+        kernel.getContext().put(\"greengrassServiceRegion\", \"us-east-1\");\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =\n+                Paths.get(PackageManagerIntegrationTest.class.getResource(\"test_packages\").toURI())\n+                     .resolve(\"KernelIntegTest-1.0.0\");\n+\n+        Path testRecipePath = testPackagePath.resolve(\"recipe.yaml\");\n+        ByteBuffer recipeBuf = ByteBuffer.wrap(Files.readAllBytes(testRecipePath));\n+        try {\n+            CreateComponentRequest createComponentRequest = new CreateComponentRequest().withRecipe(recipeBuf);\n+            CreateComponentResult createComponentResult = cmsClient.createComponent(createComponentRequest);\n+            assertEquals(\"DRAFT\", createComponentResult.getStatus());\n+\n+            CreateComponentArtifactUploadUrlRequest artifactUploadUrlRequest\n+                    = new CreateComponentArtifactUploadUrlRequest().withArtifactName(\"kernel_integ_test_artifact.txt\")\n+                                                                   .withComponentName(\"KernelIntegTest\")\n+                                                                   .withComponentVersion(\"1.0.0\");\n+            CreateComponentArtifactUploadUrlResult artifactUploadUrlResult\n+                    = cmsClient.createComponentArtifactUploadUrl(artifactUploadUrlRequest);\n+            URL s3PreSignedURL = new URL(artifactUploadUrlResult.getUrl());\n+            HttpURLConnection connection = (HttpURLConnection) s3PreSignedURL.openConnection();\n+            connection.setDoOutput(true);\n+            connection.setRequestMethod(\"PUT\");\n+            OutputStreamWriter out = new OutputStreamWriter(connection.getOutputStream());\n+            out.write(\"Integration test artifact for Evergreen Kernel\");\n+            out.close();\n+        } catch (Exception e) {\n+            System.out.println(e.toString());\n+        }\n+        */\n+    }\n+\n+    @AfterAll\n+    static void tearDown() {\n+        kernel.shutdown();\n+        DeleteComponentRequest deleteComponentRequest\n+                = new DeleteComponentRequest().withComponentName(\"KernelIntegTest\")\n+                                              .withComponentVersion(\"1.0.0\");\n+        DeleteComponentResult result = cmsClient.deleteComponent(deleteComponentRequest);\n+        assertEquals(200, result.getSdkHttpMetadata().getHttpStatusCode());\n+    }\n+\n+    @Test\n+    @Order(1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDAyOTEwOnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzowMDoyMFrOGZd7LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzowMDoyMFrOGZd7LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1Nzg2OA==", "bodyText": "you can use hamcrest's file matcher for file existing: https://www.baeldung.com/hamcrest-file-matchers", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r429357868", "createdAt": "2020-05-22T17:00:20Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.packagemanager;\n+\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(EGExtension.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+class PackageManagerIntegrationTest {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerIntegrationTest.class.getResource(\"onlyMain.yaml\").toString());\n+        kernel.getContext().put(\"greengrassServiceEndpoint\",\n+                                \"https://3w5ajog718.execute-api.us-east-1.amazonaws.com/Beta/\");\n+        kernel.getContext().put(\"greengrassServiceRegion\", \"us-east-1\");\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =\n+                Paths.get(PackageManagerIntegrationTest.class.getResource(\"test_packages\").toURI())\n+                     .resolve(\"KernelIntegTest-1.0.0\");\n+\n+        Path testRecipePath = testPackagePath.resolve(\"recipe.yaml\");\n+        ByteBuffer recipeBuf = ByteBuffer.wrap(Files.readAllBytes(testRecipePath));\n+        try {\n+            CreateComponentRequest createComponentRequest = new CreateComponentRequest().withRecipe(recipeBuf);\n+            CreateComponentResult createComponentResult = cmsClient.createComponent(createComponentRequest);\n+            assertEquals(\"DRAFT\", createComponentResult.getStatus());\n+\n+            CreateComponentArtifactUploadUrlRequest artifactUploadUrlRequest\n+                    = new CreateComponentArtifactUploadUrlRequest().withArtifactName(\"kernel_integ_test_artifact.txt\")\n+                                                                   .withComponentName(\"KernelIntegTest\")\n+                                                                   .withComponentVersion(\"1.0.0\");\n+            CreateComponentArtifactUploadUrlResult artifactUploadUrlResult\n+                    = cmsClient.createComponentArtifactUploadUrl(artifactUploadUrlRequest);\n+            URL s3PreSignedURL = new URL(artifactUploadUrlResult.getUrl());\n+            HttpURLConnection connection = (HttpURLConnection) s3PreSignedURL.openConnection();\n+            connection.setDoOutput(true);\n+            connection.setRequestMethod(\"PUT\");\n+            OutputStreamWriter out = new OutputStreamWriter(connection.getOutputStream());\n+            out.write(\"Integration test artifact for Evergreen Kernel\");\n+            out.close();\n+        } catch (Exception e) {\n+            System.out.println(e.toString());\n+        }\n+        */\n+    }\n+\n+    @AfterAll\n+    static void tearDown() {\n+        kernel.shutdown();\n+        DeleteComponentRequest deleteComponentRequest\n+                = new DeleteComponentRequest().withComponentName(\"KernelIntegTest\")\n+                                              .withComponentVersion(\"1.0.0\");\n+        DeleteComponentResult result = cmsClient.deleteComponent(deleteComponentRequest);\n+        assertEquals(200, result.getSdkHttpMetadata().getHttpStatusCode());\n+    }\n+\n+    @Test\n+    @Order(1)\n+    void GIVEN_sample_deployment_doc_WHEN_submitted_to_deployment_task_THEN_services_start_in_kernel()\n+            throws Exception {\n+        PackageIdentifier pkgIdt\n+                = new PackageIdentifier(\"KernelIntegTest\", new Semver(\"1.0.0\", SemverType.NPM));\n+        List<PackageIdentifier> pkgList = new ArrayList<>();\n+        pkgList.add(pkgIdt);\n+        Future<Void> testFuture = packageManager.preparePackages(pkgList);\n+        testFuture.get();//10, TimeUnit.SECONDS);\n+\n+        assertTrue(Files.exists(packageStorePath));\n+        assertTrue(Files.exists(packageStorePath.resolve(RECIPE_DIRECTORY)));\n+        assertTrue(Files.exists(packageStorePath.resolve(ARTIFACT_DIRECTORY)));\n+\n+        assertTrue(Files.exists(packageStorePath.resolve(RECIPE_DIRECTORY).resolve(\"KernelIntegTest-1.0.0.yaml\")));\n+\n+        assertTrue(Files.exists(packageStorePath.resolve(ARTIFACT_DIRECTORY).resolve(\"KernelIntegTest\")));\n+        assertTrue(Files.exists(packageStorePath.resolve(ARTIFACT_DIRECTORY).resolve(\"KernelIntegTest\").resolve(\"1.0.0\")));\n+\n+        assertTrue(Files.exists(packageStorePath.resolve(ARTIFACT_DIRECTORY).resolve(\"KernelIntegTest\").resolve(\"1.0.0\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 141}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDAyOTc1OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzowMDozNVrOGZd7lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzowMDozNVrOGZd7lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1Nzk3Mw==", "bodyText": "always have a timeout.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r429357973", "createdAt": "2020-05-22T17:00:35Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/packagemanager/PackageManagerIntegrationTest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.packagemanager;\n+\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(EGExtension.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+class PackageManagerIntegrationTest {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerIntegrationTest.class.getResource(\"onlyMain.yaml\").toString());\n+        kernel.getContext().put(\"greengrassServiceEndpoint\",\n+                                \"https://3w5ajog718.execute-api.us-east-1.amazonaws.com/Beta/\");\n+        kernel.getContext().put(\"greengrassServiceRegion\", \"us-east-1\");\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =\n+                Paths.get(PackageManagerIntegrationTest.class.getResource(\"test_packages\").toURI())\n+                     .resolve(\"KernelIntegTest-1.0.0\");\n+\n+        Path testRecipePath = testPackagePath.resolve(\"recipe.yaml\");\n+        ByteBuffer recipeBuf = ByteBuffer.wrap(Files.readAllBytes(testRecipePath));\n+        try {\n+            CreateComponentRequest createComponentRequest = new CreateComponentRequest().withRecipe(recipeBuf);\n+            CreateComponentResult createComponentResult = cmsClient.createComponent(createComponentRequest);\n+            assertEquals(\"DRAFT\", createComponentResult.getStatus());\n+\n+            CreateComponentArtifactUploadUrlRequest artifactUploadUrlRequest\n+                    = new CreateComponentArtifactUploadUrlRequest().withArtifactName(\"kernel_integ_test_artifact.txt\")\n+                                                                   .withComponentName(\"KernelIntegTest\")\n+                                                                   .withComponentVersion(\"1.0.0\");\n+            CreateComponentArtifactUploadUrlResult artifactUploadUrlResult\n+                    = cmsClient.createComponentArtifactUploadUrl(artifactUploadUrlRequest);\n+            URL s3PreSignedURL = new URL(artifactUploadUrlResult.getUrl());\n+            HttpURLConnection connection = (HttpURLConnection) s3PreSignedURL.openConnection();\n+            connection.setDoOutput(true);\n+            connection.setRequestMethod(\"PUT\");\n+            OutputStreamWriter out = new OutputStreamWriter(connection.getOutputStream());\n+            out.write(\"Integration test artifact for Evergreen Kernel\");\n+            out.close();\n+        } catch (Exception e) {\n+            System.out.println(e.toString());\n+        }\n+        */\n+    }\n+\n+    @AfterAll\n+    static void tearDown() {\n+        kernel.shutdown();\n+        DeleteComponentRequest deleteComponentRequest\n+                = new DeleteComponentRequest().withComponentName(\"KernelIntegTest\")\n+                                              .withComponentVersion(\"1.0.0\");\n+        DeleteComponentResult result = cmsClient.deleteComponent(deleteComponentRequest);\n+        assertEquals(200, result.getSdkHttpMetadata().getHttpStatusCode());\n+    }\n+\n+    @Test\n+    @Order(1)\n+    void GIVEN_sample_deployment_doc_WHEN_submitted_to_deployment_task_THEN_services_start_in_kernel()\n+            throws Exception {\n+        PackageIdentifier pkgIdt\n+                = new PackageIdentifier(\"KernelIntegTest\", new Semver(\"1.0.0\", SemverType.NPM));\n+        List<PackageIdentifier> pkgList = new ArrayList<>();\n+        pkgList.add(pkgIdt);\n+        Future<Void> testFuture = packageManager.preparePackages(pkgList);\n+        testFuture.get();//10, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 130}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDA0MzUzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzowNTo1M1rOGZeEQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzowNTo1M1rOGZeEQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MDE5Mw==", "bodyText": "this seems odd. Why doesn't the metadata from the cloud include the declared dependencies and version requirements?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r429360193", "createdAt": "2020-05-22T17:05:53Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -29,22 +38,40 @@\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement) {\n+        ListComponentsRequest listComponentsRequest =\n+                new ListComponentsRequest().withComponentName(packageName)\n+                                           .withComponentVersionConstraint(versionRequirement.toString());\n+        ListComponentsResult listComponentsResult = evgPmsClient.listComponents(listComponentsRequest);\n+        List<ComponentSelectedMetadata> componentSelectedMetadataList = listComponentsResult.getComponents();\n+        return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+            PackageIdentifier packageIdentifier\n+                    = new PackageIdentifier(componentMetadata.getComponentName(),\n+                                            new Semver(componentMetadata.getComponentVersion()),\n+                                            componentMetadata.getComponentARN());\n+            // Dependencies map is unused as of now, there's no point in requesting dependencies for\n+            // ALL package versions at this step, will be filled in later by package manager", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDA0NTAwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzowNjozMlrOGZeFPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxODo1MTowNFrOGZgw1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MDQ0NQ==", "bodyText": "this seems error prone, given that the map is always empty. Perhaps you should change the return value to just be the package identifier?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r429360445", "createdAt": "2020-05-22T17:06:32Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -29,22 +38,40 @@\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement) {\n+        ListComponentsRequest listComponentsRequest =\n+                new ListComponentsRequest().withComponentName(packageName)\n+                                           .withComponentVersionConstraint(versionRequirement.toString());\n+        ListComponentsResult listComponentsResult = evgPmsClient.listComponents(listComponentsRequest);\n+        List<ComponentSelectedMetadata> componentSelectedMetadataList = listComponentsResult.getComponents();\n+        return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+            PackageIdentifier packageIdentifier\n+                    = new PackageIdentifier(componentMetadata.getComponentName(),\n+                                            new Semver(componentMetadata.getComponentVersion()),\n+                                            componentMetadata.getComponentARN());\n+            // Dependencies map is unused as of now, there's no point in requesting dependencies for\n+            // ALL package versions at this step, will be filled in later by package manager\n+            return new PackageMetadata(packageIdentifier, Collections.emptyMap());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MTAwNQ==", "bodyText": "Agree. Since we are just getting a list of PackageIdentifiers.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r429371005", "createdAt": "2020-05-22T17:31:02Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -29,22 +38,40 @@\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement) {\n+        ListComponentsRequest listComponentsRequest =\n+                new ListComponentsRequest().withComponentName(packageName)\n+                                           .withComponentVersionConstraint(versionRequirement.toString());\n+        ListComponentsResult listComponentsResult = evgPmsClient.listComponents(listComponentsRequest);\n+        List<ComponentSelectedMetadata> componentSelectedMetadataList = listComponentsResult.getComponents();\n+        return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+            PackageIdentifier packageIdentifier\n+                    = new PackageIdentifier(componentMetadata.getComponentName(),\n+                                            new Semver(componentMetadata.getComponentVersion()),\n+                                            componentMetadata.getComponentARN());\n+            // Dependencies map is unused as of now, there's no point in requesting dependencies for\n+            // ALL package versions at this step, will be filled in later by package manager\n+            return new PackageMetadata(packageIdentifier, Collections.emptyMap());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MDQ0NQ=="}, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQwNDM3NQ==", "bodyText": "I tried to go through and change it, but the DependencyResolver does use the map, so I don't think we can just remove it. Seems like the cloud should give us more info.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r429404375", "createdAt": "2020-05-22T18:51:04Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -29,22 +38,40 @@\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement) {\n+        ListComponentsRequest listComponentsRequest =\n+                new ListComponentsRequest().withComponentName(packageName)\n+                                           .withComponentVersionConstraint(versionRequirement.toString());\n+        ListComponentsResult listComponentsResult = evgPmsClient.listComponents(listComponentsRequest);\n+        List<ComponentSelectedMetadata> componentSelectedMetadataList = listComponentsResult.getComponents();\n+        return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+            PackageIdentifier packageIdentifier\n+                    = new PackageIdentifier(componentMetadata.getComponentName(),\n+                                            new Semver(componentMetadata.getComponentVersion()),\n+                                            componentMetadata.getComponentARN());\n+            // Dependencies map is unused as of now, there's no point in requesting dependencies for\n+            // ALL package versions at this step, will be filled in later by package manager\n+            return new PackageMetadata(packageIdentifier, Collections.emptyMap());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MDQ0NQ=="}, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NDI1NTQ2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxODoyODozOFrOGZgOBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxODoyODozOFrOGZgOBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM5NTQ2MQ==", "bodyText": "We have a method in the platform resolver to resolve the platform. You don't need to do this yourself.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r429395461", "createdAt": "2020-05-22T18:28:38Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageManager.java", "diffHunk": "@@ -136,15 +138,13 @@ private void preparePackage(PackageIdentifier packageIdentifier)\n         logger.atInfo().setEventType(\"prepare-package-start\").addKeyValue(\"packageIdentifier\", packageIdentifier).log();\n         try {\n             PackageRecipe pkg = findRecipeDownloadIfNotExisted(packageIdentifier);\n-            List<URI> artifactURIList = pkg.getArtifacts().stream().map(artifactStr -> {\n-                try {\n-                    return new URI(artifactStr);\n-                } catch (URISyntaxException e) {\n-                    String message = String.format(\"artifact URI %s is invalid\", artifactStr);\n-                    logger.atError().setCause(e).log(message);\n-                    throw new RuntimeException(message, e);\n-                }\n-            }).collect(Collectors.toList());\n+\n+            final Set<String> resolvedPlatforms = PlatformResolver.RANKS.get().keySet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74c3fcbd9ed0c4f19d34d278a66d7629a1b6cac8"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzA4MzM3OnYy", "diffSide": "RIGHT", "path": "src/test/resources/com/aws/iot/evergreen/packagemanager/recipes/MonitoringService-1.1.0.yaml", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMzoyNDozMlrOGazjCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzozMDoxMFrOGbgpmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MDcxMg==", "bodyText": "Is the platform forced in pkg recipe?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r430760712", "createdAt": "2020-05-26T23:24:32Z", "author": {"login": "ShirleyZheng92"}, "path": "src/test/resources/com/aws/iot/evergreen/packagemanager/recipes/MonitoringService-1.1.0.yaml", "diffHunk": "@@ -16,7 +16,8 @@ Lifecycle:\n       skipif: onpath git\n       script: brew install git\n Artifacts:\n-  - greengrass:MonitoringService-1.1.0/monitor_artifact_100.txt\n+  all:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd62b2b3e3d6e70eaf3222e61fe583bf97055c77"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI2ODk4Mg==", "bodyText": "Not sure what you're getting at here? Specifying a platform name is required, at least all should be specified as per current specification.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431268982", "createdAt": "2020-05-27T16:14:42Z", "author": {"login": "chaurah"}, "path": "src/test/resources/com/aws/iot/evergreen/packagemanager/recipes/MonitoringService-1.1.0.yaml", "diffHunk": "@@ -16,7 +16,8 @@ Lifecycle:\n       skipif: onpath git\n       script: brew install git\n Artifacts:\n-  - greengrass:MonitoringService-1.1.0/monitor_artifact_100.txt\n+  all:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MDcxMg=="}, "originalCommit": {"oid": "cd62b2b3e3d6e70eaf3222e61fe583bf97055c77"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5NzUwNg==", "bodyText": "AFAIK the platform resolver on the kernel side will check if there's a platform keyword, if not, the entire setting should be returned.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431497506", "createdAt": "2020-05-27T23:23:12Z", "author": {"login": "hui-yang"}, "path": "src/test/resources/com/aws/iot/evergreen/packagemanager/recipes/MonitoringService-1.1.0.yaml", "diffHunk": "@@ -16,7 +16,8 @@ Lifecycle:\n       skipif: onpath git\n       script: brew install git\n Artifacts:\n-  - greengrass:MonitoringService-1.1.0/monitor_artifact_100.txt\n+  all:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MDcxMg=="}, "originalCommit": {"oid": "cd62b2b3e3d6e70eaf3222e61fe583bf97055c77"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5OTY3Mg==", "bodyText": "No, this is not the case because the cloud requires a platform there. There is no choice to not have a platform. Additionally, we don't run the whole recipe through the platform resolver. Before this change only the lifecycle section was resolved because we perform the resolution during the config merge, and the rest of the recipe isn't merged into the config.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431499672", "createdAt": "2020-05-27T23:30:10Z", "author": {"login": "MikeDombo"}, "path": "src/test/resources/com/aws/iot/evergreen/packagemanager/recipes/MonitoringService-1.1.0.yaml", "diffHunk": "@@ -16,7 +16,8 @@ Lifecycle:\n       skipif: onpath git\n       script: brew install git\n Artifacts:\n-  - greengrass:MonitoringService-1.1.0/monitor_artifact_100.txt\n+  all:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MDcxMg=="}, "originalCommit": {"oid": "cd62b2b3e3d6e70eaf3222e61fe583bf97055c77"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzA5MDY4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMzoyODoyN1rOGaznow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNToyMToxNVrOGb6XVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MTg5MQ==", "bodyText": "It's generally not good practice to both log stack trace & throw the error", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r430761891", "createdAt": "2020-05-26T23:28:27Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,72 +1,92 @@\n package com.aws.iot.evergreen.packagemanager;\n \n import com.amazonaws.AmazonClientException;\n-import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n-import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ComponentNameVersion;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ResolvedComponent;\n+import com.aws.iot.evergreen.config.PlatformResolver;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n import com.aws.iot.evergreen.util.SerializerFactory;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+import com.vdurmont.semver4j.Requirement;\n+import com.vdurmont.semver4j.Semver;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n-    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n-\n+    private static final String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n     private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n-\n+    private static final String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement) {\n+        FindComponentVersionsByPlatformRequest findComponentRequest =\n+                new FindComponentVersionsByPlatformRequest().withComponentName(packageName)\n+                        .withVersionConstraint(versionRequirement.toString())\n+                        .withPlatform(PlatformResolver.getPlatform());\n+        FindComponentVersionsByPlatformResult findComponentResult =\n+                evgPmsClient.findComponentVersionsByPlatform(findComponentRequest);\n+        List<ResolvedComponent> componentSelectedMetadataList = findComponentResult.getComponents();\n+\n+        return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+            PackageIdentifier packageIdentifier = new PackageIdentifier(componentMetadata.getComponentName(),\n+                    new Semver(componentMetadata.getComponentVersion()), componentMetadata.getComponentARN());\n+            return new PackageMetadata(packageIdentifier, componentMetadata.getDependencies().stream().collect(\n+                    Collectors.toMap(ComponentNameVersion::getComponentName,\n+                            ComponentNameVersion::getComponentVersionConstraint)));\n+        }).collect(Collectors.toList());\n     }\n \n     PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier)\n             throws PackageDownloadException, PackageLoadingException {\n-        GetPackageRequest getPackageRequest =\n-                new GetPackageRequest().withPackageARN(packageIdentifier.getArn())\n-                                       .withType(RecipeFormatType.YAML);\n+        GetComponentRequest getComponentRequest =\n+                new GetComponentRequest().withComponentName(packageIdentifier.getName())\n+                        .withComponentVersion(packageIdentifier.getVersion().toString())\n+                        .withType(RecipeFormatType.YAML);\n \n-        GetPackageResult getPackageResult;\n+        GetComponentResult getPackageResult;\n         try {\n-            getPackageResult = evgPmsClient.getPackage(getPackageRequest);\n+            getPackageResult = evgPmsClient.getComponent(getComponentRequest);\n         } catch (AmazonClientException e) {\n             // TODO: This should be expanded to handle various types of retryable/non-retryable exceptions\n-            String errorMsg = String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT,\n-                                            packageIdentifier.getArn());\n+            String errorMsg = String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT, packageIdentifier.getArn());\n             logger.atError(\"download-package-from-greengrass-repo\", e)\n-                  .addKeyValue(\"packageIdentifier\", packageIdentifier)\n-                  .addKeyValue(\"errorMessage\", errorMsg)\n-                  .log();\n+                    .addKeyValue(\"packageIdentifier\", packageIdentifier).addKeyValue(\"errorMessage\", errorMsg).log();\n             throw new PackageDownloadException(errorMsg, e);\n         }\n \n         try {\n             ByteBuffer recipeBuf = getPackageResult.getRecipe();\n-            return RECIPE_SERIALIZER.readValue(new ByteBufferBackedInputStream(recipeBuf),\n-                                               PackageRecipe.class);\n+            return RECIPE_SERIALIZER.readValue(new ByteBufferBackedInputStream(recipeBuf), PackageRecipe.class);\n         } catch (IOException e) {\n-            String errorMsg = String.format(PACKAGE_RECIPE_PARSING_EXCEPTION_FMT,\n-                                            packageIdentifier.getArn());\n+            String errorMsg = String.format(PACKAGE_RECIPE_PARSING_EXCEPTION_FMT, packageIdentifier.getArn());\n             logger.atError(\"download-package-from-greengrass-repo\", e)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd62b2b3e3d6e70eaf3222e61fe583bf97055c77"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3MDIwMw==", "bodyText": "The exception is the auto-generated exception from the SDK, I felt it's best to have the required information up front on which package download failed.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431270203", "createdAt": "2020-05-27T16:16:35Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,72 +1,92 @@\n package com.aws.iot.evergreen.packagemanager;\n \n import com.amazonaws.AmazonClientException;\n-import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n-import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ComponentNameVersion;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ResolvedComponent;\n+import com.aws.iot.evergreen.config.PlatformResolver;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n import com.aws.iot.evergreen.util.SerializerFactory;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+import com.vdurmont.semver4j.Requirement;\n+import com.vdurmont.semver4j.Semver;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n-    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n-\n+    private static final String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n     private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n-\n+    private static final String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement) {\n+        FindComponentVersionsByPlatformRequest findComponentRequest =\n+                new FindComponentVersionsByPlatformRequest().withComponentName(packageName)\n+                        .withVersionConstraint(versionRequirement.toString())\n+                        .withPlatform(PlatformResolver.getPlatform());\n+        FindComponentVersionsByPlatformResult findComponentResult =\n+                evgPmsClient.findComponentVersionsByPlatform(findComponentRequest);\n+        List<ResolvedComponent> componentSelectedMetadataList = findComponentResult.getComponents();\n+\n+        return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+            PackageIdentifier packageIdentifier = new PackageIdentifier(componentMetadata.getComponentName(),\n+                    new Semver(componentMetadata.getComponentVersion()), componentMetadata.getComponentARN());\n+            return new PackageMetadata(packageIdentifier, componentMetadata.getDependencies().stream().collect(\n+                    Collectors.toMap(ComponentNameVersion::getComponentName,\n+                            ComponentNameVersion::getComponentVersionConstraint)));\n+        }).collect(Collectors.toList());\n     }\n \n     PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier)\n             throws PackageDownloadException, PackageLoadingException {\n-        GetPackageRequest getPackageRequest =\n-                new GetPackageRequest().withPackageARN(packageIdentifier.getArn())\n-                                       .withType(RecipeFormatType.YAML);\n+        GetComponentRequest getComponentRequest =\n+                new GetComponentRequest().withComponentName(packageIdentifier.getName())\n+                        .withComponentVersion(packageIdentifier.getVersion().toString())\n+                        .withType(RecipeFormatType.YAML);\n \n-        GetPackageResult getPackageResult;\n+        GetComponentResult getPackageResult;\n         try {\n-            getPackageResult = evgPmsClient.getPackage(getPackageRequest);\n+            getPackageResult = evgPmsClient.getComponent(getComponentRequest);\n         } catch (AmazonClientException e) {\n             // TODO: This should be expanded to handle various types of retryable/non-retryable exceptions\n-            String errorMsg = String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT,\n-                                            packageIdentifier.getArn());\n+            String errorMsg = String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT, packageIdentifier.getArn());\n             logger.atError(\"download-package-from-greengrass-repo\", e)\n-                  .addKeyValue(\"packageIdentifier\", packageIdentifier)\n-                  .addKeyValue(\"errorMessage\", errorMsg)\n-                  .log();\n+                    .addKeyValue(\"packageIdentifier\", packageIdentifier).addKeyValue(\"errorMessage\", errorMsg).log();\n             throw new PackageDownloadException(errorMsg, e);\n         }\n \n         try {\n             ByteBuffer recipeBuf = getPackageResult.getRecipe();\n-            return RECIPE_SERIALIZER.readValue(new ByteBufferBackedInputStream(recipeBuf),\n-                                               PackageRecipe.class);\n+            return RECIPE_SERIALIZER.readValue(new ByteBufferBackedInputStream(recipeBuf), PackageRecipe.class);\n         } catch (IOException e) {\n-            String errorMsg = String.format(PACKAGE_RECIPE_PARSING_EXCEPTION_FMT,\n-                                            packageIdentifier.getArn());\n+            String errorMsg = String.format(PACKAGE_RECIPE_PARSING_EXCEPTION_FMT, packageIdentifier.getArn());\n             logger.atError(\"download-package-from-greengrass-repo\", e)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MTg5MQ=="}, "originalCommit": {"oid": "cd62b2b3e3d6e70eaf3222e61fe583bf97055c77"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyMDk4MA==", "bodyText": "We're not losing anything because you are wrapping the original error, so no information is lost.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431920980", "createdAt": "2020-05-28T15:21:15Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,72 +1,92 @@\n package com.aws.iot.evergreen.packagemanager;\n \n import com.amazonaws.AmazonClientException;\n-import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n-import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ComponentNameVersion;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ResolvedComponent;\n+import com.aws.iot.evergreen.config.PlatformResolver;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n import com.aws.iot.evergreen.util.SerializerFactory;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+import com.vdurmont.semver4j.Requirement;\n+import com.vdurmont.semver4j.Semver;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n-    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n-\n+    private static final String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n     private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n-\n+    private static final String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement) {\n+        FindComponentVersionsByPlatformRequest findComponentRequest =\n+                new FindComponentVersionsByPlatformRequest().withComponentName(packageName)\n+                        .withVersionConstraint(versionRequirement.toString())\n+                        .withPlatform(PlatformResolver.getPlatform());\n+        FindComponentVersionsByPlatformResult findComponentResult =\n+                evgPmsClient.findComponentVersionsByPlatform(findComponentRequest);\n+        List<ResolvedComponent> componentSelectedMetadataList = findComponentResult.getComponents();\n+\n+        return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+            PackageIdentifier packageIdentifier = new PackageIdentifier(componentMetadata.getComponentName(),\n+                    new Semver(componentMetadata.getComponentVersion()), componentMetadata.getComponentARN());\n+            return new PackageMetadata(packageIdentifier, componentMetadata.getDependencies().stream().collect(\n+                    Collectors.toMap(ComponentNameVersion::getComponentName,\n+                            ComponentNameVersion::getComponentVersionConstraint)));\n+        }).collect(Collectors.toList());\n     }\n \n     PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier)\n             throws PackageDownloadException, PackageLoadingException {\n-        GetPackageRequest getPackageRequest =\n-                new GetPackageRequest().withPackageARN(packageIdentifier.getArn())\n-                                       .withType(RecipeFormatType.YAML);\n+        GetComponentRequest getComponentRequest =\n+                new GetComponentRequest().withComponentName(packageIdentifier.getName())\n+                        .withComponentVersion(packageIdentifier.getVersion().toString())\n+                        .withType(RecipeFormatType.YAML);\n \n-        GetPackageResult getPackageResult;\n+        GetComponentResult getPackageResult;\n         try {\n-            getPackageResult = evgPmsClient.getPackage(getPackageRequest);\n+            getPackageResult = evgPmsClient.getComponent(getComponentRequest);\n         } catch (AmazonClientException e) {\n             // TODO: This should be expanded to handle various types of retryable/non-retryable exceptions\n-            String errorMsg = String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT,\n-                                            packageIdentifier.getArn());\n+            String errorMsg = String.format(PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT, packageIdentifier.getArn());\n             logger.atError(\"download-package-from-greengrass-repo\", e)\n-                  .addKeyValue(\"packageIdentifier\", packageIdentifier)\n-                  .addKeyValue(\"errorMessage\", errorMsg)\n-                  .log();\n+                    .addKeyValue(\"packageIdentifier\", packageIdentifier).addKeyValue(\"errorMessage\", errorMsg).log();\n             throw new PackageDownloadException(errorMsg, e);\n         }\n \n         try {\n             ByteBuffer recipeBuf = getPackageResult.getRecipe();\n-            return RECIPE_SERIALIZER.readValue(new ByteBufferBackedInputStream(recipeBuf),\n-                                               PackageRecipe.class);\n+            return RECIPE_SERIALIZER.readValue(new ByteBufferBackedInputStream(recipeBuf), PackageRecipe.class);\n         } catch (IOException e) {\n-            String errorMsg = String.format(PACKAGE_RECIPE_PARSING_EXCEPTION_FMT,\n-                                            packageIdentifier.getArn());\n+            String errorMsg = String.format(PACKAGE_RECIPE_PARSING_EXCEPTION_FMT, packageIdentifier.getArn());\n             logger.atError(\"download-package-from-greengrass-repo\", e)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MTg5MQ=="}, "originalCommit": {"oid": "cd62b2b3e3d6e70eaf3222e61fe583bf97055c77"}, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzA5NjA4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMzozMTozMFrOGazrFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNjoxODoyMlrOGbSt1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2Mjc3NQ==", "bodyText": "General question, will we support any format other than yaml when downloading a pkg recipe?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r430762775", "createdAt": "2020-05-26T23:31:30Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,72 +1,92 @@\n package com.aws.iot.evergreen.packagemanager;\n \n import com.amazonaws.AmazonClientException;\n-import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n-import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ComponentNameVersion;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ResolvedComponent;\n+import com.aws.iot.evergreen.config.PlatformResolver;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n import com.aws.iot.evergreen.util.SerializerFactory;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+import com.vdurmont.semver4j.Requirement;\n+import com.vdurmont.semver4j.Semver;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n-    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n-\n+    private static final String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n     private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n-\n+    private static final String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement) {\n+        FindComponentVersionsByPlatformRequest findComponentRequest =\n+                new FindComponentVersionsByPlatformRequest().withComponentName(packageName)\n+                        .withVersionConstraint(versionRequirement.toString())\n+                        .withPlatform(PlatformResolver.getPlatform());\n+        FindComponentVersionsByPlatformResult findComponentResult =\n+                evgPmsClient.findComponentVersionsByPlatform(findComponentRequest);\n+        List<ResolvedComponent> componentSelectedMetadataList = findComponentResult.getComponents();\n+\n+        return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+            PackageIdentifier packageIdentifier = new PackageIdentifier(componentMetadata.getComponentName(),\n+                    new Semver(componentMetadata.getComponentVersion()), componentMetadata.getComponentARN());\n+            return new PackageMetadata(packageIdentifier, componentMetadata.getDependencies().stream().collect(\n+                    Collectors.toMap(ComponentNameVersion::getComponentName,\n+                            ComponentNameVersion::getComponentVersionConstraint)));\n+        }).collect(Collectors.toList());\n     }\n \n     PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd62b2b3e3d6e70eaf3222e61fe583bf97055c77"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3MTM4Mg==", "bodyText": "Currently the service APIs support YAML and JSON. But the api allows us to specify which format we want. Basically the service can return in any supported format we want. Didn't seem to make any sense to have multiple paths based on format on the kernel side if the service already handles this so I went with YAML for all requests.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431271382", "createdAt": "2020-05-27T16:18:22Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,72 +1,92 @@\n package com.aws.iot.evergreen.packagemanager;\n \n import com.amazonaws.AmazonClientException;\n-import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n-import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ComponentNameVersion;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ResolvedComponent;\n+import com.aws.iot.evergreen.config.PlatformResolver;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n import com.aws.iot.evergreen.util.SerializerFactory;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+import com.vdurmont.semver4j.Requirement;\n+import com.vdurmont.semver4j.Semver;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n-    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n-\n+    private static final String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n     private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n-\n+    private static final String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement) {\n+        FindComponentVersionsByPlatformRequest findComponentRequest =\n+                new FindComponentVersionsByPlatformRequest().withComponentName(packageName)\n+                        .withVersionConstraint(versionRequirement.toString())\n+                        .withPlatform(PlatformResolver.getPlatform());\n+        FindComponentVersionsByPlatformResult findComponentResult =\n+                evgPmsClient.findComponentVersionsByPlatform(findComponentRequest);\n+        List<ResolvedComponent> componentSelectedMetadataList = findComponentResult.getComponents();\n+\n+        return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+            PackageIdentifier packageIdentifier = new PackageIdentifier(componentMetadata.getComponentName(),\n+                    new Semver(componentMetadata.getComponentVersion()), componentMetadata.getComponentARN());\n+            return new PackageMetadata(packageIdentifier, componentMetadata.getDependencies().stream().collect(\n+                    Collectors.toMap(ComponentNameVersion::getComponentName,\n+                            ComponentNameVersion::getComponentVersionConstraint)));\n+        }).collect(Collectors.toList());\n     }\n \n     PackageRecipe downloadPackageRecipe(PackageIdentifier packageIdentifier)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2Mjc3NQ=="}, "originalCommit": {"oid": "cd62b2b3e3d6e70eaf3222e61fe583bf97055c77"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzYxMDU1OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzozNDoxN1rOGbgu4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMzo1ODo0M1rOGbhMRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTAyNA==", "bodyText": "I made a few changes to e2e tests. Could you move this method to BaseE2ETestCase? DeviceConfiguration should already be updated", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431501024", "createdAt": "2020-05-27T23:34:17Z", "author": {"login": "hui-yang"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -317,6 +317,16 @@ public static void updateKernelConfigWithIotConfiguration(Kernel kernel, Utils.T\n         config.getIotCredentialEndpoint().withValue(thing.credEndpoint);\n     }\n \n+    // Update the kernel config with iot thing info, in specific CA, private Key and cert path.\n+    public static void updateKernelConfigWithComponentManagementServiceConfiguration(Kernel kernel)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb6d70d3e5e12b6c52427682949d5cfc160e786a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMzM4OA==", "bodyText": "Just rebased against those changes. I think this should move to a Utils class under integrationtests/utils since it's also used in integration tests. Thoughts?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431503388", "createdAt": "2020-05-27T23:41:41Z", "author": {"login": "chaurah"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -317,6 +317,16 @@ public static void updateKernelConfigWithIotConfiguration(Kernel kernel, Utils.T\n         config.getIotCredentialEndpoint().withValue(thing.credEndpoint);\n     }\n \n+    // Update the kernel config with iot thing info, in specific CA, private Key and cert path.\n+    public static void updateKernelConfigWithComponentManagementServiceConfiguration(Kernel kernel)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTAyNA=="}, "originalCommit": {"oid": "fb6d70d3e5e12b6c52427682949d5cfc160e786a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwODU0OQ==", "bodyText": "I overlooked that. It makes more sense to keep it here then.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431508549", "createdAt": "2020-05-27T23:58:43Z", "author": {"login": "hui-yang"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -317,6 +317,16 @@ public static void updateKernelConfigWithIotConfiguration(Kernel kernel, Utils.T\n         config.getIotCredentialEndpoint().withValue(thing.credEndpoint);\n     }\n \n+    // Update the kernel config with iot thing info, in specific CA, private Key and cert path.\n+    public static void updateKernelConfigWithComponentManagementServiceConfiguration(Kernel kernel)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUwMTAyNA=="}, "originalCommit": {"oid": "fb6d70d3e5e12b6c52427682949d5cfc160e786a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDE4ODQ0OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNToxNzoyNlrOGb6MuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNDozOTowN1rOGcfpxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxODI2NA==", "bodyText": "What's the plan with the commented out stuff?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431918264", "createdAt": "2020-05-28T15:17:26Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.packagemanager;\n+\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import com.aws.iot.evergreen.integrationtests.e2e.BaseE2ETestCase;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.io.FileMatchers.anExistingDirectory;\n+import static org.hamcrest.io.FileMatchers.anExistingFile;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@ExtendWith(EGExtension.class)\n+@Tag(\"E2E\")\n+class PackageManagerE2ETest extends BaseE2ETestCase {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerE2ETest.class.getResource(\"onlyMain.yaml\").toString());\n+        Utils.updateKernelConfigWithComponentManagementServiceConfiguration(kernel);\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyNjMyMA==", "bodyText": "Not in plan for M1 at the moment. We'll revisit this when service adds code to the delete API, it's just a stub at the moment that always returns 200", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431926320", "createdAt": "2020-05-28T15:28:35Z", "author": {"login": "chaurah"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.packagemanager;\n+\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import com.aws.iot.evergreen.integrationtests.e2e.BaseE2ETestCase;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.io.FileMatchers.anExistingDirectory;\n+import static org.hamcrest.io.FileMatchers.anExistingFile;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@ExtendWith(EGExtension.class)\n+@Tag(\"E2E\")\n+class PackageManagerE2ETest extends BaseE2ETestCase {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerE2ETest.class.getResource(\"onlyMain.yaml\").toString());\n+        Utils.updateKernelConfigWithComponentManagementServiceConfiguration(kernel);\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxODI2NA=="}, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAwMDc5MQ==", "bodyText": "It's good we have already thought about the future... But I also recall what Feng mentioned before about this - Let's not have big chunk of commented code in the code base since it will confuse others... Since we are going to add code incrementally, I'd say it's perfectly fine to add them just in time when we can do it.\nNo need to remove this since we already have it but just in the future...", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432000791", "createdAt": "2020-05-28T17:22:49Z", "author": {"login": "leaf94"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.packagemanager;\n+\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import com.aws.iot.evergreen.integrationtests.e2e.BaseE2ETestCase;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.io.FileMatchers.anExistingDirectory;\n+import static org.hamcrest.io.FileMatchers.anExistingFile;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@ExtendWith(EGExtension.class)\n+@Tag(\"E2E\")\n+class PackageManagerE2ETest extends BaseE2ETestCase {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerE2ETest.class.getResource(\"onlyMain.yaml\").toString());\n+        Utils.updateKernelConfigWithComponentManagementServiceConfiguration(kernel);\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxODI2NA=="}, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUzMTkwOA==", "bodyText": "I know that, this was a specific case of me creating a test package that is being validated in the test case. In case the service side decides to wipe out their DB for example, or they set up a new prod endpoint, people need to be able to recreate the package. It'll be hard if they have to guess at how things were working before basically.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432531908", "createdAt": "2020-05-29T14:39:07Z", "author": {"login": "chaurah"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.packagemanager;\n+\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import com.aws.iot.evergreen.integrationtests.e2e.BaseE2ETestCase;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.io.FileMatchers.anExistingDirectory;\n+import static org.hamcrest.io.FileMatchers.anExistingFile;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@ExtendWith(EGExtension.class)\n+@Tag(\"E2E\")\n+class PackageManagerE2ETest extends BaseE2ETestCase {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerE2ETest.class.getResource(\"onlyMain.yaml\").toString());\n+        Utils.updateKernelConfigWithComponentManagementServiceConfiguration(kernel);\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxODI2NA=="}, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDE5Mzc3OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNToxODozNFrOGb6P7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNDozOToxN1rOGcfqKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxOTA4Nw==", "bodyText": "Need more testing than just this. Should also be testing that dependency resolution works because that causes the new cms also.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431919087", "createdAt": "2020-05-28T15:18:34Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.packagemanager;\n+\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import com.aws.iot.evergreen.integrationtests.e2e.BaseE2ETestCase;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.io.FileMatchers.anExistingDirectory;\n+import static org.hamcrest.io.FileMatchers.anExistingFile;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@ExtendWith(EGExtension.class)\n+@Tag(\"E2E\")\n+class PackageManagerE2ETest extends BaseE2ETestCase {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerE2ETest.class.getResource(\"onlyMain.yaml\").toString());\n+        Utils.updateKernelConfigWithComponentManagementServiceConfiguration(kernel);\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =\n+                Paths.get(PackageManagerE2ETest.class.getResource(\"test_packages\").toURI())\n+                     .resolve(\"KernelIntegTest-1.0.0\");\n+\n+        Path testRecipePath = testPackagePath.resolve(\"recipe.yaml\");\n+        ByteBuffer recipeBuf = ByteBuffer.wrap(Files.readAllBytes(testRecipePath));\n+        try {\n+            CreateComponentRequest createComponentRequest = new CreateComponentRequest().withRecipe(recipeBuf);\n+            CreateComponentResult createComponentResult = cmsClient.createComponent(createComponentRequest);\n+            assertEquals(\"DRAFT\", createComponentResult.getStatus());\n+\n+            CreateComponentArtifactUploadUrlRequest artifactUploadUrlRequest\n+                    = new CreateComponentArtifactUploadUrlRequest().withArtifactName(\"kernel_integ_test_artifact.txt\")\n+                                                                   .withComponentName(\"KernelIntegTest\")\n+                                                                   .withComponentVersion(\"1.0.0\");\n+            CreateComponentArtifactUploadUrlResult artifactUploadUrlResult\n+                    = cmsClient.createComponentArtifactUploadUrl(artifactUploadUrlRequest);\n+            URL s3PreSignedURL = new URL(artifactUploadUrlResult.getUrl());\n+            HttpURLConnection connection = (HttpURLConnection) s3PreSignedURL.openConnection();\n+            connection.setDoOutput(true);\n+            connection.setRequestMethod(\"PUT\");\n+            OutputStreamWriter out = new OutputStreamWriter(connection.getOutputStream());\n+            out.write(\"Integration test artifact for Evergreen Kernel\");\n+            out.close();\n+        } catch (Exception e) {\n+            System.out.println(e.toString());\n+        }\n+        */\n+    }\n+\n+    @AfterAll\n+    static void tearDown() {\n+        try {\n+            kernel.shutdown();\n+        } finally {\n+            DeleteComponentRequest deleteComponentRequest\n+                    = new DeleteComponentRequest().withComponentName(\"KernelIntegTest\")\n+                    .withComponentVersion(\"1.0.0\");\n+            DeleteComponentResult result = cmsClient.deleteComponent(deleteComponentRequest);\n+            assertEquals(200, result.getSdkHttpMetadata().getHttpStatusCode());\n+        }\n+    }\n+\n+    @Test\n+    void GIVEN_package_identifier_WHEN_request_package_from_cms_service_THEN_package_downloaded_with_artifacts()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUzMjAwOA==", "bodyText": "Added a test case for that as well", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432532008", "createdAt": "2020-05-29T14:39:17Z", "author": {"login": "chaurah"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.packagemanager;\n+\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import com.aws.iot.evergreen.integrationtests.e2e.BaseE2ETestCase;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.io.FileMatchers.anExistingDirectory;\n+import static org.hamcrest.io.FileMatchers.anExistingFile;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@ExtendWith(EGExtension.class)\n+@Tag(\"E2E\")\n+class PackageManagerE2ETest extends BaseE2ETestCase {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerE2ETest.class.getResource(\"onlyMain.yaml\").toString());\n+        Utils.updateKernelConfigWithComponentManagementServiceConfiguration(kernel);\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =\n+                Paths.get(PackageManagerE2ETest.class.getResource(\"test_packages\").toURI())\n+                     .resolve(\"KernelIntegTest-1.0.0\");\n+\n+        Path testRecipePath = testPackagePath.resolve(\"recipe.yaml\");\n+        ByteBuffer recipeBuf = ByteBuffer.wrap(Files.readAllBytes(testRecipePath));\n+        try {\n+            CreateComponentRequest createComponentRequest = new CreateComponentRequest().withRecipe(recipeBuf);\n+            CreateComponentResult createComponentResult = cmsClient.createComponent(createComponentRequest);\n+            assertEquals(\"DRAFT\", createComponentResult.getStatus());\n+\n+            CreateComponentArtifactUploadUrlRequest artifactUploadUrlRequest\n+                    = new CreateComponentArtifactUploadUrlRequest().withArtifactName(\"kernel_integ_test_artifact.txt\")\n+                                                                   .withComponentName(\"KernelIntegTest\")\n+                                                                   .withComponentVersion(\"1.0.0\");\n+            CreateComponentArtifactUploadUrlResult artifactUploadUrlResult\n+                    = cmsClient.createComponentArtifactUploadUrl(artifactUploadUrlRequest);\n+            URL s3PreSignedURL = new URL(artifactUploadUrlResult.getUrl());\n+            HttpURLConnection connection = (HttpURLConnection) s3PreSignedURL.openConnection();\n+            connection.setDoOutput(true);\n+            connection.setRequestMethod(\"PUT\");\n+            OutputStreamWriter out = new OutputStreamWriter(connection.getOutputStream());\n+            out.write(\"Integration test artifact for Evergreen Kernel\");\n+            out.close();\n+        } catch (Exception e) {\n+            System.out.println(e.toString());\n+        }\n+        */\n+    }\n+\n+    @AfterAll\n+    static void tearDown() {\n+        try {\n+            kernel.shutdown();\n+        } finally {\n+            DeleteComponentRequest deleteComponentRequest\n+                    = new DeleteComponentRequest().withComponentName(\"KernelIntegTest\")\n+                    .withComponentVersion(\"1.0.0\");\n+            DeleteComponentResult result = cmsClient.deleteComponent(deleteComponentRequest);\n+            assertEquals(200, result.getSdkHttpMetadata().getHttpStatusCode());\n+        }\n+    }\n+\n+    @Test\n+    void GIVEN_package_identifier_WHEN_request_package_from_cms_service_THEN_package_downloaded_with_artifacts()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxOTA4Nw=="}, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 126}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDIwMDgzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNToyMDoxOVrOGb6Uqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTozMDowMFrOGb6wjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyMDI5OA==", "bodyText": "Agree with earlier comments we should not both log and throw.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431920298", "createdAt": "2020-05-28T15:20:19Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,72 +1,106 @@\n package com.aws.iot.evergreen.packagemanager;\n \n import com.amazonaws.AmazonClientException;\n-import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n-import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ComponentNameVersion;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ResolvedComponent;\n+import com.aws.iot.evergreen.config.PlatformResolver;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n import com.aws.iot.evergreen.util.SerializerFactory;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+import com.vdurmont.semver4j.Requirement;\n+import com.vdurmont.semver4j.Semver;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n-    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n-\n+    private static final String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n     private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n-\n+    private static final String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement)\n+            throws PackageDownloadException {\n+        FindComponentVersionsByPlatformRequest findComponentRequest =\n+                new FindComponentVersionsByPlatformRequest().withComponentName(packageName)\n+                        .withVersionConstraint(versionRequirement.toString())\n+                        .withPlatform(PlatformResolver.getPlatform());\n+\n+        try {\n+            FindComponentVersionsByPlatformResult findComponentResult =\n+                    evgPmsClient.findComponentVersionsByPlatform(findComponentRequest);\n+\n+            List<ResolvedComponent> componentSelectedMetadataList = findComponentResult.getComponents();\n+\n+            return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+                PackageIdentifier packageIdentifier\n+                        = new PackageIdentifier(componentMetadata.getComponentName(),\n+                                                new Semver(componentMetadata.getComponentVersion()),\n+                                                componentMetadata.getComponentARN());\n+                return new PackageMetadata(packageIdentifier, componentMetadata.getDependencies().stream().collect(\n+                        Collectors.toMap(ComponentNameVersion::getComponentName,\n+                                         ComponentNameVersion::getComponentVersionConstraint)));\n+            }).collect(Collectors.toList());\n+        } catch (AmazonClientException e) {\n+            // TODO: This should be expanded to handle various types of retryable/non-retryable exceptions\n+            logger.atError(\"download-package-from-greengrass-repo\", e)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyNzQzNw==", "bodyText": "Updating", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r431927437", "createdAt": "2020-05-28T15:30:00Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,72 +1,106 @@\n package com.aws.iot.evergreen.packagemanager;\n \n import com.amazonaws.AmazonClientException;\n-import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n-import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ComponentNameVersion;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ResolvedComponent;\n+import com.aws.iot.evergreen.config.PlatformResolver;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n import com.aws.iot.evergreen.util.SerializerFactory;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+import com.vdurmont.semver4j.Requirement;\n+import com.vdurmont.semver4j.Semver;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n-    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n-\n+    private static final String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n     private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n-\n+    private static final String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement)\n+            throws PackageDownloadException {\n+        FindComponentVersionsByPlatformRequest findComponentRequest =\n+                new FindComponentVersionsByPlatformRequest().withComponentName(packageName)\n+                        .withVersionConstraint(versionRequirement.toString())\n+                        .withPlatform(PlatformResolver.getPlatform());\n+\n+        try {\n+            FindComponentVersionsByPlatformResult findComponentResult =\n+                    evgPmsClient.findComponentVersionsByPlatform(findComponentRequest);\n+\n+            List<ResolvedComponent> componentSelectedMetadataList = findComponentResult.getComponents();\n+\n+            return componentSelectedMetadataList.stream().map(componentMetadata -> {\n+                PackageIdentifier packageIdentifier\n+                        = new PackageIdentifier(componentMetadata.getComponentName(),\n+                                                new Semver(componentMetadata.getComponentVersion()),\n+                                                componentMetadata.getComponentARN());\n+                return new PackageMetadata(packageIdentifier, componentMetadata.getDependencies().stream().collect(\n+                        Collectors.toMap(ComponentNameVersion::getComponentName,\n+                                         ComponentNameVersion::getComponentVersionConstraint)));\n+            }).collect(Collectors.toList());\n+        } catch (AmazonClientException e) {\n+            // TODO: This should be expanded to handle various types of retryable/non-retryable exceptions\n+            logger.atError(\"download-package-from-greengrass-repo\", e)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyMDI5OA=="}, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDY5MTY1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoyNDoxNVrOGb_Saw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoyNDoxNVrOGb_Saw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAwMTY0Mw==", "bodyText": "nit: since you renamed, probably change the this.pvgPmsClient as well...", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432001643", "createdAt": "2020-05-28T17:24:15Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,72 +1,106 @@\n package com.aws.iot.evergreen.packagemanager;\n \n import com.amazonaws.AmazonClientException;\n-import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n-import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ComponentNameVersion;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ResolvedComponent;\n+import com.aws.iot.evergreen.config.PlatformResolver;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n import com.aws.iot.evergreen.util.SerializerFactory;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+import com.vdurmont.semver4j.Requirement;\n+import com.vdurmont.semver4j.Semver;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n-    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n-\n+    private static final String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n     private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n-\n+    private static final String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDY5NzI0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoyNTo0MFrOGb_V7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzo0OTo0NlrOGcAKnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAwMjU0Mw==", "bodyText": "If the SDK doesn't log automatically, log the request and response since we will need them for debugging issues with CMS interactions.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432002543", "createdAt": "2020-05-28T17:25:40Z", "author": {"login": "leaf94"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,72 +1,106 @@\n package com.aws.iot.evergreen.packagemanager;\n \n import com.amazonaws.AmazonClientException;\n-import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n-import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ComponentNameVersion;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ResolvedComponent;\n+import com.aws.iot.evergreen.config.PlatformResolver;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n import com.aws.iot.evergreen.util.SerializerFactory;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+import com.vdurmont.semver4j.Requirement;\n+import com.vdurmont.semver4j.Semver;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n-    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n-\n+    private static final String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n     private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n-\n+    private static final String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement)\n+            throws PackageDownloadException {\n+        FindComponentVersionsByPlatformRequest findComponentRequest =\n+                new FindComponentVersionsByPlatformRequest().withComponentName(packageName)\n+                        .withVersionConstraint(versionRequirement.toString())\n+                        .withPlatform(PlatformResolver.getPlatform());\n+\n+        try {\n+            FindComponentVersionsByPlatformResult findComponentResult =\n+                    evgPmsClient.findComponentVersionsByPlatform(findComponentRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxNjAzMQ==", "bodyText": "Automatically logged :)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432016031", "createdAt": "2020-05-28T17:49:46Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/GreengrassPackageServiceHelper.java", "diffHunk": "@@ -1,72 +1,106 @@\n package com.aws.iot.evergreen.packagemanager;\n \n import com.amazonaws.AmazonClientException;\n-import com.amazonaws.services.greengrasspackagemanagement.AWSGreengrassPackageManagement;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageRequest;\n-import com.amazonaws.services.greengrasspackagemanagement.model.GetPackageResult;\n-import com.amazonaws.services.greengrasspackagemanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ComponentNameVersion;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.FindComponentVersionsByPlatformResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.GetComponentResult;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.RecipeFormatType;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.ResolvedComponent;\n+import com.aws.iot.evergreen.config.PlatformResolver;\n import com.aws.iot.evergreen.logging.api.Logger;\n import com.aws.iot.evergreen.logging.impl.LogManager;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageDownloadException;\n import com.aws.iot.evergreen.packagemanager.exceptions.PackageLoadingException;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.models.PackageMetadata;\n import com.aws.iot.evergreen.packagemanager.models.PackageRecipe;\n import com.aws.iot.evergreen.util.SerializerFactory;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.util.ByteBufferBackedInputStream;\n+import com.vdurmont.semver4j.Requirement;\n+import com.vdurmont.semver4j.Semver;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n+import java.util.List;\n+import java.util.stream.Collectors;\n import javax.inject.Inject;\n \n public class GreengrassPackageServiceHelper {\n \n-    private static String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n-    private static String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n-\n+    private static final String PACKAGE_RECIPE_PARSING_EXCEPTION_FMT = \"Error parsing downloaded recipe for package %s\";\n     private static final ObjectMapper RECIPE_SERIALIZER = SerializerFactory.getRecipeSerializer();\n-\n+    private static final String PACKAGE_RECIPE_DOWNLOAD_EXCEPTION_FMT = \"Error downloading recipe for package %s\";\n     // Service logger instance\n     protected final Logger logger = LogManager.getLogger(GreengrassPackageServiceHelper.class);\n \n-    private final AWSGreengrassPackageManagement evgPmsClient;\n+    private final AWSGreengrassComponentManagement evgPmsClient;\n \n     @Inject\n     public GreengrassPackageServiceHelper(GreengrassPackageServiceClientFactory clientFactory) {\n-        this.evgPmsClient = clientFactory.getPmsClient();\n+        this.evgPmsClient = clientFactory.getCmsClient();\n+    }\n+\n+    List<PackageMetadata> listAvailablePackageMetadata(String packageName, Requirement versionRequirement)\n+            throws PackageDownloadException {\n+        FindComponentVersionsByPlatformRequest findComponentRequest =\n+                new FindComponentVersionsByPlatformRequest().withComponentName(packageName)\n+                        .withVersionConstraint(versionRequirement.toString())\n+                        .withPlatform(PlatformResolver.getPlatform());\n+\n+        try {\n+            FindComponentVersionsByPlatformResult findComponentResult =\n+                    evgPmsClient.findComponentVersionsByPlatform(findComponentRequest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAwMjU0Mw=="}, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDcwMzM2OnYy", "diffSide": "RIGHT", "path": "src/test/resources/com/aws/iot/evergreen/packagemanager/test_packages/MonitoringService-1.1.0/recipe.yaml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoyNzoyMVrOGb_Z3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoyNzoyMVrOGb_Z3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAwMzU0OQ==", "bodyText": "Thanks for fixing all these....", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432003549", "createdAt": "2020-05-28T17:27:21Z", "author": {"login": "leaf94"}, "path": "src/test/resources/com/aws/iot/evergreen/packagemanager/test_packages/MonitoringService-1.1.0/recipe.yaml", "diffHunk": "@@ -16,7 +16,8 @@ Lifecycle:\n       skipif: onpath git\n       script: brew install git\n Artifacts:\n-  - greengrass:monitor_artifact_100.txt\n+  all:\n+    - greengrass:monitor_artifact_100.txt", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MTgwMzM0OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMzozODoyM1rOGcKPtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNDozOTo1M1rOGcfrjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE4MTE3NA==", "bodyText": "Question. Is this package \"KernelIntegTest\" actually downloaded from CMS?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432181174", "createdAt": "2020-05-28T23:38:23Z", "author": {"login": "hui-yang"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.packagemanager;\n+\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import com.aws.iot.evergreen.integrationtests.e2e.BaseE2ETestCase;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.io.FileMatchers.anExistingDirectory;\n+import static org.hamcrest.io.FileMatchers.anExistingFile;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@ExtendWith(EGExtension.class)\n+@Tag(\"E2E\")\n+class PackageManagerE2ETest extends BaseE2ETestCase {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerE2ETest.class.getResource(\"onlyMain.yaml\").toString());\n+        Utils.updateKernelConfigWithComponentManagementServiceConfiguration(kernel);\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =\n+                Paths.get(PackageManagerE2ETest.class.getResource(\"test_packages\").toURI())\n+                     .resolve(\"KernelIntegTest-1.0.0\");\n+\n+        Path testRecipePath = testPackagePath.resolve(\"recipe.yaml\");\n+        ByteBuffer recipeBuf = ByteBuffer.wrap(Files.readAllBytes(testRecipePath));\n+        try {\n+            CreateComponentRequest createComponentRequest = new CreateComponentRequest().withRecipe(recipeBuf);\n+            CreateComponentResult createComponentResult = cmsClient.createComponent(createComponentRequest);\n+            assertEquals(\"DRAFT\", createComponentResult.getStatus());\n+\n+            CreateComponentArtifactUploadUrlRequest artifactUploadUrlRequest\n+                    = new CreateComponentArtifactUploadUrlRequest().withArtifactName(\"kernel_integ_test_artifact.txt\")\n+                                                                   .withComponentName(\"KernelIntegTest\")\n+                                                                   .withComponentVersion(\"1.0.0\");\n+            CreateComponentArtifactUploadUrlResult artifactUploadUrlResult\n+                    = cmsClient.createComponentArtifactUploadUrl(artifactUploadUrlRequest);\n+            URL s3PreSignedURL = new URL(artifactUploadUrlResult.getUrl());\n+            HttpURLConnection connection = (HttpURLConnection) s3PreSignedURL.openConnection();\n+            connection.setDoOutput(true);\n+            connection.setRequestMethod(\"PUT\");\n+            OutputStreamWriter out = new OutputStreamWriter(connection.getOutputStream());\n+            out.write(\"Integration test artifact for Evergreen Kernel\");\n+            out.close();\n+        } catch (Exception e) {\n+            System.out.println(e.toString());\n+        }\n+        */\n+    }\n+\n+    @AfterAll\n+    static void tearDown() {\n+        try {\n+            kernel.shutdown();\n+        } finally {\n+            DeleteComponentRequest deleteComponentRequest\n+                    = new DeleteComponentRequest().withComponentName(\"KernelIntegTest\")\n+                    .withComponentVersion(\"1.0.0\");\n+            DeleteComponentResult result = cmsClient.deleteComponent(deleteComponentRequest);\n+            assertEquals(200, result.getSdkHttpMetadata().getHttpStatusCode());\n+        }\n+    }\n+\n+    @Test\n+    void GIVEN_package_identifier_WHEN_request_package_from_cms_service_THEN_package_downloaded_with_artifacts()\n+            throws Exception {\n+        PackageIdentifier pkgIdt\n+                = new PackageIdentifier(\"KernelIntegTest\", new Semver(\"1.0.0\", SemverType.NPM));\n+        List<PackageIdentifier> pkgList = new ArrayList<>();\n+        pkgList.add(pkgIdt);\n+        Future<Void> testFuture = packageManager.preparePackages(pkgList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUzMjM2Ng==", "bodyText": "yes, the package is coming from CMS.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432532366", "createdAt": "2020-05-29T14:39:53Z", "author": {"login": "chaurah"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/packagemanager/PackageManagerE2ETest.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.e2e.packagemanager;\n+\n+import com.amazonaws.services.greengrasscomponentmanagement.AWSGreengrassComponentManagement;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentRequest;\n+import com.amazonaws.services.greengrasscomponentmanagement.model.DeleteComponentResult;\n+\n+import com.aws.iot.evergreen.integrationtests.e2e.BaseE2ETestCase;\n+import com.aws.iot.evergreen.integrationtests.e2e.util.Utils;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.packagemanager.GreengrassPackageServiceClientFactory;\n+import com.aws.iot.evergreen.packagemanager.PackageManager;\n+import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.testcommons.testutilities.EGExtension;\n+import com.vdurmont.semver4j.Semver;\n+import com.vdurmont.semver4j.Semver.SemverType;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.io.FileMatchers.anExistingDirectory;\n+import static org.hamcrest.io.FileMatchers.anExistingFile;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@ExtendWith(EGExtension.class)\n+@Tag(\"E2E\")\n+class PackageManagerE2ETest extends BaseE2ETestCase {\n+\n+    // Based on PackageManager.java\n+    private static final String RECIPE_DIRECTORY = \"recipes\";\n+    private static final String ARTIFACT_DIRECTORY = \"artifacts\";\n+\n+    private static PackageManager packageManager;\n+    private static Path packageStorePath;\n+    private static AWSGreengrassComponentManagement cmsClient;\n+\n+    private static Kernel kernel;\n+\n+    @TempDir\n+    static Path rootDir;\n+\n+    @BeforeAll\n+    static void setupKernel() throws IOException, URISyntaxException {\n+        System.setProperty(\"root\", rootDir.toAbsolutePath().toString());\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-i\", PackageManagerE2ETest.class.getResource(\"onlyMain.yaml\").toString());\n+        Utils.updateKernelConfigWithComponentManagementServiceConfiguration(kernel);\n+\n+        // The integration test will pick up credentials from the default provider chain\n+        // In automated testing, the device environment should ideally have credentials for all tests\n+        // For dev work, this requires you to have a working set of AWS Credentials on your dev box and/or your IDE\n+        // environment\n+\n+        kernel.launch();\n+\n+        // get required instances from context\n+        packageManager = kernel.getContext().get(PackageManager.class);\n+        packageStorePath = kernel.getPackageStorePath();\n+\n+        cmsClient = kernel.getContext().get(GreengrassPackageServiceClientFactory.class).getCmsClient();\n+\n+        // TODO: Ideally integ test should clean up after itself. Unfortunately the delete API is not implemented\n+        // on the service side yet. Enable this code when that is ready. You'll also need to add the required import\n+        // statements. The delete code is already included in @AfterAll tagged function below\n+        /*\n+        Path testPackagePath =\n+                Paths.get(PackageManagerE2ETest.class.getResource(\"test_packages\").toURI())\n+                     .resolve(\"KernelIntegTest-1.0.0\");\n+\n+        Path testRecipePath = testPackagePath.resolve(\"recipe.yaml\");\n+        ByteBuffer recipeBuf = ByteBuffer.wrap(Files.readAllBytes(testRecipePath));\n+        try {\n+            CreateComponentRequest createComponentRequest = new CreateComponentRequest().withRecipe(recipeBuf);\n+            CreateComponentResult createComponentResult = cmsClient.createComponent(createComponentRequest);\n+            assertEquals(\"DRAFT\", createComponentResult.getStatus());\n+\n+            CreateComponentArtifactUploadUrlRequest artifactUploadUrlRequest\n+                    = new CreateComponentArtifactUploadUrlRequest().withArtifactName(\"kernel_integ_test_artifact.txt\")\n+                                                                   .withComponentName(\"KernelIntegTest\")\n+                                                                   .withComponentVersion(\"1.0.0\");\n+            CreateComponentArtifactUploadUrlResult artifactUploadUrlResult\n+                    = cmsClient.createComponentArtifactUploadUrl(artifactUploadUrlRequest);\n+            URL s3PreSignedURL = new URL(artifactUploadUrlResult.getUrl());\n+            HttpURLConnection connection = (HttpURLConnection) s3PreSignedURL.openConnection();\n+            connection.setDoOutput(true);\n+            connection.setRequestMethod(\"PUT\");\n+            OutputStreamWriter out = new OutputStreamWriter(connection.getOutputStream());\n+            out.write(\"Integration test artifact for Evergreen Kernel\");\n+            out.close();\n+        } catch (Exception e) {\n+            System.out.println(e.toString());\n+        }\n+        */\n+    }\n+\n+    @AfterAll\n+    static void tearDown() {\n+        try {\n+            kernel.shutdown();\n+        } finally {\n+            DeleteComponentRequest deleteComponentRequest\n+                    = new DeleteComponentRequest().withComponentName(\"KernelIntegTest\")\n+                    .withComponentVersion(\"1.0.0\");\n+            DeleteComponentResult result = cmsClient.deleteComponent(deleteComponentRequest);\n+            assertEquals(200, result.getSdkHttpMetadata().getHttpStatusCode());\n+        }\n+    }\n+\n+    @Test\n+    void GIVEN_package_identifier_WHEN_request_package_from_cms_service_THEN_package_downloaded_with_artifacts()\n+            throws Exception {\n+        PackageIdentifier pkgIdt\n+                = new PackageIdentifier(\"KernelIntegTest\", new Semver(\"1.0.0\", SemverType.NPM));\n+        List<PackageIdentifier> pkgList = new ArrayList<>();\n+        pkgList.add(pkgIdt);\n+        Future<Void> testFuture = packageManager.preparePackages(pkgList);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE4MTE3NA=="}, "originalCommit": {"oid": "62d7cbfc18f74007d3335e7c98eb50dd3a263754"}, "originalPosition": 132}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NDY2NTg4OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzo0NzowN1rOGcmazA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzo1MzoyOVrOGcmnYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0Mjc2NA==", "bodyText": "We only need to set region in one of these methods right? Or is this intentional?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432642764", "createdAt": "2020-05-29T17:47:07Z", "author": {"login": "hui-yang"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -60,7 +60,9 @@ private void launchKernel(String configFile) throws IOException, InterruptedExce\n         kernel = new Kernel()\n                 .parseArgs(\"-i\", DeploymentE2ETest.class.getResource(configFile).toString(), \"-r\", tempRootDir\n                         .toAbsolutePath().toString());\n+\n         deviceProvisioningHelper.updateKernelConfigWithIotConfiguration(kernel, thingInfo, BETA_REGION.toString());\n+        deviceProvisioningHelper.updateKernelConfigWithCMSConfiguration(kernel, BETA_REGION.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "479df77bb20336ca2e21013f7d26352b2b96ab5d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0NTk4Nw==", "bodyText": "Intentional, I would have had to refactor the provisioning helper, it doesn't store the current region at the moment. Didn't want to further increase the size of this PR.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/246#discussion_r432645987", "createdAt": "2020-05-29T17:53:29Z", "author": {"login": "chaurah"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/deployment/DeploymentE2ETest.java", "diffHunk": "@@ -60,7 +60,9 @@ private void launchKernel(String configFile) throws IOException, InterruptedExce\n         kernel = new Kernel()\n                 .parseArgs(\"-i\", DeploymentE2ETest.class.getResource(configFile).toString(), \"-r\", tempRootDir\n                         .toAbsolutePath().toString());\n+\n         deviceProvisioningHelper.updateKernelConfigWithIotConfiguration(kernel, thingInfo, BETA_REGION.toString());\n+        deviceProvisioningHelper.updateKernelConfigWithCMSConfiguration(kernel, BETA_REGION.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0Mjc2NA=="}, "originalCommit": {"oid": "479df77bb20336ca2e21013f7d26352b2b96ab5d"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4718, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}