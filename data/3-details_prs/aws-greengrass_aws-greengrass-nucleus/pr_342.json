{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwMjM2ODM0", "number": 342, "title": "Ku04 - Kernel can restart from the existing root directory and pick up previous configurations", "bodyText": "Issue #, if available:\nhttps://sim.amazon.com/issues/P38075943\nDescription of changes:\n\nSee the KernelTlog.svg for the new workflow.\nSee the new README.md for two potential but not real issue documented.\nMove the reading external config from KernelCommandLine to KernelLifecycle.\n\nWhy is this change necessary:\nGIVEN kernel has been started with some root dir and shut down gracefully,\nWHEN kernel is started again (via easysetup?) from the loader script with the same root dir,\nTHEN kernel returns to the state before it was shut down.\nHow was this change tested:\n\nUpdated unit tests in KernelLifecycleTest to actually verify different paths of loading configs/tlogs, rather than verify(config).read(any(Path.class))\nAdded 4 new integration test cases for restarting kernel in both a new KernelRestartTest and KernelTest\n\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-07-31T15:14:18Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342", "merged": true, "mergeCommit": {"oid": "e6f5dff3e893cea94dffedaaa9ad00bd529cc928"}, "closed": true, "closedAt": "2020-08-03T23:33:03Z", "author": {"login": "leaf94"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6ONT7AH2gAyNDYwMjM2ODM0OmM5MDc1NjM4ODQzMDAzNDg5YWViOTkxMjYzMjAyYWM5NDFmZWI3YTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7aWcyAFqTQ2MDM5NTE5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c9075638843003489aeb991263202ac941feb7a3", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c9075638843003489aeb991263202ac941feb7a3", "committedDate": "2020-07-31T06:26:54Z", "message": "Fix reading tlog for kernel restarting and add integ tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38eb711d9da22ab0f931e8c59d66015f4e593cb4", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/38eb711d9da22ab0f931e8c59d66015f4e593cb4", "committedDate": "2020-07-31T06:32:07Z", "message": "comment update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76f146fb629198bfb413296ded10ae6beb9bf29b", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/76f146fb629198bfb413296ded10ae6beb9bf29b", "committedDate": "2020-07-31T07:22:18Z", "message": "add readme"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc86021a6e4f9f06f9b437cb527ada4d9aed167", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5fc86021a6e4f9f06f9b437cb527ada4d9aed167", "committedDate": "2020-07-31T07:22:49Z", "message": "Merge remote-tracking branch 'origin/master' into ku04"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76a8e9350e2f007a8b092a283cbfbab5abcd793d", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/76a8e9350e2f007a8b092a283cbfbab5abcd793d", "committedDate": "2020-07-31T15:09:29Z", "message": "done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd8c1837ffef058df0a78cf3b03e4a5c03a4141b", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd8c1837ffef058df0a78cf3b03e4a5c03a4141b", "committedDate": "2020-07-31T15:11:23Z", "message": "done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bfaf70f3c9da3e7b6a6fd97ca5bd2c3d992f960", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0bfaf70f3c9da3e7b6a6fd97ca5bd2c3d992f960", "committedDate": "2020-07-31T15:16:25Z", "message": "license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96d05d6f0064dfe92b1507e4939d28cc0dd0ad7a", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/96d05d6f0064dfe92b1507e4939d28cc0dd0ad7a", "committedDate": "2020-07-31T15:17:42Z", "message": "typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3447c9708afd75502d3ee4b939337f22f9173c5c", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3447c9708afd75502d3ee4b939337f22f9173c5c", "committedDate": "2020-07-31T15:18:14Z", "message": "kerneltest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "627ef628ee5e2000392be1088e705fe931049c0b", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/627ef628ee5e2000392be1088e705fe931049c0b", "committedDate": "2020-07-31T15:18:59Z", "message": "kerneltest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MjYxNTI1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#pullrequestreview-459261525", "createdAt": "2020-07-31T15:24:22Z", "commit": {"oid": "627ef628ee5e2000392be1088e705fe931049c0b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNToyNDoyMlrOG6MjcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNToyNjo1MVrOG6MpEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NjI3Mg==", "bodyText": "Should we actually flip these, since that's the behavior when it is running; it reads the config then writes changes to tlog?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#discussion_r463676272", "createdAt": "2020-07-31T15:24:22Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java", "diffHunk": "@@ -114,6 +91,42 @@ public void launch() {\n         startupAllServices();\n     }\n \n+    private void initConfigAndTlog() {\n+        Path transactionLogPath = kernel.getConfigPath().resolve(\"config.tlog\");\n+        Path configurationFile = kernel.getConfigPath().resolve(\"config.yaml\");\n+\n+\n+        try {\n+            if (Objects.nonNull(kernelCommandLine.getProvidedConfigPathName())) {\n+                // If a config file is provided, kernel will use the provided file as a new base\n+                // and ignore existing config and tlog files.\n+                // This ideally should only used for testing and not in production\n+                kernel.getConfig().read(kernelCommandLine.getProvidedConfigPathName());\n+            } else {\n+                // if tlog presents, read the tlog first, because the yaml config file may not be up to date\n+                if (Files.exists(transactionLogPath)) {\n+                    kernel.getConfig().read(transactionLogPath);\n+                }\n+\n+                // if configuration file is available, merge it. It will be merged with file's last modified timestamp\n+                if (Files.exists(configurationFile)) {\n+                    kernel.getConfig().read(configurationFile);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "627ef628ee5e2000392be1088e705fe931049c0b"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3Njc3Mw==", "bodyText": "[nit]\nJust say in-memory", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#discussion_r463676773", "createdAt": "2020-07-31T15:25:05Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/README.md", "diffHunk": "@@ -0,0 +1,27 @@\n+# Kernel\n+\n+### How kernel reads config.tlog and config.yaml when starting\n+![Alt text](kernelTlog.svg)\n+\n+### Potential issues\n+Ideally right after we create the in-mem config, we should", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "627ef628ee5e2000392be1088e705fe931049c0b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NjgzOQ==", "bodyText": "provide alt text", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#discussion_r463676839", "createdAt": "2020-07-31T15:25:11Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/README.md", "diffHunk": "@@ -0,0 +1,27 @@\n+# Kernel\n+\n+### How kernel reads config.tlog and config.yaml when starting\n+![Alt text](kernelTlog.svg)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "627ef628ee5e2000392be1088e705fe931049c0b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY3NzcxMg==", "bodyText": "get rid of effectiveConfig.evg? Since you're writing it into the main config file?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#discussion_r463677712", "createdAt": "2020-07-31T15:26:51Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/KernelLifecycle.java", "diffHunk": "@@ -114,6 +91,42 @@ public void launch() {\n         startupAllServices();\n     }\n \n+    private void initConfigAndTlog() {\n+        Path transactionLogPath = kernel.getConfigPath().resolve(\"config.tlog\");\n+        Path configurationFile = kernel.getConfigPath().resolve(\"config.yaml\");\n+\n+\n+        try {\n+            if (Objects.nonNull(kernelCommandLine.getProvidedConfigPathName())) {\n+                // If a config file is provided, kernel will use the provided file as a new base\n+                // and ignore existing config and tlog files.\n+                // This ideally should only used for testing and not in production\n+                kernel.getConfig().read(kernelCommandLine.getProvidedConfigPathName());\n+            } else {\n+                // if tlog presents, read the tlog first, because the yaml config file may not be up to date\n+                if (Files.exists(transactionLogPath)) {\n+                    kernel.getConfig().read(transactionLogPath);\n+                }\n+\n+                // if configuration file is available, merge it. It will be merged with file's last modified timestamp\n+                if (Files.exists(configurationFile)) {\n+                    kernel.getConfig().read(configurationFile);\n+                }\n+            }\n+\n+            // write new tlog and config files\n+            kernel.writeEffectiveConfigAsTransactionLog(transactionLogPath);\n+            kernel.writeEffectiveConfig(configurationFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "627ef628ee5e2000392be1088e705fe931049c0b"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MzMyNDQ4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#pullrequestreview-459332448", "createdAt": "2020-07-31T17:14:23Z", "commit": {"oid": "627ef628ee5e2000392be1088e705fe931049c0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNzoxNDoyNFrOG6P6Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNzoxNDoyNFrOG6P6Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzczMTIyMw==", "bodyText": "I'm not fully understanding this statement but, we do want to be able to update system config or what you're calling provisioning config here via deployments, since those updates go to the tlog file, when restarting next time for whatever reason, that history should not be wiped out", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#discussion_r463731223", "createdAt": "2020-07-31T17:14:24Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/README.md", "diffHunk": "@@ -0,0 +1,27 @@\n+# Kernel\n+\n+### How kernel reads config.tlog and config.yaml when starting\n+![Alt text](kernelTlog.svg)\n+\n+### Potential issues\n+Ideally right after we create the in-mem config, we should\n+1. decide if kernel needs to merge from existing tlog/config file to restore the history\n+1. hook up the tlog listener so that every update to in-mem config is then captured to tlog automatically.\n+\n+But now both 1 and 2 are done at later stage. This causes two potential issues but neither is a real issue now. It may \n+become real issue if some conditions changes. So we are documenting them below.\n+\n+1. Since the tlog listener only created at very late stage, a potential problem is that the changes to in-mem config \n+before the listener gets hooked up will be only in the memory. \n+\n+   1. We get around this problem by dumping the in-mem to a \n+new tlog file right after we have merged existing tlog/config.\n+\n+2. Since kernel merges from existing tlog/config file after the provision step, and the provision step updates the \n+in-mem config, a potential issue is that the provision step will always update in-mem config, without knowing the \n+histories from existing tlog/config files. \n+\n+   1. This is not a real issue for now because the provision step will only \n+be executed if a user specifies doing so. When a user specifies that he or she wants to do provision, then it's fine\n+to always update in-mem config and ignores the history in tlog. But this condition may change in the future.\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "627ef628ee5e2000392be1088e705fe931049c0b"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acb4859272382824f4bd277bc4fb344a185d2511", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/acb4859272382824f4bd277bc4fb344a185d2511", "committedDate": "2020-07-31T18:35:25Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "689f4bb5f396572b10b9925dac2e5a1f1da6d902", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/689f4bb5f396572b10b9925dac2e5a1f1da6d902", "committedDate": "2020-07-31T18:35:50Z", "message": "change freq back to 15 sec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c51f7672244d3ffab53b85898e7e632d3be77564", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c51f7672244d3ffab53b85898e7e632d3be77564", "committedDate": "2020-07-31T18:58:14Z", "message": "update test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "044dc0067c492d9c2a6a5047d894dc0798b18588", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/044dc0067c492d9c2a6a5047d894dc0798b18588", "committedDate": "2020-07-31T20:10:08Z", "message": "Fix E2E"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "046ce5e5d0dee101c607970ef4885daadc047950", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/046ce5e5d0dee101c607970ef4885daadc047950", "committedDate": "2020-07-31T23:39:29Z", "message": "Merge branch 'master' into ku04"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c91040d41a470d0dbb626cc030b14abb24139054", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c91040d41a470d0dbb626cc030b14abb24139054", "committedDate": "2020-07-31T23:44:52Z", "message": "PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aca28159014ab1cd512cc566766e274158db30a0", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aca28159014ab1cd512cc566766e274158db30a0", "committedDate": "2020-08-03T16:49:26Z", "message": "Merge branch 'master' into ku04"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31c906b1124334135b7a126b26bcb3403a537a6a", "author": {"user": {"login": "leaf94", "name": "Ethan Huang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/31c906b1124334135b7a126b26bcb3403a537a6a", "committedDate": "2020-08-03T20:29:30Z", "message": "Merge branch 'master' into ku04"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzkwMDYx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#pullrequestreview-460390061", "createdAt": "2020-08-03T22:54:51Z", "commit": {"oid": "31c906b1124334135b7a126b26bcb3403a537a6a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzk1MTk5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/342#pullrequestreview-460395199", "createdAt": "2020-08-03T23:09:40Z", "commit": {"oid": "31c906b1124334135b7a126b26bcb3403a537a6a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2969, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}