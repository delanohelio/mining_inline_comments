{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNTkyNzY3", "number": 703, "title": "Add deployment fixes to kernel update", "bodyText": "Issue #, if available:\nDescription of changes:\n\nMake sure common logic of deployment and kernel update are shared, i.e. config validation and merging\nFix the exit code of bootstrap failure. Should be 100 to request Nucleus restart directly\n\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-19T00:20:29Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703", "merged": true, "mergeCommit": {"oid": "cd53b856337a7af92dfc82ca088f15fb3d63f161"}, "closed": true, "closedAt": "2020-11-25T17:17:14Z", "author": {"login": "hui-yang"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd3j-rgFqTUzMzk4NzI1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgAL-5AFqTUzODYxOTU4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTg3MjU4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#pullrequestreview-533987258", "createdAt": "2020-11-19T00:22:49Z", "commit": {"oid": "2bed7ea0af8636146ca07048b211e7da030a8757"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDoyMjo1MFrOH2HpOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDoyMjo1MFrOH2HpOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxMDM5Mg==", "bodyText": "remove inject from the fields if they are coming in through the constructor.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#discussion_r526510392", "createdAt": "2020-11-19T00:22:50Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -50,6 +52,8 @@\n \n     @Inject\n     private Kernel kernel;\n+    @Inject\n+    private DynamicComponentConfigurationValidator validator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bed7ea0af8636146ca07048b211e7da030a8757"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2ODMzNTI0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#pullrequestreview-536833524", "createdAt": "2020-11-23T20:48:15Z", "commit": {"oid": "2bed7ea0af8636146ca07048b211e7da030a8757"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bed7ea0af8636146ca07048b211e7da030a8757", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2bed7ea0af8636146ca07048b211e7da030a8757", "committedDate": "2020-11-19T00:17:05Z", "message": "Add deployment fixes to kernel update"}, "afterCommit": {"oid": "8e6201d6594237d8237292e12ace3a97c9480046", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e6201d6594237d8237292e12ace3a97c9480046", "committedDate": "2020-11-24T03:13:35Z", "message": "Add deployment fixes to kernel update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b31994e92a760c92f91335bd392e00c65b9e98b1", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b31994e92a760c92f91335bd392e00c65b9e98b1", "committedDate": "2020-11-24T21:39:28Z", "message": "Add deployment fixes to kernel update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dc47be9c618e03d936396f3bf7d81d28923ee43", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3dc47be9c618e03d936396f3bf7d81d28923ee43", "committedDate": "2020-11-24T22:02:51Z", "message": "Update config merging of Nucleus-type component"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e6201d6594237d8237292e12ace3a97c9480046", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e6201d6594237d8237292e12ace3a97c9480046", "committedDate": "2020-11-24T03:13:35Z", "message": "Add deployment fixes to kernel update"}, "afterCommit": {"oid": "3dc47be9c618e03d936396f3bf7d81d28923ee43", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3dc47be9c618e03d936396f3bf7d81d28923ee43", "committedDate": "2020-11-24T22:02:51Z", "message": "Update config merging of Nucleus-type component"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDE3NjI0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#pullrequestreview-538017624", "createdAt": "2020-11-24T22:25:54Z", "commit": {"oid": "3dc47be9c618e03d936396f3bf7d81d28923ee43"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13c7399594cf58c024a325aedc9a26aaa5ae6130", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/13c7399594cf58c024a325aedc9a26aaa5ae6130", "committedDate": "2020-11-24T23:33:34Z", "message": "Merge branch 'master' into ku-fix-2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MDkzMTcy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#pullrequestreview-538093172", "createdAt": "2020-11-25T01:34:48Z", "commit": {"oid": "13c7399594cf58c024a325aedc9a26aaa5ae6130"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMTozNDo0OFrOH5fxPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMTozNDo0OFrOH5fxPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA1MTM5MA==", "bodyText": "Maybe I miss something here, isn't line295 duplicate of line 287?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#discussion_r530051390", "createdAt": "2020-11-25T01:34:48Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/componentmanager/KernelConfigResolver.java", "diffHunk": "@@ -280,6 +286,15 @@ private void updateRunWith(RunWith runWith, Map<String, Object> resolvedServiceC\n                 if (configuration != null) {\n                     currentRunningConfig.copyFrom(configuration);\n                 }\n+            } else if (ComponentType.NUCLEUS.equals(componentRecipe.getComponentType())) {\n+                // Copy from existing Nucleus config (if any)\n+                Topics nucleusTopics = kernel.findServiceTopic(deviceConfiguration.getNucleusComponentName());\n+                if (nucleusTopics != null) {\n+                    Topics nucleusConfig = nucleusTopics.findTopics(CONFIGURATION_CONFIG_KEY);\n+                    if (nucleusConfig != null) {\n+                        currentRunningConfig.copyFrom(nucleusConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c7399594cf58c024a325aedc9a26aaa5ae6130"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53ad2d2a322c35b8f9703da9d30de61af0bdb5ef", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/53ad2d2a322c35b8f9703da9d30de61af0bdb5ef", "committedDate": "2020-11-25T01:43:55Z", "message": "Merge branch 'master' into ku-fix-2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTUyMzc3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#pullrequestreview-538152377", "createdAt": "2020-11-25T04:41:13Z", "commit": {"oid": "53ad2d2a322c35b8f9703da9d30de61af0bdb5ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNDo0MToxM1rOH5i_Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNDo0MToxM1rOH5i_Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNDE1MQ==", "bodyText": "We don't need this?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#discussion_r530104151", "createdAt": "2020-11-25T04:41:13Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/KernelCommandLine.java", "diffHunk": "@@ -141,12 +154,6 @@ private void initPaths(String rootAbsolutePath) {\n             nucleusPaths.setTelemetryPath(TelemetryConfig.getInstance().getStoreDirectory());\n             String storeDirectory = LogManager.getRootLogConfiguration().getStoreDirectory().toAbsolutePath()\n                     .toString();\n-            Topic outputDirectoryTopic = deviceConfiguration.getLoggingConfigurationTopics()\n-                    .lookup(\"outputDirectory\");\n-            String outputDirectory = Coerce.toString(outputDirectoryTopic);\n-            if (Utils.isNotEmpty(outputDirectory)) {\n-                storeDirectory = deTilde(outputDirectory);\n-            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53ad2d2a322c35b8f9703da9d30de61af0bdb5ef"}, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTUyNjk1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#pullrequestreview-538152695", "createdAt": "2020-11-25T04:42:18Z", "commit": {"oid": "53ad2d2a322c35b8f9703da9d30de61af0bdb5ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NjE5NTgz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/703#pullrequestreview-538619583", "createdAt": "2020-11-25T15:35:54Z", "commit": {"oid": "53ad2d2a322c35b8f9703da9d30de61af0bdb5ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2714, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}