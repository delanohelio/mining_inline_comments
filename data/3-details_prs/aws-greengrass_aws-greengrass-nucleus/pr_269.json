{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NDQ5MjQ4", "number": 269, "title": "Add version to builtin services", "bodyText": "Issue #, if available:\nDescription of changes:\nAdds versions to builtin services using @ImplementsService, cleans up config merging for builtin services and removes all checks for instanceof GenericExternalService since that is a very bad assumption to have in the kernel.\nNow, it will use whether the service is autostart or not in the same way it had been using that check; since that is really what it was getting at.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-06-03T20:50:12Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/269", "merged": true, "mergeCommit": {"oid": "b0a3b5f9d354d464da7b7ef81a50fe97bf8c9a7b"}, "closed": true, "closedAt": "2020-06-04T21:39:28Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoBjCtAFqTQyNDY2NDgxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoE2j0AFqTQyNDg0NTA0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NjY0ODE0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/269#pullrequestreview-424664814", "createdAt": "2020-06-04T17:18:30Z", "commit": {"oid": "c046246f513eb9aac4087e2a04ede4612ce62763"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNzoxODozMFrOGfP-nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNzoyMTozM1rOGfQFqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyMDgyOA==", "bodyText": "Will the auto start services all use the kernel version? or they will have individual versions?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/269#discussion_r435420828", "createdAt": "2020-06-04T17:18:30Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/dependency/ImplementsService.java", "diffHunk": "@@ -20,4 +20,9 @@\n      * True if the service should start immediately when Kernel starts.\n      */\n     boolean autostart() default false;\n+\n+    /**\n+     * Version of the service. By default it is 0.0.0. Must be in the form of a.b.c.\n+     */\n+    @Nonnull String version() default \"0.0.0\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c046246f513eb9aac4087e2a04ede4612ce62763"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyMTQ0OQ==", "bodyText": "Will this cause unintentional removal of evergreen services like IPCService?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/269#discussion_r435421449", "createdAt": "2020-06-04T17:19:32Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -297,7 +299,6 @@ private boolean isAutoRollbackRequested(FailureHandlingPolicy failureHandlingPol\n          */\n         public AggregateServicesChangeManager(Kernel kernel, Map<String, Object> newServiceConfig) {\n             Set<String> runningUserServices = kernel.orderedDependencies().stream()\n-                    .filter(evergreenService -> evergreenService instanceof GenericExternalService)\n                     .map(EvergreenService::getName).collect(Collectors.toSet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c046246f513eb9aac4087e2a04ede4612ce62763"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQyMjYzNA==", "bodyText": "I'm wondering if we want to expose the 'autostart' concept, maybe it's just easier to start all 'autostart' services before kernel start main, in this case we don't need to change 'main' topics .", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/269#discussion_r435422634", "createdAt": "2020-06-04T17:21:33Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -361,16 +362,26 @@ public void reinstallBrokenServices() throws ServiceLoadException {\n          */\n         public void removeObsoleteServices() throws InterruptedException, ExecutionException {\n             Set<Future<Void>> serviceClosedFutures = new HashSet<>();\n-            servicesToRemove.forEach(serviceName -> {\n+            servicesToRemove = servicesToRemove.stream().filter(serviceName -> {\n                 try {\n                     EvergreenService eg = kernel.locate(serviceName);\n+\n+                    // If the service is an autostart service, then do not close it and do not\n+                    // remove it from the config\n+                    ImplementsService serviceAnnotation = eg.getClass().getAnnotation(ImplementsService.class);\n+                    if (serviceAnnotation != null && serviceAnnotation.autostart()) {\n+                        return false;\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c046246f513eb9aac4087e2a04ede4612ce62763"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NzI0MDc1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/269#pullrequestreview-424724075", "createdAt": "2020-06-04T18:31:45Z", "commit": {"oid": "c046246f513eb9aac4087e2a04ede4612ce62763"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxODozMTo0NVrOGfSwBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxODo0NDoxNFrOGfTUfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NjI0Nw==", "bodyText": "nit: return false if service does not exist.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/269#discussion_r435466247", "createdAt": "2020-06-04T18:31:45Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -361,16 +362,26 @@ public void reinstallBrokenServices() throws ServiceLoadException {\n          */\n         public void removeObsoleteServices() throws InterruptedException, ExecutionException {\n             Set<Future<Void>> serviceClosedFutures = new HashSet<>();\n-            servicesToRemove.forEach(serviceName -> {\n+            servicesToRemove = servicesToRemove.stream().filter(serviceName -> {\n                 try {\n                     EvergreenService eg = kernel.locate(serviceName);\n+\n+                    // If the service is an autostart service, then do not close it and do not\n+                    // remove it from the config\n+                    ImplementsService serviceAnnotation = eg.getClass().getAnnotation(ImplementsService.class);\n+                    if (serviceAnnotation != null && serviceAnnotation.autostart()) {\n+                        return false;\n+                    }\n+\n                     serviceClosedFutures.add(eg.close());\n                 } catch (ServiceLoadException e) {\n                     logger.atError().setCause(e).addKeyValue(\"serviceName\", serviceName)\n                             .log(\"Could not locate EvergreenService to close service\");\n                     // No need to handle the error when trying to stop a non-existing service.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c046246f513eb9aac4087e2a04ede4612ce62763"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3NTU4MA==", "bodyText": "Why do we check evergreenService.getServiceConfig().find(\"autostart\") here but not in removeObsoleteServices?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/269#discussion_r435475580", "createdAt": "2020-06-04T18:44:14Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -186,11 +186,13 @@ private String replace(String stringValue, PackageIdentifier packageIdentifier,\n      * Compute the config for main service\n      */\n     private Map<Object, Object> getMainConfig(List<String> rootPackages) {\n-\n         Map<Object, Object> mainServiceConfig = new HashMap<>();\n         ArrayList<String> mainDependencies = new ArrayList<>(rootPackages);\n         kernel.getMain().getDependencies().forEach((evergreenService, dependencyType) -> {\n-            if (!(evergreenService instanceof GenericExternalService)) {\n+            // Add all autostart dependencies\n+            ImplementsService serviceAnnotation = evergreenService.getClass().getAnnotation(ImplementsService.class);\n+            if (serviceAnnotation != null && serviceAnnotation.autostart()\n+                    || evergreenService.getServiceConfig().find(\"autostart\") != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c046246f513eb9aac4087e2a04ede4612ce62763"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0c5c61c52ec44aae61e73ac0842700ed0e35679", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e0c5c61c52ec44aae61e73ac0842700ed0e35679", "committedDate": "2020-06-04T18:46:56Z", "message": "Add version to builtin services"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b0295de1c3fc4c32ef0447cf6ef5a66d3086fe0", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1b0295de1c3fc4c32ef0447cf6ef5a66d3086fe0", "committedDate": "2020-06-04T18:58:42Z", "message": "Address PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c046246f513eb9aac4087e2a04ede4612ce62763", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c046246f513eb9aac4087e2a04ede4612ce62763", "committedDate": "2020-06-03T20:45:24Z", "message": "Add version to builtin services"}, "afterCommit": {"oid": "1b0295de1c3fc4c32ef0447cf6ef5a66d3086fe0", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1b0295de1c3fc4c32ef0447cf6ef5a66d3086fe0", "committedDate": "2020-06-04T18:58:42Z", "message": "Address PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NzY0MDE2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/269#pullrequestreview-424764016", "createdAt": "2020-06-04T19:29:57Z", "commit": {"oid": "1b0295de1c3fc4c32ef0447cf6ef5a66d3086fe0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0ODQ1MDQy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/269#pullrequestreview-424845042", "createdAt": "2020-06-04T21:22:16Z", "commit": {"oid": "1b0295de1c3fc4c32ef0447cf6ef5a66d3086fe0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2243, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}