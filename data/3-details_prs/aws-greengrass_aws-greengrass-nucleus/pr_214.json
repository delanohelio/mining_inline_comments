{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NzA4Njk2", "number": 214, "title": "Fix race condition between reported state and actual state", "bodyText": "Issue #, if available:\nDescription of changes:\nFixes a race condition in the GenericExternalService's callbacks which check for the current state. There is a race between the reported state and the actual \"processed\" state. The service reports running, then exits very quickly which triggers the callback. The lifecycle thread hasn't yet processed the state change, so technically it is still \"INSTALLED\" and not yet \"RUNNING\", so the equality check would fail, causing the tick-tock service to be stuck \"RUNNING\" and never moves to \"FINISHED\".\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-24T18:45:27Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/214", "merged": true, "mergeCommit": {"oid": "eef33d597548771131ffea4167e7faf113098168"}, "closed": true, "closedAt": "2020-04-24T22:26:17Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABca2gSNgH2gAyNDA4NzA4Njk2OjgwNDk4YWU5ZjU4ZTRmZTQ5NDlmNzAxNWM2MjFhM2NmZDk1NDk0Y2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABca5J3ugFqTQwMDMwMzk5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "80498ae9f58e4fe4949f7015c621a3cfd95494ce", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/80498ae9f58e4fe4949f7015c621a3cfd95494ce", "committedDate": "2020-04-24T19:18:15Z", "message": "Fix race condition between reported state and actual state"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1837b66cc3c96fb325b30fc4c0e80148a5fdcaba", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1837b66cc3c96fb325b30fc4c0e80148a5fdcaba", "committedDate": "2020-04-24T18:44:46Z", "message": "Fix race condition between reported state and actual state"}, "afterCommit": {"oid": "80498ae9f58e4fe4949f7015c621a3cfd95494ce", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/80498ae9f58e4fe4949f7015c621a3cfd95494ce", "committedDate": "2020-04-24T19:18:15Z", "message": "Fix race condition between reported state and actual state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMjg0NTUw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/214#pullrequestreview-400284550", "createdAt": "2020-04-24T21:34:27Z", "commit": {"oid": "80498ae9f58e4fe4949f7015c621a3cfd95494ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTozNDoyN1rOGLqCww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTozNDoyN1rOGLqCww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg3NjM1NQ==", "bodyText": "I think you can have an AtomicReference to keep track of last reported state", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/214#discussion_r414876355", "createdAt": "2020-04-24T21:34:27Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -672,4 +672,9 @@ final void requestStop() {\n             desiredStateList.add(State.FINISHED);\n         }\n     }\n+\n+    Optional<State> lastReportedState() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80498ae9f58e4fe4949f7015c621a3cfd95494ce"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMjk3NDM4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/214#pullrequestreview-400297438", "createdAt": "2020-04-24T22:05:30Z", "commit": {"oid": "80498ae9f58e4fe4949f7015c621a3cfd95494ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzAzOTk0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/214#pullrequestreview-400303994", "createdAt": "2020-04-24T22:23:29Z", "commit": {"oid": "80498ae9f58e4fe4949f7015c621a3cfd95494ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2162, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}