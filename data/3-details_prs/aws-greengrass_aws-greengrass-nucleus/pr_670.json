{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMDUxMDgy", "number": 670, "title": "React to nucleus config changes", "bodyText": "Issue #, if available:\nNoticed a few places where clients/connections are not reconfigured on certain system config changes like the IoT Connection manager, the new GCS dataplane logic etc and the region config change was not handled anywhere\nDescription of changes:\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-12T17:45:55Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670", "merged": true, "mergeCommit": {"oid": "df8fde3246b82b68103faf04a711565b8a6114bd"}, "closed": true, "closedAt": "2020-11-13T21:26:42Z", "author": {"login": "shaguptashaikh"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb2r10gFqTUyOTM2MjU0Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcNkQegH2gAyNTIwMDUxMDgyOmQ0OGZlNjZlM2Q2MzAyZTE4ZjAzYTJmMTkyOWFkZDM2YWJhMzdjZTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MzYyNTQ2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#pullrequestreview-529362546", "createdAt": "2020-11-12T18:15:57Z", "commit": {"oid": "739da653a2fc7d86c2fb6d596a0a9f542bb5553b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODoxNTo1N1rOHyHqIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODoxNTo1N1rOHyHqIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMxNjMyMA==", "bodyText": "Noticed inconsistencies between the naming here and the actual naming used in the DeviceConfiguration, so it's better to remove these from here because we don't always remember to change it here if it changes in the code, this was here just so if customers see this recipe they know what things they can change", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522316320", "createdAt": "2020-11-12T18:15:57Z", "author": {"login": "shaguptashaikh"}, "path": "aws.greengrass.Nucleus.yaml", "diffHunk": "@@ -8,18 +8,6 @@ ComponentVersion: '1.0.0'\n ComponentConfiguration:\n   DefaultConfiguration:\n     jvmOptions: -Xms512m -Xmx512m\n-    iotDataEndpoint: \"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "739da653a2fc7d86c2fb6d596a0a9f542bb5553b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3db931dfcc8d70a53a7cbdfa58577b3960cdaab8", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3db931dfcc8d70a53a7cbdfa58577b3960cdaab8", "committedDate": "2020-11-12T18:17:25Z", "message": "React to nucleus config changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "739da653a2fc7d86c2fb6d596a0a9f542bb5553b", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/739da653a2fc7d86c2fb6d596a0a9f542bb5553b", "committedDate": "2020-11-12T17:46:08Z", "message": "Merge branch 'master' into system-config"}, "afterCommit": {"oid": "3db931dfcc8d70a53a7cbdfa58577b3960cdaab8", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3db931dfcc8d70a53a7cbdfa58577b3960cdaab8", "committedDate": "2020-11-12T18:17:25Z", "message": "React to nucleus config changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MzgwNTMz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#pullrequestreview-529380533", "createdAt": "2020-11-12T18:39:25Z", "commit": {"oid": "75ef437de2efa68c25c4d94f8fa3177936842a98"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODozOToyNVrOHyIijg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MzozMlrOHyIscA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMDc2Ng==", "bodyText": "by removing all of these, the console won't be able to show any configuration, we'll have to just rely on our documentation to explain all the options. Is that desirable?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522330766", "createdAt": "2020-11-12T18:39:25Z", "author": {"login": "MikeDombo"}, "path": "aws.greengrass.Nucleus.yaml", "diffHunk": "@@ -8,18 +8,6 @@ ComponentVersion: '1.0.0'\n ComponentConfiguration:\n   DefaultConfiguration:\n     jvmOptions: -Xms512m -Xmx512m\n-    iotDataEndpoint: \"\"\n-    iotCredEndpoint: \"\"\n-    privateKeyPath: \"\"\n-    certificateFilePath: \"\"\n-    rootCaPath: \"\"\n-    awsRegion: \"\"\n-    iotRoleAlias: \"\"\n-    mqtt: {}\n-    networkProxy: {}\n-    runWithDefault: {}\n-    deploymentPollingFrequency: 15L\n-    componentStoreMaxSize: 10_000_000_000L", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75ef437de2efa68c25c4d94f8fa3177936842a98"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMjIwOQ==", "bodyText": "let's get rid of this context crap. We can just use the device configuration or any of the many other methods to get the URL", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522332209", "createdAt": "2020-11-12T18:41:39Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -24,54 +26,75 @@\n import org.apache.http.conn.ssl.SSLConnectionSocketFactory;\n \n import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n import java.security.GeneralSecurityException;\n import java.security.KeyStore;\n import java.security.PrivateKey;\n import java.security.cert.Certificate;\n import java.security.cert.X509Certificate;\n import java.util.List;\n import javax.inject.Inject;\n-import javax.inject.Named;\n import javax.net.ssl.KeyManager;\n import javax.net.ssl.KeyManagerFactory;\n import javax.net.ssl.SSLContext;\n import javax.net.ssl.TrustManager;\n import javax.net.ssl.TrustManagerFactory;\n import javax.security.auth.x500.X500Principal;\n \n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_AWS_REGION;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_ROOT_CA_PATH;\n+\n @Getter\n @SuppressWarnings(\"PMD.ConfusingTernary\")\n public class GreengrassComponentServiceClientFactory {\n \n     public static final String CONTEXT_COMPONENT_SERVICE_ENDPOINT = \"greengrassServiceEndpoint\";\n     private static final Logger logger = LogManager.getLogger(GreengrassComponentServiceClientFactory.class);\n \n-    private final AWSEvergreen cmsClient;\n+    private AWSEvergreen cmsClient;\n \n     /**\n      * Constructor with custom endpoint/region configuration.\n      *\n-     * @param greengrassServiceEndpoint String containing service endpoint\n+     * @param context Context object\n      * @param deviceConfiguration       Device configuration\n      */\n     @Inject\n-    public GreengrassComponentServiceClientFactory(\n-            @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration) {\n+    public GreengrassComponentServiceClientFactory(Context context, DeviceConfiguration deviceConfiguration) {\n+        configureClient((String) context.getvIfExists(CONTEXT_COMPONENT_SERVICE_ENDPOINT).get(), deviceConfiguration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75ef437de2efa68c25c4d94f8fa3177936842a98"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMzI5Ng==", "bodyText": "let's get rid of this.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522333296", "createdAt": "2020-11-12T18:43:32Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/Kernel.java", "diffHunk": "@@ -554,10 +555,14 @@ private void setupCloudEndpoint() {\n             throw new RuntimeException(e);\n         }\n \n-        String region = Coerce.toString(deviceConfiguration.getAWSRegion());\n-        String endpoint = RegionUtils.getGreengrassDataPlaneEndpoint(region, stage);\n-        logger.atInfo().log(\"Configured to use Greengrass endpoint: {}\", endpoint);\n-        context.put(CONTEXT_COMPONENT_SERVICE_ENDPOINT, endpoint);\n+        deviceConfiguration.getAWSRegion().subscribe((what, node) -> {\n+            String region = Coerce.toString(node);\n+            if (Utils.isNotEmpty(region)) {\n+                String endpoint = RegionUtils.getGreengrassDataPlaneEndpoint(region, stage);\n+                logger.atInfo().log(\"Configured to use Greengrass endpoint: {}\", endpoint);\n+                context.put(CONTEXT_COMPONENT_SERVICE_ENDPOINT, endpoint);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75ef437de2efa68c25c4d94f8fa3177936842a98"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9cde0c2c9bbc897a6a18aa3247c8a863ee15c46", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e9cde0c2c9bbc897a6a18aa3247c8a863ee15c46", "committedDate": "2020-11-12T21:05:17Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75ef437de2efa68c25c4d94f8fa3177936842a98", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/75ef437de2efa68c25c4d94f8fa3177936842a98", "committedDate": "2020-11-12T18:25:55Z", "message": "Merge branch 'master' into system-config"}, "afterCommit": {"oid": "e9cde0c2c9bbc897a6a18aa3247c8a863ee15c46", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e9cde0c2c9bbc897a6a18aa3247c8a863ee15c46", "committedDate": "2020-11-12T21:05:17Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d2c5346522d345e4c6a0339285fd24cbd5dfeee", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5d2c5346522d345e4c6a0339285fd24cbd5dfeee", "committedDate": "2020-11-12T21:05:55Z", "message": "Merge branch 'master' into system-config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTQwMjUw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#pullrequestreview-529540250", "createdAt": "2020-11-12T22:10:24Z", "commit": {"oid": "5d2c5346522d345e4c6a0339285fd24cbd5dfeee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoxMDoyNFrOHyQS4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoxMDoyNFrOHyQS4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ1NzgyNQ==", "bodyText": "Why || of validString? Is this trying to check if any of these settings changed and then validate those?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#discussion_r522457825", "createdAt": "2020-11-12T22:10:24Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/GreengrassComponentServiceClientFactory.java", "diffHunk": "@@ -11,70 +11,93 @@\n import com.amazonaws.client.builder.AwsClientBuilder.EndpointConfiguration;\n import com.amazonaws.services.evergreen.AWSEvergreen;\n import com.amazonaws.services.evergreen.AWSEvergreenClientBuilder;\n+import com.aws.greengrass.config.Node;\n import com.aws.greengrass.deployment.DeviceConfiguration;\n import com.aws.greengrass.logging.api.Logger;\n import com.aws.greengrass.logging.impl.LogManager;\n import com.aws.greengrass.util.Coerce;\n import com.aws.greengrass.util.EncryptionUtils;\n+import com.aws.greengrass.util.IotSdkClientFactory;\n import com.aws.greengrass.util.ProxyUtils;\n+import com.aws.greengrass.util.RegionUtils;\n import com.aws.greengrass.util.Utils;\n+import com.aws.greengrass.util.exceptions.InvalidEnvironmentStageException;\n import com.aws.greengrass.util.exceptions.TLSAuthException;\n import lombok.Getter;\n import org.apache.http.conn.ssl.NoopHostnameVerifier;\n import org.apache.http.conn.ssl.SSLConnectionSocketFactory;\n \n import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n import java.security.GeneralSecurityException;\n import java.security.KeyStore;\n import java.security.PrivateKey;\n import java.security.cert.Certificate;\n import java.security.cert.X509Certificate;\n import java.util.List;\n import javax.inject.Inject;\n-import javax.inject.Named;\n import javax.net.ssl.KeyManager;\n import javax.net.ssl.KeyManagerFactory;\n import javax.net.ssl.SSLContext;\n import javax.net.ssl.TrustManager;\n import javax.net.ssl.TrustManagerFactory;\n import javax.security.auth.x500.X500Principal;\n \n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_AWS_REGION;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_CERTIFICATE_FILE_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_PRIVATE_KEY_PATH;\n+import static com.aws.greengrass.deployment.DeviceConfiguration.DEVICE_PARAM_ROOT_CA_PATH;\n+\n @Getter\n @SuppressWarnings(\"PMD.ConfusingTernary\")\n public class GreengrassComponentServiceClientFactory {\n \n-    public static final String CONTEXT_COMPONENT_SERVICE_ENDPOINT = \"greengrassServiceEndpoint\";\n     private static final Logger logger = LogManager.getLogger(GreengrassComponentServiceClientFactory.class);\n \n-    private final AWSEvergreen cmsClient;\n+    private AWSEvergreen cmsClient;\n \n     /**\n      * Constructor with custom endpoint/region configuration.\n      *\n-     * @param greengrassServiceEndpoint String containing service endpoint\n      * @param deviceConfiguration       Device configuration\n      */\n     @Inject\n-    public GreengrassComponentServiceClientFactory(\n-            @Named(CONTEXT_COMPONENT_SERVICE_ENDPOINT) String greengrassServiceEndpoint,\n-            DeviceConfiguration deviceConfiguration) {\n+    public GreengrassComponentServiceClientFactory(DeviceConfiguration deviceConfiguration) {\n+        configureClient(deviceConfiguration);\n+        deviceConfiguration.onAnyChange((what, node) -> {\n+            if (validString(node, DEVICE_PARAM_AWS_REGION) || validPath(node, DEVICE_PARAM_ROOT_CA_PATH) || validPath(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d2c5346522d345e4c6a0339285fd24cbd5dfeee"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTUyNTQ0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#pullrequestreview-529552544", "createdAt": "2020-11-12T22:30:46Z", "commit": {"oid": "5d2c5346522d345e4c6a0339285fd24cbd5dfeee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTUzMDkz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/670#pullrequestreview-529553093", "createdAt": "2020-11-12T22:31:47Z", "commit": {"oid": "5d2c5346522d345e4c6a0339285fd24cbd5dfeee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ac43cd9a990f69b3ccd9303e4b1550d042325f", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/22ac43cd9a990f69b3ccd9303e4b1550d042325f", "committedDate": "2020-11-13T09:23:04Z", "message": "Merge branch 'master' into system-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d48fe66e3d6302e18f03a2f1929add36aba37ce1", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d48fe66e3d6302e18f03a2f1929add36aba37ce1", "committedDate": "2020-11-13T20:55:29Z", "message": "Merge branch 'master' into system-config"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2660, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}