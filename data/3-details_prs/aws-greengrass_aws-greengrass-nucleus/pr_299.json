{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NDc2OTY2", "number": 299, "title": "Fix flaky integ test in DeploymentService mergeConfig", "bodyText": "Issue #, if available:\nDeploymentTaskIntegrationTest failed occasionally due to obsolete service is removed asynchronously.\nDescription of changes:\nIn Topics.remove() , put the logic of 'remove the node from children' synchronous\nWhy is this change necessary:\nHow was this change tested:\nRun DeploymentTaskIntegrationTest 10 times and all passed\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-07-08T20:48:19Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299", "merged": true, "mergeCommit": {"oid": "9229db5155b0467c5cd2c5265894c1758001c863"}, "closed": true, "closedAt": "2020-07-08T23:41:46Z", "author": {"login": "ShirleyZheng92"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczA8tkAFqTQ0NTEyNjYxNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABczCxs3gFqTQ0NTE4ODAyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTI2NjE3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#pullrequestreview-445126617", "createdAt": "2020-07-08T21:02:32Z", "commit": {"oid": "3d7771b473fa9e5c5af790ce26f4eeec3b37836a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMTowMjozMlrOGu5HrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMTowMjozMlrOGu5HrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMzUzMw==", "bodyText": "removeObsoleteServices() is blocking, by the time it returns the service removals would have taken place. why do we wait here then ?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451823533", "createdAt": "2020-07-08T21:02:32Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -202,8 +206,11 @@ private void rollback(String deploymentId, CompletableFuture<DeploymentResult> t\n                     waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n \n                     servicesChangeManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n+                    // block until service removal take place in kernel config\n+                    kernel.getContext().runOnPublishQueueAndWait(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d7771b473fa9e5c5af790ce26f4eeec3b37836a"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTMxMjk2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#pullrequestreview-445131296", "createdAt": "2020-07-08T21:10:12Z", "commit": {"oid": "3d7771b473fa9e5c5af790ce26f4eeec3b37836a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMToxMDoxM1rOGu5V3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMToxMDoxM1rOGu5V3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyNzE2Ng==", "bodyText": "How is this blocking on the service removal? This only waits for logging statements to finish. I think the previous tasks in the queue can be pulled out of the queue but still running.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451827166", "createdAt": "2020-07-08T21:10:13Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -202,8 +206,11 @@ private void rollback(String deploymentId, CompletableFuture<DeploymentResult> t\n                     waitForServicesToStart(servicesToTrackForRollback, mergeTime);\n \n                     servicesChangeManager.removeObsoleteServices();\n-                    logger.atInfo(MERGE_CONFIG_EVENT_KEY).kv(DEPLOYMENT_ID_LOG_KEY, deploymentId)\n+                    // block until service removal take place in kernel config\n+                    kernel.getContext().runOnPublishQueueAndWait(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d7771b473fa9e5c5af790ce26f4eeec3b37836a"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d7771b473fa9e5c5af790ce26f4eeec3b37836a", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3d7771b473fa9e5c5af790ce26f4eeec3b37836a", "committedDate": "2020-07-08T20:42:30Z", "message": "Fix flaky integ test in DeploymentService mergeConfig"}, "afterCommit": {"oid": "09525312fcc06fdadb9200a3b40ccded56f9ab78", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/09525312fcc06fdadb9200a3b40ccded56f9ab78", "committedDate": "2020-07-08T21:16:51Z", "message": "Fix flaky integ test in DeploymentService mergeConfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3980eb85b1c2f082fcfad51f060a03d85674d4b", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f3980eb85b1c2f082fcfad51f060a03d85674d4b", "committedDate": "2020-07-08T21:28:32Z", "message": "Fix flaky integ test in DeploymentService mergeConfig"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09525312fcc06fdadb9200a3b40ccded56f9ab78", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/09525312fcc06fdadb9200a3b40ccded56f9ab78", "committedDate": "2020-07-08T21:16:51Z", "message": "Fix flaky integ test in DeploymentService mergeConfig"}, "afterCommit": {"oid": "f3980eb85b1c2f082fcfad51f060a03d85674d4b", "author": {"user": {"login": "ShirleyZheng92", "name": "Xueli Zheng "}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f3980eb85b1c2f082fcfad51f060a03d85674d4b", "committedDate": "2020-07-08T21:28:32Z", "message": "Fix flaky integ test in DeploymentService mergeConfig"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTQ0MzY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#pullrequestreview-445144365", "createdAt": "2020-07-08T21:32:43Z", "commit": {"oid": "f3980eb85b1c2f082fcfad51f060a03d85674d4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMTozMjo0M1rOGu5-1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMTozMjo0M1rOGu5-1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzNzY1Mw==", "bodyText": "when can this happen?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451837653", "createdAt": "2020-07-08T21:32:43Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/config/Topics.java", "diffHunk": "@@ -250,12 +250,12 @@ public void deepForEachTopic(Consumer<Topic> f) {\n      * @param n node to remove\n      */\n     public void remove(Node n) {\n+        if (!children.remove(n.getName(), n)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3980eb85b1c2f082fcfad51f060a03d85674d4b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTQ0NzY3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#pullrequestreview-445144767", "createdAt": "2020-07-08T21:33:28Z", "commit": {"oid": "f3980eb85b1c2f082fcfad51f060a03d85674d4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMTozMzoyOFrOGu5_8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMTozMzoyOFrOGu5_8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzNzkzNg==", "bodyText": "this comment doesn't seem accurate anymore.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#discussion_r451837936", "createdAt": "2020-07-08T21:33:28Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -189,7 +189,7 @@ private void rollback(String deploymentId, CompletableFuture<DeploymentResult> t\n             return;\n         }\n         // wait until topic listeners finished processing read changes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3980eb85b1c2f082fcfad51f060a03d85674d4b"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTUwMjg5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#pullrequestreview-445150289", "createdAt": "2020-07-08T21:43:55Z", "commit": {"oid": "f3980eb85b1c2f082fcfad51f060a03d85674d4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTg4MDIy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/299#pullrequestreview-445188022", "createdAt": "2020-07-08T23:10:19Z", "commit": {"oid": "f3980eb85b1c2f082fcfad51f060a03d85674d4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2858, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}