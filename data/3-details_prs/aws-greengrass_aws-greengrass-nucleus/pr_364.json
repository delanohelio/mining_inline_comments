{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3NjI0NTcy", "number": 364, "title": "Initial work to support component plugin with integ test", "bodyText": "Issue #, if available:\nDescription of changes:\nInitial support of same-jvm plugin component. Uses recently added ComponentType key =PLUGIN to know to load the recipe as a plugin. It looks for a path of <component name>.jar.\nThis implementation also handles versioning and rollback because it pulls the artifact from the version-specific artifact directory instead of moving the jar file into our \"plugin\" directory which would lose the versioning information and make rollback very difficult.\nTODO: E2E test with add, update, removal. Need to decide how to handle the requirement that kernel restarts for a plugin update (using bootstrap). The easiest thing to do is just say that anyone implementing a plugin needs to override bootstrap and return 100 which would restart the kernel, however we may want to do something else.\nWhy is this change necessary:\nHow was this change tested:\nAdded integration test to verify that a plugin can be loaded in through the config and through a deployment.\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-08-13T20:45:32Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364", "merged": true, "mergeCommit": {"oid": "efc0dbd974842257b8c624bc839b7495ba060aa9"}, "closed": true, "closedAt": "2020-08-17T18:13:39Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-mU2OgFqTQ2NzExODkwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_2e9YAFqTQ2ODcwNzk3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTE4OTA1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#pullrequestreview-467118905", "createdAt": "2020-08-13T20:48:32Z", "commit": {"oid": "e1e0cd50d6f9a8d51cbf3403f0b081bc090c0ee4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDo0ODozM1rOHAdIgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDo0ODozM1rOHAdIgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzOTM2MQ==", "bodyText": "Recommendation generated by Amazon CodeGuru Reviewer. Leave feedback on this recommendation by replying to the comment or by reacting to the comment using emoji.\nProblem\nThis line of code contains a resource that might not be closed properly. Resource leaks can cause your system to slow down or crash.\nFix\nConsider closing the following resource: cl. The resource is referenced in statements at the following line: 96. The resource is returned at line: 99. There are other execution paths that don't close the resource or return it, for example, when FastClasspathScanner constructor throws an exception. To prevent this resource leak, close cl along these other paths before you exit this method.\nMore info\nView resource management guidelines at oracle.com (external link).", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r470239361", "createdAt": "2020-08-13T20:48:33Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/dependency/EZPlugins.java", "diffHunk": "@@ -82,6 +82,23 @@ private void loadPlugins(boolean trusted, Path p) throws IOException {\n         loadPlugins(trusted, cl);\n     }\n \n+    /**\n+     * Load a single plugin with the classpath scanner.\n+     * @param p path to jar file\n+     * @param matcher matcher to use\n+     * @throws IOException if loading the class fails\n+     */\n+    @SuppressWarnings(\"PMD.CloseResource\")\n+    public ClassLoader loadPlugin(Path p, Consumer<FastClasspathScanner> matcher) throws IOException {\n+        URLClassLoader cl = new URLClassLoader(new URL[]{p.toUri().toURL()});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1e0cd50d6f9a8d51cbf3403f0b081bc090c0ee4"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1e0cd50d6f9a8d51cbf3403f0b081bc090c0ee4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e1e0cd50d6f9a8d51cbf3403f0b081bc090c0ee4", "committedDate": "2020-08-13T20:36:39Z", "message": "Initial work to support component plugin with integ test"}, "afterCommit": {"oid": "465a1a9c2a57d8a1cafd990543d5390b60838274", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/465a1a9c2a57d8a1cafd990543d5390b60838274", "committedDate": "2020-08-13T20:53:21Z", "message": "Initial work to support component plugin with integ test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "465a1a9c2a57d8a1cafd990543d5390b60838274", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/465a1a9c2a57d8a1cafd990543d5390b60838274", "committedDate": "2020-08-13T20:53:21Z", "message": "Initial work to support component plugin with integ test"}, "afterCommit": {"oid": "63b2c423d175baddacd3c9a282fa15b22d818a8f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/63b2c423d175baddacd3c9a282fa15b22d818a8f", "committedDate": "2020-08-13T20:59:04Z", "message": "Initial work to support component plugin with integ test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "63b2c423d175baddacd3c9a282fa15b22d818a8f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/63b2c423d175baddacd3c9a282fa15b22d818a8f", "committedDate": "2020-08-13T20:59:04Z", "message": "Initial work to support component plugin with integ test"}, "afterCommit": {"oid": "a9c27720a12f2fab9d78185779ba7e45bef57b0f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a9c27720a12f2fab9d78185779ba7e45bef57b0f", "committedDate": "2020-08-13T21:01:31Z", "message": "Initial work to support component plugin with integ test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9c27720a12f2fab9d78185779ba7e45bef57b0f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a9c27720a12f2fab9d78185779ba7e45bef57b0f", "committedDate": "2020-08-13T21:01:31Z", "message": "Initial work to support component plugin with integ test"}, "afterCommit": {"oid": "3bd3cd6b9e356f19e20e5526bbf0bfb692e3a0db", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3bd3cd6b9e356f19e20e5526bbf0bfb692e3a0db", "committedDate": "2020-08-13T21:57:12Z", "message": "Initial work to support component plugin with integ test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3bd3cd6b9e356f19e20e5526bbf0bfb692e3a0db", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3bd3cd6b9e356f19e20e5526bbf0bfb692e3a0db", "committedDate": "2020-08-13T21:57:12Z", "message": "Initial work to support component plugin with integ test"}, "afterCommit": {"oid": "ba080da24bfc63dee6e9298ee3d61fad0b5c1448", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba080da24bfc63dee6e9298ee3d61fad0b5c1448", "committedDate": "2020-08-13T22:02:43Z", "message": "Initial work to support component plugin with integ test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba080da24bfc63dee6e9298ee3d61fad0b5c1448", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba080da24bfc63dee6e9298ee3d61fad0b5c1448", "committedDate": "2020-08-13T22:02:43Z", "message": "Initial work to support component plugin with integ test"}, "afterCommit": {"oid": "be119b4a1e15cd34bf22b4691c724404188cb325", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/be119b4a1e15cd34bf22b4691c724404188cb325", "committedDate": "2020-08-13T22:40:18Z", "message": "Initial work to support component plugin with integ test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6bc3e997409f16ac66d1eb6d1acbc8ef02b98549", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6bc3e997409f16ac66d1eb6d1acbc8ef02b98549", "committedDate": "2020-08-14T00:23:41Z", "message": "Fix windows"}, "afterCommit": {"oid": "6193b2f5cae21990d9a60c6946f5553ef722478e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6193b2f5cae21990d9a60c6946f5553ef722478e", "committedDate": "2020-08-14T04:40:50Z", "message": "Fix windows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NTY1Nzkx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#pullrequestreview-468565791", "createdAt": "2020-08-17T15:27:16Z", "commit": {"oid": "11564cb6b5ea3334f4ea49df67409560188fa1aa"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNToyNzoxNlrOHBtk9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTo1NDo1M1rOHBuuKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1NzM2Ng==", "bodyText": "So every in jvm component has to be built as plugin.jar? Why can't we use the component name to infer the jar name instead of using hardcoded plugin.jar?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471557366", "createdAt": "2020-08-17T15:27:16Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -427,6 +434,40 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n         });\n     }\n \n+    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    private Class<?> locateExternalPlugin(String name, Topics serviceRootTopics) throws ServiceLoadException {\n+        String jarName = \"plugin.jar\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11564cb6b5ea3334f4ea49df67409560188fa1aa"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1Nzk4OA==", "bodyText": "nit: ident seems an odd abbreviation. Maybe just id or pkgId?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471557988", "createdAt": "2020-08-17T15:28:15Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -427,6 +434,40 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n         });\n     }\n \n+    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    private Class<?> locateExternalPlugin(String name, Topics serviceRootTopics) throws ServiceLoadException {\n+        String jarName = \"plugin.jar\";\n+        PackageIdentifier ident = PackageIdentifier.fromServiceTopics(serviceRootTopics);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11564cb6b5ea3334f4ea49df67409560188fa1aa"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2NzI0OQ==", "bodyText": "Extract plugin to a constant?\nAlso this whole if..else block is getting a bit difficult to read. Maybe add some comments or refactor to private methods with more clear name?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471567249", "createdAt": "2020-08-17T15:41:54Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -355,6 +359,9 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n                     if (n != null) {\n                         cn = ((Map<String, String>) context.getvIfExists(SERVICE_TYPE_TO_CLASS_MAP_KEY).get())\n                                 .get(Coerce.toString(n).toLowerCase());\n+                        if (cn == null && Coerce.toString(n).toLowerCase().equals(\"plugin\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11564cb6b5ea3334f4ea49df67409560188fa1aa"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3MDIwOQ==", "bodyText": "Why change to 0 timestamp?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471570209", "createdAt": "2020-08-17T15:46:01Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -400,7 +407,7 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n                     }\n                     if (clazz.getAnnotation(ImplementsService.class) != null) {\n                         topics.createLeafChild(VERSION_CONFIG_KEY)\n-                                .withValue(clazz.getAnnotation(ImplementsService.class).version());\n+                                .withNewerValue(0L, clazz.getAnnotation(ImplementsService.class).version());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11564cb6b5ea3334f4ea49df67409560188fa1aa"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3NjEwNA==", "bodyText": "This pretty much allows everyone create a plugin jar and run it in evergreen kernel jvm.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#discussion_r471576104", "createdAt": "2020-08-17T15:54:53Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Kernel.java", "diffHunk": "@@ -427,6 +434,40 @@ public EvergreenService locate(String name) throws ServiceLoadException {\n         });\n     }\n \n+    @SuppressWarnings(\"PMD.AvoidCatchingThrowable\")\n+    private Class<?> locateExternalPlugin(String name, Topics serviceRootTopics) throws ServiceLoadException {\n+        String jarName = \"plugin.jar\";\n+        PackageIdentifier ident = PackageIdentifier.fromServiceTopics(serviceRootTopics);\n+        Path pluginJar = context.get(PackageStore.class).resolveArtifactDirectoryPath(ident)\n+                .resolve(jarName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11564cb6b5ea3334f4ea49df67409560188fa1aa"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00444b2ad523305e29ea0bac74120739f10fc17c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/00444b2ad523305e29ea0bac74120739f10fc17c", "committedDate": "2020-08-17T16:17:03Z", "message": "Initial work to support component plugin with integ test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c5b76926d720924fe2ba2034356e2b8ba0109b4", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3c5b76926d720924fe2ba2034356e2b8ba0109b4", "committedDate": "2020-08-17T16:17:03Z", "message": "Fix windows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11564cb6b5ea3334f4ea49df67409560188fa1aa", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/11564cb6b5ea3334f4ea49df67409560188fa1aa", "committedDate": "2020-08-14T22:34:27Z", "message": "Merge branch 'master' into jvm2"}, "afterCommit": {"oid": "026fc6fbb9b8dc662a2bae4c6cd17459b62e6c45", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/026fc6fbb9b8dc662a2bae4c6cd17459b62e6c45", "committedDate": "2020-08-17T16:53:42Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "026fc6fbb9b8dc662a2bae4c6cd17459b62e6c45", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/026fc6fbb9b8dc662a2bae4c6cd17459b62e6c45", "committedDate": "2020-08-17T16:53:42Z", "message": "Address comments"}, "afterCommit": {"oid": "6f6356eedcf73a44e25a64ee24f090e8106bda0c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f6356eedcf73a44e25a64ee24f090e8106bda0c", "committedDate": "2020-08-17T16:56:04Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99965a5d49a786e554d50867caf147ebb49c8f69", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/99965a5d49a786e554d50867caf147ebb49c8f69", "committedDate": "2020-08-17T16:59:29Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f6356eedcf73a44e25a64ee24f090e8106bda0c", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6f6356eedcf73a44e25a64ee24f090e8106bda0c", "committedDate": "2020-08-17T16:56:04Z", "message": "Address comments"}, "afterCommit": {"oid": "99965a5d49a786e554d50867caf147ebb49c8f69", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/99965a5d49a786e554d50867caf147ebb49c8f69", "committedDate": "2020-08-17T16:59:29Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NjgzNjQ2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#pullrequestreview-468683646", "createdAt": "2020-08-17T17:37:22Z", "commit": {"oid": "99965a5d49a786e554d50867caf147ebb49c8f69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NzA3OTcx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/364#pullrequestreview-468707971", "createdAt": "2020-08-17T18:12:00Z", "commit": {"oid": "99965a5d49a786e554d50867caf147ebb49c8f69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2080, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}