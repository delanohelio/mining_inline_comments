{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNTk4MDc4", "number": 693, "title": "TES clear cache", "bodyText": "Issue #, if available:\nDescription of changes:\nReset TES cache when some device config (certPath, caPath, keyPath, thingName, iotRoleAlias) change in the case of IotConnectionManager reconnecting\nWhy is this change necessary:\nHow was this change tested:\nSecurity-3 UAT\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-17T17:59:15Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693", "merged": true, "mergeCommit": {"oid": "6a632defd5f11eb22a642f0886d14bd5ce033f3e"}, "closed": true, "closedAt": "2020-11-18T01:10:56Z", "author": {"login": "youtuyy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdddoAZgBqjQwMDY4NTY1NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddi_sfgFqTUzMjkyMjA4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "299ff7300c859b226aea3452dafd6009972a638b", "author": {"user": {"login": "youtuyy", "name": "Zhaoyan Lin"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/299ff7300c859b226aea3452dafd6009972a638b", "committedDate": "2020-11-17T17:22:02Z", "message": "TES clear cache"}, "afterCommit": {"oid": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee", "author": {"user": {"login": "youtuyy", "name": "Zhaoyan Lin"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/456fdf9d96f97c45dcc205d873c3a78973ecf7ee", "committedDate": "2020-11-17T18:11:50Z", "message": "TES clear cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjgxNTY2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#pullrequestreview-532681566", "createdAt": "2020-11-17T18:44:24Z", "commit": {"oid": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjgwNTIz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#pullrequestreview-532680523", "createdAt": "2020-11-17T18:43:01Z", "commit": {"oid": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODo0MzowMVrOH1D4Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxODo1MDozOFrOH1EK_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMDA5NA==", "bodyText": "Nit: remove whitespace", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525400094", "createdAt": "2020-11-17T18:43:01Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/tes/CredentialRequestHandler.java", "diffHunk": "@@ -340,7 +340,22 @@ private Instant getExpiryPolicyForErr(int statusCode) {\n      */\n     private boolean areCredentialsValid(TESCache cacheEntry) {\n         Instant now = Instant.now(clock);\n-        return now.isBefore(cacheEntry.expiry);\n+        return cacheEntry.credentials != null && now.isBefore(cacheEntry.expiry);\n+    }\n+\n+    /**\n+     * Clear cached credentials.\n+     *\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDQ0Ng==", "bodyText": "can tesCache.get(iotCredentialsPath) ever be null? it doesn't appear to be checked elsewhere", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525404446", "createdAt": "2020-11-17T18:49:55Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/tes/CredentialRequestHandler.java", "diffHunk": "@@ -340,7 +340,22 @@ private Instant getExpiryPolicyForErr(int statusCode) {\n      */\n     private boolean areCredentialsValid(TESCache cacheEntry) {\n         Instant now = Instant.now(clock);\n-        return now.isBefore(cacheEntry.expiry);\n+        return cacheEntry.credentials != null && now.isBefore(cacheEntry.expiry);\n+    }\n+\n+    /**\n+     * Clear cached credentials.\n+     *\n+     */\n+    @SuppressWarnings(\"PMD.NullAssignment\")\n+    public void clearCache() {\n+        if (iotCredentialsPath != null && tesCache.get(iotCredentialsPath) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwNDkyNg==", "bodyText": "does the credential path ever change? does the map ever get cleared of entries?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#discussion_r525404926", "createdAt": "2020-11-17T18:50:38Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/greengrass/tes/CredentialRequestHandler.java", "diffHunk": "@@ -340,7 +340,22 @@ private Instant getExpiryPolicyForErr(int statusCode) {\n      */\n     private boolean areCredentialsValid(TESCache cacheEntry) {\n         Instant now = Instant.now(clock);\n-        return now.isBefore(cacheEntry.expiry);\n+        return cacheEntry.credentials != null && now.isBefore(cacheEntry.expiry);\n+    }\n+\n+    /**\n+     * Clear cached credentials.\n+     *\n+     */\n+    @SuppressWarnings(\"PMD.NullAssignment\")\n+    public void clearCache() {\n+        if (iotCredentialsPath != null && tesCache.get(iotCredentialsPath) != null) {\n+            LOGGER.atDebug().kv(IOT_CRED_PATH_KEY, iotCredentialsPath).log(\"Clearing TES cache\");\n+            TESCache cacheEntry = tesCache.get(iotCredentialsPath);\n+            cacheEntry.credentials = null;\n+            cacheEntry.responseCode = 0;\n+            cacheEntry.expiry = Instant.EPOCH;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df807723b3f18531fadd393e69fdf4ee15e010d7", "author": {"user": {"login": "youtuyy", "name": "Zhaoyan Lin"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/df807723b3f18531fadd393e69fdf4ee15e010d7", "committedDate": "2020-11-17T19:38:32Z", "message": "TES clear cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "456fdf9d96f97c45dcc205d873c3a78973ecf7ee", "author": {"user": {"login": "youtuyy", "name": "Zhaoyan Lin"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/456fdf9d96f97c45dcc205d873c3a78973ecf7ee", "committedDate": "2020-11-17T18:11:50Z", "message": "TES clear cache"}, "afterCommit": {"oid": "df807723b3f18531fadd393e69fdf4ee15e010d7", "author": {"user": {"login": "youtuyy", "name": "Zhaoyan Lin"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/df807723b3f18531fadd393e69fdf4ee15e010d7", "committedDate": "2020-11-17T19:38:32Z", "message": "TES clear cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a230ec4f942d033fa0be6f0a6bbdde578ff0a07e", "author": {"user": {"login": "youtuyy", "name": "Zhaoyan Lin"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a230ec4f942d033fa0be6f0a6bbdde578ff0a07e", "committedDate": "2020-11-17T20:45:33Z", "message": "Merge branch 'master' into tes-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ed309a31fa575d7fc4b732fbf1e5fc1c3050d33", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0ed309a31fa575d7fc4b732fbf1e5fc1c3050d33", "committedDate": "2020-11-17T23:27:54Z", "message": "Merge branch 'master' into tes-cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODk3NTk5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#pullrequestreview-532897599", "createdAt": "2020-11-17T23:28:43Z", "commit": {"oid": "0ed309a31fa575d7fc4b732fbf1e5fc1c3050d33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTIyMDg3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/693#pullrequestreview-532922087", "createdAt": "2020-11-18T00:27:23Z", "commit": {"oid": "0ed309a31fa575d7fc4b732fbf1e5fc1c3050d33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2700, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}