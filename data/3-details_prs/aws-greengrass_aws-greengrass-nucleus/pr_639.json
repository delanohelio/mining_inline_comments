{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MDUzMzI3", "number": 639, "title": "V234938383: Investigate how to allow the AuthorizationHandler to initalize after services are registered", "bodyText": "Details:\nThis ensures that TES handler is registered as component before the default policies are loaded. Also as per the discussion there is no need to register other component operations, since the policies would be merged as a part of recipe after the start up.\nIssue #, if available:\nV234938383: Investigate how to allow the AuthorizationHandler to initalize after services are registered\nDescription of changes:\nThis ensures that TES handler is registered as component before the default policies are loaded. Also as per the discussion there is no need to register other component operations, since the policies would be merged as a part of recipe after the start up.\nWhy is this change necessary:\nBlocker for Opensource\nHow was this change tested:\nUnit Test ans UAT(s) of security from T1 to T11\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-07T01:49:23Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639", "merged": true, "mergeCommit": {"oid": "d4c18cb3a80c1b30f0d9b367bc11ec2137cf203b"}, "closed": true, "closedAt": "2020-11-12T00:08:47Z", "author": {"login": "k-khatri"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaBdZkgH2gAyNTE3MDUzMzI3OjU5NmE3N2E1MzkwODgwOTc5NWQ5ZWJlZjI5ZTU0NjdiNmM0ZGNjOGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbmNWhAH2gAyNTE3MDUzMzI3OjM3M2MzNmI0YjhlZGM2OTc1OGI3ZDQ4YmZmZGVjMTQxOTVkNTU0MzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "596a77a53908809795d9ebef29e5467b6c4dcc8b", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/596a77a53908809795d9ebef29e5467b6c4dcc8b", "committedDate": "2020-11-07T01:41:17Z", "message": "V234938383: Investigate how to allow the AuthorizationHandler to initialize after services are registered\n\nDetails:\nThis ensures that TES handler is registered as component before the default policies are loaded. Also as per the discussion there is no need to register other component operations, since the policies would be merged as a part of recipe after the start up."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTg0NTg3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#pullrequestreview-525584587", "createdAt": "2020-11-07T02:31:08Z", "commit": {"oid": "596a77a53908809795d9ebef29e5467b6c4dcc8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMjozMTowOFrOHvCYSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMjozMTowOFrOHvCYSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDEwNw==", "bodyText": "So I'm guessing we're not able to force TokenExchangeService to start up before the AuthorizationHandler, then?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r519084107", "createdAt": "2020-11-07T02:31:08Z", "author": {"login": "avipinku"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -73,6 +74,8 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n         Map<String, List<AuthorizationPolicy>> componentNameToPolicies = policyParser.parseAllAuthorizationPolicies(\n                 kernel);\n \n+        // Adding TES component and operation before it's default policies are fetched\n+        componentToOperationsMap.put(TOKEN_EXCHANGE_SERVICE_TOPICS, new HashSet<>(Arrays.asList(AUTHZ_TES_OPERATION)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "596a77a53908809795d9ebef29e5467b6c4dcc8b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTg0NjE0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#pullrequestreview-525584614", "createdAt": "2020-11-07T02:31:27Z", "commit": {"oid": "596a77a53908809795d9ebef29e5467b6c4dcc8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMjozMToyN1rOHvCYbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwMjozMToyN1rOHvCYbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA4NDE0MQ==", "bodyText": "You can remove this comment now", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r519084141", "createdAt": "2020-11-07T02:31:27Z", "author": {"login": "avipinku"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -313,9 +316,9 @@ private void isComponentRegistered(String componentName) throws AuthorizationExc\n         }\n         // TODO: [V234938383] solve the issue where the authhandler starts up and loads policies before services", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "596a77a53908809795d9ebef29e5467b6c4dcc8b"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21e5036c5d41d54846a9403324ab06e2ceb38ae1", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/21e5036c5d41d54846a9403324ab06e2ceb38ae1", "committedDate": "2020-11-09T20:06:14Z", "message": "Removing the comments for V234938383"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f016a64a4f8af1aca3b9d6dba595f6d38ac0df32", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f016a64a4f8af1aca3b9d6dba595f6d38ac0df32", "committedDate": "2020-11-09T21:45:20Z", "message": "Merge branch 'master' into AuthHandlerFix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea98ea7aca6163b6b2bc4c508c017569381ff178", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ea98ea7aca6163b6b2bc4c508c017569381ff178", "committedDate": "2020-11-10T07:16:19Z", "message": "Adding MQTT and PubSub components with their respective operations in the AuthorizationHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b1d53a5b6c707fbfc64cf55fb6a9523388c54e0", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b1d53a5b6c707fbfc64cf55fb6a9523388c54e0", "committedDate": "2020-11-10T21:19:19Z", "message": "Fixing the build and adding Unit Test for ad operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc8f6e60929857b7d1bfbc83fa8ccbcc856cbab6", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fc8f6e60929857b7d1bfbc83fa8ccbcc856cbab6", "committedDate": "2020-11-11T00:43:01Z", "message": "Merge branch 'master' into AuthHandlerFix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f8f0505cb283f837fe24e27522267c6bbf78296", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2f8f0505cb283f837fe24e27522267c6bbf78296", "committedDate": "2020-11-11T01:24:27Z", "message": "Merge remote-tracking branch 'origin/master' into AuthHandlerFix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13ba1d0bfa16ea22e9a02d11dfd1dc6ff256f677", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/13ba1d0bfa16ea22e9a02d11dfd1dc6ff256f677", "committedDate": "2020-11-11T17:53:56Z", "message": "Adding the * as operation and fixing the Unit Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb03f6dcec2923c2b66ff170e3b34a1871632f9b", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bb03f6dcec2923c2b66ff170e3b34a1871632f9b", "committedDate": "2020-11-11T19:06:32Z", "message": "Fixing the build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43dde1143dcd0a81fe8d7a55a13aa21fdf725079", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/43dde1143dcd0a81fe8d7a55a13aa21fdf725079", "committedDate": "2020-11-11T19:23:06Z", "message": "Merge remote-tracking branch 'origin/master' into AuthHandlerFix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NDg0NDUx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#pullrequestreview-528484451", "createdAt": "2020-11-11T19:48:01Z", "commit": {"oid": "43dde1143dcd0a81fe8d7a55a13aa21fdf725079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxOTo0ODowMlrOHxb28Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxOTo0ODowMlrOHxb28Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5ODcwNQ==", "bodyText": "why was this section removed?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r521598705", "createdAt": "2020-11-11T19:48:02Z", "author": {"login": "avipinku"}, "path": "src/test/java/com/aws/greengrass/authorization/AuthorizationHandlerTest.java", "diffHunk": "@@ -456,15 +464,6 @@ void GIVEN_authZ_handler_WHEN_loaded_incorrect_config_THEN_load_fails(ExtensionC\n                 Collections.singletonList(getAuthZPolicy()), false);\n         assertTrue(logReceived.await(5, TimeUnit.SECONDS));\n \n-        // Now let the mock return mock topics", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43dde1143dcd0a81fe8d7a55a13aa21fdf725079"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NDg0NTE0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#pullrequestreview-528484514", "createdAt": "2020-11-11T19:48:07Z", "commit": {"oid": "43dde1143dcd0a81fe8d7a55a13aa21fdf725079"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxOTo0ODowOFrOHxb3JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxOTo0ODowOFrOHxb3JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5ODc1Ng==", "bodyText": "nit: we should move these into another method in the same way that we have componentNameToPolicies.putAll(getDefaultPolicies());", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#discussion_r521598756", "createdAt": "2020-11-11T19:48:08Z", "author": {"login": "avipinku"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -69,10 +76,15 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n                                 AuthorizationPolicyParser policyParser) {\n         this.kernel = kernel;\n         this.authModule = authModule;\n+        // Adding TES component and operation before it's default policies are fetched\n+        componentToOperationsMap.put(TOKEN_EXCHANGE_SERVICE_TOPICS, new HashSet<>(Arrays.asList(AUTHZ_TES_OPERATION)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43dde1143dcd0a81fe8d7a55a13aa21fdf725079"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NTE0MjE3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#pullrequestreview-528514217", "createdAt": "2020-11-11T20:34:14Z", "commit": {"oid": "43dde1143dcd0a81fe8d7a55a13aa21fdf725079"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NTMwMjM4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/639#pullrequestreview-528530238", "createdAt": "2020-11-11T20:59:45Z", "commit": {"oid": "43dde1143dcd0a81fe8d7a55a13aa21fdf725079"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eac287460c85c0d5624473f59946633fb5748ef", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9eac287460c85c0d5624473f59946633fb5748ef", "committedDate": "2020-11-11T22:34:37Z", "message": "Merge remote-tracking branch 'origin/master' into AuthHandlerFix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "373c36b4b8edc69758b7d48bffdec14195d55432", "author": {"user": {"login": "k-khatri", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/373c36b4b8edc69758b7d48bffdec14195d55432", "committedDate": "2020-11-11T23:04:10Z", "message": "Merge branch 'master' into AuthHandlerFix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2604, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}