{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMTg0NzMz", "number": 473, "title": "Size limit", "bodyText": "For cleanup, right now we just implement storing the past 2 versions in kernel config (called version and previousVersion). Contents in local store other than these two version will be cleaned up after each deployment.\nSome tests need to be modified because they load all local recipe/artifacts at the beginning and are unaware of the cleanup. So after making the first deployment, the unused local files are removed, which then makes subsequent deployment unable to find files. This is fixed by reloading local files after deployments.\nReorganized package manager preparePackage process to first check for existence, then attempt download.\nIssue #, if available:\nDescription of changes:\n\nAdd cleanup related logic\nAdd new SizeLimitException extends PackageDownloadException for size limit related errors.\nReorganize some exceptions\nAdd and update tests\n\nWhy is this change necessary:\nTo avoid filling up device storage with stale artifacts.\nHow was this change tested:\nunit test, integ test\nAny additional information or context required to review the change:\nhttps://quip-amazon.com/AaoVA3qZbqhf/Evergreen-Component-Store-Size-Limit\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-25T16:15:07Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473", "merged": true, "mergeCommit": {"oid": "79e4821f14b05751c87f9e60cc3f4d8353c9f0ad"}, "closed": true, "closedAt": "2020-10-08T23:59:34Z", "author": {"login": "tilo-chen"}, "timelineItems": {"totalCount": 44, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMYNw-gBqjM4MDg0NTM1ODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQqg2XgFqTUwNTI1MTYzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abf392a21de7442d2f064ebea7c88d14c9b052ca", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/abf392a21de7442d2f064ebea7c88d14c9b052ca", "committedDate": "2020-09-25T16:13:33Z", "message": "change default size"}, "afterCommit": {"oid": "4d5e363c7334efce09d10a55056963f490ef9ed5", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4d5e363c7334efce09d10a55056963f490ef9ed5", "committedDate": "2020-09-25T16:16:51Z", "message": "component store cleanup logic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ae20522ae14248401d2e2dc4d62ff40354657ce", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1ae20522ae14248401d2e2dc4d62ff40354657ce", "committedDate": "2020-09-25T16:21:04Z", "message": "Merge branch 'master' into size-limit"}, "afterCommit": {"oid": "ff6976d4a7681cddb838391a4096120176834fac", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ff6976d4a7681cddb838391a4096120176834fac", "committedDate": "2020-09-25T16:23:38Z", "message": "component store cleanup logic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f7a4f1008e8c82d65ca14b339b34e6490dfed5d", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4f7a4f1008e8c82d65ca14b339b34e6490dfed5d", "committedDate": "2020-09-25T18:18:18Z", "message": "fix tests"}, "afterCommit": {"oid": "2c8c05286451a5f09e396f422e9209d4024a397a", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2c8c05286451a5f09e396f422e9209d4024a397a", "committedDate": "2020-09-28T18:09:11Z", "message": "component store cleanup logic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c8c05286451a5f09e396f422e9209d4024a397a", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2c8c05286451a5f09e396f422e9209d4024a397a", "committedDate": "2020-09-28T18:09:11Z", "message": "component store cleanup logic"}, "afterCommit": {"oid": "03e6416ac7533f41ea4683a215af8e0f995924b0", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/03e6416ac7533f41ea4683a215af8e0f995924b0", "committedDate": "2020-09-28T18:13:41Z", "message": "component store cleanup logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3Nzk4OTY3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-497798967", "createdAt": "2020-09-28T18:40:31Z", "commit": {"oid": "03e6416ac7533f41ea4683a215af8e0f995924b0"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxODo0MDozMVrOHZLB9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxODo0ODo0MFrOHZLTgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE1NzE3Mg==", "bodyText": "A few questions.\n\nIs the stale version saved in each service config? If deleteAllUnusedLocalComponents removed all stale versions at certain point, is this deleteComponent going to handle it gracefully?\nWhen to use deleteAllUnusedLocalComponents or cleanupStaleVersions?\nWhy does deleteComponent require scope? Do we tell PRIVATE_SCOPE from public in local store?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r496157172", "createdAt": "2020-09-28T18:40:31Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -247,6 +270,60 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n         }\n     }\n \n+    /**\n+     * Delete stale versions from local store.\n+     *\n+     * @param deployedServiceConfig service config map that was deployed. Expected to be\n+     * {@code Map<String, Map<String, Object>>}\n+     * @throws PackageLoadingException if I/O exception during deletion\n+     */\n+    public void cleanupStaleVersions(Map<String, Object> deployedServiceConfig) throws PackageLoadingException {\n+        for (Map.Entry<String, Object> compServiceConfig : deployedServiceConfig.entrySet()) {\n+             @SuppressWarnings(\"unchecked\")\n+             Map<String, Object> config = (Map<String, Object>) compServiceConfig.getValue();\n+             String staleVersion = (String) config.get(STALE_VERSION_CONFIG_KEY);\n+             if (staleVersion != null) {\n+                 componentStore.deleteComponent(new ComponentIdentifier(compServiceConfig.getKey(),\n+                         new Semver(staleVersion), PRIVATE_SCOPE));\n+             }\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03e6416ac7533f41ea4683a215af8e0f995924b0"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MDAwOQ==", "bodyText": "Add java doc @throws? Want to confirm again, this method doesn't throw if files don't exist, right?\nPackageLoadingException may not be the best way to describe this error.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r496160009", "createdAt": "2020-09-28T18:45:43Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -141,21 +142,21 @@ ComponentRecipe getPackageRecipe(@NonNull ComponentIdentifier pkgId) throws Pack\n     }\n \n     /**\n-     * Delete the package recipe and all artifacts from disk.\n+     * Delete the component recipe and all artifacts from disk.\n      *\n-     * @param pkgId package identifier\n+     * @param compId component identifier\n      */\n-    void deletePackage(@NonNull ComponentIdentifier pkgId) throws PackagingException {\n-        Path recipePath = resolveRecipePath(pkgId.getName(), pkgId.getVersion());\n-        Path artifactDirPath = resolveArtifactDirectoryPath(pkgId);\n-        Path artifactDecompressedDirPath = resolveArtifactsDecompressedDirectory(pkgId);\n+    void deleteComponent(@NonNull ComponentIdentifier compId) throws PackageLoadingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03e6416ac7533f41ea4683a215af8e0f995924b0"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTY2Nw==", "bodyText": "Does PackageLoadingException best describe the error?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r496161667", "createdAt": "2020-09-28T18:48:40Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -271,29 +299,29 @@ public Path resolveAndSetupArtifactsDecompressedDirectory(@NonNull ComponentIden\n      * estimate of the package store's disk usage.\n      *\n      * @return total length of files in bytes\n-     * @throws UnexpectedPackagingException if unable to access the package store directory\n+     * @throws PackageLoadingException if unable to access the package store directory\n      */\n-    public long getContentSize() throws UnexpectedPackagingException {\n+    public long getContentSize() throws PackageLoadingException {\n         try {\n-            try (Stream<Path> s = Files.walk(this.componentStoreDirectory)) {\n-                return s.map(Path::toFile)\n-                        .filter(File::isFile)\n-                        .mapToLong(File::length)\n-                        .sum();\n-            }\n+            return Files.walk(this.componentStoreDirectory).map(Path::toFile)\n+                    .filter(File::isFile).mapToLong(File::length).sum();\n         } catch (IOException e) {\n-            throw new UnexpectedPackagingException(\"Failed to access package store\", e);\n+            throw new PackageLoadingException(\"Failed to access package store\", e);\n         }\n     }\n \n     /**\n      * Get remaining usable bytes for the package store.\n      * @return usable bytes\n-     * @throws IOException if I/O error occurred\n+     * @throws PackageLoadingException if I/O error occurred\n      */\n-    public long getUsableSpace() throws IOException {\n-        FileStore filestore = Files.getFileStore(this.componentStoreDirectory);\n-        return filestore.getUsableSpace();\n+    public long getUsableSpace() throws PackageLoadingException {\n+        try {\n+            FileStore filestore = Files.getFileStore(this.componentStoreDirectory);\n+            return filestore.getUsableSpace();\n+        } catch (IOException e) {\n+            throw new PackageLoadingException(\"Failed to get usable disk space\", e);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03e6416ac7533f41ea4683a215af8e0f995924b0"}, "originalPosition": 115}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27f4a1a7d2cadf633431ac5e1e2f534c5129f697", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/27f4a1a7d2cadf633431ac5e1e2f534c5129f697", "committedDate": "2020-09-28T20:16:03Z", "message": "fix style"}, "afterCommit": {"oid": "95e7f3844d05e99fcf6c4c676dce8bd97842b9ef", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/95e7f3844d05e99fcf6c4c676dce8bd97842b9ef", "committedDate": "2020-09-28T21:38:22Z", "message": "component store cleanup logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTEzODk0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-497913894", "createdAt": "2020-09-28T21:37:24Z", "commit": {"oid": "27f4a1a7d2cadf633431ac5e1e2f534c5129f697"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMTozNzoyNFrOHZQgjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMTo0NDowOVrOHZQu0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI0NjkyNw==", "bodyText": "Maybe change to if cleanup of present component files fails just to be more specific", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r496246927", "createdAt": "2020-09-28T21:37:24Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -145,6 +145,7 @@ ComponentRecipe getPackageRecipe(@NonNull ComponentIdentifier pkgId) throws Pack\n      * Delete the component recipe and all artifacts from disk.\n      *\n      * @param compId component identifier\n+     * @throws PackageLoadingException if I/O error occurred", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27f4a1a7d2cadf633431ac5e1e2f534c5129f697"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI1MDU3Nw==", "bodyText": "Though unlikely in real use cases, but can we add a test where PREV_VERSION_CONFIG_KEY doesn't exist but STALE_VERSION_CONFIG_KEY exists? Just want to make sure the config will be overridden correctly", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r496250577", "createdAt": "2020-09-28T21:44:09Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/KernelConfigResolver.java", "diffHunk": "@@ -290,6 +292,33 @@ private String lookupParameterValueForComponent(\n         return mainServiceConfig;\n     }\n \n+    /*\n+     * Record current deployment version in service config. Rotate among version, previousVersion and staleVersion.\n+     * staleVersion is subject to preemptive cleanup after deployment is merged\n+     */\n+    private void handleConfigVersions(ComponentIdentifier compId, String deploymentVersion,\n+                                      Map<String, Object> newServiceConfig) {\n+        newServiceConfig.put(VERSION_CONFIG_KEY, deploymentVersion);\n+        Topics existingServiceConfig = kernel.getConfig().findTopics(SERVICES_NAMESPACE_TOPIC, compId.getName());\n+        if (existingServiceConfig == null) {\n+            return;\n+        }\n+        Topic versionTopic = existingServiceConfig.find(VERSION_CONFIG_KEY);\n+        if (versionTopic == null) {\n+            return;\n+        }\n+        // rotate versions only if deploying a different version than the existing one\n+        String existingVersion = (String) versionTopic.getOnce();\n+        if (existingVersion.equals(deploymentVersion)) {\n+            return;\n+        }\n+        newServiceConfig.put(PREV_VERSION_CONFIG_KEY, existingVersion);\n+        Topic existingPrevVersion = existingServiceConfig.find(PREV_VERSION_CONFIG_KEY);\n+        if (existingPrevVersion != null) {\n+            newServiceConfig.put(STALE_VERSION_CONFIG_KEY, existingPrevVersion.getOnce());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e7f3844d05e99fcf6c4c676dce8bd97842b9ef"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTI3MjIw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-497927220", "createdAt": "2020-09-28T21:54:17Z", "commit": {"oid": "95e7f3844d05e99fcf6c4c676dce8bd97842b9ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMTo1NDoxOFrOHZRMSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMTo1NDoxOFrOHZRMSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI1ODEyMw==", "bodyText": "Is the stale version supposed to exist in the kernel config store only during deployment and will be cleaned up at the end of each deployment? If so, what's the downside to doing something like this instead -> save only version and previous version in the kernel config, then in this method get a list of current and previous methods then iterate over all of component store files and delete everything that doesn't exist in that list?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r496258123", "createdAt": "2020-09-28T21:54:18Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -332,6 +355,60 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n         }\n     }\n \n+    /**\n+     * Delete stale versions from local store.\n+     *\n+     * @param deployedServiceConfig service config map that was deployed. Expected to be\n+     * {@code Map<String, Map<String, Object>>}\n+     * @throws PackageLoadingException if I/O exception during deletion\n+     */\n+    public void cleanupStaleVersions(Map<String, Object> deployedServiceConfig) throws PackageLoadingException {\n+        for (Map.Entry<String, Object> compServiceConfig : deployedServiceConfig.entrySet()) {\n+             @SuppressWarnings(\"unchecked\")\n+             Map<String, Object> config = (Map<String, Object>) compServiceConfig.getValue();\n+             String staleVersion = (String) config.get(STALE_VERSION_CONFIG_KEY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e7f3844d05e99fcf6c4c676dce8bd97842b9ef"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3OTMwMTY2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-497930166", "createdAt": "2020-09-28T22:00:24Z", "commit": {"oid": "95e7f3844d05e99fcf6c4c676dce8bd97842b9ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMjowMDoyNFrOHZRVow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQyMjowMDoyNFrOHZRVow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI2MDUxNQ==", "bodyText": "Why do we need to do this if there already will be regular cleanup after every deployment? Also, will it be erroneous in such cases -> Components c1, c2, c3 have running versions 1.0, 1.0, 1.0 then current deployment has components c1 1.1, c2 1.1 and c3 1.1, the download stage has dowloaded c1 1.1 and while downloading c2 1.1 it encounters limit exceeded error, and it cleans up everything except running versions so ends up deleting c1's 1.1 version needed for the ongoing deployment as well. Regardless of that, I do think if we have preemptive  cleanup after each deployment then we don't need this deleteall method during download because it won't find anything to cleanup in the first place?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r496260515", "createdAt": "2020-09-28T22:00:24Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -332,6 +355,60 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n         }\n     }\n \n+    /**\n+     * Delete stale versions from local store.\n+     *\n+     * @param deployedServiceConfig service config map that was deployed. Expected to be\n+     * {@code Map<String, Map<String, Object>>}\n+     * @throws PackageLoadingException if I/O exception during deletion\n+     */\n+    public void cleanupStaleVersions(Map<String, Object> deployedServiceConfig) throws PackageLoadingException {\n+        for (Map.Entry<String, Object> compServiceConfig : deployedServiceConfig.entrySet()) {\n+             @SuppressWarnings(\"unchecked\")\n+             Map<String, Object> config = (Map<String, Object>) compServiceConfig.getValue();\n+             String staleVersion = (String) config.get(STALE_VERSION_CONFIG_KEY);\n+             if (staleVersion != null) {\n+                 componentStore.deleteComponent(new ComponentIdentifier(compServiceConfig.getKey(),\n+                         new Semver(staleVersion), PRIVATE_SCOPE));\n+             }\n+        }\n+    }\n+\n+    /**\n+     * Iterate through the inventory and delete all local components that is not currently running.\n+     *\n+     * @throws PackageLoadingException if I/O error encountered during deletion\n+     */\n+    private void deleteAllUnusedLocalComponents() throws PackageLoadingException {\n+        Map<String, String> runningComponentVersion = getRunningComponentVersionsOnce();\n+        Map<String, Set<String>> localComponentVersions = componentStore.listArtifactAvailableComponents();\n+        for (Map.Entry<String, Set<String>> localCompVer : localComponentVersions.entrySet()) {\n+            String compName = localCompVer.getKey();\n+            for (String compVersion : localCompVer.getValue()) {\n+                // do not delete if some running component has the same name and version\n+                if (compVersion.equals(runningComponentVersion.get(compName))) {\n+                    continue;\n+                }\n+                componentStore\n+                        .deleteComponent(new ComponentIdentifier(compName, new Semver(compVersion), PRIVATE_SCOPE));\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e7f3844d05e99fcf6c4c676dce8bd97842b9ef"}, "originalPosition": 121}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95e7f3844d05e99fcf6c4c676dce8bd97842b9ef", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/95e7f3844d05e99fcf6c4c676dce8bd97842b9ef", "committedDate": "2020-09-28T21:38:22Z", "message": "component store cleanup logic"}, "afterCommit": {"oid": "9bd7c04a734a8ae508ec80e944628251d6af1657", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9bd7c04a734a8ae508ec80e944628251d6af1657", "committedDate": "2020-10-01T17:29:51Z", "message": "component store cleanup logic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e541b02342b8e3e29640bd2b27f4c99a60cd49d9", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e541b02342b8e3e29640bd2b27f4c99a60cd49d9", "committedDate": "2020-10-01T17:54:08Z", "message": "small fix"}, "afterCommit": {"oid": "a99bce01e9eb33c82a9c8543772264936d876439", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a99bce01e9eb33c82a9c8543772264936d876439", "committedDate": "2020-10-01T18:10:38Z", "message": "component store cleanup logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwODAwODI2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-500800826", "createdAt": "2020-10-02T00:33:38Z", "commit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwMDozMzozOFrOHbeivA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwMDo0Mzo0NFrOHbeqZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDAxMg==", "bodyText": "So we will clean up after each deployment? Is this the current decision? Why don't we call this method only when we run into space issues?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498574012", "createdAt": "2020-10-02T00:33:38Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -333,6 +353,55 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n         }\n     }\n \n+    /**\n+     * Delete stale versions from local store.\n+     *\n+     * @throws PackageLoadingException if I/O exception during deletion\n+     */\n+    public void cleanupStaleVersions() throws PackageLoadingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NTEyMg==", "bodyText": "Where is this used? Also the javadoc is identical to getUsableSpace?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498575122", "createdAt": "2020-10-02T00:39:02Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -305,29 +335,41 @@ public Path resolveAndSetupArtifactsDecompressedDirectory(@NonNull ComponentIden\n      * estimate of the package store's disk usage.\n      *\n      * @return total length of files in bytes\n-     * @throws UnexpectedPackagingException if unable to access the package store directory\n+     * @throws PackageLoadingException if unable to access the package store directory\n      */\n-    public long getContentSize() throws UnexpectedPackagingException {\n+    public long getContentSize() throws PackageLoadingException {\n         try {\n-            try (Stream<Path> s = Files.walk(this.componentStoreDirectory)) {\n-                return s.map(Path::toFile)\n-                        .filter(File::isFile)\n-                        .mapToLong(File::length)\n-                        .sum();\n-            }\n+            return Files.walk(this.componentStoreDirectory).map(Path::toFile)\n+                    .filter(File::isFile).mapToLong(File::length).sum();\n         } catch (IOException e) {\n-            throw new UnexpectedPackagingException(\"Failed to access package store\", e);\n+            throw new PackageLoadingException(\"Failed to access package store\", e);\n         }\n     }\n \n     /**\n      * Get remaining usable bytes for the package store.\n      * @return usable bytes\n-     * @throws IOException if I/O error occurred\n+     * @throws PackageLoadingException if I/O error occurred\n      */\n-    public long getUsableSpace() throws IOException {\n-        FileStore filestore = Files.getFileStore(this.componentStoreDirectory);\n-        return filestore.getUsableSpace();\n+    public long getUsableSpace() throws PackageLoadingException {\n+        try {\n+            return Files.getFileStore(this.componentStoreDirectory).getUsableSpace();\n+        } catch (IOException e) {\n+            throw new PackageLoadingException(\"Failed to get usable disk space\", e);\n+        }\n+    }\n+\n+    /**\n+     * Get remaining usable bytes for the package store.\n+     * @return usable bytes\n+     * @throws PackageLoadingException if I/O error occurred\n+     */\n+    public long getTotalSpace() throws PackageLoadingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NTYyNw==", "bodyText": "Here should we also check if local artifact exists first and verify the integrity?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498575627", "createdAt": "2020-10-02T00:41:43Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -105,35 +105,37 @@ public File downloadToPath(ComponentIdentifier componentIdentifier, ComponentArt\n         return null;\n     }\n \n-    /**\n-     * Get the size of artifact from greengrass repo by sending HTTP HEAD request.\n-     *\n-     * @param packageIdentifier package info\n-     * @param artifact artifact info\n-     * @return ContentLength in bytes\n-     */\n     @Override\n-    public long getSize(ComponentIdentifier packageIdentifier, ComponentArtifact artifact)\n-            throws IOException, PackageDownloadException {\n-        logger.atInfo().setEventType(\"get-artifact-size-from-greengrass-repo\")\n-                .addKeyValue(\"packageIdentifier\", packageIdentifier)\n+    public long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentArtifact artifact, Path saveToPath)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NTk3NA==", "bodyText": "If we decide to clean up everytime, then also add to KernelUpdateDeploymentTask", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498575974", "createdAt": "2020-10-02T00:43:44Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/deployment/DefaultDeploymentTask.java", "diffHunk": "@@ -112,6 +112,8 @@ public DeploymentResult call()\n \n             logger.atInfo(DEPLOYMENT_TASK_EVENT_TYPE).setEventType(DEPLOYMENT_TASK_EVENT_TYPE)\n                     .log(\"Finished deployment task\");\n+\n+            componentManager.cleanupStaleVersions();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjQ3MTQ1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-501247145", "createdAt": "2020-10-02T15:43:45Z", "commit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0Mzo0NVrOHbyjAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0Mzo0NVrOHbyjAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwMTc2Mg==", "bodyText": "Deployment failing despite a cleanup and size limit option being in place is the expected behavior I think, doing this refactoring will only save us the work for doing the partial download right?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498901762", "createdAt": "2020-10-02T15:43:45Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -303,7 +310,20 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n                 .addKeyValue(PACKAGE_IDENTIFIER, componentIdentifier).log();\n \n         for (ComponentArtifact artifact : artifacts) {\n+            // check disk space before download\n+            //TODO refactor to check total artifacts size in preparePackages before download anything\n+            // because all artifacts must fit otherwise the deployment still can fail.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjQ3ODYx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-501247861", "createdAt": "2020-10-02T15:44:39Z", "commit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0NDozOVrOHbylFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0NDozOVrOHbylFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwMjI5Mg==", "bodyText": "nit - does not exist", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498902292", "createdAt": "2020-10-02T15:44:39Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -333,6 +353,55 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n         }\n     }\n \n+    /**\n+     * Delete stale versions from local store.\n+     *\n+     * @throws PackageLoadingException if I/O exception during deletion\n+     */\n+    public void cleanupStaleVersions() throws PackageLoadingException {\n+        logger.atInfo(\"cleanup-stale-versions-start\").log();\n+        Map<String, Set<String>> keepVersions = getNonStaleComponentVersionsOnce();\n+        Map<String, Set<String>> localComponentVersions = componentStore.listArtifactAvailableComponents();\n+        // remove all local versions that does not present in keepVersions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjQ4OTMw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-501248930", "createdAt": "2020-10-02T15:46:01Z", "commit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0NjowMlrOHbyoMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0NjowMlrOHbyoMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwMzA5MQ==", "bodyText": "Nit - can we give this a little simpler name like getVersionsToKeep()?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498903091", "createdAt": "2020-10-02T15:46:02Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -333,6 +353,55 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n         }\n     }\n \n+    /**\n+     * Delete stale versions from local store.\n+     *\n+     * @throws PackageLoadingException if I/O exception during deletion\n+     */\n+    public void cleanupStaleVersions() throws PackageLoadingException {\n+        logger.atInfo(\"cleanup-stale-versions-start\").log();\n+        Map<String, Set<String>> keepVersions = getNonStaleComponentVersionsOnce();\n+        Map<String, Set<String>> localComponentVersions = componentStore.listArtifactAvailableComponents();\n+        // remove all local versions that does not present in keepVersions\n+        for (Map.Entry<String, Set<String>> localVersions : localComponentVersions.entrySet()) {\n+            String compName = localVersions.getKey();\n+            if (keepVersions.containsKey(compName)) {\n+                Set<String> removeVersions = new HashSet<>(localVersions.getValue());\n+                removeVersions.removeAll(keepVersions.get(compName));\n+                for (String compVersion : removeVersions) {\n+                    componentStore\n+                            .deleteComponent(new ComponentIdentifier(compName, new Semver(compVersion), PRIVATE_SCOPE));\n+                }\n+            }\n+        }\n+        logger.atInfo(\"cleanup-stale-versions-finish\").log();\n+    }\n+\n+    /**\n+     * Query service config to obtain non-stale versions of components which should not be cleaned up.\n+     *\n+     * @return mapping from component name string to collection of non-stale version strings\n+     */\n+    public Map<String, Set<String>> getNonStaleComponentVersionsOnce() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjUwMzM4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-501250338", "createdAt": "2020-10-02T15:47:53Z", "commit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0Nzo1M1rOHbysNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0Nzo1M1rOHbysNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwNDExNw==", "bodyText": "Nit - This could read better as versionsToKeep and the opposite versionsToRemove", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498904117", "createdAt": "2020-10-02T15:47:53Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -333,6 +353,55 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n         }\n     }\n \n+    /**\n+     * Delete stale versions from local store.\n+     *\n+     * @throws PackageLoadingException if I/O exception during deletion\n+     */\n+    public void cleanupStaleVersions() throws PackageLoadingException {\n+        logger.atInfo(\"cleanup-stale-versions-start\").log();\n+        Map<String, Set<String>> keepVersions = getNonStaleComponentVersionsOnce();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjUxMjg2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-501251286", "createdAt": "2020-10-02T15:49:06Z", "commit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0OTowN1rOHbyu1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0OTowN1rOHbyu1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwNDc5MA==", "bodyText": "I don't think we need to subscribe because deployment workflow is the only thing that ever changes the versions, lets remove this TODO", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498904790", "createdAt": "2020-10-02T15:49:07Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -333,6 +353,55 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n         }\n     }\n \n+    /**\n+     * Delete stale versions from local store.\n+     *\n+     * @throws PackageLoadingException if I/O exception during deletion\n+     */\n+    public void cleanupStaleVersions() throws PackageLoadingException {\n+        logger.atInfo(\"cleanup-stale-versions-start\").log();\n+        Map<String, Set<String>> keepVersions = getNonStaleComponentVersionsOnce();\n+        Map<String, Set<String>> localComponentVersions = componentStore.listArtifactAvailableComponents();\n+        // remove all local versions that does not present in keepVersions\n+        for (Map.Entry<String, Set<String>> localVersions : localComponentVersions.entrySet()) {\n+            String compName = localVersions.getKey();\n+            if (keepVersions.containsKey(compName)) {\n+                Set<String> removeVersions = new HashSet<>(localVersions.getValue());\n+                removeVersions.removeAll(keepVersions.get(compName));\n+                for (String compVersion : removeVersions) {\n+                    componentStore\n+                            .deleteComponent(new ComponentIdentifier(compName, new Semver(compVersion), PRIVATE_SCOPE));\n+                }\n+            }\n+        }\n+        logger.atInfo(\"cleanup-stale-versions-finish\").log();\n+    }\n+\n+    /**\n+     * Query service config to obtain non-stale versions of components which should not be cleaned up.\n+     *\n+     * @return mapping from component name string to collection of non-stale version strings\n+     */\n+    public Map<String, Set<String>> getNonStaleComponentVersionsOnce() {\n+        // TODO maybe subscribe to service topics instead of getOnce every time", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 115}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjU0MzEy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-501254312", "createdAt": "2020-10-02T15:53:11Z", "commit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo1MzoxMlrOHby3dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo1MzoxMlrOHby3dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwNjk5Ng==", "bodyText": "I don't remember this from the previous PRs, but this does delete directories as well right?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498906996", "createdAt": "2020-10-02T15:53:12Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -333,6 +353,55 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n         }\n     }\n \n+    /**\n+     * Delete stale versions from local store.\n+     *\n+     * @throws PackageLoadingException if I/O exception during deletion\n+     */\n+    public void cleanupStaleVersions() throws PackageLoadingException {\n+        logger.atInfo(\"cleanup-stale-versions-start\").log();\n+        Map<String, Set<String>> keepVersions = getNonStaleComponentVersionsOnce();\n+        Map<String, Set<String>> localComponentVersions = componentStore.listArtifactAvailableComponents();\n+        // remove all local versions that does not present in keepVersions\n+        for (Map.Entry<String, Set<String>> localVersions : localComponentVersions.entrySet()) {\n+            String compName = localVersions.getKey();\n+            if (keepVersions.containsKey(compName)) {\n+                Set<String> removeVersions = new HashSet<>(localVersions.getValue());\n+                removeVersions.removeAll(keepVersions.get(compName));\n+                for (String compVersion : removeVersions) {\n+                    componentStore\n+                            .deleteComponent(new ComponentIdentifier(compName, new Semver(compVersion), PRIVATE_SCOPE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjU1MzUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-501255353", "createdAt": "2020-10-02T15:54:32Z", "commit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo1NDozMlrOHby6Uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo1NDozMlrOHby6Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwNzczMQ==", "bodyText": "Nit - handleComponentVersionConfigs sounds like a better name here, current name gives an impression that the version is for the config", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498907731", "createdAt": "2020-10-02T15:54:32Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/KernelConfigResolver.java", "diffHunk": "@@ -290,6 +291,33 @@ private String lookupParameterValueForComponent(\n         return mainServiceConfig;\n     }\n \n+    /*\n+     * Record current deployment version in service config. Rotate versions.\n+     */\n+    private void handleConfigVersions(ComponentIdentifier compId, String deploymentVersion,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjU3ODQ2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-501257846", "createdAt": "2020-10-02T15:57:38Z", "commit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo1NzozOFrOHbzBAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo1NzozOFrOHbzBAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwOTQ0Mg==", "bodyText": "What's the plan for this? Let's make sure it doesn't slip and is covered by tests, are we dependent on anything from cloud team to test this?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r498909442", "createdAt": "2020-10-02T15:57:38Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -105,35 +105,37 @@ public File downloadToPath(ComponentIdentifier componentIdentifier, ComponentArt\n         return null;\n     }\n \n-    /**\n-     * Get the size of artifact from greengrass repo by sending HTTP HEAD request.\n-     *\n-     * @param packageIdentifier package info\n-     * @param artifact artifact info\n-     * @return ContentLength in bytes\n-     */\n     @Override\n-    public long getSize(ComponentIdentifier packageIdentifier, ComponentArtifact artifact)\n-            throws IOException, PackageDownloadException {\n-        logger.atInfo().setEventType(\"get-artifact-size-from-greengrass-repo\")\n-                .addKeyValue(\"packageIdentifier\", packageIdentifier)\n+    public long getDownloadSize(ComponentIdentifier componentIdentifier, ComponentArtifact artifact, Path saveToPath)\n+            throws PackageDownloadException {\n+        logger.atInfo().setEventType(\"get-download-size-from-greengrass-repo\")\n+                .addKeyValue(\"componentIdentifier\", componentIdentifier)\n                 .addKeyValue(\"artifactUri\", artifact.getArtifactUri().toString()).log();\n \n-        String preSignedUrl =\n-                getArtifactDownloadURL(packageIdentifier, artifact.getArtifactUri().getSchemeSpecificPart());\n-        URL url = new URL(preSignedUrl);\n-        HttpURLConnection conn = connect(url);\n-        conn.setRequestMethod(\"HEAD\");\n-        Map<String, List<String>> headers = conn.getHeaderFields();\n-        // TODO verify this works by trying on a real package\n-        if (!headers.containsKey(HTTP_HEADER_CONTENT_LENGTH) || headers.get(HTTP_HEADER_CONTENT_LENGTH).size() != 1) {\n-            throw new PackageDownloadException(HTTP_HEADER_CONTENT_LENGTH + \" not found in response \" + \"header\");\n-        }\n-\n         try {\n+            String preSignedUrl =\n+                    getArtifactDownloadURL(componentIdentifier, artifact.getArtifactUri().getSchemeSpecificPart());\n+            URL url = new URL(preSignedUrl);\n+            HttpURLConnection conn = connect(url);\n+            conn.setRequestMethod(\"HEAD\");\n+            Map<String, List<String>> headers = conn.getHeaderFields();\n+            // TODO verify this works by trying on a real package", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjU5NTM1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-501259535", "createdAt": "2020-10-02T15:59:51Z", "commit": {"oid": "a1996a0a397a7c380db93f75e13fd1fe66f6eb57"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "356d72eebf837eaee9f52b5b0349283cf9817e2d", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/356d72eebf837eaee9f52b5b0349283cf9817e2d", "committedDate": "2020-10-05T15:00:47Z", "message": "address comments"}, "afterCommit": {"oid": "fd2bb1812c5bf4e8c6e2880b755b65cfcf69cd06", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd2bb1812c5bf4e8c6e2880b755b65cfcf69cd06", "committedDate": "2020-10-06T15:09:55Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd2bb1812c5bf4e8c6e2880b755b65cfcf69cd06", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fd2bb1812c5bf4e8c6e2880b755b65cfcf69cd06", "committedDate": "2020-10-06T15:09:55Z", "message": "address comments"}, "afterCommit": {"oid": "53fbd981f1df3f3e42ba761f982d0199e4f52f50", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/53fbd981f1df3f3e42ba761f982d0199e4f52f50", "committedDate": "2020-10-06T20:30:00Z", "message": "fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b008f15dcea44568dca03f2a780212df20045de", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9b008f15dcea44568dca03f2a780212df20045de", "committedDate": "2020-10-07T01:05:02Z", "message": "add unit test. fix bug"}, "afterCommit": {"oid": "e770f978a2e4394e6112a9605cbe9d33cb12c784", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e770f978a2e4394e6112a9605cbe9d33cb12c784", "committedDate": "2020-10-07T01:05:53Z", "message": "add unit test. fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNDgwMDE2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-503480016", "createdAt": "2020-10-07T02:17:46Z", "commit": {"oid": "faf7f8cc99486e9d91fc7a5539b6b9e341335ce4"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMjoxNzo0N1rOHdgN_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMjozMjoyMVrOHdgeCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY5ODYyMQ==", "bodyText": "Should this exception include the getUsableSpace reported as well as DEFAULT_MIN_DISK_AVAIL_BYTES?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r500698621", "createdAt": "2020-10-07T02:17:47Z", "author": {"login": "philcali"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -335,7 +342,21 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n                 .addKeyValue(PACKAGE_IDENTIFIER, componentIdentifier).log();\n \n         for (ComponentArtifact artifact : artifacts) {\n+            // check disk space before download\n+            //TODO refactor to check total size of artifacts from all components at once instead of one by one\n+            // because all artifacts must fit otherwise the deployment still fails.\n+            if (componentStore.getUsableSpace() < DEFAULT_MIN_DISK_AVAIL_BYTES) {\n+                throw new SizeLimitException(\"Disk space critical\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf7f8cc99486e9d91fc7a5539b6b9e341335ce4"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY5ODk2NQ==", "bodyText": "Should this exception include componentStore.getContentSize() + downloadSize as well as DEFAULT_MAX_STORE_SIZE_BYTES?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r500698965", "createdAt": "2020-10-07T02:18:53Z", "author": {"login": "philcali"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentManager.java", "diffHunk": "@@ -335,7 +342,21 @@ void prepareArtifacts(ComponentIdentifier componentIdentifier, List<ComponentArt\n                 .addKeyValue(PACKAGE_IDENTIFIER, componentIdentifier).log();\n \n         for (ComponentArtifact artifact : artifacts) {\n+            // check disk space before download\n+            //TODO refactor to check total size of artifacts from all components at once instead of one by one\n+            // because all artifacts must fit otherwise the deployment still fails.\n+            if (componentStore.getUsableSpace() < DEFAULT_MIN_DISK_AVAIL_BYTES) {\n+                throw new SizeLimitException(\"Disk space critical\");\n+            }\n             ArtifactDownloader downloader = selectArtifactDownloader(artifact.getArtifactUri());\n+            if (!downloader.downloadRequired(componentIdentifier, artifact, packageArtifactDirectory)) {\n+                continue;\n+            }\n+            long downloadSize = downloader.getDownloadSize(componentIdentifier, artifact, packageArtifactDirectory);\n+            if (componentStore.getContentSize() + downloadSize > DEFAULT_MAX_STORE_SIZE_BYTES) {\n+                throw new SizeLimitException(\"Component store size limit reached\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf7f8cc99486e9d91fc7a5539b6b9e341335ce4"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMTU5Ng==", "bodyText": "Include the componentStoreDirectory in the exception?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r500701596", "createdAt": "2020-10-07T02:27:47Z", "author": {"login": "philcali"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -305,29 +335,28 @@ public Path resolveAndSetupArtifactsDecompressedDirectory(@NonNull ComponentIden\n      * estimate of the package store's disk usage.\n      *\n      * @return total length of files in bytes\n-     * @throws UnexpectedPackagingException if unable to access the package store directory\n+     * @throws PackageLoadingException if unable to access the package store directory\n      */\n-    public long getContentSize() throws UnexpectedPackagingException {\n+    public long getContentSize() throws PackageLoadingException {\n         try {\n-            try (Stream<Path> s = Files.walk(this.componentStoreDirectory)) {\n-                return s.map(Path::toFile)\n-                        .filter(File::isFile)\n-                        .mapToLong(File::length)\n-                        .sum();\n-            }\n+            return Files.walk(this.componentStoreDirectory).map(Path::toFile)\n+                    .filter(File::isFile).mapToLong(File::length).sum();\n         } catch (IOException e) {\n-            throw new UnexpectedPackagingException(\"Failed to access package store\", e);\n+            throw new PackageLoadingException(\"Failed to access package store\", e);\n         }\n     }\n \n     /**\n      * Get remaining usable bytes for the package store.\n      * @return usable bytes\n-     * @throws IOException if I/O error occurred\n+     * @throws PackageLoadingException if I/O error occurred\n      */\n-    public long getUsableSpace() throws IOException {\n-        FileStore filestore = Files.getFileStore(this.componentStoreDirectory);\n-        return filestore.getUsableSpace();\n+    public long getUsableSpace() throws PackageLoadingException {\n+        try {\n+            return Files.getFileStore(this.componentStoreDirectory).getUsableSpace();\n+        } catch (IOException e) {\n+            throw new PackageLoadingException(\"Failed to get usable disk space\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf7f8cc99486e9d91fc7a5539b6b9e341335ce4"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMTY4Mg==", "bodyText": "Include the componentStoreDirectory in the exception?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r500701682", "createdAt": "2020-10-07T02:28:03Z", "author": {"login": "philcali"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -305,29 +335,28 @@ public Path resolveAndSetupArtifactsDecompressedDirectory(@NonNull ComponentIden\n      * estimate of the package store's disk usage.\n      *\n      * @return total length of files in bytes\n-     * @throws UnexpectedPackagingException if unable to access the package store directory\n+     * @throws PackageLoadingException if unable to access the package store directory\n      */\n-    public long getContentSize() throws UnexpectedPackagingException {\n+    public long getContentSize() throws PackageLoadingException {\n         try {\n-            try (Stream<Path> s = Files.walk(this.componentStoreDirectory)) {\n-                return s.map(Path::toFile)\n-                        .filter(File::isFile)\n-                        .mapToLong(File::length)\n-                        .sum();\n-            }\n+            return Files.walk(this.componentStoreDirectory).map(Path::toFile)\n+                    .filter(File::isFile).mapToLong(File::length).sum();\n         } catch (IOException e) {\n-            throw new UnexpectedPackagingException(\"Failed to access package store\", e);\n+            throw new PackageLoadingException(\"Failed to access package store\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf7f8cc99486e9d91fc7a5539b6b9e341335ce4"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMjAyMw==", "bodyText": "License header is needed.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r500702023", "createdAt": "2020-10-07T02:29:32Z", "author": {"login": "philcali"}, "path": "src/main/java/com/aws/greengrass/componentmanager/exceptions/SizeLimitException.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package com.aws.greengrass.componentmanager.exceptions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf7f8cc99486e9d91fc7a5539b6b9e341335ce4"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMjcyOQ==", "bodyText": "The downloadRequired and needsDownload needs some disambiguation.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r500702729", "createdAt": "2020-10-07T02:32:21Z", "author": {"login": "philcali"}, "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/ArtifactDownloader.java", "diffHunk": "@@ -63,14 +63,28 @@ static void checkIntegrityAndSaveToStore(InputStream artifactObject, ComponentAr\n         }\n     }\n \n-    static boolean needsDownload(ComponentArtifact artifact, Path saveToPath)\n-            throws PackageDownloadException, IOException {\n+    /**\n+     * Checks whether it is necessary to download the artifact or the existing file suffices.\n+     *\n+     * @param componentIdentifier component that has the artifact\n+     * @param artifact an artifact object\n+     * @param saveToPath path of directory where the artifact is expected to exist\n+     * @return true if download is necessary\n+     * @throws PackageDownloadException if error occurred in download process\n+     * @throws InvalidArtifactUriException if given artifact URI has error\n+     */\n+    public abstract boolean downloadRequired(ComponentIdentifier componentIdentifier, ComponentArtifact artifact,\n+                                             Path saveToPath)\n+            throws InvalidArtifactUriException, PackageDownloadException;\n+\n+    static boolean needsDownload(ComponentArtifact artifact, Path filePath)\n+            throws PackageDownloadException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf7f8cc99486e9d91fc7a5539b6b9e341335ce4"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e768c5e65d3bdae7b2bb729b30a2b220e0309297", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e768c5e65d3bdae7b2bb729b30a2b220e0309297", "committedDate": "2020-10-07T18:09:35Z", "message": "address comments. add more info to size limit exception message"}, "afterCommit": {"oid": "59064442039afdbd5f49ea3c65135b37cb70207b", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/59064442039afdbd5f49ea3c65135b37cb70207b", "committedDate": "2020-10-07T20:30:16Z", "message": "remove existence check from getDownloadSize"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MjU1ODY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-504255865", "createdAt": "2020-10-07T20:49:27Z", "commit": {"oid": "59064442039afdbd5f49ea3c65135b37cb70207b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0OTU2MTA2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-504956106", "createdAt": "2020-10-08T16:23:20Z", "commit": {"oid": "c5a6fbf0df670174cbacd92165d5c8497a79c3f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNjoyMzoyMVrOHemhlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNjoyMzoyMVrOHemhlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg1MDUxOQ==", "bodyText": "Now that you're checking if download is needed or not in component store, do we still need this condition here and same for the greengrass repo downloader because it will not reach here if the download isn't needed right?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#discussion_r501850519", "createdAt": "2020-10-08T16:23:21Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/S3Downloader.java", "diffHunk": "@@ -71,7 +79,7 @@ public File downloadToPath(ComponentIdentifier componentIdentifier, ComponentArt\n         try {\n             Path filePath = saveToPath.resolve(extractFileName(key));\n             // Skip download if not needed\n-            if (needsDownload(artifact, filePath)) {\n+            if (artifactExistsAndChecksum(artifact, filePath)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5a6fbf0df670174cbacd92165d5c8497a79c3f1"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0OTU2Njk5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-504956699", "createdAt": "2020-10-08T16:24:02Z", "commit": {"oid": "c5a6fbf0df670174cbacd92165d5c8497a79c3f1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "767a804ac28ac17f5d78751d40c7d988ed0bb2d5", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/767a804ac28ac17f5d78751d40c7d988ed0bb2d5", "committedDate": "2020-10-08T17:55:02Z", "message": "component store cleanup logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93955192e2e3c421bcaf90745f2fe8488c8d5e65", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/93955192e2e3c421bcaf90745f2fe8488c8d5e65", "committedDate": "2020-10-08T17:55:04Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e84f33ee32ed6a784777b122a18d89b4205909ed", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e84f33ee32ed6a784777b122a18d89b4205909ed", "committedDate": "2020-10-08T17:55:04Z", "message": "remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5266f156fae8b22fd691a4ae044e068a79d13950", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5266f156fae8b22fd691a4ae044e068a79d13950", "committedDate": "2020-10-08T17:55:04Z", "message": "fix e2e test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c11e1cdc58842c82eac0ffe0e94ca798cbb7c14f", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c11e1cdc58842c82eac0ffe0e94ca798cbb7c14f", "committedDate": "2020-10-08T17:55:23Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20c1966da2827f99e5a1c02753c8d8c3d4a42476", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/20c1966da2827f99e5a1c02753c8d8c3d4a42476", "committedDate": "2020-10-08T17:56:34Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f46fe11266e5a8d75375779b59556e2f56381d85", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f46fe11266e5a8d75375779b59556e2f56381d85", "committedDate": "2020-10-08T17:56:36Z", "message": "add cleanup to KernelUpdateDeploymentTask"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbc59113b3a385ec63a40e10031a51492271e6d9", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bbc59113b3a385ec63a40e10031a51492271e6d9", "committedDate": "2020-10-08T17:56:36Z", "message": "add unit test. fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6362b5d55bd8b296ed3297e1b66f0f72174ca8bc", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6362b5d55bd8b296ed3297e1b66f0f72174ca8bc", "committedDate": "2020-10-08T17:57:16Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56a267d65bf061bc476ea49eead324409c055c12", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/56a267d65bf061bc476ea49eead324409c055c12", "committedDate": "2020-10-08T17:57:18Z", "message": "address comments. add more info to size limit exception message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c5a6fbf0df670174cbacd92165d5c8497a79c3f1", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c5a6fbf0df670174cbacd92165d5c8497a79c3f1", "committedDate": "2020-10-08T14:08:30Z", "message": "Merge branch 'master' into size-limit"}, "afterCommit": {"oid": "d28653dad9b1dfaf52dd54e011257c37d52c29bd", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d28653dad9b1dfaf52dd54e011257c37d52c29bd", "committedDate": "2020-10-08T18:00:01Z", "message": "tiny fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8efedd87671d0d4241767f72c0a49d1a0bb91a70", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8efedd87671d0d4241767f72c0a49d1a0bb91a70", "committedDate": "2020-10-08T22:18:55Z", "message": "remove existence check from getDownloadSize"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c198001e5cbf7f197a823385772b3ed72e836c97", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c198001e5cbf7f197a823385772b3ed72e836c97", "committedDate": "2020-10-08T21:18:59Z", "message": "fix tests"}, "afterCommit": {"oid": "8efedd87671d0d4241767f72c0a49d1a0bb91a70", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8efedd87671d0d4241767f72c0a49d1a0bb91a70", "committedDate": "2020-10-08T22:18:55Z", "message": "remove existence check from getDownloadSize"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjQ2OTc5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-505246979", "createdAt": "2020-10-08T23:37:26Z", "commit": {"oid": "8efedd87671d0d4241767f72c0a49d1a0bb91a70"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjUxNjM3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/473#pullrequestreview-505251637", "createdAt": "2020-10-08T23:51:55Z", "commit": {"oid": "8efedd87671d0d4241767f72c0a49d1a0bb91a70"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3031, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}