{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MjI1MDQy", "number": 544, "title": "Use Store directory.", "bodyText": "Issue #, if available:\nDescription of changes:\nRemove usage of root from logging since we only need to store the store directory information.\nWhy is this change necessary:\nHow was this change tested:\nAdded integration tests.\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-19T19:25:01Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544", "merged": true, "mergeCommit": {"oid": "38cb64fccd7e2ed77f084001d3273dc0d4566c76"}, "closed": true, "closedAt": "2020-10-19T23:10:30Z", "author": {"login": "nikkhilmuthye"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUJSCVAH2gAyNTA2MjI1MDQyOjk5N2ZjNWY4MWVhYjVkZTI1MDMxYTlkZTI2Y2YxOWVmODM1OWQyYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUMCqCgH2gAyNTA2MjI1MDQyOmFhOTliMjEzYjA3ZGI5YThiMzRkZWRlNzBlM2EwZTNlYWE5NmEyODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "997fc5f81eab5de25031a9de26cf19ef8359d2b5", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/997fc5f81eab5de25031a9de26cf19ef8359d2b5", "committedDate": "2020-10-19T19:24:34Z", "message": "Use Store directory."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDk0MjY5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#pullrequestreview-512094269", "createdAt": "2020-10-19T19:32:10Z", "commit": {"oid": "997fc5f81eab5de25031a9de26cf19ef8359d2b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxOTozMjoxMFrOHkeimQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxOTozMjoxMFrOHkeimQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAxMTE2MQ==", "bodyText": "this doesn't change the logger. The logger has already been reconfigured", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508011161", "createdAt": "2020-10-19T19:32:10Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.integrationtests.lifecyclemanager;\n+\n+import com.aws.greengrass.integrationtests.BaseITCase;\n+import com.aws.greengrass.lifecyclemanager.GreengrassService;\n+import com.aws.greengrass.lifecyclemanager.Kernel;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.util.UUID;\n+\n+import static org.hamcrest.Matchers.equalToIgnoringCase;\n+import static org.hamcrest.io.FileMatchers.aFileNamed;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+\n+class FileLoggerTest extends BaseITCase {\n+    private Kernel kernel;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        System.setProperty(\"log.file.sizeInKB\", \"10240\");\n+        System.setProperty(\"log.file.fileSizeInKB\", \"1024\");\n+        System.setProperty(\"log.store\", \"FILE\");\n+    }\n+\n+    @AfterAll\n+    static void cleanup() {\n+        System.setProperty(\"log.store\", \"CONSOLE\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997fc5f81eab5de25031a9de26cf19ef8359d2b5"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDk0Mzcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#pullrequestreview-512094373", "createdAt": "2020-10-19T19:32:20Z", "commit": {"oid": "997fc5f81eab5de25031a9de26cf19ef8359d2b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxOTozMjoyMVrOHkei8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxOTozMjoyMVrOHkei8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAxMTI0OQ==", "bodyText": "this doesn't change the logger because it is statically created", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508011249", "createdAt": "2020-10-19T19:32:21Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.integrationtests.lifecyclemanager;\n+\n+import com.aws.greengrass.integrationtests.BaseITCase;\n+import com.aws.greengrass.lifecyclemanager.GreengrassService;\n+import com.aws.greengrass.lifecyclemanager.Kernel;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.util.UUID;\n+\n+import static org.hamcrest.Matchers.equalToIgnoringCase;\n+import static org.hamcrest.io.FileMatchers.aFileNamed;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+\n+class FileLoggerTest extends BaseITCase {\n+    private Kernel kernel;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        System.setProperty(\"log.fmt\", \"JSON\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "997fc5f81eab5de25031a9de26cf19ef8359d2b5"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "committedDate": "2020-10-19T20:35:11Z", "message": "Address PR comments."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c1e96209af77439111d9ee09bd05f39333424fb", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9c1e96209af77439111d9ee09bd05f39333424fb", "committedDate": "2020-10-19T20:32:21Z", "message": "Address PR comments."}, "afterCommit": {"oid": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4c3945956f4097a5b46e6dfb921a25c1fb2f9648", "committedDate": "2020-10-19T20:35:11Z", "message": "Address PR comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMTg3MjU4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#pullrequestreview-512187258", "createdAt": "2020-10-19T21:54:02Z", "commit": {"oid": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQyMTo1NDowMlrOHkjDIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQyMTo1NDowNVrOHkjDNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA4NTAyNA==", "bodyText": "not sure this does what you think it does. I'm pretty sure it doesn't check that the file exists, it is just looking at the name in the object. Use anExistingFile to check that it actually exists", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508085024", "createdAt": "2020-10-19T21:54:02Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.integrationtests.lifecyclemanager;\n+\n+import com.aws.greengrass.integrationtests.BaseITCase;\n+import com.aws.greengrass.lifecyclemanager.GreengrassService;\n+import com.aws.greengrass.lifecyclemanager.Kernel;\n+import com.aws.greengrass.logging.impl.LogManager;\n+import com.aws.greengrass.logging.impl.config.LogFormat;\n+import com.aws.greengrass.logging.impl.config.LogStore;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.util.UUID;\n+\n+import static org.hamcrest.Matchers.equalToIgnoringCase;\n+import static org.hamcrest.io.FileMatchers.aFileNamed;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+class FileLoggerTest extends BaseITCase {\n+    private Kernel kernel;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        LogManager.getRootLogConfiguration().setStoreType(LogStore.FILE);\n+        LogManager.getRootLogConfiguration().setFormat(LogFormat.TEXT);\n+    }\n+\n+    @AfterAll\n+    static void cleanup() {\n+        LogManager.getRootLogConfiguration().setStore(LogStore.CONSOLE);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_root_path_given_as_system_param_WHEN_kernel_launches_THEN_logs_written_to_correct_directory()\n+            throws Exception {\n+        // launch kernel without config arg\n+        kernel = new Kernel().parseArgs().launch();\n+\n+        GreengrassService mainService = kernel.locate(\"main\");\n+        assertNotNull(mainService);\n+\n+        // verify that log file exists are the correct location.\n+        File logFile = tempRootDir.resolve(\"logs\").resolve(\"greengrass.log\").toFile();\n+        MatcherAssert.assertThat(logFile, aFileNamed(equalToIgnoringCase(\"greengrass.log\")));\n+        assertTrue(logFile.length() > 0);\n+    }\n+\n+    @Test\n+    void GIVEN_root_path_given_as_kernel_param_WHEN_kernel_launches_THEN_logs_written_to_correct_directory()\n+            throws Exception {\n+        // launch kernel without config arg\n+        String randomDirectory = UUID.randomUUID().toString();\n+        kernel = new Kernel().parseArgs(\"-r\", tempRootDir.resolve(randomDirectory).toAbsolutePath().toString())\n+                .launch();\n+\n+        GreengrassService mainService = kernel.locate(\"main\");\n+        assertNotNull(mainService);\n+\n+        // verify that log file exists are the correct location.\n+        File logFile = tempRootDir.resolve(randomDirectory).resolve(\"logs\").resolve(\"greengrass.log\").toFile();\n+        File oldLogFile = tempRootDir.resolve(\"logs\").resolve(\"greengrass.log\").toFile();\n+        MatcherAssert.assertThat(logFile, aFileNamed(equalToIgnoringCase(\"greengrass.log\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA4NTA0NA==", "bodyText": "can we roll these into some other test maybe? Starting up a new kernel is slow for such a small test.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#discussion_r508085044", "createdAt": "2020-10-19T21:54:05Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/greengrass/integrationtests/lifecyclemanager/FileLoggerTest.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.greengrass.integrationtests.lifecyclemanager;\n+\n+import com.aws.greengrass.integrationtests.BaseITCase;\n+import com.aws.greengrass.lifecyclemanager.GreengrassService;\n+import com.aws.greengrass.lifecyclemanager.Kernel;\n+import com.aws.greengrass.logging.impl.LogManager;\n+import com.aws.greengrass.logging.impl.config.LogFormat;\n+import com.aws.greengrass.logging.impl.config.LogStore;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.util.UUID;\n+\n+import static org.hamcrest.Matchers.equalToIgnoringCase;\n+import static org.hamcrest.io.FileMatchers.aFileNamed;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\n+class FileLoggerTest extends BaseITCase {\n+    private Kernel kernel;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        LogManager.getRootLogConfiguration().setStoreType(LogStore.FILE);\n+        LogManager.getRootLogConfiguration().setFormat(LogFormat.TEXT);\n+    }\n+\n+    @AfterAll\n+    static void cleanup() {\n+        LogManager.getRootLogConfiguration().setStore(LogStore.CONSOLE);\n+    }\n+\n+    @AfterEach\n+    void afterEach() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    void GIVEN_root_path_given_as_system_param_WHEN_kernel_launches_THEN_logs_written_to_correct_directory()\n+            throws Exception {\n+        // launch kernel without config arg\n+        kernel = new Kernel().parseArgs().launch();\n+\n+        GreengrassService mainService = kernel.locate(\"main\");\n+        assertNotNull(mainService);\n+\n+        // verify that log file exists are the correct location.\n+        File logFile = tempRootDir.resolve(\"logs\").resolve(\"greengrass.log\").toFile();\n+        MatcherAssert.assertThat(logFile, aFileNamed(equalToIgnoringCase(\"greengrass.log\")));\n+        assertTrue(logFile.length() > 0);\n+    }\n+\n+    @Test\n+    void GIVEN_root_path_given_as_kernel_param_WHEN_kernel_launches_THEN_logs_written_to_correct_directory()\n+            throws Exception {\n+        // launch kernel without config arg\n+        String randomDirectory = UUID.randomUUID().toString();\n+        kernel = new Kernel().parseArgs(\"-r\", tempRootDir.resolve(randomDirectory).toAbsolutePath().toString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMjA0ODA3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/544#pullrequestreview-512204807", "createdAt": "2020-10-19T22:29:02Z", "commit": {"oid": "4c3945956f4097a5b46e6dfb921a25c1fb2f9648"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa99b213b07db9a8b34dede70e3a0e3eaa96a289", "author": {"user": {"login": "nikkhilmuthye", "name": "Nikkhil Muthye"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/aa99b213b07db9a8b34dede70e3a0e3eaa96a289", "committedDate": "2020-10-19T22:37:29Z", "message": "Merge branch 'master' into useStoreDirectory"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2789, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}