{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2ODU5MzU1", "number": 266, "title": "Use zt-process-killer/pkill to help us kill the whole process tree", "bodyText": "Issue #, if available:\nDescription of changes:\nWe currently execute all customer code through a shell using sh -c \"<user code>\". Because of this, the Process handle that we have is for the shell and not necessarily the customer's code directly. When we try to stop the process, we send SIGINT, then wait a bit, and then send SIGKILL. If the customer's code is configured to ignore SIGINT or is in a bad state for whatever reason, it may continue to run even after the shell quits due to the SIGINT. When this happens, the child process is reparented under the root (pid 1) and is effectively a zombie because we no longer have any handle to the process.\nWhen SIGINT fails, we send SIGKILL which will kill only the shell and not the children. Because of these issues, we cannot be sure that we kill all the processes that we launch without fail. This PR attempts to fix these issues by using pkill to send the interrupt and kill signals to all children processes. On Windows, we use a library that uses taskkill with the /T flag which will similarly kill all the children.\nIf we were using Java 9, then all this work would be moot because Java 9 has much better support for this using the ProcessHandle which has builtin support for handling child processes.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-06-02T22:21:00Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/266", "merged": true, "mergeCommit": {"oid": "8236bcf1dec6d99cffda6bffa3297dc19da53237"}, "closed": true, "closedAt": "2020-06-03T18:57:15Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcndMACgBqjMzOTk3OTc2MDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnuK1qAFqTQyMzg0MDY1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e142300d9c75ea19892e11a284057ebbd9119ce", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4e142300d9c75ea19892e11a284057ebbd9119ce", "committedDate": "2020-06-02T22:10:38Z", "message": "Use zt-process-killer to help us kill the whole process tree"}, "afterCommit": {"oid": "f5d4bdfb69444b581d9f5f8a869b869e8793bbaa", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f5d4bdfb69444b581d9f5f8a869b869e8793bbaa", "committedDate": "2020-06-02T23:09:22Z", "message": "Use zt-process-killer to help us kill the whole process tree"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5d4bdfb69444b581d9f5f8a869b869e8793bbaa", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f5d4bdfb69444b581d9f5f8a869b869e8793bbaa", "committedDate": "2020-06-02T23:09:22Z", "message": "Use zt-process-killer to help us kill the whole process tree"}, "afterCommit": {"oid": "5a8fb98c717331792472a133a3075792d7c89328", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5a8fb98c717331792472a133a3075792d7c89328", "committedDate": "2020-06-03T00:16:08Z", "message": "Use zt-process-killer to help us kill the whole process tree"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTQ5NjQ0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/266#pullrequestreview-423149644", "createdAt": "2020-06-03T00:52:10Z", "commit": {"oid": "5a8fb98c717331792472a133a3075792d7c89328"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMDo1MjoxMVrOGeImNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMDo1MjoxMVrOGeImNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1MTMxNw==", "bodyText": "Since you included windows here, we might also need setGracefulDestroyEnabled(true). It seems destroyGracefully is not allowed by default on windows.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/266#discussion_r434251317", "createdAt": "2020-06-03T00:52:11Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/util/Exec.java", "diffHunk": "@@ -394,19 +399,30 @@ public synchronized void close() throws IOException {\n         if (p == null || !p.isAlive()) {\n             return;\n         }\n-        p.destroy();\n+\n+        PidProcess pp = Processes.newPidProcess(p);\n+\n+        if (pp instanceof UnixProcess) {\n+            pp = new UnixParentProcess(p, pp.getPid());\n+        } else if (pp instanceof WindowsProcess) {\n+            ((WindowsProcess) pp).setIncludeChildren(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a8fb98c717331792472a133a3075792d7c89328"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7427e7d1bafd3aea22910c4a537a99ec5ef8ca0b", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7427e7d1bafd3aea22910c4a537a99ec5ef8ca0b", "committedDate": "2020-06-03T02:56:25Z", "message": "Use zt-process-killer to help us kill the whole process tree"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a8fb98c717331792472a133a3075792d7c89328", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5a8fb98c717331792472a133a3075792d7c89328", "committedDate": "2020-06-03T00:16:08Z", "message": "Use zt-process-killer to help us kill the whole process tree"}, "afterCommit": {"oid": "7427e7d1bafd3aea22910c4a537a99ec5ef8ca0b", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7427e7d1bafd3aea22910c4a537a99ec5ef8ca0b", "committedDate": "2020-06-03T02:56:25Z", "message": "Use zt-process-killer to help us kill the whole process tree"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNzgxODQz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/266#pullrequestreview-423781843", "createdAt": "2020-06-03T17:35:41Z", "commit": {"oid": "7427e7d1bafd3aea22910c4a537a99ec5ef8ca0b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77919d8e016413668cccb7fe4b92a9ab8b54424e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/77919d8e016413668cccb7fe4b92a9ab8b54424e", "committedDate": "2020-06-03T18:07:20Z", "message": "Merge branch 'master' into kill-children"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzODQwNjU2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/266#pullrequestreview-423840656", "createdAt": "2020-06-03T18:56:36Z", "commit": {"oid": "77919d8e016413668cccb7fe4b92a9ab8b54424e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2241, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}