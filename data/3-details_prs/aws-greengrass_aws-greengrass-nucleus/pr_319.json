{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNjQ0MDQ0", "number": 319, "title": "Retry deleteThing when clean up test resources", "bodyText": "Issue #, if available:\nDescription of changes:\nRetry on InvalidRequestException for iot client in e2e tests\nWhy is this change necessary:\ndetachThingPrincipal might not be done when calling deleteThing because this call is async. Retry to avoid failing to clean up resources in e2e tests\nHow was this change tested:\nmvn verify\nran e2e test and verified all resources cleaned\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-07-17T01:00:13Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319", "merged": true, "mergeCommit": {"oid": "ad9fa007373575d85949d462b8ab21b0dce66fad"}, "closed": true, "closedAt": "2020-07-21T16:37:54Z", "author": {"login": "youtuyy"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1pDZOgH2gAyNDUwNjQ0MDQ0OmQ1MDYwOGY0ZTA2OTZlYWRlY2U5ODYzOGRkMWJlMWVhYTliOGQyYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3I8R-AFqTQ1MjYzNzEwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d50608f4e0696eadece98638dd1be1eaa9b8d2a4", "author": {"user": {"login": "youtuyy", "name": "Zhaoyan Lin"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d50608f4e0696eadece98638dd1be1eaa9b8d2a4", "committedDate": "2020-07-17T00:53:53Z", "message": "Retry deleteThing when clean up test resources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzEzNjg5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#pullrequestreview-450313689", "createdAt": "2020-07-17T01:14:52Z", "commit": {"oid": "d50608f4e0696eadece98638dd1be1eaa9b8d2a4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNjY3MTI0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#pullrequestreview-450667124", "createdAt": "2020-07-17T13:41:35Z", "commit": {"oid": "d50608f4e0696eadece98638dd1be1eaa9b8d2a4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzo0MTozNlrOGzTeyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzo0MTozNlrOGzTeyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0OTczOQ==", "bodyText": "The IotClient can be built using desired retry settings as the AWS SDK provides that out of the box, please switch to using that for the client being passed at line 185 https://github.com/aws/aws-greengrass-kernel/blob/master/src/main/java/com/aws/iot/evergreen/util/IotSdkClientFactory.java#L69- . BaseRetryableAccessor was meant to be used for non AWS SDK based clients that would need custom retry logic.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#discussion_r456449739", "createdAt": "2020-07-17T13:41:36Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/easysetup/DeviceProvisioningHelper.java", "diffHunk": "@@ -180,7 +186,12 @@ public void cleanThing(IotClient client, ThingInfo thing) {\n         client.detachThingPrincipal(\n                 DetachThingPrincipalRequest.builder().thingName(thing.thingName).principal(thing.certificateArn)\n                         .build());\n-        client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build());\n+        // Retry deleteThing when getting \"still attached to one or more principals\" InvalidRequestException\n+        // as the detachThingPrincipal call is async\n+        BaseRetryableAccessor accessor = new BaseRetryableAccessor();\n+        accessor.retry(RETRY_COUNT, BACKOFF_MILLIS,\n+                () -> client.deleteThing(DeleteThingRequest.builder().thingName(thing.thingName).build()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d50608f4e0696eadece98638dd1be1eaa9b8d2a4"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d26d4e6e08a021e666052859894ba5a619ee455c", "author": {"user": {"login": "youtuyy", "name": "Zhaoyan Lin"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d26d4e6e08a021e666052859894ba5a619ee455c", "committedDate": "2020-07-17T16:51:27Z", "message": "Retry override on iotclient in e2e tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7817f670130fb0535d8e07e96359d38685f3faa2", "author": {"user": {"login": "youtuyy", "name": "Zhaoyan Lin"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7817f670130fb0535d8e07e96359d38685f3faa2", "committedDate": "2020-07-17T19:36:41Z", "message": "Merge branch 'master' into retry-delete-thing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNzY5MDEw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#pullrequestreview-451769010", "createdAt": "2020-07-20T16:28:46Z", "commit": {"oid": "7817f670130fb0535d8e07e96359d38685f3faa2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cfb5a0c132c8e0c99e151047bc6e1397f31342f", "author": {"user": {"login": "youtuyy", "name": "Zhaoyan Lin"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8cfb5a0c132c8e0c99e151047bc6e1397f31342f", "committedDate": "2020-07-20T23:25:01Z", "message": "Merge branch 'master' into retry-delete-thing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bfb93835b27d1499651ef5e7297980e94379d3d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3bfb93835b27d1499651ef5e7297980e94379d3d", "committedDate": "2020-07-21T02:47:06Z", "message": "Merge branch 'master' into retry-delete-thing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "920fafbdda9039cac98cac50e0091d7343a88de8", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/920fafbdda9039cac98cac50e0091d7343a88de8", "committedDate": "2020-07-21T03:17:45Z", "message": "Merge branch 'master' into retry-delete-thing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03e8e4228b52bc37592841ebee4ad4b29d5aa5d3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/03e8e4228b52bc37592841ebee4ad4b29d5aa5d3", "committedDate": "2020-07-21T05:16:03Z", "message": "Merge branch 'master' into retry-delete-thing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNjM3MTA1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/319#pullrequestreview-452637105", "createdAt": "2020-07-21T16:37:00Z", "commit": {"oid": "03e8e4228b52bc37592841ebee4ad4b29d5aa5d3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2904, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}