{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NDgxODc4", "number": 270, "title": "Update process killing to use PS/Slay on QNX", "bodyText": "Issue #, if available:\nDescription of changes:\nBreaks out platform specific implementations to a platform abstract class.\nQNX does not have pkill, but does have ps which can tell us each process' parent, thus allowing us to identify the process tree and kill each node in the tree using slay.\nWhy is this change necessary:\nHow was this change tested:\nTested by @edmendezcr on QNX to verify that we're now killing processes and children and not leaving around zombie processes.\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-06-03T22:11:13Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/270", "merged": true, "mergeCommit": {"oid": "3a58bd0a8c2917fead87d2d40acf8e244cc18ec4"}, "closed": true, "closedAt": "2020-06-09T20:24:16Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnxOB2ABqjM0MDQzMDE5ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpq_sxAFqTQyNzUxMTg1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "791f8b3e10ed71983a0b97ef3ee16dca5f495760", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/791f8b3e10ed71983a0b97ef3ee16dca5f495760", "committedDate": "2020-06-03T22:09:12Z", "message": "Update process killing to use slay on QNX"}, "afterCommit": {"oid": "8377910800551d37d431257216182431d24c5f05", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8377910800551d37d431257216182431d24c5f05", "committedDate": "2020-06-03T22:29:42Z", "message": "Update process killing to use slay on QNX"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8377910800551d37d431257216182431d24c5f05", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8377910800551d37d431257216182431d24c5f05", "committedDate": "2020-06-03T22:29:42Z", "message": "Update process killing to use slay on QNX"}, "afterCommit": {"oid": "c692ab454b58e4b3acf25e94cfb1c12ec28f782f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c692ab454b58e4b3acf25e94cfb1c12ec28f782f", "committedDate": "2020-06-04T18:16:03Z", "message": "Update process killing to use PS to find process tree on QNX"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c692ab454b58e4b3acf25e94cfb1c12ec28f782f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c692ab454b58e4b3acf25e94cfb1c12ec28f782f", "committedDate": "2020-06-04T18:16:03Z", "message": "Update process killing to use PS to find process tree on QNX"}, "afterCommit": {"oid": "44f99d2356d9b80aee9330fc6fe46df5149f4671", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/44f99d2356d9b80aee9330fc6fe46df5149f4671", "committedDate": "2020-06-04T18:19:45Z", "message": "Update process killing to use PS to find process tree on QNX"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44f99d2356d9b80aee9330fc6fe46df5149f4671", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/44f99d2356d9b80aee9330fc6fe46df5149f4671", "committedDate": "2020-06-04T18:19:45Z", "message": "Update process killing to use PS to find process tree on QNX"}, "afterCommit": {"oid": "b69277791c73df25244780af74d3e8e0b2659205", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b69277791c73df25244780af74d3e8e0b2659205", "committedDate": "2020-06-04T18:20:16Z", "message": "Update process killing to use PS to find process tree on QNX"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b69277791c73df25244780af74d3e8e0b2659205", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b69277791c73df25244780af74d3e8e0b2659205", "committedDate": "2020-06-04T18:20:16Z", "message": "Update process killing to use PS to find process tree on QNX"}, "afterCommit": {"oid": "717cc9ac92c949d0b54fd507d03fe82c29f6d945", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/717cc9ac92c949d0b54fd507d03fe82c29f6d945", "committedDate": "2020-06-04T18:28:59Z", "message": "Update process killing to use PS to find process tree on QNX"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "717cc9ac92c949d0b54fd507d03fe82c29f6d945", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/717cc9ac92c949d0b54fd507d03fe82c29f6d945", "committedDate": "2020-06-04T18:28:59Z", "message": "Update process killing to use PS to find process tree on QNX"}, "afterCommit": {"oid": "8a30bb279996d793fc1226cfbce783174a1a79be", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8a30bb279996d793fc1226cfbce783174a1a79be", "committedDate": "2020-06-04T18:34:32Z", "message": "Update process killing to use PS to find process tree on QNX"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a30bb279996d793fc1226cfbce783174a1a79be", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8a30bb279996d793fc1226cfbce783174a1a79be", "committedDate": "2020-06-04T18:34:32Z", "message": "Update process killing to use PS to find process tree on QNX"}, "afterCommit": {"oid": "73d2186565a720f8741a4fb9629a6166057b0de9", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/73d2186565a720f8741a4fb9629a6166057b0de9", "committedDate": "2020-06-04T21:42:11Z", "message": "Update process killing to use PS to find process tree on QNX"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a80b469db58d1ba9d2af106cd1d8a0b4b0c8fee", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9a80b469db58d1ba9d2af106cd1d8a0b4b0c8fee", "committedDate": "2020-06-08T18:35:18Z", "message": "Update process killing to use PS to find process tree on QNX"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f45be2ad5a4285b98423ac1f3b93a81622be0bb", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3f45be2ad5a4285b98423ac1f3b93a81622be0bb", "committedDate": "2020-06-08T16:56:21Z", "message": "Merge branch 'master' into qnx"}, "afterCommit": {"oid": "b4c4eaf14dd98f622044e7b7103357da906c8a8e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b4c4eaf14dd98f622044e7b7103357da906c8a8e", "committedDate": "2020-06-08T18:43:45Z", "message": "Use slay to kill on QNX"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fb7bcf7dd7c75d18d7870bb5ea6124a1fed6ed2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2fb7bcf7dd7c75d18d7870bb5ea6124a1fed6ed2", "committedDate": "2020-06-08T21:06:30Z", "message": "Use slay to kill on QNX"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4c4eaf14dd98f622044e7b7103357da906c8a8e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b4c4eaf14dd98f622044e7b7103357da906c8a8e", "committedDate": "2020-06-08T18:43:45Z", "message": "Use slay to kill on QNX"}, "afterCommit": {"oid": "2fb7bcf7dd7c75d18d7870bb5ea6124a1fed6ed2", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2fb7bcf7dd7c75d18d7870bb5ea6124a1fed6ed2", "committedDate": "2020-06-08T21:06:30Z", "message": "Use slay to kill on QNX"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67c4ee8519d2c6f98c483551dd6bacb5e24cac81", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/67c4ee8519d2c6f98c483551dd6bacb5e24cac81", "committedDate": "2020-06-08T21:40:39Z", "message": "Add lots more logging for process killing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "387a8bc4993d0dc09c4d54398c0134c6fb890ef6", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/387a8bc4993d0dc09c4d54398c0134c6fb890ef6", "committedDate": "2020-06-08T21:35:11Z", "message": "Add lots more logging for process killing"}, "afterCommit": {"oid": "67c4ee8519d2c6f98c483551dd6bacb5e24cac81", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/67c4ee8519d2c6f98c483551dd6bacb5e24cac81", "committedDate": "2020-06-08T21:40:39Z", "message": "Add lots more logging for process killing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjcyNDEy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/270#pullrequestreview-426672412", "createdAt": "2020-06-08T22:45:40Z", "commit": {"oid": "67c4ee8519d2c6f98c483551dd6bacb5e24cac81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMjo0NTo0MFrOGgy7iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMjo0NTo0MFrOGgy7iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA0MjA1Nw==", "bodyText": "will this 2 seconds be configurable?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/270#discussion_r437042057", "createdAt": "2020-06-08T22:45:40Z", "author": {"login": "rbattle"}, "path": "src/main/java/com/aws/iot/evergreen/util/platforms/UnixPlatform.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.util.platforms;\n+\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.util.Pair;\n+import com.aws.iot.evergreen.util.Utils;\n+import org.zeroturnaround.process.PidProcess;\n+import org.zeroturnaround.process.Processes;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static com.aws.iot.evergreen.util.Utils.inputStreamToString;\n+\n+public class UnixPlatform extends Platform {\n+    protected static final int SIGINT = 2;\n+    protected static final int SIGKILL = 9;\n+    public static final Pattern PS_PID_PATTERN = Pattern.compile(\"(\\\\d+)\\\\s+(\\\\d+)\");\n+    protected static final Logger logger = LogManager.getLogger(UnixPlatform.class);\n+\n+    @Override\n+    public void killProcessAndChildren(Process process, boolean force) throws IOException, InterruptedException {\n+        PidProcess pp = Processes.newPidProcess(process);\n+\n+        logger.atDebug().log(\"Running pkill to kill child processes of pid {}\", pp.getPid());\n+        // Use pkill to kill all subprocesses under the main shell\n+        String[] cmd = {\"pkill\", \"-\" + (force ? SIGKILL : SIGINT), \"-P\", Integer.toString(pp.getPid())};\n+        Process proc = Runtime.getRuntime().exec(cmd);\n+        proc.waitFor();\n+        if (proc.exitValue() != 0) {\n+            logger.atWarn()\n+                    .kv(\"pid\", pp.getPid())\n+                    .kv(\"exit-code\", proc.exitValue())\n+                    .kv(\"stdout\", inputStreamToString(proc.getInputStream()))\n+                    .kv(\"stderr\", inputStreamToString(proc.getErrorStream()))\n+                    .log(\"pkill exited non-zero\");\n+        }\n+\n+        // If forcible, then also kill the parent (the shell)\n+        if (force) {\n+            process.destroy();\n+            process.waitFor(2, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67c4ee8519d2c6f98c483551dd6bacb5e24cac81"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDI5NTY5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/270#pullrequestreview-427429569", "createdAt": "2020-06-09T18:25:39Z", "commit": {"oid": "67c4ee8519d2c6f98c483551dd6bacb5e24cac81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1acc061f44c43a2a2fda1a5f3e7b2e94bc20cf0a", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1acc061f44c43a2a2fda1a5f3e7b2e94bc20cf0a", "committedDate": "2020-06-09T18:50:07Z", "message": "Merge branch 'master' into qnx"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTAyMjY4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/270#pullrequestreview-427502268", "createdAt": "2020-06-09T20:08:38Z", "commit": {"oid": "1acc061f44c43a2a2fda1a5f3e7b2e94bc20cf0a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMDowODozOFrOGhaXNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMDoxOTowNFrOGhasPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY4ODExOQ==", "bodyText": "Thanks for starting this.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/270#discussion_r437688119", "createdAt": "2020-06-09T20:08:38Z", "author": {"login": "fufranci"}, "path": "src/main/java/com/aws/iot/evergreen/util/platforms/Platform.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.util.platforms;\n+\n+import com.aws.iot.evergreen.config.PlatformResolver;\n+import com.aws.iot.evergreen.util.Exec;\n+\n+import java.io.IOException;\n+\n+public abstract class Platform {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1acc061f44c43a2a2fda1a5f3e7b2e94bc20cf0a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY5MzUwMg==", "bodyText": "Just want to confirm: the original \"combined\" implementation calls pp.destroyGracefully() and pp.destroyForcefully(). Here you only call destroy. Is this intentional?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/270#discussion_r437693502", "createdAt": "2020-06-09T20:19:04Z", "author": {"login": "fufranci"}, "path": "src/main/java/com/aws/iot/evergreen/util/platforms/WindowsPlatform.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright Amazon.com Inc. or its affiliates.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.util.platforms;\n+\n+import org.zeroturnaround.process.PidProcess;\n+import org.zeroturnaround.process.Processes;\n+import org.zeroturnaround.process.WindowsProcess;\n+\n+import java.io.IOException;\n+\n+public class WindowsPlatform extends Platform {\n+    @Override\n+    public void killProcessAndChildren(Process process, boolean force) throws IOException, InterruptedException {\n+        PidProcess pp = Processes.newPidProcess(process);\n+        ((WindowsProcess) pp).setIncludeChildren(true);\n+        ((WindowsProcess) pp).setGracefulDestroyEnabled(true);\n+\n+        pp.destroy(force);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1acc061f44c43a2a2fda1a5f3e7b2e94bc20cf0a"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTExODUx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/270#pullrequestreview-427511851", "createdAt": "2020-06-09T20:22:34Z", "commit": {"oid": "1acc061f44c43a2a2fda1a5f3e7b2e94bc20cf0a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2245, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}