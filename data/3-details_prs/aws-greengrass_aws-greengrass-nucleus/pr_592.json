{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMzM0NDc1", "number": 592, "title": "Set IPC socket to be ugo+rw (666)", "bodyText": "Issue #, if available:\nDescription of changes:\nSet permissions so services can connect to IPC\nWhy is this change necessary:\nIPC will not function correctly otherwise\nHow was this change tested:\nLambda&smoke UAT - Lambda receives message from a component publishing of IPC. Stream manager connects over IPC\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-30T23:51:23Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/592", "merged": true, "mergeCommit": {"oid": "bf9ff5bac671178b0af0712aff65fdfa24043343"}, "closed": true, "closedAt": "2020-10-31T00:37:35Z", "author": {"login": "rbattle"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXvrUkgH2gAyNTEzMzM0NDc1OmU2OTVkYWQyZjQ5ODcwMWVmMDIxYzcwNDFhMzZiZjUyNTNiMDE3OGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXwCMcAH2gAyNTEzMzM0NDc1OjdhYjI3YWRkZDg2NjBmY2U4ZTNjNDBjNjBhM2IxNWI1Y2I2YjA0MWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e695dad2f498701ef021c7041a36bf5253b0178f", "author": {"user": {"login": "rbattle", "name": "Robert Battle"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e695dad2f498701ef021c7041a36bf5253b0178f", "committedDate": "2020-10-30T23:50:21Z", "message": "Set IPC socket to be ugo+rw (666)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a92cbec2a1488aab510d6ac954d3749e83f0fd93", "author": {"user": {"login": "rbattle", "name": "Robert Battle"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a92cbec2a1488aab510d6ac954d3749e83f0fd93", "committedDate": "2020-10-30T23:51:37Z", "message": "Merge branch 'master' into ipc-socket-perm"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDg5NDg4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/592#pullrequestreview-521089488", "createdAt": "2020-10-30T23:52:32Z", "commit": {"oid": "a92cbec2a1488aab510d6ac954d3749e83f0fd93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzo1MjozMlrOHrjK8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzo1MjozMlrOHrjK8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyNzA1Ng==", "bodyText": "this isn't logging. use debug instead", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/592#discussion_r515427056", "createdAt": "2020-10-30T23:52:32Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -156,6 +161,29 @@ public void startup() {\n             close();\n             throw e;\n         }\n+\n+        // IPC socket does not get created immediately after runServer returns\n+        // Wait up to 30s for it to exist\n+        Path ipcPath = Paths.get(ipcServerSocketAbsolutePath);\n+        long maxTime = System.currentTimeMillis() + MAX_IPC_SOCKET_CREATION_WAIT_TIME_SECONDS * 1000;\n+        while (System.currentTimeMillis() < maxTime && Files.notExists(ipcPath)) {\n+            logger.atDebug(\"Waiting for server socket file\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92cbec2a1488aab510d6ac954d3749e83f0fd93"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDg5NzU5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/592#pullrequestreview-521089759", "createdAt": "2020-10-30T23:54:06Z", "commit": {"oid": "a92cbec2a1488aab510d6ac954d3749e83f0fd93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzo1NDowN1rOHrjL5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzo1NDowN1rOHrjL5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyNzMwMg==", "bodyText": "rethrow (as unchecked) to cause the startup to fail?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/592#discussion_r515427302", "createdAt": "2020-10-30T23:54:07Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/ipc/IPCEventStreamService.java", "diffHunk": "@@ -156,6 +161,29 @@ public void startup() {\n             close();\n             throw e;\n         }\n+\n+        // IPC socket does not get created immediately after runServer returns\n+        // Wait up to 30s for it to exist\n+        Path ipcPath = Paths.get(ipcServerSocketAbsolutePath);\n+        long maxTime = System.currentTimeMillis() + MAX_IPC_SOCKET_CREATION_WAIT_TIME_SECONDS * 1000;\n+        while (System.currentTimeMillis() < maxTime && Files.notExists(ipcPath)) {\n+            logger.atDebug(\"Waiting for server socket file\");\n+            try {\n+                Thread.sleep(SOCKET_CREATE_POLL_INTERVAL_MS);\n+            } catch (InterruptedException e) {\n+                logger.atWarn().setCause(e).log(\"Service interrupted before server socket exists\");\n+                close();\n+                return;\n+            }\n+        }\n+        // set permissions on IPC socket so that everyone can read/write\n+        try {\n+            Permissions.setIpcSocketPermission(ipcPath);\n+        } catch (IOException e) {\n+            logger.atError().setCause(e).log(\"Error while setting permissions for IPC server socket\");\n+            close();\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92cbec2a1488aab510d6ac954d3749e83f0fd93"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d6724287682bab173d7a48f69d807440a3cc5a7", "author": {"user": {"login": "rbattle", "name": "Robert Battle"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7d6724287682bab173d7a48f69d807440a3cc5a7", "committedDate": "2020-10-31T00:03:06Z", "message": "Fix logging and throw rte"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDkxNTE2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/592#pullrequestreview-521091516", "createdAt": "2020-10-31T00:04:17Z", "commit": {"oid": "7d6724287682bab173d7a48f69d807440a3cc5a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDkyNDgw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/592#pullrequestreview-521092480", "createdAt": "2020-10-31T00:10:20Z", "commit": {"oid": "7d6724287682bab173d7a48f69d807440a3cc5a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDkyNjQ0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/592#pullrequestreview-521092644", "createdAt": "2020-10-31T00:11:20Z", "commit": {"oid": "7d6724287682bab173d7a48f69d807440a3cc5a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ab27addd8660fce8e3c40c60a3b15b5cb6b041d", "author": {"user": {"login": "rbattle", "name": "Robert Battle"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7ab27addd8660fce8e3c40c60a3b15b5cb6b041d", "committedDate": "2020-10-31T00:15:20Z", "message": "Merge branch 'master' into ipc-socket-perm"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2876, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}