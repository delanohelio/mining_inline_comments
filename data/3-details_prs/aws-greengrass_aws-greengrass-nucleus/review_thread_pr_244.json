{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4Nzg0NDY2", "number": 244, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTowMDoxNFrOD9hFGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjo1OVrOD9hU7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODMxNzA1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/tes/IotConnectionManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTowMDoxNFrOGXD0lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTowMDoxNFrOGXD0lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzMzA0Ng==", "bodyText": "change name of @param", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426833046", "createdAt": "2020-05-18T19:00:14Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/tes/IotConnectionManager.java", "diffHunk": "@@ -24,31 +25,31 @@\n import java.util.concurrent.ExecutionException;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.TimeoutException;\n+import javax.inject.Inject;\n \n public class IotConnectionManager implements Closeable {\n     // TODO: Move Iot related classes to a central location\n     private static final Logger LOGGER = LogManager.getLogger(IotConnectionManager.class);\n     // TODO: ALPN support\n     private static final int IOT_PORT = 8443;\n     // Max wait time for device to establish mTLS connection with IOT core\n-    private static final long TIMEOUT_FOR_CONNECTION_SETUP_SECONDS = (long) Duration.ofMinutes(1).getSeconds();\n-    private final String iotEndpoint;\n+    private static final long TIMEOUT_FOR_CONNECTION_SETUP_SECONDS = Duration.ofMinutes(1).getSeconds();\n     private final HttpClientConnectionManager connManager;\n \n     /**\n      * Constructor.\n-     * @param iotEndpoint Iot cloud credentials endpoint for managing connections to.\n+     *\n      * @param deviceConfiguration Device configuration for getting cert and keys for mTLS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041f77bf31686187958fa83326e43fce059e4612"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODM1NDQ5OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjowMVrOGXEMCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjowMVrOGXEMCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTA0OA==", "bodyText": "Wondering if we should just rename this to dataEndpoint, to match with the terminology used in AWS docs. Similar change in DeviceConfiguration as well.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426839048", "createdAt": "2020-05-18T19:12:01Z", "author": {"login": "abanthiy"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/e2e/util/Utils.java", "diffHunk": "@@ -330,5 +321,18 @@ public static void updateKernelConfigWithIotConfiguration(Kernel kernel, Utils.T\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_PRIVATE_KEY_PATH).withValue(privKeyFilePath);\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_CERTIFICATE_FILE_PATH).withValue(certFilePath);\n         deploymentServiceTopics.createLeafChild(DEVICE_PARAM_ROOT_CA_PATH).withValue(caFilePath);\n+        deploymentServiceTopics.createLeafChild(DEVICE_PARAM_IOT_CRED_ENDPOINT).withValue(thing.credEndpoint);\n+    }\n+\n+    @AllArgsConstructor\n+    public static class ThingInfo {\n+        public String thingArn;\n+        public String thingName;\n+        public String certificateArn;\n+        public String certificateId;\n+        public String certificatePem;\n+        public KeyPair keyPair;\n+        public String endpoint;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041f77bf31686187958fa83326e43fce059e4612"}, "originalPosition": 123}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODM1NjQ0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeviceConfigurationHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjozOFrOGXENTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjozOFrOGXENTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTM3Mg==", "bodyText": "clientEndpoint -> dataEndpoint", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426839372", "createdAt": "2020-05-18T19:12:38Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeviceConfigurationHelper.java", "diffHunk": "@@ -36,33 +37,38 @@\n \n     /**\n      * Retrieves the device configuration information from kernel config to communicate with Iot Cloud.\n+     *\n      * @return {@link DeviceConfiguration}\n      * @throws DeviceConfigurationException when configuration is not available for the device.\n      */\n     public DeviceConfiguration getDeviceConfiguration() throws DeviceConfigurationException {\n         String thingName = getStringParameterFromConfig(DEVICE_PARAM_THING_NAME);\n-        String certificateFilePath = kernelCommandLine.deTilde(\n-                getStringParameterFromConfig(DEVICE_PARAM_CERTIFICATE_FILE_PATH));\n+        String certificateFilePath =\n+                kernelCommandLine.deTilde(getStringParameterFromConfig(DEVICE_PARAM_CERTIFICATE_FILE_PATH));\n         String privateKeyPath = kernelCommandLine.deTilde(getStringParameterFromConfig(DEVICE_PARAM_PRIVATE_KEY_PATH));\n         String rootCAPath = kernelCommandLine.deTilde(getStringParameterFromConfig(DEVICE_PARAM_ROOT_CA_PATH));\n         String mqttClientEndpoint = getStringParameterFromConfig(DEVICE_PARAM_MQTT_CLIENT_ENDPOINT);\n-        validateDeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint);\n-        return new DeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint);\n+        String iotCredEndpoint = getStringParameterFromConfig(DEVICE_PARAM_IOT_CRED_ENDPOINT);\n+        validateDeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint,\n+                iotCredEndpoint);\n+        return new DeviceConfiguration(thingName, certificateFilePath, privateKeyPath, rootCAPath, mqttClientEndpoint,\n+                iotCredEndpoint);\n     }\n \n     private String getStringParameterFromConfig(String parameterName) {\n         String paramValue = \"\";\n         //TODO: Update when device provisioning is implemented\n-        Topic childTopic = kernel.getConfig().lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC,\n-                DeploymentService.DEPLOYMENT_SERVICE_TOPICS).findLeafChild(parameterName);\n+        Topic childTopic = kernel.getConfig()\n+                .lookupTopics(EvergreenService.SERVICES_NAMESPACE_TOPIC, DeploymentService.DEPLOYMENT_SERVICE_TOPICS)\n+                .findLeafChild(parameterName);\n         if (childTopic != null && childTopic.getOnce() != null) {\n             paramValue = childTopic.getOnce().toString();\n         }\n         return paramValue;\n     }\n \n     private void validateDeviceConfiguration(String thingName, String certificateFilePath, String privateKeyPath,\n-                                             String rootCAPath, String clientEndpoint)\n+                                             String rootCAPath, String clientEndpoint, String iotCredEndpoint)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041f77bf31686187958fa83326e43fce059e4612"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODM1NzU3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeviceConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjo1OVrOGXEOBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjo1OVrOGXEOBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTU1Ng==", "bodyText": "Renaming here to iotDataEndpoint", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/244#discussion_r426839556", "createdAt": "2020-05-18T19:12:59Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeviceConfiguration.java", "diffHunk": "@@ -18,4 +18,5 @@\n     private String privateKeyFilePath;\n     private String rootCAFilePath;\n     private String mqttClientEndpoint;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "041f77bf31686187958fa83326e43fce059e4612"}, "originalPosition": 3}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4709, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}