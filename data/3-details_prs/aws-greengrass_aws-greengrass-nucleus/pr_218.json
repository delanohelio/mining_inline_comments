{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNDc3MzIx", "number": 218, "title": "Add safe update check into GenericExternalService", "bodyText": "Issue #, if available:\nDescription of changes:\nAdds new section \"safeToUpdate\" under the lifecycle in config.yaml. This section can contain a script, timeout, and recheckPeriod. If there is no script, the script fails to run, or the script times out, then it does not block the deployment. Only if the script exits with non-zero code within the timeout will it then block the deployment for the \"recheckPeriod\" seconds (which defaults to 30s).\nAdded a test to make sure that deployment is block.\nWill have another PR to add IPC implementation.\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-29T04:08:42Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218", "merged": true, "mergeCommit": {"oid": "e8000e0b070e6d777a872fa47cf9ac7c23c4157c"}, "closed": true, "closedAt": "2020-05-04T21:43:03Z", "author": {"login": "MikeDombo"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccQk8sABqjMyODI5NDAwNjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceGXwFgFqTQwNTM2MTQ2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "957482b669be897684e02436b90b1ac9caf13043", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/957482b669be897684e02436b90b1ac9caf13043", "committedDate": "2020-04-29T04:07:50Z", "message": "Add safe update check into GenericExternalService"}, "afterCommit": {"oid": "8e7b0be88c7d82a6018f59c9c3224698cf2589e5", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e7b0be88c7d82a6018f59c9c3224698cf2589e5", "committedDate": "2020-04-29T04:14:41Z", "message": "Add safe update check into GenericExternalService"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNzk3MjM0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#pullrequestreview-402797234", "createdAt": "2020-04-29T15:43:28Z", "commit": {"oid": "8e7b0be88c7d82a6018f59c9c3224698cf2589e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTo0MzoyOFrOGOFI0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTo0MzoyOFrOGOFI0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQxNzQyNg==", "bodyText": "Not needed for the PR, but we need to start documenting these config names somewhere. A list of what is hardcoded at the moment and what can be configured via recipe/kernel context updates would help in the long run.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r417417426", "createdAt": "2020-04-29T15:43:28Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -37,6 +41,10 @@\n                     \"SIGIO\", \"SIGPWR\", \"SIGSYS\",};\n     private static final String SKIP_COMMAND_REGEX = \"(exists|onpath) +(.+)\";\n     private static final Pattern skipcmd = Pattern.compile(SKIP_COMMAND_REGEX);\n+    public static final String SAFE_UPDATE_TOPIC_NAME = \"safeToUpdate\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e7b0be88c7d82a6018f59c9c3224698cf2589e5"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e7b0be88c7d82a6018f59c9c3224698cf2589e5", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e7b0be88c7d82a6018f59c9c3224698cf2589e5", "committedDate": "2020-04-29T04:14:41Z", "message": "Add safe update check into GenericExternalService"}, "afterCommit": {"oid": "1a59f4cef186224c0ea3d8c2eefb57ac62513e12", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a59f4cef186224c0ea3d8c2eefb57ac62513e12", "committedDate": "2020-04-29T20:10:00Z", "message": "Add safe update check into GenericExternalService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a59f4cef186224c0ea3d8c2eefb57ac62513e12", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1a59f4cef186224c0ea3d8c2eefb57ac62513e12", "committedDate": "2020-04-29T20:10:00Z", "message": "Add safe update check into GenericExternalService"}, "afterCommit": {"oid": "c6c7ff7a94da9310fda20409d11035c5bbe32003", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6c7ff7a94da9310fda20409d11035c5bbe32003", "committedDate": "2020-04-29T20:48:47Z", "message": "Add safe update check into GenericExternalService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73269f56cf09035a48527085aad6c91f182e8508", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/73269f56cf09035a48527085aad6c91f182e8508", "committedDate": "2020-04-29T22:51:21Z", "message": "Add safe update check into GenericExternalService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6c7ff7a94da9310fda20409d11035c5bbe32003", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c6c7ff7a94da9310fda20409d11035c5bbe32003", "committedDate": "2020-04-29T20:48:47Z", "message": "Add safe update check into GenericExternalService"}, "afterCommit": {"oid": "73269f56cf09035a48527085aad6c91f182e8508", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/73269f56cf09035a48527085aad6c91f182e8508", "committedDate": "2020-04-29T22:51:21Z", "message": "Add safe update check into GenericExternalService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ff9accd35db2b974e6d73c969bb1b56b603a37b3", "committedDate": "2020-04-30T00:15:37Z", "message": "Try to fix often flaky test by increasing timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3de45ce00aa856103baef30cbb4823dc024f96f", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b3de45ce00aa856103baef30cbb4823dc024f96f", "committedDate": "2020-04-29T23:21:53Z", "message": "Try to fix often flaky test by increasing timeout"}, "afterCommit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ff9accd35db2b974e6d73c969bb1b56b603a37b3", "committedDate": "2020-04-30T00:15:37Z", "message": "Try to fix often flaky test by increasing timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMjIwMzE2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#pullrequestreview-403220316", "createdAt": "2020-04-30T05:51:32Z", "commit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNTo1MTozMlrOGOakJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNjoyNDo0MVrOGObVXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc2ODQ4Ng==", "bodyText": "A few questions\n\nThis is adding a single check for all of the services running, a deployment might deploy only a subset of them, why should we wait for all services to report that they are safe to update?\nIf we add a single disruption check for all services, it might effectively make the disruptionCompleted method useless? If I understand correctly it was intended to notify services that the disruption action has completed. Do we now think that there is no need to do that? Even if it is left for the future, will this change allow adding that later?\n\nLooking at the code and the deployment workflow I acknowledge that this might be difficult to do or may even be obsolete since this service was written before deployments were implemented, but have we given a thought to how this was intended to be used? My understanding was that each service can have the ability to register one disruption check and it can be removed when the service is stopped. When you want to update some set of services you can add those checks to the list in this class and the existing code will use them.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r417768486", "createdAt": "2020-04-30T05:51:32Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -36,8 +37,31 @@\n     private final Map<String, Crashable> pendingActions = new LinkedHashMap<>();\n     private final List<DisruptableCheck> disruptableChecks = new CopyOnWriteArrayList<>();\n \n-    public UpdateSystemSafelyService(Topics c) {\n+    private final DisruptableCheck egServiceCheck = new DisruptableCheck() {\n+        @Override\n+        public long whenIsDisruptionOK() {\n+            return kernel.orderedDependencies().stream().mapToLong(EvergreenService::whenIsDisruptionOK).max()\n+                    .orElse(0L);\n+        }\n+\n+        @Override\n+        public void disruptionCompleted() {\n+        }\n+    };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc3NjI2OQ==", "bodyText": "Can we rename it to something that suggests what action it is performing? like checkIfSafeToUpdate?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r417776269", "createdAt": "2020-04-30T06:11:07Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -37,6 +40,10 @@\n                     \"SIGIO\", \"SIGPWR\", \"SIGSYS\",};\n     private static final String SKIP_COMMAND_REGEX = \"(exists|onpath) +(.+)\";\n     private static final Pattern skipcmd = Pattern.compile(SKIP_COMMAND_REGEX);\n+    public static final String SAFE_UPDATE_TOPIC_NAME = \"safeToUpdate\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc3NzA1MQ==", "bodyText": "This can be named better, this is part of the lifecycle config that customer needs to specify value for, so it should convey easily that this is how long kernel will wait before polling the service again to see if it safe to update", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r417777051", "createdAt": "2020-04-30T06:13:20Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -37,6 +40,10 @@\n                     \"SIGIO\", \"SIGPWR\", \"SIGSYS\",};\n     private static final String SKIP_COMMAND_REGEX = \"(exists|onpath) +(.+)\";\n     private static final Pattern skipcmd = Pattern.compile(SKIP_COMMAND_REGEX);\n+    public static final String SAFE_UPDATE_TOPIC_NAME = \"safeToUpdate\";\n+    public static final int DEFAULT_SAFE_UPDATE_TIMEOUT = 5;\n+    public static final int DEFAULT_SAFE_UPDATE_RECHECK_TIME = 30;\n+    public static final String RECHECK_PERIOD_TOPIC_NAME = \"recheckPeriod\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc4MTA4NA==", "bodyText": "I think this may not be safe to assume, failure in running this script could be a bug in the customer's code which we wouldn't be safeguarding against and on top of that, not even reporting it. The only way they would find out would be if the deployment updates a service when it wasn't supposed to and then they dig the logs to see what went wrong. That defeats the purpose of having this safe update mechanism even when it's rare. I feel the same about timeout too. We should discuss this.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r417781084", "createdAt": "2020-04-30T06:24:41Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -180,6 +187,48 @@ public synchronized void shutdown() {\n         logger.atInfo().setEventType(\"generic-service-shutdown\").log();\n     }\n \n+    @Override\n+    protected long whenIsDisruptionOK() {\n+        AtomicInteger exitCode = new AtomicInteger();\n+        CountDownLatch doneRunning = new CountDownLatch(1);\n+        try {\n+            Pair<RunStatus, Exec> result = run(SAFE_UPDATE_TOPIC_NAME, (exit) -> {\n+                exitCode.set(exit);\n+                doneRunning.countDown();\n+            });\n+\n+            // If we didn't do anything or we were unable to run the check, then it is safe to update\n+            // since we cannot recover from being unable to run the check, we must assume it is safe\n+            // to go ahead", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d61287a48a1a961a2abb98693e75ef14fb452be", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8d61287a48a1a961a2abb98693e75ef14fb452be", "committedDate": "2020-04-30T20:25:14Z", "message": "Add disruptionCompleted implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzODcyOTM3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#pullrequestreview-403872937", "createdAt": "2020-04-30T20:59:00Z", "commit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMDo1OTowMVrOGO6HJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMToxMjozMlrOGO6hgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4NTM1MA==", "bodyText": "In the case of timeout, Stop the Executor process before returning?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r418285350", "createdAt": "2020-04-30T20:59:01Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -180,6 +187,48 @@ public synchronized void shutdown() {\n         logger.atInfo().setEventType(\"generic-service-shutdown\").log();\n     }\n \n+    @Override\n+    protected long whenIsDisruptionOK() {\n+        AtomicInteger exitCode = new AtomicInteger();\n+        CountDownLatch doneRunning = new CountDownLatch(1);\n+        try {\n+            Pair<RunStatus, Exec> result = run(SAFE_UPDATE_TOPIC_NAME, (exit) -> {\n+                exitCode.set(exit);\n+                doneRunning.countDown();\n+            });\n+\n+            // If we didn't do anything or we were unable to run the check, then it is safe to update\n+            // since we cannot recover from being unable to run the check, we must assume it is safe\n+            // to go ahead\n+            if (result.getLeft().equals(RunStatus.NothingDone) || result.getLeft().equals(RunStatus.Errored)) {\n+                return 0L;\n+            }\n+\n+            int timeout = Coerce.toInt(\n+                    config.findOrDefault(DEFAULT_SAFE_UPDATE_TIMEOUT, SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                            SAFE_UPDATE_TOPIC_NAME, TIMEOUT_NAMESPACE_TOPIC));\n+            if (doneRunning.await(timeout, TimeUnit.SECONDS)) {\n+                // Define exit code 0 means that it is safe to update right now\n+                if (exitCode.get() == 0) {\n+                    return 0L;\n+                }\n+                // Set the re-check time to some seconds in the future\n+                return Instant.now().plusSeconds(Coerce.toInt(\n+                        config.findOrDefault(DEFAULT_SAFE_UPDATE_RECHECK_TIME, SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                                SAFE_UPDATE_TOPIC_NAME, RECHECK_PERIOD_TOPIC_NAME))).toEpochMilli();\n+            } else {\n+                result.getRight().close();\n+            }\n+        } catch (InterruptedException ignore) {\n+        } catch (IOException e) {\n+            logger.atWarn().log(\"Error while running whenIsDisruptionOK\", e);\n+        }\n+\n+        // Similar to if there was an error while running the check, if we timed out we assume it is safe\n+        // to continue, otherwise we can get into a state where a deployment can never proceed\n+        return 0L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4Njg4Mw==", "bodyText": "Great! can you add a random suffix? In this case we can check that no two lifecycle thread running at the same time.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r418286883", "createdAt": "2020-04-30T21:01:53Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -577,6 +577,7 @@ void initLifecycleThread() {\n         lifecycleFuture = evergreenService.getContext().get(ExecutorService.class).submit(() -> {\n             while (!isClosed.get()) {\n                 try {\n+                    Thread.currentThread().setName(evergreenService.getName() + \"-lifecycle\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4NzkyMQ==", "bodyText": "Why we need to override with an empty method?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r418287921", "createdAt": "2020-04-30T21:03:57Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -36,8 +37,31 @@\n     private final Map<String, Crashable> pendingActions = new LinkedHashMap<>();\n     private final List<DisruptableCheck> disruptableChecks = new CopyOnWriteArrayList<>();\n \n-    public UpdateSystemSafelyService(Topics c) {\n+    private final DisruptableCheck egServiceCheck = new DisruptableCheck() {\n+        @Override\n+        public long whenIsDisruptionOK() {\n+            return kernel.orderedDependencies().stream().mapToLong(EvergreenService::whenIsDisruptionOK).max()\n+                    .orElse(0L);\n+        }\n+\n+        @Override\n+        public void disruptionCompleted() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI5MjA5Nw==", "bodyText": "Can we find a way to verify safeToUpdate check is run and return non-zero?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r418292097", "createdAt": "2020-04-30T21:12:32Z", "author": {"login": "ShirleyZheng92"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -411,6 +412,34 @@ void GIVEN_kernel_running_services_WHEN_merge_removes_service_THEN_removed_servi\n         assertEquals(Arrays.asList(\"sleeperB\", \"main\"), orderedDependencies);\n     }\n \n+    @Test\n+    void GIVEN_a_running_service_is_not_disruptable_WHEN_deployed_THEN_deployment_waits() throws Throwable {\n+        // GIVEN\n+        kernel.parseArgs(\"-i\", getClass().getResource(\"non_disruptable_service.yaml\").toString());\n+        kernel.launch();\n+\n+        CountDownLatch mainFinished = new CountDownLatch(1);\n+        kernel.getMain().getStateTopic().subscribe((WhatHappened what, Topic t) -> {\n+            if (t.getOnce().equals(State.FINISHED)) {\n+                mainFinished.countDown();\n+            }\n+        });\n+\n+        // wait for main to finish\n+        assertTrue(mainFinished.await(10, TimeUnit.SECONDS));\n+\n+        Map<Object, Object> currentConfig = new HashMap<>(kernel.getConfig().toPOJO());\n+        ((Map) currentConfig.get(SERVICES_NAMESPACE_TOPIC)).remove(\"nondisruptable\");\n+\n+        Future<DeploymentResult> future =\n+                deploymentConfigMerger.mergeInNewConfig(testDeploymentDocument(), currentConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff9accd35db2b974e6d73c969bb1b56b603a37b3"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a862296f7496f0fe397472a6485944bf0be7831d", "committedDate": "2020-05-01T17:21:22Z", "message": "Rework test, flip logic to assume it is not safe to update"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e32acd114eb0c22a1c74f0109994696799e8c08e", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e32acd114eb0c22a1c74f0109994696799e8c08e", "committedDate": "2020-05-01T05:01:14Z", "message": "Rework test, flip logic to assume it is not safe to update"}, "afterCommit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a862296f7496f0fe397472a6485944bf0be7831d", "committedDate": "2020-05-01T17:21:22Z", "message": "Rework test, flip logic to assume it is not safe to update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjQ0ODI1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#pullrequestreview-405244825", "createdAt": "2020-05-04T18:36:13Z", "commit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODozNjoxM1rOGQNCsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODozNjoxM1rOGQNCsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY0NDA4Mg==", "bodyText": "NIT: I feel this 'run, wait for timeout, then stop Exec' logic can be extracted to a function. eg. 'runWithTimeout(ScriptNamespace, timeout, processesToTrack)'", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r419644082", "createdAt": "2020-05-04T18:36:13Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -171,17 +183,99 @@ private synchronized void handleRunScript() throws InterruptedException {\n     public synchronized void shutdown() {\n         logger.atInfo().log(\"Shutdown initiated\");\n         try {\n-            run(\"shutdown\", null);\n+            run(\"shutdown\", null, lifecycleProcesses);\n         } catch (InterruptedException ex) {\n             logger.atWarn(\"generic-service-shutdown\").log(\"Thread interrupted while shutting down service\");\n             return;\n         }\n-        stopAllProcesses();\n+        stopAllLifecycleProcesses();\n         logger.atInfo().setEventType(\"generic-service-shutdown\").log();\n     }\n \n+    @Override\n+    public long whenIsDisruptionOK() {\n+        stopAllSafeUpdateProcesses();\n+        try {\n+            CompletableFuture<Integer> exitFuture = new CompletableFuture<>();\n+            Pair<RunStatus, Exec> result = run(SAFE_UPDATE_TOPIC_NAME, exitFuture::complete, safeUpdateProcesses);\n+\n+            // If we didn't do anything then it is safe to update\n+            if (result.getLeft().equals(RunStatus.NothingDone)) {\n+                return 0L;\n+            }\n+\n+            // If it ran, then check the result or timeout\n+            if (result.getLeft().equals(RunStatus.OK)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1Mjg4OTky", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#pullrequestreview-405288992", "createdAt": "2020-05-04T19:38:35Z", "commit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxOTozODozNVrOGQPQPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoxNTowMVrOGQQetg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MDMxOA==", "bodyText": "Why do we need to change this? If we don't need to wait, change the comment above and also change the rollback method below?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r419680318", "createdAt": "2020-05-04T19:38:35Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -96,7 +96,7 @@\n \n             kernel.getConfig().mergeMap(timestamp, newConfig);\n             // wait until topic listeners finished processing mergeMap changes.\n-            kernel.getContext().runOnPublishQueueAndWait(() -> {\n+            kernel.getContext().runOnPublishQueue(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MTczMw==", "bodyText": "Our internal services are not updated through deployment and logically don't need a safety check, so this can be implemented at the GenericExternalService?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r419681733", "createdAt": "2020-05-04T19:41:00Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -35,7 +35,7 @@\n \n import static com.aws.iot.evergreen.util.Utils.getUltimateCause;\n \n-public class EvergreenService implements InjectionActions {\n+public class EvergreenService implements InjectionActions, DisruptableCheck {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwMDQwNg==", "bodyText": "Now that you're implementing DisruptableCheck interface at the service level, a service instance itself can function as a disruptable check instance, so this logic of going over services is duplicate, it was already being done at line 131-136", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r419700406", "createdAt": "2020-05-04T20:15:01Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -36,8 +37,32 @@\n     private final Map<String, Crashable> pendingActions = new LinkedHashMap<>();\n     private final List<DisruptableCheck> disruptableChecks = new CopyOnWriteArrayList<>();\n \n-    public UpdateSystemSafelyService(Topics c) {\n+    private final DisruptableCheck egServiceCheck = new DisruptableCheck() {\n+        @Override\n+        public long whenIsDisruptionOK() {\n+            return kernel.orderedDependencies().stream().mapToLong(EvergreenService::whenIsDisruptionOK).max()\n+                    .orElse(0L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MzMwNTIy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#pullrequestreview-405330522", "createdAt": "2020-05-04T20:40:56Z", "commit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00d1308bbbd858ca601bdaec75355c6009af7816", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/00d1308bbbd858ca601bdaec75355c6009af7816", "committedDate": "2020-05-04T20:49:20Z", "message": "Update for comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MzM5OTMx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#pullrequestreview-405339931", "createdAt": "2020-05-04T20:55:18Z", "commit": {"oid": "00d1308bbbd858ca601bdaec75355c6009af7816"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MzU4ODc0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#pullrequestreview-405358874", "createdAt": "2020-05-04T21:24:55Z", "commit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMToyNDo1NlrOGQSxpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMToyNDo1NlrOGQSxpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTczODAyMw==", "bodyText": "protected/private ?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r419738023", "createdAt": "2020-05-04T21:24:56Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -36,8 +37,32 @@\n     private final Map<String, Crashable> pendingActions = new LinkedHashMap<>();\n     private final List<DisruptableCheck> disruptableChecks = new CopyOnWriteArrayList<>();\n \n-    public UpdateSystemSafelyService(Topics c) {\n+    private final DisruptableCheck egServiceCheck = new DisruptableCheck() {\n+        @Override\n+        public long whenIsDisruptionOK() {\n+            return kernel.orderedDependencies().stream().mapToLong(EvergreenService::whenIsDisruptionOK).max()\n+                    .orElse(0L);\n+        }\n+\n+        @Override\n+        public void disruptionCompleted() {\n+            kernel.orderedDependencies().forEach(EvergreenService::disruptionCompleted);\n+        }\n+    };\n+\n+    private final Kernel kernel;\n+\n+    /**\n+     * Constructor for injection.\n+     *\n+     * @param c topics root\n+     * @param k kernel\n+     */\n+    @Inject\n+    public UpdateSystemSafelyService(Topics c, Kernel k) {\n         super(c);\n+        this.kernel = k;\n+        addDisruptableCheck(egServiceCheck);\n     }\n \n     public void addDisruptableCheck(DisruptableCheck d) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MzYwODQ0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#pullrequestreview-405360844", "createdAt": "2020-05-04T21:28:10Z", "commit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMToyODoxMFrOGQS3uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMToyODoxMFrOGQS3uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTczOTU3Ng==", "bodyText": "Not in the scope of this PR. Given we already moving out disruptableCheck interface, I'm wondering if we need UpdateSystemSafelyService to be a service. InjectObject may be enough.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#discussion_r419739576", "createdAt": "2020-05-04T21:28:10Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -36,8 +37,32 @@\n     private final Map<String, Crashable> pendingActions = new LinkedHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a862296f7496f0fe397472a6485944bf0be7831d"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MzYxNDYx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/218#pullrequestreview-405361461", "createdAt": "2020-05-04T21:29:11Z", "commit": {"oid": "00d1308bbbd858ca601bdaec75355c6009af7816"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2166, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}