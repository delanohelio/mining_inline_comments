{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5Mzg5MTEz", "number": 451, "title": "size limit - file ops", "bodyText": "Issue #, if available:\nDescription of changes:\n\nNew methods to PackageStore: getContentSize, getUsableSpace, deletePackage\nNew abstract getSize to ArtifactDownloader. Implement it for S3Downloader and GG repo Downloader\nRename unpack -> decompress\n\nE2E test to come in later PR\nWhy is this change necessary:\nTo be aware of artifact disk usage and prevent overfull disk.\nHow was this change tested:\nunit test\nAny additional information or context required to review the change:\nhttps://quip-amazon.com/AaoVA3qZbqhf/Evergreen-Package-Store-Size-Limit\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-09-18T15:29:17Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451", "merged": true, "mergeCommit": {"oid": "13a7c1492fb16656617a09ebbe7e25db411ac5dc"}, "closed": true, "closedAt": "2020-09-23T23:13:53Z", "author": {"login": "tilo-chen"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKNxZgAFqTQ5MTgxODk3Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL05uZgFqTQ5NTExMTE2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxODE4OTcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#pullrequestreview-491818973", "createdAt": "2020-09-18T22:39:52Z", "commit": {"oid": "8f011ba05f809bcbe9264a488c186486f7f1f45c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMjozOTo1MlrOHUd5pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMjo1Njo1OFrOHUeJ1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIyMzQ2Mg==", "bodyText": "Maybe also check artifactsDecompressedDirectory and delete it", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#discussion_r491223462", "createdAt": "2020-09-18T22:39:52Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -136,6 +137,23 @@ PackageRecipe getPackageRecipe(@NonNull PackageIdentifier pkgId) throws PackageL\n         return optionalPackage.get();\n     }\n \n+    /**\n+     * Delete the package recipe and all artifacts from disk.\n+     *\n+     * @param pkgId package identifier\n+     */\n+    void deletePackage(@NonNull PackageIdentifier pkgId) throws PackagingException {\n+        Path recipePath = resolveRecipePath(pkgId.getName(), pkgId.getVersion());\n+        Path artifactDirPath = resolveArtifactDirectoryPath(pkgId);\n+\n+        try {\n+            Files.deleteIfExists(recipePath);\n+            FileUtils.deleteDirectory(artifactDirPath.toFile());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f011ba05f809bcbe9264a488c186486f7f1f45c"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIyNzYwNQ==", "bodyText": "hmm. how often do we recalculate the whole directory? I feel we can keep track of an increasing number until the next cleanup", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#discussion_r491227605", "createdAt": "2020-09-18T22:56:58Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -233,6 +251,36 @@ public Path resolveAndSetupArtifactsUnpackDirectory(@NonNull PackageIdentifier p\n         }\n     }\n \n+    /**\n+     * Get the total size of files in the package store by recursively walking the package store directory. Provides an\n+     * estimate of the package store's disk usage.\n+     *\n+     * @return total length of files in bytes\n+     * @throws UnexpectedPackagingException if unable to access the package store directory\n+     */\n+    public long getContentSize() throws UnexpectedPackagingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f011ba05f809bcbe9264a488c186486f7f1f45c"}, "originalPosition": 63}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f011ba05f809bcbe9264a488c186486f7f1f45c", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8f011ba05f809bcbe9264a488c186486f7f1f45c", "committedDate": "2020-09-18T19:16:19Z", "message": "minor fix"}, "afterCommit": {"oid": "b03162dbd606a748e2a584cfc7ff07313fe35c27", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b03162dbd606a748e2a584cfc7ff07313fe35c27", "committedDate": "2020-09-21T16:03:14Z", "message": "package store file operations; rebase master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODU1Mzg5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#pullrequestreview-492855389", "createdAt": "2020-09-21T18:00:08Z", "commit": {"oid": "b03162dbd606a748e2a584cfc7ff07313fe35c27"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODowMDowOFrOHVcYlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODowMDoxMFrOHVcYqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0NzE4OA==", "bodyText": "Maybe use consistent name DecompressedDirectory?\nAlso reuse this method in resolveAndSetupArtifactsUnpackDirectory below", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#discussion_r492247188", "createdAt": "2020-09-21T18:00:08Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -215,6 +235,17 @@ private Path resolveRecipePath(String packageName, Semver packageVersion) {\n         return recipeDirectory.resolve(String.format(RECIPE_FILE_NAME_FORMAT, packageName, packageVersion.getValue()));\n     }\n \n+    /**\n+     * Resolve the artifact unpack directory.\n+     *\n+     * @param packageIdentifier packageIdentifier\n+     * @return artifact unpack directory path\n+     */\n+    public Path resolveArtifactsUnpackDirectory(@NonNull ComponentIdentifier packageIdentifier) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03162dbd606a748e2a584cfc7ff07313fe35c27"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0NzIwOQ==", "bodyText": "I think it's possible artifactDirPath or artifactUnpackDirPath doesn't exist. Maybe don't throw in that case?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#discussion_r492247209", "createdAt": "2020-09-21T18:00:10Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -138,6 +139,25 @@ ComponentRecipe getPackageRecipe(@NonNull ComponentIdentifier pkgId) throws Pack\n         return optionalPackage.get();\n     }\n \n+    /**\n+     * Delete the package recipe and all artifacts from disk.\n+     *\n+     * @param pkgId package identifier\n+     */\n+    void deletePackage(@NonNull ComponentIdentifier pkgId) throws PackagingException {\n+        Path recipePath = resolveRecipePath(pkgId.getName(), pkgId.getVersion());\n+        Path artifactDirPath = resolveArtifactDirectoryPath(pkgId);\n+        Path artifactUnpackDirPath = resolveArtifactsUnpackDirectory(pkgId);\n+\n+        try {\n+            Files.deleteIfExists(recipePath);\n+            FileUtils.deleteDirectory(artifactDirPath.toFile());\n+            FileUtils.deleteDirectory(artifactUnpackDirPath.toFile());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b03162dbd606a748e2a584cfc7ff07313fe35c27"}, "originalPosition": 57}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b03162dbd606a748e2a584cfc7ff07313fe35c27", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b03162dbd606a748e2a584cfc7ff07313fe35c27", "committedDate": "2020-09-21T16:03:14Z", "message": "package store file operations; rebase master"}, "afterCommit": {"oid": "dbc6f6951a344798928515aed1a15c0c2e321d41", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dbc6f6951a344798928515aed1a15c0c2e321d41", "committedDate": "2020-09-22T03:02:24Z", "message": "package store file operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91ede7b0bf318e832aeeb2857e086774d98a8c54", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/91ede7b0bf318e832aeeb2857e086774d98a8c54", "committedDate": "2020-09-22T03:06:38Z", "message": "package store file operations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dbc6f6951a344798928515aed1a15c0c2e321d41", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dbc6f6951a344798928515aed1a15c0c2e321d41", "committedDate": "2020-09-22T03:02:24Z", "message": "package store file operations"}, "afterCommit": {"oid": "91ede7b0bf318e832aeeb2857e086774d98a8c54", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/91ede7b0bf318e832aeeb2857e086774d98a8c54", "committedDate": "2020-09-22T03:06:38Z", "message": "package store file operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fba2a61de4cebbce3310a3fadcc794353702f81", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7fba2a61de4cebbce3310a3fadcc794353702f81", "committedDate": "2020-09-22T16:59:19Z", "message": "Merge branch 'master' into size-limit-tc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzE2MjE0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#pullrequestreview-493716214", "createdAt": "2020-09-22T18:01:08Z", "commit": {"oid": "7fba2a61de4cebbce3310a3fadcc794353702f81"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzUyMTY3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#pullrequestreview-493752167", "createdAt": "2020-09-22T18:49:22Z", "commit": {"oid": "7fba2a61de4cebbce3310a3fadcc794353702f81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODo0OToyMlrOHWH4fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODo0OToyMlrOHWH4fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk1OTg3MA==", "bodyText": "rename package to component everywhere", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#discussion_r492959870", "createdAt": "2020-09-22T18:49:22Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/componentmanager/ComponentStore.java", "diffHunk": "@@ -138,6 +139,25 @@ ComponentRecipe getPackageRecipe(@NonNull ComponentIdentifier pkgId) throws Pack\n         return optionalPackage.get();\n     }\n \n+    /**\n+     * Delete the package recipe and all artifacts from disk.\n+     *\n+     * @param pkgId package identifier\n+     */\n+    void deletePackage(@NonNull ComponentIdentifier pkgId) throws PackagingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fba2a61de4cebbce3310a3fadcc794353702f81"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb13dd4ac8e101af662a2b4e5f22a40062f669fb", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fb13dd4ac8e101af662a2b4e5f22a40062f669fb", "committedDate": "2020-09-22T19:19:48Z", "message": "Merge branch 'master' into size-limit-tc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "540f1c082dc13ba280f3aea7451272374f972394", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/540f1c082dc13ba280f3aea7451272374f972394", "committedDate": "2020-09-23T21:10:26Z", "message": "Merge branch 'master' into size-limit-tc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTEwMzIy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#pullrequestreview-495110322", "createdAt": "2020-09-23T23:07:11Z", "commit": {"oid": "540f1c082dc13ba280f3aea7451272374f972394"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzowNzoxMVrOHXD6fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMzowNzoxMVrOHXD6fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0MzQyMA==", "bodyText": "Didn't you verify this already?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#discussion_r493943420", "createdAt": "2020-09-23T23:07:11Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/greengrass/componentmanager/plugins/GreengrassRepositoryDownloader.java", "diffHunk": "@@ -103,6 +105,38 @@ public File downloadToPath(ComponentIdentifier componentIdentifier, ComponentArt\n         return null;\n     }\n \n+    /**\n+     * Get the size of artifact from greengrass repo by sending HTTP HEAD request.\n+     *\n+     * @param packageIdentifier package info\n+     * @param artifact artifact info\n+     * @return ContentLength in bytes\n+     */\n+    @Override\n+    public long getSize(ComponentIdentifier packageIdentifier, ComponentArtifact artifact)\n+            throws IOException, PackageDownloadException {\n+        logger.atInfo().setEventType(\"get-artifact-size-from-greengrass-repo\")\n+                .addKeyValue(\"packageIdentifier\", packageIdentifier)\n+                .addKeyValue(\"artifactUri\", artifact.getArtifactUri().toString()).log();\n+\n+        String preSignedUrl =\n+                getArtifactDownloadURL(packageIdentifier, artifact.getArtifactUri().getSchemeSpecificPart());\n+        URL url = new URL(preSignedUrl);\n+        HttpURLConnection conn = connect(url);\n+        conn.setRequestMethod(\"HEAD\");\n+        Map<String, List<String>> headers = conn.getHeaderFields();\n+        // TODO verify this works by trying on a real package", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "540f1c082dc13ba280f3aea7451272374f972394"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTExMTYz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/451#pullrequestreview-495111163", "createdAt": "2020-09-23T23:08:31Z", "commit": {"oid": "540f1c082dc13ba280f3aea7451272374f972394"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2980, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}