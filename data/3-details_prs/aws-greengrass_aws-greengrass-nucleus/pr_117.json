{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NTIwNjg5", "number": 117, "title": "Update definition of skip if, remove support for arbitrary scripts", "bodyText": "Issue #, if available:\nhttps://issues.amazon.com/issues/P33898016\nDescription of changes:\nUpdate the skipif keyword in lifecycle steps to remove support for running arbitrary scripts. The customer can just choose to run scripts in the \"script\" section.\nThe skipif keyword will support \"onpath\", \"exists\" and other convenience keywords only. More keywords will be added as needed.\nHow was this change tested:\nAdded an integration test to ensure service moves to error state.\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-03-16T22:15:18Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117", "merged": true, "mergeCommit": {"oid": "67a102437dd8835af7a03dc4fc05f4170591cc2d"}, "closed": true, "closedAt": "2020-03-17T11:14:11Z", "author": {"login": "chaurah"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOVxACgFqTM3NTYxOTcwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOgplGABqjMxMzY4MzkxMTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjE5NzA0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#pullrequestreview-375619704", "createdAt": "2020-03-16T22:19:25Z", "commit": {"oid": "45a8c998fede40d1b89f8498224fc42813b2d485"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjoxOToyNVrOF3Hm2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjoyMjozMFrOF3HrFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MDYzNQ==", "bodyText": "remove -log stdout.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393340635", "createdAt": "2020-03-16T22:19:25Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.integrationtests.kernel;\n+\n+import java.nio.file.Path;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(PerformanceReporting.class)\n+class GenericExternalServiceTest {\n+    private Kernel kernel;\n+\n+    @TempDir\n+    Path tempRootDir;\n+\n+\n+    @BeforeEach\n+    void before(TestInfo testInfo) {\n+        System.out.println(\"Running test: \" + testInfo.getDisplayName());\n+        System.setProperty(\"log.store\", \"CONSOLE\");\n+        System.setProperty(\"log.fmt\", \"TEXT\");\n+        kernel = new Kernel();\n+    }\n+\n+    @AfterEach\n+    void after() {\n+        kernel.shutdownNow();\n+    }\n+\n+    @Test\n+    void GIVEN_kernel_running_single_service_WHEN_merge_change_to_service_THEN_service_restarts_with_new_config()\n+            throws Throwable {\n+        // GIVEN\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", tempRootDir.toString(), \"-log\", \"stdout\", \"-i\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45a8c998fede40d1b89f8498224fc42813b2d485"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MTA2Mg==", "bodyText": "This name is not correct.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393341062", "createdAt": "2020-03-16T22:20:42Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.integrationtests.kernel;\n+\n+import java.nio.file.Path;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(PerformanceReporting.class)\n+class GenericExternalServiceTest {\n+    private Kernel kernel;\n+\n+    @TempDir\n+    Path tempRootDir;\n+\n+\n+    @BeforeEach\n+    void before(TestInfo testInfo) {\n+        System.out.println(\"Running test: \" + testInfo.getDisplayName());\n+        System.setProperty(\"log.store\", \"CONSOLE\");\n+        System.setProperty(\"log.fmt\", \"TEXT\");\n+        kernel = new Kernel();\n+    }\n+\n+    @AfterEach\n+    void after() {\n+        kernel.shutdownNow();\n+    }\n+\n+    @Test\n+    void GIVEN_kernel_running_single_service_WHEN_merge_change_to_service_THEN_service_restarts_with_new_config()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45a8c998fede40d1b89f8498224fc42813b2d485"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM0MTcxOQ==", "bodyText": "I'm not sure we want it to be in errored, is it possible to do this validation and just fail to create the service?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393341719", "createdAt": "2020-03-16T22:22:30Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.integrationtests.kernel;\n+\n+import java.nio.file.Path;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@ExtendWith(PerformanceReporting.class)\n+class GenericExternalServiceTest {\n+    private Kernel kernel;\n+\n+    @TempDir\n+    Path tempRootDir;\n+\n+\n+    @BeforeEach\n+    void before(TestInfo testInfo) {\n+        System.out.println(\"Running test: \" + testInfo.getDisplayName());\n+        System.setProperty(\"log.store\", \"CONSOLE\");\n+        System.setProperty(\"log.fmt\", \"TEXT\");\n+        kernel = new Kernel();\n+    }\n+\n+    @AfterEach\n+    void after() {\n+        kernel.shutdownNow();\n+    }\n+\n+    @Test\n+    void GIVEN_kernel_running_single_service_WHEN_merge_change_to_service_THEN_service_restarts_with_new_config()\n+            throws Throwable {\n+        // GIVEN\n+        Kernel kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", tempRootDir.toString(), \"-log\", \"stdout\", \"-i\",\n+                getClass().getResource(\"skipif_broken.yaml\").toString());\n+\n+        CountDownLatch testErrored = new CountDownLatch(1);\n+        kernel.context.addGlobalStateChangeListener((service, oldState, newState) -> {\n+            if (service.getName().equals(\"test\") && newState.equals(State.ERRORED)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45a8c998fede40d1b89f8498224fc42813b2d485"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjMxNTIx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#pullrequestreview-375631521", "createdAt": "2020-03-16T22:43:48Z", "commit": {"oid": "45a8c998fede40d1b89f8498224fc42813b2d485"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjo0Mzo0OFrOF3INYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjo0Mzo0OFrOF3INYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1MDQ5OA==", "bodyText": "no git defined here?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393350498", "createdAt": "2020-03-16T22:43:48Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/resources/com/aws/iot/evergreen/integrationtests/kernel/skipif_broken.yaml", "diffHunk": "@@ -0,0 +1,16 @@\n+services:\n+  test:\n+    lifecycle:\n+      run:\n+        debian:\n+          skipif: This is broken\n+          script: echo \"Running test\" && sleep 10\n+        macos:\n+          skipif: This is broken\n+          script: echo \"Running test\" && sleep 10\n+  main:\n+    lifecycle:\n+      run:\n+        script: echo \"Running main\" && sleep 60\n+    dependencies:\n+      - git", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45a8c998fede40d1b89f8498224fc42813b2d485"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45a8c998fede40d1b89f8498224fc42813b2d485", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/45a8c998fede40d1b89f8498224fc42813b2d485", "committedDate": "2020-03-16T21:37:37Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}, "afterCommit": {"oid": "d7a840478d3c2b1e45b155de7d1303bef6f7aabf", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d7a840478d3c2b1e45b155de7d1303bef6f7aabf", "committedDate": "2020-03-16T22:48:10Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjQyNjY1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#pullrequestreview-375642665", "createdAt": "2020-03-16T23:10:38Z", "commit": {"oid": "d7a840478d3c2b1e45b155de7d1303bef6f7aabf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjY1MDky", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#pullrequestreview-375665092", "createdAt": "2020-03-17T00:25:07Z", "commit": {"oid": "d7a840478d3c2b1e45b155de7d1303bef6f7aabf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwMDoyNTowN1rOF3KFXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwMDoyNTowN1rOF3KFXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM4MTIxNQ==", "bodyText": "NIT: Duplicate with L45?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#discussion_r393381215", "createdAt": "2020-03-17T00:25:07Z", "author": {"login": "ShirleyZheng92"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/kernel/GenericExternalServiceTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/* Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0 */\n+\n+package com.aws.iot.evergreen.integrationtests.kernel;\n+\n+import java.nio.file.Path;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import com.aws.iot.evergreen.dependency.State;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class GenericExternalServiceTest {\n+    private Kernel kernel;\n+\n+    @TempDir\n+    Path tempRootDir;\n+\n+\n+    @BeforeEach\n+    void before(TestInfo testInfo) {\n+        System.out.println(\"Running test: \" + testInfo.getDisplayName());\n+        System.setProperty(\"log.store\", \"CONSOLE\");\n+        System.setProperty(\"log.fmt\", \"TEXT\");\n+        kernel = new Kernel();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7a840478d3c2b1e45b155de7d1303bef6f7aabf"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjY1MTYz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/117#pullrequestreview-375665163", "createdAt": "2020-03-17T00:25:21Z", "commit": {"oid": "d7a840478d3c2b1e45b155de7d1303bef6f7aabf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7a840478d3c2b1e45b155de7d1303bef6f7aabf", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d7a840478d3c2b1e45b155de7d1303bef6f7aabf", "committedDate": "2020-03-16T22:48:10Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}, "afterCommit": {"oid": "2ec974e018e433094b46874ce34c5d574ad7a9e5", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ec974e018e433094b46874ce34c5d574ad7a9e5", "committedDate": "2020-03-17T06:58:37Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ec974e018e433094b46874ce34c5d574ad7a9e5", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2ec974e018e433094b46874ce34c5d574ad7a9e5", "committedDate": "2020-03-17T06:58:37Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}, "afterCommit": {"oid": "f339c221cf6656311ba40018ce0f822f45365cec", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f339c221cf6656311ba40018ce0f822f45365cec", "committedDate": "2020-03-17T09:46:48Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f339c221cf6656311ba40018ce0f822f45365cec", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f339c221cf6656311ba40018ce0f822f45365cec", "committedDate": "2020-03-17T09:46:48Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}, "afterCommit": {"oid": "8496fedcebb55ac08f0f80a6568c50894f720b8b", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8496fedcebb55ac08f0f80a6568c50894f720b8b", "committedDate": "2020-03-17T10:51:22Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf2f796b433a251539158a26ccdb711eba3725ce", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cf2f796b433a251539158a26ccdb711eba3725ce", "committedDate": "2020-03-17T11:03:13Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8496fedcebb55ac08f0f80a6568c50894f720b8b", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8496fedcebb55ac08f0f80a6568c50894f720b8b", "committedDate": "2020-03-17T10:51:22Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}, "afterCommit": {"oid": "cf2f796b433a251539158a26ccdb711eba3725ce", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cf2f796b433a251539158a26ccdb711eba3725ce", "committedDate": "2020-03-17T11:03:13Z", "message": "Update definition of skip if, remove support for arbitrary scripts"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2344, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}