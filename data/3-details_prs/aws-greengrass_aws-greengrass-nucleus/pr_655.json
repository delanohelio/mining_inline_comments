{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4ODgzNTQ1", "number": 655, "title": "Move ACL to a nested config style", "bodyText": "Issue #, if available:\nDescription of changes:\nMove ACL config to a nested config structure.\nWhy is this change necessary:\nTo allow customers to create/update ACL parameter easily with possible updates to individual keys.\nHow was this change tested:\nUT and integ tests.\nOne integ test currently fails, still working on it.\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-11-11T01:56:04Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655", "merged": true, "mergeCommit": {"oid": "25d837dfd72026898ff341c9d34f3a2d53228f25"}, "closed": true, "closedAt": "2020-11-16T18:08:11Z", "author": {"login": "prateek-y"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbUCbwgH2gAyNTE4ODgzNTQ1OjNkZTgyODE2MGYxMmRkYzE2YmYxYTMwNzJkNGY5YjQ2OGY4ZmMwZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddI9Y8AFqTUzMTU3NzIwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3de828160f12ddc16bf1a3072d4f9b468f8fc0ff", "committedDate": "2020-11-11T01:53:57Z", "message": "Move ACL to a nested config style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Nzg5MjA2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#pullrequestreview-527789206", "createdAt": "2020-11-11T01:57:47Z", "commit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMTo1Nzo0N1rOHw4O5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMTo1Nzo0N1rOHw4O5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNTAxMw==", "bodyText": "noice, much cleaner now.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521015013", "createdAt": "2020-11-11T01:57:47Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/resources/com/aws/greengrass/integrationtests/ipc/pubsub.yaml", "diffHunk": "@@ -11,23 +11,16 @@ services:\n   PublishNotSubscribe:\n     parameters:\n       accessControl:\n-        '{\n-          \"aws.greengrass.ipc.pubsub\":[\n-          {\n-            \"policyId1\":{\n-              \"policyDescription\":\"access to pubsub topics for mqtt\",\n-              \"operations\":[\n-                \"aws.greengrass#PublishToTopic\"\n-              ],\n-              \"resources\":[\n-                \"/topic/1/#\",\n-                \"/longer/topic/example/\",\n-                \"*\"\n-              ]\n-            }\n-          }\n-          ]\n-        }'\n+        aws.greengrass.ipc.pubsub:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Nzg5NzEz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#pullrequestreview-527789713", "createdAt": "2020-11-11T01:59:14Z", "commit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMTo1OToxNFrOHw4S4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMjowMToyNVrOHw4ZCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNjAzMw==", "bodyText": "why not use the lombok to string?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521016033", "createdAt": "2020-11-11T01:59:14Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationPolicy.java", "diffHunk": "@@ -5,42 +5,36 @@\n \n package com.aws.greengrass.authorization;\n \n+import lombok.AllArgsConstructor;\n import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n import lombok.NonNull;\n-import lombok.Value;\n \n import java.util.Set;\n \n-@Value\n-@Builder\n+/**\n+ * Class that holds full access control policy which translates to {@link Permission}.\n+ */\n+@Builder(toBuilder = true)\n+@Data\n+@AllArgsConstructor\n+@NoArgsConstructor\n public class AuthorizationPolicy implements Comparable<AuthorizationPolicy> {\n     @NonNull String policyId;\n     String policyDescription;\n     @NonNull Set<String> principals;\n     @NonNull Set<String> operations;\n     Set<String> resources;\n \n-    enum PolicyComponentTypes {\n-        POLICY_DESCRIPTION(\"policyDescription\"),\n-        PRINCIPALS(\"principals\"),\n-        OPERATIONS(\"operations\"),\n-        RESOURCES(\"resources\"),\n-        UNKNOWN(\"unknown\");\n-\n-        private final String name;\n-\n-        PolicyComponentTypes(String s) {\n-            name = s;\n-        }\n-\n-        @Override\n-        public String toString() {\n-            return this.name;\n-        }\n-    }\n-\n     @Override\n     public int compareTo(AuthorizationPolicy other) {\n         return this.policyId.compareTo(other.policyId);\n     }\n+\n+    @Override\n+    public String toString() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNzI3NQ==", "bodyText": "Why have this? Seems like it is going to be noisy when we have debug logs.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521017275", "createdAt": "2020-11-11T02:00:59Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/builtin/services/mqttproxy/MqttProxyIPCAgent.java", "diffHunk": "@@ -211,6 +211,10 @@ void doAuthorization(String opName, String serviceName, String topic) throws Aut\n \n         for (String topicFilter : authorizedResources) {\n             if (topicFilter.equals(ANY_REGEX) || MqttTopic.topicIsSupersetOf(topicFilter, topic)) {\n+                LOGGER.atDebug().log(\"Hit policy with principal {}, operation {}, resource {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNzYxMA==", "bodyText": "secret manager should be capitalized SecretsManager", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521017610", "createdAt": "2020-11-11T02:01:25Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/greengrass/authorization/AuthorizationPolicyParserTest.java", "diffHunk": "@@ -44,6 +45,7 @@\n @ExtendWith({MockitoExtension.class, GGExtension.class})\n class AuthorizationPolicyParserTest {\n \n+    private final static String SECRET_SERVICE = \"aws.greengrass.secretsManager\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac053daa4f865c615e1f7ffaf309b1cb6c5c6b98", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ac053daa4f865c615e1f7ffaf309b1cb6c5c6b98", "committedDate": "2020-11-11T02:07:43Z", "message": "Merge branch 'master' into ACL_config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e20399840eb5f7accc3bc07e59a712968f5c456", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8e20399840eb5f7accc3bc07e59a712968f5c456", "committedDate": "2020-11-11T02:19:01Z", "message": "Move ACL to a nested config style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bc13a5aed528378ac210b635e2ed0c57b580157", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2bc13a5aed528378ac210b635e2ed0c57b580157", "committedDate": "2020-11-11T21:40:03Z", "message": "Merge branch 'master' into ACL_config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfa6196bd121e97f0b1fd656096d1905fe65c6c9", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dfa6196bd121e97f0b1fd656096d1905fe65c6c9", "committedDate": "2020-11-11T22:06:26Z", "message": "Merge branch 'master' into ACL_config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "045045b303ae3c6b59711f70d8fd11161bd2528b", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/045045b303ae3c6b59711f70d8fd11161bd2528b", "committedDate": "2020-11-12T07:50:26Z", "message": "Fix some integ tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4a50d014b0af3b4ee0a1abe19bd6f71b720c181", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b4a50d014b0af3b4ee0a1abe19bd6f71b720c181", "committedDate": "2020-11-12T07:54:30Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7352142cc17aa6276280148cd350ec6430dc9625", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7352142cc17aa6276280148cd350ec6430dc9625", "committedDate": "2020-11-12T08:31:48Z", "message": "Remove mapper properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43f05bdb4e485814ded39d580544bbe5dc9338d7", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/43f05bdb4e485814ded39d580544bbe5dc9338d7", "committedDate": "2020-11-12T23:33:17Z", "message": "Merge branch 'master' into ACL_config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NjgxNTI1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#pullrequestreview-529681525", "createdAt": "2020-11-13T03:33:16Z", "commit": {"oid": "43f05bdb4e485814ded39d580544bbe5dc9338d7"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMzozMzoxN1rOHyYfTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMzozMzo1M1rOHyYfxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjA3Ng==", "bodyText": "check for what is timestampUpdated or interiorAdded those 2 event types you can safely ignore to save on re-parsing effort.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r522592076", "createdAt": "2020-11-13T03:33:17Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -92,8 +91,8 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n             this.loadAuthorizationPolicies(acl.getKey(), acl.getValue(), false);\n         }\n \n-        //Subscribe to future auth config updates\n-        this.kernel.getConfig().getRoot().subscribe(\n+        // Subscribe to future auth config updates\n+        this.kernel.getConfig().lookupTopics(SERVICES_NAMESPACE_TOPIC).subscribe(\n                 (why, newv) -> {\n                     if (newv == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f05bdb4e485814ded39d580544bbe5dc9338d7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjE5Ng==", "bodyText": "why remove case insensitive properties? We should be lenient IMO", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r522592196", "createdAt": "2020-11-13T03:33:53Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationPolicyParser.java", "diffHunk": "@@ -5,41 +5,33 @@\n \n package com.aws.greengrass.authorization;\n \n-import com.aws.greengrass.authorization.AuthorizationPolicy.PolicyComponentTypes;\n import com.aws.greengrass.config.Node;\n import com.aws.greengrass.config.Topic;\n import com.aws.greengrass.config.Topics;\n import com.aws.greengrass.lifecyclemanager.Kernel;\n import com.aws.greengrass.logging.api.Logger;\n import com.aws.greengrass.logging.impl.LogManager;\n-import com.aws.greengrass.util.Coerce;\n import com.aws.greengrass.util.Utils;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.core.type.TypeReference;\n-import com.fasterxml.jackson.databind.MapperFeature;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.json.JsonMapper;\n \n import java.util.ArrayList;\n import java.util.HashMap;\n-import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n-import java.util.Set;\n \n import static com.aws.greengrass.componentmanager.KernelConfigResolver.PARAMETERS_CONFIG_KEY;\n import static com.aws.greengrass.lifecyclemanager.GreengrassService.ACCESS_CONTROL_NAMESPACE_TOPIC;\n import static com.aws.greengrass.lifecyclemanager.GreengrassService.SERVICES_NAMESPACE_TOPIC;\n-import static com.aws.greengrass.util.Coerce.toEnum;\n \n public final class AuthorizationPolicyParser {\n     private static final Logger logger = LogManager.getLogger(AuthorizationPolicyParser.class);\n-    private static final ObjectMapper OBJECT_MAPPER =\n-            JsonMapper.builder().configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true).build();\n+    private static final ObjectMapper OBJECT_MAPPER = JsonMapper.builder().build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f05bdb4e485814ded39d580544bbe5dc9338d7"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90800418bb9439b20158e0cd037cda32c98e68d9", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/90800418bb9439b20158e0cd037cda32c98e68d9", "committedDate": "2020-11-13T19:54:48Z", "message": "More feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccb987b0c8b5bd40aac069555b0e0cb3d2e090ce", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ccb987b0c8b5bd40aac069555b0e0cb3d2e090ce", "committedDate": "2020-11-13T20:00:03Z", "message": "Merge branch 'master' into ACL_config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd3c5cdcc44b10c41c0c73a745931b9226588e23", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cd3c5cdcc44b10c41c0c73a745931b9226588e23", "committedDate": "2020-11-13T20:02:46Z", "message": "Merge branch 'master' into ACL_config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d02e76bff1cb35d1108134d5d563bd07ed191504", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d02e76bff1cb35d1108134d5d563bd07ed191504", "committedDate": "2020-11-13T20:06:30Z", "message": "update logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed2a1122c2d352fe0de8767af65332c4a824d986", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ed2a1122c2d352fe0de8767af65332c4a824d986", "committedDate": "2020-11-13T21:16:46Z", "message": "Merge branch 'master' into ACL_config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40d62b02f6a80569bc331b5c218ada640d027de1", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/40d62b02f6a80569bc331b5c218ada640d027de1", "committedDate": "2020-11-13T23:00:31Z", "message": "Merge branch 'master' into ACL_config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTU2MTUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#pullrequestreview-530556153", "createdAt": "2020-11-14T05:29:32Z", "commit": {"oid": "40d62b02f6a80569bc331b5c218ada640d027de1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cb25bcb4017ad013225e8119788905115219cad", "author": {"user": {"login": "prateek-y", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0cb25bcb4017ad013225e8119788905115219cad", "committedDate": "2020-11-16T01:45:08Z", "message": "Merge branch 'master' into ACL_config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTc3MjA0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#pullrequestreview-531577204", "createdAt": "2020-11-16T18:07:20Z", "commit": {"oid": "0cb25bcb4017ad013225e8119788905115219cad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2632, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}