{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNjcxMTg4", "number": 744, "title": "Add timeout for recovery lifecycle step", "bodyText": "Issue #, if available:\nhttps://issues.amazon.com/issues/P42089045\nDescription of changes:\nHandle customer provided timeout and in the absence of it use a default timeout for lifecycle recovery step so it doesn't end up running forever when unresponsive\nWhy is this change necessary:\nHow was this change tested:\nAny additional information or context required to review the change:\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-12-02T01:06:08Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744", "merged": true, "mergeCommit": {"oid": "7fc831f24ce56b9f4ec6d9c354cf34b9d914aea1"}, "closed": true, "closedAt": "2020-12-02T17:39:44Z", "author": {"login": "shaguptashaikh"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiD_7SAFqTU0MjQyMzIyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiSBepAFqTU0MzA3NDc0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNDIzMjI4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#pullrequestreview-542423228", "createdAt": "2020-12-02T01:10:12Z", "commit": {"oid": "412b26ae10396173bae25249cdcdca0ae46cf5c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMToxMDoxMlrOH9GS6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMToxMDoxMlrOH9GS6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyODMzMA==", "bodyText": "why add this? Our other lifecycle steps can also timeout, but they never throw it up", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#discussion_r533828330", "createdAt": "2020-12-02T01:10:12Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/GreengrassService.java", "diffHunk": "@@ -229,8 +229,9 @@ public final void requestStop() {\n      * Custom handler to handle error.\n      *\n      * @throws InterruptedException if the thread is interrupted while handling the error\n+     * @throws TimeoutException if running the handler takes longer than the timeout\n      */\n-    protected void handleError() throws InterruptedException {\n+    protected void handleError() throws InterruptedException, TimeoutException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "412b26ae10396173bae25249cdcdca0ae46cf5c9"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a40ed3f5c1875bd7c36ae2b3281d4e852eb63dab", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a40ed3f5c1875bd7c36ae2b3281d4e852eb63dab", "committedDate": "2020-12-02T01:13:38Z", "message": "Merge branch 'master' into recovery-timeout"}, "afterCommit": {"oid": "018e2817a8dc00e8b76b3d770ec7c6fdd7793356", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/018e2817a8dc00e8b76b3d770ec7c6fdd7793356", "committedDate": "2020-12-02T01:15:35Z", "message": "Add timeout for recovery lifecycle step"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "018e2817a8dc00e8b76b3d770ec7c6fdd7793356", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/018e2817a8dc00e8b76b3d770ec7c6fdd7793356", "committedDate": "2020-12-02T01:15:35Z", "message": "Add timeout for recovery lifecycle step"}, "afterCommit": {"oid": "c52f50d1df33f114b60c3cf42b579679e68e62b0", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c52f50d1df33f114b60c3cf42b579679e68e62b0", "committedDate": "2020-12-02T01:50:27Z", "message": "Skip all logic when there is no recovery config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "629234025b9ddd056effc8125f8dc44ea4455e83", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/629234025b9ddd056effc8125f8dc44ea4455e83", "committedDate": "2020-12-02T03:30:59Z", "message": "Add timeout for recovery lifecycle step"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6e4ce7b5efcb8ea0ec1f4121e5d0f17c20d0e2a", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f6e4ce7b5efcb8ea0ec1f4121e5d0f17c20d0e2a", "committedDate": "2020-12-02T03:30:59Z", "message": "Skip all logic when there is no recovery config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c52f50d1df33f114b60c3cf42b579679e68e62b0", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c52f50d1df33f114b60c3cf42b579679e68e62b0", "committedDate": "2020-12-02T01:50:27Z", "message": "Skip all logic when there is no recovery config"}, "afterCommit": {"oid": "4a8e115d9a51539583fd89b4da7c65ca71b1b5cb", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4a8e115d9a51539583fd89b4da7c65ca71b1b5cb", "committedDate": "2020-12-02T03:30:59Z", "message": "Address comments and add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19d16ca29b2bb405c639d21c5eacb099fea81196", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19d16ca29b2bb405c639d21c5eacb099fea81196", "committedDate": "2020-12-02T03:36:09Z", "message": "Address comments and add more tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a8e115d9a51539583fd89b4da7c65ca71b1b5cb", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4a8e115d9a51539583fd89b4da7c65ca71b1b5cb", "committedDate": "2020-12-02T03:30:59Z", "message": "Address comments and add more tests"}, "afterCommit": {"oid": "19d16ca29b2bb405c639d21c5eacb099fea81196", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/19d16ca29b2bb405c639d21c5eacb099fea81196", "committedDate": "2020-12-02T03:36:09Z", "message": "Address comments and add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f9e3c3f53a694890afb1d37417f607aecef6f88", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4f9e3c3f53a694890afb1d37417f607aecef6f88", "committedDate": "2020-12-02T03:59:37Z", "message": "Fix permission issue with integ test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba63dc04000c08aa632938eccf3a2cc43fbc5444", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/ba63dc04000c08aa632938eccf3a2cc43fbc5444", "committedDate": "2020-12-02T06:35:32Z", "message": "Try fixing integ test again"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNTU0NDEy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#pullrequestreview-542554412", "createdAt": "2020-12-02T07:21:13Z", "commit": {"oid": "ba63dc04000c08aa632938eccf3a2cc43fbc5444"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwNzoyMToxM1rOH9NbGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwNzoyMToxM1rOH9NbGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk0NTExNQ==", "bodyText": "What if this process goes rogue? Don't we need to kill it when it times out?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#discussion_r533945115", "createdAt": "2020-12-02T07:21:13Z", "author": {"login": "fengwang666"}, "path": "src/main/java/com/aws/greengrass/lifecyclemanager/GenericExternalService.java", "diffHunk": "@@ -387,8 +387,22 @@ private synchronized void stopProcesses(List<Exec> processes) {\n \n     @Override\n     public void handleError() throws InterruptedException {\n-        // A placeholder for error handling in GenericExternalService\n-        run(\"recover\", null, lifecycleProcesses);\n+        if (getConfig().findNode(GreengrassService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC,\n+                Lifecycle.LIFECYCLE_RECOVER_NAMESPACE_TOPIC) == null) {\n+            // No recovery step defined in lifecycle\n+            return;\n+        }\n+\n+        Integer timeout = Coerce.toInt(getConfig().findOrDefault(Lifecycle.DEFAULT_ERROR_RECOVERY_HANDLER_TIMEOUT_SEC,\n+                GreengrassService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC, Lifecycle.LIFECYCLE_RECOVER_NAMESPACE_TOPIC,\n+                Lifecycle.TIMEOUT_NAMESPACE_TOPIC));\n+\n+        CountDownLatch handlerExecutionCdl = new CountDownLatch(1);\n+        run(Lifecycle.LIFECYCLE_RECOVER_NAMESPACE_TOPIC, c -> handlerExecutionCdl.countDown(), lifecycleProcesses);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba63dc04000c08aa632938eccf3a2cc43fbc5444"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDQwMDIy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#pullrequestreview-543040022", "createdAt": "2020-12-02T16:53:55Z", "commit": {"oid": "ba63dc04000c08aa632938eccf3a2cc43fbc5444"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d801f46e9821157c1a37f0eeb99013110a6f6675", "author": {"user": {"login": "shaguptashaikh", "name": "Shagupta Shaikh"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d801f46e9821157c1a37f0eeb99013110a6f6675", "committedDate": "2020-12-02T16:56:36Z", "message": "Merge branch 'master' into recovery-timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDc0NzQ0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/744#pullrequestreview-543074744", "createdAt": "2020-12-02T17:30:34Z", "commit": {"oid": "d801f46e9821157c1a37f0eeb99013110a6f6675"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2513, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}