{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0ODc2MzQx", "number": 228, "title": "Clear previous ERROR count when the last ERROR happened more than 1 h\u2026", "bodyText": "Issue #, if available:\nP34758454\nDescription of changes:\nAvoid setting service to \"BROKEN\" due to transient errors.\nWhy is this change necessary:\nHow was this change tested:\nUnit tests\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-07T19:27:15Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228", "merged": true, "mergeCommit": {"oid": "f2c427a61d43e8f3c52165ef8a38f027c49cfc30"}, "closed": true, "closedAt": "2020-05-12T21:03:47Z", "author": {"login": "fufranci"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfCRJAAH2gAyNDE0ODc2MzQxOjc4YmM4MWIzMTk0NjA5YTYyOTJmYTU2MGMzMWEyMGZjMjJkMjFlMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgqw2rAFqTQxMDQxODgyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "78bc81b3194609a6292fa560c31a20fc22d21e35", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/78bc81b3194609a6292fa560c31a20fc22d21e35", "committedDate": "2020-05-07T19:16:16Z", "message": "Clear previous ERROR count when the last ERROR happened more than 1 hr ago"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3ODc3NzY3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#pullrequestreview-407877767", "createdAt": "2020-05-07T22:21:34Z", "commit": {"oid": "78bc81b3194609a6292fa560c31a20fc22d21e35"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMjoyMTozNFrOGSSW9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMjoyMjowMlrOGSSXqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyODM0Mw==", "bodyText": "This needs a better name. Perhaps ERROR_RESET_TIME?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#discussion_r421828343", "createdAt": "2020-05-07T22:21:34Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -96,7 +98,9 @@\n     private static final Map<State, Collection<State>> ALLOWED_STATE_TRANSITION_FOR_REPORTING = new HashMap<>();\n     // The number of continual occurrences from a state to ERRORED.\n     // This is not thread safe and should only be used inside reportState().\n-    private final Map<State, Integer> stateToErroredCount = new HashMap<>();\n+    private final Map<State, List<Long>> stateToErroredCount = new HashMap<>();\n+    private static final long THRESHOLD = Duration.ofHours(1).toMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78bc81b3194609a6292fa560c31a20fc22d21e35"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTgyODUyMA==", "bodyText": "you can replace this with an injectable Clock from the Context.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#discussion_r421828520", "createdAt": "2020-05-07T22:22:02Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -158,13 +162,26 @@ private synchronized void internalReportState(State newState) {\n \n         if (State.ERRORED.equals(newState) && STATES_TO_ERRORED.contains(currentState)) {\n             // If the reported state is ERRORED, we'll increase the ERROR counter for the current state.\n-            stateToErroredCount.compute(currentState, (k, v) -> (v == null) ? 1 : v + 1);\n+            stateToErroredCount.compute(currentState, (k, v) -> {\n+                if (v == null) {\n+                    v = new ArrayList<>();\n+                }\n+\n+                final long now = System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78bc81b3194609a6292fa560c31a20fc22d21e35"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c4df689b86fca9b7e20f62b55a0b22e2760a979", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4c4df689b86fca9b7e20f62b55a0b22e2760a979", "committedDate": "2020-05-08T05:38:44Z", "message": "Added one unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c6bbdb40efe6720a970982b86a0434753f9f47a", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0c6bbdb40efe6720a970982b86a0434753f9f47a", "committedDate": "2020-05-08T18:33:59Z", "message": "Use a Clock in the context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0821618fcb02306403dd81fee9687a7e90b1b521", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0821618fcb02306403dd81fee9687a7e90b1b521", "committedDate": "2020-05-08T18:56:25Z", "message": "add another unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d494525b16d966382bebcb42df42ac9e33caeaed", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/d494525b16d966382bebcb42df42ac9e33caeaed", "committedDate": "2020-05-08T20:25:17Z", "message": "small clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbd928b676e25c7506f1f2b803d8f05f6f6ba5e3", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bbd928b676e25c7506f1f2b803d8f05f6f6ba5e3", "committedDate": "2020-05-08T23:30:06Z", "message": "get error reset time from service config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82bd80103a15086eedd269dcd3ca73938234c504", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/82bd80103a15086eedd269dcd3ca73938234c504", "committedDate": "2020-05-08T23:32:04Z", "message": "Merge remote-tracking branch 'origin/master' into broken_state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4ODgzNDA0", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#pullrequestreview-408883404", "createdAt": "2020-05-11T06:11:26Z", "commit": {"oid": "82bd80103a15086eedd269dcd3ca73938234c504"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNjoxMToyNlrOGTN1Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNjoxMToyNlrOGTN1Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwMjcyNw==", "bodyText": "I don't think that errorResetTime should be under run, it should be a top level value like run is because run is actually optional.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#discussion_r422802727", "createdAt": "2020-05-11T06:11:26Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/Lifecycle.java", "diffHunk": "@@ -730,9 +750,13 @@ final void requestStop() {\n     }\n \n     private Integer getTimeoutConfigValue(String nameSpace, Integer defaultValue) {\n-        Topic timeoutTopic = evergreenService.getConfig()\n-                .find(EvergreenService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC, nameSpace,\n-                        TIMEOUT_NAMESPACE_TOPIC);\n-        return timeoutTopic == null ? defaultValue : (Integer) timeoutTopic.getOnce();\n+        return Coerce.toInt(evergreenService.getConfig().findOrDefault(defaultValue,\n+                EvergreenService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC, nameSpace, TIMEOUT_NAMESPACE_TOPIC));\n+    }\n+\n+    private int getErrorResetTime() {\n+        return Coerce.toInt(evergreenService.getConfig().findOrDefault(DEFAULT_ERROR_RESET_TIME_IN_SEC,\n+                EvergreenService.SERVICE_LIFECYCLE_NAMESPACE_TOPIC, LIFECYCLE_RUN_NAMESPACE_TOPIC,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82bd80103a15086eedd269dcd3ca73938234c504"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4ODg0NjQz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#pullrequestreview-408884643", "createdAt": "2020-05-11T06:14:20Z", "commit": {"oid": "82bd80103a15086eedd269dcd3ca73938234c504"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNjoxNDoyMFrOGTN5gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNjoxNDoyMFrOGTN5gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwMzg0MQ==", "bodyText": "Pretty sure we already have a test for this, but this is ok too.\nPlease, never sleep in tests. If the countdownlatch unlocks, then your state should be done. If it isn't then you can use the hamcrest eventually matcher to validate that the state is what you expect eventually.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#discussion_r422803841", "createdAt": "2020-05-11T06:14:20Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/kernel/LifecycleTest.java", "diffHunk": "@@ -325,6 +330,109 @@ void GIVEN_a_service_WHEN_reportState_THEN_all_state_changes_are_notified() thro\n         assertEquals(1, errorReported.get());\n     }\n \n+    @Test\n+    void GIVEN_state_running_WHEN_errored_3_times_THEN_broken() throws InterruptedException {\n+        lifecycle = new Lifecycle(evergreenService, logger);\n+        initLifecycleState(lifecycle, State.NEW);\n+\n+        CountDownLatch reachedRunning1 = new CountDownLatch(1);\n+        CountDownLatch reachedRunning2 = new CountDownLatch(1);\n+        CountDownLatch reachedRunning3 = new CountDownLatch(1);\n+        Mockito.doAnswer(mock -> {\n+            lifecycle.reportState(State.RUNNING);\n+            reachedRunning1.countDown();\n+            return null;\n+        }).doAnswer(mock -> {\n+            lifecycle.reportState(State.RUNNING);\n+            reachedRunning2.countDown();\n+            return null;\n+        }).doAnswer(mock -> {\n+            lifecycle.reportState(State.RUNNING);\n+            reachedRunning3.countDown();\n+            return null;\n+        }).when(evergreenService).startup();\n+\n+        lifecycle.initLifecycleThread();\n+        lifecycle.requestStart();\n+        assertTrue(reachedRunning1.await(5, TimeUnit.SECONDS));\n+        Thread.sleep(1000); // Lifecycle thread needs some time to process the state transition", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82bd80103a15086eedd269dcd3ca73938234c504"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cda17311a8f46733cfcb8175ba4bd9a44b439db", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7cda17311a8f46733cfcb8175ba4bd9a44b439db", "committedDate": "2020-05-11T14:26:48Z", "message": "address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23c2c217e136396ed9d55f7dec8a8d38a431186e", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/23c2c217e136396ed9d55f7dec8a8d38a431186e", "committedDate": "2020-05-11T14:26:58Z", "message": "Merge remote-tracking branch 'origin/master' into broken_state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MzE5NzI4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#pullrequestreview-409319728", "createdAt": "2020-05-11T16:10:57Z", "commit": {"oid": "23c2c217e136396ed9d55f7dec8a8d38a431186e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "763071880e8d4778af30c4f84f518bd1f233ee45", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/763071880e8d4778af30c4f84f518bd1f233ee45", "committedDate": "2020-05-11T21:13:19Z", "message": "increase await timeout to deduce flakiness"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTM3MDQ4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#pullrequestreview-409537048", "createdAt": "2020-05-11T21:16:13Z", "commit": {"oid": "763071880e8d4778af30c4f84f518bd1f233ee45"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTQyNjI4", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#pullrequestreview-409542628", "createdAt": "2020-05-11T21:25:23Z", "commit": {"oid": "763071880e8d4778af30c4f84f518bd1f233ee45"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51a0ce3efe90e7d38a49856aa55cf1336397c55f", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/51a0ce3efe90e7d38a49856aa55cf1336397c55f", "committedDate": "2020-05-12T05:36:35Z", "message": "Merge branch 'master' into broken_state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f59101daa6e758d7cb3591523aec1d6a452e570", "author": {"user": {"login": "fufranci", "name": "Francis Fu"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2f59101daa6e758d7cb3591523aec1d6a452e570", "committedDate": "2020-05-12T06:17:19Z", "message": "remove more sleep by using eventuallyEval"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMTc4NTMw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#pullrequestreview-410178530", "createdAt": "2020-05-12T15:46:21Z", "commit": {"oid": "2f59101daa6e758d7cb3591523aec1d6a452e570"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7086190061662e8024e007087f9f798f05f52399", "author": {"user": {"login": "MikeDombo", "name": "Michael Dombrowski"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7086190061662e8024e007087f9f798f05f52399", "committedDate": "2020-05-12T20:22:15Z", "message": "Merge branch 'master' into broken_state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDE4ODI1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/228#pullrequestreview-410418825", "createdAt": "2020-05-12T21:01:02Z", "commit": {"oid": "7086190061662e8024e007087f9f798f05f52399"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2182, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}