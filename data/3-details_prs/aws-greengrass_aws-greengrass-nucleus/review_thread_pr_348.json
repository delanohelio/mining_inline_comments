{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNDU5MzAw", "number": 348, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDozMTozOVrOEUzUbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTo0MzozNFrOEVLa-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMjQ3Nzg5OnYy", "diffSide": "LEFT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDozMTozOVrOG7M_Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMToyMjo0MVrOG7NyOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMTk5OA==", "bodyText": "Why remove this? Isn't this basically the whole point of the test?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464731998", "createdAt": "2020-08-04T00:31:39Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -408,29 +406,13 @@ void GIVEN_kernel_running_services_WHEN_merge_removes_service_THEN_removed_servi\n         lifecycle.put(LIFECYCLE_RUN_NAMESPACE_TOPIC,\n                 ((String) lifecycle.get(LIFECYCLE_RUN_NAMESPACE_TOPIC)).replace(\"5\", \"10\"));\n \n+        Future<DeploymentResult> deploymentFuture = deploymentConfigMerger.mergeInNewConfig(testDeploymentDocument(), currentConfig);\n \n-        deploymentConfigMerger.mergeInNewConfig(testDeploymentDocument(), currentConfig);\n-        AtomicBoolean isSleeperAClosed = new AtomicBoolean(false);\n-        CountDownLatch mainRestarted = new CountDownLatch(1);\n-        kernel.getContext().addGlobalStateChangeListener((service, oldState, newState) -> {\n-            if (\"sleeperA\".equals(service.getName()) && newState.isClosable()) {\n-                isSleeperAClosed.set(true);\n-            }\n-            if(isSleeperAClosed.get() && \"main\".equals(service.getName()) && newState.equals(State.RUNNING)){\n-                mainRestarted.countDown();\n-            }\n-        });\n-\n-        // wait for merge to complete\n-        //TODO: wait on the future returned by mergeInNewConfig. mainRestarted is required due to race condition\n-        // mentioned in DeploymentConfigMergerL120 is fixed.\n-        mainRestarted.await(30, TimeUnit.SECONDS);\n+        deploymentFuture.get(30, TimeUnit.SECONDS);\n         EvergreenService main = kernel.locate(\"main\");\n         assertEquals(State.RUNNING, main.getState());\n         EvergreenService sleeperB = kernel.locate(\"sleeperB\");\n         assertEquals(State.RUNNING, sleeperB.getState());\n-        //sleeperA should be closed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0NTAxOA==", "bodyText": "The test verifies if the service topic name is removed, if the service failed to close that will be present.  Added check to verify deployment status.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464745018", "createdAt": "2020-08-04T01:22:41Z", "author": {"login": "fahadmohammed01"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -408,29 +406,13 @@ void GIVEN_kernel_running_services_WHEN_merge_removes_service_THEN_removed_servi\n         lifecycle.put(LIFECYCLE_RUN_NAMESPACE_TOPIC,\n                 ((String) lifecycle.get(LIFECYCLE_RUN_NAMESPACE_TOPIC)).replace(\"5\", \"10\"));\n \n+        Future<DeploymentResult> deploymentFuture = deploymentConfigMerger.mergeInNewConfig(testDeploymentDocument(), currentConfig);\n \n-        deploymentConfigMerger.mergeInNewConfig(testDeploymentDocument(), currentConfig);\n-        AtomicBoolean isSleeperAClosed = new AtomicBoolean(false);\n-        CountDownLatch mainRestarted = new CountDownLatch(1);\n-        kernel.getContext().addGlobalStateChangeListener((service, oldState, newState) -> {\n-            if (\"sleeperA\".equals(service.getName()) && newState.isClosable()) {\n-                isSleeperAClosed.set(true);\n-            }\n-            if(isSleeperAClosed.get() && \"main\".equals(service.getName()) && newState.equals(State.RUNNING)){\n-                mainRestarted.countDown();\n-            }\n-        });\n-\n-        // wait for merge to complete\n-        //TODO: wait on the future returned by mergeInNewConfig. mainRestarted is required due to race condition\n-        // mentioned in DeploymentConfigMergerL120 is fixed.\n-        mainRestarted.await(30, TimeUnit.SECONDS);\n+        deploymentFuture.get(30, TimeUnit.SECONDS);\n         EvergreenService main = kernel.locate(\"main\");\n         assertEquals(State.RUNNING, main.getState());\n         EvergreenService sleeperB = kernel.locate(\"sleeperB\");\n         assertEquals(State.RUNNING, sleeperB.getState());\n-        //sleeperA should be closed", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMTk5OA=="}, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 154}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMjQ3OTkzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDozMjo0NVrOG7NAhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMToyMTowN1rOG7Nwgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMjI5NA==", "bodyText": "Should the fix be to move that off of the publish thread?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464732294", "createdAt": "2020-08-04T00:32:45Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -64,9 +65,14 @@\n         CompletableFuture<DeploymentResult> totallyCompleteFuture = new CompletableFuture<>();\n \n         if (DeploymentSafetyPolicy.CHECK_SAFETY.equals(deploymentDocument.getDeploymentSafetyPolicy())) {\n-            kernel.getContext().get(UpdateSystemSafelyService.class)\n-                    .addUpdateAction(deploymentDocument.getDeploymentId(),\n-                            () -> updateActionForDeployment(newConfig, deploymentDocument, totallyCompleteFuture));\n+            UpdateSystemSafelyService updateService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            // running updateActionForDeployment in a separate thread so runOnPublishQueueAndWait would wait.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0NDA0Mw==", "bodyText": "I am not sure why UpdateSystemSafelyService is run on the publish queue? Do you have more context on this?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464744043", "createdAt": "2020-08-04T01:19:04Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -64,9 +65,14 @@\n         CompletableFuture<DeploymentResult> totallyCompleteFuture = new CompletableFuture<>();\n \n         if (DeploymentSafetyPolicy.CHECK_SAFETY.equals(deploymentDocument.getDeploymentSafetyPolicy())) {\n-            kernel.getContext().get(UpdateSystemSafelyService.class)\n-                    .addUpdateAction(deploymentDocument.getDeploymentId(),\n-                            () -> updateActionForDeployment(newConfig, deploymentDocument, totallyCompleteFuture));\n+            UpdateSystemSafelyService updateService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            // running updateActionForDeployment in a separate thread so runOnPublishQueueAndWait would wait.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMjI5NA=="}, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0NDU3OQ==", "bodyText": "The idea was that the entire update would be run on the publish thread, but since we're actually having trouble with that now, maybe it should just be changed.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464744579", "createdAt": "2020-08-04T01:21:07Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -64,9 +65,14 @@\n         CompletableFuture<DeploymentResult> totallyCompleteFuture = new CompletableFuture<>();\n \n         if (DeploymentSafetyPolicy.CHECK_SAFETY.equals(deploymentDocument.getDeploymentSafetyPolicy())) {\n-            kernel.getContext().get(UpdateSystemSafelyService.class)\n-                    .addUpdateAction(deploymentDocument.getDeploymentId(),\n-                            () -> updateActionForDeployment(newConfig, deploymentDocument, totallyCompleteFuture));\n+            UpdateSystemSafelyService updateService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            // running updateActionForDeployment in a separate thread so runOnPublishQueueAndWait would wait.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMjI5NA=="}, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMjQ4MDk4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDozMzozMFrOG7NBMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMToyMzowN1rOG7NyqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMjQ2Ng==", "bodyText": "Interesting find. What is the result of not having this change?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464732466", "createdAt": "2020-08-04T00:33:30Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -316,8 +316,12 @@ public void disruptionCompleted() {\n     @SuppressWarnings(\"PMD.AvoidCatchingGenericException\")\n     public final CompletableFuture<Void> close() {\n         CompletableFuture<Void> closeFuture = new CompletableFuture<>();\n+\n         context.get(Executor.class).execute(() -> {\n             logger.atInfo(\"service-close\").log(\"Service is now closing\");\n+            // removing listeners on dependencies\n+            dependencies.forEach((service, dependencyInfo) ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0NDA2OQ==", "bodyText": "Nothing much, the service shutting down will restart when waiting for dependers to exit, if one of its dependencies got updated. Since the lifecycle thread exits, the shutdown service will not be able to restart when the StateSubscriber  triggers.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464744069", "createdAt": "2020-08-04T01:19:11Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -316,8 +316,12 @@ public void disruptionCompleted() {\n     @SuppressWarnings(\"PMD.AvoidCatchingGenericException\")\n     public final CompletableFuture<Void> close() {\n         CompletableFuture<Void> closeFuture = new CompletableFuture<>();\n+\n         context.get(Executor.class).execute(() -> {\n             logger.atInfo(\"service-close\").log(\"Service is now closing\");\n+            // removing listeners on dependencies\n+            dependencies.forEach((service, dependencyInfo) ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMjQ2Ng=="}, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0NTEyOA==", "bodyText": "Seems like this might fix some other flakiness, so this is good.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464745128", "createdAt": "2020-08-04T01:23:07Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -316,8 +316,12 @@ public void disruptionCompleted() {\n     @SuppressWarnings(\"PMD.AvoidCatchingGenericException\")\n     public final CompletableFuture<Void> close() {\n         CompletableFuture<Void> closeFuture = new CompletableFuture<>();\n+\n         context.get(Executor.class).execute(() -> {\n             logger.atInfo(\"service-close\").log(\"Service is now closing\");\n+            // removing listeners on dependencies\n+            dependencies.forEach((service, dependencyInfo) ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDczMjQ2Ng=="}, "originalCommit": {"oid": "4502e17f3300d1a84598f93144a2f622e55a3d92"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMjk3MTg2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNToxODo1NFrOG7RdNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxODowMzozMFrOG7rj_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgwNTE3NQ==", "bodyText": "Will this still work as expected https://github.com/aws/aws-greengrass-kernel/blob/master/src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java#L80 ? I'm not sure how important this is though, i.e. whether we need to notify services that they can resume normal work", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464805175", "createdAt": "2020-08-04T05:18:54Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -64,9 +65,14 @@\n         CompletableFuture<DeploymentResult> totallyCompleteFuture = new CompletableFuture<>();\n \n         if (DeploymentSafetyPolicy.CHECK_SAFETY.equals(deploymentDocument.getDeploymentSafetyPolicy())) {\n-            kernel.getContext().get(UpdateSystemSafelyService.class)\n-                    .addUpdateAction(deploymentDocument.getDeploymentId(),\n-                            () -> updateActionForDeployment(newConfig, deploymentDocument, totallyCompleteFuture));\n+            UpdateSystemSafelyService updateService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            // running updateActionForDeployment in a separate thread so runOnPublishQueueAndWait would wait.\n+            // addUpdateAction is run on publish queue thread and when executing on publish queue thread\n+            // runOnPublishQueueAndWait does not wait.\n+            updateService.addUpdateAction(deploymentDocument.getDeploymentId(), () ->\n+                    kernel.getContext().get(Executor.class).execute(() ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53731edcee9a988c57d3f8adaa976c964744985f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgxNjU1Mw==", "bodyText": "No, that wouldn't work at all because the update task would complete almost immediately. I think we may want to change the update service implementation to not run on the publish queue.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r464816553", "createdAt": "2020-08-04T05:57:09Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -64,9 +65,14 @@\n         CompletableFuture<DeploymentResult> totallyCompleteFuture = new CompletableFuture<>();\n \n         if (DeploymentSafetyPolicy.CHECK_SAFETY.equals(deploymentDocument.getDeploymentSafetyPolicy())) {\n-            kernel.getContext().get(UpdateSystemSafelyService.class)\n-                    .addUpdateAction(deploymentDocument.getDeploymentId(),\n-                            () -> updateActionForDeployment(newConfig, deploymentDocument, totallyCompleteFuture));\n+            UpdateSystemSafelyService updateService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            // running updateActionForDeployment in a separate thread so runOnPublishQueueAndWait would wait.\n+            // addUpdateAction is run on publish queue thread and when executing on publish queue thread\n+            // runOnPublishQueueAndWait does not wait.\n+            updateService.addUpdateAction(deploymentDocument.getDeploymentId(), () ->\n+                    kernel.getContext().get(Executor.class).execute(() ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgwNTE3NQ=="}, "originalCommit": {"oid": "53731edcee9a988c57d3f8adaa976c964744985f"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTIzMjg5Mw==", "bodyText": "Approving since this will help with intermittent workflow failures, but we need to follow up on if we need to notify services when deployments have finished, and if so, how we can achieve that", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465232893", "createdAt": "2020-08-04T18:03:30Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentConfigMerger.java", "diffHunk": "@@ -64,9 +65,14 @@\n         CompletableFuture<DeploymentResult> totallyCompleteFuture = new CompletableFuture<>();\n \n         if (DeploymentSafetyPolicy.CHECK_SAFETY.equals(deploymentDocument.getDeploymentSafetyPolicy())) {\n-            kernel.getContext().get(UpdateSystemSafelyService.class)\n-                    .addUpdateAction(deploymentDocument.getDeploymentId(),\n-                            () -> updateActionForDeployment(newConfig, deploymentDocument, totallyCompleteFuture));\n+            UpdateSystemSafelyService updateService = kernel.getContext().get(UpdateSystemSafelyService.class);\n+            // running updateActionForDeployment in a separate thread so runOnPublishQueueAndWait would wait.\n+            // addUpdateAction is run on publish queue thread and when executing on publish queue thread\n+            // runOnPublishQueueAndWait does not wait.\n+            updateService.addUpdateAction(deploymentDocument.getDeploymentId(), () ->\n+                    kernel.getContext().get(Executor.class).execute(() ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgwNTE3NQ=="}, "originalCommit": {"oid": "53731edcee9a988c57d3f8adaa976c964744985f"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjIyOTYzOnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDozODoyNVrOG7wpPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDo0OTo1NlrOG7xAOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjE1OQ==", "bodyText": "why not assertEquals? I've never used same, though I'd assume they're the same.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465316159", "createdAt": "2020-08-04T20:38:25Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -471,10 +472,13 @@ void GIVEN_a_running_service_is_not_disruptable_WHEN_deployed_THEN_deployment_wa\n                     \"Merge should not happen within 2 seconds\");\n             assertTrue(unsafeToUpdate.get(), \"Service should have been checked if it is safe to update immediately\");\n             assertFalse(safeToUpdate.get(), \"Service should not yet be safe to update\");\n+            assertSame(sawUpdatesCompleted.getCount(), 1l,\n+                    \"Service should not call update done yet\");\n \n-            future.get(20, TimeUnit.SECONDS);\n+            sawUpdatesCompleted.await(30, TimeUnit.SECONDS);\n             assertTrue(safeToUpdate.get(), \"Service should have been rechecked and be safe to update\");\n-            assertTrue(sawUpdatesCompleted.get(), \"Service should have been called when the update was done\");\n+            assertSame(sawUpdatesCompleted.getCount(), 0l,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMjA0Mg==", "bodyText": "same is == while equals uses .equals(). Does not matter much here. Updated", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465322042", "createdAt": "2020-08-04T20:49:56Z", "author": {"login": "fahadmohammed01"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -471,10 +472,13 @@ void GIVEN_a_running_service_is_not_disruptable_WHEN_deployed_THEN_deployment_wa\n                     \"Merge should not happen within 2 seconds\");\n             assertTrue(unsafeToUpdate.get(), \"Service should have been checked if it is safe to update immediately\");\n             assertFalse(safeToUpdate.get(), \"Service should not yet be safe to update\");\n+            assertSame(sawUpdatesCompleted.getCount(), 1l,\n+                    \"Service should not call update done yet\");\n \n-            future.get(20, TimeUnit.SECONDS);\n+            sawUpdatesCompleted.await(30, TimeUnit.SECONDS);\n             assertTrue(safeToUpdate.get(), \"Service should have been rechecked and be safe to update\");\n-            assertTrue(sawUpdatesCompleted.get(), \"Service should have been called when the update was done\");\n+            assertSame(sawUpdatesCompleted.getCount(), 0l,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjE1OQ=="}, "originalCommit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjIzMDI2OnYy", "diffSide": "RIGHT", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDozODozOFrOG7wprg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDo0NzowM1rOG7w6yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjI3MA==", "bodyText": "you can just assert true here instead of on L480", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465316270", "createdAt": "2020-08-04T20:38:38Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -471,10 +472,13 @@ void GIVEN_a_running_service_is_not_disruptable_WHEN_deployed_THEN_deployment_wa\n                     \"Merge should not happen within 2 seconds\");\n             assertTrue(unsafeToUpdate.get(), \"Service should have been checked if it is safe to update immediately\");\n             assertFalse(safeToUpdate.get(), \"Service should not yet be safe to update\");\n+            assertSame(sawUpdatesCompleted.getCount(), 1l,\n+                    \"Service should not call update done yet\");\n \n-            future.get(20, TimeUnit.SECONDS);\n+            sawUpdatesCompleted.await(30, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMDY1MQ==", "bodyText": "updated", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465320651", "createdAt": "2020-08-04T20:47:03Z", "author": {"login": "fahadmohammed01"}, "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentConfigMergingTest.java", "diffHunk": "@@ -471,10 +472,13 @@ void GIVEN_a_running_service_is_not_disruptable_WHEN_deployed_THEN_deployment_wa\n                     \"Merge should not happen within 2 seconds\");\n             assertTrue(unsafeToUpdate.get(), \"Service should have been checked if it is safe to update immediately\");\n             assertFalse(safeToUpdate.get(), \"Service should not yet be safe to update\");\n+            assertSame(sawUpdatesCompleted.getCount(), 1l,\n+                    \"Service should not call update done yet\");\n \n-            future.get(20, TimeUnit.SECONDS);\n+            sawUpdatesCompleted.await(30, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjI3MA=="}, "originalCommit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjIzMTk0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDozOToxMVrOG7wqvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDo0NzowOFrOG7w65Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjU0Mw==", "bodyText": "this doesn't log anything. You need to have .log()", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465316543", "createdAt": "2020-08-04T20:39:11Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -139,11 +141,15 @@ protected void startup() throws InterruptedException {\n                 Thread.sleep(maxt - now);\n             } else {\n                 logger.atDebug().setEventType(\"service-update-scheduled\").log();\n-                context.runOnPublishQueueAndWait(() -> {\n-                    logger.atInfo().setEventType(\"service-update-start\").log();\n-                    runUpdateActions();\n-                    logger.atInfo().setEventType(\"service-update-finish\").log();\n-                });\n+                try {\n+                    kernel.getContext().get(ExecutorService.class).submit(() -> {\n+                        logger.atInfo().setEventType(\"service-update-start\").log();\n+                        runUpdateActions();\n+                        logger.atInfo().setEventType(\"service-update-finish\").log();\n+                    }).get();\n+                } catch (InterruptedException | ExecutionException e) {\n+                    logger.atError(\"Run update actions was interrupted\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNzA4OA==", "bodyText": "and atError is (<event type>, <exception>)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465317088", "createdAt": "2020-08-04T20:40:18Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -139,11 +141,15 @@ protected void startup() throws InterruptedException {\n                 Thread.sleep(maxt - now);\n             } else {\n                 logger.atDebug().setEventType(\"service-update-scheduled\").log();\n-                context.runOnPublishQueueAndWait(() -> {\n-                    logger.atInfo().setEventType(\"service-update-start\").log();\n-                    runUpdateActions();\n-                    logger.atInfo().setEventType(\"service-update-finish\").log();\n-                });\n+                try {\n+                    kernel.getContext().get(ExecutorService.class).submit(() -> {\n+                        logger.atInfo().setEventType(\"service-update-start\").log();\n+                        runUpdateActions();\n+                        logger.atInfo().setEventType(\"service-update-finish\").log();\n+                    }).get();\n+                } catch (InterruptedException | ExecutionException e) {\n+                    logger.atError(\"Run update actions was interrupted\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjU0Mw=="}, "originalCommit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMDY3Nw==", "bodyText": "updated", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465320677", "createdAt": "2020-08-04T20:47:08Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -139,11 +141,15 @@ protected void startup() throws InterruptedException {\n                 Thread.sleep(maxt - now);\n             } else {\n                 logger.atDebug().setEventType(\"service-update-scheduled\").log();\n-                context.runOnPublishQueueAndWait(() -> {\n-                    logger.atInfo().setEventType(\"service-update-start\").log();\n-                    runUpdateActions();\n-                    logger.atInfo().setEventType(\"service-update-finish\").log();\n-                });\n+                try {\n+                    kernel.getContext().get(ExecutorService.class).submit(() -> {\n+                        logger.atInfo().setEventType(\"service-update-start\").log();\n+                        runUpdateActions();\n+                        logger.atInfo().setEventType(\"service-update-finish\").log();\n+                    }).get();\n+                } catch (InterruptedException | ExecutionException e) {\n+                    logger.atError(\"Run update actions was interrupted\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxNjU0Mw=="}, "originalCommit": {"oid": "e7c04475fd50f1c48d3c90795f95de07fdc64c31"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjMxNjUzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTowNTo0NlrOG7xfoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTowNTo0NlrOG7xfoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzMDA4MQ==", "bodyText": "[nit]\nJust use context instead of kernel.getContext()", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465330081", "createdAt": "2020-08-04T21:05:46Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -139,11 +141,16 @@ protected void startup() throws InterruptedException {\n                 Thread.sleep(maxt - now);\n             } else {\n                 logger.atDebug().setEventType(\"service-update-scheduled\").log();\n-                context.runOnPublishQueueAndWait(() -> {\n-                    logger.atInfo().setEventType(\"service-update-start\").log();\n-                    runUpdateActions();\n-                    logger.atInfo().setEventType(\"service-update-finish\").log();\n-                });\n+                try {\n+                    kernel.getContext().get(ExecutorService.class).submit(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0fb8ed09b97df5e034fd80602a8f2ff44127bd7"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNjQyNjgzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTo0MzozNFrOG7yjCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTo0MzozNFrOG7yjCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0NzMzNw==", "bodyText": "don't catch the interruption, let it bubble up because it means that we need to stop", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/348#discussion_r465347337", "createdAt": "2020-08-04T21:43:34Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/UpdateSystemSafelyService.java", "diffHunk": "@@ -139,11 +141,16 @@ protected void startup() throws InterruptedException {\n                 Thread.sleep(maxt - now);\n             } else {\n                 logger.atDebug().setEventType(\"service-update-scheduled\").log();\n-                context.runOnPublishQueueAndWait(() -> {\n-                    logger.atInfo().setEventType(\"service-update-start\").log();\n-                    runUpdateActions();\n-                    logger.atInfo().setEventType(\"service-update-finish\").log();\n-                });\n+                try {\n+                    kernel.getContext().get(ExecutorService.class).submit(() -> {\n+                        logger.atInfo().setEventType(\"service-update-start\").log();\n+                        runUpdateActions();\n+                        logger.atInfo().setEventType(\"service-update-finish\").log();\n+                    }).get();\n+                } catch (InterruptedException | ExecutionException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0fb8ed09b97df5e034fd80602a8f2ff44127bd7"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4508, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}