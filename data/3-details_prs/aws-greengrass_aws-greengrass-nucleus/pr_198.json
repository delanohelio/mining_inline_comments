{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NzY0Mjc3", "number": 198, "title": "Add support for retrying jobs on retryable exceptions", "bodyText": "Description of changes:\nRefactor deployment service to retry a job when Deployment Task throws a Retryable Exception\nHow was this change tested:\nUpdated Unit test to include a scenario for retry, test also validates sequence of events for a retryable exception.\nFurther Work\nNeed a longer test that works with multiple jobs in flight to validate edge cases\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-04-21T16:25:05Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198", "merged": true, "mergeCommit": {"oid": "87b1ee8cc843891519eb77508fb9718718deff8b"}, "closed": true, "closedAt": "2020-04-24T00:09:51Z", "author": {"login": "chaurah"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZ2PJ-gBqjMyNTY4NDk2NTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcal9HGgFqTM5OTU1NjY2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "308ba7830a4ffc400b465d89ec50f581be18fef1", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/308ba7830a4ffc400b465d89ec50f581be18fef1", "committedDate": "2020-04-21T16:04:15Z", "message": "Add support for retrying jobs on retryable exceptions"}, "afterCommit": {"oid": "85205dd0d1dceca4226de605bdbcdd624dff1453", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/85205dd0d1dceca4226de605bdbcdd624dff1453", "committedDate": "2020-04-21T16:09:51Z", "message": "Add support for retrying jobs on retryable exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85205dd0d1dceca4226de605bdbcdd624dff1453", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/85205dd0d1dceca4226de605bdbcdd624dff1453", "committedDate": "2020-04-21T16:09:51Z", "message": "Add support for retrying jobs on retryable exceptions"}, "afterCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e19f6142218d313731436a7c0a03bd9addde42ee", "committedDate": "2020-04-21T16:22:12Z", "message": "Add support for retrying jobs on retryable exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTA1ODUy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#pullrequestreview-397505852", "createdAt": "2020-04-21T17:10:12Z", "commit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzoxMDoxMlrOGJPE2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzoxMDoyNlrOGJPFeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzNzM3MQ==", "bodyText": "Get rid of this. This is a unit test which should not need any sleeping.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412337371", "createdAt": "2020-04-21T17:10:12Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -182,6 +183,32 @@ public void GIVEN_deployment_job_WHEN_deployment_process_fails_THEN_report_faile\n             deploymentService.shutdown();\n         }\n \n+        @Test\n+        public void GIVEN_deployment_job_WHEN_deployment_process_fails_with_retry_THEN_retry_job(ExtensionContext context)\n+                throws Exception {\n+            CompletableFuture<Void> mockFutureWithException = new CompletableFuture<>();\n+            ignoreExceptionUltimateCauseOfType(context, RetryableDeploymentTaskFailureException.class);\n+            Throwable t = new RetryableDeploymentTaskFailureException(null);\n+            mockFutureWithException.completeExceptionally(t);\n+            when(mockExecutorService.submit(any(DeploymentTask.class))).thenReturn(mockFutureWithException, mockFuture);\n+            startDeploymentServiceInAnotherThread();\n+\n+            //Wait for the enough time after which deployment service would have processed the job from the queue\n+            Thread.sleep(Duration.ofSeconds(2).toMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzNzUzMA==", "bodyText": "Why atMost and not times?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412337530", "createdAt": "2020-04-21T17:10:26Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -182,6 +183,32 @@ public void GIVEN_deployment_job_WHEN_deployment_process_fails_THEN_report_faile\n             deploymentService.shutdown();\n         }\n \n+        @Test\n+        public void GIVEN_deployment_job_WHEN_deployment_process_fails_with_retry_THEN_retry_job(ExtensionContext context)\n+                throws Exception {\n+            CompletableFuture<Void> mockFutureWithException = new CompletableFuture<>();\n+            ignoreExceptionUltimateCauseOfType(context, RetryableDeploymentTaskFailureException.class);\n+            Throwable t = new RetryableDeploymentTaskFailureException(null);\n+            mockFutureWithException.completeExceptionally(t);\n+            when(mockExecutorService.submit(any(DeploymentTask.class))).thenReturn(mockFutureWithException, mockFuture);\n+            startDeploymentServiceInAnotherThread();\n+\n+            //Wait for the enough time after which deployment service would have processed the job from the queue\n+            Thread.sleep(Duration.ofSeconds(2).toMillis());\n+            // Expecting two invocations\n+            verify(mockExecutorService, atMost(2)).submit(any(DeploymentTask.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzExNDYw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#pullrequestreview-397711460", "createdAt": "2020-04-21T22:09:01Z", "commit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjowOTowMVrOGJakmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjoxODo1MlrOGJa2_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyNTcyMQ==", "bodyText": "Need to have a max times till when we will keep adding this to the queue. Also I don't think we need to add the QUEUED status to the config. The documentation at https://docs.aws.amazon.com/iot/latest/developerguide/jobs-api.html#mqtt-updatejobexecution mentions the update statuses from among (IN_PROGRESS, FAILED, SUCCEEDED, or REJECTED). I think keeping it IN_PROGRESS should be fine since thats the next thing we are going to process.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412525721", "createdAt": "2020-04-21T22:09:01Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -228,12 +230,14 @@ private void finishCurrentDeployment() throws InterruptedException {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n             if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                storeDeploymentStatusInConfig(currentJobId, JobStatus.QUEUED, statusDetails);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyODMwMQ==", "bodyText": "I think this is a big try block. Consider putting try-catch blocks around the specific calls. For example PackageVersionConflictException can be caught around the resolveDependencies call. SImilarly for other calls?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412528301", "createdAt": "2020-04-21T22:14:27Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -59,9 +60,16 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n                     newConfig).get();\n             logger.atInfo().setEventType(DEPLOYMENT_TASK_EVENT_TYPE)\n                     .addKeyValue(\"deploymentId\", deploymentDocument.getDeploymentId()).log(\"Finish deployment task\");\n-        // TODO: unwrap ExcutionException to see which one is retryable.\n-        } catch (PackageVersionConflictException | UnexpectedPackagingException | ExecutionException e) {\n+        } catch (PackageVersionConflictException | UnexpectedPackagingException e) {\n             throw new NonRetryableDeploymentTaskFailureException(e);\n+        } catch (ExecutionException e) {\n+            Throwable t = e.getCause();\n+            if (t instanceof PackagingException\n+                    || t instanceof InterruptedException\n+                    || t instanceof IOException) {\n+                throw new RetryableDeploymentTaskFailureException(t);\n+            }\n+            throw new NonRetryableDeploymentTaskFailureException(t);\n         } catch (InterruptedException | IOException | PackagingException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUzMDQzMA==", "bodyText": "We need to wait for the deployment service to start in another thread and reach a point where it processed the job.  There is no latches in the code to indicate that it reached certain execution point.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412530430", "createdAt": "2020-04-21T22:18:52Z", "author": {"login": "abanthiy"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -182,6 +183,32 @@ public void GIVEN_deployment_job_WHEN_deployment_process_fails_THEN_report_faile\n             deploymentService.shutdown();\n         }\n \n+        @Test\n+        public void GIVEN_deployment_job_WHEN_deployment_process_fails_with_retry_THEN_retry_job(ExtensionContext context)\n+                throws Exception {\n+            CompletableFuture<Void> mockFutureWithException = new CompletableFuture<>();\n+            ignoreExceptionUltimateCauseOfType(context, RetryableDeploymentTaskFailureException.class);\n+            Throwable t = new RetryableDeploymentTaskFailureException(null);\n+            mockFutureWithException.completeExceptionally(t);\n+            when(mockExecutorService.submit(any(DeploymentTask.class))).thenReturn(mockFutureWithException, mockFuture);\n+            startDeploymentServiceInAnotherThread();\n+\n+            //Wait for the enough time after which deployment service would have processed the job from the queue\n+            Thread.sleep(Duration.ofSeconds(2).toMillis());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzNzM3MQ=="}, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzI3Nzgy", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#pullrequestreview-397727782", "createdAt": "2020-04-21T22:45:38Z", "commit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo0NTozOFrOGJbmDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo0NTozOFrOGJbmDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0MjQ3OA==", "bodyText": "Can you rewind an \"INPROGRESS\" job to \"QUEUED\" ?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412542478", "createdAt": "2020-04-21T22:45:38Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -228,12 +230,14 @@ private void finishCurrentDeployment() throws InterruptedException {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n             if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                storeDeploymentStatusInConfig(currentJobId, JobStatus.QUEUED, statusDetails);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e19f6142218d313731436a7c0a03bd9addde42ee", "committedDate": "2020-04-21T16:22:12Z", "message": "Add support for retrying jobs on retryable exceptions"}, "afterCommit": {"oid": "5b9d79a5ec054874036dcf36228e5211547bded9", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b9d79a5ec054874036dcf36228e5211547bded9", "committedDate": "2020-04-22T16:14:50Z", "message": "Add support for retrying jobs on retryable exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b9d79a5ec054874036dcf36228e5211547bded9", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5b9d79a5ec054874036dcf36228e5211547bded9", "committedDate": "2020-04-22T16:14:50Z", "message": "Add support for retrying jobs on retryable exceptions"}, "afterCommit": {"oid": "f643b2e43617272f06608e61f99955e2c0c72c9c", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f643b2e43617272f06608e61f99955e2c0c72c9c", "committedDate": "2020-04-22T17:19:19Z", "message": "Add support for retrying jobs on retryable exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f643b2e43617272f06608e61f99955e2c0c72c9c", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f643b2e43617272f06608e61f99955e2c0c72c9c", "committedDate": "2020-04-22T17:19:19Z", "message": "Add support for retrying jobs on retryable exceptions"}, "afterCommit": {"oid": "33f1c8c8dc3e90ff3f3703a98aff78163779d77c", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/33f1c8c8dc3e90ff3f3703a98aff78163779d77c", "committedDate": "2020-04-22T17:23:21Z", "message": "Add support for retrying jobs on retryable exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33f1c8c8dc3e90ff3f3703a98aff78163779d77c", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/33f1c8c8dc3e90ff3f3703a98aff78163779d77c", "committedDate": "2020-04-22T17:23:21Z", "message": "Add support for retrying jobs on retryable exceptions"}, "afterCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/03605c0fb2b9e0aabb3db5a8c533372b918df64c", "committedDate": "2020-04-22T17:33:42Z", "message": "Add support for retrying jobs on retryable exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDM1MTI5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#pullrequestreview-398435129", "createdAt": "2020-04-22T17:51:10Z", "commit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1MToxMFrOGKDRZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1MToxMFrOGKDRZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MjU0OA==", "bodyText": "4 seconds is way too long for a unit test. All this stuff should be happening within milliseconds.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413192548", "createdAt": "2020-04-22T17:51:10Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -63,6 +65,7 @@\n     private static final String TEST_JOB_ID_1 = \"TEST_JOB_1\";\n     private static final String TEST_JOB_ID_2 = \"TEST_JOB_2\";\n     private static final String CONNECTION_ERROR = \"Connection error\";\n+    private static final VerificationWithTimeout WAIT_FOUR_SECONDS = timeout(Duration.ofSeconds(4).toMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NjE0MDI5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#pullrequestreview-398614029", "createdAt": "2020-04-22T21:47:33Z", "commit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMTo0NzozNFrOGKNP2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMjoyMzo1NFrOGKOU6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1NTk5Mw==", "bodyText": "Nothing else should be pushed between the new timestamp and the old timestamp since we are executing everything in single thread and also pushing deployment to the head of the deque. Timestamps are used for ordering the updates and in this case the order will not be affected.\nI see that we are updating the status details with the error information. Afaik right now there is no requirement to update the status of deployment every retry, and we do not mention in status details that we are retrying. It is also going to get overridden (in cloud) by the IN_PROGRESS update made on the new retry. I think we can skip this update and only update the status of the deployment when its final. What do you think?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413355993", "createdAt": "2020-04-22T21:47:34Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -219,21 +230,27 @@ private void connectToAWSIot() throws InterruptedException {\n     private void finishCurrentDeployment() throws InterruptedException {\n         logger.atInfo().kv(JOB_ID_LOG_KEY_NAME, currentJobId).log(\"Current deployment finished\");\n         try {\n-            //No timeout is set here. Detection of error is delegated to downstream components like\n+            // No timeout is set here. Detection of error is delegated to downstream components like\n             // dependency resolver, package downloader, kernel which will have more visibility\n             // if something is going wrong\n             currentProcessStatus.get();\n             storeDeploymentStatusInConfig(currentJobId, JobStatus.SUCCEEDED, new HashMap<>());\n+            currentJobAttemptCount.set(0);\n         } catch (ExecutionException e) {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n-            if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n+            if (t instanceof NonRetryableDeploymentTaskFailureException\n+                    || currentJobAttemptCount.get() >= DEPLOYMENT_MAX_ATTEMPTS) {\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+                currentJobAttemptCount.set(0);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                // Required to update timestamps", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM3MzY3Mg==", "bodyText": "Have you considered storing DeploymentTask into a class variable and then submitting that to the executor service as oppose to resubmitting the Deployment.\n\nIt saves the processing that needs to be done again when submitting the same Deployment\nIt will allow us to keep it as a Queue, as opposed to Deque. This is to preserve that deployments run in the order in which they are submitted.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413373672", "createdAt": "2020-04-22T22:23:54Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -219,21 +230,27 @@ private void connectToAWSIot() throws InterruptedException {\n     private void finishCurrentDeployment() throws InterruptedException {\n         logger.atInfo().kv(JOB_ID_LOG_KEY_NAME, currentJobId).log(\"Current deployment finished\");\n         try {\n-            //No timeout is set here. Detection of error is delegated to downstream components like\n+            // No timeout is set here. Detection of error is delegated to downstream components like\n             // dependency resolver, package downloader, kernel which will have more visibility\n             // if something is going wrong\n             currentProcessStatus.get();\n             storeDeploymentStatusInConfig(currentJobId, JobStatus.SUCCEEDED, new HashMap<>());\n+            currentJobAttemptCount.set(0);\n         } catch (ExecutionException e) {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n-            if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n+            if (t instanceof NonRetryableDeploymentTaskFailureException\n+                    || currentJobAttemptCount.get() >= DEPLOYMENT_MAX_ATTEMPTS) {\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+                currentJobAttemptCount.set(0);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                // Required to update timestamps\n+                storeDeploymentStatusInConfig(currentJobId, JobStatus.IN_PROGRESS, statusDetails);\n+                deploymentsQueue.addFirst(currentDeployment);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "originalPosition": 81}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/03605c0fb2b9e0aabb3db5a8c533372b918df64c", "committedDate": "2020-04-22T17:33:42Z", "message": "Add support for retrying jobs on retryable exceptions"}, "afterCommit": {"oid": "71a4c8970ada06f304a0bef487517000bd07477d", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/71a4c8970ada06f304a0bef487517000bd07477d", "committedDate": "2020-04-23T23:20:31Z", "message": "Add support for retrying jobs on retryable exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NTQ0NzAw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#pullrequestreview-399544700", "createdAt": "2020-04-23T23:26:59Z", "commit": {"oid": "71a4c8970ada06f304a0bef487517000bd07477d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMzoyNjo1OVrOGLAIfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMzoyNjo1OVrOGLAIfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4OTY5Mw==", "bodyText": "Change it back to Queue?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r414189693", "createdAt": "2020-04-23T23:26:59Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -88,7 +99,7 @@\n     private final AtomicBoolean retryConnectingToAWSIot = new AtomicBoolean(false);\n     @Setter\n     private long pollingFrequency = DEPLOYMENT_POLLING_FREQUENCY;\n-    private LinkedBlockingQueue<Deployment> deploymentsQueue = new LinkedBlockingQueue<>();\n+    private LinkedBlockingDeque<Deployment> deploymentsQueue = new LinkedBlockingDeque<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71a4c8970ada06f304a0bef487517000bd07477d"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b13e526751b0b1937f5fc491ef9adf968867611e", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b13e526751b0b1937f5fc491ef9adf968867611e", "committedDate": "2020-04-23T23:27:43Z", "message": "Add support for retrying jobs on retryable exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "71a4c8970ada06f304a0bef487517000bd07477d", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/71a4c8970ada06f304a0bef487517000bd07477d", "committedDate": "2020-04-23T23:20:31Z", "message": "Add support for retrying jobs on retryable exceptions"}, "afterCommit": {"oid": "b13e526751b0b1937f5fc491ef9adf968867611e", "author": {"user": {"login": "chaurah", "name": "Rahul Singh Chauhan"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b13e526751b0b1937f5fc491ef9adf968867611e", "committedDate": "2020-04-23T23:27:43Z", "message": "Add support for retrying jobs on retryable exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NTQ4MDQ3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#pullrequestreview-399548047", "createdAt": "2020-04-23T23:35:57Z", "commit": {"oid": "b13e526751b0b1937f5fc491ef9adf968867611e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NTU2NjYx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#pullrequestreview-399556661", "createdAt": "2020-04-24T00:01:21Z", "commit": {"oid": "b13e526751b0b1937f5fc491ef9adf968867611e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2142, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}