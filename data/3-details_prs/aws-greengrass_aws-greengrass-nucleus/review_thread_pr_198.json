{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NzY0Mjc3", "number": 198, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzoxMDoxMlrOD0VuRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMzoyNjo1OVrOD1hQlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjA4NDUzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzoxMDoxMlrOGJPE2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjoxODo1MlrOGJa2_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzNzM3MQ==", "bodyText": "Get rid of this. This is a unit test which should not need any sleeping.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412337371", "createdAt": "2020-04-21T17:10:12Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -182,6 +183,32 @@ public void GIVEN_deployment_job_WHEN_deployment_process_fails_THEN_report_faile\n             deploymentService.shutdown();\n         }\n \n+        @Test\n+        public void GIVEN_deployment_job_WHEN_deployment_process_fails_with_retry_THEN_retry_job(ExtensionContext context)\n+                throws Exception {\n+            CompletableFuture<Void> mockFutureWithException = new CompletableFuture<>();\n+            ignoreExceptionUltimateCauseOfType(context, RetryableDeploymentTaskFailureException.class);\n+            Throwable t = new RetryableDeploymentTaskFailureException(null);\n+            mockFutureWithException.completeExceptionally(t);\n+            when(mockExecutorService.submit(any(DeploymentTask.class))).thenReturn(mockFutureWithException, mockFuture);\n+            startDeploymentServiceInAnotherThread();\n+\n+            //Wait for the enough time after which deployment service would have processed the job from the queue\n+            Thread.sleep(Duration.ofSeconds(2).toMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUzMDQzMA==", "bodyText": "We need to wait for the deployment service to start in another thread and reach a point where it processed the job.  There is no latches in the code to indicate that it reached certain execution point.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412530430", "createdAt": "2020-04-21T22:18:52Z", "author": {"login": "abanthiy"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -182,6 +183,32 @@ public void GIVEN_deployment_job_WHEN_deployment_process_fails_THEN_report_faile\n             deploymentService.shutdown();\n         }\n \n+        @Test\n+        public void GIVEN_deployment_job_WHEN_deployment_process_fails_with_retry_THEN_retry_job(ExtensionContext context)\n+                throws Exception {\n+            CompletableFuture<Void> mockFutureWithException = new CompletableFuture<>();\n+            ignoreExceptionUltimateCauseOfType(context, RetryableDeploymentTaskFailureException.class);\n+            Throwable t = new RetryableDeploymentTaskFailureException(null);\n+            mockFutureWithException.completeExceptionally(t);\n+            when(mockExecutorService.submit(any(DeploymentTask.class))).thenReturn(mockFutureWithException, mockFuture);\n+            startDeploymentServiceInAnotherThread();\n+\n+            //Wait for the enough time after which deployment service would have processed the job from the queue\n+            Thread.sleep(Duration.ofSeconds(2).toMillis());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzNzM3MQ=="}, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjA4NTUxOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzoxMDoyNlrOGJPFeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjoyNToxMFrOGJ_WWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzNzUzMA==", "bodyText": "Why atMost and not times?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412337530", "createdAt": "2020-04-21T17:10:26Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -182,6 +183,32 @@ public void GIVEN_deployment_job_WHEN_deployment_process_fails_THEN_report_faile\n             deploymentService.shutdown();\n         }\n \n+        @Test\n+        public void GIVEN_deployment_job_WHEN_deployment_process_fails_with_retry_THEN_retry_job(ExtensionContext context)\n+                throws Exception {\n+            CompletableFuture<Void> mockFutureWithException = new CompletableFuture<>();\n+            ignoreExceptionUltimateCauseOfType(context, RetryableDeploymentTaskFailureException.class);\n+            Throwable t = new RetryableDeploymentTaskFailureException(null);\n+            mockFutureWithException.completeExceptionally(t);\n+            when(mockExecutorService.submit(any(DeploymentTask.class))).thenReturn(mockFutureWithException, mockFuture);\n+            startDeploymentServiceInAnotherThread();\n+\n+            //Wait for the enough time after which deployment service would have processed the job from the queue\n+            Thread.sleep(Duration.ofSeconds(2).toMillis());\n+            // Expecting two invocations\n+            verify(mockExecutorService, atMost(2)).submit(any(DeploymentTask.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEyODI4MA==", "bodyText": "Changed to times, copy pasta", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413128280", "createdAt": "2020-04-22T16:25:10Z", "author": {"login": "chaurah"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -182,6 +183,32 @@ public void GIVEN_deployment_job_WHEN_deployment_process_fails_THEN_report_faile\n             deploymentService.shutdown();\n         }\n \n+        @Test\n+        public void GIVEN_deployment_job_WHEN_deployment_process_fails_with_retry_THEN_retry_job(ExtensionContext context)\n+                throws Exception {\n+            CompletableFuture<Void> mockFutureWithException = new CompletableFuture<>();\n+            ignoreExceptionUltimateCauseOfType(context, RetryableDeploymentTaskFailureException.class);\n+            Throwable t = new RetryableDeploymentTaskFailureException(null);\n+            mockFutureWithException.completeExceptionally(t);\n+            when(mockExecutorService.submit(any(DeploymentTask.class))).thenReturn(mockFutureWithException, mockFuture);\n+            startDeploymentServiceInAnotherThread();\n+\n+            //Wait for the enough time after which deployment service would have processed the job from the queue\n+            Thread.sleep(Duration.ofSeconds(2).toMillis());\n+            // Expecting two invocations\n+            verify(mockExecutorService, atMost(2)).submit(any(DeploymentTask.class));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzNzUzMA=="}, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzM0NDY5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjowOTowMVrOGJakmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjoyMzozN1rOGJ_Row==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyNTcyMQ==", "bodyText": "Need to have a max times till when we will keep adding this to the queue. Also I don't think we need to add the QUEUED status to the config. The documentation at https://docs.aws.amazon.com/iot/latest/developerguide/jobs-api.html#mqtt-updatejobexecution mentions the update statuses from among (IN_PROGRESS, FAILED, SUCCEEDED, or REJECTED). I think keeping it IN_PROGRESS should be fine since thats the next thing we are going to process.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412525721", "createdAt": "2020-04-21T22:09:01Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -228,12 +230,14 @@ private void finishCurrentDeployment() throws InterruptedException {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n             if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                storeDeploymentStatusInConfig(currentJobId, JobStatus.QUEUED, statusDetails);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEyNzA3NQ==", "bodyText": "Makes sense. adding an explicit call to make sure it stays in IN_PROGRESS. Create a hard coded constant for now for max retries with a value of say 3?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413127075", "createdAt": "2020-04-22T16:23:37Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -228,12 +230,14 @@ private void finishCurrentDeployment() throws InterruptedException {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n             if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                storeDeploymentStatusInConfig(currentJobId, JobStatus.QUEUED, statusDetails);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyNTcyMQ=="}, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzM2MjgzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjoxNDoyN1rOGJaurQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjoyNDoyNlrOGJ_UPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyODMwMQ==", "bodyText": "I think this is a big try block. Consider putting try-catch blocks around the specific calls. For example PackageVersionConflictException can be caught around the resolveDependencies call. SImilarly for other calls?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412528301", "createdAt": "2020-04-21T22:14:27Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -59,9 +60,16 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n                     newConfig).get();\n             logger.atInfo().setEventType(DEPLOYMENT_TASK_EVENT_TYPE)\n                     .addKeyValue(\"deploymentId\", deploymentDocument.getDeploymentId()).log(\"Finish deployment task\");\n-        // TODO: unwrap ExcutionException to see which one is retryable.\n-        } catch (PackageVersionConflictException | UnexpectedPackagingException | ExecutionException e) {\n+        } catch (PackageVersionConflictException | UnexpectedPackagingException e) {\n             throw new NonRetryableDeploymentTaskFailureException(e);\n+        } catch (ExecutionException e) {\n+            Throwable t = e.getCause();\n+            if (t instanceof PackagingException\n+                    || t instanceof InterruptedException\n+                    || t instanceof IOException) {\n+                throw new RetryableDeploymentTaskFailureException(t);\n+            }\n+            throw new NonRetryableDeploymentTaskFailureException(t);\n         } catch (InterruptedException | IOException | PackagingException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEyNzc0MQ==", "bodyText": "I did think of that, but it was even longer code. This seemed to be a bit better overall", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413127741", "createdAt": "2020-04-22T16:24:26Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -59,9 +60,16 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n                     newConfig).get();\n             logger.atInfo().setEventType(DEPLOYMENT_TASK_EVENT_TYPE)\n                     .addKeyValue(\"deploymentId\", deploymentDocument.getDeploymentId()).log(\"Finish deployment task\");\n-        // TODO: unwrap ExcutionException to see which one is retryable.\n-        } catch (PackageVersionConflictException | UnexpectedPackagingException | ExecutionException e) {\n+        } catch (PackageVersionConflictException | UnexpectedPackagingException e) {\n             throw new NonRetryableDeploymentTaskFailureException(e);\n+        } catch (ExecutionException e) {\n+            Throwable t = e.getCause();\n+            if (t instanceof PackagingException\n+                    || t instanceof InterruptedException\n+                    || t instanceof IOException) {\n+                throw new RetryableDeploymentTaskFailureException(t);\n+            }\n+            throw new NonRetryableDeploymentTaskFailureException(t);\n         } catch (InterruptedException | IOException | PackagingException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyODMwMQ=="}, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzQ2MjA3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo0NTozOFrOGJbmDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjoyNDo1MFrOGJ_VfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0MjQ3OA==", "bodyText": "Can you rewind an \"INPROGRESS\" job to \"QUEUED\" ?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r412542478", "createdAt": "2020-04-21T22:45:38Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -228,12 +230,14 @@ private void finishCurrentDeployment() throws InterruptedException {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n             if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                storeDeploymentStatusInConfig(currentJobId, JobStatus.QUEUED, statusDetails);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEyODA2MQ==", "bodyText": "Keeping it in IN_PROGRESS based on Amit's comment above.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413128061", "createdAt": "2020-04-22T16:24:50Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -228,12 +230,14 @@ private void finishCurrentDeployment() throws InterruptedException {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n             if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                storeDeploymentStatusInConfig(currentJobId, JobStatus.QUEUED, statusDetails);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0MjQ3OA=="}, "originalCommit": {"oid": "e19f6142218d313731436a7c0a03bd9addde42ee"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NzgyNjcxOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1MToxMFrOGKDRZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzo1ODo0MlrOGKDmgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MjU0OA==", "bodyText": "4 seconds is way too long for a unit test. All this stuff should be happening within milliseconds.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413192548", "createdAt": "2020-04-22T17:51:10Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -63,6 +65,7 @@\n     private static final String TEST_JOB_ID_1 = \"TEST_JOB_1\";\n     private static final String TEST_JOB_ID_2 = \"TEST_JOB_2\";\n     private static final String CONNECTION_ERROR = \"Connection error\";\n+    private static final VerificationWithTimeout WAIT_FOUR_SECONDS = timeout(Duration.ofSeconds(4).toMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Mjk2Nw==", "bodyText": "Actually, nevermind since it will be at most 4 s.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413192967", "createdAt": "2020-04-22T17:51:46Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -63,6 +65,7 @@\n     private static final String TEST_JOB_ID_1 = \"TEST_JOB_1\";\n     private static final String TEST_JOB_ID_2 = \"TEST_JOB_2\";\n     private static final String CONNECTION_ERROR = \"Connection error\";\n+    private static final VerificationWithTimeout WAIT_FOUR_SECONDS = timeout(Duration.ofSeconds(4).toMillis());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MjU0OA=="}, "originalCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5Nzk1Mg==", "bodyText": "Out of the 7-8 times I ran the test with a 2 second timeout, at least once it failed. In the worst case, am using this to monitor 5 invocations of a single function. Keeping it high to avoid flakiness. I agree it's long but at the moment, there's no way to block on some value in the deployment service and completely avoid timers.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413197952", "createdAt": "2020-04-22T17:58:42Z", "author": {"login": "chaurah"}, "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -63,6 +65,7 @@\n     private static final String TEST_JOB_ID_1 = \"TEST_JOB_1\";\n     private static final String TEST_JOB_ID_2 = \"TEST_JOB_2\";\n     private static final String CONNECTION_ERROR = \"Connection error\";\n+    private static final VerificationWithTimeout WAIT_FOUR_SECONDS = timeout(Duration.ofSeconds(4).toMillis());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MjU0OA=="}, "originalCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODg3ODU0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMTo0NzozNFrOGKNP2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMzoxMDoxOVrOGKoeDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1NTk5Mw==", "bodyText": "Nothing else should be pushed between the new timestamp and the old timestamp since we are executing everything in single thread and also pushing deployment to the head of the deque. Timestamps are used for ordering the updates and in this case the order will not be affected.\nI see that we are updating the status details with the error information. Afaik right now there is no requirement to update the status of deployment every retry, and we do not mention in status details that we are retrying. It is also going to get overridden (in cloud) by the IN_PROGRESS update made on the new retry. I think we can skip this update and only update the status of the deployment when its final. What do you think?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413355993", "createdAt": "2020-04-22T21:47:34Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -219,21 +230,27 @@ private void connectToAWSIot() throws InterruptedException {\n     private void finishCurrentDeployment() throws InterruptedException {\n         logger.atInfo().kv(JOB_ID_LOG_KEY_NAME, currentJobId).log(\"Current deployment finished\");\n         try {\n-            //No timeout is set here. Detection of error is delegated to downstream components like\n+            // No timeout is set here. Detection of error is delegated to downstream components like\n             // dependency resolver, package downloader, kernel which will have more visibility\n             // if something is going wrong\n             currentProcessStatus.get();\n             storeDeploymentStatusInConfig(currentJobId, JobStatus.SUCCEEDED, new HashMap<>());\n+            currentJobAttemptCount.set(0);\n         } catch (ExecutionException e) {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n-            if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n+            if (t instanceof NonRetryableDeploymentTaskFailureException\n+                    || currentJobAttemptCount.get() >= DEPLOYMENT_MAX_ATTEMPTS) {\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+                currentJobAttemptCount.set(0);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                // Required to update timestamps", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgwMTk5Nw==", "bodyText": "I was erring on the side of more information over less. But if there's an override happening then it doesn't make sense to do this at the moment. Removing", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413801997", "createdAt": "2020-04-23T13:10:19Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -219,21 +230,27 @@ private void connectToAWSIot() throws InterruptedException {\n     private void finishCurrentDeployment() throws InterruptedException {\n         logger.atInfo().kv(JOB_ID_LOG_KEY_NAME, currentJobId).log(\"Current deployment finished\");\n         try {\n-            //No timeout is set here. Detection of error is delegated to downstream components like\n+            // No timeout is set here. Detection of error is delegated to downstream components like\n             // dependency resolver, package downloader, kernel which will have more visibility\n             // if something is going wrong\n             currentProcessStatus.get();\n             storeDeploymentStatusInConfig(currentJobId, JobStatus.SUCCEEDED, new HashMap<>());\n+            currentJobAttemptCount.set(0);\n         } catch (ExecutionException e) {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n-            if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n+            if (t instanceof NonRetryableDeploymentTaskFailureException\n+                    || currentJobAttemptCount.get() >= DEPLOYMENT_MAX_ATTEMPTS) {\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+                currentJobAttemptCount.set(0);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                // Required to update timestamps", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM1NTk5Mw=="}, "originalCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2OTAwMDQ5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMjoyMzo1NFrOGKOU6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNTo1NToyOVrOGKvjxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM3MzY3Mg==", "bodyText": "Have you considered storing DeploymentTask into a class variable and then submitting that to the executor service as oppose to resubmitting the Deployment.\n\nIt saves the processing that needs to be done again when submitting the same Deployment\nIt will allow us to keep it as a Queue, as opposed to Deque. This is to preserve that deployments run in the order in which they are submitted.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413373672", "createdAt": "2020-04-22T22:23:54Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -219,21 +230,27 @@ private void connectToAWSIot() throws InterruptedException {\n     private void finishCurrentDeployment() throws InterruptedException {\n         logger.atInfo().kv(JOB_ID_LOG_KEY_NAME, currentJobId).log(\"Current deployment finished\");\n         try {\n-            //No timeout is set here. Detection of error is delegated to downstream components like\n+            // No timeout is set here. Detection of error is delegated to downstream components like\n             // dependency resolver, package downloader, kernel which will have more visibility\n             // if something is going wrong\n             currentProcessStatus.get();\n             storeDeploymentStatusInConfig(currentJobId, JobStatus.SUCCEEDED, new HashMap<>());\n+            currentJobAttemptCount.set(0);\n         } catch (ExecutionException e) {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n-            if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n+            if (t instanceof NonRetryableDeploymentTaskFailureException\n+                    || currentJobAttemptCount.get() >= DEPLOYMENT_MAX_ATTEMPTS) {\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+                currentJobAttemptCount.set(0);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                // Required to update timestamps\n+                storeDeploymentStatusInConfig(currentJobId, JobStatus.IN_PROGRESS, statusDetails);\n+                deploymentsQueue.addFirst(currentDeployment);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkxODE0OQ==", "bodyText": "I did consider that. However, there's a lot of stuff happening in the createNewDeployment function like updating persisted deployments etc. As of now, it seems to be fairly straightforward? I just didn't see the point of adding a workaround that may have other implications when an iterative solution was easily available.\nI can update if you feel it's necessary, but as of now this seems the better approach until the rest of your thoughts in comments around refactoring get addressed. It should be possible to just move to queuing deployment tasks and avoiding the entire loop but that would require a lot more work than a one day task would allow I think.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r413918149", "createdAt": "2020-04-23T15:55:29Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -219,21 +230,27 @@ private void connectToAWSIot() throws InterruptedException {\n     private void finishCurrentDeployment() throws InterruptedException {\n         logger.atInfo().kv(JOB_ID_LOG_KEY_NAME, currentJobId).log(\"Current deployment finished\");\n         try {\n-            //No timeout is set here. Detection of error is delegated to downstream components like\n+            // No timeout is set here. Detection of error is delegated to downstream components like\n             // dependency resolver, package downloader, kernel which will have more visibility\n             // if something is going wrong\n             currentProcessStatus.get();\n             storeDeploymentStatusInConfig(currentJobId, JobStatus.SUCCEEDED, new HashMap<>());\n+            currentJobAttemptCount.set(0);\n         } catch (ExecutionException e) {\n             logger.atError().kv(JOB_ID_LOG_KEY_NAME, currentJobId).setCause(e)\n                     .log(\"Caught exception while getting the status of the Job\");\n             Throwable t = e.getCause();\n-            if (t instanceof NonRetryableDeploymentTaskFailureException) {\n-                HashMap<String, String> statusDetails = new HashMap<>();\n-                statusDetails.put(\"error\", t.getMessage());\n+            HashMap<String, String> statusDetails = new HashMap<>();\n+            statusDetails.put(\"error\", t.getMessage());\n+            if (t instanceof NonRetryableDeploymentTaskFailureException\n+                    || currentJobAttemptCount.get() >= DEPLOYMENT_MAX_ATTEMPTS) {\n                 storeDeploymentStatusInConfig(currentJobId, JobStatus.FAILED, statusDetails);\n+                currentJobAttemptCount.set(0);\n+            } else if (t instanceof RetryableDeploymentTaskFailureException) {\n+                // Required to update timestamps\n+                storeDeploymentStatusInConfig(currentJobId, JobStatus.IN_PROGRESS, statusDetails);\n+                deploymentsQueue.addFirst(currentDeployment);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM3MzY3Mg=="}, "originalCommit": {"oid": "03605c0fb2b9e0aabb3db5a8c533372b918df64c"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3NDQ2MDM5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMzoyNjo1OVrOGLAIfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMzozMTo1MVrOGLAPxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4OTY5Mw==", "bodyText": "Change it back to Queue?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r414189693", "createdAt": "2020-04-23T23:26:59Z", "author": {"login": "abanthiy"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -88,7 +99,7 @@\n     private final AtomicBoolean retryConnectingToAWSIot = new AtomicBoolean(false);\n     @Setter\n     private long pollingFrequency = DEPLOYMENT_POLLING_FREQUENCY;\n-    private LinkedBlockingQueue<Deployment> deploymentsQueue = new LinkedBlockingQueue<>();\n+    private LinkedBlockingDeque<Deployment> deploymentsQueue = new LinkedBlockingDeque<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71a4c8970ada06f304a0bef487517000bd07477d"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5MTU1OA==", "bodyText": "Refresh :)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/198#discussion_r414191558", "createdAt": "2020-04-23T23:31:51Z", "author": {"login": "chaurah"}, "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -88,7 +99,7 @@\n     private final AtomicBoolean retryConnectingToAWSIot = new AtomicBoolean(false);\n     @Setter\n     private long pollingFrequency = DEPLOYMENT_POLLING_FREQUENCY;\n-    private LinkedBlockingQueue<Deployment> deploymentsQueue = new LinkedBlockingQueue<>();\n+    private LinkedBlockingDeque<Deployment> deploymentsQueue = new LinkedBlockingDeque<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4OTY5Mw=="}, "originalCommit": {"oid": "71a4c8970ada06f304a0bef487517000bd07477d"}, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4626, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}