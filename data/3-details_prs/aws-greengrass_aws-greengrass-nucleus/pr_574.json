{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNDcwMjc2", "number": 574, "title": "Shadow deployment report state", "bodyText": "Issue #, if available:\nDescription of changes:\n\nAdd additional info passed to the PublishUpdateNamedShadow call\nSupport cancellation from shadow deployment\nReport deployment detailed info in FSS if it is a shadow deployment\n\nWhy is this change necessary:\nImplement proposed shadow deployment status reporting.\nHow was this change tested:\nWill be covered by UAT. Mark UAT as stable, add scenarios after cloud side is updated.\nAny additional information or context required to review the change:\nhttps://quip-amazon.com/go8TAt6sIHUb/Evergreen-Shadow-Deployment-Status-Gathering\nhttps://quip-amazon.com/6D5CArbzSlRb/Shadow-deployment-Update-with-FSS\nChecklist:\n\n Updated the README if applicable\n Updated or added new unit tests\n Updated or added new integration tests\n Updated or added new end-to-end tests\n\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-10-27T05:01:15Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574", "merged": true, "mergeCommit": {"oid": "54e07e03e570b01e138b18a4acd20f9865e0d0a4"}, "closed": true, "closedAt": "2020-11-13T01:42:39Z", "author": {"login": "tilo-chen"}, "timelineItems": {"totalCount": 38, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWqIImABqjM5MjYzNTg1Mjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdb8_waAFqTUyOTY0MDE1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa633be67b00312edbbc59013688e15ce00b500c", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fa633be67b00312edbbc59013688e15ce00b500c", "committedDate": "2020-10-27T04:59:57Z", "message": "draft shadow deployment report state"}, "afterCommit": {"oid": "e76736d2852631cfcc080b5ae0346e01f9495f39", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e76736d2852631cfcc080b5ae0346e01f9495f39", "committedDate": "2020-10-27T14:48:12Z", "message": "add some fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MTYwOTMw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#pullrequestreview-518160930", "createdAt": "2020-10-27T21:21:46Z", "commit": {"oid": "e76736d2852631cfcc080b5ae0346e01f9495f39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMToyMTo0NlrOHpRfdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMToyMTo0NlrOHpRfdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA0MDI0NA==", "bodyText": "you remove the desiredStateQueue all state required to update the reported state of shadow are present in Map<String, Object> deploymentDetails", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#discussion_r513040244", "createdAt": "2020-10-27T21:21:46Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/greengrass/deployment/ShadowDeploymentListener.java", "diffHunk": "@@ -182,51 +183,48 @@ private void publishToGetDeviceShadowTopic() {\n \n     @SuppressFBWarnings\n     private Boolean deploymentStatusChanged(Map<String, Object> deploymentDetails) {\n-        DeploymentStatus status = DeploymentStatus.valueOf((String)\n-                deploymentDetails.get(DEPLOYMENT_STATUS_KEY_NAME));\n-\n         String configurationArn = (String) deploymentDetails.get(DEPLOYMENT_ID_KEY_NAME);\n-        // only update reported state when the deployment succeeds.\n-        if (DeploymentStatus.SUCCEEDED.equals(status)) {\n-\n-            Pair<String, Map<String, Object>> desired = desiredStateQueue.peek();\n-            // discard configurations that might have got added to the queue but the deployment\n-            // got discarded before being processed due to a new shadow deployment\n-            while (desired != null && !desired.getLeft().equals(configurationArn)) {\n-                desiredStateQueue.poll();\n-                desired = desiredStateQueue.peek();\n-            }\n+        Pair<String, Map<String, Object>> desired = desiredStateQueue.peek();\n+        // discard configurations that might have got added to the queue but the deployment\n+        // got discarded before being processed due to a new shadow deployment\n+        while (desired != null && !desired.getLeft().equals(configurationArn)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76736d2852631cfcc080b5ae0346e01f9495f39"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e76736d2852631cfcc080b5ae0346e01f9495f39", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e76736d2852631cfcc080b5ae0346e01f9495f39", "committedDate": "2020-10-27T14:48:12Z", "message": "add some fields"}, "afterCommit": {"oid": "7847957e75265d358ceb8953f0742dcc80efe45b", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7847957e75265d358ceb8953f0742dcc80efe45b", "committedDate": "2020-10-29T00:57:28Z", "message": "finish impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDgxMDE3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#pullrequestreview-521081017", "createdAt": "2020-10-30T23:13:12Z", "commit": {"oid": "004427fa7d0e14d4d748f35db61a4a77db7f6683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzoxMzoxMlrOHritlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzoxMzoxMlrOHritlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQxOTU0Mg==", "bodyText": "Lets create a new hash map here, wouldnt this just add two more keys with the same value while keeping the originals keys DEPLOYMENT_DETAILED_STATUS_KEY, DEPLOYMENT_FAILURE_CAUSE_KEY", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#discussion_r515419542", "createdAt": "2020-10-30T23:13:12Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/greengrass/deployment/ShadowDeploymentListener.java", "diffHunk": "@@ -182,59 +189,52 @@ private void publishToGetDeviceShadowTopic() {\n \n     @SuppressFBWarnings\n     private Boolean deploymentStatusChanged(Map<String, Object> deploymentDetails) {\n-        DeploymentStatus status = DeploymentStatus.valueOf((String)\n-                deploymentDetails.get(DEPLOYMENT_STATUS_KEY_NAME));\n-\n         String configurationArn = (String) deploymentDetails.get(DEPLOYMENT_ID_KEY_NAME);\n-        // only update reported state when the deployment succeeds.\n-        if (DeploymentStatus.SUCCEEDED.equals(status)) {\n+        try {\n+            ShadowState shadowState = new ShadowState();\n+            shadowState.reported = getReportedShadowState(deploymentDetails);\n+            UpdateNamedShadowRequest updateNamedShadowRequest = new UpdateNamedShadowRequest();\n+            updateNamedShadowRequest.shadowName = DEPLOYMENT_SHADOW_NAME;\n+            updateNamedShadowRequest.thingName = thingName;\n+            updateNamedShadowRequest.state = shadowState;\n+            iotShadowClient.PublishUpdateNamedShadow(updateNamedShadowRequest, QualityOfService.AT_LEAST_ONCE)\n+                    .get(TIMEOUT_FOR_PUBLISHING_TO_TOPICS_SECONDS, TimeUnit.SECONDS);\n+            logger.atInfo().kv(CONFIGURATION_ARN_LOG_KEY_NAME, configurationArn)\n+                    .log(\"Updated reported state for deployment\");\n+            return true;\n+        } catch (InterruptedException e) {\n+            //Since this method can run as runnable cannot throw exception so handling exceptions here\n+            logger.atWarn().log(\"Interrupted while publishing reported state\");\n+        } catch (ExecutionException e) {\n+            logger.atError().setCause(e).log(\"Caught exception while publishing reported state\");\n+        } catch (TimeoutException e) {\n+            logger.atWarn().setCause(e).log(\"Publish reported state timed out, will retry shortly\");\n+        }\n+        return false;\n+    }\n \n-            Pair<String, Map<String, Object>> desired = desiredStateQueue.peek();\n-            // discard configurations that might have got added to the queue but the deployment\n-            // got discarded before being processed due to a new shadow deployment\n-            while (desired != null && !desired.getLeft().equals(configurationArn)) {\n-                desiredStateQueue.poll();\n-                desired = desiredStateQueue.peek();\n-            }\n+    @SuppressWarnings(\"PMD.LooseCoupling\")\n+    private HashMap<String, Object> getReportedShadowState(Map<String, Object> deploymentDetails) {\n+        HashMap<String, Object> statusDetails =\n+                (HashMap<String, Object>) deploymentDetails.get(DEPLOYMENT_STATUS_DETAILS_KEY_NAME);\n+        statusDetails.put(DETAILED_STATUS_KEY, statusDetails.get(DEPLOYMENT_DETAILED_STATUS_KEY));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "004427fa7d0e14d4d748f35db61a4a77db7f6683"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDgyNzcx", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#pullrequestreview-521082771", "createdAt": "2020-10-30T23:20:51Z", "commit": {"oid": "004427fa7d0e14d4d748f35db61a4a77db7f6683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzoyMDo1MlrOHrizpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzoyMDo1MlrOHrizpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyMTA5Mw==", "bodyText": "Line256 should use configuration.get(FLEET_CONFIG_KEY)) instead of configuration. Can we test this by pointing to a different shadow and updating the shadow (simulate cloud)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#discussion_r515421093", "createdAt": "2020-10-30T23:20:52Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/greengrass/deployment/ShadowDeploymentListener.java", "diffHunk": "@@ -259,9 +259,12 @@ protected void shadowUpdated(Map<String, Object> configuration, Integer version)\n             return;\n         }\n \n-        desiredStateQueue.add(new Pair<>(configurationArn, configuration));\n-        Deployment deployment =\n-                new Deployment(configurationString, DeploymentType.SHADOW, configurationArn);\n+        Deployment deployment;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "004427fa7d0e14d4d748f35db61a4a77db7f6683"}, "originalPosition": 160}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDgyOTY5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#pullrequestreview-521082969", "createdAt": "2020-10-30T23:21:44Z", "commit": {"oid": "004427fa7d0e14d4d748f35db61a4a77db7f6683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzoyMTo0NFrOHri0Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzoyMTo0NFrOHri0Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyMTI0Mg==", "bodyText": "we dont need this check, the deployment details can be emitted for both shadow and jobs deployments. Lets not check this in as it would break existing e2e and FSS related UAT's", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#discussion_r515421242", "createdAt": "2020-10-30T23:21:44Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/greengrass/status/FleetStatusService.java", "diffHunk": "@@ -240,6 +246,13 @@ private Boolean deploymentStatusChanged(Map<String, Object> deploymentDetails) {\n             logger.atDebug().log(\"Updating Fleet Status service for deployment with ID: {}\",\n                     deploymentDetails.get(DEPLOYMENT_ID_KEY_NAME));\n             isDeploymentInProgress.set(false);\n+            if (type == SHADOW) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "004427fa7d0e14d4d748f35db61a4a77db7f6683"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c308968b72727f9e940271e35b1681441b9f0c1", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4c308968b72727f9e940271e35b1681441b9f0c1", "committedDate": "2020-11-02T02:40:17Z", "message": "draft shadow deployment report state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f274761b315695e001f428a6135e315e4ec0b54", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/7f274761b315695e001f428a6135e315e4ec0b54", "committedDate": "2020-11-02T02:40:17Z", "message": "add some fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d513734c4bce25576096fe63ad4e8bba9242464", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/3d513734c4bce25576096fe63ad4e8bba9242464", "committedDate": "2020-11-02T02:40:17Z", "message": "finish impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc7646248b5c51c07706feb31ee6cac1c2a53dd6", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bc7646248b5c51c07706feb31ee6cac1c2a53dd6", "committedDate": "2020-11-02T03:31:23Z", "message": "fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "004427fa7d0e14d4d748f35db61a4a77db7f6683", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/004427fa7d0e14d4d748f35db61a4a77db7f6683", "committedDate": "2020-10-30T18:21:11Z", "message": "Merge branch 'master' into shadow-deploy-report"}, "afterCommit": {"oid": "bc7646248b5c51c07706feb31ee6cac1c2a53dd6", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bc7646248b5c51c07706feb31ee6cac1c2a53dd6", "committedDate": "2020-11-02T03:31:23Z", "message": "fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "715ec34856f78c6e10d5c4135f2cd5c3b3e44025", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/715ec34856f78c6e10d5c4135f2cd5c3b3e44025", "committedDate": "2020-11-02T05:39:57Z", "message": "add null check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTU1NTc3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#pullrequestreview-521955577", "createdAt": "2020-11-02T20:06:03Z", "commit": {"oid": "715ec34856f78c6e10d5c4135f2cd5c3b3e44025"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDowNjowM1rOHsT2Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDoxMjozOFrOHsUCiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNDU0Mw==", "bodyText": "nit: DESIRED_STATUS_CANCELED.equals(...)", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#discussion_r516224543", "createdAt": "2020-11-02T20:06:03Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/deployment/ShadowDeploymentListener.java", "diffHunk": "@@ -253,15 +256,18 @@ protected void shadowUpdated(Map<String, Object> configuration, Integer version)\n \n         String configurationString;\n         try {\n-            configurationString = SerializerFactory.getJsonObjectMapper().writeValueAsString(configuration);\n+            configurationString = SerializerFactory.getJsonObjectMapper().writeValueAsString(fleetConfig);\n         } catch (JsonProcessingException e) {\n             logger.atError(\"Unable to process shadow update\", e);\n             return;\n         }\n \n-        desiredStateQueue.add(new Pair<>(configurationArn, configuration));\n-        Deployment deployment =\n-                new Deployment(configurationString, DeploymentType.SHADOW, configurationArn);\n+        Deployment deployment;\n+        if (desired.get(DESIRED_STATUS_KEY).equals(DESIRED_STATUS_CANCELED)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "715ec34856f78c6e10d5c4135f2cd5c3b3e44025"}, "originalPosition": 173}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNzcyMA==", "bodyText": "Is this information only reported to shadow (not in iot jobs)?\nThe version may need to be changed later, by looking up Nucleus component deviceConfiguration.getNucleusComponentName()", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#discussion_r516227720", "createdAt": "2020-11-02T20:12:38Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/greengrass/deployment/ShadowDeploymentListener.java", "diffHunk": "@@ -182,59 +189,55 @@ private void publishToGetDeviceShadowTopic() {\n \n     @SuppressFBWarnings\n     private Boolean deploymentStatusChanged(Map<String, Object> deploymentDetails) {\n-        DeploymentStatus status = DeploymentStatus.valueOf((String)\n-                deploymentDetails.get(DEPLOYMENT_STATUS_KEY_NAME));\n-\n         String configurationArn = (String) deploymentDetails.get(DEPLOYMENT_ID_KEY_NAME);\n-        // only update reported state when the deployment succeeds.\n-        if (DeploymentStatus.SUCCEEDED.equals(status)) {\n+        try {\n+            ShadowState shadowState = new ShadowState();\n+            shadowState.reported = getReportedShadowState(deploymentDetails);\n+            UpdateNamedShadowRequest updateNamedShadowRequest = new UpdateNamedShadowRequest();\n+            updateNamedShadowRequest.shadowName = DEPLOYMENT_SHADOW_NAME;\n+            updateNamedShadowRequest.thingName = thingName;\n+            updateNamedShadowRequest.state = shadowState;\n+            iotShadowClient.PublishUpdateNamedShadow(updateNamedShadowRequest, QualityOfService.AT_LEAST_ONCE)\n+                    .get(TIMEOUT_FOR_PUBLISHING_TO_TOPICS_SECONDS, TimeUnit.SECONDS);\n+            logger.atInfo().kv(CONFIGURATION_ARN_LOG_KEY_NAME, configurationArn)\n+                    .log(\"Updated reported state for deployment\");\n+            return true;\n+        } catch (InterruptedException e) {\n+            //Since this method can run as runnable cannot throw exception so handling exceptions here\n+            logger.atWarn().log(\"Interrupted while publishing reported state\");\n+        } catch (ExecutionException e) {\n+            logger.atError().setCause(e).log(\"Caught exception while publishing reported state\");\n+        } catch (TimeoutException e) {\n+            logger.atWarn().setCause(e).log(\"Publish reported state timed out, will retry shortly\");\n+        }\n+        return false;\n+    }\n \n-            Pair<String, Map<String, Object>> desired = desiredStateQueue.peek();\n-            // discard configurations that might have got added to the queue but the deployment\n-            // got discarded before being processed due to a new shadow deployment\n-            while (desired != null && !desired.getLeft().equals(configurationArn)) {\n-                desiredStateQueue.poll();\n-                desired = desiredStateQueue.peek();\n-            }\n+    @SuppressWarnings(\"PMD.LooseCoupling\")\n+    private HashMap<String, Object> getReportedShadowState(Map<String, Object> deploymentDetails) {\n+        Map<String, Object> deploymentStatusDetails =\n+                (Map<String, Object>) deploymentDetails.get(DEPLOYMENT_STATUS_DETAILS_KEY_NAME);\n \n-            if (desired == null) {\n-                logger.atError().kv(CONFIGURATION_ARN_LOG_KEY_NAME, configurationArn)\n-                        .log(\"Unable to update shadow for deployment\");\n-                return true;\n-            }\n+        HashMap<String, Object> statusDetails = new HashMap<>();\n+        statusDetails.put(DETAILED_STATUS_KEY, deploymentStatusDetails.get(DEPLOYMENT_DETAILED_STATUS_KEY));\n+        statusDetails.put(FAILURE_CAUSE_KEY, deploymentStatusDetails.get(DEPLOYMENT_FAILURE_CAUSE_KEY));\n \n-            try {\n-                ShadowState shadowState = new ShadowState();\n-                shadowState.reported = new HashMap<>(desired.getRight());\n-                UpdateNamedShadowRequest updateNamedShadowRequest = new UpdateNamedShadowRequest();\n-                updateNamedShadowRequest.shadowName = DEPLOYMENT_SHADOW_NAME;\n-                updateNamedShadowRequest.thingName = thingName;\n-                updateNamedShadowRequest.state = shadowState;\n-                iotShadowClient.PublishUpdateNamedShadow(updateNamedShadowRequest, QualityOfService.AT_LEAST_ONCE)\n-                        .get(TIMEOUT_FOR_PUBLISHING_TO_TOPICS_SECONDS, TimeUnit.SECONDS);\n-                desiredStateQueue.remove();\n-                logger.atInfo().kv(CONFIGURATION_ARN_LOG_KEY_NAME, configurationArn)\n-                        .log(\"Updated reported state for deployment\");\n-                return true;\n-            } catch (InterruptedException e) {\n-                //Since this method can run as runnable cannot throw exception so handling exceptions here\n-                logger.atWarn().log(\"Interrupted while publishing reported state\");\n-            } catch (ExecutionException e) {\n-                logger.atError().setCause(e).log(\"Caught exception while publishing reported state\");\n-            } catch (TimeoutException e) {\n-                logger.atWarn().setCause(e).log(\"Publish reported state timed out, will retry shortly\");\n-            }\n-            return false;\n-        }\n-        return true;\n+        HashMap<String, Object> reported = new HashMap<>();\n+        reported.put(ARN_FOR_STATUS_KEY, deploymentDetails.get(DEPLOYMENT_ID_KEY_NAME));\n+        reported.put(STATUS_KEY, deploymentDetails.get(DEPLOYMENT_STATUS_KEY_NAME));\n+        reported.put(STATUS_DETAILS_KEY, statusDetails);\n+        reported.put(GGC_VERSION_KEY, KERNEL_VERSION);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "715ec34856f78c6e10d5c4135f2cd5c3b3e44025"}, "originalPosition": 140}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMTM3MjY3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#pullrequestreview-522137267", "createdAt": "2020-11-03T01:10:15Z", "commit": {"oid": "715ec34856f78c6e10d5c4135f2cd5c3b3e44025"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwMToxMDoxNVrOHsdQmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwMToxNDoyMlrOHsdUrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM3ODc3OA==", "bodyText": "should this cast happen safely? maybe check if the get does not return null?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#discussion_r516378778", "createdAt": "2020-11-03T01:10:15Z", "author": {"login": "nikkhilmuthye"}, "path": "src/main/java/com/aws/greengrass/status/FleetStatusService.java", "diffHunk": "@@ -359,6 +364,24 @@ private void uploadFleetStatusServiceData(Set<GreengrassService> greengrassServi\n                 .ggcVersion(KERNEL_VERSION)\n                 .sequenceNumber(sequenceNumber)\n                 .build();\n+\n+        if (deploymentDetails != null) {\n+            DeploymentInformation deploymentInformation = DeploymentInformation.builder()\n+                    .status((String) deploymentDetails.get(DEPLOYMENT_STATUS_KEY_NAME))\n+                    .fleetConfigurationArnForStatus((String) deploymentDetails.get(DEPLOYMENT_ID_KEY_NAME))\n+                    .build();\n+            Map<String, String> statusDetailsMap =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "715ec34856f78c6e10d5c4135f2cd5c3b3e44025"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM3OTgyMA==", "bodyText": "It would probably be better if you send a DeploymentInformation in this function and create the object in deploymentStatusChanged", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#discussion_r516379820", "createdAt": "2020-11-03T01:14:22Z", "author": {"login": "nikkhilmuthye"}, "path": "src/main/java/com/aws/greengrass/status/FleetStatusService.java", "diffHunk": "@@ -277,12 +281,13 @@ private void updateEventTriggeredFleetStatusData() {\n         });\n         removedDependenciesSet.forEach(allServiceNamesMap::remove);\n         removedDependenciesSet.clear();\n-        uploadFleetStatusServiceData(updatedGreengrassServiceSet, overAllStatus.get());\n+        uploadFleetStatusServiceData(updatedGreengrassServiceSet, overAllStatus.get(), deploymentDetails);\n         isEventTriggeredUpdateInProgress.set(false);\n     }\n \n     private void uploadFleetStatusServiceData(Set<GreengrassService> greengrassServiceSet,\n-                                              OverallStatus overAllStatus) {\n+                                              OverallStatus overAllStatus,\n+                                              Map<String, Object> deploymentDetails) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "715ec34856f78c6e10d5c4135f2cd5c3b3e44025"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44437383e4ffb0e316e980e122fa9153fcfdae9f", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/44437383e4ffb0e316e980e122fa9153fcfdae9f", "committedDate": "2020-11-03T17:50:58Z", "message": "Merge branch 'master' into shadow-deploy-report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc220aab4f1e32a9e6f9f3d00b3e7cd90128c630", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/bc220aab4f1e32a9e6f9f3d00b3e7cd90128c630", "committedDate": "2020-11-03T19:49:01Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a1e0ad0084f2050df287093d44e207f3ff6916c", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8a1e0ad0084f2050df287093d44e207f3ff6916c", "committedDate": "2020-11-06T17:40:42Z", "message": "report shadow cancel status; name change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd8c7569cd81809ebe9d4585852293324476cc8e", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/dd8c7569cd81809ebe9d4585852293324476cc8e", "committedDate": "2020-11-06T19:46:10Z", "message": "Merge branch 'master' of github.com:aws/aws-greengrass-nucleus into shadow-deploy-report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b44d337ea52cc09282ea8f3258b0ef077cd32c3e", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b44d337ea52cc09282ea8f3258b0ef077cd32c3e", "committedDate": "2020-11-06T19:47:06Z", "message": "name change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "078c1dbf9a16890344f8877b662ecacf1124dee1", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/078c1dbf9a16890344f8877b662ecacf1124dee1", "committedDate": "2020-11-10T15:26:16Z", "message": "Merge branch 'master' into shadow-deploy-report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a4f32f60356633a4939ab1fcec9ae931fb53682", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6a4f32f60356633a4939ab1fcec9ae931fb53682", "committedDate": "2020-11-11T04:09:26Z", "message": "Merge branch 'master' into shadow-deploy-report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f98fbc11e869aeef1f0ceae3161256e83311450e", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/f98fbc11e869aeef1f0ceae3161256e83311450e", "committedDate": "2020-11-11T18:22:30Z", "message": "Merge branch 'master' into shadow-deploy-report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c064fc613014ab8acc26e452128afc34c63f7874", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/c064fc613014ab8acc26e452128afc34c63f7874", "committedDate": "2020-11-11T22:32:46Z", "message": "Merge branch 'master' into shadow-deploy-report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0150d73a7d9bf3505027a188140900fc374a424c", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0150d73a7d9bf3505027a188140900fc374a424c", "committedDate": "2020-11-12T00:08:58Z", "message": "handle shadow update properly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8d34e5e1cb8d40b81270d88187ccc5a31b24e3d", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a8d34e5e1cb8d40b81270d88187ccc5a31b24e3d", "committedDate": "2020-11-12T00:10:05Z", "message": "Merge branch 'master' into shadow-deploy-report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "822aef31a943ff91ee8751044eac36e442a185d0", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/822aef31a943ff91ee8751044eac36e442a185d0", "committedDate": "2020-11-12T15:51:53Z", "message": "Merge branch 'master' into shadow-deploy-report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df2a23fb4c29004447cfa698c21df9c5defa3735", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/df2a23fb4c29004447cfa698c21df9c5defa3735", "committedDate": "2020-11-12T20:41:30Z", "message": "update e2e test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "708a3ae253225244f63ad3ac870d3cebde6763e9", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/708a3ae253225244f63ad3ac870d3cebde6763e9", "committedDate": "2020-11-12T21:15:20Z", "message": "update e2e test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4634f2d8b921472a2b457e41dd4c069e21f6eb3", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a4634f2d8b921472a2b457e41dd4c069e21f6eb3", "committedDate": "2020-11-12T21:34:30Z", "message": "Merge branch 'master' into shadow-deploy-report"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTE5NDkw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#pullrequestreview-529519490", "createdAt": "2020-11-12T21:41:51Z", "commit": {"oid": "a4634f2d8b921472a2b457e41dd4c069e21f6eb3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTQ5NjQ5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#pullrequestreview-529549649", "createdAt": "2020-11-12T22:25:44Z", "commit": {"oid": "a4634f2d8b921472a2b457e41dd4c069e21f6eb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoyNTo0NFrOHyRGXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMjoyNTo0NFrOHyRGXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ3MTAwNw==", "bodyText": "Can you add a unit test which will use this function?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#discussion_r522471007", "createdAt": "2020-11-12T22:25:44Z", "author": {"login": "nikkhilmuthye"}, "path": "src/main/java/com/aws/greengrass/status/FleetStatusService.java", "diffHunk": "@@ -437,6 +445,20 @@ private OverallStatus getOverallStatusBasedOnServiceState(OverallStatus overallS\n         return OverallStatus.HEALTHY;\n     }\n \n+    private DeploymentInformation getDeploymentInformation(Map<String, Object> deploymentDetails) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4634f2d8b921472a2b457e41dd4c069e21f6eb3"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6e392ec700f717f88d0f95836e01f625ce7c1ea", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a6e392ec700f717f88d0f95836e01f625ce7c1ea", "committedDate": "2020-11-12T22:47:38Z", "message": "add unit test assertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3e6f639666ce69ac20e796dc83b18743244d418", "author": {"user": {"login": "fahadmohammed01", "name": null}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/b3e6f639666ce69ac20e796dc83b18743244d418", "committedDate": "2020-11-13T00:12:27Z", "message": "Merge branch 'master' into shadow-deploy-report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81791ca2a7d741461e77dd75a7012c326092ff40", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/81791ca2a7d741461e77dd75a7012c326092ff40", "committedDate": "2020-11-13T01:24:27Z", "message": "add status details assertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e89fa3ed940f5681ea422f176884c59e99515ca", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/9e89fa3ed940f5681ea422f176884c59e99515ca", "committedDate": "2020-11-13T01:25:13Z", "message": "Merge branch 'shadow-deploy-report' of github.com:aws/aws-greengrass-nucleus into shadow-deploy-report"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b06d7c9581cc0e85a742977cd87dd12cf1df7da", "author": {"user": {"login": "tilo-chen", "name": "Tiangang (Tilo) Chen"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6b06d7c9581cc0e85a742977cd87dd12cf1df7da", "committedDate": "2020-11-13T01:26:00Z", "message": "Merge branch 'master' into shadow-deploy-report"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NjM4ODU5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#pullrequestreview-529638859", "createdAt": "2020-11-13T01:33:11Z", "commit": {"oid": "6b06d7c9581cc0e85a742977cd87dd12cf1df7da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NjQwMTUz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/574#pullrequestreview-529640153", "createdAt": "2020-11-13T01:37:08Z", "commit": {"oid": "6b06d7c9581cc0e85a742977cd87dd12cf1df7da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2837, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}