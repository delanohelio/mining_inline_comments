{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MDc4MDE3", "number": 237, "title": "Support dependency type in package recipe", "bodyText": "Issue #, if available:\nDescription of changes:\n\nUpdate dependency syntax in package recipes\nSupport dependency type\n\nWhy is this change necessary:\nRequired to support soft dependencies.\nHow was this change tested:\nUnit tests\nAny additional information or context required to review the change:\nBy submitting this pull request, I confirm that you can use, modify, copy, and redistribute this contribution, under the terms of your choice.", "createdAt": "2020-05-13T02:37:19Z", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237", "merged": true, "mergeCommit": {"oid": "6f98d3b8330e5b64d5af8f3a29d8f5ba1420fbff"}, "closed": true, "closedAt": "2020-05-14T21:09:21Z", "author": {"login": "hui-yang"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg65VxgFqTQxMTA2MjY0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABchTyT-AFqTQxMjE3Mjk3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDYyNjQw", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#pullrequestreview-411062640", "createdAt": "2020-05-13T15:48:46Z", "commit": {"oid": "68e82224cf86d65b74997bb6ad2d4e684f921127"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNTo0ODo0N1rOGU4IWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNTo0ODo0N1rOGU4IWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NDM0Nw==", "bodyText": "Can this not be a Map<String, Map<...>> so that we can do dependency syntax validation right at the time of parsing and don't move further at all?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r424544347", "createdAt": "2020-05-13T15:48:47Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/models/PackageRecipe.java", "diffHunk": "@@ -50,7 +52,7 @@\n     // TODO: Migrate to artifact objects, this is only a list of URLs at the moment\n     private final List<String> artifacts;\n \n-    private final Map<String, String> dependencies;\n+    private final Map<String, Object> dependencies;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68e82224cf86d65b74997bb6ad2d4e684f921127"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDYzNTU1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#pullrequestreview-411063555", "createdAt": "2020-05-13T15:49:46Z", "commit": {"oid": "68e82224cf86d65b74997bb6ad2d4e684f921127"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNTo0OTo0NlrOGU4LJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNTo0OTo0NlrOGU4LJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NTA2MA==", "bodyText": "Nit -move out to a method?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r424545060", "createdAt": "2020-05-13T15:49:46Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -146,7 +150,21 @@ PackageRecipe getPackageRecipe(@NonNull PackageIdentifier pkgId) throws PackageL\n      * @throws PackagingException if fails to find or parse the recipe\n      */\n     PackageMetadata getPackageMetadata(@NonNull PackageIdentifier pkgId) throws PackagingException {\n-        return new PackageMetadata(pkgId, getPackageRecipe(pkgId).getDependencies());\n+        Map<String, String> dependencyMetadata = new HashMap<>();\n+        for (Map.Entry<String, Object> entry : getPackageRecipe(pkgId).getDependencies().entrySet()) {\n+            if (!(entry.getValue() instanceof Map)) {\n+                throw new PackageLoadingException(String.format(\"Illegal dependency syntax in package recipe of %s\",\n+                        pkgId));\n+            }\n+            Map<String, String> propMap = (Map<String, String>) entry.getValue();\n+            if (!propMap.containsKey(DEPENDENCY_VERSION_REQUIREMENTS_KEY)) {\n+                throw new PackageLoadingException(String.format(\n+                        \"Illegal dependency syntax in package recipe of %s: Missing %s\",\n+                        pkgId, DEPENDENCY_VERSION_REQUIREMENTS_KEY));\n+            }\n+            dependencyMetadata.put(entry.getKey(), propMap.get(DEPENDENCY_VERSION_REQUIREMENTS_KEY));\n+        }\n+        return new PackageMetadata(pkgId, dependencyMetadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68e82224cf86d65b74997bb6ad2d4e684f921127"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDY2MjY2", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#pullrequestreview-411066266", "createdAt": "2020-05-13T15:52:38Z", "commit": {"oid": "68e82224cf86d65b74997bb6ad2d4e684f921127"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNTo1MjozOFrOGU4TYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNTo1MjozOFrOGU4TYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NzE2OQ==", "bodyText": "Can also move this out to a method", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r424547169", "createdAt": "2020-05-13T15:52:38Z", "author": {"login": "shaguptashaikh"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -102,13 +103,21 @@\n         }\n         resolvedServiceConfig.put(SETENV_CONFIG_NAMESPACE, resolvedSetEnvConfig);\n \n-        // TODO : Update package recipe format to include all information that service dependencies config\n-        // expects according to the new syntax e.g. dependencyType,\n-        // then change the following code accordingly\n-\n         // Generate dependencies\n-        List<String> dependencyServiceNames = new ArrayList<>(packageRecipe.getDependencies().keySet());\n-        resolvedServiceConfig.put(SERVICE_DEPENDENCIES_NAMESPACE_TOPIC, dependencyServiceNames);\n+        List<String> dependencyConfig = new ArrayList<>();\n+        for (Map.Entry<String, Object> entry : packageRecipe.getDependencies().entrySet()) {\n+            if (!(entry.getValue() instanceof Map)) {\n+                throw new PackageLoadingException(String\n+                        .format(\"Illegal dependency syntax in package recipe of %s\", packageIdentifier));\n+            }\n+            Map<String, String> propMap = (Map<String, String>) entry.getValue();\n+            if (!propMap.containsKey(DEPENDENCY_TYPE_KEY)) {\n+                dependencyConfig.add(entry.getKey());\n+                continue;\n+            }\n+            dependencyConfig.add(entry.getKey() + \":\" + propMap.get(DEPENDENCY_TYPE_KEY));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68e82224cf86d65b74997bb6ad2d4e684f921127"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68e82224cf86d65b74997bb6ad2d4e684f921127", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/68e82224cf86d65b74997bb6ad2d4e684f921127", "committedDate": "2020-05-13T02:28:18Z", "message": "Support dependency type in package recipe"}, "afterCommit": {"oid": "cc42b95fc8fb7781b03196ee29ec5d71fbc6a70d", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cc42b95fc8fb7781b03196ee29ec5d71fbc6a70d", "committedDate": "2020-05-14T02:28:22Z", "message": "Support dependency type in package recipe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd5e9c7eae611fda27473b73c2c37443063352f", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/abd5e9c7eae611fda27473b73c2c37443063352f", "committedDate": "2020-05-14T02:30:14Z", "message": "Support dependency type in package recipe"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc42b95fc8fb7781b03196ee29ec5d71fbc6a70d", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/cc42b95fc8fb7781b03196ee29ec5d71fbc6a70d", "committedDate": "2020-05-14T02:28:22Z", "message": "Support dependency type in package recipe"}, "afterCommit": {"oid": "abd5e9c7eae611fda27473b73c2c37443063352f", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/abd5e9c7eae611fda27473b73c2c37443063352f", "committedDate": "2020-05-14T02:30:14Z", "message": "Support dependency type in package recipe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDUyNDM3", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#pullrequestreview-412052437", "createdAt": "2020-05-14T17:55:43Z", "commit": {"oid": "abd5e9c7eae611fda27473b73c2c37443063352f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzo1NTo0M1rOGVn8NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzo1ODoxMVrOGVoCUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMyNzY2OQ==", "bodyText": "Do you plan to turn this into a map as well instead of a string? Not necessary for this PR to keep changes smaller, but eventually, right?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r425327669", "createdAt": "2020-05-14T17:55:43Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/KernelConfigResolver.java", "diffHunk": "@@ -191,9 +189,9 @@ private String replace(String stringValue, PackageIdentifier packageIdentifier,\n \n         Map<Object, Object> mainServiceConfig = new HashMap<>();\n         ArrayList<String> mainDependencies = new ArrayList<>(rootPackages);\n-        kernel.getMain().getDependencies().keySet().forEach(evergreenService -> {\n+        kernel.getMain().getDependencies().forEach((evergreenService, dependencyType) -> {\n             if (!(evergreenService instanceof GenericExternalService)) {\n-                mainDependencies.add(evergreenService.getName());\n+                mainDependencies.add(evergreenService.getName() + \":\" + dependencyType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abd5e9c7eae611fda27473b73c2c37443063352f"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMyOTIzMg==", "bodyText": "Why not change the data type in PackageMetadata to contain all the dependency info and not just the version requirement?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#discussion_r425329232", "createdAt": "2020-05-14T17:58:11Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageStore.java", "diffHunk": "@@ -146,7 +148,10 @@ PackageRecipe getPackageRecipe(@NonNull PackageIdentifier pkgId) throws PackageL\n      * @throws PackagingException if fails to find or parse the recipe\n      */\n     PackageMetadata getPackageMetadata(@NonNull PackageIdentifier pkgId) throws PackagingException {\n-        return new PackageMetadata(pkgId, getPackageRecipe(pkgId).getDependencies());\n+        Map<String, String> dependencyMetadata = new HashMap<>();\n+        getPackageRecipe(pkgId).getDependencies().forEach((name, prop) ->\n+                dependencyMetadata.put(name, prop.getVersionRequirements()));\n+        return new PackageMetadata(pkgId, dependencyMetadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abd5e9c7eae611fda27473b73c2c37443063352f"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTY3NzE5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#pullrequestreview-412167719", "createdAt": "2020-05-14T20:40:34Z", "commit": {"oid": "abd5e9c7eae611fda27473b73c2c37443063352f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24dd3678c54978190b17aeb0c5b173943de32c41", "author": {"user": {"login": "hui-yang", "name": "Hui Yang"}}, "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/24dd3678c54978190b17aeb0c5b173943de32c41", "committedDate": "2020-05-14T20:42:04Z", "message": "Merge branch 'master' into soft-dep-recipe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTcyOTcz", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/237#pullrequestreview-412172973", "createdAt": "2020-05-14T20:48:44Z", "commit": {"oid": "24dd3678c54978190b17aeb0c5b173943de32c41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2192, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}