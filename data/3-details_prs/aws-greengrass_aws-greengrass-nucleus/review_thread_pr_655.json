{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4ODgzNTQ1", "number": 655, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMTo1Nzo0N1rOE3f3SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMzozMzo1M1rOE4dKOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NjI5MTkzOnYy", "diffSide": "RIGHT", "path": "src/integrationtests/resources/com/aws/greengrass/integrationtests/ipc/pubsub.yaml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMTo1Nzo0N1rOHw4O5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMTo1Nzo0N1rOHw4O5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNTAxMw==", "bodyText": "noice, much cleaner now.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521015013", "createdAt": "2020-11-11T01:57:47Z", "author": {"login": "MikeDombo"}, "path": "src/integrationtests/resources/com/aws/greengrass/integrationtests/ipc/pubsub.yaml", "diffHunk": "@@ -11,23 +11,16 @@ services:\n   PublishNotSubscribe:\n     parameters:\n       accessControl:\n-        '{\n-          \"aws.greengrass.ipc.pubsub\":[\n-          {\n-            \"policyId1\":{\n-              \"policyDescription\":\"access to pubsub topics for mqtt\",\n-              \"operations\":[\n-                \"aws.greengrass#PublishToTopic\"\n-              ],\n-              \"resources\":[\n-                \"/topic/1/#\",\n-                \"/longer/topic/example/\",\n-                \"*\"\n-              ]\n-            }\n-          }\n-          ]\n-        }'\n+        aws.greengrass.ipc.pubsub:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NjI5NzcwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationPolicy.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMTo1OToxNFrOHw4S4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMjozMjoyMlrOHw5sYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNjAzMw==", "bodyText": "why not use the lombok to string?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521016033", "createdAt": "2020-11-11T01:59:14Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationPolicy.java", "diffHunk": "@@ -5,42 +5,36 @@\n \n package com.aws.greengrass.authorization;\n \n+import lombok.AllArgsConstructor;\n import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n import lombok.NonNull;\n-import lombok.Value;\n \n import java.util.Set;\n \n-@Value\n-@Builder\n+/**\n+ * Class that holds full access control policy which translates to {@link Permission}.\n+ */\n+@Builder(toBuilder = true)\n+@Data\n+@AllArgsConstructor\n+@NoArgsConstructor\n public class AuthorizationPolicy implements Comparable<AuthorizationPolicy> {\n     @NonNull String policyId;\n     String policyDescription;\n     @NonNull Set<String> principals;\n     @NonNull Set<String> operations;\n     Set<String> resources;\n \n-    enum PolicyComponentTypes {\n-        POLICY_DESCRIPTION(\"policyDescription\"),\n-        PRINCIPALS(\"principals\"),\n-        OPERATIONS(\"operations\"),\n-        RESOURCES(\"resources\"),\n-        UNKNOWN(\"unknown\");\n-\n-        private final String name;\n-\n-        PolicyComponentTypes(String s) {\n-            name = s;\n-        }\n-\n-        @Override\n-        public String toString() {\n-            return this.name;\n-        }\n-    }\n-\n     @Override\n     public int compareTo(AuthorizationPolicy other) {\n         return this.policyId.compareTo(other.policyId);\n     }\n+\n+    @Override\n+    public String toString() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAzODk0NQ==", "bodyText": "I was thinking to mask some stuff initially, dont need it now.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521038945", "createdAt": "2020-11-11T02:32:22Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationPolicy.java", "diffHunk": "@@ -5,42 +5,36 @@\n \n package com.aws.greengrass.authorization;\n \n+import lombok.AllArgsConstructor;\n import lombok.Builder;\n+import lombok.Data;\n+import lombok.NoArgsConstructor;\n import lombok.NonNull;\n-import lombok.Value;\n \n import java.util.Set;\n \n-@Value\n-@Builder\n+/**\n+ * Class that holds full access control policy which translates to {@link Permission}.\n+ */\n+@Builder(toBuilder = true)\n+@Data\n+@AllArgsConstructor\n+@NoArgsConstructor\n public class AuthorizationPolicy implements Comparable<AuthorizationPolicy> {\n     @NonNull String policyId;\n     String policyDescription;\n     @NonNull Set<String> principals;\n     @NonNull Set<String> operations;\n     Set<String> resources;\n \n-    enum PolicyComponentTypes {\n-        POLICY_DESCRIPTION(\"policyDescription\"),\n-        PRINCIPALS(\"principals\"),\n-        OPERATIONS(\"operations\"),\n-        RESOURCES(\"resources\"),\n-        UNKNOWN(\"unknown\");\n-\n-        private final String name;\n-\n-        PolicyComponentTypes(String s) {\n-            name = s;\n-        }\n-\n-        @Override\n-        public String toString() {\n-            return this.name;\n-        }\n-    }\n-\n     @Override\n     public int compareTo(AuthorizationPolicy other) {\n         return this.policyId.compareTo(other.policyId);\n     }\n+\n+    @Override\n+    public String toString() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNjAzMw=="}, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NjMwNTE5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/builtin/services/mqttproxy/MqttProxyIPCAgent.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMjowMDo1OVrOHw4Xuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMjozMTo0NFrOHw5qsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNzI3NQ==", "bodyText": "Why have this? Seems like it is going to be noisy when we have debug logs.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521017275", "createdAt": "2020-11-11T02:00:59Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/builtin/services/mqttproxy/MqttProxyIPCAgent.java", "diffHunk": "@@ -211,6 +211,10 @@ void doAuthorization(String opName, String serviceName, String topic) throws Aut\n \n         for (String topicFilter : authorizedResources) {\n             if (topicFilter.equals(ANY_REGEX) || MqttTopic.topicIsSupersetOf(topicFilter, topic)) {\n+                LOGGER.atDebug().log(\"Hit policy with principal {}, operation {}, resource {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAzODUxMw==", "bodyText": "you are right. Need some kind of throttled logs here. probably at trace.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521038513", "createdAt": "2020-11-11T02:31:44Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/greengrass/builtin/services/mqttproxy/MqttProxyIPCAgent.java", "diffHunk": "@@ -211,6 +211,10 @@ void doAuthorization(String opName, String serviceName, String topic) throws Aut\n \n         for (String topicFilter : authorizedResources) {\n             if (topicFilter.equals(ANY_REGEX) || MqttTopic.topicIsSupersetOf(topicFilter, topic)) {\n+                LOGGER.atDebug().log(\"Hit policy with principal {}, operation {}, resource {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNzI3NQ=="}, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NjMwNzA1OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/aws/greengrass/authorization/AuthorizationPolicyParserTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMjowMToyNVrOHw4ZCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMjozMjo1MFrOHw5tWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNzYxMA==", "bodyText": "secret manager should be capitalized SecretsManager", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521017610", "createdAt": "2020-11-11T02:01:25Z", "author": {"login": "MikeDombo"}, "path": "src/test/java/com/aws/greengrass/authorization/AuthorizationPolicyParserTest.java", "diffHunk": "@@ -44,6 +45,7 @@\n @ExtendWith({MockitoExtension.class, GGExtension.class})\n class AuthorizationPolicyParserTest {\n \n+    private final static String SECRET_SERVICE = \"aws.greengrass.secretsManager\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAzOTE5Mw==", "bodyText": "just a component string here, could be \"abcd\". actually i should rename it to random.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r521039193", "createdAt": "2020-11-11T02:32:50Z", "author": {"login": "prateek-y"}, "path": "src/test/java/com/aws/greengrass/authorization/AuthorizationPolicyParserTest.java", "diffHunk": "@@ -44,6 +45,7 @@\n @ExtendWith({MockitoExtension.class, GGExtension.class})\n class AuthorizationPolicyParserTest {\n \n+    private final static String SECRET_SERVICE = \"aws.greengrass.secretsManager\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxNzYxMA=="}, "originalCommit": {"oid": "3de828160f12ddc16bf1a3072d4f9b468f8fc0ff"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NjMzMzk5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMzozMzoxN1rOHyYfTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMDozNzoxMlrOHy-L_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjA3Ng==", "bodyText": "check for what is timestampUpdated or interiorAdded those 2 event types you can safely ignore to save on re-parsing effort.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r522592076", "createdAt": "2020-11-13T03:33:17Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -92,8 +91,8 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n             this.loadAuthorizationPolicies(acl.getKey(), acl.getValue(), false);\n         }\n \n-        //Subscribe to future auth config updates\n-        this.kernel.getConfig().getRoot().subscribe(\n+        // Subscribe to future auth config updates\n+        this.kernel.getConfig().lookupTopics(SERVICES_NAMESPACE_TOPIC).subscribe(\n                 (why, newv) -> {\n                     if (newv == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f05bdb4e485814ded39d580544bbe5dc9338d7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwOTcyNw==", "bodyText": "added", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r523209727", "createdAt": "2020-11-13T20:37:12Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationHandler.java", "diffHunk": "@@ -92,8 +91,8 @@ public AuthorizationHandler(Kernel kernel,  AuthorizationModule authModule,\n             this.loadAuthorizationPolicies(acl.getKey(), acl.getValue(), false);\n         }\n \n-        //Subscribe to future auth config updates\n-        this.kernel.getConfig().getRoot().subscribe(\n+        // Subscribe to future auth config updates\n+        this.kernel.getConfig().lookupTopics(SERVICES_NAMESPACE_TOPIC).subscribe(\n                 (why, newv) -> {\n                     if (newv == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjA3Ng=="}, "originalCommit": {"oid": "43f05bdb4e485814ded39d580544bbe5dc9338d7"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NjMzNDY3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationPolicyParser.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwMzozMzo1M1rOHyYfxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMDozNzowN1rOHy-Lrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjE5Ng==", "bodyText": "why remove case insensitive properties? We should be lenient IMO", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r522592196", "createdAt": "2020-11-13T03:33:53Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationPolicyParser.java", "diffHunk": "@@ -5,41 +5,33 @@\n \n package com.aws.greengrass.authorization;\n \n-import com.aws.greengrass.authorization.AuthorizationPolicy.PolicyComponentTypes;\n import com.aws.greengrass.config.Node;\n import com.aws.greengrass.config.Topic;\n import com.aws.greengrass.config.Topics;\n import com.aws.greengrass.lifecyclemanager.Kernel;\n import com.aws.greengrass.logging.api.Logger;\n import com.aws.greengrass.logging.impl.LogManager;\n-import com.aws.greengrass.util.Coerce;\n import com.aws.greengrass.util.Utils;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.core.type.TypeReference;\n-import com.fasterxml.jackson.databind.MapperFeature;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.json.JsonMapper;\n \n import java.util.ArrayList;\n import java.util.HashMap;\n-import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n-import java.util.Set;\n \n import static com.aws.greengrass.componentmanager.KernelConfigResolver.PARAMETERS_CONFIG_KEY;\n import static com.aws.greengrass.lifecyclemanager.GreengrassService.ACCESS_CONTROL_NAMESPACE_TOPIC;\n import static com.aws.greengrass.lifecyclemanager.GreengrassService.SERVICES_NAMESPACE_TOPIC;\n-import static com.aws.greengrass.util.Coerce.toEnum;\n \n public final class AuthorizationPolicyParser {\n     private static final Logger logger = LogManager.getLogger(AuthorizationPolicyParser.class);\n-    private static final ObjectMapper OBJECT_MAPPER =\n-            JsonMapper.builder().configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true).build();\n+    private static final ObjectMapper OBJECT_MAPPER = JsonMapper.builder().build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f05bdb4e485814ded39d580544bbe5dc9338d7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIwOTY0Ng==", "bodyText": "retained", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/655#discussion_r523209646", "createdAt": "2020-11-13T20:37:07Z", "author": {"login": "prateek-y"}, "path": "src/main/java/com/aws/greengrass/authorization/AuthorizationPolicyParser.java", "diffHunk": "@@ -5,41 +5,33 @@\n \n package com.aws.greengrass.authorization;\n \n-import com.aws.greengrass.authorization.AuthorizationPolicy.PolicyComponentTypes;\n import com.aws.greengrass.config.Node;\n import com.aws.greengrass.config.Topic;\n import com.aws.greengrass.config.Topics;\n import com.aws.greengrass.lifecyclemanager.Kernel;\n import com.aws.greengrass.logging.api.Logger;\n import com.aws.greengrass.logging.impl.LogManager;\n-import com.aws.greengrass.util.Coerce;\n import com.aws.greengrass.util.Utils;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.core.type.TypeReference;\n-import com.fasterxml.jackson.databind.MapperFeature;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.json.JsonMapper;\n \n import java.util.ArrayList;\n import java.util.HashMap;\n-import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n-import java.util.Set;\n \n import static com.aws.greengrass.componentmanager.KernelConfigResolver.PARAMETERS_CONFIG_KEY;\n import static com.aws.greengrass.lifecyclemanager.GreengrassService.ACCESS_CONTROL_NAMESPACE_TOPIC;\n import static com.aws.greengrass.lifecyclemanager.GreengrassService.SERVICES_NAMESPACE_TOPIC;\n-import static com.aws.greengrass.util.Coerce.toEnum;\n \n public final class AuthorizationPolicyParser {\n     private static final Logger logger = LogManager.getLogger(AuthorizationPolicyParser.class);\n-    private static final ObjectMapper OBJECT_MAPPER =\n-            JsonMapper.builder().configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true).build();\n+    private static final ObjectMapper OBJECT_MAPPER = JsonMapper.builder().build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU5MjE5Ng=="}, "originalCommit": {"oid": "43f05bdb4e485814ded39d580544bbe5dc9338d7"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 205, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}