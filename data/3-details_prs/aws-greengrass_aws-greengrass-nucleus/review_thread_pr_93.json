{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMTkxNTA1", "number": 93, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMTozODoyNFrODk0zJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjozNDowMlrODlOjuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTQwMzkxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMTozODoyNFrOFxXdCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMjowMDoxNFrOFxYIKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODgxMQ==", "bodyText": "Should this make sure that the current script is stopped or we kill it if not?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387308811", "createdAt": "2020-03-03T21:38:24Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -149,40 +153,34 @@ protected RunStatus run(Topic t, String cmd, IntConsumer background, Topics conf\n         final ShellRunner shellRunner = context.get(ShellRunner.class);\n         final EZTemplates templateEngine = context.get(EZTemplates.class);\n         cmd = templateEngine.rewrite(cmd).toString();\n-        setStatus(cmd);\n-        if (background == null) {\n-            setStatus(null);\n-        }\n         Exec exec = shellRunner.setup(t.getFullName(), cmd, this);\n-        currentScript = exec;\n-        if (exec != null) { // there's something to run\n-            addEnv(exec, t.parent);\n-            logger.atDebug().setEventType(\"generic-service-run\").log();\n-            RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n-            if (background == null) {\n-                currentScript = null;\n-            }\n-            return ret;\n-        } else {\n+        if (exec == null) {\n             return RunStatus.NothingDone;\n         }\n+        currentScript = exec;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83d3f30ab7ff345cbb31027b629eeb2a3c4a9d33"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxOTE4NQ==", "bodyText": "Updated", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387319185", "createdAt": "2020-03-03T21:58:52Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -149,40 +153,34 @@ protected RunStatus run(Topic t, String cmd, IntConsumer background, Topics conf\n         final ShellRunner shellRunner = context.get(ShellRunner.class);\n         final EZTemplates templateEngine = context.get(EZTemplates.class);\n         cmd = templateEngine.rewrite(cmd).toString();\n-        setStatus(cmd);\n-        if (background == null) {\n-            setStatus(null);\n-        }\n         Exec exec = shellRunner.setup(t.getFullName(), cmd, this);\n-        currentScript = exec;\n-        if (exec != null) { // there's something to run\n-            addEnv(exec, t.parent);\n-            logger.atDebug().setEventType(\"generic-service-run\").log();\n-            RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n-            if (background == null) {\n-                currentScript = null;\n-            }\n-            return ret;\n-        } else {\n+        if (exec == null) {\n             return RunStatus.NothingDone;\n         }\n+        currentScript = exec;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODgxMQ=="}, "originalCommit": {"oid": "83d3f30ab7ff345cbb31027b629eeb2a3c4a9d33"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxOTg0OA==", "bodyText": "Added a new variable 'runScript' . there could be 2 scripts running at the same time (\"run\" and \"shutdown\"), therefore currentScript doesn't cancel the previous one.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387319848", "createdAt": "2020-03-03T22:00:14Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -149,40 +153,34 @@ protected RunStatus run(Topic t, String cmd, IntConsumer background, Topics conf\n         final ShellRunner shellRunner = context.get(ShellRunner.class);\n         final EZTemplates templateEngine = context.get(EZTemplates.class);\n         cmd = templateEngine.rewrite(cmd).toString();\n-        setStatus(cmd);\n-        if (background == null) {\n-            setStatus(null);\n-        }\n         Exec exec = shellRunner.setup(t.getFullName(), cmd, this);\n-        currentScript = exec;\n-        if (exec != null) { // there's something to run\n-            addEnv(exec, t.parent);\n-            logger.atDebug().setEventType(\"generic-service-run\").log();\n-            RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n-            if (background == null) {\n-                currentScript = null;\n-            }\n-            return ret;\n-        } else {\n+        if (exec == null) {\n             return RunStatus.NothingDone;\n         }\n+        currentScript = exec;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODgxMQ=="}, "originalCommit": {"oid": "83d3f30ab7ff345cbb31027b629eeb2a3c4a9d33"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTQzODQ4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/util/Exec.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMTo0OToxNFrOFxXypA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMTo1Nzo1M1rOFxYDmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNDM0MA==", "bodyText": "Do we really want to block forever here? That is the opposite of the original implementation. Just want to make sure that the result of this change was considered.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387314340", "createdAt": "2020-03-03T21:49:14Z", "author": {"login": "MikeDombo"}, "path": "src/main/java/com/aws/iot/evergreen/util/Exec.java", "diffHunk": "@@ -314,9 +314,13 @@ private void exec() {\n             stdoutc.start();\n             if (whenDone == null) {\n                 try {\n-                    if (!process.waitFor(timeout, timeunit)) {\n-                        (stderr != null ? stderr : stdout).accept(\"\\n[TIMEOUT]\\n\");\n-                        process.destroyForcibly();\n+                    if (timeout < 0) {\n+                        process.waitFor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83d3f30ab7ff345cbb31027b629eeb2a3c4a9d33"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxODY4MA==", "bodyText": "EvergreenService calling backingTask.cancel() will interrupt this and cause process.destroyForcibly().", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387318680", "createdAt": "2020-03-03T21:57:53Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/util/Exec.java", "diffHunk": "@@ -314,9 +314,13 @@ private void exec() {\n             stdoutc.start();\n             if (whenDone == null) {\n                 try {\n-                    if (!process.waitFor(timeout, timeunit)) {\n-                        (stderr != null ? stderr : stdout).accept(\"\\n[TIMEOUT]\\n\");\n-                        process.destroyForcibly();\n+                    if (timeout < 0) {\n+                        process.waitFor();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNDM0MA=="}, "originalCommit": {"oid": "83d3f30ab7ff345cbb31027b629eeb2a3c4a9d33"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMDE3MjE2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMzowNzoyNFrOFxeo6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMzowMTowN1rOFyAytA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQyNjUzNg==", "bodyText": "Can the current script be not the exec for run due to race conditions ? example: run called and shutdown was called before this assignment happened.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387426536", "createdAt": "2020-03-04T03:07:24Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -99,9 +96,14 @@ public void startup() {\n                         logger.atError().setEventType(\"generic-service-errored\").addKeyValue(\"exitCode\", exit).log();\n                     }\n                 }\n-            }) == RunStatus.NothingDone) {\n-                logger.atInfo().setEventType(\"generic-service-finished\").log(\"Nothing done\");\n+            });\n+            runScript = currentScript;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "051945eb3569f2b9d5faa427be771c6e04445b31"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4MjY0Mw==", "bodyText": "Yes that's possible. currentScript points to \"shutdown\", runScript points to \"run\" , and both are under execution. The reason I created two variables is to handle this situation. The intention is we want 'shutdown' to run first to gracefully shutdown the service, before we try to kill the running process .", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387982643", "createdAt": "2020-03-04T22:52:11Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -99,9 +96,14 @@ public void startup() {\n                         logger.atError().setEventType(\"generic-service-errored\").addKeyValue(\"exitCode\", exit).log();\n                     }\n                 }\n-            }) == RunStatus.NothingDone) {\n-                logger.atInfo().setEventType(\"generic-service-finished\").log(\"Nothing done\");\n+            });\n+            runScript = currentScript;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQyNjUzNg=="}, "originalCommit": {"oid": "051945eb3569f2b9d5faa427be771c6e04445b31"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NjEwMA==", "bodyText": "Can if return the exec instead of the current approach with currentScript. I think that would make the code a bit more readable and avoids the race conditions", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387986100", "createdAt": "2020-03-04T23:01:07Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -99,9 +96,14 @@ public void startup() {\n                         logger.atError().setEventType(\"generic-service-errored\").addKeyValue(\"exitCode\", exit).log();\n                     }\n                 }\n-            }) == RunStatus.NothingDone) {\n-                logger.atInfo().setEventType(\"generic-service-finished\").log(\"Nothing done\");\n+            });\n+            runScript = currentScript;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQyNjUzNg=="}, "originalCommit": {"oid": "051945eb3569f2b9d5faa427be771c6e04445b31"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMDQ1Mzg1OnYy", "diffSide": "RIGHT", "path": "src/test/resources/com/aws/iot/evergreen/kernel/config.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjozMDozNFrOFxhWOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxODo0NDo0OVrOFx5KZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ3MDkwNA==", "bodyText": "Why 17, why did this need to be changed?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387470904", "createdAt": "2020-03-04T06:30:34Z", "author": {"login": "MikeDombo"}, "path": "src/test/resources/com/aws/iot/evergreen/kernel/config.yaml", "diffHunk": "@@ -131,7 +131,7 @@ main:\n     pwd\n     printenv\n     while true; do\n-    date; sleep 5; echo RUNNING\n+    date; sleep 17; echo HI_RUNNING", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "051945eb3569f2b9d5faa427be771c6e04445b31"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg2MTA5NQ==", "bodyText": "Ah this is my local test. I have a bunch of zombie sleep 5 process on my laptop", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387861095", "createdAt": "2020-03-04T18:44:49Z", "author": {"login": "ShirleyZheng92"}, "path": "src/test/resources/com/aws/iot/evergreen/kernel/config.yaml", "diffHunk": "@@ -131,7 +131,7 @@ main:\n     pwd\n     printenv\n     while true; do\n-    date; sleep 5; echo RUNNING\n+    date; sleep 17; echo HI_RUNNING", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ3MDkwNA=="}, "originalCommit": {"oid": "051945eb3569f2b9d5faa427be771c6e04445b31"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzA4NTE3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTozNjoyOVrOFx64bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo1MTozMlrOFx9K_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4OTI2Mg==", "bodyText": "Can we add a note here how currentScript and runScript should be used respectively?", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387889262", "createdAt": "2020-03-04T19:36:29Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -27,6 +27,7 @@\n     private static final Pattern skipcmd = Pattern.compile(\"(exists|onpath) +(.+)\");\n     private boolean inShutdown;\n     private Exec currentScript;\n+    private Exec runScript;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "051945eb3569f2b9d5faa427be771c6e04445b31"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNjc4MQ==", "bodyText": "currentScript is the Exec that's under run now. runScript is the script defined in \"startup\" or \"run\" block.\nwhen service is installing, currentScript = \"install\" block , runScript = null;\nwhen service is running , currentScript = runScript = \"run\"/\"startup\" block\nwhen service is shutting down, currentScript = \"shutdown\" block, runscript = \"run\"/\"startup\" block , both can be running\nI'll add a note", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387926781", "createdAt": "2020-03-04T20:51:32Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -27,6 +27,7 @@\n     private static final Pattern skipcmd = Pattern.compile(\"(exists|onpath) +(.+)\");\n     private boolean inShutdown;\n     private Exec currentScript;\n+    private Exec runScript;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4OTI2Mg=="}, "originalCommit": {"oid": "051945eb3569f2b9d5faa427be771c6e04445b31"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzExNjgyOnYy", "diffSide": "LEFT", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTo0NjowMlrOFx7Mzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMDo0Nzo1NlrOFx9EcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5NDQ3OQ==", "bodyText": "Correct me if I'm wrong, serviceErrored(); will keep track of the error and try to recover later, while direct reportState() will not.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387894479", "createdAt": "2020-03-04T19:46:02Z", "author": {"login": "hui-yang"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -149,40 +157,34 @@ protected RunStatus run(Topic t, String cmd, IntConsumer background, Topics conf\n         final ShellRunner shellRunner = context.get(ShellRunner.class);\n         final EZTemplates templateEngine = context.get(EZTemplates.class);\n         cmd = templateEngine.rewrite(cmd).toString();\n-        setStatus(cmd);\n-        if (background == null) {\n-            setStatus(null);\n-        }\n         Exec exec = shellRunner.setup(t.getFullName(), cmd, this);\n-        currentScript = exec;\n-        if (exec != null) { // there's something to run\n-            addEnv(exec, t.parent);\n-            logger.atDebug().setEventType(\"generic-service-run\").log();\n-            RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n-            if (background == null) {\n-                currentScript = null;\n-            }\n-            return ret;\n-        } else {\n+        if (exec == null) {\n             return RunStatus.NothingDone;\n         }\n+        currentScript = exec;\n+        addEnv(exec, t.parent);\n+        logger.atDebug().setEventType(\"generic-service-run\").log();\n+        RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n+        if (background == null) {\n+            currentScript = null;\n+        }\n+        return ret;\n     }\n \n     protected RunStatus run(Topics t, IntConsumer background) {\n-        if (!shouldSkip(t)) {\n-            Node script = t.getChild(\"script\");\n-            if (script instanceof Topic) {\n-                return run((Topic) script, background, t);\n-            } else {\n-                logger.atError().setEventType(\"generic-service-invalid-config\")\n-                        .addKeyValue(\"configNode\", t.getFullName()).log(\"Missing script\");\n-                serviceErrored();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "051945eb3569f2b9d5faa427be771c6e04445b31"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTEwNQ==", "bodyText": "serviceErrored(throwable t) does what you said, which keeps track and log error.\nserviceError() is same as reportState(Error) .\nBoth will trigger error recovery.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387925105", "createdAt": "2020-03-04T20:47:56Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -149,40 +157,34 @@ protected RunStatus run(Topic t, String cmd, IntConsumer background, Topics conf\n         final ShellRunner shellRunner = context.get(ShellRunner.class);\n         final EZTemplates templateEngine = context.get(EZTemplates.class);\n         cmd = templateEngine.rewrite(cmd).toString();\n-        setStatus(cmd);\n-        if (background == null) {\n-            setStatus(null);\n-        }\n         Exec exec = shellRunner.setup(t.getFullName(), cmd, this);\n-        currentScript = exec;\n-        if (exec != null) { // there's something to run\n-            addEnv(exec, t.parent);\n-            logger.atDebug().setEventType(\"generic-service-run\").log();\n-            RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n-            if (background == null) {\n-                currentScript = null;\n-            }\n-            return ret;\n-        } else {\n+        if (exec == null) {\n             return RunStatus.NothingDone;\n         }\n+        currentScript = exec;\n+        addEnv(exec, t.parent);\n+        logger.atDebug().setEventType(\"generic-service-run\").log();\n+        RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n+        if (background == null) {\n+            currentScript = null;\n+        }\n+        return ret;\n     }\n \n     protected RunStatus run(Topics t, IntConsumer background) {\n-        if (!shouldSkip(t)) {\n-            Node script = t.getChild(\"script\");\n-            if (script instanceof Topic) {\n-                return run((Topic) script, background, t);\n-            } else {\n-                logger.atError().setEventType(\"generic-service-invalid-config\")\n-                        .addKeyValue(\"configNode\", t.getFullName()).log(\"Missing script\");\n-                serviceErrored();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5NDQ3OQ=="}, "originalCommit": {"oid": "051945eb3569f2b9d5faa427be771c6e04445b31"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzYwODIyOnYy", "diffSide": "LEFT", "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjoyNzo1OVrOFx_-xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMzoyNToxNFrOFyBUPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MjgwNg==", "bodyText": "This is used in the httpserver and cli, might want to update that", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387972806", "createdAt": "2020-03-04T22:27:59Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -62,7 +62,6 @@\n     private Future backingTask;\n     private Periodicity periodicityInformation;\n     private State prevState = State.NEW;\n-    private String status;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07591e05326346e00c8ab67c4f8158275af571a7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5NDY4Ng==", "bodyText": "Ok. The reason I removed this is it's confusing against 'State' variable", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387994686", "createdAt": "2020-03-04T23:25:14Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/EvergreenService.java", "diffHunk": "@@ -62,7 +62,6 @@\n     private Future backingTask;\n     private Periodicity periodicityInformation;\n     private State prevState = State.NEW;\n-    private String status;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MjgwNg=="}, "originalCommit": {"oid": "07591e05326346e00c8ab67c4f8158275af571a7"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzYyNDI0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjozNDowMlrOFyAI7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMzowNDowMVrOFyA21g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NTQwNg==", "bodyText": "Can a race condition cause this currentScript to change between L165 and L170", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387975406", "createdAt": "2020-03-04T22:34:02Z", "author": {"login": "fahadmohammed01"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -149,40 +158,34 @@ protected RunStatus run(Topic t, String cmd, IntConsumer background, Topics conf\n         final ShellRunner shellRunner = context.get(ShellRunner.class);\n         final EZTemplates templateEngine = context.get(EZTemplates.class);\n         cmd = templateEngine.rewrite(cmd).toString();\n-        setStatus(cmd);\n-        if (background == null) {\n-            setStatus(null);\n-        }\n         Exec exec = shellRunner.setup(t.getFullName(), cmd, this);\n-        currentScript = exec;\n-        if (exec != null) { // there's something to run\n-            addEnv(exec, t.parent);\n-            logger.atDebug().setEventType(\"generic-service-run\").log();\n-            RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n-            if (background == null) {\n-                currentScript = null;\n-            }\n-            return ret;\n-        } else {\n+        if (exec == null) {\n             return RunStatus.NothingDone;\n         }\n+        currentScript = exec;\n+        addEnv(exec, t.parent);\n+        logger.atDebug().setEventType(\"generic-service-run\").log();\n+        RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n+        if (background == null) {\n+            currentScript = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07591e05326346e00c8ab67c4f8158275af571a7"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NzE1OA==", "bodyText": "Not in this implementation. currentScript = null only happens in background == null, in this case is install() and shutdown() . These methods are blocking in the lifecycle thread. I updated the PR to make sure that runScript tracks the running Exec before reportState(Running).\nHowever I agree the run() method here isn't thread safe.", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/93#discussion_r387987158", "createdAt": "2020-03-04T23:04:01Z", "author": {"login": "ShirleyZheng92"}, "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -149,40 +158,34 @@ protected RunStatus run(Topic t, String cmd, IntConsumer background, Topics conf\n         final ShellRunner shellRunner = context.get(ShellRunner.class);\n         final EZTemplates templateEngine = context.get(EZTemplates.class);\n         cmd = templateEngine.rewrite(cmd).toString();\n-        setStatus(cmd);\n-        if (background == null) {\n-            setStatus(null);\n-        }\n         Exec exec = shellRunner.setup(t.getFullName(), cmd, this);\n-        currentScript = exec;\n-        if (exec != null) { // there's something to run\n-            addEnv(exec, t.parent);\n-            logger.atDebug().setEventType(\"generic-service-run\").log();\n-            RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n-            if (background == null) {\n-                currentScript = null;\n-            }\n-            return ret;\n-        } else {\n+        if (exec == null) {\n             return RunStatus.NothingDone;\n         }\n+        currentScript = exec;\n+        addEnv(exec, t.parent);\n+        logger.atDebug().setEventType(\"generic-service-run\").log();\n+        RunStatus ret = shellRunner.successful(exec, cmd, background) ? RunStatus.OK : RunStatus.Errored;\n+        if (background == null) {\n+            currentScript = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NTQwNg=="}, "originalCommit": {"oid": "07591e05326346e00c8ab67c4f8158275af571a7"}, "originalPosition": 122}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4847, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}