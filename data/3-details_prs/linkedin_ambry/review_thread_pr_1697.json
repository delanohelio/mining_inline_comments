{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyODg0MzQ2", "number": 1697, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNjozMDozNlrOE6asEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMjoyOTo0M1rOE62Q7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NjkwMTI5OnYy", "diffSide": "LEFT", "path": "ambry-account/src/main/java/com/github/ambry/account/AbstractAccountService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNjozMDozNlrOH1e5BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzoyMjowOVrOH2GUCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0MjY5Mg==", "bodyText": "Does this need to be changed?  I thought only account version was out of sync.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r525842692", "createdAt": "2020-11-18T06:30:36Z", "author": {"login": "lightningrob"}, "path": "ambry-account/src/main/java/com/github/ambry/account/AbstractAccountService.java", "diffHunk": "@@ -141,11 +142,6 @@ public Account getAccountById(short id) {\n               \"In account \" + accountName + \", container \" + container.getName() + \" has containerId \"\n                   + existingContainer.getId() + \" (\" + container.getId() + \" was supplied)\",\n               AccountServiceErrorCode.ResourceConflict);\n-        } else if (existingContainer.getSnapshotVersion() != container.getSnapshotVersion()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMwNjA1OA==", "bodyText": "+1", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526306058", "createdAt": "2020-11-18T17:58:15Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/AbstractAccountService.java", "diffHunk": "@@ -141,11 +142,6 @@ public Account getAccountById(short id) {\n               \"In account \" + accountName + \", container \" + container.getName() + \" has containerId \"\n                   + existingContainer.getId() + \" (\" + container.getId() + \" was supplied)\",\n               AccountServiceErrorCode.ResourceConflict);\n-        } else if (existingContainer.getSnapshotVersion() != container.getSnapshotVersion()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0MjY5Mg=="}, "originalCommit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ4ODU4Ng==", "bodyText": "Discussed offline.  This does need to be adjusted.  Please use the mentioned config property (after moving to base class) to toggle the behavior.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526488586", "createdAt": "2020-11-18T23:22:09Z", "author": {"login": "lightningrob"}, "path": "ambry-account/src/main/java/com/github/ambry/account/AbstractAccountService.java", "diffHunk": "@@ -141,11 +142,6 @@ public Account getAccountById(short id) {\n               \"In account \" + accountName + \", container \" + container.getName() + \" has containerId \"\n                   + existingContainer.getId() + \" (\" + container.getId() + \" was supplied)\",\n               AccountServiceErrorCode.ResourceConflict);\n-        } else if (existingContainer.getSnapshotVersion() != container.getSnapshotVersion()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0MjY5Mg=="}, "originalCommit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NjkyMDI3OnYy", "diffSide": "RIGHT", "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNjozODozNFrOH1fEFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxODowODoxMlrOH17j8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0NTUyNw==", "bodyText": "Can we make ignoreAccountVersion a mysql config property?  That way we won't need to change the code later.  Default can be false and override in config when composite AS is used.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r525845527", "createdAt": "2020-11-18T06:38:34Z", "author": {"login": "lightningrob"}, "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "diffHunk": "@@ -249,14 +249,16 @@ public void updateAccounts(Collection<Account> accounts) throws AccountServiceEx\n     infoMapLock.readLock().lock();\n     try {\n       AccountInfoMap accountInfoMap = accountInfoMapRef.get();\n-      if (accountInfoMap.hasConflictingAccount(accounts)) {\n+      //TODO: Temporarily disabling version check with CompositeAccountService enabled. Remove it after moving to MySql only.\n+      if (accountInfoMap.hasConflictingAccount(accounts, true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMxMjQzNQ==", "bodyText": "Right, config seems to be better. This is one-off migration and we can keep the default value false after it's complete.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526312435", "createdAt": "2020-11-18T18:08:12Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "diffHunk": "@@ -249,14 +249,16 @@ public void updateAccounts(Collection<Account> accounts) throws AccountServiceEx\n     infoMapLock.readLock().lock();\n     try {\n       AccountInfoMap accountInfoMap = accountInfoMapRef.get();\n-      if (accountInfoMap.hasConflictingAccount(accounts)) {\n+      //TODO: Temporarily disabling version check with CompositeAccountService enabled. Remove it after moving to MySql only.\n+      if (accountInfoMap.hasConflictingAccount(accounts, true)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0NTUyNw=="}, "originalCommit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTAyOTE4OnYy", "diffSide": "RIGHT", "path": "ambry-api/src/main/java/com/github/ambry/config/MySqlAccountServiceConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzozNDo1M1rOH2GlwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzozNDo1M1rOH2GlwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5MzEyMQ==", "bodyText": "I would move this to base AccountServiceConfig class so AbstractAccountService can also use it.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526493121", "createdAt": "2020-11-18T23:34:53Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/config/MySqlAccountServiceConfig.java", "diffHunk": "@@ -97,6 +98,13 @@\n   @Default(\"false\")\n   public final boolean updateDisabled;\n \n+  /**\n+   * If true, MySqlAccountService would ignore version mismatch while updating Accounts and Containers.\n+   */\n+  @Config(IGNORE_VERSION_MISMATCH)\n+  @Default(\"false\")\n+  public final boolean ignoreVersionMismatch;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "824449255240e6e8dbb356e23c2b9ef8a08a4d73"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTA4NDY1OnYy", "diffSide": "RIGHT", "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo1NzoyNlrOH2HHWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo1NzoyNlrOH2HHWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMTcyMg==", "bodyText": "minor: can you print out  account name instead of account id?\nAlso account.getAllContainers() can be replaced with resolvedContainers", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526501722", "createdAt": "2020-11-18T23:57:26Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "diffHunk": "@@ -340,6 +341,23 @@ ExecutorService getScheduler() {\n   @Override\n   protected void updateResolvedContainers(Account account, Collection<Container> resolvedContainers)\n       throws AccountServiceException {\n+\n+    // Check for name/id/version conflicts for containers being updated with those in local cache.\n+    infoMapLock.readLock().lock();\n+    try {\n+      if (accountInfoMapRef.get()\n+          .hasConflictingContainer(resolvedContainers, account.getId(), config.ignoreVersionMismatch)) {\n+        logger.error(\n+            \"Containers={} under Account={} conflict with the containers in local cache. Cancel the update operation.\",\n+            account.getAllContainers(), account.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "824449255240e6e8dbb356e23c2b9ef8a08a4d73"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTQxOTM0OnYy", "diffSide": "RIGHT", "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMjoyOTo0M1rOH2KLTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMjoyOTo0M1rOH2KLTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU1MTg4NA==", "bodyText": "I'm wondering if this will be a problem when we switch to mysql primary and Helix secondary.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526551884", "createdAt": "2020-11-19T02:29:43Z", "author": {"login": "lightningrob"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -289,7 +289,7 @@ void updateAccountsWithAccountMetadataStore(Collection<Account> accounts, Accoun\n     // update operation for all the accounts if any conflict exists. There is a slight chance that the account to update\n     // conflicts with the accounts in the local cache, but does not conflict with those in the helixPropertyStore. This\n     // will happen if some accounts are updated but the local cache is not refreshed.\n-    if (accountInfoMapRef.get().hasConflictingAccount(accounts)) {\n+    if (accountInfoMapRef.get().hasConflictingAccount(accounts, false)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0faf6aada9374159dfb87383fc91bf3b1d9a3b11"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1135, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}