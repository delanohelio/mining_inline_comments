{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1OTEwNTk5", "number": 1422, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMTowNTozN1rODnQGeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNToyMToxMlrODnViHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNDg0ODU2OnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/test/java/com.github.ambry.replication/InMemoryStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMTowNTozN1rOF1JE6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMToyNTo0MFrOF1Jqjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI2NzU2MQ==", "bodyText": "Just want to make sure one thing. For V2 and V2, info.getLifeVersion() returns -1, right?", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391267561", "createdAt": "2020-03-11T21:05:37Z", "author": {"login": "zzmao"}, "path": "ambry-replication/src/test/java/com.github.ambry.replication/InMemoryStore.java", "diffHunk": "@@ -264,7 +264,7 @@ public void updateTtl(List<MessageInfo> infos) throws StoreException {\n         }\n         MessageFormatInputStream stream =\n             new TtlUpdateMessageFormatInputStream(info.getStoreKey(), info.getAccountId(), info.getContainerId(),\n-                info.getExpirationTimeInMs(), info.getOperationTimeMs());\n+                info.getExpirationTimeInMs(), info.getOperationTimeMs(), info.getLifeVersion());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI3NzE5OQ==", "bodyText": "it returns 0 here. 0 should be the lifeVersion to be persisted in the log.", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391277199", "createdAt": "2020-03-11T21:25:40Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-replication/src/test/java/com.github.ambry.replication/InMemoryStore.java", "diffHunk": "@@ -264,7 +264,7 @@ public void updateTtl(List<MessageInfo> infos) throws StoreException {\n         }\n         MessageFormatInputStream stream =\n             new TtlUpdateMessageFormatInputStream(info.getStoreKey(), info.getAccountId(), info.getContainerId(),\n-                info.getExpirationTimeInMs(), info.getOperationTimeMs());\n+                info.getExpirationTimeInMs(), info.getOperationTimeMs(), info.getLifeVersion());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI2NzU2MQ=="}, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTY3NzUyOnYy", "diffSide": "RIGHT", "path": "ambry-messageformat/src/main/java/com.github.ambry.messageformat/PutMessageFormatInputStream.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDozNjo1NFrOF1Q_Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDozNjo1NFrOF1Q_Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5NzIyMw==", "bodyText": "can be removed", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391397223", "createdAt": "2020-03-12T04:36:54Z", "author": {"login": "jsjtzyy"}, "path": "ambry-messageformat/src/main/java/com.github.ambry.messageformat/PutMessageFormatInputStream.java", "diffHunk": "@@ -13,6 +13,7 @@\n  */\n package com.github.ambry.messageformat;\n \n+import com.github.ambry.store.Message;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTY4MjI2OnYy", "diffSide": "RIGHT", "path": "ambry-messageformat/src/main/java/com.github.ambry.messageformat/PutMessageFormatInputStream.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo0MTowMlrOF1RCVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo0MTowMlrOF1RCVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5Nzk3Mw==", "bodyText": "you can change this to:\nthis(key, blobEncryptionKey, blobProperties, userMetadata, blobStream, streamSize, BlobType.DataBlob, (short) 0);\n\navoiding an extra method call.", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391397973", "createdAt": "2020-03-12T04:41:02Z", "author": {"login": "jsjtzyy"}, "path": "ambry-messageformat/src/main/java/com.github.ambry.messageformat/PutMessageFormatInputStream.java", "diffHunk": "@@ -43,27 +44,33 @@\n   public PutMessageFormatInputStream(StoreKey key, ByteBuffer blobEncryptionKey, BlobProperties blobProperties,\n       ByteBuffer userMetadata, InputStream blobStream, long streamSize, BlobType blobType)\n       throws MessageFormatException {\n-    if (MessageFormatRecord.headerVersionToUse == MessageFormatRecord.Message_Header_Version_V2) {\n-      createStreamWithMessageHeaderV2(key, blobEncryptionKey, blobProperties, userMetadata, blobStream, streamSize,\n-          blobType);\n-    } else {\n-      createStreamWithMessageHeaderV1(key, blobProperties, userMetadata, blobStream, streamSize, blobType);\n-    }\n+    this(key, blobEncryptionKey, blobProperties, userMetadata, blobStream, streamSize, blobType, (short) 0);\n   }\n \n   public PutMessageFormatInputStream(StoreKey key, ByteBuffer blobEncryptionKey, BlobProperties blobProperties,\n       ByteBuffer userMetadata, InputStream blobStream, long streamSize) throws MessageFormatException {\n     this(key, blobEncryptionKey, blobProperties, userMetadata, blobStream, streamSize, BlobType.DataBlob);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTcyOTgzOnYy", "diffSide": "RIGHT", "path": "ambry-store/src/main/java/com.github.ambry.store/BlobStore.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNToxNTowM1rOF1Re3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMjozMzoxMVrOF1yLHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwNTI3Ng==", "bodyText": "nit: could you change ind to index?", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391405276", "createdAt": "2020-03-12T05:15:03Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/main/java/com.github.ambry.store/BlobStore.java", "diffHunk": "@@ -507,14 +507,9 @@ public void delete(List<MessageInfo> infosToDelete) throws StoreException {\n         List<MessageInfo> updatedInfos = new ArrayList<>(infosToDelete.size());\n         int ind = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgzODQwNA==", "bodyText": "we already have a member variable named \"index\", it's persistentIndex in the blobstore. I guess I can just name this variable to \"i\" if you desire.", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391838404", "createdAt": "2020-03-12T19:17:31Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-store/src/main/java/com.github.ambry.store/BlobStore.java", "diffHunk": "@@ -507,14 +507,9 @@ public void delete(List<MessageInfo> infosToDelete) throws StoreException {\n         List<MessageInfo> updatedInfos = new ArrayList<>(infosToDelete.size());\n         int ind = 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwNTI3Ng=="}, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0MDg5Mw==", "bodyText": "yeah, \"i\" makes less ambiguity.", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391940893", "createdAt": "2020-03-12T22:33:11Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/main/java/com.github.ambry.store/BlobStore.java", "diffHunk": "@@ -507,14 +507,9 @@ public void delete(List<MessageInfo> infosToDelete) throws StoreException {\n         List<MessageInfo> updatedInfos = new ArrayList<>(infosToDelete.size());\n         int ind = 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwNTI3Ng=="}, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTczNjAzOnYy", "diffSide": "RIGHT", "path": "ambry-store/src/main/java/com.github.ambry.store/BlobStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNToxOTozMFrOF1Ring==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxOToxNzozN1rOF1r7Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwNjIzOA==", "bodyText": "same here", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391406238", "createdAt": "2020-03-12T05:19:30Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/main/java/com.github.ambry.store/BlobStore.java", "diffHunk": "@@ -619,16 +614,9 @@ public void updateTtl(List<MessageInfo> infosToUpdate) throws StoreException {\n         List<MessageInfo> updatedInfos = new ArrayList<>(infosToUpdate.size());\n         int ind = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgzODQ3MQ==", "bodyText": "above.", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391838471", "createdAt": "2020-03-12T19:17:37Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-store/src/main/java/com.github.ambry.store/BlobStore.java", "diffHunk": "@@ -619,16 +614,9 @@ public void updateTtl(List<MessageInfo> infosToUpdate) throws StoreException {\n         List<MessageInfo> updatedInfos = new ArrayList<>(infosToUpdate.size());\n         int ind = 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwNjIzOA=="}, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTczODUzOnYy", "diffSide": "RIGHT", "path": "ambry-tools/src/main/java/com.github.ambry/store/DumpDataHelper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNToyMToxMlrOF1RkHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxOToxODo0MFrOF1r9IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwNjYyMg==", "bodyText": "Could you explain \"- 2\" here?", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391406622", "createdAt": "2020-03-12T05:21:12Z", "author": {"login": "jsjtzyy"}, "path": "ambry-tools/src/main/java/com.github.ambry/store/DumpDataHelper.java", "diffHunk": "@@ -92,6 +92,20 @@ static LogBlobRecordInfo readSingleRecordFromLog(RandomAccessFile randomAccessFi\n                 + header.getUserMetadataRecordRelativeOffset() + \" dataRelativeOffset \"\n                 + header.getBlobRecordRelativeOffset() + \" crc \" + header.getCrc();\n         totalRecordSize += header.getMessageSize() + buffer.capacity();\n+      } else if (version == MessageFormatRecord.Message_Header_Version_V3) {\n+        ByteBuffer buffer = ByteBuffer.allocate(MessageFormatRecord.MessageHeader_Format_V3.getHeaderSize());\n+        buffer.putShort(version);\n+        randomAccessFile.read(buffer.array(), 2, buffer.capacity() - 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgzOTAwOQ==", "bodyText": "2 is the number of bytes to store header version (it's a short). I copy this code from case above.", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391839009", "createdAt": "2020-03-12T19:18:40Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-tools/src/main/java/com.github.ambry/store/DumpDataHelper.java", "diffHunk": "@@ -92,6 +92,20 @@ static LogBlobRecordInfo readSingleRecordFromLog(RandomAccessFile randomAccessFi\n                 + header.getUserMetadataRecordRelativeOffset() + \" dataRelativeOffset \"\n                 + header.getBlobRecordRelativeOffset() + \" crc \" + header.getCrc();\n         totalRecordSize += header.getMessageSize() + buffer.capacity();\n+      } else if (version == MessageFormatRecord.Message_Header_Version_V3) {\n+        ByteBuffer buffer = ByteBuffer.allocate(MessageFormatRecord.MessageHeader_Format_V3.getHeaderSize());\n+        buffer.putShort(version);\n+        randomAccessFile.read(buffer.array(), 2, buffer.capacity() - 2);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwNjYyMg=="}, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1416, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}