{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0NDcxNTM5", "number": 1382, "title": "Minor changes to support recovering from replica addition failure", "bodyText": "This PR adds minor changes to resume dynamic replica addition if it failed last time before updating InstanceConfig(clustermap update in Helix). The logic is simple: if diskManager finds there is a existing\ndirectory associated with replica to add, it first deletes it and recreates a new one. (The files in previous directory may not be reliable)", "createdAt": "2020-02-12T18:53:07Z", "url": "https://github.com/linkedin/ambry/pull/1382", "merged": true, "mergeCommit": {"oid": "042bcd560daa13da2a08be40177fcf37065f5400"}, "closed": true, "closedAt": "2020-02-15T01:35:28Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDq7FMAH2gAyMzc0NDcxNTM5OmIxYjNlYjkwMjVlYWM3YjNlNzBiNTE4ZTkwN2JlNWM0ZmEyNGZiM2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEZ6teAFqTM1OTI5NDA4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b1b3eb9025eac7b3e70b518e907be5c4fa24fb3d", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/b1b3eb9025eac7b3e70b518e907be5c4fa24fb3d", "committedDate": "2020-02-12T18:48:24Z", "message": "Minor changes to support recovering from replica addition failure\n\nThis PR adds minor changes to resume dynamic replica addition if it\nfailed last time before updating InstanceConfig(clustermap update in\nHelix). The logic is simple: if diskManager finds there is a existing\ndir associated with replica to add, it first deletes it and recreates a\nnew one. (The files in previous dir may not be reliable)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDQ0NTEx", "url": "https://github.com/linkedin/ambry/pull/1382#pullrequestreview-358444511", "createdAt": "2020-02-13T18:18:26Z", "commit": {"oid": "b1b3eb9025eac7b3e70b518e907be5c4fa24fb3d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODoxODoyNlrOFped0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODoxODoyNlrOFped0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzNTA4OQ==", "bodyText": "Just validating my though?\nIs the assumption here that, if there is some old state of a replica on a node's storage, and storage manager or disk manager don't know about it, then it could be a corrupted state, and hence remove it.\nThe existing state might help in case where let's say a node crashed and comes back up after sometime, and is assigned same replica back again. In this case, even though there is some state on disk, we will delete it. The state on disk might have helped this replica in catching up with existing replicas quicker. But I assuming that we are ignoring this scenario because we don't have a way to identify this scenario. Is this correct?", "url": "https://github.com/linkedin/ambry/pull/1382#discussion_r379035089", "createdAt": "2020-02-13T18:18:26Z", "author": {"login": "ankagrawal"}, "path": "ambry-store/src/main/java/com.github.ambry.store/DiskManager.java", "diffHunk": "@@ -311,11 +312,23 @@ boolean addBlobStore(ReplicaId replica) {\n       if (!running) {\n         logger.error(\"Failed to add {} because disk manager is not running\", replica.getPartitionId());\n       } else {\n+        // Clean up existing dir associated with this replica to add. Here we re-create a new store because we don't\n+        // know the state of files in old directory. (The old directory was created last time when adding this replica", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1b3eb9025eac7b3e70b518e907be5c4fa24fb3d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5Mjk0MDg4", "url": "https://github.com/linkedin/ambry/pull/1382#pullrequestreview-359294088", "createdAt": "2020-02-15T01:33:32Z", "commit": {"oid": "b1b3eb9025eac7b3e70b518e907be5c4fa24fb3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1609, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}