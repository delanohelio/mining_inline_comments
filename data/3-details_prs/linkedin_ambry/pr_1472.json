{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNDc2MTUx", "number": 1472, "title": "Add basic support for multiple participants on server side", "bodyText": "In some cases where single datanode has to parcipate into mulitiple clusters\nand it needs to update node info in these clusters separately. This requires\nmuptiple participants on same node and each of them is responsible for interacting\nwith corresponding cluster. With this feature, we are able to build a mirror cluster\nthat helps us perform some monitoring and adminstration operations (i.e. ZK migration).", "createdAt": "2020-04-13T05:13:45Z", "url": "https://github.com/linkedin/ambry/pull/1472", "merged": true, "mergeCommit": {"oid": "0671eb169968151b822ffc718a647b17bd73ec72"}, "closed": true, "closedAt": "2020-04-21T00:50:32Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXHu0igH2gAyNDAyNDc2MTUxOjkwMjRkYTRhYWRiMWM2ODllZjE5M2NlNDMwNWQ4MjgwZjUyZjQzOGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZqeswAFqTM5Njk0OTQ0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9024da4aadb1c689ef193ce4305d8280f52f438c", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/9024da4aadb1c689ef193ce4305d8280f52f438c", "committedDate": "2020-04-13T05:06:49Z", "message": "Add basic support for multiple participants on server side\n\nIn some cases where single datanode has to parcipate into mulitiple clusters\nand it needs to update node info in these clusters separately. This requires\nmuptiple participants on same node and each of them is responsible for interacting\nwith corresponding cluster. With this feature, we are able to build a mirror cluster\nthat helps us perform some monitoring and adminstration operations (i.e. ZK migration)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "537c21f69e26dcd77295807edcb71bf9111fdc72", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/537c21f69e26dcd77295807edcb71bf9111fdc72", "committedDate": "2020-04-13T18:07:23Z", "message": "added unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b758face087dc960fd37f188dfeb4a58a35ffd92", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/b758face087dc960fd37f188dfeb4a58a35ffd92", "committedDate": "2020-04-13T18:43:40Z", "message": "fixed test failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjE2ODE5", "url": "https://github.com/linkedin/ambry/pull/1472#pullrequestreview-393216819", "createdAt": "2020-04-14T19:08:28Z", "commit": {"oid": "b758face087dc960fd37f188dfeb4a58a35ffd92"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTowODoyOVrOGFc-vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMDozMjowNVrOGFfyjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3MDg3Ng==", "bodyText": "nit: In some special cases, might as well just point it out this is for zk migration.", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r408370876", "createdAt": "2020-04-14T19:08:29Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com/github/ambry/clustermap/ClusterAgentsFactory.java", "diffHunk": "@@ -29,9 +30,12 @@\n   ClusterMap getClusterMap() throws IOException;\n \n   /**\n-   * Construct and return the reference or return the reference to the previously constructed\n-   * {@link ClusterParticipant}\n+   * Construct and return the references or return the references to the previously constructed\n+   * {@link ClusterParticipant}(s). We extend this method to support multiple participants on same node. In some special", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b758face087dc960fd37f188dfeb4a58a35ffd92"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5NzgzNg==", "bodyText": "From the zk migration document, there will be no replica movement during the migration, why do those managers has to support multiple participants?", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r408397836", "createdAt": "2020-04-14T19:57:35Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-server/src/main/java/com/github/ambry/server/AmbryServer.java", "diffHunk": "@@ -165,9 +164,11 @@ public void startup() throws InstantiationException {\n       }\n \n       StoreKeyFactory storeKeyFactory = Utils.getObj(storeConfig.storeKeyFactory, clusterMap);\n+      // TODO make StorageManager, ReplicationManager, CloudToStoreReplicationManager and StatsManager support multiple participants\n+      // For now, we assume there is only one element in clusterParticipants list.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b758face087dc960fd37f188dfeb4a58a35ffd92"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxNjkwOA==", "bodyText": "This comment is confusing to me. DatacenterInitializer is not part of the ClusterParticipant. It's used by HelixClusterManager to fetch the instance config and fill the clustermap. Why do we need to support multiple of them?", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r408416908", "createdAt": "2020-04-14T20:32:05Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/DatacenterInitializer.java", "diffHunk": "@@ -158,7 +158,10 @@ private void onInitializationFailure(Exception e) {\n    * @throws Exception if something went wrong during startup\n    */\n   private DcInfo initializeHelixDatacenter() throws Exception {\n-    String zkConnectStr = dcZkInfo.getZkConnectStr();\n+    // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default for initialization.\n+    // If we really need multiple HelixClusterManagers on same node in the future, we can use separate zk connect str configs\n+    // for HelixClusterManager and HelixParticipant.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b758face087dc960fd37f188dfeb4a58a35ffd92"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0ODQyMDU2", "url": "https://github.com/linkedin/ambry/pull/1472#pullrequestreview-394842056", "createdAt": "2020-04-16T17:18:30Z", "commit": {"oid": "b758face087dc960fd37f188dfeb4a58a35ffd92"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzoxODozMFrOGGvZ5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzoyMDozNVrOGGvfGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMTMxOQ==", "bodyText": "this can result in a NPE, since we use optString for cloud backed replicas.\nInstead, you could do Utils.splitString(entry.optString(ZKCONNECT_STR, \"\"), ZKCONNECTSTR_DELIMITER)", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409721319", "createdAt": "2020-04-16T17:18:30Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java", "diffHunk": "@@ -152,9 +155,10 @@ public static String getInstanceName(String host, Integer port) {\n       String name = entry.getString(DATACENTER_STR);\n       byte id = (byte) entry.getInt(DATACENTER_ID_STR);\n       ReplicaType replicaType = entry.optEnum(ReplicaType.class, REPLICA_TYPE_STR, ReplicaType.DISK_BACKED);\n-      String zkConnectStr = (replicaType == ReplicaType.DISK_BACKED) ? entry.getString(ZKCONNECTSTR_STR)\n-          : entry.optString(ZKCONNECTSTR_STR);\n-      DcZkInfo dcZkInfo = new DcZkInfo(name, id, zkConnectStr, replicaType);\n+      String[] zkConnectStrs =\n+          (replicaType == ReplicaType.DISK_BACKED) ? entry.getString(ZKCONNECTSTR_STR).split(ZKCONNECTSTR_DELIMITER)\n+              : entry.optString(ZKCONNECTSTR_STR).split(ZKCONNECTSTR_DELIMITER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b758face087dc960fd37f188dfeb4a58a35ffd92"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMTQzMw==", "bodyText": "Use Utils.splitString here?", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409721433", "createdAt": "2020-04-16T17:18:42Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java", "diffHunk": "@@ -152,9 +155,10 @@ public static String getInstanceName(String host, Integer port) {\n       String name = entry.getString(DATACENTER_STR);\n       byte id = (byte) entry.getInt(DATACENTER_ID_STR);\n       ReplicaType replicaType = entry.optEnum(ReplicaType.class, REPLICA_TYPE_STR, ReplicaType.DISK_BACKED);\n-      String zkConnectStr = (replicaType == ReplicaType.DISK_BACKED) ? entry.getString(ZKCONNECTSTR_STR)\n-          : entry.optString(ZKCONNECTSTR_STR);\n-      DcZkInfo dcZkInfo = new DcZkInfo(name, id, zkConnectStr, replicaType);\n+      String[] zkConnectStrs =\n+          (replicaType == ReplicaType.DISK_BACKED) ? entry.getString(ZKCONNECTSTR_STR).split(ZKCONNECTSTR_DELIMITER)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b758face087dc960fd37f188dfeb4a58a35ffd92"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMjY0OQ==", "bodyText": "this needs to go below line 203 since CLOUD_BACKED replicas do not have a zk connect string", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409722649", "createdAt": "2020-04-16T17:20:35Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java", "diffHunk": "@@ -197,7 +197,9 @@ public HelixClusterManager(ClusterMapConfig clusterMapConfig, String instanceNam\n   private HelixManager initializeHelixManagerAndPropertyStoreInLocalDC(Map<String, DcZkInfo> dataCenterToZkAddress,\n       String instanceName, HelixFactory helixFactory) throws Exception {\n     DcZkInfo dcZkInfo = dataCenterToZkAddress.get(clusterMapConfig.clusterMapDatacenterName);\n-    String zkConnectStr = dcZkInfo.getZkConnectStr();\n+    // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default. We can update\n+    // this if we really need to initialize mulitiple HelixManager in local dc.\n+    String zkConnectStr = dcZkInfo.getZkConnectStrs().get(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b758face087dc960fd37f188dfeb4a58a35ffd92"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "605420e79699fb00c96ed5dcb7c65d23653f655e", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/605420e79699fb00c96ed5dcb7c65d23653f655e", "committedDate": "2020-04-16T18:34:19Z", "message": "address Justin's and Casey's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MDYzMDEz", "url": "https://github.com/linkedin/ambry/pull/1472#pullrequestreview-395063013", "createdAt": "2020-04-16T23:19:07Z", "commit": {"oid": "605420e79699fb00c96ed5dcb7c65d23653f655e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMzoxOTowN1rOGG6gsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMzoxOTowN1rOGG6gsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkwMzI4Mw==", "bodyText": "I don't think we need to support multiple helix instances here, maybe we should change the comments.", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409903283", "createdAt": "2020-04-16T23:19:07Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java", "diffHunk": "@@ -197,10 +197,12 @@ public HelixClusterManager(ClusterMapConfig clusterMapConfig, String instanceNam\n   private HelixManager initializeHelixManagerAndPropertyStoreInLocalDC(Map<String, DcZkInfo> dataCenterToZkAddress,\n       String instanceName, HelixFactory helixFactory) throws Exception {\n     DcZkInfo dcZkInfo = dataCenterToZkAddress.get(clusterMapConfig.clusterMapDatacenterName);\n-    String zkConnectStr = dcZkInfo.getZkConnectStr();\n     if (dcZkInfo.getReplicaType() == ReplicaType.CLOUD_BACKED) {\n       return null;\n     }\n+    // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default. We can update\n+    // this if we really need to initialize multiple HelixManagers in local dc.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "605420e79699fb00c96ed5dcb7c65d23653f655e"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c63664179f7530057728d42ece47247bd9996b7", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/3c63664179f7530057728d42ece47247bd9996b7", "committedDate": "2020-04-17T04:30:54Z", "message": "comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2OTE0OTUw", "url": "https://github.com/linkedin/ambry/pull/1472#pullrequestreview-396914950", "createdAt": "2020-04-21T00:50:13Z", "commit": {"oid": "3c63664179f7530057728d42ece47247bd9996b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2OTQ3NTQw", "url": "https://github.com/linkedin/ambry/pull/1472#pullrequestreview-396947540", "createdAt": "2020-04-21T02:37:22Z", "commit": {"oid": "3c63664179f7530057728d42ece47247bd9996b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMjozNzoyM1rOGIv0Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMjozNzoyM1rOGIv0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyNTIwNg==", "bodyText": "Minor: my only concern here is that the metric names will look convoluted.  But I don't have a better suggestion either for making them distinct.", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r411825206", "createdAt": "2020-04-21T02:37:23Z", "author": {"login": "lightningrob"}, "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixParticipantMetrics.java", "diffHunk": "@@ -32,26 +32,27 @@\n   // no need to record exact number of \"dropped\" partition, a counter to track partition-dropped events would suffice\n   final Counter partitionDroppedCount;\n \n-  HelixParticipantMetrics(MetricRegistry metricRegistry) {\n+  HelixParticipantMetrics(MetricRegistry metricRegistry, String zkConnectStr) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c63664179f7530057728d42ece47247bd9996b7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2OTQ5NDQx", "url": "https://github.com/linkedin/ambry/pull/1472#pullrequestreview-396949441", "createdAt": "2020-04-21T02:43:43Z", "commit": {"oid": "3c63664179f7530057728d42ece47247bd9996b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMjo0Mzo0M1rOGIv8bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMjo0Mzo0M1rOGIv8bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyNzMxMQ==", "bodyText": "Minor: It's generally better to let either the test constructor or @before method do this kind of initialization in case an exception happens in test case.", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r411827311", "createdAt": "2020-04-21T02:43:43Z", "author": {"login": "lightningrob"}, "path": "ambry-clustermap/src/test/java/com/github/ambry/clustermap/HelixParticipantTest.java", "diffHunk": "@@ -301,21 +307,45 @@ public void testBadCases() throws IOException {\n     props.setProperty(\"clustermap.dcs.zk.connect.strings\", \"\");\n     clusterMapConfig = new ClusterMapConfig(new VerifiableProperties(props));\n     try {\n-      new HelixParticipant(clusterMapConfig, helixManagerFactory, new MetricRegistry());\n+      new HelixClusterAgentsFactory(clusterMapConfig, new MetricRegistry()).getClusterParticipants();\n       fail(\"Instantiation should have failed\");\n     } catch (IOException e) {\n       // OK\n     }\n   }\n \n+  /**\n+   * Test instantiating multiple {@link HelixParticipant}(s) in {@link HelixClusterAgentsFactory}\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testMultiParticipants() throws Exception {\n+    JSONArray zkInfosJson = new JSONArray();\n+    // create a new zkJson which contains two zk endpoints in the same data center.\n+    JSONObject zkInfoJson = new JSONObject();\n+    zkInfoJson.put(ClusterMapUtils.DATACENTER_STR, \"DC0\");\n+    zkInfoJson.put(ClusterMapUtils.DATACENTER_ID_STR, (byte) 0);\n+    zkInfoJson.put(ClusterMapUtils.ZKCONNECT_STR, \"localhost:2199\" + ZKCONNECT_STR_DELIMITER + \"localhost:2299\");\n+    zkInfosJson.put(zkInfoJson);\n+    JSONObject jsonObject = new JSONObject().put(ClusterMapUtils.ZKINFO_STR, zkInfosJson);\n+    props.setProperty(\"clustermap.dcs.zk.connect.strings\", jsonObject.toString(2));\n+    ClusterMapConfig clusterMapConfig = new ClusterMapConfig(new VerifiableProperties(props));\n+    List<ClusterParticipant> participants =\n+        new HelixClusterAgentsFactory(clusterMapConfig, helixManagerFactory).getClusterParticipants();\n+    assertEquals(\"Number of participants is not expected\", 2, participants.size());\n+    // restore previous setup\n+    props.setProperty(\"clustermap.dcs.zk.connect.strings\", zkJson.toString(2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c63664179f7530057728d42ece47247bd9996b7"}, "originalPosition": 123}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1391, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}