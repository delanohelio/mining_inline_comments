{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MDA0NjI5", "number": 1566, "title": "Add more undelete unit test for compaction", "bodyText": "This PR adds more unit test in compaction with undeletes.", "createdAt": "2020-06-16T06:34:53Z", "url": "https://github.com/linkedin/ambry/pull/1566", "merged": true, "mergeCommit": {"oid": "3cb78d323012e42c43f528ba0878d8a128ac77be"}, "closed": true, "closedAt": "2020-06-20T06:18:46Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsPoPogBqjM0NTUyMjU0MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABctAh5fAH2gAyNDM1MDA0NjI5OmRlYzgxMDVjNzc5OWVmMjE1YjdiZDM4ZjhlN2EyYjRhNWNlOTk4NWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f19c1389908ad71add0249ac5beb67dee33a43df", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/f19c1389908ad71add0249ac5beb67dee33a43df", "committedDate": "2020-06-16T18:28:06Z", "message": "More tests"}, "afterCommit": {"oid": "f7bf3c67aaa22fb449317b93d86a71ffc8838f8c", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/f7bf3c67aaa22fb449317b93d86a71ffc8838f8c", "committedDate": "2020-06-17T20:11:10Z", "message": "More tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODY1NjIw", "url": "https://github.com/linkedin/ambry/pull/1566#pullrequestreview-432865620", "createdAt": "2020-06-18T00:39:20Z", "commit": {"oid": "f7bf3c67aaa22fb449317b93d86a71ffc8838f8c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a037e1408a2d727eeca2472aba2cf1063c1465a", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/2a037e1408a2d727eeca2472aba2cf1063c1465a", "committedDate": "2020-06-19T00:05:38Z", "message": "Add more undelete unit test for compaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3d0fd8d7e984af3371aa55ed7785e120773c7d7", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/e3d0fd8d7e984af3371aa55ed7785e120773c7d7", "committedDate": "2020-06-19T00:05:38Z", "message": "More tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52297ca3f93d6398702aebe08c8868feeba161da", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/52297ca3f93d6398702aebe08c8868feeba161da", "committedDate": "2020-06-19T20:32:19Z", "message": "Add more tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7bf3c67aaa22fb449317b93d86a71ffc8838f8c", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/f7bf3c67aaa22fb449317b93d86a71ffc8838f8c", "committedDate": "2020-06-17T20:11:10Z", "message": "More tests"}, "afterCommit": {"oid": "52297ca3f93d6398702aebe08c8868feeba161da", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/52297ca3f93d6398702aebe08c8868feeba161da", "committedDate": "2020-06-19T20:32:19Z", "message": "Add more tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDAzNTIw", "url": "https://github.com/linkedin/ambry/pull/1566#pullrequestreview-434403520", "createdAt": "2020-06-20T05:03:14Z", "commit": {"oid": "52297ca3f93d6398702aebe08c8868feeba161da"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQwNTowMzoxNVrOGmkzNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQwNTowNDozNFrOGmkzeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwMjAwNQ==", "bodyText": "indexSegmentCountBeforeCompaction is never accessed, did you want to verify this count originally?", "url": "https://github.com/linkedin/ambry/pull/1566#discussion_r443102005", "createdAt": "2020-06-20T05:03:15Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/test/java/com/github/ambry/store/BlobStoreCompactorTest.java", "diffHunk": "@@ -1235,13 +1234,27 @@ public void undeleteSameIndexSegmentTest() throws Exception {\n     state.addUndeleteEntry((MockId) p9.getKey());\n     state.addUndeleteEntry((MockId) p9.getKey(), (short) 2);\n     state.addPutEntries(1, CuratedLogIndexState.PUT_RECORD_SIZE, Utils.Infinite_Time);\n-    // Make sure we have two log segments\n-    writeDataToMeetRequiredSegmentCount(2, null);\n+\n+    writeDataToMeetRequiredSegmentCount(1, null);\n+    // This is the end of the first log segment\n+\n+    // log segment 1\n+    // Index Segment 1.1 P(expired) D U T -> P(expire) U T\n+    long p10Expiration = state.time.milliseconds() + 10000;\n+    IndexEntry p10 = state.addPutEntries(1, CuratedLogIndexState.PUT_RECORD_SIZE, p10Expiration).get(0);\n+    state.addDeleteEntry((MockId) p10.getKey());\n+    state.addUndeleteEntry((MockId) p10.getKey());\n+    state.makePermanent((MockId) p10.getKey(), false);\n+    state.addPutEntries(1, CuratedLogIndexState.PUT_RECORD_SIZE, Utils.Infinite_Time);\n+\n+    // Make sure we have 3 log segments\n+    writeDataToMeetRequiredSegmentCount(3, null);\n     state.reloadIndex(true, false);\n \n     String logSegmentName = p1.getValue().getOffset().getName();\n-    List<String> segmentsUnderCompaction = Collections.singletonList(logSegmentName);\n-    long deleteReferenceTimeMs = state.time.milliseconds() + 10000;\n+    List<String> segmentsUnderCompaction = getLogSegments(0, 1);\n+    state.advanceTime(p10Expiration - state.time.milliseconds() + 1000);\n+    long deleteReferenceTimeMs = state.time.milliseconds();\n     long endOffsetOfSegmentBeforeCompaction = state.log.getSegment(logSegmentName).getEndOffset();\n     int indexSegmentCountBeforeCompaction = state.index.getIndexSegments().size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52297ca3f93d6398702aebe08c8868feeba161da"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwMjA1OA==", "bodyText": "oh I see you removed an assert and make this assigned but never accessed.", "url": "https://github.com/linkedin/ambry/pull/1566#discussion_r443102058", "createdAt": "2020-06-20T05:04:11Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/test/java/com/github/ambry/store/BlobStoreCompactorTest.java", "diffHunk": "@@ -1235,13 +1234,27 @@ public void undeleteSameIndexSegmentTest() throws Exception {\n     state.addUndeleteEntry((MockId) p9.getKey());\n     state.addUndeleteEntry((MockId) p9.getKey(), (short) 2);\n     state.addPutEntries(1, CuratedLogIndexState.PUT_RECORD_SIZE, Utils.Infinite_Time);\n-    // Make sure we have two log segments\n-    writeDataToMeetRequiredSegmentCount(2, null);\n+\n+    writeDataToMeetRequiredSegmentCount(1, null);\n+    // This is the end of the first log segment\n+\n+    // log segment 1\n+    // Index Segment 1.1 P(expired) D U T -> P(expire) U T\n+    long p10Expiration = state.time.milliseconds() + 10000;\n+    IndexEntry p10 = state.addPutEntries(1, CuratedLogIndexState.PUT_RECORD_SIZE, p10Expiration).get(0);\n+    state.addDeleteEntry((MockId) p10.getKey());\n+    state.addUndeleteEntry((MockId) p10.getKey());\n+    state.makePermanent((MockId) p10.getKey(), false);\n+    state.addPutEntries(1, CuratedLogIndexState.PUT_RECORD_SIZE, Utils.Infinite_Time);\n+\n+    // Make sure we have 3 log segments\n+    writeDataToMeetRequiredSegmentCount(3, null);\n     state.reloadIndex(true, false);\n \n     String logSegmentName = p1.getValue().getOffset().getName();\n-    List<String> segmentsUnderCompaction = Collections.singletonList(logSegmentName);\n-    long deleteReferenceTimeMs = state.time.milliseconds() + 10000;\n+    List<String> segmentsUnderCompaction = getLogSegments(0, 1);\n+    state.advanceTime(p10Expiration - state.time.milliseconds() + 1000);\n+    long deleteReferenceTimeMs = state.time.milliseconds();\n     long endOffsetOfSegmentBeforeCompaction = state.log.getSegment(logSegmentName).getEndOffset();\n     int indexSegmentCountBeforeCompaction = state.index.getIndexSegments().size();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwMjAwNQ=="}, "originalCommit": {"oid": "52297ca3f93d6398702aebe08c8868feeba161da"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwMjA3NA==", "bodyText": "same here", "url": "https://github.com/linkedin/ambry/pull/1566#discussion_r443102074", "createdAt": "2020-06-20T05:04:34Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/test/java/com/github/ambry/store/BlobStoreCompactorTest.java", "diffHunk": "@@ -1368,14 +1378,69 @@ public void undeleteSameIndexSegmentTest() throws Exception {\n     // there should be no temp files\n     assertEquals(\"There are some temp log segments\", 0,\n         tempDir.listFiles(BlobStoreCompactor.TEMP_LOG_SEGMENTS_FILTER).length);\n+\n+    state.reloadIndex(true, false);\n+    logSegmentName = p10.getValue().getOffset().getName();\n+    segmentsUnderCompaction = Collections.singletonList(logSegmentName);\n+    deleteReferenceTimeMs = state.time.milliseconds();\n+    endOffsetOfSegmentBeforeCompaction = state.log.getSegment(logSegmentName).getEndOffset();\n+    indexSegmentCountBeforeCompaction = state.index.getIndexSegments().size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52297ca3f93d6398702aebe08c8868feeba161da"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dec8105c7799ef215b7bd38f8e7a2b4a5ce9985b", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/dec8105c7799ef215b7bd38f8e7a2b4a5ce9985b", "committedDate": "2020-06-20T05:09:42Z", "message": "Comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1141, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}