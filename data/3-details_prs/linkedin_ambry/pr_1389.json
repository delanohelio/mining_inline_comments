{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2ODI5NTAx", "number": 1389, "title": "Support ByteBuf writing in NettyResponseChannel", "bodyText": "Start to support writing ByteBuf in the NettyResponseChannel.\nThis is another step to stop supporting writing java ByteBuffer in the AsyncWritableChannel.", "createdAt": "2020-02-18T20:53:19Z", "url": "https://github.com/linkedin/ambry/pull/1389", "merged": true, "mergeCommit": {"oid": "c59ad9e83465ffb73be434b05bf26206b699839f"}, "closed": true, "closedAt": "2020-02-28T05:11:06Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGSWWiAFqTM2MjI2MDQyMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIo0S8AFqTM2NjE2Mzg5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjYwNDIz", "url": "https://github.com/linkedin/ambry/pull/1389#pullrequestreview-362260423", "createdAt": "2020-02-20T21:52:20Z", "commit": {"oid": "351ae76b4206d798aa8363743a4148c0d5587c3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMTo1MjoyMFrOFskaOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMTo1MjoyMFrOFskaOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI3ODIwMQ==", "bodyText": "Maybe a typo here for j added before @param.", "url": "https://github.com/linkedin/ambry/pull/1389#discussion_r382278201", "createdAt": "2020-02-20T21:52:20Z", "author": {"login": "xuhao417347761"}, "path": "ambry-rest/src/main/java/com.github.ambry.rest/NettyResponseChannel.java", "diffHunk": "@@ -443,7 +443,7 @@ private boolean maybeWriteResponseMetadata(HttpResponse responseMetadata,\n \n   /**\n    * Builds and sends an error response to the client based on {@code cause}.\n-   * @param exception the cause of the request handling failure.\n+   *j@param exception the cause of the request handling failure.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "351ae76b4206d798aa8363743a4148c0d5587c3e"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDU5MDQ1", "url": "https://github.com/linkedin/ambry/pull/1389#pullrequestreview-363059045", "createdAt": "2020-02-23T00:53:58Z", "commit": {"oid": "13777002348b108944d899ab0d7c441b90a97e77"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwMDo1Mzo1OFrOFtNo6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwMToyODo0M1rOFtNuyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1MzcwNw==", "bodyText": "private static final", "url": "https://github.com/linkedin/ambry/pull/1389#discussion_r382953707", "createdAt": "2020-02-23T00:53:58Z", "author": {"login": "cgtz"}, "path": "ambry-rest/src/main/java/com.github.ambry.rest/NettyResponseChannel.java", "diffHunk": "@@ -86,7 +86,7 @@\n   private final ChunkedWriteHandler chunkedWriteHandler;\n   private final PerformanceConfig perfConfig;\n \n-  private final Logger logger = LoggerFactory.getLogger(getClass());\n+  private final static Logger logger = LoggerFactory.getLogger(NettyResponseChannel.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13777002348b108944d899ab0d7c441b90a97e77"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1Mzg0Ng==", "bodyText": "this seems like it should be exception != null or result == null", "url": "https://github.com/linkedin/ambry/pull/1389#discussion_r382953846", "createdAt": "2020-02-23T00:57:11Z", "author": {"login": "cgtz"}, "path": "ambry-rest/src/main/java/com.github.ambry.rest/NettyResponseChannel.java", "diffHunk": "@@ -127,6 +127,23 @@\n \n   @Override\n   public Future<Long> write(ByteBuffer src, Callback<Long> callback) {\n+    return write(Unpooled.wrappedBuffer(src), new Callback<Long>() {\n+      @Override\n+      public void onCompletion(Long result, Exception exception) {\n+        if (exception == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13777002348b108944d899ab0d7c441b90a97e77"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1NDQ1Nw==", "bodyText": "i would recommend doing the thing that was done with in the default impl in AsyncWritableChannel where a second future is created and completed from the callback. This will ensure that the future returned is completed after the buffer position is changed.", "url": "https://github.com/linkedin/ambry/pull/1389#discussion_r382954457", "createdAt": "2020-02-23T01:11:07Z", "author": {"login": "cgtz"}, "path": "ambry-rest/src/main/java/com.github.ambry.rest/NettyResponseChannel.java", "diffHunk": "@@ -127,6 +127,23 @@\n \n   @Override\n   public Future<Long> write(ByteBuffer src, Callback<Long> callback) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13777002348b108944d899ab0d7c441b90a97e77"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1NTIwOQ==", "bodyText": "should these buffers be retained before sending as content? If the chunk callback called by operationProgressed releases the buffer and the content object is also released by downstream channel handlers (not sure if this part happens or not), it may get an IllegalReferenceCountException", "url": "https://github.com/linkedin/ambry/pull/1389#discussion_r382955209", "createdAt": "2020-02-23T01:28:43Z", "author": {"login": "cgtz"}, "path": "ambry-rest/src/main/java/com.github.ambry.rest/NettyResponseChannel.java", "diffHunk": "@@ -877,14 +893,13 @@ public HttpContent readChunk(ByteBufAllocator allocator) throws Exception {\n       Chunk chunk = chunksToWrite.poll();\n       if (chunk != null) {\n         chunk.onDequeue();\n-        ByteBuf buf = Unpooled.wrappedBuffer(chunk.buffer);\n-        progress.addAndGet(chunk.buffer.remaining());\n+        progress.addAndGet(chunk.buffer.readableBytes());\n         chunksAwaitingCallback.add(chunk);\n         if (chunk.isLast) {\n-          content = new DefaultLastHttpContent(buf);\n+          content = new DefaultLastHttpContent(chunk.buffer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13777002348b108944d899ab0d7c441b90a97e77"}, "originalPosition": 103}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "13777002348b108944d899ab0d7c441b90a97e77", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/13777002348b108944d899ab0d7c441b90a97e77", "committedDate": "2020-02-18T20:49:04Z", "message": "Support ByteBuf writing in NettyResponseChannel"}, "afterCommit": {"oid": "ddd0eb34aa541d946d43afabfb420707a2c60daf", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/ddd0eb34aa541d946d43afabfb420707a2c60daf", "committedDate": "2020-02-25T01:14:10Z", "message": "Address casey comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ddd0eb34aa541d946d43afabfb420707a2c60daf", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/ddd0eb34aa541d946d43afabfb420707a2c60daf", "committedDate": "2020-02-25T01:14:10Z", "message": "Address casey comments"}, "afterCommit": {"oid": "005d7b91e62d7231fb06332551f738542564a74b", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/005d7b91e62d7231fb06332551f738542564a74b", "committedDate": "2020-02-25T07:28:40Z", "message": "Address casey comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MTcwNTU5", "url": "https://github.com/linkedin/ambry/pull/1389#pullrequestreview-365170559", "createdAt": "2020-02-26T19:16:15Z", "commit": {"oid": "005d7b91e62d7231fb06332551f738542564a74b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOToxNjoxNVrOFu4oKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOTozMzo1MFrOFu5Nmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcwNjYwMA==", "bodyText": "Why 0 instead of previous src.position()?", "url": "https://github.com/linkedin/ambry/pull/1389#discussion_r384706600", "createdAt": "2020-02-26T19:16:15Z", "author": {"login": "zzmao"}, "path": "ambry-rest/src/main/java/com.github.ambry.rest/NettyResponseChannel.java", "diffHunk": "@@ -127,6 +127,23 @@\n \n   @Override\n   public Future<Long> write(ByteBuffer src, Callback<Long> callback) {\n+    FutureResult<Long> futureResult = new FutureResult<>();\n+    write(Unpooled.wrappedBuffer(src), new Callback<Long>() {\n+      @Override\n+      public void onCompletion(Long result, Exception exception) {\n+        long r = result == null ? (long) 0 : result.longValue();\n+        src.position((int) r);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "005d7b91e62d7231fb06332551f738542564a74b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcxNjE4Nw==", "bodyText": "not used.", "url": "https://github.com/linkedin/ambry/pull/1389#discussion_r384716187", "createdAt": "2020-02-26T19:33:50Z", "author": {"login": "zzmao"}, "path": "ambry-rest/src/test/java/com.github.ambry.rest/NettyResponseChannelTest.java", "diffHunk": "@@ -17,10 +17,12 @@\n import com.github.ambry.config.PerformanceConfig;\n import com.github.ambry.config.VerifiableProperties;\n import com.github.ambry.router.Callback;\n+import com.github.ambry.utils.NettyByteBufLeakHelper;\n import com.github.ambry.utils.TestUtils;\n import com.github.ambry.utils.Utils;\n import com.github.ambry.utils.UtilsTest;\n import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.PooledByteBufAllocator;\n import io.netty.buffer.Unpooled;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "005d7b91e62d7231fb06332551f738542564a74b"}, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "005d7b91e62d7231fb06332551f738542564a74b", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/005d7b91e62d7231fb06332551f738542564a74b", "committedDate": "2020-02-25T07:28:40Z", "message": "Address casey comments"}, "afterCommit": {"oid": "0a1c99e7c7bf852f986ebda67580c71fc629fbe6", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/0a1c99e7c7bf852f986ebda67580c71fc629fbe6", "committedDate": "2020-02-26T22:07:30Z", "message": "Addres comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c730f019958c2da77bcb98226663a30f36ba3509", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/c730f019958c2da77bcb98226663a30f36ba3509", "committedDate": "2020-02-27T02:13:51Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a05c14cdc3a217d6be811c872506f7fec21974a4", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/a05c14cdc3a217d6be811c872506f7fec21974a4", "committedDate": "2020-02-27T02:13:51Z", "message": "Support ByteBuf writing in NettyResponseChannel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c3aca4b978db2a8203417d1337f86ad4c656a88", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/5c3aca4b978db2a8203417d1337f86ad4c656a88", "committedDate": "2020-02-27T02:13:51Z", "message": "Address casey comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f5628bd627351f273a9ed5745ce9005084b6fb2", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/3f5628bd627351f273a9ed5745ce9005084b6fb2", "committedDate": "2020-02-27T21:51:54Z", "message": "Addres comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5249cc714fd81db29610fda5a765dd579d825854", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/5249cc714fd81db29610fda5a765dd579d825854", "committedDate": "2020-02-28T01:12:11Z", "message": "Fix a weird bug"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a1c99e7c7bf852f986ebda67580c71fc629fbe6", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/0a1c99e7c7bf852f986ebda67580c71fc629fbe6", "committedDate": "2020-02-26T22:07:30Z", "message": "Addres comments"}, "afterCommit": {"oid": "5249cc714fd81db29610fda5a765dd579d825854", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/5249cc714fd81db29610fda5a765dd579d825854", "committedDate": "2020-02-28T01:12:11Z", "message": "Fix a weird bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTA3MjQw", "url": "https://github.com/linkedin/ambry/pull/1389#pullrequestreview-366107240", "createdAt": "2020-02-28T01:15:45Z", "commit": {"oid": "5249cc714fd81db29610fda5a765dd579d825854"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMToxNTo0NVrOFvmpwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMToxNTo0NVrOFvmpwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ2MDY3Mw==", "bodyText": "I have seen a really weird bug, where a range request would somehow pollute the blob data here. I change the way we are dealing with range request data to copying it out. And it fixes the problem. This is weird, but I won't get into too much detail.", "url": "https://github.com/linkedin/ambry/pull/1389#discussion_r385460673", "createdAt": "2020-02-28T01:15:45Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-router/src/test/java/com.github.ambry.router/InMemoryRouter.java", "diffHunk": "@@ -157,7 +157,11 @@ public ByteBuffer getBlob(ByteRange range) throws RouterException {\n         } catch (IllegalArgumentException e) {\n           throw new RouterException(\"Invalid range for blob\", e, RouterErrorCode.RangeNotSatisfiable);\n         }\n-        buf = ByteBuffer.wrap(blob.array(), (int) resolvedRange.getStartOffset(), (int) resolvedRange.getRangeSize());\n+        byte[] bytes = new byte[(int) resolvedRange.getRangeSize()];\n+        ByteBuffer duplicate = blob.duplicate();\n+        duplicate.position((int) resolvedRange.getStartOffset());\n+        duplicate.get(bytes);\n+        buf = ByteBuffer.wrap(bytes);\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5249cc714fd81db29610fda5a765dd579d825854"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTA3NzM0", "url": "https://github.com/linkedin/ambry/pull/1389#pullrequestreview-366107734", "createdAt": "2020-02-28T01:17:22Z", "commit": {"oid": "5249cc714fd81db29610fda5a765dd579d825854"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTYzODk1", "url": "https://github.com/linkedin/ambry/pull/1389#pullrequestreview-366163895", "createdAt": "2020-02-28T05:10:48Z", "commit": {"oid": "5249cc714fd81db29610fda5a765dd579d825854"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1624, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}