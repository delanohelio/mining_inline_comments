{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3ODY4NTcw", "number": 1453, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjozMDowNVrODvpLrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzowODo1MFrODvqKGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMjg0Mzk4OnYy", "diffSide": "RIGHT", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixParticipant.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjozMDowNVrOGCMByw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjozMDowNVrOGCMByw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk0NzQwMw==", "bodyText": "After PR #1452 is merged, please rebase and fix conflict if needed", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404947403", "createdAt": "2020-04-07T16:30:05Z", "author": {"login": "jsjtzyy"}, "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixParticipant.java", "diffHunk": "@@ -510,6 +516,12 @@ public void onPartitionBecomeStandbyFromLeader(String partitionName) {\n     if (cloudToStoreReplicationListener != null) {\n       cloudToStoreReplicationListener.onPartitionBecomeStandbyFromLeader(partitionName);\n     }\n+\n+    PartitionStateChangeListener replicationManagerListener =\n+        partitionStateChangeListeners.get(StateModelListenerType.ReplicationManagerListener);\n+    if (replicationManagerListener != null) {\n+      replicationManagerListener.onPartitionBecomeStandbyFromLeader(partitionName);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21046b2bab764cbe04e631889f819d9843657e81"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMjg2NjIyOnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicationManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjozNToyN1rOGCMQFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjozNToyN1rOGCMQFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1MTA2Mw==", "bodyText": "not used, can be removed", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404951063", "createdAt": "2020-04-07T16:35:27Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicationManager.java", "diffHunk": "@@ -47,6 +49,7 @@\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.stream.Collectors;\n \n+import static com.github.ambry.clustermap.ClusterMapUtils.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21046b2bab764cbe04e631889f819d9843657e81"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMjg3MDcxOnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicationManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjozNjozNlrOGCMTCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjozNjozNlrOGCMTCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1MTgxNw==", "bodyText": "This can be package private. Also add java doc to this method please.", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404951817", "createdAt": "2020-04-07T16:36:36Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicationManager.java", "diffHunk": "@@ -241,6 +244,10 @@ private void updatePartitionInfoMaps(List<RemoteReplicaInfo> remoteReplicaInfos,\n         .add(partitionInfo);\n   }\n \n+  public Map<String, List<ReplicaId>> getPeerLeaderReplicasByPartition() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21046b2bab764cbe04e631889f819d9843657e81"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMjk2Mzc2OnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicationManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo1OToxNVrOGCNPJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo1OToxNVrOGCNPJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2NzIwNQ==", "bodyText": "minor: I noticed AmbryDataNode.toString() will print out DataNode, so you can remove Node in your log message.", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404967205", "createdAt": "2020-04-07T16:59:15Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicationManager.java", "diffHunk": "@@ -373,12 +380,34 @@ public void onPartitionBecomeStandbyFromBootstrap(String partitionName) {\n     public void onPartitionBecomeLeaderFromStandby(String partitionName) {\n       logger.info(\"Partition state change notification from Standby to Leader received for partition {}\",\n           partitionName);\n+      //Changes for leader based replication - for now, we just log the list of peer leader replicas\n+      // 1. get replica ID of current node from store manager\n+      ReplicaId localReplica = storeManager.getReplica(partitionName);\n+\n+      // 2. Get the peer leader replicas from all data centers for this partition\n+      List<? extends ReplicaId> leaderReplicas =\n+          localReplica.getPartitionId().getReplicaIdsByState(ReplicaState.LEADER, null);\n+\n+      // 3. Log the list of leader replicas associated with this partition (will be used later for leadership based replication)\n+      List<ReplicaId> peerLeaderReplicas = new ArrayList<>();\n+      for (ReplicaId leaderReplica : leaderReplicas) {\n+        if (leaderReplica.getDataNodeId() != localReplica.getDataNodeId()) {\n+          peerLeaderReplicas.add(leaderReplica);\n+          logger.info(\"Partition {} on Node {} is leader in remote dc {}\", partitionName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21046b2bab764cbe04e631889f819d9843657e81"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMjk4MzQ4OnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzowNDowMFrOGCNbxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzowNDo0MFrOGCNdlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MDQzOQ==", "bodyText": "nit: CamelCase currentDataCenter", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404970439", "createdAt": "2020-04-07T17:04:00Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "diffHunk": "@@ -601,7 +602,18 @@ public void replicaFromStandbyToLeaderTest() throws Exception {\n     StorageManager storageManager = managers.getFirst();\n     MockReplicationManager replicationManager = (MockReplicationManager) managers.getSecond();\n     PartitionId existingPartition = replicationManager.partitionToPartitionInfo.keySet().iterator().next();\n+    String currentdatacenter =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21046b2bab764cbe04e631889f819d9843657e81"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MDkwMA==", "bodyText": "Also, update the comment of this method please.", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404970900", "createdAt": "2020-04-07T17:04:40Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "diffHunk": "@@ -601,7 +602,18 @@ public void replicaFromStandbyToLeaderTest() throws Exception {\n     StorageManager storageManager = managers.getFirst();\n     MockReplicationManager replicationManager = (MockReplicationManager) managers.getSecond();\n     PartitionId existingPartition = replicationManager.partitionToPartitionInfo.keySet().iterator().next();\n+    String currentdatacenter =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MDQzOQ=="}, "originalCommit": {"oid": "21046b2bab764cbe04e631889f819d9843657e81"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMjk5NDk1OnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzowNjozN1rOGCNi_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzowNjozN1rOGCNi_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MjI4Nw==", "bodyText": "minor: can remove this cast (List<ReplicaId>)", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404972287", "createdAt": "2020-04-07T17:06:37Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "diffHunk": "@@ -601,7 +602,18 @@ public void replicaFromStandbyToLeaderTest() throws Exception {\n     StorageManager storageManager = managers.getFirst();\n     MockReplicationManager replicationManager = (MockReplicationManager) managers.getSecond();\n     PartitionId existingPartition = replicationManager.partitionToPartitionInfo.keySet().iterator().next();\n+    String currentdatacenter =\n+        storageManager.getReplica(existingPartition.toString()).getDataNodeId().getDatacenterName();\n     mockHelixParticipant.onPartitionBecomeLeaderFromStandby(existingPartition.toPathString());\n+    List<ReplicaId> peerLeaderReplicasInReplicationManager =\n+        replicationManager.getPeerLeaderReplicasByPartition().get(existingPartition.toString());\n+    List<ReplicaId> peerLeaderReplicasInClusterMap =\n+        (List<ReplicaId>) existingPartition.getReplicaIdsByState(ReplicaState.LEADER, null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21046b2bab764cbe04e631889f819d9843657e81"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMjk5OTEwOnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzowNzo0MVrOGCNlkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzowNzo0MVrOGCNlkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3Mjk0Nw==", "bodyText": "Since you also made changes in LEADER -> STANDBY transition in replication manager, could you also add a test for this case?  (in replicaFromLeaderToStandbyTest)", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404972947", "createdAt": "2020-04-07T17:07:41Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "diffHunk": "@@ -601,7 +602,18 @@ public void replicaFromStandbyToLeaderTest() throws Exception {\n     StorageManager storageManager = managers.getFirst();\n     MockReplicationManager replicationManager = (MockReplicationManager) managers.getSecond();\n     PartitionId existingPartition = replicationManager.partitionToPartitionInfo.keySet().iterator().next();\n+    String currentdatacenter =\n+        storageManager.getReplica(existingPartition.toString()).getDataNodeId().getDatacenterName();\n     mockHelixParticipant.onPartitionBecomeLeaderFromStandby(existingPartition.toPathString());\n+    List<ReplicaId> peerLeaderReplicasInReplicationManager =\n+        replicationManager.getPeerLeaderReplicasByPartition().get(existingPartition.toString());\n+    List<ReplicaId> peerLeaderReplicasInClusterMap =\n+        (List<ReplicaId>) existingPartition.getReplicaIdsByState(ReplicaState.LEADER, null)\n+            .stream()\n+            .filter(r -> !r.getDataNodeId().getDatacenterName().equals(currentdatacenter))\n+            .collect(Collectors.toList());\n+    assertThat(\"mismatch in leader peer replicas\", peerLeaderReplicasInReplicationManager,\n+        is(peerLeaderReplicasInClusterMap));\n     storageManager.shutdown();\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21046b2bab764cbe04e631889f819d9843657e81"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzAwMzc2OnYy", "diffSide": "RIGHT", "path": "ambry-test-utils/src/main/java/com/github/ambry/clustermap/MockPartitionId.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzowODo1MFrOGCNofw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzowODo1MFrOGCNofw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MzY5NQ==", "bodyText": "nit: dataCenters", "url": "https://github.com/linkedin/ambry/pull/1453#discussion_r404973695", "createdAt": "2020-04-07T17:08:50Z", "author": {"login": "jsjtzyy"}, "path": "ambry-test-utils/src/main/java/com/github/ambry/clustermap/MockPartitionId.java", "diffHunk": "@@ -53,10 +55,16 @@ public MockPartitionId(long partition, String partitionClass, List<MockDataNodeI\n     this.partitionClass = partitionClass;\n     this.replicaIds = new ArrayList<>(dataNodes.size());\n     replicaAndState = new HashMap<>();\n+    Set<String> datacenters = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21046b2bab764cbe04e631889f819d9843657e81"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1461, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}