{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NDEzNTUx", "number": 1668, "title": "Upgrade metrics to 4.1.2, allow custom configuration for JmxReporter", "bodyText": "Upgrade dropwizard metrics to 4.1.2\nUpgrading to 4.1.2 brings some changes in MBean naming in JmxReporter,\nwhich can effect users that query these MBeans based on naming patterns.\nTo address this, add an optional argument to each \"server\" class to\nallow users to pass in a factory that produces a JmxReporter with\nnon-default configs.", "createdAt": "2020-10-22T16:24:51Z", "url": "https://github.com/linkedin/ambry/pull/1668", "merged": true, "mergeCommit": {"oid": "8a97123df1350241a14b2755db6905ad1cd688d9"}, "closed": true, "closedAt": "2020-10-23T20:48:13Z", "author": {"login": "cgtz"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVEb3TAH2gAyNTA4NDEzNTUxOjkyMmQyNzIzYjA1NTE1YzI1Zjg4YTVjMTk3ZmViNzcxZTQxOTQ4NmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVafQZgFqTUxNTg4OTg3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "922d2723b05515c25f88a5c197feb771e419486e", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/922d2723b05515c25f88a5c197feb771e419486e", "committedDate": "2020-10-22T16:19:42Z", "message": "Upgrade metrics to 4.1.2, allow custom configuration for JmxReporter\n\n- Upgrade dropwizard metrics to 4.1.2\n- Upgrading to 4.1.2 brings some changes in MBean naming in JmxReporter,\n  which can effect users that query these MBeans based on naming patterns.\n- To address this, add an optional argument to each \"server\" class to\n  allow users to pass in a factory that produces a JmxReporter with\n  non-default configs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDgyNTQ4", "url": "https://github.com/linkedin/ambry/pull/1668#pullrequestreview-515082548", "createdAt": "2020-10-22T20:12:25Z", "commit": {"oid": "922d2723b05515c25f88a5c197feb771e419486e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoxMjoyNVrOHmyF2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMDoxMjoyNVrOHmyF2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQyODYzNQ==", "bodyText": "nit, complete the comment", "url": "https://github.com/linkedin/ambry/pull/1668#discussion_r510428635", "createdAt": "2020-10-22T20:12:25Z", "author": {"login": "jsjtzyy"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/VcrServer.java", "diffHunk": "@@ -98,10 +103,12 @@ public VcrServer(VerifiableProperties properties, ClusterAgentsFactory clusterAg\n    * @param clusterAgentsFactory the {@link ClusterAgentsFactory} to use.\n    * @param notificationSystem the {@link NotificationSystem} to use.\n    * @param cloudDestinationFactory the {@link CloudDestinationFactory} to use.\n+   * @param reporterFactory", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "922d2723b05515c25f88a5c197feb771e419486e"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4796e902ae1f747b4c255a8463d9b22f90117d97", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/4796e902ae1f747b4c255a8463d9b22f90117d97", "committedDate": "2020-10-22T22:54:35Z", "message": "fix doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTg4NDgx", "url": "https://github.com/linkedin/ambry/pull/1668#pullrequestreview-515188481", "createdAt": "2020-10-22T23:36:18Z", "commit": {"oid": "4796e902ae1f747b4c255a8463d9b22f90117d97"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMzozNjoxOFrOHm3W8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMzo0MDoyN1rOHm3bmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxNDkyOQ==", "bodyText": "I like this Function usage.  It's inconsistent with the other factory interfaces we use, but it seems like a sensible shortcut.", "url": "https://github.com/linkedin/ambry/pull/1668#discussion_r510514929", "createdAt": "2020-10-22T23:36:18Z", "author": {"login": "lightningrob"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/VcrServer.java", "diffHunk": "@@ -74,6 +75,7 @@\n   private JmxReporter reporter = null;\n   private ConnectionPool connectionPool = null;\n   private final NotificationSystem notificationSystem;\n+  private final Function<MetricRegistry, JmxReporter> reporterFactory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4796e902ae1f747b4c255a8463d9b22f90117d97"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxNjEyMg==", "bodyText": "Ideally we should have a test case that passes a non-null reporterFactory.", "url": "https://github.com/linkedin/ambry/pull/1668#discussion_r510516122", "createdAt": "2020-10-22T23:40:27Z", "author": {"login": "lightningrob"}, "path": "ambry-rest/src/main/java/com/github/ambry/rest/RestServer.java", "diffHunk": "@@ -171,17 +172,20 @@ public RestServer(VerifiableProperties verifiableProperties, ClusterMap clusterM\n    * @param sslFactory the {@link SSLFactory} to be used. This can be {@code null} if no components require SSL support.\n    * @param addedChannelHandlers a list of {@link ChannelHandler} to add to the {@link io.netty.channel.ChannelInitializer} before\n    *                             the final handler.\n+   * @param reporterFactory if non-null, use this function to set up a {@link JmxReporter} with custom settings. If this\n+   *                        option is null the default settings for the reporter will be used.\n    * @throws InstantiationException if there is any error instantiating an instance of RestServer.\n    */\n   public RestServer(VerifiableProperties verifiableProperties, ClusterMap clusterMap,\n-      NotificationSystem notificationSystem, SSLFactory sslFactory, List<ChannelHandler> addedChannelHandlers)\n-      throws Exception {\n+      NotificationSystem notificationSystem, SSLFactory sslFactory, List<ChannelHandler> addedChannelHandlers,\n+      Function<MetricRegistry, JmxReporter> reporterFactory) throws Exception {\n     if (verifiableProperties == null || clusterMap == null || notificationSystem == null) {\n       throw new IllegalArgumentException(\"Null arg(s) received during instantiation of RestServer\");\n     }\n     MetricRegistry metricRegistry = clusterMap.getMetricRegistry();\n     RestServerConfig restServerConfig = new RestServerConfig(verifiableProperties);\n-    reporter = JmxReporter.forRegistry(metricRegistry).build();\n+    reporter = reporterFactory != null ? reporterFactory.apply(metricRegistry)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4796e902ae1f747b4c255a8463d9b22f90117d97"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f35debc562b97b138f26aadbd76c5a13a3e3a920", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/f35debc562b97b138f26aadbd76c5a13a3e3a920", "committedDate": "2020-10-23T17:37:35Z", "message": "Add test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1ODc4NjUz", "url": "https://github.com/linkedin/ambry/pull/1668#pullrequestreview-515878653", "createdAt": "2020-10-23T17:45:04Z", "commit": {"oid": "f35debc562b97b138f26aadbd76c5a13a3e3a920"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1ODg5ODc1", "url": "https://github.com/linkedin/ambry/pull/1668#pullrequestreview-515889875", "createdAt": "2020-10-23T18:01:19Z", "commit": {"oid": "f35debc562b97b138f26aadbd76c5a13a3e3a920"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 957, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}