{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MjEwNzEy", "number": 1666, "title": "[named_blobs] Add NamedBlobDB interface/MySQL impl", "bodyText": "Add an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching.", "createdAt": "2020-10-19T18:57:43Z", "url": "https://github.com/linkedin/ambry/pull/1666", "merged": true, "mergeCommit": {"oid": "c28a89b864a772ce52f840c5aadc59e0112348cf"}, "closed": true, "closedAt": "2020-11-21T02:05:43Z", "author": {"login": "cgtz"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVKDaCgBqjM5MTE0MzUxMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdehQrjgH2gAyNTA2MjEwNzEyOmMyZDkxNDQyMWRiNjIwMjlhN2E5ZjhhYjA0NmNkYzcxNTYzZjc3MWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94516dcedd97acdf4895383f632b3e75b11a7818", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/94516dcedd97acdf4895383f632b3e75b11a7818", "committedDate": "2020-10-19T18:55:38Z", "message": "[named_blobs] Add NamedBlobDB interface\n\nAdd an interface and a skeleton implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs."}, "afterCommit": {"oid": "3520f3e95c68efc4ba78bde1e8959481be78dadc", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/3520f3e95c68efc4ba78bde1e8959481be78dadc", "committedDate": "2020-10-22T22:52:17Z", "message": "[named_blobs] Add NamedBlobDB interface\n\nAdd an interface and a skeleton implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61ae1d7b87bd8fe213be5bdac33749f2acee2372", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/61ae1d7b87bd8fe213be5bdac33749f2acee2372", "committedDate": "2020-11-02T22:00:13Z", "message": "Add get and put impl"}, "afterCommit": {"oid": "aa8b338c3a293cb4347e0ae5e0dbee698797c3fc", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/aa8b338c3a293cb4347e0ae5e0dbee698797c3fc", "committedDate": "2020-11-12T17:29:07Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nFor the first iteration, this does not include retry and failover to\nother active databases."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa8b338c3a293cb4347e0ae5e0dbee698797c3fc", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/aa8b338c3a293cb4347e0ae5e0dbee698797c3fc", "committedDate": "2020-11-12T17:29:07Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nFor the first iteration, this does not include retry and failover to\nother active databases."}, "afterCommit": {"oid": "6cdfdcf03b5554f008b9c0fd7382c9030fbff426", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/6cdfdcf03b5554f008b9c0fd7382c9030fbff426", "committedDate": "2020-11-16T21:59:40Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nFor the first iteration, this does not include retry and failover to\nother active databases."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cdfdcf03b5554f008b9c0fd7382c9030fbff426", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/6cdfdcf03b5554f008b9c0fd7382c9030fbff426", "committedDate": "2020-11-16T21:59:40Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nFor the first iteration, this does not include retry and failover to\nother active databases."}, "afterCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/0f2712caca6250a2c756fe33aa7a8374182efa25", "committedDate": "2020-11-16T23:50:37Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODE4NDUx", "url": "https://github.com/linkedin/ambry/pull/1666#pullrequestreview-532818451", "createdAt": "2020-11-17T21:15:44Z", "commit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMToxNTo0NFrOH1Lwzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMToyNzowMVrOH1MIhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUyOTI5NA==", "bodyText": "I would have preferred AmbryNamedBlobs, but you may have already provisioned it with that name.", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525529294", "createdAt": "2020-11-17T21:15:44Z", "author": {"login": "lightningrob"}, "path": ".travis.yml", "diffHunk": "@@ -28,6 +28,8 @@ before_install:\n   - mysql --version\n   - mysql -e 'CREATE DATABASE AccountMetadata;'\n   - mysql -e 'USE AccountMetadata; SOURCE ./ambry-account/src/main/resources/AccountSchema.ddl;'\n+  - mysql -e 'CREATE DATABASE AmbryBlobs;'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMDk5Nw==", "bodyText": "Javadocs", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525530997", "createdAt": "2020-11-17T21:19:07Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/named/NamedBlobDb.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Container;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+\n+public interface NamedBlobDb {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMTY3Ng==", "bodyText": "Are the methods going to throw only unchecked exceptions on errors?", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525531676", "createdAt": "2020-11-17T21:20:16Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/named/NamedBlobDb.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Container;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+\n+public interface NamedBlobDb {\n+  CompletableFuture<NamedBlobRecord> get(String accountName, String containerName, String blobName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMjIwNQ==", "bodyText": "Optional: might be useful to return the NamedBlobRecord with blobId filled in.", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525532205", "createdAt": "2020-11-17T21:21:19Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/named/NamedBlobDb.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Container;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+\n+public interface NamedBlobDb {\n+  CompletableFuture<NamedBlobRecord> get(String accountName, String containerName, String blobName);\n+\n+  CompletableFuture<Page<NamedBlobRecord>> list(String accountName, String containerName, String blobNamePrefix, String continuationToken);\n+\n+  CompletableFuture<Void> put(NamedBlobRecord record);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMjgyOA==", "bodyText": "Will the caller ever need to know if the deletion happened?  Or will this throw an exception on blob not found?", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525532828", "createdAt": "2020-11-17T21:22:29Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/named/NamedBlobDb.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Container;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+\n+public interface NamedBlobDb {\n+  CompletableFuture<NamedBlobRecord> get(String accountName, String containerName, String blobName);\n+\n+  CompletableFuture<Page<NamedBlobRecord>> list(String accountName, String containerName, String blobNamePrefix, String continuationToken);\n+\n+  CompletableFuture<Void> put(NamedBlobRecord record);\n+\n+  CompletableFuture<Void> delete(String accountName, String containerName, String blobName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMzMyOA==", "bodyText": "Minor: javadocs", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525533328", "createdAt": "2020-11-17T21:23:24Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/named/NamedBlobRecord.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import java.util.Objects;\n+\n+\n+/**\n+ * Represents a metadata record in a {@link NamedBlobDb} implementation.\n+ */\n+public class NamedBlobRecord {\n+  private final String accountName;\n+  private final String containerName;\n+  private final String blobName;\n+  private final String blobId;\n+  private final long expirationTimeMs;\n+\n+  public NamedBlobRecord(String accountName, String containerName, String blobName, String blobId,\n+      long expirationTimeMs) {\n+    this.accountName = accountName;\n+    this.containerName = containerName;\n+    this.blobName = blobName;\n+    this.blobId = blobId;\n+    this.expirationTimeMs = expirationTimeMs;\n+  }\n+\n+  public String getAccountName() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzNTM2Nw==", "bodyText": "Can you use string constants for table and column names?", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525535367", "createdAt": "2020-11-17T21:27:01Z", "author": {"login": "lightningrob"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -0,0 +1,290 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Account;\n+import com.github.ambry.account.AccountService;\n+import com.github.ambry.account.Container;\n+import com.github.ambry.mysql.MySqlUtils;\n+import com.github.ambry.mysql.MySqlUtils.DbEndpoint;\n+import com.github.ambry.config.MySqlNamedBlobDbConfig;\n+import com.github.ambry.rest.RestServiceErrorCode;\n+import com.github.ambry.rest.RestServiceException;\n+import com.github.ambry.utils.Utils;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.Statement;\n+import java.sql.Timestamp;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.stream.Collectors;\n+import javax.sql.DataSource;\n+import org.apache.commons.codec.binary.Base64;\n+\n+\n+/**\n+ * An implementation of {@link NamedBlobDb} that uses an active-active MySQL deployment as the source of truth for\n+ * named blob mappings.\n+ *\n+ * It uses the Hikari library for connection pooling, which is a widely used and performant JDBC connection pool\n+ * implementation.\n+ */\n+public class MySqlNamedBlobDb implements NamedBlobDb {\n+  // query building blocks\n+  private static final String IS_DELETED = \"(deleted_ts IS NOT NULL AND deleted_ts <= CURRENT_TIMESTAMP(6))\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTIyMTcy", "url": "https://github.com/linkedin/ambry/pull/1666#pullrequestreview-533122172", "createdAt": "2020-11-18T05:51:56Z", "commit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNTo1MTo1NlrOH1eJUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNjowODo0OFrOH1edmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgzMDQ4MQ==", "bodyText": "A quick question, if the blob has been deleted or expired, do we need to throw the exception similar like the get method or simply excluding it from the element is good enough? I just feel it might be better if we can tell why some expired blob are not listed.", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525830481", "createdAt": "2020-11-18T05:51:56Z", "author": {"login": "SophieGuo410"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -0,0 +1,290 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.github.ambry.account.Account;\n+import com.github.ambry.account.AccountService;\n+import com.github.ambry.account.Container;\n+import com.github.ambry.mysql.MySqlUtils;\n+import com.github.ambry.mysql.MySqlUtils.DbEndpoint;\n+import com.github.ambry.config.MySqlNamedBlobDbConfig;\n+import com.github.ambry.rest.RestServiceErrorCode;\n+import com.github.ambry.rest.RestServiceException;\n+import com.github.ambry.utils.Utils;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.Statement;\n+import java.sql.Timestamp;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.stream.Collectors;\n+import javax.sql.DataSource;\n+import org.apache.commons.codec.binary.Base64;\n+\n+\n+/**\n+ * An implementation of {@link NamedBlobDb} that uses an active-active MySQL deployment as the source of truth for\n+ * named blob mappings.\n+ *\n+ * It uses the Hikari library for connection pooling, which is a widely used and performant JDBC connection pool\n+ * implementation.\n+ */\n+public class MySqlNamedBlobDb implements NamedBlobDb {\n+  // query building blocks\n+  private static final String IS_DELETED = \"(deleted_ts IS NOT NULL AND deleted_ts <= CURRENT_TIMESTAMP(6))\";\n+  private static final String IS_EXPIRED = \"(expires_ts IS NOT NULL AND expires_ts <= CURRENT_TIMESTAMP(6))\";\n+  private static final String IS_DELETED_OR_EXPIRED = IS_DELETED + \" OR \" + IS_EXPIRED;\n+  private static final String WHERE_PK_MATCH = \"WHERE (account_id, container_id, blob_name) = (?, ?, ?)\";\n+\n+  /**\n+   * Select a record that matches a blob name (lookup by primary key).\n+   */\n+  private static final String GET_QUERY = \"SELECT blob_id, expires_ts, deleted_ts FROM named_blobs \" + WHERE_PK_MATCH;\n+\n+  /**\n+   * Select records up to a specific limit where the blob name starts with a string prefix. The fourth parameter can\n+   * be used for pagination.\n+   */\n+  private static final String LIST_QUERY = \"SELECT blob_name, blob_id, expires_ts, deleted_ts FROM named_blobs \"\n+      + \"WHERE (account_id, container_id) = (?, ?) AND blob_name LIKE ? AND blob_name >= ? LIMIT ?\";\n+\n+  /**\n+   * Create a blob name to blob ID mapping if a record for that blob name does not exist.\n+   * If there is an existing record but the existing blob was soft deleted or expired, allow it to be overwritten.\n+   * If there is an existing record and the existing blob is still valid (not expired or soft deleted), do not\n+   * overwrite it.\n+   * <p>\n+   * Eventually the put operation will support updates to the mapping in the third case above, but that requires other\n+   * work around concurrency control.\n+   */\n+  private static final String PUT_QUERY = String.format(\n+      \"INSERT INTO named_blobs (account_id, container_id, blob_name, blob_id, expires_ts)\\n\"\n+          + \"VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE\\n\" + \"  blob_id = IF(%1$s, VALUES(blob_id), blob_id),\\n\"\n+          + \"  expires_ts = IF(%1$s, VALUES(expires_ts), expires_ts),\\n\" + \"  deleted_ts = IF(%1$s, null, deleted_ts)\",\n+      IS_DELETED_OR_EXPIRED);\n+\n+  /**\n+   * Soft delete a blob by setting the delete timestamp to the current time if the blob is not already deleted.\n+   */\n+  private static final String DELETE_QUERY =\n+      \"UPDATE named_blobs SET deleted_ts = IF(\" + IS_DELETED + \", deleted_ts, CURRENT_TIMESTAMP(6)) \" + WHERE_PK_MATCH;\n+\n+  private final AccountService accountService;\n+  private final Map<String, DataSource> dcToDataSource;\n+  private final String localDatacenter;\n+  private final ExecutorService executorService;\n+  private final MySqlNamedBlobDbConfig config;\n+\n+  MySqlNamedBlobDb(AccountService accountService, MySqlNamedBlobDbConfig config, DataSourceFactory dataSourceFactory,\n+      String localDatacenter) {\n+    this.accountService = accountService;\n+    this.config = config;\n+    this.localDatacenter = localDatacenter;\n+    this.dcToDataSource = MySqlUtils.getDbEndpointsPerDC(config.dbInfo)\n+        .values()\n+        .stream()\n+        .flatMap(List::stream)\n+        .filter(DbEndpoint::isWriteable)\n+        .collect(Collectors.toMap(DbEndpoint::getDatacenter, dataSourceFactory::getDataSource));\n+    // size this to match the connection pool\n+    executorService = Executors.newFixedThreadPool(config.poolSize);\n+  }\n+\n+  @Override\n+  public CompletableFuture<NamedBlobRecord> get(String accountName, String containerName, String blobName) {\n+    return executeTransactionAsync(accountName, containerName, (accountId, containerId, connection) -> {\n+      try (PreparedStatement statement = connection.prepareStatement(GET_QUERY)) {\n+        statement.setInt(1, accountId);\n+        statement.setInt(2, containerId);\n+        statement.setString(3, blobName);\n+        try (ResultSet resultSet = statement.executeQuery()) {\n+          if (!resultSet.next()) {\n+            throw new RestServiceException(\"Named blob not found\", RestServiceErrorCode.NotFound);\n+          }\n+          String blobId = Base64.encodeBase64URLSafeString(resultSet.getBytes(1));\n+          Timestamp expirationTime = resultSet.getTimestamp(2);\n+          if (expirationTime != null && expirationTime.getTime() < System.currentTimeMillis()) {\n+            throw new RestServiceException(\"Named blob deleted or expired\", RestServiceErrorCode.Deleted);\n+          }\n+          return new NamedBlobRecord(accountName, containerName, blobName, blobId,\n+              expirationTime != null ? expirationTime.getTime() : Utils.Infinite_Time);\n+        }\n+      }\n+    });\n+  }\n+\n+  @Override\n+  public CompletableFuture<Page<NamedBlobRecord>> list(String accountName, String containerName, String blobNamePrefix,\n+      String continuationToken) {\n+    return executeTransactionAsync(accountName, containerName, (accountId, containerId, connection) -> {\n+      try (PreparedStatement statement = connection.prepareStatement(LIST_QUERY)) {\n+        statement.setInt(1, accountId);\n+        statement.setInt(2, containerId);\n+        statement.setString(3, blobNamePrefix + \"%\");\n+        statement.setString(4, continuationToken != null ? continuationToken : blobNamePrefix);\n+        statement.setInt(5, config.listMaxResults + 1);\n+        try (ResultSet resultSet = statement.executeQuery()) {\n+          String nextContinuationToken = null;\n+          List<NamedBlobRecord> elements = new ArrayList<>();\n+          int resultIndex = 0;\n+          while (resultSet.next()) {\n+            if (resultIndex++ == config.listMaxResults) {\n+              nextContinuationToken = resultSet.getString(1);\n+              break;\n+            }\n+            String blobName = resultSet.getString(1);\n+            String blobId = Base64.encodeBase64URLSafeString(resultSet.getBytes(2));\n+            Timestamp expirationTime = resultSet.getTimestamp(3);\n+            Timestamp deletionTime = resultSet.getTimestamp(4);\n+            long currentTime = System.currentTimeMillis();\n+            if (compareTimestamp(expirationTime, currentTime) > 0 && compareTimestamp(deletionTime, currentTime) > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "originalPosition": 158}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgzNTY3Mw==", "bodyText": "May I know which module will call this factory to get the db? Are you planning to call it in IdConverter?", "url": "https://github.com/linkedin/ambry/pull/1666#discussion_r525835673", "createdAt": "2020-11-18T06:08:48Z", "author": {"login": "SophieGuo410"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDbFactory.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+\n+package com.github.ambry.named;\n+\n+import com.codahale.metrics.MetricRegistry;\n+import com.github.ambry.account.AccountService;\n+import com.github.ambry.mysql.MySqlUtils.DbEndpoint;\n+import com.github.ambry.config.ClusterMapConfig;\n+import com.github.ambry.config.MySqlNamedBlobDbConfig;\n+import com.github.ambry.config.VerifiableProperties;\n+import com.zaxxer.hikari.HikariConfig;\n+import com.zaxxer.hikari.HikariDataSource;\n+\n+\n+public class MySqlNamedBlobDbFactory implements NamedBlobDbFactory {\n+  private final MySqlNamedBlobDbConfig config;\n+  private final String localDatacenter;\n+  private final MetricRegistry metricRegistry;\n+  private final AccountService accountService;\n+\n+  public MySqlNamedBlobDbFactory(VerifiableProperties verifiableProperties, MetricRegistry metricRegistry,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f2712caca6250a2c756fe33aa7a8374182efa25", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/0f2712caca6250a2c756fe33aa7a8374182efa25", "committedDate": "2020-11-16T23:50:37Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching."}, "afterCommit": {"oid": "e5782e2d97832af229ff62470449310b1dea62b9", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/e5782e2d97832af229ff62470449310b1dea62b9", "committedDate": "2020-11-19T17:29:59Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e5782e2d97832af229ff62470449310b1dea62b9", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/e5782e2d97832af229ff62470449310b1dea62b9", "committedDate": "2020-11-19T17:29:59Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching."}, "afterCommit": {"oid": "dfae35afadfcab4bba028c6c709eeaf5e056d07d", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/dfae35afadfcab4bba028c6c709eeaf5e056d07d", "committedDate": "2020-11-20T17:29:23Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dfae35afadfcab4bba028c6c709eeaf5e056d07d", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/dfae35afadfcab4bba028c6c709eeaf5e056d07d", "committedDate": "2020-11-20T17:29:23Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching."}, "afterCommit": {"oid": "64376ca74a96a14c60b9b2b9364e316abb5e9e30", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/64376ca74a96a14c60b9b2b9364e316abb5e9e30", "committedDate": "2020-11-20T17:33:42Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODI4NDM4", "url": "https://github.com/linkedin/ambry/pull/1666#pullrequestreview-535828438", "createdAt": "2020-11-20T22:52:23Z", "commit": {"oid": "c1764760af4b4a7c8b04216641f9110290134d74"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODMwNTYz", "url": "https://github.com/linkedin/ambry/pull/1666#pullrequestreview-535830563", "createdAt": "2020-11-20T22:57:40Z", "commit": {"oid": "c1764760af4b4a7c8b04216641f9110290134d74"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1764760af4b4a7c8b04216641f9110290134d74", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/c1764760af4b4a7c8b04216641f9110290134d74", "committedDate": "2020-11-20T22:43:05Z", "message": "Minor fixes"}, "afterCommit": {"oid": "02ad8538350427e9d89fc9526759e3e3fcdbaf35", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/02ad8538350427e9d89fc9526759e3e3fcdbaf35", "committedDate": "2020-11-20T23:58:52Z", "message": "Minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "880076267ad41878cbf5bcd7f0cb46c4ccf8fcfd", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/880076267ad41878cbf5bcd7f0cb46c4ccf8fcfd", "committedDate": "2020-11-21T00:29:06Z", "message": "[named_blobs] Add NamedBlobDB interface/MySQL impl\n\nAdd an interface and a MySQL implementation of NamedBlobDB.\nThis interface will enable interaction with a mutable mapping layer for\nnamed blobs.\n\nAdd a mysql based implementation that supports the put/get/list/delete\nAPIs. For the first iteration, this does not include retry and failover to\nother active databases. This implementation uses Hikari for connection\npooling and built-in mysql connector options for prepared statement\ncaching."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bdf16484b23beebd37d4e77cd7fd9039bbbacfb", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/6bdf16484b23beebd37d4e77cd7fd9039bbbacfb", "committedDate": "2020-11-21T00:29:06Z", "message": "Add config for NamedBlobDbFactory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0ef486eb65341d1894a43c512a488c2871a9276", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/a0ef486eb65341d1894a43c512a488c2871a9276", "committedDate": "2020-11-21T00:29:06Z", "message": "Minor fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02ad8538350427e9d89fc9526759e3e3fcdbaf35", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/02ad8538350427e9d89fc9526759e3e3fcdbaf35", "committedDate": "2020-11-20T23:58:52Z", "message": "Minor fixes"}, "afterCommit": {"oid": "a0ef486eb65341d1894a43c512a488c2871a9276", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/a0ef486eb65341d1894a43c512a488c2871a9276", "committedDate": "2020-11-21T00:29:06Z", "message": "Minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2d914421db62029a7a9f8ab046cdc71563f771c", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/c2d914421db62029a7a9f8ab046cdc71563f771c", "committedDate": "2020-11-21T01:00:03Z", "message": "fix rebase issue"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 950, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}