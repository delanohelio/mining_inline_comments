{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzNzM4ODEz", "number": 1735, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzowNDowOVrOFLeW9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzozMjowN1rOFLewiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NTc2MDUzOnYy", "diffSide": "LEFT", "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/NamedBlobPutHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzowNDowOVrOIOquwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQyMDo1MDozNlrOIT2uqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1MTA3Mg==", "bodyText": "Is there any logic change in this class or only refactoring?", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r552251072", "createdAt": "2021-01-05T23:04:09Z", "author": {"login": "lightningrob"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/NamedBlobPutHandler.java", "diffHunk": "@@ -145,48 +145,6 @@ private void start() {\n       }\n     }\n \n-    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzY5MDUzOA==", "bodyText": "Just refactoring", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r557690538", "createdAt": "2021-01-14T20:50:36Z", "author": {"login": "cgtz"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/NamedBlobPutHandler.java", "diffHunk": "@@ -145,48 +145,6 @@ private void start() {\n       }\n     }\n \n-    /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1MTA3Mg=="}, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NTc5MzYxOnYy", "diffSide": "RIGHT", "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzoxODowN1rOIOrCKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQyMDo1MzowOFrOIT20jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1NjA0Mw==", "bodyText": "Still need the indexes (4,5,6)?", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r552256043", "createdAt": "2021-01-05T23:18:07Z", "author": {"login": "lightningrob"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -84,27 +83,32 @@\n       EXPIRES_TS, DELETED_TS, NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID);\n \n   /**\n-   * Create a blob name to blob ID mapping if a record for that blob name does not exist.\n-   * If there is an existing record but the existing blob was soft deleted or expired, allow it to be overwritten.\n-   * If there is an existing record and the existing blob is still valid (not expired or soft deleted), do not\n-   * overwrite it.\n-   * <p>\n-   * Eventually the put operation will support updates to the mapping in the third case above, but that requires other\n-   * work around concurrency control.\n+   * Attempt to insert a new mapping into the database.\n    */\n-  private static final String PUT_QUERY = String.format(\n-      \"INSERT INTO %1$s (%2$s, %3$s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE \"\n-          + \"%5$s = IF(%8$s, VALUES(%5$s), %5$s), %6$s = IF(%8$s, VALUES(%6$s), %6$s), %7$s = IF(%8$s, null, %7$s)\",\n-      NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID, BLOB_NAME, BLOB_ID, EXPIRES_TS, DELETED_TS, IS_DELETED_OR_EXPIRED);\n+  private static final String INSERT_QUERY =\n+      String.format(\"INSERT INTO %s (%s, %s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?)\", NAMED_BLOBS, ACCOUNT_ID,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzY5MjA0NA==", "bodyText": "You are right that these aren't required. I will make sure to fix this in my next PR", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r557692044", "createdAt": "2021-01-14T20:53:08Z", "author": {"login": "cgtz"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -84,27 +83,32 @@\n       EXPIRES_TS, DELETED_TS, NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID);\n \n   /**\n-   * Create a blob name to blob ID mapping if a record for that blob name does not exist.\n-   * If there is an existing record but the existing blob was soft deleted or expired, allow it to be overwritten.\n-   * If there is an existing record and the existing blob is still valid (not expired or soft deleted), do not\n-   * overwrite it.\n-   * <p>\n-   * Eventually the put operation will support updates to the mapping in the third case above, but that requires other\n-   * work around concurrency control.\n+   * Attempt to insert a new mapping into the database.\n    */\n-  private static final String PUT_QUERY = String.format(\n-      \"INSERT INTO %1$s (%2$s, %3$s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE \"\n-          + \"%5$s = IF(%8$s, VALUES(%5$s), %5$s), %6$s = IF(%8$s, VALUES(%6$s), %6$s), %7$s = IF(%8$s, null, %7$s)\",\n-      NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID, BLOB_NAME, BLOB_ID, EXPIRES_TS, DELETED_TS, IS_DELETED_OR_EXPIRED);\n+  private static final String INSERT_QUERY =\n+      String.format(\"INSERT INTO %s (%s, %s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?)\", NAMED_BLOBS, ACCOUNT_ID,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1NjA0Mw=="}, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NTc5OTY3OnYy", "diffSide": "RIGHT", "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzoyMDo0M1rOIOrFwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQyMDo1MzozNFrOIT21jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1Njk2MQ==", "bodyText": "Just curious, why are you updating the blobId column here?", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r552256961", "createdAt": "2021-01-05T23:20:43Z", "author": {"login": "lightningrob"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -84,27 +83,32 @@\n       EXPIRES_TS, DELETED_TS, NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID);\n \n   /**\n-   * Create a blob name to blob ID mapping if a record for that blob name does not exist.\n-   * If there is an existing record but the existing blob was soft deleted or expired, allow it to be overwritten.\n-   * If there is an existing record and the existing blob is still valid (not expired or soft deleted), do not\n-   * overwrite it.\n-   * <p>\n-   * Eventually the put operation will support updates to the mapping in the third case above, but that requires other\n-   * work around concurrency control.\n+   * Attempt to insert a new mapping into the database.\n    */\n-  private static final String PUT_QUERY = String.format(\n-      \"INSERT INTO %1$s (%2$s, %3$s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE \"\n-          + \"%5$s = IF(%8$s, VALUES(%5$s), %5$s), %6$s = IF(%8$s, VALUES(%6$s), %6$s), %7$s = IF(%8$s, null, %7$s)\",\n-      NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID, BLOB_NAME, BLOB_ID, EXPIRES_TS, DELETED_TS, IS_DELETED_OR_EXPIRED);\n+  private static final String INSERT_QUERY =\n+      String.format(\"INSERT INTO %s (%s, %s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?)\", NAMED_BLOBS, ACCOUNT_ID,\n+          CONTAINER_ID, BLOB_NAME, BLOB_ID, EXPIRES_TS);\n \n-  private static final String SELECT_FOR_DELETE_QUERY =\n+  /**\n+   * If a record already exists for a named blob, attempt an update if the record in the DB represents an expired or\n+   * deleted blob.\n+   */\n+  private static final String UPDATE_IF_DELETED_OR_EXPIRED_QUERY =\n+      String.format(\"UPDATE %s SET %s = ?, %s = ?, %s = null WHERE %s AND %s\", NAMED_BLOBS, BLOB_ID, EXPIRES_TS,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzY5MjMwMQ==", "bodyText": "This would allow one to replace a soft deleted record with a new blob.\nA put to the same key when a value was previously deleted is an allowed operation.", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r557692301", "createdAt": "2021-01-14T20:53:34Z", "author": {"login": "cgtz"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -84,27 +83,32 @@\n       EXPIRES_TS, DELETED_TS, NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID);\n \n   /**\n-   * Create a blob name to blob ID mapping if a record for that blob name does not exist.\n-   * If there is an existing record but the existing blob was soft deleted or expired, allow it to be overwritten.\n-   * If there is an existing record and the existing blob is still valid (not expired or soft deleted), do not\n-   * overwrite it.\n-   * <p>\n-   * Eventually the put operation will support updates to the mapping in the third case above, but that requires other\n-   * work around concurrency control.\n+   * Attempt to insert a new mapping into the database.\n    */\n-  private static final String PUT_QUERY = String.format(\n-      \"INSERT INTO %1$s (%2$s, %3$s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE \"\n-          + \"%5$s = IF(%8$s, VALUES(%5$s), %5$s), %6$s = IF(%8$s, VALUES(%6$s), %6$s), %7$s = IF(%8$s, null, %7$s)\",\n-      NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID, BLOB_NAME, BLOB_ID, EXPIRES_TS, DELETED_TS, IS_DELETED_OR_EXPIRED);\n+  private static final String INSERT_QUERY =\n+      String.format(\"INSERT INTO %s (%s, %s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?)\", NAMED_BLOBS, ACCOUNT_ID,\n+          CONTAINER_ID, BLOB_NAME, BLOB_ID, EXPIRES_TS);\n \n-  private static final String SELECT_FOR_DELETE_QUERY =\n+  /**\n+   * If a record already exists for a named blob, attempt an update if the record in the DB represents an expired or\n+   * deleted blob.\n+   */\n+  private static final String UPDATE_IF_DELETED_OR_EXPIRED_QUERY =\n+      String.format(\"UPDATE %s SET %s = ?, %s = ?, %s = null WHERE %s AND %s\", NAMED_BLOBS, BLOB_ID, EXPIRES_TS,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1Njk2MQ=="}, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NTgyNjAwOnYy", "diffSide": "RIGHT", "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzozMjowN1rOIOrU1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQyMDo1NToyNFrOIT24_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2MDgyMQ==", "bodyText": "What happens to the locked record if the update is not made?  In either case, when does it get unlocked (not sure if this whole thing is inside a transaction)?", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r552260821", "createdAt": "2021-01-05T23:32:07Z", "author": {"login": "lightningrob"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -250,8 +276,8 @@\n       }\n       // only need to issue an update statement if the row was not already marked as deleted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzY5MzE4Mw==", "bodyText": "Yep this whole thing is inside a transaction. In this case, the row is unlocked when the transaction is finished (executeTransactionAsync calls transaction.commit() or rollback())", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r557693183", "createdAt": "2021-01-14T20:55:24Z", "author": {"login": "cgtz"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -250,8 +276,8 @@\n       }\n       // only need to issue an update statement if the row was not already marked as deleted.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2MDgyMQ=="}, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 150}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1192, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}