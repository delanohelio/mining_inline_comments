{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NTg3NjAx", "number": 1387, "title": "Enabled automated, sequenced releases from Travis CI", "bodyText": "The goal is to release automatically from Travis and enable convenient merging of PRs, even if many PRs are merged concurrently (bug in Shipkit Gradle plugin: mockito/shipkit#395).\nImportant Add 'GIT_SECRET' env variable in Travis UI in format: user:github_access_token, for example: mockitoguy:qq43234xc23x23d24d\nMore details:\n\ninstead of using Shipkit Gradle plugin we keep most CI/CD automation inside Ambry project. This way, it is easier to configure, debug and understand.\nwe're using a new Gradle plugin \"shipkit-auto-version\". This plugin automatically deducts the version based on the most recent tag and the \"version.properties\" file.  It is a very simple plugin, keeps the build logic simple, and keeps the Ambry build easy to maintain in the future.\n\nThis PR removes following features (acceptable trade-offs, we can implement it in the future):\n\nautomated release notes generation", "createdAt": "2020-02-14T21:52:16Z", "url": "https://github.com/linkedin/ambry/pull/1387", "merged": true, "mergeCommit": {"oid": "07b00a9849be6e1f38e0410bece648f93a5ba92b"}, "closed": true, "closedAt": "2020-02-21T22:03:23Z", "author": {"login": "mockitoguy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEJwXOgH2gAyMzc1NTg3NjAxOjk3NTUxNzYzZjhlNjMzZTFiMjY1N2E3MzZmZjQzYmRjZTlkNDNlZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGnFJkgFqTM2Mjk0MzU2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "97551763f8e633e1b2657a736ff43bdce9d43ef1", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/97551763f8e633e1b2657a736ff43bdce9d43ef1", "committedDate": "2020-02-14T06:43:45Z", "message": "Enabled continuous releases from Travis CI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MzYxMDk4", "url": "https://github.com/linkedin/ambry/pull/1387#pullrequestreview-359361098", "createdAt": "2020-02-15T19:05:37Z", "commit": {"oid": "97551763f8e633e1b2657a736ff43bdce9d43ef1"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQxOTowNTozOFrOFqQL-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNVQyMjo0NToxOFrOFqQ3sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg0OTcyMg==", "bodyText": "this should be linkedin/ambry", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r379849722", "createdAt": "2020-02-15T19:05:38Z", "author": {"login": "cgtz"}, "path": "gradle/git-push.sh", "diffHunk": "@@ -0,0 +1,11 @@\n+#!/bin/sh\n+\n+#Git push is implemented in the script to make sure we are not leaking GH key to the output\n+#Expects 'GIT_SECRET' env variable to be in format: user:github_access_token, \n+#for example: mockitoguy:qq43234xc23x23d24d\n+\n+echo \"Running git push without output for security. If it fails make sure that GIT_SECRET env variable is set.\"\n+git push --quiet https://$GIT_SECRET@github.com/mockitoguy/ambry.git --tags > /dev/null 2>&1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97551763f8e633e1b2657a736ff43bdce9d43ef1"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg0OTc3MQ==", "bodyText": "add newlines at the end of the newly added files", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r379849771", "createdAt": "2020-02-15T19:06:16Z", "author": {"login": "cgtz"}, "path": "gradle/ci-release.gradle", "diffHunk": "@@ -0,0 +1,37 @@\n+task bintrayUploadAll {\n+    description = \"Runs 'bintrayUpload' tasks from all projects\"\n+    mustRunAfter \"gitPush\" //git push is easier to rollback so we run it first\n+}\n+\n+allprojects {\n+    tasks.matching { it.name == \"bintrayUpload\" }.all {\n+        bintrayUploadAll.dependsOn it\n+    }\n+}\n+\n+task ciPerformRelease {\n+    description = \"Performs the release, intended to be ran on CI\"\n+    dependsOn \"gitTag\", \"gitPush\", \"bintrayUploadAll\"    \n+}\n+\n+task gitTag {\n+    description = \"Creates annotated tag 'v$version'\"\n+\n+    doLast {\n+        println \"Setting Git user and email to Travis CI\"\n+        exec { commandLine \"git\", \"config\", \"user.email\", \"travis@travis-ci.org\" }\n+        exec { commandLine \"git\", \"config\", \"user.name\", \"Travis CI\" }\n+        println \"Creating tag v$version\"\n+        exec { commandLine \"git\", \"tag\", \"-a\", \"-m\", \"Release $version\", \"v$version\" }\n+        println \"Created tag v$version\"\n+    }\n+}\n+\n+task gitPush(type: Exec) {\n+    description = \"Pushes tags by running 'git push --tags'. Hides secret key from git push output.\"\n+    mustRunAfter \"gitTag\" //tag first, push later\n+    \n+    doFirst { println \"Pushing tag v$version\" }\n+    commandLine \"./gradle/git-push.sh\", \"v$version\"\n+    doLast { println \"Pushed tag v$version\" }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97551763f8e633e1b2657a736ff43bdce9d43ef1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg1MTA2Mg==", "bodyText": "some extra spaces here", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r379851062", "createdAt": "2020-02-15T19:29:23Z", "author": {"login": "cgtz"}, "path": "build.gradle", "diffHunk": "@@ -11,23 +11,22 @@\n buildscript {\n     repositories {\n         mavenCentral()\n+        mavenLocal()\n     }\n     apply from: file('gradle/buildscript.gradle'), to: buildscript\n }\n \n-plugins {\n-    id 'org.shipkit.java' version '2.2.5' apply false\n-}\n-if (!project.hasProperty('disableShipkit')) {\n-    apply plugin: 'org.shipkit.java'\n-}\n+apply plugin: 'org.shipkit.shipkit-auto-version'\n+println \"Building version $version\"\n \n apply from: file('gradle/license.gradle')\n apply from: file('gradle/environment.gradle')\n apply from: file(\"gradle/dependency-versions.gradle\")\n+apply from: file(\"gradle/ci-release.gradle\")\n \n-allprojects {\n+allprojects {    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97551763f8e633e1b2657a736ff43bdce9d43ef1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg2MDkxNA==", "bodyText": "It seems like travis-ci reorganized the docs lately, so this link should be https://docs.travis-ci.com/user/job-lifecycle/#skipping-the-installation-phase\nThe docs also suggest install: skip", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r379860914", "createdAt": "2020-02-15T22:45:18Z", "author": {"login": "cgtz"}, "path": ".travis.yml", "diffHunk": "@@ -15,11 +15,12 @@ addons:\n     packages:\n       - oracle-java8-installer\n       - oracle-java8-unlimited-jce-policy\n-#don't build tags\n branches:\n-  except:\n+  except: # don't build tags\n     - /^v\\d/\n+install:\n+ - true # skips unnecessary ./gradlew assemble (https://docs.travis-ci.com/user/customizing-the-build/#Skipping-the-Installation-Step) ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97551763f8e633e1b2657a736ff43bdce9d43ef1"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4047cd146218d7476f8ace5e5118563b4e5a7f0d", "author": {"user": {"login": "mockitoguy", "name": "Szczepan Faber"}}, "url": "https://github.com/linkedin/ambry/commit/4047cd146218d7476f8ace5e5118563b4e5a7f0d", "committedDate": "2020-02-18T21:53:02Z", "message": "Updated based on review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08e5d1049bc8586bfda62d18292162cde25a70a3", "author": {"user": {"login": "mockitoguy", "name": "Szczepan Faber"}}, "url": "https://github.com/linkedin/ambry/commit/08e5d1049bc8586bfda62d18292162cde25a70a3", "committedDate": "2020-02-18T21:56:49Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNDU3NDc5", "url": "https://github.com/linkedin/ambry/pull/1387#pullrequestreview-361457479", "createdAt": "2020-02-19T21:40:18Z", "commit": {"oid": "08e5d1049bc8586bfda62d18292162cde25a70a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMTo0MDoxOVrOFr4nGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMTo0MDoxOVrOFr4nGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU2MDYwMw==", "bodyText": "Could you remove the -i option from this command? Since we have logging enabled for our tests, this can produce a ton of output.\nI think it should be okay to use -i on lines 10 and 17 though.", "url": "https://github.com/linkedin/ambry/pull/1387#discussion_r381560603", "createdAt": "2020-02-19T21:40:19Z", "author": {"login": "cgtz"}, "path": "travis-build.sh", "diffHunk": "@@ -0,0 +1,18 @@\n+#!/bin/sh\n+\n+# exit when any command fails\n+set -e\n+\n+echo \"Building and testing artifacts, and creating pom files\"\n+./gradlew -s -i --scan build publishToMavenLocal codeCoverageReport", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08e5d1049bc8586bfda62d18292162cde25a70a3"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "017d055f5c91aa27cdc3d08e47260a4e93e7b400", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/017d055f5c91aa27cdc3d08e47260a4e93e7b400", "committedDate": "2020-02-20T18:42:59Z", "message": "Remove -i option to reduce log volumes\n\nOur tests have noisy logging, and travis can't show all of the output."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTQzNTYy", "url": "https://github.com/linkedin/ambry/pull/1387#pullrequestreview-362943562", "createdAt": "2020-02-21T22:01:33Z", "commit": {"oid": "017d055f5c91aa27cdc3d08e47260a4e93e7b400"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1621, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}