{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNjI3MjU4", "number": 1410, "title": "Preparation and cleanup for Http2NetworkClient", "bodyText": "Introduced config to enable/disable http2network client.\nCreated Http2NetworkClientFactory.\nChanged number of max stream for a channel to Long instead of Int.\nSome preparation work for http2 client.", "createdAt": "2020-03-02T21:52:16Z", "url": "https://github.com/linkedin/ambry/pull/1410", "merged": true, "mergeCommit": {"oid": "8bb40eb25c47d90d75cf4a2c19bb519e58553898"}, "closed": true, "closedAt": "2020-03-04T02:25:58Z", "author": {"login": "zzmao"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJzDypAH2gAyMzgyNjI3MjU4OmI2MzA1NDdiMzdiMTNmNzRiNmFjOTVkM2NiNzE0NzA2M2QyYTQwMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKNc3OgFqTM2ODQ2NDEwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022", "author": {"user": {"login": "zzmao", "name": "Ze Mao"}}, "url": "https://github.com/linkedin/ambry/commit/b630547b37b13f74b6ac95d3cb7147063d2a4022", "committedDate": "2020-03-02T19:40:42Z", "message": "Clean up and preparation for http2NetworkClient"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjM5NjAw", "url": "https://github.com/linkedin/ambry/pull/1410#pullrequestreview-367639600", "createdAt": "2020-03-03T01:05:57Z", "commit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMTowNTo1OFrOFw0-Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToxMjoxMlrOFw1FqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0Mzg0Mw==", "bodyText": "Long.MAX_VALUE seems pretty scary? Is stream id reusable in http2?", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r386743843", "createdAt": "2020-03-03T01:05:58Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com.github.ambry/config/Http2ClientConfig.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.config;\n+\n+/**\n+ * The configs for HTTP/2 Client\n+ */\n+public class Http2ClientConfig {\n+\n+  public static final String HTTP2_MIN_CONNECTION_PER_PORT = \"http2.min.connection.per.port\";\n+  public static final String HTTP2_MAX_STREAMS_PER_CONNECTION = \"http2.max.streams.per.connection\";\n+  public static final String HTTP2_NETTY_EVENT_LOOP_GROUP_THREADS = \"http2.netty.event.loop.group.threads\";\n+  public static final String HTTP2_IDLE_CONNECTION_TIMEOUT = \"http2.idle.connection.timeout\";\n+\n+  /**\n+   * HTTP/2 connection idle time before we close it. -1 means no idle close.\n+   */\n+  @Config(HTTP2_IDLE_CONNECTION_TIMEOUT)\n+  @Default(\"-1\")\n+  public final Long idleConnectionTimeout;\n+\n+  /**\n+   * Minimum number of http2 connection per port we want to keep.\n+   */\n+  @Config(HTTP2_MIN_CONNECTION_PER_PORT)\n+  @Default(\"4\")\n+  public final int http2MinConnectionPerPort;\n+\n+  /**\n+   * Maximum number of streams allowed per HTTP/2 connection.\n+   */\n+  @Config(HTTP2_MAX_STREAMS_PER_CONNECTION)\n+  @Default(\"Long.Max_VALUE\")\n+  public final Long http2MaxStreamsPerConnection;\n+\n+  /**\n+   * Number of threads in a Netty event loop group. 0 means Netty will decide the number.\n+   */\n+  @Config(HTTP2_NETTY_EVENT_LOOP_GROUP_THREADS)\n+  @Default(\"0\")\n+  public final int http2NettyEventLoopGroupThreads;\n+\n+  public Http2ClientConfig(VerifiableProperties verifiableProperties) {\n+    idleConnectionTimeout = verifiableProperties.getLong(HTTP2_IDLE_CONNECTION_TIMEOUT, -1);\n+    http2MinConnectionPerPort = verifiableProperties.getInt(HTTP2_MIN_CONNECTION_PER_PORT, 4);\n+    http2MaxStreamsPerConnection = verifiableProperties.getLong(HTTP2_MAX_STREAMS_PER_CONNECTION, Long.MAX_VALUE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0NTcxMg==", "bodyText": "2020", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r386745712", "createdAt": "2020-03-03T01:11:58Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-network/src/main/java/com.github.ambry.network/http2/Http2NetworkClient.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/**\n+ * Copyright 2019 LinkedIn Corp. All rights reserved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0NTc2OA==", "bodyText": "javadoc?", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r386745768", "createdAt": "2020-03-03T01:12:12Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-network/src/main/java/com.github.ambry.network/http2/Http2ClientMetrics.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+\n+package com.github.ambry.network.http2;\n+\n+import com.codahale.metrics.MetricRegistry;\n+\n+\n+public class Http2ClientMetrics {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4Mjc4NzEx", "url": "https://github.com/linkedin/ambry/pull/1410#pullrequestreview-368278711", "createdAt": "2020-03-03T19:55:00Z", "commit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxOTo1NTowMFrOFxUVFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMToyNDo1NFrOFxXDWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1NzYyMQ==", "bodyText": "How about calling it clustermap.http2.network.client.enabled?", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r387257621", "createdAt": "2020-03-03T19:55:00Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com.github.ambry/config/ClusterMapConfig.java", "diffHunk": "@@ -75,6 +75,15 @@\n   @Default(\"10 * 60 * 1000\")\n   public final int clusterMapFixedTimeoutReplicaRetryBackoffMs;\n \n+  /**\n+   * TODO: Clean up configs once HTTP/2 fully deployed\n+   * HTTP/2 network client will be enabled if true. HTTP/2 network client send HTTP/2 request to all storage nodes.\n+   * This config takes precedence over clusterMapSslEnabledDatacenters.\n+   */\n+  @Config(\"clustermap.http2.enable\")\n+  @Default(\"false\")\n+  public final boolean clusterMapHttp2Enable;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI1OTQzNw==", "bodyText": "could you add time unit for this config?", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r387259437", "createdAt": "2020-03-03T19:58:17Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com.github.ambry/config/Http2ClientConfig.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.config;\n+\n+/**\n+ * The configs for HTTP/2 Client\n+ */\n+public class Http2ClientConfig {\n+\n+  public static final String HTTP2_MIN_CONNECTION_PER_PORT = \"http2.min.connection.per.port\";\n+  public static final String HTTP2_MAX_STREAMS_PER_CONNECTION = \"http2.max.streams.per.connection\";\n+  public static final String HTTP2_NETTY_EVENT_LOOP_GROUP_THREADS = \"http2.netty.event.loop.group.threads\";\n+  public static final String HTTP2_IDLE_CONNECTION_TIMEOUT = \"http2.idle.connection.timeout\";\n+\n+  /**\n+   * HTTP/2 connection idle time before we close it. -1 means no idle close.\n+   */\n+  @Config(HTTP2_IDLE_CONNECTION_TIMEOUT)\n+  @Default(\"-1\")\n+  public final Long idleConnectionTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2MjQ3MA==", "bodyText": "I notice that getSnapshot() method doesn't contain Http2 port info. Could you add it?", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r387262470", "createdAt": "2020-03-03T20:03:59Z", "author": {"login": "jsjtzyy"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/AmbryDatanode.java", "diffHunk": "@@ -118,6 +120,9 @@ public boolean hasHttp2Port() {\n \n   @Override\n   public Port getPortToConnectTo() {\n+    if (http2ClientEnabled) {\n+      return http2Port;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2NDA5Nw==", "bodyText": "Same in CloudDataNode, please add Http2 port info into getSnapshot()", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r387264097", "createdAt": "2020-03-03T20:07:16Z", "author": {"login": "jsjtzyy"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/CloudDataNode.java", "diffHunk": "@@ -117,6 +120,9 @@ public int getHttp2Port() {\n \n   @Override\n   public Port getPortToConnectTo() {\n+    if (http2ClientEnabled) {\n+      return http2Port;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MjUzMQ==", "bodyText": "Could you add some java doc for this class?", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r387292531", "createdAt": "2020-03-03T21:04:35Z", "author": {"login": "jsjtzyy"}, "path": "ambry-network/src/main/java/com.github.ambry.network/http2/Http2ChannelPoolMap.java", "diffHunk": "@@ -28,9 +29,13 @@\n   private final EventLoopGroup eventLoopGroup;\n   private final SSLFactory sslFactory;\n \n-  public Http2ChannelPoolMap(SSLFactory sslFactory, EventLoopGroup eventLoopGroup) {\n+  private final Http2ClientConfig http2ClientConfig;\n+\n+  public Http2ChannelPoolMap(SSLFactory sslFactory, EventLoopGroup eventLoopGroup,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5MzY2NA==", "bodyText": "minor: Add TODO before More implementation details will be added in next PR.", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r387293664", "createdAt": "2020-03-03T21:06:51Z", "author": {"login": "jsjtzyy"}, "path": "ambry-network/src/main/java/com.github.ambry.network/http2/Http2NetworkClient.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/**\n+ * Copyright 2019 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.network.http2;\n+\n+import com.github.ambry.clustermap.DataNodeId;\n+import com.github.ambry.commons.SSLFactory;\n+import com.github.ambry.config.Http2ClientConfig;\n+import com.github.ambry.network.NetworkClient;\n+import com.github.ambry.network.RequestInfo;\n+import com.github.ambry.network.ResponseInfo;\n+import io.netty.channel.EventLoopGroup;\n+import io.netty.channel.nio.NioEventLoopGroup;\n+import io.netty.channel.pool.ChannelPool;\n+import io.netty.channel.pool.ChannelPoolMap;\n+import java.net.InetSocketAddress;\n+import java.util.List;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * A HTTP/2 implementation of {@link NetworkClient}. More implementation details will be added in next PR.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5NDExNg==", "bodyText": "can this be final ?", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r387294116", "createdAt": "2020-03-03T21:07:51Z", "author": {"login": "jsjtzyy"}, "path": "ambry-network/src/main/java/com.github.ambry.network/http2/Http2NetworkClient.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/**\n+ * Copyright 2019 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.network.http2;\n+\n+import com.github.ambry.clustermap.DataNodeId;\n+import com.github.ambry.commons.SSLFactory;\n+import com.github.ambry.config.Http2ClientConfig;\n+import com.github.ambry.network.NetworkClient;\n+import com.github.ambry.network.RequestInfo;\n+import com.github.ambry.network.ResponseInfo;\n+import io.netty.channel.EventLoopGroup;\n+import io.netty.channel.nio.NioEventLoopGroup;\n+import io.netty.channel.pool.ChannelPool;\n+import io.netty.channel.pool.ChannelPoolMap;\n+import java.net.InetSocketAddress;\n+import java.util.List;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * A HTTP/2 implementation of {@link NetworkClient}. More implementation details will be added in next PR.\n+ */\n+public class Http2NetworkClient implements NetworkClient {\n+  private static final Logger logger = LoggerFactory.getLogger(Http2NetworkClient.class);\n+  private EventLoopGroup eventLoopGroup;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwMDAzMw==", "bodyText": "Can we just create one instance of ClusterMapConfig ? No need to create ClusterMapConfig twice in some cases.", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r387300033", "createdAt": "2020-03-03T21:20:23Z", "author": {"login": "jsjtzyy"}, "path": "ambry-rest/src/main/java/com.github.ambry.rest/RestServerMain.java", "diffHunk": "@@ -79,6 +80,9 @@ public static void main(String[] args) {\n    * @throws IOException\n    */\n   private static SSLFactory getSSLFactoryIfRequired(VerifiableProperties verifiableProperties) throws Exception {\n+    if (new ClusterMapConfig(verifiableProperties).clusterMapHttp2Enable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwMjIzNQ==", "bodyText": "After reviewing the whole PR, I actually wonder if we can put the Http2ClientEnabled config into NetworkConfig.   Any specific reason to keep it in the ClusterMapConfig ?", "url": "https://github.com/linkedin/ambry/pull/1410#discussion_r387302235", "createdAt": "2020-03-03T21:24:54Z", "author": {"login": "jsjtzyy"}, "path": "ambry-router/src/main/java/com.github.ambry.router/NonBlockingRouterFactory.java", "diffHunk": "@@ -86,11 +91,18 @@ public NonBlockingRouterFactory(VerifiableProperties verifiableProperties, Clust\n     MetricRegistry registry = clusterMap.getMetricRegistry();\n     routerMetrics = new NonBlockingRouterMetrics(clusterMap, routerConfig);\n     networkConfig = new NetworkConfig(verifiableProperties);\n+    http2ClientConfig = new Http2ClientConfig(verifiableProperties);\n     networkMetrics = new NetworkMetrics(registry);\n+    http2ClientMetrics = new Http2ClientMetrics(registry);\n+\n     time = SystemTime.getInstance();\n-    networkClientFactory = new SocketNetworkClientFactory(networkMetrics, networkConfig, sslFactory,\n-        routerConfig.routerScalingUnitMaxConnectionsPerPortPlainText,\n-        routerConfig.routerScalingUnitMaxConnectionsPerPortSsl, routerConfig.routerConnectionCheckoutTimeoutMs, time);\n+    if (new ClusterMapConfig(verifiableProperties).clusterMapHttp2Enable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b630547b37b13f74b6ac95d3cb7147063d2a4022"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b779036e027290ce1e435d686a6ef2a2111ff823", "author": {"user": {"login": "zzmao", "name": "Ze Mao"}}, "url": "https://github.com/linkedin/ambry/commit/b779036e027290ce1e435d686a6ef2a2111ff823", "committedDate": "2020-03-04T01:23:59Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDYxMDQ1", "url": "https://github.com/linkedin/ambry/pull/1410#pullrequestreview-368461045", "createdAt": "2020-03-04T02:15:16Z", "commit": {"oid": "b779036e027290ce1e435d686a6ef2a2111ff823"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDY0MTAz", "url": "https://github.com/linkedin/ambry/pull/1410#pullrequestreview-368464103", "createdAt": "2020-03-04T02:25:37Z", "commit": {"oid": "b779036e027290ce1e435d686a6ef2a2111ff823"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1664, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}