{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyODg0MzQ2", "number": 1697, "title": "Ignore version mismatch temporarily in MySqlAccountService while updating Accounts and Containers", "bodyText": "Since HelixAccountService and MySqlAccountService handles versioning of Accounts and Containers differently, this causes mismatch between Accounts when compared in CompositeAccountService. This PR temporarily ignores version mismatch during Account/Container updates in MySqlAccountService.", "createdAt": "2020-11-18T03:27:34Z", "url": "https://github.com/linkedin/ambry/pull/1697", "merged": true, "mergeCommit": {"oid": "2db9bfe380e193bb690bf30897d8bb47070cbe64"}, "closed": true, "closedAt": "2020-11-20T00:41:00Z", "author": {"login": "Arun-LinkedIn"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddlaipgH2gAyNTIyODg0MzQ2OjEwYjU4ZmRkNzI1ZjFkMGI4NzM3ZjNjMzg1NDI2MjM5ZGRlM2E4YzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeMYOWgFqTUzNDk5MTQwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/10b58fdd725f1d0b8737f3c385426239dde3a8c6", "committedDate": "2020-11-18T03:16:31Z", "message": "Ignore version mismatch temporarily in MySqlAccountService while updating Accounts and Containers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTM2ODQ2", "url": "https://github.com/linkedin/ambry/pull/1697#pullrequestreview-533136846", "createdAt": "2020-11-18T06:30:36Z", "commit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNjozMDozNlrOH1e5BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNjozODozNFrOH1fEFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0MjY5Mg==", "bodyText": "Does this need to be changed?  I thought only account version was out of sync.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r525842692", "createdAt": "2020-11-18T06:30:36Z", "author": {"login": "lightningrob"}, "path": "ambry-account/src/main/java/com/github/ambry/account/AbstractAccountService.java", "diffHunk": "@@ -141,11 +142,6 @@ public Account getAccountById(short id) {\n               \"In account \" + accountName + \", container \" + container.getName() + \" has containerId \"\n                   + existingContainer.getId() + \" (\" + container.getId() + \" was supplied)\",\n               AccountServiceErrorCode.ResourceConflict);\n-        } else if (existingContainer.getSnapshotVersion() != container.getSnapshotVersion()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0NTUyNw==", "bodyText": "Can we make ignoreAccountVersion a mysql config property?  That way we won't need to change the code later.  Default can be false and override in config when composite AS is used.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r525845527", "createdAt": "2020-11-18T06:38:34Z", "author": {"login": "lightningrob"}, "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "diffHunk": "@@ -249,14 +249,16 @@ public void updateAccounts(Collection<Account> accounts) throws AccountServiceEx\n     infoMapLock.readLock().lock();\n     try {\n       AccountInfoMap accountInfoMap = accountInfoMapRef.get();\n-      if (accountInfoMap.hasConflictingAccount(accounts)) {\n+      //TODO: Temporarily disabling version check with CompositeAccountService enabled. Remove it after moving to MySql only.\n+      if (accountInfoMap.hasConflictingAccount(accounts, true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNzMxNDM1", "url": "https://github.com/linkedin/ambry/pull/1697#pullrequestreview-533731435", "createdAt": "2020-11-18T17:58:14Z", "commit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNzo1ODoxNVrOH17LCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxODowODoxMlrOH17j8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMwNjA1OA==", "bodyText": "+1", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526306058", "createdAt": "2020-11-18T17:58:15Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/AbstractAccountService.java", "diffHunk": "@@ -141,11 +142,6 @@ public Account getAccountById(short id) {\n               \"In account \" + accountName + \", container \" + container.getName() + \" has containerId \"\n                   + existingContainer.getId() + \" (\" + container.getId() + \" was supplied)\",\n               AccountServiceErrorCode.ResourceConflict);\n-        } else if (existingContainer.getSnapshotVersion() != container.getSnapshotVersion()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0MjY5Mg=="}, "originalCommit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMxMjQzNQ==", "bodyText": "Right, config seems to be better. This is one-off migration and we can keep the default value false after it's complete.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526312435", "createdAt": "2020-11-18T18:08:12Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "diffHunk": "@@ -249,14 +249,16 @@ public void updateAccounts(Collection<Account> accounts) throws AccountServiceEx\n     infoMapLock.readLock().lock();\n     try {\n       AccountInfoMap accountInfoMap = accountInfoMapRef.get();\n-      if (accountInfoMap.hasConflictingAccount(accounts)) {\n+      //TODO: Temporarily disabling version check with CompositeAccountService enabled. Remove it after moving to MySql only.\n+      if (accountInfoMap.hasConflictingAccount(accounts, true)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0NTUyNw=="}, "originalCommit": {"oid": "10b58fdd725f1d0b8737f3c385426239dde3a8c6"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "824449255240e6e8dbb356e23c2b9ef8a08a4d73", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/824449255240e6e8dbb356e23c2b9ef8a08a4d73", "committedDate": "2020-11-18T23:26:31Z", "message": "Add config to check if version mismatch can be ignored during Account and Container updates."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTY3MDgz", "url": "https://github.com/linkedin/ambry/pull/1697#pullrequestreview-533967083", "createdAt": "2020-11-18T23:34:53Z", "commit": {"oid": "824449255240e6e8dbb356e23c2b9ef8a08a4d73"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzozNDo1M1rOH2GlwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzozNDo1M1rOH2GlwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5MzEyMQ==", "bodyText": "I would move this to base AccountServiceConfig class so AbstractAccountService can also use it.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526493121", "createdAt": "2020-11-18T23:34:53Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/config/MySqlAccountServiceConfig.java", "diffHunk": "@@ -97,6 +98,13 @@\n   @Default(\"false\")\n   public final boolean updateDisabled;\n \n+  /**\n+   * If true, MySqlAccountService would ignore version mismatch while updating Accounts and Containers.\n+   */\n+  @Config(IGNORE_VERSION_MISMATCH)\n+  @Default(\"false\")\n+  public final boolean ignoreVersionMismatch;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "824449255240e6e8dbb356e23c2b9ef8a08a4d73"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTc2OTgz", "url": "https://github.com/linkedin/ambry/pull/1697#pullrequestreview-533976983", "createdAt": "2020-11-18T23:57:26Z", "commit": {"oid": "824449255240e6e8dbb356e23c2b9ef8a08a4d73"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo1NzoyNlrOH2HHWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo1NzoyNlrOH2HHWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMTcyMg==", "bodyText": "minor: can you print out  account name instead of account id?\nAlso account.getAllContainers() can be replaced with resolvedContainers", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526501722", "createdAt": "2020-11-18T23:57:26Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "diffHunk": "@@ -340,6 +341,23 @@ ExecutorService getScheduler() {\n   @Override\n   protected void updateResolvedContainers(Account account, Collection<Container> resolvedContainers)\n       throws AccountServiceException {\n+\n+    // Check for name/id/version conflicts for containers being updated with those in local cache.\n+    infoMapLock.readLock().lock();\n+    try {\n+      if (accountInfoMapRef.get()\n+          .hasConflictingContainer(resolvedContainers, account.getId(), config.ignoreVersionMismatch)) {\n+        logger.error(\n+            \"Containers={} under Account={} conflict with the containers in local cache. Cancel the update operation.\",\n+            account.getAllContainers(), account.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "824449255240e6e8dbb356e23c2b9ef8a08a4d73"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0faf6aada9374159dfb87383fc91bf3b1d9a3b11", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/0faf6aada9374159dfb87383fc91bf3b1d9a3b11", "committedDate": "2020-11-19T01:28:55Z", "message": "Move IGNORE_VERSION_MISMATCH config to AccountServiceConfig from MySqlAccountServiceConfig"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDM0MDYy", "url": "https://github.com/linkedin/ambry/pull/1697#pullrequestreview-534034062", "createdAt": "2020-11-19T02:29:43Z", "commit": {"oid": "0faf6aada9374159dfb87383fc91bf3b1d9a3b11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMjoyOTo0M1rOH2KLTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMjoyOTo0M1rOH2KLTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU1MTg4NA==", "bodyText": "I'm wondering if this will be a problem when we switch to mysql primary and Helix secondary.", "url": "https://github.com/linkedin/ambry/pull/1697#discussion_r526551884", "createdAt": "2020-11-19T02:29:43Z", "author": {"login": "lightningrob"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -289,7 +289,7 @@ void updateAccountsWithAccountMetadataStore(Collection<Account> accounts, Accoun\n     // update operation for all the accounts if any conflict exists. There is a slight chance that the account to update\n     // conflicts with the accounts in the local cache, but does not conflict with those in the helixPropertyStore. This\n     // will happen if some accounts are updated but the local cache is not refreshed.\n-    if (accountInfoMapRef.get().hasConflictingAccount(accounts)) {\n+    if (accountInfoMapRef.get().hasConflictingAccount(accounts, false)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0faf6aada9374159dfb87383fc91bf3b1d9a3b11"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d30d0e0dfa07e6595cd95e69721ee37bc4abc96d", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/d30d0e0dfa07e6595cd95e69721ee37bc4abc96d", "committedDate": "2020-11-19T21:56:27Z", "message": "Address Rob's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTkxNDAy", "url": "https://github.com/linkedin/ambry/pull/1697#pullrequestreview-534991402", "createdAt": "2020-11-20T00:40:17Z", "commit": {"oid": "d30d0e0dfa07e6595cd95e69721ee37bc4abc96d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1006, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}