{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyODg5NTEw", "number": 1734, "title": "Encode user metadata value if it contains non-ascii character", "bodyText": "User metadata now supports UTF-8 charset. However, when setting header that includes non-ascii characters, underlying netty replaces these characters with question mark without throwing any exception. This PR explicitly checks if header value contains non-ascii characters. If yes, it encodes the string and associate it with a special header, which will be identified and decoded by client.", "createdAt": "2020-12-19T07:09:51Z", "url": "https://github.com/linkedin/ambry/pull/1734", "merged": true, "mergeCommit": {"oid": "d29fd1aa017df0ace88c59d74beac5662f1645de"}, "closed": true, "closedAt": "2020-12-22T00:27:54Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnnPuGgH2gAyNTQyODg5NTEwOjgxZWZmZTE0MDQzMTcxOGVjZjlmZDMzOWU0NjQ1YjJkOWFhMjBlYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdofYBVAFqTU1Njc0NDgyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "81effe140431718ecf9fd339e4645b2d9aa20eba", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/81effe140431718ecf9fd339e4645b2d9aa20eba", "committedDate": "2020-12-19T07:03:45Z", "message": "Encode user metadata value if it contains non-ascii character\n\nUser metadata now supports UTF-8 charset. However, when setting header that includes non-ascii characters, underlying netty replaces these characters with\nquestion mark without throwing any exception. This PR explicitly checks if header value contains non-ascii characters. If yes, it encodes the string and put\nit to a special header which will be identified and decoded by client."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd", "committedDate": "2020-12-21T18:04:39Z", "message": "minor clean up in tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NTc5Mzkx", "url": "https://github.com/linkedin/ambry/pull/1734#pullrequestreview-556579391", "createdAt": "2020-12-21T18:26:48Z", "commit": {"oid": "7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxODoyNjo0OFrOIJhwpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxODoyNjo0OFrOIJhwpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2MTIyMg==", "bodyText": "Changes in this file are some cleanup and not related to user metadata change. (there was a travis failure, although this doesn't really fix the intermittent test error, it removes redundant code)", "url": "https://github.com/linkedin/ambry/pull/1734#discussion_r546861222", "createdAt": "2020-12-21T18:26:48Z", "author": {"login": "jsjtzyy"}, "path": "ambry-protocol/src/test/java/com/github/ambry/protocol/RequestResponseTest.java", "diffHunk": "@@ -369,14 +364,12 @@ public void putRequestResponseTest() throws IOException {\n         blob, blobSize, blobKey);\n \n     // Response test\n-    for (boolean useByteBufContent : new boolean[]{true, false}) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NTg4MTMz", "url": "https://github.com/linkedin/ambry/pull/1734#pullrequestreview-556588133", "createdAt": "2020-12-21T18:43:02Z", "commit": {"oid": "7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxODo0MzowMlrOIJiLzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxODo0MzowMlrOIJiLzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2ODE3Mg==", "bodyText": "What happens if the value contains non ascii characters and you pass it to setHeader() as before?  Does it not throw IllegalArgumentException?", "url": "https://github.com/linkedin/ambry/pull/1734#discussion_r546868172", "createdAt": "2020-12-21T18:43:02Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/rest/RestUtils.java", "diffHunk": "@@ -910,21 +908,16 @@ public static void setUserMetadataHeaders(Map<String, String> userMetadataMap,\n       if (!headerName.startsWith(Headers.USER_META_DATA_HEADER_PREFIX)) {\n         headerName = Headers.USER_META_DATA_HEADER_PREFIX + headerName;\n       }\n-      try {\n-        restResponseChannel.setHeader(headerName, headerValue);\n-      } catch (IllegalArgumentException iae) {\n+      if (StandardCharsets.US_ASCII.newEncoder().canEncode(headerValue)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NjY1NzAx", "url": "https://github.com/linkedin/ambry/pull/1734#pullrequestreview-556665701", "createdAt": "2020-12-21T21:10:47Z", "commit": {"oid": "7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NzQ0ODI5", "url": "https://github.com/linkedin/ambry/pull/1734#pullrequestreview-556744829", "createdAt": "2020-12-22T00:27:30Z", "commit": {"oid": "7a0ad12285dc7dd8ffb4abb86ddf566fe5b2c5dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1061, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}