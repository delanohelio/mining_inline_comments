{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5NzE5NzMw", "number": 1672, "title": "Fix reset partition error when restarting a stopped replica", "bodyText": "This PR will fix two issues regarding \"stop replica\":\n\n\nPrevious stop replica method didn't change the state of replica in Helix state engine (only added it to \"stopped\" list in InstanceConfig). This becomes a problem for leader-based replication when a leader replica is stopped and Helix still believes it's leader, which will block cross-colo replication.\n\n\nSince replica state doesn't change in Helix while being stopped,  the stopped replica may still stay in STANDBY/LEADER state when we try to restart it. Our code calls \"resetPartitionState\" at the end of \"start replica\". This will throw exception because Helix doesn't support resetting a non-error replica.\n\n\nTo address above issues, this PR makes following changes\n(1)  adds logic to explicitly disable replica when stopping a replica (to trigger state transition and potential leader election);\n(2) checks if the stopped replica is in ERROR state and decide whether to reset the partition.", "createdAt": "2020-10-26T02:38:57Z", "url": "https://github.com/linkedin/ambry/pull/1672", "merged": true, "mergeCommit": {"oid": "09bf83c2fde7f97a63ca2f343b48ac7969f3f1a1"}, "closed": true, "closedAt": "2020-11-04T02:39:19Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWNmLRAH2gAyNTA5NzE5NzMwOmM3MDIwOTY4ZTQ1YWUyY2RkOTU0MTEyZWQ4NGZjYzliNGJhMDcwNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZB4gZAH2gAyNTA5NzE5NzMwOjJlYmI0ZDQyNjAxNTBkOWQ1OTgzZDMzYjdiYWQ1NDg0N2FlNjI3MjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c7020968e45ae2cdd954112ed84fcc9b4ba07073", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/c7020968e45ae2cdd954112ed84fcc9b4ba07073", "committedDate": "2020-10-26T05:34:02Z", "message": "Fix reset partition error when restarting a stopped replica\n\nPrevious code assumes stopped replica is in error state (this is true if replica is stopped and machine is rebooted).\nHowever, if there is no reboot between stopping and starting same replica, its state should stay unchanged (i.e.\nSTANDBY). Helix current doesn't support resetting partition from STANDBY (only ERROR state is allowed). Hence, this\nPR will check if the stopped replica is in ERROR state and decide whether to reset the partition.\nAlso, since leader based replica is introduced, this PR adds logic to disable replica when stopping a replica (to\ntrigger state transistion and potential leader election)."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d2ed3a9ada0fb11b91408f2311c155bb91d24dd", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/0d2ed3a9ada0fb11b91408f2311c155bb91d24dd", "committedDate": "2020-10-26T02:31:54Z", "message": "Fix reset partition error when restarting a stopped replica\n\nPrevious code assumes stopped replica is in error state (this is true if replica is stopped and machine is rebooted).\nHowever, if there is no reboot between stopping and starting same replica, its state should stay unchanged (i.e.\nSTANDBY). Helix current doesn't support resetting partition from STANDBY (only ERROR state is allowed). Hence, this\nPR will check if the stopped replica is in ERROR state and decide whether to reset the partition."}, "afterCommit": {"oid": "c7020968e45ae2cdd954112ed84fcc9b4ba07073", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/c7020968e45ae2cdd954112ed84fcc9b4ba07073", "committedDate": "2020-10-26T05:34:02Z", "message": "Fix reset partition error when restarting a stopped replica\n\nPrevious code assumes stopped replica is in error state (this is true if replica is stopped and machine is rebooted).\nHowever, if there is no reboot between stopping and starting same replica, its state should stay unchanged (i.e.\nSTANDBY). Helix current doesn't support resetting partition from STANDBY (only ERROR state is allowed). Hence, this\nPR will check if the stopped replica is in ERROR state and decide whether to reset the partition.\nAlso, since leader based replica is introduced, this PR adds logic to disable replica when stopping a replica (to\ntrigger state transistion and potential leader election)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDcyNjMx", "url": "https://github.com/linkedin/ambry/pull/1672#pullrequestreview-519072631", "createdAt": "2020-10-28T20:50:55Z", "commit": {"oid": "c7020968e45ae2cdd954112ed84fcc9b4ba07073"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTM4NDc5", "url": "https://github.com/linkedin/ambry/pull/1672#pullrequestreview-522938479", "createdAt": "2020-11-03T23:06:04Z", "commit": {"oid": "c7020968e45ae2cdd954112ed84fcc9b4ba07073"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzowNjowNFrOHtDofQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzowNjowNFrOHtDofQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNzQ4NQ==", "bodyText": "nit: can change this code slightly to not require the intermediate set:\nboolean isLocalStoreInErrorState =\n    partitionId.getReplicaIdsByState(ReplicaState.ERROR, currentNode.getDatacenterName())\n        .stream()\n        .anyMatch(r -> r.getDataNodeId().getHostname().equals(currentNode.getHostname()));", "url": "https://github.com/linkedin/ambry/pull/1672#discussion_r517007485", "createdAt": "2020-11-03T23:06:04Z", "author": {"login": "cgtz"}, "path": "ambry-server/src/main/java/com/github/ambry/server/AmbryServerRequests.java", "diffHunk": "@@ -434,10 +434,14 @@ private ServerErrorCode handleStartStoreRequest(PartitionId partitionId) {\n       logger.error(\"Could not enable replication on {}\", partitionIds);\n       return ServerErrorCode.Unknown_Error;\n     }\n-    // startBlobStore should guarantee that store is started, so return value shouldn't be null\n-    Store store = storeManager.getStore(partitionId);\n-    // 4. reset partition state if it's offline (will trigger state transition)\n-    if (store.getCurrentState() == ReplicaState.OFFLINE && clusterParticipant != null) {\n+    // 4. reset partition state if it's in error state (will trigger state transition)\n+    boolean isLocalStoreInErrorState =\n+        partitionId.getReplicaIdsByState(ReplicaState.ERROR, currentNode.getDatacenterName())\n+            .stream()\n+            .map(r -> r.getDataNodeId().getHostname())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7020968e45ae2cdd954112ed84fcc9b4ba07073"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ebb4d4260150d9d5983d33b7bad54847ae62726", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/2ebb4d4260150d9d5983d33b7bad54847ae62726", "committedDate": "2020-11-03T23:36:58Z", "message": "address comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 963, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}