{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMzY4MTI3", "number": 1380, "title": "Add precondition to metadata updates to fail on conflicts", "bodyText": "When we update blob metadata in ABS and Cosmos, we have to first pull the whole metadata record (a property map in ABS and a document in Cosmos), update the field of interest, and upload the modified record.  (There is no single-field update operation.)  In live-serving mode, both the ambry-frontend and ambry-vcr may try to update the same blob metadata concurrently.  Hence, it is possible for updates to get clobbered due to race conditions.  To prevent this, we make use of the resource etag, along with the If-Match request condition, to fail conflicting updates and force them to retry.\nNote: the mechanism used to test conflicts is non-standard as it relies on a callback in the production code for the test to inject a conflicting modification.  I'm open to suggestions for cleaner alternatives.", "createdAt": "2020-02-10T21:41:26Z", "url": "https://github.com/linkedin/ambry/pull/1380", "merged": true, "mergeCommit": {"oid": "5288fb5c71d471ef5ea34d81d817bff5b64f96f8"}, "closed": true, "closedAt": "2020-02-27T04:49:26Z", "author": {"login": "lightningrob"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDD_MuAH2gAyMzczMzY4MTI3OjBlZDIyYTVkN2U1NThjNzgzZjZkZTY2MDdmNWZiM2Q0Y2M5MjVhYmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIQ0GiAH2gAyMzczMzY4MTI3OjVkMDBmOWQ2MDQ5OTZmNDVmMmIxM2E5NTAwMWNiYTAzZmZlNjc3ZWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ed22a5d7e558c783f6de6607f5fb3d4cc925abb", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/0ed22a5d7e558c783f6de6607f5fb3d4cc925abb", "committedDate": "2020-02-10T21:26:36Z", "message": "Add precondition to metadata updates to fail on conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f55f2ea56e4e82df4d5d1fc6c8c071f629b4e1cb", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/f55f2ea56e4e82df4d5d1fc6c8c071f629b4e1cb", "committedDate": "2020-02-18T18:53:31Z", "message": "Merge branch 'master' of github.com:linkedin/ambry into azure-update-precondition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c36f8fed8487d4b1bca059cb87476c3a996566c", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/6c36f8fed8487d4b1bca059cb87476c3a996566c", "committedDate": "2020-02-18T19:17:34Z", "message": "remove accidentally committed code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTQxODM3", "url": "https://github.com/linkedin/ambry/pull/1380#pullrequestreview-362141837", "createdAt": "2020-02-20T18:42:29Z", "commit": {"oid": "6c36f8fed8487d4b1bca059cb87476c3a996566c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDU4NjE2", "url": "https://github.com/linkedin/ambry/pull/1380#pullrequestreview-363058616", "createdAt": "2020-02-23T00:39:44Z", "commit": {"oid": "6c36f8fed8487d4b1bca059cb87476c3a996566c"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwMDozOTo0NFrOFtNmYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QwMDo0NDo1OVrOFtNnNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1MzA1OQ==", "bodyText": "log exception?", "url": "https://github.com/linkedin/ambry/pull/1380#discussion_r382953059", "createdAt": "2020-02-23T00:39:44Z", "author": {"login": "cgtz"}, "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureBlobDataAccessor.java", "diffHunk": "@@ -295,7 +301,13 @@ public boolean updateBlobMetadata(BlobId blobId, String fieldName, Object value)\n         String textValue = String.valueOf(value);\n         if (!textValue.equals(metadata.get(fieldName))) {\n           metadata.put(fieldName, textValue);\n-          // Set condition to ensure we don't clobber another update\n+          if (updateCallback != null) {\n+            try {\n+              updateCallback.call();\n+            } catch (Exception ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c36f8fed8487d4b1bca059cb87476c3a996566c"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1MzE5MA==", "bodyText": "use generics in both the member variable and method arg. If the return type of call doesn't matter, you can use Callable<?> in both places.", "url": "https://github.com/linkedin/ambry/pull/1380#discussion_r382953190", "createdAt": "2020-02-23T00:42:32Z", "author": {"login": "cgtz"}, "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureBlobDataAccessor.java", "diffHunk": "@@ -120,6 +121,11 @@\n     this.purgeBatchSize = AzureCloudConfig.DEFAULT_PURGE_BATCH_SIZE;\n   }\n \n+  /** Visible for testing */\n+  void setUpdateCallback(Callable callback) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c36f8fed8487d4b1bca059cb87476c3a996566c"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk1MzI2OA==", "bodyText": "same comments for CosmosDataAccessor as AzureBlobDataAccessor.", "url": "https://github.com/linkedin/ambry/pull/1380#discussion_r382953268", "createdAt": "2020-02-23T00:44:59Z", "author": {"login": "cgtz"}, "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/azure/CosmosDataAccessor.java", "diffHunk": "@@ -58,6 +61,11 @@\n     this.azureMetrics = azureMetrics;\n   }\n \n+  /** Visible for testing */\n+  void setUpdateCallback(Callable callback) {\n+    this.updateCallback = callback;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c36f8fed8487d4b1bca059cb87476c3a996566c"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "786f5382082d593db39525a0bc54746e33cba72f", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/786f5382082d593db39525a0bc54746e33cba72f", "committedDate": "2020-02-27T01:02:47Z", "message": "Address Casey's review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d00f9d604996f45f2b13a95001cba03ffe677ed", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/5d00f9d604996f45f2b13a95001cba03ffe677ed", "committedDate": "2020-02-27T01:12:52Z", "message": "Merge branch 'master' of github.com:linkedin/ambry into azure-update-precondition"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1608, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}