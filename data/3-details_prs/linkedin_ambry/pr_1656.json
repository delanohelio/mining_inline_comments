{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxODg1ODQ2", "number": 1656, "title": "Fix test failures in BlobStoreStatsTest and GetBlobOperationTest", "bodyText": "This PR should fix test failures  in master branch.\n#1648\n#1645", "createdAt": "2020-10-12T23:54:06Z", "url": "https://github.com/linkedin/ambry/pull/1656", "merged": true, "mergeCommit": {"oid": "8471d56a54927a46e60d789dbd5b68874d29a701"}, "closed": true, "closedAt": "2020-10-13T20:18:38Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR84q2gH2gAyNTAxODg1ODQ2OmU2YWRmYTg5MTI1MTcwOTQ2N2Q4NzY0NGQ5MGZmMmFiZTliZTBiZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSOc6BgFqTUwNzc5NzA0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e6adfa891251709467d87644d90ff2abe9be0bf0", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/e6adfa891251709467d87644d90ff2abe9be0bf0", "committedDate": "2020-10-12T23:50:09Z", "message": "Fix test failures in BlobStoreStatsTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "142597248818fafb0895366890f8b971030b97b8", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/142597248818fafb0895366890f8b971030b97b8", "committedDate": "2020-10-13T05:41:35Z", "message": "Fix a test failure in GetBlobOperationTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NzE0NzU3", "url": "https://github.com/linkedin/ambry/pull/1656#pullrequestreview-507714757", "createdAt": "2020-10-13T18:21:33Z", "commit": {"oid": "142597248818fafb0895366890f8b971030b97b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODoyMTozNFrOHgz6IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODoyMTozNFrOHgz6IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2Njk0NQ==", "bodyText": "+1 to AtomicReference", "url": "https://github.com/linkedin/ambry/pull/1656#discussion_r504166945", "createdAt": "2020-10-13T18:21:34Z", "author": {"login": "lightningrob"}, "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "diffHunk": "@@ -1549,15 +1557,15 @@ private void onInvalidRange(Exception exception) {\n class DecryptCallBackResultInfo {\n   volatile boolean decryptJobComplete;\n   volatile Exception exception;\n-  volatile DecryptJob.DecryptJobResult result;\n+  AtomicReference<DecryptJob.DecryptJobResult> result = new AtomicReference<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142597248818fafb0895366890f8b971030b97b8"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NzIyNzc1", "url": "https://github.com/linkedin/ambry/pull/1656#pullrequestreview-507722775", "createdAt": "2020-10-13T18:32:54Z", "commit": {"oid": "142597248818fafb0895366890f8b971030b97b8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODozMjo1NVrOHg0Sng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODozMjo1NVrOHg0Sng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3MzIxNA==", "bodyText": "If you pull latest master branch, you can use:\nif (!TestUtils.checkAndSleep(() -> blobStoreStats.isRecentEntryQueueEnabled(), 10000)) {\n  throw new TimeoutException(\"Time out to wait for IndexScanner to finish\");\n}", "url": "https://github.com/linkedin/ambry/pull/1656#discussion_r504173214", "createdAt": "2020-10-13T18:32:55Z", "author": {"login": "lightningrob"}, "path": "ambry-store/src/test/java/com/github/ambry/store/BlobStoreStatsTest.java", "diffHunk": "@@ -752,7 +754,15 @@ public void testBucketingWithEmptyIndexToBegin()\n     throttlers.put(BlobStoreStats.IO_SCHEDULER_JOB_TYPE, mockThrottler);\n     int bucketCount = 50;\n     BlobStoreStats blobStoreStats = setupBlobStoreStats(bucketCount, 0);\n-    int expectedThrottleCount = state.referenceIndex.size();\n+    // Make sure the index scanner is finished and we can enqueue\n+    long recentEntryQueueTimeout = 10 * SystemTime.MsPerSec + System.currentTimeMillis();\n+    while (!blobStoreStats.isRecentEntryQueueEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142597248818fafb0895366890f8b971030b97b8"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NzIzNDM5", "url": "https://github.com/linkedin/ambry/pull/1656#pullrequestreview-507723439", "createdAt": "2020-10-13T18:33:49Z", "commit": {"oid": "142597248818fafb0895366890f8b971030b97b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODozMzo0OVrOHg0UhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODozMzo0OVrOHg0UhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE3MzcwMA==", "bodyText": "nit, it may be a bit more readable to do the getandset on this line:\nDecryptJob.DecryptJobResult result = decryptCallbackResultInfo.result.getAndSet(null);\nif (result != null) {...", "url": "https://github.com/linkedin/ambry/pull/1656#discussion_r504173700", "createdAt": "2020-10-13T18:33:49Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "diffHunk": "@@ -715,13 +716,17 @@ protected void maybeProcessCallbacks() {\n         // Only when the blob is encrypted should we need to call this method. When finish decryption, we don't need\n         // response info anymore.\n         if (decryptCallbackResultInfo.exception == null) {\n-          chunkIndexToBuf.put(chunkIndex,\n-              filterChunkToRange(decryptCallbackResultInfo.result.getDecryptedBlobContent()));\n-          numChunksRetrieved.incrementAndGet();\n+          DecryptJob.DecryptJobResult result = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142597248818fafb0895366890f8b971030b97b8"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3Nzk3MDQz", "url": "https://github.com/linkedin/ambry/pull/1656#pullrequestreview-507797043", "createdAt": "2020-10-13T20:18:07Z", "commit": {"oid": "142597248818fafb0895366890f8b971030b97b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 938, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}