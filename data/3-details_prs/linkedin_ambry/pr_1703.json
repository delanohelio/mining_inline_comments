{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MTQ3Njc3", "number": 1703, "title": "Changes to allow batch inserts/updates of accounts/container operations.", "bodyText": "Adding support for executing account and container inserts/updates in a batch with configurable batch size.", "createdAt": "2020-11-24T03:29:11Z", "url": "https://github.com/linkedin/ambry/pull/1703", "merged": true, "mergeCommit": {"oid": "0f3338b562219ac8afb2690b2b0a95621c52bbe7"}, "closed": true, "closedAt": "2020-12-03T00:14:30Z", "author": {"login": "Arun-LinkedIn"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfhGc0AH2gAyNTI2MTQ3Njc3Ojc3ZWRkYTYwNjE2NzMxYTEzNDgyNDRhZjRmOWQ0ZTM2YmZmMjM1ZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiXyyYgFqTU0MzM0MjUzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "77edda60616731a1348244af4f9d4e36bff235e9", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/77edda60616731a1348244af4f9d4e36bff235e9", "committedDate": "2020-11-24T03:22:48Z", "message": "Code changes to allow batch inserts/updates of accounts/container changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8", "committedDate": "2020-11-25T17:45:32Z", "message": "Add couple of unit tests for batch updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDgxODIw", "url": "https://github.com/linkedin/ambry/pull/1703#pullrequestreview-541481820", "createdAt": "2020-12-01T04:32:57Z", "commit": {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwNDozMjo1N1rOH8Xzxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwNjozNjoxOFrOH8Z_1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA2NjY5NQ==", "bodyText": "minor: add accounts to database in batches", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533066695", "createdAt": "2020-12-01T04:32:57Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/AccountDao.java", "diffHunk": "@@ -77,22 +78,28 @@ public void addAccount(Account account) throws SQLException {\n   }\n \n   /**\n-   * Gets all accounts that have been created or modified since the specified time.\n-   * @param updatedSince the last modified time used to filter.\n-   * @return a list of {@link Account}s.\n+   * Add an account to the database.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5NjgyNg==", "bodyText": "I wonder what will happen if first batch execution succeeds but second batch fails?", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533096826", "createdAt": "2020-12-01T06:19:01Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/AccountDao.java", "diffHunk": "@@ -77,22 +78,28 @@ public void addAccount(Account account) throws SQLException {\n   }\n \n   /**\n-   * Gets all accounts that have been created or modified since the specified time.\n-   * @param updatedSince the last modified time used to filter.\n-   * @return a list of {@link Account}s.\n+   * Add an account to the database.\n+   * @param accounts the account to insert.\n+   * @param batchSize number of statements to be executed in one batch\n    * @throws SQLException\n    */\n-  public List<Account> getNewAccounts(long updatedSince) throws SQLException {\n-    long startTimeMs = System.currentTimeMillis();\n-    Timestamp sinceTime = new Timestamp(updatedSince);\n-    PreparedStatement getSinceStatement = dataAccessor.getPreparedStatement(getSinceSql, false);\n-    getSinceStatement.setTimestamp(1, sinceTime);\n-    try (ResultSet rs = getSinceStatement.executeQuery()) {\n-      List<Account> accounts = convertResultSet(rs);\n-      dataAccessor.onSuccess(Read, System.currentTimeMillis() - startTimeMs);\n-      return accounts;\n+  public void addAccounts(Collection<Account> accounts, int batchSize) throws SQLException {\n+    try {\n+      long startTimeMs = System.currentTimeMillis();\n+      PreparedStatement insertStatement = dataAccessor.getPreparedStatement(insertSql, true);\n+      int count = 0;\n+      for (Account account : accounts) {\n+        insertStatement.setString(1, AccountCollectionSerde.accountToJsonNoContainers(account).toString());\n+        insertStatement.setInt(2, account.getSnapshotVersion());\n+        insertStatement.addBatch();\n+        if (++count % batchSize == 0) {\n+          insertStatement.executeBatch();\n+        }\n+      }\n+      insertStatement.executeBatch();\n+      dataAccessor.onSuccess(Write, System.currentTimeMillis() - startTimeMs);\n     } catch (SQLException e) {\n-      dataAccessor.onException(e, Read);\n+      dataAccessor.onException(e, Write);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5NzI5MA==", "bodyText": "minor: Updates a collection of accounts in the database.", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533097290", "createdAt": "2020-12-01T06:20:18Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/AccountDao.java", "diffHunk": "@@ -117,6 +124,55 @@ public void updateAccount(Account account) throws SQLException {\n     }\n   }\n \n+  /**\n+   * Updates an existing account in the database.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODM1Mg==", "bodyText": "nit:\n\nAdd containers from given account to database in batches\ncontainers'", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533098352", "createdAt": "2020-12-01T06:23:43Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/ContainerDao.java", "diffHunk": "@@ -83,6 +84,36 @@ public void addContainer(int accountId, Container container) throws SQLException\n     }\n   }\n \n+  /**\n+   * Add a containers to the database.\n+   * @param accountId the containers's parent account id.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODgxMA==", "bodyText": "same here", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533098810", "createdAt": "2020-12-01T06:25:03Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/ContainerDao.java", "diffHunk": "@@ -106,6 +137,37 @@ public void updateContainer(int accountId, Container container) throws SQLExcept\n     }\n   }\n \n+  /**\n+   * Updates a container in the database.\n+   * @param accountId the container's parent account id.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEwMDA0OQ==", "bodyText": "minor: add java doc for localDatacenter and config", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533100049", "createdAt": "2020-12-01T06:29:04Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/MySqlAccountStore.java", "diffHunk": "@@ -31,17 +32,20 @@\n   private final AccountDao accountDao;\n   private final ContainerDao containerDao;\n   private final MySqlDataAccessor mySqlDataAccessor;\n+  private final MySqlAccountServiceConfig config;\n \n   /**\n    * Constructor.\n    * @param dbEndpoints MySql DB end points\n    * @param metrics metrics to track mysql operations\n    * @throws SQLException\n    */\n-  public MySqlAccountStore(List<MySqlUtils.DbEndpoint> dbEndpoints, String localDatacenter, MySqlMetrics metrics) throws SQLException {\n+  public MySqlAccountStore(List<MySqlUtils.DbEndpoint> dbEndpoints, String localDatacenter, MySqlMetrics metrics,\n+      MySqlAccountServiceConfig config) throws SQLException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEwMjU0OQ==", "bodyText": "if count % batchSize = 0,  will line 99 execute an empty batch ?  I guess this is OK for database?", "url": "https://github.com/linkedin/ambry/pull/1703#discussion_r533102549", "createdAt": "2020-12-01T06:36:18Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/mysql/AccountDao.java", "diffHunk": "@@ -77,22 +78,28 @@ public void addAccount(Account account) throws SQLException {\n   }\n \n   /**\n-   * Gets all accounts that have been created or modified since the specified time.\n-   * @param updatedSince the last modified time used to filter.\n-   * @return a list of {@link Account}s.\n+   * Add an account to the database.\n+   * @param accounts the account to insert.\n+   * @param batchSize number of statements to be executed in one batch\n    * @throws SQLException\n    */\n-  public List<Account> getNewAccounts(long updatedSince) throws SQLException {\n-    long startTimeMs = System.currentTimeMillis();\n-    Timestamp sinceTime = new Timestamp(updatedSince);\n-    PreparedStatement getSinceStatement = dataAccessor.getPreparedStatement(getSinceSql, false);\n-    getSinceStatement.setTimestamp(1, sinceTime);\n-    try (ResultSet rs = getSinceStatement.executeQuery()) {\n-      List<Account> accounts = convertResultSet(rs);\n-      dataAccessor.onSuccess(Read, System.currentTimeMillis() - startTimeMs);\n-      return accounts;\n+  public void addAccounts(Collection<Account> accounts, int batchSize) throws SQLException {\n+    try {\n+      long startTimeMs = System.currentTimeMillis();\n+      PreparedStatement insertStatement = dataAccessor.getPreparedStatement(insertSql, true);\n+      int count = 0;\n+      for (Account account : accounts) {\n+        insertStatement.setString(1, AccountCollectionSerde.accountToJsonNoContainers(account).toString());\n+        insertStatement.setInt(2, account.getSnapshotVersion());\n+        insertStatement.addBatch();\n+        if (++count % batchSize == 0) {\n+          insertStatement.executeBatch();\n+        }\n+      }\n+      insertStatement.executeBatch();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMzMwMDE1", "url": "https://github.com/linkedin/ambry/pull/1703#pullrequestreview-542330015", "createdAt": "2020-12-01T21:57:43Z", "commit": {"oid": "b20dfb8091c86c38c5ebbc4ef18d276fb48b16e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69276caa92d72be979f90e779a24ad3b19c6ef4c", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/69276caa92d72be979f90e779a24ad3b19c6ef4c", "committedDate": "2020-12-02T01:34:30Z", "message": "Fix MySql int tests and address Rob/Yingyi's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzQyNTM4", "url": "https://github.com/linkedin/ambry/pull/1703#pullrequestreview-543342538", "createdAt": "2020-12-03T00:13:57Z", "commit": {"oid": "69276caa92d72be979f90e779a24ad3b19c6ef4c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1018, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}