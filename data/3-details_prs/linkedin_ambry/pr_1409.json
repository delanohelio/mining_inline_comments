{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNjIzNjQz", "number": 1409, "title": "Passing netty ByteBuf from NettyRequest to ByteBufferAsyncWritableChannel", "bodyText": "Passing netty ByteBuf in NettyRequest to ByteBufferAsyncWritableChannel.\nBy doing this, we can avoid creating a java ByteBuffer ( one less memory allocation) and copying data from httpContent.content() to newly created java ByteBuffer (one less memory copy).", "createdAt": "2020-03-02T21:43:23Z", "url": "https://github.com/linkedin/ambry/pull/1409", "merged": true, "mergeCommit": {"oid": "4ba30a9f0f17b80ab65911d6cb0adf52c04f7bd1"}, "closed": true, "closedAt": "2020-03-04T23:22:35Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKbsSSAFqTM2OTA0MDQwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKfT1ngH2gAyMzgyNjIzNjQzOmI2MDA3ZmYwNzVmY2ZhZTc2ZTYxY2VhM2E2ZjBkZmFjNDQ2Y2ZkYmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDQwNDAz", "url": "https://github.com/linkedin/ambry/pull/1409#pullrequestreview-369040403", "createdAt": "2020-03-04T19:01:08Z", "commit": {"oid": "03d15477d458545c088c5b95e9223992a5b4ac9a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3a2e6e7bdc0eb32bb55991c9c4d5c9f71d6c7d4", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/e3a2e6e7bdc0eb32bb55991c9c4d5c9f71d6c7d4", "committedDate": "2020-03-04T19:58:58Z", "message": "Passing netty ByteBuf from NettyRequest to ByteBufferAsyncWritableChannel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6179acfbae04360234ae76323897f3a12fc55e08", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/6179acfbae04360234ae76323897f3a12fc55e08", "committedDate": "2020-03-04T19:58:59Z", "message": "Fix the test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03d15477d458545c088c5b95e9223992a5b4ac9a", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/03d15477d458545c088c5b95e9223992a5b4ac9a", "committedDate": "2020-03-03T00:11:18Z", "message": "Fix the test"}, "afterCommit": {"oid": "6179acfbae04360234ae76323897f3a12fc55e08", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/6179acfbae04360234ae76323897f3a12fc55e08", "committedDate": "2020-03-04T19:58:59Z", "message": "Fix the test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTg1MDAz", "url": "https://github.com/linkedin/ambry/pull/1409#pullrequestreview-369185003", "createdAt": "2020-03-04T22:55:24Z", "commit": {"oid": "03d15477d458545c088c5b95e9223992a5b4ac9a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjo1NTo1OVrOFyArBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMzoxMTowNVrOFyBAuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NDEzNQ==", "bodyText": "double space here", "url": "https://github.com/linkedin/ambry/pull/1409#discussion_r387984135", "createdAt": "2020-03-04T22:55:59Z", "author": {"login": "cgtz"}, "path": "ambry-rest/src/main/java/com.github.ambry.rest/NettyRequest.java", "diffHunk": "@@ -453,56 +454,36 @@ protected boolean isMultipart() {\n    */\n   protected void writeContent(AsyncWritableChannel writeChannel, ReadIntoCallbackWrapper callbackWrapper,\n       HttpContent httpContent) {\n-    boolean retained = false;\n     ByteBuffer[] contentBuffers;\n-    Callback<Long>[] writeCallbacks;\n     // LastHttpContent in the end marker in netty http world.\n     boolean isLast = httpContent instanceof LastHttpContent;\n     if (isLast) {\n       setAutoRead(true);\n     }\n     if (httpContent.content().nioBufferCount() > 0) {\n-      // not a copy.\n-      httpContent = ReferenceCountUtil.retain(httpContent);\n-      retained = true;\n       contentBuffers = httpContent.content().nioBuffers();\n-      writeCallbacks = new ContentWriteCallback[contentBuffers.length];\n-      int i = 0;\n-      for (; i < contentBuffers.length - 1; i++) {\n-        writeCallbacks[i] = new ContentWriteCallback(null, false, callbackWrapper);\n-      }\n-      writeCallbacks[i] = new ContentWriteCallback(httpContent, isLast, callbackWrapper);\n     } else {\n       // this will not happen (looking at current implementations of ByteBuf in Netty), but if it does, we cannot avoid\n       // a copy (or we can introduce a read(GatheringByteChannel) method in ReadableStreamChannel if required).\n       nettyMetrics.contentCopyCount.inc();\n+      ByteBuf  content = httpContent.content();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6179acfbae04360234ae76323897f3a12fc55e08"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4OTY5MQ==", "bodyText": "Remove this ^", "url": "https://github.com/linkedin/ambry/pull/1409#discussion_r387989691", "createdAt": "2020-03-04T23:11:05Z", "author": {"login": "cgtz"}, "path": "ambry-rest/src/test/java/com.github.ambry.rest/NettyRequestTest.java", "diffHunk": "@@ -293,6 +293,7 @@ public void operationsAfterCloseTest() throws Exception {\n   }\n \n   /**\n+   * sed(line('.')) < 0) ? 'zc' : 'zo')<CR></CR>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6179acfbae04360234ae76323897f3a12fc55e08"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6007ff075fcfae76e61cea3a6f0dfac446cfdba", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/b6007ff075fcfae76e61cea3a6f0dfac446cfdba", "committedDate": "2020-03-04T23:14:03Z", "message": "casey comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1662, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}