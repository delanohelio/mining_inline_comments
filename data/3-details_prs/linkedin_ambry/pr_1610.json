{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyODQ4MDg4", "number": 1610, "title": "Create a MessageInfo.Builder to help build MessageInfo", "bodyText": "There has been too many MessageInfo constructors due to new fields being added to MessageInfo. This PR adds a Builder for MessageInfo in hope that later those constructors can be replaced by this builder.", "createdAt": "2020-08-25T00:06:30Z", "url": "https://github.com/linkedin/ambry/pull/1610", "merged": true, "mergeCommit": {"oid": "7986b46201fc5e18308161926e01c04653259bbd"}, "closed": true, "closedAt": "2020-09-02T17:38:05Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCyyOoAFqTQ3NTgzNzAwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE-XA3gFqTQ4MDk3NzgxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODM3MDA1", "url": "https://github.com/linkedin/ambry/pull/1610#pullrequestreview-475837005", "createdAt": "2020-08-26T20:32:21Z", "commit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozMjoyMlrOHHcqSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMToyMTo0NVrOHHeMjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3MTY1OA==", "bodyText": "Can we move this class to a separate file and call it MessageInfoBuilder?", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r477571658", "createdAt": "2020-08-26T20:32:22Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/store/MessageInfo.java", "diffHunk": "@@ -295,4 +295,175 @@ public String toString() {\n         .append(\"]\");\n     return stringBuilder.toString();\n   }\n+\n+  /**\n+   * A builder class for {@link MessageInfo}.\n+   */\n+  public static class Builder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3NjQ0MA==", "bodyText": "nit: extra this", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r477576440", "createdAt": "2020-08-26T20:41:13Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/store/MessageInfo.java", "diffHunk": "@@ -295,4 +295,175 @@ public String toString() {\n         .append(\"]\");\n     return stringBuilder.toString();\n   }\n+\n+  /**\n+   * A builder class for {@link MessageInfo}.\n+   */\n+  public static class Builder {\n+    private StoreKey key;\n+    private short accountId;\n+    private short containerId;\n+    private long operationTimeMs;\n+    private long size;\n+\n+    private long expirationTimeInMs = Utils.Infinite_Time;\n+    private boolean isDeleted = false;\n+    private boolean isTtlUpdated = false;\n+    private boolean isUndeleted = false;\n+    private Long crc = null;\n+    private short lifeVersion = 0;\n+\n+    /**\n+     * Constructor to create a builder.\n+     * @param key The {@link StoreKey} associated with {@link MessageInfo}.\n+     * @param size The size of this this message in bytes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3NjgyMg==", "bodyText": "nit:  @return This builder.", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r477576822", "createdAt": "2020-08-26T20:41:51Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/store/MessageInfo.java", "diffHunk": "@@ -295,4 +295,175 @@ public String toString() {\n         .append(\"]\");\n     return stringBuilder.toString();\n   }\n+\n+  /**\n+   * A builder class for {@link MessageInfo}.\n+   */\n+  public static class Builder {\n+    private StoreKey key;\n+    private short accountId;\n+    private short containerId;\n+    private long operationTimeMs;\n+    private long size;\n+\n+    private long expirationTimeInMs = Utils.Infinite_Time;\n+    private boolean isDeleted = false;\n+    private boolean isTtlUpdated = false;\n+    private boolean isUndeleted = false;\n+    private Long crc = null;\n+    private short lifeVersion = 0;\n+\n+    /**\n+     * Constructor to create a builder.\n+     * @param key The {@link StoreKey} associated with {@link MessageInfo}.\n+     * @param size The size of this this message in bytes.\n+     * @param accountId accountId of the blob.\n+     * @param containerId containerId of the blob.\n+     * @param operationTimeMs operation time in ms.\n+     */\n+    public Builder(StoreKey key, long size, short accountId, short containerId, long operationTimeMs) {\n+      this.key = key;\n+      this.size = size;\n+      this.accountId = accountId;\n+      this.containerId = containerId;\n+      this.operationTimeMs = operationTimeMs;\n+    }\n+\n+    /**\n+     * Constructor to create a builder from {@link MessageInfo}.\n+     * @param info The {@link MessageInfo} to build from.\n+     */\n+    public Builder(final MessageInfo info) {\n+      this.key = info.getStoreKey();\n+      this.accountId = info.getAccountId();\n+      this.containerId = info.getContainerId();\n+      this.operationTimeMs = info.getOperationTimeMs();\n+      this.size = info.getSize();\n+      this.expirationTimeInMs = info.getExpirationTimeInMs();\n+      this.isDeleted = info.isDeleted();\n+      this.isTtlUpdated = info.isTtlUpdated();\n+      this.isUndeleted = info.isUndeleted();\n+      this.crc = info.getCrc();\n+      this.lifeVersion = info.getLifeVersion();\n+    }\n+\n+    /**\n+     * Builds a {@link MessageInfo} object.\n+     * @return A {@link MessageInfo} object.\n+     */\n+    public MessageInfo build() {\n+      return new MessageInfo(key, size, isDeleted, isTtlUpdated, isUndeleted, expirationTimeInMs, crc, accountId,\n+          containerId, operationTimeMs, lifeVersion);\n+    }\n+\n+    /**\n+     * Sets the key of the {@link MessageInfo} to build.\n+     * @param key the key to set.\n+     * @return This builder.\n+     */\n+    public Builder storeKey(StoreKey key) {\n+      this.key = key;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets the accountId of the {@link MessageInfo} to build.\n+     * @param accountId the accountId to set.\n+     * @return This builder.\n+     */\n+    public Builder accountId(short accountId) {\n+      this.accountId = accountId;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets the containerId of the {@link MessageInfo} to build.\n+     * @param containerId the containerId to set.\n+     * @return This builder.\n+     */\n+    public Builder containerId(short containerId) {\n+      this.containerId = containerId;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets the operationTime in ms of the {@link MessageInfo} to build.\n+     * @param operationTimeMs the operationTime to set.\n+     * @return This builder.\n+     */\n+    public Builder operationTimeMs(long operationTimeMs) {\n+      this.operationTimeMs = operationTimeMs;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets the size of the {@link MessageInfo} to build.\n+     * @param size the size to set.\n+     * @return This builder.\n+     */\n+    public Builder size(long size) {\n+      this.size = size;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets expirationTime in ms of the {@link MessageInfo} to build.\n+     * @param expirationTimeInMs the expirationTime to set\n+     * @return This builder.\n+     */\n+    public Builder expirationTimeInMs(long expirationTimeInMs) {\n+      this.expirationTimeInMs = expirationTimeInMs;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets isDeleted flag of the {@link MessageInfo} to build.\n+     * @param isDeleted the isDeleted to set.\n+     * @return This builder.\n+     */\n+    public Builder isDeleted(boolean isDeleted) {\n+      this.isDeleted = isDeleted;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets isTtlUpdated flag of the {@link MessageInfo} to build.\n+     * @param isTtlUpdated the isTtlUpdated to set.\n+     * @return This builder.\n+     */\n+    public Builder isTtlUpdated(boolean isTtlUpdated) {\n+      this.isTtlUpdated = isTtlUpdated;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets isUndeleted flag of the {@link MessageInfo} to build.\n+     * @param isUndeleted the isUndeleted to set.\n+     * @return This builder.\n+     */\n+    public Builder isUndeleted(boolean isUndeleted) {\n+      this.isUndeleted = isUndeleted;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets crc of the {@link MessageInfo} to build.\n+     * @param crc the crc to set.\n+     * @return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580"}, "originalPosition": 169}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU5NjgxNA==", "bodyText": "minor: replace receivedRequest.getBlobProperties() with properties", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r477596814", "createdAt": "2020-08-26T21:21:45Z", "author": {"login": "jsjtzyy"}, "path": "ambry-protocol/src/main/java/com/github/ambry/protocol/AmbryRequests.java", "diffHunk": "@@ -168,11 +169,15 @@ public void handlePutRequest(NetworkRequest request) throws IOException, Interru\n             new PutMessageFormatInputStream(receivedRequest.getBlobId(), receivedRequest.getBlobEncryptionKey(),\n                 receivedRequest.getBlobProperties(), receivedRequest.getUsermetadata(), receivedRequest.getBlobStream(),\n                 receivedRequest.getBlobSize(), receivedRequest.getBlobType());\n-        MessageInfo info = new MessageInfo(receivedRequest.getBlobId(), stream.getSize(), false, false, false,\n-            Utils.addSecondsToEpochTime(receivedRequest.getBlobProperties().getCreationTimeInMs(),\n-                receivedRequest.getBlobProperties().getTimeToLiveInSeconds()), receivedRequest.getCrc(),\n-            receivedRequest.getBlobProperties().getAccountId(), receivedRequest.getBlobProperties().getContainerId(),\n-            receivedRequest.getBlobProperties().getCreationTimeInMs(), MessageInfo.LIFE_VERSION_FROM_FRONTEND);\n+        BlobProperties properties = receivedRequest.getBlobProperties();\n+        long expirationTime = Utils.addSecondsToEpochTime(receivedRequest.getBlobProperties().getCreationTimeInMs(),\n+            receivedRequest.getBlobProperties().getTimeToLiveInSeconds());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f3a8adb7ee926445bf2b2b343748fbd6b30758c", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/6f3a8adb7ee926445bf2b2b343748fbd6b30758c", "committedDate": "2020-08-31T20:19:08Z", "message": "Adding builder to messageinfo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b1bc5fee5445bae84ea9cb27eb3a1895a3d3430", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/2b1bc5fee5445bae84ea9cb27eb3a1895a3d3430", "committedDate": "2020-08-31T20:19:08Z", "message": "Add MessageInfo.Builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a40613f04c759baf2a352ba317441dd6339de785", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/a40613f04c759baf2a352ba317441dd6339de785", "committedDate": "2020-08-31T20:20:57Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/24a1c182c837e24efc69048cc29b30271f762580", "committedDate": "2020-08-25T00:04:35Z", "message": "Add MessageInfo.Builder"}, "afterCommit": {"oid": "a40613f04c759baf2a352ba317441dd6339de785", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/a40613f04c759baf2a352ba317441dd6339de785", "committedDate": "2020-08-31T20:20:57Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08a8f32872078a89d78aefed66e1267ff9e6e4b1", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/08a8f32872078a89d78aefed66e1267ff9e6e4b1", "committedDate": "2020-08-31T22:02:30Z", "message": "Revert typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwOTc3ODE1", "url": "https://github.com/linkedin/ambry/pull/1610#pullrequestreview-480977815", "createdAt": "2020-09-02T16:07:30Z", "commit": {"oid": "08a8f32872078a89d78aefed66e1267ff9e6e4b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNjowNzozMFrOHL2irw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNjowNzozMFrOHL2irw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE4OTk5OQ==", "bodyText": "looks like this one has slightly different behavior. The builder code always sets isDeleted to false. Was this intended?", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r482189999", "createdAt": "2020-09-02T16:07:30Z", "author": {"login": "cgtz"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -1255,10 +1252,7 @@ private void applyTtlUpdate(MessageInfo messageInfo, RemoteReplicaInfo remoteRep\n   private void applyUndelete(MessageInfo messageInfo, RemoteReplicaInfo remoteReplicaInfo) throws StoreException {\n     DataNodeId remoteNode = remoteReplicaInfo.getReplicaId().getDataNodeId();\n     try {\n-      messageInfo = new MessageInfo(messageInfo.getStoreKey(), messageInfo.getSize(), messageInfo.isDeleted(),\n-          messageInfo.isTtlUpdated(), true, messageInfo.getExpirationTimeInMs(), messageInfo.getCrc(),\n-          messageInfo.getAccountId(), messageInfo.getContainerId(), messageInfo.getOperationTimeMs(),\n-          messageInfo.getLifeVersion());\n+      messageInfo = new MessageInfo.Builder(messageInfo).isUndeleted(true).isDeleted(false).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08a8f32872078a89d78aefed66e1267ff9e6e4b1"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1219, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}