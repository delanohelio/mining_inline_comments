{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNjAzNjMz", "number": 1608, "title": "Use copy of ExchangeMetadataResponse while fetching missing keys for timed out standby replicas", "bodyText": "Issues:\n\nIllegalStateException thrown in writeMessagesToLocalStoreAndAdvanceTokens() due to mismatch in partition ID in partitionResponseInfo with remoteReplicaInfo\nIllegalArgumentException thrown in getReplicaMetadataResponse() when trying to read from connectionChannel inputStream (size of the stream from first 8 bytes is incorrect)\n\nExplanation: We are using references of ExchangeMetadataResponse stored in RemoteReplicaInfo while fetching the missing keys for standby(blocked) replicas. Due to that, it is possible that while an\ninter-colo thread is fetching missing store messages present in ExchangeMetadaResponse::missingStoreMessages set, other threads receive these messages and \"modify/empty the same set reference\".\nThis will lead to mismatch in state of missingStoreMessages tracked for a partition before and after fetching the keys. That is, before fetch, we would find missingStoreMessages is non-empty and send PartitionRequestInfo in\nGET request but when we receive the response,  we will skip/ignore the PartitionResponseInfo since missingStoreMessages is empty were emptied. This could lead to two kinds of issues during iteration of received responses in\nwriteMessagesToLocalStoreAndAdvanceTokens:\n\nIf we skip/ignore such partitions in middle of iteration, indexes of replica list and partition response list mismatch. This causes IllegalStateException.\nIf we skip/ignore such partitions at end of iteration, the inputStream is not read completely resulting in left over bytes for next replication cycle. This causes IllegalArgumentException.\n\nFix: Create a copy of ExchangeMetadataResponse (and its missingStoreMessages set) while fetching missing keys.", "createdAt": "2020-08-20T03:01:00Z", "url": "https://github.com/linkedin/ambry/pull/1608", "merged": true, "mergeCommit": {"oid": "aa5c3261c5dff764527638cb21d2001f5adfdf60"}, "closed": true, "closedAt": "2020-08-20T21:01:30Z", "author": {"login": "Arun-LinkedIn"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAzifaAH2gAyNDcwNjAzNjMzOjBiNWQ5MjBhNWZkYTViM2EyMjM3YTQ3OWFiZWQyZTU1ZmZlMDQ3MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA2Kx6gFqTQ3MTk1OTEzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0b5d920a5fda5b3a2237a479abed2e55ffe04704", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/0b5d920a5fda5b3a2237a479abed2e55ffe04704", "committedDate": "2020-08-20T17:20:04Z", "message": "Use copy of ExchangeMetadataResponse while fetching missing keys for timed out standby replicas\n\nIssues:\n 1. IllegalStateException thrown in writeMessagesToLocalStoreAndAdvanceTokens() due to mismatch in partition ID in partitionResponseInfo with remoteReplicaInfo\n 2. IllegalArgumentException thrown in getReplicaMetadataResponse() when trying to read from connectionChannel inputStream (size of the stream from first 8 bytes is incorrect)\n\nExplanation: We are using references of ExchangeMetadataResponse stored in RemoteReplicaInfo while fetching the missing keys for standby(blocked) replicas. Due to that, it is possible that while an\ninter-colo thread is fetching missing store messages present in ExchangeMetadaResponse::missingStoreMessages set, other threads receive these messages and \"modify/empty the same set reference\".\n\nThis will lead to mismatch in state of missingStoreMessages tracked for a partition before and after fetching the keys. That is, before fetch, we would find missingStoreMessages is non-empty and send PartitionRequestInfo in\nGET request but when we receive the response,  we will skip/ignore the PartitionResponseInfo since missingStoreMessages is empty were emptied. This could lead to two kinds of issues during iteration of received responses in\nwriteMessagesToLocalStoreAndAdvanceTokens:\n 1. If we skip/ignore such partitions in middle of iteration, indexes of replica list and partition response list mismatch. This causes IllegalStateException.\n 2. If we skip/ignore such partitions at end of iteration, the inputStream is not read completely resulting in left over bytes for next replication cycle. This causes IllegalArgumentException.\n\nFix: Create a copy of ExchangeMetadataResponse (and its missingStoreMessages set) while fetching missing keys."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODUyNjk3", "url": "https://github.com/linkedin/ambry/pull/1608#pullrequestreview-471852697", "createdAt": "2020-08-20T17:54:12Z", "commit": {"oid": "edf65b7c0fde41b21ca0759ccdbb708c6d6a473f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edf65b7c0fde41b21ca0759ccdbb708c6d6a473f", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/edf65b7c0fde41b21ca0759ccdbb708c6d6a473f", "committedDate": "2020-08-20T02:44:41Z", "message": "Use copy of ExchangeMetadataResponse while fetching missing keys for timed out standby replicas\nPossible issue: As an inter-colo thread could be fetching missing store messages present in ExchangeMetadaResponse::missingStoreMessages set, it is possible that an intra-colo thread\ncould update the set. This leads to mismatch in state for inter-colo thread after it fetched the messages and wants to write to store in writeMessagesToLocalStoreAndAdvanceTokens() function.\nPotential fix: Create a copy of ExchangeMetadataResponse (and its missingStoreMessages set) while fetching missing keys"}, "afterCommit": {"oid": "0b5d920a5fda5b3a2237a479abed2e55ffe04704", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/0b5d920a5fda5b3a2237a479abed2e55ffe04704", "committedDate": "2020-08-20T17:20:04Z", "message": "Use copy of ExchangeMetadataResponse while fetching missing keys for timed out standby replicas\n\nIssues:\n 1. IllegalStateException thrown in writeMessagesToLocalStoreAndAdvanceTokens() due to mismatch in partition ID in partitionResponseInfo with remoteReplicaInfo\n 2. IllegalArgumentException thrown in getReplicaMetadataResponse() when trying to read from connectionChannel inputStream (size of the stream from first 8 bytes is incorrect)\n\nExplanation: We are using references of ExchangeMetadataResponse stored in RemoteReplicaInfo while fetching the missing keys for standby(blocked) replicas. Due to that, it is possible that while an\ninter-colo thread is fetching missing store messages present in ExchangeMetadaResponse::missingStoreMessages set, other threads receive these messages and \"modify/empty the same set reference\".\n\nThis will lead to mismatch in state of missingStoreMessages tracked for a partition before and after fetching the keys. That is, before fetch, we would find missingStoreMessages is non-empty and send PartitionRequestInfo in\nGET request but when we receive the response,  we will skip/ignore the PartitionResponseInfo since missingStoreMessages is empty were emptied. This could lead to two kinds of issues during iteration of received responses in\nwriteMessagesToLocalStoreAndAdvanceTokens:\n 1. If we skip/ignore such partitions in middle of iteration, indexes of replica list and partition response list mismatch. This causes IllegalStateException.\n 2. If we skip/ignore such partitions at end of iteration, the inputStream is not read completely resulting in left over bytes for next replication cycle. This causes IllegalArgumentException.\n\nFix: Create a copy of ExchangeMetadataResponse (and its missingStoreMessages set) while fetching missing keys."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODY4MjA4", "url": "https://github.com/linkedin/ambry/pull/1608#pullrequestreview-471868208", "createdAt": "2020-08-20T18:16:25Z", "commit": {"oid": "0b5d920a5fda5b3a2237a479abed2e55ffe04704"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoxNjoyNVrOHENt5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODoxNjoyNVrOHENt5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4MTA5NQ==", "bodyText": "nit: please use a different name like \"other\" instead of \"old\".", "url": "https://github.com/linkedin/ambry/pull/1608#discussion_r474181095", "createdAt": "2020-08-20T18:16:25Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -1551,6 +1547,28 @@ ReplicationMetrics getReplicationMetrics() {\n       this.receivedStoreMessagesWithUpdatesPending = null;\n     }\n \n+    /**\n+     * Shallow copy Constructor for {@link ExchangeMetadataResponse}, which copies all field references with exception\n+     * of 'missingStoreMessages' for which it creates new Set object.\n+     * @param old old {@link ExchangeMetadataResponse} object.\n+     */\n+    ExchangeMetadataResponse(ExchangeMetadataResponse old) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b5d920a5fda5b3a2237a479abed2e55ffe04704"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a657c51f872d270933987f7e48fe25c381db428f", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/a657c51f872d270933987f7e48fe25c381db428f", "committedDate": "2020-08-20T20:16:07Z", "message": "Nit: Use 'other' instead of 'old' as parameter variable name in copy constructor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTU5MTM3", "url": "https://github.com/linkedin/ambry/pull/1608#pullrequestreview-471959137", "createdAt": "2020-08-20T20:23:53Z", "commit": {"oid": "a657c51f872d270933987f7e48fe25c381db428f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1215, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}