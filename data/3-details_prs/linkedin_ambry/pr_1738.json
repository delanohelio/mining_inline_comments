{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0OTg3Mjc3", "number": 1738, "title": "[StorageQuota] Adding more logs to quota classes", "bodyText": "Adding more logs to quota classes for future debugging.", "createdAt": "2020-12-23T19:06:59Z", "url": "https://github.com/linkedin/ambry/pull/1738", "merged": true, "mergeCommit": {"oid": "44e57399c6338f35d0a0c8eb09be7d90e892754c"}, "closed": true, "closedAt": "2021-01-07T17:30:20Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdtpI1VgFqTU2MzExNzMwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtuJb5AH2gAyNTQ0OTg3Mjc3OmUzMmNmNWM5YWI0N2FjYWM4NDQ5NTQxNzA4YzM3ZGM2OTMyMjc4YWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMTE3MzA1", "url": "https://github.com/linkedin/ambry/pull/1738#pullrequestreview-563117305", "createdAt": "2021-01-07T00:06:11Z", "commit": {"oid": "808e192c72bbb9811272eebc2b4bd53f16b91591"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwMDowNjoxMVrOIPaGCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwMDozNDo1MVrOIPa4Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyNzA4MQ==", "bodyText": "The trimmed result is ignored.", "url": "https://github.com/linkedin/ambry/pull/1738#discussion_r553027081", "createdAt": "2021-01-07T00:06:11Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/config/StorageQuotaConfig.java", "diffHunk": "@@ -127,5 +138,14 @@ public StorageQuotaConfig(VerifiableProperties verifiableProperties) {\n     mysqlStoreRetryBackoffMs = verifiableProperties.getLong(MYSQL_STORE_RETRY_BACKOFF_MS, 10 * 60 * 1000);\n     mysqlStoreRetryMaxCount = verifiableProperties.getInt(MYSQL_STORE_RETRY_MAX_COUNT, 1);\n     mysqlMonthlyBaseFetchOffsetSec = verifiableProperties.getLong(MYSQL_MONTHLY_BASE_FETCH_OFFSET_SEC, 60 * 60);\n+    enforcerMode = QuotaMode.valueOf(\n+        capitalize(verifiableProperties.getString(ENFORCER_MODE, DEFAULT_VALUE_ENFORCE_MODE).toLowerCase()));\n+  }\n+\n+  private String capitalize(String str) {\n+    if (str == null || str.isEmpty() || str.trim().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808e192c72bbb9811272eebc2b4bd53f16b91591"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAyOTQ4MQ==", "bodyText": "Could you add java doc for this method?", "url": "https://github.com/linkedin/ambry/pull/1738#discussion_r553029481", "createdAt": "2021-01-07T00:14:57Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/quota/StorageQuotaEnforcer.java", "diffHunk": "@@ -71,4 +71,12 @@\n    * @param mode The new value for {@link QuotaMode}.\n    */\n   void setQuotaMode(QuotaMode mode);\n+\n+  /**\n+   * Interface of callback method when the quota of certain account and container's quota is exceeded.\n+   */\n+  interface QuotaExceededCallback {\n+    void onQuotaExceeded(QuotaMode quotaMode, short accountId, short containerId, QuotaOperation op, long quota,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808e192c72bbb9811272eebc2b4bd53f16b91591"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAzMjE4MA==", "bodyText": "I am thinking if we can move this to caller method and use separate metrics for AccountService and AccountStatsReport. Thus, we have a clear view that how may QPS from AccountService, how many from Account Stats/ Quota Service.", "url": "https://github.com/linkedin/ambry/pull/1738#discussion_r553032180", "createdAt": "2021-01-07T00:24:48Z", "author": {"login": "jsjtzyy"}, "path": "ambry-mysql/src/main/java/com/github/ambry/mysql/MySqlDataAccessor.java", "diffHunk": "@@ -271,10 +271,13 @@ public static boolean isCredentialError(SQLException e) {\n   public void onException(SQLException e, OperationType operationType) {\n     if (e instanceof SQLTransientConnectionException) {\n       if (operationType == OperationType.Write) {\n+        metrics.writeRate.mark();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808e192c72bbb9811272eebc2b4bd53f16b91591"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAzOTcxMQ==", "bodyText": "nit: try to avoid string concatenation in the log.\nlogger.info(\"Setting Quota mode to {}\", mode.name());", "url": "https://github.com/linkedin/ambry/pull/1738#discussion_r553039711", "createdAt": "2021-01-07T00:34:19Z", "author": {"login": "jsjtzyy"}, "path": "ambry-quota/src/main/java/com/github/ambry/quota/AmbryStorageQuotaEnforcer.java", "diffHunk": "@@ -54,28 +69,35 @@ public boolean shouldThrottle(short accountId, short containerId, QuotaOperation\n             return v;\n           }\n         });\n+    if (exceedQuota.get() && quota != Long.MAX_VALUE && quotaExceededCallback != null) {\n+      quotaExceededCallback.onQuotaExceeded(mode, accountId, containerId, op, quota, existingUsage.get(), size);\n+    }\n     return mode == QuotaMode.Throttling ? exceedQuota.get() : false;\n   }\n \n   @Override\n   public void setQuotaMode(QuotaMode mode) {\n+    logger.info(\"Setting Quota mode to \" + mode.name());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808e192c72bbb9811272eebc2b4bd53f16b91591"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAzOTk3MQ==", "bodyText": "same here and please update whole class.", "url": "https://github.com/linkedin/ambry/pull/1738#discussion_r553039971", "createdAt": "2021-01-07T00:34:51Z", "author": {"login": "jsjtzyy"}, "path": "ambry-quota/src/main/java/com/github/ambry/quota/AmbryStorageQuotaEnforcer.java", "diffHunk": "@@ -54,28 +69,35 @@ public boolean shouldThrottle(short accountId, short containerId, QuotaOperation\n             return v;\n           }\n         });\n+    if (exceedQuota.get() && quota != Long.MAX_VALUE && quotaExceededCallback != null) {\n+      quotaExceededCallback.onQuotaExceeded(mode, accountId, containerId, op, quota, existingUsage.get(), size);\n+    }\n     return mode == QuotaMode.Throttling ? exceedQuota.get() : false;\n   }\n \n   @Override\n   public void setQuotaMode(QuotaMode mode) {\n+    logger.info(\"Setting Quota mode to \" + mode.name());\n     this.mode = mode;\n   }\n \n   @Override\n   public void initStorageUsage(Map<String, Map<String, Long>> usage) {\n+    logger.info(\"Initializing storage usage for \" + usage.size() + \" accounts\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "808e192c72bbb9811272eebc2b4bd53f16b91591"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61d7d03b5725854b7e273d7043fca68691441fc6", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/61d7d03b5725854b7e273d7043fca68691441fc6", "committedDate": "2021-01-07T01:19:34Z", "message": "[StorageQuota] Adding more logs to quota classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "150cb3f5e6c25bb6386c5de2c0315cfad0a4420a", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/150cb3f5e6c25bb6386c5de2c0315cfad0a4420a", "committedDate": "2021-01-07T01:19:34Z", "message": "Add more metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1fcea3c5d1cccbac46bf2a430b007932dc3c255", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/a1fcea3c5d1cccbac46bf2a430b007932dc3c255", "committedDate": "2021-01-07T01:28:31Z", "message": "Comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "808e192c72bbb9811272eebc2b4bd53f16b91591", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/808e192c72bbb9811272eebc2b4bd53f16b91591", "committedDate": "2021-01-06T01:27:25Z", "message": "Add more metrics"}, "afterCommit": {"oid": "a1fcea3c5d1cccbac46bf2a430b007932dc3c255", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/a1fcea3c5d1cccbac46bf2a430b007932dc3c255", "committedDate": "2021-01-07T01:28:31Z", "message": "Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMjI4MTI1", "url": "https://github.com/linkedin/ambry/pull/1738#pullrequestreview-563228125", "createdAt": "2021-01-07T05:57:46Z", "commit": {"oid": "a1fcea3c5d1cccbac46bf2a430b007932dc3c255"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNTo1Nzo0NlrOIPgBtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNTo1Nzo0NlrOIPgBtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzEyNDI3Nw==", "bodyText": "in practice, rate metrics behave pretty similarly to count metrics (since count metrics are partitioned into count/sec by the metrics sensors). Is there a specific reason for having both?", "url": "https://github.com/linkedin/ambry/pull/1738#discussion_r553124277", "createdAt": "2021-01-07T05:57:46Z", "author": {"login": "cgtz"}, "path": "ambry-mysql/src/main/java/com/github/ambry/mysql/MySqlMetrics.java", "diffHunk": "@@ -38,6 +42,9 @@\n   public final Histogram writeTimeMs;\n   public final Histogram readTimeMs;\n   public final Histogram copyTimeMs;\n+  public final Meter writeRate;\n+  public final Meter readRate;\n+  public final Meter copyRate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1fcea3c5d1cccbac46bf2a430b007932dc3c255"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMjI4ODEz", "url": "https://github.com/linkedin/ambry/pull/1738#pullrequestreview-563228813", "createdAt": "2021-01-07T05:59:52Z", "commit": {"oid": "a1fcea3c5d1cccbac46bf2a430b007932dc3c255"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNTo1OTo1MlrOIPgD6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNTo1OTo1MlrOIPgD6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzEyNDg0Mg==", "bodyText": "nit: some remaining string concats in this class", "url": "https://github.com/linkedin/ambry/pull/1738#discussion_r553124842", "createdAt": "2021-01-07T05:59:52Z", "author": {"login": "cgtz"}, "path": "ambry-quota/src/main/java/com/github/ambry/quota/MySqlStorageUsageRefresher.java", "diffHunk": "@@ -388,6 +390,7 @@ void persistentBackupFile(String filename, Map<String, Map<String, Long>> usage)\n       if (backupFiles.contains(filename)) {\n         return;\n       }\n+      logger.trace(\"Persist container usage for \" + filename);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1fcea3c5d1cccbac46bf2a430b007932dc3c255"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e32cf5c9ab47acac8449541708c37dc6932278ad", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/e32cf5c9ab47acac8449541708c37dc6932278ad", "committedDate": "2021-01-07T06:29:46Z", "message": "comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1066, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}