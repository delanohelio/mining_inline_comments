{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2ODMxOTk2", "number": 1390, "title": "Fix early close refcnt error", "bodyText": "This pr should fix this test error:\n\nIn order to prevent concurrent access of chunkIndexToBuf, this pr separates ByteBufs waiting to be written and the ByteBuf that already written but waiting for callback to comeback.", "createdAt": "2020-02-18T20:59:15Z", "url": "https://github.com/linkedin/ambry/pull/1390", "merged": true, "mergeCommit": {"oid": "160ce7e22079c455bcb4c961d02ff0cd50aea219"}, "closed": true, "closedAt": "2020-02-22T18:28:15Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcF9PdgAH2gAyMzc2ODMxOTk2OjA2ZDA3OWMyZTRmNjU3OWNiOWE0YTkzMmFhZWNhYmVmM2ZjZjBmOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcG4n6_gFqTM2MzA0MzQzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "06d079c2e4f6579cb9a4a932aaecabef3fcf0f91", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/06d079c2e4f6579cb9a4a932aaecabef3fcf0f91", "committedDate": "2020-02-19T21:16:48Z", "message": "Fix early close refcnt error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a6f54d8dcbd72d33b21695e8294311a74a3ad10", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/7a6f54d8dcbd72d33b21695e8294311a74a3ad10", "committedDate": "2020-02-19T21:16:48Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9219b25acbcbd3a6b90fc5e418c9e56888a44c08", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/9219b25acbcbd3a6b90fc5e418c9e56888a44c08", "committedDate": "2020-02-19T21:17:54Z", "message": "Remove unused stuff"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cbbee1fc0f69a12588b205c27d60838924967d3", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/8cbbee1fc0f69a12588b205c27d60838924967d3", "committedDate": "2020-02-19T01:56:08Z", "message": "Fix test"}, "afterCommit": {"oid": "9219b25acbcbd3a6b90fc5e418c9e56888a44c08", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/9219b25acbcbd3a6b90fc5e418c9e56888a44c08", "committedDate": "2020-02-19T21:17:54Z", "message": "Remove unused stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6358aa54bffc5ed37cd916d12a272869a13c426b", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/6358aa54bffc5ed37cd916d12a272869a13c426b", "committedDate": "2020-02-19T21:31:45Z", "message": "stuff"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNDY2Mzkz", "url": "https://github.com/linkedin/ambry/pull/1390#pullrequestreview-361466393", "createdAt": "2020-02-19T21:54:35Z", "commit": {"oid": "6358aa54bffc5ed37cd916d12a272869a13c426b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMTo1NDozNVrOFr5CwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMTo1NDozNVrOFr5CwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU2NzY4MQ==", "bodyText": "should this call come before asyncWritableChannel.write in case write calls chunkAsyncWriteCallback before the buff is added to the map?", "url": "https://github.com/linkedin/ambry/pull/1390#discussion_r381567681", "createdAt": "2020-02-19T21:54:35Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com.github.ambry.router/GetBlobOperation.java", "diffHunk": "@@ -442,9 +449,12 @@ private void maybeWriteToChannel() {\n       // if there are chunks available to be written out, do now.\n       if (firstChunk.isComplete() && readCalled) {\n         while (operationException.get() == null && chunkIndexToBuf.containsKey(indexOfNextChunkToWriteOut)) {\n-          ByteBuf byteBuf = chunkIndexToBuf.get(indexOfNextChunkToWriteOut);\n-          asyncWritableChannel.write(byteBuf.nioBuffer(), chunkAsyncWriteCallback);\n-          indexOfNextChunkToWriteOut++;\n+          ByteBuf byteBuf = chunkIndexToBuf.remove(indexOfNextChunkToWriteOut);\n+          if (byteBuf != null) {\n+            asyncWritableChannel.write(byteBuf.nioBuffer(), chunkAsyncWriteCallback);\n+            chunkIndexToBufWaitingForRelease.put(indexOfNextChunkToWriteOut, byteBuf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6358aa54bffc5ed37cd916d12a272869a13c426b"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b1947e35d3cb5999b1dda2b258a0e0fcf2b3eb9", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/8b1947e35d3cb5999b1dda2b258a0e0fcf2b3eb9", "committedDate": "2020-02-19T22:58:34Z", "message": "Address casey comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTA2ODg3", "url": "https://github.com/linkedin/ambry/pull/1390#pullrequestreview-361506887", "createdAt": "2020-02-19T23:10:36Z", "commit": {"oid": "8b1947e35d3cb5999b1dda2b258a0e0fcf2b3eb9"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMzoxMDozNlrOFr7EeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMzozNDoyOFrOFr7kUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYwMDg4OQ==", "bodyText": "Could you explain a little why we need wait for 1 sec here?", "url": "https://github.com/linkedin/ambry/pull/1390#discussion_r381600889", "createdAt": "2020-02-19T23:10:36Z", "author": {"login": "jsjtzyy"}, "path": "ambry-router/src/main/java/com.github.ambry.router/CryptoJobHandler.java", "diffHunk": "@@ -69,6 +70,11 @@ public void close() {\n           logger.error(\"Unknown type of job seen : \" + task.getClass());\n         }\n       }\n+      try {\n+        scheduler.awaitTermination(1000, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1947e35d3cb5999b1dda2b258a0e0fcf2b3eb9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYwOTA0Mg==", "bodyText": "In which case, there might be a chunk left? I feel like chunks have been read in previous loop.", "url": "https://github.com/linkedin/ambry/pull/1390#discussion_r381609042", "createdAt": "2020-02-19T23:34:28Z", "author": {"login": "jsjtzyy"}, "path": "ambry-router/src/test/java/com.github.ambry.router/GetBlobOperationTest.java", "diffHunk": "@@ -1215,6 +1212,9 @@ public void run() {\n                   chunksLeftToRead--;\n                 }\n                 result.getBlobResult.getBlobDataChannel().close();\n+                while (writableChannel.getNextChunk(100) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1947e35d3cb5999b1dda2b258a0e0fcf2b3eb9"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDQzNDMw", "url": "https://github.com/linkedin/ambry/pull/1390#pullrequestreview-363043430", "createdAt": "2020-02-22T18:27:55Z", "commit": {"oid": "8b1947e35d3cb5999b1dda2b258a0e0fcf2b3eb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1627, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}