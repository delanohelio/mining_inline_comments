{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMTg0NzA4", "number": 1435, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMzoxMDoyOFrODr6LxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOTo1NjowM1rODsNY6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzY4NjQ1OnYy", "diffSide": "RIGHT", "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/DynamicClusterChangeHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMzoxMDoyOFrOF8huww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNDoyMTo0MFrOF8istA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxMTUyMw==", "bodyText": "Would it be worth having a metric for this event? Would this mean that the replica never gets added until the machine is restarted or will it get added eventually?", "url": "https://github.com/linkedin/ambry/pull/1435#discussion_r399011523", "createdAt": "2020-03-27T03:10:28Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/DynamicClusterChangeHandler.java", "diffHunk": "@@ -360,10 +363,20 @@ private void addOrUpdateInstanceInfos(List<InstanceConfig> instanceConfigs) thro\n             // Ensure only one AmbryPartition instance exists for specific partition.\n             mappedPartition = clusterChangeHandlerCallback.addPartitionIfAbsent(mappedPartition, replicaCapacity);\n             ensurePartitionAbsenceOnNodeAndValidateCapacity(mappedPartition, dataNode, replicaCapacity);\n-            // create new replica belonging to this partition\n-            AmbryReplica replica =\n-                new AmbryServerReplica(clusterMapConfig, mappedPartition, disk, stoppedReplicas.contains(partitionName),\n-                    replicaCapacity, sealedReplicas.contains(partitionName));\n+            // create new replica belonging to this partition or find the existing replica from bootstrapReplicas map.\n+            AmbryReplica replica;\n+            if (selfInstanceName.equals(instanceName)) {\n+              // if this is a newly added replica on current instance, it should be present in bootstrapReplicas map.\n+              replica = (AmbryReplica) bootstrapReplicas.remove(mappedPartition.toPathString());\n+              if (replica == null) {\n+                logger.warn(\"Replica {} is not present in bootstrap replica set, skip adding it to clustermap\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44b41c1d5529383ce1ac5c25cf0809e17f84b371"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAyNzM4MA==", "bodyText": "Actually, replica == null should not happen in practice. If everything goes well, then the replica should be present in bootstrap replica map. If failure occurs during bootstrap, there are two cases to discuss:\n(1)  new replica is added but node crashes before updating Helix InstanceConfig\nThere is no InstanceConfig change. When machine is restarted, node will re-do replica addition and newly added replica should be in the map.\n(2) InstanceConfig is updated and then node crashes immediately\nSince new replica is already in InstanceConfig, once machine is restarted the new replica will be added to in-mem clustermap when handling initial InstanceConfig change (a different code path within createNewInstance() method)\nThere is only one rare case (human error) where we mistakenly update InstanceConfig of existing node by adding new replica rather than update IdealState, which may trigger this replica == null statement. In this case, it won't be added. Instead of a metric, I think I should throw an exception here and change the warn to error.", "url": "https://github.com/linkedin/ambry/pull/1435#discussion_r399027380", "createdAt": "2020-03-27T04:21:40Z", "author": {"login": "jsjtzyy"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/DynamicClusterChangeHandler.java", "diffHunk": "@@ -360,10 +363,20 @@ private void addOrUpdateInstanceInfos(List<InstanceConfig> instanceConfigs) thro\n             // Ensure only one AmbryPartition instance exists for specific partition.\n             mappedPartition = clusterChangeHandlerCallback.addPartitionIfAbsent(mappedPartition, replicaCapacity);\n             ensurePartitionAbsenceOnNodeAndValidateCapacity(mappedPartition, dataNode, replicaCapacity);\n-            // create new replica belonging to this partition\n-            AmbryReplica replica =\n-                new AmbryServerReplica(clusterMapConfig, mappedPartition, disk, stoppedReplicas.contains(partitionName),\n-                    replicaCapacity, sealedReplicas.contains(partitionName));\n+            // create new replica belonging to this partition or find the existing replica from bootstrapReplicas map.\n+            AmbryReplica replica;\n+            if (selfInstanceName.equals(instanceName)) {\n+              // if this is a newly added replica on current instance, it should be present in bootstrapReplicas map.\n+              replica = (AmbryReplica) bootstrapReplicas.remove(mappedPartition.toPathString());\n+              if (replica == null) {\n+                logger.warn(\"Replica {} is not present in bootstrap replica set, skip adding it to clustermap\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxMTUyMw=="}, "originalCommit": {"oid": "44b41c1d5529383ce1ac5c25cf0809e17f84b371"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzcwNjU3OnYy", "diffSide": "RIGHT", "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/DynamicClusterChangeHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMzoyMzo1NVrOF8h6iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwNDowMzo1OVrOF8idxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNDUzNw==", "bodyText": "Instead of passing the map directly to DynamicClusterChangeHandler, could you add a AmbryReplica popBootstrapReplica(String partition) method to ClusterChangeHandlerCallback?", "url": "https://github.com/linkedin/ambry/pull/1435#discussion_r399014537", "createdAt": "2020-03-27T03:23:55Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/DynamicClusterChangeHandler.java", "diffHunk": "@@ -360,10 +363,20 @@ private void addOrUpdateInstanceInfos(List<InstanceConfig> instanceConfigs) thro\n             // Ensure only one AmbryPartition instance exists for specific partition.\n             mappedPartition = clusterChangeHandlerCallback.addPartitionIfAbsent(mappedPartition, replicaCapacity);\n             ensurePartitionAbsenceOnNodeAndValidateCapacity(mappedPartition, dataNode, replicaCapacity);\n-            // create new replica belonging to this partition\n-            AmbryReplica replica =\n-                new AmbryServerReplica(clusterMapConfig, mappedPartition, disk, stoppedReplicas.contains(partitionName),\n-                    replicaCapacity, sealedReplicas.contains(partitionName));\n+            // create new replica belonging to this partition or find the existing replica from bootstrapReplicas map.\n+            AmbryReplica replica;\n+            if (selfInstanceName.equals(instanceName)) {\n+              // if this is a newly added replica on current instance, it should be present in bootstrapReplicas map.\n+              replica = (AmbryReplica) bootstrapReplicas.remove(mappedPartition.toPathString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44b41c1d5529383ce1ac5c25cf0809e17f84b371"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAyMzU1OQ==", "bodyText": "Yeah, we can do that. Actually, it is quite safe in terms of concurrency. There should be only one dc (where the current node sits) calling this method.", "url": "https://github.com/linkedin/ambry/pull/1435#discussion_r399023559", "createdAt": "2020-03-27T04:03:59Z", "author": {"login": "jsjtzyy"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/DynamicClusterChangeHandler.java", "diffHunk": "@@ -360,10 +363,20 @@ private void addOrUpdateInstanceInfos(List<InstanceConfig> instanceConfigs) thro\n             // Ensure only one AmbryPartition instance exists for specific partition.\n             mappedPartition = clusterChangeHandlerCallback.addPartitionIfAbsent(mappedPartition, replicaCapacity);\n             ensurePartitionAbsenceOnNodeAndValidateCapacity(mappedPartition, dataNode, replicaCapacity);\n-            // create new replica belonging to this partition\n-            AmbryReplica replica =\n-                new AmbryServerReplica(clusterMapConfig, mappedPartition, disk, stoppedReplicas.contains(partitionName),\n-                    replicaCapacity, sealedReplicas.contains(partitionName));\n+            // create new replica belonging to this partition or find the existing replica from bootstrapReplicas map.\n+            AmbryReplica replica;\n+            if (selfInstanceName.equals(instanceName)) {\n+              // if this is a newly added replica on current instance, it should be present in bootstrapReplicas map.\n+              replica = (AmbryReplica) bootstrapReplicas.remove(mappedPartition.toPathString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNDUzNw=="}, "originalCommit": {"oid": "44b41c1d5529383ce1ac5c25cf0809e17f84b371"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzcxMTQ0OnYy", "diffSide": "RIGHT", "path": "ambry-clustermap/src/test/java/com.github.ambry.clustermap/TestUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMzoyNzoxMFrOF8h9eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMzoyNzoxMFrOF8h9eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNTI5MA==", "bodyText": "No need to remove these, but for some reason, my formatter keeps the enum like this without compressing it onto one line like it used to. It may be different on different versions of LI intellij.", "url": "https://github.com/linkedin/ambry/pull/1435#discussion_r399015290", "createdAt": "2020-03-27T03:27:10Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/test/java/com.github.ambry.clustermap/TestUtils.java", "diffHunk": "@@ -39,20 +39,24 @@\n   static final int DEFAULT_XID = 64;\n \n   enum ReplicaStateType {\n+    // @formatter:off\n     SealedState,\n     StoppedState\n+    // @formatter:om\n   }\n \n   /**\n    * Resource state associated with datanode, disk and replica.\n    */\n   enum ResourceState {\n+    // @formatter:off\n     Node_Up,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44b41c1d5529383ce1ac5c25cf0809e17f84b371"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NjgyNTcxOnYy", "diffSide": "RIGHT", "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/HelixClusterManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOTo1Mzo1MFrOF8_5NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMDozMjoyOFrOF9A9TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwNTcxNg==", "bodyText": "Can this be just Map?", "url": "https://github.com/linkedin/ambry/pull/1435#discussion_r399505716", "createdAt": "2020-03-27T19:53:50Z", "author": {"login": "lightningrob"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/HelixClusterManager.java", "diffHunk": "@@ -73,6 +73,7 @@\n   private final AtomicLong sealedStateChangeCounter = new AtomicLong(0);\n   private final PartitionSelectionHelper partitionSelectionHelper;\n   private final Map<String, Map<String, String>> partitionOverrideInfoMap = new HashMap<>();\n+  private final ConcurrentHashMap<String, ReplicaId> bootstrapReplicas = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a334651e1184c6c3d5bf7122443d4e049da3189"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyMzE0OA==", "bodyText": "Yep, will make the change.", "url": "https://github.com/linkedin/ambry/pull/1435#discussion_r399523148", "createdAt": "2020-03-27T20:32:28Z", "author": {"login": "jsjtzyy"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/HelixClusterManager.java", "diffHunk": "@@ -73,6 +73,7 @@\n   private final AtomicLong sealedStateChangeCounter = new AtomicLong(0);\n   private final PartitionSelectionHelper partitionSelectionHelper;\n   private final Map<String, Map<String, String>> partitionOverrideInfoMap = new HashMap<>();\n+  private final ConcurrentHashMap<String, ReplicaId> bootstrapReplicas = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwNTcxNg=="}, "originalCommit": {"oid": "1a334651e1184c6c3d5bf7122443d4e049da3189"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NjgzMzA3OnYy", "diffSide": "RIGHT", "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/HelixClusterManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxOTo1NjowM1rOF8_9rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QyMToxMjoxNlrOF9B_7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwNjg2Mg==", "bodyText": "Pop makes it sound like a stack.  How about removeBootstrapReplica?", "url": "https://github.com/linkedin/ambry/pull/1435#discussion_r399506862", "createdAt": "2020-03-27T19:56:03Z", "author": {"login": "lightningrob"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/HelixClusterManager.java", "diffHunk": "@@ -617,6 +637,16 @@ void removeReplicasFromPartition(AmbryPartition partition, List<AmbryReplica> re\n     void addClusterWideRawCapacity(long diskRawCapacityBytes) {\n       clusterWideRawCapacityBytes.getAndAdd(diskRawCapacityBytes);\n     }\n+\n+    /**\n+     * Pop out bootstrap replica (if any) on current instance. A bootstrap replica is a replica dynamically added to\n+     * current node at runtime.\n+     * @param partitionName the partition name of bootstrap replica.\n+     * @return bootstrap replica or {@code null} if not found.\n+     */\n+    AmbryReplica popBootstrapReplica(String partitionName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a334651e1184c6c3d5bf7122443d4e049da3189"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MDIwNg==", "bodyText": "Considering the context of this method, I think I will rename it to fetchBootstrapReplica. It fetches a replica out (if any) from bootstrap replica map and add it into in-memory clustermap.\n(Just like fetchRequest() in GetBlobOperation, DeleteOperation, etc)", "url": "https://github.com/linkedin/ambry/pull/1435#discussion_r399540206", "createdAt": "2020-03-27T21:12:16Z", "author": {"login": "jsjtzyy"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/HelixClusterManager.java", "diffHunk": "@@ -617,6 +637,16 @@ void removeReplicasFromPartition(AmbryPartition partition, List<AmbryReplica> re\n     void addClusterWideRawCapacity(long diskRawCapacityBytes) {\n       clusterWideRawCapacityBytes.getAndAdd(diskRawCapacityBytes);\n     }\n+\n+    /**\n+     * Pop out bootstrap replica (if any) on current instance. A bootstrap replica is a replica dynamically added to\n+     * current node at runtime.\n+     * @param partitionName the partition name of bootstrap replica.\n+     * @return bootstrap replica or {@code null} if not found.\n+     */\n+    AmbryReplica popBootstrapReplica(String partitionName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwNjg2Mg=="}, "originalCommit": {"oid": "1a334651e1184c6c3d5bf7122443d4e049da3189"}, "originalPosition": 85}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1434, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}