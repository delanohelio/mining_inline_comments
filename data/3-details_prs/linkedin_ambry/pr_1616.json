{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NTU3MTU3", "number": 1616, "title": "[SEGMENTED_GET_FIX] Return correct size in headers for segmented blobs.", "bodyText": "The size of the segmented blob can only be determined when the segmented chunk has been fetched. This PR fixes the issue of returning correct for segmented blobs by taking advantage of the fact that for a segmented blob, first chunk will always be a metadata chunk, and subsequently there will be only data chunk that will ever be returned.", "createdAt": "2020-09-03T11:19:06Z", "url": "https://github.com/linkedin/ambry/pull/1616", "merged": true, "mergeCommit": {"oid": "2c401e9040da848b7b8740b3dee056fcde6fed78"}, "closed": true, "closedAt": "2020-09-14T20:38:49Z", "author": {"login": "ankagrawal"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFOsqvgH2gAyNDc4NTU3MTU3OmM5NTgzY2UxOGMzNDMxYTNlYjI5NTM1Y2YwOWI4Nzg2ZDk0ZDZlNTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH7KdsAFqTQ4NzA5NDE4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c9583ce18c3431a3eb29535cf09b8786d94d6e53", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/c9583ce18c3431a3eb29535cf09b8786d94d6e53", "committedDate": "2020-09-03T11:14:19Z", "message": "Return correct size if headers for segmented blobs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35", "committedDate": "2020-09-07T00:03:33Z", "message": "Fix size for encrypted blob."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTAxMjU2", "url": "https://github.com/linkedin/ambry/pull/1616#pullrequestreview-484501256", "createdAt": "2020-09-08T21:21:02Z", "commit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMToyMTowMlrOHOubrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNjoyNjowN1rOHPPxxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwMjg2Mw==", "bodyText": "hmm, it seems like this static init block wasn't even needed since it can be done in one line:\nstatic final Set<String> OPERATIONS = Collections...", "url": "https://github.com/linkedin/ambry/pull/1616#discussion_r485202863", "createdAt": "2020-09-08T21:21:02Z", "author": {"login": "cgtz"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/AmbrySecurityService.java", "diffHunk": "@@ -385,4 +384,9 @@ private void validateSecurePathIfRequired(RestRequest restRequest, String prefix\n       }\n     }\n   }\n+\n+  static {\n+    OPERATIONS = Collections.unmodifiableSet(Utils.getStaticFieldValuesAsStrings(Operations.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyMzQ3Mg==", "bodyText": "why move this variable down here?", "url": "https://github.com/linkedin/ambry/pull/1616#discussion_r485723472", "createdAt": "2020-09-09T15:57:10Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "diffHunk": "@@ -376,6 +416,8 @@ public void onCompletion(Long result, Exception exception) {\n         routerCallback.onPollReady();\n       }\n     };\n+    // the index of the next chunk that is to be written out to the asyncWritableChannel.\n+    private int indexOfNextChunkToWriteOut = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "originalPosition": 203}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc0OTE4OA==", "bodyText": "This seems to always set the size to the size of the first chunk regardless of which chunk is being fetched. Also, why can't this be done in the chunk == firstChunk block above? It looks like we have all of the necessary pieces to complete the operation at that time (BlobInfo for the properties of the composite blob, ChunkMetadata list to get the datachunk size, segment index from options)\nEDIT: Oh, I remember now that the first chunk internal logic already filters the list down to just the segment of interest. However, I'm still wondering what prevents this from working in the firstChunk block?", "url": "https://github.com/linkedin/ambry/pull/1616#discussion_r485749188", "createdAt": "2020-09-09T16:26:07Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "diffHunk": "@@ -252,15 +236,49 @@ private void onChunkOperationComplete(GetChunk chunk) {\n             routerMetrics.onGetBlobError(e, options, isEncrypted);\n           }\n         }\n-        NonBlockingRouter.completeOperation(null, getOperationCallback, operationResult, e);\n+        // We don't complete operation in case of segmented blob, as we don't have all the header information until we fetch the segmented chunk.\n+        if (e != null || !options.getBlobOptions.hasBlobSegmentIdx()) {\n+          NonBlockingRouter.completeOperation(null, getOperationCallback, operationResult, e);\n+        }\n       }\n+    } else if (options.getBlobOptions.hasBlobSegmentIdx()) {\n+      // We have fetched the segmented chunk, and there cannot be any more chunks to fetch now.\n+      fixBlobSizeIfRequired(blobInfo.getBlobProperties().getBlobSize(),\n+          firstChunk.getChunkMetadataList().get(0).getSize());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92d16597d4e7691c89bd477334ce67ae91c20b57", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/92d16597d4e7691c89bd477334ce67ae91c20b57", "committedDate": "2020-09-11T06:48:53Z", "message": "Address review comment to move the logic to firstChunk block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9373464bd417ce24219186360b53f2fe96b52f1a", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/9373464bd417ce24219186360b53f2fe96b52f1a", "committedDate": "2020-09-11T06:51:38Z", "message": "fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDE2MjU2", "url": "https://github.com/linkedin/ambry/pull/1616#pullrequestreview-487016256", "createdAt": "2020-09-11T18:05:29Z", "commit": {"oid": "9373464bd417ce24219186360b53f2fe96b52f1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDk0MTg2", "url": "https://github.com/linkedin/ambry/pull/1616#pullrequestreview-487094186", "createdAt": "2020-09-11T20:10:32Z", "commit": {"oid": "9373464bd417ce24219186360b53f2fe96b52f1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1235, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}