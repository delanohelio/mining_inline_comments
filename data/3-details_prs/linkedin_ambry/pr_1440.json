{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0Mjc5Njc0", "number": 1440, "title": "Integrate CompositeNetworkClient with CloudRouterFactory", "bodyText": "Prior to this change, CloudRouterFactory could only communicate with\ncloud services. This integrates CompositeNetworkClient which lets it\naddress both cloud service replicas and ambry-server replicas.\n\nFix a bug in CompositeNetworkClient. sendAndPoll on the child clients\nneeds to be called regardless of if there are new requests to send so\nthat any responses that come back are received in a timely manner.\nAdd support for the wakeup call to\nLocalNetworkClient/LocalRequestResponseChannel. This allows a\nsendAndPoll call to end before the timeout if the router indicates\nthat there is extra work to do (e.g. processing decrypted blobs)\nSome MockClusterMap changes to support adding a datacenter with\nCLOUD_BACKED replicas to the cluster. This will help test retry\npolicies with heterogenous clusters down the line and makes the\nexisting tests work with CompositeNetworkClient for now.", "createdAt": "2020-03-26T16:30:30Z", "url": "https://github.com/linkedin/ambry/pull/1440", "merged": true, "mergeCommit": {"oid": "18138a19cce810840edd9708568469f8ee318625"}, "closed": true, "closedAt": "2020-04-01T01:51:13Z", "author": {"login": "cgtz"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRzRGjABqjMxNzMxMzA3MTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTNugCAFqTM4NTIxNjA1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82773e022d0ad5d125fd6f274b2f754cbd14c62e", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/82773e022d0ad5d125fd6f274b2f754cbd14c62e", "committedDate": "2020-03-26T16:29:42Z", "message": "Integrate CompositeNetworkClient with CloudRouterFactory"}, "afterCommit": {"oid": "d0b3e291447df64847c21d0b3430a1700d96856a", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/d0b3e291447df64847c21d0b3430a1700d96856a", "committedDate": "2020-03-27T16:19:28Z", "message": "Integrate CompositeNetworkClient with CloudRouterFactory\n\nPrior to this change, CloudRouterFactory could only communicate with\ncloud services. This integrates CompositeNetworkClient which lets it\naddress both cloud service replicas and ambry-server replicas.\n\n- Fix a bug in CompositeNetworkClient. sendAndPoll on the child clients\n  needs to be called regardless of if there are new requests to send so\n  that any responses that come back are received in a timely manner.\n- Add support for the wakeup call to\n  LocalNetworkClient/LocalRequestResponseChannel. This allows a\n  sendAndPoll call to end before the timeout if the router indicates\n  that there is extra work to do (e.g. processing decrypted blobs)\n- Some MockClusterMap changes to support adding a datacenter with\n  CLOUD_BACKED replicas to the cluster. This will help test retry\n  policies with heterogenous clusters down the line and makes the\n  existing tests work with CompositeNetworkClient for now."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMjc1NDYw", "url": "https://github.com/linkedin/ambry/pull/1440#pullrequestreview-383275460", "createdAt": "2020-03-28T02:30:10Z", "commit": {"oid": "d0b3e291447df64847c21d0b3430a1700d96856a"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOFQwMjozMDoxMFrOF9GJRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMDowNDo1OVrOF96KqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYwODEzNA==", "bodyText": "Use constant for \"replica\".  Do we want port and partition with no separator?", "url": "https://github.com/linkedin/ambry/pull/1440#discussion_r399608134", "createdAt": "2020-03-28T02:30:10Z", "author": {"login": "lightningrob"}, "path": "ambry-test-utils/src/main/java/com/github/ambry/clustermap/MockReplicaId.java", "diffHunk": "@@ -40,18 +41,23 @@ public MockReplicaId(ReplicaType replicaType) {\n   public MockReplicaId(int port, MockPartitionId partitionId, MockDataNodeId dataNodeId, int indexOfMountPathToUse) {\n     this.partitionId = partitionId;\n     this.dataNodeId = dataNodeId;\n-    mountPath = dataNodeId.getMountPaths().get(indexOfMountPathToUse);\n-    File mountFile = new File(mountPath);\n-    File replicaFile = new File(mountFile, \"replica\" + port + partitionId.partition);\n-    replicaFile.mkdir();\n-    replicaFile.deleteOnExit();\n-    if (mountPath.startsWith(\"/vcr\")) {\n+    if (dataNodeId.getMountPaths().isEmpty()) {\n+      // a data node with no mount paths is a virtual data node which holds cloud service replicas.\n       replicaType = ReplicaType.CLOUD_BACKED;\n     } else {\n-      replicaType = ReplicaType.DISK_BACKED;\n+      mountPath = dataNodeId.getMountPaths().get(indexOfMountPathToUse);\n+      File mountFile = new File(mountPath);\n+      File replicaFile = new File(mountFile, \"replica\" + port + partitionId.partition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0b3e291447df64847c21d0b3430a1700d96856a"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYwODE4Nw==", "bodyText": "Would be nice to have const for this too, not sure where it's defined.", "url": "https://github.com/linkedin/ambry/pull/1440#discussion_r399608187", "createdAt": "2020-03-28T02:30:44Z", "author": {"login": "lightningrob"}, "path": "ambry-test-utils/src/main/java/com/github/ambry/clustermap/MockReplicaId.java", "diffHunk": "@@ -40,18 +41,23 @@ public MockReplicaId(ReplicaType replicaType) {\n   public MockReplicaId(int port, MockPartitionId partitionId, MockDataNodeId dataNodeId, int indexOfMountPathToUse) {\n     this.partitionId = partitionId;\n     this.dataNodeId = dataNodeId;\n-    mountPath = dataNodeId.getMountPaths().get(indexOfMountPathToUse);\n-    File mountFile = new File(mountPath);\n-    File replicaFile = new File(mountFile, \"replica\" + port + partitionId.partition);\n-    replicaFile.mkdir();\n-    replicaFile.deleteOnExit();\n-    if (mountPath.startsWith(\"/vcr\")) {\n+    if (dataNodeId.getMountPaths().isEmpty()) {\n+      // a data node with no mount paths is a virtual data node which holds cloud service replicas.\n       replicaType = ReplicaType.CLOUD_BACKED;\n     } else {\n-      replicaType = ReplicaType.DISK_BACKED;\n+      mountPath = dataNodeId.getMountPaths().get(indexOfMountPathToUse);\n+      File mountFile = new File(mountPath);\n+      File replicaFile = new File(mountFile, \"replica\" + port + partitionId.partition);\n+      replicaFile.mkdir();\n+      replicaFile.deleteOnExit();\n+      if (mountPath.startsWith(\"/vcr\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0b3e291447df64847c21d0b3430a1700d96856a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ1NzU2Nw==", "bodyText": "Minor: can you add a comment explaining why null is passed for notificationSystem?", "url": "https://github.com/linkedin/ambry/pull/1440#discussion_r400457567", "createdAt": "2020-03-30T19:59:42Z", "author": {"login": "lightningrob"}, "path": "ambry-router/src/main/java/com.github.ambry.router/CloudRouterFactory.java", "diffHunk": "@@ -168,10 +174,35 @@ static RequestHandlerPool getRequestHandlerPool(VerifiableProperties verifiableP\n     StoreKeyConverterFactory storeKeyConverterFactory =\n         Utils.getObj(serverConfig.serverStoreKeyConverterFactory, verifiableProperties, registry);\n     AmbryRequests requests =\n-        new AmbryRequests(cloudStorageManager, channel, clusterMap, nodeId, registry, serverMetrics, null,\n-            notificationSystem, null, storeKeyFactory, serverConfig.serverEnableStoreDataPrefetch,\n-            storeKeyConverterFactory);\n+        new AmbryRequests(cloudStorageManager, channel, clusterMap, nodeId, registry, serverMetrics, null, null, null,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0b3e291447df64847c21d0b3430a1700d96856a"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ1ODQzNQ==", "bodyText": "Javadoc", "url": "https://github.com/linkedin/ambry/pull/1440#discussion_r400458435", "createdAt": "2020-03-30T20:01:21Z", "author": {"login": "lightningrob"}, "path": "ambry-router/src/main/java/com.github.ambry.router/CloudRouterFactory.java", "diffHunk": "@@ -168,10 +174,35 @@ static RequestHandlerPool getRequestHandlerPool(VerifiableProperties verifiableP\n     StoreKeyConverterFactory storeKeyConverterFactory =\n         Utils.getObj(serverConfig.serverStoreKeyConverterFactory, verifiableProperties, registry);\n     AmbryRequests requests =\n-        new AmbryRequests(cloudStorageManager, channel, clusterMap, nodeId, registry, serverMetrics, null,\n-            notificationSystem, null, storeKeyFactory, serverConfig.serverEnableStoreDataPrefetch,\n-            storeKeyConverterFactory);\n+        new AmbryRequests(cloudStorageManager, channel, clusterMap, nodeId, registry, serverMetrics, null, null, null,\n+            storeKeyFactory, serverConfig.serverEnableStoreDataPrefetch, storeKeyConverterFactory);\n     return new RequestHandlerPool(serverConfig.serverRequestHandlerNumOfThreads, channel, requests);\n   }\n+\n+  private CompositeNetworkClientFactory getNetworkClientFactory(RequestHandlerPool requestHandlerPool,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0b3e291447df64847c21d0b3430a1700d96856a"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ2MDQ1Nw==", "bodyText": "Looks like this logic was copied from NonBlockingRouterFactory.  I'd prefer to see it reused somehow, though that can be done in a follow up.", "url": "https://github.com/linkedin/ambry/pull/1440#discussion_r400460457", "createdAt": "2020-03-30T20:04:59Z", "author": {"login": "lightningrob"}, "path": "ambry-router/src/main/java/com.github.ambry.router/CloudRouterFactory.java", "diffHunk": "@@ -168,10 +174,35 @@ static RequestHandlerPool getRequestHandlerPool(VerifiableProperties verifiableP\n     StoreKeyConverterFactory storeKeyConverterFactory =\n         Utils.getObj(serverConfig.serverStoreKeyConverterFactory, verifiableProperties, registry);\n     AmbryRequests requests =\n-        new AmbryRequests(cloudStorageManager, channel, clusterMap, nodeId, registry, serverMetrics, null,\n-            notificationSystem, null, storeKeyFactory, serverConfig.serverEnableStoreDataPrefetch,\n-            storeKeyConverterFactory);\n+        new AmbryRequests(cloudStorageManager, channel, clusterMap, nodeId, registry, serverMetrics, null, null, null,\n+            storeKeyFactory, serverConfig.serverEnableStoreDataPrefetch, storeKeyConverterFactory);\n     return new RequestHandlerPool(serverConfig.serverRequestHandlerNumOfThreads, channel, requests);\n   }\n+\n+  private CompositeNetworkClientFactory getNetworkClientFactory(RequestHandlerPool requestHandlerPool,\n+      MetricRegistry registry) {\n+    NetworkConfig networkConfig = new NetworkConfig(verifiableProperties);\n+    NetworkMetrics networkMetrics = new NetworkMetrics(registry);\n+    NetworkClientFactory cloudNetworkClientFactory =\n+        new LocalNetworkClientFactory((LocalRequestResponseChannel) requestHandlerPool.getChannel(), networkConfig,\n+            networkMetrics, time);\n+\n+    NetworkClientFactory diskNetworkClientFactory;\n+    if (new ClusterMapConfig(verifiableProperties).clusterMapHttp2NetworkClientEnabled) {\n+      Http2ClientConfig http2ClientConfig = new Http2ClientConfig(verifiableProperties);\n+      Http2ClientMetrics http2ClientMetrics = new Http2ClientMetrics(registry);\n+      diskNetworkClientFactory = new Http2NetworkClientFactory(http2ClientMetrics, http2ClientConfig, sslFactory, time);\n+    } else {\n+      diskNetworkClientFactory = new SocketNetworkClientFactory(networkMetrics, networkConfig, sslFactory,\n+          routerConfig.routerScalingUnitMaxConnectionsPerPortPlainText,\n+          routerConfig.routerScalingUnitMaxConnectionsPerPortSsl, routerConfig.routerConnectionCheckoutTimeoutMs, time);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0b3e291447df64847c21d0b3430a1700d96856a"}, "originalPosition": 108}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86fdce0db21cc61f188fd74fe242b3f575efc744", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/86fdce0db21cc61f188fd74fe242b3f575efc744", "committedDate": "2020-03-30T23:04:07Z", "message": "Integrate CompositeNetworkClient with CloudRouterFactory\n\nPrior to this change, CloudRouterFactory could only communicate with\ncloud services. This integrates CompositeNetworkClient which lets it\naddress both cloud service replicas and ambry-server replicas.\n\n- Fix a bug in CompositeNetworkClient. sendAndPoll on the child clients\n  needs to be called regardless of if there are new requests to send so\n  that any responses that come back are received in a timely manner.\n- Add support for the wakeup call to\n  LocalNetworkClient/LocalRequestResponseChannel. This allows a\n  sendAndPoll call to end before the timeout if the router indicates\n  that there is extra work to do (e.g. processing decrypted blobs)\n- Some MockClusterMap changes to support adding a datacenter with\n  CLOUD_BACKED replicas to the cluster. This will help test retry\n  policies with heterogenous clusters down the line and makes the\n  existing tests work with CompositeNetworkClient for now."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03a5984cfc54dfa7651891c921f31168f9f61871", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/03a5984cfc54dfa7651891c921f31168f9f61871", "committedDate": "2020-03-31T00:02:15Z", "message": "Address Rob's comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0b3e291447df64847c21d0b3430a1700d96856a", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/d0b3e291447df64847c21d0b3430a1700d96856a", "committedDate": "2020-03-27T16:19:28Z", "message": "Integrate CompositeNetworkClient with CloudRouterFactory\n\nPrior to this change, CloudRouterFactory could only communicate with\ncloud services. This integrates CompositeNetworkClient which lets it\naddress both cloud service replicas and ambry-server replicas.\n\n- Fix a bug in CompositeNetworkClient. sendAndPoll on the child clients\n  needs to be called regardless of if there are new requests to send so\n  that any responses that come back are received in a timely manner.\n- Add support for the wakeup call to\n  LocalNetworkClient/LocalRequestResponseChannel. This allows a\n  sendAndPoll call to end before the timeout if the router indicates\n  that there is extra work to do (e.g. processing decrypted blobs)\n- Some MockClusterMap changes to support adding a datacenter with\n  CLOUD_BACKED replicas to the cluster. This will help test retry\n  policies with heterogenous clusters down the line and makes the\n  existing tests work with CompositeNetworkClient for now."}, "afterCommit": {"oid": "03a5984cfc54dfa7651891c921f31168f9f61871", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/03a5984cfc54dfa7651891c921f31168f9f61871", "committedDate": "2020-03-31T00:02:15Z", "message": "Address Rob's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0Mzk1MDY2", "url": "https://github.com/linkedin/ambry/pull/1440#pullrequestreview-384395066", "createdAt": "2020-03-31T04:30:51Z", "commit": {"oid": "03a5984cfc54dfa7651891c921f31168f9f61871"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjE2MDUw", "url": "https://github.com/linkedin/ambry/pull/1440#pullrequestreview-385216050", "createdAt": "2020-04-01T01:50:12Z", "commit": {"oid": "03a5984cfc54dfa7651891c921f31168f9f61871"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1331, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}