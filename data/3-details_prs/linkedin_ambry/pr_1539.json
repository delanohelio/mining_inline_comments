{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MjA1MTEz", "number": 1539, "title": "Return failure reason in http header for undelete", "bodyText": "Return failure reason in http response header for undelete. Since undelete is not exposed outside of the linked datacenter and should be an admin operation, we should always return the failure reason in the header.", "createdAt": "2020-05-28T02:09:40Z", "url": "https://github.com/linkedin/ambry/pull/1539", "merged": true, "mergeCommit": {"oid": "9fe940652254133a09e5901231a402f9c95de78a"}, "closed": true, "closedAt": "2020-05-29T17:40:34Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclkI7igH2gAyNDI0MjA1MTEzOjg3ODFmYjUzODhlMjlhZDQ3MmNkOGNiNDIxZjU5ZDQ0MDQwMjUxMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmGFM7gFqTQyMTE1Nzk4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8781fb5388e29ad472cd8cb421f59d4404025104", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/8781fb5388e29ad472cd8cb421f59d4404025104", "committedDate": "2020-05-28T02:07:37Z", "message": "Return failure reason in http header for undelete"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5Nzk4NzY0", "url": "https://github.com/linkedin/ambry/pull/1539#pullrequestreview-419798764", "createdAt": "2020-05-28T06:01:33Z", "commit": {"oid": "8781fb5388e29ad472cd8cb421f59d4404025104"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNjowMTozM1rOGbmudg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNjowMTozM1rOGbmudg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU5OTIyMg==", "bodyText": "sorry, I realize that setting this option whenever a failure reason needs to be sent creates a lot of duplicate code. Maybe a better solution would be to have a request-level internal key that can be set to true when that request should be allowed to receive error info (for any exception type).\nTHe approach in this PR should work, though!", "url": "https://github.com/linkedin/ambry/pull/1539#discussion_r431599222", "createdAt": "2020-05-28T06:01:33Z", "author": {"login": "cgtz"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/FrontendRestRequestService.java", "diffHunk": "@@ -257,6 +256,10 @@ public void handlePut(RestRequest restRequest, RestResponseChannel restResponseC\n       } else if (requestPath.matchesOperation(Operations.UNDELETE) && frontendConfig.enableUndelete) {\n         // If the undelete is not enabled, then treat it as unrecognized operation.\n         undeleteHandler.handle(restRequest, restResponseChannel, (r, e) -> {\n+          if (e instanceof RouterException) {\n+            e = new RestServiceException(e.getMessage(),\n+                RestServiceErrorCode.getRestServiceErrorCode(((RouterException) e).getErrorCode()), true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8781fb5388e29ad472cd8cb421f59d4404025104"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5634689be8428674c5247880a53ea5324dfe533", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/c5634689be8428674c5247880a53ea5324dfe533", "committedDate": "2020-05-28T22:29:28Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTc5Njkw", "url": "https://github.com/linkedin/ambry/pull/1539#pullrequestreview-420579690", "createdAt": "2020-05-29T00:31:23Z", "commit": {"oid": "c5634689be8428674c5247880a53ea5324dfe533"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwMDozMToyM1rOGcLHVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwMDozMToyM1rOGcLHVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE5NTQxNA==", "bodyText": "thanks for making this change! I can change some of the code inside of AmbryLI to use this instead of the old approach.", "url": "https://github.com/linkedin/ambry/pull/1539#discussion_r432195414", "createdAt": "2020-05-29T00:31:23Z", "author": {"login": "cgtz"}, "path": "ambry-api/src/main/java/com/github/ambry/rest/RestUtils.java", "diffHunk": "@@ -297,6 +296,11 @@\n      * The key for the {@link RequestPath} that represents the parsed path of an incoming request.\n      */\n     public static final String REQUEST_PATH = KEY_PREFIX + \"request-path\";\n+\n+    /**\n+     * To be set to {@code true} if failures reason should be attached to frontend responses.\n+     */\n+    public static final String SEND_FAILURE_REASON = KEY_PREFIX + \"send-failure-reason\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5634689be8428674c5247880a53ea5324dfe533"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTUyNDg2", "url": "https://github.com/linkedin/ambry/pull/1539#pullrequestreview-421152486", "createdAt": "2020-05-29T17:31:55Z", "commit": {"oid": "c5634689be8428674c5247880a53ea5324dfe533"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzozMTo1NVrOGcl8Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzozMTo1NVrOGcl8Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzNDk3NA==", "bodyText": "why is this changed to onBlobUndeleted ?", "url": "https://github.com/linkedin/ambry/pull/1539#discussion_r432634974", "createdAt": "2020-05-29T17:31:55Z", "author": {"login": "zzmao"}, "path": "ambry-test-utils/src/main/java/com/github/ambry/router/InMemoryRouter.java", "diffHunk": "@@ -335,15 +335,13 @@ public void setLifeVersion(short lifeVersion) {\n       checkBlobId(blobId);\n       if (!blobs.containsKey(blobId)) {\n         exception = new RouterException(\"Blob not found\", RouterErrorCode.BlobDoesNotExist);\n-      } else if (undeletedBlobs.contains(blobId)) {\n-        exception = new RouterException(\"Blob already undeleted\", RouterErrorCode.BlobUndeleted);\n       } else if (!deletedBlobs.contains(blobId)) {\n         exception = new RouterException(\"Blob not deleted\", RouterErrorCode.BlobNotDeleted);\n       }\n       undeletedBlobs.add(blobId);\n       deletedBlobs.remove(blobId);\n       if (notificationSystem != null) {\n-        notificationSystem.onBlobDeleted(blobId, serviceId, null, null);\n+        notificationSystem.onBlobUndeleted(blobId, serviceId, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5634689be8428674c5247880a53ea5324dfe533"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTU3OTg5", "url": "https://github.com/linkedin/ambry/pull/1539#pullrequestreview-421157989", "createdAt": "2020-05-29T17:40:19Z", "commit": {"oid": "c5634689be8428674c5247880a53ea5324dfe533"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1076, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}