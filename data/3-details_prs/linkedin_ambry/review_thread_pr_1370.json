{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MTg4MDU1", "number": 1370, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjowMzo0NVrODbY2eQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwMDowNjoxM1rODdK97w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDQ1MzA1OnYy", "diffSide": "LEFT", "path": "ambry-server/src/main/java/com.github.ambry.server/AmbryServerRequests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjowMzo0NVrOFi2OZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjowNzoyMVrOFi2UjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA4NDMyNg==", "bodyText": "Why this method removed?", "url": "https://github.com/linkedin/ambry/pull/1370#discussion_r372084326", "createdAt": "2020-01-28T22:03:45Z", "author": {"login": "zzmao"}, "path": "ambry-server/src/main/java/com.github.ambry.server/AmbryServerRequests.java", "diffHunk": "@@ -100,39 +100,6 @@\n     localPartitionToReplicaMap = createLocalPartitionToReplicaMap();\n   }\n \n-  @Override\n-  public void handleRequests(NetworkRequest request) throws InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdff6c9b14f5a407530e58c7767e29b3d98923e6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA4NTkwMQ==", "bodyText": "AmbryServerRequests is a direct child of AmbryRequests and this method is trying to override the same method from AmbryRequests, but they are exactly the same method. So we can remove it.", "url": "https://github.com/linkedin/ambry/pull/1370#discussion_r372085901", "createdAt": "2020-01-28T22:07:21Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-server/src/main/java/com.github.ambry.server/AmbryServerRequests.java", "diffHunk": "@@ -100,39 +100,6 @@\n     localPartitionToReplicaMap = createLocalPartitionToReplicaMap();\n   }\n \n-  @Override\n-  public void handleRequests(NetworkRequest request) throws InterruptedException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA4NDMyNg=="}, "originalCommit": {"oid": "bdff6c9b14f5a407530e58c7767e29b3d98923e6"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODk1OTIyOnYy", "diffSide": "RIGHT", "path": "ambry-api/src/main/java/com.github.ambry/protocol/RequestAPI.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMjozOTozMVrOFlmATA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMjozOTozMVrOFlmATA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2NDMwMA==", "bodyText": "typo contains the partition", "url": "https://github.com/linkedin/ambry/pull/1370#discussion_r374964300", "createdAt": "2020-02-04T22:39:31Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com.github.ambry/protocol/RequestAPI.java", "diffHunk": "@@ -80,4 +80,14 @@\n   default void handleAdminRequest(NetworkRequest request) throws InterruptedException, IOException {\n     throw new UnsupportedOperationException(\"Admin request not supported on this node\");\n   }\n+\n+  /**\n+   * Undelete the blob from the store.\n+   * @param request the request that contains the partitioni and the id of the blob that needs to be undeleted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdff6c9b14f5a407530e58c7767e29b3d98923e6"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxODk2ODYwOnYy", "diffSide": "RIGHT", "path": "ambry-api/src/main/java/com.github.ambry/protocol/RequestAPI.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMjo0MzowN1rOFlmGEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwMjoyMjozMlrOFlp9XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2NTc3Nw==", "bodyText": "I don't think we need to explicitly use default here.", "url": "https://github.com/linkedin/ambry/pull/1370#discussion_r374965777", "createdAt": "2020-02-04T22:43:07Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com.github.ambry/protocol/RequestAPI.java", "diffHunk": "@@ -80,4 +80,14 @@\n   default void handleAdminRequest(NetworkRequest request) throws InterruptedException, IOException {\n     throw new UnsupportedOperationException(\"Admin request not supported on this node\");\n   }\n+\n+  /**\n+   * Undelete the blob from the store.\n+   * @param request the request that contains the partitioni and the id of the blob that needs to be undeleted.\n+   * @throws IOException if there are I/O errors carrying our the required operation.\n+   * @throws InterruptedException if request processing is interrupted.\n+   */\n+  default void handleUndeleteRequest(NetworkRequest request) throws InterruptedException, IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdff6c9b14f5a407530e58c7767e29b3d98923e6"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwNDU0Mg==", "bodyText": "Interface's abstract method can't have it's owner body unless it's a default method.", "url": "https://github.com/linkedin/ambry/pull/1370#discussion_r375004542", "createdAt": "2020-02-05T00:45:19Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com.github.ambry/protocol/RequestAPI.java", "diffHunk": "@@ -80,4 +80,14 @@\n   default void handleAdminRequest(NetworkRequest request) throws InterruptedException, IOException {\n     throw new UnsupportedOperationException(\"Admin request not supported on this node\");\n   }\n+\n+  /**\n+   * Undelete the blob from the store.\n+   * @param request the request that contains the partitioni and the id of the blob that needs to be undeleted.\n+   * @throws IOException if there are I/O errors carrying our the required operation.\n+   * @throws InterruptedException if request processing is interrupted.\n+   */\n+  default void handleUndeleteRequest(NetworkRequest request) throws InterruptedException, IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2NTc3Nw=="}, "originalCommit": {"oid": "bdff6c9b14f5a407530e58c7767e29b3d98923e6"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAyOTA4NA==", "bodyText": "I see.", "url": "https://github.com/linkedin/ambry/pull/1370#discussion_r375029084", "createdAt": "2020-02-05T02:22:32Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com.github.ambry/protocol/RequestAPI.java", "diffHunk": "@@ -80,4 +80,14 @@\n   default void handleAdminRequest(NetworkRequest request) throws InterruptedException, IOException {\n     throw new UnsupportedOperationException(\"Admin request not supported on this node\");\n   }\n+\n+  /**\n+   * Undelete the blob from the store.\n+   * @param request the request that contains the partitioni and the id of the blob that needs to be undeleted.\n+   * @throws IOException if there are I/O errors carrying our the required operation.\n+   * @throws InterruptedException if request processing is interrupted.\n+   */\n+  default void handleUndeleteRequest(NetworkRequest request) throws InterruptedException, IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2NTc3Nw=="}, "originalCommit": {"oid": "bdff6c9b14f5a407530e58c7767e29b3d98923e6"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxOTAzMDMwOnYy", "diffSide": "RIGHT", "path": "ambry-protocol/src/main/java/com.github.ambry.protocol/UndeleteRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzowODoxMVrOFlmrzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzowODoxMVrOFlmrzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3NTQzOA==", "bodyText": "can you also append operationTimeMs ?", "url": "https://github.com/linkedin/ambry/pull/1370#discussion_r374975438", "createdAt": "2020-02-04T23:08:11Z", "author": {"login": "jsjtzyy"}, "path": "ambry-protocol/src/main/java/com.github.ambry.protocol/UndeleteRequest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.protocol;\n+\n+import com.github.ambry.clustermap.ClusterMap;\n+import com.github.ambry.commons.BlobId;\n+import com.github.ambry.utils.Utils;\n+import java.io.DataInputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.WritableByteChannel;\n+\n+\n+/**\n+ * Undelete request to undelete a deleted blob.\n+ */\n+public class UndeleteRequest extends RequestOrResponse {\n+  static final short UNDELETE_REQUEST_VERSION_1 = 1;\n+  private final static short CURRENT_VERSION = UNDELETE_REQUEST_VERSION_1;\n+\n+  private int sizeSent = 0;\n+  private final BlobId blobId;\n+  private final long operationTimeMs;\n+\n+  /**\n+   * Constructs {@link UndeleteRequest} in {@link #UNDELETE_REQUEST_VERSION_1}.\n+   * @param correlationId correlationId of the undelete request\n+   * @param clientId clientId of the undelete request\n+   * @param blobId blobId of the undelete request\n+   * @param operationTimeMs the time when this operation is created (in ms).\n+   */\n+  public UndeleteRequest(int correlationId, String clientId, BlobId blobId, long operationTimeMs) {\n+    this(correlationId, clientId, blobId, operationTimeMs, CURRENT_VERSION);\n+  }\n+\n+  /**\n+   * Constructs {@link UndeleteRequest} in given version.\n+   * @param correlationId correlationId of the undelete request\n+   * @param clientId clientId of the undelete request\n+   * @param blobId blobId of the undelete request\n+   * @param operationTimeMs the time when this operation is created (in ms).\n+   * @param version version of the {@link UndeleteRequest}.\n+   */\n+  public UndeleteRequest(int correlationId, String clientId, BlobId blobId, long operationTimeMs, short version) {\n+    super(RequestOrResponseType.UndeleteRequest, version, correlationId, clientId);\n+    this.blobId = blobId;\n+    this.operationTimeMs = operationTimeMs;\n+    sizeSent = 0;\n+  }\n+\n+  public static UndeleteRequest readFrom(DataInputStream stream, ClusterMap map) throws IOException {\n+    Short version = stream.readShort();\n+    if (version != UNDELETE_REQUEST_VERSION_1) {\n+      throw new IllegalStateException(\"Unknown undelete request version \" + version);\n+    }\n+    int correlationId = stream.readInt();\n+    String clientId = Utils.readIntString(stream);\n+    BlobId id = new BlobId(stream, map);\n+    long operationTimeMs = stream.readLong();\n+    return new UndeleteRequest(correlationId, clientId, id, operationTimeMs);\n+  }\n+\n+  @Override\n+  public long writeTo(WritableByteChannel channel) throws IOException {\n+    long written = 0;\n+    if (bufferToSend == null) {\n+      bufferToSend = ByteBuffer.allocate((int) sizeInBytes());\n+      writeHeader();\n+      bufferToSend.put(blobId.toBytes());\n+      bufferToSend.putLong(operationTimeMs);\n+      bufferToSend.flip();\n+    }\n+    if (bufferToSend.remaining() > 0) {\n+      written = channel.write(bufferToSend);\n+      sizeSent += written;\n+    }\n+    return written;\n+  }\n+\n+  @Override\n+  public boolean isSendComplete() {\n+    return sizeSent == sizeInBytes();\n+  }\n+\n+  @Override\n+  public long sizeInBytes() {\n+    // header + blobId\n+    return super.sizeInBytes() + blobId.sizeInBytes() + Long.BYTES;\n+  }\n+\n+  /**\n+   * Return blob id.\n+   * @return The {@link BlobId}.\n+   */\n+  public BlobId getBlobId() {\n+    return blobId;\n+  }\n+\n+  /**\n+   * Return the account id for the blob to be undeleted.\n+   * @return the account ID.\n+   */\n+  public short getAccountId() {\n+    return blobId.getAccountId();\n+  }\n+\n+  /**\n+   * Return the container id for the blob to be undeleted.\n+   * @return the container id.\n+   */\n+  public short getContainerId() {\n+    return blobId.getContainerId();\n+  }\n+\n+  /**\n+   * Return the operationTimeMs.\n+   * @return the operationTimeMs.\n+   */\n+  public long getOperationTimeMs() {\n+    return operationTimeMs;\n+  }\n+\n+  @Override\n+  public String toString() {\n+    StringBuilder sb = new StringBuilder();\n+    sb.append(\"UndeleteRequest[\");\n+    sb.append(\"BlobID=\").append(blobId);\n+    sb.append(\", \").append(\"PartitionId=\").append(blobId.getPartition());\n+    sb.append(\", \").append(\"ClientId=\").append(clientId);\n+    sb.append(\", \").append(\"CorrelationId=\").append(correlationId);\n+    sb.append(\", \").append(\"AccountId=\").append(blobId.getAccountId());\n+    sb.append(\", \").append(\"ContainerId=\").append(blobId.getContainerId());\n+    sb.append(\"]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdff6c9b14f5a407530e58c7767e29b3d98923e6"}, "originalPosition": 144}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxOTE0OTkxOnYy", "diffSide": "RIGHT", "path": "ambry-protocol/src/main/java/com.github.ambry.protocol/UndeleteResponse.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwMDowNjoxM1rOFln1NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwMDo0ODoxNlrOFlogjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk5NDIyOQ==", "bodyText": "Can you explain a little more about this exception?", "url": "https://github.com/linkedin/ambry/pull/1370#discussion_r374994229", "createdAt": "2020-02-05T00:06:13Z", "author": {"login": "jsjtzyy"}, "path": "ambry-protocol/src/main/java/com.github.ambry.protocol/UndeleteResponse.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.protocol;\n+\n+import com.github.ambry.server.ServerErrorCode;\n+import com.github.ambry.utils.Utils;\n+import java.io.DataInputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.WritableByteChannel;\n+\n+\n+/**\n+ * Response of undelete rqeuest.\n+ */\n+public class UndeleteResponse extends Response {\n+  private static final short UNDELETE_RESPONSE_VERSION_1 = 1;\n+  public static final short INVALID_LIFE_VERSION = -1;\n+\n+  private short lifeVersion;\n+  private static final int Life_Version_InBytes = Short.BYTES;\n+\n+  /**\n+   * Constructs a {@link UndeleteResponse} with an {@link ServerErrorCode}.\n+   * @param correlationId correlationId of the undelete response.\n+   * @param clientId clientId of the undelete response.\n+   * @param error error code returned in this undelete response.\n+   */\n+  public UndeleteResponse(int correlationId, String clientId, ServerErrorCode error) {\n+    super(RequestOrResponseType.UndeleteResponse, UNDELETE_RESPONSE_VERSION_1, correlationId, clientId, error);\n+    if (error == ServerErrorCode.No_Error) {\n+      throw new IllegalArgumentException(\"NoError is not a valid error code\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdff6c9b14f5a407530e58c7767e29b3d98923e6"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwNTMyNA==", "bodyText": "there are two possible responses for undelete request: 1 Normal response with a lifeVersion and NO_ERROR code, 2 error response with a invalid lifeVersion number and any error code rather than NO_ERROR. That's why I am throwing out an exception here.", "url": "https://github.com/linkedin/ambry/pull/1370#discussion_r375005324", "createdAt": "2020-02-05T00:48:16Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-protocol/src/main/java/com.github.ambry.protocol/UndeleteResponse.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.protocol;\n+\n+import com.github.ambry.server.ServerErrorCode;\n+import com.github.ambry.utils.Utils;\n+import java.io.DataInputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.WritableByteChannel;\n+\n+\n+/**\n+ * Response of undelete rqeuest.\n+ */\n+public class UndeleteResponse extends Response {\n+  private static final short UNDELETE_RESPONSE_VERSION_1 = 1;\n+  public static final short INVALID_LIFE_VERSION = -1;\n+\n+  private short lifeVersion;\n+  private static final int Life_Version_InBytes = Short.BYTES;\n+\n+  /**\n+   * Constructs a {@link UndeleteResponse} with an {@link ServerErrorCode}.\n+   * @param correlationId correlationId of the undelete response.\n+   * @param clientId clientId of the undelete response.\n+   * @param error error code returned in this undelete response.\n+   */\n+  public UndeleteResponse(int correlationId, String clientId, ServerErrorCode error) {\n+    super(RequestOrResponseType.UndeleteResponse, UNDELETE_RESPONSE_VERSION_1, correlationId, clientId, error);\n+    if (error == ServerErrorCode.No_Error) {\n+      throw new IllegalArgumentException(\"NoError is not a valid error code\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk5NDIyOQ=="}, "originalCommit": {"oid": "bdff6c9b14f5a407530e58c7767e29b3d98923e6"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1677, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}