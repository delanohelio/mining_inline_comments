{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxODk2ODY3", "number": 1657, "title": "Mysql error handling and retries", "bodyText": "When container update fails with conflict error, refresh cache and retry operation.\nAccountService.updateAccounts() now throws AccountServiceException.\nFail creation of MySqlAccountService if bad DB credentials are supplied.", "createdAt": "2020-10-13T00:28:13Z", "url": "https://github.com/linkedin/ambry/pull/1657", "merged": true, "mergeCommit": {"oid": "10fc181eb2ca065eaf09a9ce49444787d66ed17c"}, "closed": true, "closedAt": "2020-10-20T03:06:11Z", "author": {"login": "lightningrob"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR77e1gH2gAyNTAxODk2ODY3OjFjODI2M2IyMzljYjVlMTBkMzM0YzFmZjc3Yjc1Y2RmZGU1NDViZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUP4GDAFqTUxMjI5Nzg0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c8263b239cb5e10d334c1ff77b75cdfde545be6", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/1c8263b239cb5e10d334c1ff77b75cdfde545be6", "committedDate": "2020-10-12T22:43:19Z", "message": "Handle database errors and retry as needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aba3f3d58f8dc8e58ddab8d35620957d0694a06", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/9aba3f3d58f8dc8e58ddab8d35620957d0694a06", "committedDate": "2020-10-12T23:39:03Z", "message": "Merge branch 'master' of github.com:linkedin/ambry into mysql-error-retry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "591bd21c04ebd8d082a5c62791592057f22a954f", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/591bd21c04ebd8d082a5c62791592057f22a954f", "committedDate": "2020-10-13T00:26:34Z", "message": "Merge branch 'master' of github.com:linkedin/ambry into mysql-error-retry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "379bcb720541e4e04f36fedf1d528832ded2ad80", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/379bcb720541e4e04f36fedf1d528832ded2ad80", "committedDate": "2020-10-13T00:30:01Z", "message": "Revert accidental property change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f5e2ad6b386ae048627cfa8b35e75dfe97c0e26", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/6f5e2ad6b386ae048627cfa8b35e75dfe97c0e26", "committedDate": "2020-10-13T00:42:46Z", "message": "Compile and test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edc6a27609e5da5cbc80e345777cc6b57534b386", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/edc6a27609e5da5cbc80e345777cc6b57534b386", "committedDate": "2020-10-14T05:14:37Z", "message": "Update tests that call AccountService.updateAccounts to handle exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b0eb119bbed3c89b9c882aff6786e46054fd80b", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/6b0eb119bbed3c89b9c882aff6786e46054fd80b", "committedDate": "2020-10-14T05:19:47Z", "message": "Merge branch 'master' of github.com:linkedin/ambry into mysql-error-retry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a7c7b24081b2c19ed155555be4377c2100146f3", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/0a7c7b24081b2c19ed155555be4377c2100146f3", "committedDate": "2020-10-14T05:43:53Z", "message": "Fix merge issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4260a208aee1780dca219d3eecb6726593ea9da0", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/4260a208aee1780dca219d3eecb6726593ea9da0", "committedDate": "2020-10-14T06:00:07Z", "message": "Test fix and cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f0ec1df12d06475ea55b3805d72db36ba2bd66f", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/2f0ec1df12d06475ea55b3805d72db36ba2bd66f", "committedDate": "2020-10-14T18:15:25Z", "message": "Test fix and minor refactoring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NjI2Nzk4", "url": "https://github.com/linkedin/ambry/pull/1657#pullrequestreview-509626798", "createdAt": "2020-10-15T17:49:46Z", "commit": {"oid": "2f0ec1df12d06475ea55b3805d72db36ba2bd66f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0OTo0N1rOHiTQfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzo0OTo0N1rOHiTQfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyOTE0OQ==", "bodyText": "nit: typo for word cache", "url": "https://github.com/linkedin/ambry/pull/1657#discussion_r505729149", "createdAt": "2020-10-15T17:49:47Z", "author": {"login": "Arun-LinkedIn"}, "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "diffHunk": "@@ -152,6 +156,8 @@ void fetchAndUpdateCache() {\n         } finally {\n           infoMapLock.writeLock().unlock();\n         }\n+        // At this point we can safely say cash is refreshed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f0ec1df12d06475ea55b3805d72db36ba2bd66f"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODA4NjY1", "url": "https://github.com/linkedin/ambry/pull/1657#pullrequestreview-509808665", "createdAt": "2020-10-15T21:05:22Z", "commit": {"oid": "2f0ec1df12d06475ea55b3805d72db36ba2bd66f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTc4MTUx", "url": "https://github.com/linkedin/ambry/pull/1657#pullrequestreview-511978151", "createdAt": "2020-10-19T17:08:58Z", "commit": {"oid": "2f0ec1df12d06475ea55b3805d72db36ba2bd66f"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzowODo1OFrOHkYrjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzoxODo1NVrOHkZC7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxNTE0OA==", "bodyText": "It seems this method uses both return false and AccountServiceException to handle failure cases. Can we throw AccountServiceException everywhere to make it consistent? Also we can consider removing boolean return value, if the method goes through without exception, then it should be a success.", "url": "https://github.com/linkedin/ambry/pull/1657#discussion_r507915148", "createdAt": "2020-10-19T17:08:58Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -263,7 +263,7 @@ public boolean updateAccounts(Collection<Account> accounts) {\n    * @return True when the update operation succeeds.\n    */\n   boolean updateAccountsWithAccountMetadataStore(Collection<Account> accounts,\n-      AccountMetadataStore accountMetadataStore) {\n+      AccountMetadataStore accountMetadataStore) throws AccountServiceException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f0ec1df12d06475ea55b3805d72db36ba2bd66f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxNTYwMA==", "bodyText": "Feel free to add new type of error code to AccountServiceErrorCode", "url": "https://github.com/linkedin/ambry/pull/1657#discussion_r507915600", "createdAt": "2020-10-19T17:09:40Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -263,7 +263,7 @@ public boolean updateAccounts(Collection<Account> accounts) {\n    * @return True when the update operation succeeds.\n    */\n   boolean updateAccountsWithAccountMetadataStore(Collection<Account> accounts,\n-      AccountMetadataStore accountMetadataStore) {\n+      AccountMetadataStore accountMetadataStore) throws AccountServiceException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxNTE0OA=="}, "originalCommit": {"oid": "2f0ec1df12d06475ea55b3805d72db36ba2bd66f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyMTEzNA==", "bodyText": "Is this because  throwing AccountServiceException will bring lots of changes in too many places?", "url": "https://github.com/linkedin/ambry/pull/1657#discussion_r507921134", "createdAt": "2020-10-19T17:18:55Z", "author": {"login": "jsjtzyy"}, "path": "ambry-test-utils/src/main/java/com/github/ambry/account/InMemAccountService.java", "diffHunk": "@@ -167,7 +167,11 @@ public synchronized void clear() {\n    */\n   public synchronized Account createAndAddRandomAccount() {\n     Account account = generateRandomAccount();\n-    updateAccounts(Collections.singletonList(account));\n+    try {\n+      updateAccounts(Collections.singletonList(account));\n+    } catch (AccountServiceException ase) {\n+      throw new IllegalStateException(ase);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f0ec1df12d06475ea55b3805d72db36ba2bd66f"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e14f107e27851f8c4ee1fe778a5ed447c98d5584", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/e14f107e27851f8c4ee1fe778a5ed447c98d5584", "committedDate": "2020-10-20T00:43:32Z", "message": "Address review comments, make AccountService.updateAccounts() return void."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMjk3ODQ1", "url": "https://github.com/linkedin/ambry/pull/1657#pullrequestreview-512297845", "createdAt": "2020-10-20T03:05:30Z", "commit": {"oid": "e14f107e27851f8c4ee1fe778a5ed447c98d5584"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMzowNTozMFrOHko5cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMzowNTozMFrOHko5cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE4MDg0OQ==", "bodyText": "nit:  This can be BadRequest AccountServiceErrorCode. (We can do this in future PR)", "url": "https://github.com/linkedin/ambry/pull/1657#discussion_r508180849", "createdAt": "2020-10-20T03:05:30Z", "author": {"login": "jsjtzyy"}, "path": "ambry-account/src/main/java/com/github/ambry/account/MySqlAccountService.java", "diffHunk": "@@ -199,20 +199,17 @@ public Account getAccountByName(String accountName) {\n   }\n \n   @Override\n-  public boolean updateAccounts(Collection<Account> accounts) throws AccountServiceException {\n+  public void updateAccounts(Collection<Account> accounts) throws AccountServiceException {\n     Objects.requireNonNull(accounts, \"accounts cannot be null\");\n     if (accounts.isEmpty()) {\n-      logger.debug(\"Empty account collection to update.\");\n-      return false;\n+      throw new IllegalArgumentException(\"Empty account collection to update.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14f107e27851f8c4ee1fe778a5ed447c98d5584"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 941, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}