{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNTUyMTg1", "number": 1374, "title": "Upgrade Helix lib to 0.9.1 and add metrics for state transition", "bodyText": "upgrade Helix lib which should fix missing zk callback issues;\nintroduce participant metrics to track partitions in each state;", "createdAt": "2020-02-05T19:43:56Z", "url": "https://github.com/linkedin/ambry/pull/1374", "merged": true, "mergeCommit": {"oid": "bcab57e72fca02c567cf5927cffdcfd9fbf3a782"}, "closed": true, "closedAt": "2020-02-14T00:00:12Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCJSEqgH2gAyMzcxNTUyMTg1OjlkNDhiY2E3OGMzNGNmMDBiYWY3MTQ0MjM0OGFkZjhkYjEyNDZlNGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEAIoAAFqTM1ODQ5MjU5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d48bca78c34cf00baf71442348adf8db1246e4a", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/9d48bca78c34cf00baf71442348adf8db1246e4a", "committedDate": "2020-02-08T01:02:49Z", "message": "Upgrade Helix lib to 0.9.1 and add metrics for state transition\n\n1. upgrade Helix lib which should fix missing zk callback issues;\n2. introduce participant metrics to track partitions in each state;"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb6d367d0eef32999b40131c0dbc0d01c8c1a258", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/cb6d367d0eef32999b40131c0dbc0d01c8c1a258", "committedDate": "2020-02-08T01:02:49Z", "message": "minor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76b54df09709cc19fd747505202c70626a97bfb5", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/76b54df09709cc19fd747505202c70626a97bfb5", "committedDate": "2020-02-05T20:09:54Z", "message": "minor"}, "afterCommit": {"oid": "cb6d367d0eef32999b40131c0dbc0d01c8c1a258", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/cb6d367d0eef32999b40131c0dbc0d01c8c1a258", "committedDate": "2020-02-08T01:02:49Z", "message": "minor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MTIwMTE2", "url": "https://github.com/linkedin/ambry/pull/1374#pullrequestreview-357120116", "createdAt": "2020-02-12T00:40:08Z", "commit": {"oid": "cb6d367d0eef32999b40131c0dbc0d01c8c1a258"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwMDo0MDowOFrOFoeP-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwNzozODoxOVrOFokPDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4Mjk3MQ==", "bodyText": "javadoc", "url": "https://github.com/linkedin/ambry/pull/1374#discussion_r377982971", "createdAt": "2020-02-12T00:40:08Z", "author": {"login": "lightningrob"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/HelixParticipantMetrics.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.clustermap;\n+\n+import com.codahale.metrics.Counter;\n+import com.codahale.metrics.Gauge;\n+import com.codahale.metrics.MetricRegistry;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+class HelixParticipantMetrics {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb6d367d0eef32999b40131c0dbc0d01c8c1a258"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4Mzc4Mg==", "bodyText": "Should this throw IllegalStateException?  Seems like bug case.", "url": "https://github.com/linkedin/ambry/pull/1374#discussion_r377983782", "createdAt": "2020-02-12T00:43:07Z", "author": {"login": "lightningrob"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/HelixParticipantMetrics.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.clustermap;\n+\n+import com.codahale.metrics.Counter;\n+import com.codahale.metrics.Gauge;\n+import com.codahale.metrics.MetricRegistry;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+class HelixParticipantMetrics {\n+  final AtomicInteger bootstrapCount = new AtomicInteger();\n+  final AtomicInteger standbyCount = new AtomicInteger();\n+  final AtomicInteger leaderCount = new AtomicInteger();\n+  final AtomicInteger inactiveCount = new AtomicInteger();\n+  final AtomicInteger offlineCount = new AtomicInteger();\n+  // no need to record exact number of \"dropped\" partition, a counter to track partition-dropped events would suffice\n+  final Counter partitionDroppedCount;\n+  private static final Logger logger = LoggerFactory.getLogger(HelixParticipantMetrics.class);\n+\n+  HelixParticipantMetrics(MetricRegistry metricRegistry) {\n+    Gauge<Integer> bootstrapPartitionCount = bootstrapCount::get;\n+    metricRegistry.register(MetricRegistry.name(HelixParticipant.class, \"bootstrapPartitionCount\"),\n+        bootstrapPartitionCount);\n+    Gauge<Integer> standbyPartitionCount = standbyCount::get;\n+    metricRegistry.register(MetricRegistry.name(HelixParticipant.class, \"standbyPartitionCount\"),\n+        standbyPartitionCount);\n+    Gauge<Integer> leaderPartitionCount = leaderCount::get;\n+    metricRegistry.register(MetricRegistry.name(HelixParticipant.class, \"leaderPartitionCount\"), leaderPartitionCount);\n+    Gauge<Integer> inactivePartitionCount = inactiveCount::get;\n+    metricRegistry.register(MetricRegistry.name(HelixParticipant.class, \"inactivePartitionCount\"),\n+        inactivePartitionCount);\n+    Gauge<Integer> offlinePartitionCount = offlineCount::get;\n+    metricRegistry.register(MetricRegistry.name(HelixParticipant.class, \"offlinePartitionCount\"),\n+        offlinePartitionCount);\n+    partitionDroppedCount =\n+        metricRegistry.counter(MetricRegistry.name(HelixParticipant.class, \"partitionDroppedCount\"));\n+  }\n+\n+  /**\n+   * Set number of partitions on current node. This is invoked during startup.\n+   * @param partitionCount number of partitions on current node\n+   */\n+  void setLocalPartitionCount(int partitionCount) {\n+    // this method should be invoked before participation, so the initial value is expected to be 0.\n+    if (!offlineCount.compareAndSet(0, partitionCount)) {\n+      logger.warn(\"Number of OFFLINE partitions has changed before initializing participant metrics\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb6d367d0eef32999b40131c0dbc0d01c8c1a258"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4NDYxMg==", "bodyText": "Can make this a default no op method so need not be overridden.", "url": "https://github.com/linkedin/ambry/pull/1374#discussion_r377984612", "createdAt": "2020-02-12T00:45:43Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com.github.ambry/clustermap/ClusterParticipant.java", "diffHunk": "@@ -84,6 +84,12 @@ void registerPartitionStateChangeListener(StateModelListenerType listenerType,\n    */\n   boolean updateDataNodeInfoInCluster(ReplicaId replicaId, boolean shouldExist);\n \n+  /**\n+   * Initialize participant related metrics if needed.\n+   * @param localPartitionCount total number of partitions on local node.\n+   */\n+  void initializeParticipantMetrics(int localPartitionCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb6d367d0eef32999b40131c0dbc0d01c8c1a258"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4NzA5Ng==", "bodyText": "Could the partition count be passed to constructor instead, and avoid the extra call?", "url": "https://github.com/linkedin/ambry/pull/1374#discussion_r377987096", "createdAt": "2020-02-12T00:54:58Z", "author": {"login": "lightningrob"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/HelixParticipant.java", "diffHunk": "@@ -88,6 +93,11 @@ public HelixParticipant(ClusterMapConfig clusterMapConfig, HelixFactory helixFac\n     partitionStateChangeListeners = new HashMap<>();\n   }\n \n+  @Override\n+  public void initializeParticipantMetrics(int localPartitionCount) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb6d367d0eef32999b40131c0dbc0d01c8c1a258"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA4MTAzNg==", "bodyText": "you can just say ZkInfo since you are already importing TestUtils.*", "url": "https://github.com/linkedin/ambry/pull/1374#discussion_r378081036", "createdAt": "2020-02-12T07:38:19Z", "author": {"login": "lightningrob"}, "path": "ambry-clustermap/src/test/java/com.github.ambry.clustermap/AmbryStateModelFactoryTest.java", "diffHunk": "@@ -13,39 +13,54 @@\n  */\n package com.github.ambry.clustermap;\n \n+import com.codahale.metrics.MetricRegistry;\n import com.github.ambry.config.ClusterMapConfig;\n import com.github.ambry.config.VerifiableProperties;\n+import com.github.ambry.utils.TestUtils;\n+import java.util.ArrayList;\n import java.util.Arrays;\n import java.util.List;\n import java.util.Properties;\n+import org.apache.helix.model.Message;\n import org.apache.helix.participant.statemachine.StateModel;\n+import org.json.JSONObject;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.junit.runners.Parameterized;\n+import org.mockito.Mockito;\n \n+import static com.github.ambry.clustermap.TestUtils.*;\n import static org.junit.Assert.*;\n+import static org.junit.Assume.*;\n+import static org.mockito.Mockito.*;\n \n \n /**\n- * Test for {@link AmbryStateModelFactory}\n+ * Test for {@link AmbryStateModelFactory} and {@link AmbryPartitionStateModel}\n  */\n @RunWith(Parameterized.class)\n public class AmbryStateModelFactoryTest {\n   private final ClusterMapConfig config;\n+  private final String stateModelDef;\n \n   @Parameterized.Parameters\n   public static List<Object[]> data() {\n     return Arrays.asList(\n         new Object[][]{{ClusterMapConfig.OLD_STATE_MODEL_DEF}, {ClusterMapConfig.AMBRY_STATE_MODEL_DEF}});\n   }\n \n-  public AmbryStateModelFactoryTest(String stateModelDef) {\n+  public AmbryStateModelFactoryTest(String stateModelDef) throws Exception {\n+    List<com.github.ambry.utils.TestUtils.ZkInfo> zkInfoList = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb6d367d0eef32999b40131c0dbc0d01c8c1a258"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "461f57c4ddb5579335fd994d1dafec7c1440725f", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/461f57c4ddb5579335fd994d1dafec7c1440725f", "committedDate": "2020-02-12T19:32:53Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e21ec84b2e29bd4404621930a32475364fe0242", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/6e21ec84b2e29bd4404621930a32475364fe0242", "committedDate": "2020-02-12T22:07:58Z", "message": "fix test failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDkyNTkw", "url": "https://github.com/linkedin/ambry/pull/1374#pullrequestreview-358492590", "createdAt": "2020-02-13T19:31:12Z", "commit": {"oid": "6e21ec84b2e29bd4404621930a32475364fe0242"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1592, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}