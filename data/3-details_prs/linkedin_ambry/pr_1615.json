{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MjY2MTIz", "number": 1615, "title": "[LeaderBasedReplication] Notify response handler on connection check out failure in all places.", "bodyText": "Issue: While fetching missing keys for timed out standby replicas, we have following issues:\n\nResponse handler is not notified on connection checkout failure. Due to that remote node might not be marked as down.\nAll remote hosts are being iterated (including ones which are marked as down) instead of \u2018Active replicas\u2019.\n\nDue to this, we see frequent retries for connection checkout with remote hosts which are down.\nThis PR addresses above two issues.", "createdAt": "2020-09-03T00:39:44Z", "url": "https://github.com/linkedin/ambry/pull/1615", "merged": true, "mergeCommit": {"oid": "c5f2720ee293471cfcb6dbc92ba6d93e78985536"}, "closed": true, "closedAt": "2020-09-11T17:56:02Z", "author": {"login": "Arun-LinkedIn"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFFC_fgH2gAyNDc4MjY2MTIzOjYwNGM1ZDQzNTFhODhiZmFkODE0ZmI5MjdjZTJkMzMyMGNkOWM5MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH4l0lAH2gAyNDc4MjY2MTIzOmYxNTNhOTA3ZmJmNDczNGZjNzRkNmIwMDk2MWE1ZDU5YzdiN2IyZDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "604c5d4351a88bfad814fb927ce2d3320cd9c916", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/604c5d4351a88bfad814fb927ce2d3320cd9c916", "committedDate": "2020-09-02T23:59:39Z", "message": "Issue: In replication code, we are continuously attempting to replicate with remote hosts that are down instead of following retry backoff procedures. Due to that, socket connection checkout fails repeatedly.\nThis happens during fetching of missing keys for timed out standby replicas due to two reasons:\n1. Failing to notify response handler on connection checkout failure. Due to that node might not be marked as down.\n2. Iterating over all replicas (which includes replicas whose nodes are down) instead of \u2018Active replicas\u2019 while fetching the missing keys.\n\nThis PR addresses above two issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NTcyMTI4", "url": "https://github.com/linkedin/ambry/pull/1615#pullrequestreview-485572128", "createdAt": "2020-09-10T04:56:18Z", "commit": {"oid": "604c5d4351a88bfad814fb927ce2d3320cd9c916"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNDo1NjoxOFrOHPi8Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNDo1NjoxOFrOHPi8Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA2MzExMQ==", "bodyText": "minor: line 458 startTimeInMs is not updated before checking out the channel", "url": "https://github.com/linkedin/ambry/pull/1615#discussion_r486063111", "createdAt": "2020-09-10T04:56:18Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -452,11 +446,12 @@ public void replicate() {\n           // TODO: If the result to fetch a blob from local dc is Blob_Not_Found, then we can fetch it from replicas in remote datacenter.\n           // This will involve co-ordination between replica threads containing replicas of same partition.\n           List<RemoteReplicaInfo> standbyReplicasTimedOutOnNoProgress =\n-              getRemoteStandbyReplicasTimedOutOnNoProgress(replicasToReplicatePerNode);\n+              getRemoteStandbyReplicasTimedOutOnNoProgress(standbyReplicasWithNoProgress);\n           if (standbyReplicasTimedOutOnNoProgress.size() > 0) {\n             allCaughtUp = false;\n             currentReplicaList = standbyReplicasTimedOutOnNoProgress;\n             if (connectedChannel == null) {\n+              checkoutConnectionTimeInMs = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "604c5d4351a88bfad814fb927ce2d3320cd9c916"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NDAwMTIw", "url": "https://github.com/linkedin/ambry/pull/1615#pullrequestreview-486400120", "createdAt": "2020-09-11T00:40:21Z", "commit": {"oid": "604c5d4351a88bfad814fb927ce2d3320cd9c916"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f153a907fbf4734fc74d6b00961a5d59c7b7b2d8", "author": {"user": {"login": "Arun-LinkedIn", "name": "Arun Sai Bhima"}}, "url": "https://github.com/linkedin/ambry/commit/f153a907fbf4734fc74d6b00961a5d59c7b7b2d8", "committedDate": "2020-09-11T17:10:42Z", "message": "Update startTimeInMs before checking out connection channel"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1232, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}