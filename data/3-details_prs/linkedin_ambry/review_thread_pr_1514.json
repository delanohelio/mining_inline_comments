{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NDgzNjQ0", "number": 1514, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxODozNzozN1rOD9gofA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDowODowNVrOD99FCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODI0MzgwOnYy", "diffSide": "RIGHT", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxODozNzozN1rOGXDGbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMDoxNDoxMVrOGXLhMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyMTIzMA==", "bodyText": "Instead of the logic in AmbryRequests to look up the life version again, could the life version be carried inside of the StoreException? You could create an UndeleteStoreException that extends StoreException and then AmbryRequests can handle it with an instanceof check:\nif (e instanceof UndeleteStoreException) {\n  response = Response(e.getErrorCode(), ((UndeleteStoreException) e).getLifeVersion());\n}\n\nI feel like this would keep the boundary between store logic and request handling logic more clear.", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r426821230", "createdAt": "2020-05-18T18:37:37Z", "author": {"login": "cgtz"}, "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStore.java", "diffHunk": "@@ -727,22 +735,32 @@ public short undelete(MessageInfo info) throws StoreException {\n         Offset currentIndexEndOffset = index.getCurrentEndOffset();\n         if (!currentIndexEndOffset.equals(indexEndOffsetBeforeCheck)) {\n           FileSpan fileSpan = new FileSpan(indexEndOffsetBeforeCheck, currentIndexEndOffset);\n-          IndexValue value =\n-              index.findKey(info.getStoreKey(), fileSpan, EnumSet.allOf(PersistentIndex.IndexEntryType.class));\n+          IndexValue value = index.findKey(info.getStoreKey(), fileSpan,\n+              EnumSet.of(PersistentIndex.IndexEntryType.DELETE, PersistentIndex.IndexEntryType.UNDELETE));\n           if (value != null) {\n-            throw new StoreException(\"Cannot undelete id \" + info.getStoreKey() + \" since concurrent operation occurs\",\n-                StoreErrorCodes.Life_Version_Conflict);\n+            if (value.isUndelete() && value.getLifeVersion() == revisedLifeVersion) {\n+              // Might get an concurrent undelete from both replication and frontend. This is considered as an\n+              // successful operation and the exception will be captured by the catch statement below.\n+              throw new StoreException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f253c01658b8d57efe18c995bc27ba25fa6adb6"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1OTE1NQ==", "bodyText": "this is a good idea, updated.", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r426959155", "createdAt": "2020-05-19T00:14:11Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStore.java", "diffHunk": "@@ -727,22 +735,32 @@ public short undelete(MessageInfo info) throws StoreException {\n         Offset currentIndexEndOffset = index.getCurrentEndOffset();\n         if (!currentIndexEndOffset.equals(indexEndOffsetBeforeCheck)) {\n           FileSpan fileSpan = new FileSpan(indexEndOffsetBeforeCheck, currentIndexEndOffset);\n-          IndexValue value =\n-              index.findKey(info.getStoreKey(), fileSpan, EnumSet.allOf(PersistentIndex.IndexEntryType.class));\n+          IndexValue value = index.findKey(info.getStoreKey(), fileSpan,\n+              EnumSet.of(PersistentIndex.IndexEntryType.DELETE, PersistentIndex.IndexEntryType.UNDELETE));\n           if (value != null) {\n-            throw new StoreException(\"Cannot undelete id \" + info.getStoreKey() + \" since concurrent operation occurs\",\n-                StoreErrorCodes.Life_Version_Conflict);\n+            if (value.isUndelete() && value.getLifeVersion() == revisedLifeVersion) {\n+              // Might get an concurrent undelete from both replication and frontend. This is considered as an\n+              // successful operation and the exception will be captured by the catch statement below.\n+              throw new StoreException(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyMTIzMA=="}, "originalCommit": {"oid": "9f253c01658b8d57efe18c995bc27ba25fa6adb6"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODI1NDk4OnYy", "diffSide": "RIGHT", "path": "ambry-router/src/main/java/com/github/ambry/router/UndeleteOperation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxODo0MToyMlrOGXDNoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwMDoxNTo0N1rOGXLiuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyMzA3Mw==", "bodyText": "How is the life version field in the error UndeleteResponse used?", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r426823073", "createdAt": "2020-05-18T18:41:22Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com/github/ambry/router/UndeleteOperation.java", "diffHunk": "@@ -195,6 +194,7 @@ void handleResponse(ResponseInfo responseInfo, UndeleteResponse undeleteResponse\n               // This is first successful response.\n               lifeVersion = undeleteResponse.getLifeVersion();\n               firstResponseReplicaId = replica;\n+              operationTracker.onResponse(replica, TrackedRequestFinalState.SUCCESS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f253c01658b8d57efe18c995bc27ba25fa6adb6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1OTU0NQ==", "bodyText": "when the error is Blob_Already_Undelete, we treat it as a successful operation, just like in DeleteOperation, when the error is Blob_Already_Deleted, it's considered as a successful operation. The lifeVersion will be used to compare with other ambry servers' lifeVersions.", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r426959545", "createdAt": "2020-05-19T00:15:47Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-router/src/main/java/com/github/ambry/router/UndeleteOperation.java", "diffHunk": "@@ -195,6 +194,7 @@ void handleResponse(ResponseInfo responseInfo, UndeleteResponse undeleteResponse\n               // This is first successful response.\n               lifeVersion = undeleteResponse.getLifeVersion();\n               firstResponseReplicaId = replica;\n+              operationTracker.onResponse(replica, TrackedRequestFinalState.SUCCESS);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyMzA3Mw=="}, "originalCommit": {"oid": "9f253c01658b8d57efe18c995bc27ba25fa6adb6"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2Mjg5Njg2OnYy", "diffSide": "RIGHT", "path": "ambry-api/src/main/java/com/github/ambry/store/IdUndeletedStoreException.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDowNTo0NVrOGXwqWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDowNTo0NVrOGXwqWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU2NzcwNw==", "bodyText": "nit: end file with newline", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r427567707", "createdAt": "2020-05-19T20:05:45Z", "author": {"login": "cgtz"}, "path": "ambry-api/src/main/java/com/github/ambry/store/IdUndeletedStoreException.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.store;\n+\n+/**\n+ * This is a dedicated exception for {@link StoreErrorCodes#ID_Undeleted}. When {@link Store} throws an Exception\n+ * for {@link StoreErrorCodes#ID_Undeleted}, it's better that it throws an {@link IdUndeletedStoreException}.\n+ */\n+public class IdUndeletedStoreException extends StoreException {\n+  private final short lifeVersion;\n+\n+  /**\n+   * Constructor to create a {@link IdUndeletedStoreException}.\n+   * @param message The error message.\n+   * @param lifeVersion The lifeVersion.\n+   */\n+  public IdUndeletedStoreException(String message, short lifeVersion) {\n+    super(message, StoreErrorCodes.ID_Undeleted);\n+    this.lifeVersion = lifeVersion;\n+  }\n+\n+  /**\n+   * @return The lifeVersion for the current undelete record.\n+   */\n+  public short getLifeVersion() {\n+    return lifeVersion;\n+  }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f159f152adbea2bedb20d063385a6c527afc995b"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MjkwNDQyOnYy", "diffSide": "RIGHT", "path": "ambry-protocol/src/main/java/com/github/ambry/protocol/UndeleteResponse.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDowODowNVrOGXwvMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDoxNDowNFrOGXw7SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU2ODk0Ng==", "bodyText": "since there is no live site traffic performing undeletes yet, this schema change should be ok, right?", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r427568946", "createdAt": "2020-05-19T20:08:05Z", "author": {"login": "cgtz"}, "path": "ambry-protocol/src/main/java/com/github/ambry/protocol/UndeleteResponse.java", "diffHunk": "@@ -62,6 +62,18 @@ public UndeleteResponse(int correlationId, String clientId, short lifeVersion) {\n     this.lifeVersion = lifeVersion;\n   }\n \n+  /**\n+   * Constructs a {@link UndeleteResponse} with a valid lifeVersion. The error code will be set to {@link ServerErrorCode#No_Error}.\n+   * @param correlationId correlationId of the undelete response.\n+   * @param clientId clientId of the undelete response.\n+   * @param lifeVersion a valid lifeVersion to return to client.\n+   * @param error error code returned in this undelete response.\n+   */\n+  public UndeleteResponse(int correlationId, String clientId, short lifeVersion, ServerErrorCode error) {\n+    super(RequestOrResponseType.UndeleteResponse, UNDELETE_RESPONSE_VERSION_1, correlationId, clientId, error);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f159f152adbea2bedb20d063385a6c527afc995b"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3MjA0MA==", "bodyText": "that's right.", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r427572040", "createdAt": "2020-05-19T20:14:04Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-protocol/src/main/java/com/github/ambry/protocol/UndeleteResponse.java", "diffHunk": "@@ -62,6 +62,18 @@ public UndeleteResponse(int correlationId, String clientId, short lifeVersion) {\n     this.lifeVersion = lifeVersion;\n   }\n \n+  /**\n+   * Constructs a {@link UndeleteResponse} with a valid lifeVersion. The error code will be set to {@link ServerErrorCode#No_Error}.\n+   * @param correlationId correlationId of the undelete response.\n+   * @param clientId clientId of the undelete response.\n+   * @param lifeVersion a valid lifeVersion to return to client.\n+   * @param error error code returned in this undelete response.\n+   */\n+  public UndeleteResponse(int correlationId, String clientId, short lifeVersion, ServerErrorCode error) {\n+    super(RequestOrResponseType.UndeleteResponse, UNDELETE_RESPONSE_VERSION_1, correlationId, clientId, error);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU2ODk0Ng=="}, "originalCommit": {"oid": "f159f152adbea2bedb20d063385a6c527afc995b"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1579, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}