{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0Nzk3MTE5", "number": 1720, "title": "Change compaction retention time granularity to hour", "bodyText": "Compaction needs to run with less retention time in some use cases. Change compaction retention time granularity to hour from day.", "createdAt": "2020-12-08T23:40:48Z", "url": "https://github.com/linkedin/ambry/pull/1720", "merged": true, "mergeCommit": {"oid": "3ca268beaed3dde3cff78a68845f741eede73ab5"}, "closed": true, "closedAt": "2020-12-15T00:42:09Z", "author": {"login": "zzmao"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkSpI0AH2gAyNTM0Nzk3MTE5OjRiOTRiY2Q5MTdlMTRhZTRiNDI5OTJhMzFlZmZiNWIzODE5NmMxZDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmLCXlAH2gAyNTM0Nzk3MTE5OjMxNDk1MDUwZmY0OTc5OTJkMTIwYTUxNDlhZmU1MDhiMWQ1Njg3MGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4b94bcd917e14ae4b42992a31effb5b38196c1d0", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/4b94bcd917e14ae4b42992a31effb5b38196c1d0", "committedDate": "2020-12-08T23:21:44Z", "message": "compataction retention time granularity to hour"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4ODI1MDMx", "url": "https://github.com/linkedin/ambry/pull/1720#pullrequestreview-548825031", "createdAt": "2020-12-10T05:17:22Z", "commit": {"oid": "4b94bcd917e14ae4b42992a31effb5b38196c1d0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNToxNzoyMlrOIC18qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNToxNzoyMlrOIC18qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1MTk0Ng==", "bodyText": "minor: Might want to change to \"Message retention hours\" for the exception message.", "url": "https://github.com/linkedin/ambry/pull/1720#discussion_r539851946", "createdAt": "2020-12-10T05:17:22Z", "author": {"login": "SophieGuo410"}, "path": "ambry-store/src/main/java/com/github/ambry/store/StorageManager.java", "diffHunk": "@@ -165,8 +165,8 @@ private void verifyConfigs(StoreConfig storeConfig, DiskManagerConfig diskManage\n     /* NOTE: We must ensure that the store never performs hard deletes on the part of the log that is not yet flushed.\n        We do this by making sure that the retention period for deleted messages (which determines the end point for hard\n        deletes) is always greater than the log flush period. */\n-    if (storeConfig.storeDeletedMessageRetentionDays\n-        < TimeUnit.SECONDS.toDays(storeConfig.storeDataFlushIntervalSeconds) + 1) {\n+    if (storeConfig.storeDeletedMessageRetentionHours\n+        < TimeUnit.SECONDS.toHours(storeConfig.storeDataFlushIntervalSeconds) + 1) {\n       throw new StoreException(\"Message retention days must be greater than the store flush interval period\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b94bcd917e14ae4b42992a31effb5b38196c1d0"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4ODgzOTIz", "url": "https://github.com/linkedin/ambry/pull/1720#pullrequestreview-548883923", "createdAt": "2020-12-10T06:19:55Z", "commit": {"oid": "4b94bcd917e14ae4b42992a31effb5b38196c1d0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNjoxOTo1NVrOIC3zWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNjozMzowNVrOIC4dog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg4MjMyOA==", "bodyText": "TimeUnit.HOURS.toMillis", "url": "https://github.com/linkedin/ambry/pull/1720#discussion_r539882328", "createdAt": "2020-12-10T06:19:55Z", "author": {"login": "jsjtzyy"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/CloudBlobStore.java", "diffHunk": "@@ -648,7 +648,7 @@ private boolean preUndeleteValidation(CloudBlobMetadata metadata, StoreKey key,\n       throw new StoreException(\"Id \" + key + \" is already undeleted in cloud\", StoreErrorCodes.ID_Undeleted);\n     } else if (!metadata.isDeleted()) {\n       throw new StoreException(\"Id \" + key + \" is not deleted yet in cloud \", StoreErrorCodes.ID_Not_Deleted);\n-    } else if (metadata.getDeletionTime() + TimeUnit.DAYS.toMillis(storeConfig.storeDeletedMessageRetentionDays)\n+    } else if (metadata.getDeletionTime() + TimeUnit.DAYS.toMillis(storeConfig.storeDeletedMessageRetentionHours)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b94bcd917e14ae4b42992a31effb5b38196c1d0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg5MzE1NA==", "bodyText": "@justinlin-linkedin if logSegmentForecastOffsetMs becomes a few hours and bucketSpanInMs, bucketCount stay unchanged, will it be a problem? logSegmentForecastEndTimeMsForDeleted  > scan timestamp", "url": "https://github.com/linkedin/ambry/pull/1720#discussion_r539893154", "createdAt": "2020-12-10T06:33:05Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStore.java", "diffHunk": "@@ -247,7 +247,7 @@ public void start() throws StoreException {\n             diskIOScheduler, metrics, time, sessionId, storeDescriptor.getIncarnationId());\n         compactor.initialize(index);\n         metrics.initializeIndexGauges(storeId, index, capacityInBytes);\n-        long logSegmentForecastOffsetMs = TimeUnit.DAYS.toMillis(config.storeDeletedMessageRetentionDays);\n+        long logSegmentForecastOffsetMs = TimeUnit.HOURS.toMillis(config.storeDeletedMessageRetentionHours);\n         long bucketSpanInMs = TimeUnit.MINUTES.toMillis(config.storeStatsBucketSpanInMinutes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b94bcd917e14ae4b42992a31effb5b38196c1d0"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edd25b507cd4fbae91e50709cbf69226b6018e47", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/edd25b507cd4fbae91e50709cbf69226b6018e47", "committedDate": "2020-12-11T21:55:40Z", "message": "address comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODIyODUw", "url": "https://github.com/linkedin/ambry/pull/1720#pullrequestreview-551822850", "createdAt": "2020-12-14T19:28:00Z", "commit": {"oid": "edd25b507cd4fbae91e50709cbf69226b6018e47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODI0NDU5", "url": "https://github.com/linkedin/ambry/pull/1720#pullrequestreview-551824459", "createdAt": "2020-12-14T19:29:50Z", "commit": {"oid": "edd25b507cd4fbae91e50709cbf69226b6018e47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOToyOTo1MVrOIFizNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOToyOTo1MVrOIFizNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4Mzk1Ng==", "bodyText": "One minor suggestion:  maybe we can use 7 * 24 as default value which lines up with we are using for main cluster, and change this for delivery cluster only.", "url": "https://github.com/linkedin/ambry/pull/1720#discussion_r542683956", "createdAt": "2020-12-14T19:29:51Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/config/StoreConfig.java", "diffHunk": "@@ -75,11 +75,11 @@\n   public final double storeIndexBloomMaxFalsePositiveProbability;\n \n   /**\n-   * How long (in days) a key must be in deleted state before it is hard deleted.\n+   * How long (in hours) a key must be in deleted state before it is hard deleted. Minimum value: 1 hour.\n    */\n-  @Config(\"store.deleted.message.retention.days\")\n-  @Default(\"7\")\n-  public final int storeDeletedMessageRetentionDays;\n+  @Config(\"store.deleted.message.retention.hours\")\n+  @Default(\"24\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edd25b507cd4fbae91e50709cbf69226b6018e47"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31495050ff497992d120a5149afe508b1d56870f", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/31495050ff497992d120a5149afe508b1d56870f", "committedDate": "2020-12-14T19:37:54Z", "message": "change to 7*24h"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1042, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}