{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5ODM1Njgz", "number": 1707, "title": "[named_blobs] Integrate NamedBlobDb and support deletes", "bodyText": "Use NamedBlobDb in AmbryIdConverter\nAdd support for getting the blob ID deleted after a delete call\nCall delete from inside of AmbryIdConverter.", "createdAt": "2020-11-30T21:58:39Z", "url": "https://github.com/linkedin/ambry/pull/1707", "merged": true, "mergeCommit": {"oid": "b7bc559638b28762968203211531e421cf4cdf45"}, "closed": true, "closedAt": "2020-12-10T02:07:22Z", "author": {"login": "cgtz"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh8X54gBqjQwNTgwNDgwNDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkpm4SgFqTU0ODc2NDI1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "614617d052e3aa1e5f71c57baa24ada683a2087f", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/614617d052e3aa1e5f71c57baa24ada683a2087f", "committedDate": "2020-11-30T21:57:50Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes"}, "afterCommit": {"oid": "74be4ac5ce1db08fda35e630d822b47507a4e72a", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/74be4ac5ce1db08fda35e630d822b47507a4e72a", "committedDate": "2020-12-01T16:15:46Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74be4ac5ce1db08fda35e630d822b47507a4e72a", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/74be4ac5ce1db08fda35e630d822b47507a4e72a", "committedDate": "2020-12-01T16:15:46Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}, "afterCommit": {"oid": "9312cd263b3a04b8494ba18d75510f2abff52911", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/9312cd263b3a04b8494ba18d75510f2abff52911", "committedDate": "2020-12-01T16:55:38Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNDA5NzMz", "url": "https://github.com/linkedin/ambry/pull/1707#pullrequestreview-542409733", "createdAt": "2020-12-02T00:35:22Z", "commit": {"oid": "9312cd263b3a04b8494ba18d75510f2abff52911"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMDozNToyMlrOH9Fhrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwMToyMjoxOFrOH9Glpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgxNTcyNw==", "bodyText": "The blobInfo is null? I guess you want to parse in it from NamedBlobPutHandler right?", "url": "https://github.com/linkedin/ambry/pull/1707#discussion_r533815727", "createdAt": "2020-12-02T00:35:22Z", "author": {"login": "SophieGuo410"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/AmbryIdConverterFactory.java", "diffHunk": "@@ -65,6 +73,11 @@ public void close() {\n       isOpen = false;\n     }\n \n+    @Override\n+    public Future<String> convert(RestRequest restRequest, String input, Callback<String> callback) {\n+      return convert(restRequest, input, null, callback);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9312cd263b3a04b8494ba18d75510f2abff52911"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgxNjY2NA==", "bodyText": "a quick question. Do we really need to update the idConverterProcessingTimeInMs twice since eventually the finally logic will do it.", "url": "https://github.com/linkedin/ambry/pull/1707#discussion_r533816664", "createdAt": "2020-12-02T00:38:09Z", "author": {"login": "SophieGuo410"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/AmbryIdConverterFactory.java", "diffHunk": "@@ -73,29 +86,30 @@ public void close() {\n      * {@link com.github.ambry.router.Router} will understand.\n      * @param restRequest {@link RestRequest} representing the request.\n      * @param input the ID that needs to be converted.\n+     * @param blobInfo the {@link BlobInfo} for an uploaded blob. This will be used for named blob PUT requests.\n      * @param callback the {@link Callback} to invoke once the converted ID is available. Can be null.\n      * @return a {@link Future} that will eventually contain the converted ID.\n      */\n     @Override\n-    public Future<String> convert(RestRequest restRequest, String input, Callback<String> callback) {\n+    public Future<String> convert(RestRequest restRequest, String input, BlobInfo blobInfo, Callback<String> callback) {\n       final CompletableFuture<String> future = new CompletableFuture<>();\n       String convertedId = null;\n       Exception exception = null;\n       frontendMetrics.idConverterRequestRate.mark();\n       long startTimeInMs = System.currentTimeMillis();\n       try {\n         if (!isOpen) {\n-        frontendMetrics.idConverterProcessingTimeInMs.update(System.currentTimeMillis() - startTimeInMs);\n-        exception = new RestServiceException(\"IdConverter is closed\", RestServiceErrorCode.ServiceUnavailable);\n+          frontendMetrics.idConverterProcessingTimeInMs.update(System.currentTimeMillis() - startTimeInMs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9312cd263b3a04b8494ba18d75510f2abff52911"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyMTU4Mw==", "bodyText": "Thanks for providing the better way to identify the requestPath.", "url": "https://github.com/linkedin/ambry/pull/1707#discussion_r533821583", "createdAt": "2020-12-02T00:52:17Z", "author": {"login": "SophieGuo410"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/AmbrySecurityService.java", "diffHunk": "@@ -221,7 +219,7 @@ public void processResponse(RestRequest restRequest, RestResponseChannel respons\n             break;\n           case OPTIONS:\n           case PUT:\n-            if (requestPath.getOperationOrBlobId(false).startsWith(NAMED_BLOB_PREFIX)) {\n+            if (requestPath.matchesOperation(Operations.NAMED_BLOB)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9312cd263b3a04b8494ba18d75510f2abff52911"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyNTcyOA==", "bodyText": "minor: Although it's the original code, but I guess maybe we can remove the RestUtils for getRequestPath as well for consistency right?", "url": "https://github.com/linkedin/ambry/pull/1707#discussion_r533825728", "createdAt": "2020-12-02T01:03:39Z", "author": {"login": "SophieGuo410"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/AccountAndContainerInjector.java", "diffHunk": "@@ -240,7 +239,7 @@ private void injectAccountAndContainerUsingAccountAndContainerHeaders(RestReques\n    */\n   private void injectAccountAndContainerUsingAccountAndContainerUri(RestRequest restRequest,\n       RestRequestMetricsGroup metricsGroup) throws RestServiceException {\n-    NamedBlobPath namedBlobPath = RestUtils.parseInput(RestUtils.getRequestPath(restRequest).getOperationOrBlobId(false));\n+    NamedBlobPath namedBlobPath = parseNamedBlobPath(RestUtils.getRequestPath(restRequest).getOperationOrBlobId(false));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9312cd263b3a04b8494ba18d75510f2abff52911"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgzMzEyNg==", "bodyText": "Can you give me a brief introduction about what's the connection.commit() and connection.rollback() are doing? a little bit confuse about it. Thank you!", "url": "https://github.com/linkedin/ambry/pull/1707#discussion_r533833126", "createdAt": "2020-12-02T01:22:18Z", "author": {"login": "SophieGuo410"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -274,7 +289,22 @@\n     executorService.submit(() -> {\n       // TODO introduce failover handling (retry on remote datacenters, handle SQL exceptions)\n       try (Connection connection = dcToDataSource.get(localDatacenter).getConnection()) {\n-        future.complete(transaction.run(account.getId(), container.getId(), connection));\n+        T result;\n+        if (autoCommit) {\n+          result = transaction.run(account.getId(), container.getId(), connection);\n+        } else {\n+          connection.setAutoCommit(false);\n+          try {\n+            result = transaction.run(account.getId(), container.getId(), connection);\n+            connection.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9312cd263b3a04b8494ba18d75510f2abff52911"}, "originalPosition": 129}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9312cd263b3a04b8494ba18d75510f2abff52911", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/9312cd263b3a04b8494ba18d75510f2abff52911", "committedDate": "2020-12-01T16:55:38Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}, "afterCommit": {"oid": "c283a4c7b51678ab405473ff71d3608f0b8a485a", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/c283a4c7b51678ab405473ff71d3608f0b8a485a", "committedDate": "2020-12-03T23:32:51Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzYzMzA0", "url": "https://github.com/linkedin/ambry/pull/1707#pullrequestreview-545363304", "createdAt": "2020-12-04T23:31:55Z", "commit": {"oid": "c283a4c7b51678ab405473ff71d3608f0b8a485a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMzozMTo1NVrOH_l9tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMzozMTo1NVrOH_l9tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ0NDM0MA==", "bodyText": "Incomplete java doc", "url": "https://github.com/linkedin/ambry/pull/1707#discussion_r536444340", "createdAt": "2020-12-04T23:31:55Z", "author": {"login": "zzmao"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/NamedBlobPutHandler.java", "diffHunk": "@@ -245,26 +245,29 @@ private PutBlobOptions getPutBlobOptionsFromRequest() throws RestServiceExceptio\n     }\n \n     /**\n-     * After reading the body of the stitch request\n-     * @param channel\n-     * @param blobInfo\n-     * @return\n+     * After reading the body of the stitch request, parse the request body,\n+     * and make a call to {@link Router#stitchBlob}.\n+     * @param channel the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c283a4c7b51678ab405473ff71d3608f0b8a485a"}, "originalPosition": 61}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c283a4c7b51678ab405473ff71d3608f0b8a485a", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/c283a4c7b51678ab405473ff71d3608f0b8a485a", "committedDate": "2020-12-03T23:32:51Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}, "afterCommit": {"oid": "fcee11d5516be46f115329455d97871332cd6b4a", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/fcee11d5516be46f115329455d97871332cd6b4a", "committedDate": "2020-12-07T21:19:43Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcee11d5516be46f115329455d97871332cd6b4a", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/fcee11d5516be46f115329455d97871332cd6b4a", "committedDate": "2020-12-07T21:19:43Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}, "afterCommit": {"oid": "38c4ffd1a1b9e56b99b70650d13746bec1318039", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/38c4ffd1a1b9e56b99b70650d13746bec1318039", "committedDate": "2020-12-07T21:50:31Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30ad3cfeb426df78aa297c3b9b995ab12557b250", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/30ad3cfeb426df78aa297c3b9b995ab12557b250", "committedDate": "2020-12-07T21:59:18Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38c4ffd1a1b9e56b99b70650d13746bec1318039", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/38c4ffd1a1b9e56b99b70650d13746bec1318039", "committedDate": "2020-12-07T21:50:31Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}, "afterCommit": {"oid": "30ad3cfeb426df78aa297c3b9b995ab12557b250", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/30ad3cfeb426df78aa297c3b9b995ab12557b250", "committedDate": "2020-12-07T21:59:18Z", "message": "[named_blobs] Integrate NamedBlobDb and support deletes\n\n- Use NamedBlobDb in AmbryIdConverter\n- Add support for getting the blob ID deleted after a delete call\n- Call delete from inside of AmbryIdConverter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTU0Njg2", "url": "https://github.com/linkedin/ambry/pull/1707#pullrequestreview-548554686", "createdAt": "2020-12-09T19:53:34Z", "commit": {"oid": "30ad3cfeb426df78aa297c3b9b995ab12557b250"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NzY0MjU4", "url": "https://github.com/linkedin/ambry/pull/1707#pullrequestreview-548764258", "createdAt": "2020-12-10T02:07:05Z", "commit": {"oid": "30ad3cfeb426df78aa297c3b9b995ab12557b250"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1023, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}