{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NDA5Mjkz", "number": 1547, "title": "Skip blobs from deprecated containers in replication", "bodyText": "This PR blocks replication for deprecated containers.", "createdAt": "2020-06-02T07:43:49Z", "url": "https://github.com/linkedin/ambry/pull/1547", "merged": true, "mergeCommit": {"oid": "942624050f928c0b8188a57e9180cb5c91ec8625"}, "closed": true, "closedAt": "2020-06-09T01:22:25Z", "author": {"login": "SophieGuo410"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnRSBcABqjMzOTY2OTYwNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpafSagFqTQyNjcyMTk5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "333ff745e68548dac0d5092d8079936e155bf87e", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/333ff745e68548dac0d5092d8079936e155bf87e", "committedDate": "2020-06-02T07:33:26Z", "message": "Block deprecated container during replication"}, "afterCommit": {"oid": "a41b3c9eaa930bccb9bf8d4bbe6fc41132659d2a", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/a41b3c9eaa930bccb9bf8d4bbe6fc41132659d2a", "committedDate": "2020-06-02T09:16:28Z", "message": "Block deprecated container during replication"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a41b3c9eaa930bccb9bf8d4bbe6fc41132659d2a", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/a41b3c9eaa930bccb9bf8d4bbe6fc41132659d2a", "committedDate": "2020-06-02T09:16:28Z", "message": "Block deprecated container during replication"}, "afterCommit": {"oid": "40254fd62b7321aafc82a9f3d73bfad6b8d7ca6d", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/40254fd62b7321aafc82a9f3d73bfad6b8d7ca6d", "committedDate": "2020-06-02T16:12:57Z", "message": "Block deprecated container during replication"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTg3Mzk2", "url": "https://github.com/linkedin/ambry/pull/1547#pullrequestreview-422987396", "createdAt": "2020-06-02T19:20:06Z", "commit": {"oid": "40254fd62b7321aafc82a9f3d73bfad6b8d7ca6d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOToyMDowNlrOGeAqlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxOToyMDowNlrOGeAqlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDEyMTM2NQ==", "bodyText": "is isGivenStatus  needed?\nContainer.ContainerStatus status = accountService.getAccountById(messageInfo.getAccountId())\n        .getContainerById(messageInfo.getContainerId())\n        .getStatus()\nreturn (status == DELETE_IN_PROGRESS || status == INACTIVE)", "url": "https://github.com/linkedin/ambry/pull/1547#discussion_r434121365", "createdAt": "2020-06-02T19:20:06Z", "author": {"login": "zzmao"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -639,14 +644,41 @@ private ReplicaMetadataResponse getReplicaMetadataResponse(List<RemoteReplicaInf\n   }\n \n   /**\n-   * Gets the missing store messages by comparing the messages from the remote node\n+   * Determines if {@link MessageInfo} container in the given status.\n+   * @param messageInfo A message info class that contains basic info about a blob.\n+   * @param containerStatus Status of the container.\n+   * @return {@code true} if the blob belongs to the given status container, {@code false} otherwise.\n+   */\n+  private boolean isGivenStatus(MessageInfo messageInfo, Container.ContainerStatus containerStatus) {\n+    return accountService.getAccountById(messageInfo.getAccountId())\n+        .getContainerById(messageInfo.getContainerId())\n+        .getStatus() == containerStatus;\n+  }\n+\n+  /**\n+   * Determines if {@link MessageInfo} container in the status of DELETED_IN_PROGRESS or INACTIVE.\n+   * @param messageInfo A message info class that contains basic info about a blob\n+   * @return {@code true} if the blob associates with the deprecated container, {@code false} otherwise.\n+   * Deprecated containers status include DELETE_IN_PROGRESS and INACTIVE.\n+   */\n+  private boolean isDeprecatedContainer(MessageInfo messageInfo) {\n+    if (accountService != null) {\n+      return isGivenStatus(messageInfo, Container.ContainerStatus.DELETE_IN_PROGRESS) || isGivenStatus(messageInfo,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40254fd62b7321aafc82a9f3d73bfad6b8d7ca6d"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTAyMTA3", "url": "https://github.com/linkedin/ambry/pull/1547#pullrequestreview-423102107", "createdAt": "2020-06-02T22:33:24Z", "commit": {"oid": "ac2014257d5e8583cda2ce3187b1ecb3f702a809"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMjozMzoyNVrOGeGKtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMjozMzoyNVrOGeGKtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIxMTUwOA==", "bodyText": "While the logic is correct, it seems a bit heavy handed to pass AccountService to ReplicaThread and see all this logic here (which probably also is similar in other places).  I would suggest adding a generic interface that lets the replica thread know if the messageInfo should be included or skipped.  The interface would have one method like:\nboolean skipFromReplication(MessageInfo messageInfo);\nThen pass this interface to ReplicaThread instead of AccountService.  In the future, we may want to extend the logic of what messages to skip and have that be transparent to replication.", "url": "https://github.com/linkedin/ambry/pull/1547#discussion_r434211508", "createdAt": "2020-06-02T22:33:25Z", "author": {"login": "lightningrob"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -639,14 +644,31 @@ private ReplicaMetadataResponse getReplicaMetadataResponse(List<RemoteReplicaInf\n   }\n \n   /**\n-   * Gets the missing store messages by comparing the messages from the remote node\n+   * Determines if {@link MessageInfo} container in the status of DELETED_IN_PROGRESS or INACTIVE.\n+   * @param messageInfo A message info class that contains basic info about a blob\n+   * @return {@code true} if the blob associates with the deprecated container, {@code false} otherwise.\n+   * Deprecated containers status include DELETE_IN_PROGRESS and INACTIVE.\n+   */\n+  private boolean isDeprecatedContainer(MessageInfo messageInfo) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2014257d5e8583cda2ce3187b1ecb3f702a809"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTA4ODc1", "url": "https://github.com/linkedin/ambry/pull/1547#pullrequestreview-423108875", "createdAt": "2020-06-02T22:50:02Z", "commit": {"oid": "ac2014257d5e8583cda2ce3187b1ecb3f702a809"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMjo1MDowMlrOGeGgbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMjo1MDowMlrOGeGgbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIxNzA2OA==", "bodyText": "Should replication be subject to the same retention time after marked as DELETE_IN_PROGRESS that the compactor is?", "url": "https://github.com/linkedin/ambry/pull/1547#discussion_r434217068", "createdAt": "2020-06-02T22:50:02Z", "author": {"login": "cgtz"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -639,14 +644,31 @@ private ReplicaMetadataResponse getReplicaMetadataResponse(List<RemoteReplicaInf\n   }\n \n   /**\n-   * Gets the missing store messages by comparing the messages from the remote node\n+   * Determines if {@link MessageInfo} container in the status of DELETED_IN_PROGRESS or INACTIVE.\n+   * @param messageInfo A message info class that contains basic info about a blob\n+   * @return {@code true} if the blob associates with the deprecated container, {@code false} otherwise.\n+   * Deprecated containers status include DELETE_IN_PROGRESS and INACTIVE.\n+   */\n+  private boolean isDeprecatedContainer(MessageInfo messageInfo) {\n+    if (accountService != null) {\n+      Container.ContainerStatus status = accountService.getAccountById(messageInfo.getAccountId())\n+          .getContainerById(messageInfo.getContainerId())\n+          .getStatus();\n+      return status == Container.ContainerStatus.DELETE_IN_PROGRESS || status == Container.ContainerStatus.INACTIVE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2014257d5e8583cda2ce3187b1ecb3f702a809"}, "originalPosition": 72}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd6ed7275d166e8c612925476b61ed82d1746fc2", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/bd6ed7275d166e8c612925476b61ed82d1746fc2", "committedDate": "2020-06-03T06:25:26Z", "message": "introduce Predicate interface instead of accountService into ReplicaThread"}, "afterCommit": {"oid": "b4e2a8cb446bf73ebd8b71d9bf78447626ed5085", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/b4e2a8cb446bf73ebd8b71d9bf78447626ed5085", "committedDate": "2020-06-03T16:07:42Z", "message": "introduce Predicate interface instead of accountService into ReplicaThread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTI2NjQz", "url": "https://github.com/linkedin/ambry/pull/1547#pullrequestreview-425526643", "createdAt": "2020-06-05T18:19:55Z", "commit": {"oid": "b4e2a8cb446bf73ebd8b71d9bf78447626ed5085"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxODoxOTo1NVrOGf41Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxODoxOTo1NVrOGf41Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA5MDIwMw==", "bodyText": "Could we declare it as Predicate and rename it skipPredicate to make it clear we're using it to filter out?", "url": "https://github.com/linkedin/ambry/pull/1547#discussion_r436090203", "createdAt": "2020-06-05T18:19:55Z", "author": {"login": "lightningrob"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -113,7 +112,7 @@\n   private final Condition pauseCondition = lock.newCondition();\n   private final ReplicaSyncUpManager replicaSyncUpManager;\n   private final int maxReplicaCountPerRequest;\n-  private final AccountService accountService;\n+  private final Predicate predicate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e2a8cb446bf73ebd8b71d9bf78447626ed5085"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTI4MTA3", "url": "https://github.com/linkedin/ambry/pull/1547#pullrequestreview-425528107", "createdAt": "2020-06-05T18:22:21Z", "commit": {"oid": "66c961bb749f12b123009cbf355e9ec8856c223a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30b72f9031718d5e230df50efa5520b3f1ae592a", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/30b72f9031718d5e230df50efa5520b3f1ae592a", "committedDate": "2020-06-06T00:05:54Z", "message": "Block deprecated container during replication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dfa5488f0508a247b05e293ea95e8c263b853a6", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/8dfa5488f0508a247b05e293ea95e8c263b853a6", "committedDate": "2020-06-06T00:05:54Z", "message": "minor fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5d9d6b473526b19f55d7ba261830d768f79ab79", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/f5d9d6b473526b19f55d7ba261830d768f79ab79", "committedDate": "2020-06-06T00:05:55Z", "message": "introduce Predicate interface instead of accountService into ReplicaThread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d3c8600c1148d6d1c0b2e649fef5cfa83fe978c", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/6d3c8600c1148d6d1c0b2e649fef5cfa83fe978c", "committedDate": "2020-06-06T00:05:55Z", "message": "adding rentention time for container before skip replication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fa91ba7fbbe8fdf28d9e784ca88e3aa85a9b0fc", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/1fa91ba7fbbe8fdf28d9e784ca88e3aa85a9b0fc", "committedDate": "2020-06-06T00:05:55Z", "message": "minor naming fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66c961bb749f12b123009cbf355e9ec8856c223a", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/66c961bb749f12b123009cbf355e9ec8856c223a", "committedDate": "2020-06-03T21:36:12Z", "message": "adding rentention time for container before skip replication"}, "afterCommit": {"oid": "1fa91ba7fbbe8fdf28d9e784ca88e3aa85a9b0fc", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/1fa91ba7fbbe8fdf28d9e784ca88e3aa85a9b0fc", "committedDate": "2020-06-06T00:05:55Z", "message": "minor naming fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb14773c17e37c114efb7fea7e0e968a24b5f689", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/cb14773c17e37c114efb7fea7e0e968a24b5f689", "committedDate": "2020-06-08T17:29:40Z", "message": "Fix test failure and add enable config"}, "afterCommit": {"oid": "714d3888baa4d1294d9397d38a7bfb1e9aba3a2e", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/714d3888baa4d1294d9397d38a7bfb1e9aba3a2e", "committedDate": "2020-06-08T18:32:02Z", "message": "Fix test failure and add enable config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b6d44e29920848fb0f29f5b9349a961bceb209d", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/0b6d44e29920848fb0f29f5b9349a961bceb209d", "committedDate": "2020-06-08T20:29:37Z", "message": "Fix test failure and add enable config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "714d3888baa4d1294d9397d38a7bfb1e9aba3a2e", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/714d3888baa4d1294d9397d38a7bfb1e9aba3a2e", "committedDate": "2020-06-08T18:32:02Z", "message": "Fix test failure and add enable config"}, "afterCommit": {"oid": "0b6d44e29920848fb0f29f5b9349a961bceb209d", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/0b6d44e29920848fb0f29f5b9349a961bceb209d", "committedDate": "2020-06-08T20:29:37Z", "message": "Fix test failure and add enable config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjA4Nzgx", "url": "https://github.com/linkedin/ambry/pull/1547#pullrequestreview-426608781", "createdAt": "2020-06-08T20:47:59Z", "commit": {"oid": "0b6d44e29920848fb0f29f5b9349a961bceb209d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjMwNTc5", "url": "https://github.com/linkedin/ambry/pull/1547#pullrequestreview-426630579", "createdAt": "2020-06-08T21:21:05Z", "commit": {"oid": "0b6d44e29920848fb0f29f5b9349a961bceb209d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMToyMTowNVrOGgw4Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMToyMTowNVrOGgw4Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwODQ0Mw==", "bodyText": "The ReplicationSkipPredicate class has low code coverage because the test only runs the positive case where container is skipped.  Please add negative test cases.", "url": "https://github.com/linkedin/ambry/pull/1547#discussion_r437008443", "createdAt": "2020-06-08T21:21:05Z", "author": {"login": "lightningrob"}, "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "diffHunk": "@@ -1328,6 +1335,94 @@ public void replicaThreadTestConverter() throws Exception {\n         idsToBeIgnoredByPartition, storeKeyConverter, expectedIndex, expectedIndex, 5);\n   }\n \n+  /**\n+   * Tests if deprecated containers have been blocked during replication.\n+   */\n+  @Test\n+  public void blockDeprecatedContainerReplicationTest() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b6d44e29920848fb0f29f5b9349a961bceb209d"}, "originalPosition": 59}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "679cd0ef45e3a80b367420e417dddd2774e8cca6", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/679cd0ef45e3a80b367420e417dddd2774e8cca6", "committedDate": "2020-06-08T23:38:28Z", "message": "adding more test cases"}, "afterCommit": {"oid": "a94a8be587950a7b27d8307cb201f975fd16e561", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/a94a8be587950a7b27d8307cb201f975fd16e561", "committedDate": "2020-06-09T00:11:03Z", "message": "adding more test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d397e5f06d93feb375d35d6cac70164ba38c351", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/3d397e5f06d93feb375d35d6cac70164ba38c351", "committedDate": "2020-06-09T00:13:11Z", "message": "adding more test cases"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a94a8be587950a7b27d8307cb201f975fd16e561", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/a94a8be587950a7b27d8307cb201f975fd16e561", "committedDate": "2020-06-09T00:11:03Z", "message": "adding more test cases"}, "afterCommit": {"oid": "3d397e5f06d93feb375d35d6cac70164ba38c351", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/3d397e5f06d93feb375d35d6cac70164ba38c351", "committedDate": "2020-06-09T00:13:11Z", "message": "adding more test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NzIxOTk0", "url": "https://github.com/linkedin/ambry/pull/1547#pullrequestreview-426721994", "createdAt": "2020-06-09T01:08:41Z", "commit": {"oid": "3d397e5f06d93feb375d35d6cac70164ba38c351"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1097, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}