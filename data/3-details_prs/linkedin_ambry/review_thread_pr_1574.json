{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MzI2NzA3", "number": 1574, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTo1OTowOFrOEICKGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNDozMTozMFrOEINrtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2ODU5NDE3OnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTo1OTowOFrOGnwBlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNDowNDo1NFrOGoCNKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNDQ4Nw==", "bodyText": "Is there a unit test for this?", "url": "https://github.com/linkedin/ambry/pull/1574#discussion_r444334487", "createdAt": "2020-06-23T15:59:08Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -741,6 +741,10 @@ private void processReplicaMetadataResponse(Set<MessageInfo> missingRemoteStoreM\n       } else {\n         // the key is present in the local store. Mark it for deletion if it is deleted in the remote store and not\n         // deleted yet locally\n+        // if the blob is from deprecated container, then nothing needs to be done.\n+        if (skipPredicate != null && skipPredicate.test(messageInfo)) {\n+          continue;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59abb40efad1c3d85e251aca3b757b78730d25d9"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMjM2MQ==", "bodyText": "Added more test cases to cover this.", "url": "https://github.com/linkedin/ambry/pull/1574#discussion_r444632361", "createdAt": "2020-06-24T04:04:54Z", "author": {"login": "SophieGuo410"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -741,6 +741,10 @@ private void processReplicaMetadataResponse(Set<MessageInfo> missingRemoteStoreM\n       } else {\n         // the key is present in the local store. Mark it for deletion if it is deleted in the remote store and not\n         // deleted yet locally\n+        // if the blob is from deprecated container, then nothing needs to be done.\n+        if (skipPredicate != null && skipPredicate.test(messageInfo)) {\n+          continue;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNDQ4Nw=="}, "originalCommit": {"oid": "59abb40efad1c3d85e251aca3b757b78730d25d9"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDQ3Njc4OnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNDoyNzoyOVrOGoCgtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNDoyNzoyOVrOGoCgtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNzM2NQ==", "bodyText": "can be removed", "url": "https://github.com/linkedin/ambry/pull/1574#discussion_r444637365", "createdAt": "2020-06-24T04:27:29Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "diffHunk": "@@ -108,6 +108,7 @@\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.junit.runners.Parameterized;\n+import org.mockito.Mock;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3832b94286df7ed5d9538c280b788a162f5a21e6"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDQ4MDgxOnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNDozMDoyMFrOGoCjMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNzozNzowNlrOGocWZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODAwMw==", "bodyText": "I still can't wrap my head around the exception findKey throws. How does it happen?\nIf we are here at line 745, then the local key is not missing from the local store. But if we move on to findKey, it throws an exception about not able to find it? Does this mean the key is compacted between?", "url": "https://github.com/linkedin/ambry/pull/1574#discussion_r444638003", "createdAt": "2020-06-24T04:30:20Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -741,6 +741,10 @@ private void processReplicaMetadataResponse(Set<MessageInfo> missingRemoteStoreM\n       } else {\n         // the key is present in the local store. Mark it for deletion if it is deleted in the remote store and not\n         // deleted yet locally\n+        // if the blob is from deprecated container, then nothing needs to be done.\n+        if (skipPredicate != null && skipPredicate.test(messageInfo)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3832b94286df7ed5d9538c280b788a162f5a21e6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0NzE3NA==", "bodyText": "I think the messageInfo is coming from replicaMetadataResponseInfo which stands for \"the replica metadata response from the remote store\". And during replication the deprecated containers won't be added in the missingRemoteStoreMessages list, so it will jump into line 741 no matter the local store has the key or not. And let's say the local store key has been compacted already, and for it's peer replica still have this key, then it will move on to findKey and throw exception. so in this situation, I use the skipPredicate to bypass the below procedure.", "url": "https://github.com/linkedin/ambry/pull/1574#discussion_r444647174", "createdAt": "2020-06-24T05:09:01Z", "author": {"login": "SophieGuo410"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -741,6 +741,10 @@ private void processReplicaMetadataResponse(Set<MessageInfo> missingRemoteStoreM\n       } else {\n         // the key is present in the local store. Mark it for deletion if it is deleted in the remote store and not\n         // deleted yet locally\n+        // if the blob is from deprecated container, then nothing needs to be done.\n+        if (skipPredicate != null && skipPredicate.test(messageInfo)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODAwMw=="}, "originalCommit": {"oid": "3832b94286df7ed5d9538c280b788a162f5a21e6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA2MDcxMA==", "bodyText": "that makes sense.", "url": "https://github.com/linkedin/ambry/pull/1574#discussion_r445060710", "createdAt": "2020-06-24T17:37:06Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -741,6 +741,10 @@ private void processReplicaMetadataResponse(Set<MessageInfo> missingRemoteStoreM\n       } else {\n         // the key is present in the local store. Mark it for deletion if it is deleted in the remote store and not\n         // deleted yet locally\n+        // if the blob is from deprecated container, then nothing needs to be done.\n+        if (skipPredicate != null && skipPredicate.test(messageInfo)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODAwMw=="}, "originalCommit": {"oid": "3832b94286df7ed5d9538c280b788a162f5a21e6"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDQ4MjQ2OnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNDozMTozMFrOGoCkJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNDozMTozMFrOGoCkJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODI0Nw==", "bodyText": "minor:  checkSet is never used, consider removing it?  (Also, format this file please)", "url": "https://github.com/linkedin/ambry/pull/1574#discussion_r444638247", "createdAt": "2020-06-24T04:31:30Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/test/java/com/github/ambry/replication/ReplicationTest.java", "diffHunk": "@@ -1417,6 +1418,9 @@ public void blockDeprecatedContainerReplicationTest() throws Exception {\n       }\n       Set<MessageInfo> remoteMissingStoreKeys = replicaThread.getMissingStoreMessages(replicaMetadataResponseInfo, remoteNode, remoteReplicaInfo);\n       assertEquals(\"All DELETE_IN_PROGRESS blobs qualified with retention time should be skipped during replication\", 0, remoteMissingStoreKeys.size());\n+      Map<StoreKey, StoreKey> remoteKeyToLocalKeyMap = replicaThread.batchConvertReplicaMetadataResponseKeys(response);\n+      replicaThread.processReplicaMetadataResponse(remoteMissingStoreKeys, replicaMetadataResponseInfo, remoteReplicaInfo,\n+          remoteNode, remoteKeyToLocalKeyMap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3832b94286df7ed5d9538c280b788a162f5a21e6"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1294, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}