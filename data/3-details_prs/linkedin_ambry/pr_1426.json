{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4ODM4Mzg2", "number": 1426, "title": "Fix the null pointer exception in hard deleter", "bodyText": "This should fix the null pointer exception in hard deleter that recorded in this issue #1425\nThe NPE is caused by performing recovery. When we persist HardDeletePersistItem to the disk, we only write the BlobReadOptions and the recoveryInfo bytes, without the start token. So when we perform the recovery, we read the BlobReadOptions and the recovery info bytes out, but now the HardDeletePersistItem doesn't have a start token. Luckily, we don't need start token for recovery, we only have to use the BlobReadOption and recovery info bytes. After performing the recovery, we have to clear the hardDeleteRecoveryRange, so later all the items added to the list would have all three fields.\nBefore the PR, the hardDeleteRecoveryRange is not cleared after performing the recovery, so next time when calling pruneTill method, some of the item doesn't have a startToken. Clearing it would fix this issue.", "createdAt": "2020-03-15T21:28:56Z", "url": "https://github.com/linkedin/ambry/pull/1426", "merged": true, "mergeCommit": {"oid": "2f60a6623a2624d203137e88bb1a750bb19c1c0e"}, "closed": true, "closedAt": "2020-03-16T17:09:53Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcN-efdgH2gAyMzg4ODM4Mzg2OmIzOTMyZDg2ZDc4ODdkMTU1MDk4YTc3NWQzNzA5NTg5MTMyNTUwNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcORRhmgFqTM3NTQxODc4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b3932d86d7887d155098a775d370958913255072", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/b3932d86d7887d155098a775d370958913255072", "committedDate": "2020-03-15T19:14:31Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4674faa99cc3801a1f33826a9f98906f1aad3d89", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/4674faa99cc3801a1f33826a9f98906f1aad3d89", "committedDate": "2020-03-15T21:27:32Z", "message": "Fix the null pointer exception for hard deleter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0OTEwODYx", "url": "https://github.com/linkedin/ambry/pull/1426#pullrequestreview-374910861", "createdAt": "2020-03-16T04:51:02Z", "commit": {"oid": "4674faa99cc3801a1f33826a9f98906f1aad3d89"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNDo1MTowMlrOF2lfEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNTowODo1NlrOF2lshA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc4MTU4NA==", "bodyText": "nit : this.e = e == null ? e :  new RuntimeException(e);", "url": "https://github.com/linkedin/ambry/pull/1426#discussion_r392781584", "createdAt": "2020-03-16T04:51:02Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/test/java/com.github.ambry.store/HardDeleterTest.java", "diffHunk": "@@ -581,7 +612,11 @@ public long getSlice(String jobType, String jobId, long usedSinceLastCall) {\n     }\n \n     public void setException(Exception e) {\n-      this.e = new RuntimeException(e);\n+      if (e == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4674faa99cc3801a1f33826a9f98906f1aad3d89"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc4NTAyOA==", "bodyText": "Could you briefly explain why this would fix NPE in pruneTill()? You can add the explanation to the commit message of this PR.", "url": "https://github.com/linkedin/ambry/pull/1426#discussion_r392785028", "createdAt": "2020-03-16T05:08:56Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/main/java/com.github.ambry.store/HardDeleter.java", "diffHunk": "@@ -217,6 +221,7 @@ void performRecovery() throws StoreException {\n         readOptionsList.add(item.blobReadOptions);\n         messageStoreRecoveryInfoList.add(item.messagesStoreRecoveryInfo);\n       }\n+      hardDeleteRecoveryRange.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4674faa99cc3801a1f33826a9f98906f1aad3d89"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38e5f8535f8215161c969b1b353bc78ec9b4e8a7", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/38e5f8535f8215161c969b1b353bc78ec9b4e8a7", "committedDate": "2020-03-16T05:13:54Z", "message": "Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0OTIxODQ4", "url": "https://github.com/linkedin/ambry/pull/1426#pullrequestreview-374921848", "createdAt": "2020-03-16T05:37:31Z", "commit": {"oid": "4674faa99cc3801a1f33826a9f98906f1aad3d89"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNTozNzozMVrOF2mDdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNTozNzozMVrOF2mDdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc5MDkwMw==", "bodyText": "Got it. I wonder why readCleanupTokenAndPopulateRecoveryRange didn't pass in startToken when creating recoverRange previously? Looks like it's viable to do so. Nvm, will approve this PR.", "url": "https://github.com/linkedin/ambry/pull/1426#discussion_r392790903", "createdAt": "2020-03-16T05:37:31Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/main/java/com.github.ambry.store/HardDeleter.java", "diffHunk": "@@ -217,6 +221,7 @@ void performRecovery() throws StoreException {\n         readOptionsList.add(item.blobReadOptions);\n         messageStoreRecoveryInfoList.add(item.messagesStoreRecoveryInfo);\n       }\n+      hardDeleteRecoveryRange.clear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc4NTAyOA=="}, "originalCommit": {"oid": "4674faa99cc3801a1f33826a9f98906f1aad3d89"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NDE4Nzgx", "url": "https://github.com/linkedin/ambry/pull/1426#pullrequestreview-375418781", "createdAt": "2020-03-16T17:08:33Z", "commit": {"oid": "38e5f8535f8215161c969b1b353bc78ec9b4e8a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1301, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}