{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMjE5MTU1", "number": 1465, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjoyMToxN1rODweXQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjo1ODowN1rODwfMiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTU1NzEzOnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjoyMToxN1rOGDf9Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjoyMToxN1rOGDf9Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMyMjUxMQ==", "bodyText": "nit: better say Local store not started for remote replica", "url": "https://github.com/linkedin/ambry/pull/1465#discussion_r406322511", "createdAt": "2020-04-09T16:21:17Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -457,14 +461,19 @@ public void replicate() {\n               replicationMetrics.updateLagMetricForRemoteReplica(remoteReplicaInfo,\n                   exchangeMetadataResponse.localLagFromRemoteInBytes);\n             } catch (Exception e) {\n-              logger.error(\n-                  \"Remote node: \" + remoteNode + \" Thread name: \" + threadName + \" Remote replica: \" + remoteReplicaInfo\n-                      .getReplicaId(), e);\n-              replicationMetrics.updateLocalStoreError(remoteReplicaInfo.getReplicaId());\n-              responseHandler.onEvent(remoteReplicaInfo.getReplicaId(), e);\n-              ExchangeMetadataResponse exchangeMetadataResponse =\n-                  new ExchangeMetadataResponse(ServerErrorCode.Unknown_Error);\n-              exchangeMetadataResponseList.add(exchangeMetadataResponse);\n+              if (e instanceof StoreException\n+                  && ((StoreException) e).getErrorCode() == StoreErrorCodes.Store_Not_Started) {\n+                // Must have just been stopped, just skip it and move on.\n+                logger.info(\"Store not started for remote replica: {}\", remoteReplicaInfo.getReplicaId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb9f08f1fbfd3c76f7fa520a88f9c92e444b07a2"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTYzNTEyOnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjo0MToyOVrOGDgt7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzo1MTowM1rOGDjJwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDk1Ng==", "bodyText": "eplicationMetrics.updateLocalStoreError(remoteReplicaInfo.getReplicaId());\nExchangeMetadataResponse exchangeMetadataResponse =\n                    new ExchangeMetadataResponse(ServerErrorCode.Unknown_Error);\nexchangeMetadataResponseList.add(exchangeMetadataResponse);\n\nThese lines are supposed to be in the if block as well. Otherwise,  exchangeMetadataResponse has less elements than replicasToReplicatePerNode and IllegalArgumentException will be thrown at the beginning of fixMissingStoreKeys.", "url": "https://github.com/linkedin/ambry/pull/1465#discussion_r406334956", "createdAt": "2020-04-09T16:41:29Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -457,14 +461,19 @@ public void replicate() {\n               replicationMetrics.updateLagMetricForRemoteReplica(remoteReplicaInfo,\n                   exchangeMetadataResponse.localLagFromRemoteInBytes);\n             } catch (Exception e) {\n-              logger.error(\n-                  \"Remote node: \" + remoteNode + \" Thread name: \" + threadName + \" Remote replica: \" + remoteReplicaInfo\n-                      .getReplicaId(), e);\n-              replicationMetrics.updateLocalStoreError(remoteReplicaInfo.getReplicaId());\n-              responseHandler.onEvent(remoteReplicaInfo.getReplicaId(), e);\n-              ExchangeMetadataResponse exchangeMetadataResponse =\n-                  new ExchangeMetadataResponse(ServerErrorCode.Unknown_Error);\n-              exchangeMetadataResponseList.add(exchangeMetadataResponse);\n+              if (e instanceof StoreException\n+                  && ((StoreException) e).getErrorCode() == StoreErrorCodes.Store_Not_Started) {\n+                // Must have just been stopped, just skip it and move on.\n+                logger.info(\"Store not started for remote replica: {}\", remoteReplicaInfo.getReplicaId());\n+              } else {\n+                logger.error(\"Remote node: {} Thread name: {} Remote replica: {}\", remoteNode, threadName,\n+                    remoteReplicaInfo.getReplicaId(), e);\n+                replicationMetrics.updateLocalStoreError(remoteReplicaInfo.getReplicaId());\n+                responseHandler.onEvent(remoteReplicaInfo.getReplicaId(), e);\n+                ExchangeMetadataResponse exchangeMetadataResponse =\n+                    new ExchangeMetadataResponse(ServerErrorCode.Unknown_Error);\n+                exchangeMetadataResponseList.add(exchangeMetadataResponse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb9f08f1fbfd3c76f7fa520a88f9c92e444b07a2"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3MTM1Mw==", "bodyText": "Good catch.  I will add the ExchangeMetadataResponse both here and in the previous line where I skip if store is not started.  But do I need to call updateLocalStoreError() in this case?\nAlso, should we use Unknown_Error or add a new one like Store_Stopped?  Or perhaps use an existing one like Temporarily_Disabled?", "url": "https://github.com/linkedin/ambry/pull/1465#discussion_r406371353", "createdAt": "2020-04-09T17:45:03Z", "author": {"login": "lightningrob"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -457,14 +461,19 @@ public void replicate() {\n               replicationMetrics.updateLagMetricForRemoteReplica(remoteReplicaInfo,\n                   exchangeMetadataResponse.localLagFromRemoteInBytes);\n             } catch (Exception e) {\n-              logger.error(\n-                  \"Remote node: \" + remoteNode + \" Thread name: \" + threadName + \" Remote replica: \" + remoteReplicaInfo\n-                      .getReplicaId(), e);\n-              replicationMetrics.updateLocalStoreError(remoteReplicaInfo.getReplicaId());\n-              responseHandler.onEvent(remoteReplicaInfo.getReplicaId(), e);\n-              ExchangeMetadataResponse exchangeMetadataResponse =\n-                  new ExchangeMetadataResponse(ServerErrorCode.Unknown_Error);\n-              exchangeMetadataResponseList.add(exchangeMetadataResponse);\n+              if (e instanceof StoreException\n+                  && ((StoreException) e).getErrorCode() == StoreErrorCodes.Store_Not_Started) {\n+                // Must have just been stopped, just skip it and move on.\n+                logger.info(\"Store not started for remote replica: {}\", remoteReplicaInfo.getReplicaId());\n+              } else {\n+                logger.error(\"Remote node: {} Thread name: {} Remote replica: {}\", remoteNode, threadName,\n+                    remoteReplicaInfo.getReplicaId(), e);\n+                replicationMetrics.updateLocalStoreError(remoteReplicaInfo.getReplicaId());\n+                responseHandler.onEvent(remoteReplicaInfo.getReplicaId(), e);\n+                ExchangeMetadataResponse exchangeMetadataResponse =\n+                    new ExchangeMetadataResponse(ServerErrorCode.Unknown_Error);\n+                exchangeMetadataResponseList.add(exchangeMetadataResponse);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDk1Ng=="}, "originalCommit": {"oid": "cb9f08f1fbfd3c76f7fa520a88f9c92e444b07a2"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM3NDg0OQ==", "bodyText": "Yeah, I think updateLocalStoreError() is optional in this case.  For server error, we can reuse the existing one Temporarily_Disabled.", "url": "https://github.com/linkedin/ambry/pull/1465#discussion_r406374849", "createdAt": "2020-04-09T17:51:03Z", "author": {"login": "jsjtzyy"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -457,14 +461,19 @@ public void replicate() {\n               replicationMetrics.updateLagMetricForRemoteReplica(remoteReplicaInfo,\n                   exchangeMetadataResponse.localLagFromRemoteInBytes);\n             } catch (Exception e) {\n-              logger.error(\n-                  \"Remote node: \" + remoteNode + \" Thread name: \" + threadName + \" Remote replica: \" + remoteReplicaInfo\n-                      .getReplicaId(), e);\n-              replicationMetrics.updateLocalStoreError(remoteReplicaInfo.getReplicaId());\n-              responseHandler.onEvent(remoteReplicaInfo.getReplicaId(), e);\n-              ExchangeMetadataResponse exchangeMetadataResponse =\n-                  new ExchangeMetadataResponse(ServerErrorCode.Unknown_Error);\n-              exchangeMetadataResponseList.add(exchangeMetadataResponse);\n+              if (e instanceof StoreException\n+                  && ((StoreException) e).getErrorCode() == StoreErrorCodes.Store_Not_Started) {\n+                // Must have just been stopped, just skip it and move on.\n+                logger.info(\"Store not started for remote replica: {}\", remoteReplicaInfo.getReplicaId());\n+              } else {\n+                logger.error(\"Remote node: {} Thread name: {} Remote replica: {}\", remoteNode, threadName,\n+                    remoteReplicaInfo.getReplicaId(), e);\n+                replicationMetrics.updateLocalStoreError(remoteReplicaInfo.getReplicaId());\n+                responseHandler.onEvent(remoteReplicaInfo.getReplicaId(), e);\n+                ExchangeMetadataResponse exchangeMetadataResponse =\n+                    new ExchangeMetadataResponse(ServerErrorCode.Unknown_Error);\n+                exchangeMetadataResponseList.add(exchangeMetadataResponse);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNDk1Ng=="}, "originalCommit": {"oid": "cb9f08f1fbfd3c76f7fa520a88f9c92e444b07a2"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTY5MzUzOnYy", "diffSide": "RIGHT", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreStats.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjo1ODowN1rOGDhT8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNjo1ODowN1rOGDhT8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM0NDY4OQ==", "bodyText": "I wonder in which case PUT is not found when updating Ttl for certain key. And it might be worth a warn here.", "url": "https://github.com/linkedin/ambry/pull/1465#discussion_r406344689", "createdAt": "2020-04-09T16:58:07Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreStats.java", "diffHunk": "@@ -550,10 +550,15 @@ private void addPutEntriesForDelete(long indexSegmentStartOffset, List<IndexEntr\n    */\n   private void updateExpiryTimeForAllPuts(List<IndexEntry> indexEntries) throws StoreException {\n     for (IndexEntry entry : indexEntries) {\n-      if (!entry.getValue().isFlagSet(IndexValue.Flags.Ttl_Update_Index) && !entry.getValue()\n-          .isFlagSet(IndexValue.Flags.Delete_Index)) {\n-        long expiryTimeMs = index.findKey(entry.getKey()).getExpiresAtMs();\n-        entry.getValue().setExpiresAtMs(expiryTimeMs);\n+      IndexValue entryValue = entry.getValue();\n+      if (!entryValue.isFlagSet(IndexValue.Flags.Ttl_Update_Index) && !entryValue.isFlagSet(\n+          IndexValue.Flags.Delete_Index)) {\n+        IndexValue indexValue = index.findKey(entry.getKey());\n+        if (indexValue != null) {\n+          entryValue.setExpiresAtMs(indexValue.getExpiresAtMs());\n+        } else {\n+          logger.info(\"No index value found for {}\", entry.getKey().getID());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb9f08f1fbfd3c76f7fa520a88f9c92e444b07a2"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1479, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}