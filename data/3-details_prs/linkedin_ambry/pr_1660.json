{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNzE2OTMw", "number": 1660, "title": "[BlobStoreCompaction] Always enable target index duplicate checking to ignore duplicate PUTs", "bodyText": "We experienced a compaction error due to duplicate PUTs in log. This is a weird error since there shouldn't be any duplicate PUTs in the log. However, it takes too long to figure out why it happened. Before we fully understand the root cause, this is a bandage to temporarily fix the issue.\nWe can always check the duplicates in target persistent index while we are check if a IndexValue is a valid one or not. If it's a duplicate of certain IndexValue in target persistent index, then it's not a valid one. This logic would ignore the duplicate PUT and mark it as invalid.", "createdAt": "2020-10-14T23:52:36Z", "url": "https://github.com/linkedin/ambry/pull/1660", "merged": true, "mergeCommit": {"oid": "fc0b55105f41b9fd6bf40d8604db4a5c0ee2a942"}, "closed": true, "closedAt": "2020-10-23T17:41:45Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUIwHbgFqTUxMjA2MTAzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVaMu2gFqTUxNTg3NjA4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDYxMDMw", "url": "https://github.com/linkedin/ambry/pull/1660#pullrequestreview-512061030", "createdAt": "2020-10-19T18:46:59Z", "commit": {"oid": "37e8c41a762b260cc74e862ff114a9170a08d396"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODo0Njo1OVrOHkc7IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODo0Njo1OVrOHkc7IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk4NDY3Mg==", "bodyText": "Can we simplify this if-else as follows?\nstate.properties.put(StoreConfig.storeAlwaysEnableTargetIndexDuplicateCheckingName, Boolean.toString(alwaysEnableTargetIndexDuplicateChecking));", "url": "https://github.com/linkedin/ambry/pull/1660#discussion_r507984672", "createdAt": "2020-10-19T18:46:59Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/test/java/com/github/ambry/store/BlobStoreCompactorTest.java", "diffHunk": "@@ -2393,6 +2445,11 @@ private BlobStoreCompactor getCompactor(Log log, DiskIOScheduler ioScheduler) th\n     if (withUndelete) {\n       state.properties.put(\"store.compaction.filter\", \"IndexSegmentValidEntryWithUndelete\");\n     }\n+    if (alwaysEnableTargetIndexDuplicateChecking) {\n+      state.properties.put(StoreConfig.storeAlwaysEnableTargetIndexDuplicateCheckingName, \"true\");\n+    } else {\n+      state.properties.put(StoreConfig.storeAlwaysEnableTargetIndexDuplicateCheckingName, \"false\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37e8c41a762b260cc74e862ff114a9170a08d396"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d18d23c592f50d1aa7b387dc84403f28e658150", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/8d18d23c592f50d1aa7b387dc84403f28e658150", "committedDate": "2020-10-22T19:14:17Z", "message": "[BlobStoreCompaction] Always enable target index duplicate checking to ignore duplicate PUTs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "274fdbb01378201daf545a24a447e6a8d2f32e53", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/274fdbb01378201daf545a24a447e6a8d2f32e53", "committedDate": "2020-10-22T19:14:17Z", "message": "Add more tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37e8c41a762b260cc74e862ff114a9170a08d396", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/37e8c41a762b260cc74e862ff114a9170a08d396", "committedDate": "2020-10-14T23:01:42Z", "message": "Add more tests"}, "afterCommit": {"oid": "5db668d48cc538d2f17cb215bb03df87db40a881", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/5db668d48cc538d2f17cb215bb03df87db40a881", "committedDate": "2020-10-22T19:18:16Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbfd8d025eaf8a7b3f77880dc85b4e1f01cb6971", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/fbfd8d025eaf8a7b3f77880dc85b4e1f01cb6971", "committedDate": "2020-10-22T19:23:21Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5db668d48cc538d2f17cb215bb03df87db40a881", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/5db668d48cc538d2f17cb215bb03df87db40a881", "committedDate": "2020-10-22T19:18:16Z", "message": "Address comments"}, "afterCommit": {"oid": "fbfd8d025eaf8a7b3f77880dc85b4e1f01cb6971", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/fbfd8d025eaf8a7b3f77880dc85b4e1f01cb6971", "committedDate": "2020-10-22T19:23:21Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1ODc2MDgx", "url": "https://github.com/linkedin/ambry/pull/1660#pullrequestreview-515876081", "createdAt": "2020-10-23T17:41:05Z", "commit": {"oid": "fbfd8d025eaf8a7b3f77880dc85b4e1f01cb6971"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 943, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}