{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMDMwMjk5", "number": 1372, "title": "Add additional log to track unsatisfied requests", "bodyText": "Print out more info of unsatisfied requests for investigation.", "createdAt": "2020-02-04T20:15:49Z", "url": "https://github.com/linkedin/ambry/pull/1372", "merged": true, "mergeCommit": {"oid": "edfa2240790ee7f20086714935441497bd7dade0"}, "closed": true, "closedAt": "2020-02-07T17:28:50Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBHVEIgH2gAyMzcxMDMwMjk5OmYzYTI2Mjg2YTcxMTdhNjJjNzFmN2NkMDRjYzUzMzNkN2VlNTAwZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCB4NhAH2gAyMzcxMDMwMjk5OjE3ZDQ2ZGViZWJmMjAyYTM2ZGY4NzZmMTdjMTQ5NDE5ZjI2ODE0Yjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3a26286a7117a62c71f7cd04cc5333d7ee500e1", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/f3a26286a7117a62c71f7cd04cc5333d7ee500e1", "committedDate": "2020-02-04T20:12:21Z", "message": "Add additional log to track unsatisfied requests\n\nPrint out more info of unsatisfied requests for investigation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODgzNDkx", "url": "https://github.com/linkedin/ambry/pull/1372#pullrequestreview-354883491", "createdAt": "2020-02-07T01:28:59Z", "commit": {"oid": "f3a26286a7117a62c71f7cd04cc5333d7ee500e1"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMToyODo1OVrOFmvxjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMTozNTozNVrOFmv3kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3Mjk0MQ==", "bodyText": "\"; method=\" and say uri=request.getUri() to match the other key value pairs", "url": "https://github.com/linkedin/ambry/pull/1372#discussion_r376172941", "createdAt": "2020-02-07T01:28:59Z", "author": {"login": "cgtz"}, "path": "ambry-rest/src/main/java/com.github.ambry.rest/NettyResponseChannel.java", "diffHunk": "@@ -369,10 +369,37 @@ private void evaluatePerformanceAndUpdateMetrics() {\n         .checkThresholds(requestPerfToCheck))) {\n       // this means either response is 5xx or request missed one of thresholds, the request should be unsatisfied\n       restRequestMetricsTracker.markUnsatisfied();\n+      logUnsatisfiedRequest(requestPerfToCheck);\n     }\n     restRequestMetricsTracker.recordMetrics();\n   }\n \n+  /**\n+   * Log unsatisfied request (print out request/response info and performance indices)\n+   * @param requestPerfToCheck the performance indices associated with this request.\n+   */\n+  private void logUnsatisfiedRequest(Map<PerformanceIndex, Long> requestPerfToCheck) {\n+    StringBuilder sb = new StringBuilder();\n+    sb.append(\"Unsatisfied request: \").append(request.getUri()).append(\"  method=\").append(request.getRestMethod());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a26286a7117a62c71f7cd04cc5333d7ee500e1"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE3NDQ4MA==", "bodyText": "change \": \" to \"=\" to match other key value pairs", "url": "https://github.com/linkedin/ambry/pull/1372#discussion_r376174480", "createdAt": "2020-02-07T01:35:35Z", "author": {"login": "cgtz"}, "path": "ambry-rest/src/main/java/com.github.ambry.rest/NettyResponseChannel.java", "diffHunk": "@@ -369,10 +369,37 @@ private void evaluatePerformanceAndUpdateMetrics() {\n         .checkThresholds(requestPerfToCheck))) {\n       // this means either response is 5xx or request missed one of thresholds, the request should be unsatisfied\n       restRequestMetricsTracker.markUnsatisfied();\n+      logUnsatisfiedRequest(requestPerfToCheck);\n     }\n     restRequestMetricsTracker.recordMetrics();\n   }\n \n+  /**\n+   * Log unsatisfied request (print out request/response info and performance indices)\n+   * @param requestPerfToCheck the performance indices associated with this request.\n+   */\n+  private void logUnsatisfiedRequest(Map<PerformanceIndex, Long> requestPerfToCheck) {\n+    StringBuilder sb = new StringBuilder();\n+    sb.append(\"Unsatisfied request: \").append(request.getUri()).append(\"  method=\").append(request.getRestMethod());\n+    if (request.getRestMethod() == RestMethod.POST) {\n+      sb.append(\"; location=\").append((String) getHeader(RestUtils.Headers.LOCATION));\n+    }\n+    sb.append(\"; status=\").append(responseStatus.getStatusCode());\n+    Object blobSize = getHeader(RestUtils.Headers.BLOB_SIZE);\n+    if (blobSize != null) {\n+      sb.append(\"; blob size=\").append((String) blobSize);\n+    }\n+    for (Map.Entry<PerformanceIndex, Long> entry : requestPerfToCheck.entrySet()) {\n+      sb.append(\"; \").append(entry.getKey().toString()).append(\": \").append(entry.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a26286a7117a62c71f7cd04cc5333d7ee500e1"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbbee904161c9e2dd1d25f1703d082c417794408", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/dbbee904161c9e2dd1d25f1703d082c417794408", "committedDate": "2020-02-07T06:41:50Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17d46debebf202a36df876f17c149419f26814b7", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/17d46debebf202a36df876f17c149419f26814b7", "committedDate": "2020-02-07T16:25:14Z", "message": "minor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1586, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}