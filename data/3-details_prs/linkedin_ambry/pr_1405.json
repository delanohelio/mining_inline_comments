{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMTM3NzY3", "number": 1405, "title": "Make PartitionSelectionHelper incorporate clustermap changes", "bodyText": "Previously, data structures in PartitionSelectionHelper are constant after initialization. With \"Move Replica\" feature on, this should dynamically incorporate any changes in clustermap (i.e. new replica / partition added or old replica removed). In this PR, we make PartitionSelectionHelper as a listener of clustermap and re-populate all in-mem data structures if number of replicas / partitions has changed.", "createdAt": "2020-02-28T00:17:23Z", "url": "https://github.com/linkedin/ambry/pull/1405", "merged": true, "mergeCommit": {"oid": "072a532c5decad5388e9e6abfc075e62db1b3562"}, "closed": true, "closedAt": "2020-03-06T16:54:30Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJffq5gFqTM2Njg4NTYwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcK-O9rgFqTM3MDI0OTkzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODg1NjA0", "url": "https://github.com/linkedin/ambry/pull/1405#pullrequestreview-366885604", "createdAt": "2020-03-01T20:49:20Z", "commit": {"oid": "41f31387ea6be5d992961efb7d73f981c2efa2b6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQyMDo0OToyMFrOFwQFYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQyMDo1Mjo0MFrOFwQGQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzOTQ4OA==", "bodyText": "Instead of copying the list and requiring a (potentially) unsafe cast. I think we could make more use of generics in ClusterManagerCallback.", "url": "https://github.com/linkedin/ambry/pull/1405#discussion_r386139488", "createdAt": "2020-03-01T20:49:20Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/AmbryPartition.java", "diffHunk": "@@ -64,12 +65,18 @@\n \n   @Override\n   public List<AmbryReplica> getReplicaIds() {\n-    return clusterManagerCallback.getReplicaIdsForPartition(this);\n+    return clusterManagerCallback.getReplicaIdsForPartition(this)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f31387ea6be5d992961efb7d73f981c2efa2b6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzOTU2MQ==", "bodyText": "ClusterManagerCallback<R extends ReplicaId, D extends DiskId, P extends PartitionId>", "url": "https://github.com/linkedin/ambry/pull/1405#discussion_r386139561", "createdAt": "2020-03-01T20:50:34Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/ClusterManagerCallback.java", "diffHunk": "@@ -18,26 +18,25 @@\n \n \n /**\n- * A callback that needs to be implemented by dynamic implementations of the cluster manager which can be\n- * used by dynamic cluster manager components such as {@link AmbryDataNode}, {@link AmbryDisk},\n- * {@link AmbryPartition}, and {@link AmbryReplica}\n+ * A callback that needs to be implemented by different implementations of the cluster manager. External components may\n+ * get resources (i.e. {@link ReplicaId}, {@link PartitionId}, {@link DiskId}) via this callback.\n  */\n interface ClusterManagerCallback {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f31387ea6be5d992961efb7d73f981c2efa2b6"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzOTcxNQ==", "bodyText": "And then pass in ClusterManagerCallback<AmbryReplica, AmbryDisk, AmbryPartition> here and in other similar classes, which will get rid of the need for the copies/casts.", "url": "https://github.com/linkedin/ambry/pull/1405#discussion_r386139715", "createdAt": "2020-03-01T20:52:40Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/AmbryPartition.java", "diffHunk": "@@ -46,7 +47,7 @@\n    * Instantiate an AmbryPartition instance.\n    * @param id the id associated with this partition.\n    * @param partitionClass the partition class that this partition belongs to\n-   * @param clusterManagerCallback the {@link ClusterManagerCallback} to use to make callbacks\n+   * @param clusterManagerCallback the {@link HelixClusterManager.HelixClusterManagerCallback} to use to make callbacks\n    *                               to the {@link HelixClusterManager}\n    * The initial state defaults to {@link PartitionState#READ_WRITE}.\n    */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f31387ea6be5d992961efb7d73f981c2efa2b6"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2OTU0MjA2", "url": "https://github.com/linkedin/ambry/pull/1405#pullrequestreview-366954206", "createdAt": "2020-03-02T05:14:12Z", "commit": {"oid": "41f31387ea6be5d992961efb7d73f981c2efa2b6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwNToxNDoxM1rOFwTzkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwNTo1MjozOFrOFwUQMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIwMDQ2NQ==", "bodyText": "why not just return the added replicas instead of pair?", "url": "https://github.com/linkedin/ambry/pull/1405#discussion_r386200465", "createdAt": "2020-03-02T05:14:13Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/DynamicClusterChangeHandler.java", "diffHunk": "@@ -393,11 +421,12 @@ private void updateReplicaStateAndOverrideIfNeeded(AmbryReplica replica, List<St\n   /**\n    * Create a new instance(node) and initialize disks/replicas on it.\n    * @param instanceConfig the {@link InstanceConfig} to create new instance\n+   * @return a pair of lists: (1) newly added replicas; (2) removed old replicas(in this method, it should be empty)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f31387ea6be5d992961efb7d73f981c2efa2b6"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIwNzc5Mg==", "bodyText": "Any reason to hook into the cluster change handler instead of ClusterChangeHandlerCallback? I was considering adding some logic that would call a hook directly from addPartitionIfAbsent", "url": "https://github.com/linkedin/ambry/pull/1405#discussion_r386207792", "createdAt": "2020-03-02T05:52:38Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/HelixClusterManager.java", "diffHunk": "@@ -510,7 +512,9 @@ public ReplicaId getBootstrapReplica(String partitionIdStr, DataNodeId dataNodeI\n \n   @Override\n   public void registerClusterMapListener(ClusterMapChangeListener clusterMapChangeListener) {\n-    clusterMapChangeListeners.add(clusterMapChangeListener);\n+    for (DcInfo dcInfo : dcToDcZkInfo.values()) {\n+      dcInfo.clusterChangeHandler.registerClusterMapListener(clusterMapChangeListener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f31387ea6be5d992961efb7d73f981c2efa2b6"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfdf31d002cc71e974eaad5956b1f5eacd3188ab", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/cfdf31d002cc71e974eaad5956b1f5eacd3188ab", "committedDate": "2020-03-03T18:27:04Z", "message": "fix compilation error"}, "afterCommit": {"oid": "7c0f95891aab57f8c85d16d0ef212f6bda9967ba", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/7c0f95891aab57f8c85d16d0ef212f6bda9967ba", "committedDate": "2020-03-03T22:37:23Z", "message": "minor changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTk5OTEz", "url": "https://github.com/linkedin/ambry/pull/1405#pullrequestreview-369999913", "createdAt": "2020-03-06T00:09:17Z", "commit": {"oid": "7c0f95891aab57f8c85d16d0ef212f6bda9967ba"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwMDowOToxN1rOFyoh4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwMDowOToxN1rOFyoh4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYzNzE1NQ==", "bodyText": "For long type names like this, I wish java had typedef statements, but alas it does not", "url": "https://github.com/linkedin/ambry/pull/1405#discussion_r388637155", "createdAt": "2020-03-06T00:09:17Z", "author": {"login": "cgtz"}, "path": "ambry-clustermap/src/main/java/com.github.ambry.clustermap/AmbryPartition.java", "diffHunk": "@@ -32,7 +32,7 @@\n public class AmbryPartition implements PartitionId {\n   private final Long id;\n   private final String partitionClass;\n-  private final ClusterManagerCallback clusterManagerCallback;\n+  private final ClusterManagerCallback<AmbryReplica, AmbryDisk, AmbryPartition, AmbryDataNode> clusterManagerCallback;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c0f95891aab57f8c85d16d0ef212f6bda9967ba"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2f043cbdf0ffa9f3f9715546caf96df05932d96", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/d2f043cbdf0ffa9f3f9715546caf96df05932d96", "committedDate": "2020-03-06T02:06:58Z", "message": "Make PartitionSelectionHelper incorporate clustermap changes\n\nPreviously, data structures in PartitionSelectionHelper are constant\nafter initialization. With \"Move Replica\" feature on, this should\ndynamically incorporate any changes in clustermap (i.e. new\nreplica/partition added or replica is removed). In this PR, we make it as\na listener of clustermap and re-populate all in-mem data structures if\nnumber of replicas/partitions has changed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4442ee4fa3cbc6aa898b0b4397d0c4f4caeaf4c1", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/4442ee4fa3cbc6aa898b0b4397d0c4f4caeaf4c1", "committedDate": "2020-03-06T02:06:58Z", "message": "fix test failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d01acbd0daa85a711916db37cd4eefbc8b88bee8", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/d01acbd0daa85a711916db37cd4eefbc8b88bee8", "committedDate": "2020-03-06T02:06:58Z", "message": "added additional synchronization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acd91bdb42bb1f5f9c26ec265cfddfd14a107cb3", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/acd91bdb42bb1f5f9c26ec265cfddfd14a107cb3", "committedDate": "2020-03-06T02:06:58Z", "message": "fix one more test failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6afdb542b1a9d409cc1f8b4fe7c5c1d77092d59f", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/6afdb542b1a9d409cc1f8b4fe7c5c1d77092d59f", "committedDate": "2020-03-06T02:06:58Z", "message": "added unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d5a74954ecd5b719bf7cb4f55f9dbee624b9235", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/2d5a74954ecd5b719bf7cb4f55f9dbee624b9235", "committedDate": "2020-03-06T02:06:58Z", "message": "addressed comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c087bd030db3d445e3e2d07e1bac2f5f2e0cb06d", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/c087bd030db3d445e3e2d07e1bac2f5f2e0cb06d", "committedDate": "2020-03-06T02:08:19Z", "message": "fix compilation error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c0e0650112c94b76d63d6cb69b4f593e0f17c59", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/0c0e0650112c94b76d63d6cb69b4f593e0f17c59", "committedDate": "2020-03-06T02:08:19Z", "message": "minor changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cca6f41b832891cced45858fbc1268c4c26f720", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/1cca6f41b832891cced45858fbc1268c4c26f720", "committedDate": "2020-03-06T02:11:07Z", "message": "rebase and fix conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c0f95891aab57f8c85d16d0ef212f6bda9967ba", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/7c0f95891aab57f8c85d16d0ef212f6bda9967ba", "committedDate": "2020-03-03T22:37:23Z", "message": "minor changes"}, "afterCommit": {"oid": "1cca6f41b832891cced45858fbc1268c4c26f720", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/1cca6f41b832891cced45858fbc1268c4c26f720", "committedDate": "2020-03-06T02:11:07Z", "message": "rebase and fix conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMjQ5OTMy", "url": "https://github.com/linkedin/ambry/pull/1405#pullrequestreview-370249932", "createdAt": "2020-03-06T11:15:47Z", "commit": {"oid": "1cca6f41b832891cced45858fbc1268c4c26f720"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1653, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}