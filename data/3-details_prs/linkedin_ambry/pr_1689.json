{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NjQ2NjIy", "number": 1689, "title": "Support UTF-8 char set in buildUserMetadata method", "bodyText": "Replace ASCII char set with UTF-8 to support more characters (i.e Chinese characters) in the user metadata.", "createdAt": "2020-11-10T17:24:37Z", "url": "https://github.com/linkedin/ambry/pull/1689", "merged": true, "mergeCommit": {"oid": "826262d98f0aae3a8f142103d9e607ff76063152"}, "closed": true, "closedAt": "2020-11-11T16:46:25Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbMtHoAH2gAyNTE4NjQ2NjIyOjlmZTUwYmU5YjNiY2JlZWNiYzA2NjI1YzkwYjNiMDgzNjJkNmZlNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbgzSFAFqTUyODM0OTQyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9fe50be9b3bcbeecbc06625c90b3b08362d6fe44", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/9fe50be9b3bcbeecbc06625c90b3b08362d6fe44", "committedDate": "2020-11-10T17:21:20Z", "message": "Support UTF-8 char set in buildUserMetadata method\n\nReplace ASCII char set with UTF-8 to support more characters (i.e Chinese characters) in the\nuser metadata."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDU2MDE4", "url": "https://github.com/linkedin/ambry/pull/1689#pullrequestreview-527456018", "createdAt": "2020-11-10T17:47:55Z", "commit": {"oid": "9fe50be9b3bcbeecbc06625c90b3b08362d6fe44"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNzo0Nzo1NVrOHwoTJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNzo0Nzo1NVrOHwoTJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1Mzk1Nw==", "bodyText": "I changed this because  String keyAlgo = Utils.readIntString(dataStream) in deserializeKeyRecord() is actually using UTF-8. (line 383)", "url": "https://github.com/linkedin/ambry/pull/1689#discussion_r520753957", "createdAt": "2020-11-10T17:47:55Z", "author": {"login": "jsjtzyy"}, "path": "ambry-router/src/main/java/com/github/ambry/router/GCMCryptoService.java", "diffHunk": "@@ -366,18 +366,17 @@ private static void serializeKeyRecord(ByteBuffer outputBuffer, byte[] key, Stri\n       outputBuffer.putShort(KEY_RECORD_VERSION_V_1);\n       outputBuffer.putInt(key.length);\n       outputBuffer.put(key);\n-      Utils.serializeString(outputBuffer, keyGenAlgo, StandardCharsets.US_ASCII);\n+      Utils.serializeString(outputBuffer, keyGenAlgo, StandardCharsets.UTF_8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fe50be9b3bcbeecbc06625c90b3b08362d6fe44"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDU5MDg3", "url": "https://github.com/linkedin/ambry/pull/1689#pullrequestreview-527459087", "createdAt": "2020-11-10T17:51:39Z", "commit": {"oid": "9fe50be9b3bcbeecbc06625c90b3b08362d6fe44"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNzo1MTozOVrOHwochQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNzo1MTozOVrOHwochQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1NjM1Nw==", "bodyText": "I thought of one slight deployment issue with changing the charset without making a new user metadata version.\nIf you deploy this change to one frontend, a user could write a non-ascii value into user metadata, and the binary format will now store its real utf-8 value instead of a ? character.\nIf this blob's user metadata is fetched on a frontend without this change, that frontend will attempt to decode as ascii and a deserialization error will occur.\nHowever, this may be a negligible number of users affected and any problems will be resolved by completing the deployment, so maybe continuing with this approach and opting for a fast deployment is the easiest solution. Another option would be to make a user metadata v2 and a config to switch the version; then you could deploy read support for v2 and then switch on serialization in v2.", "url": "https://github.com/linkedin/ambry/pull/1689#discussion_r520756357", "createdAt": "2020-11-10T17:51:39Z", "author": {"login": "cgtz"}, "path": "ambry-api/src/main/java/com/github/ambry/rest/RestUtils.java", "diffHunk": "@@ -443,12 +443,12 @@ public static BlobProperties buildBlobProperties(Map<String, Object> args) throw\n           // key size\n           sizeToAllocate += 4;\n           String keyToStore = key.substring(Headers.USER_META_DATA_HEADER_PREFIX.length());\n-          sizeToAllocate += keyToStore.getBytes(StandardCharsets.US_ASCII).length;\n+          sizeToAllocate += keyToStore.getBytes(StandardCharsets.UTF_8).length;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fe50be9b3bcbeecbc06625c90b3b08362d6fe44"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTkwMjg3", "url": "https://github.com/linkedin/ambry/pull/1689#pullrequestreview-527590287", "createdAt": "2020-11-10T20:41:36Z", "commit": {"oid": "9fe50be9b3bcbeecbc06625c90b3b08362d6fe44"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDo0MTozNlrOHwu0jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDo0MTozNlrOHwu0jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2MDgxMg==", "bodyText": "Can you make the Charset a class level constant?", "url": "https://github.com/linkedin/ambry/pull/1689#discussion_r520860812", "createdAt": "2020-11-10T20:41:36Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/rest/RestUtils.java", "diffHunk": "@@ -443,12 +443,12 @@ public static BlobProperties buildBlobProperties(Map<String, Object> args) throw\n           // key size\n           sizeToAllocate += 4;\n           String keyToStore = key.substring(Headers.USER_META_DATA_HEADER_PREFIX.length());\n-          sizeToAllocate += keyToStore.getBytes(StandardCharsets.US_ASCII).length;\n+          sizeToAllocate += keyToStore.getBytes(StandardCharsets.UTF_8).length;\n           String value = getHeader(args, key, true);\n           userMetadataMap.put(keyToStore, value);\n           // value size\n           sizeToAllocate += 4;\n-          sizeToAllocate += value.getBytes(StandardCharsets.US_ASCII).length;\n+          sizeToAllocate += value.getBytes(StandardCharsets.UTF_8).length;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fe50be9b3bcbeecbc06625c90b3b08362d6fe44"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e5f34f4e7348416f14bd3b54ad62174ea4ef447", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/9e5f34f4e7348416f14bd3b54ad62174ea4ef447", "committedDate": "2020-11-10T21:44:04Z", "message": "address comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjU3Nzk1", "url": "https://github.com/linkedin/ambry/pull/1689#pullrequestreview-527657795", "createdAt": "2020-11-10T22:25:31Z", "commit": {"oid": "9e5f34f4e7348416f14bd3b54ad62174ea4ef447"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MzQ5NDIy", "url": "https://github.com/linkedin/ambry/pull/1689#pullrequestreview-528349422", "createdAt": "2020-11-11T16:46:10Z", "commit": {"oid": "9e5f34f4e7348416f14bd3b54ad62174ea4ef447"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 989, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}