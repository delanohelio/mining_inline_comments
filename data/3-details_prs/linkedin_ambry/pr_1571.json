{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3NjAzNDky", "number": 1571, "title": "Force empty store to stay in BOOTSTRAP before catchup completes", "bodyText": "When disk crashed due to I/O error, we lost all partitions on this disk. After a new disk\nis mounted, Ambry is able to recreate the stores on new disk during reboot. These\nrecreated stores are empty and probably way behind their peer replicas, so we need\nto put them in BOOTSTRAP state until they have caught up with peers. Considering\nLeader-based Replication will be introduced, this PR guarantees those empty stores\nwon't be selected LEADER because they are kept in BOOTSTRAP state. (Otherwise, some stores\nmay be selected as LEADER but they have to spend a couple of hours/days completing catchup.\nMeanwhile new data in remote dc(s) cannot be replicated to current dc.)", "createdAt": "2020-06-21T21:29:01Z", "url": "https://github.com/linkedin/ambry/pull/1571", "merged": true, "mergeCommit": {"oid": "85c54bef17c3d83271c1e1068464982cb359e3c8"}, "closed": true, "closedAt": "2020-06-26T23:29:20Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuSHQegFqTQzNjMxMTUyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvL1B2AFqTQzODY0Mzg0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MzExNTI4", "url": "https://github.com/linkedin/ambry/pull/1571#pullrequestreview-436311528", "createdAt": "2020-06-24T04:12:49Z", "commit": {"oid": "5e51d46695f9ce28959a4e91a0fbf31d6458661e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNDoxMjo0OVrOGoCUIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNDoxMjo0OVrOGoCUIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDE0Nw==", "bodyText": "Sorry I didn't quite follow with this part. From the comments, the store will be forced in BOOTSTRAP state if capacity is less or equal to header size, but looks like no matter what the value of the storeUsedCapacity is, the store will be forced in BOOTSTRAP state. Is this intended?", "url": "https://github.com/linkedin/ambry/pull/1571#discussion_r444634147", "createdAt": "2020-06-24T04:12:49Z", "author": {"login": "SophieGuo410"}, "path": "ambry-store/src/main/java/com/github/ambry/store/StorageManager.java", "diffHunk": "@@ -476,16 +477,40 @@ public void onPartitionBecomeBootstrapFromOffline(String partitionName) {\n         // able to get new replica from storageManager without querying Helix\n       } else {\n         // if the replica is already on current node, there are 3 cases need to discuss:\n-        // 1. replica was initially present in clustermap;\n-        // 2. replica was dynamically added to this node but may fail during BOOTSTRAP -> STANDBY transition\n+        // 1. replica was initially present in clustermap and this is a regular reboot.\n+        // 2. replica was dynamically added to this node but may fail during BOOTSTRAP -> STANDBY transition.\n         // 3. replica is on current node but its disk is offline. The replica is not able to start.\n+        // 4. replica was initially present in clustermap but it's current being recreated due to disk failure before.\n+\n         // For case 1 and 2, OFFLINE -> BOOTSTRAP is complete, we leave remaining actions (if there any) to other transition.\n         // For case 3, we should throw exception to make replica stay in ERROR state (thus, frontends won't pick this replica)\n-        if (getStore(replica.getPartitionId(), false) == null) {\n+        // For case 4, we check it's current used capacity and put it in BOOTSTRAP state if necessary. This is to ensure\n+        //             it catches up with peers before serving PUT traffic (or being selected as LEADER)\n+        Store store = getStore(replica.getPartitionId(), false);\n+        if (store == null) {\n           throw new StateTransitionException(\n               \"Store \" + partitionName + \" didn't start correctly, replica should be set to ERROR state\",\n               StoreNotStarted);\n         }\n+        // if store's used capacity is less than or equal to header size, we create a bootstrap_in_progress file and force\n+        // it to stay in BOOTSTRAP state when catching up with peers.\n+        long storeUsedCapacity = store.getSizeInBytes();\n+        if (storeUsedCapacity <= HEADER_SIZE) {\n+          logger.info(\n+              \"Store {} has used capacity {} less than or equal to {} bytes, consider it recently created and make it go through bootstrap process.\",\n+              partitionName, storeUsedCapacity, HEADER_SIZE);\n+          try {\n+            File bootstrapFile = new File(replica.getReplicaPath(), BlobStore.BOOTSTRAP_FILE_NAME);\n+            if (!bootstrapFile.exists()) {\n+              bootstrapFile.createNewFile();\n+            }\n+          } catch (IOException e) {\n+            logger.error(\"Failed to create bootstrap file for store {}\", partitionName);\n+            throw new StateTransitionException(\"Failed to create bootstrap file for \" + partitionName,\n+                ReplicaOperationFailure);\n+          }\n+        }\n+        store.setCurrentState(ReplicaState.BOOTSTRAP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e51d46695f9ce28959a4e91a0fbf31d6458661e"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2OTA0MTU2", "url": "https://github.com/linkedin/ambry/pull/1571#pullrequestreview-436904156", "createdAt": "2020-06-24T18:31:30Z", "commit": {"oid": "5e51d46695f9ce28959a4e91a0fbf31d6458661e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODozMTozMFrOGoeNOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODo0MDozMVrOGoef3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5MTEyOQ==", "bodyText": "creating a bootstrap_in_progress file and set setting currentstate to bootstrap has to go toe to toe, I suppose we can make a method out of them.", "url": "https://github.com/linkedin/ambry/pull/1571#discussion_r445091129", "createdAt": "2020-06-24T18:31:30Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-store/src/main/java/com/github/ambry/store/StorageManager.java", "diffHunk": "@@ -476,16 +477,40 @@ public void onPartitionBecomeBootstrapFromOffline(String partitionName) {\n         // able to get new replica from storageManager without querying Helix\n       } else {\n         // if the replica is already on current node, there are 3 cases need to discuss:\n-        // 1. replica was initially present in clustermap;\n-        // 2. replica was dynamically added to this node but may fail during BOOTSTRAP -> STANDBY transition\n+        // 1. replica was initially present in clustermap and this is a regular reboot.\n+        // 2. replica was dynamically added to this node but may fail during BOOTSTRAP -> STANDBY transition.\n         // 3. replica is on current node but its disk is offline. The replica is not able to start.\n+        // 4. replica was initially present in clustermap but it's current being recreated due to disk failure before.\n+\n         // For case 1 and 2, OFFLINE -> BOOTSTRAP is complete, we leave remaining actions (if there any) to other transition.\n         // For case 3, we should throw exception to make replica stay in ERROR state (thus, frontends won't pick this replica)\n-        if (getStore(replica.getPartitionId(), false) == null) {\n+        // For case 4, we check it's current used capacity and put it in BOOTSTRAP state if necessary. This is to ensure\n+        //             it catches up with peers before serving PUT traffic (or being selected as LEADER)\n+        Store store = getStore(replica.getPartitionId(), false);\n+        if (store == null) {\n           throw new StateTransitionException(\n               \"Store \" + partitionName + \" didn't start correctly, replica should be set to ERROR state\",\n               StoreNotStarted);\n         }\n+        // if store's used capacity is less than or equal to header size, we create a bootstrap_in_progress file and force\n+        // it to stay in BOOTSTRAP state when catching up with peers.\n+        long storeUsedCapacity = store.getSizeInBytes();\n+        if (storeUsedCapacity <= HEADER_SIZE) {\n+          logger.info(\n+              \"Store {} has used capacity {} less than or equal to {} bytes, consider it recently created and make it go through bootstrap process.\",\n+              partitionName, storeUsedCapacity, HEADER_SIZE);\n+          try {\n+            File bootstrapFile = new File(replica.getReplicaPath(), BlobStore.BOOTSTRAP_FILE_NAME);\n+            if (!bootstrapFile.exists()) {\n+              bootstrapFile.createNewFile();\n+            }\n+          } catch (IOException e) {\n+            logger.error(\"Failed to create bootstrap file for store {}\", partitionName);\n+            throw new StateTransitionException(\"Failed to create bootstrap file for \" + partitionName,\n+                ReplicaOperationFailure);\n+          }\n+        }\n+        store.setCurrentState(ReplicaState.BOOTSTRAP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e51d46695f9ce28959a4e91a0fbf31d6458661e"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5MTI3Nw==", "bodyText": "there are 4 cases need to discuss:", "url": "https://github.com/linkedin/ambry/pull/1571#discussion_r445091277", "createdAt": "2020-06-24T18:31:47Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-store/src/main/java/com/github/ambry/store/StorageManager.java", "diffHunk": "@@ -476,16 +477,40 @@ public void onPartitionBecomeBootstrapFromOffline(String partitionName) {\n         // able to get new replica from storageManager without querying Helix\n       } else {\n         // if the replica is already on current node, there are 3 cases need to discuss:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e51d46695f9ce28959a4e91a0fbf31d6458661e"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTkwMg==", "bodyText": "I wonder if this is really necessary. If we create a bootstrap_in_progress file no matter the used capacity and let the remaining transition remove it later. In this way I think we can address another corner case where only half of the data in this partition gets wiped out.\nImagine that we have two log segment files in this partition, somehow we remove the second log segment file and then we restart the process. Here since the used capacity is no less then HEADER_SIZE, so the bootstrap_in_progress file will not be created, then the replicationmanager's callback would just mark it as standby on the onPartitionBecomeStandByFromBootstrap.\nBut if we create the bootstrap without checking the HEADER_SIZE, then we can avoid this issue.", "url": "https://github.com/linkedin/ambry/pull/1571#discussion_r445095902", "createdAt": "2020-06-24T18:40:31Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-store/src/main/java/com/github/ambry/store/StorageManager.java", "diffHunk": "@@ -476,16 +477,40 @@ public void onPartitionBecomeBootstrapFromOffline(String partitionName) {\n         // able to get new replica from storageManager without querying Helix\n       } else {\n         // if the replica is already on current node, there are 3 cases need to discuss:\n-        // 1. replica was initially present in clustermap;\n-        // 2. replica was dynamically added to this node but may fail during BOOTSTRAP -> STANDBY transition\n+        // 1. replica was initially present in clustermap and this is a regular reboot.\n+        // 2. replica was dynamically added to this node but may fail during BOOTSTRAP -> STANDBY transition.\n         // 3. replica is on current node but its disk is offline. The replica is not able to start.\n+        // 4. replica was initially present in clustermap but it's current being recreated due to disk failure before.\n+\n         // For case 1 and 2, OFFLINE -> BOOTSTRAP is complete, we leave remaining actions (if there any) to other transition.\n         // For case 3, we should throw exception to make replica stay in ERROR state (thus, frontends won't pick this replica)\n-        if (getStore(replica.getPartitionId(), false) == null) {\n+        // For case 4, we check it's current used capacity and put it in BOOTSTRAP state if necessary. This is to ensure\n+        //             it catches up with peers before serving PUT traffic (or being selected as LEADER)\n+        Store store = getStore(replica.getPartitionId(), false);\n+        if (store == null) {\n           throw new StateTransitionException(\n               \"Store \" + partitionName + \" didn't start correctly, replica should be set to ERROR state\",\n               StoreNotStarted);\n         }\n+        // if store's used capacity is less than or equal to header size, we create a bootstrap_in_progress file and force\n+        // it to stay in BOOTSTRAP state when catching up with peers.\n+        long storeUsedCapacity = store.getSizeInBytes();\n+        if (storeUsedCapacity <= HEADER_SIZE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e51d46695f9ce28959a4e91a0fbf31d6458661e"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecba601d1e51ad912ba80889253e460a4ccd0c07", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/ecba601d1e51ad912ba80889253e460a4ccd0c07", "committedDate": "2020-06-24T23:12:58Z", "message": "Force empty store to stay in BOOTSTRAP before catchup completes\n\nWhen disk crashed due to I/O error, we lost partitions on this disk. After new disk\nis mounted, Ambry is able to recreate the stores on new disk during reboot. These\nrecreated stores are empty and probably way behind their peer replicas, so we need\nto put them in BOOTSTRAP state until they have caught up with peers. Considering\nLeader-based Replication will be introduced, this PR guarantees those empty store\nwon't be selected LEADER because they are in BOOTSTRAP state. (Otherwise, some stores\nare selected as LEADER but they have to spend a couple of hours/days completing catchup.\nMeanwhile new data in remote dc(s) cannot be replicated to current dc.)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56f80e3a3c03f2ac6eb9866202f5b8492b8c15cc", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/56f80e3a3c03f2ac6eb9866202f5b8492b8c15cc", "committedDate": "2020-06-24T23:12:58Z", "message": "added unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b4cf3836810b2915141818eab150441f2f247c9", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/4b4cf3836810b2915141818eab150441f2f247c9", "committedDate": "2020-06-24T23:42:21Z", "message": "fix test failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29b018720bfc1f4ac2b9041dc430e0f5e9af9741", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/29b018720bfc1f4ac2b9041dc430e0f5e9af9741", "committedDate": "2020-06-25T00:56:03Z", "message": "rebased and addressed comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e51d46695f9ce28959a4e91a0fbf31d6458661e", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/5e51d46695f9ce28959a4e91a0fbf31d6458661e", "committedDate": "2020-06-22T03:34:23Z", "message": "fix test failure"}, "afterCommit": {"oid": "29b018720bfc1f4ac2b9041dc430e0f5e9af9741", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/29b018720bfc1f4ac2b9041dc430e0f5e9af9741", "committedDate": "2020-06-25T00:56:03Z", "message": "rebased and addressed comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NTE4NjE4", "url": "https://github.com/linkedin/ambry/pull/1571#pullrequestreview-438518618", "createdAt": "2020-06-26T18:44:17Z", "commit": {"oid": "29b018720bfc1f4ac2b9041dc430e0f5e9af9741"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjAwMjky", "url": "https://github.com/linkedin/ambry/pull/1571#pullrequestreview-438600292", "createdAt": "2020-06-26T21:16:55Z", "commit": {"oid": "29b018720bfc1f4ac2b9041dc430e0f5e9af9741"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjQzODQx", "url": "https://github.com/linkedin/ambry/pull/1571#pullrequestreview-438643841", "createdAt": "2020-06-26T23:27:24Z", "commit": {"oid": "29b018720bfc1f4ac2b9041dc430e0f5e9af9741"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1154, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}