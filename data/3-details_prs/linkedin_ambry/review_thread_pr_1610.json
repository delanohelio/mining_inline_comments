{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyODQ4MDg4", "number": 1610, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozMjoyMlrOEcvMVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNjowNzozMFrOEfhvTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTY4NzkwOnYy", "diffSide": "RIGHT", "path": "ambry-api/src/main/java/com/github/ambry/store/MessageInfo.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDozMjoyMlrOHHcqSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMDoyMjowM1rOHKH6-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3MTY1OA==", "bodyText": "Can we move this class to a separate file and call it MessageInfoBuilder?", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r477571658", "createdAt": "2020-08-26T20:32:22Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/store/MessageInfo.java", "diffHunk": "@@ -295,4 +295,175 @@ public String toString() {\n         .append(\"]\");\n     return stringBuilder.toString();\n   }\n+\n+  /**\n+   * A builder class for {@link MessageInfo}.\n+   */\n+  public static class Builder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDM3NzU5Mg==", "bodyText": "I personally prefer to have Builder as a public static class of what it's building. I think this makes more sense since if the MessageInfo doesn't exist, this builder would not exist either.", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r480377592", "createdAt": "2020-08-31T20:22:03Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com/github/ambry/store/MessageInfo.java", "diffHunk": "@@ -295,4 +295,175 @@ public String toString() {\n         .append(\"]\");\n     return stringBuilder.toString();\n   }\n+\n+  /**\n+   * A builder class for {@link MessageInfo}.\n+   */\n+  public static class Builder {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3MTY1OA=="}, "originalCommit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTcxOTA2OnYy", "diffSide": "RIGHT", "path": "ambry-api/src/main/java/com/github/ambry/store/MessageInfo.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDo0MToxM1rOHHc8-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDo0MToxM1rOHHc8-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3NjQ0MA==", "bodyText": "nit: extra this", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r477576440", "createdAt": "2020-08-26T20:41:13Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/store/MessageInfo.java", "diffHunk": "@@ -295,4 +295,175 @@ public String toString() {\n         .append(\"]\");\n     return stringBuilder.toString();\n   }\n+\n+  /**\n+   * A builder class for {@link MessageInfo}.\n+   */\n+  public static class Builder {\n+    private StoreKey key;\n+    private short accountId;\n+    private short containerId;\n+    private long operationTimeMs;\n+    private long size;\n+\n+    private long expirationTimeInMs = Utils.Infinite_Time;\n+    private boolean isDeleted = false;\n+    private boolean isTtlUpdated = false;\n+    private boolean isUndeleted = false;\n+    private Long crc = null;\n+    private short lifeVersion = 0;\n+\n+    /**\n+     * Constructor to create a builder.\n+     * @param key The {@link StoreKey} associated with {@link MessageInfo}.\n+     * @param size The size of this this message in bytes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTcyMTYzOnYy", "diffSide": "RIGHT", "path": "ambry-api/src/main/java/com/github/ambry/store/MessageInfo.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDo0MTo1MVrOHHc-dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDo0MTo1MVrOHHc-dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3NjgyMg==", "bodyText": "nit:  @return This builder.", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r477576822", "createdAt": "2020-08-26T20:41:51Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/store/MessageInfo.java", "diffHunk": "@@ -295,4 +295,175 @@ public String toString() {\n         .append(\"]\");\n     return stringBuilder.toString();\n   }\n+\n+  /**\n+   * A builder class for {@link MessageInfo}.\n+   */\n+  public static class Builder {\n+    private StoreKey key;\n+    private short accountId;\n+    private short containerId;\n+    private long operationTimeMs;\n+    private long size;\n+\n+    private long expirationTimeInMs = Utils.Infinite_Time;\n+    private boolean isDeleted = false;\n+    private boolean isTtlUpdated = false;\n+    private boolean isUndeleted = false;\n+    private Long crc = null;\n+    private short lifeVersion = 0;\n+\n+    /**\n+     * Constructor to create a builder.\n+     * @param key The {@link StoreKey} associated with {@link MessageInfo}.\n+     * @param size The size of this this message in bytes.\n+     * @param accountId accountId of the blob.\n+     * @param containerId containerId of the blob.\n+     * @param operationTimeMs operation time in ms.\n+     */\n+    public Builder(StoreKey key, long size, short accountId, short containerId, long operationTimeMs) {\n+      this.key = key;\n+      this.size = size;\n+      this.accountId = accountId;\n+      this.containerId = containerId;\n+      this.operationTimeMs = operationTimeMs;\n+    }\n+\n+    /**\n+     * Constructor to create a builder from {@link MessageInfo}.\n+     * @param info The {@link MessageInfo} to build from.\n+     */\n+    public Builder(final MessageInfo info) {\n+      this.key = info.getStoreKey();\n+      this.accountId = info.getAccountId();\n+      this.containerId = info.getContainerId();\n+      this.operationTimeMs = info.getOperationTimeMs();\n+      this.size = info.getSize();\n+      this.expirationTimeInMs = info.getExpirationTimeInMs();\n+      this.isDeleted = info.isDeleted();\n+      this.isTtlUpdated = info.isTtlUpdated();\n+      this.isUndeleted = info.isUndeleted();\n+      this.crc = info.getCrc();\n+      this.lifeVersion = info.getLifeVersion();\n+    }\n+\n+    /**\n+     * Builds a {@link MessageInfo} object.\n+     * @return A {@link MessageInfo} object.\n+     */\n+    public MessageInfo build() {\n+      return new MessageInfo(key, size, isDeleted, isTtlUpdated, isUndeleted, expirationTimeInMs, crc, accountId,\n+          containerId, operationTimeMs, lifeVersion);\n+    }\n+\n+    /**\n+     * Sets the key of the {@link MessageInfo} to build.\n+     * @param key the key to set.\n+     * @return This builder.\n+     */\n+    public Builder storeKey(StoreKey key) {\n+      this.key = key;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets the accountId of the {@link MessageInfo} to build.\n+     * @param accountId the accountId to set.\n+     * @return This builder.\n+     */\n+    public Builder accountId(short accountId) {\n+      this.accountId = accountId;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets the containerId of the {@link MessageInfo} to build.\n+     * @param containerId the containerId to set.\n+     * @return This builder.\n+     */\n+    public Builder containerId(short containerId) {\n+      this.containerId = containerId;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets the operationTime in ms of the {@link MessageInfo} to build.\n+     * @param operationTimeMs the operationTime to set.\n+     * @return This builder.\n+     */\n+    public Builder operationTimeMs(long operationTimeMs) {\n+      this.operationTimeMs = operationTimeMs;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets the size of the {@link MessageInfo} to build.\n+     * @param size the size to set.\n+     * @return This builder.\n+     */\n+    public Builder size(long size) {\n+      this.size = size;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets expirationTime in ms of the {@link MessageInfo} to build.\n+     * @param expirationTimeInMs the expirationTime to set\n+     * @return This builder.\n+     */\n+    public Builder expirationTimeInMs(long expirationTimeInMs) {\n+      this.expirationTimeInMs = expirationTimeInMs;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets isDeleted flag of the {@link MessageInfo} to build.\n+     * @param isDeleted the isDeleted to set.\n+     * @return This builder.\n+     */\n+    public Builder isDeleted(boolean isDeleted) {\n+      this.isDeleted = isDeleted;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets isTtlUpdated flag of the {@link MessageInfo} to build.\n+     * @param isTtlUpdated the isTtlUpdated to set.\n+     * @return This builder.\n+     */\n+    public Builder isTtlUpdated(boolean isTtlUpdated) {\n+      this.isTtlUpdated = isTtlUpdated;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets isUndeleted flag of the {@link MessageInfo} to build.\n+     * @param isUndeleted the isUndeleted to set.\n+     * @return This builder.\n+     */\n+    public Builder isUndeleted(boolean isUndeleted) {\n+      this.isUndeleted = isUndeleted;\n+      return this;\n+    }\n+\n+    /**\n+     * Sets crc of the {@link MessageInfo} to build.\n+     * @param crc the crc to set.\n+     * @return", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580"}, "originalPosition": 169}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTg1MDAzOnYy", "diffSide": "RIGHT", "path": "ambry-protocol/src/main/java/com/github/ambry/protocol/AmbryRequests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMToyMTo0NVrOHHeMjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMToyMTo0NVrOHHeMjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU5NjgxNA==", "bodyText": "minor: replace receivedRequest.getBlobProperties() with properties", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r477596814", "createdAt": "2020-08-26T21:21:45Z", "author": {"login": "jsjtzyy"}, "path": "ambry-protocol/src/main/java/com/github/ambry/protocol/AmbryRequests.java", "diffHunk": "@@ -168,11 +169,15 @@ public void handlePutRequest(NetworkRequest request) throws IOException, Interru\n             new PutMessageFormatInputStream(receivedRequest.getBlobId(), receivedRequest.getBlobEncryptionKey(),\n                 receivedRequest.getBlobProperties(), receivedRequest.getUsermetadata(), receivedRequest.getBlobStream(),\n                 receivedRequest.getBlobSize(), receivedRequest.getBlobType());\n-        MessageInfo info = new MessageInfo(receivedRequest.getBlobId(), stream.getSize(), false, false, false,\n-            Utils.addSecondsToEpochTime(receivedRequest.getBlobProperties().getCreationTimeInMs(),\n-                receivedRequest.getBlobProperties().getTimeToLiveInSeconds()), receivedRequest.getCrc(),\n-            receivedRequest.getBlobProperties().getAccountId(), receivedRequest.getBlobProperties().getContainerId(),\n-            receivedRequest.getBlobProperties().getCreationTimeInMs(), MessageInfo.LIFE_VERSION_FROM_FRONTEND);\n+        BlobProperties properties = receivedRequest.getBlobProperties();\n+        long expirationTime = Utils.addSecondsToEpochTime(receivedRequest.getBlobProperties().getCreationTimeInMs(),\n+            receivedRequest.getBlobProperties().getTimeToLiveInSeconds());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24a1c182c837e24efc69048cc29b30271f762580"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxNDk0MDkzOnYy", "diffSide": "RIGHT", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNjowNzozMFrOHL2irw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNjoxNTowN1rOHL22ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE4OTk5OQ==", "bodyText": "looks like this one has slightly different behavior. The builder code always sets isDeleted to false. Was this intended?", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r482189999", "createdAt": "2020-09-02T16:07:30Z", "author": {"login": "cgtz"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -1255,10 +1252,7 @@ private void applyTtlUpdate(MessageInfo messageInfo, RemoteReplicaInfo remoteRep\n   private void applyUndelete(MessageInfo messageInfo, RemoteReplicaInfo remoteReplicaInfo) throws StoreException {\n     DataNodeId remoteNode = remoteReplicaInfo.getReplicaId().getDataNodeId();\n     try {\n-      messageInfo = new MessageInfo(messageInfo.getStoreKey(), messageInfo.getSize(), messageInfo.isDeleted(),\n-          messageInfo.isTtlUpdated(), true, messageInfo.getExpirationTimeInMs(), messageInfo.getCrc(),\n-          messageInfo.getAccountId(), messageInfo.getContainerId(), messageInfo.getOperationTimeMs(),\n-          messageInfo.getLifeVersion());\n+      messageInfo = new MessageInfo.Builder(messageInfo).isUndeleted(true).isDeleted(false).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08a8f32872078a89d78aefed66e1267ff9e6e4b1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE5NTA0NA==", "bodyText": "This method applyUndelete to local store, so I always set undelete to true and delete to false.", "url": "https://github.com/linkedin/ambry/pull/1610#discussion_r482195044", "createdAt": "2020-09-02T16:15:07Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -1255,10 +1252,7 @@ private void applyTtlUpdate(MessageInfo messageInfo, RemoteReplicaInfo remoteRep\n   private void applyUndelete(MessageInfo messageInfo, RemoteReplicaInfo remoteReplicaInfo) throws StoreException {\n     DataNodeId remoteNode = remoteReplicaInfo.getReplicaId().getDataNodeId();\n     try {\n-      messageInfo = new MessageInfo(messageInfo.getStoreKey(), messageInfo.getSize(), messageInfo.isDeleted(),\n-          messageInfo.isTtlUpdated(), true, messageInfo.getExpirationTimeInMs(), messageInfo.getCrc(),\n-          messageInfo.getAccountId(), messageInfo.getContainerId(), messageInfo.getOperationTimeMs(),\n-          messageInfo.getLifeVersion());\n+      messageInfo = new MessageInfo.Builder(messageInfo).isUndeleted(true).isDeleted(false).build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjE4OTk5OQ=="}, "originalCommit": {"oid": "08a8f32872078a89d78aefed66e1267ff9e6e4b1"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1349, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}