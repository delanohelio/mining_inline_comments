{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyOTcwNzI1", "number": 1378, "title": "Improve FailOnNotFound by accounting for disk down and cross-colo NotFound", "bodyText": "Current operation tracker supports terminating when at least two\nNotFound occur in originating DC. Such strategy is not able to\nhandle edge case where originating DC replicas return Disk_Unavailable,\nDeleted and NotFound separately. Even though rest remote replicas\nall return NotFound, the operation still returns AmbryUnavailable\nwhich makes client keep retrying. This PR improve FailOnNotFound logic\nby accounting for number of Disk_Unavailable and NotFound across all\ndcs. It adds additional check in hasFailedOnNotFound to correctly return\n404 reminding client the blob is no longer present. This is helpful when\nclient attempts to delete some blobs which have expired and been compacted\nbut encounters Disk_Unavailable during delete operation.", "createdAt": "2020-02-10T06:59:17Z", "url": "https://github.com/linkedin/ambry/pull/1378", "merged": true, "mergeCommit": {"oid": "2f94c6635e05589ed64c9825294239d72d78d077"}, "closed": true, "closedAt": "2020-02-19T19:52:55Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcD_XVtAFqTM1ODQ1NzExMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcF8CPHgFqTM2MTM5MDU2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDU3MTEy", "url": "https://github.com/linkedin/ambry/pull/1378#pullrequestreview-358457112", "createdAt": "2020-02-13T18:37:21Z", "commit": {"oid": "87949d10b95094e6470559b95b99ddd155ff4062"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODozNzoyMlrOFpfFLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODozNzoyMlrOFpfFLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0NTE2Ng==", "bodyText": "what if 2 Disk_Unavailable and 1 Deleted?", "url": "https://github.com/linkedin/ambry/pull/1378#discussion_r379045166", "createdAt": "2020-02-13T18:37:22Z", "author": {"login": "zzmao"}, "path": "ambry-router/src/test/java/com.github.ambry.router/GetBlobOperationTest.java", "diffHunk": "@@ -715,6 +716,34 @@ public void testErrorPrecedenceWithSpecialCase() throws Exception {\n     }\n   }\n \n+  /**\n+   * Test the case where originating dc returns 2 Disk_Unavailable and 1 Not_Found and rest replicas return Not_Found.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87949d10b95094e6470559b95b99ddd155ff4062"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NTc3OTI2", "url": "https://github.com/linkedin/ambry/pull/1378#pullrequestreview-358577926", "createdAt": "2020-02-13T21:52:00Z", "commit": {"oid": "87949d10b95094e6470559b95b99ddd155ff4062"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMTo1MjowMFrOFpk09g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMTo1NjoxMlrOFpk8og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEzOTMxOA==", "bodyText": "I don't think we need this statement here. in processServerError method, it already returns AmbryUnavailable for Disk_Unavailable. All we need is to change TrackedRequestFinalState.fromRouterErrorCodeToFinalState method.", "url": "https://github.com/linkedin/ambry/pull/1378#discussion_r379139318", "createdAt": "2020-02-13T21:52:00Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-router/src/main/java/com.github.ambry.router/DeleteOperation.java", "diffHunk": "@@ -195,25 +195,33 @@ void handleResponse(ResponseInfo responseInfo, DeleteResponse deleteResponse) {\n               new RouterException(\"Received wrong response that is not for the corresponding request.\",\n                   RouterErrorCode.UnexpectedInternalError));\n         } else {\n-          ServerErrorCode getError = deleteResponse.getError();\n-          if (getError == ServerErrorCode.No_Error || getError == ServerErrorCode.Blob_Deleted) {\n+          ServerErrorCode serverError = deleteResponse.getError();\n+          if (serverError == ServerErrorCode.No_Error || serverError == ServerErrorCode.Blob_Deleted) {\n             operationTracker.onResponse(replica, TrackedRequestFinalState.SUCCESS);\n             if (RouterUtils.isRemoteReplica(routerConfig, replica)) {\n               logger.trace(\"Cross colo request successful for remote replica {} in {} \", replica.getDataNodeId(),\n                   replica.getDataNodeId().getDatacenterName());\n               routerMetrics.crossColoSuccessCount.inc();\n             }\n+          } else if (serverError == ServerErrorCode.Disk_Unavailable) {\n+            logger.trace(\"Replica {} returned Disk_Unavailable for a delete request with correlationId : {} \", replica,\n+                deleteRequest.getCorrelationId());\n+            operationTracker.onResponse(replica, TrackedRequestFinalState.DISK_DOWN);\n+            setOperationException(\n+                new RouterException(\"Server returned: \" + serverError, RouterErrorCode.AmbryUnavailable));\n+            routerMetrics.routerRequestErrorCount.inc();\n+            routerMetrics.getDataNodeBasedMetrics(replica.getDataNodeId()).deleteRequestErrorCount.inc();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87949d10b95094e6470559b95b99ddd155ff4062"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE0MDA4MA==", "bodyText": "same as above.", "url": "https://github.com/linkedin/ambry/pull/1378#discussion_r379140080", "createdAt": "2020-02-13T21:53:35Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-router/src/main/java/com.github.ambry.router/GetBlobInfoOperation.java", "diffHunk": "@@ -296,16 +296,24 @@ private void processGetBlobInfoResponse(GetRequestInfo getRequestInfo, GetRespon\n           logger.trace(\"Replica  {} returned error {} with response correlationId {} \",\n               getRequestInfo.replicaId.getDataNodeId(), getError, getResponse.getCorrelationId());\n           RouterErrorCode routerErrorCode = processServerError(getError);\n-          if (getError == ServerErrorCode.Blob_Deleted || getError == ServerErrorCode.Blob_Expired\n-              || getError == ServerErrorCode.Blob_Authorization_Failure) {\n-            // this is a successful response and one that completes the operation regardless of whether the\n-            // success target has been reached or not.\n-            operationCompleted = true;\n+          if (getError == ServerErrorCode.Disk_Unavailable) {\n+            operationTracker.onResponse(getRequestInfo.replicaId, TrackedRequestFinalState.DISK_DOWN);\n+            setOperationException(new RouterException(\"Server returned: \" + getError, routerErrorCode));\n+            routerMetrics.routerRequestErrorCount.inc();\n+            routerMetrics.getDataNodeBasedMetrics(getRequestInfo.replicaId.getDataNodeId()).getBlobInfoRequestErrorCount\n+                .inc();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87949d10b95094e6470559b95b99ddd155ff4062"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE0MDUzOQ==", "bodyText": "same as above", "url": "https://github.com/linkedin/ambry/pull/1378#discussion_r379140539", "createdAt": "2020-02-13T21:54:34Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-router/src/main/java/com.github.ambry.router/GetBlobOperation.java", "diffHunk": "@@ -939,17 +938,25 @@ private void processGetBlobResponse(GetRequestInfo getRequestInfo, GetResponse g\n           } else {\n             // process and set the most relevant exception.\n             RouterErrorCode routerErrorCode = processServerError(getError);\n-            if (getError == ServerErrorCode.Blob_Deleted || getError == ServerErrorCode.Blob_Expired\n-                || getError == ServerErrorCode.Blob_Authorization_Failure) {\n-              // this is a successful response and one that completes the operation regardless of whether the\n-              // success target has been reached or not.\n-              chunkCompleted = true;\n-              chunkException = buildChunkException(\"Server returned: \" + getError, routerErrorCode);\n+            if (getError == ServerErrorCode.Disk_Unavailable) {\n+              chunkOperationTracker.onResponse(getRequestInfo.replicaId, TrackedRequestFinalState.DISK_DOWN);\n+              setChunkException(buildChunkException(\"Server returned: \" + getError, routerErrorCode));\n+              routerMetrics.routerRequestErrorCount.inc();\n+              routerMetrics.getDataNodeBasedMetrics(\n+                  getRequestInfo.replicaId.getDataNodeId()).getRequestErrorCount.inc();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87949d10b95094e6470559b95b99ddd155ff4062"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE0MTI4Mg==", "bodyText": "same as above", "url": "https://github.com/linkedin/ambry/pull/1378#discussion_r379141282", "createdAt": "2020-02-13T21:56:12Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-router/src/main/java/com.github.ambry.router/TtlUpdateOperation.java", "diffHunk": "@@ -188,26 +188,34 @@ void handleResponse(ResponseInfo responseInfo, TtlUpdateResponse ttlUpdateRespon\n               new RouterException(\"Received wrong response that is not for the corresponding request.\",\n                   RouterErrorCode.UnexpectedInternalError));\n         } else {\n-          ServerErrorCode getError = ttlUpdateResponse.getError();\n-          if (getError == ServerErrorCode.No_Error || getError == ServerErrorCode.Blob_Already_Updated) {\n+          ServerErrorCode serverError = ttlUpdateResponse.getError();\n+          if (serverError == ServerErrorCode.No_Error || serverError == ServerErrorCode.Blob_Already_Updated) {\n             operationTracker.onResponse(replica, TrackedRequestFinalState.SUCCESS);\n             if (RouterUtils.isRemoteReplica(routerConfig, replica)) {\n               LOGGER.trace(\"Cross colo request successful for remote replica {} in {} \", replica.getDataNodeId(),\n                   replica.getDataNodeId().getDatacenterName());\n               routerMetrics.crossColoSuccessCount.inc();\n             }\n+          } else if (serverError == ServerErrorCode.Disk_Unavailable) {\n+            LOGGER.debug(\n+                \"Replica {} returned Disk_Unavailable for a Ttl update request with response correlationId : {} \",\n+                replica.getDataNodeId(), ttlUpdateResponse.getCorrelationId());\n+            operationTracker.onResponse(replica, TrackedRequestFinalState.DISK_DOWN);\n+            setOperationException(\n+                new RouterException(\"Server returned: \" + serverError, RouterErrorCode.AmbryUnavailable));\n+            routerMetrics.getDataNodeBasedMetrics(replica.getDataNodeId()).ttlUpdateRequestErrorCount.inc();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87949d10b95094e6470559b95b99ddd155ff4062"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MTA3ODMx", "url": "https://github.com/linkedin/ambry/pull/1378#pullrequestreview-359107831", "createdAt": "2020-02-14T17:38:45Z", "commit": {"oid": "87949d10b95094e6470559b95b99ddd155ff4062"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a21147bc8d59a1077874ff70224d4d96f16c16b9", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/a21147bc8d59a1077874ff70224d4d96f16c16b9", "committedDate": "2020-02-18T21:45:05Z", "message": "Improve FailOnNotFound by accounting for disk down and cross-colo NotFound\n\nCurrent operation tracker supports terminating when at least two\nNotFound occur in originating DC. Such strategy is not able to\nhandle edge case where originating DC replicas return Disk_Unavailable,\nDeleted and NotFound separately. Even though rest remote replicas\nall return NotFound, the operation still returns AmbryUnavailable\nwhich makes client keep retrying. This PR improve FailOnNotFound logic\nby accounting for number of Disk_Unavailable and NotFound across all\ndcs. It adds additional check in hasFailedOnNotFound to correctly return\n404 reminding client the blob is no longer present. This is helpful when\nclient attempts to delete some blobs which have expired and been compacted\nbut encounters Disk_Unavailable during delete operation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf3f03a26969eceeaf1b8776d534c5361a5cbd49", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/bf3f03a26969eceeaf1b8776d534c5361a5cbd49", "committedDate": "2020-02-18T21:45:05Z", "message": "fix test failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "717144ab908ec85a367f02568347771726f6dc8b", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/717144ab908ec85a367f02568347771726f6dc8b", "committedDate": "2020-02-18T21:45:05Z", "message": "make get operation adopt similar strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5885cc7dc9e035b1e43f05ac1b691926b14dc325", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/5885cc7dc9e035b1e43f05ac1b691926b14dc325", "committedDate": "2020-02-18T21:51:37Z", "message": "improve test coverage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87949d10b95094e6470559b95b99ddd155ff4062", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/87949d10b95094e6470559b95b99ddd155ff4062", "committedDate": "2020-02-11T20:56:21Z", "message": "improve test coverage"}, "afterCommit": {"oid": "5885cc7dc9e035b1e43f05ac1b691926b14dc325", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/5885cc7dc9e035b1e43f05ac1b691926b14dc325", "committedDate": "2020-02-18T21:51:37Z", "message": "improve test coverage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMzkwNTYy", "url": "https://github.com/linkedin/ambry/pull/1378#pullrequestreview-361390562", "createdAt": "2020-02-19T19:52:27Z", "commit": {"oid": "5885cc7dc9e035b1e43f05ac1b691926b14dc325"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1601, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}