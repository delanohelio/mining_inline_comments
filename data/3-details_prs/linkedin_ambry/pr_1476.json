{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0Njc5NDU5", "number": 1476, "title": "Command line tool to reset replica tokens in Azure", "bodyText": "", "createdAt": "2020-04-16T20:06:10Z", "url": "https://github.com/linkedin/ambry/pull/1476", "merged": true, "mergeCommit": {"oid": "0b646cd4021980b9d7b49b24c1d88f4bbca00d61"}, "closed": true, "closedAt": "2020-05-27T16:34:31Z", "author": {"login": "lightningrob"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYSLAvgH2gAyNDA0Njc5NDU5OjZlZWM3NjYxZGU3M2Q0NmI4N2ZlYjEzMzE0NDZkZWJiN2Y1NWMwYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclb4cTAFqTQxOTQwMzIxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6eec7661de73d46b87feb1331446debb7f55c0a9", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/6eec7661de73d46b87feb1331446debb7f55c0a9", "committedDate": "2020-04-16T19:50:35Z", "message": "Command line tool to reset replica tokens in Azure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NzczMzcy", "url": "https://github.com/linkedin/ambry/pull/1476#pullrequestreview-396773372", "createdAt": "2020-04-20T20:06:19Z", "commit": {"oid": "6eec7661de73d46b87feb1331446debb7f55c0a9"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMDowNjoxOVrOGIlhGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMDoyMToyMVrOGImDYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY1NjQ3Mg==", "bodyText": "Maybe we can either remove Default from here, or change it to empty string.", "url": "https://github.com/linkedin/ambry/pull/1476#discussion_r411656472", "createdAt": "2020-04-20T20:06:19Z", "author": {"login": "ankagrawal"}, "path": "ambry-api/src/main/java/com/github/ambry/config/ClusterMapConfig.java", "diffHunk": "@@ -128,25 +133,25 @@\n   /**\n    * The name of the associated cluster for this node.\n    */\n-  @Config(\"clustermap.cluster.name\")\n+  @Config(CLUSTERMAP_CLUSTER_NAME)\n   public final String clusterMapClusterName;\n \n   /**\n    * The name of the associated datacenter for this node.\n    */\n-  @Config(\"clustermap.datacenter.name\")\n+  @Config(CLUSTERMAP_DATACENTER_NAME)\n   public final String clusterMapDatacenterName;\n \n   /**\n    * The host name associated with this node.\n    */\n-  @Config(\"clustermap.host.name\")\n+  @Config(CLUSTERMAP_HOST_NAME)\n   public final String clusterMapHostName;\n \n   /**\n    * The port number associated with this node.\n    */\n-  @Config(\"clustermap.port\")\n+  @Config(CLUSTERMAP_PORT)\n   @Default(\"null\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eec7661de73d46b87feb1331446debb7f55c0a9"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY1NzQ4MA==", "bodyText": "javadocs.", "url": "https://github.com/linkedin/ambry/pull/1476#discussion_r411657480", "createdAt": "2020-04-20T20:08:02Z", "author": {"login": "ankagrawal"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/azure/AzureBlobDataAccessor.java", "diffHunk": "@@ -129,6 +129,10 @@\n     batchTimeout = null;\n   }\n \n+  public BlobServiceClient getStorageClient() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eec7661de73d46b87feb1331446debb7f55c0a9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY2Mzk4Ng==", "bodyText": "Nit: Not sure about how we maintain javadocs for tools. But if we maintain it like prod code, then we might need javadocs for methods in this class.", "url": "https://github.com/linkedin/ambry/pull/1476#discussion_r411663986", "createdAt": "2020-04-20T20:19:07Z", "author": {"login": "ankagrawal"}, "path": "ambry-tools/src/main/java/com/github/ambry/tools/admin/AzureTokenResetTool.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.tools.admin;\n+\n+import com.azure.storage.blob.BlobServiceClient;\n+import com.azure.storage.blob.models.BlobStorageException;\n+import com.azure.storage.blob.models.ListBlobContainersOptions;\n+import com.azure.storage.blob.specialized.BlockBlobClient;\n+import com.codahale.metrics.MetricRegistry;\n+import com.github.ambry.cloud.azure.AzureBlobDataAccessor;\n+import com.github.ambry.cloud.azure.AzureBlobLayoutStrategy;\n+import com.github.ambry.cloud.azure.AzureCloudConfig;\n+import com.github.ambry.cloud.azure.AzureMetrics;\n+import com.github.ambry.config.CloudConfig;\n+import com.github.ambry.config.ClusterMapConfig;\n+import com.github.ambry.config.ReplicationConfig;\n+import com.github.ambry.config.VerifiableProperties;\n+import com.github.ambry.tools.util.ToolUtils;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * Utility to delete the replica tokens for all partitions.\n+ * Very dangerous tool.  Please know what you're doing and wear a hard hat at all times.\n+ * Required properties:\n+ *  - \"azure.storage.connection.string\" for the storage account.\n+ *  - \"cosmos.endpoint\", \"cosmos.collection.link\", \"cosmos.key\" (set to any nonempty value)\n+ *  - \"clustermap.cluster.name\" used to restrict blob container name search (e.g. \"main-123\")\n+ * Optional properties:\n+ *  - \"vcr.proxy.host\" name of the proxy host to tunnel through.\n+ *  - \"azure.blob.container.strategy\" if the account is sharded by container instead of partition.\n+ */\n+public class AzureTokenResetTool {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(AzureTokenResetTool.class);\n+  private static BlobServiceClient storageClient;\n+\n+  public static void main(String[] args) {\n+    String commandName = AzureTokenResetTool.class.getSimpleName();\n+    try {\n+      VerifiableProperties verifiableProperties = ToolUtils.getVerifiableProperties(args);\n+      String clusterName = verifiableProperties.getString(ClusterMapConfig.CLUSTERMAP_CLUSTER_NAME);\n+      CloudConfig cloudConfig = new CloudConfig(verifiableProperties);\n+      AzureCloudConfig azureCloudConfig = new AzureCloudConfig(verifiableProperties);\n+      AzureMetrics azureMetrics = new AzureMetrics(new MetricRegistry());\n+      AzureBlobLayoutStrategy blobLayoutStrategy = new AzureBlobLayoutStrategy(clusterName, azureCloudConfig);\n+      AzureBlobDataAccessor dataAccessor =\n+          new AzureBlobDataAccessor(cloudConfig, azureCloudConfig, blobLayoutStrategy, azureMetrics);\n+      storageClient = dataAccessor.getStorageClient();\n+\n+      int tokensDeleted = resetTokens(clusterName);\n+      logger.info(\"Deleted tokens for {} partitions\", tokensDeleted);\n+    } catch (Exception ex) {\n+      ex.printStackTrace();\n+      logger.error(\"Command {} failed\", commandName, ex);\n+      System.exit(1);\n+    }\n+  }\n+\n+  // Reset the offset token by deleting the blob from the container", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eec7661de73d46b87feb1331446debb7f55c0a9"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY2NTI0OA==", "bodyText": "Curious as to why we need AtomicInteger here? Does forEachRemaining for PagedIterable's returned by listBlobContainers, return a parallel stream?", "url": "https://github.com/linkedin/ambry/pull/1476#discussion_r411665248", "createdAt": "2020-04-20T20:21:21Z", "author": {"login": "ankagrawal"}, "path": "ambry-tools/src/main/java/com/github/ambry/tools/admin/AzureTokenResetTool.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.tools.admin;\n+\n+import com.azure.storage.blob.BlobServiceClient;\n+import com.azure.storage.blob.models.BlobStorageException;\n+import com.azure.storage.blob.models.ListBlobContainersOptions;\n+import com.azure.storage.blob.specialized.BlockBlobClient;\n+import com.codahale.metrics.MetricRegistry;\n+import com.github.ambry.cloud.azure.AzureBlobDataAccessor;\n+import com.github.ambry.cloud.azure.AzureBlobLayoutStrategy;\n+import com.github.ambry.cloud.azure.AzureCloudConfig;\n+import com.github.ambry.cloud.azure.AzureMetrics;\n+import com.github.ambry.config.CloudConfig;\n+import com.github.ambry.config.ClusterMapConfig;\n+import com.github.ambry.config.ReplicationConfig;\n+import com.github.ambry.config.VerifiableProperties;\n+import com.github.ambry.tools.util.ToolUtils;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+/**\n+ * Utility to delete the replica tokens for all partitions.\n+ * Very dangerous tool.  Please know what you're doing and wear a hard hat at all times.\n+ * Required properties:\n+ *  - \"azure.storage.connection.string\" for the storage account.\n+ *  - \"cosmos.endpoint\", \"cosmos.collection.link\", \"cosmos.key\" (set to any nonempty value)\n+ *  - \"clustermap.cluster.name\" used to restrict blob container name search (e.g. \"main-123\")\n+ * Optional properties:\n+ *  - \"vcr.proxy.host\" name of the proxy host to tunnel through.\n+ *  - \"azure.blob.container.strategy\" if the account is sharded by container instead of partition.\n+ */\n+public class AzureTokenResetTool {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(AzureTokenResetTool.class);\n+  private static BlobServiceClient storageClient;\n+\n+  public static void main(String[] args) {\n+    String commandName = AzureTokenResetTool.class.getSimpleName();\n+    try {\n+      VerifiableProperties verifiableProperties = ToolUtils.getVerifiableProperties(args);\n+      String clusterName = verifiableProperties.getString(ClusterMapConfig.CLUSTERMAP_CLUSTER_NAME);\n+      CloudConfig cloudConfig = new CloudConfig(verifiableProperties);\n+      AzureCloudConfig azureCloudConfig = new AzureCloudConfig(verifiableProperties);\n+      AzureMetrics azureMetrics = new AzureMetrics(new MetricRegistry());\n+      AzureBlobLayoutStrategy blobLayoutStrategy = new AzureBlobLayoutStrategy(clusterName, azureCloudConfig);\n+      AzureBlobDataAccessor dataAccessor =\n+          new AzureBlobDataAccessor(cloudConfig, azureCloudConfig, blobLayoutStrategy, azureMetrics);\n+      storageClient = dataAccessor.getStorageClient();\n+\n+      int tokensDeleted = resetTokens(clusterName);\n+      logger.info(\"Deleted tokens for {} partitions\", tokensDeleted);\n+    } catch (Exception ex) {\n+      ex.printStackTrace();\n+      logger.error(\"Command {} failed\", commandName, ex);\n+      System.exit(1);\n+    }\n+  }\n+\n+  // Reset the offset token by deleting the blob from the container\n+  public static int resetTokens(String containerPrefix) throws BlobStorageException {\n+    AtomicInteger tokensDeleted = new AtomicInteger(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eec7661de73d46b87feb1331446debb7f55c0a9"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMzExOTcx", "url": "https://github.com/linkedin/ambry/pull/1476#pullrequestreview-401311971", "createdAt": "2020-04-27T20:45:03Z", "commit": {"oid": "6eec7661de73d46b87feb1331446debb7f55c0a9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMDo0NTowM1rOGM24vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMDo0NTowM1rOGM24vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjEzNTM1OA==", "bodyText": "minor: in future PR, we can replace all config names with string constants (like what you did in this PR to make them consistent)", "url": "https://github.com/linkedin/ambry/pull/1476#discussion_r416135358", "createdAt": "2020-04-27T20:45:03Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/config/ClusterMapConfig.java", "diffHunk": "@@ -282,10 +287,10 @@ public ClusterMapConfig(VerifiableProperties verifiableProperties) {\n     clusterMapClusterChangeHandlerType =\n         verifiableProperties.getString(\"clustermap.cluster.change.handler.type\", \"SimpleClusterChangeHandler\");\n     clusterMapDcsZkConnectStrings = verifiableProperties.getString(\"clustermap.dcs.zk.connect.strings\", \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eec7661de73d46b87feb1331446debb7f55c0a9"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ee25c4b20656048099144653595a94e9a72a45e", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/7ee25c4b20656048099144653595a94e9a72a45e", "committedDate": "2020-04-28T02:47:42Z", "message": "Add javadocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NDAzMjEx", "url": "https://github.com/linkedin/ambry/pull/1476#pullrequestreview-419403211", "createdAt": "2020-05-27T16:30:22Z", "commit": {"oid": "7ee25c4b20656048099144653595a94e9a72a45e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1399, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}