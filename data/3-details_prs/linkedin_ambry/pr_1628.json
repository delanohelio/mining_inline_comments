{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNzA4MDIx", "number": 1628, "title": "[Container API] Introducing create/update container APIs in AccountService", "bodyText": "When number of containers in single account keeps growing, it becomes expensive to transmit whole account\nto clients, edit on client side and send it back. This PR introduces some container management APIs (prototype)\nto help create/update container within frontend to avoid unnecessary transmission overhead. Also, this PR\nincorporates the logic to generate container id.\nThe addContainer implementation in HelixAccountService will be called by PostAccountsHandler in future PR.", "createdAt": "2020-09-22T05:55:58Z", "url": "https://github.com/linkedin/ambry/pull/1628", "merged": true, "mergeCommit": {"oid": "8d2cb01516b7deb85afb83ec1d9aaf0bb686282d"}, "closed": true, "closedAt": "2020-09-24T19:14:27Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLef03gH2gAyNDkwNzA4MDIxOjYxMzU0YTk1NWIxZDM3MDIyZDQ3MDE3ODM1ZDNlYTdjZWNkZDIxYzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMFROcAFqTQ5NTgzMTI5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "61354a955b1d37022d47017835d3ea7cecdd21c7", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/61354a955b1d37022d47017835d3ea7cecdd21c7", "committedDate": "2020-09-22T21:02:19Z", "message": "[Container API] Introducing create/update container APIs in AccountService\n\nWhen number of containers in single account keeps growing, it becomes expensive to transmit whole account\nto clients, edit on client side and send it back. This PR introduces some container management APIs (prototype)\nto help create/update container within frontend to avoid unnecessary transmission overhead. Also, this PR\nincorprates the logic to generate container id."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19408a0d3a69854e1e869da8690f7f85086038fb", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/19408a0d3a69854e1e869da8690f7f85086038fb", "committedDate": "2020-09-22T05:53:12Z", "message": "[Container API] Introducing create/update container APIs in AccountService\n\nWhen number of containers in single account keeps growing, it becomes expensive to transmit whole account\nto clients, edit on client side and send it back. This PR introduces some container management APIs (prototype)\nto help create/update container within frontend to avoid unnecessary transmission overhead. Also, this PR\nincorprates the logic to generate container id."}, "afterCommit": {"oid": "61354a955b1d37022d47017835d3ea7cecdd21c7", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/61354a955b1d37022d47017835d3ea7cecdd21c7", "committedDate": "2020-09-22T21:02:19Z", "message": "[Container API] Introducing create/update container APIs in AccountService\n\nWhen number of containers in single account keeps growing, it becomes expensive to transmit whole account\nto clients, edit on client side and send it back. This PR introduces some container management APIs (prototype)\nto help create/update container within frontend to avoid unnecessary transmission overhead. Also, this PR\nincorprates the logic to generate container id."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODYzMzEy", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-493863312", "createdAt": "2020-09-22T21:34:09Z", "commit": {"oid": "61354a955b1d37022d47017835d3ea7cecdd21c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMTozNDoxMFrOHWNMIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMTozNDoxMFrOHWNMIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0NjgxOQ==", "bodyText": "These two methods are added for initial review (we can discuss what signature is acceptable). I can remove them after review is done.", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r493046819", "createdAt": "2020-09-22T21:34:10Z", "author": {"login": "jsjtzyy"}, "path": "ambry-api/src/main/java/com/github/ambry/account/AccountService.java", "diffHunk": "@@ -107,6 +108,36 @@\n    */\n   public boolean removeAccountUpdateConsumer(Consumer<Collection<Account>> accountUpdateConsumer);\n \n+  /**\n+   * Add a new container to an existing account.\n+   * @param accountName the name of account in which new container will be added.\n+   * @param newContainer the new container to add.\n+   * @return a pair of account id and container id strings associated with existing account and new container.\n+   */\n+  default Pair<String, String> addContainer(String accountName, Container newContainer) {\n+    throw new UnsupportedOperationException(\"This method is not supported\");\n+  }\n+\n+  /**\n+   * Update attributes of an existing container.\n+   * @param accountName the name of account which container belongs to.\n+   * @param updatedContainer the updated {@link Container} used to replace current one.\n+   * @return {@code true} if container is successfully updated. {@code false} otherwise.\n+   */\n+  default boolean updateContainer(String accountName, Container updatedContainer) {\n+    throw new UnsupportedOperationException(\"This method is not supported\");\n+  }\n+\n+  /**\n+   * Get an existing container from a given account.\n+   * @param accountName the name of account which container belongs to.\n+   * @param containerId the id of container to get.\n+   * @return the requested {@link Container} object or null if not present.\n+   */\n+  default Container getContainer(String accountName, String containerId) {\n+    throw new UnsupportedOperationException(\"This method is not supported\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61354a955b1d37022d47017835d3ea7cecdd21c7"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODc5MjM5", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-493879239", "createdAt": "2020-09-22T22:05:07Z", "commit": {"oid": "61354a955b1d37022d47017835d3ea7cecdd21c7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjowNTowN1rOHWOADg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMjozMzoxOVrOHWOpfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2MDExMA==", "bodyText": "Probably can omit this file from the PR.", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r493060110", "createdAt": "2020-09-22T22:05:07Z", "author": {"login": "lightningrob"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/PostAccountsHandler.java", "diffHunk": "@@ -17,6 +17,7 @@\n import com.github.ambry.account.Account;\n import com.github.ambry.account.AccountCollectionSerde;\n import com.github.ambry.account.AccountService;\n+import com.github.ambry.commons.Callback;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61354a955b1d37022d47017835d3ea7cecdd21c7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2MjQyMg==", "bodyText": "This is tricky since \"editable\" concept is not well defined in OS ambry.\nAlso, should make this instance method taking only one Container argument to compare.", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r493062422", "createdAt": "2020-09-22T22:11:11Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/account/Container.java", "diffHunk": "@@ -476,6 +480,24 @@ public static void setCurrentJsonVersion(short currentJsonVersion) {\n     Container.currentJsonVersion = currentJsonVersion;\n   }\n \n+  /**\n+   * Check if two containers' editable fields are same.\n+   * @param container1 the {@link Container} to compare.\n+   * @param container2 the {@link Container} to compare.\n+   * @return {@code true} if two containers are equivalent in terms of editable fields. {@code false} otherwise.\n+   */\n+  public static boolean containerEditableFieldsAreSame(Container container1, Container container2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61354a955b1d37022d47017835d3ea7cecdd21c7"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2MzMxOQ==", "bodyText": "This can be confusing to someone who is only aware of OS ambry.", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r493063319", "createdAt": "2020-09-22T22:13:32Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/account/Container.java", "diffHunk": "@@ -84,6 +84,7 @@\n   static final boolean CACHEABLE_DEFAULT_VALUE = true;\n   static final Set<String> CONTENT_TYPE_WHITELIST_FOR_FILENAMES_ON_DOWNLOAD_DEFAULT_VALUE = Collections.emptySet();\n \n+  public static final short CONTAINER_ID_START_RANGE = 8;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61354a955b1d37022d47017835d3ea7cecdd21c7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2OTY1MQ==", "bodyText": "This entire method is generic except for the line that updates the underlying store.  Can we move it to the base class?  Maybe AccountService can also have a method like getMetadataStore().", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r493069651", "createdAt": "2020-09-22T22:30:24Z", "author": {"login": "lightningrob"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -246,6 +250,69 @@ public boolean updateAccounts(Collection<Account> accounts) {\n     return updateAccountsWithAccountMetadataStore(accounts, accountMetadataStore);\n   }\n \n+  /**\n+   * {@inheritDoc}\n+   */\n+  @Override\n+  public Pair<String, String> addContainer(String accountName, Container newContainer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61354a955b1d37022d47017835d3ea7cecdd21c7"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA3MDcxNw==", "bodyText": "It seems strange to have accountName and containerId in same signature.", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r493070717", "createdAt": "2020-09-22T22:33:19Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/account/AccountService.java", "diffHunk": "@@ -107,6 +108,36 @@\n    */\n   public boolean removeAccountUpdateConsumer(Consumer<Collection<Account>> accountUpdateConsumer);\n \n+  /**\n+   * Add a new container to an existing account.\n+   * @param accountName the name of account in which new container will be added.\n+   * @param newContainer the new container to add.\n+   * @return a pair of account id and container id strings associated with existing account and new container.\n+   */\n+  default Pair<String, String> addContainer(String accountName, Container newContainer) {\n+    throw new UnsupportedOperationException(\"This method is not supported\");\n+  }\n+\n+  /**\n+   * Update attributes of an existing container.\n+   * @param accountName the name of account which container belongs to.\n+   * @param updatedContainer the updated {@link Container} used to replace current one.\n+   * @return {@code true} if container is successfully updated. {@code false} otherwise.\n+   */\n+  default boolean updateContainer(String accountName, Container updatedContainer) {\n+    throw new UnsupportedOperationException(\"This method is not supported\");\n+  }\n+\n+  /**\n+   * Get an existing container from a given account.\n+   * @param accountName the name of account which container belongs to.\n+   * @param containerId the id of container to get.\n+   * @return the requested {@link Container} object or null if not present.\n+   */\n+  default Container getContainer(String accountName, String containerId) {\n+    throw new UnsupportedOperationException(\"This method is not supported\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0NjgxOQ=="}, "originalCommit": {"oid": "61354a955b1d37022d47017835d3ea7cecdd21c7"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8234e62e08b5ef9cebdd36e28af9e624e31b014b", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/8234e62e08b5ef9cebdd36e28af9e624e31b014b", "committedDate": "2020-09-23T04:34:44Z", "message": "comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODM5MjMx", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-494839231", "createdAt": "2020-09-23T16:27:22Z", "commit": {"oid": "8234e62e08b5ef9cebdd36e28af9e624e31b014b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNjoyNzoyMlrOHW2xnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNjoyNzoyMlrOHW2xnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzcyODE1Nw==", "bodyText": "Why are the numerical IDs returned as a pair of strings instead of Pair<Short, Short>?", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r493728157", "createdAt": "2020-09-23T16:27:22Z", "author": {"login": "cgtz"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -246,6 +250,69 @@ public boolean updateAccounts(Collection<Account> accounts) {\n     return updateAccountsWithAccountMetadataStore(accounts, accountMetadataStore);\n   }\n \n+  /**\n+   * {@inheritDoc}\n+   */\n+  @Override\n+  public Pair<String, String> addContainer(String accountName, Container newContainer) {\n+    checkOpen();\n+    if (accountName == null || accountName.isEmpty() || newContainer == null || newContainer.getName() == null\n+        || newContainer.getName().isEmpty()) {\n+      logger.error(\"Account name: {} or container: {} is invalid\", accountName, newContainer);\n+      throw new IllegalArgumentException(\"Account or container name is null or empty\");\n+    }\n+    Account account = getAccountByName(accountName);\n+    if (account == null) {\n+      logger.error(\"Account {} is not found\", accountName);\n+      throw new IllegalArgumentException(\"Account \" + accountName + \" is not found\");\n+    }\n+    String accountId = String.valueOf(account.getId());\n+    for (Container container : account.getAllContainers()) {\n+      // make sure there is no conflict container (conflict means a container with same name but different attributes already exists).\n+      if (container.getName().equals(newContainer.getName())) {\n+        if (containerEditableFieldsAreSame(container, newContainer)) {\n+          // If an exactly same container already exists, we directly return its id. Adding same container multiple times\n+          // should be no-op.\n+          return new Pair<>(accountId, String.valueOf(container.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8234e62e08b5ef9cebdd36e28af9e624e31b014b"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODQyNDMx", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-494842431", "createdAt": "2020-09-23T16:30:46Z", "commit": {"oid": "8234e62e08b5ef9cebdd36e28af9e624e31b014b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNjozMDo0NlrOHW26YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNjozMDo0NlrOHW26YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczMDQwMA==", "bodyText": "ContainerBuilder has a copy constructor, could we use that here?", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r493730400", "createdAt": "2020-09-23T16:30:46Z", "author": {"login": "cgtz"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -246,6 +250,69 @@ public boolean updateAccounts(Collection<Account> accounts) {\n     return updateAccountsWithAccountMetadataStore(accounts, accountMetadataStore);\n   }\n \n+  /**\n+   * {@inheritDoc}\n+   */\n+  @Override\n+  public Pair<String, String> addContainer(String accountName, Container newContainer) {\n+    checkOpen();\n+    if (accountName == null || accountName.isEmpty() || newContainer == null || newContainer.getName() == null\n+        || newContainer.getName().isEmpty()) {\n+      logger.error(\"Account name: {} or container: {} is invalid\", accountName, newContainer);\n+      throw new IllegalArgumentException(\"Account or container name is null or empty\");\n+    }\n+    Account account = getAccountByName(accountName);\n+    if (account == null) {\n+      logger.error(\"Account {} is not found\", accountName);\n+      throw new IllegalArgumentException(\"Account \" + accountName + \" is not found\");\n+    }\n+    String accountId = String.valueOf(account.getId());\n+    for (Container container : account.getAllContainers()) {\n+      // make sure there is no conflict container (conflict means a container with same name but different attributes already exists).\n+      if (container.getName().equals(newContainer.getName())) {\n+        if (containerEditableFieldsAreSame(container, newContainer)) {\n+          // If an exactly same container already exists, we directly return its id. Adding same container multiple times\n+          // should be no-op.\n+          return new Pair<>(accountId, String.valueOf(container.getId()));\n+        } else {\n+          logger.error(\"A container: {} already exists with different attributes\", container.getName());\n+          throw new IllegalArgumentException(\"There is a conflicting container in account \" + accountName);\n+        }\n+      }\n+    }\n+    // if code reaches here, it means no duplicate container in this account\n+    // generate container id for new container\n+    short nextContainerId = account.getAllContainers()\n+        .stream()\n+        .map(Container::getId)\n+        .max(Short::compareTo)\n+        .map(maxId -> (short) (maxId + 1))\n+        .orElse(CONTAINER_ID_START_RANGE);\n+    // construct a container based on input container and next containerId\n+    Container containerToAdd = new ContainerBuilder(nextContainerId, newContainer.getName(), newContainer.getStatus(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8234e62e08b5ef9cebdd36e28af9e624e31b014b"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa22af1731edac9ce0457015ddb1a17c9f1be9ce", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/aa22af1731edac9ce0457015ddb1a17c9f1be9ce", "committedDate": "2020-09-23T16:49:58Z", "message": "address Casey's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTM3NDkx", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-494937491", "createdAt": "2020-09-23T18:33:47Z", "commit": {"oid": "aa22af1731edac9ce0457015ddb1a17c9f1be9ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODozMzo0N1rOHW7cWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODozMzo0N1rOHW7cWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgwNDYzMw==", "bodyText": "The PostAccountsHandler will have method updateContainers that takes a collection of (new or updated) containers in the payload.  Would it make more sense to mirror that in this interface?  Otherwise the handler will need to get the existing containers, compare with the input and call add() and update() as appropriate.  Which may be okay.  But the MySqlAccountService should ideally make all the updates in a single transaction (in case multiple containers are added/updated).", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r493804633", "createdAt": "2020-09-23T18:33:47Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/account/AccountService.java", "diffHunk": "@@ -107,6 +108,36 @@\n    */\n   public boolean removeAccountUpdateConsumer(Consumer<Collection<Account>> accountUpdateConsumer);\n \n+  /**\n+   * Add a new container to an existing account.\n+   * @param accountName the name of account in which new container will be added.\n+   * @param newContainer the new container to add.\n+   * @return a pair of account id and container id strings associated with existing account and new container.\n+   */\n+  default Pair<String, String> addContainer(String accountName, Container newContainer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa22af1731edac9ce0457015ddb1a17c9f1be9ce"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MDcxNTk1", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-495071595", "createdAt": "2020-09-23T21:46:03Z", "commit": {"oid": "aa22af1731edac9ce0457015ddb1a17c9f1be9ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMTo0NjowM1rOHXCGfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMTo0NjowM1rOHXCGfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkxMzcyNQ==", "bodyText": "How about calling this updateContainers (plural) and accepting a collection of containers?", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r493913725", "createdAt": "2020-09-23T21:46:03Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/account/AccountService.java", "diffHunk": "@@ -107,6 +108,36 @@\n    */\n   public boolean removeAccountUpdateConsumer(Consumer<Collection<Account>> accountUpdateConsumer);\n \n+  /**\n+   * Add a new container to an existing account.\n+   * @param accountName the name of account in which new container will be added.\n+   * @param newContainer the new container to add.\n+   * @return a pair of account id and container id strings associated with existing account and new container.\n+   */\n+  default Pair<String, String> addContainer(String accountName, Container newContainer) {\n+    throw new UnsupportedOperationException(\"This method is not supported\");\n+  }\n+\n+  /**\n+   * Update attributes of an existing container.\n+   * @param accountName the name of account which container belongs to.\n+   * @param updatedContainer the updated {@link Container} used to replace current one.\n+   * @return {@code true} if container is successfully updated. {@code false} otherwise.\n+   */\n+  default boolean updateContainer(String accountName, Container updatedContainer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa22af1731edac9ce0457015ddb1a17c9f1be9ce"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43477f8a06f88f955f59d526f086dbb8214560d5", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/43477f8a06f88f955f59d526f086dbb8214560d5", "committedDate": "2020-09-24T04:40:14Z", "message": "Address Rob's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjI5NzIz", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-495229723", "createdAt": "2020-09-24T05:29:30Z", "commit": {"oid": "43477f8a06f88f955f59d526f086dbb8214560d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNToyOTozMFrOHXKQHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNToyOTozMFrOHXKQHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA0NzI2MQ==", "bodyText": "May be we can make it O(n) by storing existing container names in hash set?", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r494047261", "createdAt": "2020-09-24T05:29:30Z", "author": {"login": "Arun-LinkedIn"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -253,56 +253,62 @@ public boolean updateAccounts(Collection<Account> accounts) {\n    * {@inheritDoc}\n    */\n   @Override\n-  public Pair<String, String> addContainer(String accountName, Container newContainer) {\n+  public Collection<Container> addContainers(String accountName, Collection<Container> containers) {\n     checkOpen();\n-    if (accountName == null || accountName.isEmpty() || newContainer == null || newContainer.getName() == null\n-        || newContainer.getName().isEmpty()) {\n-      logger.error(\"Account name: {} or container: {} is invalid\", accountName, newContainer);\n-      throw new IllegalArgumentException(\"Account or container name is null or empty\");\n+    // input validation\n+    if (accountName == null || accountName.isEmpty() || containers == null || containers.isEmpty()) {\n+      throw new IllegalArgumentException(\"Account or container is null or empty\");\n     }\n     Account account = getAccountByName(accountName);\n     if (account == null) {\n       logger.error(\"Account {} is not found\", accountName);\n       throw new IllegalArgumentException(\"Account \" + accountName + \" is not found\");\n     }\n-    String accountId = String.valueOf(account.getId());\n-    for (Container container : account.getAllContainers()) {\n-      // make sure there is no conflict container (conflict means a container with same name but different attributes already exists).\n-      if (container.getName().equals(newContainer.getName())) {\n-        if (container.isSameContainer(newContainer)) {\n-          // If an exactly same container already exists, we directly return its id. Adding same container multiple times\n-          // should be no-op.\n-          return new Pair<>(accountId, String.valueOf(container.getId()));\n-        } else {\n-          logger.error(\"A container: {} already exists with different attributes\", container.getName());\n-          throw new IllegalArgumentException(\"There is a conflicting container in account \" + accountName);\n+    Set<Container> existingContainers = new HashSet<>();\n+    Set<Container> newContainers = new HashSet<>(containers);\n+    for (Container existingContainer : account.getAllContainers()) {\n+      for (Container newContainer : containers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43477f8a06f88f955f59d526f086dbb8214560d5"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjI3NTc2", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-495227576", "createdAt": "2020-09-24T05:23:13Z", "commit": {"oid": "43477f8a06f88f955f59d526f086dbb8214560d5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNToyMzoxM1rOHXKJKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNTozNDo1NVrOHXKWxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA0NTQ4Mg==", "bodyText": "Minor: conflicting container", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r494045482", "createdAt": "2020-09-24T05:23:13Z", "author": {"login": "lightningrob"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -253,56 +253,62 @@ public boolean updateAccounts(Collection<Account> accounts) {\n    * {@inheritDoc}\n    */\n   @Override\n-  public Pair<String, String> addContainer(String accountName, Container newContainer) {\n+  public Collection<Container> addContainers(String accountName, Collection<Container> containers) {\n     checkOpen();\n-    if (accountName == null || accountName.isEmpty() || newContainer == null || newContainer.getName() == null\n-        || newContainer.getName().isEmpty()) {\n-      logger.error(\"Account name: {} or container: {} is invalid\", accountName, newContainer);\n-      throw new IllegalArgumentException(\"Account or container name is null or empty\");\n+    // input validation\n+    if (accountName == null || accountName.isEmpty() || containers == null || containers.isEmpty()) {\n+      throw new IllegalArgumentException(\"Account or container is null or empty\");\n     }\n     Account account = getAccountByName(accountName);\n     if (account == null) {\n       logger.error(\"Account {} is not found\", accountName);\n       throw new IllegalArgumentException(\"Account \" + accountName + \" is not found\");\n     }\n-    String accountId = String.valueOf(account.getId());\n-    for (Container container : account.getAllContainers()) {\n-      // make sure there is no conflict container (conflict means a container with same name but different attributes already exists).\n-      if (container.getName().equals(newContainer.getName())) {\n-        if (container.isSameContainer(newContainer)) {\n-          // If an exactly same container already exists, we directly return its id. Adding same container multiple times\n-          // should be no-op.\n-          return new Pair<>(accountId, String.valueOf(container.getId()));\n-        } else {\n-          logger.error(\"A container: {} already exists with different attributes\", container.getName());\n-          throw new IllegalArgumentException(\"There is a conflicting container in account \" + accountName);\n+    Set<Container> existingContainers = new HashSet<>();\n+    Set<Container> newContainers = new HashSet<>(containers);\n+    for (Container existingContainer : account.getAllContainers()) {\n+      for (Container newContainer : containers) {\n+        // make sure there is no conflict container (conflict means a container with same name but different attributes already exists).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43477f8a06f88f955f59d526f086dbb8214560d5"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA0ODk2Ng==", "bodyText": "The Helix impl returns all containers (added or already exist).  Javadoc should mention that existing containers are ignored.", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r494048966", "createdAt": "2020-09-24T05:34:55Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/account/AccountService.java", "diffHunk": "@@ -109,22 +108,22 @@\n   public boolean removeAccountUpdateConsumer(Consumer<Collection<Account>> accountUpdateConsumer);\n \n   /**\n-   * Add a new container to an existing account.\n+   * Add a collection of containers to an existing account.\n    * @param accountName the name of account in which new container will be added.\n-   * @param newContainer the new container to add.\n-   * @return a pair of account id and container id strings associated with existing account and new container.\n+   * @param containers a collection of containers to add.\n+   * @return a collection of containers that are successfully added.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43477f8a06f88f955f59d526f086dbb8214560d5"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjM1MzI5", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-495235329", "createdAt": "2020-09-24T05:45:29Z", "commit": {"oid": "43477f8a06f88f955f59d526f086dbb8214560d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNTo0NTozMFrOHXKjWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNTo0NTozMFrOHXKjWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1MjE4NQ==", "bodyText": "Even if we don't update in-memory account here, may be it might eventually get updated later when fetchAndUpdateCache() is called by background updater thread or on ZK notification (similar to how accounts in cache get updated today after updateAccounts() is called from PostAccountsHandler).", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r494052185", "createdAt": "2020-09-24T05:45:30Z", "author": {"login": "Arun-LinkedIn"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -253,56 +253,62 @@ public boolean updateAccounts(Collection<Account> accounts) {\n    * {@inheritDoc}\n    */\n   @Override\n-  public Pair<String, String> addContainer(String accountName, Container newContainer) {\n+  public Collection<Container> addContainers(String accountName, Collection<Container> containers) {\n     checkOpen();\n-    if (accountName == null || accountName.isEmpty() || newContainer == null || newContainer.getName() == null\n-        || newContainer.getName().isEmpty()) {\n-      logger.error(\"Account name: {} or container: {} is invalid\", accountName, newContainer);\n-      throw new IllegalArgumentException(\"Account or container name is null or empty\");\n+    // input validation\n+    if (accountName == null || accountName.isEmpty() || containers == null || containers.isEmpty()) {\n+      throw new IllegalArgumentException(\"Account or container is null or empty\");\n     }\n     Account account = getAccountByName(accountName);\n     if (account == null) {\n       logger.error(\"Account {} is not found\", accountName);\n       throw new IllegalArgumentException(\"Account \" + accountName + \" is not found\");\n     }\n-    String accountId = String.valueOf(account.getId());\n-    for (Container container : account.getAllContainers()) {\n-      // make sure there is no conflict container (conflict means a container with same name but different attributes already exists).\n-      if (container.getName().equals(newContainer.getName())) {\n-        if (container.isSameContainer(newContainer)) {\n-          // If an exactly same container already exists, we directly return its id. Adding same container multiple times\n-          // should be no-op.\n-          return new Pair<>(accountId, String.valueOf(container.getId()));\n-        } else {\n-          logger.error(\"A container: {} already exists with different attributes\", container.getName());\n-          throw new IllegalArgumentException(\"There is a conflicting container in account \" + accountName);\n+    Set<Container> existingContainers = new HashSet<>();\n+    Set<Container> newContainers = new HashSet<>(containers);\n+    for (Container existingContainer : account.getAllContainers()) {\n+      for (Container newContainer : containers) {\n+        // make sure there is no conflict container (conflict means a container with same name but different attributes already exists).\n+        if (existingContainer.getName().equals(newContainer.getName())) {\n+          if (existingContainer.isSameContainer(newContainer)) {\n+            // If an exactly same container already exists, we directly return its id. Adding same container multiple times\n+            // should be no-op.\n+            existingContainers.add(existingContainer);\n+          } else {\n+            throw new IllegalArgumentException(\"There is a conflicting container in account \" + accountName);\n+          }\n         }\n       }\n     }\n-    // if code reaches here, it means no duplicate container in this account\n-    // generate container id for new container\n+    newContainers.removeAll(existingContainers);\n+\n+    // if code reaches here, it means no conflicting container in this account\n     short nextContainerId = account.getAllContainers()\n         .stream()\n         .map(Container::getId)\n         .max(Short::compareTo)\n         .map(maxId -> (short) (maxId + 1))\n         .orElse(config.containerIdStartNumber);\n     // construct a container based on input container and next containerId\n-    Container containerToAdd =\n-        new ContainerBuilder(newContainer).setId(nextContainerId).setParentAccountId(account.getId()).build();\n-    account.updateContainerMap(containerToAdd);\n-    List<Account> accounts = Collections.singletonList(account);\n-    boolean hasSucceeded = false;\n-    if (accountInfoMapRef.get().hasConflictingAccount(accounts)) {\n-      logger.debug(\"Accounts={} conflict with the accounts in local cache. Cancel the update operation.\", accounts);\n-      accountServiceMetrics.updateAccountErrorCount.inc();\n-    } else {\n-      hasSucceeded = accountMetadataStore.updateAccounts(accounts);\n+    List<Container> createdContainers = new ArrayList<>();\n+    for (Container container : newContainers) {\n+      createdContainers.add(\n+          new ContainerBuilder(container).setId(nextContainerId).setParentAccountId(account.getId()).build());\n+      ++nextContainerId;\n     }\n+    // In case updating account metadata store failed, we do a deep copy of original account. Thus, we don't have to\n+    // revert changes in original account when there is a failure.\n+    Account accountCopy = new AccountBuilder(account).build();\n+    accountCopy.updateContainerMap(createdContainers);\n+    boolean hasSucceeded = updateAccounts(Collections.singletonList(accountCopy));\n     if (!hasSucceeded) {\n       throw new IllegalStateException(\"Account update failed for \" + accountName);\n     }\n-    return new Pair<>(accountId, String.valueOf(nextContainerId));\n+    // after metadata store is successfully updated, we safely update original account\n+    account.updateContainerMap(createdContainers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43477f8a06f88f955f59d526f086dbb8214560d5"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjM3NDk5", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-495237499", "createdAt": "2020-09-24T05:51:12Z", "commit": {"oid": "43477f8a06f88f955f59d526f086dbb8214560d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1afbb6459f4de8228f9b2bbc4a14afd3242e1e06", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/1afbb6459f4de8228f9b2bbc4a14afd3242e1e06", "committedDate": "2020-09-24T06:31:00Z", "message": "address comments from Rob and Arun"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzUwMjYx", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-495750261", "createdAt": "2020-09-24T16:29:59Z", "commit": {"oid": "1afbb6459f4de8228f9b2bbc4a14afd3242e1e06"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjoyOTo1OVrOHXjGaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjoyOTo1OVrOHXjGaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ1NDM3OQ==", "bodyText": "I think these methods should throw exceptions (might need to create one).  They can't return false, and having the impl throw IllegalStateException on any failure doesn't feel right.", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r494454379", "createdAt": "2020-09-24T16:29:59Z", "author": {"login": "lightningrob"}, "path": "ambry-api/src/main/java/com/github/ambry/account/AccountService.java", "diffHunk": "@@ -107,6 +107,37 @@\n    */\n   public boolean removeAccountUpdateConsumer(Consumer<Collection<Account>> accountUpdateConsumer);\n \n+  /**\n+   * Add a collection of containers to an existing account.\n+   * @param accountName the name of account in which new container will be added.\n+   * @param containers a collection of containers to add.\n+   * @return a collection of containers that are successfully added. If original input containers includes existing one,\n+   *         the existing containers will be ignored and not present in the result.\n+   */\n+  default Collection<Container> addContainers(String accountName, Collection<Container> containers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1afbb6459f4de8228f9b2bbc4a14afd3242e1e06"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4a8f0aac29bd777eeb6d6bafe541610d7323969", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/b4a8f0aac29bd777eeb6d6bafe541610d7323969", "committedDate": "2020-09-24T17:56:23Z", "message": "introduced AccountServiceException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1ODMwNTI3", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-495830527", "createdAt": "2020-09-24T18:11:57Z", "commit": {"oid": "b4a8f0aac29bd777eeb6d6bafe541610d7323969"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxODoxMTo1N1rOHXmzHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxODoxMTo1N1rOHXmzHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxNDk3Mw==", "bodyText": "updateAccounts can also throw AccountServiceException (future PR)", "url": "https://github.com/linkedin/ambry/pull/1628#discussion_r494514973", "createdAt": "2020-09-24T18:11:57Z", "author": {"login": "lightningrob"}, "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -305,7 +307,8 @@ public boolean updateAccounts(Collection<Account> accounts) {\n       accountCopy.updateContainerMap(createdContainers);\n       boolean hasSucceeded = updateAccounts(Collections.singletonList(accountCopy));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4a8f0aac29bd777eeb6d6bafe541610d7323969"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1ODMxMjkw", "url": "https://github.com/linkedin/ambry/pull/1628#pullrequestreview-495831290", "createdAt": "2020-09-24T18:12:40Z", "commit": {"oid": "b4a8f0aac29bd777eeb6d6bafe541610d7323969"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1263, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}