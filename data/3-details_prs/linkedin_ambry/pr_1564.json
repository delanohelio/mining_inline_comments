{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NzI0NDI5", "number": 1564, "title": "Check the size of vcr node list before finding one to assign as cloud peer.", "bodyText": "", "createdAt": "2020-06-15T19:16:39Z", "url": "https://github.com/linkedin/ambry/pull/1564", "merged": true, "mergeCommit": {"oid": "e80351475bd9f8e5c224d49a4686e7cb30aca962"}, "closed": true, "closedAt": "2020-06-18T22:22:42Z", "author": {"login": "ankagrawal"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcroRmRgFqTQzMTAzMjgwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsjHMUgFqTQzMzU1OTUxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMDMyODAz", "url": "https://github.com/linkedin/ambry/pull/1564#pullrequestreview-431032803", "createdAt": "2020-06-15T22:20:15Z", "commit": {"oid": "bbde88b8c1f4b442107277c0f717022743d3adbc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMDQ1ODY5", "url": "https://github.com/linkedin/ambry/pull/1564#pullrequestreview-431045869", "createdAt": "2020-06-15T22:52:33Z", "commit": {"oid": "bbde88b8c1f4b442107277c0f717022743d3adbc"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjo1MjozNFrOGkFXzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMzowNDoyOFrOGkFmjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4OTkzNQ==", "bodyText": "isEmpty() is simpler.", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r440489935", "createdAt": "2020-06-15T22:52:34Z", "author": {"login": "lightningrob"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/CloudToStoreReplicationManager.java", "diffHunk": "@@ -240,8 +240,13 @@ private void removeCloudReplica(String partitionName) {\n   /**\n    * Randomly select a {@link DataNodeId} from list of {@code vcrNodes}.\n    * @return randomly selected {@link DataNodeId} object.\n+   * @throws ReplicationException if there are no vcr nodes.\n    */\n-  private DataNodeId getCloudDataNode() {\n+  private DataNodeId getCloudDataNode() throws ReplicationException {\n+    if (vcrNodes.get().size() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbde88b8c1f4b442107277c0f717022743d3adbc"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4OTk0OQ==", "bodyText": "No need to log if the same message is passed to exception.  Also say VCR.", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r440489949", "createdAt": "2020-06-15T22:52:37Z", "author": {"login": "lightningrob"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/CloudToStoreReplicationManager.java", "diffHunk": "@@ -240,8 +240,13 @@ private void removeCloudReplica(String partitionName) {\n   /**\n    * Randomly select a {@link DataNodeId} from list of {@code vcrNodes}.\n    * @return randomly selected {@link DataNodeId} object.\n+   * @throws ReplicationException if there are no vcr nodes.\n    */\n-  private DataNodeId getCloudDataNode() {\n+  private DataNodeId getCloudDataNode() throws ReplicationException {\n+    if (vcrNodes.get().size() == 0) {\n+      logger.error(\"No vcr node found to replicate partition from cloud.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbde88b8c1f4b442107277c0f717022743d3adbc"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ5MzcxMA==", "bodyText": "I realize this isn't new code, but it seems inefficient for a getter method to have to copy a collection to an array every time it needs to get an element from it.  It makes me wonder if the concurrent set is really the optimal data structure for this.", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r440493710", "createdAt": "2020-06-15T23:04:28Z", "author": {"login": "lightningrob"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/CloudToStoreReplicationManager.java", "diffHunk": "@@ -240,8 +240,13 @@ private void removeCloudReplica(String partitionName) {\n   /**\n    * Randomly select a {@link DataNodeId} from list of {@code vcrNodes}.\n    * @return randomly selected {@link DataNodeId} object.\n+   * @throws ReplicationException if there are no vcr nodes.\n    */\n-  private DataNodeId getCloudDataNode() {\n+  private DataNodeId getCloudDataNode() throws ReplicationException {\n+    if (vcrNodes.get().size() == 0) {\n+      logger.error(\"No vcr node found to replicate partition from cloud.\");\n+      throw new ReplicationException(\"No vcr node found to replicate partition from cloud.\");\n+    }\n     return vcrNodes.get().toArray(new CloudDataNode[0])[Utils.getRandomShort(new Random()) % vcrNodes.get().size()];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbde88b8c1f4b442107277c0f717022743d3adbc"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bbde88b8c1f4b442107277c0f717022743d3adbc", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/bbde88b8c1f4b442107277c0f717022743d3adbc", "committedDate": "2020-06-15T19:14:57Z", "message": "Check the size of vcr node list before finding on to assign as cloud peer."}, "afterCommit": {"oid": "600ce3d0d4acc1494b1da6c537f5628e17aa25ab", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/600ce3d0d4acc1494b1da6c537f5628e17aa25ab", "committedDate": "2020-06-17T01:30:43Z", "message": "Make list of vcr nodes a list instead of set.\nAddress review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODc1OTEx", "url": "https://github.com/linkedin/ambry/pull/1564#pullrequestreview-432875911", "createdAt": "2020-06-18T01:15:12Z", "commit": {"oid": "600ce3d0d4acc1494b1da6c537f5628e17aa25ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMToxNToxMlrOGlcWHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMToxNToxMlrOGlcWHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkxNDkwOA==", "bodyText": "I didn't notice it before, but I think initializing a new Random() each time will result in the same value each time.  At least that's how it used to behave, not sure if it's still the case.  Either way, I would initialize the Random statically and reuse.  I recommend adding a test case that calls this method consecutive times and verifies different results are returned.  And one to test the no-nodes exception case.", "url": "https://github.com/linkedin/ambry/pull/1564#discussion_r441914908", "createdAt": "2020-06-18T01:15:12Z", "author": {"login": "lightningrob"}, "path": "ambry-replication/src/main/java/com/github/ambry/replication/CloudToStoreReplicationManager.java", "diffHunk": "@@ -240,9 +240,14 @@ private void removeCloudReplica(String partitionName) {\n   /**\n    * Randomly select a {@link DataNodeId} from list of {@code vcrNodes}.\n    * @return randomly selected {@link DataNodeId} object.\n+   * @throws ReplicationException if there are no vcr nodes.\n    */\n-  private DataNodeId getCloudDataNode() {\n-    return vcrNodes.get().toArray(new CloudDataNode[0])[Utils.getRandomShort(new Random()) % vcrNodes.get().size()];\n+  private DataNodeId getCloudDataNode() throws ReplicationException {\n+    List<CloudDataNode> nodes = vcrNodes.get();\n+    if (nodes.isEmpty()) {\n+      throw new ReplicationException(\"No VCR node found to replicate partition from cloud.\");\n+    }\n+    return nodes.get(Utils.getRandomShort(new Random()) % nodes.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "600ce3d0d4acc1494b1da6c537f5628e17aa25ab"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODc2MzQz", "url": "https://github.com/linkedin/ambry/pull/1564#pullrequestreview-432876343", "createdAt": "2020-06-18T01:16:44Z", "commit": {"oid": "600ce3d0d4acc1494b1da6c537f5628e17aa25ab"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09f4a436d85ffbb82a5d3887804b0e0a1492f3b3", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/09f4a436d85ffbb82a5d3887804b0e0a1492f3b3", "committedDate": "2020-06-18T05:38:54Z", "message": "Check the size of vcr node list before finding on to assign as cloud peer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9356de8926c2e1bb34e2f203e19d1db5f6d28268", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/9356de8926c2e1bb34e2f203e19d1db5f6d28268", "committedDate": "2020-06-18T05:38:54Z", "message": "Make list of vcr nodes a list instead of set.\nAddress review comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "567ddd08eda9de99aaeee3ee275dd30dd28133c5", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/567ddd08eda9de99aaeee3ee275dd30dd28133c5", "committedDate": "2020-06-18T05:38:54Z", "message": "Add unit test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "600ce3d0d4acc1494b1da6c537f5628e17aa25ab", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/600ce3d0d4acc1494b1da6c537f5628e17aa25ab", "committedDate": "2020-06-17T01:30:43Z", "message": "Make list of vcr nodes a list instead of set.\nAddress review comments."}, "afterCommit": {"oid": "567ddd08eda9de99aaeee3ee275dd30dd28133c5", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/567ddd08eda9de99aaeee3ee275dd30dd28133c5", "committedDate": "2020-06-18T05:38:54Z", "message": "Add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb95619dd37639174b2753b99c67406c881988da", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/fb95619dd37639174b2753b99c67406c881988da", "committedDate": "2020-06-18T05:42:35Z", "message": "Fix error message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTU5NTE5", "url": "https://github.com/linkedin/ambry/pull/1564#pullrequestreview-433559519", "createdAt": "2020-06-18T18:53:17Z", "commit": {"oid": "fb95619dd37639174b2753b99c67406c881988da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1136, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}