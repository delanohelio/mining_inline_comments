{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NTM4MjAy", "number": 1594, "title": "Introduce tool for migrating instance configs to property store", "bodyText": "This HelixBootstrapUpgradeTool operation will fetch all instance configs\nfor a cluster, convert them into the new format, and then persist them\nin the property store.", "createdAt": "2020-07-29T16:09:29Z", "url": "https://github.com/linkedin/ambry/pull/1594", "merged": true, "mergeCommit": {"oid": "b62064b2a5ac14618f1f9559dbf10dd99fd845a4"}, "closed": true, "closedAt": "2020-08-12T17:39:15Z", "author": {"login": "cgtz"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6V3eCgBqjM2MDkwMTc4Njc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-PArNAFqTQ2NjEzMzUyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ee2270bf8f602cdaa92b43d012f55d056065ca0", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/3ee2270bf8f602cdaa92b43d012f55d056065ca0", "committedDate": "2020-07-29T16:06:44Z", "message": "Introduce tool for migrating instance configs to property store\n\nThis HelixBootstrapUpgradeTool operation will fetch all instance configs\nfor a cluster, convert them into the new format, and then persist them\nin the property store."}, "afterCommit": {"oid": "aec5614e239794de15b0218e20972645eceea7f9", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/aec5614e239794de15b0218e20972645eceea7f9", "committedDate": "2020-07-31T15:22:06Z", "message": "Introduce tool for migrating instance configs to property store\n\nThis HelixBootstrapUpgradeTool operation will fetch all instance configs\nfor a cluster, convert them into the new format, and then persist them\nin the property store."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMjM4Nzg0", "url": "https://github.com/linkedin/ambry/pull/1594#pullrequestreview-460238784", "createdAt": "2020-08-03T18:10:46Z", "commit": {"oid": "aec5614e239794de15b0218e20972645eceea7f9"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODoxMDo0NlrOG7DuLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxODo0NDozM1rOG7EuSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4MDE0Mw==", "bodyText": "Optional: considering making this multi-threaded (one thread  per colo).\n(Never mind, it should be fine, as it's one-off operation)", "url": "https://github.com/linkedin/ambry/pull/1594#discussion_r464580143", "createdAt": "2020-08-03T18:10:46Z", "author": {"login": "jsjtzyy"}, "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixBootstrapUpgradeUtil.java", "diffHunk": "@@ -700,20 +718,47 @@ private void uploadClusterAdminInfos(Map<String, Map<String, Map<String, String>\n    * @param adminConfigZNodePath the znode path of admin config.\n    */\n   private void deleteClusterAdminInfos(String clusterAdminType, String adminConfigZNodePath) {\n-    Properties storeProps = new Properties();\n-    storeProps.setProperty(\"helix.property.store.root.path\", \"/\" + clusterName + \"/\" + PROPERTYSTORE_STR);\n-    HelixPropertyStoreConfig propertyStoreConfig = new HelixPropertyStoreConfig(new VerifiableProperties(storeProps));\n     for (Map.Entry<String, ClusterMapUtils.DcZkInfo> entry : dataCenterToZkAddress.entrySet()) {\n       info(\"Deleting {} infos for datacenter {}.\", clusterAdminType, entry.getKey());\n-      HelixPropertyStore<ZNRecord> helixPropertyStore =\n-          CommonUtils.createHelixPropertyStore(entry.getValue().getZkConnectStrs().get(0), propertyStoreConfig, null);\n+      HelixPropertyStore<ZNRecord> helixPropertyStore = createHelixPropertyStore(entry.getKey());\n       if (!helixPropertyStore.remove(adminConfigZNodePath, AccessOption.PERSISTENT)) {\n         logger.error(\"Failed to remove {} infos from datacenter {}\", clusterAdminType, entry.getKey());\n       }\n       helixPropertyStore.stop();\n     }\n   }\n \n+  /**\n+   * Convert instance configs to the new DataNodeConfig format and persist them in the property store.\n+   */\n+  private void migrateToPropertyStore() {\n+    adminForDc.forEach((dcName, helixAdmin) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aec5614e239794de15b0218e20972645eceea7f9"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU5NjU1NA==", "bodyText": "Thanks for simplifying this. Could you also make the change for uploadClusterAdminInfos method as well (line 701 ~ 705)?", "url": "https://github.com/linkedin/ambry/pull/1594#discussion_r464596554", "createdAt": "2020-08-03T18:44:33Z", "author": {"login": "jsjtzyy"}, "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixBootstrapUpgradeUtil.java", "diffHunk": "@@ -700,20 +718,47 @@ private void uploadClusterAdminInfos(Map<String, Map<String, Map<String, String>\n    * @param adminConfigZNodePath the znode path of admin config.\n    */\n   private void deleteClusterAdminInfos(String clusterAdminType, String adminConfigZNodePath) {\n-    Properties storeProps = new Properties();\n-    storeProps.setProperty(\"helix.property.store.root.path\", \"/\" + clusterName + \"/\" + PROPERTYSTORE_STR);\n-    HelixPropertyStoreConfig propertyStoreConfig = new HelixPropertyStoreConfig(new VerifiableProperties(storeProps));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aec5614e239794de15b0218e20972645eceea7f9"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a5a8767aa13109d5330f83783f2a3e52e84e1d", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/c1a5a8767aa13109d5330f83783f2a3e52e84e1d", "committedDate": "2020-08-05T17:08:06Z", "message": "Introduce tool for migrating instance configs to property store\n\nThis HelixBootstrapUpgradeTool operation will fetch all instance configs\nfor a cluster, convert them into the new format, and then persist them\nin the property store."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d4f70983c96f8f4b56fcb7129cf26994b2d1da2", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/2d4f70983c96f8f4b56fcb7129cf26994b2d1da2", "committedDate": "2020-08-05T17:08:06Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "774581377b7c51a9b0a7ac68df201d7626a34c57", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/774581377b7c51a9b0a7ac68df201d7626a34c57", "committedDate": "2020-08-04T15:25:24Z", "message": "Address comments"}, "afterCommit": {"oid": "2d4f70983c96f8f4b56fcb7129cf26994b2d1da2", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/2d4f70983c96f8f4b56fcb7129cf26994b2d1da2", "committedDate": "2020-08-05T17:08:06Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abad9b81598ad5ff40531d3fcd789b71c89ab927", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/abad9b81598ad5ff40531d3fcd789b71c89ab927", "committedDate": "2020-08-05T17:20:49Z", "message": "Fix after rebase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ef9e50993ab24b4be537958f547380d59ade32c", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/7ef9e50993ab24b4be537958f547380d59ade32c", "committedDate": "2020-08-05T17:14:13Z", "message": "Fix after rebase"}, "afterCommit": {"oid": "abad9b81598ad5ff40531d3fcd789b71c89ab927", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/abad9b81598ad5ff40531d3fcd789b71c89ab927", "committedDate": "2020-08-05T17:20:49Z", "message": "Fix after rebase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MTMzNTI1", "url": "https://github.com/linkedin/ambry/pull/1594#pullrequestreview-466133525", "createdAt": "2020-08-12T17:38:42Z", "commit": {"oid": "abad9b81598ad5ff40531d3fcd789b71c89ab927"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1193, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}