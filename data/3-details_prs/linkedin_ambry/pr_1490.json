{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjIxOTUy", "number": 1490, "title": "Introduce dc-level replication lag metrics", "bodyText": "Currently ReplicationMetrics tracks each remote replica lag from local by emitting a dedicated metric. As ambry grows, it brings more than one million metrics and it's hard to get a whole view of replication lag from remote dcs. This PR introduces a config that allows us to track remote replica lags dc level. That is, it provides statistics regarding replicas' lag in certain dc (min/max/avg) which gives a decent estimation of overall replication lag in each dc.\nAlso this PR introduces two new metrics on source node to track bytes rate of cross-colo fetch and metadata exchange. These metrics present a more accurate view of WAN bandwidth usage.", "createdAt": "2020-04-28T16:17:29Z", "url": "https://github.com/linkedin/ambry/pull/1490", "merged": true, "mergeCommit": {"oid": "16615e2b17ec3880b9db6d2c41a83ee8a09882d4"}, "closed": true, "closedAt": "2020-05-06T01:44:50Z", "author": {"login": "jsjtzyy"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcc1CBGAFqTQwMzkyNjkzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABceYeZaAFqTQwNjA1MzMyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzOTI2OTMw", "url": "https://github.com/linkedin/ambry/pull/1490#pullrequestreview-403926930", "createdAt": "2020-04-30T22:43:08Z", "commit": {"oid": "bdde999e84d16ec52957615b836bec65a0db866d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MzQ5NDUz", "url": "https://github.com/linkedin/ambry/pull/1490#pullrequestreview-404349453", "createdAt": "2020-05-01T19:19:37Z", "commit": {"oid": "bdde999e84d16ec52957615b836bec65a0db866d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxOToxOTozN1rOGPTLZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxOToxOTozN1rOGPTLZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY5NjAzNw==", "bodyText": "looks like this variable name may need adjusting since it is assigned to the per datacenter metric config", "url": "https://github.com/linkedin/ambry/pull/1490#discussion_r418696037", "createdAt": "2020-05-01T19:19:37Z", "author": {"login": "cgtz"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/VcrReplicationManager.java", "diffHunk": "@@ -77,6 +78,7 @@ public VcrReplicationManager(CloudConfig cloudConfig, ReplicationConfig replicat\n     this.cloudStorageCompactor =\n         cloudConfig.cloudBlobCompactionEnabled ? new CloudStorageCompactor(cloudDestination, cloudConfig,\n             partitionToPartitionInfo.keySet(), vcrMetrics) : null;\n+    trackPerPartitionLagInMetric = replicationConfig.replicationTrackRemoteFromLocalPerDatacenterLag;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdde999e84d16ec52957615b836bec65a0db866d"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MzUwODI3", "url": "https://github.com/linkedin/ambry/pull/1490#pullrequestreview-404350827", "createdAt": "2020-05-01T19:22:22Z", "commit": {"oid": "bdde999e84d16ec52957615b836bec65a0db866d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxOToyMjoyMlrOGPTPqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxOToyMjoyMlrOGPTPqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY5NzEzMQ==", "bodyText": "Why comment it?", "url": "https://github.com/linkedin/ambry/pull/1490#discussion_r418697131", "createdAt": "2020-05-01T19:22:22Z", "author": {"login": "zzmao"}, "path": "ambry-server/src/test/java/com/github/ambry/server/AmbryServerRequestsTest.java", "diffHunk": "@@ -318,7 +318,7 @@ public void scheduleCompactionFailureTest() throws InterruptedException, IOExcep\n    * @throws InterruptedException\n    * @throws IOException\n    */\n-  @Test\n+  //@Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdde999e84d16ec52957615b836bec65a0db866d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bbd3675779290509a346fe4def185a2d36c03b5", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/8bbd3675779290509a346fe4def185a2d36c03b5", "committedDate": "2020-05-03T17:23:28Z", "message": "Introduce dc-level replication lag metrics.\n\nNow ReplicationMetrics tracks each remote replica lag from local by emitting a\ndedicated metric. As ambry grows, it brings more than one million metrics and\nit's hard to get a whole view of replication lag from remote dcs. This PR introduces\na config that allows us to track remote replica lags dc level. That is, it provides\nstatistics regarding replicas' lag in certain dc (min/max/avg/sum) which gives a\ndecent estimation of overall replication lag in each dc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95c863a2c19904a120d088379c6c51608edc9fb4", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/95c863a2c19904a120d088379c6c51608edc9fb4", "committedDate": "2020-05-03T17:23:28Z", "message": "added unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dc89fb2777099025653787e00eb74e8ae9ab97b", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/0dc89fb2777099025653787e00eb74e8ae9ab97b", "committedDate": "2020-05-03T17:23:28Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "322447425a44429194fa645e6a94fa53f5851165", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/322447425a44429194fa645e6a94fa53f5851165", "committedDate": "2020-05-04T01:39:27Z", "message": "added additional metrics to track cross-colo replication bytes rate"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bdde999e84d16ec52957615b836bec65a0db866d", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/bdde999e84d16ec52957615b836bec65a0db866d", "committedDate": "2020-04-26T21:35:26Z", "message": "added unit test"}, "afterCommit": {"oid": "322447425a44429194fa645e6a94fa53f5851165", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/322447425a44429194fa645e6a94fa53f5851165", "committedDate": "2020-05-04T01:39:27Z", "message": "added additional metrics to track cross-colo replication bytes rate"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MTc5MDEy", "url": "https://github.com/linkedin/ambry/pull/1490#pullrequestreview-405179012", "createdAt": "2020-05-04T17:06:26Z", "commit": {"oid": "322447425a44429194fa645e6a94fa53f5851165"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNzowNjoyNlrOGQJrNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNzowNjoyNlrOGQJrNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU4ODkxOA==", "bodyText": "@Arun-LinkedIn these two metrics are what you need to track realtime cross-colo fetch/metadata request bytes rate. Note that, these metrics are emitted on source node, which are more accurate than existing metrics on puller to indicate cross-colo bandwidth usage.", "url": "https://github.com/linkedin/ambry/pull/1490#discussion_r419588918", "createdAt": "2020-05-04T17:06:26Z", "author": {"login": "jsjtzyy"}, "path": "ambry-commons/src/main/java/com/github/ambry/commons/ServerMetrics.java", "diffHunk": "@@ -211,12 +215,14 @@\n   public final Counter ttlAlreadyUpdatedError;\n   public final Counter ttlUpdateRejectedError;\n   public final Counter replicationResponseMessageSizeTooHigh;\n+  public final Map<String, Meter> crossColoFetchBytesRate = new HashMap<>();\n+  public final Map<String, Meter> crossColoMetadataExchangeBytesRate = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "322447425a44429194fa645e6a94fa53f5851165"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8bcfdcfb07daeb89a9eb216f60bd25a50c2ccd1", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/e8bcfdcfb07daeb89a9eb216f60bd25a50c2ccd1", "committedDate": "2020-05-04T19:18:32Z", "message": "remove duplicate metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6b9ccc5dd9da3eaa66ee1bceeec8a59af4c0808", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/d6b9ccc5dd9da3eaa66ee1bceeec8a59af4c0808", "committedDate": "2020-05-04T20:24:38Z", "message": "minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de8b43cc6cc6e48fc1b612bc38c51a797f36a599", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/de8b43cc6cc6e48fc1b612bc38c51a797f36a599", "committedDate": "2020-05-05T05:45:42Z", "message": "fixed test failure and simplify code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c8a4cb66dbcef235583a0927ce0a20f95eee33a", "author": {"user": {"login": "jsjtzyy", "name": "Yingyi Zhang"}}, "url": "https://github.com/linkedin/ambry/commit/2c8a4cb66dbcef235583a0927ce0a20f95eee33a", "committedDate": "2020-05-05T18:33:08Z", "message": "minor change for stats init value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MDUzMzIx", "url": "https://github.com/linkedin/ambry/pull/1490#pullrequestreview-406053321", "createdAt": "2020-05-05T18:34:44Z", "commit": {"oid": "de8b43cc6cc6e48fc1b612bc38c51a797f36a599"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1430, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}