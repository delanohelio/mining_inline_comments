{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5MDk0MDEw", "number": 1618, "title": "Fix a NullPointerException in PutOperation's fillChunk method", "bodyText": "There is a NPE in the ChunkFiller thread in PutOperation. The root cause of this NPE is a race condition and state misconfiguration.\nThe data flow that causes NPE\n1 Last chunkReadBuf from chunkFillerChannel is an empty chunk\n2 Reading this empty chunk would create a PutChunk at BUILDING state.\n3 At line 593, when finish reading chunks from ReadableStreamChannel, the lastChunk's readable bytes' length is 0\n4 Without change the lastChunk' state to free, the program logic move on to link 606 to check whether operation is completed or not.\n5 If somehow the operation is completed, (by error, or any other reason), it will call lastChunk.releaseBlobContent. This will set buf to null in lastChunk.\n6 Since chunkFiller is in a different thread, it doesn't know the operation is finished, it still calls fillChunks and this time, it will directly go to line 593 and fail with a NPE.\nThis PR fixes this issue, by setting the last chunk's state to FREE, so step 6 will never happen.", "createdAt": "2020-09-03T23:23:30Z", "url": "https://github.com/linkedin/ambry/pull/1618", "merged": true, "mergeCommit": {"oid": "4514c6c3901a309a04075d131c555b55ec620353"}, "closed": true, "closedAt": "2020-10-01T21:46:45Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFaiV9AFqTQ4MjI5MjgxMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOYha4AFqTUwMDc0MDc4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjkyODEy", "url": "https://github.com/linkedin/ambry/pull/1618#pullrequestreview-482292812", "createdAt": "2020-09-04T01:01:54Z", "commit": {"oid": "9a3b12776ea5cd1dabce316a2dd2b50de854258c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMTowMTo1NFrOHM8GOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwMTowMTo1NFrOHM8GOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMyOTU5Mw==", "bodyText": "is there a unit test we could write to reproduce the NPE?", "url": "https://github.com/linkedin/ambry/pull/1618#discussion_r483329593", "createdAt": "2020-09-04T01:01:54Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com/github/ambry/router/PutOperation.java", "diffHunk": "@@ -590,7 +590,7 @@ void fillChunks() {\n         // the chunk above.\n         PutChunk lastChunk = getBuildingChunk();\n         if (lastChunk != null) {\n-          if (chunkCounter != 0 && lastChunk.buf.readableBytes() == 0) {\n+          if (chunkCounter != 0 && (lastChunk.buf == null || lastChunk.buf.readableBytes() == 0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a3b12776ea5cd1dabce316a2dd2b50de854258c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55985a7d995c54892ae97da176514ac0ed8c60de", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/55985a7d995c54892ae97da176514ac0ed8c60de", "committedDate": "2020-10-01T00:31:35Z", "message": "Fix a NPE in PutOperation ChunkFiller thread"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a3b12776ea5cd1dabce316a2dd2b50de854258c", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/9a3b12776ea5cd1dabce316a2dd2b50de854258c", "committedDate": "2020-09-02T22:23:55Z", "message": "WIP"}, "afterCommit": {"oid": "55985a7d995c54892ae97da176514ac0ed8c60de", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/55985a7d995c54892ae97da176514ac0ed8c60de", "committedDate": "2020-10-01T00:31:35Z", "message": "Fix a NPE in PutOperation ChunkFiller thread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjkxODk2", "url": "https://github.com/linkedin/ambry/pull/1618#pullrequestreview-500691896", "createdAt": "2020-10-01T20:25:16Z", "commit": {"oid": "55985a7d995c54892ae97da176514ac0ed8c60de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzQwNzgw", "url": "https://github.com/linkedin/ambry/pull/1618#pullrequestreview-500740780", "createdAt": "2020-10-01T21:46:24Z", "commit": {"oid": "55985a7d995c54892ae97da176514ac0ed8c60de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1240, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}