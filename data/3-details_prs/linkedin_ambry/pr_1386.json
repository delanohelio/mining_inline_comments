{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NTg1OTM2", "number": 1386, "title": "Change Store interface to not use MessageWriteSet", "bodyText": "delete and updateTtl method in interface Store take MessageWriteSet as its only parameter. This is not ideal since the data from MessageWriteSet would be persisted in the LogSegment files on disk, which means there is a chance that outside of the BlobStore implementation, we can construct any arbitrary bytes and persist them in the log files. This is not very bad, for we control how to construct those bytes, but from interface's perspective, it's not a good one.\nAnd in order to support persisting undelete record, we need to get the lifeVersion from the PersistentIndex before we can construct a UndeleteFormatInputStream. The same goes to delete and ttlUpdate record. But in AmbryRequests, we don't yet know the lifeVersion before creating FormatInputStream for those record because of Store interface requires MessageWriteSet as the parameter. Changing the interface to take MessageInfo not MessageWriteSet solves this problem.\nThis PR changes that to make sure BlobStore would construct all the delete and updateTtl records by itself. We should change put method as well, but later.", "createdAt": "2020-02-14T21:46:48Z", "url": "https://github.com/linkedin/ambry/pull/1386", "merged": true, "mergeCommit": {"oid": "7779cdd6381ba63361dfcc8177a23d68a4159725"}, "closed": true, "closedAt": "2020-02-27T23:15:50Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcILkykgFqTM2NTE1NzIwOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIjsmSAFqTM2NjA2NTQ5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MTU3MjA5", "url": "https://github.com/linkedin/ambry/pull/1386#pullrequestreview-365157209", "createdAt": "2020-02-26T18:56:45Z", "commit": {"oid": "b4204604af246e821e68de6a68b29ca80c2e12fe"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxODo1Njo0NVrOFu3_Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOTowMjoxMVrOFu4LRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5NjE2Ng==", "bodyText": "Minor:\nAdding a new constructor created some duplicated code and you need 'if else' in the caller. Prefer to change existing constructor by adding lifeVersion.", "url": "https://github.com/linkedin/ambry/pull/1386#discussion_r384696166", "createdAt": "2020-02-26T18:56:45Z", "author": {"login": "zzmao"}, "path": "ambry-messageformat/src/main/java/com.github.ambry.messageformat/DeleteMessageFormatInputStream.java", "diffHunk": "@@ -55,4 +55,22 @@ public DeleteMessageFormatInputStream(StoreKey key, short accountId, short conta\n     messageLength = buffer.capacity();\n     buffer.flip();\n   }\n+\n+  public DeleteMessageFormatInputStream(StoreKey key, short accountId, short containerId, long deletionTimeMs,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4204604af246e821e68de6a68b29ca80c2e12fe"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5OTIwNw==", "bodyText": "-1 might be better, to indicate invalid or meaningless.", "url": "https://github.com/linkedin/ambry/pull/1386#discussion_r384699207", "createdAt": "2020-02-26T19:02:11Z", "author": {"login": "zzmao"}, "path": "ambry-protocol/src/main/java/com.github.ambry.protocol/AmbryRequests.java", "diffHunk": "@@ -398,16 +396,11 @@ public void handleDeleteRequest(NetworkRequest request) throws IOException, Inte\n         response = new DeleteResponse(deleteRequest.getCorrelationId(), deleteRequest.getClientId(), error);\n       } else {\n         BlobId convertedBlobId = (BlobId) convertedStoreKey;\n-        MessageFormatInputStream stream =\n-            new DeleteMessageFormatInputStream(convertedStoreKey, convertedBlobId.getAccountId(),\n-                convertedBlobId.getContainerId(), deleteRequest.getDeletionTimeInMs());\n-        MessageInfo info = new MessageInfo(convertedStoreKey, stream.getSize(), convertedBlobId.getAccountId(),\n-            convertedBlobId.getContainerId(), deleteRequest.getDeletionTimeInMs());\n-        ArrayList<MessageInfo> infoList = new ArrayList<MessageInfo>();\n-        infoList.add(info);\n-        MessageFormatWriteSet writeSet = new MessageFormatWriteSet(stream, infoList, false);\n+        MessageInfo info =\n+            new MessageInfo(convertedStoreKey, 0, convertedBlobId.getAccountId(), convertedBlobId.getContainerId(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4204604af246e821e68de6a68b29ca80c2e12fe"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4204604af246e821e68de6a68b29ca80c2e12fe", "author": {"user": {"login": "dharju", "name": "David Harju"}}, "url": "https://github.com/linkedin/ambry/commit/b4204604af246e821e68de6a68b29ca80c2e12fe", "committedDate": "2020-02-14T21:42:32Z", "message": "Change Store interface to not use MessageWriteSet on delete and updateTtl"}, "afterCommit": {"oid": "83b8f0af78f4506873e64cdff816198b1c3cad11", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/83b8f0af78f4506873e64cdff816198b1c3cad11", "committedDate": "2020-02-26T19:19:22Z", "message": "Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MzU4Mjc5", "url": "https://github.com/linkedin/ambry/pull/1386#pullrequestreview-365358279", "createdAt": "2020-02-27T01:20:49Z", "commit": {"oid": "83b8f0af78f4506873e64cdff816198b1c3cad11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMToyMDo0OVrOFvCOSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMToyMDo0OVrOFvCOSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2MzgxOQ==", "bodyText": "Not sure why you removed the javadoc.  Please restore.", "url": "https://github.com/linkedin/ambry/pull/1386#discussion_r384863819", "createdAt": "2020-02-27T01:20:49Z", "author": {"login": "lightningrob"}, "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java", "diffHunk": "@@ -367,18 +367,12 @@ public short undelete(MessageInfo info) throws StoreException {\n     throw new UnsupportedOperationException(\"Undelete not supported in cloud store\");\n   }\n \n-  /**\n-   * {@inheritDoc}\n-   * Currently, the only supported operation is to set the TTL to infinite (i.e. no arbitrary increase or decrease)\n-   * @param messageSetToUpdate The list of messages that need to be updated\n-   * @throws StoreException if there is a problem persisting the operation in the store.\n-   */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83b8f0af78f4506873e64cdff816198b1c3cad11"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31d235b1fb1ab2206e8af6ee80931f5995a2a3ba", "author": {"user": {"login": "dharju", "name": "David Harju"}}, "url": "https://github.com/linkedin/ambry/commit/31d235b1fb1ab2206e8af6ee80931f5995a2a3ba", "committedDate": "2020-02-27T01:52:38Z", "message": "Change Store interface to not use MessageWriteSet on delete and updateTtl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "134b4c1cca6dd49f6706fb9285b4c640a42bd648", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/134b4c1cca6dd49f6706fb9285b4c640a42bd648", "committedDate": "2020-02-27T01:52:38Z", "message": "Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7277456b0d7c6d2f9131c373a46448ad3aff4c2", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/d7277456b0d7c6d2f9131c373a46448ad3aff4c2", "committedDate": "2020-02-27T02:04:00Z", "message": "comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83b8f0af78f4506873e64cdff816198b1c3cad11", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/83b8f0af78f4506873e64cdff816198b1c3cad11", "committedDate": "2020-02-26T19:19:22Z", "message": "Comments"}, "afterCommit": {"oid": "d7277456b0d7c6d2f9131c373a46448ad3aff4c2", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/d7277456b0d7c6d2f9131c373a46448ad3aff4c2", "committedDate": "2020-02-27T02:04:00Z", "message": "comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDE2MTQx", "url": "https://github.com/linkedin/ambry/pull/1386#pullrequestreview-366016141", "createdAt": "2020-02-27T21:36:08Z", "commit": {"oid": "d7277456b0d7c6d2f9131c373a46448ad3aff4c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDY1NDk4", "url": "https://github.com/linkedin/ambry/pull/1386#pullrequestreview-366065498", "createdAt": "2020-02-27T23:12:52Z", "commit": {"oid": "d7277456b0d7c6d2f9131c373a46448ad3aff4c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1618, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}