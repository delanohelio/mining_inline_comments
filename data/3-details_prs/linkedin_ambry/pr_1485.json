{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MzczODU0", "number": 1485, "title": "Prevent compaction partial failure if possible, recover from it if necessary.", "bodyText": "Two complementary changes here:\n\nAdd shutdown hook to let compaction operations to complete.\nCheck for inconsistency in update operation and delete stray Cosmos record.", "createdAt": "2020-04-24T07:15:09Z", "url": "https://github.com/linkedin/ambry/pull/1485", "merged": true, "mergeCommit": {"oid": "89cda7d808b393317554d958ccd935dc38377bd1"}, "closed": true, "closedAt": "2020-04-27T23:23:28Z", "author": {"login": "lightningrob"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcasGFfgH2gAyNDA4MzczODU0OjljMGUzMjM5N2I0NmY3MTNlNzkwMTljODU1MjI3OGFmMDg3MGE2MWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb3zVMgFqTQwMTM5NDg0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9c0e32397b46f713e79019c8552278af0870a61e", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/9c0e32397b46f713e79019c8552278af0870a61e", "committedDate": "2020-04-24T07:10:35Z", "message": "Prevent compaction partial failure if possible, and recover from it if necessary."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMTI5MzU0", "url": "https://github.com/linkedin/ambry/pull/1485#pullrequestreview-400129354", "createdAt": "2020-04-24T17:15:32Z", "commit": {"oid": "9c0e32397b46f713e79019c8552278af0870a61e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzoxNTozMlrOGLhYoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNzoxNTozMlrOGLhYoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczNDQ5Nw==", "bodyText": "Can we log a metric here? Will be easier to track. Otherwise this will get lost in log messages.", "url": "https://github.com/linkedin/ambry/pull/1485#discussion_r414734497", "createdAt": "2020-04-24T17:15:32Z", "author": {"login": "ankagrawal"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/CloudStorageCompactor.java", "diffHunk": "@@ -65,6 +73,29 @@ public void run() {\n     }\n   }\n \n+  /**\n+   * Shut down the compactor waiting for in progress operations to complete.\n+   */\n+  public void shutdown() {\n+    shuttingDown.set(true);\n+    logger.info(\"Compactor received shutdown request, waiting up to {} seconds for in-flight operations to finish\",\n+        shutDownTimeoutSecs);\n+    try {\n+      doneLatch.get().await(shutDownTimeoutSecs, TimeUnit.SECONDS);\n+      logger.info(\"Compactor shut down successfully.\");\n+    } catch (InterruptedException ex) {\n+      logger.warn(\"Timed out waiting for operations to finish.  If cloud provider uses separate stores for \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c0e32397b46f713e79019c8552278af0870a61e"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMTk3NTgx", "url": "https://github.com/linkedin/ambry/pull/1485#pullrequestreview-401197581", "createdAt": "2020-04-27T18:03:35Z", "commit": {"oid": "9c0e32397b46f713e79019c8552278af0870a61e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODowMzozNVrOGMwoew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODoyNTozMVrOGMxjzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAzMjg5MQ==", "bodyText": "When a latch times out, it actually doesn't throw an exception, it just returns false, so the return value has to be checked. The InterruptedException is only thrown if the thread is actually interrupted.", "url": "https://github.com/linkedin/ambry/pull/1485#discussion_r416032891", "createdAt": "2020-04-27T18:03:35Z", "author": {"login": "cgtz"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/CloudStorageCompactor.java", "diffHunk": "@@ -65,6 +73,29 @@ public void run() {\n     }\n   }\n \n+  /**\n+   * Shut down the compactor waiting for in progress operations to complete.\n+   */\n+  public void shutdown() {\n+    shuttingDown.set(true);\n+    logger.info(\"Compactor received shutdown request, waiting up to {} seconds for in-flight operations to finish\",\n+        shutDownTimeoutSecs);\n+    try {\n+      doneLatch.get().await(shutDownTimeoutSecs, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c0e32397b46f713e79019c8552278af0870a61e"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA0ODA3OA==", "bodyText": "udpate -> update\nWas the previous javadoc inaccurate? It seems like the old code would have also thrown an exception on not found.", "url": "https://github.com/linkedin/ambry/pull/1485#discussion_r416048078", "createdAt": "2020-04-27T18:25:31Z", "author": {"login": "cgtz"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/azure/AzureCloudDestination.java", "diffHunk": "@@ -248,7 +249,7 @@ public FindResult findEntriesSince(String partitionPath, FindToken findToken, lo\n    * @param blobId The {@link BlobId} to update.\n    * @param fieldName The metadata field to modify.\n    * @param value The new value.\n-   * @return {@code true} if the udpate succeeded, {@code false} if the metadata record was not found.\n+   * @return {@code true} if the udpate succeeded, {@code false} if no update was needed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c0e32397b46f713e79019c8552278af0870a61e"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b314ee1bb9a454ec2b4fc14595b556e9653281b6", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/b314ee1bb9a454ec2b4fc14595b556e9653281b6", "committedDate": "2020-04-27T20:42:44Z", "message": "Address review comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35ab8f5b2414afc2b7621d70f74204cf8af2e86e", "author": {"user": {"login": "shipkit-org", "name": "shipkit.org automated bot"}}, "url": "https://github.com/linkedin/ambry/commit/35ab8f5b2414afc2b7621d70f74204cf8af2e86e", "committedDate": "2020-04-27T22:16:25Z", "message": "Minor logging change to trigger rebuild"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMzk0ODQ2", "url": "https://github.com/linkedin/ambry/pull/1485#pullrequestreview-401394846", "createdAt": "2020-04-27T23:22:53Z", "commit": {"oid": "35ab8f5b2414afc2b7621d70f74204cf8af2e86e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1419, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}