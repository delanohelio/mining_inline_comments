{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NzIzMDYw", "number": 1607, "title": "Add configuration to limit the number of concurrent delete operations in background deleter", "bodyText": "Blobs in delivery cluster are usually pretty huge. When router is trying to delete a blob, router would create delete operations for all the chunks of this blob. The number of chunks which belong to this blob can be huge, and background deleter would flood the network client with delete operations. This might cause connection unavailable error when the servers are not responding to the frontends fast enough.\nSince they are background deletes, we can de-prioritize them by setting a limit on how many concurrent delete operations a router can have. By doing so, we would mitigate the connection unavailable error.\nHowever, this is not an ideal solution. To solve this issue, we should\n\nSet a different time out for checking connection from pool for background deletes.\nDe-prioritize background delete requests in the network layer (and maybe retry?) to support better QOS.", "createdAt": "2020-08-18T20:19:51Z", "url": "https://github.com/linkedin/ambry/pull/1607", "merged": true, "mergeCommit": {"oid": "98d86462bd6e5e79cd0dd7d93065f0b58516c35d"}, "closed": true, "closedAt": "2020-08-19T17:26:24Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAM0ZwAH2gAyNDY5NzIzMDYwOjU3NTRiMTNkNDQ5NWY4NzRkZWMyOGE0MjdhNTA3MDM3NTFhYzc0Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAfBvyAFqTQ3MDY4NzI1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5754b13d4495f874dec28a427a50703751ac7477", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/5754b13d4495f874dec28a427a50703751ac7477", "committedDate": "2020-08-18T20:13:20Z", "message": "Add configuration to limit the number of concurrent delete operations in background deleter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3c529962db14c8c45b3f6bef280976ca1bc584d", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/e3c529962db14c8c45b3f6bef280976ca1bc584d", "committedDate": "2020-08-18T20:24:44Z", "message": "Add metric"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODU1OTk2", "url": "https://github.com/linkedin/ambry/pull/1607#pullrequestreview-469855996", "createdAt": "2020-08-18T21:51:23Z", "commit": {"oid": "e3c529962db14c8c45b3f6bef280976ca1bc584d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo1MToyM1rOHCn9Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo1MjoyMlrOHCn-_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMzg5MA==", "bodyText": "Prefer to use -1. To reduce some <= confusion in below.", "url": "https://github.com/linkedin/ambry/pull/1607#discussion_r472513890", "createdAt": "2020-08-18T21:51:23Z", "author": {"login": "zzmao"}, "path": "ambry-api/src/main/java/com/github/ambry/config/RouterConfig.java", "diffHunk": "@@ -500,6 +502,13 @@\n   @Default(\"false\")\n   public final boolean routerCrossColoRequestToDcWithMostReplicas;\n \n+  /**\n+   * The maximum number of outgoing delete operations in background deleter. 0 means no limit.\n+   */\n+  @Config(ROUTER_BACKGROUND_DELETER_MAX_CONCURRENT_OPERATIONS)\n+  @Default(\"0\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3c529962db14c8c45b3f6bef280976ca1bc584d"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxNDMwMQ==", "bodyText": "Update Java Doc.", "url": "https://github.com/linkedin/ambry/pull/1607#discussion_r472514301", "createdAt": "2020-08-18T21:52:22Z", "author": {"login": "zzmao"}, "path": "ambry-router/src/main/java/com/github/ambry/router/NonBlockingRouter.java", "diffHunk": "@@ -1085,12 +1104,49 @@ protected void updateBlobTtl(String blobIdStr, final String serviceId, long expi\n       completeUpdateBlobTtlOperation(routerException, futureResult, callback);\n     }\n \n+    /**\n+     * Requests for a blob to be deleted asynchronously and invokes the {@link Callback} when the request completes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3c529962db14c8c45b3f6bef280976ca1bc584d"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODg0NDY3", "url": "https://github.com/linkedin/ambry/pull/1607#pullrequestreview-469884467", "createdAt": "2020-08-18T22:56:20Z", "commit": {"oid": "e3c529962db14c8c45b3f6bef280976ca1bc584d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMjo1NjoyMFrOHCpcLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMjo1NjoyMFrOHCpcLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUzODE1OA==", "bodyText": "In practice, probably almost no difference, but it may be slightly better to use ConcurrentLinkedQueue instead of deque if we don't need the extra deque features right now.\nThe deque impl mentions this:\n     * Empirically, microbenchmarks suggest that this class adds about\n     * 40% overhead relative to ConcurrentLinkedQueue, which feels as\n     * good as we can hope for.", "url": "https://github.com/linkedin/ambry/pull/1607#discussion_r472538158", "createdAt": "2020-08-18T22:56:20Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com/github/ambry/router/NonBlockingRouter.java", "diffHunk": "@@ -1034,8 +1044,10 @@ public void run() {\n    * 2. (TBD) Deleting successfully put chunks of a failed composite blob put operation. Today, this is done by the\n    * same {@link OperationController} doing the put.\n    */\n-  private class BackgroundDeleter extends OperationController {\n+  class BackgroundDeleter extends OperationController {\n+    private final AtomicInteger concurrentBackgroudDeleteOperationCount = new AtomicInteger();\n     private final Logger logger = LoggerFactory.getLogger(getClass());\n+    private final ConcurrentLinkedDeque<Supplier<Void>> deleteOperationQueue = new ConcurrentLinkedDeque<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3c529962db14c8c45b3f6bef280976ca1bc584d"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09719a09c8f0cc3b589faeace7e871acaa38c741", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/09719a09c8f0cc3b589faeace7e871acaa38c741", "committedDate": "2020-08-19T02:05:17Z", "message": "Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjc3MTM3", "url": "https://github.com/linkedin/ambry/pull/1607#pullrequestreview-470677137", "createdAt": "2020-08-19T17:12:41Z", "commit": {"oid": "09719a09c8f0cc3b589faeace7e871acaa38c741"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjg3MjUy", "url": "https://github.com/linkedin/ambry/pull/1607#pullrequestreview-470687252", "createdAt": "2020-08-19T17:26:12Z", "commit": {"oid": "09719a09c8f0cc3b589faeace7e871acaa38c741"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1212, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}