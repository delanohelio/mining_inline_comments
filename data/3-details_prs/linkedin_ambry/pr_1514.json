{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NDgzNjQ0", "number": 1514, "title": "Make BlobUndeleted not an error in router and more tests", "bodyText": "BlobAlreadyUndeleted is not an error response in router from this PR on.\nThere are several ways ambry server might return BlobAlreadyUndeleted.\n\nFrontend makes several attempts to undelete a blob\nFrontend and replication concurrently undelete a blob (this happens a lot)\n\nIn both cases, we can ignore the BlobAlreadyUndeleted error and just treat it as an NoError.\nAlso more integration tests are added.", "createdAt": "2020-05-09T00:18:18Z", "url": "https://github.com/linkedin/ambry/pull/1514", "merged": true, "mergeCommit": {"oid": "727a2b1046a3b7d6ca0015b4345afd75cc6d73a4"}, "closed": true, "closedAt": "2020-05-19T21:50:21Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcikYWOgFqTQxMzg0Mzc3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABci7BE-gH2gAyNDE1NDgzNjQ0OmJkZDdjZjVjZmE3MTMxOTlhYjFkYjNjM2I3NjE3NjIxYzFlY2VlYTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODQzNzc1", "url": "https://github.com/linkedin/ambry/pull/1514#pullrequestreview-413843775", "createdAt": "2020-05-18T18:37:36Z", "commit": {"oid": "9f253c01658b8d57efe18c995bc27ba25fa6adb6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxODozNzozN1rOGXDGbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxODo0MToyMlrOGXDNoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyMTIzMA==", "bodyText": "Instead of the logic in AmbryRequests to look up the life version again, could the life version be carried inside of the StoreException? You could create an UndeleteStoreException that extends StoreException and then AmbryRequests can handle it with an instanceof check:\nif (e instanceof UndeleteStoreException) {\n  response = Response(e.getErrorCode(), ((UndeleteStoreException) e).getLifeVersion());\n}\n\nI feel like this would keep the boundary between store logic and request handling logic more clear.", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r426821230", "createdAt": "2020-05-18T18:37:37Z", "author": {"login": "cgtz"}, "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStore.java", "diffHunk": "@@ -727,22 +735,32 @@ public short undelete(MessageInfo info) throws StoreException {\n         Offset currentIndexEndOffset = index.getCurrentEndOffset();\n         if (!currentIndexEndOffset.equals(indexEndOffsetBeforeCheck)) {\n           FileSpan fileSpan = new FileSpan(indexEndOffsetBeforeCheck, currentIndexEndOffset);\n-          IndexValue value =\n-              index.findKey(info.getStoreKey(), fileSpan, EnumSet.allOf(PersistentIndex.IndexEntryType.class));\n+          IndexValue value = index.findKey(info.getStoreKey(), fileSpan,\n+              EnumSet.of(PersistentIndex.IndexEntryType.DELETE, PersistentIndex.IndexEntryType.UNDELETE));\n           if (value != null) {\n-            throw new StoreException(\"Cannot undelete id \" + info.getStoreKey() + \" since concurrent operation occurs\",\n-                StoreErrorCodes.Life_Version_Conflict);\n+            if (value.isUndelete() && value.getLifeVersion() == revisedLifeVersion) {\n+              // Might get an concurrent undelete from both replication and frontend. This is considered as an\n+              // successful operation and the exception will be captured by the catch statement below.\n+              throw new StoreException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f253c01658b8d57efe18c995bc27ba25fa6adb6"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyMzA3Mw==", "bodyText": "How is the life version field in the error UndeleteResponse used?", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r426823073", "createdAt": "2020-05-18T18:41:22Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com/github/ambry/router/UndeleteOperation.java", "diffHunk": "@@ -195,6 +194,7 @@ void handleResponse(ResponseInfo responseInfo, UndeleteResponse undeleteResponse\n               // This is first successful response.\n               lifeVersion = undeleteResponse.getLifeVersion();\n               firstResponseReplicaId = replica;\n+              operationTracker.onResponse(replica, TrackedRequestFinalState.SUCCESS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f253c01658b8d57efe18c995bc27ba25fa6adb6"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f253c01658b8d57efe18c995bc27ba25fa6adb6", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/9f253c01658b8d57efe18c995bc27ba25fa6adb6", "committedDate": "2020-05-09T00:15:12Z", "message": "Make BlobUndeleted not an error in router and more tests"}, "afterCommit": {"oid": "ce66095af98fe98e64eba096c728604fd99f3737", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/ce66095af98fe98e64eba096c728604fd99f3737", "committedDate": "2020-05-19T00:13:40Z", "message": "Add IdUndeletedStoreException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NzgyNjg0", "url": "https://github.com/linkedin/ambry/pull/1514#pullrequestreview-414782684", "createdAt": "2020-05-19T20:05:45Z", "commit": {"oid": "f159f152adbea2bedb20d063385a6c527afc995b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDowNTo0NVrOGXwqWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDowODowNVrOGXwvMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU2NzcwNw==", "bodyText": "nit: end file with newline", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r427567707", "createdAt": "2020-05-19T20:05:45Z", "author": {"login": "cgtz"}, "path": "ambry-api/src/main/java/com/github/ambry/store/IdUndeletedStoreException.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.store;\n+\n+/**\n+ * This is a dedicated exception for {@link StoreErrorCodes#ID_Undeleted}. When {@link Store} throws an Exception\n+ * for {@link StoreErrorCodes#ID_Undeleted}, it's better that it throws an {@link IdUndeletedStoreException}.\n+ */\n+public class IdUndeletedStoreException extends StoreException {\n+  private final short lifeVersion;\n+\n+  /**\n+   * Constructor to create a {@link IdUndeletedStoreException}.\n+   * @param message The error message.\n+   * @param lifeVersion The lifeVersion.\n+   */\n+  public IdUndeletedStoreException(String message, short lifeVersion) {\n+    super(message, StoreErrorCodes.ID_Undeleted);\n+    this.lifeVersion = lifeVersion;\n+  }\n+\n+  /**\n+   * @return The lifeVersion for the current undelete record.\n+   */\n+  public short getLifeVersion() {\n+    return lifeVersion;\n+  }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f159f152adbea2bedb20d063385a6c527afc995b"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU2ODk0Ng==", "bodyText": "since there is no live site traffic performing undeletes yet, this schema change should be ok, right?", "url": "https://github.com/linkedin/ambry/pull/1514#discussion_r427568946", "createdAt": "2020-05-19T20:08:05Z", "author": {"login": "cgtz"}, "path": "ambry-protocol/src/main/java/com/github/ambry/protocol/UndeleteResponse.java", "diffHunk": "@@ -62,6 +62,18 @@ public UndeleteResponse(int correlationId, String clientId, short lifeVersion) {\n     this.lifeVersion = lifeVersion;\n   }\n \n+  /**\n+   * Constructs a {@link UndeleteResponse} with a valid lifeVersion. The error code will be set to {@link ServerErrorCode#No_Error}.\n+   * @param correlationId correlationId of the undelete response.\n+   * @param clientId clientId of the undelete response.\n+   * @param lifeVersion a valid lifeVersion to return to client.\n+   * @param error error code returned in this undelete response.\n+   */\n+  public UndeleteResponse(int correlationId, String clientId, short lifeVersion, ServerErrorCode error) {\n+    super(RequestOrResponseType.UndeleteResponse, UNDELETE_RESPONSE_VERSION_1, correlationId, clientId, error);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f159f152adbea2bedb20d063385a6c527afc995b"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1096f982768d1b13536c8a054141f878e351f38b", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/1096f982768d1b13536c8a054141f878e351f38b", "committedDate": "2020-05-19T20:35:04Z", "message": "Make BlobUndeleted not an error in router and more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86e195fc6eb725f00410b45382f4395332594fee", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/86e195fc6eb725f00410b45382f4395332594fee", "committedDate": "2020-05-19T20:35:04Z", "message": "Add IdUndeletedStoreException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "904e0f5653ebee0fca61e6a86ca4cb5875422e2f", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/904e0f5653ebee0fca61e6a86ca4cb5875422e2f", "committedDate": "2020-05-19T20:35:04Z", "message": "More test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dbe868a98322acefd93bc85c1d2935932111298", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/4dbe868a98322acefd93bc85c1d2935932111298", "committedDate": "2020-05-19T20:36:02Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f159f152adbea2bedb20d063385a6c527afc995b", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/f159f152adbea2bedb20d063385a6c527afc995b", "committedDate": "2020-05-19T00:37:59Z", "message": "More test"}, "afterCommit": {"oid": "4dbe868a98322acefd93bc85c1d2935932111298", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/4dbe868a98322acefd93bc85c1d2935932111298", "committedDate": "2020-05-19T20:36:02Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODA5MjQ2", "url": "https://github.com/linkedin/ambry/pull/1514#pullrequestreview-414809246", "createdAt": "2020-05-19T20:45:24Z", "commit": {"oid": "4dbe868a98322acefd93bc85c1d2935932111298"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdd7cf5cfa713199ab1db3c3b7617621c1eceea5", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/bdd7cf5cfa713199ab1db3c3b7617621c1eceea5", "committedDate": "2020-05-19T21:05:05Z", "message": "Addin testing event log to ambry-store;"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1475, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}