{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzNzM4ODEz", "number": 1735, "title": "[named_blobs] Avoid bad affected row count assumptions", "bodyText": "Previously, the put code used an \"insert on duplicate key\" expression\nwith conditional assignments. However, this required using the affected\nrows to count how many rows actually changed. If the DB is set up to use\ntriggers that assign other metadata columns, the row may change even if\nthe specific fields set in the update call did not.\nAs an alternative, we can switch to the default \"found rows\" jdbc\nbehavior and use an optimistic insert followed by a conditional update.", "createdAt": "2020-12-21T21:38:42Z", "url": "https://github.com/linkedin/ambry/pull/1735", "merged": true, "mergeCommit": {"oid": "a9cc0d27ca4ccfe561e4c095f2958d15c5616d47"}, "closed": true, "closedAt": "2021-01-14T20:52:55Z", "author": {"login": "cgtz"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdofcgcAH2gAyNTQzNzM4ODEzOjk1ZjAzM2JmYzQyZmE5MjM5MTRlMDNmYTM0MWZlMjNkNTA0ZDJhMGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtTmXqAFqTU2MjIwMDUzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/95f033bfc42fa923914e03fa341fe23d504d2a0b", "committedDate": "2020-12-22T00:32:24Z", "message": "[named_blobs] Avoid bad affected row count assumptions\n\nPreviously, the put code used an \"insert on duplicate key\" expression\nwith conditional assignments. However, this required using the affected\nrows to count how many rows actually changed. If the DB is set up to use\ntriggers that assign other metadata columns, the row may change even if\nthe specific fields set in the update call did not.\n\nAs an alternative, we can switch to the default \"found rows\" jdbc\nbehavior and use an optimistic insert followed by a conditional update."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d68ada9d717aa99891486e423401415a829bb96f", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/d68ada9d717aa99891486e423401415a829bb96f", "committedDate": "2020-12-21T21:33:48Z", "message": "[named_blobs] Avoid bad affected row count assumptions\n\nPreviously, the put code used an \"insert on duplicate key\" expression\nwith conditional assignments. However, this required using the affected\nrows to count how many rows actually changed. If the DB is set up to use\ntriggers that assign other metadata columns, the row may change even if\nthe specific fields set in the update call did not.\n\nAs an alternative, we can switch to the default \"found rows\" jdbc\nbehavior and use an optimistic insert followed by a conditional update."}, "afterCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b", "author": {"user": {"login": "cgtz", "name": "Casey Getz"}}, "url": "https://github.com/linkedin/ambry/commit/95f033bfc42fa923914e03fa341fe23d504d2a0b", "committedDate": "2020-12-22T00:32:24Z", "message": "[named_blobs] Avoid bad affected row count assumptions\n\nPreviously, the put code used an \"insert on duplicate key\" expression\nwith conditional assignments. However, this required using the affected\nrows to count how many rows actually changed. If the DB is set up to use\ntriggers that assign other metadata columns, the row may change even if\nthe specific fields set in the update call did not.\n\nAs an alternative, we can switch to the default \"found rows\" jdbc\nbehavior and use an optimistic insert followed by a conditional update."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Mjk4MDU3", "url": "https://github.com/linkedin/ambry/pull/1735#pullrequestreview-557298057", "createdAt": "2020-12-22T18:57:44Z", "commit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMjAwNTMw", "url": "https://github.com/linkedin/ambry/pull/1735#pullrequestreview-562200530", "createdAt": "2021-01-05T23:04:09Z", "commit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzowNDowOVrOIOquwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzozMjowN1rOIOrU1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1MTA3Mg==", "bodyText": "Is there any logic change in this class or only refactoring?", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r552251072", "createdAt": "2021-01-05T23:04:09Z", "author": {"login": "lightningrob"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/NamedBlobPutHandler.java", "diffHunk": "@@ -145,48 +145,6 @@ private void start() {\n       }\n     }\n \n-    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1NjA0Mw==", "bodyText": "Still need the indexes (4,5,6)?", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r552256043", "createdAt": "2021-01-05T23:18:07Z", "author": {"login": "lightningrob"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -84,27 +83,32 @@\n       EXPIRES_TS, DELETED_TS, NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID);\n \n   /**\n-   * Create a blob name to blob ID mapping if a record for that blob name does not exist.\n-   * If there is an existing record but the existing blob was soft deleted or expired, allow it to be overwritten.\n-   * If there is an existing record and the existing blob is still valid (not expired or soft deleted), do not\n-   * overwrite it.\n-   * <p>\n-   * Eventually the put operation will support updates to the mapping in the third case above, but that requires other\n-   * work around concurrency control.\n+   * Attempt to insert a new mapping into the database.\n    */\n-  private static final String PUT_QUERY = String.format(\n-      \"INSERT INTO %1$s (%2$s, %3$s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE \"\n-          + \"%5$s = IF(%8$s, VALUES(%5$s), %5$s), %6$s = IF(%8$s, VALUES(%6$s), %6$s), %7$s = IF(%8$s, null, %7$s)\",\n-      NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID, BLOB_NAME, BLOB_ID, EXPIRES_TS, DELETED_TS, IS_DELETED_OR_EXPIRED);\n+  private static final String INSERT_QUERY =\n+      String.format(\"INSERT INTO %s (%s, %s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?)\", NAMED_BLOBS, ACCOUNT_ID,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1Njk2MQ==", "bodyText": "Just curious, why are you updating the blobId column here?", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r552256961", "createdAt": "2021-01-05T23:20:43Z", "author": {"login": "lightningrob"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -84,27 +83,32 @@\n       EXPIRES_TS, DELETED_TS, NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID);\n \n   /**\n-   * Create a blob name to blob ID mapping if a record for that blob name does not exist.\n-   * If there is an existing record but the existing blob was soft deleted or expired, allow it to be overwritten.\n-   * If there is an existing record and the existing blob is still valid (not expired or soft deleted), do not\n-   * overwrite it.\n-   * <p>\n-   * Eventually the put operation will support updates to the mapping in the third case above, but that requires other\n-   * work around concurrency control.\n+   * Attempt to insert a new mapping into the database.\n    */\n-  private static final String PUT_QUERY = String.format(\n-      \"INSERT INTO %1$s (%2$s, %3$s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?) ON DUPLICATE KEY UPDATE \"\n-          + \"%5$s = IF(%8$s, VALUES(%5$s), %5$s), %6$s = IF(%8$s, VALUES(%6$s), %6$s), %7$s = IF(%8$s, null, %7$s)\",\n-      NAMED_BLOBS, ACCOUNT_ID, CONTAINER_ID, BLOB_NAME, BLOB_ID, EXPIRES_TS, DELETED_TS, IS_DELETED_OR_EXPIRED);\n+  private static final String INSERT_QUERY =\n+      String.format(\"INSERT INTO %s (%s, %s, %4$s, %5$s, %6$s) VALUES (?, ?, ?, ?, ?)\", NAMED_BLOBS, ACCOUNT_ID,\n+          CONTAINER_ID, BLOB_NAME, BLOB_ID, EXPIRES_TS);\n \n-  private static final String SELECT_FOR_DELETE_QUERY =\n+  /**\n+   * If a record already exists for a named blob, attempt an update if the record in the DB represents an expired or\n+   * deleted blob.\n+   */\n+  private static final String UPDATE_IF_DELETED_OR_EXPIRED_QUERY =\n+      String.format(\"UPDATE %s SET %s = ?, %s = ?, %s = null WHERE %s AND %s\", NAMED_BLOBS, BLOB_ID, EXPIRES_TS,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2MDgyMQ==", "bodyText": "What happens to the locked record if the update is not made?  In either case, when does it get unlocked (not sure if this whole thing is inside a transaction)?", "url": "https://github.com/linkedin/ambry/pull/1735#discussion_r552260821", "createdAt": "2021-01-05T23:32:07Z", "author": {"login": "lightningrob"}, "path": "ambry-named-mysql/src/main/java/com/github/ambry/named/MySqlNamedBlobDb.java", "diffHunk": "@@ -250,8 +276,8 @@\n       }\n       // only need to issue an update statement if the row was not already marked as deleted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95f033bfc42fa923914e03fa341fe23d504d2a0b"}, "originalPosition": 150}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1062, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}