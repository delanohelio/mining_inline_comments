{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1OTEwNTk5", "number": 1422, "title": "Bump the message header version from 2 to 3", "bodyText": "Change the message header version from 2 to 3 so that we can save lifeVersion in the log.", "createdAt": "2020-03-10T02:56:57Z", "url": "https://github.com/linkedin/ambry/pull/1422", "merged": true, "mergeCommit": {"oid": "ee1e8cbb16677bbb18326c9f5aabaa651d73d81a"}, "closed": true, "closedAt": "2020-03-13T22:01:57Z", "author": {"login": "justinlin-linkedin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMtq5CgFqTM3MzEyNDkxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNU0O1gH2gAyMzg1OTEwNTk5OjVkMThkNTI4NTBjMjZkYWZmZTJkMGU3MDFiMWU0Y2EzODU0ZDRlZDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTI0OTE2", "url": "https://github.com/linkedin/ambry/pull/1422#pullrequestreview-373124916", "createdAt": "2020-03-11T21:05:37Z", "commit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMTowNTozN1rOF1JE6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMTowNTozN1rOF1JE6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI2NzU2MQ==", "bodyText": "Just want to make sure one thing. For V2 and V2, info.getLifeVersion() returns -1, right?", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391267561", "createdAt": "2020-03-11T21:05:37Z", "author": {"login": "zzmao"}, "path": "ambry-replication/src/test/java/com.github.ambry.replication/InMemoryStore.java", "diffHunk": "@@ -264,7 +264,7 @@ public void updateTtl(List<MessageInfo> infos) throws StoreException {\n         }\n         MessageFormatInputStream stream =\n             new TtlUpdateMessageFormatInputStream(info.getStoreKey(), info.getAccountId(), info.getContainerId(),\n-                info.getExpirationTimeInMs(), info.getOperationTimeMs());\n+                info.getExpirationTimeInMs(), info.getOperationTimeMs(), info.getLifeVersion());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjczNjg2", "url": "https://github.com/linkedin/ambry/pull/1422#pullrequestreview-373273686", "createdAt": "2020-03-12T04:36:54Z", "commit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDozNjo1NFrOF1Q_Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNToyMToxMlrOF1RkHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5NzIyMw==", "bodyText": "can be removed", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391397223", "createdAt": "2020-03-12T04:36:54Z", "author": {"login": "jsjtzyy"}, "path": "ambry-messageformat/src/main/java/com.github.ambry.messageformat/PutMessageFormatInputStream.java", "diffHunk": "@@ -13,6 +13,7 @@\n  */\n package com.github.ambry.messageformat;\n \n+import com.github.ambry.store.Message;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5Nzk3Mw==", "bodyText": "you can change this to:\nthis(key, blobEncryptionKey, blobProperties, userMetadata, blobStream, streamSize, BlobType.DataBlob, (short) 0);\n\navoiding an extra method call.", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391397973", "createdAt": "2020-03-12T04:41:02Z", "author": {"login": "jsjtzyy"}, "path": "ambry-messageformat/src/main/java/com.github.ambry.messageformat/PutMessageFormatInputStream.java", "diffHunk": "@@ -43,27 +44,33 @@\n   public PutMessageFormatInputStream(StoreKey key, ByteBuffer blobEncryptionKey, BlobProperties blobProperties,\n       ByteBuffer userMetadata, InputStream blobStream, long streamSize, BlobType blobType)\n       throws MessageFormatException {\n-    if (MessageFormatRecord.headerVersionToUse == MessageFormatRecord.Message_Header_Version_V2) {\n-      createStreamWithMessageHeaderV2(key, blobEncryptionKey, blobProperties, userMetadata, blobStream, streamSize,\n-          blobType);\n-    } else {\n-      createStreamWithMessageHeaderV1(key, blobProperties, userMetadata, blobStream, streamSize, blobType);\n-    }\n+    this(key, blobEncryptionKey, blobProperties, userMetadata, blobStream, streamSize, blobType, (short) 0);\n   }\n \n   public PutMessageFormatInputStream(StoreKey key, ByteBuffer blobEncryptionKey, BlobProperties blobProperties,\n       ByteBuffer userMetadata, InputStream blobStream, long streamSize) throws MessageFormatException {\n     this(key, blobEncryptionKey, blobProperties, userMetadata, blobStream, streamSize, BlobType.DataBlob);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwNTI3Ng==", "bodyText": "nit: could you change ind to index?", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391405276", "createdAt": "2020-03-12T05:15:03Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/main/java/com.github.ambry.store/BlobStore.java", "diffHunk": "@@ -507,14 +507,9 @@ public void delete(List<MessageInfo> infosToDelete) throws StoreException {\n         List<MessageInfo> updatedInfos = new ArrayList<>(infosToDelete.size());\n         int ind = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwNjIzOA==", "bodyText": "same here", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391406238", "createdAt": "2020-03-12T05:19:30Z", "author": {"login": "jsjtzyy"}, "path": "ambry-store/src/main/java/com.github.ambry.store/BlobStore.java", "diffHunk": "@@ -619,16 +614,9 @@ public void updateTtl(List<MessageInfo> infosToUpdate) throws StoreException {\n         List<MessageInfo> updatedInfos = new ArrayList<>(infosToUpdate.size());\n         int ind = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwNjYyMg==", "bodyText": "Could you explain \"- 2\" here?", "url": "https://github.com/linkedin/ambry/pull/1422#discussion_r391406622", "createdAt": "2020-03-12T05:21:12Z", "author": {"login": "jsjtzyy"}, "path": "ambry-tools/src/main/java/com.github.ambry/store/DumpDataHelper.java", "diffHunk": "@@ -92,6 +92,20 @@ static LogBlobRecordInfo readSingleRecordFromLog(RandomAccessFile randomAccessFi\n                 + header.getUserMetadataRecordRelativeOffset() + \" dataRelativeOffset \"\n                 + header.getBlobRecordRelativeOffset() + \" crc \" + header.getCrc();\n         totalRecordSize += header.getMessageSize() + buffer.capacity();\n+      } else if (version == MessageFormatRecord.Message_Header_Version_V3) {\n+        ByteBuffer buffer = ByteBuffer.allocate(MessageFormatRecord.MessageHeader_Format_V3.getHeaderSize());\n+        buffer.putShort(version);\n+        randomAccessFile.read(buffer.array(), 2, buffer.capacity() - 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06bd3d301d0e80c5cef832bbd2a7a04a9e1ef71b", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/06bd3d301d0e80c5cef832bbd2a7a04a9e1ef71b", "committedDate": "2020-03-12T19:12:53Z", "message": "Bump the message header version from 2 to 3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf4b5801de23018e302f5848a54dd0fe0b00a595", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/cf4b5801de23018e302f5848a54dd0fe0b00a595", "committedDate": "2020-03-12T19:12:53Z", "message": "Add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0625ea2e2648b2578725aeb48cbf8324d63033d0", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/0625ea2e2648b2578725aeb48cbf8324d63033d0", "committedDate": "2020-03-12T22:04:32Z", "message": "Add even more tests for version compatibility"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "74ae36479409fb4b780fda0e92afe28e48d6852d", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/74ae36479409fb4b780fda0e92afe28e48d6852d", "committedDate": "2020-03-11T20:17:41Z", "message": "Add more tests"}, "afterCommit": {"oid": "0625ea2e2648b2578725aeb48cbf8324d63033d0", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/0625ea2e2648b2578725aeb48cbf8324d63033d0", "committedDate": "2020-03-12T22:04:32Z", "message": "Add even more tests for version compatibility"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczOTM1Njk4", "url": "https://github.com/linkedin/ambry/pull/1422#pullrequestreview-373935698", "createdAt": "2020-03-12T22:11:18Z", "commit": {"oid": "0625ea2e2648b2578725aeb48cbf8324d63033d0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f7070d13f66ded3d0102dc59726957d55d88c96", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/4f7070d13f66ded3d0102dc59726957d55d88c96", "committedDate": "2020-03-12T23:39:08Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d18d52850c26daffe2d0e701b1e4ca3854d4ed7", "author": {"user": {"login": "justinlin-linkedin", "name": "Justin Lin"}}, "url": "https://github.com/linkedin/ambry/commit/5d18d52850c26daffe2d0e701b1e4ca3854d4ed7", "committedDate": "2020-03-13T18:42:15Z", "message": "Address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1294, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}