{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMzcwMzYw", "number": 1535, "title": "Add lastUpdateTime for container and select container meet retention time during compaction", "bodyText": "This PR add a new field variable called lastUpdateTime for containers, so during compaction it will only compact the container meet with retention time at each compaction cycle.", "createdAt": "2020-05-26T18:11:36Z", "url": "https://github.com/linkedin/ambry/pull/1535", "merged": true, "mergeCommit": {"oid": "13bf118e4fe87e462314807de8089243061aa37e"}, "closed": true, "closedAt": "2020-06-01T19:42:42Z", "author": {"login": "SophieGuo410"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclIrTQgH2gAyNDIzMzcwMzYwOmI4MWY2NmI5OTIyODdmNzU1YjYzNGFmMzE4Mjc1NDViNDJlMzM4ZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnFnPfgFqTQyMjEyNzkyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b81f66b992287f755b634af31827545b42e338f4", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/b81f66b992287f755b634af31827545b42e338f4", "committedDate": "2020-05-26T18:07:49Z", "message": "Retention time support for container deletion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NTYwNTcz", "url": "https://github.com/linkedin/ambry/pull/1535#pullrequestreview-418560573", "createdAt": "2020-05-26T18:20:29Z", "commit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODoyMDoyOVrOGaqsuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODoyNDo1N1rOGaq2sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxNTczNg==", "bodyText": "we can give lastUpdateTime a default value\nprivate long lastUpdateTime = System. currentTimeMillis();\n\nThis way we don't have to change the constructor's signature.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r430615736", "createdAt": "2020-05-26T18:20:29Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com/github/ambry/account/ContainerBuilder.java", "diffHunk": "@@ -29,6 +29,7 @@\n   private short id;\n   private String name;\n   private ContainerStatus status;\n+  private long lastUpdateTime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxNTc3NA==", "bodyText": "The beauty of having builder pattern is to avoid this massive change when adding a new field. I suggest that we make lastUpdateTime as an optional here. We can give lastUpdateTime a default value and only set the lastUpdateTime when it's not the default value.\npublic ContainerBuilder(short id, String name, ContainerStatus status, String description, short parentAccountId) {\n    this.id = id;\n    this.name = name;\n    this.status = status;\n    this.description = description;\n    this.parentAccountId = parentAccountId;\n}\n\npublic ContainerBuilder lastUpdateTime(long val) {\n    this.lastUpdateTime = val;\n    return this;\n}", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r430615774", "createdAt": "2020-05-26T18:20:33Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com/github/ambry/account/ContainerBuilder.java", "diffHunk": "@@ -78,12 +80,13 @@ public ContainerBuilder(Container origin) {\n    * @param description The description of the {@link Container}.\n    * @param parentAccountId The id of the parent {@link Account} of the {@link Container} to build.\n    */\n-  public ContainerBuilder(short id, String name, ContainerStatus status, String description, short parentAccountId) {\n+  public ContainerBuilder(short id, String name, ContainerStatus status, String description, short parentAccountId, long lastUpdateTime) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxNjg0Ng==", "bodyText": "this is a bad signature in builder. It should be\npublic ContainerBuilder lastUpdateTime(long val) {\n    this.lastUpdateTime = val;\n    return this;\n}\n\nIt's up to you to prefix set to the method name. I would not, but to keep it consistent with all the methods in this file, we probably should.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r430616846", "createdAt": "2020-05-26T18:22:25Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com/github/ambry/account/ContainerBuilder.java", "diffHunk": "@@ -116,6 +119,14 @@ public ContainerBuilder setStatus(ContainerStatus status) {\n     return this;\n   }\n \n+  /**\n+   * Sets the last update time of the {@link Container} to build.\n+   */\n+  public Long setLastUpdateTime(Long lastUpdateTime) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxNzY4Nw==", "bodyText": "please don't change the current version.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r430617687", "createdAt": "2020-05-26T18:23:53Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com/github/ambry/account/Container.java", "diffHunk": "@@ -478,6 +498,7 @@ JSONObject toJson() throws JSONException {\n         metadata.put(JSON_VERSION_KEY, JSON_VERSION_1);\n         metadata.put(CONTAINER_ID_KEY, id);\n         metadata.put(CONTAINER_NAME_KEY, name);\n+        metadata.put(CONTAINER_LAST_UPDATE_TIME_KEY, lastUpdateTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxODEyNQ==", "bodyText": "Please don't change the current version. Please add JSON_VERSON_3 and only in version_3 can we put container_last_update_time_key.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r430618125", "createdAt": "2020-05-26T18:24:39Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com/github/ambry/account/Container.java", "diffHunk": "@@ -487,6 +508,7 @@ JSONObject toJson() throws JSONException {\n         metadata.put(Container.JSON_VERSION_KEY, JSON_VERSION_2);\n         metadata.put(CONTAINER_ID_KEY, id);\n         metadata.put(CONTAINER_NAME_KEY, name);\n+        metadata.put(CONTAINER_LAST_UPDATE_TIME_KEY, lastUpdateTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxODI5MQ==", "bodyText": "please format this methood.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r430618291", "createdAt": "2020-05-26T18:24:57Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com/github/ambry/account/Container.java", "diffHunk": "@@ -535,6 +557,12 @@ public ContainerStatus getStatus() {\n     return status;\n   }\n \n+  /**\n+   * Gets the last update time of the container.\n+   * @return The last update time of the container.\n+   */\n+  public Long getLastUpdateTime() {return lastUpdateTime;}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "originalPosition": 117}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NTg0NDg5", "url": "https://github.com/linkedin/ambry/pull/1535#pullrequestreview-418584489", "createdAt": "2020-05-26T18:53:29Z", "commit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODo1MzoyOVrOGar3Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxODo1Njo0MFrOGar_BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzNDgyNg==", "bodyText": "This will set the default time to whatever the timestamp was when this classes static initialization completed. Maybe the default time should be 0 for consistency? Also, generally prefer long over Long when there is no need for a primitive to be null and no need to use the long as part of a generic. This avoids unnecessary unboxing penalties.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r430634826", "createdAt": "2020-05-26T18:53:29Z", "author": {"login": "cgtz"}, "path": "ambry-api/src/main/java/com/github/ambry/account/Container.java", "diffHunk": "@@ -136,6 +137,21 @@\n    */\n   public static final ContainerStatus UNKNOWN_CONTAINER_STATUS = ContainerStatus.ACTIVE;\n \n+  /**\n+   * The last update time of {@link #UNKNOWN_CONTAINER}\n+   */\n+  public static final Long UNKNOWN_CONTAINER_LAST_UPDATE_TIME = System.currentTimeMillis();\n+\n+  /**\n+   * The last update time of {@link #DEFAULT_PUBLIC_CONTAINER}\n+   */\n+  public static final Long DEFAULT_PUBLIC_CONTAINER_LAST_UPDATE_TIME = System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzNjQ3Nw==", "bodyText": "I think we should not create a version 3. version 2 was only created since we removed a field between v1 and v2.\nHowever, you are right that adding a new required field to an existing version will cause issues when deserializing existing records. Generally the best way to make the migration seamless for json documents is to make any new field optional in version 2.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r430636477", "createdAt": "2020-05-26T18:56:04Z", "author": {"login": "cgtz"}, "path": "ambry-api/src/main/java/com/github/ambry/account/Container.java", "diffHunk": "@@ -487,6 +508,7 @@ JSONObject toJson() throws JSONException {\n         metadata.put(Container.JSON_VERSION_KEY, JSON_VERSION_2);\n         metadata.put(CONTAINER_ID_KEY, id);\n         metadata.put(CONTAINER_NAME_KEY, name);\n+        metadata.put(CONTAINER_LAST_UPDATE_TIME_KEY, lastUpdateTime);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYxODEyNQ=="}, "originalCommit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzNjgwNQ==", "bodyText": "any new field added to an existing version should be optional so existing records can be deserialized by the new code.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r430636805", "createdAt": "2020-05-26T18:56:40Z", "author": {"login": "cgtz"}, "path": "ambry-api/src/main/java/com/github/ambry/account/Container.java", "diffHunk": "@@ -353,6 +371,7 @@ private Container(JSONObject metadata, short parentAccountId) throws JSONExcepti\n         id = (short) metadata.getInt(CONTAINER_ID_KEY);\n         name = metadata.getString(CONTAINER_NAME_KEY);\n         status = ContainerStatus.valueOf(metadata.getString(STATUS_KEY));\n+        lastUpdateTime = metadata.getLong(CONTAINER_LAST_UPDATE_TIME_KEY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81f66b992287f755b634af31827545b42e338f4"}, "originalPosition": 75}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c150c82418003c4b3782dfd935e97a6fc3c82be2", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/c150c82418003c4b3782dfd935e97a6fc3c82be2", "committedDate": "2020-05-27T05:50:59Z", "message": "address comments"}, "afterCommit": {"oid": "fcdcca1697a6297ca4727847c40d27f25ab56b6a", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/fcdcca1697a6297ca4727847c40d27f25ab56b6a", "committedDate": "2020-05-27T06:09:01Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcdcca1697a6297ca4727847c40d27f25ab56b6a", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/fcdcca1697a6297ca4727847c40d27f25ab56b6a", "committedDate": "2020-05-27T06:09:01Z", "message": "address comments"}, "afterCommit": {"oid": "64eea3cda811ca108182b6b5ad6112ab97f379a1", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/64eea3cda811ca108182b6b5ad6112ab97f379a1", "committedDate": "2020-05-27T06:26:21Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64eea3cda811ca108182b6b5ad6112ab97f379a1", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/64eea3cda811ca108182b6b5ad6112ab97f379a1", "committedDate": "2020-05-27T06:26:21Z", "message": "address comments"}, "afterCommit": {"oid": "60bc6bdedd9ff6e224ab1cb8d122ee7a8a57e0aa", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/60bc6bdedd9ff6e224ab1cb8d122ee7a8a57e0aa", "committedDate": "2020-05-27T06:58:08Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "812e422491acb2f378230d425203ebad0d047fa9", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/812e422491acb2f378230d425203ebad0d047fa9", "committedDate": "2020-05-27T22:18:55Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60bc6bdedd9ff6e224ab1cb8d122ee7a8a57e0aa", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/60bc6bdedd9ff6e224ab1cb8d122ee7a8a57e0aa", "committedDate": "2020-05-27T06:58:08Z", "message": "address comments"}, "afterCommit": {"oid": "812e422491acb2f378230d425203ebad0d047fa9", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/812e422491acb2f378230d425203ebad0d047fa9", "committedDate": "2020-05-27T22:18:55Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5Njk0NTkz", "url": "https://github.com/linkedin/ambry/pull/1535#pullrequestreview-419694593", "createdAt": "2020-05-28T00:13:56Z", "commit": {"oid": "812e422491acb2f378230d425203ebad0d047fa9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMDoxMzo1NlrOGbhdFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMDoxMzo1NlrOGbhdFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUxMjg1NQ==", "bodyText": "The PR looks good after addressing people's comments.\nI have one concern:  lastUpdateTime sounds like a general update time. Any update can refer to it.\nBut in this PR, it is used as delete triggered time.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r431512855", "createdAt": "2020-05-28T00:13:56Z", "author": {"login": "zzmao"}, "path": "ambry-api/src/main/java/com/github/ambry/account/Container.java", "diffHunk": "@@ -61,6 +61,7 @@\n   static final String CONTAINER_NAME_KEY = \"containerName\";\n   static final String CONTAINER_ID_KEY = \"containerId\";\n   static final String STATUS_KEY = \"status\";\n+  static final String CONTAINER_LAST_UPDATE_TIME_KEY = \"lastUpdateTime\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "812e422491acb2f378230d425203ebad0d047fa9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNDc3NjA4", "url": "https://github.com/linkedin/ambry/pull/1535#pullrequestreview-420477608", "createdAt": "2020-05-28T20:44:38Z", "commit": {"oid": "812e422491acb2f378230d425203ebad0d047fa9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMDo0NDozOFrOGcGDhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMDo0NjoxMlrOGcGGzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExMjUxOQ==", "bodyText": "nit: we know the key and value won't be null, so we can just use metadata.put.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r432112519", "createdAt": "2020-05-28T20:44:38Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-api/src/main/java/com/github/ambry/account/Container.java", "diffHunk": "@@ -487,6 +509,7 @@ JSONObject toJson() throws JSONException {\n         metadata.put(Container.JSON_VERSION_KEY, JSON_VERSION_2);\n         metadata.put(CONTAINER_ID_KEY, id);\n         metadata.put(CONTAINER_NAME_KEY, name);\n+        metadata.putOpt(CONTAINER_LAST_UPDATE_TIME_KEY, lastUpdateTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "812e422491acb2f378230d425203ebad0d047fa9"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExMzM1OA==", "bodyText": "nit: we should use a config for this value, maybe we can update it in next pr.", "url": "https://github.com/linkedin/ambry/pull/1535#discussion_r432113358", "createdAt": "2020-05-28T20:46:12Z", "author": {"login": "justinlin-linkedin"}, "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -198,14 +197,17 @@ void compact(CompactionDetails details, byte[] bundleReadBuffer) throws IOExcept\n   }\n \n   /**\n-   * Filters deprecated {@link Container}s for compaction purpose. Deprecated status include DELETE_IN_PROGRESS and INACTIVE.\n+   * Filters deprecated {@link Container}s for compaction purpose. Deprecated containers include DELETE_IN_PROGRESS\n+   * containers met with retention time and all INACTIVE containers.\n    * @return the deprecated {@link Container}s' accountId & containerId pairs.\n    */\n   private void getDeprecatedContainers() {\n     deprecatedContainers.clear();\n     if (accountService != null) {\n       accountService.getContainersByStatus(Container.ContainerStatus.DELETE_IN_PROGRESS).forEach((container) -> {\n-        deprecatedContainers.add(new Pair<>(container.getParentAccountId(), container.getId()));\n+        if (container.getLastUpdateTime() + TimeUnit.DAYS.toMillis(14) >= System.currentTimeMillis()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "812e422491acb2f378230d425203ebad0d047fa9"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1b32931d02f663eba45a2773746501439f82ed8", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/c1b32931d02f663eba45a2773746501439f82ed8", "committedDate": "2020-05-28T23:17:26Z", "message": "minor fixing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTYwODk2", "url": "https://github.com/linkedin/ambry/pull/1535#pullrequestreview-420560896", "createdAt": "2020-05-28T23:33:40Z", "commit": {"oid": "c1b32931d02f663eba45a2773746501439f82ed8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMTI3OTI2", "url": "https://github.com/linkedin/ambry/pull/1535#pullrequestreview-422127926", "createdAt": "2020-06-01T19:41:31Z", "commit": {"oid": "c1b32931d02f663eba45a2773746501439f82ed8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1520, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}