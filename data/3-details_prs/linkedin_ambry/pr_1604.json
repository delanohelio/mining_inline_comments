{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NzIyNTQy", "number": 1604, "title": "[VCR_DELAYED_DEPLOYMENT_STRATEGY] Code changes to switch vcr helix cluster to DelayedAutoRebalancer.", "bodyText": "Switch vcr helix cluster to DelayedAutoRebalancer strategy with OfflineOnline state machine and number of replicas 1.", "createdAt": "2020-08-10T20:45:08Z", "url": "https://github.com/linkedin/ambry/pull/1604", "merged": true, "mergeCommit": {"oid": "a0cdbf7a33067c7e1a37b7def42d88258c2e7082"}, "closed": true, "closedAt": "2020-08-24T16:49:34Z", "author": {"login": "ankagrawal"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc99zXzgFqTQ2NTQxMjEwNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCFWf5gFqTQ3MzY3MTgzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NDEyMTA2", "url": "https://github.com/linkedin/ambry/pull/1604#pullrequestreview-465412106", "createdAt": "2020-08-11T20:40:03Z", "commit": {"oid": "cfa3bc5e5d5fdfe5b2d2de63ed1cfd10d363f5d5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDo0MDowM1rOG_IbMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMTozMDo0NFrOG_J8KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg1MTUwNQ==", "bodyText": "nit: change it to  REBALANCE_DELAY_MS", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r468851505", "createdAt": "2020-08-11T20:40:03Z", "author": {"login": "jsjtzyy"}, "path": "ambry-cloud/src/test/java/com/github/ambry/cloud/VcrTestUtil.java", "diffHunk": "@@ -46,7 +47,9 @@\n  */\n public class VcrTestUtil {\n \n-  public static String helixResource = \"resource1\";\n+  private static final int MIN_ACTIVE_REPLICAS = 0;\n+  private static final long REBALANCE_DELAY = TimeUnit.SECONDS.toMillis(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa3bc5e5d5fdfe5b2d2de63ed1cfd10d363f5d5"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NjMyOQ==", "bodyText": "same here", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r468876329", "createdAt": "2020-08-11T21:30:44Z", "author": {"login": "jsjtzyy"}, "path": "ambry-tools/src/main/java/com/github/ambry/clustermap/HelixVcrPopulateTool.java", "diffHunk": "@@ -48,11 +49,13 @@\n \n   private static final String SEPARATOR = \"/\";\n   static List<String> ignoreResourceKeyWords = Arrays.asList(\"aggregation\", \"trigger\", \"stats\");\n-  private static final int REPLICA_NUMBER = 3;\n+  private static final int REPLICA_NUMBER = 1;\n   private static final ZNRecordSerializer ZN_RECORD_SERIALIZER = new ZNRecordSerializer();\n   // TODO: get from properties file\n   private static final int MAX_OFFLINE_INSTANCES_ALLOWED = 4;\n   private static final int NUM_OFFLINE_INSTANCES_FOR_AUTO_EXIT = 2;\n+  private static final int MIN_ACTIVE_REPLICAS = 0;\n+  private static final long REBALANCE_DELAY = TimeUnit.MINUTES.toMillis(20);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa3bc5e5d5fdfe5b2d2de63ed1cfd10d363f5d5"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NDc0Mjk3", "url": "https://github.com/linkedin/ambry/pull/1604#pullrequestreview-465474297", "createdAt": "2020-08-11T22:35:08Z", "commit": {"oid": "cfa3bc5e5d5fdfe5b2d2de63ed1cfd10d363f5d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMjozNTowOFrOG_LiPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMjozNTowOFrOG_LiPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkwMjQ2MA==", "bodyText": "I suggest keeping this unless we have another of piece of code setting this for new resource, which I didn't see here.", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r468902460", "createdAt": "2020-08-11T22:35:08Z", "author": {"login": "jsjtzyy"}, "path": "ambry-tools/src/main/java/com/github/ambry/clustermap/HelixVcrPopulateTool.java", "diffHunk": "@@ -214,11 +217,13 @@ static void updateResourceIdealState(String destZkString, String destClusterName\n    */\n   static IdealState buildIdealState(String resource, Set<String> partitionSet) {\n     FullAutoModeISBuilder builder = new FullAutoModeISBuilder(resource);\n-    builder.setStateModel(LeaderStandbySMD.name);\n+    builder.setStateModel(OnlineOfflineSMD.name);\n     for (String partition : partitionSet) {\n       builder.add(partition);\n     }\n-    builder.setRebalanceStrategy(CrushEdRebalanceStrategy.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa3bc5e5d5fdfe5b2d2de63ed1cfd10d363f5d5"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MjQzOTcz", "url": "https://github.com/linkedin/ambry/pull/1604#pullrequestreview-466243973", "createdAt": "2020-08-12T20:21:57Z", "commit": {"oid": "cfa3bc5e5d5fdfe5b2d2de63ed1cfd10d363f5d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyMTo1N1rOG_xDvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMDoyMTo1N1rOG_xDvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUxNzI0NQ==", "bodyText": "Would it possible to store the ideal state as a json doc in config property and have the populate tool take it as an argument? It seems clunky to have to modify the code every time we want to tweak our Helix config.\nI realize the HelixVcrStateModel does need to know the state names.", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r469517245", "createdAt": "2020-08-12T20:21:57Z", "author": {"login": "lightningrob"}, "path": "ambry-tools/src/main/java/com/github/ambry/clustermap/HelixVcrPopulateTool.java", "diffHunk": "@@ -214,11 +217,13 @@ static void updateResourceIdealState(String destZkString, String destClusterName\n    */\n   static IdealState buildIdealState(String resource, Set<String> partitionSet) {\n     FullAutoModeISBuilder builder = new FullAutoModeISBuilder(resource);\n-    builder.setStateModel(LeaderStandbySMD.name);\n+    builder.setStateModel(OnlineOfflineSMD.name);\n     for (String partition : partitionSet) {\n       builder.add(partition);\n     }\n-    builder.setRebalanceStrategy(CrushEdRebalanceStrategy.class.getName());\n+    builder.setMinActiveReplica(MIN_ACTIVE_REPLICAS);\n+    builder.setRebalanceDelay((int) REBALANCE_DELAY);\n+    builder.setRebalancerClass(DelayedAutoRebalancer.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa3bc5e5d5fdfe5b2d2de63ed1cfd10d363f5d5"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfa3bc5e5d5fdfe5b2d2de63ed1cfd10d363f5d5", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/cfa3bc5e5d5fdfe5b2d2de63ed1cfd10d363f5d5", "committedDate": "2020-08-10T19:21:37Z", "message": "Code changes to switch vcr helix cluster to DelayedAutoRebalancer."}, "afterCommit": {"oid": "a20151090b870b44bc55d4ac3f6acf1b4134989f", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/a20151090b870b44bc55d4ac3f6acf1b4134989f", "committedDate": "2020-08-17T18:34:06Z", "message": "Fix tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23f7478d94fb79b4ec29e492be31dd180b11f94b", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/23f7478d94fb79b4ec29e492be31dd180b11f94b", "committedDate": "2020-08-19T01:06:00Z", "message": "Config based enabling and disabling of rebalancing strategy and state model."}, "afterCommit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/4543c076ed5e223ce23752ea308e04540ced102c", "committedDate": "2020-08-19T01:07:02Z", "message": "Config based enabling and disabling of rebalancing strategy and state model."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMDUxNzI2", "url": "https://github.com/linkedin/ambry/pull/1604#pullrequestreview-470051726", "createdAt": "2020-08-19T01:59:41Z", "commit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMTo1OTo0MVrOHCsqVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMjowMjowNVrOHCstDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5MDkzNQ==", "bodyText": "How does this work without a constructor or setters?", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r472590935", "createdAt": "2020-08-19T01:59:41Z", "author": {"login": "lightningrob"}, "path": "ambry-tools/src/main/java/com/github/ambry/clustermap/HelixVcrPopulateTool.java", "diffHunk": "@@ -335,5 +344,120 @@ static void errorAndExit(String error) {\n     System.err.println(error);\n     System.exit(1);\n   }\n+\n+  /**\n+   * Is the rebalancer class {@link org.apache.helix.controller.rebalancer.DelayedAutoRebalancer}\n+   * @param rebalancerClassName name of the rebalancer class.\n+   * @return true if rebalancer is {@link org.apache.helix.controller.rebalancer.DelayedAutoRebalancer}, false otherwise.\n+   */\n+  private static boolean isDelayedRebalanceEnabled(String rebalancerClassName) {\n+    return (rebalancerClassName != null) && rebalancerClassName.endsWith(DELAYED_REBALANCER_CLASS_NAME);\n+  }\n+\n+  /**\n+   * Class for ideal state configs.\n+   */\n+  static class IdealStateConfigFields {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c"}, "originalPosition": 252}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5MTYyOA==", "bodyText": "It's cool that you found a way to parametrize the state model.", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r472591628", "createdAt": "2020-08-19T02:02:05Z", "author": {"login": "lightningrob"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/HelixVcrCluster.java", "diffHunk": "@@ -167,4 +169,25 @@ public void close() {\n     manager.disconnect();\n     helixAdmin.close();\n   }\n+\n+  /**\n+   * Register the state model factory corresponding to {@code vcrHelixStateModelName}.\n+   * @param vcrHelixStateModelName\n+   */\n+  private void registerStateModelFactory(String vcrHelixStateModelName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMDkzOTIz", "url": "https://github.com/linkedin/ambry/pull/1604#pullrequestreview-470093923", "createdAt": "2020-08-19T03:08:56Z", "commit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzowODo1NlrOHCu9aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzo1MjozMVrOHCwlMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYyODU4NA==", "bodyText": "I suggest adding state model validation into CloudConfig, thus it throws exception at the very beginning (when generating the config) rather than keep initializing other components until participation.\nYou can refer to clustermapStateModelDefinition in ClusterMapConfig.", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r472628584", "createdAt": "2020-08-19T03:08:56Z", "author": {"login": "jsjtzyy"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/HelixVcrCluster.java", "diffHunk": "@@ -167,4 +169,25 @@ public void close() {\n     manager.disconnect();\n     helixAdmin.close();\n   }\n+\n+  /**\n+   * Register the state model factory corresponding to {@code vcrHelixStateModelName}.\n+   * @param vcrHelixStateModelName\n+   */\n+  private void registerStateModelFactory(String vcrHelixStateModelName) {\n+    switch (vcrHelixStateModelName) {\n+      case OnlineOfflineSMD.name:\n+        manager.getStateMachineEngine()\n+            .registerStateModelFactory(vcrHelixStateModelName, new OnlineOfflineHelixVcrStateModelFactory(this));\n+        break;\n+      case LeaderStandbySMD.name:\n+        manager.getStateMachineEngine()\n+            .registerStateModelFactory(vcrHelixStateModelName, new LeaderStandbyHelixVcrStateModelFactory(this));\n+        break;\n+      default:\n+        throw new IllegalArgumentException(String.format(\n+            \"Illegal vcr helix state model name: \" + vcrHelixStateModelName + \". Should be one of\"\n+                + OnlineOfflineSMD.name + \", \" + LeaderStandbySMD.name));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzMTY1Nw==", "bodyText": "May I ask why we need two state model factories?  The code logic looks same with LeaderStandbyHelixVcrStateModelFactory. I think one factory should suffice.", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r472631657", "createdAt": "2020-08-19T03:13:52Z", "author": {"login": "jsjtzyy"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/OnlineOfflineHelixVcrStateModelFactory.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.cloud;\n+\n+import org.apache.helix.participant.statemachine.StateModel;\n+import org.apache.helix.participant.statemachine.StateModelFactory;\n+\n+\n+/**\n+ * A factory for creating {@link OnlineOfflineHelixVcrStateModel}\n+ */\n+public class OnlineOfflineHelixVcrStateModelFactory extends StateModelFactory<StateModel> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0MDg3OQ==", "bodyText": "nit: add java doc for new argument", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r472640879", "createdAt": "2020-08-19T03:28:48Z", "author": {"login": "jsjtzyy"}, "path": "ambry-tools/src/main/java/com/github/ambry/clustermap/HelixVcrPopulateTool.java", "diffHunk": "@@ -212,13 +222,19 @@ static void updateResourceIdealState(String destZkString, String destClusterName\n    * @param partitionSet the set of partitions managed by the resource.\n    * @return the {@link IdealState}.\n    */\n-  static IdealState buildIdealState(String resource, Set<String> partitionSet) {\n+  static IdealState buildIdealState(String resource, Set<String> partitionSet,\n+      IdealStateConfigFields idealStateConfigFields) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c"}, "originalPosition": 194}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0ODA3NA==", "bodyText": "nit: can a single string without concatenation.", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r472648074", "createdAt": "2020-08-19T03:40:55Z", "author": {"login": "jsjtzyy"}, "path": "ambry-tools/src/main/java/com/github/ambry/clustermap/HelixVcrPopulateTool.java", "diffHunk": "@@ -13,64 +13,65 @@\n  */\n package com.github.ambry.clustermap;\n \n+import com.github.ambry.utils.Utils;\n+import java.io.IOException;\n import java.util.Arrays;\n import java.util.HashMap;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n import joptsimple.ArgumentAcceptingOptionSpec;\n import joptsimple.OptionParser;\n import joptsimple.OptionSet;\n import joptsimple.OptionSpec;\n import org.apache.helix.ConfigAccessor;\n import org.apache.helix.HelixAdmin;\n-import org.apache.helix.controller.rebalancer.strategy.CrushEdRebalanceStrategy;\n import org.apache.helix.manager.zk.ZKHelixAdmin;\n import org.apache.helix.manager.zk.ZKHelixManager;\n import org.apache.helix.manager.zk.ZKUtil;\n import org.apache.helix.manager.zk.client.DedicatedZkClientFactory;\n import org.apache.helix.model.ClusterConfig;\n import org.apache.helix.model.HelixConfigScope;\n import org.apache.helix.model.IdealState;\n-import org.apache.helix.model.LeaderStandbySMD;\n import org.apache.helix.model.builder.FullAutoModeISBuilder;\n import org.apache.helix.model.builder.HelixConfigScopeBuilder;\n import org.apache.helix.tools.ClusterSetup;\n import org.apache.helix.zookeeper.api.client.HelixZkClient;\n import org.apache.helix.zookeeper.datamodel.serializer.ZNRecordSerializer;\n+import org.codehaus.jackson.map.ObjectMapper;\n \n \n /**\n  * This tool provides function to create vcr cluster and update vcr cluster by referencing src cluster.\n  */\n public class HelixVcrPopulateTool {\n \n+  static final List<String> ignoreResourceKeyWords = Arrays.asList(\"aggregation\", \"trigger\", \"stats\");\n   private static final String SEPARATOR = \"/\";\n-  static List<String> ignoreResourceKeyWords = Arrays.asList(\"aggregation\", \"trigger\", \"stats\");\n-  private static final int REPLICA_NUMBER = 3;\n   private static final ZNRecordSerializer ZN_RECORD_SERIALIZER = new ZNRecordSerializer();\n-  // TODO: get from properties file\n-  private static final int MAX_OFFLINE_INSTANCES_ALLOWED = 4;\n-  private static final int NUM_OFFLINE_INSTANCES_FOR_AUTO_EXIT = 2;\n+  private static final String DELAYED_REBALANCER_CLASS_NAME = \"DelayedRebalancer\";\n \n-  public static void main(String[] args) {\n+  public static void main(String[] args) throws IOException {\n     OptionParser parser = new OptionParser();\n     OptionSpec createClusterOpt = parser.accepts(\"createCluster\",\n-        \"Create cluster in dest zk(no resource creation). --createCluster --dest destZkEndpoint/destClusterName\");\n+        \"Create cluster in dest zk(no resource creation). --createCluster --dest destZkEndpoint/destClusterName\"\n+            + \" --config configFilePath\");\n \n     OptionSpec updateClusterOpt = parser.accepts(\"updateCluster\",\n         \"Update resources in dest by copying from src to dest. --updateCluster\"\n-            + \" [--src srcZkEndpoint/srcClusterName] --dest destZkEndpoint/destClusterName\");\n+            + \" [--src srcZkEndpoint/srcClusterName] --dest destZkEndpoint/destClusterName --config configFilePath\");\n     OptionSpec dryRunOpt = parser.accepts(\"dryRun\", \"Do dry run.\");\n \n     OptionSpec controlResourceOpt = parser.accepts(\"controlResource\",\n-        \"Enable/Disable a resource. --controlResource --dest destZkEndpoint/destClusterName --resource resource --enable true\");\n+        \"Enable/Disable a resource. --controlResource --dest destZkEndpoint/destClusterName\"\n+            + \" --resource resource --enable true\");\n     ArgumentAcceptingOptionSpec<String> resourceOpt =\n         parser.accepts(\"resource\").withRequiredArg().describedAs(\"resource name\").ofType(String.class);\n \n     ArgumentAcceptingOptionSpec<Boolean> maintenanceOpt = parser.accepts(\"maintainCluster\",\n-        \"Enter/Exit helix maintenance mode. --maintainCluster --dest destZkEndpoint/destClusterName --enable true\")\n+        \"Enter/Exit helix maintenance mode. --maintainCluster --dest destZkEndpoint/destClusterName\" + \" --enable true\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1MjQ3Mg==", "bodyText": "I suppose there is ordering requirement (i.e. idealStateConfigFields comes first) when preparing the json file. In that case, it's a bit of error-prone for user to use this tool.", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r472652472", "createdAt": "2020-08-19T03:47:56Z", "author": {"login": "jsjtzyy"}, "path": "ambry-tools/src/main/java/com/github/ambry/clustermap/HelixVcrPopulateTool.java", "diffHunk": "@@ -328,5 +344,120 @@ static void errorAndExit(String error) {\n     System.err.println(error);\n     System.exit(1);\n   }\n+\n+  /**\n+   * Is the rebalancer class {@link org.apache.helix.controller.rebalancer.DelayedAutoRebalancer}\n+   * @param rebalancerClassName name of the rebalancer class.\n+   * @return true if rebalancer is {@link org.apache.helix.controller.rebalancer.DelayedAutoRebalancer}, false otherwise.\n+   */\n+  private static boolean isDelayedRebalanceEnabled(String rebalancerClassName) {\n+    return (rebalancerClassName != null) && rebalancerClassName.endsWith(DELAYED_REBALANCER_CLASS_NAME);\n+  }\n+\n+  /**\n+   * Class for ideal state configs.\n+   */\n+  static class IdealStateConfigFields {\n+    private int numReplicas;\n+    private String stateModelDefRef;\n+    private String rebalanceStrategy;\n+    private int minActiveReplicas;\n+    private String rebalancerClassName;\n+    private long rebalanceDelayInMins;\n+\n+    /**\n+     * @return {@code numReplicas}\n+     */\n+    public int getNumReplicas() {\n+      return numReplicas;\n+    }\n+\n+    /**\n+     * @return {@code stateModelDefRef}\n+     */\n+    public String getStateModelDefRef() {\n+      return stateModelDefRef;\n+    }\n+\n+    /**\n+     * @return {@code rebalanceStrategy}\n+     */\n+    public String getRebalanceStrategy() {\n+      return rebalanceStrategy;\n+    }\n+\n+    /**\n+     * @return {@code minActiveReplicas}\n+     */\n+    public int getMinActiveReplicas() {\n+      return minActiveReplicas;\n+    }\n+\n+    /**\n+     * @return {@code rebalancerClassName}\n+     */\n+    public String getRebalancerClassName() {\n+      return rebalancerClassName;\n+    }\n+\n+    /**\n+     * @return {@code rebalanceDelayInMins}\n+     */\n+    public long getRebalanceDelayInMins() {\n+      return rebalanceDelayInMins;\n+    }\n+  }\n+\n+  /**\n+   * Class for cluster config fields.\n+   */\n+  static class ClusterConfigFields {\n+    private int maxOfflineInstancesAllowed;\n+    private int numOfflineInstancesForAutoExit;\n+    private boolean allowAutoJoin;\n+\n+    /**\n+     * @return {@code maxOfflineInstancesAllowed}\n+     */\n+    public int getMaxOfflineInstancesAllowed() {\n+      return maxOfflineInstancesAllowed;\n+    }\n+\n+    /**\n+     * @return {@code numOfflineInstancesForAutoExit}\n+     */\n+    public int getNumOfflineInstancesForAutoExit() {\n+      return numOfflineInstancesForAutoExit;\n+    }\n+\n+    /**\n+     * @return {@code allowAutoJoin}\n+     */\n+    public boolean isAllowAutoJoin() {\n+      return allowAutoJoin;\n+    }\n+  }\n+\n+  /**\n+   * Class for configs passed to the {@link HelixVcrPopulateTool}\n+   */\n+  static class Config {\n+    private IdealStateConfigFields idealStateConfigFields;\n+    private ClusterConfigFields clusterConfigFields;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c"}, "originalPosition": 338}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1NTE1Mw==", "bodyText": "You can move this to config directory. For testing, you can just instantiate a Config object (as you defined HelixVcrPopulateTool) and write it into string via jackson's writeValueAsString method.", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r472655153", "createdAt": "2020-08-19T03:52:31Z", "author": {"login": "jsjtzyy"}, "path": "ambry-tools/src/integration-test/resources/mocktio-extensions/DelayedAutoRebalancerHelixConfig.json", "diffHunk": "@@ -0,0 +1,15 @@\n+{\n+  \"idealStateConfigFields\": {\n+    \"numReplicas\": 2,\n+    \"stateModelDefRef\": \"OnlineOffline\",\n+    \"rebalanceStrategy\": \"org.apache.helix.controller.rebalancer.strategy.CrushEdRebalanceStrategy\",\n+    \"minActiveReplicas\": 0,\n+    \"rebalancerClassName\": \"org.apache.helix.controller.rebalancer.DelayedAutoRebalancer\",\n+    \"rebalanceDelayInMins\": 20\n+  },\n+  \"clusterConfigFields\": {\n+    \"maxOfflineInstancesAllowed\": 4,\n+    \"numOfflineInstancesForAutoExit\": 2,\n+    \"allowAutoJoin\": true\n+  }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4543c076ed5e223ce23752ea308e04540ced102c"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53622ec45ca915e34c177f971b716168d21c790b", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/53622ec45ca915e34c177f971b716168d21c790b", "committedDate": "2020-08-19T20:06:15Z", "message": "Code changes to switch vcr helix cluster to DelayedAutoRebalancer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b417510a0ce7e6dbbae8de107e0456a32f19a7e2", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/b417510a0ce7e6dbbae8de107e0456a32f19a7e2", "committedDate": "2020-08-19T20:06:15Z", "message": "Fix tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3e5b510360ee9445ba809dfa0f6ebc0e28df06a", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/d3e5b510360ee9445ba809dfa0f6ebc0e28df06a", "committedDate": "2020-08-19T20:06:15Z", "message": "Config based enabling and disabling of rebalancing strategy and state model."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "045907886ac5697a9aae87fa00849fb8da1a5b44", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/045907886ac5697a9aae87fa00849fb8da1a5b44", "committedDate": "2020-08-19T20:06:15Z", "message": "Add factory class as config for state model\nAdd the config json files to main resources."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a378ad36bfe6d1efe2834b21afcd1e86f4684dd", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/4a378ad36bfe6d1efe2834b21afcd1e86f4684dd", "committedDate": "2020-08-19T20:06:15Z", "message": "Move config files to config directory"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4bb01d8d9fa2ddea45fb8f745e9d7fb37b0afb7", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/c4bb01d8d9fa2ddea45fb8f745e9d7fb37b0afb7", "committedDate": "2020-08-19T19:19:53Z", "message": "Add factory class as config for state model\nAdd the config json files to main resources."}, "afterCommit": {"oid": "4a378ad36bfe6d1efe2834b21afcd1e86f4684dd", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/4a378ad36bfe6d1efe2834b21afcd1e86f4684dd", "committedDate": "2020-08-19T20:06:15Z", "message": "Move config files to config directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35f663d56d956561b9278bfdae060fe66e9b5042", "author": {"user": null}, "url": "https://github.com/linkedin/ambry/commit/35f663d56d956561b9278bfdae060fe66e9b5042", "committedDate": "2020-08-19T22:35:30Z", "message": "fix tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDQ1NTQ3", "url": "https://github.com/linkedin/ambry/pull/1604#pullrequestreview-471045547", "createdAt": "2020-08-20T00:14:13Z", "commit": {"oid": "35f663d56d956561b9278bfdae060fe66e9b5042"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMDoxNDoxNFrOHDh5Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMDoxNDoxNFrOHDh5Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ2MzA3MQ==", "bodyText": "[An alternative but totally optional]\nSince we decide to use two factories, we can make a abstract factory VcrStateModelFactory which extends StateModelFactory and make two state model factories extend it. Then this method can be replaced by adding state model name to each StateModelFactory. Thus, line149~151 can be changed to:\nVcrStateModelFactory stateModelFactory = Utils.getObj(cloudConfig.vcrHelixStateModelFactoryClass, this);\nmanager.getStateMachineEngine()\n        .registerStateModelFactory(stateModelFactory.getModelName(), stateModelFactory);\n\nAnd this method can be removed.", "url": "https://github.com/linkedin/ambry/pull/1604#discussion_r473463071", "createdAt": "2020-08-20T00:14:14Z", "author": {"login": "jsjtzyy"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/HelixVcrCluster.java", "diffHunk": "@@ -167,4 +171,22 @@ public void close() {\n     manager.disconnect();\n     helixAdmin.close();\n   }\n+\n+  /**\n+   * Get the name of the state model for the factory class.\n+   * @param stateModelFactoryClass name of the {@link org.apache.helix.participant.statemachine.StateModelFactory} class.\n+   * @return state model name corresponding to the factor class.\n+   */\n+  private String getStateModelNameFromFactory(String stateModelFactoryClass) {\n+    if (stateModelFactoryClass.equals(OnlineOfflineHelixVcrStateModelFactory.class.getName())) {\n+      return OnlineOfflineSMD.name;\n+    }\n+    if (stateModelFactoryClass.equals(LeaderStandbyHelixVcrStateModelFactory.class.getName())) {\n+      return LeaderStandbySMD.name;\n+    }\n+    throw new IllegalArgumentException(String.format(\n+        \"Illegal vcr helix state model factory class: \" + stateModelFactoryClass + \". Should be one of\"\n+            + OnlineOfflineHelixVcrStateModelFactory.class.getName() + \", \"\n+            + LeaderStandbyHelixVcrStateModelFactory.class.getName()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35f663d56d956561b9278bfdae060fe66e9b5042"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjcxODMy", "url": "https://github.com/linkedin/ambry/pull/1604#pullrequestreview-473671832", "createdAt": "2020-08-24T16:39:11Z", "commit": {"oid": "35f663d56d956561b9278bfdae060fe66e9b5042"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1209, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}