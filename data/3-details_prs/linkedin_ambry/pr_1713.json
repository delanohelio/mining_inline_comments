{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMzg4OTg4", "number": 1713, "title": "[CLOUD_CONTAINER_DELETION] Add logs and metrics for container deletion.", "bodyText": "", "createdAt": "2020-12-03T01:12:36Z", "url": "https://github.com/linkedin/ambry/pull/1713", "merged": true, "mergeCommit": {"oid": "29548cca6f05ee61fce28fe706c786c9d9052935"}, "closed": true, "closedAt": "2020-12-04T22:31:10Z", "author": {"login": "ankagrawal"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiYlrOAH2gAyNTMxMzg4OTg4OmJhOTQ4Y2VlYmZmYzNiYzNjMjQwZjhkMzlmNjNkZTI3ODM0OGU1ZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi0CZ4gH2gAyNTMxMzg4OTg4OmI3ZWMxODc5ZWZlMWQxMmM5MGY3ZDgyNjY2YjAwODRlMzc3OGQ3ZTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ba948ceebffc3bc3c240f8d39f63de278348e5f4", "author": {"user": {"login": "ankagrawal", "name": "Ankur Agrawal"}}, "url": "https://github.com/linkedin/ambry/commit/ba948ceebffc3bc3c240f8d39f63de278348e5f4", "committedDate": "2020-12-03T01:09:32Z", "message": "Add logs and metrics for container deletion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "919e75fb0bf98e710c6d4808c451a454d2a845bc", "author": {"user": {"login": "ankagrawal", "name": "Ankur Agrawal"}}, "url": "https://github.com/linkedin/ambry/commit/919e75fb0bf98e710c6d4808c451a454d2a845bc", "committedDate": "2020-12-03T08:30:42Z", "message": "Fix unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NjM4OTA0", "url": "https://github.com/linkedin/ambry/pull/1713#pullrequestreview-544638904", "createdAt": "2020-12-04T03:53:09Z", "commit": {"oid": "919e75fb0bf98e710c6d4808c451a454d2a845bc"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMzo1MzowOVrOH-_q6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwNDowNTozMVrOH-_5ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxNjkzOA==", "bodyText": "Minor: Don't need String..format in logger call, use {} instead.", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535816938", "createdAt": "2020-12-04T03:53:09Z", "author": {"login": "lightningrob"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/DeprecatedContainerCloudSyncTask.java", "diffHunk": "@@ -40,20 +42,29 @@\n    * @param cloudDestination the {@link CloudDestination} object where deprecated container information will be updated.\n    */\n   public DeprecatedContainerCloudSyncTask(AccountService accountService, long containerDeletionRetentionDays,\n-      CloudDestination cloudDestination) {\n+      CloudDestination cloudDestination, VcrMetrics vcrMetrics) {\n     this.accountService = accountService;\n     this.containerDeletionRetentionDays = containerDeletionRetentionDays;\n     this.cloudDestination = cloudDestination;\n+    this.vcrMetrics = vcrMetrics;\n   }\n \n   @Override\n   public TaskResult run() {\n+    Timer.Context deprecationTaskRunTimer = vcrMetrics.deprecationTaskRunTime.time();\n     try {\n+      logger.info(\"DeprecatedContainerCloudSyncTask run started.\");\n+      Timer.Context accountServiceFetchTimer = vcrMetrics.accountServiceFetchTime.time();\n       Set<Container> deprecatedContainers =\n           AccountUtils.getDeprecatedContainers(accountService, containerDeletionRetentionDays);\n+      accountServiceFetchTimer.stop();\n+      logger.info(String.format(\"Attempting deprecation of %d containers.\", deprecatedContainers.size()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "919e75fb0bf98e710c6d4808c451a454d2a845bc"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxODI5OQ==", "bodyText": "What's the effect of the failure?  Is it safe to just log and continue?  I guess container deprecation isn't fail fast situation, but how will we know something is wrong if we don't see the log message?", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535818299", "createdAt": "2020-12-04T03:57:26Z", "author": {"login": "lightningrob"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/HelixVcrCluster.java", "diffHunk": "@@ -181,12 +184,16 @@ private void registerContainerDeletionSyncTask(StateMachineEngine engine) {\n         @Override\n         public Task createNewTask(TaskCallbackContext context) {\n           return new DeprecatedContainerCloudSyncTask(accountService, storeConfig.storeContainerDeletionRetentionDays,\n-              cloudDestination);\n+              cloudDestination, vcrMetrics);\n         }\n       });\n       if (!taskFactoryMap.isEmpty()) {\n-        engine.registerStateModelFactory(TaskConstants.STATE_MODEL_NAME,\n-            new TaskStateModelFactory(manager, taskFactoryMap));\n+        if (engine.registerStateModelFactory(TaskConstants.STATE_MODEL_NAME,\n+            new TaskStateModelFactory(manager, taskFactoryMap))) {\n+          logger.info(\"Container deletion sync task registered with helix.\");\n+        } else {\n+          logger.error(\"Container deletion sync task registration with helix failed.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "919e75fb0bf98e710c6d4808c451a454d2a845bc"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxODk1NA==", "bodyText": "Same here.", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535818954", "createdAt": "2020-12-04T03:59:46Z", "author": {"login": "lightningrob"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/azure/AzureContainerCompactor.java", "diffHunk": "@@ -122,9 +132,14 @@ public void compactAssignedDeprecatedContainers(Collection<? extends PartitionId\n         containerDeletionEntrySet.remove(containerDeletionEntry);\n         for (String partitionId : containerDeletionEntry.getDeletePendingPartitions()) {\n           try {\n+            logger.info(String.format(\"Starting compaction of container %d, account %d in partition %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "919e75fb0bf98e710c6d4808c451a454d2a845bc"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyMDY1MA==", "bodyText": "When does this throw CloudStorageException?", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535820650", "createdAt": "2020-12-04T04:05:31Z", "author": {"login": "lightningrob"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/azure/AzureContainerCompactor.java", "diffHunk": "@@ -67,16 +68,20 @@\n    * @param cloudConfig {@link CloudConfig} object.\n    * @param vcrMetrics {@link VcrMetrics} object.\n    * @param azureMetrics {@link AzureMetrics} object.\n+   * @throws CloudStorageException if case of any error.\n    */\n   public AzureContainerCompactor(AzureBlobDataAccessor azureBlobDataAccessor, CosmosDataAccessor cosmosDataAccessor,\n-      CloudConfig cloudConfig, AzureCloudConfig azureCloudConfig, VcrMetrics vcrMetrics, AzureMetrics azureMetrics) {\n+      CloudConfig cloudConfig, AzureCloudConfig azureCloudConfig, VcrMetrics vcrMetrics, AzureMetrics azureMetrics)\n+      throws CloudStorageException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "919e75fb0bf98e710c6d4808c451a454d2a845bc"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Njc1OTI3", "url": "https://github.com/linkedin/ambry/pull/1713#pullrequestreview-544675927", "createdAt": "2020-12-04T05:57:32Z", "commit": {"oid": "919e75fb0bf98e710c6d4808c451a454d2a845bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwNTo1NzozM1rOH_CBOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwNTo1NzozM1rOH_CBOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg1NTQxNw==", "bodyText": "minor: will this be used in the future pr?", "url": "https://github.com/linkedin/ambry/pull/1713#discussion_r535855417", "createdAt": "2020-12-04T05:57:33Z", "author": {"login": "SophieGuo410"}, "path": "ambry-cloud/src/main/java/com/github/ambry/cloud/azure/AzureContainerCompactor.java", "diffHunk": "@@ -139,6 +154,13 @@ public void compactAssignedDeprecatedContainers(Collection<? extends PartitionId\n     }\n   }\n \n+  /**\n+   * @return the latest container deletion timestamp.\n+   */\n+  public long getLatestContainerDeletionTimestamp() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "919e75fb0bf98e710c6d4808c451a454d2a845bc"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0Njc2MDE0", "url": "https://github.com/linkedin/ambry/pull/1713#pullrequestreview-544676014", "createdAt": "2020-12-04T05:57:47Z", "commit": {"oid": "919e75fb0bf98e710c6d4808c451a454d2a845bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7ec1879efe1d12c90f7d82666b0084e3778d7e6", "author": {"user": {"login": "ankagrawal", "name": "Ankur Agrawal"}}, "url": "https://github.com/linkedin/ambry/commit/b7ec1879efe1d12c90f7d82666b0084e3778d7e6", "committedDate": "2020-12-04T09:08:21Z", "message": "Address review comments."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1031, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}