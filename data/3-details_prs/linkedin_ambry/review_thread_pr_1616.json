{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NTU3MTU3", "number": 1616, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMToyMTowMlrOEha1WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNjoyNjowN1rOEhwWmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDc4MTA0OnYy", "diffSide": "RIGHT", "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/AmbrySecurityService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMToyMTowMlrOHOubrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNjozMDowMFrOHQQALA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwMjg2Mw==", "bodyText": "hmm, it seems like this static init block wasn't even needed since it can be done in one line:\nstatic final Set<String> OPERATIONS = Collections...", "url": "https://github.com/linkedin/ambry/pull/1616#discussion_r485202863", "createdAt": "2020-09-08T21:21:02Z", "author": {"login": "cgtz"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/AmbrySecurityService.java", "diffHunk": "@@ -385,4 +384,9 @@ private void validateSecurePathIfRequired(RestRequest restRequest, String prefix\n       }\n     }\n   }\n+\n+  static {\n+    OPERATIONS = Collections.unmodifiableSet(Utils.getStaticFieldValuesAsStrings(Operations.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgwMTQ1Mg==", "bodyText": "Makes sense. These changes crept in because of style check fixes by Intellij though.", "url": "https://github.com/linkedin/ambry/pull/1616#discussion_r486801452", "createdAt": "2020-09-11T06:30:00Z", "author": {"login": "ankagrawal"}, "path": "ambry-frontend/src/main/java/com/github/ambry/frontend/AmbrySecurityService.java", "diffHunk": "@@ -385,4 +384,9 @@ private void validateSecurePathIfRequired(RestRequest restRequest, String prefix\n       }\n     }\n   }\n+\n+  static {\n+    OPERATIONS = Collections.unmodifiableSet(Utils.getStaticFieldValuesAsStrings(Operations.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwMjg2Mw=="}, "originalCommit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODE0NTY2OnYy", "diffSide": "RIGHT", "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNTo1NzoxMFrOHPONUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNzo1MjoyM1rOHQoS6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyMzQ3Mg==", "bodyText": "why move this variable down here?", "url": "https://github.com/linkedin/ambry/pull/1616#discussion_r485723472", "createdAt": "2020-09-09T15:57:10Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "diffHunk": "@@ -376,6 +416,8 @@ public void onCompletion(Long result, Exception exception) {\n         routerCallback.onPollReady();\n       }\n     };\n+    // the index of the next chunk that is to be written out to the asyncWritableChannel.\n+    private int indexOfNextChunkToWriteOut = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "originalPosition": 203}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5NjMyMg==", "bodyText": "It was auto moved by intellij code formatting tool. Let me know if you want me to move it back.", "url": "https://github.com/linkedin/ambry/pull/1616#discussion_r487196322", "createdAt": "2020-09-11T17:46:00Z", "author": {"login": "ankagrawal"}, "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "diffHunk": "@@ -376,6 +416,8 @@ public void onCompletion(Long result, Exception exception) {\n         routerCallback.onPollReady();\n       }\n     };\n+    // the index of the next chunk that is to be written out to the asyncWritableChannel.\n+    private int indexOfNextChunkToWriteOut = 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyMzQ3Mg=="}, "originalCommit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "originalPosition": 203}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5OTQ2NA==", "bodyText": "Ah, it doesn't do that for me since I don't have rearrange code checked in the formatting options. Just keep it in whatever place you feel is best or most logical, I don't think we have any designated style for this", "url": "https://github.com/linkedin/ambry/pull/1616#discussion_r487199464", "createdAt": "2020-09-11T17:52:23Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "diffHunk": "@@ -376,6 +416,8 @@ public void onCompletion(Long result, Exception exception) {\n         routerCallback.onPollReady();\n       }\n     };\n+    // the index of the next chunk that is to be written out to the asyncWritableChannel.\n+    private int indexOfNextChunkToWriteOut = 0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyMzQ3Mg=="}, "originalCommit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "originalPosition": 203}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODMwNjgzOnYy", "diffSide": "RIGHT", "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNjoyNjowN1rOHPPxxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNjo0NzozMFrOHQQawQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc0OTE4OA==", "bodyText": "This seems to always set the size to the size of the first chunk regardless of which chunk is being fetched. Also, why can't this be done in the chunk == firstChunk block above? It looks like we have all of the necessary pieces to complete the operation at that time (BlobInfo for the properties of the composite blob, ChunkMetadata list to get the datachunk size, segment index from options)\nEDIT: Oh, I remember now that the first chunk internal logic already filters the list down to just the segment of interest. However, I'm still wondering what prevents this from working in the firstChunk block?", "url": "https://github.com/linkedin/ambry/pull/1616#discussion_r485749188", "createdAt": "2020-09-09T16:26:07Z", "author": {"login": "cgtz"}, "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "diffHunk": "@@ -252,15 +236,49 @@ private void onChunkOperationComplete(GetChunk chunk) {\n             routerMetrics.onGetBlobError(e, options, isEncrypted);\n           }\n         }\n-        NonBlockingRouter.completeOperation(null, getOperationCallback, operationResult, e);\n+        // We don't complete operation in case of segmented blob, as we don't have all the header information until we fetch the segmented chunk.\n+        if (e != null || !options.getBlobOptions.hasBlobSegmentIdx()) {\n+          NonBlockingRouter.completeOperation(null, getOperationCallback, operationResult, e);\n+        }\n       }\n+    } else if (options.getBlobOptions.hasBlobSegmentIdx()) {\n+      // We have fetched the segmented chunk, and there cannot be any more chunks to fetch now.\n+      fixBlobSizeIfRequired(blobInfo.getBlobProperties().getBlobSize(),\n+          firstChunk.getChunkMetadataList().get(0).getSize());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgwODI1Nw==", "bodyText": "You are right about being able to do it in the firstChunk block itself. fixed it!", "url": "https://github.com/linkedin/ambry/pull/1616#discussion_r486808257", "createdAt": "2020-09-11T06:47:30Z", "author": {"login": "ankagrawal"}, "path": "ambry-router/src/main/java/com/github/ambry/router/GetBlobOperation.java", "diffHunk": "@@ -252,15 +236,49 @@ private void onChunkOperationComplete(GetChunk chunk) {\n             routerMetrics.onGetBlobError(e, options, isEncrypted);\n           }\n         }\n-        NonBlockingRouter.completeOperation(null, getOperationCallback, operationResult, e);\n+        // We don't complete operation in case of segmented blob, as we don't have all the header information until we fetch the segmented chunk.\n+        if (e != null || !options.getBlobOptions.hasBlobSegmentIdx()) {\n+          NonBlockingRouter.completeOperation(null, getOperationCallback, operationResult, e);\n+        }\n       }\n+    } else if (options.getBlobOptions.hasBlobSegmentIdx()) {\n+      // We have fetched the segmented chunk, and there cannot be any more chunks to fetch now.\n+      fixBlobSizeIfRequired(blobInfo.getBlobProperties().getBlobSize(),\n+          firstChunk.getChunkMetadataList().get(0).getSize());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc0OTE4OA=="}, "originalCommit": {"oid": "6370fce4afeeb8ef279ed3e26bdf8cbafbfdcf35"}, "originalPosition": 99}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1364, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}