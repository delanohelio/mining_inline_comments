{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNjA1Mjcx", "number": 2070, "title": "Fix chat user player status state updates", "bodyText": "Fixes #2067\nFixes #2066\nFixes #2065\nFixes user color initialization", "createdAt": "2020-12-17T05:07:17Z", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070", "merged": true, "mergeCommit": {"oid": "05b3dd7c834577be4d18481ba1eb8dee43288e4d"}, "closed": true, "closedAt": "2020-12-19T00:31:34Z", "author": {"login": "Sheikah45"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm8YzOgH2gAyNTQxNjA1MjcxOmJhY2M2MjYxOGNiN2YwZDk0ZDliOGY0N2RkZWY3NzhkM2ViNjNhNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnNwPEAH2gAyNTQxNjA1MjcxOjlhM2EwOWQwZDhmODU3NmEzZDRjMWFjYmI5NjVlYjAzM2RiN2VlNmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "committedDate": "2020-12-17T05:07:45Z", "message": "Fix chat user player status state updates"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f35abc17d56877d4e1c957768987346e4c57e3b", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/5f35abc17d56877d4e1c957768987346e4c57e3b", "committedDate": "2020-12-17T05:05:47Z", "message": "Fix chat user player status state updates"}, "afterCommit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/bacc62618cb7f0d94d9b8f47ddef778d3eb63a56", "committedDate": "2020-12-17T05:07:45Z", "message": "Fix chat user player status state updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0OTk5MTIx", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#pullrequestreview-554999121", "createdAt": "2020-12-17T21:24:27Z", "commit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMToyNDoyN1rOIIJWxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMToyNDoyN1rOIIJWxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMjgwNg==", "bodyText": "Maybe we can refactor this since it is hardly readable anymore. Should be extracted into methods. Too many nesting", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545412806", "createdAt": "2020-12-17T21:24:27Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {\n+        chatChannelUser.getPlayer().ifPresent(player -> {\n+          if (player.getClan() != null) {\n+            clanService.getClanByTag(player.getClan())\n+                .thenAccept(optionalClan -> Platform.runLater(() -> {\n+                      if (optionalClan.isPresent()) {\n+                        chatChannelUser.setClan(optionalClan.get());\n+                      } else {\n+                        chatChannelUser.setClan(null);\n+                      }\n+                    })\n+                );\n+          } else {\n+            chatChannelUser.setClan(null);\n+          }\n+        });\n+      }\n+    } else {\n+      chatChannelUser.setClan(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0OTk5OTI3", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#pullrequestreview-554999927", "createdAt": "2020-12-17T21:25:39Z", "commit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMToyNTozOVrOIIJZIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QyMTozMDo0NFrOIIJjRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMzQxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (chatChannelUser.getClan().isEmpty()) {\n          \n          \n            \n                  if (!chatChannelUser.getClan().isEmpty()) {\n          \n          \n            \n                       return;\n          \n          \n            \n                  }", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545413411", "createdAt": "2020-12-17T21:25:39Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMzg5Mg==", "bodyText": "Early return avoids another level of nesting", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545413892", "createdAt": "2020-12-17T21:26:40Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMzQxMQ=="}, "originalCommit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxNDMyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (chatChannelUser.getAvatar().isEmpty()) {\n          \n          \n            \n                  if (!chatChannelUser.getAvatar().isEmpty()) {\n          \n          \n            \n                      return;\n          \n          \n            \n                  }", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545414322", "createdAt": "2020-12-17T21:27:30Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {\n+        chatChannelUser.getPlayer().ifPresent(player -> {\n+          if (player.getClan() != null) {\n+            clanService.getClanByTag(player.getClan())\n+                .thenAccept(optionalClan -> Platform.runLater(() -> {\n+                      if (optionalClan.isPresent()) {\n+                        chatChannelUser.setClan(optionalClan.get());\n+                      } else {\n+                        chatChannelUser.setClan(null);\n+                      }\n+                    })\n+                );\n+          } else {\n+            chatChannelUser.setClan(null);\n+          }\n+        });\n+      }\n+    } else {\n+      chatChannelUser.setClan(null);\n     }\n   }\n \n   public void populateAvatar(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getAvatar().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Image avatar;\n-            if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n-              avatar = avatarService.loadAvatar(player.getAvatarUrl());\n-            } else {\n-              avatar = null;\n-            }\n-            Platform.runLater(() -> {\n-              chatChannelUser.setAvatar(avatar);\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getAvatar().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxNDUzOQ==", "bodyText": "early return -> less nesting", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545414539", "createdAt": "2020-12-17T21:27:59Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {\n+        chatChannelUser.getPlayer().ifPresent(player -> {\n+          if (player.getClan() != null) {\n+            clanService.getClanByTag(player.getClan())\n+                .thenAccept(optionalClan -> Platform.runLater(() -> {\n+                      if (optionalClan.isPresent()) {\n+                        chatChannelUser.setClan(optionalClan.get());\n+                      } else {\n+                        chatChannelUser.setClan(null);\n+                      }\n+                    })\n+                );\n+          } else {\n+            chatChannelUser.setClan(null);\n+          }\n+        });\n+      }\n+    } else {\n+      chatChannelUser.setClan(null);\n     }\n   }\n \n   public void populateAvatar(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getAvatar().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Image avatar;\n-            if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n-              avatar = avatarService.loadAvatar(player.getAvatarUrl());\n-            } else {\n-              avatar = null;\n-            }\n-            Platform.runLater(() -> {\n-              chatChannelUser.setAvatar(avatar);\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getAvatar().isEmpty()) {\n+        chatChannelUser.getPlayer()\n+            .ifPresent(player -> {\n+              Image avatar;\n+              if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n+                avatar = avatarService.loadAvatar(player.getAvatarUrl());\n+              } else {\n+                avatar = null;\n+              }\n+              Platform.runLater(() -> {\n+                chatChannelUser.setAvatar(avatar);\n+              });\n             });\n-          });\n+      }\n+    } else {\n+      chatChannelUser.setAvatar(null);\n     }\n   }\n \n   public void populateCountry(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getCountryFlag().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Optional<Image> countryFlag = countryFlagService.loadCountryFlag(player.getCountry());\n-            Platform.runLater(() -> {\n-              chatChannelUser.setCountryFlag(countryFlag.orElse(null));\n-              chatChannelUser.setCountryName(i18n.getCountryNameLocalized(player.getCountry()));\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getCountryFlag().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxNTc1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        PlayerStatus status = player.getStatus();\n          \n          \n            \n                        Image playerStatusImage = switch (status) {\n          \n          \n            \n                          case HOSTING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_HOSTING);\n          \n          \n            \n                          case LOBBYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_LOBBYING);\n          \n          \n            \n                          case PLAYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_PLAYING);\n          \n          \n            \n                          default -> null;\n          \n          \n            \n                        };\n          \n          \n            \n                        Image mapImage;\n          \n          \n            \n                        if (status != PlayerStatus.IDLE) {\n          \n          \n            \n                          mapImage = mapService.loadPreview(player.getGame().getMapFolderName(), PreviewSize.SMALL);\n          \n          \n            \n                        } else {\n          \n          \n            \n                          mapImage = null;\n          \n          \n            \n                        }\n          \n          \n            \n                        Platform.runLater(() -> {\n          \n          \n            \n                          chatChannelUser.setStatusTooltipText(i18n.get(status.getI18nKey()));\n          \n          \n            \n                          chatChannelUser.setGameStatusImage(playerStatusImage);\n          \n          \n            \n                          chatChannelUser.setMapImage(mapImage);\n          \n          \n            \n                        });\n          \n          \n            \n                        setImages()", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545415754", "createdAt": "2020-12-17T21:30:15Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {\n+        chatChannelUser.getPlayer().ifPresent(player -> {\n+          if (player.getClan() != null) {\n+            clanService.getClanByTag(player.getClan())\n+                .thenAccept(optionalClan -> Platform.runLater(() -> {\n+                      if (optionalClan.isPresent()) {\n+                        chatChannelUser.setClan(optionalClan.get());\n+                      } else {\n+                        chatChannelUser.setClan(null);\n+                      }\n+                    })\n+                );\n+          } else {\n+            chatChannelUser.setClan(null);\n+          }\n+        });\n+      }\n+    } else {\n+      chatChannelUser.setClan(null);\n     }\n   }\n \n   public void populateAvatar(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getAvatar().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Image avatar;\n-            if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n-              avatar = avatarService.loadAvatar(player.getAvatarUrl());\n-            } else {\n-              avatar = null;\n-            }\n-            Platform.runLater(() -> {\n-              chatChannelUser.setAvatar(avatar);\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getAvatar().isEmpty()) {\n+        chatChannelUser.getPlayer()\n+            .ifPresent(player -> {\n+              Image avatar;\n+              if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n+                avatar = avatarService.loadAvatar(player.getAvatarUrl());\n+              } else {\n+                avatar = null;\n+              }\n+              Platform.runLater(() -> {\n+                chatChannelUser.setAvatar(avatar);\n+              });\n             });\n-          });\n+      }\n+    } else {\n+      chatChannelUser.setAvatar(null);\n     }\n   }\n \n   public void populateCountry(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getCountryFlag().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Optional<Image> countryFlag = countryFlagService.loadCountryFlag(player.getCountry());\n-            Platform.runLater(() -> {\n-              chatChannelUser.setCountryFlag(countryFlag.orElse(null));\n-              chatChannelUser.setCountryName(i18n.getCountryNameLocalized(player.getCountry()));\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getCountryFlag().isEmpty()) {\n+        chatChannelUser.getPlayer()\n+            .ifPresent(player -> {\n+              Optional<Image> countryFlag = countryFlagService.loadCountryFlag(player.getCountry());\n+              Platform.runLater(() -> {\n+                chatChannelUser.setCountryFlag(countryFlag.orElse(null));\n+                chatChannelUser.setCountryName(i18n.getCountryNameLocalized(player.getCountry()));\n+              });\n             });\n-          });\n+      }\n+    } else {\n+      chatChannelUser.setCountryFlag(null);\n+      chatChannelUser.setCountryName(null);\n     }\n   }\n \n   public void populateGameStatus(ChatChannelUser chatChannelUser) {\n-    chatChannelUser.getPlayer()\n-        .ifPresent(player -> {\n-          PlayerStatus status = player.getStatus();\n-          Image playerStatusImage = switch (status) {\n-            case HOSTING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_HOSTING);\n-            case LOBBYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_LOBBYING);\n-            case PLAYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_PLAYING);\n-            default -> null;\n-          };\n-          Image mapImage;\n-          if (status != PlayerStatus.IDLE) {\n-            mapImage = mapService.loadPreview(player.getGame().getMapFolderName(), PreviewSize.SMALL);\n-          } else {\n-            mapImage = null;\n-          }\n-          Platform.runLater(() -> {\n-            chatChannelUser.setStatusTooltipText(i18n.get(status.getI18nKey()));\n-            chatChannelUser.setGameStatusImage(playerStatusImage);\n-            chatChannelUser.setMapImage(mapImage);\n-            chatChannelUser.setGameStatus(status);\n+    if (chatChannelUser.isDisplayed()) {\n+      chatChannelUser.getPlayer()\n+          .ifPresent(player -> {\n+            PlayerStatus status = player.getStatus();\n+            Image playerStatusImage = switch (status) {\n+              case HOSTING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_HOSTING);\n+              case LOBBYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_LOBBYING);\n+              case PLAYING -> uiService.getThemeImage(UiService.CHAT_LIST_STATUS_PLAYING);\n+              default -> null;\n+            };\n+            Image mapImage;\n+            if (status != PlayerStatus.IDLE) {\n+              mapImage = mapService.loadPreview(player.getGame().getMapFolderName(), PreviewSize.SMALL);\n+            } else {\n+              mapImage = null;\n+            }\n+            Platform.runLater(() -> {\n+              chatChannelUser.setStatusTooltipText(i18n.get(status.getI18nKey()));\n+              chatChannelUser.setGameStatusImage(playerStatusImage);\n+              chatChannelUser.setMapImage(mapImage);\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56"}, "originalPosition": 168}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxNjAwNQ==", "bodyText": "Miss leading name also does other things", "url": "https://github.com/FAForever/downlords-faf-client/pull/2070#discussion_r545416005", "createdAt": "2020-12-17T21:30:44Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/chat/ChatUserService.java", "diffHunk": "@@ -38,114 +38,121 @@ public void afterPropertiesSet() {\n   }\n \n   public void populateClan(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getClan().isEmpty()) {\n-      chatChannelUser.getPlayer().ifPresent(player -> {\n-        if (player.getClan() != null) {\n-          clanService.getClanByTag(player.getClan())\n-              .thenAccept(optionalClan -> Platform.runLater(() -> {\n-                    if (optionalClan.isPresent()) {\n-                      chatChannelUser.setClan(optionalClan.get());\n-                      chatChannelUser.setClanTag(String.format(\"[%s]\", optionalClan.get().getTag()));\n-                    } else {\n-                      chatChannelUser.setClan(null);\n-                      chatChannelUser.setClanTag(null);\n-                    }\n-                  })\n-              );\n-        } else {\n-          chatChannelUser.setClan(null);\n-          chatChannelUser.setClanTag(null);\n-        }\n-      });\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getClan().isEmpty()) {\n+        chatChannelUser.getPlayer().ifPresent(player -> {\n+          if (player.getClan() != null) {\n+            clanService.getClanByTag(player.getClan())\n+                .thenAccept(optionalClan -> Platform.runLater(() -> {\n+                      if (optionalClan.isPresent()) {\n+                        chatChannelUser.setClan(optionalClan.get());\n+                      } else {\n+                        chatChannelUser.setClan(null);\n+                      }\n+                    })\n+                );\n+          } else {\n+            chatChannelUser.setClan(null);\n+          }\n+        });\n+      }\n+    } else {\n+      chatChannelUser.setClan(null);\n     }\n   }\n \n   public void populateAvatar(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getAvatar().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Image avatar;\n-            if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n-              avatar = avatarService.loadAvatar(player.getAvatarUrl());\n-            } else {\n-              avatar = null;\n-            }\n-            Platform.runLater(() -> {\n-              chatChannelUser.setAvatar(avatar);\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getAvatar().isEmpty()) {\n+        chatChannelUser.getPlayer()\n+            .ifPresent(player -> {\n+              Image avatar;\n+              if (!Strings.isNullOrEmpty(player.getAvatarUrl())) {\n+                avatar = avatarService.loadAvatar(player.getAvatarUrl());\n+              } else {\n+                avatar = null;\n+              }\n+              Platform.runLater(() -> {\n+                chatChannelUser.setAvatar(avatar);\n+              });\n             });\n-          });\n+      }\n+    } else {\n+      chatChannelUser.setAvatar(null);\n     }\n   }\n \n   public void populateCountry(ChatChannelUser chatChannelUser) {\n-    if (chatChannelUser.getCountryFlag().isEmpty()) {\n-      chatChannelUser.getPlayer()\n-          .ifPresent(player -> {\n-            Optional<Image> countryFlag = countryFlagService.loadCountryFlag(player.getCountry());\n-            Platform.runLater(() -> {\n-              chatChannelUser.setCountryFlag(countryFlag.orElse(null));\n-              chatChannelUser.setCountryName(i18n.getCountryNameLocalized(player.getCountry()));\n+    if (chatChannelUser.isDisplayed()) {\n+      if (chatChannelUser.getCountryFlag().isEmpty()) {\n+        chatChannelUser.getPlayer()\n+            .ifPresent(player -> {\n+              Optional<Image> countryFlag = countryFlagService.loadCountryFlag(player.getCountry());\n+              Platform.runLater(() -> {\n+                chatChannelUser.setCountryFlag(countryFlag.orElse(null));\n+                chatChannelUser.setCountryName(i18n.getCountryNameLocalized(player.getCountry()));\n+              });\n             });\n-          });\n+      }\n+    } else {\n+      chatChannelUser.setCountryFlag(null);\n+      chatChannelUser.setCountryName(null);\n     }\n   }\n \n   public void populateGameStatus(ChatChannelUser chatChannelUser) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bacc62618cb7f0d94d9b8f47ddef778d3eb63a56"}, "originalPosition": 127}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d34639e59e3e19c75a29426cfb1f2d2fe5e7ff8e", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/d34639e59e3e19c75a29426cfb1f2d2fe5e7ff8e", "committedDate": "2020-12-18T00:23:45Z", "message": "simplify chat user service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a3a09d0d8f8576a3d4c1acbb965eb033db7ee6c", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/9a3a09d0d8f8576a3d4c1acbb965eb033db7ee6c", "committedDate": "2020-12-18T01:21:44Z", "message": "Use equals"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3170, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}