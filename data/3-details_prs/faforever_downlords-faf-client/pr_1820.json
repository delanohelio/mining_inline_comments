{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MzAyNTE3", "number": 1820, "title": "Feature/#1763 local replays pagination", "bodyText": "Done after unittesting", "createdAt": "2020-07-10T08:27:44Z", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820", "merged": true, "mergeCommit": {"oid": "505e5f2a98b10a0a8bb9fb0a91118b8966dedf34"}, "closed": true, "closedAt": "2020-11-13T14:19:06Z", "author": {"login": "IAmAlife"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczjgABgBqjM1MzM4NTU3OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdaUPPigH2gAyNDQ3MzAyNTE3Ojg5ZmZhOGJiZDhiZDQ5NmJhMzM4ODJiZDQ4N2U1MzhjMDUyOTY0NmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12956e08233bed5818ad9f9cbb4b1e70ebbfb7fa", "author": {"user": {"login": "Tarmandan", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/12956e08233bed5818ad9f9cbb4b1e70ebbfb7fa", "committedDate": "2020-07-09T20:32:21Z", "message": "fixed not showing last page in some cases"}, "afterCommit": {"oid": "9abfc3a100ce2c0928fd2a7e3dab5112bf12b1b9", "author": {"user": {"login": "Tarmandan", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/9abfc3a100ce2c0928fd2a7e3dab5112bf12b1b9", "committedDate": "2020-07-10T12:15:46Z", "message": "fixed not showing last page in some cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NTgyMjg3", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#pullrequestreview-446582287", "createdAt": "2020-07-10T17:41:09Z", "commit": {"oid": "6612d1d9906114382b1c41941e6508ff94ab90e2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzo0MTowOVrOGv_5IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNzo0NjozNVrOGwACzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4MzA3Mw==", "bodyText": "Passing an UI Elements to a service should never happen!", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#discussion_r452983073", "createdAt": "2020-07-10T17:41:09Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -139,19 +142,27 @@\n   private final ExecutorService executorService;\n   private Thread directoryWatcherThread;\n   private WatchService watchService;\n-  protected List<Replay> localReplays = new ArrayList<Replay>();\n+  protected List<Replay> localReplays = new ArrayList<>();\n \n-  public void startLoadingAndWatchingLocalReplays() {\n+  public void startLoadingAndWatchingLocalReplays(Pagination pagination) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6612d1d9906114382b1c41941e6508ff94ab90e2"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4MzU4Ng==", "bodyText": "Publish page count here maybe...", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#discussion_r452983586", "createdAt": "2020-07-10T17:42:18Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -139,19 +142,27 @@\n   private final ExecutorService executorService;\n   private Thread directoryWatcherThread;\n   private WatchService watchService;\n-  protected List<Replay> localReplays = new ArrayList<Replay>();\n+  protected List<Replay> localReplays = new ArrayList<>();\n \n-  public void startLoadingAndWatchingLocalReplays() {\n+  public void startLoadingAndWatchingLocalReplays(Pagination pagination) {\n     Path replaysDirectory = preferencesService.getReplaysDirectory();\n     if (Files.notExists(replaysDirectory)) {\n       noCatch(() -> createDirectories(replaysDirectory));\n     }\n \n+    String replayFileGlob = clientProperties.getReplay().getReplayFileGlob();\n+    try (DirectoryStream<Path> directoryStream = Files.newDirectoryStream(replaysDirectory, replayFileGlob)) {\n+      final int pageCount = (int) Math.ceil((StreamSupport.stream(directoryStream.spliterator(), false).count() / (double) REPLAYS_PER_PAGE));\n+      Platform.runLater(() -> pagination.setPageCount(pageCount));\n+    } catch (IOException e) {\n+      logger.error(\"Failed loading total amount of replays\", e);\n+    }\n+\n     LoadLocalReplaysTask loadLocalReplaysTask = applicationContext.getBean(LoadLocalReplaysTask.class);\n-    taskService.submitTask(loadLocalReplaysTask).getFuture().thenAccept( replays -> {\n+    taskService.submitTask(loadLocalReplaysTask).getFuture().thenAccept(replays -> {\n       localReplays.clear();\n       localReplays.addAll(replays);\n-      publisher.publishEvent(new LocalReplaysChangedEvent(this, replays, new ArrayList<Replay>()));\n+      publisher.publishEvent(new LocalReplaysChangedEvent(this, replays, new ArrayList<>()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6612d1d9906114382b1c41941e6508ff94ab90e2"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4Mzg5NQ==", "bodyText": "This is not an error, rather warning I say", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#discussion_r452983895", "createdAt": "2020-07-10T17:42:58Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -139,19 +142,27 @@\n   private final ExecutorService executorService;\n   private Thread directoryWatcherThread;\n   private WatchService watchService;\n-  protected List<Replay> localReplays = new ArrayList<Replay>();\n+  protected List<Replay> localReplays = new ArrayList<>();\n \n-  public void startLoadingAndWatchingLocalReplays() {\n+  public void startLoadingAndWatchingLocalReplays(Pagination pagination) {\n     Path replaysDirectory = preferencesService.getReplaysDirectory();\n     if (Files.notExists(replaysDirectory)) {\n       noCatch(() -> createDirectories(replaysDirectory));\n     }\n \n+    String replayFileGlob = clientProperties.getReplay().getReplayFileGlob();\n+    try (DirectoryStream<Path> directoryStream = Files.newDirectoryStream(replaysDirectory, replayFileGlob)) {\n+      final int pageCount = (int) Math.ceil((StreamSupport.stream(directoryStream.spliterator(), false).count() / (double) REPLAYS_PER_PAGE));\n+      Platform.runLater(() -> pagination.setPageCount(pageCount));\n+    } catch (IOException e) {\n+      logger.error(\"Failed loading total amount of replays\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6612d1d9906114382b1c41941e6508ff94ab90e2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4NDk4OA==", "bodyText": "Have u thought about what happens if a user drops a new replay into his replay folder... that is what happens here.", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#discussion_r452984988", "createdAt": "2020-07-10T17:45:21Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -186,8 +207,8 @@ protected Thread startDirectoryWatcher(Path replaysDirectory) throws IOException\n \n   @VisibleForTesting\n   protected void onLocalReplaysWatchEvent(WatchKey key) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6612d1d9906114382b1c41941e6508ff94ab90e2"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4NTU1MA==", "bodyText": "Maybe u can simplify this method by just going back to the first page \ud83e\udd14", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#discussion_r452985550", "createdAt": "2020-07-10T17:46:35Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -186,8 +207,8 @@ protected Thread startDirectoryWatcher(Path replaysDirectory) throws IOException\n \n   @VisibleForTesting\n   protected void onLocalReplaysWatchEvent(WatchKey key) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk4NDk4OA=="}, "originalCommit": {"oid": "6612d1d9906114382b1c41941e6508ff94ab90e2"}, "originalPosition": 78}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28696f6b4688ad1d775eca46e999aad1003e4090", "author": {"user": {"login": "Tarmandan", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/28696f6b4688ad1d775eca46e999aad1003e4090", "committedDate": "2020-07-15T15:51:59Z", "message": "Test for pagingation"}, "afterCommit": {"oid": "16a024304acc0cfd3fb1916b63db6ba69c3dd7a8", "author": {"user": {"login": "IAmAlife", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/16a024304acc0cfd3fb1916b63db6ba69c3dd7a8", "committedDate": "2020-07-15T15:54:50Z", "message": "Local Replays Pagination\n\nFixes #1763\n\nCo-Authored-By: tarmandan <58087411+tarmandan@users.noreply.github.com>\nCo-Authored-By: aclrian <32142988+aclrian@users.noreply.github.com>\nCo-Authored-By: Jia Hong Frenki Zhang <64331094+frezha@users.noreply.github.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95098b9ec1297e9ba2069ba28fdd513bec35ae83", "author": {"user": {"login": "1-alex98", "name": "Alexander von Trostorff"}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/95098b9ec1297e9ba2069ba28fdd513bec35ae83", "committedDate": "2020-07-16T17:12:40Z", "message": "Alex refactor"}, "afterCommit": {"oid": "0d929cf1e30d2d8c89667fc110954e58b76f33db", "author": {"user": {"login": "1-alex98", "name": "Alexander von Trostorff"}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/0d929cf1e30d2d8c89667fc110954e58b76f33db", "committedDate": "2020-07-16T17:15:18Z", "message": "Alex refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMDI4MjMx", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#pullrequestreview-450028231", "createdAt": "2020-07-16T16:43:51Z", "commit": {"oid": "16a024304acc0cfd3fb1916b63db6ba69c3dd7a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNjo0Mzo1MlrOGyzddQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNjo0Mzo1MlrOGyzddQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyNTEwOQ==", "bodyText": "whys that a double", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#discussion_r455925109", "createdAt": "2020-07-16T16:43:52Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -139,19 +140,29 @@\n   private final ExecutorService executorService;\n   private Thread directoryWatcherThread;\n   private WatchService watchService;\n-  protected List<Replay> localReplays = new ArrayList<Replay>();\n+  protected List<Replay> localReplays = new ArrayList<>();\n+  private double localReplaysItemsSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16a024304acc0cfd3fb1916b63db6ba69c3dd7a8"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNjY0OTU0", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#pullrequestreview-450664954", "createdAt": "2020-07-17T13:38:57Z", "commit": {"oid": "26cb7a73ab4bb7dc851efd6eedc57bb8c5dc2324"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzozODo1N1rOGzTYVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzozODo1N1rOGzTYVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0ODA4NQ==", "bodyText": "Written to but never read, right? If so remove", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#discussion_r456448085", "createdAt": "2020-07-17T13:38:57Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -134,36 +134,47 @@\n   private final FafService fafService;\n   private final ModService modService;\n   private final MapService mapService;\n-  private final ApplicationEventPublisher publisher;\n+  private final EventBus eventBus;\n   private final MapGeneratorService mapGeneratorService;\n-  private final ExecutorService executorService;\n   private Thread directoryWatcherThread;\n-  private WatchService watchService;\n-  protected List<Replay> localReplays = new ArrayList<Replay>();\n+  protected List<Replay> localReplays = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26cb7a73ab4bb7dc851efd6eedc57bb8c5dc2324"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MTIzMTYy", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#pullrequestreview-454123162", "createdAt": "2020-07-23T13:21:04Z", "commit": {"oid": "26cb7a73ab4bb7dc851efd6eedc57bb8c5dc2324"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzoyMTowNFrOG2KMnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzoyMTowNFrOG2KMnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ0MzM1OQ==", "bodyText": "Files.list", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#discussion_r459443359", "createdAt": "2020-07-23T13:21:04Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -134,36 +134,47 @@\n   private final FafService fafService;\n   private final ModService modService;\n   private final MapService mapService;\n-  private final ApplicationEventPublisher publisher;\n+  private final EventBus eventBus;\n   private final MapGeneratorService mapGeneratorService;\n-  private final ExecutorService executorService;\n   private Thread directoryWatcherThread;\n-  private WatchService watchService;\n-  protected List<Replay> localReplays = new ArrayList<Replay>();\n+  protected List<Replay> localReplays = new ArrayList<>();\n+  private double localReplaysItemsSize;\n+  private int pageCountLocalReplays;\n \n   public void startLoadingAndWatchingLocalReplays() {\n     Path replaysDirectory = preferencesService.getReplaysDirectory();\n     if (Files.notExists(replaysDirectory)) {\n       noCatch(() -> createDirectories(replaysDirectory));\n     }\n \n-    LoadLocalReplaysTask loadLocalReplaysTask = applicationContext.getBean(LoadLocalReplaysTask.class);\n-    taskService.submitTask(loadLocalReplaysTask).getFuture().thenAccept( replays -> {\n-      localReplays.clear();\n-      localReplays.addAll(replays);\n-      publisher.publishEvent(new LocalReplaysChangedEvent(this, replays, new ArrayList<Replay>()));\n-    });\n-\n     try {\n       Optional.ofNullable(directoryWatcherThread).ifPresent(Thread::interrupt);\n       directoryWatcherThread = startDirectoryWatcher(replaysDirectory);\n     } catch (IOException e) {\n       logger.warn(\"Failed to start watching the local replays directory\");\n     }\n+\n+    reloadLocalReplays();\n   }\n \n-  public Collection<Replay> getLocalReplays() {\n-    return localReplays;\n+  private void reloadLocalReplays() {\n+    Path replaysDirectory = preferencesService.getReplaysDirectory();\n+    pageCountLocalReplays = 1;\n+    String replayFileGlob = clientProperties.getReplay().getReplayFileGlob();\n+    try (DirectoryStream<Path> directoryStream = Files.newDirectoryStream(replaysDirectory, replayFileGlob)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26cb7a73ab4bb7dc851efd6eedc57bb8c5dc2324"}, "originalPosition": 92}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5501e876fa9243c5603d93d255cdc57870f61fb", "author": {"user": {"login": "Aclrian", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/b5501e876fa9243c5603d93d255cdc57870f61fb", "committedDate": "2020-08-04T07:30:20Z", "message": "Merge branch 'develop' into feature/#1763-local-replays-pagination"}, "afterCommit": {"oid": "b738e1c87f12a46199986c50b657a3625070f63d", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/b738e1c87f12a46199986c50b657a3625070f63d", "committedDate": "2020-11-07T04:54:37Z", "message": "Implement Vault Entity Pagination"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdfea8e9f94f0c24889bbb5ed92fcb1274ea3346", "author": {"user": {"login": "IAmAlife", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/bdfea8e9f94f0c24889bbb5ed92fcb1274ea3346", "committedDate": "2020-11-07T04:55:54Z", "message": "Local Replays Pagination\n\nFixes #1763\n\nCo-Authored-By: tarmandan <58087411+tarmandan@users.noreply.github.com>\nCo-Authored-By: aclrian <32142988+aclrian@users.noreply.github.com>\nCo-Authored-By: Jia Hong Frenki Zhang <64331094+frezha@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43b649293fade8a3b4a9d20cdb79f78be7df13cd", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/43b649293fade8a3b4a9d20cdb79f78be7df13cd", "committedDate": "2020-11-07T04:55:54Z", "message": "Implement Vault Entity Pagination"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b738e1c87f12a46199986c50b657a3625070f63d", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/b738e1c87f12a46199986c50b657a3625070f63d", "committedDate": "2020-11-07T04:54:37Z", "message": "Implement Vault Entity Pagination"}, "afterCommit": {"oid": "43b649293fade8a3b4a9d20cdb79f78be7df13cd", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/43b649293fade8a3b4a9d20cdb79f78be7df13cd", "committedDate": "2020-11-07T04:55:54Z", "message": "Implement Vault Entity Pagination"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba4f6edfdd0ee8b7d990a42bfb2c49f7d177bbb4", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/ba4f6edfdd0ee8b7d990a42bfb2c49f7d177bbb4", "committedDate": "2020-11-07T04:58:04Z", "message": "Remove unused event"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NjU4NTU2", "url": "https://github.com/FAForever/downlords-faf-client/pull/1820#pullrequestreview-525658556", "createdAt": "2020-11-07T14:58:29Z", "commit": {"oid": "ba4f6edfdd0ee8b7d990a42bfb2c49f7d177bbb4"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89ffa8bbd8bd496ba33882bd487e538c0529646e", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/89ffa8bbd8bd496ba33882bd487e538c0529646e", "committedDate": "2020-11-07T23:34:01Z", "message": "Remove unnecessary stubbing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3240, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}