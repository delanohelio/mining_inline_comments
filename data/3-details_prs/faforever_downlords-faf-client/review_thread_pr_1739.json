{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1Njc0NjA1", "number": 1739, "reviewThreads": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1Mzo1MVrOEBwWCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDo1OTo0OVrOEuzzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjc2MTA3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1Mzo1MVrOGdyuHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzoxMTozMFrOGgDsBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5Mjg5NA==", "bodyText": "This should not be hard coded", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r433892894", "createdAt": "2020-06-02T13:53:51Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5MzEyOA==", "bodyText": "take all flders in there", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r433893128", "createdAt": "2020-06-02T13:54:09Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5Mjg5NA=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2ODAzOA==", "bodyText": "oukay. but i'll need to rename the class, cause we'll remove more than only featured mod files, we'll remove much more.", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436268038", "createdAt": "2020-06-06T13:11:30Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5Mjg5NA=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjc2NTI4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1NDo0NVrOGdyw4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzoxMToxOFrOGgDr_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5MzYwMA==", "bodyText": "There are dedicated methods to make that transition", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r433893600", "createdAt": "2020-06-02T13:54:45Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2ODAzMA==", "bodyText": "Don't get it. Can you show me, where i can find them?", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436268030", "createdAt": "2020-06-06T13:11:18Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5MzYwMA=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjc3MDg5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1NTo0M1rOGdy0Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzowOTo0MVrOGgDrkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NDQzOA==", "bodyText": "We normally use more modern classes like OffsetDateTime or Instant", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r433894438", "createdAt": "2020-06-02T13:55:43Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NzkyMg==", "bodyText": "I'll get rid of Calendar and use only System.currentTimeMillis(). Imho, it's better, cause any other funcitonality  i don't need.", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436267922", "createdAt": "2020-06-06T13:09:41Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NDQzOA=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjc3NDk5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1NjozN1rOGdy2uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzoyMDo0NVrOGgDuXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NTA5OQ==", "bodyText": "aquie disk lock maybe", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r433895099", "createdAt": "2020-06-02T13:56:37Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),\n+        this.cacheDirectory.resolve(\"gamedata\")\n+    };\n+\n+    try {\n+      for (Path directoryPath : directoryPaths) {\n+        Files.createDirectories(directoryPath);\n+        Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+      }\n+    } catch (IOException e) {\n+      e.printStackTrace();\n+    }\n+  }\n+\n+  private void deleteCachedFileIfNeeded(Path filePath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2ODYzNw==", "bodyText": "done", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436268637", "createdAt": "2020-06-06T13:20:45Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),\n+        this.cacheDirectory.resolve(\"gamedata\")\n+    };\n+\n+    try {\n+      for (Path directoryPath : directoryPaths) {\n+        Files.createDirectories(directoryPath);\n+        Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+      }\n+    } catch (IOException e) {\n+      e.printStackTrace();\n+    }\n+  }\n+\n+  private void deleteCachedFileIfNeeded(Path filePath) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NTA5OQ=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjc3OTEyOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1NzozOFrOGdy5eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzoxNzoyMFrOGgDtqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NTgwMA==", "bodyText": "we do never call printStackTrace that is like System.out.println and we use a logger @slf4j above the class give u an instance logger", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r433895800", "createdAt": "2020-06-02T13:57:38Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),\n+        this.cacheDirectory.resolve(\"gamedata\")\n+    };\n+\n+    try {\n+      for (Path directoryPath : directoryPaths) {\n+        Files.createDirectories(directoryPath);\n+        Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+      }\n+    } catch (IOException e) {\n+      e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2ODQ1Nw==", "bodyText": "done", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436268457", "createdAt": "2020-06-06T13:17:20Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),\n+        this.cacheDirectory.resolve(\"gamedata\")\n+    };\n+\n+    try {\n+      for (Path directoryPath : directoryPaths) {\n+        Files.createDirectories(directoryPath);\n+        Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+      }\n+    } catch (IOException e) {\n+      e.printStackTrace();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NTgwMA=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjc4MTAwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1Nzo1OFrOGdy6hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzowOTo0NVrOGgDrkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NjA2OA==", "bodyText": "done by @slf4j", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r433896068", "createdAt": "2020-06-02T13:57:58Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NzkyMw==", "bodyText": "done", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436267923", "createdAt": "2020-06-06T13:09:45Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NjA2OA=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjc4MjQ2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1ODoxOFrOGdy7gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzoyMDo0OFrOGgDuXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NjMyMg==", "bodyText": "1 Euro for every System.out.println pls", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r433896322", "createdAt": "2020-06-02T13:58:18Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),\n+        this.cacheDirectory.resolve(\"gamedata\")\n+    };\n+\n+    try {\n+      for (Path directoryPath : directoryPaths) {\n+        Files.createDirectories(directoryPath);\n+        Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+      }\n+    } catch (IOException e) {\n+      e.printStackTrace();\n+    }\n+  }\n+\n+  private void deleteCachedFileIfNeeded(Path filePath) {\n+    try {\n+      if (Files.isDirectory(filePath)) {\n+        return;\n+      }\n+\n+      FileTime lastAccessTime = Files.readAttributes(filePath, BasicFileAttributes.class).lastAccessTime();\n+      if (lastAccessTime.toMillis() + cacheLifeTime < calendar.getTimeInMillis()) {\n+        System.out.println(\"deleting: \" + filePath.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2ODYzOQ==", "bodyText": "done", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436268639", "createdAt": "2020-06-06T13:20:48Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),\n+        this.cacheDirectory.resolve(\"gamedata\")\n+    };\n+\n+    try {\n+      for (Path directoryPath : directoryPaths) {\n+        Files.createDirectories(directoryPath);\n+        Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+      }\n+    } catch (IOException e) {\n+      e.printStackTrace();\n+    }\n+  }\n+\n+  private void deleteCachedFileIfNeeded(Path filePath) {\n+    try {\n+      if (Files.isDirectory(filePath)) {\n+        return;\n+      }\n+\n+      FileTime lastAccessTime = Files.readAttributes(filePath, BasicFileAttributes.class).lastAccessTime();\n+      if (lastAccessTime.toMillis() + cacheLifeTime < calendar.getTimeInMillis()) {\n+        System.out.println(\"deleting: \" + filePath.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NjMyMg=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjc4MzAwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1ODoyNVrOGdy71Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzoyMDo1MVrOGgDubA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NjQwNQ==", "bodyText": "nope", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r433896405", "createdAt": "2020-06-02T13:58:25Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),\n+        this.cacheDirectory.resolve(\"gamedata\")\n+    };\n+\n+    try {\n+      for (Path directoryPath : directoryPaths) {\n+        Files.createDirectories(directoryPath);\n+        Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+      }\n+    } catch (IOException e) {\n+      e.printStackTrace();\n+    }\n+  }\n+\n+  private void deleteCachedFileIfNeeded(Path filePath) {\n+    try {\n+      if (Files.isDirectory(filePath)) {\n+        return;\n+      }\n+\n+      FileTime lastAccessTime = Files.readAttributes(filePath, BasicFileAttributes.class).lastAccessTime();\n+      if (lastAccessTime.toMillis() + cacheLifeTime < calendar.getTimeInMillis()) {\n+        System.out.println(\"deleting: \" + filePath.toString());\n+        Files.deleteIfExists(filePath);\n+      }\n+    } catch (IOException e) {\n+      e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2ODY1Mg==", "bodyText": "done", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436268652", "createdAt": "2020-06-06T13:20:51Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.lang.invoke.MethodHandles;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Calendar;\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+  private Calendar calendar;\n+  private static final Logger logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTime() * 1000 * 3600 * 24;\n+    this.calendar = Calendar.getInstance();\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      logger.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    Path[] directoryPaths = new Path[] {\n+        this.cacheDirectory.resolve(\"bin\"),\n+        this.cacheDirectory.resolve(\"gamedata\")\n+    };\n+\n+    try {\n+      for (Path directoryPath : directoryPaths) {\n+        Files.createDirectories(directoryPath);\n+        Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+      }\n+    } catch (IOException e) {\n+      e.printStackTrace();\n+    }\n+  }\n+\n+  private void deleteCachedFileIfNeeded(Path filePath) {\n+    try {\n+      if (Files.isDirectory(filePath)) {\n+        return;\n+      }\n+\n+      FileTime lastAccessTime = Files.readAttributes(filePath, BasicFileAttributes.class).lastAccessTime();\n+      if (lastAccessTime.toMillis() + cacheLifeTime < calendar.getTimeInMillis()) {\n+        System.out.println(\"deleting: \" + filePath.toString());\n+        Files.deleteIfExists(filePath);\n+      }\n+    } catch (IOException e) {\n+      e.printStackTrace();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NjQwNQ=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwMjc4ODk5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/preferences/Preferences.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1OTo0NlrOGdy_qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxMzo1OTo0NlrOGdy_qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg5NzM4NQ==", "bodyText": "Maybe reflect unit in name", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r433897385", "createdAt": "2020-06-02T13:59:46Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/preferences/Preferences.java", "diffHunk": "@@ -81,6 +84,7 @@ public Preferences() {\n     showGameDetailsSidePane = new SimpleBooleanProperty(false);\n     advancedIceLogEnabled = new SimpleBooleanProperty(false);\n     prereleaseCheckEnabled = new SimpleBooleanProperty(false);\n+    cacheLifeTime = new SimpleIntegerProperty(30);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzUzMzg5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMjoyMDowMVrOGgDd_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzozNzoyOVrOGgDytg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NDQ0Ng==", "bodyText": "logger.info(\"Downloading {}\", cacheFilePath)", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436264446", "createdAt": "2020-06-06T12:20:01Z", "author": {"login": "micheljung"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +68,50 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();\n+        knownTargetHashes.put(targetPath.toString(), existingTargetFileHash);\n+\n+        if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+          logger.info(String.format(\"downloading: %s\", cacheFilePath.toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2OTYwNQ==", "bodyText": "Welcome back! :-)", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436269605", "createdAt": "2020-06-06T13:35:23Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +68,50 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();\n+        knownTargetHashes.put(targetPath.toString(), existingTargetFileHash);\n+\n+        if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+          logger.info(String.format(\"downloading: %s\", cacheFilePath.toString()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NDQ0Ng=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2OTc1MA==", "bodyText": "Done", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436269750", "createdAt": "2020-06-06T13:37:29Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +68,50 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();\n+        knownTargetHashes.put(targetPath.toString(), existingTargetFileHash);\n+\n+        if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+          logger.info(String.format(\"downloading: %s\", cacheFilePath.toString()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NDQ0Ng=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzUzNDE1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMjoyMDoxMlrOGgDeHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzozNzozNFrOGgDyug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NDQ3Nw==", "bodyText": "logger.info(\"Downloading {}\", targetPath)", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436264477", "createdAt": "2020-06-06T12:20:12Z", "author": {"login": "micheljung"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +68,50 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();\n+        knownTargetHashes.put(targetPath.toString(), existingTargetFileHash);\n+\n+        if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+          logger.info(String.format(\"downloading: %s\", cacheFilePath.toString()));\n+          downloadFeaturedModFile(featuredModFile, cacheFilePath);\n+        }\n       } else {\n-        Files.createDirectories(targetPath.getParent());\n-        updateMessage(i18n.get(\"updater.downloadingFile\", targetPath.getFileName()));\n-\n-        String url = featuredModFile.getUrl();\n-        downloadService.downloadFile(new URL(url), targetPath, this::updateProgress);\n-        UpdaterUtil.extractMoviesIfPresent(targetPath, fafDataDirectory);\n+        logger.info(String.format(\"downloading: %s\", targetPath.toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2OTc1NA==", "bodyText": "done", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436269754", "createdAt": "2020-06-06T13:37:34Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +68,50 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();\n+        knownTargetHashes.put(targetPath.toString(), existingTargetFileHash);\n+\n+        if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+          logger.info(String.format(\"downloading: %s\", cacheFilePath.toString()));\n+          downloadFeaturedModFile(featuredModFile, cacheFilePath);\n+        }\n       } else {\n-        Files.createDirectories(targetPath.getParent());\n-        updateMessage(i18n.get(\"updater.downloadingFile\", targetPath.getFileName()));\n-\n-        String url = featuredModFile.getUrl();\n-        downloadService.downloadFile(new URL(url), targetPath, this::updateProgress);\n-        UpdaterUtil.extractMoviesIfPresent(targetPath, fafDataDirectory);\n+        logger.info(String.format(\"downloading: %s\", targetPath.toString()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NDQ3Nw=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzUzNDU0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMjoyMDo1NFrOGgDeTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMzozODo0MFrOGgDy8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NDUyNg==", "bodyText": "logger.info(\"Copying featured mod file '{}' to '{}'\", cacheFilePath, targetPath);", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436264526", "createdAt": "2020-06-06T12:20:54Z", "author": {"login": "micheljung"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +68,50 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();\n+        knownTargetHashes.put(targetPath.toString(), existingTargetFileHash);\n+\n+        if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+          logger.info(String.format(\"downloading: %s\", cacheFilePath.toString()));\n+          downloadFeaturedModFile(featuredModFile, cacheFilePath);\n+        }\n       } else {\n-        Files.createDirectories(targetPath.getParent());\n-        updateMessage(i18n.get(\"updater.downloadingFile\", targetPath.getFileName()));\n-\n-        String url = featuredModFile.getUrl();\n-        downloadService.downloadFile(new URL(url), targetPath, this::updateProgress);\n-        UpdaterUtil.extractMoviesIfPresent(targetPath, fafDataDirectory);\n+        logger.info(String.format(\"downloading: %s\", targetPath.toString()));\n+        downloadFeaturedModFile(featuredModFile, targetPath);\n+        knownTargetHashes.put(targetPath.toString(), featuredModFile.getMd5());\n       }\n \n-\n       if (\"bin\".equals(featuredModFile.getGroup()) && initFileName.equalsIgnoreCase(featuredModFile.getName())) {\n         initFile = targetPath;\n       }\n     }\n \n+    for (FeaturedModFile featuredModFile : featuredModFiles) {\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+      String existingTargetFileHash = knownTargetHashes.get(targetPath.toString());\n+\n+      if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+        logger.info(String.format(\"copying featured mod file: %s to %s\", cacheFilePath.toString(), targetPath.toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2OTgwOA==", "bodyText": "done", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436269808", "createdAt": "2020-06-06T13:38:40Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +68,50 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();\n+        knownTargetHashes.put(targetPath.toString(), existingTargetFileHash);\n+\n+        if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+          logger.info(String.format(\"downloading: %s\", cacheFilePath.toString()));\n+          downloadFeaturedModFile(featuredModFile, cacheFilePath);\n+        }\n       } else {\n-        Files.createDirectories(targetPath.getParent());\n-        updateMessage(i18n.get(\"updater.downloadingFile\", targetPath.getFileName()));\n-\n-        String url = featuredModFile.getUrl();\n-        downloadService.downloadFile(new URL(url), targetPath, this::updateProgress);\n-        UpdaterUtil.extractMoviesIfPresent(targetPath, fafDataDirectory);\n+        logger.info(String.format(\"downloading: %s\", targetPath.toString()));\n+        downloadFeaturedModFile(featuredModFile, targetPath);\n+        knownTargetHashes.put(targetPath.toString(), featuredModFile.getMd5());\n       }\n \n-\n       if (\"bin\".equals(featuredModFile.getGroup()) && initFileName.equalsIgnoreCase(featuredModFile.getName())) {\n         initFile = targetPath;\n       }\n     }\n \n+    for (FeaturedModFile featuredModFile : featuredModFiles) {\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+      String existingTargetFileHash = knownTargetHashes.get(targetPath.toString());\n+\n+      if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+        logger.info(String.format(\"copying featured mod file: %s to %s\", cacheFilePath.toString(), targetPath.toString()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NDUyNg=="}, "originalCommit": {"oid": "12c02a3be69a3399bdf7891b956d2b4861881745"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg0MDk0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoxMjo0NlrOGgF7Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoxMjo0NlrOGgF7Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNDY3MA==", "bodyText": "There are metods to make this calculation. Instant or OffsetDateTime", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436304670", "createdAt": "2020-06-06T22:12:46Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTimeInDays() * 1000 * 3600 * 24;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg0MzMxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoxNjoxM1rOGgF8Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoxNjoxM1rOGgF8Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNDk1MA==", "bodyText": "throw new RuntimeException(e)", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436304950", "createdAt": "2020-06-06T22:16:13Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTimeInDays() * 1000 * 3600 * 24;\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      log.error(e.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg0MzM4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoxNjoyN1rOGgF8Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoxNjoyN1rOGgF8Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNDk2Mg==", "bodyText": "@SneakyThrows", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436304962", "createdAt": "2020-06-06T22:16:27Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTimeInDays() * 1000 * 3600 * 24;\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg0MzYwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoxNzowMVrOGgF8WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoxNzowMVrOGgF8WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNDk4NA==", "bodyText": "just purge that", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436304984", "createdAt": "2020-06-06T22:17:01Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTimeInDays() * 1000 * 3600 * 24;\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg0Mzg2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoxNzoyNFrOGgF8dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoxNzoyNFrOGgF8dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNTAxMg==", "bodyText": "warn", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436305012", "createdAt": "2020-06-06T22:17:24Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTimeInDays() * 1000 * 3600 * 24;\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      log.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    try {\n+      Files.walk(this.cacheDirectory).forEach(this::walkDirectoriesAndDeleteCachedFiles);\n+    } catch (IOException e) {\n+      log.error(\"Exception during gathering files\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg0NDYzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoyMDozNlrOGgF9Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoyMDozNlrOGgF9Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNTE3OA==", "bodyText": "debug", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436305178", "createdAt": "2020-06-06T22:20:36Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTimeInDays() * 1000 * 3600 * 24;\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      log.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    try {\n+      Files.walk(this.cacheDirectory).forEach(this::walkDirectoriesAndDeleteCachedFiles);\n+    } catch (IOException e) {\n+      log.error(\"Exception during gathering files\", e);\n+    }\n+  }\n+\n+  private void walkDirectoriesAndDeleteCachedFiles(Path directoryPath) {\n+    try {\n+      Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+    } catch (IOException e) {\n+      log.error(\"Exception during gathering files per directory\", e);\n+    }\n+  }\n+\n+  /**\n+   * Per directory cleanup old files.\n+   */\n+  private void deleteCachedFileIfNeeded(Path filePath) {\n+    if (Files.isDirectory(filePath)) {\n+      return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg0NTYwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoyMToxOVrOGgF9SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoyMToxOVrOGgF9SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNTIyNA==", "bodyText": "Instant", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436305224", "createdAt": "2020-06-06T22:21:19Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTimeInDays() * 1000 * 3600 * 24;\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      log.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    try {\n+      Files.walk(this.cacheDirectory).forEach(this::walkDirectoriesAndDeleteCachedFiles);\n+    } catch (IOException e) {\n+      log.error(\"Exception during gathering files\", e);\n+    }\n+  }\n+\n+  private void walkDirectoriesAndDeleteCachedFiles(Path directoryPath) {\n+    try {\n+      Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+    } catch (IOException e) {\n+      log.error(\"Exception during gathering files per directory\", e);\n+    }\n+  }\n+\n+  /**\n+   * Per directory cleanup old files.\n+   */\n+  private void deleteCachedFileIfNeeded(Path filePath) {\n+    if (Files.isDirectory(filePath)) {\n+      return;\n+    }\n+\n+    try {\n+      ResourceLocks.acquireDiskLock();\n+\n+      FileTime lastAccessTime = Files.readAttributes(filePath, BasicFileAttributes.class).lastAccessTime();\n+      if (lastAccessTime.toMillis() + cacheLifeTime < System.currentTimeMillis()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg0NTc0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoyMTo0OFrOGgF9Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoyMTo0OFrOGgF9Wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNTI0Mg==", "bodyText": "Also {}", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436305242", "createdAt": "2020-06-06T22:21:48Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private int cacheLifeTime;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTime = preferencesService.getPreferences().getCacheLifeTimeInDays() * 1000 * 3600 * 24;\n+  }\n+\n+  private String getCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory.resolve(featuredModFile.getGroup()).resolve(getCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) throws java.io.IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } catch (Exception e) {\n+      log.error(e.toString());\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    try {\n+      Files.walk(this.cacheDirectory).forEach(this::walkDirectoriesAndDeleteCachedFiles);\n+    } catch (IOException e) {\n+      log.error(\"Exception during gathering files\", e);\n+    }\n+  }\n+\n+  private void walkDirectoriesAndDeleteCachedFiles(Path directoryPath) {\n+    try {\n+      Files.walk(directoryPath).forEach(this::deleteCachedFileIfNeeded);\n+    } catch (IOException e) {\n+      log.error(\"Exception during gathering files per directory\", e);\n+    }\n+  }\n+\n+  /**\n+   * Per directory cleanup old files.\n+   */\n+  private void deleteCachedFileIfNeeded(Path filePath) {\n+    if (Files.isDirectory(filePath)) {\n+      return;\n+    }\n+\n+    try {\n+      ResourceLocks.acquireDiskLock();\n+\n+      FileTime lastAccessTime = Files.readAttributes(filePath, BasicFileAttributes.class).lastAccessTime();\n+      if (lastAccessTime.toMillis() + cacheLifeTime < System.currentTimeMillis()) {\n+        log.info(\"deleting: \" + filePath.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg0NjczOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjoyNDowMFrOGgF90w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjo0OTozNlrOHjIVRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNTM2Mw==", "bodyText": "maybe static import", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436305363", "createdAt": "2020-06-06T22:24:00Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +61,46 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n-      } else {\n-        Files.createDirectories(targetPath.getParent());\n-        updateMessage(i18n.get(\"updater.downloadingFile\", targetPath.getFileName()));\n-\n-        String url = featuredModFile.getUrl();\n-        downloadService.downloadFile(new URL(url), targetPath, this::updateProgress);\n-        UpdaterUtil.extractMoviesIfPresent(targetPath, fafDataDirectory);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMDA2NA==", "bodyText": "import java.nio.file.Files; vs com.google.common.io.Files, it will fight each other, how to solve such?", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r490620064", "createdAt": "2020-09-17T23:40:44Z", "author": {"login": "norraxx"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +61,46 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n-      } else {\n-        Files.createDirectories(targetPath.getParent());\n-        updateMessage(i18n.get(\"updater.downloadingFile\", targetPath.getFileName()));\n-\n-        String url = featuredModFile.getUrl();\n-        downloadService.downloadFile(new URL(url), targetPath, this::updateProgress);\n-        UpdaterUtil.extractMoviesIfPresent(targetPath, fafDataDirectory);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNTM2Mw=="}, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU5ODcyNg==", "bodyText": "static import just the function", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r506598726", "createdAt": "2020-10-16T16:49:36Z", "author": {"login": "Brutus5000"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +61,46 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n-      } else {\n-        Files.createDirectories(targetPath.getParent());\n-        updateMessage(i18n.get(\"updater.downloadingFile\", targetPath.getFileName()));\n-\n-        String url = featuredModFile.getUrl();\n-        downloadService.downloadFile(new URL(url), targetPath, this::updateProgress);\n-        UpdaterUtil.extractMoviesIfPresent(targetPath, fafDataDirectory);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNTM2Mw=="}, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg1MTU1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjozNTo1NVrOGgGARQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjozNTo1NVrOGgGARQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNTk4OQ==", "bodyText": "check if in cache first", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436305989", "createdAt": "2020-06-06T22:35:55Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +61,46 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n-      } else {\n-        Files.createDirectories(targetPath.getParent());\n-        updateMessage(i18n.get(\"updater.downloadingFile\", targetPath.getFileName()));\n-\n-        String url = featuredModFile.getUrl();\n-        downloadService.downloadFile(new URL(url), targetPath, this::updateProgress);\n-        UpdaterUtil.extractMoviesIfPresent(targetPath, fafDataDirectory);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();\n+        knownTargetHashes.put(targetPath.toString(), existingTargetFileHash);\n       }\n \n+      if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+        log.info(\"Downloading: {}\", cacheFilePath);\n+        downloadFeaturedModFile(featuredModFile, cacheFilePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg1MjcxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjozODo1MlrOGgGA2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjozODo1MlrOGgGA2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNjEzOA==", "bodyText": "copyMissingFilesFromCache", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436306138", "createdAt": "2020-06-06T22:38:52Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/patch/SimpleHttpFeaturedModUpdaterTask.java", "diffHunk": "@@ -54,32 +61,46 @@ protected PatchResult call() throws Exception {\n     updateMessage(i18n.get(\"updater.readingFileList\"));\n \n     List<FeaturedModFile> featuredModFiles = fafService.getFeaturedModFiles(featuredMod, version).get();\n+    Path fafDataDirectory = preferencesService.getFafDataDirectory();\n \n     Path initFile = null;\n+    Path cacheFilePath;\n+    Path targetPath;\n+\n+    Map<String, String> knownTargetHashes = new HashMap<>();\n+\n+    // Download to cache if file exists in target place, otherwise, download to direct place.\n     for (FeaturedModFile featuredModFile : featuredModFiles) {\n-      Path fafDataDirectory = preferencesService.getFafDataDirectory();\n-      Path targetPath = fafDataDirectory\n-          .resolve(featuredModFile.getGroup())\n-          .resolve(featuredModFile.getName());\n-\n-      if (Files.exists(targetPath)\n-          && featuredModFile.getMd5().equals(com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString())) {\n-        logger.debug(\"Already up to date: {}\", targetPath);\n-      } else {\n-        Files.createDirectories(targetPath.getParent());\n-        updateMessage(i18n.get(\"updater.downloadingFile\", targetPath.getFileName()));\n-\n-        String url = featuredModFile.getUrl();\n-        downloadService.downloadFile(new URL(url), targetPath, this::updateProgress);\n-        UpdaterUtil.extractMoviesIfPresent(targetPath, fafDataDirectory);\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+\n+      String existingTargetFileHash = null;\n+      if (Files.exists(targetPath)) {\n+        existingTargetFileHash = com.google.common.io.Files.hash(targetPath.toFile(), Hashing.md5()).toString();\n+        knownTargetHashes.put(targetPath.toString(), existingTargetFileHash);\n       }\n \n+      if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+        log.info(\"Downloading: {}\", cacheFilePath);\n+        downloadFeaturedModFile(featuredModFile, cacheFilePath);\n+      }\n \n       if (\"bin\".equals(featuredModFile.getGroup()) && initFileName.equalsIgnoreCase(featuredModFile.getName())) {\n         initFile = targetPath;\n       }\n     }\n \n+    for (FeaturedModFile featuredModFile : featuredModFiles) {\n+      targetPath = fafDataDirectory.resolve(featuredModFile.getGroup()).resolve(featuredModFile.getName());\n+      cacheFilePath = featuredModFileCacheService.getCachedFilePath(featuredModFile);\n+      String existingTargetFileHash = knownTargetHashes.get(targetPath.toString());\n+\n+      if (!featuredModFile.getMd5().equals(existingTargetFileHash)) {\n+        log.info(\"copying featured mod file: {} to {}\", cacheFilePath, targetPath);\n+        featuredModFileCacheService.copyFeaturedModFileFromCache(cacheFilePath, targetPath);\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg1NTQ1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/preferences/ui/SettingsController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjo0NTo0MFrOGgGCRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjo0NTo0MFrOGgGCRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNjUwMg==", "bodyText": "Apply TextFormatter setTextFormatter", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436306502", "createdAt": "2020-06-06T22:45:40Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/preferences/ui/SettingsController.java", "diffHunk": "@@ -142,6 +142,7 @@\n   private ChangeListener<Theme> selectedThemeChangeListener;\n   private ChangeListener<Theme> currentThemeChangeListener;\n   public ComboBox<NavigationItem> startTabChoiceBox;\n+  public TextField cacheLifeTimeTextField;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNzg1NjA0OnYy", "diffSide": "RIGHT", "path": "src/main/resources/i18n/messages.properties", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjo0Njo0NVrOGgGCjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQyMjo0Njo0NVrOGgGCjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwNjU3Mw==", "bodyText": "Files cached for(in days):", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r436306573", "createdAt": "2020-06-06T22:46:45Z", "author": {"login": "1-alex98"}, "path": "src/main/resources/i18n/messages.properties", "diffHunk": "@@ -677,6 +677,7 @@ gamePath.select.fafDataSelected=The specified location is the Forged Alliance Fo\n gamePath.select.error=Something went wrong selecting game path\n userInfo.statistics.errorLoading=Could not load statistics\n settings.general.unitDatabase=Unit database\n+settings.general.cacheLifeTime=Cache downloaded files for (in days)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21270effe3102b5be809ad110ac9e52323ae73dc"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3NTE1ODY1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDoxODoxMlrOHjcZ5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDo1ODo1MFrOHjcmQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkyNzU4OQ==", "bodyText": ". seems to be a dangrous delimiter. Could there not be mod files that have a . in the name \ud83e\udd14", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r506927589", "createdAt": "2020-10-17T10:18:12Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneId;\n+import java.util.stream.Stream;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private final int cacheLifeTimeInDays;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTimeInDays = preferencesService.getPreferences().getCacheLifeTimeInDays();\n+  }\n+\n+  public boolean isCached(FeaturedModFile featuredModFile) {\n+    return Files.exists(getCachedFilePath(featuredModFile));\n+  }\n+\n+  private String readHashFromFile(Path filePath) {\n+    // see buildCachedFileName\n+    return filePath.getFileName().toString().split(\"\\\\.\")[3];\n+  }\n+\n+  private String buildCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c58ea8d686a070313ee124338eff1fe66e1c8200"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkyNzk3OQ==", "bodyText": "is that possible?", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r506927979", "createdAt": "2020-10-17T10:23:20Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneId;\n+import java.util.stream.Stream;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private final int cacheLifeTimeInDays;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTimeInDays = preferencesService.getPreferences().getCacheLifeTimeInDays();\n+  }\n+\n+  public boolean isCached(FeaturedModFile featuredModFile) {\n+    return Files.exists(getCachedFilePath(featuredModFile));\n+  }\n+\n+  private String readHashFromFile(Path filePath) {\n+    // see buildCachedFileName\n+    return filePath.getFileName().toString().split(\"\\\\.\")[3];\n+  }\n+\n+  private String buildCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkyNzU4OQ=="}, "originalCommit": {"oid": "c58ea8d686a070313ee124338eff1fe66e1c8200"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzMDc1NA==", "bodyText": "And yes file name as almost always a . in it.... But anyway what do you need the file name for???", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r506930754", "createdAt": "2020-10-17T10:58:50Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneId;\n+import java.util.stream.Stream;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private final int cacheLifeTimeInDays;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTimeInDays = preferencesService.getPreferences().getCacheLifeTimeInDays();\n+  }\n+\n+  public boolean isCached(FeaturedModFile featuredModFile) {\n+    return Files.exists(getCachedFilePath(featuredModFile));\n+  }\n+\n+  private String readHashFromFile(Path filePath) {\n+    // see buildCachedFileName\n+    return filePath.getFileName().toString().split(\"\\\\.\")[3];\n+  }\n+\n+  private String buildCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkyNzU4OQ=="}, "originalCommit": {"oid": "c58ea8d686a070313ee124338eff1fe66e1c8200"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3NTE2MDE2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDoyMDoyNlrOHjcalA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDoyMDoyNlrOHjcalA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkyNzc2NA==", "bodyText": "If they are cached here changes to this variables are later not reflected. While this does not matter for cacheLifeTime it might be for the cache driectory(even that is also unlikely)", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r506927764", "createdAt": "2020-10-17T10:20:26Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneId;\n+import java.util.stream.Stream;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private final int cacheLifeTimeInDays;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTimeInDays = preferencesService.getPreferences().getCacheLifeTimeInDays();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c58ea8d686a070313ee124338eff1fe66e1c8200"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3NTE4MDg1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDo1MTozNlrOHjcj-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDo1MzoxNFrOHjckfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzMDE3MA==", "bodyText": "should be debug cause that gets really verbose", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r506930170", "createdAt": "2020-10-17T10:51:36Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneId;\n+import java.util.stream.Stream;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private final int cacheLifeTimeInDays;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTimeInDays = preferencesService.getPreferences().getCacheLifeTimeInDays();\n+  }\n+\n+  public boolean isCached(FeaturedModFile featuredModFile) {\n+    return Files.exists(getCachedFilePath(featuredModFile));\n+  }\n+\n+  private String readHashFromFile(Path filePath) {\n+    // see buildCachedFileName\n+    return filePath.getFileName().toString().split(\"\\\\.\")[3];\n+  }\n+\n+  private String buildCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory\n+        .resolve(featuredModFile.getGroup())\n+        .resolve(buildCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(FeaturedModFile featuredModFile, Path targetPath) throws IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(getCachedFilePath(featuredModFile), targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  @SneakyThrows\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    cleanUnusedFilesFromCache();\n+  }\n+\n+  private void cleanUnusedFilesFromCache() {\n+    try (Stream<Path> pathElements = Files.walk(this.cacheDirectory)) {\n+      pathElements\n+          .filter(Files::isRegularFile)\n+          .forEach(this::deleteCachedFileIfNeeded);\n+    } catch (IOException e) {\n+      log.error(\"Cleaning featured mod files cache failed\", e);\n+    }\n+  }\n+\n+  /**\n+   * Per directory cleanup old files.\n+   */\n+  private void deleteCachedFileIfNeeded(Path filePath) {\n+    try {\n+      ResourceLocks.acquireDiskLock();\n+\n+      FileTime lastAccessTime = Files.readAttributes(filePath, BasicFileAttributes.class).lastAccessTime();\n+      OffsetDateTime comparableLastAccessTime = OffsetDateTime.ofInstant(lastAccessTime.toInstant(), ZoneId.systemDefault());\n+      if (comparableLastAccessTime.plusDays(this.cacheLifeTimeInDays).isBefore(OffsetDateTime.now())) {\n+        log.info(\"Deleting cached file ''{}'' (last access:\", filePath.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c58ea8d686a070313ee124338eff1fe66e1c8200"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzMDMwMQ==", "bodyText": "Also log statement is incomplete...", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r506930301", "createdAt": "2020-10-17T10:53:14Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneId;\n+import java.util.stream.Stream;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private final int cacheLifeTimeInDays;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTimeInDays = preferencesService.getPreferences().getCacheLifeTimeInDays();\n+  }\n+\n+  public boolean isCached(FeaturedModFile featuredModFile) {\n+    return Files.exists(getCachedFilePath(featuredModFile));\n+  }\n+\n+  private String readHashFromFile(Path filePath) {\n+    // see buildCachedFileName\n+    return filePath.getFileName().toString().split(\"\\\\.\")[3];\n+  }\n+\n+  private String buildCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory\n+        .resolve(featuredModFile.getGroup())\n+        .resolve(buildCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(FeaturedModFile featuredModFile, Path targetPath) throws IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(getCachedFilePath(featuredModFile), targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  @SneakyThrows\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    cleanUnusedFilesFromCache();\n+  }\n+\n+  private void cleanUnusedFilesFromCache() {\n+    try (Stream<Path> pathElements = Files.walk(this.cacheDirectory)) {\n+      pathElements\n+          .filter(Files::isRegularFile)\n+          .forEach(this::deleteCachedFileIfNeeded);\n+    } catch (IOException e) {\n+      log.error(\"Cleaning featured mod files cache failed\", e);\n+    }\n+  }\n+\n+  /**\n+   * Per directory cleanup old files.\n+   */\n+  private void deleteCachedFileIfNeeded(Path filePath) {\n+    try {\n+      ResourceLocks.acquireDiskLock();\n+\n+      FileTime lastAccessTime = Files.readAttributes(filePath, BasicFileAttributes.class).lastAccessTime();\n+      OffsetDateTime comparableLastAccessTime = OffsetDateTime.ofInstant(lastAccessTime.toInstant(), ZoneId.systemDefault());\n+      if (comparableLastAccessTime.plusDays(this.cacheLifeTimeInDays).isBefore(OffsetDateTime.now())) {\n+        log.info(\"Deleting cached file ''{}'' (last access:\", filePath.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzMDE3MA=="}, "originalCommit": {"oid": "c58ea8d686a070313ee124338eff1fe66e1c8200"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3NTE4MjYxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDo1NDoyNVrOHjckyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDo1NjoxNVrOHjclhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzMDM3OQ==", "bodyText": "this is obsolete", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r506930379", "createdAt": "2020-10-17T10:54:25Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneId;\n+import java.util.stream.Stream;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private final int cacheLifeTimeInDays;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTimeInDays = preferencesService.getPreferences().getCacheLifeTimeInDays();\n+  }\n+\n+  public boolean isCached(FeaturedModFile featuredModFile) {\n+    return Files.exists(getCachedFilePath(featuredModFile));\n+  }\n+\n+  private String readHashFromFile(Path filePath) {\n+    // see buildCachedFileName\n+    return filePath.getFileName().toString().split(\"\\\\.\")[3];\n+  }\n+\n+  private String buildCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory\n+        .resolve(featuredModFile.getGroup())\n+        .resolve(buildCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(FeaturedModFile featuredModFile, Path targetPath) throws IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(getCachedFilePath(featuredModFile), targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  @SneakyThrows\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    cleanUnusedFilesFromCache();\n+  }\n+\n+  private void cleanUnusedFilesFromCache() {\n+    try (Stream<Path> pathElements = Files.walk(this.cacheDirectory)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c58ea8d686a070313ee124338eff1fe66e1c8200"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzMDU2NA==", "bodyText": "also cacheDirectory is C:\\ProgramData\\FAForever\\cache so that the FeaturedModFileCacheService deletes files from all caches not only the featured mod files.", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r506930564", "createdAt": "2020-10-17T10:56:15Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/io/FeaturedModFileCacheService.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.faforever.client.io;\n+\n+import com.faforever.client.api.dto.FeaturedModFile;\n+import com.faforever.client.preferences.PreferencesService;\n+import com.faforever.client.task.ResourceLocks;\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.StandardCopyOption;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileTime;\n+import java.time.OffsetDateTime;\n+import java.time.ZoneId;\n+import java.util.stream.Stream;\n+\n+\n+@Service\n+@Slf4j\n+public class FeaturedModFileCacheService implements InitializingBean {\n+  private final Path cacheDirectory;\n+  private final int cacheLifeTimeInDays;\n+\n+  public FeaturedModFileCacheService(PreferencesService preferencesService) {\n+    this.cacheDirectory = preferencesService.getCacheDirectory();\n+    this.cacheLifeTimeInDays = preferencesService.getPreferences().getCacheLifeTimeInDays();\n+  }\n+\n+  public boolean isCached(FeaturedModFile featuredModFile) {\n+    return Files.exists(getCachedFilePath(featuredModFile));\n+  }\n+\n+  private String readHashFromFile(Path filePath) {\n+    // see buildCachedFileName\n+    return filePath.getFileName().toString().split(\"\\\\.\")[3];\n+  }\n+\n+  private String buildCachedFileName(FeaturedModFile featuredModFile) {\n+    return String.format(\n+        \"%s.%s.%s.%s\",\n+        featuredModFile.getId(),\n+        featuredModFile.getVersion(),\n+        featuredModFile.getMd5(),\n+        featuredModFile.getName()\n+    );\n+  }\n+\n+  public Path getCachedFilePath(FeaturedModFile featuredModFile) {\n+    return cacheDirectory\n+        .resolve(featuredModFile.getGroup())\n+        .resolve(buildCachedFileName(featuredModFile));\n+  }\n+\n+  public void copyFeaturedModFileFromCache(FeaturedModFile featuredModFile, Path targetPath) throws IOException {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(getCachedFilePath(featuredModFile), targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  @SneakyThrows\n+  public void copyFeaturedModFileFromCache(Path cacheFilePath, Path targetPath) {\n+    Files.createDirectories(targetPath.getParent());\n+    ResourceLocks.acquireDiskLock();\n+\n+    try {\n+      Files.copy(cacheFilePath, targetPath, StandardCopyOption.REPLACE_EXISTING);\n+    } finally {\n+      ResourceLocks.freeDiskLock();\n+    }\n+  }\n+\n+  /**\n+   * Cleanup method, on service start, we'll get rid of old files.\n+   */\n+  @Override\n+  public void afterPropertiesSet() {\n+    cleanUnusedFilesFromCache();\n+  }\n+\n+  private void cleanUnusedFilesFromCache() {\n+    try (Stream<Path> pathElements = Files.walk(this.cacheDirectory)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzMDM3OQ=="}, "originalCommit": {"oid": "c58ea8d686a070313ee124338eff1fe66e1c8200"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3NTE4NjQxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/preferences/PreferencesService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDo1OTo0OVrOHjcmig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QxMDo1OTo0OVrOHjcmig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjkzMDgyNg==", "bodyText": "should be used by cache service but is not", "url": "https://github.com/FAForever/downlords-faf-client/pull/1739#discussion_r506930826", "createdAt": "2020-10-17T10:59:49Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/preferences/PreferencesService.java", "diffHunk": "@@ -344,6 +347,10 @@ public Path getCacheDirectory() {\n     return CACHE_DIRECTORY;\n   }\n \n+  public Path getFeaturedModCachePath() {\n+    return FEATURED_MOD_CACHE_PATH;\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c58ea8d686a070313ee124338eff1fe66e1c8200"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2018, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}