{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MzQyODU4", "number": 1788, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNDoyNTo0NFrOEHTLgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNDoyNzo1OFrOEHTL7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MDg5NzI4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNDoyNTo0NFrOGmmzpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMzoxNzoyMFrOGqqIBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDg4NQ==", "bodyText": "Can u specify what you mean, maybe link a GitHub issue. Donot think that a user could use this string to attack another client", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443134885", "createdAt": "2020-06-20T14:25:44Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -231,6 +233,7 @@ static Integer parseSupComVersion(byte[] rawReplayBytes) {\n   static String parseMapName(byte[] rawReplayBytes) {\n     int mapDelimiterIndex = Bytes.indexOf(rawReplayBytes, new byte[]{0x00, 0x0D, 0x0A, 0x1A});\n     String mapPath = new String(rawReplayBytes, MAP_NAME_OFFSET, mapDelimiterIndex - MAP_NAME_OFFSET, US_ASCII);\n+    // TODO make sure that these are valid characters for a file name? this is potentially unsafe user input", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzMDE5OA==", "bodyText": "The usual maps dont require calling this beause mapName is in metadata. That mapName is retrived from some server column by matching via filename. So for normal maps we are guarantueed to get server entries. When directly parsing, we are reading a name that comes directly from one players client.\nI guess it doesnt matter because downloading the mapo will simply fail if we have invalid characters right?", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443230198", "createdAt": "2020-06-21T15:24:44Z", "author": {"login": "Katharsas"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -231,6 +233,7 @@ static Integer parseSupComVersion(byte[] rawReplayBytes) {\n   static String parseMapName(byte[] rawReplayBytes) {\n     int mapDelimiterIndex = Bytes.indexOf(rawReplayBytes, new byte[]{0x00, 0x0D, 0x0A, 0x1A});\n     String mapPath = new String(rawReplayBytes, MAP_NAME_OFFSET, mapDelimiterIndex - MAP_NAME_OFFSET, US_ASCII);\n+    // TODO make sure that these are valid characters for a file name? this is potentially unsafe user input", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDg4NQ=="}, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM4MzU1Nw==", "bodyText": "I added in a check for invalid filename characters", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r447383557", "createdAt": "2020-06-30T03:17:20Z", "author": {"login": "Sheikah45"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -231,6 +233,7 @@ static Integer parseSupComVersion(byte[] rawReplayBytes) {\n   static String parseMapName(byte[] rawReplayBytes) {\n     int mapDelimiterIndex = Bytes.indexOf(rawReplayBytes, new byte[]{0x00, 0x0D, 0x0A, 0x1A});\n     String mapPath = new String(rawReplayBytes, MAP_NAME_OFFSET, mapDelimiterIndex - MAP_NAME_OFFSET, US_ASCII);\n+    // TODO make sure that these are valid characters for a file name? this is potentially unsafe user input", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDg4NQ=="}, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MDg5ODE1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNDoyNzozNlrOGmm0EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQxNToyMDo0M1rOGmsmuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDk5Mg==", "bodyText": "This is also the case for other featured mods like coop.  How would that work out there?", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443134992", "createdAt": "2020-06-20T14:27:36Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -503,6 +507,14 @@ private void runFafReplayFile(Path path) throws IOException {\n       mapName = parseMapFolderName(rawReplayBytes);\n     }\n \n+    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n+    // from replay data, and DB does not contain generated maps.\n+    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIyOTg4MA==", "bodyText": "Coop maps seem to be handled in the lines directly above this code. Maybe it was null or empty in the past and due to a replay server change is \"None\" now for coop maps as well?", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443229880", "createdAt": "2020-06-21T15:20:43Z", "author": {"login": "Katharsas"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -503,6 +507,14 @@ private void runFafReplayFile(Path path) throws IOException {\n       mapName = parseMapFolderName(rawReplayBytes);\n     }\n \n+    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n+    // from replay data, and DB does not contain generated maps.\n+    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDk5Mg=="}, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MDg5ODM3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNDoyNzo1OVrOGmm0Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNzo0NjozMlrOGtD1Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNTAxNQ==", "bodyText": "Could we write a unit test for that?", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443135015", "createdAt": "2020-06-20T14:27:59Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -503,6 +507,14 @@ private void runFafReplayFile(Path path) throws IOException {\n       mapName = parseMapFolderName(rawReplayBytes);\n     }\n \n+    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n+    // from replay data, and DB does not contain generated maps.\n+    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {\n+      String maybeMapGen = parseMapFolderName(rawReplayBytes);\n+      if (mapGeneratorService.isGeneratedMap(maybeMapGen)) {\n+        mapName = maybeMapGen;\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzMDQwMg==", "bodyText": "Do we have some actual specification that determines when mapName is supposed to be null, empty or \"None\"? Otherwise the test will just enforce arbitrary things.", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443230402", "createdAt": "2020-06-21T15:26:39Z", "author": {"login": "Katharsas"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -503,6 +507,14 @@ private void runFafReplayFile(Path path) throws IOException {\n       mapName = parseMapFolderName(rawReplayBytes);\n     }\n \n+    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n+    // from replay data, and DB does not contain generated maps.\n+    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {\n+      String maybeMapGen = parseMapFolderName(rawReplayBytes);\n+      if (mapGeneratorService.isGeneratedMap(maybeMapGen)) {\n+        mapName = maybeMapGen;\n+      }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNTAxNQ=="}, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwMTg3MQ==", "bodyText": "Sheikah added a test", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r449901871", "createdAt": "2020-07-05T17:46:32Z", "author": {"login": "Katharsas"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -503,6 +507,14 @@ private void runFafReplayFile(Path path) throws IOException {\n       mapName = parseMapFolderName(rawReplayBytes);\n     }\n \n+    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n+    // from replay data, and DB does not contain generated maps.\n+    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {\n+      String maybeMapGen = parseMapFolderName(rawReplayBytes);\n+      if (mapGeneratorService.isGeneratedMap(maybeMapGen)) {\n+        mapName = maybeMapGen;\n+      }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNTAxNQ=="}, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2022, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}