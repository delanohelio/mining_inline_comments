{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MzQyODU4", "number": 1788, "title": "Fix \"None\" map name retrieved for generated maps", "bodyText": "Fixes #1772", "createdAt": "2020-06-20T00:53:39Z", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788", "merged": true, "mergeCommit": {"oid": "ea3578ad1fcbbf6855228bb290a2a540f56e67b8"}, "closed": true, "closedAt": "2020-07-05T17:47:43Z", "author": {"login": "Katharsas"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcs8y9fgH2gAyNDM3MzQyODU4OjhiZjhmNTQyOGVkNjEyZGI3ZTczNWVhMmNiMjdlNjRlYzMyMzE3YjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyAW9BAFqTQ0MjY5NTAzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5", "author": {"user": {"login": "Katharsas", "name": "Jan"}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/8bf8f5428ed612db7e735ea2cb27e64ec32317b5", "committedDate": "2020-06-20T00:48:43Z", "message": "Fix \"None\" map name retrieved for generated maps"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDMxODEw", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#pullrequestreview-434431810", "createdAt": "2020-06-20T14:25:44Z", "commit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNDoyNTo0NFrOGmmzpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNDoyNzo1OVrOGmm0Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDg4NQ==", "bodyText": "Can u specify what you mean, maybe link a GitHub issue. Donot think that a user could use this string to attack another client", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443134885", "createdAt": "2020-06-20T14:25:44Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -231,6 +233,7 @@ static Integer parseSupComVersion(byte[] rawReplayBytes) {\n   static String parseMapName(byte[] rawReplayBytes) {\n     int mapDelimiterIndex = Bytes.indexOf(rawReplayBytes, new byte[]{0x00, 0x0D, 0x0A, 0x1A});\n     String mapPath = new String(rawReplayBytes, MAP_NAME_OFFSET, mapDelimiterIndex - MAP_NAME_OFFSET, US_ASCII);\n+    // TODO make sure that these are valid characters for a file name? this is potentially unsafe user input", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNDk5Mg==", "bodyText": "This is also the case for other featured mods like coop.  How would that work out there?", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443134992", "createdAt": "2020-06-20T14:27:36Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -503,6 +507,14 @@ private void runFafReplayFile(Path path) throws IOException {\n       mapName = parseMapFolderName(rawReplayBytes);\n     }\n \n+    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n+    // from replay data, and DB does not contain generated maps.\n+    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNTAxNQ==", "bodyText": "Could we write a unit test for that?", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#discussion_r443135015", "createdAt": "2020-06-20T14:27:59Z", "author": {"login": "1-alex98"}, "path": "src/main/java/com/faforever/client/replay/ReplayService.java", "diffHunk": "@@ -503,6 +507,14 @@ private void runFafReplayFile(Path path) throws IOException {\n       mapName = parseMapFolderName(rawReplayBytes);\n     }\n \n+    // For map generator games the map name is \"None\" because replay server gets map name by from DB based on filename\n+    // from replay data, and DB does not contain generated maps.\n+    if (StringUtils.equalsIgnoreCase(mapName, \"None\")) {\n+      String maybeMapGen = parseMapFolderName(rawReplayBytes);\n+      if (mapGeneratorService.isGeneratedMap(maybeMapGen)) {\n+        mapName = maybeMapGen;\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bf8f5428ed612db7e735ea2cb27e64ec32317b5"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efb633d8ff349a036b1ac5639ddaad1aac20d93e", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/efb633d8ff349a036b1ac5639ddaad1aac20d93e", "committedDate": "2020-06-30T03:14:13Z", "message": "Add check for invalid characters in filename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd7ff9f6253da3bdb835bcee19d6ebbb322881dc", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/fd7ff9f6253da3bdb835bcee19d6ebbb322881dc", "committedDate": "2020-06-30T03:14:35Z", "message": "Add unit tests for invalid filenames"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f56b55ba9f76aadb8058cb058d3fb6964168105", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/3f56b55ba9f76aadb8058cb058d3fb6964168105", "committedDate": "2020-06-30T11:56:09Z", "message": "Add unit test for generated map check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNTEwMzg5", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#pullrequestreview-440510389", "createdAt": "2020-07-01T02:43:31Z", "commit": {"oid": "3f56b55ba9f76aadb8058cb058d3fb6964168105"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fd54d238db31e581a13735c82d0a1f098c0778b", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/3fd54d238db31e581a13735c82d0a1f098c0778b", "committedDate": "2020-07-02T04:43:17Z", "message": "Use parseMapName over parseMapFolderName\n\nFor some reason parseMapFolderName returns the map name without any capitalization from the raw replay bytes. This causes issues with the base64 string encoding used by the next gen map generator. parseMapName returns the map name with correct capitalization making it more suitable for usage. As an aside it appears that parseMapFolderName uses the scenario file in the raw bytes to get the map name whereas parseMapName uses the .scmap file and the capitalization differences are reflected there."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzQ2NTU0", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#pullrequestreview-441346554", "createdAt": "2020-07-02T04:44:34Z", "commit": {"oid": "3fd54d238db31e581a13735c82d0a1f098c0778b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13be0cc079701e1adf171c49d5f6ada271e13209", "author": {"user": {"login": "Sheikah45", "name": null}}, "url": "https://github.com/FAForever/downlords-faf-client/commit/13be0cc079701e1adf171c49d5f6ada271e13209", "committedDate": "2020-07-02T11:51:35Z", "message": "Update unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNjA0NzU2", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#pullrequestreview-441604756", "createdAt": "2020-07-02T11:52:54Z", "commit": {"oid": "13be0cc079701e1adf171c49d5f6ada271e13209"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjk1MDM4", "url": "https://github.com/FAForever/downlords-faf-client/pull/1788#pullrequestreview-442695038", "createdAt": "2020-07-05T17:47:22Z", "commit": {"oid": "13be0cc079701e1adf171c49d5f6ada271e13209"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3204, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}