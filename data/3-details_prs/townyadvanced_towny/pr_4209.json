{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MDIyMTQy", "number": 4209, "title": "Remove Manual Config Changes and Migrate them automatically instead.", "bodyText": "Description:\n\nOverview\nI think many can agree that the biggest dread of upgrading the towny version is the manual labor involved with performing required config changes. If anything we should be making the upgrade process as fast as possible to get most people on the latest version. This PR helps the goal immensely:\nThis PR eliminates required config changes by keeping track of all config changes over each version. It does this by storing changes within a json file, which is read whenever a user installs a newer version of towny.\nMigration JSON format:\nTowny Stores config modification information in the config-migration.json file, here's excerpt of how it looks:\n[\n  {\n    \"version\": \"0.96.2.2\",\n    \"changes\": [\n      {\n        \"type\": \"APPEND\",\n        \"path\": \"protection.switch_ids\",\n        \"value\": \",CRIMSON_PRESSURE_PLATE,WARPED_PRESSURE_PLATE,POLISHED_BLACKSTONE_PRESSURE_PLATE,CRIMSON_BUTTON,WARPED_BUTTON,POLISHED_BLACKSTONE_BUTTON,CRIMSON_DOOR,WARPED_DOOR,CRIMSON_FENCE_GATE,WARPED_FENCE_GATE,CRIMSON_TRAPDOOR,WARPED_TRAPDOOR,LODESTONE,RESPAWN_ANCHOR,TARGET\"\n      },\n      {\n        \"type\": \"APPEND\",\n        \"path\": \"protection.item_use_ids\",\n        \"value\": \",NETHERITE_AXE\"\n      },\n      {\n        \"type\": \"APPEND\",\n        \"path\": \"new_world_settings.plot_management.revert_on_unclaim.block_ignore\",\n        \"value\": \",NETHER_GOLD_ORE,ANCIENT_DEBRIS,SOUL_TORCH,SOUL_WALL_TORCH,CRIMSON_SIGN,CRIMSON_WALL_SIGN,WARPED_SIGN,WARPED_WALL_SIGN,LODESTONE,RESPAWN_ANCHOR\",\n        \"worldAction\": \"UPDATE_WORLD_BLOCK_IGNORE\"\n      },\n      {\n        \"type\": \"APPEND\",\n        \"path\": \"new_world_settings.plot_management.mayor_plotblock_delete.mayor_plot_delete\",\n        \"value\": \",CRIMSON_WALL_SIGN,CRIMSON_SIGN,WARPED_WALL_SIGN,WARPED_SIGN\",\n        \"worldAction\": \"UPDATE_WORLD_DELETE_MAYOR\"\n      },\n      {\n        \"type\": \"APPEND\",\n        \"path\": \"new_world_settings.plot_management.block_delete.unclaim_delete\",\n        \"value\": \",CRIMSON_SIGN,WARPED_SIGN,CRIMSON_WALL_SIGN,WARPED_WALL_SIGN,CRIMSON_DOOR,WARPED_DOOR,SOUL_TORCH,SOUL_WALL_TORCH,CRIMSON_PRESSURE_PLATE,WARPED_PRESSURE_PLATE,POLISHED_BLACKSTONE_PRESSURE_PLATE\",\n        \"worldAction\": \"UPDATE_WORLD_UNCLAIM_DELETE\"\n      }\n    ]\n  },\n  {\n    \"version\": \"0.96.2.3\",\n    \"changes\": [\n      {\n        \"type\": \"OVERWRITE\",\n        \"path\": \"notification.format\",\n        \"value\": \"This is a test\"\n      }\n    ]\n  }\nIt defines an array of version numbers followed by a dictionary of changes, in the format:\n\"version\" : \"{VERSION}\"\n\"changes\": [\n      {\n        \"type\": \"{ACTION}\",\n        \"path\": \"{YML_PATH}\",\n        \"value\": \"{NEW_VALUE}\",\n        \"worldAction\": \"{WORLD_ACTION}\" \n      },\n      (...)\n]\n{VERSION} is the version where the migrations happened.\nFor {ACTION} there are two options:\n\n\"OVERWRITE\", which overwrites/replaces the config value.\n\"APPEND\", which appends a formatted string to the config value.\n\nThe field \"worldAction\" is optional and specifies to update the world files with new values.\nThe path key simply specifies which config YML path to modify. And {NEW_VALUE} is the new value to overwrite or append.\nYou can also add town or nation level properties:\n{\n    \"version\": \"{VERSION}\",\n    \"changes\": [\n      {\n        \"type\": \"TOWN_LEVEL_ADD\",\n        \"key\": \"myNewKey\",\n        \"value\": \"myNewValue\"\n      }\n    ]\n  }\nThe Idea is whenever a towny update is released this file is updated, so users can transition gracefully into their next towny version.\n\nNew Nodes/Commands/ConfigOptions:\n\n\nRelevant Towny Issue ticket:\n\n\n\n I have tested this pull request for defects on a server.\n\n\nBy making this pull request, I represent that I have the right to waive copyright and related rights to my contribution, and agree that all copyright and related rights in my contributions are waived, and I acknowledge that the TownyAdvanced organization has the copyright to use and modify my contribution under the Towny License for perpetuity.", "createdAt": "2020-07-24T00:51:16Z", "url": "https://github.com/TownyAdvanced/Towny/pull/4209", "merged": true, "mergeCommit": {"oid": "318a721dbc51c035ffab87924a20966e838e27af"}, "closed": true, "closedAt": "2020-07-26T01:46:33Z", "author": null, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc348zkgH2gAyNDU2MDIyMTQyOmI0OGM4ZWU4MjdkY2ZmYzcyNzQ0ODZlNTgzMTY0M2ZhMThjODdiNGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4MxNTgH2gAyNDU2MDIyMTQyOjE3NDQ0ZDI5OWY2YmRmYTEyNTI3MGMxMWRiZGRmZmMwZDA1MzczNDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b48c8ee827dcffc7274486e5831643fa18c87b4a", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/b48c8ee827dcffc7274486e5831643fa18c87b4a", "committedDate": "2020-07-24T00:33:01Z", "message": "Initial Commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d218646a3662e6bac74610b3fbc5e516bb55761", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/2d218646a3662e6bac74610b3fbc5e516bb55761", "committedDate": "2020-07-24T00:34:43Z", "message": "Merge branches 'feature/config-migration' and 'master' of https://github.com/TownyAdvanced/Towny into feature/config-migration\n\n\u0001 Conflicts:\n\u0001\tpom.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "191676952f246920baedd5211436849998881b17", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/191676952f246920baedd5211436849998881b17", "committedDate": "2020-07-24T03:04:33Z", "message": "Add support for adding town and nation level properties."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/44ee8f9059d276f5c00e04f77874996b7ea5c6b6", "committedDate": "2020-07-24T20:01:19Z", "message": "Removed unused code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca201a077cd93af2637912ee72ee23be4f7c0a60", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/ca201a077cd93af2637912ee72ee23be4f7c0a60", "committedDate": "2020-07-24T20:31:09Z", "message": "revert datasource change."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32f414c571937510f6f037273ba1c9391d8fe895", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/32f414c571937510f6f037273ba1c9391d8fe895", "committedDate": "2020-07-24T20:32:55Z", "message": "Remove test migrations from json file."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b0a25b73af773b1b92761df9c3a7702b6c42346", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/4b0a25b73af773b1b92761df9c3a7702b6c42346", "committedDate": "2020-07-24T20:36:16Z", "message": "Remove unused files."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTY1NTE5", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#pullrequestreview-455165519", "createdAt": "2020-07-24T20:26:26Z", "commit": {"oid": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDoyNjozMlrOG28xZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDozNjo1NVrOG29BYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MTk3Mw==", "bodyText": "Nuke these ones", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460271973", "createdAt": "2020-07-24T20:26:32Z", "author": {"login": "LlmDl"}, "path": "resources/config-migration.json", "diffHunk": "@@ -0,0 +1,55 @@\n+[\n+  {\n+    \"version\": \"0.96.2.2\",\n+    \"changes\": [\n+      {\n+        \"type\": \"APPEND\",\n+        \"path\": \"protection.switch_ids\",\n+        \"value\": \",CRIMSON_PRESSURE_PLATE,WARPED_PRESSURE_PLATE,POLISHED_BLACKSTONE_PRESSURE_PLATE,CRIMSON_BUTTON,WARPED_BUTTON,POLISHED_BLACKSTONE_BUTTON,CRIMSON_DOOR,WARPED_DOOR,CRIMSON_FENCE_GATE,WARPED_FENCE_GATE,CRIMSON_TRAPDOOR,WARPED_TRAPDOOR,LODESTONE,RESPAWN_ANCHOR,TARGET\"\n+      },\n+      {\n+        \"type\": \"APPEND\",\n+        \"path\": \"protection.item_use_ids\",\n+        \"value\": \",NETHERITE_AXE\"\n+      },\n+      {\n+        \"type\": \"APPEND\",\n+        \"path\": \"new_world_settings.plot_management.revert_on_unclaim.block_ignore\",\n+        \"value\": \",NETHER_GOLD_ORE,ANCIENT_DEBRIS,SOUL_TORCH,SOUL_WALL_TORCH,CRIMSON_SIGN,CRIMSON_WALL_SIGN,WARPED_SIGN,WARPED_WALL_SIGN,LODESTONE,RESPAWN_ANCHOR\",\n+        \"worldAction\": \"UPDATE_WORLD_BLOCK_IGNORE\"\n+      },\n+      {\n+        \"type\": \"APPEND\",\n+        \"path\": \"new_world_settings.plot_management.mayor_plotblock_delete.mayor_plot_delete\",\n+        \"value\": \",CRIMSON_WALL_SIGN,CRIMSON_SIGN,WARPED_WALL_SIGN,WARPED_SIGN\",\n+        \"worldAction\": \"UPDATE_WORLD_DELETE_MAYOR\"\n+      },\n+      {\n+        \"type\": \"APPEND\",\n+        \"path\": \"new_world_settings.plot_management.block_delete.unclaim_delete\",\n+        \"value\": \",CRIMSON_SIGN,WARPED_SIGN,CRIMSON_WALL_SIGN,WARPED_WALL_SIGN,CRIMSON_DOOR,WARPED_DOOR,SOUL_TORCH,SOUL_WALL_TORCH,CRIMSON_PRESSURE_PLATE,WARPED_PRESSURE_PLATE,POLISHED_BLACKSTONE_PRESSURE_PLATE\",\n+        \"worldAction\": \"UPDATE_WORLD_UNCLAIM_DELETE\"\n+      }\n+    ]\n+  },\n+  {\n+    \"version\": \"0.96.2.3\",\n+    \"changes\": [\n+      {\n+        \"type\": \"OVERWRITE\",\n+        \"path\": \"notification.format\",\n+        \"value\": \"This is a test\"\n+      }\n+    ]\n+  },\n+  {\n+    \"version\": \"0.96.2.4\",\n+    \"changes\": [\n+      {\n+        \"type\": \"TOWN_LEVEL_ADD\",\n+        \"key\": \"foo\",\n+        \"value\": \"bar\"\n+      }\n+    ]\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MjM4OA==", "bodyText": "remove unused import", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460272388", "createdAt": "2020-07-24T20:27:33Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/TownySettings.java", "diffHunk": "@@ -2,6 +2,7 @@\n \n import com.palmergames.bukkit.config.CommentedConfiguration;\n import com.palmergames.bukkit.config.ConfigNodes;\n+import com.palmergames.bukkit.config.migration.ConfigMigrator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MjQxMQ==", "bodyText": "Remove formatting change.", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460272411", "createdAt": "2020-07-24T20:27:36Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/TownySettings.java", "diffHunk": "@@ -231,7 +236,7 @@ public static void loadConfig(String filepath, String version) throws IOExceptio\n \t\t\t}\n \n \t\t\tsetDefaults(version, file);\n-\n+\t\t\t", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MjYyMg==", "bodyText": "Add [Towny] to beginning of Performing ....", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460272622", "createdAt": "2020-07-24T20:28:11Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/TownyUniverse.java", "diffHunk": "@@ -142,6 +144,16 @@ boolean loadSettings() {\n             return false;\n         }\n         \n+        Version lastRunVersion = new Version(TownySettings.getLastRunVersion(Towny.getPlugin().getVersion()));\n+        Version curVersion = new Version(Towny.getPlugin().getVersion());\n+        \n+        // Only migrate if the user just updated.\n+        if (!lastRunVersion.equals(curVersion)) {\n+\t\t\tSystem.out.println(\"Performing Config Migrations...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44ee8f9059d276f5c00e04f77874996b7ea5c6b6"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NTg3Mg==", "bodyText": "remove", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460275872", "createdAt": "2020-07-24T20:36:25Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/db/TownyDataSource.java", "diffHunk": "@@ -46,6 +46,7 @@\n \tfinal Lock lock = new ReentrantLock();\n \tprotected final Towny plugin;\n \tprotected final TownyUniverse universe;\n+\tprivate Runnable completionHandler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32f414c571937510f6f037273ba1c9391d8fe895"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NjAyOQ==", "bodyText": "delete class", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460276029", "createdAt": "2020-07-24T20:36:48Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/config/migration/NationLevelMigration.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package com.palmergames.bukkit.config.migration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32f414c571937510f6f037273ba1c9391d8fe895"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NjA2NA==", "bodyText": "delete class", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460276064", "createdAt": "2020-07-24T20:36:55Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/config/migration/TownLevelMigration.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package com.palmergames.bukkit.config.migration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32f414c571937510f6f037273ba1c9391d8fe895"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b43b4f384998c5fc0ef23ea699aa8fc912a3194", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/5b43b4f384998c5fc0ef23ea699aa8fc912a3194", "committedDate": "2020-07-24T20:40:43Z", "message": "Make requested changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/788266fb3fb221562d48f2d47718116d5d50ef6c", "committedDate": "2020-07-24T20:45:20Z", "message": "Cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTc1NjU3", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#pullrequestreview-455175657", "createdAt": "2020-07-24T20:45:52Z", "commit": {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjA2ODEw", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#pullrequestreview-455206810", "createdAt": "2020-07-24T21:58:25Z", "commit": {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMTo1ODoyNVrOG2-1OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMTo1ODoyNVrOG2-1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNTcyMQ==", "bodyText": "Use the logger", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460305721", "createdAt": "2020-07-24T21:58:25Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/config/migration/ConfigMigrator.java", "diffHunk": "@@ -0,0 +1,119 @@\n+package com.palmergames.bukkit.config.migration;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.reflect.TypeToken;\n+import com.palmergames.bukkit.config.CommentedConfiguration;\n+import com.palmergames.bukkit.towny.Towny;\n+import com.palmergames.bukkit.towny.TownySettings;\n+import com.palmergames.bukkit.towny.TownyUniverse;\n+import com.palmergames.bukkit.towny.object.TownyWorld;\n+import com.palmergames.bukkit.util.Version;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.Reader;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * An object which manages the procces of migrating towny config versions to \n+ * up-to-date ones.\n+ */\n+public class ConfigMigrator {\n+\t\n+\tprivate final String migrationFilename;\n+\tprivate static final Gson GSON = new GsonBuilder()\n+\t\t.registerTypeAdapter(Version.class, new VersionDeserializer()).create();\n+\tprivate final CommentedConfiguration config;\n+\t\n+\tpublic ConfigMigrator(CommentedConfiguration config, String filename) {\n+\t\tObjects.requireNonNull(config, filename);\n+\t\tthis.migrationFilename = filename;\n+\t\tthis.config = config;\n+\t}\n+\n+\t/**\n+\t * Migrates configuration to latest version availibe in the given JSON file.\n+\t */\n+\tpublic void migrate() {\n+\t\t// Use the last run version as a reference.\n+\t\tVersion configVersion = new Version(TownySettings.getLastRunVersion(Towny.getPlugin().getVersion()));\n+\t\t\n+\t\t// Go through each migration element.\n+\t\tfor (Migration migration : readMigrator()) {\n+\t\t\t// If a migration version is greater than our version, upgrade with it.\n+\t\t\tif (configVersion.compareTo(migration.version) < 0) {\n+\t\t\t\t// Perform all desired changes.\n+\t\t\t\tfor (Change change : migration.changes) {\n+\t\t\t\t\tperformChange(change);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\tconfig.save();\n+\t}\n+\t\n+\tprivate void performChange(Change change) {\n+\t\tswitch (change.type) {\n+\t\t\tcase OVERWRITE:\n+\t\t\t\tconfig.set(change.path, change.value);\n+\t\t\t\tbreak;\n+\t\t\tcase APPEND:\n+\t\t\t\tString base = config.getString(change.path);\n+\t\t\t\tconfig.set(change.path, base + change.value);\n+\t\t\t\tbreak;\n+\t\t\tcase TOWN_LEVEL_ADD:\n+\t\t\t\taddTownLevelProperty(change.key, change.value);\n+\t\t\t\tbreak;\n+\t\t\tcase NATION_LEVEL_ADD:\n+\t\t\t\taddNationLevelProperty(change.key, change.value);\n+\t\t\t\tbreak;\n+\t\t\tdefault:\n+\t\t\t\tthrow new UnsupportedOperationException(\"Unsupported Change type: \" + change);\n+\t\t}\n+\n+\t\tif (change.path != null) {\n+\t\t\t// Perform change.\n+\t\t\tSystem.out.println(\"Updating \" + change.path + \"...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjA5Mzk4", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#pullrequestreview-455209398", "createdAt": "2020-07-24T22:05:54Z", "commit": {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMjowNTo1NVrOG2-9yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMjowNTo1NVrOG2-9yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwNzkxMw==", "bodyText": "I think this class is small enough just to be a class inside ConfigMigrator.java", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460307913", "createdAt": "2020-07-24T22:05:55Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/config/migration/Migration.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.palmergames.bukkit.config.migration;\n+\n+import com.palmergames.bukkit.util.Version;\n+\n+import java.util.List;\n+\n+/**\n+ * Represents a collection of changes.\n+ */\n+class Migration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjA5NTk4", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#pullrequestreview-455209598", "createdAt": "2020-07-24T22:06:36Z", "commit": {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMjowNjozN1rOG2--VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMjowNjozN1rOG2--VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwODA1Mg==", "bodyText": "Use the logger here", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460308052", "createdAt": "2020-07-24T22:06:37Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/towny/TownyUniverse.java", "diffHunk": "@@ -142,6 +144,16 @@ boolean loadSettings() {\n             return false;\n         }\n         \n+        Version lastRunVersion = new Version(TownySettings.getLastRunVersion(Towny.getPlugin().getVersion()));\n+        Version curVersion = new Version(Towny.getPlugin().getVersion());\n+        \n+        // Only migrate if the user just updated.\n+        if (!lastRunVersion.equals(curVersion)) {\n+\t\t\tSystem.out.println(\"[Towny] Performing Config Migrations...\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MjExMDU5", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#pullrequestreview-455211059", "createdAt": "2020-07-24T22:10:57Z", "commit": {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMjoxMDo1N1rOG2_DLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMjoxMDo1N1rOG2_DLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwOTI5Mw==", "bodyText": "I think this has the possibility of being recursive since Object.equals() internally calls .equals(). At the least it's a useless call.", "url": "https://github.com/TownyAdvanced/Towny/pull/4209#discussion_r460309293", "createdAt": "2020-07-24T22:10:57Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/util/Version.java", "diffHunk": "@@ -35,14 +37,23 @@ public Version(String version) {\n \t\treturn 0;\n \t}\n \n-\t@Override public boolean equals(Object that) {\n-\t\tif(this == that)\n-\t\t\treturn true;\n-\t\tif(that == null)\n-\t\t\treturn false;\n-\t\tif(this.getClass() != that.getClass())\n-\t\t\treturn false;\n-\t\treturn this.compareTo((Version) that) == 0;\n+\t@Override\n+\tpublic boolean equals(Object o) {\n+\t\tif (this == o) return true;\n+\t\tif (!(o instanceof Version)) return false;\n+\t\tVersion version1 = (Version) o;\n+\t\treturn Objects.equals(version, version1.version);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "788266fb3fb221562d48f2d47718116d5d50ef6c"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61f855149a4ab9c2b62bde081ab46fbbe5464505", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/61f855149a4ab9c2b62bde081ab46fbbe5464505", "committedDate": "2020-07-24T22:53:13Z", "message": "Make requested changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77874ac03d5e671acf0dddaa7c9a59c7a3ba2e29", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/77874ac03d5e671acf0dddaa7c9a59c7a3ba2e29", "committedDate": "2020-07-24T22:53:35Z", "message": "Merge remote-tracking branch 'origin/feature/config-migration' into feature/config-migration\n\n# Conflicts:\n#\tsrc/com/palmergames/bukkit/config/migration/ConfigMigrator.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17444d299f6bdfa125270c11dbddffc0d0537345", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/17444d299f6bdfa125270c11dbddffc0d0537345", "committedDate": "2020-07-24T23:38:27Z", "message": "Update and add messaging."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4169, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}