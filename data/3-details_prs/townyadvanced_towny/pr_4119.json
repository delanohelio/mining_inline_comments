{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMDUwMDUx", "number": 4119, "title": "Residents.txt removal, Resident UUID Gathering.", "bodyText": "Description:\n\n\nRemoves residents.txt files from the database.\nLoads residents who do exist in the residents.txt file, deleting orphaned files that weren't being read anyways.\nRemoves storing the residents in the townname.txt files.\nDrops the residents column from the town table on mysql databases.\nRemoved removeResidentList(resident) and consolidate it into removeResident(resident).\nCleaned up TownyDatabaseHandler.removeTown(Town).\nRemoves Town.clear(). - Largely unused.\nRemoves Town.removeAllResidents(). - Unused.\n\n\n\nAdds BukkitTools.getUUIDSafely(String name) that returns UUIDs only when they are actually stored in the server cache, not pinging mojang.\nAdds BukkitTools.getUUIDFromResident(Resident resident) method to resolve the UUID of a resident, using their name and their lastLogin timestamp and the MojangAPI.\n\n\n\nCreate GatherResidentUUIDTask.\n\nQueue is populated with non-UUID residents on database load.\nReturns early if the resident has gotten a UUID since being added to the queue.\nBegins 1 minute after Towny has successfully enabled if UUID gathering is not 100% & the config's gathering_resident_uuids setting is true.\nRuns every 2 seconds gathering a UUID.\nFirst attempts to use the getUUIDSafely() method, using the server cache.\nSecondly attempts to use the getUUIDFromResident() method, using the MojangAPI.\n\nIf a response 204 is received the resident is deleted from the database.\n\n\nIf all of the above fail, it takes a 60 second break.\nShuts itself down when 100% is reached.\n\n\n\n\n\nAdds config option: plugin.database.gather_resident_uuids\n\ndefault: true\nWhen true Towny will use a background task to gather UUIDs for residents who do not have UUIDs.\n\n\n\n\n\nAdds real-time tracking of gathered UUID count (instead of only updating the count on startup.)\nNPC residents are given a UUID.\nCopy UUID for residents renamed by TownyDatabaseHandler.\nHandle /ta reload db|all properly when GatherResidentUUIDTask is running.\n\n\n\nRemove possible NotRegisteredException from town.removeOutlaw(resident).\nRemove possible NotRegisteredException from resident.removeFriend(resident).\n\n\nThis comment is up to date as of commit Part 16.\n\n I have tested this pull request for defects on a server.\n\n\nBy making this pull request, I represent that I have the right to waive copyright and related rights to my contribution, and agree that all copyright and related rights in my contributions are waived, and I acknowledge that the TownyAdvanced organization has the copyright to use and modify my contribution under the Towny License for perpetuity.", "createdAt": "2020-06-28T12:31:01Z", "url": "https://github.com/TownyAdvanced/Towny/pull/4119", "merged": true, "mergeCommit": {"oid": "d75743ad0d33e964dabf1d0ae811b78670d83c42"}, "closed": true, "closedAt": "2020-07-15T18:46:33Z", "author": {"login": "LlmDl"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvMjEIgH2gAyNDQxMDUwMDUxOmRmNDliMzcyNWRiNjYyOWJiMTMzYjBmNTUyZmNjOTdkZWMwYzBhZGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1PHWEAH2gAyNDQxMDUwMDUxOmI0NTRkOWJmNTAxYjY1OWEwODc4ZWU4YTM5MzhjMGI4NTM0MzJhMWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "df49b3725db6629bb133b0f552fcc97dec0c0adc", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/df49b3725db6629bb133b0f552fcc97dec0c0adc", "committedDate": "2020-06-27T00:17:41Z", "message": "Resident saving/loading clean up.\n\n- Removes residents.txt files.\n- Loads residents who do exist in the residents.txt file, deleting\norphaned files that weren't being read anyways.\n- Removes storing the town a resident belongs to in the residentname.txt\nfile.\n- Drops the town column from the resident table.\n- Adds methods to BukkitTools that should return UUIDs only when they\nare actually stored in the server cache, not pinging mojang.\n- TODO:\n  - Test offline player getting.\n  - Remove commented out code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71a2b54b2d31b3f8da08db356929078a37424c06", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/71a2b54b2d31b3f8da08db356929078a37424c06", "committedDate": "2020-06-27T15:14:39Z", "message": "Resident saving/loading clean up. Part 2.\n\n- Removed removeResidentList(resident) and consolidate it into\nremoveResident(resident).\n- Remove possible NotRegisteredException from\ntown.removeOutlaw(resident).\n- Remove old code which was commented out.\n\n- TODO:\n  - Test offline player getting."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f802d8304726e9a800844e3bf96a4d42c4056007", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/f802d8304726e9a800844e3bf96a4d42c4056007", "committedDate": "2020-06-27T16:25:37Z", "message": "Resident saving/loading clean up. Part 3.\n\n- Remove possible NotRegisteredException from\nresident.removeFriend(resident).\n- Tested offline player getting.\n  - Works well but doesn't get UUIDs for players who have since changed\ntheir name. May be pinging Mojang servers.\n\n- TODO:\n  - Figure out if we're pinging mojang or the playerdata.\n  - Find solution for offline-player-getting for players who have since\nchanged their name."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a050a6e2e454030a67df9bd313cfccbaec8381f0", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/a050a6e2e454030a67df9bd313cfccbaec8381f0", "committedDate": "2020-06-27T22:45:26Z", "message": "Resident saving/loading clean up. Part 4.\n\n- Adds BukkitTools.getUUIDFromResident(Resident resident) method to\nresolve the UUID of a resident, using their name and their lastLogin\ntimestamp.\n  - Temporarily being done to all residents without a UUID when\nresidents are loaded, for testing purposes only.\n  - In testing this has shown to solve the one resident who would not\nconvert from just using the BukkitTools.getUUIDSafely(String name)\nmethod.\n\n- TODO:\n  - Remove auto-conversion from loading cycle.\n  - Add task to accomplish async UUID collection via a queue.\n  - Add variable to determine if a server is at 100% UUIDs gathered."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "664be01a7ad4df148f7033375b7f508779dd3799", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/664be01a7ad4df148f7033375b7f508779dd3799", "committedDate": "2020-06-28T02:48:02Z", "message": "Resident saving/loading clean up. Part 5.\n\n- Fix compile error.\n- Create GatherResidentUUIDTask.\n  - Queue is populated with non-UUID residents on database load.\n  - Begins 1 minute after Towny has successfully enabled if UUID\ngathering is not 100%.\n  - Runs every 20 seconds gathering a UUID.\n  - Shuts itself down when 100% is reached.\n  - Works good.\n- Adds real-time tracking of gathered UUID count.\n\n- TODO:\n  - Give NPC residents a UUID."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7034db00b5b9aa8190374c84f0ec88cd27315e7e", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/7034db00b5b9aa8190374c84f0ec88cd27315e7e", "committedDate": "2020-06-28T04:15:24Z", "message": "Resident saving/loading clean up. Part 6.\n\n- Fix reporting of UUID percentage.\n\n- TODO:\n  - Give NPC residents a UUID."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e12a2d37e1be785a654245f5d159d3de4b8d9e48", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/e12a2d37e1be785a654245f5d159d3de4b8d9e48", "committedDate": "2020-06-28T12:14:38Z", "message": "Resident saving/loading clean up. Part 7.\n\n- NPC residents are given a UUID.\n- Exit GatherResidentUUIDTask if the resident has gotten a UUID since\nbeing added to the queue.\n- Handle /ta reload db|all properly when GatherResidentUUIDTask is\nrunning.\n\n- TODO:"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d017a234895cf977f5dae86b1ce9fd3908b09301", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/d017a234895cf977f5dae86b1ce9fd3908b09301", "committedDate": "2020-06-28T12:30:30Z", "message": "Resident saving/loading clean up. Part 8.\n\n- Copy UUID for residents renamed by TownyDatabaseHandler.\n\n- TODO:"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a5019fc76276808a73f9527356b738b45f508e", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/d5a5019fc76276808a73f9527356b738b45f508e", "committedDate": "2020-06-28T12:32:51Z", "message": "Formatting fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54f4077b877ade30565261c5bb599fe9b8139f0d", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/54f4077b877ade30565261c5bb599fe9b8139f0d", "committedDate": "2020-06-28T16:25:34Z", "message": "Resident saving/loading clean up. Part 9.\n\n- Fix NPCs not getting assigned a UUID from the GatherTask.\n- Fix being unable to handle players who appear to have never had a\nMojang Account and return an HTTP Response Code 204.\n\n- TODO:\n  - Decide what to do with the above Un-resolvable residents."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff97096602bb3a21b31fd9916ebc5913bbdeca2b", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/ff97096602bb3a21b31fd9916ebc5913bbdeca2b", "committedDate": "2020-06-28T21:35:36Z", "message": "Resident saving/loading clean up. Part 10.\n\n- Fix exception.\n- Use TownyNameUpdater playermap as a fall back when Mojang cannot\ndeliver someones UUID any more, (solving Code 204 responses.)\n\n- TODO:"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52691a4b440c0b885adb1ec1c0744a3cd9f76837", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/52691a4b440c0b885adb1ec1c0744a3cd9f76837", "committedDate": "2020-06-29T14:00:38Z", "message": "Resident saving/loading clean up. Part 11.\n\n- Revert change to resident not storing town. Towns now no longer save\nresidents.\n- Towns no longer save the Resident list.\n- MySQL servers will drop the residents column from the Towns table.\n\n- TODO:\n  - Testing.\n  - Move code from Town object to Resident object when it deals with\nadding/removing Towns."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0458f75a2bbe5131d2e099dae85d112c7e93831", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/c0458f75a2bbe5131d2e099dae85d112c7e93831", "committedDate": "2020-06-30T18:11:25Z", "message": "Resident saving/loading clean up. Part 12.\n\n- Fix databases not loading.\n  - Achieved by moving loadResidents() in front of loadTowns().\n- Added config option:\n  - plugin.database.gather_resident_uuids\n  - default: true\n  - When true Towny will use a background task to gather UUIDs for\nresidents who do not have UUIDs.\n\n- TODO:\n  - More testing.\n  - Move code from Town object to Resident object when it deals with\nadding/removing Towns."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b381a3b3acb65a245806bdbe3ac8747000d04770", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/b381a3b3acb65a245806bdbe3ac8747000d04770", "committedDate": "2020-07-12T19:54:07Z", "message": "Resident saving/loading clean up. Part 13.\n\n- Removed TNUPlayerMapImporter\n  - The only time it would be called is when a player's call to the\nMojangAPI for UUID returned 204, which means they no longer have an MC\naccount.\n  - Instead of finding a UUID for them they are going to have their\nresident deleted from the DB.\n- Cleaned up TownyDatabaseHandler.removeTown(Town).\n  - No longer saving the nation as that is already being done.\n- Removed Town.clear().\n  - Was not being used in any real capacity, what it was doing was\nalready being done somewhere else.\n- Remove Town.removeAllResidents().\n  - Not being used.\n\n- TODO:\n  - Not much."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/b29562d54d254ceae34207580ba5ee0753e1a2e5", "committedDate": "2020-07-12T23:55:57Z", "message": "Resident saving/loading clean up. Part 14.\n\n- Replace all calls of Town.removeResident(Resident) with\nResident.removeTown().\n  - As Residents are now storing the Town it makes sense to do all of\nthat logic on the resident.\n  - Town.removeResident(Resident) is now used to fire the\nEmptyTownException and determine the town's new mayor.\n  - Removes all of the EmptyTownExceptions throughout the codebase,\nleaving just the one which is caught in Resident.RemoveTown().\n- TownRemoveResident and TownAddResident Events are now fired from the\nResident object instead of the Town object.\n- Removed Resident.clear()\n  - Now unused.\n\n- TODO:\n  - Testing.\n  - Possibly further removal of Resident-oriented code in the Town\nobject."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTM2NDcx", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#pullrequestreview-448536471", "createdAt": "2020-07-14T23:39:09Z", "commit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMzozOTowOVrOGxpCxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMzozOTowOVrOGxpCxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwNTg2Mw==", "bodyText": "This should be just townsblocks not new ArrayList<>(townBlocks)", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454705863", "createdAt": "2020-07-14T23:39:09Z", "author": null, "path": "src/com/palmergames/bukkit/towny/object/Resident.java", "diffHunk": "@@ -307,24 +310,69 @@ public Town getTown() throws NotRegisteredException {\n \n \tpublic void setTown(Town town) throws AlreadyRegisteredException {\n \n+\t\tif (this.town == town)\n+\t\t\treturn;\n+\n+\t\tTowny.getPlugin().deleteCache(this.getName());\n+\t\tsetTitle(\"\");\n+\t\tsetSurname(\"\");\n+\t\tupdatePerms();\n+\t\t\n+\n \t\tif (town == null) {\n \t\t\tthis.town = null;\n-\t\t\tsetTitle(\"\");\n-\t\t\tsetSurname(\"\");\n-\t\t\tupdatePerms();\n \t\t\treturn;\n \t\t}\n \n-\t\tif (this.town == town)\n-\t\t\treturn;\n-\n \t\tif (hasTown())\n \t\t\tthrow new AlreadyRegisteredException();\n \n \t\tthis.town = town;\n-\t\tsetTitle(\"\");\n-\t\tsetSurname(\"\");\n-\t\tupdatePerms();\n+\t\ttown.addResident(this);\n+\t\tBukkitTools.getPluginManager().callEvent(new TownAddResidentEvent(this, town));\n+\t}\n+\t\n+\tpublic void removeTown() {\n+\t\t\n+\t\tif (!hasTown())\n+\t\t\treturn;\n+\n+\t\tTown town = this.town;\n+\t\t\n+\t\tBukkitTools.getPluginManager().callEvent(new TownRemoveResidentEvent(this, town));\n+\t\ttry {\n+\t\t\t\n+\t\t\ttown.removeResident(this);\n+\t\t\t\n+\t\t} catch (NotRegisteredException e1) {\n+\t\t\te1.printStackTrace();\n+\t\t} catch (EmptyTownException e1) {\n+\t\t\tTownyUniverse.getInstance().getDataSource().removeTown(town);\n+\t\t}\n+\t\t\n+\t\tfor (TownBlock townBlock : new ArrayList<>(townBlocks)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "584e38608b97fe64bfbcf209ee3e2fccd037168b", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/584e38608b97fe64bfbcf209ee3e2fccd037168b", "committedDate": "2020-07-15T00:47:52Z", "message": "Use iterator to prevent concurrent modifications."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b47f03fb6aefaa93cc6ea5396bbb71acc9ebab7d", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/b47f03fb6aefaa93cc6ea5396bbb71acc9ebab7d", "committedDate": "2020-07-15T00:51:55Z", "message": "Remove unused import."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6731793f0c05a4e3cbaf81e858fae6c1705f66b0", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/6731793f0c05a4e3cbaf81e858fae6c1705f66b0", "committedDate": "2020-07-15T00:56:00Z", "message": "Merge branch 'master' into resident_txt_removal\n\n# Conflicts:\n#\tsrc/com/palmergames/bukkit/towny/command/TownyAdminCommand.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTYzMjcw", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#pullrequestreview-448563270", "createdAt": "2020-07-15T01:07:29Z", "commit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMTowNzoyOVrOGxqjkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMTowNzoyOVrOGxqjkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczMDY0Mg==", "bodyText": "Were you having ConcurrentModicationExpection's here as well? If not this should be just universe.getResidentMap.values()", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454730642", "createdAt": "2020-07-15T01:07:29Z", "author": null, "path": "src/com/palmergames/bukkit/towny/db/TownyDatabaseHandler.java", "diffHunk": "@@ -291,6 +290,27 @@ public TownyWorld getTownWorld(String townName) {\n \t@Override\n \tpublic void removeResident(Resident resident) {\n \n+\t\t// Remove resident from towns' outlawlists.\n+\t\tfor (Town townOutlaw : getTowns()) {\n+\t\t\tif (townOutlaw.hasOutlaw(resident)) {\n+\t\t\t\ttownOutlaw.removeOutlaw(resident);\n+\t\t\t\tsaveTown(townOutlaw);\n+\t\t\t}\n+\t\t}\n+\n+\t\t// Remove resident from residents' friendslists.\n+\t\tList<Resident> toSave = new ArrayList<>();\n+\t\tfor (Resident toCheck : new ArrayList<>(universe.getResidentMap().values())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTY2NDYz", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#pullrequestreview-448566463", "createdAt": "2020-07-15T01:18:04Z", "commit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMToxODowNFrOGxqvhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMToxODowNFrOGxqvhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczMzcwMw==", "bodyText": "Although this isn't part of the diff, I still have the same comment as the others, why a new arraylist if that arraylist already exists?", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454733703", "createdAt": "2020-07-15T01:18:04Z", "author": null, "path": "src/com/palmergames/bukkit/towny/db/TownyDatabaseHandler.java", "diffHunk": "@@ -1053,12 +1010,8 @@ public void renamePlayer(Resident resident, String newName) throws AlreadyRegist\n \t\t\tList<Resident> toSaveResident = new ArrayList<>(getResidents());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "originalPosition": 201}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTY2OTk5", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#pullrequestreview-448566999", "createdAt": "2020-07-15T01:19:57Z", "commit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMToxOTo1N1rOGxqxcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMToxOTo1N1rOGxqxcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNDE5Mg==", "bodyText": "same thing as above", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454734192", "createdAt": "2020-07-15T01:19:57Z", "author": null, "path": "src/com/palmergames/bukkit/towny/db/TownyDatabaseHandler.java", "diffHunk": "@@ -1067,12 +1020,8 @@ public void renamePlayer(Resident resident, String newName) throws AlreadyRegist\n \t\t\tList<Town> toSaveTown = new ArrayList<>(getTowns());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "originalPosition": 216}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTY3ODE1", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#pullrequestreview-448567815", "createdAt": "2020-07-15T01:22:48Z", "commit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMToyMjo0OFrOGxq0Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMToyMjo0OFrOGxq0Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNDkzMA==", "bodyText": "Add a FileNameFilter for the file listings, we should only be picking up \".txt\" files, not just every file in the directory. See https://stackoverflow.com/questions/37900798/filenamefilter-to-show-list-files-with-certain-extension-and-directories for an example.", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454734930", "createdAt": "2020-07-15T01:22:48Z", "author": null, "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -349,28 +346,46 @@ public boolean loadResidentList() {\n \t\t\n \t\tTownyMessaging.sendDebugMsg(\"Loading Resident List\");\n \t\tString line = null;\n+\t\tList residents = new ArrayList<String>();\n \n+\t\t// Build up a list of residents from any existing legacy residents.txt files.\n \t\ttry (BufferedReader fin = new BufferedReader(new InputStreamReader(new FileInputStream(dataFolderPath + File.separator + \"residents.txt\"), StandardCharsets.UTF_8))) {\n \t\t\t\n-\t\t\twhile ((line = fin.readLine()) != null) {\n-\t\t\t\tif (!line.equals(\"\")) {\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tnewResident(line);\n-\t\t\t\t\t} catch (AlreadyRegisteredException e) {\n-\t\t\t\t\t\tTownyMessaging.sendDebugMsg(\"Duplicate resident '\" + line + \"' found in residents.txt, ignoring.\");\n-\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t}\n-\t\t\t\t}\n+\t\t\twhile ((line = fin.readLine()) != null && !line.equals(\"\"))\n+\t\t\t\tresidents.add(line);\n+\t\t} catch (Exception ignored) {\n+\t\t\t// No residents.txt any more.\n+\t\t}\n+\t\tFile residentFolder = new File(dataFolderPath + File.separator + \"residents\");\n+\t\tFile[] residentFiles = residentFolder.listFiles();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTY4OTM1", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#pullrequestreview-448568935", "createdAt": "2020-07-15T01:26:48Z", "commit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMToyNjo0OFrOGxq4YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMToyNjo0OFrOGxq4YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNTk2OA==", "bodyText": "This can be removed by applying the above fix", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r454735968", "createdAt": "2020-07-15T01:26:48Z", "author": null, "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -349,28 +346,46 @@ public boolean loadResidentList() {\n \t\t\n \t\tTownyMessaging.sendDebugMsg(\"Loading Resident List\");\n \t\tString line = null;\n+\t\tList residents = new ArrayList<String>();\n \n+\t\t// Build up a list of residents from any existing legacy residents.txt files.\n \t\ttry (BufferedReader fin = new BufferedReader(new InputStreamReader(new FileInputStream(dataFolderPath + File.separator + \"residents.txt\"), StandardCharsets.UTF_8))) {\n \t\t\t\n-\t\t\twhile ((line = fin.readLine()) != null) {\n-\t\t\t\tif (!line.equals(\"\")) {\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tnewResident(line);\n-\t\t\t\t\t} catch (AlreadyRegisteredException e) {\n-\t\t\t\t\t\tTownyMessaging.sendDebugMsg(\"Duplicate resident '\" + line + \"' found in residents.txt, ignoring.\");\n-\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t}\n-\t\t\t\t}\n+\t\t\twhile ((line = fin.readLine()) != null && !line.equals(\"\"))\n+\t\t\t\tresidents.add(line);\n+\t\t} catch (Exception ignored) {\n+\t\t\t// No residents.txt any more.\n+\t\t}\n+\t\tFile residentFolder = new File(dataFolderPath + File.separator + \"residents\");\n+\t\tFile[] residentFiles = residentFolder.listFiles();\n+\t\tfor (File resident : residentFiles) {\n+\t\t\t// Don't load resident files if they weren't in the residents.txt file.\n+\t\t\tString name = resident.getName().replace(\".txt\", \"\");\n+\t\t\tif (residents.size() > 0 && !residents.contains(name)) {\n+\t\t\t\tTownyMessaging.sendDebugMsg(\"Removing \" + resident.getName() + \" because they are not found in the residents.txt.\");\n+\t\t\t\tdeleteFile(resident.getAbsolutePath());\n+\t\t\t\tcontinue;\n \t\t\t}\n-\n-\t\t\treturn true;\n-\t\t\t\n-\t\t} catch (Exception e) {\n-\t\t\tTownyMessaging.sendErrorMsg(\"Error Loading Resident List at \" + line + \", in towny\\\\data\\\\residents.txt\");\n-\t\t\te.printStackTrace();\n-\t\t\treturn false;\n \t\t\t\n+\t\t\tif (!resident.getName().endsWith(\".txt\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b29562d54d254ceae34207580ba5ee0753e1a2e5"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdd4ac49e5950013ac928c997b164e5545ab2644", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/fdd4ac49e5950013ac928c997b164e5545ab2644", "committedDate": "2020-07-15T01:46:50Z", "message": "Fix removeAllFriends()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a440ac928f3a0ac01522a1210e2370039a7ef8d7", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/a440ac928f3a0ac01522a1210e2370039a7ef8d7", "committedDate": "2020-07-15T01:53:05Z", "message": "Fix useless array copies."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f19e2ed375d7a70a6ca77031655131bf4a19a91f", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/f19e2ed375d7a70a6ca77031655131bf4a19a91f", "committedDate": "2020-07-15T13:30:05Z", "message": "Revert \"Fix useless array copies.\"\n\nThis reverts commit a440ac928f3a0ac01522a1210e2370039a7ef8d7."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f893d3430bdd792fbc0cb5231e54db4c2addec1", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/5f893d3430bdd792fbc0cb5231e54db4c2addec1", "committedDate": "2020-07-15T17:42:58Z", "message": "Resident saving/loading clean up. Part 15.\n\n- Remove unneeded ArrayList.\n- Use FileFilter.\n\n- TODO:\n  - Nothing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MTk5MDY2", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#pullrequestreview-449199066", "createdAt": "2020-07-15T17:56:20Z", "commit": {"oid": "5f893d3430bdd792fbc0cb5231e54db4c2addec1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1NjoyMFrOGyJcHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNzo1NjoyMFrOGyJcHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzNjYzOQ==", "bodyText": "This can be condensed into a lambda:\nFile[] residentFiles = residentFolder.listFiles((file) -> file.getName.toLowerCase().endsWith(\".txt\");", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r455236639", "createdAt": "2020-07-15T17:56:20Z", "author": null, "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -349,28 +347,48 @@ public boolean loadResidentList() {\n \t\t\n \t\tTownyMessaging.sendDebugMsg(\"Loading Resident List\");\n \t\tString line = null;\n+\t\tList residents = new ArrayList<String>();\n \n+\t\t// Build up a list of residents from any existing legacy residents.txt files.\n \t\ttry (BufferedReader fin = new BufferedReader(new InputStreamReader(new FileInputStream(dataFolderPath + File.separator + \"residents.txt\"), StandardCharsets.UTF_8))) {\n \t\t\t\n-\t\t\twhile ((line = fin.readLine()) != null) {\n-\t\t\t\tif (!line.equals(\"\")) {\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tnewResident(line);\n-\t\t\t\t\t} catch (AlreadyRegisteredException e) {\n-\t\t\t\t\t\tTownyMessaging.sendDebugMsg(\"Duplicate resident '\" + line + \"' found in residents.txt, ignoring.\");\n-\t\t\t\t\t\tcontinue;\n-\t\t\t\t\t}\n-\t\t\t\t}\n+\t\t\twhile ((line = fin.readLine()) != null && !line.equals(\"\"))\n+\t\t\t\tresidents.add(line);\n+\t\t} catch (Exception ignored) {\n+\t\t\t// No residents.txt any more.\n+\t\t}\n+\t\tFile residentFolder = new File(dataFolderPath + File.separator + \"residents\");\n+\t\tFile[] residentFiles = residentFolder.listFiles(new FileFilter() {\n+\t\t\t@Override\n+\t\t\tpublic boolean accept(File residentFolder) {\n+\t\t\t\treturn residentFolder.getName().toLowerCase().endsWith(\".txt\"); \n+\t\t\t}\n+\t\t});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f893d3430bdd792fbc0cb5231e54db4c2addec1"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be75324f0470ff1e3d1b02f3fc2bf24e49f20f46", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/be75324f0470ff1e3d1b02f3fc2bf24e49f20f46", "committedDate": "2020-07-15T18:27:59Z", "message": "Resident saving/loading clean up. Part 16.\n\n- Switch to a lambda in loadResidentList().\n\n- TODO:\n  - Nothing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjIzMTE2", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#pullrequestreview-449223116", "createdAt": "2020-07-15T18:28:11Z", "commit": {"oid": "5f893d3430bdd792fbc0cb5231e54db4c2addec1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoyODoxMVrOGyKp1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoyODoxMVrOGyKp1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NjUzNQ==", "bodyText": "Setting this to null is redundant, String line; has the exact same effect.", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r455256535", "createdAt": "2020-07-15T18:28:11Z", "author": null, "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -349,28 +347,48 @@ public boolean loadResidentList() {\n \t\t\n \t\tTownyMessaging.sendDebugMsg(\"Loading Resident List\");\n \t\tString line = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f893d3430bdd792fbc0cb5231e54db4c2addec1"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjIzMTMx", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#pullrequestreview-449223131", "createdAt": "2020-07-15T18:28:12Z", "commit": {"oid": "5f893d3430bdd792fbc0cb5231e54db4c2addec1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoyODoxMlrOGyKp4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODoyODoxMlrOGyKp4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NjU0NA==", "bodyText": "You're using the raw type of List, you should be using the parameterized type:\nList<String> residents = new ArrayList<>();", "url": "https://github.com/TownyAdvanced/Towny/pull/4119#discussion_r455256544", "createdAt": "2020-07-15T18:28:12Z", "author": null, "path": "src/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java", "diffHunk": "@@ -349,28 +347,48 @@ public boolean loadResidentList() {\n \t\t\n \t\tTownyMessaging.sendDebugMsg(\"Loading Resident List\");\n \t\tString line = null;\n+\t\tList residents = new ArrayList<String>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f893d3430bdd792fbc0cb5231e54db4c2addec1"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b454d9bf501b659a0878ee8a3938c0b853432a1a", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/b454d9bf501b659a0878ee8a3938c0b853432a1a", "committedDate": "2020-07-15T18:40:40Z", "message": "Not use raw type List."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3217, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}