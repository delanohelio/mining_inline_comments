{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NDY4OTc2", "number": 4136, "title": "Add Asynchronous Backup To Speed up Load Times", "bodyText": "Description:\n\nEvery time Towny loads its database it performs a full backup of the database. This operation is quite slow and in some cases may be slower than the actual loading of the database. Since Towny doesn't explicitly depend on this operation before other operations, it has been made async. This speeds up the loading time for Towny dramatically, by making the backup operations occur in the background.\nIf you look at this excerpt of a startup log you can see that Successfully cleaned backups. and\nTowny Database Successfully backed up both occur after towny has loaded because it was put in a background thread and it did its business without holding up any other operations.\n[18:20:30 INFO]: ====================      Towny      ========================\n[18:20:30 INFO]: [Towny] Database: [Load] flatfile [Save] flatfile\n[18:20:30 INFO]: [Towny] 1/1335 residents have stored UUIDs.\n[18:20:31 INFO]: [Towny] Database loaded in 1128ms.\n[18:20:31 INFO]: [Towny] Using: BukkitPermissions, TheNewEconomy via Vault\n[18:20:31 INFO]: [Towny] Time until a New Day: 17 hours, 39 minutes, 29 seconds\n[18:20:31 INFO]: =============================================================\n[18:20:31 INFO]: [Towny] Version: 0.96.2.2 - Mod Enabled\n[18:20:31 INFO]: =============================================================\n...\n[18:20:32 INFO]: [Vault] Checking for Updates ...\n[18:20:33 INFO]: [Vault] No new version available\n[18:20:35 INFO]: [Towny] Successfully cleaned backups.\n[18:20:37 INFO]: [Towny] Towny Database Successfully backed up.\n\n\n\n I have tested this pull request for defects on a server.\n\n\nBy making this pull request, I represent that I have the right to waive copyright and related rights to my contribution, and agree that all copyright and related rights in my contributions are waived, and I acknowledge that the TownyAdvanced organization has the copyright to use and modify my contribution under the Towny License for perpetuity.", "createdAt": "2020-07-05T22:28:48Z", "url": "https://github.com/TownyAdvanced/Towny/pull/4136", "merged": true, "mergeCommit": {"oid": "eb1b615e48badf8ce168b981e9fbc04276c53300"}, "closed": true, "closedAt": "2020-07-07T12:24:19Z", "author": null, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyEMtiAH2gAyNDQ0NDY4OTc2OmM4OTc5MjljMTE1N2MwMWY2Zjg4ODk4NTM4N2IwZDEwNWVhNTc5OTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyYkUMgFqTQ0MzQzNDI5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c897929c1157c01f6f888985387b0d105ea57999", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/c897929c1157c01f6f888985387b0d105ea57999", "committedDate": "2020-07-05T22:15:48Z", "message": "Add async clean backups and backups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7993eb332b9a77fefb2f405d7bbb78227688c6b6", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/7993eb332b9a77fefb2f405d7bbb78227688c6b6", "committedDate": "2020-07-05T22:22:27Z", "message": "Merge branch 'master' into feature/async-backup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "053afe10710bc55ed47957c3c1deb1f3dfda52a8", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/053afe10710bc55ed47957c3c1deb1f3dfda52a8", "committedDate": "2020-07-06T00:55:07Z", "message": "thenRunAsync not thenRun"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a647c02c21023c37ed3ef4a4edad2d44581b1577", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/a647c02c21023c37ed3ef4a4edad2d44581b1577", "committedDate": "2020-07-06T01:05:13Z", "message": "make backup command run async."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMzM5ODQz", "url": "https://github.com/TownyAdvanced/Towny/pull/4136#pullrequestreview-443339843", "createdAt": "2020-07-06T19:10:14Z", "commit": {"oid": "a647c02c21023c37ed3ef4a4edad2d44581b1577"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOToxMDoxNFrOGtj0gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxOToxMTo1NVrOGtj3-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyNTk4Nw==", "bodyText": "this should be .cleanBackups() no?", "url": "https://github.com/TownyAdvanced/Towny/pull/4136#discussion_r450425987", "createdAt": "2020-07-06T19:10:14Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/tasks/CleanupBackupTask.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package com.palmergames.bukkit.towny.tasks;\n+\n+import com.palmergames.bukkit.towny.Towny;\n+import com.palmergames.bukkit.towny.TownyMessaging;\n+import com.palmergames.bukkit.towny.TownyUniverse;\n+\n+import java.io.IOException;\n+\n+public class CleanupBackupTask implements Runnable {\n+\n+\t@Override\n+\tpublic void run() {\n+\t\ttry {\n+\t\t\tTownyUniverse.getInstance().getDataSource().backup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a647c02c21023c37ed3ef4a4edad2d44581b1577"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyNjQ4Mg==", "bodyText": "spacing is a bit off here.", "url": "https://github.com/TownyAdvanced/Towny/pull/4136#discussion_r450426482", "createdAt": "2020-07-06T19:11:10Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/TownyUniverse.java", "diffHunk": "@@ -62,8 +67,10 @@\n     private TownyDataSource dataSource;\n     private TownyPermissionSource permissionSource;\n     private War warEvent;\n-    \n-    private TownyUniverse() {\n+\tprivate String saveDbType;\n+\tprivate String loadDbType;\n+\n+\tprivate TownyUniverse() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a647c02c21023c37ed3ef4a4edad2d44581b1577"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyNjg3Mg==", "bodyText": "spacing is also out here too I think.", "url": "https://github.com/TownyAdvanced/Towny/pull/4136#discussion_r450426872", "createdAt": "2020-07-06T19:11:55Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/TownyUniverse.java", "diffHunk": "@@ -121,19 +127,12 @@ boolean loadSettings() {\n                 }\n             }\n             FileMgmt.checkOrCreateFolder(rootFolder + File.separator + \"logs\"); // Setup the logs folder here as the logger will not yet be enabled.\n-            try {\n-                dataSource.backup();\n-                \n-                if (loadDbType.equalsIgnoreCase(\"flatfile\") || saveDbType.equalsIgnoreCase(\"flatfile\")) {\n-                    dataSource.deleteUnusedResidents();\n-                }\n-                \n-            } catch (IOException e) {\n-                System.out.println(\"[Towny] Error: Could not create backup.\");\n-                e.printStackTrace();\n-                return false;\n-            }\n-            \n+\t\t\t\n+\t\t\t// Run both the backup cleanup and backup async.\n+\t\t\tCompletableFuture\n+\t\t\t\t.runAsync(new CleanupBackupTask())\n+\t\t\t\t.thenRunAsync(new BackupTask());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a647c02c21023c37ed3ef4a4edad2d44581b1577"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ab51055aa41e251e6c4891892f1b7b64886dc06", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/8ab51055aa41e251e6c4891892f1b7b64886dc06", "committedDate": "2020-07-06T20:42:17Z", "message": "fix formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDM0Mjk3", "url": "https://github.com/TownyAdvanced/Towny/pull/4136#pullrequestreview-443434297", "createdAt": "2020-07-06T21:59:41Z", "commit": {"oid": "8ab51055aa41e251e6c4891892f1b7b64886dc06"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3221, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}