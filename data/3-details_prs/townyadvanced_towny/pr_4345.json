{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MjcyOTA5", "number": 4345, "title": "Dragon Fireball Damage handling.", "bodyText": "Description:\n\n\nPotential solution for #4100.\nNot ideal.\nSo far I have not found a way to handle Dragon Fireballs better.\nThey fire a ProjectileHitEvent which cannot be cancelled.\nThey generate an AreaEffectCloud which only returns the type\nUNCRAFTABLE.\nThe only way so far is to listen for the AreaEffectCloudApplyEvent\nand if it is UNCRAFTABLE, check the hurt entities one by one using the\nCombatUtil.\nAs this is technically a mob damage, it shouldn't really be\nconsidered PVP (arrows fired by a skeleton from outside of town still\nhurts players with PVP off.)\nSome people are using slimefun to have dragon pets that end up\nshooting these fireballs...\n\n\nNew Nodes/Commands/ConfigOptions:\n\n\nRelevant Towny Issue ticket:\n\n#4100\n\n\n I have tested this pull request for defects on a server.\n\n\nBy making this pull request, I represent that I have the right to waive copyright and related rights to my contribution, and agree that all copyright and related rights in my contributions are waived, and I acknowledge that the TownyAdvanced organization has the copyright to use and modify my contribution under the Towny License for perpetuity.", "createdAt": "2020-09-28T16:44:58Z", "url": "https://github.com/TownyAdvanced/Towny/pull/4345", "merged": true, "mergeCommit": {"oid": "e088bb7fe74f4c1e9ff8494ad15adb287f305891"}, "closed": true, "closedAt": "2020-11-21T12:15:08Z", "author": {"login": "LlmDl"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNW3GogFqTQ5NzczOTU1NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeq5UZgH2gAyNDk0MjcyOTA5OjJhNzU2NTg3MTgxMjk1Y2M2ZDNkMGQ0MGU0ZTIxYmQ2MzIzNTU5ODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzM5NTU1", "url": "https://github.com/TownyAdvanced/Towny/pull/4345#pullrequestreview-497739555", "createdAt": "2020-09-28T17:16:20Z", "commit": {"oid": "b6942303fa1c2ef69d023fa57d7465ac4d4d0491"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzoxNjoyMFrOHZILPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzoxNjoyMFrOHZILPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMDM5Nw==", "bodyText": "I would cancel and do event.getEntity().remove() this way the same checks aren't being done every 5 ticks.", "url": "https://github.com/TownyAdvanced/Towny/pull/4345#discussion_r496110397", "createdAt": "2020-09-28T17:16:20Z", "author": {"login": "creatorfromhell"}, "path": "src/com/palmergames/bukkit/towny/listeners/TownyEntityListener.java", "diffHunk": "@@ -375,6 +378,39 @@ public void onEntityDamageByEntityEvent(EntityDamageByEntityEvent event) {\n \t\t\t\r\n \t}\r\n \r\n+\t/**\r\n+\t * Handles dragon fireball's cloud damage to players.\r\n+\t * \r\n+\t * @param event AreaEffectCloudApplyEvent\r\n+\t */\r\n+\t@EventHandler(priority = EventPriority.HIGH, ignoreCancelled = true)\r\n+\tpublic void onDragonFireBallCloudDamage(AreaEffectCloudApplyEvent event) {\r\n+\t\tif (!TownyAPI.getInstance().isTownyWorld(event.getEntity().getWorld()))\r\n+\t\t\treturn;\r\n+\t\t\r\n+\t\tif (!event.getEntity().getBasePotionData().getType().equals(PotionType.UNCRAFTABLE))\r\n+\t\t\treturn;\r\n+\r\n+\t\tif (!(event.getEntity().getSource() instanceof Player) || !(event.getEntity().getSource() instanceof DragonFireball))\r\n+\t\t\treturn;\r\n+\r\n+\t\tList<LivingEntity> entities = event.getAffectedEntities();\r\n+\r\n+\t\tTownyWorld townyWorld = null;\r\n+\t\ttry {\r\n+\t\t\ttownyWorld = TownyUniverse.getInstance().getDataSource().getWorld(event.getEntity().getWorld().getName());\r\n+\t\t} catch (NotRegisteredException e) {\r\n+\t\t\t// Failed to fetch a world\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\t\r\n+\t\tfor (LivingEntity entity : entities) {\r\n+\t\t\tTownBlock townBlock = TownyAPI.getInstance().getTownBlock(entity.getLocation());\r\n+\t\t\tif (CombatUtil.preventPvP(townyWorld, townBlock)) {\r\n+\t\t\t\tevent.setCancelled(true);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6942303fa1c2ef69d023fa57d7465ac4d4d0491"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6cdbec3355ace2f4d345202636a0ba64df66e27", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/e6cdbec3355ace2f4d345202636a0ba64df66e27", "committedDate": "2020-11-21T12:12:03Z", "message": "Dragon Fireball Damage handling.\n\n - Potential solution for #4100.\n - Not ideal.\n - So far I have not found a way to handle Dragon Fireballs better.\n - They fire a ProjectileHitEvent which cannot be cancelled.\n - They generate an AreaEffectCloud which only returns the type\nUNCRAFTABLE.\n - The only way so far is to listen for the AreaEffectCloudApplyEvent\nand if it is UNCRAFTABLE, check the hurt entities one by one using the\nCombatUtil.\n - As this is technically a mob damage, it shouldn't really be\nconsidered PVP (arrows fired by a skeleton from outside of town still\nhurts players with PVP off.)\n - Some people are using slimefun to have dragon pets that end up\nshooting these fireballs..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8296b64daa11921351509d620b724209a9dfc2f7", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/8296b64daa11921351509d620b724209a9dfc2f7", "committedDate": "2020-11-21T12:12:03Z", "message": "Revise check to just remove the AreaEffectCloud when it has spawned in a\nPVP-off area."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cca3cb78780aa271cd21898c281c18292d54fcb", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/7cca3cb78780aa271cd21898c281c18292d54fcb", "committedDate": "2020-11-21T12:12:03Z", "message": "creatorfromhell's annual contribution."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d090c0306d84dcc23f608de91877c6af44b47441", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/d090c0306d84dcc23f608de91877c6af44b47441", "committedDate": "2020-09-28T21:15:35Z", "message": "creatorfromhell's annual contribution."}, "afterCommit": {"oid": "7cca3cb78780aa271cd21898c281c18292d54fcb", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/7cca3cb78780aa271cd21898c281c18292d54fcb", "committedDate": "2020-11-21T12:12:03Z", "message": "creatorfromhell's annual contribution."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a756587181295cc6d3d0d40e4e21bd632355982", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/2a756587181295cc6d3d0d40e4e21bd632355982", "committedDate": "2020-11-21T12:13:35Z", "message": "- Remove unused import."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4195, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}