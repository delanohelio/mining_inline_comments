{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNjEyMzUz", "number": 3892, "title": "Confirmation System Refactor/Overhaul", "bodyText": "Description:\n\nThis PR aims to overhaul the existing confirmation system. To illustrate the significance of this PR I'll go over how confirmations are currently handled.\nCurrent Way of Adding Confirmations\n\nYou need to add a Type to the ConfirmationType enum:\n\npublic enum ConfirmationType {\n\tTOWN_DELETE,\n\tNATION_DELETE,\n\t...\n\tGROUP_TOGGLE_ACTION,\n        MY_NEW_TYPE // Added type\n}\n\nOnce the type is added you need to define how its added in ConfirmationHandler:\n\npublic static void addConfirmation(final Resident r, final ConfirmationType type, Object extra) throws TownyException {\n\t// We use \"extra\" in certain instances like the number of days for something e.t.c\n\tswitch (type) {\n\t\tcase TOWN_DELETE:\n\t\t\t\t...\n\t\tcase NATION_DELETE:\n\t\t\t\t...\n\t\tcase GROUP_TOGGLE_ACTION:\n\t\t\t\t...\n                  case MY_NEW_TYPE: // Added here\n                        r.setConfirmationType(type);\n\t\t\tgrouptoggleconfirmations.put(r, extra);\n\n\t\t\tnew BukkitRunnable() {\n\t\t\t\t@Override\n\t\t\t\tpublic void run() {\n\t\t\t\t\tremoveConfirmation(r, type, false);\n\t\t\t\t}\n\t\t\t}.runTaskLater(plugin, 400);\n\t\t\tbreak;\n\t\t}\n\t}\n...\n\nNow you need to define how this confirmation is handled in the same file:\n\npublic static void handleConfirmation(Resident r, ConfirmationType type) throws TownyException {\n\tif (type == ConfirmationType.MY_NEW_TYPE) {\n\t\t\t       ...\n\t\t\t}\n\t\t}\n\t}\n}\n4.) Now you need to define the way it's cancelled\npublic static void removeConfirmation(Resident r, ConfirmationType type, boolean successful) {\n\tswitch (type) {\n\t\tcase MY_NEW_TYPE:\n\t\t      ...\n        ...\n        }\n}\n\nFinally, you need to add the object in the appropriate area in the code:\n\nResident resident = new Resident(\"Bob\");\nObject extra = new Object();\nConfirmationHandler.addConfirmation(resident, ConfirmationType.MY_NEW_TYPE, extra);\nAs you can see this process is extremely monotonous. Now let's see how the new code works\nNew Way of Adding Confirmations\n\nCreate Confirmation object:\n\nConfirmation confirmation = new Confirmation(()-> System.out.println(\"I was confirmed!\"));\n\nSend confirmation:\n\nConfirmationHandler.sendConfirmation(player, confirmation);\nIn addition, the confirmation message text will be sent by calling sendConfirmation(), you can define the message title by using Confirmation.setTitle().\nThat's it, much less work than the first steps.\nNow because the static ConfirmationType enum is gone, plugin developers can define and call their own confirmations. Also since the confirmations are keyed by CommandSender you don't have to worry about differences between players and the console.\nIn other statistics, because of the reduction of code needed for confirmations, the codebase actually shrinks with this PR. The codebase will trim over 300 lines of code! (nice)\n\n\n I have tested this pull request for defects on a server.\n\n\nBy making this pull request, I represent that I have the right to waive copyright and related rights to my contribution, and agree that all copyright and related rights in my contributions are waived, and I acknowledge that the TownyAdvanced organization has the copyright to use and modify my contribution under the Towny License for perpetuity.", "createdAt": "2020-04-08T03:46:50Z", "url": "https://github.com/TownyAdvanced/Towny/pull/3892", "merged": true, "mergeCommit": {"oid": "ffc0e326b477dc8bb7fe08e0f25ad596fa85a7fd"}, "closed": true, "closedAt": "2020-04-10T13:21:11Z", "author": null, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVbEH9AH2gAyNDAwNjEyMzUzOjYxYmUyYmIwMTBlMWEwYTc5MTNmY2UyMWY4MDk0YzI1ZmU2MGZiYjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWQ_yNAFqTM5MTQzODA1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "61be2bb010e1a0a7913fce21f8094c25fe60fbb2", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/61be2bb010e1a0a7913fce21f8094c25fe60fbb2", "committedDate": "2020-04-07T22:30:26Z", "message": "Implement new confirmation system, needs work on console."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c31eb6b7928379843cf82eabf7c9e11eb55a2434", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/c31eb6b7928379843cf82eabf7c9e11eb55a2434", "committedDate": "2020-04-08T03:18:50Z", "message": "Generify confirmation holders and finish implementation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjQ2NjYz", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#pullrequestreview-389646663", "createdAt": "2020-04-08T04:37:11Z", "commit": {"oid": "c31eb6b7928379843cf82eabf7c9e11eb55a2434"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNDozNzoxMVrOGCessw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNDozNzoxMVrOGCessw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI1MzI5OQ==", "bodyText": "Why an atomic reference?", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405253299", "createdAt": "2020-04-08T04:37:11Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "diffHunk": "@@ -1592,18 +1603,62 @@ public void purge(String[] split) {\n \t\t\t} catch (TownyException e) {\r\n \t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n \t\t\t}\r\n-\t\t\t\r\n-\t\t\tif (resident != null) {\r\n-\t\t\t\ttry {\r\n-\t\t\t\t\tConfirmationHandler.addConfirmation(resident, ConfirmationType.PURGE, days); // It takes the senders town & nation, an admin deleting another town has no confirmation.\r\n-\t\t\t\t\tTownyMessaging.sendConfirmationMessage(player, null, null, null, null);\r\n \r\n-\t\t\t\t} catch (TownyException e) {\r\n-\t\t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n+\t\t\tResident finalResident = resident;\r\n+\t\t\tString finalDays = days[0];\r\n+\t\t\tTownyUniverse townyUniverse = TownyUniverse.getInstance();\r\n+\t\t\tRunnable purgeHandler = () -> {\r\n+\t\t\t\tPlayer player = TownyAPI.getInstance().getPlayer(finalResident);\r\n+\t\t\t\tif (player == null) {\r\n+\t\t\t\t\ttry {\r\n+\t\t\t\t\t\tthrow new TownyException(\"Player could not be found!\");\r\n+\t\t\t\t\t} catch (TownyException e) {\r\n+\t\t\t\t\t\te.printStackTrace();\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t\tif (!townyUniverse.getPermissionSource().testPermission(player, PermissionNodes.TOWNY_COMMAND_TOWNYADMIN_PURGE.getNode())) {\r\n+\t\t\t\t\ttry {\r\n+\t\t\t\t\t\tthrow new TownyException(TownySettings.getLangString(\"msg_err_admin_only\"));\r\n+\t\t\t\t\t} catch (TownyException e) {\r\n+\t\t\t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n+\t\t\t\t\t}\r\n \t\t\t\t}\r\n+\r\n+\t\t\t\tint numDays;\r\n+\t\t\t\tboolean townless = false;\r\n+\t\t\t\tif (finalDays.startsWith(\"townless\")) {\r\n+\t\t\t\t\ttownless = true;\r\n+\t\t\t\t\tnumDays = Integer.parseInt(finalDays.substring(8));\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\tnumDays = Integer.parseInt(finalDays);\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\tnew ResidentPurge(plugin, player, TimeTools.getMillis(numDays + \"d\"), townless).start();\r\n+\t\t\t};\r\n+\t\t\t\r\n+\t\t\tif (resident != null) {\r\n+\t\t\t\t\r\n+\t\t\t\tConfirmation confirmation = new Confirmation(player);\r\n+\t\t\t\tconfirmation.setHandler(purgeHandler);\r\n+\t\t\t\tConfirmationHandler.registerConfirmation(confirmation);\r\n+\t\t\t\tTownyMessaging.sendConfirmationMessage(player, null, null, null, null);\r\n \t\t\t}\r\n \t\t} else { // isConsole\r\n-\t\t\tConfirmationHandler.addConfirmation(ConfirmationType.PURGE, days);\r\n+\t\t\tConfirmation confirmation = new Confirmation(sender);\r\n+\r\n+\t\t\tfinal AtomicReference<String>[] finalDays = new AtomicReference[]{new AtomicReference<>(days[0])};\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31eb6b7928379843cf82eabf7c9e11eb55a2434"}, "originalPosition": 134}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87542256a165f121c87b5c4b6c93e1ed3da585b7", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/87542256a165f121c87b5c4b6c93e1ed3da585b7", "committedDate": "2020-04-08T04:51:42Z", "message": "Fix atomic reference"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5ODg0NDIw", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#pullrequestreview-389884420", "createdAt": "2020-04-08T11:26:03Z", "commit": {"oid": "87542256a165f121c87b5c4b6c93e1ed3da585b7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMToyNjowM1rOGCq06w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMTo1MjowNFrOGCrpEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ1MjAxMQ==", "bodyText": "Can we not reuse the above nation and remainingNation here now?\nAlso finalRemainingNation is basically unused.", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405452011", "createdAt": "2020-04-08T11:26:03Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/command/NationCommand.java", "diffHunk": "@@ -1350,7 +1352,20 @@ public void mergeNation(Player player, String name) throws TownyException {\n \t\t\t\tthrow new TownyException(String.format(TownySettings.getLangString(\"msg_err_king_of_that_nation_is_not_online\"), name, king.getName()));\r\n \t\t\t}\r\n \t\t\tTownyMessaging.sendMessage(BukkitTools.getPlayer(king.getName()), String.format(TownySettings.getLangString(\"msg_would_you_merge_your_nation_into_other_nation\"), nation, remainingNation, remainingNation));\r\n-\t\t\tConfirmationHandler.addConfirmation(king, ConfirmationType.NATION_MERGE, remainingNation);\r\n+\t\t\tConfirmation confirmation = new Confirmation(player);\r\n+\t\t\tNation finalRemainingNation = remainingNation;\r\n+\t\t\tconfirmation.setHandler(() -> {\r\n+\t\t\t\ttry {\r\n+\t\t\t\t\tNation succumbingNation = resident.getTown().getNation();\r\n+\t\t\t\t\tNation prevailingNation = finalRemainingNation;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87542256a165f121c87b5c4b6c93e1ed3da585b7"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ1NTAyNg==", "bodyText": "This selection will only be one townblock and needs to be populated with the PlotGroup's townblocks like the group claiming confirmation above.", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405455026", "createdAt": "2020-04-08T11:32:09Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/command/PlotCommand.java", "diffHunk": "@@ -400,8 +412,17 @@ public boolean parsePlotCommand(Player player, String[] split) throws TownyExcep\n \t\t\t\t\t\t\t\t\tnew PlotClaim(plugin, player, resident, selection, false, false, false).start();\r\n \t\t\t\t\t\t\t\t\tcontinue;\r\n \t\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\t\t// Create confirmation.\r\n+\t\t\t\t\t\t\t\tConfirmation confirmation = new Confirmation(player);\r\n+\t\t\t\t\t\t\t\tList<WorldCoord> finalSelection = selection;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87542256a165f121c87b5c4b6c93e1ed3da585b7"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ2NTM2Mg==", "bodyText": "Not sure why you've changed the above days to a String[] to make days[0], to create a new finalDays String to do the same logic below as was used previously.", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405465362", "createdAt": "2020-04-08T11:52:04Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "diffHunk": "@@ -1592,18 +1603,62 @@ public void purge(String[] split) {\n \t\t\t} catch (TownyException e) {\r\n \t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n \t\t\t}\r\n-\t\t\t\r\n-\t\t\tif (resident != null) {\r\n-\t\t\t\ttry {\r\n-\t\t\t\t\tConfirmationHandler.addConfirmation(resident, ConfirmationType.PURGE, days); // It takes the senders town & nation, an admin deleting another town has no confirmation.\r\n-\t\t\t\t\tTownyMessaging.sendConfirmationMessage(player, null, null, null, null);\r\n \r\n-\t\t\t\t} catch (TownyException e) {\r\n-\t\t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n+\t\t\tResident finalResident = resident;\r\n+\t\t\tString finalDays = days[0];\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87542256a165f121c87b5c4b6c93e1ed3da585b7"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ea42dfe6eb37711c3818f206ac1d0099dbf9544", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/2ea42dfe6eb37711c3818f206ac1d0099dbf9544", "committedDate": "2020-04-08T15:17:15Z", "message": "Fix bugs and code formatting issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ae03d3ffd9ce8ba8ce0201a8a4f95195ecfd0a6", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/8ae03d3ffd9ce8ba8ce0201a8a4f95195ecfd0a6", "committedDate": "2020-04-08T15:29:27Z", "message": "make sure timeout message only shows on an actual timeout."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64c0b6cac26262a4bb5f4fcc34d0037b2389a6e1", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/64c0b6cac26262a4bb5f4fcc34d0037b2389a6e1", "committedDate": "2020-04-08T20:22:12Z", "message": "Confirmations now send confirmations messages automatically."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc2ee2aec8df2575161c23052ecb49ebeb9530b6", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/cc2ee2aec8df2575161c23052ecb49ebeb9530b6", "committedDate": "2020-04-08T20:43:38Z", "message": "Removed CommandSender from Confirmation\n\nOnly ConfirmationHandler will deal with CommandSender's"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffe0e3c63345f678f0265b48d67f94107609476c", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/ffe0e3c63345f678f0265b48d67f94107609476c", "committedDate": "2020-04-08T20:51:40Z", "message": "Add duration field for Confirmation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c7f4c921a297ff0ca682be043893645866b7c16", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/9c7f4c921a297ff0ca682be043893645866b7c16", "committedDate": "2020-04-08T20:58:57Z", "message": "fix constructor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "367f400a72737e86affe98b1850dfb63f8d0d358", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/367f400a72737e86affe98b1850dfb63f8d0d358", "committedDate": "2020-04-08T21:23:32Z", "message": "Fix purge command feedback being only seen in console & moved purge\npermission test to pre-confirmation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bd1918c95b5a5a1444cf708f955e52c8cc487b5", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/0bd1918c95b5a5a1444cf708f955e52c8cc487b5", "committedDate": "2020-04-08T21:56:33Z", "message": "Fix /t unclaim all showing two confirmations & Fix unwanted refunds."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3add00e466ec8840a68ea983bdb839d2c6c61356", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/3add00e466ec8840a68ea983bdb839d2c6c61356", "committedDate": "2020-04-08T21:57:40Z", "message": "Remove commented out message."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "183abff678014ac7cd71b936462f682b18d4b999", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/183abff678014ac7cd71b936462f682b18d4b999", "committedDate": "2020-04-09T19:17:18Z", "message": "- Allow for other plugins to modify the TownPreClaim cancellation\nmessage.\n    - Closes #3814."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d9430c92b8e89e4772188ac4fe19236a32e34ab", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/2d9430c92b8e89e4772188ac4fe19236a32e34ab", "committedDate": "2020-04-09T19:21:55Z", "message": "Revert \"- Allow for other plugins to modify the TownPreClaim cancellation message.     - Closes #3814.\"\n\nThis reverts commit 183abff678014ac7cd71b936462f682b18d4b999."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7505c56913c5f929e2e9e4494a338adb88a4051", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/c7505c56913c5f929e2e9e4494a338adb88a4051", "committedDate": "2020-04-10T11:58:47Z", "message": "Fix nation merging confirmation going to the wrong person."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDM4MDU4", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#pullrequestreview-391438058", "createdAt": "2020-04-10T13:20:34Z", "commit": {"oid": "c7505c56913c5f929e2e9e4494a338adb88a4051"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4272, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}