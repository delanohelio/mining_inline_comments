{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MDA5NDY1", "number": 4499, "title": "Implemented MySQL Connection Pooling", "bodyText": "Description:\n\nThe purpose of this PR is to implement Connection Pooling to MySQL. The benefit to this is having the ability to jump around on connections instead of having a single connection that might get stalled. This overall will improve performance of the data handling in MySQL and should be safer.\nShowcase of these changes:\n[15:13:19 INFO]: [Towny] Database: Loaded in 4347ms.\n[15:13:19 INFO]: [Towny] Database: <50% of residents have stored UUIDs.\n\n[15:13:46 INFO]:\n[15:13:46 INFO]: -###---###-   [Towny 0.96.5.1]\n[15:13:46 INFO]: #####-#####   Authors: Chris H (Shade), ElgarL, LlmDl\n[15:13:46 INFO]: ###########    And contributors like you. <3\n[15:13:46 INFO]: -#########-\n[15:13:46 INFO]: --#######--   Residents: 140805 | Towns: 376 | Nations: 10\n[15:13:46 INFO]: ----###----   Worlds: 4 | TownBlocks: 29153\n[15:13:46 INFO]: -----#-----   https://TownyAdvanced.github.io/\n[15:13:46 INFO]:\n\nAlso, as a discussion started in the Discord about H2 and SQLite not being used / not working, I've also removed traces of those to focus solely on MySQL for the time being.\n\nNew Nodes/Commands/ConfigOptions:\n\n      # Modifiable settings to control the connection pooling.\n      pooling:\n        max_pool_size: '10'\n        min_idle_time: '10'\n        max_lifetime: '180000'\n        connection_timeout: '5000'\n\nRelevant Towny Issue ticket:\n\n\n\n I have tested this pull request for defects on a server.\n\n\nBy making this pull request, I represent that I have the right to waive copyright and related rights to my contribution, and agree that all copyright and related rights in my contributions are waived, and I acknowledge that the TownyAdvanced organization has the copyright to use and modify my contribution under the Towny License for perpetuity.", "createdAt": "2020-11-28T21:08:44Z", "url": "https://github.com/TownyAdvanced/Towny/pull/4499", "merged": true, "mergeCommit": {"oid": "03da162b48b8546ad7032ff27048d8ffbdaa30cc"}, "closed": true, "closedAt": "2020-12-03T23:38:18Z", "author": {"login": "darbyjack"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhCozjgH2gAyNTI5MDA5NDY1OmM5N2YwNzA2MTA1YTcxYjY3Yzk5YmVkOTQyNWE2YmE3OGUxMWNmOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdirguDgFqTU0NDUzOTI2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c97f0706105a71b67c99bed9425a6ba78e11cf94", "author": {"user": {"login": "darbyjack", "name": "Glare"}}, "url": "https://github.com/TownyAdvanced/Towny/commit/c97f0706105a71b67c99bed9425a6ba78e11cf94", "committedDate": "2020-11-28T21:01:07Z", "message": "Implemented MySQL Connection Pooling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e05e0a36b3db2c507ad8b5e6db340da937c7ee5", "author": {"user": {"login": "darbyjack", "name": "Glare"}}, "url": "https://github.com/TownyAdvanced/Towny/commit/3e05e0a36b3db2c507ad8b5e6db340da937c7ee5", "committedDate": "2020-11-28T21:05:40Z", "message": "Change - to _"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8ce88409ce7c78768ddd63d80ae0d60ac1164ff", "author": {"user": {"login": "darbyjack", "name": "Glare"}}, "url": "https://github.com/TownyAdvanced/Towny/commit/b8ce88409ce7c78768ddd63d80ae0d60ac1164ff", "committedDate": "2020-11-28T21:29:23Z", "message": "Inlined some properties that are only used once."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTE3ODU4", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#pullrequestreview-540517858", "createdAt": "2020-11-29T21:22:25Z", "commit": {"oid": "b8ce88409ce7c78768ddd63d80ae0d60ac1164ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQyMToyMjoyNVrOH7nEoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQyMToyMjoyNVrOH7nEoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI2ODE5Mw==", "bodyText": "setMinimumIdle represents the number of minimum connections that Hikari will maintain, and not a timeout for each connections. So I think the config setting should be renamed to MinIdleConnections. Although, hikari recommends not to set this setting.\nFrom HikariCP README:\n\nThis property controls the minimum number of idle connections that HikariCP tries to maintain in the pool. If the idle connections dip below this value and total connections in the pool are less than maximumPoolSize, HikariCP will make a best effort to add additional connections quickly and efficiently.", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#discussion_r532268193", "createdAt": "2020-11-29T21:22:25Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/towny/db/TownySQLSource.java", "diffHunk": "@@ -77,41 +80,46 @@ public TownySQLSource(Towny plugin, TownyUniverse universe, String type) {\n \t\t/*\n \t\t * Setup SQL connection\n \t\t */\n-\t\tString hostname = TownySettings.getSQLHostName();\n-\t\tString port = TownySettings.getSQLPort();\n-\t\tString flags = TownySettings.getSQLFlags();\n \t\tdb_name = TownySettings.getSQLDBName();\n \t\ttb_prefix = TownySettings.getSQLTablePrefix().toUpperCase();\n \t\t\n-\t\tString driver1;\n-\t\tif (this.type.equals(\"h2\")) {\n-\n-\t\t\tdriver1 = \"org.h2.Driver\";\n-\t\t\tthis.dsn = (\"jdbc:h2:\" + dataFolderPath + File.separator + db_name + \".h2db;AUTO_RECONNECT=TRUE\");\n-\t\t\tusername = \"sa\";\n-\t\t\tpassword = \"sa\";\n-\n-\t\t} else if (this.type.equals(\"mysql\")) {\n-\n-\t\t\tdriver1 = \"com.mysql.jdbc.Driver\";\n-\t\t\tthis.dsn = (\"jdbc:mysql://\" + hostname + \":\" + port + \"/\" + db_name + flags);\n-\t\t\tusername = TownySettings.getSQLUsername();\n-\t\t\tpassword = TownySettings.getSQLPassword();\n-\n-\t\t} else {\n-\n-\t\t\tdriver1 = \"org.sqlite.JDBC\";\n-\t\t\tthis.dsn = (\"jdbc:sqlite:\" + dataFolderPath + File.separator + db_name + \".sqldb\");\n-\t\t\tusername = \"\";\n-\t\t\tpassword = \"\";\n-\n-\t\t}\n+\t\tthis.dsn = (\"jdbc:mysql://\" + TownySettings.getSQLHostName() + \":\" + TownySettings.getSQLPort() + \"/\" + db_name + TownySettings.getSQLFlags());\n+\t\tthis.config = new HikariConfig();\n+\t\t\n+\t\tconfig.setPoolName(\"Towny MySQL\");\n+\t\tconfig.setJdbcUrl(this.dsn);\n+\n+\t\tusername = TownySettings.getSQLUsername();\n+\t\tpassword = TownySettings.getSQLPassword();\n+\n+\t\tconfig.setUsername(username);\n+\t\tconfig.setPassword(password);\n+\n+\t\tconfig.addDataSourceProperty(\"cachePrepStmts\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"prepStmtCacheSize\", \"250\");\n+\t\tconfig.addDataSourceProperty(\"prepStmtCacheSqlLimit\", \"2048\");\n+\t\tconfig.addDataSourceProperty(\"useServerPrepStmts\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"useLocalSessionState\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"rewriteBatchedStatements\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"cacheResultSetMetadata\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"cacheServerConfiguration\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"elideSetAutoCommits\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"maintainTimeStats\", \"false\");\n+\t\tconfig.addDataSourceProperty(\"alwaysSendSetIsolation\", \"false\");\n+\t\tconfig.addDataSourceProperty(\"cacheCallableStmts\", \"true\");\n+\n+\t\tconfig.setMaximumPoolSize(TownySettings.getMaxPoolSize());\n+\t\tconfig.setMinimumIdle(TownySettings.getMinIdleTime());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8ce88409ce7c78768ddd63d80ae0d60ac1164ff"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTI1NTc3", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#pullrequestreview-540525577", "createdAt": "2020-11-29T21:46:01Z", "commit": {"oid": "b8ce88409ce7c78768ddd63d80ae0d60ac1164ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQyMTo0NjowMVrOH7nYAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQyMTo0NjowMVrOH7nYAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI3MzE1NA==", "bodyText": "It would appear this line doesn't do anything:\nNote that useLocalSessionState=true will force the same behavior as alwaysSendSetIsolation=false, regardless of how alwaysSendSetIsolation is set.", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#discussion_r532273154", "createdAt": "2020-11-29T21:46:01Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/db/TownySQLSource.java", "diffHunk": "@@ -77,41 +80,46 @@ public TownySQLSource(Towny plugin, TownyUniverse universe, String type) {\n \t\t/*\n \t\t * Setup SQL connection\n \t\t */\n-\t\tString hostname = TownySettings.getSQLHostName();\n-\t\tString port = TownySettings.getSQLPort();\n-\t\tString flags = TownySettings.getSQLFlags();\n \t\tdb_name = TownySettings.getSQLDBName();\n \t\ttb_prefix = TownySettings.getSQLTablePrefix().toUpperCase();\n \t\t\n-\t\tString driver1;\n-\t\tif (this.type.equals(\"h2\")) {\n-\n-\t\t\tdriver1 = \"org.h2.Driver\";\n-\t\t\tthis.dsn = (\"jdbc:h2:\" + dataFolderPath + File.separator + db_name + \".h2db;AUTO_RECONNECT=TRUE\");\n-\t\t\tusername = \"sa\";\n-\t\t\tpassword = \"sa\";\n-\n-\t\t} else if (this.type.equals(\"mysql\")) {\n-\n-\t\t\tdriver1 = \"com.mysql.jdbc.Driver\";\n-\t\t\tthis.dsn = (\"jdbc:mysql://\" + hostname + \":\" + port + \"/\" + db_name + flags);\n-\t\t\tusername = TownySettings.getSQLUsername();\n-\t\t\tpassword = TownySettings.getSQLPassword();\n-\n-\t\t} else {\n-\n-\t\t\tdriver1 = \"org.sqlite.JDBC\";\n-\t\t\tthis.dsn = (\"jdbc:sqlite:\" + dataFolderPath + File.separator + db_name + \".sqldb\");\n-\t\t\tusername = \"\";\n-\t\t\tpassword = \"\";\n-\n-\t\t}\n+\t\tthis.dsn = (\"jdbc:mysql://\" + TownySettings.getSQLHostName() + \":\" + TownySettings.getSQLPort() + \"/\" + db_name + TownySettings.getSQLFlags());\n+\t\tthis.config = new HikariConfig();\n+\t\t\n+\t\tconfig.setPoolName(\"Towny MySQL\");\n+\t\tconfig.setJdbcUrl(this.dsn);\n+\n+\t\tusername = TownySettings.getSQLUsername();\n+\t\tpassword = TownySettings.getSQLPassword();\n+\n+\t\tconfig.setUsername(username);\n+\t\tconfig.setPassword(password);\n+\n+\t\tconfig.addDataSourceProperty(\"cachePrepStmts\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"prepStmtCacheSize\", \"250\");\n+\t\tconfig.addDataSourceProperty(\"prepStmtCacheSqlLimit\", \"2048\");\n+\t\tconfig.addDataSourceProperty(\"useServerPrepStmts\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"useLocalSessionState\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"rewriteBatchedStatements\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"cacheResultSetMetadata\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"cacheServerConfiguration\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"elideSetAutoCommits\", \"true\");\n+\t\tconfig.addDataSourceProperty(\"maintainTimeStats\", \"false\");\n+\t\tconfig.addDataSourceProperty(\"alwaysSendSetIsolation\", \"false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8ce88409ce7c78768ddd63d80ae0d60ac1164ff"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf40caf9454fc4c318df8c39d9fc5d06cacdb98e", "author": {"user": {"login": "darbyjack", "name": "Glare"}}, "url": "https://github.com/TownyAdvanced/Towny/commit/bf40caf9454fc4c318df8c39d9fc5d06cacdb98e", "committedDate": "2020-11-30T15:35:54Z", "message": "Updated in response to PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdb6fa4723505b9f675c1acdd2da1ee4d5f26490", "author": {"user": {"login": "darbyjack", "name": "Glare"}}, "url": "https://github.com/TownyAdvanced/Towny/commit/fdb6fa4723505b9f675c1acdd2da1ee4d5f26490", "committedDate": "2020-11-30T19:37:21Z", "message": "Merge branch 'master' into connection-pooling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6350cef0f131f10892dd934dc9874ceb2a50d22", "author": {"user": {"login": "darbyjack", "name": "Glare"}}, "url": "https://github.com/TownyAdvanced/Towny/commit/e6350cef0f131f10892dd934dc9874ceb2a50d22", "committedDate": "2020-12-03T01:00:09Z", "message": "Close old connections on reload."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzc2ODAx", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#pullrequestreview-543376801", "createdAt": "2020-12-03T01:42:17Z", "commit": {"oid": "e6350cef0f131f10892dd934dc9874ceb2a50d22"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwMTo0MjoxN1rOH91lng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwMTo0MjoxN1rOH91lng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYwMzE2Ng==", "bodyText": "The trailing ` will have to go.", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#discussion_r534603166", "createdAt": "2020-12-03T01:42:17Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "diffHunk": "@@ -1648,7 +1648,7 @@ public void reloadConfig(boolean reset) {\n \t *\r\n \t */\r\n \tpublic void reloadDatabase() {\r\n-\t\t\r\n+\t\tTownyUniverse.getInstance().getDataSource().finishTasks();`\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6350cef0f131f10892dd934dc9874ceb2a50d22"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d23b2fc4c36c8b28468f3f9a46c0d08789cecfb", "author": {"user": {"login": "darbyjack", "name": "Glare"}}, "url": "https://github.com/TownyAdvanced/Towny/commit/6d23b2fc4c36c8b28468f3f9a46c0d08789cecfb", "committedDate": "2020-12-03T20:51:44Z", "message": "Fixed not compiling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40d9eee77e0f8ea0a05e53f749fa44b754ddd8a1", "author": {"user": {"login": "darbyjack", "name": "Glare"}}, "url": "https://github.com/TownyAdvanced/Towny/commit/40d9eee77e0f8ea0a05e53f749fa44b754ddd8a1", "committedDate": "2020-12-03T23:06:16Z", "message": "Implemented shade filter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTM5MjYx", "url": "https://github.com/TownyAdvanced/Towny/pull/4499#pullrequestreview-544539261", "createdAt": "2020-12-03T23:12:19Z", "commit": {"oid": "40d9eee77e0f8ea0a05e53f749fa44b754ddd8a1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4142, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}