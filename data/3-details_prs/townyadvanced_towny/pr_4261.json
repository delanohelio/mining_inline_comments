{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2OTk2MDcw", "number": 4261, "title": "Refactor/nations dont save towns anymore", "bodyText": "Description:\n\n\nStops nations saving their towns: towns store their nation.\nIntelligently handles setting new nation capitals when a nation loads an invalid town for that role.\nIntelligently handles setting new town mayor when a town loads an invalid resident for that role.\nRemoves towns.txt and nations.txt from flatfile database.\nRemoves saving the nation list and town list throughout the code.\nRemoves all but two occurrences of the EmptyNationException (one on load, one in runtime.)\nMoves the bulk of the work in managing the town-nation relationship to the Town object, leaving the Nation object to just track it's list of towns in memory which are not saved.\nAdds nation.findNewCapital().\nmysql: Drops towns column from nation table.\n\nTODO: testing loading nations with invalid towns set to capital.\n\nNew Nodes/Commands/ConfigOptions:\n\n\nRelevant Towny Issue ticket:\n\n#4170\n\n\n I have tested this pull request for defects on a server.\n\n\nBy making this pull request, I represent that I have the right to waive copyright and related rights to my contribution, and agree that all copyright and related rights in my contributions are waived, and I acknowledge that the TownyAdvanced organization has the copyright to use and modify my contribution under the Towny License for perpetuity.", "createdAt": "2020-08-12T20:39:37Z", "url": "https://github.com/TownyAdvanced/Towny/pull/4261", "merged": true, "mergeCommit": {"oid": "921420037338d84c3f3fd4d81b1928b17be66407"}, "closed": true, "closedAt": "2020-08-21T15:21:39Z", "author": {"login": "LlmDl"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4JEvhAH2gAyNDY2OTk2MDcwOjk3MDIxYTJiZmZlZmE5YzY0NGUzOGZkOTk1NzQzNzU4M2NhMmUxMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBGVuPgH2gAyNDY2OTk2MDcwOjI2Y2ExNTMyYjYyZGU4ZmRiOTYwMzQwYzVhZDMzZDIwNGQ1MmQzYWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "97021a2bffefa9c644e38fd9957437583ca2e117", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/97021a2bffefa9c644e38fd9957437583ca2e117", "committedDate": "2020-07-24T19:20:10Z", "message": "Removes towns.txt and nations.txt files.\n\nRemoves necessity of saving the towns and nations lists.\nLoads old towns.txt and nations.txt to ensure that orphaned files in the\ntowns & nations folders are not loaded. If successfully loaded, the\ntowns.txt and nations.txt files are deleted."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22c0db544affaca4b4250e342e29f7ee2161b8b7", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/22c0db544affaca4b4250e342e29f7ee2161b8b7", "committedDate": "2020-07-25T12:56:42Z", "message": "Refactor for Towns loading their mayors.\n\nIf a town attempts to set a mayor who is not part of the town, and the\ntown has no residents, the town will be deleted.\n  - Closes #4170."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c81a3b89c7c221bb4637a2cf63dc47448b214b4c", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/c81a3b89c7c221bb4637a2cf63dc47448b214b4c", "committedDate": "2020-07-25T19:11:34Z", "message": "Refactor removing nations storing their towns.\n\nWorkload of adding/removing a nation for a town now worked out in Town\ninstead of Nation.\nReduces all but one EmptyNationException.\n\nUntested."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d261c6b5025b97a25b3dff4d7db9cbaaa7d59cb", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/6d261c6b5025b97a25b3dff4d7db9cbaaa7d59cb", "committedDate": "2020-07-25T19:18:36Z", "message": "Merge remote-tracking branch 'origin/master' into refactor/nations_dont_save_towns_anymore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d051e7e0692f80a289bd90debb6820a3d0a842e2", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/d051e7e0692f80a289bd90debb6820a3d0a842e2", "committedDate": "2020-07-25T19:45:02Z", "message": "Slight tweaking on initial commit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "522140149fe9899dea031d3bf3d763c79fb7021c", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/522140149fe9899dea031d3bf3d763c79fb7021c", "committedDate": "2020-07-26T01:25:41Z", "message": "Clean up nation/town loading, handle loading nation capitals\nintelligently."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5f4af8bfc5b097ccec277e726d063f780958251", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/f5f4af8bfc5b097ccec277e726d063f780958251", "committedDate": "2020-07-26T02:23:09Z", "message": "Re-work mayor setting. Find new mayors when a town loads a mayor who\ndoesn't match.\n\nTODO: testing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69b9c3a75766d0a95ff48aa2d07a76e7442306e9", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/69b9c3a75766d0a95ff48aa2d07a76e7442306e9", "committedDate": "2020-07-26T02:41:45Z", "message": "Merge branch 'refactor/town_set_mayor_exception_removal' of https://github.com/TownyAdvanced/Towny.git into refactor/nations_dont_save_towns_anymore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDcwMDA5", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#pullrequestreview-467070009", "createdAt": "2020-08-13T19:32:27Z", "commit": {"oid": "69b9c3a75766d0a95ff48aa2d07a76e7442306e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxOTozMjoyN1rOHAap8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxOTozMjoyN1rOHAap8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5ODc3MA==", "bodyText": "Please wrap in {} for readability", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#discussion_r470198770", "createdAt": "2020-08-13T19:32:27Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/towny/object/Nation.java", "diffHunk": "@@ -193,13 +200,35 @@ public void setCapital(Town capital) {\n \t\t} catch (Exception e) {\n \t\t\t// Dummy catch to prevent errors on startup when setting nation.\n \t\t}\n-\t\t//TownyUniverse.getInstance().getDataSource().saveNation(this);\n \t}\n \n \tpublic Town getCapital() {\n \n \t\treturn capital;\n \t}\n+\t\n+\t/**\n+\t * Finds the town in the nation with the most residents and makes it the capital.\n+\t * \n+\t * @return whether it successfully set a capital.\n+\t */\n+\tprivate boolean findNewCapital() {\n+\t\t\n+\t\tint numResidents = 0;\n+\t\tTown tempCapital = null;\n+\t\tfor (Town newCapital : getTowns())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69b9c3a75766d0a95ff48aa2d07a76e7442306e9"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDcxMDIw", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#pullrequestreview-467071020", "createdAt": "2020-08-13T19:34:02Z", "commit": {"oid": "69b9c3a75766d0a95ff48aa2d07a76e7442306e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxOTozNDowMlrOHAatMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxOTozNDowMlrOHAatMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5OTYwMw==", "bodyText": "I don't really see a necessity in making a separate method just to throw an exception. Maybe just make the setMayor(...) method return a boolean indicating success and then handle the result in the loading areas.", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#discussion_r470199603", "createdAt": "2020-08-13T19:34:02Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/towny/object/Town.java", "diffHunk": "@@ -129,13 +131,32 @@ public double getTaxes() {\n \t\treturn taxes == -1 ? TownySettings.getTownDefaultTax() : taxes;\n \t}\n \n-\tpublic void setMayor(Resident mayor) throws TownyException {\n+\t/**\n+\t * Sets a resident to become mayor. Used only in database loading.\n+\t * \n+\t * @param mayor - Town Resident to make into mayor.\n+\t * @throws TownyException - When given mayor is not a resident.\n+\t */\n+\tpublic void forceSetMayor(Resident mayor) throws TownyException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69b9c3a75766d0a95ff48aa2d07a76e7442306e9"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69e14cbe3cfa300ced80f27a400cf2e34e0d6447", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/69e14cbe3cfa300ced80f27a400cf2e34e0d6447", "committedDate": "2020-08-14T21:26:37Z", "message": "Improve readability in Nation.java's findNewCapital()."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MTE1Mjgx", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#pullrequestreview-468115281", "createdAt": "2020-08-17T01:02:00Z", "commit": {"oid": "69e14cbe3cfa300ced80f27a400cf2e34e0d6447"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwMTowMjowMFrOHBW3Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwMTowMjowMFrOHBW3Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE4NTIzOA==", "bodyText": "Doesn't this need a return statement since otherwise it will continue to findNewCapital?", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#discussion_r471185238", "createdAt": "2020-08-17T01:02:00Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/towny/object/Nation.java", "diffHunk": "@@ -171,20 +168,30 @@ public boolean hasTown(Town town) {\n \t\treturn towns.contains(town);\n \t}\n \n-\tpublic void addTown(Town town) throws AlreadyRegisteredException {\n+\tpublic void addTown(Town town) {\n+\t\ttowns.add(town);\n+\t}\n \n-\t\tif (hasTown(town))\n-\t\t\tthrow new AlreadyRegisteredException();\n-\t\telse if (town.hasNation())\n-\t\t\tthrow new AlreadyRegisteredException();\n-\t\telse {\n-\t\t\ttowns.add(town);\n-\t\t\ttown.setNation(this);\n-\t\t\t\n-\t\t\tBukkitTools.getPluginManager().callEvent(new NationAddTownEvent(town, this));\n+\t/**\n+\t * Only to be called from the loading methods.\n+\t * \n+\t * @param capital - Town to make capital.\n+\t * @throws EmptyNationException Thrown when no capital can be set.\n+\t */\n+\tpublic void forceSetCapital(Town capital) throws EmptyNationException {\n+\n+\t\tif (towns.isEmpty())\n+\t\t\tthrow new EmptyNationException(this);\n+\t\t\n+\t\ttry {\n+\t\t\tif (capital.getNation().equals(this))\n+\t\t\t\tsetCapital(capital);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69e14cbe3cfa300ced80f27a400cf2e34e0d6447"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92c8471c1d6422636f52da1c2a7648fa21edbbd9", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/92c8471c1d6422636f52da1c2a7648fa21edbbd9", "committedDate": "2020-08-17T14:20:50Z", "message": "Add missing return to forceSetCapital(Town capital)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de29034804750b4891124d4b5a69ce5b13048d99", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/de29034804750b4891124d4b5a69ce5b13048d99", "committedDate": "2020-08-19T01:54:12Z", "message": "Merge tag '0.96.2.11' into refactor/nations_dont_save_towns_anymore\n\nConflicts:\n\tsrc/com/palmergames/bukkit/towny/db/TownyFlatFileSource.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMDk3MjI5", "url": "https://github.com/TownyAdvanced/Towny/pull/4261#pullrequestreview-470097229", "createdAt": "2020-08-19T03:20:50Z", "commit": {"oid": "de29034804750b4891124d4b5a69ce5b13048d99"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0172fabaf74758e4e35d3b55493870eed917845", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/e0172fabaf74758e4e35d3b55493870eed917845", "committedDate": "2020-08-21T15:08:11Z", "message": "Merge master branch and sort out conflicts in TownySQLSource.\n\nAlso fix town loading after selecting a new mayor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26ca1532b62de8fdb960340c5ad33d204d52d3ab", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/26ca1532b62de8fdb960340c5ad33d204d52d3ab", "committedDate": "2020-08-21T15:14:19Z", "message": "Merge branch 'master' into refactor/nations_dont_save_towns_anymore"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4180, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}