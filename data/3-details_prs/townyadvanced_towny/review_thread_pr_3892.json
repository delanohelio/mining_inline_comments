{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNjEyMzUz", "number": 3892, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNDozNzoxMVrODv1Ecw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMTo1MjowNFrODv9RWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDc5MTU1OnYy", "diffSide": "RIGHT", "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNDozNzoxMVrOGCessw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNDozNzoxMVrOGCessw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI1MzI5OQ==", "bodyText": "Why an atomic reference?", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405253299", "createdAt": "2020-04-08T04:37:11Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "diffHunk": "@@ -1592,18 +1603,62 @@ public void purge(String[] split) {\n \t\t\t} catch (TownyException e) {\r\n \t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n \t\t\t}\r\n-\t\t\t\r\n-\t\t\tif (resident != null) {\r\n-\t\t\t\ttry {\r\n-\t\t\t\t\tConfirmationHandler.addConfirmation(resident, ConfirmationType.PURGE, days); // It takes the senders town & nation, an admin deleting another town has no confirmation.\r\n-\t\t\t\t\tTownyMessaging.sendConfirmationMessage(player, null, null, null, null);\r\n \r\n-\t\t\t\t} catch (TownyException e) {\r\n-\t\t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n+\t\t\tResident finalResident = resident;\r\n+\t\t\tString finalDays = days[0];\r\n+\t\t\tTownyUniverse townyUniverse = TownyUniverse.getInstance();\r\n+\t\t\tRunnable purgeHandler = () -> {\r\n+\t\t\t\tPlayer player = TownyAPI.getInstance().getPlayer(finalResident);\r\n+\t\t\t\tif (player == null) {\r\n+\t\t\t\t\ttry {\r\n+\t\t\t\t\t\tthrow new TownyException(\"Player could not be found!\");\r\n+\t\t\t\t\t} catch (TownyException e) {\r\n+\t\t\t\t\t\te.printStackTrace();\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t\tif (!townyUniverse.getPermissionSource().testPermission(player, PermissionNodes.TOWNY_COMMAND_TOWNYADMIN_PURGE.getNode())) {\r\n+\t\t\t\t\ttry {\r\n+\t\t\t\t\t\tthrow new TownyException(TownySettings.getLangString(\"msg_err_admin_only\"));\r\n+\t\t\t\t\t} catch (TownyException e) {\r\n+\t\t\t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n+\t\t\t\t\t}\r\n \t\t\t\t}\r\n+\r\n+\t\t\t\tint numDays;\r\n+\t\t\t\tboolean townless = false;\r\n+\t\t\t\tif (finalDays.startsWith(\"townless\")) {\r\n+\t\t\t\t\ttownless = true;\r\n+\t\t\t\t\tnumDays = Integer.parseInt(finalDays.substring(8));\r\n+\t\t\t\t} else {\r\n+\t\t\t\t\tnumDays = Integer.parseInt(finalDays);\r\n+\t\t\t\t}\r\n+\r\n+\t\t\t\tnew ResidentPurge(plugin, player, TimeTools.getMillis(numDays + \"d\"), townless).start();\r\n+\t\t\t};\r\n+\t\t\t\r\n+\t\t\tif (resident != null) {\r\n+\t\t\t\t\r\n+\t\t\t\tConfirmation confirmation = new Confirmation(player);\r\n+\t\t\t\tconfirmation.setHandler(purgeHandler);\r\n+\t\t\t\tConfirmationHandler.registerConfirmation(confirmation);\r\n+\t\t\t\tTownyMessaging.sendConfirmationMessage(player, null, null, null, null);\r\n \t\t\t}\r\n \t\t} else { // isConsole\r\n-\t\t\tConfirmationHandler.addConfirmation(ConfirmationType.PURGE, days);\r\n+\t\t\tConfirmation confirmation = new Confirmation(sender);\r\n+\r\n+\t\t\tfinal AtomicReference<String>[] finalDays = new AtomicReference[]{new AtomicReference<>(days[0])};\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31eb6b7928379843cf82eabf7c9e11eb55a2434"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNjA1MDg4OnYy", "diffSide": "RIGHT", "path": "src/com/palmergames/bukkit/towny/command/NationCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMToyNjowM1rOGCq06w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMToyNjowM1rOGCq06w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ1MjAxMQ==", "bodyText": "Can we not reuse the above nation and remainingNation here now?\nAlso finalRemainingNation is basically unused.", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405452011", "createdAt": "2020-04-08T11:26:03Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/command/NationCommand.java", "diffHunk": "@@ -1350,7 +1352,20 @@ public void mergeNation(Player player, String name) throws TownyException {\n \t\t\t\tthrow new TownyException(String.format(TownySettings.getLangString(\"msg_err_king_of_that_nation_is_not_online\"), name, king.getName()));\r\n \t\t\t}\r\n \t\t\tTownyMessaging.sendMessage(BukkitTools.getPlayer(king.getName()), String.format(TownySettings.getLangString(\"msg_would_you_merge_your_nation_into_other_nation\"), nation, remainingNation, remainingNation));\r\n-\t\t\tConfirmationHandler.addConfirmation(king, ConfirmationType.NATION_MERGE, remainingNation);\r\n+\t\t\tConfirmation confirmation = new Confirmation(player);\r\n+\t\t\tNation finalRemainingNation = remainingNation;\r\n+\t\t\tconfirmation.setHandler(() -> {\r\n+\t\t\t\ttry {\r\n+\t\t\t\t\tNation succumbingNation = resident.getTown().getNation();\r\n+\t\t\t\t\tNation prevailingNation = finalRemainingNation;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87542256a165f121c87b5c4b6c93e1ed3da585b7"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNjA3MDA3OnYy", "diffSide": "RIGHT", "path": "src/com/palmergames/bukkit/towny/command/PlotCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMTozMjowOVrOGCrAsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMTozMjowOVrOGCrAsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ1NTAyNg==", "bodyText": "This selection will only be one townblock and needs to be populated with the PlotGroup's townblocks like the group claiming confirmation above.", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405455026", "createdAt": "2020-04-08T11:32:09Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/command/PlotCommand.java", "diffHunk": "@@ -400,8 +412,17 @@ public boolean parsePlotCommand(Player player, String[] split) throws TownyExcep\n \t\t\t\t\t\t\t\t\tnew PlotClaim(plugin, player, resident, selection, false, false, false).start();\r\n \t\t\t\t\t\t\t\t\tcontinue;\r\n \t\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t\t\t\r\n+\t\t\t\t\t\t\t\t// Create confirmation.\r\n+\t\t\t\t\t\t\t\tConfirmation confirmation = new Confirmation(player);\r\n+\t\t\t\t\t\t\t\tList<WorldCoord> finalSelection = selection;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87542256a165f121c87b5c4b6c93e1ed3da585b7"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNjEzNTMxOnYy", "diffSide": "RIGHT", "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMTo1MjowNFrOGCrpEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMTo1MjowNFrOGCrpEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ2NTM2Mg==", "bodyText": "Not sure why you've changed the above days to a String[] to make days[0], to create a new finalDays String to do the same logic below as was used previously.", "url": "https://github.com/TownyAdvanced/Towny/pull/3892#discussion_r405465362", "createdAt": "2020-04-08T11:52:04Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/command/TownyAdminCommand.java", "diffHunk": "@@ -1592,18 +1603,62 @@ public void purge(String[] split) {\n \t\t\t} catch (TownyException e) {\r\n \t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n \t\t\t}\r\n-\t\t\t\r\n-\t\t\tif (resident != null) {\r\n-\t\t\t\ttry {\r\n-\t\t\t\t\tConfirmationHandler.addConfirmation(resident, ConfirmationType.PURGE, days); // It takes the senders town & nation, an admin deleting another town has no confirmation.\r\n-\t\t\t\t\tTownyMessaging.sendConfirmationMessage(player, null, null, null, null);\r\n \r\n-\t\t\t\t} catch (TownyException e) {\r\n-\t\t\t\t\tTownyMessaging.sendErrorMsg(player, e.getMessage());\r\n+\t\t\tResident finalResident = resident;\r\n+\t\t\tString finalDays = days[0];\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87542256a165f121c87b5c4b6c93e1ed3da585b7"}, "originalPosition": 92}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1268, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}