{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4NDYxNzEw", "number": 3872, "title": "Hotfix/paper async", "bodyText": "Description:\n\nFixes spawn events firing false positives, and cleans up async code.\n\nRelevant Towny Issue ticket:\n\n I have tested this pull request for defects on a server.\n\n\nBy making this pull request, I represent that I have the right to waive copyright and related rights to my contribution, and agree that all copyright and related rights in my contributions are waived, and I acknowledge that the TownyAdvanced organization has the copyright to use and modify my contribution under the Towny License for perpetuity.", "createdAt": "2020-04-04T03:36:57Z", "url": "https://github.com/TownyAdvanced/Towny/pull/3872", "merged": true, "mergeCommit": {"oid": "de5e182093e3f293547837a7bcad7243b42a492c"}, "closed": true, "closedAt": "2020-04-04T23:26:00Z", "author": null, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUFPfogH2gAyMzk4NDYxNzEwOjM2ZGU2ODY4OTk2NTA5ZjQ0ZDA1YWIyYmZmZTBmMDdlOWQ4NmYwNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUa1VIgH2gAyMzk4NDYxNzEwOjQxYzI1NGZjNmJhNmU0ZWQ4NThiMDE2ZTUzYjFlNTczZjY5MTkzM2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "36de6868996509f44d05ab2bffe0f07e9d86f070", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/36de6868996509f44d05ab2bffe0f07e9d86f070", "committedDate": "2020-04-03T18:31:01Z", "message": "Shade in paperlib for async chunk loading."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1c184bd5cc6945bf2dace6ee61a17c61beda0ac", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/a1c184bd5cc6945bf2dace6ee61a17c61beda0ac", "committedDate": "2020-04-04T03:35:55Z", "message": "fix spawn events and clean up async teleporting."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2a201e502c010b8f078ed0e45b35d3da8aaa67e", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/a2a201e502c010b8f078ed0e45b35d3da8aaa67e", "committedDate": "2020-04-04T03:37:21Z", "message": "Merge remote-tracking branch 'origin/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16ed583ad2a69fdf847442287a0ef99cee008fd6", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/16ed583ad2a69fdf847442287a0ef99cee008fd6", "committedDate": "2020-04-04T03:38:27Z", "message": "Merge branch 'master' into hotfix/paper-async\n\n# Conflicts:\n#\tsrc/com/palmergames/bukkit/towny/utils/SpawnUtil.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NjkwNDk1", "url": "https://github.com/TownyAdvanced/Towny/pull/3872#pullrequestreview-387690495", "createdAt": "2020-04-04T11:15:00Z", "commit": {"oid": "16ed583ad2a69fdf847442287a0ef99cee008fd6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQxMToxNTowMVrOGAxIVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNFQxMToxNTowMVrOGAxIVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ1ODEzMw==", "bodyText": "This still doesn't work when the player is going to an outpost.", "url": "https://github.com/TownyAdvanced/Towny/pull/3872#discussion_r403458133", "createdAt": "2020-04-04T11:15:01Z", "author": {"login": "LlmDl"}, "path": "src/com/palmergames/bukkit/towny/utils/SpawnUtil.java", "diffHunk": "@@ -349,40 +351,72 @@ else if (town != null)\n \t\t\t}\r\n \t\t}\r\n \t\t\r\n-\t\t// Used later to make sure the chunk we teleport to is loaded.\r\n-\t\tCompletableFuture<Chunk> chunkFuture = PaperLib.getChunkAtAsync(spawnLoc);\r\n-\t\t\r\n-\t\t// Legacy code (non-paper sync)\r\n-\t\t//Chunk chunk = spawnLoc.getChunk();\r\n+\t\tif (!sendSpawnEvent(player, spawnType, townyObject)) {\r\n+\t\t\treturn;\r\n+\t\t}\r\n \r\n-\t\tLocation finalSpawnLoc = spawnLoc;\r\n-\t\tchunkFuture.thenAccept((chunk -> {\r\n-\t\t\t// If an Admin or Essentials teleport isn't being used, use our own.\r\n-\t\t\tif (isTownyAdmin) {\r\n-\t\t\t\tif (player.getVehicle() != null)\r\n-\t\t\t\t\tplayer.getVehicle().eject();\r\n-\t\t\t\tplayer.teleport(finalSpawnLoc, TeleportCause.COMMAND);\r\n-\t\t\t\treturn;\r\n-\t\t\t}\r\n+\t\t// If an Admin or Essentials teleport isn't being used, use our own.\r\n+\t\tif (isTownyAdmin) {\r\n+\t\t\tif (player.getVehicle() != null)\r\n+\t\t\t\tplayer.getVehicle().eject();\r\n+\t\t\tPaperLib.teleportAsync(player, spawnLoc, TeleportCause.COMMAND);\r\n+\t\t\treturn;\r\n+\t\t}\r\n \r\n \t\t\tif (!usingESS) {\r\n \t\t\t\tif (TownyTimerHandler.isTeleportWarmupRunning()) {\r\n \t\t\t\t\t// Use teleport warmup\r\n \t\t\t\t\tplayer.sendMessage(String.format(TownySettings.getLangString(\"msg_town_spawn_warmup\"),\r\n \t\t\t\t\t\tTownySettings.getTeleportWarmupTime()));\r\n-\t\t\t\t\tTownyAPI.getInstance().requestTeleport(player, finalSpawnLoc);\r\n-\t\t\t\t} else {\r\n-\t\t\t\t\t// Don't use teleport warmup\r\n-\t\t\t\t\tif (player.getVehicle() != null)\r\n-\t\t\t\t\t\tplayer.getVehicle().eject();\r\n-\t\t\t\t\tplayer.teleport(finalSpawnLoc, TeleportCause.COMMAND);\r\n-\t\t\t\t\tif (TownySettings.getSpawnCooldownTime() > 0)\r\n-\t\t\t\t\t\tCooldownTimerTask.addCooldownTimer(resident.getName(), CooldownType.TELEPORT);\r\n-\t\t\t\t}\r\n+\t\t\t\tTownyAPI.getInstance().requestTeleport(player, spawnLoc);\r\n+\t\t\t} else {\r\n+\t\t\t\t// Don't use teleport warmup\r\n+\t\t\t\tif (player.getVehicle() != null)\r\n+\t\t\t\t\tplayer.getVehicle().eject();\r\n+\t\t\t\tPaperLib.teleportAsync(player, spawnLoc, TeleportCause.COMMAND);\r\n+\t\t\t\tif (TownySettings.getSpawnCooldownTime() > 0)\r\n+\t\t\t\t\tCooldownTimerTask.addCooldownTimer(resident.getName(), CooldownType.TELEPORT);\r\n \t\t\t}\r\n-\t\t}));\r\n+\t\t}\r\n+\t}\r\n+\t\r\n+\tpublic static boolean sendSpawnEvent(Player player, SpawnType type, TownyObject object) {\r\n+\t\tswitch (type) {\r\n+\t\t\tcase TOWN:\r\n+\t\t\t\tTown town = (Town)object;\r\n+\t\t\t\tLocation to;\r\n+\t\t\t\ttry {\r\n+\t\t\t\t\tto = town.getSpawn();\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16ed583ad2a69fdf847442287a0ef99cee008fd6"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d3ac9e345275b2084fc3a7ad17ca46f9101d9eb", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/5d3ac9e345275b2084fc3a7ad17ca46f9101d9eb", "committedDate": "2020-04-04T15:56:22Z", "message": "fix outpost for town spawn events."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad97a5adc606a46a9bf1083ad2788d6f63566134", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/ad97a5adc606a46a9bf1083ad2788d6f63566134", "committedDate": "2020-04-04T16:17:40Z", "message": "Remove testing code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "848f39f303590ff77badd76c81f0cfad2a475675", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/848f39f303590ff77badd76c81f0cfad2a475675", "committedDate": "2020-04-04T19:20:40Z", "message": "clean up and add proper docs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "329413a1869b4421788bc1b931e2b7764816d3ec", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/329413a1869b4421788bc1b931e2b7764816d3ec", "committedDate": "2020-04-04T19:22:39Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41c254fc6ba6e4ed858b016e53b1e573f691933f", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/41c254fc6ba6e4ed858b016e53b1e573f691933f", "committedDate": "2020-04-04T19:40:21Z", "message": "revert custom listener changes."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4266, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}