{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNjA4NjM5", "number": 4340, "title": "Town bankruptcy rebase", "bodyText": "This Pull Request is a continuation of #4245. We are now working on it from a branch on this repo.\nDescription:\nThis PR adds a 'town bankruptcy' feature\n\nIf this feature is enabled, then if a town runs out of money (due to upkeep, nation tax etc.), it does not get deleted, but instead goes into a 'bankrupt state'.\nWhile bankrupt, the town bank account is in debt, and the town cannot expand (e.g. claim, recruit, or build).\nThe debt has a ceiling equal to the estimated value of the town (from new town and claims costs).\nThe debt can be repaid using /t deposit x.\nOnce all debt is repaid, the town immediately returns to a normal state.\nThis work builds on the recent changes by Siris which added a 'debt' account.\n\n\nNew Nodes/Commands/ConfigOptions:\n  - New Config Option: economy.bankruptcy.enabled\n    - default: false\n    - If this setting is true, then if a town runs out of money (due to\nupkeep, nation tax etc.), it does not get deleted, but instead goes into\na 'bankrupt state'.\n    - While bankrupt, the town bank account is in debt, and the town\ncannot expand (e.g claim, recruit, or build).\n    - The debt has a ceiling equal to the estimated value of the town\n(from new town and claims costs.)\n    - The debt can be repaid using /t deposit x.\n    - Once all debt is repaid, the town immediately returns to a normal\nstate.\n\n  - New Config Option: economy.bankruptcy.debt_cap.maximum\n    - default: 0.0\n    - When set to greater than 0.0, this will be used to determine every\ntown''s maximum debt overriding the above calculation if the calculation\nwould be larger than the set maximum.\n\n  - New Config Option: economy.bankruptcy.debt_cap.override\n    - default: 0.0\n    - When set to greater than 0.0, this setting will override all other\ndebt calculations and maximums, making all towns have the same debt cap.\n\n  - New Config Option:\neconomy.bankruptcy.upkeep.delete_towns_that_reach_debt_cap\n    - default: false\n    - If a town has reached their debt cap and is unable to pay the\nupkeep with debt, will Towny delete them?\n\n  - New Config Option:\neconomy.bankruptcy.nation_tax.do_bankrupt_towns_pay_nation_tax\n    - default: false\n    - Will bankrupt towns pay their nation tax?\n    - If false towns that are bankrupt will not pay any nation tax and\nwill leave their nation.\n    - If true the town will go into debt up until their debt cap is\nreached.\n    - True is recommended when using a Siege War style war/conquering\nsystem, otherwise conquered towns will be able to leave the nation\nsimply by not paying the nation tax.\n    - False is recommended otherwise so that nations are not using\nabandoned towns to gather taxes.\n\n  - New Config Option:\neconomy.bankruptcy.nation_tax.kick_towns_that_reach_debt_cap\n    - default: false\n    - If a town can no longer pay their nation tax with debt because\nthey have reach their debtcap, are they kicked from the nation?\n\n\nRelevant Towny Issue ticket:\n#3657\n\n\n I have tested this pull request for defects on a server.\n\nBy making this pull request, I represent that I have the right to waive copyright and related rights to my contribution, and agree that all copyright and related rights in my contributions are waived, and I acknowledge that the TownyAdvanced organization has the copyright to use and modify my contribution under the Towny License for perpetuity.", "createdAt": "2020-09-26T18:03:01Z", "url": "https://github.com/TownyAdvanced/Towny/pull/4340", "merged": true, "mergeCommit": {"oid": "c12a58c4a08482c94cd60140de202dcf9570ee0f"}, "closed": true, "closedAt": "2020-09-27T18:21:54Z", "author": {"login": "LlmDl"}, "timelineItems": {"totalCount": 71, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMVTm6gH2gAyNDkzNjA4NjM5OjMxZDYxMTE4OWE0MTY0OGNiNjE5ZDgzNGJiN2Q0ZTI2N2U5MDI3NTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNDIXNAH2gAyNDkzNjA4NjM5OmQ5OTVkOTVkOWY0YzI5YjE0YzBmNGRjMWMyNzIxYTdlNGEzMWJjNDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "31d611189a41648cb619d834bb7d4e267e902755", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/31d611189a41648cb619d834bb7d4e267e902755", "committedDate": "2020-09-25T12:53:45Z", "message": "Unify Bank methods and provide defaults."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d220fb46531de24b42a0eeedd399d7f48c72dd8", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/8d220fb46531de24b42a0eeedd399d7f48c72dd8", "committedDate": "2020-09-25T13:06:13Z", "message": "Introduce new territory for code consolidation between towns and nations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba0df31b070c23c60ced80086b1fbbde1b9db558", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/ba0df31b070c23c60ced80086b1fbbde1b9db558", "committedDate": "2020-09-25T13:06:14Z", "message": "Revert Towny.java changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2db4f8d62e54d18201c969d40ad9e4cbe607e14", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/b2db4f8d62e54d18201c969d40ad9e4cbe607e14", "committedDate": "2020-09-25T13:09:31Z", "message": "Add new SpawnLocation interface and more cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42b25f02df2278d00ca8ce0ca7a059bb6ae408d8", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/42b25f02df2278d00ca8ce0ca7a059bb6ae408d8", "committedDate": "2020-09-25T13:10:34Z", "message": "Cleanup Commit\n\nRemoves unused imports\nRe-adds renamed methods as deprecated to maintain compatibility."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dda4ae1c33f48e39ae8244fabe136fd2673f147e", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/dda4ae1c33f48e39ae8244fabe136fd2673f147e", "committedDate": "2020-09-25T13:10:34Z", "message": "Format code to what is standard in Towny."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30f966a9a5bf48a22419f9907bf5315b5f8cdc1f", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/30f966a9a5bf48a22419f9907bf5315b5f8cdc1f", "committedDate": "2020-09-25T13:20:18Z", "message": "Add new Bank Object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "477fac29605c1d06da174cea5e4551bbbc140a24", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/477fac29605c1d06da174cea5e4551bbbc140a24", "committedDate": "2020-09-25T13:21:35Z", "message": "Add Documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60c779cebcab6b205c88c99f81446065c1398494", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/60c779cebcab6b205c88c99f81446065c1398494", "committedDate": "2020-09-25T13:21:35Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4688cb5fe2dd161d40797511c75ac42c8e4b799e", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/4688cb5fe2dd161d40797511c75ac42c8e4b799e", "committedDate": "2020-09-25T13:25:18Z", "message": "Add more specific documentation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebfdd9b909360618fe3fe6cf7fc6139c0b846ef6", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/ebfdd9b909360618fe3fe6cf7fc6139c0b846ef6", "committedDate": "2020-09-25T13:25:18Z", "message": "Add observer for account transactions to separate auditing code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94ce4407f1e4a5cb725191046c8d8f96e720de4d", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/94ce4407f1e4a5cb725191046c8d8f96e720de4d", "committedDate": "2020-09-25T13:29:11Z", "message": "Make most objects return unmodifiable lists, this will prevent untracked and dangerous writes to objects.\n\n- Document ResidentList"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f90fbe220ef97c006cf614530c943e4a77e89af5", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/f90fbe220ef97c006cf614530c943e4a77e89af5", "committedDate": "2020-09-25T13:29:11Z", "message": "Remove some unused imports."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a59fee8fbd2af8bf01fc5e0fd271afac692a32ca", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/a59fee8fbd2af8bf01fc5e0fd271afac692a32ca", "committedDate": "2020-09-25T13:30:09Z", "message": "Add auditing mechanics to Town and Nation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "003fc13a6e546b90eef284d30c71142f76c2c96f", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/003fc13a6e546b90eef284d30c71142f76c2c96f", "committedDate": "2020-09-25T13:50:17Z", "message": "Initial book stuff."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af6ba2cf25568bb235a74847a6929c10dfad04f7", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/af6ba2cf25568bb235a74847a6929c10dfad04f7", "committedDate": "2020-09-25T14:20:32Z", "message": "Add iterator support for TownBlockOwner and ResidentList"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c578b38c3a4349c59efdb88d9865b58abdd36579", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/c578b38c3a4349c59efdb88d9865b58abdd36579", "committedDate": "2020-09-25T14:29:23Z", "message": "Add deprecations for backwards compatibility."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f136433393ac263c93c42deead57617fa2e09c81", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/f136433393ac263c93c42deead57617fa2e09c81", "committedDate": "2020-09-25T14:30:30Z", "message": "Revert iterators."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d018edc999082d8d638658282ee9a6aac6bb9ad", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/4d018edc999082d8d638658282ee9a6aac6bb9ad", "committedDate": "2020-09-25T14:33:01Z", "message": "Finalization."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fc415961b1f34771dad1713e832ff10b87b6fc0", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/2fc415961b1f34771dad1713e832ff10b87b6fc0", "committedDate": "2020-09-25T14:33:01Z", "message": "Fix version number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a90b2ee5c8df1e4366c2da2a570bf122ed44e1a5", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/a90b2ee5c8df1e4366c2da2a570bf122ed44e1a5", "committedDate": "2020-09-25T14:42:58Z", "message": "Added bankrupt towns feature\n\n- If this feature is enabled, towns do not get deleted if they run out\nof funds (e.g. due to taxes/upkeep)\n- Instead they go into a bankrupt state\n- In this state the town bank is in debt, and the debt accumulates as\nfurther costs are incurred, up to a maximum ceiling amount.\n- In this state the towns cannot build, recruit, or claim\n- Towns can return from this state by repaying all debt using /t deposit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f649d24d02cebe99ede253b8cef45633f90fd640", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/f649d24d02cebe99ede253b8cef45633f90fd640", "committedDate": "2020-09-25T14:45:02Z", "message": "Add economy adapter to interface with multiple eco implementations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b27fab677f9ac7d68c1d8961154264a6a39ff767", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/b27fab677f9ac7d68c1d8961154264a6a39ff767", "committedDate": "2020-09-25T14:45:02Z", "message": "unbox primitive types."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bbf22875c5b140cb049c44ddf4a2ee9fc69a1fc", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/0bbf22875c5b140cb049c44ddf4a2ee9fc69a1fc", "committedDate": "2020-09-25T14:48:49Z", "message": "CR updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a34ba544c1c41aa7f537d9d6c77e506cbc9e87fb", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/a34ba544c1c41aa7f537d9d6c77e506cbc9e87fb", "committedDate": "2020-09-25T14:48:49Z", "message": "town bankruptsy - Misc fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18e459be527aec54281084c49ebecb5c1e727ac9", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/18e459be527aec54281084c49ebecb5c1e727ac9", "committedDate": "2020-09-25T14:49:51Z", "message": "Remove GH packages dependencies."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2560cc013ca09050ba0f9450c91622d6d1d9112f", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/2560cc013ca09050ba0f9450c91622d6d1d9112f", "committedDate": "2020-09-25T14:51:22Z", "message": "Remove static server account field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f08bc7cf7a24bd838552995989b15458c6c7eef4", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/f08bc7cf7a24bd838552995989b15458c6c7eef4", "committedDate": "2020-09-25T14:58:13Z", "message": "Initial skeleton for debt handling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6011a391a1d469ca220ae064477cad72ca874e53", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/6011a391a1d469ca220ae064477cad72ca874e53", "committedDate": "2020-09-25T15:00:24Z", "message": "Flesh out more debt methods add debt prefix config setting."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d11cd0580a5c9cb58260cb7a9abdd0c56c8b149e", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/d11cd0580a5c9cb58260cb7a9abdd0c56c8b149e", "committedDate": "2020-09-25T15:01:19Z", "message": "Debt account is now functional."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe59923ec4b47142bff9d5d39011750da84db80c", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/fe59923ec4b47142bff9d5d39011750da84db80c", "committedDate": "2020-09-25T15:04:22Z", "message": "Fix other debt issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6f17b25bee6571df075626f30cf89a609f3baab", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/f6f17b25bee6571df075626f30cf89a609f3baab", "committedDate": "2020-09-25T15:05:05Z", "message": "remove unecessary stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "699c651d6aadf7214bdec497a27cca38c96fefae", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/699c651d6aadf7214bdec497a27cca38c96fefae", "committedDate": "2020-09-25T15:05:57Z", "message": "fix javadoc errors."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0557d6c7e4be760e3497f62a3d330910ca5544e5", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/0557d6c7e4be760e3497f62a3d330910ca5544e5", "committedDate": "2020-09-25T15:06:56Z", "message": "make requested changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4df66f31f6ba608dcbb347b412e55f0e6e682dea", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/4df66f31f6ba608dcbb347b412e55f0e6e682dea", "committedDate": "2020-09-25T15:07:28Z", "message": "town_bankruptsy - some merge fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c06b57ec4854bc6593c20357420b7da3a3e1455", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/3c06b57ec4854bc6593c20357420b7da3a3e1455", "committedDate": "2020-09-25T15:14:30Z", "message": "town bankruptsy - fixes around isOpen/db/bankruptsy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6941181846267a99f5e7e3c92bd14a87ad038865", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/6941181846267a99f5e7e3c92bd14a87ad038865", "committedDate": "2020-09-25T15:15:19Z", "message": "town_bankruptsy removed dev artefact"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "224cf6de67eb113d96ff1452f606ec70edaba8e7", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/224cf6de67eb113d96ff1452f606ec70edaba8e7", "committedDate": "2020-09-25T15:16:13Z", "message": "town_bankruptsy some fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f351d183f106aa01fabbc39c0524e27a680ef69", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/7f351d183f106aa01fabbc39c0524e27a680ef69", "committedDate": "2020-09-25T15:17:16Z", "message": "town_bankruptsy bug fix w nation costs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e689054c1236c1a7620da023ebcc9493314981ac", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/e689054c1236c1a7620da023ebcc9493314981ac", "committedDate": "2020-09-25T15:18:48Z", "message": "fixes related to debt & bankruptcy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ad36cacd16bf9aecd892384d21f688ce6f689bf", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/9ad36cacd16bf9aecd892384d21f688ce6f689bf", "committedDate": "2020-09-25T15:19:40Z", "message": "town bankr. - added util method for est. town val."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "295e7d76abe81cd66db619e82d8743b3cdb230b3", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/295e7d76abe81cd66db619e82d8743b3cdb230b3", "committedDate": "2020-09-25T15:20:42Z", "message": "Add fixes from goosius' branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5b5fdf4b0b56cd80ee59e570094c31f61590444", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/b5b5fdf4b0b56cd80ee59e570094c31f61590444", "committedDate": "2020-09-25T15:22:20Z", "message": "Cleanup/Territory renameRemove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7a9538232316686447c9dd846f98e9da90b3a4c", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/b7a9538232316686447c9dd846f98e9da90b3a4c", "committedDate": "2020-09-25T15:22:48Z", "message": "Fix tag issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76dc4d087fa23d22576300479e16f5155e50dc28", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/76dc4d087fa23d22576300479e16f5155e50dc28", "committedDate": "2020-09-25T15:23:47Z", "message": "Fix tne account name issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1c3ec358d502c9590435925c7ef00608a9b353e", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/b1c3ec358d502c9590435925c7ef00608a9b353e", "committedDate": "2020-09-25T15:25:44Z", "message": "Add initial proper eco bank support."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f8aa8f82cd32fc484f1be462e6420206e249ae7", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/4f8aa8f82cd32fc484f1be462e6420206e249ae7", "committedDate": "2020-09-25T15:28:22Z", "message": "Revert \"Add initial proper eco bank support.\"\n\nThis reverts commit 9c838ae8"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7933c13bd53731b38e79a5f84edaff7224c75149", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/7933c13bd53731b38e79a5f84edaff7224c75149", "committedDate": "2020-09-25T15:29:53Z", "message": "Polish it up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5cfbe3c6ddeab26e5ac7def049f7e9cddd7cc4d", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/a5cfbe3c6ddeab26e5ac7def049f7e9cddd7cc4d", "committedDate": "2020-09-25T15:31:24Z", "message": "Refactor things that are useless and/or serve no purpose, and adjust naming."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec2a51e5a026be6d2858a1b04914c9f62ccb85b4", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/ec2a51e5a026be6d2858a1b04914c9f62ccb85b4", "committedDate": "2020-09-25T15:32:21Z", "message": "Fix this thang."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4253c37202c2ea5c8f000708b098913abc68077", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/a4253c37202c2ea5c8f000708b098913abc68077", "committedDate": "2020-09-25T15:35:36Z", "message": "Update comparators for government types."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "772dcfa7296999f7bb85e5cb3f50e32ac8b416b4", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/772dcfa7296999f7bb85e5cb3f50e32ac8b416b4", "committedDate": "2020-09-25T15:36:03Z", "message": "Fix possible EconomyAccount deadlock issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad4829fcbd25beb7ab6599dc5f634d55e4d87775", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/ad4829fcbd25beb7ab6599dc5f634d55e4d87775", "committedDate": "2020-09-25T15:38:15Z", "message": "Fixing merge issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4355838be06fcdefe110d28d97e2505d1aa07d00", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/4355838be06fcdefe110d28d97e2505d1aa07d00", "committedDate": "2020-09-25T15:39:16Z", "message": "town bankruptcy - fixing merge issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cc9cea17bad8b73f9c15b8b9abb0bd0e054ab01", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/0cc9cea17bad8b73f9c15b8b9abb0bd0e054ab01", "committedDate": "2020-09-25T15:40:03Z", "message": "town_bankruptcy - minor cleanups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c321b97be86414a611f779f859fa36bc5f2a2963", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/c321b97be86414a611f779f859fa36bc5f2a2963", "committedDate": "2020-09-25T15:42:49Z", "message": "town bankruptcy - minor cleanups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "246704fd9a851a29f3d5a15bfe700bc05269fc92", "author": {"user": null}, "url": "https://github.com/TownyAdvanced/Towny/commit/246704fd9a851a29f3d5a15bfe700bc05269fc92", "committedDate": "2020-09-25T15:43:57Z", "message": "town_bankruptcy - added open set when bankrupt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97e2b629133a95c0fb1993abc9ebff9a64a70d3f", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/97e2b629133a95c0fb1993abc9ebff9a64a70d3f", "committedDate": "2020-09-25T15:45:22Z", "message": "Replace deprecated TownySettings#getLangString() calls."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89cad2578b1045fce92593023276c5d9877be5b3", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/89cad2578b1045fce92593023276c5d9877be5b3", "committedDate": "2020-09-25T15:47:40Z", "message": "Make requested changes.\n\n- New config node moved to economy section/townysettings adjusted.\n\n- rename fallenTowns to delinquentTowns in DailyTimerTask.\n\n- Undo spacing & variable name changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "329a4f68e362c0d62604643def14acc722bb5844", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/329a4f68e362c0d62604643def14acc722bb5844", "committedDate": "2020-09-25T15:49:00Z", "message": "Further changes:\n\n- Adds town#isBankrupt().\n\n- Fixes upkeep missing from town status screen when bankrupted.\n\n- Adds outposts to MoneyUtil#getEstimatedValueOfTown()\n\n- Set TownCommand tests to use town#isBankrupt()."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ea1424394d8833f6a6db7dd6a547338c998d4bf", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/1ea1424394d8833f6a6db7dd6a547338c998d4bf", "committedDate": "2020-09-25T15:51:14Z", "message": "Make indebted towns not pay nation tax.\n\n - New config option:\neconomy.bankruptcy.do_bankrupt_towns_pay_nation_tax\n   - default: false\n   - Will bankrupt towns pay their nation tax?\n   - If false towns that are bankrupt will not pay any nation tax and\nwill leave their nation.\n   - If true the town will go into debt up until their debt cap is\nreached.\n   - True is recommended when using a Siege War style war/conquering\nsystem, otherwise conquered towns will be able to leave the nation\nsimply by not paying the nation tax.\n   - False is recommended otherwise so that nations are not using\nabandoned towns to gather taxes.\n\ntodo:\n - Test new setting,\n - Test when nations are allowed to take tax from bankrupt towns.\n   - Namely: when a town is not bankrupt but will not be able to fully\npay the nation tax."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c644432a7dc4151ce12d2c6032b589aee03c27b", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/6c644432a7dc4151ce12d2c6032b589aee03c27b", "committedDate": "2020-09-25T17:02:58Z", "message": "Fix disparities missed in rebase."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b11332a455f281e982655fe058d1562a1e6cbd", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/78b11332a455f281e982655fe058d1562a1e6cbd", "committedDate": "2020-09-25T17:04:27Z", "message": "Missed deprecated translation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54d8ad14283a84524f73ae4aa81d02e2836bbbfc", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/54d8ad14283a84524f73ae4aa81d02e2836bbbfc", "committedDate": "2020-09-25T20:56:04Z", "message": "Improvements\n\n  - Remove siege_ from language strings.\n  - Condense ignored exceptions in playercacheutil.\n  - Start of dailytimertask redundancy removal.\n\n\nTODO: likely more cleaning in the dailytimertask."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3b3a083707476c0370bc3fcea416965c5baf6c7", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/b3b3a083707476c0370bc3fcea416965c5baf6c7", "committedDate": "2020-09-26T02:30:37Z", "message": "Bankruptcy commit:\n\n - Adds language files for missing things, changes one to accomodate a\nslug to make it reusable in consolidated messaging code.\n - Add newline to beginning of bankruptcy section.\n - Fix debtcap not discounting homeblock from claims price.\n - Fix dailytimertask changing nationtax to take up the full debtcap.\n - Reorder dailertimertask to reduce redundancy.\n\n\nTODO:\n - Set towns to not pay their upkeep past their debtcap.\n - Add config setting to delete towns which have no room in their\ndebtcap to pay upkeep costs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e9f112c9f94e34a25db10e35d2496666ee636d4", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/7e9f112c9f94e34a25db10e35d2496666ee636d4", "committedDate": "2020-09-26T14:34:02Z", "message": "Bankruptcy Commit:\n\n - Commit adds more config nodes to further flesh out upkeep settings,\ndebt cap settings.\n   - Maximum debt cap to lower a town's debt cap if their calculated\ndebt cap would be very very high.\n   - Override debt cap to make all towns on the server have one fixed\ndebt cap.\n   - Config options to kick towns from a nation when their debt cap is\nreached & to delete towns when their debt cap is reached and they cannot\npay their upkeep with debt.\n\n - New Config Nodes so far: (For the eventual changelog)\n\n   - New Config Option: economy.bankruptcy.enabled\n    - default: false\n    - If this setting is true, then if a town runs out of money (due to\nupkeep, nation tax etc.), it does not get deleted, but instead goes into\na 'bankrupt state'.\n    - While bankrupt, the town bank account is in debt, and the town\ncannot expand (e.g claim, recruit, or build).\n    - The debt has a ceiling equal to the estimated value of the town\n(from new town and claims costs.)\n    - The debt can be repaid using /t deposit x.\n    - Once all debt is repaid, the town immediately returns to a normal\nstate.\n\n  - New Config Option: economy.bankruptcy.debt_cap.maximum\n    - default: 0.0\n    - When set to greater than 0.0, this will be used to determine every\ntown''s maximum debt overriding the above calculation if the calculation\nwould be larger than the set maximum.\n\n  - New Config Option: economy.bankruptcy.debt_cap.override\n    - default: 0.0\n    - When set to greater than 0.0, this setting will override all other\ndebt calculations and maximums, making all towns have the same debt cap.\n\n  - New Config Option:\neconomy.bankruptcy.upkeep.delete_towns_that_reach_debt_cap\n    - default: false\n    - If a town has reached their debt cap and is unable to pay the\nupkeep with debt, will Towny delete them?\n\n  - New Config Option:\neconomy.bankruptcy.nation_tax.do_bankrupt_towns_pay_nation_tax\n    - default: false\n    - Will bankrupt towns pay their nation tax?\n    - If false towns that are bankrupt will not pay any nation tax and\nwill leave their nation.\n    - If true the town will go into debt up until their debt cap is\nreached.\n    - True is recommended when using a Siege War style war/conquering\nsystem, otherwise conquered towns will be able to leave the nation\nsimply by not paying the nation tax.\n    - False is recommended otherwise so that nations are not using\nabandoned towns to gather taxes.\n\n  - New Config Option:\neconomy.bankruptcy.nation_tax.kick_towns_that_reach_debt_cap\n    - default: false\n    - If a town can no longer pay their nation tax with debt because\nthey have reach their debtcap, are they kicked from the nation?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a30f9b4066c3800ea6948b66c7f38b3037cae77", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/7a30f9b4066c3800ea6948b66c7f38b3037cae77", "committedDate": "2020-09-26T17:59:01Z", "message": "Bankruptcy Commit:\n\n - Tested and corrected tax/upkeep amounts not playing nicely with the\ndebt caps.\n - Added some language strings.\n - Removed redundant TownyUniverse variables from DailyTimerTask.\n - Made towns and nations see what taxes/upkeeps they are paying.\n\n\nTODO: Nothing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDIyOTIy", "url": "https://github.com/TownyAdvanced/Towny/pull/4340#pullrequestreview-497022922", "createdAt": "2020-09-26T18:31:07Z", "commit": {"oid": "7a30f9b4066c3800ea6948b66c7f38b3037cae77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxODozMTowN1rOHYh4Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxODozMTowN1rOHYh4Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ4Mjk0Mw==", "bodyText": "This conditional can be reduced to if (!TownySettings.isTownBankruptcyEnabled() || !TownySettings.doBankruptTownsPayNationTax()) Since you check first if bankruptcy is not enabled, then the only time doBankruptTownsPayNationTax will be checked is if that first conditional is false, and that means bankruptcy has to be enabled.", "url": "https://github.com/TownyAdvanced/Towny/pull/4340#discussion_r495482943", "createdAt": "2020-09-26T18:31:07Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/towny/tasks/DailyTimerTask.java", "diffHunk": "@@ -206,23 +201,69 @@ protected void collectNationTaxes(Nation nation) throws EconomyException {\n \t\t\t\t * exists.\r\n \t\t\t\t * We are running in an Async thread so MUST verify all objects.\r\n \t\t\t\t */\r\n-\t\t\t\tif (townyUniverse.getDataSource().hasTown(town.getName())) {\r\n+\t\t\t\tif (universe.getDataSource().hasTown(town.getName())) {\r\n \t\t\t\t\tif (town.isCapital() || !town.hasUpkeep())\r\n \t\t\t\t\t\tcontinue;\r\n-\t\t\t\t\tif (!town.getAccount().payTo(nation.getTaxes(), nation, \"Nation Tax\")) {\r\n-\t\t\t\t\t\tlocalRemovedTowns.add(town.getName());\t\t\r\n-\t\t\t\t\t\ttown.removeNation();\r\n+\t\t\t\t\tif (town.getAccount().canPayFromHoldings(taxAmount)) {\r\n+\t\t\t\t\t// Town is able to pay the nation's tax.\r\n+\t\t\t\t\t\ttown.getAccount().payTo(taxAmount, nation, \"Nation Tax to \" + nation.getName());\r\n+\t\t\t\t\t\tTownyMessaging.sendPrefixedTownMessage(town, Translation.of(\"msg_payed_nation_tax\", TownyEconomyHandler.getFormattedBalance(taxAmount)));\r\n \t\t\t\t\t} else {\r\n-\t\t\t\t\t\tTownyMessaging.sendPrefixedTownMessage(town, TownySettings.getPayedTownTaxMsg() + nation.getTaxes());\r\n+\t\t\t\t\t// Town is unable to pay the nation's tax.\r\n+\t\t\t\t\t\tif (!TownySettings.isTownBankruptcyEnabled() || (TownySettings.isTownBankruptcyEnabled() && !TownySettings.doBankruptTownsPayNationTax())) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a30f9b4066c3800ea6948b66c7f38b3037cae77"}, "originalPosition": 170}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDIyOTk2", "url": "https://github.com/TownyAdvanced/Towny/pull/4340#pullrequestreview-497022996", "createdAt": "2020-09-26T18:32:45Z", "commit": {"oid": "7a30f9b4066c3800ea6948b66c7f38b3037cae77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxODozMjo0NVrOHYh4qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxODozMjo0NVrOHYh4qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ4MzA0OA==", "bodyText": "I would put this line after the if-statement below since it's not used in that statement below.", "url": "https://github.com/TownyAdvanced/Towny/pull/4340#discussion_r495483048", "createdAt": "2020-09-26T18:32:45Z", "author": {"login": "silverwolfg11"}, "path": "src/com/palmergames/bukkit/towny/tasks/DailyTimerTask.java", "diffHunk": "@@ -206,23 +201,69 @@ protected void collectNationTaxes(Nation nation) throws EconomyException {\n \t\t\t\t * exists.\r\n \t\t\t\t * We are running in an Async thread so MUST verify all objects.\r\n \t\t\t\t */\r\n-\t\t\t\tif (townyUniverse.getDataSource().hasTown(town.getName())) {\r\n+\t\t\t\tif (universe.getDataSource().hasTown(town.getName())) {\r\n \t\t\t\t\tif (town.isCapital() || !town.hasUpkeep())\r\n \t\t\t\t\t\tcontinue;\r\n-\t\t\t\t\tif (!town.getAccount().payTo(nation.getTaxes(), nation, \"Nation Tax\")) {\r\n-\t\t\t\t\t\tlocalRemovedTowns.add(town.getName());\t\t\r\n-\t\t\t\t\t\ttown.removeNation();\r\n+\t\t\t\t\tif (town.getAccount().canPayFromHoldings(taxAmount)) {\r\n+\t\t\t\t\t// Town is able to pay the nation's tax.\r\n+\t\t\t\t\t\ttown.getAccount().payTo(taxAmount, nation, \"Nation Tax to \" + nation.getName());\r\n+\t\t\t\t\t\tTownyMessaging.sendPrefixedTownMessage(town, Translation.of(\"msg_payed_nation_tax\", TownyEconomyHandler.getFormattedBalance(taxAmount)));\r\n \t\t\t\t\t} else {\r\n-\t\t\t\t\t\tTownyMessaging.sendPrefixedTownMessage(town, TownySettings.getPayedTownTaxMsg() + nation.getTaxes());\r\n+\t\t\t\t\t// Town is unable to pay the nation's tax.\r\n+\t\t\t\t\t\tif (!TownySettings.isTownBankruptcyEnabled() || (TownySettings.isTownBankruptcyEnabled() && !TownySettings.doBankruptTownsPayNationTax())) {\r\n+\t\t\t\t\t\t// Bankruptcy disabled, remove town for not paying nation tax, \r\n+\t\t\t\t\t\t// OR Bankruptcy enabled but towns aren't allowed to use debt to pay nation tax. \r\n+\t\t\t\t\t\t\tlocalNewlyDelinquentTowns.add(town.getName());\t\t\r\n+\t\t\t\t\t\t\ttown.removeNation();\r\n+\t\t\t\t\t\t\tTownyMessaging.sendPrefixedTownMessage(town, Translation.of(\"msg_your_town_couldnt_pay_the_nation_tax_of\", TownyEconomyHandler.getFormattedBalance(taxAmount)));\r\n+\t\t\t\t\t\t\tcontinue;\r\n+\t\t\t\t\t\t}\r\n+\r\n+\t\t\t\t\t\t// Bankruptcy enabled and towns are allowed to use debt to pay nation tax.\r\n+\t\t\t\t\t\tboolean townWasBankrupt = town.isBankrupt();\r\n+\t\t\t\t\t\ttown.getAccount().setDebtCap(MoneyUtil.getEstimatedValueOfTown(town));\r\n+\t\t\t\t\t\t\r\n+\t\t\t\t\t\tif (town.getAccount().getHoldingBalance() - taxAmount < town.getAccount().getDebtCap() * -1) {\r\n+\t\t\t\t\t\t// Towns that would go over their debtcap to pay nation tax, need the amount they pay reduced to what their debt cap can cover.\r\n+\t\t\t\t\t\t// This will result in towns that become fully indebted paying 0 nation tax eventually.\r\n+\t\t\t\t\t\t\ttaxAmount = town.getAccount().getDebtCap() - Math.abs(town.getAccount().getHoldingBalance());\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a30f9b4066c3800ea6948b66c7f38b3037cae77"}, "originalPosition": 186}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "926d5824bcc5ca053bb6d35bad2054a3507cab4f", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/926d5824bcc5ca053bb6d35bad2054a3507cab4f", "committedDate": "2020-09-26T18:59:56Z", "message": "Bankruptcy Commit:\n\n  - Make requested changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d995d95d9f4c29b14c0f4dc1c2721a7e4a31bc40", "author": {"user": {"login": "LlmDl", "name": null}}, "url": "https://github.com/TownyAdvanced/Towny/commit/d995d95d9f4c29b14c0f4dc1c2721a7e4a31bc40", "committedDate": "2020-09-27T18:17:06Z", "message": "Merge branch 'master' into town_bankruptcy_rebase"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4193, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}