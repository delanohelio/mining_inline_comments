{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzMzk0OTgx", "number": 3252, "title": "Check for valid signature on attestations once", "bodyText": "PR Description\nCheck for valid signature on attestations only once\nFixed Issue(s)\n\n\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-18T18:40:56Z", "url": "https://github.com/ConsenSys/teku/pull/3252", "merged": true, "mergeCommit": {"oid": "16a0bc8e0b0d421a4e98d536409227ab57fafd53"}, "closed": true, "closedAt": "2020-11-19T00:16:48Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddyk-qgH2gAyNTIzMzk0OTgxOjRkN2VhZjMyYTQyOWMxYThhMjI0NzEyMjc2YjE4ZmM4OGQ3MTQ3NjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd3RtvAH2gAyNTIzMzk0OTgxOjM0ZDA0MGUzMzg2MTk1OTBiZWE5OTI2NzZhMDRhOWZjOTE5MGU1NjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4d7eaf32a429c1a8a224712276b18fc88d714760", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/4d7eaf32a429c1a8a224712276b18fc88d714760", "committedDate": "2020-11-18T18:36:41Z", "message": "Check for valid signature on attestations once"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODAyMTM2", "url": "https://github.com/ConsenSys/teku/pull/3252#pullrequestreview-533802136", "createdAt": "2020-11-18T19:27:45Z", "commit": {"oid": "4d7eaf32a429c1a8a224712276b18fc88d714760"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOToyNzo0NlrOH1-lmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOToyNzo0NlrOH1-lmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2MjAwOQ==", "bodyText": "I thought we needed to set this when we check the signatures in AttestationValidator and AggregateAttestationValidator from AttestationManager", "url": "https://github.com/ConsenSys/teku/pull/3252#discussion_r526362009", "createdAt": "2020-11-18T19:27:46Z", "author": {"login": "mbaxter"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/ForkChoiceUtil.java", "diffHunk": "@@ -434,6 +440,7 @@ private static AttestationProcessingResult indexAndValidateAttestation(\n     return is_valid_indexed_attestation(targetState, indexedAttestation)\n         .ifSuccessful(\n             () -> {\n+              attestation.setValidIndexedAttestation();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d7eaf32a429c1a8a224712276b18fc88d714760"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "996a68046c95310f3d7577d01d78c299545ad3e6", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/996a68046c95310f3d7577d01d78c299545ad3e6", "committedDate": "2020-11-18T19:35:54Z", "message": "Set valid indexed attestation at first check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODI1OTY3", "url": "https://github.com/ConsenSys/teku/pull/3252#pullrequestreview-533825967", "createdAt": "2020-11-18T19:58:45Z", "commit": {"oid": "996a68046c95310f3d7577d01d78c299545ad3e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTo1ODo0NlrOH1_vSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxOTo1ODo0NlrOH1_vSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM4MDg3NQ==", "bodyText": "Would is make sense to pass the ValidatableAttestation to a new version of is_valid_indexed_attestation?  This new method could return early if the isValidIndexedAttestation is already set, and otherwise delegate to the existing method that accepts the plain attestation, then set isValidIndexedAttestation.", "url": "https://github.com/ConsenSys/teku/pull/3252#discussion_r526380875", "createdAt": "2020-11-18T19:58:46Z", "author": {"login": "mbaxter"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/validation/AttestationValidator.java", "diffHunk": "@@ -186,6 +186,8 @@ private InternalValidationResult singleAttestationChecks(final Attestation attes\n               if (!is_valid_indexed_attestation(state, indexedAttestation).isSuccessful()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "996a68046c95310f3d7577d01d78c299545ad3e6"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a292950f78fdaa4026244615f931fd715601a070", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/a292950f78fdaa4026244615f931fd715601a070", "committedDate": "2020-11-18T20:14:44Z", "message": "Incorporate feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODUxNzM5", "url": "https://github.com/ConsenSys/teku/pull/3252#pullrequestreview-533851739", "createdAt": "2020-11-18T20:32:36Z", "commit": {"oid": "a292950f78fdaa4026244615f931fd715601a070"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDozMjozNlrOH2BBmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDozMjozNlrOH2BBmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQwMTk0Ng==", "bodyText": "Instead of short-circuiting here, I think you can just use the new is_valid_indexed_attestation method in indexAndValidateAttestation", "url": "https://github.com/ConsenSys/teku/pull/3252#discussion_r526401946", "createdAt": "2020-11-18T20:32:36Z", "author": {"login": "mbaxter"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/ForkChoiceUtil.java", "diffHunk": "@@ -385,7 +385,13 @@ public static AttestationProcessingResult on_attestation(\n     Attestation attestation = validateableAttestation.getAttestation();\n \n     return validateOnAttestation(store, attestation, forkChoiceStrategy)\n-        .ifSuccessful(() -> indexAndValidateAttestation(validateableAttestation, maybeTargetState))\n+        .ifSuccessful(\n+            () -> {\n+              if (validateableAttestation.isValidIndexedAttestation()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a292950f78fdaa4026244615f931fd715601a070"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "582bda4f5f7b528aa27e96454b00de0bd140460c", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/582bda4f5f7b528aa27e96454b00de0bd140460c", "committedDate": "2020-11-18T20:41:53Z", "message": "Use the new method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODYyNzM4", "url": "https://github.com/ConsenSys/teku/pull/3252#pullrequestreview-533862738", "createdAt": "2020-11-18T20:48:08Z", "commit": {"oid": "582bda4f5f7b528aa27e96454b00de0bd140460c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo0ODowOFrOH2BidQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDo0ODowOFrOH2BidQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxMDM1Nw==", "bodyText": "Looks like you can cut indexAndValidateAttestation altogether now.  Just wondering if we need the call to attestation.saveCommitteeShufflingSeed(targetState); that's in that method?", "url": "https://github.com/ConsenSys/teku/pull/3252#discussion_r526410357", "createdAt": "2020-11-18T20:48:08Z", "author": {"login": "mbaxter"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/ForkChoiceUtil.java", "diffHunk": "@@ -385,7 +385,15 @@ public static AttestationProcessingResult on_attestation(\n     Attestation attestation = validateableAttestation.getAttestation();\n \n     return validateOnAttestation(store, attestation, forkChoiceStrategy)\n-        .ifSuccessful(() -> indexAndValidateAttestation(validateableAttestation, maybeTargetState))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "582bda4f5f7b528aa27e96454b00de0bd140460c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2a5d2f9b3a85010e7d9d4dffda071694f358752", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/b2a5d2f9b3a85010e7d9d4dffda071694f358752", "committedDate": "2020-11-18T21:14:26Z", "message": "Save shuffling seed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d497a0d546193b62fea703823fe020bc2195d6cf", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/d497a0d546193b62fea703823fe020bc2195d6cf", "committedDate": "2020-11-18T21:24:15Z", "message": "Remove unused method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d9e4dfdf6fd660a8c1160e1ba4752ac3a089c62", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/2d9e4dfdf6fd660a8c1160e1ba4752ac3a089c62", "committedDate": "2020-11-18T21:27:42Z", "message": "Remove unused logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae17b6f8bd38e3fc800134debc8254b5fe2ae37a", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/ae17b6f8bd38e3fc800134debc8254b5fe2ae37a", "committedDate": "2020-11-18T21:27:57Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a07e6b762a93760136d6c53860591ade156c7ae9", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/a07e6b762a93760136d6c53860591ade156c7ae9", "committedDate": "2020-11-18T22:46:38Z", "message": "Reinstate try catch block"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTQ2MTk3", "url": "https://github.com/ConsenSys/teku/pull/3252#pullrequestreview-533946197", "createdAt": "2020-11-18T22:49:59Z", "commit": {"oid": "a07e6b762a93760136d6c53860591ade156c7ae9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjo0OTo1OVrOH2Fiag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMjo0OTo1OVrOH2Fiag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ3NTg4Mg==", "bodyText": "(nit) Might be a little cleaner to move this try / catch into is_valid_indexed_attestation", "url": "https://github.com/ConsenSys/teku/pull/3252#discussion_r526475882", "createdAt": "2020-11-18T22:49:59Z", "author": {"login": "mbaxter"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/ForkChoiceUtil.java", "diffHunk": "@@ -385,7 +383,20 @@ public static AttestationProcessingResult on_attestation(\n     Attestation attestation = validateableAttestation.getAttestation();\n \n     return validateOnAttestation(store, attestation, forkChoiceStrategy)\n-        .ifSuccessful(() -> indexAndValidateAttestation(validateableAttestation, maybeTargetState))\n+        .ifSuccessful(\n+            () -> {\n+              if (maybeTargetState.isEmpty()) {\n+                return AttestationProcessingResult.UNKNOWN_BLOCK;\n+              } else {\n+                try {\n+                  return is_valid_indexed_attestation(\n+                      maybeTargetState.get(), validateableAttestation);\n+                } catch (IllegalArgumentException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a07e6b762a93760136d6c53860591ade156c7ae9"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "860e72cd8d52a7cf26822d374fac90204caacd9c", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/860e72cd8d52a7cf26822d374fac90204caacd9c", "committedDate": "2020-11-19T00:01:54Z", "message": "Have smaller scoped try/catch block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e3910168b5fabb8331bbef7c0aa8a303e145240", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/5e3910168b5fabb8331bbef7c0aa8a303e145240", "committedDate": "2020-11-19T00:02:24Z", "message": "Merge branch 'master' into deduplicateSignatureChecking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34d040e338619590bea992676a04a9fc9190e565", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/34d040e338619590bea992676a04a9fc9190e565", "committedDate": "2020-11-19T00:05:10Z", "message": "Remove unused variable."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3211, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}