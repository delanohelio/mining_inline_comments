{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0OTIxMDIw", "number": 2320, "title": "Add persistent subnets list to discovery peer", "bodyText": "PR Description\nAdd persistent subnets list to discovery peer in preparation for #1963\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-07-06T17:55:11Z", "url": "https://github.com/ConsenSys/teku/pull/2320", "merged": true, "mergeCommit": {"oid": "3e9bc8a369b3a40383d0535183e8bb51ec0e723b"}, "closed": true, "closedAt": "2020-07-08T03:12:45Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyU-7iAH2gAyNDQ0OTIxMDIwOjg3ZDllYWU0MDQzYzNkYjljZGJlM2YwMTk3NWUyZWMwZmMwNDA2ZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyxctSAH2gAyNDQ0OTIxMDIwOjExZjM0OWM5OGU4MjI1NTE1MmI4ZTNiYTM1ZDY4N2E4YjMwZjU0MWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "87d9eae4043c3db9cdbe3f01975e2ec0fc0406e5", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/87d9eae4043c3db9cdbe3f01975e2ec0fc0406e5", "committedDate": "2020-07-06T17:49:08Z", "message": "Add persistent subnets list to DiscoveryPeer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d69b28cb791c5708555207faf49933ab7139ec6f", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/d69b28cb791c5708555207faf49933ab7139ec6f", "committedDate": "2020-07-06T17:52:38Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "565d1e4ac50af748affb3c3e782d35f2b8288691", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/565d1e4ac50af748affb3c3e782d35f2b8288691", "committedDate": "2020-07-06T19:25:22Z", "message": "Merge branch 'master' into addPersistentSubnetsListToDiscoveryPeer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDMyOTYx", "url": "https://github.com/ConsenSys/teku/pull/2320#pullrequestreview-443432961", "createdAt": "2020-07-06T21:56:58Z", "commit": {"oid": "565d1e4ac50af748affb3c3e782d35f2b8288691"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMTo1Njo1OFrOGtoYUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMTo1Njo1OFrOGtoYUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUwMDY4OQ==", "bodyText": "I think it's probably better to just use an empty list if the attribute is not present rather than having an Optional<List>.  Not advertising any persistent subnets is effectively the same as not having any.\nAlso it would probably be better to stick with the Bitvector rather than converting to List<Integer> the most common thing we'll do is check for a specific value which in a List means iterating through every item but is as single lookup in a Bitvector.", "url": "https://github.com/ConsenSys/teku/pull/2320#discussion_r450500689", "createdAt": "2020-07-06T21:56:58Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/discovery/DiscoveryPeer.java", "diffHunk": "@@ -14,21 +14,28 @@\n package tech.pegasys.teku.networking.p2p.discovery;\n \n import com.google.common.base.MoreObjects;\n+import com.google.common.base.Objects;\n import java.net.InetSocketAddress;\n-import java.util.Objects;\n+import java.util.List;\n import java.util.Optional;\n import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.teku.datastructures.networking.libp2p.rpc.EnrForkId;\n \n public class DiscoveryPeer {\n   private final Bytes publicKey;\n   private final InetSocketAddress nodeAddress;\n-  private final Optional<Bytes> enrForkId;\n+  private final Optional<EnrForkId> enrForkId;\n+  private final Optional<List<Integer>> persistentSubnets;\n \n   public DiscoveryPeer(\n-      final Bytes publicKey, final InetSocketAddress nodeAddress, final Optional<Bytes> enrForkId) {\n+      final Bytes publicKey,\n+      final InetSocketAddress nodeAddress,\n+      final Optional<EnrForkId> enrForkId,\n+      final Optional<List<Integer>> persistentSubnets) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "565d1e4ac50af748affb3c3e782d35f2b8288691"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca9a5b6ed03acbb33c81a945525e1f2141b7acc6", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/ca9a5b6ed03acbb33c81a945525e1f2141b7acc6", "committedDate": "2020-07-07T15:02:17Z", "message": "Use Bitvectors for persistent subnets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03fa7915b47535ca7917cd626c01b62404a8a331", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/03fa7915b47535ca7917cd626c01b62404a8a331", "committedDate": "2020-07-07T16:58:30Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into addPersistentSubnetsListToDiscoveryPeer\n\n# Conflicts:\n#\tnetworking/p2p/src/test/java/tech/pegasys/teku/networking/p2p/discovery/ConnectionManagerTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2da97ae603e83e3d4e5ba01b05b8f43680a9a336", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/2da97ae603e83e3d4e5ba01b05b8f43680a9a336", "committedDate": "2020-07-07T16:59:17Z", "message": "Run spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MjgzNDIx", "url": "https://github.com/ConsenSys/teku/pull/2320#pullrequestreview-444283421", "createdAt": "2020-07-07T22:06:37Z", "commit": {"oid": "2da97ae603e83e3d4e5ba01b05b8f43680a9a336"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjowNjozN1rOGuRTFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjowNjozN1rOGuRTFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3MTA5Mg==", "bodyText": "This may throw an IllegalArgumentException if the bytes are not the right length.", "url": "https://github.com/ConsenSys/teku/pull/2320#discussion_r451171092", "createdAt": "2020-07-07T22:06:37Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/discovery/discv5/NodeRecordConverter.java", "diffHunk": "@@ -29,9 +36,19 @@\n \n   private static DiscoveryPeer socketAddressToDiscoveryPeer(\n       final NodeRecord nodeRecord, final InetSocketAddress address) {\n+\n+    Optional<EnrForkId> enrForkId =\n+        Optional.ofNullable((Bytes) nodeRecord.get(ETH2_ENR_FIELD))\n+            .map(enrField -> SimpleOffsetSerializer.deserialize(enrField, EnrForkId.class));\n+\n+    Bitvector persistentSubnets =\n+        Optional.ofNullable((Bytes) nodeRecord.get(ATTESTATION_SUBNET_ENR_FIELD))\n+            .map(\n+                attestionSubnetsField ->\n+                    Bitvector.fromBytes(attestionSubnetsField, ATTESTATION_SUBNET_COUNT))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da97ae603e83e3d4e5ba01b05b8f43680a9a336"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e426e910b2fb7ad804dbb837b0d82f6f57347faf", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e426e910b2fb7ad804dbb837b0d82f6f57347faf", "committedDate": "2020-07-08T02:57:27Z", "message": "Handle parse errors for ENR fields."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11f349c98e82255152b8e3ba35d687a8b30f541a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/11f349c98e82255152b8e3ba35d687a8b30f541a", "committedDate": "2020-07-08T02:59:00Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into addPersistentSubnetsListToDiscoveryPeer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3809, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}