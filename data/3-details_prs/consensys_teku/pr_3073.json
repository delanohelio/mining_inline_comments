{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5Njc2NjUx", "number": 3073, "title": "If the requested slot is empty, get the block header for the latest block.", "bodyText": "Previously an empty head slot would result in a 404 (not found) error.\n\n\nIt was possible for the slot of the finalized epoch to be empty, which would result in 404.\n\n\nfixes #3071\nSigned-off-by: Paul Harris paul.harris@consensys.net\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-25T22:47:03Z", "url": "https://github.com/ConsenSys/teku/pull/3073", "merged": true, "mergeCommit": {"oid": "38da4ec1a712c54e5e78e6c23cad3acd6bb297cc"}, "closed": true, "closedAt": "2020-10-27T00:18:19Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWHwH0AH2gAyNTA5Njc2NjUxOmE3MDA2YWYxNjc0MDkxZDkyMjg2MzE4ZWVlYmQ5MGQzZjVjODUxYzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWdg-ZAH2gAyNTA5Njc2NjUxOjZjZTM0YzViNzJhZGJhYzJhZjY5Y2FmODEyMmEzMzc0NmZjODQyNzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7006af1674091d92286318eeebd90d3f5c851c2", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/a7006af1674091d92286318eeebd90d3f5c851c2", "committedDate": "2020-10-25T22:45:28Z", "message": "If the current slot is empty, get the block header for the latest block.\n\n - Previously an empty head slot would result in a 404 (not found) error.\n\n - It was possible for the slot of the finalized epoch to be empty, which would result in 404.\n\n - Retrieval of a specific slot may now result in a different slot being returned by `/eth/v1/beacon/headers/*` endpoints if the numeric requested slot had no block.\n\n - An empty slot will have the block header from the most recent block at that point, complete with the slot it was produced for.\n\n fixes #3071\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8020ba69ef13288062f597710b79e8e6a54f913a", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/8020ba69ef13288062f597710b79e8e6a54f913a", "committedDate": "2020-10-25T22:47:11Z", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13a1018384dfbcaf2207203b7f5426de612d0d73", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/13a1018384dfbcaf2207203b7f5426de612d0d73", "committedDate": "2020-10-26T20:55:30Z", "message": "refactor to factory.\n\nFixed broken regression test\n\nfixes #3069\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTc3MzU0", "url": "https://github.com/ConsenSys/teku/pull/3073#pullrequestreview-517177354", "createdAt": "2020-10-26T21:09:05Z", "commit": {"oid": "13a1018384dfbcaf2207203b7f5426de612d0d73"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTowOTowNVrOHoidHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMToxNjoxNVrOHoisTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2OTU5OQ==", "bodyText": "We could have a default method getSingleBlock in the BlockSelector interface that does this conversion from list to Optional.  Could just do a blockList.stream().findFirst() so simplify it.", "url": "https://github.com/ConsenSys/teku/pull/3073#discussion_r512269599", "createdAt": "2020-10-26T21:09:05Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -196,24 +199,14 @@ public GetForkResponse getForkInfo() {\n       return chainUnavailable();\n     }\n \n-    final Optional<UInt64> maybeSlot = blockParameterToSlot(slotParameter);\n-    if (maybeSlot.isEmpty()) {\n-      return getBlockHeaderByBlockRoot(Bytes32.fromHexString(slotParameter));\n-    }\n-\n-    final UInt64 slot = maybeSlot.get();\n-    return combinedChainDataClient\n-        .getBlockAtSlotExact(slot)\n-        .thenApply(maybeBlock -> maybeBlock.map(block -> new BlockHeader(block, true)));\n-  }\n-\n-  // because this is called after attempting to match a block to a slot, this function\n-  // will only ever be run for non canonical blocks. if made public, it will have to be updated to\n-  // first check that the block doesnt have a slot, before it can make that assumption.\n-  SafeFuture<Optional<BlockHeader>> getBlockHeaderByBlockRoot(final Bytes32 blockRoot) {\n-    return combinedChainDataClient\n-        .getBlockByBlockRoot(blockRoot)\n-        .thenApply(maybeBlock -> maybeBlock.map(block -> new BlockHeader(block, false)));\n+    return defaultBlockSelectorFactory\n+        .defaultBlockSelector(slotParameter)\n+        .getBlock()\n+        .thenApply(\n+            blockList ->\n+                blockList.isEmpty()\n+                    ? Optional.empty()\n+                    : Optional.of(new BlockHeader(blockList.get(0), true)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13a1018384dfbcaf2207203b7f5426de612d0d73"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MDcwMw==", "bodyText": "We shouldn't be expecting this and it probably shouldn't be in this change.  Need to work out why it's being released twice and fix that in a different PR. :)", "url": "https://github.com/ConsenSys/teku/pull/3073#discussion_r512270703", "createdAt": "2020-10-26T21:10:57Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/rpc/core/Eth2OutgoingRequestHandlerTest.java", "diffHunk": "@@ -280,7 +282,7 @@ public void shouldCompleteExceptionallyWhenClosedWithTruncatedMessage() {\n \n     asyncRequestRunner.executeQueuedActions();\n \n-    complete();\n+    assertThrows(IllegalReferenceCountException.class, this::complete);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13a1018384dfbcaf2207203b7f5426de612d0d73"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MzQ4Ng==", "bodyText": "Also I'd have expected the handler to convert the String slotParameter to a BlockSelector and then pass the BlockSelector into this method.  That way the handler is responsible for interpreting the request and the provider has the business logic.  With it this way the provider is interpreting the request and doing the business logic.", "url": "https://github.com/ConsenSys/teku/pull/3073#discussion_r512273486", "createdAt": "2020-10-26T21:16:15Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -196,24 +199,14 @@ public GetForkResponse getForkInfo() {\n       return chainUnavailable();\n     }\n \n-    final Optional<UInt64> maybeSlot = blockParameterToSlot(slotParameter);\n-    if (maybeSlot.isEmpty()) {\n-      return getBlockHeaderByBlockRoot(Bytes32.fromHexString(slotParameter));\n-    }\n-\n-    final UInt64 slot = maybeSlot.get();\n-    return combinedChainDataClient\n-        .getBlockAtSlotExact(slot)\n-        .thenApply(maybeBlock -> maybeBlock.map(block -> new BlockHeader(block, true)));\n-  }\n-\n-  // because this is called after attempting to match a block to a slot, this function\n-  // will only ever be run for non canonical blocks. if made public, it will have to be updated to\n-  // first check that the block doesnt have a slot, before it can make that assumption.\n-  SafeFuture<Optional<BlockHeader>> getBlockHeaderByBlockRoot(final Bytes32 blockRoot) {\n-    return combinedChainDataClient\n-        .getBlockByBlockRoot(blockRoot)\n-        .thenApply(maybeBlock -> maybeBlock.map(block -> new BlockHeader(block, false)));\n+    return defaultBlockSelectorFactory\n+        .defaultBlockSelector(slotParameter)\n+        .getBlock()\n+        .thenApply(\n+            blockList ->\n+                blockList.isEmpty()\n+                    ? Optional.empty()\n+                    : Optional.of(new BlockHeader(blockList.get(0), true)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2OTU5OQ=="}, "originalCommit": {"oid": "13a1018384dfbcaf2207203b7f5426de612d0d73"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b2a5e95587efda449c1cc3bc2ac56c232666374", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/4b2a5e95587efda449c1cc3bc2ac56c232666374", "committedDate": "2020-10-26T22:54:27Z", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55a5b1d8482dc229d4d1c465d7597ce9a0168043", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/55a5b1d8482dc229d4d1c465d7597ce9a0168043", "committedDate": "2020-10-26T23:38:10Z", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5781cd9919a0dfefe04f49c7e03b71fb7775a79f", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/5781cd9919a0dfefe04f49c7e03b71fb7775a79f", "committedDate": "2020-10-26T23:46:05Z", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4055517ca72514dab9dcf522536ac6bb8d6d302", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/b4055517ca72514dab9dcf522536ac6bb8d6d302", "committedDate": "2020-10-26T23:52:10Z", "message": "Merge remote-tracking branch 'upstream/master' into 3071"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MjYwODQ3", "url": "https://github.com/ConsenSys/teku/pull/3073#pullrequestreview-517260847", "createdAt": "2020-10-27T00:06:12Z", "commit": {"oid": "b4055517ca72514dab9dcf522536ac6bb8d6d302"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ce34c5b72adbac2af69caf8122a33746fc84272", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6ce34c5b72adbac2af69caf8122a33746fc84272", "committedDate": "2020-10-27T00:06:50Z", "message": "Merge branch 'master' into 3071"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3263, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}