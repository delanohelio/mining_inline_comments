{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0OTI3MzEz", "number": 1612, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTo1Mjo1M1rODy9EuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTo1Mjo1M1rODy9EuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NzU2MDI0OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/client/RecentChainData.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTo1Mjo1M1rOGHTjig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjoyNTo0MlrOGHe1uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMxMzYxMA==", "bodyText": "nit: A bit of explanation on how getBlockRootBySlot might return a different root at that slot would be nice, since the updating of the canonical chain with the switch to a new bestBlockRoot is a bit implicit.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Get the block root in effect at the old best slot on the new chain\n          \n          \n            \n                // Get the block root in effect at the old best slot on the new chain, which might be different from originalBestRoot due to getBlockRootBySlot potentially using a new chain as the correct fork", "url": "https://github.com/ConsenSys/teku/pull/1612#discussion_r410313610", "createdAt": "2020-04-17T15:52:53Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/client/RecentChainData.java", "diffHunk": "@@ -130,9 +134,22 @@ public Store getStore() {\n    * @param slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {\n+    final Optional<Bytes32> originalBestRoot = bestBlockRoot;\n+    final UnsignedLong originalBestSlot = bestSlot;\n     this.bestBlockRoot = Optional.of(root);\n     this.bestSlot = slot;\n     bestBlockInitialized.complete(null);\n+\n+    if (originalBestRoot.map(original -> isReorg(original, originalBestSlot)).orElse(false)) {\n+      reorgEventChannel.reorgOccurred();\n+    }\n+  }\n+\n+  private boolean isReorg(final Bytes32 originalBestRoot, final UnsignedLong originalBestSlot) {\n+    // Get the block root in effect at the old best slot on the new chain", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "392caf7c31b39f82e3b1994ddd3356d691c0a33c"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5ODQ5MQ==", "bodyText": "Renamed the method and improved the comment to make it clearer.", "url": "https://github.com/ConsenSys/teku/pull/1612#discussion_r410498491", "createdAt": "2020-04-17T22:25:42Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/client/RecentChainData.java", "diffHunk": "@@ -130,9 +134,22 @@ public Store getStore() {\n    * @param slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {\n+    final Optional<Bytes32> originalBestRoot = bestBlockRoot;\n+    final UnsignedLong originalBestSlot = bestSlot;\n     this.bestBlockRoot = Optional.of(root);\n     this.bestSlot = slot;\n     bestBlockInitialized.complete(null);\n+\n+    if (originalBestRoot.map(original -> isReorg(original, originalBestSlot)).orElse(false)) {\n+      reorgEventChannel.reorgOccurred();\n+    }\n+  }\n+\n+  private boolean isReorg(final Bytes32 originalBestRoot, final UnsignedLong originalBestSlot) {\n+    // Get the block root in effect at the old best slot on the new chain", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMxMzYxMA=="}, "originalCommit": {"oid": "392caf7c31b39f82e3b1994ddd3356d691c0a33c"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1656, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}