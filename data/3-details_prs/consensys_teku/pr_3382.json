{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MzU5MTc0", "number": 3382, "title": "SSZ deserialization based on backing tree ViewType", "bodyText": "PR Description\nAs follow up to PR #3062 (which implemented backing tree based ssz serialization) this PR implements tree based ssz deserialization:\n\nadd SSZType.sszDeserializeTree() interface method and its implementations in base structures: basic type, container, list/vector\nspecial deserialization case when SszSuperNode type hint exists\nadd @SszTypeDescriptor annotation to denote static SSZType members to find the type by class when SimpleOffsetSerializer.deserialize() is called. This may be thought of a temporary change and is subject to be removed when legacy ssz is removed\n\nThis PR also significantly speeds up SSZ deserialization: 100K validators BeaconState SSZ is deserialized almost 1000x faster: ~2-4ms instead of 2-3sec\nFixed Issue(s)\nFix #3371\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-12-09T17:57:27Z", "url": "https://github.com/ConsenSys/teku/pull/3382", "merged": true, "mergeCommit": {"oid": "0f83476864cfd4749df41f7581552700043aa52b"}, "closed": true, "closedAt": "2020-12-15T12:13:46Z", "author": {"login": "Nashatyrev"}, "timelineItems": {"totalCount": 68, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiPfHCgH2gAyNTM1MzU5MTc0OmE2Y2M5OTQ1YzkyYWIzZGEzODI1YzdlYmRhODI5NGE0NGNiOGI4MmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmZBX2gH2gAyNTM1MzU5MTc0OjAxNWVhOTBlM2JkYzBlMjE0ZTNhZDk4MmNhOWVjNmM2M2ViOTg1ODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a6cc9945c92ab3da3825c7ebda8294a44cb8b82c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/a6cc9945c92ab3da3825c7ebda8294a44cb8b82c", "committedDate": "2020-12-02T14:33:13Z", "message": "Add SszSuperNode, TypeHints and add a hint to BeaconState.validators to use SszSuperNode in the list backing tree"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2706b50bc8f61bbc661a5d2b90e91d0ee7c96da", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/f2706b50bc8f61bbc661a5d2b90e91d0ee7c96da", "committedDate": "2020-12-02T14:34:59Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e3067f811359e5d37649bb50ccb52e42ef1b0cd", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/6e3067f811359e5d37649bb50ccb52e42ef1b0cd", "committedDate": "2020-12-02T14:36:31Z", "message": "Remove obsolete test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64c96d16d1893afa6b7551cfd902bee25a0a49a8", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/64c96d16d1893afa6b7551cfd902bee25a0a49a8", "committedDate": "2020-12-02T14:55:28Z", "message": "Fix compiler warns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fd6687c3e09993c5dece307e0537f0e10ab994c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/5fd6687c3e09993c5dece307e0537f0e10ab994c", "committedDate": "2020-12-03T12:03:52Z", "message": "Fix TreeNode.toString() for large trees"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e723a951d7d935638c7d6dee0ca1d150ef3bc38", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/4e723a951d7d935638c7d6dee0ca1d150ef3bc38", "committedDate": "2020-12-03T12:05:16Z", "message": "Refactor SszNodeTemplate to be able to return subTemplate and fix SszSuperNode to be able to return subtrees"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9472146f850a9bd93e8729c69476b12d09c1933d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9472146f850a9bd93e8729c69476b12d09c1933d", "committedDate": "2020-12-03T13:41:48Z", "message": "Fix SszSuperNode.hashTreeRoot bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fa04833754c92bd8fd12953fa819d5620200952", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/5fa04833754c92bd8fd12953fa819d5620200952", "committedDate": "2020-12-03T13:47:20Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27e3e5ddab46290d25c9ad570dc8612804aa6dee", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/27e3e5ddab46290d25c9ad570dc8612804aa6dee", "committedDate": "2020-12-03T13:59:35Z", "message": "Remove obsolete test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dd83b358df4a49c8a43cdb256e8c30a36bcdbce", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8dd83b358df4a49c8a43cdb256e8c30a36bcdbce", "committedDate": "2020-12-04T14:50:53Z", "message": "Add test for ListView with TypeHints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57d712306942c530860a4775213fc785d8f9b6c9", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/57d712306942c530860a4775213fc785d8f9b6c9", "committedDate": "2020-12-07T09:26:06Z", "message": "Add equals/hashCode to List/VectorViewRead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66bc0008cfebd67b63386498422cb87b03bfe306", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/66bc0008cfebd67b63386498422cb87b03bfe306", "committedDate": "2020-12-07T16:05:04Z", "message": "Add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b330a1aa59d4672a057b8c757828108b3bcdab52", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/b330a1aa59d4672a057b8c757828108b3bcdab52", "committedDate": "2020-12-07T16:05:49Z", "message": "Refactor SszNodeTemplate to use GeneralizedIndex based map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab9192d84594e4d967704eebcd534dfb1e054c4b", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/ab9192d84594e4d967704eebcd534dfb1e054c4b", "committedDate": "2020-12-07T16:10:35Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01ad85d72c866a5b45115d1ae6917e5907be0ffb", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/01ad85d72c866a5b45115d1ae6917e5907be0ffb", "committedDate": "2020-12-07T16:50:35Z", "message": "Implement optimized SszSuperNode.updated variant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76b5ab5e9cb854f59fd1752d7fc316b53be86805", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/76b5ab5e9cb854f59fd1752d7fc316b53be86805", "committedDate": "2020-12-07T17:22:45Z", "message": "Add javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf8e497a9c6bc7712e57ed115f116bfddf19e504", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/bf8e497a9c6bc7712e57ed115f116bfddf19e504", "committedDate": "2020-12-07T17:25:52Z", "message": "Remove accidentally committed debug code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb9659586403f90447511464e312877134dcd68e", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/eb9659586403f90447511464e312877134dcd68e", "committedDate": "2020-12-07T17:33:03Z", "message": "Fix the LeafDataNode class name and add javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60ea403a35293925bea3ce790607086c52b7abcc", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/60ea403a35293925bea3ce790607086c52b7abcc", "committedDate": "2020-12-07T17:37:09Z", "message": "Minor refactoring of SszNodeTemplate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2881b5fa48b0f51577a2f5de73014910fc598ff9", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/2881b5fa48b0f51577a2f5de73014910fc598ff9", "committedDate": "2020-12-07T18:00:46Z", "message": "Fix javadoc html"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3d07885c2ff6ee726d799eb39df027de952319e", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/b3d07885c2ff6ee726d799eb39df027de952319e", "committedDate": "2020-12-07T18:17:59Z", "message": "Merge branch 'master' into optimize/state-tree-validators"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1554d54345af7929bfeb27c9776afbd68a050251", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/1554d54345af7929bfeb27c9776afbd68a050251", "committedDate": "2020-12-08T17:25:56Z", "message": "Draft temp commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6eec77b174ac25eaf5fad12d24d10cfaa3b51a9", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d6eec77b174ac25eaf5fad12d24d10cfaa3b51a9", "committedDate": "2020-12-08T17:37:30Z", "message": "Add assertion to double check offset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f44ee31e3b8fba63b0a9f61c2a8d92498052c33", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9f44ee31e3b8fba63b0a9f61c2a8d92498052c33", "committedDate": "2020-12-08T17:38:01Z", "message": "Merge remote-tracking branch 'origin/optimize/state-tree-validators' into optimize/state-tree-validators"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d13c3dd72882bb512be13886dfa2e4c22787bd58", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d13c3dd72882bb512be13886dfa2e4c22787bd58", "committedDate": "2020-12-09T10:23:24Z", "message": "Merge branch 'optimize/state-tree-validators' into feature/view-ssz-deserialize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4331b605cb485d59e6132eacb273b52ff8d33b55", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/4331b605cb485d59e6132eacb273b52ff8d33b55", "committedDate": "2020-12-09T10:24:40Z", "message": "Merge remote-tracking branch 'ConsenSys/master' into optimize/state-tree-validators"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bb0152371c48e5fb29c31bcdcf0a93258f74dbf", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8bb0152371c48e5fb29c31bcdcf0a93258f74dbf", "committedDate": "2020-12-09T10:25:14Z", "message": "Merge branch 'optimize/state-tree-validators' into feature/view-ssz-deserialize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af1642e6e23a65ef5b72e74da3bd3625a8e38855", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/af1642e6e23a65ef5b72e74da3bd3625a8e38855", "committedDate": "2020-12-09T15:10:39Z", "message": "Remove obsolete method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e56692ea2ebdd1b4d6448a9646fc5596183e2a3e", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e56692ea2ebdd1b4d6448a9646fc5596183e2a3e", "committedDate": "2020-12-09T15:11:27Z", "message": "Initial implementation of sszDeserialize()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06cb6aa4a8cf24b359544e498eba576c263a7bc3", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/06cb6aa4a8cf24b359544e498eba576c263a7bc3", "committedDate": "2020-12-09T16:08:49Z", "message": "Fix a bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c65f70b766650fad2554db96cecd98b8a37a389", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/7c65f70b766650fad2554db96cecd98b8a37a389", "committedDate": "2020-12-09T16:09:02Z", "message": "Fix another bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1390473b37f3484671a11db2ec5469886a83b07", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/f1390473b37f3484671a11db2ec5469886a83b07", "committedDate": "2020-12-09T16:15:02Z", "message": "Fix another bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb8ebc579d26eb5f51eb8a4f0111cc43c882bbfd", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/eb8ebc579d26eb5f51eb8a4f0111cc43c882bbfd", "committedDate": "2020-12-09T16:49:11Z", "message": "Get ViewType from Class based on annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbe983da5af1ced9978a0338db58f06f901b89b3", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/bbe983da5af1ced9978a0338db58f06f901b89b3", "committedDate": "2020-12-09T16:57:07Z", "message": "Check no bytes left at the end of container ssz deserialize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9789d26915f3505db723bafb74328f54dd6344d2", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9789d26915f3505db723bafb74328f54dd6344d2", "committedDate": "2020-12-09T17:06:38Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "346a35cfff47d320f7e12d5b289dc72e1d518aa1", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/346a35cfff47d320f7e12d5b289dc72e1d518aa1", "committedDate": "2020-12-09T17:42:45Z", "message": "Fix a couple of bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bb2a00a4460569debd3b261ad0498d2a48a1a9c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/0bb2a00a4460569debd3b261ad0498d2a48a1a9c", "committedDate": "2020-12-09T17:43:15Z", "message": "Fix @SszTypeDescriptor search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "195cbed4c9f7db5fd3fab6171147727779c45e7c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/195cbed4c9f7db5fd3fab6171147727779c45e7c", "committedDate": "2020-12-09T17:44:17Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a8710bf2691120ba95824736fc8903a66d6a5e8", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/5a8710bf2691120ba95824736fc8903a66d6a5e8", "committedDate": "2020-12-10T09:14:53Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c49ef0eac26932a1e15b662616f70b38ef2c171c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/c49ef0eac26932a1e15b662616f70b38ef2c171c", "committedDate": "2020-12-10T15:03:32Z", "message": "Merge remote-tracking branch 'ConsenSys/master' into feature/view-ssz-deserialize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91b666c809a8788e6dd46cc582e223cc4315a4f6", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/91b666c809a8788e6dd46cc582e223cc4315a4f6", "committedDate": "2020-12-10T16:56:13Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bd6a23d749eeff4e2daab63571d45cb2dfbc52c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/2bd6a23d749eeff4e2daab63571d45cb2dfbc52c", "committedDate": "2020-12-10T17:24:05Z", "message": "Use dedicated SSZDeserializeException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cdf25b4bb7b6a94c77986e39365270ac1585392", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/4cdf25b4bb7b6a94c77986e39365270ac1585392", "committedDate": "2020-12-10T17:40:58Z", "message": "Fix empty list case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "768a1085d7d19d1f7ae41ff5ff270ed2d983d1fd", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/768a1085d7d19d1f7ae41ff5ff270ed2d983d1fd", "committedDate": "2020-12-11T08:48:21Z", "message": "Cache Types factories instead of Types instances cause tests may change constants and some types need to be recreated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c1d117719679c5683ed6e033e092bbfe663e77d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9c1d117719679c5683ed6e033e092bbfe663e77d", "committedDate": "2020-12-11T08:55:53Z", "message": "Slightly flatten confusing multi-level functional construct"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8701e6ccf9dbfc913e2c5edd18009717456f1663", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8701e6ccf9dbfc913e2c5edd18009717456f1663", "committedDate": "2020-12-11T11:05:02Z", "message": "Refactor SszReader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30ab75b846f1f2408c99252dd73f32cae0ffdfd3", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/30ab75b846f1f2408c99252dd73f32cae0ffdfd3", "committedDate": "2020-12-11T11:24:34Z", "message": "Fix compile warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc2ebd4282e9afe1e0198c2384177b0ee35a3141", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/fc2ebd4282e9afe1e0198c2384177b0ee35a3141", "committedDate": "2020-12-11T11:55:08Z", "message": "A bit more refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9199db9a96e169a1ba542a28faaf708b08ba7b3e", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9199db9a96e169a1ba542a28faaf708b08ba7b3e", "committedDate": "2020-12-11T12:43:50Z", "message": "Move bitlist ssz math to the Bitlist class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b1c4e2a756c17dc8e814a1c5041d4d529f67d46", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/1b1c4e2a756c17dc8e814a1c5041d4d529f67d46", "committedDate": "2020-12-11T13:17:22Z", "message": "Temp commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfebc2e8a7f9cdc6492068d9f9b9e9c37238ce4b", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/dfebc2e8a7f9cdc6492068d9f9b9e9c37238ce4b", "committedDate": "2020-12-11T13:32:23Z", "message": "Fix refactor regression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37c3cff64ad7c16aefecfbf84b08f4ab3b18e284", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/37c3cff64ad7c16aefecfbf84b08f4ab3b18e284", "committedDate": "2020-12-11T13:43:28Z", "message": "Fix bitlist refactor regression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "289af788bd62fd54f81f0d5fba3a0bb9690b165f", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/289af788bd62fd54f81f0d5fba3a0bb9690b165f", "committedDate": "2020-12-11T13:46:07Z", "message": "Remove temp file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66d62ffe9e6e71983a518aa9d962f3cbf7c023d1", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/66d62ffe9e6e71983a518aa9d962f3cbf7c023d1", "committedDate": "2020-12-11T13:55:11Z", "message": "Remove redundant and invalid check. Move package private class to the bottom"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c159af94bd76d45573d82cc04d98c6b56934057d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/c159af94bd76d45573d82cc04d98c6b56934057d", "committedDate": "2020-12-11T13:57:26Z", "message": "Merge remote-tracking branch 'ConsenSys/master' into feature/view-ssz-deserialize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cb8e97ce4006a4045bcc1ce16c9f0401ca86648", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/7cb8e97ce4006a4045bcc1ce16c9f0401ca86648", "committedDate": "2020-12-11T14:13:55Z", "message": "Fix Bitlist refactor regression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d316b4ae3a0e4e9f9eb35613858bcf4b03685e1", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9d316b4ae3a0e4e9f9eb35613858bcf4b03685e1", "committedDate": "2020-12-11T15:00:30Z", "message": "Fix Bitlist refactor regression, add bitlist test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae722360e605f6778c3aecccd8a2b0cea3c8c3e1", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/ae722360e605f6778c3aecccd8a2b0cea3c8c3e1", "committedDate": "2020-12-11T15:01:29Z", "message": "Merge branch 'master' into feature/view-ssz-deserialize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "469784f6895380f352c4fa3ef824e432a57f7a84", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/469784f6895380f352c4fa3ef824e432a57f7a84", "committedDate": "2020-12-11T15:05:32Z", "message": "Fix compiler warnings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTYwNzEz", "url": "https://github.com/ConsenSys/teku/pull/3382#pullrequestreview-550560713", "createdAt": "2020-12-11T20:36:20Z", "commit": {"oid": "469784f6895380f352c4fa3ef824e432a57f7a84"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMDozNjoyMFrOIEMBMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQyMjozNDozMlrOIESmEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI2MjEzMA==", "bodyText": "Looks like the changes to this file were for debugging - should we revert this?", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541262130", "createdAt": "2020-12-11T20:36:20Z", "author": {"login": "mbaxter"}, "path": "eth-reference-tests/src/referenceTest/java/tech/pegasys/teku/reference/phase0/ManualReferenceTestRunner.java", "diffHunk": "@@ -30,7 +29,7 @@\n  * <p>The test case is disabled as the tests run via the generated classes in CI, but it still runs\n  * without removing the @Disabled in IntelliJ.\n  */\n-@Disabled\n+// @Disabled", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469784f6895380f352c4fa3ef824e432a57f7a84"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI5OTg1MQ==", "bodyText": "(nit) Probably worth asserting on the message to make sure we're throwing the error we expect", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541299851", "createdAt": "2020-12-11T21:16:12Z", "author": {"login": "mbaxter"}, "path": "ethereum/datastructures/src/test/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializerTest.java", "diffHunk": "@@ -87,8 +88,7 @@ public void deserialize_extraDataAppended() {\n     final Bytes checkpointData = SimpleOffsetSerializer.serialize(checkpoint);\n     final Bytes encoded = Bytes.concatenate(checkpointData, extraData);\n     assertThatThrownBy(() -> SimpleOffsetSerializer.deserialize(encoded, Checkpoint.class))\n-        .isInstanceOf(IllegalStateException.class)\n-        .hasMessageContaining(\"Unread data detected\");\n+        .isInstanceOf(SSZDeserializeException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469784f6895380f352c4fa3ef824e432a57f7a84"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMyNjY4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  int lastByteWithLeadingBit = lastByte ^ (1 << (length % 8));\n          \n          \n            \n                  int lastByteWithLeadingBit = lastByte ^ leadingBit;", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541326686", "createdAt": "2020-12-11T21:45:53Z", "author": {"login": "mbaxter"}, "path": "ssz/src/main/java/tech/pegasys/teku/ssz/SSZTypes/Bitlist.java", "diffHunk": "@@ -141,6 +133,41 @@ public static Bitlist fromBytes(Bytes bytes, long maxSize) {\n     return new Bitlist(bitlistSize, byteArray, maxSize);\n   }\n \n+  public static Bytes sszTruncateLeadingBit(Bytes bytes, int length) {\n+    Bytes bytesWithoutLast = bytes.slice(0, bytes.size() - 1);\n+    if (length % 8 == 0) {\n+      return bytesWithoutLast;\n+    } else {\n+      int lastByte = 0xFF & bytes.get(bytes.size() - 1);\n+      int leadingBit = 1 << (length % 8);\n+      int lastByteWithoutLeadingBit = lastByte ^ leadingBit;\n+      return Bytes.concatenate(bytesWithoutLast, Bytes.of(lastByteWithoutLeadingBit));\n+    }\n+  }\n+\n+  public static Bytes sszAppendLeadingBit(Bytes bytes, int length) {\n+    checkArgument(length <= bytes.size() * 8 && length > (bytes.size() - 1) * 8);\n+    if (length % 8 == 0) {\n+      return Bytes.wrap(bytes, Bytes.of(1));\n+    } else {\n+      int lastByte = 0xFF & bytes.get(bytes.size() - 1);\n+      int leadingBit = 1 << (length % 8);\n+      checkArgument((-leadingBit & lastByte) == 0, \"Bits higher than length should be 0\");\n+      int lastByteWithLeadingBit = lastByte ^ (1 << (length % 8));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469784f6895380f352c4fa3ef824e432a57f7a84"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMzMDIxOQ==", "bodyText": "nit - these nodes aren't necessarily terminal leaf nodes:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static TreeNode createTree(List<? extends TreeNode> leafNodes) {\n          \n          \n            \n              public static TreeNode createTree(List<? extends TreeNode> children) {", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541330219", "createdAt": "2020-12-11T21:49:43Z", "author": {"login": "mbaxter"}, "path": "ssz/src/main/java/tech/pegasys/teku/ssz/backing/tree/TreeUtil.java", "diffHunk": "@@ -77,7 +77,7 @@ public static TreeNode createDefaultTree(long maxLength, TreeNode defaultNode) {\n   }\n \n   /** Creates a binary tree of width `nextPowerOf2(leafNodes.size())` with specific leaf nodes */\n-  public static TreeNode createTree(List<TreeNode> leafNodes) {\n+  public static TreeNode createTree(List<? extends TreeNode> leafNodes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469784f6895380f352c4fa3ef824e432a57f7a84"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM1MzA2MQ==", "bodyText": "(nit) Probably worth adding a non-empty error string?", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541353061", "createdAt": "2020-12-11T22:15:28Z", "author": {"login": "mbaxter"}, "path": "ssz/src/main/java/tech/pegasys/teku/ssz/backing/type/CollectionViewType.java", "diffHunk": "@@ -123,6 +138,123 @@ private int sszSerializeVariableVector(\n     return variableOffset;\n   }\n \n+  protected DeserializedData sszDeserializeVector(SszReader reader) {\n+    if (getElementType().isFixedSize()) {\n+      Optional<SszSuperNodeHint> sszSuperNodeHint = getHints().getHint(SszSuperNodeHint.class);\n+      if (sszSuperNodeHint.isPresent()) {\n+        return sszDeserializeSupernode(reader, sszSuperNodeHint.get().getDepth());\n+      } else {\n+        return sszDeserializeFixed(reader);\n+      }\n+    } else {\n+      return sszDeserializeVariable(reader);\n+    }\n+  }\n+\n+  private DeserializedData sszDeserializeSupernode(SszReader reader, int supernodeDepth) {\n+    SszNodeTemplate template = elementSszSupernodeTemplate.get();\n+    int sszSize = reader.getAvailableBytes();\n+    if (sszSize % template.getSszLength() != 0) {\n+      throw new SSZDeserializeException(\"Ssz length is not multiple of element length\");\n+    }\n+    int elementsCount = sszSize / template.getSszLength();\n+    List<SszSuperNode> sszNodes =\n+        chunks(sszSize, (1 << supernodeDepth) * template.getSszLength())\n+            .mapToObj(reader::read)\n+            .map(bb -> new SszSuperNode(supernodeDepth, template, bb))\n+            .collect(Collectors.toList());\n+    TreeNode tree =\n+        TreeUtil.createTree(\n+            sszNodes,\n+            new SszSuperNode(supernodeDepth, template, Bytes.EMPTY),\n+            treeDepth() - supernodeDepth);\n+    return new DeserializedData(tree, elementsCount);\n+  }\n+\n+  private DeserializedData sszDeserializeFixed(SszReader reader) {\n+    int bytesSize = reader.getAvailableBytes();\n+    if (getElementType() instanceof BasicViewType) {\n+      checkSsz(bytesSize % getElementType().getFixedPartSize() == 0, \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469784f6895380f352c4fa3ef824e432a57f7a84"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM2Nzc3MQ==", "bodyText": "Looks like this can be private:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static ViewRead deserialize(Bytes bytes, ViewType sszViewType) {\n          \n          \n            \n              private static ViewRead deserialize(Bytes bytes, ViewType sszViewType) {", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541367771", "createdAt": "2020-12-11T22:31:44Z", "author": {"login": "mbaxter"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializer.java", "diffHunk": "@@ -229,6 +236,12 @@ public static Bytes serializeVariableCompositeList(\n     }\n   }\n \n+  public static ViewRead deserialize(Bytes bytes, ViewType sszViewType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469784f6895380f352c4fa3ef824e432a57f7a84"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM2OTg3NA==", "bodyText": "Does this mean we can remove all of the tree-backed classes from SimpleOffsetSerializer.setConstants()?", "url": "https://github.com/ConsenSys/teku/pull/3382#discussion_r541369874", "createdAt": "2020-12-11T22:34:32Z", "author": {"login": "mbaxter"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializer.java", "diffHunk": "@@ -210,14 +212,19 @@ public static Bytes serializeVariableCompositeList(\n   public static <T> T deserialize(Bytes bytes, Class<T> classInfo) {\n     MutableInt bytePointer = new MutableInt(0);\n     if (!isPrimitive(classInfo)) {\n-      return SSZ.decode(\n-          bytes,\n-          reader -> {\n-            final T result =\n-                deserializeContainerErrorWrapper(classInfo, reader, bytePointer, bytes.size());\n-            assertAllDataRead(reader);\n-            return result;\n-          });\n+      Optional<ViewType> maybeViewType = ViewType.getType(classInfo);\n+      if (maybeViewType.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469784f6895380f352c4fa3ef824e432a57f7a84"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb79a6bad4bbe32099faff57c67de91413edb3a7", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/cb79a6bad4bbe32099faff57c67de91413edb3a7", "committedDate": "2020-12-15T11:13:49Z", "message": "Revert debugging change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7632ce431be25be738ff575120c4f5d0b0e3316", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/c7632ce431be25be738ff575120c4f5d0b0e3316", "committedDate": "2020-12-15T11:31:42Z", "message": "Throw SSZDeserializeException with more correct message. Add message check to the test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3aa13c6c6b5553bfa7f657fcbeb54cad812a04c3", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/3aa13c6c6b5553bfa7f657fcbeb54cad812a04c3", "committedDate": "2020-12-15T11:34:20Z", "message": "Use already calculated value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e3388091150c04fa5366de57c4c36f4dd2c0978", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/5e3388091150c04fa5366de57c4c36f4dd2c0978", "committedDate": "2020-12-15T11:37:19Z", "message": "Rename parameter to be more exact: these nodes aren't necessarily terminal leaf nodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b19d9186959587fd69485043aa9048ebfa67230", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9b19d9186959587fd69485043aa9048ebfa67230", "committedDate": "2020-12-15T11:46:42Z", "message": "Add error string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e82d44e8ae4dcb613403153a1a32cfe762e019f6", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e82d44e8ae4dcb613403153a1a32cfe762e019f6", "committedDate": "2020-12-15T11:49:16Z", "message": "Make the method private for now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96354a4edf5325c93a4854c94ebe6ded1938c812", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/96354a4edf5325c93a4854c94ebe6ded1938c812", "committedDate": "2020-12-15T11:55:19Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "015ea90e3bdc0e214e3ad982ca9ec6c63eb98586", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/015ea90e3bdc0e214e3ad982ca9ec6c63eb98586", "committedDate": "2020-12-15T11:55:29Z", "message": "Merge remote-tracking branch 'ConsenSys/master' into feature/view-ssz-deserialize"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4366, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}