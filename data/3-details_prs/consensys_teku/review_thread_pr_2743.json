{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMzM1MTA3", "number": 2743, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QyMToyMzoxNVrOEhBqqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMjo1MToyM1rOEiUbBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMDY1NzcxOnYy", "diffSide": "RIGHT", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QyMToyMzoxNVrOHOHw5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDozMTo0NlrOHOW3Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU2OTMxOA==", "bodyText": "We should just tie this into the existing stop functionality rather than adding another shutdown hook.\nAlso the write is async so we need to actually wait for it to complete (as a batch, don't wait sequentially for each peer).\nWould be best to use the disconnectCleanly method as well so the peer is marked as disconnected and we don't send any other messages after disconnect.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r484569318", "createdAt": "2020-09-07T21:23:15Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -91,6 +92,19 @@\n     this.eth2RpcPingInterval = eth2RpcPingInterval;\n     this.eth2RpcOutstandingPingThreshold = eth2RpcOutstandingPingThreshold;\n     this.eth2StatusUpdateInterval = eth2StatusUpdateInterval;\n+    Runtime.getRuntime()\n+        .addShutdownHook(\n+            new Thread(\n+                () ->\n+                    connectedPeerMap\n+                        .values()\n+                        .forEach(\n+                            peer ->\n+                                peer.sendGoodbye(GoodbyeMessage.REASON_CLIENT_SHUT_DOWN)\n+                                    .finish(\n+                                        err ->\n+                                            LOG.debug(\n+                                                \"Unable to send goodbye to peer {}\", peer, err)))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd474eb5068648c608dfa9d6c7d24bf27a2670d6"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxNjY4Mw==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r484816683", "createdAt": "2020-09-08T10:31:46Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -91,6 +92,19 @@\n     this.eth2RpcPingInterval = eth2RpcPingInterval;\n     this.eth2RpcOutstandingPingThreshold = eth2RpcOutstandingPingThreshold;\n     this.eth2StatusUpdateInterval = eth2StatusUpdateInterval;\n+    Runtime.getRuntime()\n+        .addShutdownHook(\n+            new Thread(\n+                () ->\n+                    connectedPeerMap\n+                        .values()\n+                        .forEach(\n+                            peer ->\n+                                peer.sendGoodbye(GoodbyeMessage.REASON_CLIENT_SHUT_DOWN)\n+                                    .finish(\n+                                        err ->\n+                                            LOG.debug(\n+                                                \"Unable to send goodbye to peer {}\", peer, err)))));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU2OTMxOA=="}, "originalCommit": {"oid": "dd474eb5068648c608dfa9d6c7d24bf27a2670d6"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjEzMTc1OnYy", "diffSide": "RIGHT", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwOTo0MzozNVrOHOVNfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDozMTozNVrOHOW2xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4OTYzMQ==", "bodyText": "You don't need to sendGoodbye then disconnectCleanly - disconnectCleanly sends the goodbye.  It probably does need to be adjusted to return a future so you know when it's actually been written.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r484789631", "createdAt": "2020-09-08T09:43:35Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -301,4 +289,19 @@ public BeaconChainMethods getBeaconChainMethods() {\n   private boolean peerIsReady(Eth2Peer peer) {\n     return peer.hasStatus();\n   }\n+\n+  public SafeFuture<?> sendGoodbyeToPeers() {\n+    return SafeFuture.allOf(\n+        connectedPeerMap.values().stream()\n+            .map(\n+                peer ->\n+                    peer.sendGoodbye(GoodbyeMessage.REASON_CLIENT_SHUT_DOWN)\n+                        .thenRun(() -> peer.disconnectCleanly(DisconnectReason.SHUTTING_DOWN))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffb6c2ac393ccfc9cceb64e495458d730646b276"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxNjU4MQ==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r484816581", "createdAt": "2020-09-08T10:31:35Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -301,4 +289,19 @@ public BeaconChainMethods getBeaconChainMethods() {\n   private boolean peerIsReady(Eth2Peer peer) {\n     return peer.hasStatus();\n   }\n+\n+  public SafeFuture<?> sendGoodbyeToPeers() {\n+    return SafeFuture.allOf(\n+        connectedPeerMap.values().stream()\n+            .map(\n+                peer ->\n+                    peer.sendGoodbye(GoodbyeMessage.REASON_CLIENT_SHUT_DOWN)\n+                        .thenRun(() -> peer.disconnectCleanly(DisconnectReason.SHUTTING_DOWN))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4OTYzMQ=="}, "originalCommit": {"oid": "ffb6c2ac393ccfc9cceb64e495458d730646b276"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjEzMzQzOnYy", "diffSide": "RIGHT", "path": "networking/eth2/src/testFixtures/java/tech/pegasys/teku/networking/eth2/Eth2NetworkFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwOTo0NDowMVrOHOVOhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDozMjo1NVrOHOW5mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4OTg5Mw==", "bodyText": "Waiter.waitFor is probably better than .join() here and below so the test doesn't hang forever if the future doesn't complete.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r484789893", "createdAt": "2020-09-08T09:44:01Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/testFixtures/java/tech/pegasys/teku/networking/eth2/Eth2NetworkFactory.java", "diffHunk": "@@ -92,7 +93,7 @@ public Eth2P2PNetworkBuilder builder() {\n   }\n \n   public void stopAll() {\n-    networks.forEach(P2PNetwork::stop);\n+    SafeFuture.allOf(networks.stream().map(P2PNetwork::stop).toArray(SafeFuture[]::new)).join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffb6c2ac393ccfc9cceb64e495458d730646b276"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxNzMwNQ==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r484817305", "createdAt": "2020-09-08T10:32:55Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/testFixtures/java/tech/pegasys/teku/networking/eth2/Eth2NetworkFactory.java", "diffHunk": "@@ -92,7 +93,7 @@ public Eth2P2PNetworkBuilder builder() {\n   }\n \n   public void stopAll() {\n-    networks.forEach(P2PNetwork::stop);\n+    SafeFuture.allOf(networks.stream().map(P2PNetwork::stop).toArray(SafeFuture[]::new)).join();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4OTg5Mw=="}, "originalCommit": {"oid": "ffb6c2ac393ccfc9cceb64e495458d730646b276"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDc5OTUyOnYy", "diffSide": "RIGHT", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMToyNzoyNlrOHOumtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMDo0MTowOFrOHPBZkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTY4NQ==", "bodyText": "Probably always want to call super.stop now I think about this, even if sending goodbye fails.  So probably:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return peerManager.sendGoodbyeToPeers().thenCompose(__ -> super.stop());\n          \n          \n            \n                return peerManager.sendGoodbyeToPeers().exceptionally(error -> {\n          \n          \n            \n                  LOG.debug(\"Failed to send goodby to peers on shutdown\", error);\n          \n          \n            \n                  return null;\n          \n          \n            \n                }).thenCompose(__ -> super.stop());", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485205685", "createdAt": "2020-09-08T21:27:26Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -245,7 +245,7 @@ public synchronized void stop() {\n     proposerSlashingGossipManager.shutdown();\n     attesterSlashingGossipManager.shutdown();\n     attestationSubnetService.unsubscribe(discoveryNetworkAttestationSubnetsSubscription);\n-    super.stop();\n+    return peerManager.sendGoodbyeToPeers().thenCompose(__ -> super.stop());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUxMzYxOQ==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485513619", "createdAt": "2020-09-09T10:41:08Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -245,7 +245,7 @@ public synchronized void stop() {\n     proposerSlashingGossipManager.shutdown();\n     attesterSlashingGossipManager.shutdown();\n     attestationSubnetService.unsubscribe(discoveryNetworkAttestationSubnetsSubscription);\n-    super.stop();\n+    return peerManager.sendGoodbyeToPeers().thenCompose(__ -> super.stop());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTY4NQ=="}, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDgwMjM4OnYy", "diffSide": "RIGHT", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMToyODoyN1rOHOuoeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMDo0MjowNVrOHPBbfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNjEzOA==", "bodyText": "Since disconnectCleanly already has an exceptionally clause to handle the goodbye not sending, this should always complete normally and we can just use .reportExceptions().  If it does wind up failing, it's not for any expected reason and should be reported very loudly.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485206138", "createdAt": "2020-09-08T21:28:27Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java", "diffHunk": "@@ -97,7 +97,8 @@ public void updateStatus(final PeerStatus status) {\n             },\n             error -> {\n               LOG.error(\"Failed to validate updated peer status\", error);\n-              disconnectCleanly(DisconnectReason.UNABLE_TO_VERIFY_NETWORK);\n+              disconnectCleanly(DisconnectReason.UNABLE_TO_VERIFY_NETWORK)\n+                  .finish(err -> LOG.debug(\"Error while disconnecting from peer {}\", this, err));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUxNDExMA==", "bodyText": "Makes sense.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485514110", "createdAt": "2020-09-09T10:42:05Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java", "diffHunk": "@@ -97,7 +97,8 @@ public void updateStatus(final PeerStatus status) {\n             },\n             error -> {\n               LOG.error(\"Failed to validate updated peer status\", error);\n-              disconnectCleanly(DisconnectReason.UNABLE_TO_VERIFY_NETWORK);\n+              disconnectCleanly(DisconnectReason.UNABLE_TO_VERIFY_NETWORK)\n+                  .finish(err -> LOG.debug(\"Error while disconnecting from peer {}\", this, err));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNjEzOA=="}, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDgxMDI5OnYy", "diffSide": "RIGHT", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMTozMTowN1rOHOutKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMDo0OTozOVrOHPBqWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNzMzOQ==", "bodyText": "Can probably just drop this exceptionally clause as disconnectCleanly already has one.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485207339", "createdAt": "2020-09-08T21:31:07Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -287,4 +290,18 @@ public BeaconChainMethods getBeaconChainMethods() {\n   private boolean peerIsReady(Eth2Peer peer) {\n     return peer.hasStatus();\n   }\n+\n+  public SafeFuture<?> sendGoodbyeToPeers() {\n+    return SafeFuture.allOf(\n+        connectedPeerMap.values().stream()\n+            .map(\n+                peer ->\n+                    peer.disconnectCleanly(DisconnectReason.SHUTTING_DOWN)\n+                        .exceptionally(\n+                            err -> {\n+                              LOG.debug(\"Error while sending goodbye to peers\", err);\n+                              return null;\n+                            }))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUxNzkxMw==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485517913", "createdAt": "2020-09-09T10:49:39Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -287,4 +290,18 @@ public BeaconChainMethods getBeaconChainMethods() {\n   private boolean peerIsReady(Eth2Peer peer) {\n     return peer.hasStatus();\n   }\n+\n+  public SafeFuture<?> sendGoodbyeToPeers() {\n+    return SafeFuture.allOf(\n+        connectedPeerMap.values().stream()\n+            .map(\n+                peer ->\n+                    peer.disconnectCleanly(DisconnectReason.SHUTTING_DOWN)\n+                        .exceptionally(\n+                            err -> {\n+                              LOG.debug(\"Error while sending goodbye to peers\", err);\n+                              return null;\n+                            }))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNzMzOQ=="}, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDg0OTk0OnYy", "diffSide": "RIGHT", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/DiscoveryNetwork.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMTo0NDo0N1rOHOvE9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMTo0NzoxMFrOHPvv6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMzQzMQ==", "bodyText": "We need to make sure this still runs regardless of whether connectionManager.stop() failed or not.  You actually want a .handleComposed method on SafeFuture I suspect.  Would be something like:\n  /**\n   * Returns a new CompletionStage that, when this stage completes either normally or exceptionally,\n   * is executed with this stage's result and exception as arguments to the supplied function.\n   *\n   * <p>When this stage is complete, the given function is invoked with the result (or {@code null}\n   * if none) and the exception (or {@code null} if none) returning another `CompletionStage`. When\n   * that stage completes, the `SafeFuture` returned by this method is completed with the same value\n   * or exception.\n   *\n   * @param fn the function to use to compute another CompletionStage\n   * @param <U> the function's return type\n   * @return the new SafeFuture\n   */\n  public <U> SafeFuture<U> handleComposed(\n      final BiFunction<? super T, Throwable, CompletionStage<U>> fn) {\n    final SafeFuture<U> result = new SafeFuture<>();\n    whenComplete(\n        (value, error) -> {\n          try {\n            propagateResult(fn.apply(value, error), result);\n          } catch (final Throwable t) {\n            result.completeExceptionally(t);\n          }\n        });\n    return result;\n  }\n\nThat's quite a useful method to have around actually.  Would need some extra tests for it.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485213431", "createdAt": "2020-09-08T21:44:47Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/DiscoveryNetwork.java", "diffHunk": "@@ -121,19 +121,15 @@ private static DiscoveryService createDiscoveryService(\n   }\n \n   @Override\n-  public void stop() {\n-    connectionManager\n+  public SafeFuture<?> stop() {\n+    return connectionManager\n         .stop()\n         .exceptionally(\n             error -> {\n               LOG.error(\"Failed to stop connection manager\", error);\n               return null;\n             })\n-        .always(\n-            () -> {\n-              p2pNetwork.stop();\n-              discoveryService.stop().reportExceptions();\n-            });\n+        .thenCompose((__) -> SafeFuture.allOf(p2pNetwork.stop(), discoveryService.stop()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUyNTM2Nw==", "bodyText": "I actually noticed that I could just do this instead:\n  public SafeFuture<?> stop() {\n    return SafeFuture.allOf(\n            connectionManager.stop(),\n            p2pNetwork.stop(),\n            discoveryService.stop()\n    );\n\nWent with this since it's much simpler. Let me know if you don't think that's a good approach.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485525367", "createdAt": "2020-09-09T11:03:43Z", "author": {"login": "cemozerr"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/DiscoveryNetwork.java", "diffHunk": "@@ -121,19 +121,15 @@ private static DiscoveryService createDiscoveryService(\n   }\n \n   @Override\n-  public void stop() {\n-    connectionManager\n+  public SafeFuture<?> stop() {\n+    return connectionManager\n         .stop()\n         .exceptionally(\n             error -> {\n               LOG.error(\"Failed to stop connection manager\", error);\n               return null;\n             })\n-        .always(\n-            () -> {\n-              p2pNetwork.stop();\n-              discoveryService.stop().reportExceptions();\n-            });\n+        .thenCompose((__) -> SafeFuture.allOf(p2pNetwork.stop(), discoveryService.stop()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMzQzMQ=="}, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU2MzI2Ng==", "bodyText": "The tests in DiscoveryNetworkTest implied that connection manager would need to be stopped before p2pNetwork or discovery service, but after I inspected connectionManager.stop() I don't believe that's necessarily the case. Thus just simply stopping them all together makes sense to me.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485563266", "createdAt": "2020-09-09T12:14:31Z", "author": {"login": "cemozerr"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/DiscoveryNetwork.java", "diffHunk": "@@ -121,19 +121,15 @@ private static DiscoveryService createDiscoveryService(\n   }\n \n   @Override\n-  public void stop() {\n-    connectionManager\n+  public SafeFuture<?> stop() {\n+    return connectionManager\n         .stop()\n         .exceptionally(\n             error -> {\n               LOG.error(\"Failed to stop connection manager\", error);\n               return null;\n             })\n-        .always(\n-            () -> {\n-              p2pNetwork.stop();\n-              discoveryService.stop().reportExceptions();\n-            });\n+        .thenCompose((__) -> SafeFuture.allOf(p2pNetwork.stop(), discoveryService.stop()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMzQzMQ=="}, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwODA4Mg==", "bodyText": "I don't think that's right.  The connection manager is stopped first so that it stops connecting to new peers and running discovery searches, otherwise you get an awful lot of race conditions.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r486008082", "createdAt": "2020-09-10T01:24:22Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/DiscoveryNetwork.java", "diffHunk": "@@ -121,19 +121,15 @@ private static DiscoveryService createDiscoveryService(\n   }\n \n   @Override\n-  public void stop() {\n-    connectionManager\n+  public SafeFuture<?> stop() {\n+    return connectionManager\n         .stop()\n         .exceptionally(\n             error -> {\n               LOG.error(\"Failed to stop connection manager\", error);\n               return null;\n             })\n-        .always(\n-            () -> {\n-              p2pNetwork.stop();\n-              discoveryService.stop().reportExceptions();\n-            });\n+        .thenCompose((__) -> SafeFuture.allOf(p2pNetwork.stop(), discoveryService.stop()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMzQzMQ=="}, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI3MzAwMg==", "bodyText": "That makes sense. Added handleComposed and two unit tests along with it.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r486273002", "createdAt": "2020-09-10T11:47:10Z", "author": {"login": "cemozerr"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/DiscoveryNetwork.java", "diffHunk": "@@ -121,19 +121,15 @@ private static DiscoveryService createDiscoveryService(\n   }\n \n   @Override\n-  public void stop() {\n-    connectionManager\n+  public SafeFuture<?> stop() {\n+    return connectionManager\n         .stop()\n         .exceptionally(\n             error -> {\n               LOG.error(\"Failed to stop connection manager\", error);\n               return null;\n             })\n-        .always(\n-            () -> {\n-              p2pNetwork.stop();\n-              discoveryService.stop().reportExceptions();\n-            });\n+        .thenCompose((__) -> SafeFuture.allOf(p2pNetwork.stop(), discoveryService.stop()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxMzQzMQ=="}, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDg1NTc0OnYy", "diffSide": "RIGHT", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/LibP2PPeer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMTo0NzowMlrOHOvIlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMTowNjoxNFrOHPCMhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNDM1OA==", "bodyText": "Might be cleaner to use handle here:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .thenRun(\n          \n          \n            \n                        () -> // Request sent now close our side\n          \n          \n            \n                        disconnectImmediately(Optional.of(reason), true))\n          \n          \n            \n                    .exceptionally(\n          \n          \n            \n                        error -> {\n          \n          \n            \n                          LOG.debug(\"Failed to disconnect from \" + getId() + \" cleanly.\", error);\n          \n          \n            \n                          disconnectImmediately(Optional.of(reason), true);\n          \n          \n            \n                          return null;\n          \n          \n            \n                        });\n          \n          \n            \n                    .handle(\n          \n          \n            \n                        (__, error) -> {\n          \n          \n            \n                          if (error != null) {\n          \n          \n            \n                            LOG.debug(\"Failed to disconnect from \" + getId() + \" cleanly.\", error);\n          \n          \n            \n                          }\n          \n          \n            \n                        disconnectImmediately(Optional.of(reason), true));\n          \n          \n            \n                        return null;\n          \n          \n            \n                     });", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485214358", "createdAt": "2020-09-08T21:47:02Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/LibP2PPeer.java", "diffHunk": "@@ -87,18 +87,20 @@ public void disconnectImmediately(\n   }\n \n   @Override\n-  public void disconnectCleanly(final DisconnectReason reason) {\n+  public SafeFuture<?> disconnectCleanly(final DisconnectReason reason) {\n     connected.set(false);\n     disconnectReason = Optional.of(reason);\n     disconnectLocallyInitiated = true;\n-    disconnectRequestHandler\n+    return disconnectRequestHandler\n         .requestDisconnect(reason)\n-        .finish(\n-            () ->\n-                disconnectImmediately(Optional.of(reason), true), // Request sent now close our side\n+        .thenRun(\n+            () -> // Request sent now close our side\n+            disconnectImmediately(Optional.of(reason), true))\n+        .exceptionally(\n             error -> {\n               LOG.debug(\"Failed to disconnect from \" + getId() + \" cleanly.\", error);\n               disconnectImmediately(Optional.of(reason), true);\n+              return null;\n             });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUyNjY2MA==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485526660", "createdAt": "2020-09-09T11:06:14Z", "author": {"login": "cemozerr"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/libp2p/LibP2PPeer.java", "diffHunk": "@@ -87,18 +87,20 @@ public void disconnectImmediately(\n   }\n \n   @Override\n-  public void disconnectCleanly(final DisconnectReason reason) {\n+  public SafeFuture<?> disconnectCleanly(final DisconnectReason reason) {\n     connected.set(false);\n     disconnectReason = Optional.of(reason);\n     disconnectLocallyInitiated = true;\n-    disconnectRequestHandler\n+    return disconnectRequestHandler\n         .requestDisconnect(reason)\n-        .finish(\n-            () ->\n-                disconnectImmediately(Optional.of(reason), true), // Request sent now close our side\n+        .thenRun(\n+            () -> // Request sent now close our side\n+            disconnectImmediately(Optional.of(reason), true))\n+        .exceptionally(\n             error -> {\n               LOG.debug(\"Failed to disconnect from \" + getId() + \" cleanly.\", error);\n               disconnectImmediately(Optional.of(reason), true);\n+              return null;\n             });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNDM1OA=="}, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDg2MTAxOnYy", "diffSide": "RIGHT", "path": "networking/p2p/src/test/java/tech/pegasys/teku/networking/p2p/discovery/ConnectionManagerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMTo0OTowMFrOHOvL1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMTo0OTowMFrOHOvL1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNTE4OQ==", "bodyText": "If we expect the future to already be completed it can be clearer to use\n    assertThat(manager.start()).isCompleted();\n\nBoth work though and are both better than .join.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485215189", "createdAt": "2020-09-08T21:49:00Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/test/java/tech/pegasys/teku/networking/p2p/discovery/ConnectionManagerTest.java", "diffHunk": "@@ -80,23 +83,25 @@ public void setUp() {\n   }\n \n   @Test\n-  public void shouldConnectToStaticPeersOnStart() {\n+  public void shouldConnectToStaticPeersOnStart()\n+      throws InterruptedException, ExecutionException, TimeoutException {\n     final ConnectionManager manager = createManager(PEER1, PEER2);\n     when(network.connect(any(PeerAddress.class))).thenReturn(SafeFuture.completedFuture(null));\n-    manager.start().join();\n+    Waiter.waitFor(manager.start());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDg2NTIwOnYy", "diffSide": "RIGHT", "path": "networking/p2p/src/testFixtures/java/tech/pegasys/teku/network/p2p/DiscoveryNetworkFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMTo1MDoyNlrOHOvOWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMTo1MDoyNlrOHOvOWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIxNTgzNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        network.stop().join();\n          \n          \n            \n                        Waiter.waitFor(network.stop());", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r485215834", "createdAt": "2020-09-08T21:50:26Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/testFixtures/java/tech/pegasys/teku/network/p2p/DiscoveryNetworkFactory.java", "diffHunk": "@@ -123,7 +125,7 @@ public DiscoveryNetworkBuilder bootnode(final String bootnode) {\n                 \"Port conflict detected, retrying with a new port. Original message: {}\",\n                 e.getMessage());\n             attempt++;\n-            network.stop();\n+            network.stop().join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f627d3afa4303550a3853b0ed3ab888f13376e3f"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTk2NTE2OnYy", "diffSide": "RIGHT", "path": "networking/p2p/src/testFixtures/java/tech/pegasys/teku/network/p2p/DiscoveryNetworkFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMToyNjoyNFrOHPfnTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMjoxNTowM1rOHPwppQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwODY1NQ==", "bodyText": "Probably should use Waiter.waitFor here too.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r486008655", "createdAt": "2020-09-10T01:26:24Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/testFixtures/java/tech/pegasys/teku/network/p2p/DiscoveryNetworkFactory.java", "diffHunk": "@@ -53,7 +55,8 @@ public DiscoveryNetworkBuilder builder() {\n   }\n \n   public void stopAll() {\n-    networks.forEach(DiscoveryNetwork::stop);\n+    SafeFuture.allOf(networks.stream().map(DiscoveryNetwork::stop).toArray(SafeFuture[]::new))\n+        .join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1e4cf44bab032e8c9aedcfd96429e2a99680334"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI4Nzc4MQ==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r486287781", "createdAt": "2020-09-10T12:15:03Z", "author": {"login": "cemozerr"}, "path": "networking/p2p/src/testFixtures/java/tech/pegasys/teku/network/p2p/DiscoveryNetworkFactory.java", "diffHunk": "@@ -53,7 +55,8 @@ public DiscoveryNetworkBuilder builder() {\n   }\n \n   public void stopAll() {\n-    networks.forEach(DiscoveryNetwork::stop);\n+    SafeFuture.allOf(networks.stream().map(DiscoveryNetwork::stop).toArray(SafeFuture[]::new))\n+        .join();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwODY1NQ=="}, "originalCommit": {"oid": "f1e4cf44bab032e8c9aedcfd96429e2a99680334"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDIxNjM3OnYy", "diffSide": "LEFT", "path": "networking/p2p/src/test/java/tech/pegasys/teku/networking/p2p/DiscoveryNetworkTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMjo1MToyM1rOHQIYKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNzo0MToxOVrOHRf51g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3NjUyMQ==", "bodyText": "We should be able to restore these tests now.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r486676521", "createdAt": "2020-09-10T22:51:23Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/test/java/tech/pegasys/teku/networking/p2p/DiscoveryNetworkTest.java", "diffHunk": "@@ -96,44 +93,6 @@ public void shouldStartConnectionManagerAfterP2pAndDiscoveryStarted() {\n     assertThat(started).isCompleted();\n   }\n \n-  @Test\n-  public void shouldStopConnectionManagerBeforeNetworkAndDiscovery() {\n-    final SafeFuture<Void> connectionStop = new SafeFuture<>();\n-    doReturn(new SafeFuture<Void>()).when(discoveryService).stop();\n-    doReturn(connectionStop).when(connectionManager).stop();\n-\n-    discoveryNetwork.stop();\n-\n-    verify(connectionManager).stop();\n-    verify(discoveryService).updateCustomENRField(any(), any());\n-    verify(discoveryService).getEnr();\n-    verifyNoMoreInteractions(discoveryService);\n-    verifyNoInteractions(p2pNetwork);\n-\n-    connectionStop.complete(null);\n-    verify(p2pNetwork).stop();\n-    verify(discoveryService).stop();\n-  }\n-\n-  @Test\n-  public void shouldStopNetworkAndDiscoveryWhenConnectionManagerStopFails() {\n-    final SafeFuture<Void> connectionStop = new SafeFuture<>();\n-    doReturn(new SafeFuture<Void>()).when(discoveryService).stop();\n-    doReturn(connectionStop).when(connectionManager).stop();\n-\n-    discoveryNetwork.stop();\n-\n-    verify(connectionManager).stop();\n-    verify(discoveryService).updateCustomENRField(any(), any());\n-    verify(discoveryService).getEnr();\n-    verifyNoMoreInteractions(discoveryService);\n-    verifyNoInteractions(p2pNetwork);\n-\n-    connectionStop.completeExceptionally(new RuntimeException(\"Nope\"));\n-    verify(p2pNetwork).stop();\n-    verify(discoveryService).stop();\n-  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5def5f4a7b9d11be2926b87d99ae2559efcdaf3"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMDU1MA==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/2743#discussion_r488110550", "createdAt": "2020-09-14T17:41:19Z", "author": {"login": "cemozerr"}, "path": "networking/p2p/src/test/java/tech/pegasys/teku/networking/p2p/DiscoveryNetworkTest.java", "diffHunk": "@@ -96,44 +93,6 @@ public void shouldStartConnectionManagerAfterP2pAndDiscoveryStarted() {\n     assertThat(started).isCompleted();\n   }\n \n-  @Test\n-  public void shouldStopConnectionManagerBeforeNetworkAndDiscovery() {\n-    final SafeFuture<Void> connectionStop = new SafeFuture<>();\n-    doReturn(new SafeFuture<Void>()).when(discoveryService).stop();\n-    doReturn(connectionStop).when(connectionManager).stop();\n-\n-    discoveryNetwork.stop();\n-\n-    verify(connectionManager).stop();\n-    verify(discoveryService).updateCustomENRField(any(), any());\n-    verify(discoveryService).getEnr();\n-    verifyNoMoreInteractions(discoveryService);\n-    verifyNoInteractions(p2pNetwork);\n-\n-    connectionStop.complete(null);\n-    verify(p2pNetwork).stop();\n-    verify(discoveryService).stop();\n-  }\n-\n-  @Test\n-  public void shouldStopNetworkAndDiscoveryWhenConnectionManagerStopFails() {\n-    final SafeFuture<Void> connectionStop = new SafeFuture<>();\n-    doReturn(new SafeFuture<Void>()).when(discoveryService).stop();\n-    doReturn(connectionStop).when(connectionManager).stop();\n-\n-    discoveryNetwork.stop();\n-\n-    verify(connectionManager).stop();\n-    verify(discoveryService).updateCustomENRField(any(), any());\n-    verify(discoveryService).getEnr();\n-    verifyNoMoreInteractions(discoveryService);\n-    verifyNoInteractions(p2pNetwork);\n-\n-    connectionStop.completeExceptionally(new RuntimeException(\"Nope\"));\n-    verify(p2pNetwork).stop();\n-    verify(discoveryService).stop();\n-  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3NjUyMQ=="}, "originalCommit": {"oid": "c5def5f4a7b9d11be2926b87d99ae2559efcdaf3"}, "originalPosition": 54}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3377, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}