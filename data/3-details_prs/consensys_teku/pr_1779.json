{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MzA0MDIw", "number": 1779, "title": "[BC-428] Disconnect a peer which doesn't respond to N PINGs in a row", "bodyText": "PR Description\nA peer which doesn't respond to several PING request in a row should be disconnected. This should help with stall TCP connections and thus with stucked peers\nFixed Issue(s)\nProbably fixes #1740", "createdAt": "2020-05-13T11:37:55Z", "url": "https://github.com/ConsenSys/teku/pull/1779", "merged": true, "mergeCommit": {"oid": "44a5a1da15e01be03a5d96fd0c5bcde64c724640"}, "closed": true, "closedAt": "2020-05-14T11:51:50Z", "author": {"login": "Nashatyrev"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg3P6UgH2gAyNDE3MzA0MDIwOjYyNjBiMjQ5NWNkYjEyOTc5MDc3M2ZkYTRjYTIzMWNiN2Y1ODg0YmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchKLadAH2gAyNDE3MzA0MDIwOjRlMGRkYjRmOWMzMzQ3NTAwM2FiNGQ4NDE5MWRiODQxOGY4ZTZmYTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6260b2495cdb129790773fda4ca231cb7f5884be", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/6260b2495cdb129790773fda4ca231cb7f5884be", "committedDate": "2020-05-13T11:33:49Z", "message": "Disconnect a peer which doesn't respond to N PINGs in a row"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c44c4f879e65c14748c59c31af021323c97ca194", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/c44c4f879e65c14748c59c31af021323c97ca194", "committedDate": "2020-05-13T11:40:57Z", "message": "Fix test compilation error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10f75d4a590020a2cb037c5d4251d139354cf7c6", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/10f75d4a590020a2cb037c5d4251d139354cf7c6", "committedDate": "2020-05-13T11:42:52Z", "message": "Merge remote-tracking branch 'pegasys/master' into feature-ping-timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDMyNDI2", "url": "https://github.com/ConsenSys/teku/pull/1779#pullrequestreview-411032426", "createdAt": "2020-05-13T15:17:22Z", "commit": {"oid": "10f75d4a590020a2cb037c5d4251d139354cf7c6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNToxNzoyM1rOGU2r9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNToyMDo1OVrOGU22UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyMDY5Mw==", "bodyText": "I'd probably move this logic into Eth2PeerManager - the other peer validation / management logic is in the manager.", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424520693", "createdAt": "2020-05-13T15:17:23Z", "author": {"login": "mbaxter"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java", "diffHunk": "@@ -171,9 +180,16 @@ void markChainValidated() {\n   }\n \n   public SafeFuture<UnsignedLong> sendPing() {\n-    return requestSingleItem(rpcMethods.ping(), metadataMessagesFactory.createPingMessage())\n-        .thenApply(PingMessage::getSeqNumber)\n-        .thenPeek(this::updateMetadataSeqNumber);\n+    if (outstandingPings.getAndIncrement() >= outstandingPingsThreshold) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10f75d4a590020a2cb037c5d4251d139354cf7c6"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyMTMzOA==", "bodyText": "Even though the peer is probably gone, I don't think it would hurt to send a goodBye message just in case.", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424521338", "createdAt": "2020-05-13T15:18:15Z", "author": {"login": "mbaxter"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2Peer.java", "diffHunk": "@@ -171,9 +180,16 @@ void markChainValidated() {\n   }\n \n   public SafeFuture<UnsignedLong> sendPing() {\n-    return requestSingleItem(rpcMethods.ping(), metadataMessagesFactory.createPingMessage())\n-        .thenApply(PingMessage::getSeqNumber)\n-        .thenPeek(this::updateMetadataSeqNumber);\n+    if (outstandingPings.getAndIncrement() >= outstandingPingsThreshold) {\n+      LOG.debug(\"Disconnecting the peer {} due to PING timeout.\", getId());\n+      disconnectImmediately();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10f75d4a590020a2cb037c5d4251d139354cf7c6"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyMzM0NA==", "bodyText": "I think this is too fast - looks like we're sometimes disconnecting the peer before the network notices we're connected.", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424523344", "createdAt": "2020-05-13T15:20:59Z", "author": {"login": "mbaxter"}, "path": "networking/eth2/src/integration-test/java/tech/pegasys/teku/networking/eth2/PingIntegrationTest.java", "diffHunk": "@@ -114,4 +116,64 @@ public void testPingPeriodically() throws Exception {\n     // detecting that ping was automatically sent via updated att subnets of the remote peer\n     waitFor(() -> assertThat(peer1.getRemoteAttestationSubnets()).contains(expectedBitvector1));\n   }\n+\n+  @Test\n+  public void testManualPingTimeout() throws Exception {\n+    // sending PING manually to check eth2RpcOutstandingPingThreshold works correctly\n+    Duration pingPeriod = Duration.ofDays(1);\n+    network1 =\n+        networkFactory\n+            .builder()\n+            .eth2RpcPingInterval(pingPeriod)\n+            .eth2RpcOutstandingPingThreshold(2)\n+            // remove PING method\n+            .rpcMethodsModifier(m -> Stream.of(m).filter(t -> !t.getId().contains(\"/ping\")))\n+            .startNetwork();\n+    network2 =\n+        networkFactory\n+            .builder()\n+            .eth2RpcPingInterval(pingPeriod)\n+            .eth2RpcOutstandingPingThreshold(2)\n+            .peer(network1)\n+            .startNetwork();\n+\n+    peer1 = network2.getPeer(network1.getNodeId()).orElseThrow();\n+    peer2 = network1.getPeer(network2.getNodeId()).orElseThrow();\n+\n+    assertThatThrownBy(() -> peer1.sendPing().get(5, TimeUnit.SECONDS)).isNotNull();\n+    assertThat(peer1.isConnected()).isTrue();\n+    assertThatThrownBy(() -> peer1.sendPing().get(5, TimeUnit.SECONDS)).isNotNull();\n+    assertThat(peer1.isConnected()).isTrue();\n+    // the 3rd ping attempt should disconnect the peer since there are 2 unanswered PING requests\n+    assertThatThrownBy(() -> peer1.sendPing().get(5, TimeUnit.SECONDS)).isNotNull();\n+    waitFor(() -> assertThat(peer1.isConnected()).isFalse());\n+  }\n+\n+  @Test\n+  public void testAutomaticPingTimeout() throws Exception {\n+    // PING is send automatically each 100ms.\n+    // The peer should be finally disconnected as it doesn't answer\n+    Duration pingPeriod = Duration.ofMillis(100);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10f75d4a590020a2cb037c5d4251d139354cf7c6"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "408b5ce82b8fb07f516efc293f3218c1344860d5", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/408b5ce82b8fb07f516efc293f3218c1344860d5", "committedDate": "2020-05-13T17:37:02Z", "message": "Move ping timeout disconnect logic to the PeerManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51a18153ea2e726507a48c0932dc117a53e26282", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/51a18153ea2e726507a48c0932dc117a53e26282", "committedDate": "2020-05-13T17:37:43Z", "message": "Adjust the ping test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d4e89cd39e7cb9da978008421784e9b73ec461f", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/4d4e89cd39e7cb9da978008421784e9b73ec461f", "committedDate": "2020-05-13T17:39:06Z", "message": "Apply spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "648c427ceddcadc57a620d43a16358a1d39ed7cd", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/648c427ceddcadc57a620d43a16358a1d39ed7cd", "committedDate": "2020-05-13T17:43:40Z", "message": "Remove unused field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caf4357aa778ecc14fa24f6cd216e4304e47ff91", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/caf4357aa778ecc14fa24f6cd216e4304e47ff91", "committedDate": "2020-05-13T17:49:10Z", "message": "Fix test compilation error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzIzOTQ3", "url": "https://github.com/ConsenSys/teku/pull/1779#pullrequestreview-411323947", "createdAt": "2020-05-13T21:48:38Z", "commit": {"oid": "caf4357aa778ecc14fa24f6cd216e4304e47ff91"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMTo0ODozOFrOGVEu5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMjoxNDozN1rOGVFZWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1MDgyMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              void sendPeriodicPing(Eth2Peer peer) {\n          \n          \n            \n              @VisibleForTesting\n          \n          \n            \n              void sendPeriodicPing(Eth2Peer peer) {", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424750821", "createdAt": "2020-05-13T21:48:38Z", "author": {"login": "mbaxter"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -148,13 +153,25 @@ public void onConnect(final Peer peer) {\n     @SuppressWarnings(\"FutureReturnValueIgnored\")\n     SafeFuture<Void> pingTask =\n         asyncRunner.runWithFixedDelay(\n-            eth2Peer::sendPing,\n+            () -> sendPeriodicPing(eth2Peer),\n             eth2RpcPingInterval.toMillis(),\n             TimeUnit.MILLISECONDS,\n             t -> LOG.debug(\"Exception executing ping\", t));\n     peer.subscribeDisconnect(() -> pingTask.cancel(false));\n   }\n \n+  void sendPeriodicPing(Eth2Peer peer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caf4357aa778ecc14fa24f6cd216e4304e47ff91"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1NDMzNA==", "bodyText": "Not sure we need the logging on successfully sending the ping - seems noisey.", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424754334", "createdAt": "2020-05-13T21:56:58Z", "author": {"login": "mbaxter"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -148,13 +153,25 @@ public void onConnect(final Peer peer) {\n     @SuppressWarnings(\"FutureReturnValueIgnored\")\n     SafeFuture<Void> pingTask =\n         asyncRunner.runWithFixedDelay(\n-            eth2Peer::sendPing,\n+            () -> sendPeriodicPing(eth2Peer),\n             eth2RpcPingInterval.toMillis(),\n             TimeUnit.MILLISECONDS,\n             t -> LOG.debug(\"Exception executing ping\", t));\n     peer.subscribeDisconnect(() -> pingTask.cancel(false));\n   }\n \n+  void sendPeriodicPing(Eth2Peer peer) {\n+    if (peer.getOutstandingPings() >= eth2RpcOutstandingPingThreshold) {\n+      LOG.debug(\"Disconnecting the peer {} due to PING timeout.\", peer.getId());\n+      peer.disconnectCleanly(DisconnectReason.REMOTE_FAULT);\n+    } else {\n+      peer.sendPing()\n+          .finish(\n+              i -> LOG.trace(\"Periodic ping returned {} from {}\", i, peer.getId()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caf4357aa778ecc14fa24f6cd216e4304e47ff91"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1ODUzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              Eth2PeerManager getPeerManager() {\n          \n          \n            \n              @VisibleForTesting\n          \n          \n            \n              Eth2PeerManager getPeerManager() {", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424758533", "createdAt": "2020-05-13T22:07:01Z", "author": {"login": "mbaxter"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -169,4 +169,8 @@ public void unsubscribeFromAttestationSubnetId(final int subnetId) {\n   public void setLongTermAttestationSubnetSubscriptions(final Iterable<Integer> subnetIndices) {\n     attestationSubnetService.updateSubscriptions(subnetIndices);\n   }\n+\n+  Eth2PeerManager getPeerManager() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caf4357aa778ecc14fa24f6cd216e4304e47ff91"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MTM5OA==", "bodyText": "(optional) Another option for structuring this would be to have the Eth2NetworkFactory return a special subclass of Eth2Network that exposes extra test utilities (MockEth2Network.sendPeriodicPing())", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424761398", "createdAt": "2020-05-13T22:13:51Z", "author": {"login": "mbaxter"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -169,4 +169,8 @@ public void unsubscribeFromAttestationSubnetId(final int subnetId) {\n   public void setLongTermAttestationSubnetSubscriptions(final Iterable<Integer> subnetIndices) {\n     attestationSubnetService.updateSubscriptions(subnetIndices);\n   }\n+\n+  Eth2PeerManager getPeerManager() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1ODUzMw=="}, "originalCommit": {"oid": "caf4357aa778ecc14fa24f6cd216e4304e47ff91"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc2MTY4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public Eth2NetworkBuilder eth2RpcOutstandingPingThreshold(int eth2RpcOutstandingPingThreshold) {\n          \n          \n            \n              public Eth2NetworkBuilder eth2RpcOutstandingPingThreshold(final int eth2RpcOutstandingPingThreshold) {", "url": "https://github.com/ConsenSys/teku/pull/1779#discussion_r424761689", "createdAt": "2020-05-13T22:14:37Z", "author": {"login": "mbaxter"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java", "diffHunk": "@@ -178,4 +182,10 @@ public Eth2NetworkBuilder eth2RpcPingInterval(Duration eth2RpcPingInterval) {\n     this.eth2RpcPingInterval = eth2RpcPingInterval;\n     return this;\n   }\n+\n+  public Eth2NetworkBuilder eth2RpcOutstandingPingThreshold(int eth2RpcOutstandingPingThreshold) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caf4357aa778ecc14fa24f6cd216e4304e47ff91"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99fb091d1d4106e7caa4ad328f1cf5bae49af60b", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/99fb091d1d4106e7caa4ad328f1cf5bae49af60b", "committedDate": "2020-05-14T09:19:12Z", "message": "Add @VisibleForTesting annotations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a07525e3d99c9402a472042bf0937e60f5194bc7", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/a07525e3d99c9402a472042bf0937e60f5194bc7", "committedDate": "2020-05-14T09:19:46Z", "message": "Add final modifiers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53467875260a0e54c3479e154deb1e10663aebad", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/53467875260a0e54c3479e154deb1e10663aebad", "committedDate": "2020-05-14T09:20:20Z", "message": "Merge remote-tracking branch 'pegasys/master' into feature-ping-timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e0ddb4f9c33475003ab4d84191db8418f8e6fa7", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/4e0ddb4f9c33475003ab4d84191db8418f8e6fa7", "committedDate": "2020-05-14T09:37:06Z", "message": "Apply spotless"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4197, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}