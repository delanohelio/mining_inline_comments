{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MTA4NDQz", "number": 1605, "title": "Add SyncStatusTracker to consider multiple variables when deciding if the node is in sync", "bodyText": "PR Description\nIntroduces SyncStatusTracker to provide a more nuanced algorithm to determine if the node is in sync than just checking if the sync service is running a sync.\nWhen the node first starts up, it is in START_UP state.  It moves out of START_UP state when either a minimum number of peers are connected, a timeout is reached or syncing begins.  After that point if a sync is running the state is SYNCING, otherwise it's IN_SYNC.\nValidatorApiHandler only calculates duties once the node is IN_SYNC avoiding the problem of trying to process huge numbers of blocks at startup because the request for duties came in before any peers were connected.\nSyncStatusTracker is specifically designed so that in the future it can emit events indicating when the state changes (making it a push model, not just pull).\nThe minimum number of peers and timeout on startup need to be made configurable and tuned. The defaults should vary depending on the network being connected to (specifically minimal should skip START_UP as it's likely to be a single instance).", "createdAt": "2020-04-16T04:20:14Z", "url": "https://github.com/ConsenSys/teku/pull/1605", "merged": true, "mergeCommit": {"oid": "4a1d4343f2632fc12848f9b9b8e978901f98bfdf"}, "closed": true, "closedAt": "2020-04-17T22:47:06Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYEvbEgH2gAyNDA0MTA4NDQzOmU3YmRiMjVhN2RmMWY3YzIyMzMyNjVmYjZiZDc4OTBkODZkYTY1YTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYpJRbAH2gAyNDA0MTA4NDQzOjQ0NDFlOWE3NDc5MmMzYTEzYjJmZGEzZDg1OWQxNTZhODdlNmI3OTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e7bdb25a7df1f7c2233265fb6bd7890d86da65a0", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e7bdb25a7df1f7c2233265fb6bd7890d86da65a0", "committedDate": "2020-04-16T04:11:41Z", "message": "Add SyncStatusTracker that considers time since startup, sync status and number of peers when deciding if the node is up to date."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e9e3a06ae4b68596bf39745925d52c93395be8a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3e9e3a06ae4b68596bf39745925d52c93395be8a", "committedDate": "2020-04-16T04:27:37Z", "message": "Add missing dependency."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NzI1NDIx", "url": "https://github.com/ConsenSys/teku/pull/1605#pullrequestreview-394725421", "createdAt": "2020-04-16T15:02:49Z", "commit": {"oid": "3e9e3a06ae4b68596bf39745925d52c93395be8a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTowMjo1MFrOGGpx3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTowMjo1MFrOGGpx3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYyOTE1MA==", "bodyText": "As you mentioned in the description making the last two arguments constants with clear names would be nice.", "url": "https://github.com/ConsenSys/teku/pull/1605#discussion_r409629150", "createdAt": "2020-04-16T15:02:50Z", "author": {"login": "cemozerr"}, "path": "services/beaconchain/src/main/java/tech/pegasys/artemis/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -268,6 +275,13 @@ private void initEth1DataCache() {\n         });\n   }\n \n+  private void initSyncStateTracker() {\n+    LOG.debug(\"BeaconChainController.initSyncStateTracker\");\n+    // TODO: Make startup conditions configurable and set reasonable defaults based on the network\n+    syncStateTracker =\n+        new SyncStateTracker(asyncRunner, syncService, p2pNetwork, 5, Duration.ofSeconds(10));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e9e3a06ae4b68596bf39745925d52c93395be8a"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76b99557503fcabcc29921d41cffe91bc8d7c9af", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/76b99557503fcabcc29921d41cffe91bc8d7c9af", "committedDate": "2020-04-16T23:52:53Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into startup-sync-status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8485f7b7e71931825534cb48173ecea0da8d68c9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8485f7b7e71931825534cb48173ecea0da8d68c9", "committedDate": "2020-04-17T02:25:59Z", "message": "Set startup target peer count and timeout as config options with defaults based on the selected network."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4aa2906cd4cc79d22e7fa1dd0b92034a48e0d237", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4aa2906cd4cc79d22e7fa1dd0b92034a48e0d237", "committedDate": "2020-04-17T03:16:28Z", "message": "Spotless."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2163f71adfe307ca51c36a7e9ead1102acbd516e", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2163f71adfe307ca51c36a7e9ead1102acbd516e", "committedDate": "2020-04-17T03:28:06Z", "message": "Fix test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTU2Njk3", "url": "https://github.com/ConsenSys/teku/pull/1605#pullrequestreview-395556697", "createdAt": "2020-04-17T15:31:31Z", "commit": {"oid": "2163f71adfe307ca51c36a7e9ead1102acbd516e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTozMTozMVrOGHSwZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTozMTozMVrOGHSwZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMwMDUxOQ==", "bodyText": "nit: the naming of these two methods is a bit confusing since the getEffectiveValueOptional is currently the one that possibly returns null whereas getEffectiveValue wraps it in an optional", "url": "https://github.com/ConsenSys/teku/pull/1605#discussion_r410300519", "createdAt": "2020-04-17T15:31:31Z", "author": {"login": "cemozerr"}, "path": "util/src/main/java/tech/pegasys/artemis/util/config/ArtemisConfigurationBuilder.java", "diffHunk": "@@ -343,7 +363,12 @@ public ArtemisConfiguration build() {\n         restApiInterface);\n   }\n \n-  private <T> T getEffectiveValue(\n+  private <T> T getEffectiveValue(final T explicitValue, final Supplier<T> predefinedNetworkValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2163f71adfe307ca51c36a7e9ead1102acbd516e"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTU3Mjg0", "url": "https://github.com/ConsenSys/teku/pull/1605#pullrequestreview-395557284", "createdAt": "2020-04-17T15:32:14Z", "commit": {"oid": "2163f71adfe307ca51c36a7e9ead1102acbd516e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTcwOTY2", "url": "https://github.com/ConsenSys/teku/pull/1605#pullrequestreview-395570966", "createdAt": "2020-04-17T15:49:20Z", "commit": {"oid": "2163f71adfe307ca51c36a7e9ead1102acbd516e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTo0OToyMFrOGHTatw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTo0OToyMFrOGHTatw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMxMTM1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    () -> {\n          \n          \n            \n                    () -> SafeFuture.fromRunnable(action)", "url": "https://github.com/ConsenSys/teku/pull/1605#discussion_r410311351", "createdAt": "2020-04-17T15:49:20Z", "author": {"login": "mbaxter"}, "path": "util/src/main/java/tech/pegasys/artemis/util/async/AsyncRunner.java", "diffHunk": "@@ -27,6 +27,17 @@\n   <U> SafeFuture<U> runAfterDelay(\n       Supplier<SafeFuture<U>> action, long delayAmount, TimeUnit delayUnit);\n \n+  default SafeFuture<Void> runAfterDelay(\n+      final Runnable action, long delayAmount, TimeUnit delayUnit) {\n+    return runAfterDelay(\n+        () -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2163f71adfe307ca51c36a7e9ead1102acbd516e"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "930fafecd37886a6439bb2902e63518036f479d6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/930fafecd37886a6439bb2902e63518036f479d6", "committedDate": "2020-04-17T22:26:22Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into startup-sync-status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27e7236a13419eff0bbfa78b3bebea26b7d8b464", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/27e7236a13419eff0bbfa78b3bebea26b7d8b464", "committedDate": "2020-04-17T22:27:33Z", "message": "Use SafeFuture.fromRunnable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43dda5a48600f8e1c0c99f8f8a717b064744c7d9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/43dda5a48600f8e1c0c99f8f8a717b064744c7d9", "committedDate": "2020-04-17T22:29:50Z", "message": "Rename method for clarity."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4441e9a74792c3a13b2fda3d859d156a87e6b796", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4441e9a74792c3a13b2fda3d859d156a87e6b796", "committedDate": "2020-04-17T22:36:30Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into startup-sync-status"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4299, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}