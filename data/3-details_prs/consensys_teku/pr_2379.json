{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxNDgzOTYx", "number": 2379, "title": "[Issue 2291] Validate gossip async", "bodyText": "PR Description\nUse new async retrieveBlockState method to pull states when validating gossip messages.\nFixed Issue(s)\nPart of #2291\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-07-17T21:48:13Z", "url": "https://github.com/ConsenSys/teku/pull/2379", "merged": true, "mergeCommit": {"oid": "5bed8bfcfbf026ac5eb3d6cb8cf3a0cb4d1ed3e7"}, "closed": true, "closedAt": "2020-07-20T17:53:30Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc165CqAH2gAyNDUxNDgzOTYxOjE3ZGNiNmYyN2IzOTRhZmE4OTUxNjJlMmY3MjYxODNkZTYyZDc4ZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc21S6SgH2gAyNDUxNDgzOTYxOjhjNjFmMmZhZWI4N2UzZTIzMjBjNzQ2OTYxMGQwMDI3NGMwNGZiYzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "17dcb6f27b394afa895162e2f726183de62d78e8", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/17dcb6f27b394afa895162e2f726183de62d78e8", "committedDate": "2020-07-17T21:40:52Z", "message": "Rework gossip topic handlers to return a validation future"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02c61470d3551222068d08876065038fb7ba8a58", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/02c61470d3551222068d08876065038fb7ba8a58", "committedDate": "2020-07-17T21:40:52Z", "message": "Update gossip validators to use new async retrieveBlockState method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf6434163fdfa9fb05dc646b7d612f3679df24d5", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/bf6434163fdfa9fb05dc646b7d612f3679df24d5", "committedDate": "2020-07-17T21:59:10Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb2e7fb52235844fe034d2589997f385aebf45ce", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/eb2e7fb52235844fe034d2589997f385aebf45ce", "committedDate": "2020-07-17T22:12:26Z", "message": "Update BlockValidator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dc6097016b6772769b0c4de18799fa557c566f5", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/9dc6097016b6772769b0c4de18799fa557c566f5", "committedDate": "2020-07-17T22:54:32Z", "message": "Merge branch 'master' into issue-2291/validate-gossip-async"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f12a78ffd11b501a818589b718095445da501e99", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f12a78ffd11b501a818589b718095445da501e99", "committedDate": "2020-07-17T23:08:56Z", "message": "Incorporate changes from master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMTc2MTY2", "url": "https://github.com/ConsenSys/teku/pull/2379#pullrequestreview-451176166", "createdAt": "2020-07-20T00:03:40Z", "commit": {"oid": "f12a78ffd11b501a818589b718095445da501e99"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMDowMzo0MVrOGzzaNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMDoyMDoyOFrOGzzh-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3Mjg1NA==", "bodyText": "Probably outside the scope of this PR but does this wind up doing the validation on the netty thread or have we already jumped off of it?\nBecause if we've got SafeFuture involved anyway it would be good to delegate validation to a worker pool and not block the netty threads.", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r456972854", "createdAt": "2020-07-20T00:03:41Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/AttesterSlashingTopicHandler.java", "diffHunk": "@@ -92,7 +81,9 @@ public Bytes4 getForkDigest() {\n     return forkDigest;\n   }\n \n-  protected InternalValidationResult validateData(final AttesterSlashing attesterSlashing) {\n-    return validator.validate(attesterSlashing);\n+  @Override\n+  protected SafeFuture<InternalValidationResult> validateData(\n+      final AttesterSlashing attesterSlashing) {\n+    return SafeFuture.completedFuture(validator.validate(attesterSlashing));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f12a78ffd11b501a818589b718095445da501e99"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDMzMg==", "bodyText": "Shouldn't Store automatically take care of caching for us?  We're also only loading one state and creating a new cache each time so I don't think this can wind up ever being useful.", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r456974332", "createdAt": "2020-07-20T00:16:39Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java", "diffHunk": "@@ -211,6 +229,23 @@ private UnsignedLong maximumBroadcastTimeMillis(final UnsignedLong attestationSl\n     return secondsToMillis(lastAllowedTime).plus(MAXIMUM_GOSSIP_CLOCK_DISPARITY);\n   }\n \n+  StateProvider createStateProvider() {\n+    return createStateProvider(recentChainData);\n+  }\n+\n+  @VisibleForTesting\n+  static StateProvider createStateProvider(final RecentChainData recentChainData) {\n+    LoadingCache<Bytes32, SafeFuture<Optional<BeaconState>>> cache =\n+        CacheBuilder.newBuilder().build(CacheLoader.from(recentChainData::retrieveBlockState));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f12a78ffd11b501a818589b718095445da501e99"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDg0Mw==", "bodyText": "Oh I see we do reuse it in SignedAggregateAndProofValidator.  I suspect leaving the caching to the Store is likely to be the right answer still.", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r456974843", "createdAt": "2020-07-20T00:20:28Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java", "diffHunk": "@@ -211,6 +229,23 @@ private UnsignedLong maximumBroadcastTimeMillis(final UnsignedLong attestationSl\n     return secondsToMillis(lastAllowedTime).plus(MAXIMUM_GOSSIP_CLOCK_DISPARITY);\n   }\n \n+  StateProvider createStateProvider() {\n+    return createStateProvider(recentChainData);\n+  }\n+\n+  @VisibleForTesting\n+  static StateProvider createStateProvider(final RecentChainData recentChainData) {\n+    LoadingCache<Bytes32, SafeFuture<Optional<BeaconState>>> cache =\n+        CacheBuilder.newBuilder().build(CacheLoader.from(recentChainData::retrieveBlockState));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDMzMg=="}, "originalCommit": {"oid": "f12a78ffd11b501a818589b718095445da501e99"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b65e37bed9d143c44947d59d7ae473b46901f026", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/b65e37bed9d143c44947d59d7ae473b46901f026", "committedDate": "2020-07-20T17:35:21Z", "message": "Simplify state retrieval - rely on Store cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c61f2faeb87e3e2320c7469610d00274c04fbc3", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8c61f2faeb87e3e2320c7469610d00274c04fbc3", "committedDate": "2020-07-20T17:43:37Z", "message": "Merge branch 'master' into issue-2291/validate-gossip-async"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3649, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}