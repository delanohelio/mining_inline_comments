{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxOTYyNDk1", "number": 3237, "title": "Add `correct` validator metrics", "bodyText": "PR Description\nAdd beacon_current_correct_validators and beacon_previous_correct_validators metrics that returns the number of validators with correct attestations, meaning that they got both the source and target checkpoints correctly.\nThese metrics will allow us a more accurate view of proximity to finalisation.\nFixed Issue(s)\n\n\nFixes #2630\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-16T21:15:37Z", "url": "https://github.com/ConsenSys/teku/pull/3237", "merged": true, "mergeCommit": {"oid": "66c5e477c00409ca0c90beefd37226c67554f5a7"}, "closed": true, "closedAt": "2020-11-18T13:15:44Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddLmKsgH2gAyNTIxOTYyNDk1OmZmMmMyYjU0ODZmNTNhNTU5OTBmYzUzZDk4NDBhOTMzYmJhYjFhMGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddtvJkAH2gAyNTIxOTYyNDk1OjRmNWUxODY0YzYzZGMzNjU5MmQxMzNhMGY3NjFiY2Q1MjEwMGNkZTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ff2c2b5486f53a55990fc53d9840a933bbab1a0e", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/ff2c2b5486f53a55990fc53d9840a933bbab1a0e", "committedDate": "2020-11-16T21:11:41Z", "message": "Add 'correct' validator metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97a59406618a2e4435af011ac0490a1fed567fb1", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/97a59406618a2e4435af011ac0490a1fed567fb1", "committedDate": "2020-11-16T21:39:33Z", "message": "Remove redundant line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3908927657f0ea1965dbe0998036c91c554facee", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/3908927657f0ea1965dbe0998036c91c554facee", "committedDate": "2020-11-16T21:45:29Z", "message": "Merge branch 'master' into addCorrectValidatorsMetrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "611b9cd8f3553a8218c682699cb1d2e8607401c7", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/611b9cd8f3553a8218c682699cb1d2e8607401c7", "committedDate": "2020-11-16T22:33:24Z", "message": "Fix old test breaking change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTAwNDkz", "url": "https://github.com/ConsenSys/teku/pull/3237#pullrequestreview-531900493", "createdAt": "2020-11-16T23:16:27Z", "commit": {"oid": "611b9cd8f3553a8218c682699cb1d2e8607401c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzoxNjoyOFrOH0bGQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzoxNjoyOFrOH0bGQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDczMTk2OQ==", "bodyText": "I think we should avoid iterating through all the attestations twice. We just need to iterate through once, counting both total validators and correct validators.  Likely that will be easiest if you just an old fashioned for loop rather than streams.", "url": "https://github.com/ConsenSys/teku/pull/3237#discussion_r524731969", "createdAt": "2020-11-16T23:16:28Z", "author": {"login": "ajsutton"}, "path": "services/beaconchain/src/main/java/tech/pegasys/teku/services/beaconchain/BeaconChainMetrics.java", "diffHunk": "@@ -173,15 +194,35 @@ private void updateMetrics(final BeaconState state) {\n   }\n \n   private int getLiveValidators(final SSZList<PendingAttestation> attestations) {\n-    final Map<UInt64, Map<UInt64, Bitlist>> aggregationBitsBySlotAndCommittee = new HashMap<>();\n-    attestations.forEach(\n+    return getNumberOfValidators(attestations, (__) -> true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "611b9cd8f3553a8218c682699cb1d2e8607401c7"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f44cf4ed87b44f203d4598d95850e7bea62a266", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/1f44cf4ed87b44f203d4598d95850e7bea62a266", "committedDate": "2020-11-17T17:48:43Z", "message": "Pass through attesation lists once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2027940ead7f1606d83c30b244a91aa83848c55d", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/2027940ead7f1606d83c30b244a91aa83848c55d", "committedDate": "2020-11-17T18:15:47Z", "message": "Remove extra parantheses"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTI5MzU0", "url": "https://github.com/ConsenSys/teku/pull/3237#pullrequestreview-532929354", "createdAt": "2020-11-18T00:46:06Z", "commit": {"oid": "2027940ead7f1606d83c30b244a91aa83848c55d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f5e1864c63dc36592d133a0f761bcd52100cde6", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/4f5e1864c63dc36592d133a0f761bcd52100cde6", "committedDate": "2020-11-18T12:58:16Z", "message": "Merge branch 'master' into addCorrectValidatorsMetrics"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4455, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}