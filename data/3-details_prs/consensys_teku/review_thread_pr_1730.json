{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0Mjc4NDY5", "number": 1730, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo1NzowMFrOD5_iJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMTowNzozN1rOD5_xlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMTM2MzU5OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo1NzowMFrOGRlHIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMjo0MzoyNVrOGRoAhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4NzAxMQ==", "bodyText": "Should we return here rather than ploughing on into a NullPointerException?", "url": "https://github.com/ConsenSys/teku/pull/1730#discussion_r421087011", "createdAt": "2020-05-06T20:57:00Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "diffHunk": "@@ -133,17 +131,31 @@ public Store getStore() {\n    * @param slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {\n-    final Optional<Bytes32> originalBestRoot = bestBlockRoot;\n-    final UnsignedLong originalBestSlot = bestSlot;\n-    this.bestBlockRoot = Optional.of(root);\n-    this.bestSlot = slot;\n-    bestBlockInitialized.complete(null);\n-\n-    if (originalBestRoot\n-        .map(original -> hasReorgedFrom(original, originalBestSlot))\n-        .orElse(false)) {\n-      reorgEventChannel.reorgOccurred(root, bestSlot);\n+    synchronized (this) {\n+      final SignedBeaconBlock newBestBlock = store.getSignedBlock(root);\n+      final BeaconState newBestState = store.getBlockState(root);\n+      if (newBestBlock == null || newBestState == null) {\n+        LOG.warn(\n+            \"Unable to update best block (slot={}, root={}). Corresponding {} unavailable\",\n+            slot,\n+            root,\n+            newBestBlock == null ? \"block\" : \"state\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c25ec72bba195899e7a5b5184e446f4d06c106ab"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEzNDQ2OA==", "bodyText": "yes - good catch!! \ud83e\udd26\u200d\u2640\ufe0f", "url": "https://github.com/ConsenSys/teku/pull/1730#discussion_r421134468", "createdAt": "2020-05-06T22:43:25Z", "author": {"login": "mbaxter"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "diffHunk": "@@ -133,17 +131,31 @@ public Store getStore() {\n    * @param slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {\n-    final Optional<Bytes32> originalBestRoot = bestBlockRoot;\n-    final UnsignedLong originalBestSlot = bestSlot;\n-    this.bestBlockRoot = Optional.of(root);\n-    this.bestSlot = slot;\n-    bestBlockInitialized.complete(null);\n-\n-    if (originalBestRoot\n-        .map(original -> hasReorgedFrom(original, originalBestSlot))\n-        .orElse(false)) {\n-      reorgEventChannel.reorgOccurred(root, bestSlot);\n+    synchronized (this) {\n+      final SignedBeaconBlock newBestBlock = store.getSignedBlock(root);\n+      final BeaconState newBestState = store.getBlockState(root);\n+      if (newBestBlock == null || newBestState == null) {\n+        LOG.warn(\n+            \"Unable to update best block (slot={}, root={}). Corresponding {} unavailable\",\n+            slot,\n+            root,\n+            newBestBlock == null ? \"block\" : \"state\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4NzAxMQ=="}, "originalCommit": {"oid": "c25ec72bba195899e7a5b5184e446f4d06c106ab"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMTQwMzA4OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMTowNzozN1rOGRlecA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMjo0NToyMVrOGRoDew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA5Mjk3Ng==", "bodyText": "nit: it might be nicer to use this\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void updateBestBlock(Bytes32 root, UnsignedLong slot) {\n          \n          \n            \n              public synchronized void updateBestBlock(Bytes32 root, UnsignedLong slot) {", "url": "https://github.com/ConsenSys/teku/pull/1730#discussion_r421092976", "createdAt": "2020-05-06T21:07:37Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "diffHunk": "@@ -133,17 +131,31 @@ public Store getStore() {\n    * @param slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c25ec72bba195899e7a5b5184e446f4d06c106ab"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEzNTIyNw==", "bodyText": "I used a synchronized block because I didn't want to end up executing whatever is hanging off of bestBlockInitialized in the synchronized section.", "url": "https://github.com/ConsenSys/teku/pull/1730#discussion_r421135227", "createdAt": "2020-05-06T22:45:21Z", "author": {"login": "mbaxter"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "diffHunk": "@@ -133,17 +131,31 @@ public Store getStore() {\n    * @param slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA5Mjk3Ng=="}, "originalCommit": {"oid": "c25ec72bba195899e7a5b5184e446f4d06c106ab"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3769, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}