{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MTk0NDU3", "number": 1990, "title": "Poll the chain head to detect new blocks instead of using a filter", "bodyText": "PR Description\neth_newBlockFilter is not supported by Infura over HTTP and is actually less efficient as it winds up polling more frequently and doesn't skip blocks if the chain progresses by more than one block in the polling period.\nInstead of the filter, we now just request the latest block periodically.", "createdAt": "2020-05-28T01:24:49Z", "url": "https://github.com/ConsenSys/teku/pull/1990", "merged": true, "mergeCommit": {"oid": "2d5c94bcef80821af5742b9987b7937d6b895207"}, "closed": true, "closedAt": "2020-05-28T21:19:13Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclje4IgH2gAyNDI0MTk0NDU3OjI0MjdmN2U2Njg0NDk3MDg1ODg1Y2U3MDY0ZDJlYWMwMWNjZjMzMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl0NbwgH2gAyNDI0MTk0NDU3OmU0NWVkYjRhMDM1MTU5ZTk5MTdiYjk4ZWNjMzI2YjRmYmVkMmM4NTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2427f7e6684497085885ce7064d2eac01ccf3315", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2427f7e6684497085885ce7064d2eac01ccf3315", "committedDate": "2020-05-28T01:21:41Z", "message": "Poll the chain head to detect new blocks instead of using a filter.\neth_newBlockFilter is not supported by Infura over HTTP and is actually less efficient."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ae3f49449ed3e07c1aaa8eef95d34966d2bb229", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7ae3f49449ed3e07c1aaa8eef95d34966d2bb229", "committedDate": "2020-05-28T01:25:21Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into infura-support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTczMDA4", "url": "https://github.com/ConsenSys/teku/pull/1990#pullrequestreview-420173008", "createdAt": "2020-05-28T14:31:17Z", "commit": {"oid": "7ae3f49449ed3e07c1aaa8eef95d34966d2bb229"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDozMToxN1rOGb370Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDozMToxN1rOGb370Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4MTE2OQ==", "bodyText": "There is a possibility that running pollLatestHead every SECONDS_PER_ETH1_BLOCK leads to us trailing almost a block behind the ETH1_FOLLOW_DISTANCE. Not sure if that would be a problem.", "url": "https://github.com/ConsenSys/teku/pull/1990#discussion_r431881169", "createdAt": "2020-05-28T14:31:17Z", "author": {"login": "cemozerr"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/Eth1HeadTracker.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.pow;\n+\n+import static tech.pegasys.teku.util.config.Constants.ETH1_FOLLOW_DISTANCE;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Optional;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.web3j.protocol.core.methods.response.EthBlock.Block;\n+import tech.pegasys.teku.util.async.AsyncRunner;\n+import tech.pegasys.teku.util.config.Constants;\n+import tech.pegasys.teku.util.events.Subscribers;\n+\n+public class Eth1HeadTracker {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final AtomicBoolean running = new AtomicBoolean(false);\n+  private final AsyncRunner asyncRunner;\n+  private final Eth1Provider eth1Provider;\n+  private Optional<UnsignedLong> headAtFollowDistance = Optional.empty();\n+\n+  private final Subscribers<HeadUpdatedSubscriber> subscribers = Subscribers.create(true);\n+\n+  public Eth1HeadTracker(final AsyncRunner asyncRunner, final Eth1Provider eth1Provider) {\n+    this.asyncRunner = asyncRunner;\n+    this.eth1Provider = eth1Provider;\n+  }\n+\n+  public void start() {\n+    if (!running.compareAndSet(false, true)) {\n+      return;\n+    }\n+    pollLatestHead();\n+  }\n+\n+  private void pollLatestHead() {\n+    if (!running.get()) {\n+      return;\n+    }\n+    eth1Provider\n+        .getLatestEth1Block()\n+        .thenAccept(this::onLatestBlockHead)\n+        .exceptionally(\n+            error -> {\n+              LOG.warn(\"Failed to get latest ETH1 chain head. Will retry.\", error);\n+              return null;\n+            })\n+        .always(\n+            () ->\n+                asyncRunner\n+                    .runAfterDelay(\n+                        this::pollLatestHead,\n+                        Constants.SECONDS_PER_ETH1_BLOCK.longValue(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ae3f49449ed3e07c1aaa8eef95d34966d2bb229"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTc1NzA2", "url": "https://github.com/ConsenSys/teku/pull/1990#pullrequestreview-420175706", "createdAt": "2020-05-28T14:34:04Z", "commit": {"oid": "7ae3f49449ed3e07c1aaa8eef95d34966d2bb229"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDozNDowNFrOGb4GbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDozNDowNFrOGb4GbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4Mzg4NQ==", "bodyText": "nit: to keep the method names in line, you might want to either add Future to the end of this method name or remove all the Futures from the method names above.", "url": "https://github.com/ConsenSys/teku/pull/1990#discussion_r431883885", "createdAt": "2020-05-28T14:34:04Z", "author": {"login": "cemozerr"}, "path": "pow/src/main/java/tech/pegasys/teku/pow/Eth1Provider.java", "diffHunk": "@@ -31,7 +28,7 @@\n \n   SafeFuture<Block> getGuaranteedEth1BlockFuture(UnsignedLong blockNumber);\n \n-  SafeFuture<Block> getLatestEth1BlockFuture();\n+  SafeFuture<Block> getLatestEth1Block();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ae3f49449ed3e07c1aaa8eef95d34966d2bb229"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTk1NDY4", "url": "https://github.com/ConsenSys/teku/pull/1990#pullrequestreview-420195468", "createdAt": "2020-05-28T14:53:31Z", "commit": {"oid": "7ae3f49449ed3e07c1aaa8eef95d34966d2bb229"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3540647969a6c043874df5d8906d4a4d237ab4c", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e3540647969a6c043874df5d8906d4a4d237ab4c", "committedDate": "2020-05-28T20:50:47Z", "message": "Complete rename."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e45edb4a035159e9917bb98ecc326b4fbed2c855", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e45edb4a035159e9917bb98ecc326b4fbed2c855", "committedDate": "2020-05-28T20:51:01Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into infura-support"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4052, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}