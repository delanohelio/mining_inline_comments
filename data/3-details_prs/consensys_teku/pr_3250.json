{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyODgyNzgy", "number": 3250, "title": "TLS configuration for external signer", "bodyText": "PR Description\nAdditional options to configure keystore and truststore for TLS communication and authentication with external signer.\nFixed Issue(s)\n\n\n#3121\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-18T03:22:56Z", "url": "https://github.com/ConsenSys/teku/pull/3250", "merged": true, "mergeCommit": {"oid": "79efe75f6308386994112264aaa97dbd5b6c214f"}, "closed": true, "closedAt": "2020-12-08T07:12:06Z", "author": {"login": "usmansaleem"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddld6eAH2gAyNTIyODgyNzgyOjRiZTI5YzU2OWY0ZGIxZmMyMmFhNjQxZGI3NTc1YTkxODQ2NDg4NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkEbFpgH2gAyNTIyODgyNzgyOjMxMWExZDc1MWE2NDQ1ZWYxNzA1NDRjYjZiMzNlYTY0NDNiOGI1ZGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4be29c569f4db1fc22aa641db7575a9184648858", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/4be29c569f4db1fc22aa641db7575a9184648858", "committedDate": "2020-11-18T03:20:12Z", "message": "TLS configuration for external signer\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7af3e0d70367506a85dd0656d7a3bb464eebc09d", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/7af3e0d70367506a85dd0656d7a3bb464eebc09d", "committedDate": "2020-11-18T03:29:26Z", "message": "Use SecureRandomProvider\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTk2NzQ2", "url": "https://github.com/ConsenSys/teku/pull/3250#pullrequestreview-533996746", "createdAt": "2020-11-19T00:47:39Z", "commit": {"oid": "7af3e0d70367506a85dd0656d7a3bb464eebc09d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo0Nzo0MFrOH2IJ8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo0Nzo0MFrOH2IJ8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxODc3MQ==", "bodyText": "to me, this looks to say that they must both be null, or it's invalid configuration?", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r526518771", "createdAt": "2020-11-19T00:47:40Z", "author": {"login": "rolfyone"}, "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java", "diffHunk": "@@ -243,5 +300,38 @@ private void validateKeyStoreFilesAndPasswordFilesConfig() {\n         throw new InvalidConfigurationException(errorMessage);\n       }\n     }\n+\n+    private void validateExternalSignerUrlAndPublicKeys() {\n+      if (validatorExternalSignerPublicKeys == null\n+          || validatorExternalSignerPublicKeys.isEmpty()) {\n+        return;\n+      }\n+\n+      if (validatorExternalSignerUrl == null) {\n+        final String errorMessage =\n+            \"Invalid configuration. '--validators-external-signer-url' and '--validators-external-signer-public-keys' must be specified together\";\n+        throw new InvalidConfigurationException(errorMessage);\n+      }\n+    }\n+\n+    private void validateExternalSignerKeystoreAndPasswordFileConfig() {\n+      if (validatorExternalSignerKeystore == null\n+          && validatorExternalSignerKeystorePasswordFile == null) {\n+        return;\n+      }\n+      final String errorMessage =\n+          \"Invalid configuration. '--validators-external-signer-keystore' and '--validators-external-signer-keystore-password-file' must be specified together\";\n+      throw new InvalidConfigurationException(errorMessage);\n+    }\n+\n+    private void validateExternalSignerTruststoreAndPasswordFileConfig() {\n+      if (validatorExternalSignerTruststore == null\n+          && validatorExternalSignerTruststorePasswordFile == null) {\n+        return;\n+      }\n+      final String errorMessage =\n+          \"Invalid configuration. '--validators-external-signer-truststore' and '--validators-external-signer-truststore-password-file' must be specified together\";\n+      throw new InvalidConfigurationException(errorMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7af3e0d70367506a85dd0656d7a3bb464eebc09d"}, "originalPosition": 148}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTk3MDc0", "url": "https://github.com/ConsenSys/teku/pull/3250#pullrequestreview-533997074", "createdAt": "2020-11-19T00:48:40Z", "commit": {"oid": "7af3e0d70367506a85dd0656d7a3bb464eebc09d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo0ODo0MVrOH2ILEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo0ODo0MVrOH2ILEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxOTA1OQ==", "bodyText": "not sure this check is correct either, like validatorExternalSignerTruststoreAndPasswordFileConfig seems to require they're both null...", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r526519059", "createdAt": "2020-11-19T00:48:41Z", "author": {"login": "rolfyone"}, "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java", "diffHunk": "@@ -243,5 +300,38 @@ private void validateKeyStoreFilesAndPasswordFilesConfig() {\n         throw new InvalidConfigurationException(errorMessage);\n       }\n     }\n+\n+    private void validateExternalSignerUrlAndPublicKeys() {\n+      if (validatorExternalSignerPublicKeys == null\n+          || validatorExternalSignerPublicKeys.isEmpty()) {\n+        return;\n+      }\n+\n+      if (validatorExternalSignerUrl == null) {\n+        final String errorMessage =\n+            \"Invalid configuration. '--validators-external-signer-url' and '--validators-external-signer-public-keys' must be specified together\";\n+        throw new InvalidConfigurationException(errorMessage);\n+      }\n+    }\n+\n+    private void validateExternalSignerKeystoreAndPasswordFileConfig() {\n+      if (validatorExternalSignerKeystore == null\n+          && validatorExternalSignerKeystorePasswordFile == null) {\n+        return;\n+      }\n+      final String errorMessage =\n+          \"Invalid configuration. '--validators-external-signer-keystore' and '--validators-external-signer-keystore-password-file' must be specified together\";\n+      throw new InvalidConfigurationException(errorMessage);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7af3e0d70367506a85dd0656d7a3bb464eebc09d"}, "originalPosition": 139}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45c27e4a4fbde7cf48f5fbf22108d85e348b2e5c", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/45c27e4a4fbde7cf48f5fbf22108d85e348b2e5c", "committedDate": "2020-11-19T01:25:55Z", "message": "modified validation condition and added unit test cases\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db8817bcf2d57a202989ff540da2e0abb41f4a06", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/db8817bcf2d57a202989ff540da2e0abb41f4a06", "committedDate": "2020-11-19T01:38:18Z", "message": "more unit tests\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDYzOTk4", "url": "https://github.com/ConsenSys/teku/pull/3250#pullrequestreview-534063998", "createdAt": "2020-11-19T03:55:35Z", "commit": {"oid": "db8817bcf2d57a202989ff540da2e0abb41f4a06"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMzo1NTozNVrOH2Lyuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMzo1NTozNVrOH2Lyuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU3ODM2Mw==", "bodyText": "i think having the supplier be final is probably a better pattern, than allowing it to be set just for testing.\nMaybe what we want is a second 'create' function that allows the supplier to be provided during create time to allow for this testing? it could be package private, just used in testing...", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r526578363", "createdAt": "2020-11-19T03:55:35Z", "author": {"login": "rolfyone"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "diffHunk": "@@ -45,25 +45,22 @@\n \n   private final SlashingProtector slashingProtector;\n   private final AsyncRunner asyncRunner;\n-  private final Supplier<HttpClient> remoteValidatorHttpClientFactory;\n+  private Supplier<HttpClient> externalValidatorHttpClientFactory;\n \n-  @VisibleForTesting\n-  ValidatorLoader(\n-      final SlashingProtector slashingProtector,\n-      final AsyncRunner asyncRunner,\n-      final Supplier<HttpClient> remoteValidatorHttpClientFactory) {\n+  private ValidatorLoader(\n+      final SlashingProtector slashingProtector, final AsyncRunner asyncRunner) {\n     this.slashingProtector = slashingProtector;\n     this.asyncRunner = asyncRunner;\n-    this.remoteValidatorHttpClientFactory = remoteValidatorHttpClientFactory;\n   }\n \n   public static ValidatorLoader create(\n       final SlashingProtector slashingProtector, final AsyncRunner asyncRunner) {\n-    return new ValidatorLoader(\n-        slashingProtector,\n-        asyncRunner,\n-        Suppliers.memoize(\n-            () -> HttpClient.newBuilder().version(HttpClient.Version.HTTP_1_1).build()));\n+    return new ValidatorLoader(slashingProtector, asyncRunner);\n+  }\n+\n+  @VisibleForTesting\n+  void setExternalValidatorHttpClientFactory(final Supplier<HttpClient> httpClientSupplier) {\n+    this.externalValidatorHttpClientFactory = httpClientSupplier;\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db8817bcf2d57a202989ff540da2e0abb41f4a06"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc96d80e75d779003f6ca33391b2d8be8ee780b", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/dcc96d80e75d779003f6ca33391b2d8be8ee780b", "committedDate": "2020-11-19T04:12:07Z", "message": "refactor external signer httpclient factory to initialize validators\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0ODExNTE0", "url": "https://github.com/ConsenSys/teku/pull/3250#pullrequestreview-534811514", "createdAt": "2020-11-19T20:11:39Z", "commit": {"oid": "dcc96d80e75d779003f6ca33391b2d8be8ee780b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8ee76ce89c3b8b96cf32c00d357b2ce00cc74b0", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/e8ee76ce89c3b8b96cf32c00d357b2ce00cc74b0", "committedDate": "2020-11-19T23:33:10Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50b442ab29bb1642799f24fe829c49aa950161e2", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/50b442ab29bb1642799f24fe829c49aa950161e2", "committedDate": "2020-11-23T05:11:28Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcfa97c8e90f8c19c1b3abe92c60f6c0626dde24", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/fcfa97c8e90f8c19c1b3abe92c60f6c0626dde24", "committedDate": "2020-11-24T23:24:40Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed5cc7e5dcff9d9995e9e529546ff868c54d9145", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/ed5cc7e5dcff9d9995e9e529546ff868c54d9145", "committedDate": "2020-11-25T10:49:42Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2a30ae131b80e812acc29078da8751e49216f69", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/e2a30ae131b80e812acc29078da8751e49216f69", "committedDate": "2020-11-25T12:20:55Z", "message": "Add external signer upcheck at start up\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a887ad8c7d10031f1a185c1f909a533b1204e63", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/3a887ad8c7d10031f1a185c1f909a533b1204e63", "committedDate": "2020-11-25T12:59:29Z", "message": "fixing validator unit test case\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cb79d029f5d38e4143c3ae58d70d5b3c18c680d", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/9cb79d029f5d38e4143c3ae58d70d5b3c18c680d", "committedDate": "2020-11-25T20:49:54Z", "message": "simplifying comparison\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/326b72dcb311346fc18da0edf4a732297ea0fcea", "committedDate": "2020-11-30T00:18:07Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTQzMjk4", "url": "https://github.com/ConsenSys/teku/pull/3250#pullrequestreview-540543298", "createdAt": "2020-11-30T00:43:51Z", "commit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMDo0Mzo1MVrOH7oxJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMDo0Mzo1MVrOH7oxJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI5NTk3Mg==", "bodyText": "these look like they're added in just to satisfy the test? maybe just put them in a @BeforeEach if they're not important for the test?\nIf they're expected, we might want to verify they occur...", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r532295972", "createdAt": "2020-11-30T00:43:51Z", "author": {"login": "rolfyone"}, "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/loader/ValidatorLoaderTest.java", "diffHunk": "@@ -151,6 +160,9 @@ void initializeValidatorsWithBothLocalAndExternalSigners(@TempDir Path tempDir)\n                         + File.pathSeparator\n                         + tempDir.toAbsolutePath().toString()))\n             .build();\n+    when(httpClient.send(any(), ArgumentMatchers.<HttpResponse.BodyHandler<Void>>any()))\n+        .thenReturn(upcheckResponse);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTQzODU0", "url": "https://github.com/ConsenSys/teku/pull/3250#pullrequestreview-540543854", "createdAt": "2020-11-30T00:47:10Z", "commit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMDo0NzoxMFrOH7oz4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMDo0NzoxMFrOH7oz4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI5NjY3Mg==", "bodyText": "I just wonder if this log message should also be displayed if the signer disappears?\nI'm not sure I see anywhere specifically in this latest set of changes, but maybe if the signer stops responding, raising this message would be a useful warning...", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r532296672", "createdAt": "2020-11-30T00:47:10Z", "author": {"login": "rolfyone"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "diffHunk": "@@ -99,8 +101,20 @@ public static ValidatorLoader create(\n \n   private Map<BLSPublicKey, Validator> createExternalSignerValidator(\n       final ValidatorConfig config, final Supplier<HttpClient> externalSignerHttpClientFactory) {\n+    if (config.getValidatorExternalSignerPublicKeys().isEmpty()) {\n+      return Collections.emptyMap();\n+    }\n+\n     final Duration timeout = Duration.ofMillis(config.getValidatorExternalSignerTimeout());\n \n+    final boolean isReachable =\n+        new ExternalSignerUpcheck(\n+                externalSignerHttpClientFactory.get(),\n+                config.getValidatorExternalSignerUrl(),\n+                timeout)\n+            .upcheck();\n+    STATUS_LOG.externalSignerStatus(config.getValidatorExternalSignerUrl(), isReachable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTQyNzYx", "url": "https://github.com/ConsenSys/teku/pull/3250#pullrequestreview-540542761", "createdAt": "2020-11-30T00:39:55Z", "commit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMDozOTo1NVrOH7ouwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMDo1MTozM1rOH7o2tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI5NTM2MQ==", "bodyText": "nit: I'd make this an error and it's probably worth making it red with ColorConsolePrinter.print.", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r532295361", "createdAt": "2020-11-30T00:39:55Z", "author": {"login": "ajsutton"}, "path": "infrastructure/logging/src/main/java/tech/pegasys/teku/infrastructure/logging/StatusLogger.java", "diffHunk": "@@ -228,4 +229,12 @@ public void eth1DepositChainIdMismatch(int expectedChainId, int eth1ChainId) {\n         expectedChainId,\n         eth1ChainId);\n   }\n+\n+  public void externalSignerStatus(final URL externalSignerUrl, boolean isReachable) {\n+    if (isReachable) {\n+      log.info(\"External signer is reachable at {}\", externalSignerUrl);\n+    } else {\n+      log.warn(\"External signer is currently not reachable at {}\", externalSignerUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI5NTU3NQ==", "bodyText": "We should make this description specific to this type of keystore rather than having the same description as validators-external-signer-truststore-password-file", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r532295575", "createdAt": "2020-11-30T00:41:09Z", "author": {"login": "ajsutton"}, "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorKeysOptions.java", "diffHunk": "@@ -80,6 +81,35 @@\n       arity = \"1\")\n   private int validatorExternalSignerTimeout = 1000;\n \n+  @CommandLine.Option(\n+      names = {\"--validators-external-signer-keystore\"},\n+      paramLabel = \"<FILE>\",\n+      description =\n+          \"Keystore (PKCS12/JKS) to use for TLS mutual authentication with external signer\",\n+      arity = \"1\")\n+  private String validatorExternalSignerKeystore = null;\n+\n+  @CommandLine.Option(\n+      names = {\"--validators-external-signer-keystore-password-file\"},\n+      paramLabel = \"<FILE>\",\n+      description = \"Password file for keystore\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI5NTkwNQ==", "bodyText": "Should we refuse to start if ssl keystores are specified but the URL is http only? Validation would probably happen in ValidatorConfig I guess.", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r532295905", "createdAt": "2020-11-30T00:43:31Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/HttpClientExternalSignerFactory.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.net.http.HttpClient;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyManagementException;\n+import java.security.KeyStore;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.function.Supplier;\n+import javax.net.ssl.KeyManager;\n+import javax.net.ssl.KeyManagerFactory;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.TrustManagerFactory;\n+import org.apache.commons.lang3.tuple.Pair;\n+import tech.pegasys.teku.infrastructure.crypto.SecureRandomProvider;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+import tech.pegasys.teku.validator.api.ValidatorConfig;\n+\n+public class HttpClientExternalSignerFactory implements Supplier<HttpClient> {\n+  private final ValidatorConfig validatorConfig;\n+\n+  public HttpClientExternalSignerFactory(final ValidatorConfig validatorConfig) {\n+    this.validatorConfig = validatorConfig;\n+  }\n+\n+  @Override\n+  public HttpClient get() {\n+    final HttpClient.Builder builder = HttpClient.newBuilder().version(HttpClient.Version.HTTP_1_1);\n+    if (isTLSEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI5NjIwMQ==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return protocol != null && protocol.toLowerCase().equals(\"https\");\n          \n          \n            \n                return protocol != null && protocol.equalsIgnoringCase(\"https\");\n          \n      \n    \n    \n  \n\ntoLowerCase can do surprising things in some locales and with some characters.", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r532296201", "createdAt": "2020-11-30T00:45:11Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/HttpClientExternalSignerFactory.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.loader;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.net.http.HttpClient;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.security.GeneralSecurityException;\n+import java.security.KeyManagementException;\n+import java.security.KeyStore;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.function.Supplier;\n+import javax.net.ssl.KeyManager;\n+import javax.net.ssl.KeyManagerFactory;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.TrustManager;\n+import javax.net.ssl.TrustManagerFactory;\n+import org.apache.commons.lang3.tuple.Pair;\n+import tech.pegasys.teku.infrastructure.crypto.SecureRandomProvider;\n+import tech.pegasys.teku.util.config.InvalidConfigurationException;\n+import tech.pegasys.teku.validator.api.ValidatorConfig;\n+\n+public class HttpClientExternalSignerFactory implements Supplier<HttpClient> {\n+  private final ValidatorConfig validatorConfig;\n+\n+  public HttpClientExternalSignerFactory(final ValidatorConfig validatorConfig) {\n+    this.validatorConfig = validatorConfig;\n+  }\n+\n+  @Override\n+  public HttpClient get() {\n+    final HttpClient.Builder builder = HttpClient.newBuilder().version(HttpClient.Version.HTTP_1_1);\n+    if (isTLSEnabled()) {\n+      builder.sslContext(\n+          getSSLContext(\n+              validatorConfig.getValidatorExternalSignerKeystorePasswordFilePair(),\n+              validatorConfig.getValidatorExternalSignerTruststorePasswordFilePair()));\n+    }\n+    return builder.build();\n+  }\n+\n+  private boolean isTLSEnabled() {\n+    final String protocol = validatorConfig.getValidatorExternalSignerUrl().getProtocol();\n+    return protocol != null && protocol.toLowerCase().equals(\"https\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI5NzM5Ng==", "bodyText": "It would probably be good to get this new upcheck in its own PR.  It would also be good to keep retrying - particularly if its failing - otherwise a single error message in the logs can easily be missed and as Paul mentioned, the signer may be up initially but then later go down.  Checking liveness every few minutes probably makes sense.  Would also be good that this is then an async check instead of delaying startup to perform it.", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r532297396", "createdAt": "2020-11-30T00:51:33Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java", "diffHunk": "@@ -96,14 +99,28 @@ public static ValidatorLoader create(\n         .collect(toMap(Validator::getPublicKey, Function.identity()));\n   }\n \n-  private Map<BLSPublicKey, Validator> createExternalSignerValidator(final ValidatorConfig config) {\n+  private Map<BLSPublicKey, Validator> createExternalSignerValidator(\n+      final ValidatorConfig config, final Supplier<HttpClient> externalSignerHttpClientFactory) {\n+    if (config.getValidatorExternalSignerPublicKeys().isEmpty()) {\n+      return Collections.emptyMap();\n+    }\n+\n     final Duration timeout = Duration.ofMillis(config.getValidatorExternalSignerTimeout());\n+\n+    final boolean isReachable =\n+        new ExternalSignerUpcheck(\n+                externalSignerHttpClientFactory.get(),\n+                config.getValidatorExternalSignerUrl(),\n+                timeout)\n+            .upcheck();\n+    STATUS_LOG.externalSignerStatus(config.getValidatorExternalSignerUrl(), isReachable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3be45779314a75bbf94278ba40bd17e25e3fc5e", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/f3be45779314a75bbf94278ba40bd17e25e3fc5e", "committedDate": "2020-12-06T23:39:16Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bba3e452770c660ebaefef6630e1a999232ba5f6", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/bba3e452770c660ebaefef6630e1a999232ba5f6", "committedDate": "2020-12-07T23:40:39Z", "message": "remove external upcheck as it is coming from different PR\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ddc254be7584d340b96fd6c4eb72fcef9e3eff1", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/6ddc254be7584d340b96fd6c4eb72fcef9e3eff1", "committedDate": "2020-12-07T23:48:11Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>\n\n# Conflicts:\n#\tvalidator/client/src/main/java/tech/pegasys/teku/validator/client/loader/ValidatorLoader.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88ef9fbef15d3816b10f4c9259b2ea03a900628c", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/88ef9fbef15d3816b10f4c9259b2ea03a900628c", "committedDate": "2020-12-07T23:49:43Z", "message": "spotless fix post merge\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59ba8b308ff2db0de6ecd78d4646ba59671a0b09", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/59ba8b308ff2db0de6ecd78d4646ba59671a0b09", "committedDate": "2020-12-07T23:58:42Z", "message": "review suggestion - use equalsIgnoreCase instead of toLowerCase\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30546e05649648147fd1c9c11b4b7cd01fbf2a43", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/30546e05649648147fd1c9c11b4b7cd01fbf2a43", "committedDate": "2020-12-08T00:00:12Z", "message": "post merge conflict fix\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40ddecebb2815b632c9b8273bcae8cce90607f83", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/40ddecebb2815b632c9b8273bcae8cce90607f83", "committedDate": "2020-12-08T00:06:33Z", "message": "review suggestion - more descriptive cli description for password files\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "778ea44b371926e1a7556be36924360d9dbeda7e", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/778ea44b371926e1a7556be36924360d9dbeda7e", "committedDate": "2020-12-08T00:26:09Z", "message": "validation fails if external signer url does not start with https\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7f9b014304ca129d352ae2dc8281e451d0a43b2", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/a7f9b014304ca129d352ae2dc8281e451d0a43b2", "committedDate": "2020-12-08T01:04:38Z", "message": "typo\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d678170d49ad7adfb2a5206ef6bec4ced7bc4d6f", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/d678170d49ad7adfb2a5206ef6bec4ced7bc4d6f", "committedDate": "2020-12-08T01:27:56Z", "message": "Updating integration test case, changing timeout type to Duration\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53444659b84552a071ddce5fee4bd8dac807a8f1", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/53444659b84552a071ddce5fee4bd8dac807a8f1", "committedDate": "2020-12-08T02:52:19Z", "message": "Integration test for External Signer Upcheck with TLS\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23f7c5fad7275d25a08d2b414a52806f2f95d930", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/23f7c5fad7275d25a08d2b414a52806f2f95d930", "committedDate": "2020-12-08T02:52:43Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aae7c46626b84b68d344a93e8779bd0bf38f99d", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/8aae7c46626b84b68d344a93e8779bd0bf38f99d", "committedDate": "2020-12-08T02:55:43Z", "message": "errorprone suggestion\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d67ef50e0422935f6066b17d50c6782ae7e447e6", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/d67ef50e0422935f6066b17d50c6782ae7e447e6", "committedDate": "2020-12-08T03:05:29Z", "message": "fixing unit test\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NzE5NDY3", "url": "https://github.com/ConsenSys/teku/pull/3250#pullrequestreview-546719467", "createdAt": "2020-12-08T03:32:12Z", "commit": {"oid": "d67ef50e0422935f6066b17d50c6782ae7e447e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NzIxNDc4", "url": "https://github.com/ConsenSys/teku/pull/3250#pullrequestreview-546721478", "createdAt": "2020-12-08T03:38:38Z", "commit": {"oid": "d67ef50e0422935f6066b17d50c6782ae7e447e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMzozODozOFrOIBFfoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMzozODozOFrOIBFfoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAwOTUwNA==", "bodyText": "as discussed, 1 second is very short.", "url": "https://github.com/ConsenSys/teku/pull/3250#discussion_r538009504", "createdAt": "2020-12-08T03:38:38Z", "author": {"login": "rolfyone"}, "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorKeysOptions.java", "diffHunk": "@@ -79,7 +80,7 @@\n       paramLabel = \"<INTEGER>\",\n       description = \"Timeout (in milliseconds) for the external signing service\",\n       arity = \"1\")\n-  private int validatorExternalSignerTimeout = 1000;\n+  private long validatorExternalSignerTimeout = 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d67ef50e0422935f6066b17d50c6782ae7e447e6"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d21df24bcebff05609779aea2f24068f2a796fd4", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/d21df24bcebff05609779aea2f24068f2a796fd4", "committedDate": "2020-12-08T04:59:39Z", "message": "default external signer timeout to 5 seconds\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65ff5d11da4077786e9081edaf39321e179ba62d", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/65ff5d11da4077786e9081edaf39321e179ba62d", "committedDate": "2020-12-08T04:59:53Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "311a1d751a6445ef170544cb6b33ea6443b8b5db", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/311a1d751a6445ef170544cb6b33ea6443b8b5db", "committedDate": "2020-12-08T06:47:43Z", "message": "fixing unit test\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3208, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}