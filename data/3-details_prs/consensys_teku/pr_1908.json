{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyOTQ4OTg4", "number": 1908, "title": "Store pending subnet subscriptions to be activated once the network starts", "bodyText": "PR Description\nFix a race condition during genesis event by storing attestation subnet subscriptions to be activated once the network starts.  Otherwise the validator client may request subscriptions before the network has started and throw IllegalStateException.\nFixed Issue(s)\nfixes #1897", "createdAt": "2020-05-26T02:02:03Z", "url": "https://github.com/ConsenSys/teku/pull/1908", "merged": true, "mergeCommit": {"oid": "8df99c67c5015041e0040f06fa25ff6de057b1b7"}, "closed": true, "closedAt": "2020-05-26T21:09:00Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABck613SgH2gAyNDIyOTQ4OTg4OjA0ZDgzOGI2YWI0OWIyMzczMDI1MTc4YWNjMmJhY2FjYmIzMGRjZDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclLExhgH2gAyNDIyOTQ4OTg4OmYyNzBmZDllMzBkMWY4YTNkOGZmZjAxMWM0MjQzNmQxYmYyZDg0MWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "04d838b6ab49b2373025178acc2bacacbb30dcd6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/04d838b6ab49b2373025178acc2bacacbb30dcd6", "committedDate": "2020-05-26T02:00:41Z", "message": "Store pending subnet subscriptions to be activated once the network has started and the attestation manager is available.\nFixes a race condition while handling the genesis event."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3OTk4MTEz", "url": "https://github.com/ConsenSys/teku/pull/1908#pullrequestreview-417998113", "createdAt": "2020-05-26T06:19:59Z", "commit": {"oid": "04d838b6ab49b2373025178acc2bacacbb30dcd6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwNjoyMDowMFrOGaQCew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwNjoyMDowN1rOGaQCrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3ODkzOQ==", "bodyText": "System.out", "url": "https://github.com/ConsenSys/teku/pull/1908#discussion_r430178939", "createdAt": "2020-05-26T06:20:00Z", "author": {"login": "macfarla"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -149,21 +155,23 @@ public BeaconChainMethods getBeaconChainMethods() {\n   }\n \n   @Override\n-  public void subscribeToAttestationSubnetId(final int subnetId) {\n-    if (aggregateGossipManager == null) {\n-      throw new IllegalStateException(\n-          \"Attestation committee can not be subscribed due to gossip manager not being initialized\");\n+  public synchronized void subscribeToAttestationSubnetId(final int subnetId) {\n+    if (attestationGossipManager == null) {\n+      System.out.println(\"Adding pending subscription to \" + subnetId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04d838b6ab49b2373025178acc2bacacbb30dcd6"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3ODk5MA==", "bodyText": "System.out", "url": "https://github.com/ConsenSys/teku/pull/1908#discussion_r430178990", "createdAt": "2020-05-26T06:20:07Z", "author": {"login": "macfarla"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/ActiveEth2Network.java", "diffHunk": "@@ -149,21 +155,23 @@ public BeaconChainMethods getBeaconChainMethods() {\n   }\n \n   @Override\n-  public void subscribeToAttestationSubnetId(final int subnetId) {\n-    if (aggregateGossipManager == null) {\n-      throw new IllegalStateException(\n-          \"Attestation committee can not be subscribed due to gossip manager not being initialized\");\n+  public synchronized void subscribeToAttestationSubnetId(final int subnetId) {\n+    if (attestationGossipManager == null) {\n+      System.out.println(\"Adding pending subscription to \" + subnetId);\n+      pendingSubnetSubscriptions.add(subnetId);\n+    } else {\n+      System.out.println(\"Subscribing to \" + subnetId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04d838b6ab49b2373025178acc2bacacbb30dcd6"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "271d9278cbe7c9c80cb84bfa7bbc15ee4ae29106", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/271d9278cbe7c9c80cb84bfa7bbc15ee4ae29106", "committedDate": "2020-05-26T08:55:50Z", "message": "Remove System.out."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NDg3OTQ5", "url": "https://github.com/ConsenSys/teku/pull/1908#pullrequestreview-418487949", "createdAt": "2020-05-26T16:45:29Z", "commit": {"oid": "271d9278cbe7c9c80cb84bfa7bbc15ee4ae29106"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f270fd9e30d1f8a3d8fff011c42436d1bf2d841d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/f270fd9e30d1f8a3d8fff011c42436d1bf2d841d", "committedDate": "2020-05-26T20:55:27Z", "message": "Merge branch 'master' into pending-subscriptions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4033, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}