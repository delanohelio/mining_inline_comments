{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NTU0NzQ1", "number": 1493, "title": "Fix getDuties to use a state from the previous epoch", "bodyText": "PR Description\nSo that Validator Duties can be calculated an epoch in advance, getDuties must use the state from the previous epoch as the requested epoch may not have happened yet.\nCombinedChainDataClient should load data for the genesis slot from recent storage during the first epoch. The store reports epoch 0 as finalised but it's a special case and won't actually have been pruned.", "createdAt": "2020-03-27T05:09:26Z", "url": "https://github.com/ConsenSys/teku/pull/1493", "merged": true, "mergeCommit": {"oid": "1bf77ac6fda538854c47afbdc91465e4096d7ac2"}, "closed": true, "closedAt": "2020-03-28T02:06:10Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRpi4SAH2gAyMzk0NTU0NzQ1OmI1YmFkMzc4OTI2YjBhZGY3NjhmODVmYmY5ZmRlMTk5NTdkYzgzYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcR7GhXgH2gAyMzk0NTU0NzQ1OjMxMDVhNTlhOGJiZGMxZTRmODYzMDdjYjNkNmNiNGMwMzhlNDBjNzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b5bad378926b0adf768f85fbf9fde19957dc83a9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b5bad378926b0adf768f85fbf9fde19957dc83a9", "committedDate": "2020-03-27T05:07:00Z", "message": "Fix getDuties to use a state from the epoch prior to the one requested so that we can actually lookup an epoch ahead.\nCombinedChainDataClient should load data for the genesis slot from recent storage during the first epoch."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be96df8a1a69eac271c23353bfe8acd956ebefa8", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/be96df8a1a69eac271c23353bfe8acd956ebefa8", "committedDate": "2020-03-27T05:12:49Z", "message": "Make errorprone happy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a1c080c95f62d3510f36fc6af571aa6d7450ad6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3a1c080c95f62d3510f36fc6af571aa6d7450ad6", "committedDate": "2020-03-27T05:28:37Z", "message": "Fix unit test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0981a5d387713ca288c590338ec999327d6b55a9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0981a5d387713ca288c590338ec999327d6b55a9", "committedDate": "2020-03-27T05:41:16Z", "message": "Fix test again."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11ee8feb0c8c91d470e92888d49a10e7187d3d46", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/11ee8feb0c8c91d470e92888d49a10e7187d3d46", "committedDate": "2020-03-27T07:12:04Z", "message": "Reduce log level."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMDc5NDI1", "url": "https://github.com/ConsenSys/teku/pull/1493#pullrequestreview-383079425", "createdAt": "2020-03-27T17:51:24Z", "commit": {"oid": "11ee8feb0c8c91d470e92888d49a10e7187d3d46"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNzo1MToyNFrOF878-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNzo1MToyNFrOF878-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0MTE0NQ==", "bodyText": "We always hold the latest finalized state in the in-memory store.  What if we just check the chainStorageClient first before pulling historical data?", "url": "https://github.com/ConsenSys/teku/pull/1493#discussion_r399441145", "createdAt": "2020-03-27T17:51:24Z", "author": {"login": "mbaxter"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/CombinedChainDataClient.java", "diffHunk": "@@ -146,6 +146,11 @@ public CombinedChainDataClient(\n     return getBlockByBlockRoot(get_block_root_at_slot(state, slot));\n   }\n \n+  private boolean isHistoricalData(final UnsignedLong slot) {\n+    final boolean finalizedPastFirstEpoch = !recentChainData.getFinalizedEpoch().equals(ZERO);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11ee8feb0c8c91d470e92888d49a10e7187d3d46"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMDgwNTM1", "url": "https://github.com/ConsenSys/teku/pull/1493#pullrequestreview-383080535", "createdAt": "2020-03-27T17:52:55Z", "commit": {"oid": "11ee8feb0c8c91d470e92888d49a10e7187d3d46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6df4c0b057eb870e2ecc650f7b6c30d5f77cf0ed", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6df4c0b057eb870e2ecc650f7b6c30d5f77cf0ed", "committedDate": "2020-03-27T23:21:55Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into use-previous-epoch-to-generate-duties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3105a59a8bbdc1e4f86307cb3d6cb4c038e40c72", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3105a59a8bbdc1e4f86307cb3d6cb4c038e40c72", "committedDate": "2020-03-28T01:34:19Z", "message": "Fix unit test."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4399, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}