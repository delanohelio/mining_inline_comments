{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxNDgzOTYx", "number": 2379, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMDowMzo0MVrOEP52hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMDoxNjozOVrOEP568w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MTExOTQyOnYy", "diffSide": "RIGHT", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/AttesterSlashingTopicHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMDowMzo0MVrOGzzaNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzoyMTo0OFrOG0X6og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3Mjg1NA==", "bodyText": "Probably outside the scope of this PR but does this wind up doing the validation on the netty thread or have we already jumped off of it?\nBecause if we've got SafeFuture involved anyway it would be good to delegate validation to a worker pool and not block the netty threads.", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r456972854", "createdAt": "2020-07-20T00:03:41Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/AttesterSlashingTopicHandler.java", "diffHunk": "@@ -92,7 +81,9 @@ public Bytes4 getForkDigest() {\n     return forkDigest;\n   }\n \n-  protected InternalValidationResult validateData(final AttesterSlashing attesterSlashing) {\n-    return validator.validate(attesterSlashing);\n+  @Override\n+  protected SafeFuture<InternalValidationResult> validateData(\n+      final AttesterSlashing attesterSlashing) {\n+    return SafeFuture.completedFuture(validator.validate(attesterSlashing));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f12a78ffd11b501a818589b718095445da501e99"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU3MDk3OA==", "bodyText": "We're still on the netty thread.  Definitely makes sense to move this to a worker thread though \ud83d\udc4d  We've got a ticket for that here: #1947.  Should be made easier by this PR.", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r457570978", "createdAt": "2020-07-20T17:21:48Z", "author": {"login": "mbaxter"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/AttesterSlashingTopicHandler.java", "diffHunk": "@@ -92,7 +81,9 @@ public Bytes4 getForkDigest() {\n     return forkDigest;\n   }\n \n-  protected InternalValidationResult validateData(final AttesterSlashing attesterSlashing) {\n-    return validator.validate(attesterSlashing);\n+  @Override\n+  protected SafeFuture<InternalValidationResult> validateData(\n+      final AttesterSlashing attesterSlashing) {\n+    return SafeFuture.completedFuture(validator.validate(attesterSlashing));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3Mjg1NA=="}, "originalCommit": {"oid": "f12a78ffd11b501a818589b718095445da501e99"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MTEzMDc1OnYy", "diffSide": "RIGHT", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwMDoxNjozOVrOGzzf_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzo0MzowMlrOG0YqiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDMzMg==", "bodyText": "Shouldn't Store automatically take care of caching for us?  We're also only loading one state and creating a new cache each time so I don't think this can wind up ever being useful.", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r456974332", "createdAt": "2020-07-20T00:16:39Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java", "diffHunk": "@@ -211,6 +229,23 @@ private UnsignedLong maximumBroadcastTimeMillis(final UnsignedLong attestationSl\n     return secondsToMillis(lastAllowedTime).plus(MAXIMUM_GOSSIP_CLOCK_DISPARITY);\n   }\n \n+  StateProvider createStateProvider() {\n+    return createStateProvider(recentChainData);\n+  }\n+\n+  @VisibleForTesting\n+  static StateProvider createStateProvider(final RecentChainData recentChainData) {\n+    LoadingCache<Bytes32, SafeFuture<Optional<BeaconState>>> cache =\n+        CacheBuilder.newBuilder().build(CacheLoader.from(recentChainData::retrieveBlockState));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f12a78ffd11b501a818589b718095445da501e99"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDg0Mw==", "bodyText": "Oh I see we do reuse it in SignedAggregateAndProofValidator.  I suspect leaving the caching to the Store is likely to be the right answer still.", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r456974843", "createdAt": "2020-07-20T00:20:28Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java", "diffHunk": "@@ -211,6 +229,23 @@ private UnsignedLong maximumBroadcastTimeMillis(final UnsignedLong attestationSl\n     return secondsToMillis(lastAllowedTime).plus(MAXIMUM_GOSSIP_CLOCK_DISPARITY);\n   }\n \n+  StateProvider createStateProvider() {\n+    return createStateProvider(recentChainData);\n+  }\n+\n+  @VisibleForTesting\n+  static StateProvider createStateProvider(final RecentChainData recentChainData) {\n+    LoadingCache<Bytes32, SafeFuture<Optional<BeaconState>>> cache =\n+        CacheBuilder.newBuilder().build(CacheLoader.from(recentChainData::retrieveBlockState));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDMzMg=="}, "originalCommit": {"oid": "f12a78ffd11b501a818589b718095445da501e99"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4MzI0MQ==", "bodyText": "Simplified this. It felt weird to me to potentially regenerate the same state twice, but in reality the Store should still have it cached.", "url": "https://github.com/ConsenSys/teku/pull/2379#discussion_r457583241", "createdAt": "2020-07-20T17:43:02Z", "author": {"login": "mbaxter"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/validation/AttestationValidator.java", "diffHunk": "@@ -211,6 +229,23 @@ private UnsignedLong maximumBroadcastTimeMillis(final UnsignedLong attestationSl\n     return secondsToMillis(lastAllowedTime).plus(MAXIMUM_GOSSIP_CLOCK_DISPARITY);\n   }\n \n+  StateProvider createStateProvider() {\n+    return createStateProvider(recentChainData);\n+  }\n+\n+  @VisibleForTesting\n+  static StateProvider createStateProvider(final RecentChainData recentChainData) {\n+    LoadingCache<Bytes32, SafeFuture<Optional<BeaconState>>> cache =\n+        CacheBuilder.newBuilder().build(CacheLoader.from(recentChainData::retrieveBlockState));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk3NDMzMg=="}, "originalCommit": {"oid": "f12a78ffd11b501a818589b718095445da501e99"}, "originalPosition": 156}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3411, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}