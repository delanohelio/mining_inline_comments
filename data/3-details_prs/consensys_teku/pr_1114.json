{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NDYzNzk0", "number": 1114, "title": "Optimize: use HashSet instead of ArrayList", "bodyText": "Depends on PR #1113\nRelevant commits starts from:\n\nUsing HashSet.contains() in the inner loop is more effective than Arr\u2026 3c2930d\n\nPR Description\nSimple optimization: use HashSet.contains() instead of ArrayList.contains() in the inner loop\nResults:\nBefore:\nBenchmark                              (validatorsCount)  Mode  Cnt  Score   Error  Units\nTransitionBenchmark.Block.importBlock               1024    ss   50  0,229 \u00b1 0,009   s/op\nTransitionBenchmark.Block.importBlock               3072    ss   50  0,359 \u00b1 0,016   s/op\nTransitionBenchmark.Block.importBlock              10240    ss   50  0,838 \u00b1 0,008   s/op\nTransitionBenchmark.Epoch.importBlock               1024    ss   10  0,222 \u00b1 0,013   s/op\nTransitionBenchmark.Epoch.importBlock               3072    ss   10  0,389 \u00b1 0,012   s/op\nTransitionBenchmark.Epoch.importBlock              10240    ss   10  1,155 \u00b1 0,025   s/op\n\nAfter:\nBenchmark                              (validatorsCount)  Mode  Cnt  Score   Error  Units\nTransitionBenchmark.Block.importBlock               1024    ss   50  0,224 \u00b1 0,012   s/op\nTransitionBenchmark.Block.importBlock               3072    ss   50  0,352 \u00b1 0,005   s/op\nTransitionBenchmark.Block.importBlock              10240    ss   50  0,844 \u00b1 0,008   s/op\nTransitionBenchmark.Epoch.importBlock               1024    ss   10  0,215 \u00b1 0,015   s/op\nTransitionBenchmark.Epoch.importBlock               3072    ss   10  0,363 \u00b1 0,012   s/op\nTransitionBenchmark.Epoch.importBlock              10240    ss   10  0,892 \u00b1 0,020   s/op", "createdAt": "2020-01-23T16:53:11Z", "url": "https://github.com/ConsenSys/teku/pull/1114", "merged": true, "mergeCommit": {"oid": "5a40615657c702fc169f183772cab53ff52b689d"}, "closed": true, "closedAt": "2020-01-28T18:23:12Z", "author": {"login": "Nashatyrev"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9Gy8XgH2gAyMzY2NDYzNzk0OmJjYzYwMzE1YWQ2NTRkNDlkNTAwZjdjOGQ4MzAxY2JhOTM1ZDY0MjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-1b6AgH2gAyMzY2NDYzNzk0OjYwZGU3ODBhM2Y0OTE2NjFhNmQ0N2NlYWQyMTYwMGFkYzNiNDM4NWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bcc60315ad654d49d500f7c8d8301cba935d6426", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/bcc60315ad654d49d500f7c8d8301cba935d6426", "committedDate": "2020-01-23T09:19:23Z", "message": "Add activeValidatorsCache (naive static implementation)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d724d3aab1f020d1c4b7aa71e87e39f9b1e9d69c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d724d3aab1f020d1c4b7aa71e87e39f9b1e9d69c", "committedDate": "2020-01-23T09:27:26Z", "message": "Add TransitionCaches to the BeaconChainWithCache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89d375ca06891b1d214094ac0a7beff94afc99cf", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/89d375ca06891b1d214094ac0a7beff94afc99cf", "committedDate": "2020-01-23T09:27:43Z", "message": "Move activeValidators cache from ValidatorUtils statics to the TransitionsCache instance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8588b1d60b72857ff10ec1a7e0130f2ea1990d0f", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8588b1d60b72857ff10ec1a7e0130f2ea1990d0f", "committedDate": "2020-01-23T09:50:49Z", "message": "Make LRUCache to evict last inserted entry instead of last accessed, since it is more appropriate for transition logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84ecfd1a24c5d394b183b526febce60a8c3e6776", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/84ecfd1a24c5d394b183b526febce60a8c3e6776", "committedDate": "2020-01-23T09:51:02Z", "message": "Add javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c88eecc073a94bde9a3312e28730fbf69d59c7a7", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/c88eecc073a94bde9a3312e28730fbf69d59c7a7", "committedDate": "2020-01-23T10:55:07Z", "message": "Apply spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a0a51f476df20d56fc11468af7d31b499365b30", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9a0a51f476df20d56fc11468af7d31b499365b30", "committedDate": "2020-01-23T11:36:38Z", "message": "Fix compiler warnings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04f9319220e4e56f1c3b85dac1ab8f77595c25e5", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/04f9319220e4e56f1c3b85dac1ab8f77595c25e5", "committedDate": "2020-01-23T12:54:11Z", "message": "Make LRUCache.copy() method thread-safe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfa0829bcbc02347f177b19f665d1bf927ddfbff", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/cfa0829bcbc02347f177b19f665d1bf927ddfbff", "committedDate": "2020-01-23T13:14:05Z", "message": "Blocks generator: use the right keys source"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07206583d6e2e5b0df720ebcda3076328228c1b0", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/07206583d6e2e5b0df720ebcda3076328228c1b0", "committedDate": "2020-01-23T13:48:36Z", "message": "Re-generate benchmark blocks for 0.9.4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dad2554ecba9653bae9a6669c33652cda3ff3198", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/dad2554ecba9653bae9a6669c33652cda3ff3198", "committedDate": "2020-01-23T13:49:44Z", "message": "Remove debug blocks printing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea93d0f994b367b001dcacb40e59a6c7641240ab", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/ea93d0f994b367b001dcacb40e59a6c7641240ab", "committedDate": "2020-01-23T14:15:15Z", "message": "Add beacon_proposer_index and beacon_committee caches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3889f655f4878cf5244efe1d09e5597025a4b707", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/3889f655f4878cf5244efe1d09e5597025a4b707", "committedDate": "2020-01-23T14:15:58Z", "message": "Include 10K validators case into transition benchmark"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8db2731b1e24a6056af6ad41411548eadf4b1484", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8db2731b1e24a6056af6ad41411548eadf4b1484", "committedDate": "2020-01-23T15:30:54Z", "message": "Add base_reward cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c2930d6846bdc3920f050f955943311bb134b65", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/3c2930d6846bdc3920f050f955943311bb134b65", "committedDate": "2020-01-23T16:50:12Z", "message": "Using HashSet.contains() in the inner loop is more effective than ArrayList.contains()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NjU5OTQ1", "url": "https://github.com/ConsenSys/teku/pull/1114#pullrequestreview-347659945", "createdAt": "2020-01-23T22:47:36Z", "commit": {"oid": "3c2930d6846bdc3920f050f955943311bb134b65"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMjo0NzozNlrOFhPKag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMjo1MDoyMlrOFhPOdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM5NTc1NA==", "bodyText": "One pattern we may want to consider is allowing the caller of get_unslahsed_attesting_indices decide what type of collection it wants back.\nSo it would become:\nprivate static List<Integer> get_unslashed_attesting_indices(\n      BeaconState state, List<PendingAttestation> attestations) {\n    return get_unslashed_attesting_indices(state, attestations, ArrayList::new);\n  }\n\n  private static <T extends Collection<Integer>> T get_unslashed_attesting_indices(\n      BeaconState state,\n      List<PendingAttestation> attestations,\n      final Supplier<T> collectionFactory) {\n    TreeSet<Integer> output = new TreeSet<>();\n    for (PendingAttestation a : attestations) {\n      output.addAll(get_attesting_indices(state, a.getData(), a.getAggregation_bits()));\n    }\n    List<Integer> output_list = new ArrayList<>(output);\n    return output_list.stream()\n        .filter(index -> !state.getValidators().get(index).isSlashed())\n        .collect(Collectors.toCollection(collectionFactory));\n  }\n\nThen rather than having to copy the list into a HashSet you could just pass in HashSet::new and get a HashSet back.\nFrom a quick review of where this particular method is used I think we may always want a HashSet but I may have missed somewhere that order is important. I suspect the pattern of allowing the caller to determine the returned collection type will be useful in a bunch of places though.", "url": "https://github.com/ConsenSys/teku/pull/1114#discussion_r370395754", "createdAt": "2020-01-23T22:47:36Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/EpochProcessorUtil.java", "diffHunk": "@@ -332,8 +333,9 @@ private static UnsignedLong get_base_reward(BeaconState state, int index) {\n       List<Integer> unslashed_attesting_indices =\n           get_unslashed_attesting_indices(state, attestations);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c2930d6846bdc3920f050f955943311bb134b65"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM5Njc5MQ==", "bodyText": "nit: We try to use the interface for collection types (ie Set<Integer>) in variable declarations instead of the specific implementation of HashSet. Doesn't really matter here but as things are refactored over time to extract methods etc you can wind up with specific collection types in APIs that make it harder to reuse code.", "url": "https://github.com/ConsenSys/teku/pull/1114#discussion_r370396791", "createdAt": "2020-01-23T22:50:22Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/EpochProcessorUtil.java", "diffHunk": "@@ -332,8 +333,9 @@ private static UnsignedLong get_base_reward(BeaconState state, int index) {\n       List<Integer> unslashed_attesting_indices =\n           get_unslashed_attesting_indices(state, attestations);\n       UnsignedLong attesting_balance = get_total_balance(state, unslashed_attesting_indices);\n+      HashSet<Integer> unslashed_attesting_indices_set = new HashSet<>(unslashed_attesting_indices);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c2930d6846bdc3920f050f955943311bb134b65"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61580fe6d1b90e8b4a0e45569073368d7a243540", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/61580fe6d1b90e8b4a0e45569073368d7a243540", "committedDate": "2020-01-24T08:23:01Z", "message": "get_total_balance: widen parameter type from List to Collection since the order doesn't matter here.\nUse more laconic enhanced for statement instead of explicit Iterator."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90c33df2913b35378c20a6278d4c2401b564a771", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/90c33df2913b35378c20a6278d4c2401b564a771", "committedDate": "2020-01-24T08:25:06Z", "message": "get_unslashed_attesting_indices: can now create and return any Collection implementation.\nThis is to avoid unnecessary copying"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d3626d3c658290c86f3db45d1504f6291ef391c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/0d3626d3c658290c86f3db45d1504f6291ef391c", "committedDate": "2020-01-24T08:25:19Z", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-list-to-set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d3e5407c9153fb6d8b1d72028644719ebd062c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/a3d3e5407c9153fb6d8b1d72028644719ebd062c", "committedDate": "2020-01-28T11:38:35Z", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-cache-base-reward\n\n# Conflicts:\n#\teth-benchmark-tests/src/jmh/resources/blocks/blocks_epoch_6_validators_10240.ssz.gz\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/TransitionCaches.java\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/cache/LRUCache.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79a23a435d0b6ed863979461b08e438f11638fa7", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/79a23a435d0b6ed863979461b08e438f11638fa7", "committedDate": "2020-01-28T18:10:12Z", "message": "Merge branch 'optimize-cache-base-reward' into optimize-list-to-set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60de780a3f491661a6d47cead21600adc3b4385e", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/60de780a3f491661a6d47cead21600adc3b4385e", "committedDate": "2020-01-28T18:13:41Z", "message": "Merge branch 'master' into optimize-list-to-set"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4236, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}