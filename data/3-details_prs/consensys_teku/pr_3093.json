{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExMDgwMjI1", "number": 3093, "title": "[Issue-3063] Handle missing historical blocks for BlocksByRange requests", "bodyText": "PR Description\nAdd API's for querying for the earliest available finalized block.  Handle missing historical blocks for blocksByRange requests: if the first requested block is not available locally, send back an error.\nFixed Issue(s)\nPart of #3063\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-27T21:20:53Z", "url": "https://github.com/ConsenSys/teku/pull/3093", "merged": true, "mergeCommit": {"oid": "ff316a201dac03121320ee89651cf6604b84fee2"}, "closed": true, "closedAt": "2020-10-29T22:51:08Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWvtGTAH2gAyNTExMDgwMjI1OmJiYzU2ZGJkNjQ0Y2RiZWFmYWUwYWEyMzkwZjZkMjg3ZDQzMmFlMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXaBShAH2gAyNTExMDgwMjI1OmY3YTNkMzI3NjY3NDc5YjFjZjc2ZjA5MGIxNGM3MDNlYTUxODgyZTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bbc56dbd644cdbeafae0aa2390f6d287d432ae39", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/bbc56dbd644cdbeafae0aa2390f6d287d432ae39", "committedDate": "2020-10-27T21:18:22Z", "message": "Add API's for pulling the earliest available block slot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f45dcbc7f09c04a6f9861b0067a514d6436027c", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/0f45dcbc7f09c04a6f9861b0067a514d6436027c", "committedDate": "2020-10-27T21:18:22Z", "message": "Send empty response to blocksByRange request when first block is missing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb302bbb28cc7b12f3fd3937c826cf036586fdcd", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/eb302bbb28cc7b12f3fd3937c826cf036586fdcd", "committedDate": "2020-10-27T22:23:10Z", "message": "Fix BlocksByRangeIntegrationTest: update to use newer testing tools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee0eb110892f13c6b6c06aca94e9c2982ff6dd16", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/ee0eb110892f13c6b6c06aca94e9c2982ff6dd16", "committedDate": "2020-10-27T22:49:34Z", "message": "Return an error rather than an empty response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NDg4MjQ3", "url": "https://github.com/ConsenSys/teku/pull/3093#pullrequestreview-518488247", "createdAt": "2020-10-28T09:53:01Z", "commit": {"oid": "bbc56dbd644cdbeafae0aa2390f6d287d432ae39"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTo1MzowMVrOHpiCWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDoyODoxNVrOHpjbyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMxMTMyMw==", "bodyText": "I'm a bit confused with different method names here: one return erliest 'Finalized' another returns earliest 'Historical'. Does it makes sense to give them the same name? Or I missing something?", "url": "https://github.com/ConsenSys/teku/pull/3093#discussion_r513311323", "createdAt": "2020-10-28T09:53:01Z", "author": {"login": "Nashatyrev"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java", "diffHunk": "@@ -318,6 +318,11 @@ public WeakSubjectivityState getWeakSubjectivityState() {\n     return finalizedDao.getFinalizedBlockAtSlot(slot);\n   }\n \n+  @Override\n+  public Optional<UInt64> getEarliestHistoricalBlockSlot() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbc56dbd644cdbeafae0aa2390f6d287d432ae39"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMzMjMzMQ==", "bodyText": "Just to make sure: are we neglecting the case when we might have some blocks matching the request? I mean the case where earliestSlot < endSlot", "url": "https://github.com/ConsenSys/teku/pull/3093#discussion_r513332331", "createdAt": "2020-10-28T10:25:14Z", "author": {"login": "Nashatyrev"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/beaconchain/methods/BeaconBlocksByRangeMessageHandler.java", "diffHunk": "@@ -105,24 +105,45 @@ public void onIncomingMessage(\n     final UInt64 count = maxRequestSize.min(message.getCount());\n     final UInt64 endSlot = message.getStartSlot().plus(message.getStep().times(count)).minus(ONE);\n \n-    final UInt64 headBlockSlot =\n-        combinedChainDataClient.getBestBlock().map(SignedBeaconBlock::getSlot).orElse(ZERO);\n-    final NavigableMap<UInt64, Bytes32> hotRoots;\n-    if (combinedChainDataClient.isFinalized(endSlot)) {\n-      // All blocks are finalized so skip scanning the protoarray\n-      hotRoots = new TreeMap<>();\n-    } else {\n-      hotRoots =\n-          combinedChainDataClient.getAncestorRoots(\n-              message.getStartSlot(), message.getStep(), count);\n-    }\n-    // Don't send anything past the last slot found in protoarray to ensure blocks are consistent\n-    // If we didn't find any blocks in protoarray, every block in the range must be finalized\n-    // so we don't need to worry about inconsistent blocks\n-    final UInt64 headSlot = hotRoots.isEmpty() ? headBlockSlot : hotRoots.lastKey();\n-    return sendNextBlock(\n-        new RequestState(\n-            message.getStartSlot(), message.getStep(), count, headSlot, hotRoots, callback));\n+    return combinedChainDataClient\n+        .getEarliestHistoricalBlockSlot()\n+        .thenCompose(\n+            earliestSlot -> {\n+              if (earliestSlot.map(s -> s.isGreaterThan(message.getStartSlot())).orElse(true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f45dcbc7f09c04a6f9861b0067a514d6436027c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMzNDIxNw==", "bodyText": "Can you please comment why do we need to return the error instead of empty set? Doesn't this error mean that we totally have no any historical blocks (aka light client)?", "url": "https://github.com/ConsenSys/teku/pull/3093#discussion_r513334217", "createdAt": "2020-10-28T10:28:15Z", "author": {"login": "Nashatyrev"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/beaconchain/methods/BeaconBlocksByRangeMessageHandler.java", "diffHunk": "@@ -105,24 +105,47 @@ public void onIncomingMessage(\n     final UInt64 count = maxRequestSize.min(message.getCount());\n     final UInt64 endSlot = message.getStartSlot().plus(message.getStep().times(count)).minus(ONE);\n \n-    final UInt64 headBlockSlot =\n-        combinedChainDataClient.getBestBlock().map(SignedBeaconBlock::getSlot).orElse(ZERO);\n-    final NavigableMap<UInt64, Bytes32> hotRoots;\n-    if (combinedChainDataClient.isFinalized(endSlot)) {\n-      // All blocks are finalized so skip scanning the protoarray\n-      hotRoots = new TreeMap<>();\n-    } else {\n-      hotRoots =\n-          combinedChainDataClient.getAncestorRoots(\n-              message.getStartSlot(), message.getStep(), count);\n-    }\n-    // Don't send anything past the last slot found in protoarray to ensure blocks are consistent\n-    // If we didn't find any blocks in protoarray, every block in the range must be finalized\n-    // so we don't need to worry about inconsistent blocks\n-    final UInt64 headSlot = hotRoots.isEmpty() ? headBlockSlot : hotRoots.lastKey();\n-    return sendNextBlock(\n-        new RequestState(\n-            message.getStartSlot(), message.getStep(), count, headSlot, hotRoots, callback));\n+    return combinedChainDataClient\n+        .getEarliestHistoricalBlockSlot()\n+        .thenCompose(\n+            earliestSlot -> {\n+              if (earliestSlot.map(s -> s.isGreaterThan(message.getStartSlot())).orElse(true)) {\n+                // We're missing the first block so return an error\n+                return SafeFuture.failedFuture(\n+                    new RpcException.HistoricalDataUnavailableException(\n+                        \"Requested historical blocks are currently unavailable\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee0eb110892f13c6b6c06aca94e9c2982ff6dd16"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ce43140ac6a4cab2ef2ae4a8ad9feddcd913c4d", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/1ce43140ac6a4cab2ef2ae4a8ad9feddcd913c4d", "committedDate": "2020-10-28T15:12:49Z", "message": "Rename methods to getEarliestAvailableBlockSlot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0b21d83488b69498a7a83439ca9cdf5bb2508b1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a0b21d83488b69498a7a83439ca9cdf5bb2508b1", "committedDate": "2020-10-28T15:13:44Z", "message": "Merge branch 'master' into issue-3063/handle-missing-historical-blocks-for-blocks-by-range-request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4OTY4ODY3", "url": "https://github.com/ConsenSys/teku/pull/3093#pullrequestreview-518968867", "createdAt": "2020-10-28T18:29:18Z", "commit": {"oid": "a0b21d83488b69498a7a83439ca9cdf5bb2508b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a09951f099ae7569c4c91fd890629190f00dd50", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/6a09951f099ae7569c4c91fd890629190f00dd50", "committedDate": "2020-10-29T22:32:15Z", "message": "Use random custom error code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7a3d327667479b1cf76f090b14c703ea51882e3", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f7a3d327667479b1cf76f090b14c703ea51882e3", "committedDate": "2020-10-29T22:36:26Z", "message": "Merge branch 'master' into issue-3063/handle-missing-historical-blocks-for-blocks-by-range-request"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3272, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}