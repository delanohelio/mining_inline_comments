{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0NDIxODMz", "number": 3133, "title": "[Issue 3063] Add BeaconBlockSummary interface", "bodyText": "PR Description\nLay some groundwork for starting up from an initial state without requiring a matching block by adding a  BeaconBlockSummary interface.  This interface makes it easier to work with state and block header information without requiring full blocks.\nSummary:\n\nAdd BeaconBlockSummary interface\nUpdate Store state regeneration tasks to return the new summary type\nUpdate AnchorPoint to hold a BeaconBlockSummary rather than requiring a full block\nUpdate ChainHead to hold a BeaconBlockSummary, so that we can handle chain heads that do not have a full block available\nUpdate CheckpointState to hold a BeaconBlockSummary type rather than a full block\n\nFixed Issue(s)\nPart of #3063\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-03T01:09:01Z", "url": "https://github.com/ConsenSys/teku/pull/3133", "merged": true, "mergeCommit": {"oid": "ae994ca4538eba3d7063fb4990277385f75b26c2"}, "closed": true, "closedAt": "2020-11-05T18:54:07Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYuHRyAH2gAyNTE0NDIxODMzOjhhOGQ4YTE1ZjJlYmJjYjI0M2Y5YTJhYjUwYWFhMjFhZDJkZjRmMmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZmt8XgH2gAyNTE0NDIxODMzOjM2OGU2MzRmMjA0MGY4YjMxY2NkY2Y5YTBjMDdjOWRhNTM0ZTMwOWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8a8d8a15f2ebbcb243f9a2ab50aaa21ad2df4f2e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8a8d8a15f2ebbcb243f9a2ab50aaa21ad2df4f2e", "committedDate": "2020-11-03T00:35:00Z", "message": "Remove CheckpointState.getBlock() method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a586505aa2fdc0d35c9a4dabb7807e6da7b675fd", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a586505aa2fdc0d35c9a4dabb7807e6da7b675fd", "committedDate": "2020-11-03T00:35:00Z", "message": "Remove block requirement from AnchorPoint and CheckpointState"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d342fb45e894bfea575846f168638f1478b7825b", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d342fb45e894bfea575846f168638f1478b7825b", "committedDate": "2020-11-03T00:35:00Z", "message": "Add BeaconBlockSummary interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d03135a1df4df5bcb57928e99f1f0eb8da90630", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/9d03135a1df4df5bcb57928e99f1f0eb8da90630", "committedDate": "2020-11-03T00:35:00Z", "message": "Use generic summary type to allow Store.states to cache latest finalized"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae2b6350c4d7a0d04feeb595f5960a2b9c89e6a9", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/ae2b6350c4d7a0d04feeb595f5960a2b9c89e6a9", "committedDate": "2020-11-03T00:35:00Z", "message": "Update AnchorPoint to extend summary interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edb0aadf929645cc736de7dc76048573b6ee27f3", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/edb0aadf929645cc736de7dc76048573b6ee27f3", "committedDate": "2020-11-03T00:35:00Z", "message": "Update Chainhead to extend summary interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b10ca8fa2d739b6b482be828a39a9ec49b83a64a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/b10ca8fa2d739b6b482be828a39a9ec49b83a64a", "committedDate": "2020-11-03T00:35:00Z", "message": "Update BeaconBlockAndState to extend summary class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4653e2145a756ed340142b14c8b393368e19e1a1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/4653e2145a756ed340142b14c8b393368e19e1a1", "committedDate": "2020-11-03T00:35:00Z", "message": "Fix store assertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "742983cf1bba1a3e5e04aae515e0c59f304245bb", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/742983cf1bba1a3e5e04aae515e0c59f304245bb", "committedDate": "2020-11-03T00:35:00Z", "message": "Fix call to pull latest finalized block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fb5697c9a13e8382dbf9e7577a9ac9b8120ef79", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/6fb5697c9a13e8382dbf9e7577a9ac9b8120ef79", "committedDate": "2020-11-03T00:35:00Z", "message": "Fix test mocks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e9b993c8bd476854f6470d72597b3989f113b84", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/3e9b993c8bd476854f6470d72597b3989f113b84", "committedDate": "2020-11-03T00:35:00Z", "message": "Rework ChainHead accessor to return summary type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMTU3MjQ1", "url": "https://github.com/ConsenSys/teku/pull/3133#pullrequestreview-522157245", "createdAt": "2020-11-03T02:30:20Z", "commit": {"oid": "3e9b993c8bd476854f6470d72597b3989f113b84"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwMjozMDoyMFrOHseakg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwMjozMDoyMFrOHseakg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM5NzcxNA==", "bodyText": "nit: I think you can just use:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    block.getBody().hash_tree_root());\n          \n          \n            \n                    block.getBodyRoot());", "url": "https://github.com/ConsenSys/teku/pull/3133#discussion_r516397714", "createdAt": "2020-11-03T02:30:20Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/blocks/BeaconBlockHeader.java", "diffHunk": "@@ -87,6 +94,43 @@ public BeaconBlockHeader() {\n     super(TYPE);\n   }\n \n+  /**\n+   * Returns the block header associated with this state\n+   *\n+   * @param state A beacon state\n+   * @return The latest block header from the state, with stateRoot pointing to the supplied state\n+   */\n+  public static BeaconBlockHeader fromState(final BeaconState state) {\n+    BeaconBlockHeader latestHeader = state.getLatest_block_header();\n+\n+    if (latestHeader.getStateRoot().isZero()) {\n+      // If the state root is empty, replace it with the current state root\n+      final Bytes32 stateRoot = state.hash_tree_root();\n+      latestHeader =\n+          new BeaconBlockHeader(\n+              latestHeader.getSlot(),\n+              latestHeader.getProposerIndex(),\n+              latestHeader.getParentRoot(),\n+              stateRoot,\n+              latestHeader.getBodyRoot());\n+    }\n+\n+    return latestHeader;\n+  }\n+\n+  public static BeaconBlockHeader fromBlock(final BeaconBlock block) {\n+    return new BeaconBlockHeader(\n+        block.getSlot(),\n+        block.getProposerIndex(),\n+        block.getParentRoot(),\n+        block.getStateRoot(),\n+        block.getBody().hash_tree_root());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e9b993c8bd476854f6470d72597b3989f113b84"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "beda0ce2c56a01a426d23455506908bc50b4f624", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/beda0ce2c56a01a426d23455506908bc50b4f624", "committedDate": "2020-11-03T19:52:53Z", "message": "Fix spotless error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bde0c779edc8b827c310999aef735e8e2ea5e4c6", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/bde0c779edc8b827c310999aef735e8e2ea5e4c6", "committedDate": "2020-11-03T20:25:27Z", "message": "Clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3773bf06ff65df61d7e4a597962a3b9da6dc07b8", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/3773bf06ff65df61d7e4a597962a3b9da6dc07b8", "committedDate": "2020-11-03T20:26:05Z", "message": "Don't lookup / cache block when retrieving block summary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58e0309ff68fcdd584d7d23dc0aef3ba48816920", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/58e0309ff68fcdd584d7d23dc0aef3ba48816920", "committedDate": "2020-11-03T20:49:38Z", "message": "Fix state regeneration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86730e39584491125c144ce7fd05b7bdd649f7ec", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/86730e39584491125c144ce7fd05b7bdd649f7ec", "committedDate": "2020-11-03T20:53:47Z", "message": "Fix ProtoArray test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fae86428b93601da3efe43e99cf9c3e8d9d2d5b1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/fae86428b93601da3efe43e99cf9c3e8d9d2d5b1", "committedDate": "2020-11-04T21:08:34Z", "message": "Hold a BlockSummary rather than a BlockHeader in CheckpointState"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "519a5e7dca78c14648b0aa0bc8b6e94fe42b7913", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/519a5e7dca78c14648b0aa0bc8b6e94fe42b7913", "committedDate": "2020-11-04T21:14:30Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f51e653b5d10cd879c6f8200590c8c32c17d4d62", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f51e653b5d10cd879c6f8200590c8c32c17d4d62", "committedDate": "2020-11-04T21:19:29Z", "message": "Simplify AnchorPoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79567956621c69f1600c5435a111ad58e1047e9a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/79567956621c69f1600c5435a111ad58e1047e9a", "committedDate": "2020-11-04T22:41:01Z", "message": "Update WeakSubjectivityValidatorTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzODA2NDcx", "url": "https://github.com/ConsenSys/teku/pull/3133#pullrequestreview-523806471", "createdAt": "2020-11-04T23:19:10Z", "commit": {"oid": "79567956621c69f1600c5435a111ad58e1047e9a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzoxOToxMFrOHttLVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzoxOToxMFrOHttLVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY4ODE1MQ==", "bodyText": "This is potentially a bit heavy handed as it removes all compile time checking.  Can we get away with:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .map(BeaconBlockSummary.class::cast)\n          \n          \n            \n                        .<BeaconBlockSummary>map(a -> a)\n          \n      \n    \n    \n  \n\nIt doesn't read quite as well, but will give compile errors if block ever winds up not actually being a BeaconBlockSummary.", "url": "https://github.com/ConsenSys/teku/pull/3133#discussion_r517688151", "createdAt": "2020-11-04T23:19:10Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/state/AnchorPoint.java", "diffHunk": "@@ -30,33 +34,36 @@\n  * Represents an \"anchor\" - a trusted, finalized (block, state, checkpoint) tuple from which we can\n  * sync.\n  */\n-public class AnchorPoint {\n+public class AnchorPoint extends StateAndBlockSummary {\n   private final Checkpoint checkpoint;\n-  private final SignedBeaconBlock block;\n-  private final BeaconState state;\n   private final boolean isGenesis;\n-  private final SignedBlockAndState blockAndState;\n \n   private AnchorPoint(\n-      final Checkpoint checkpoint, final SignedBeaconBlock block, final BeaconState state) {\n+      final Checkpoint checkpoint, final BeaconState state, final BeaconBlockSummary blockSummary) {\n+    super(blockSummary, state);\n     checkArgument(\n-        block.getStateRoot().equals(state.hash_tree_root()), \"Block and state must match\");\n-    checkArgument(checkpoint.getRoot().equals(block.getRoot()), \"Checkpoint and block must match\");\n+        checkpoint.getRoot().equals(blockSummary.getRoot()), \"Checkpoint and block must match\");\n \n     this.checkpoint = checkpoint;\n-    this.block = block;\n-    this.state = state;\n     this.isGenesis = checkpoint.getEpoch().equals(UInt64.valueOf(Constants.GENESIS_EPOCH));\n-    this.blockAndState = new SignedBlockAndState(block, state);\n+  }\n+\n+  public static AnchorPoint create(\n+      Checkpoint checkpoint, BeaconState state, Optional<SignedBeaconBlock> block) {\n+    final BeaconBlockSummary blockSummary =\n+        block\n+            .map(BeaconBlockSummary.class::cast)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79567956621c69f1600c5435a111ad58e1047e9a"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ff483e24e53449c2e27ec9f700c147084b08890", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/0ff483e24e53449c2e27ec9f700c147084b08890", "committedDate": "2020-11-05T16:22:51Z", "message": "Use safer casting approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9844365f81184ae2b39aab4053ff68b42fd36b97", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/9844365f81184ae2b39aab4053ff68b42fd36b97", "committedDate": "2020-11-05T17:00:58Z", "message": "Merge branch 'master' into issue-3063/add-block-summary-interface\n\n Conflicts:\n\tstorage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java\n\tstorage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java\n\tstorage/src/main/java/tech/pegasys/teku/storage/store/StoreTransactionUpdates.java\n\tstorage/src/test/java/tech/pegasys/teku/storage/client/RecentChainDataTest.java\n\tstorage/src/test/java/tech/pegasys/teku/storage/client/StorageBackedRecentChainDataTest.java\n\tstorage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/AbstractRocksDbDatabaseTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab328ba6c66d60907258c2630a0a714661fed5a0", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/ab328ba6c66d60907258c2630a0a714661fed5a0", "committedDate": "2020-11-05T17:12:12Z", "message": "Require hot tx updates to hold full blocks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c73bc30b85118e43ee7c1c189afa93079ffcc64f", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c73bc30b85118e43ee7c1c189afa93079ffcc64f", "committedDate": "2020-11-05T18:30:42Z", "message": "Use safer casting approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "368e634f2040f8b31ccdcf9a0c07c9da534e309a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/368e634f2040f8b31ccdcf9a0c07c9da534e309a", "committedDate": "2020-11-05T18:31:55Z", "message": "Cut unused methods"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3290, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}