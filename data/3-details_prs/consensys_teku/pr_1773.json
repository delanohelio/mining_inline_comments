{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MDE1NTIy", "number": 1773, "title": "Adds periodic peer status updates", "bodyText": "PR Description\nAdds periodic peer status updates. Solves: [BC-338](https://pegasys1.atlassian.net/secure/RapidBoard.jspa?rapidView=67&modal=detail&selectedIssue=BC-338)", "createdAt": "2020-05-12T22:52:11Z", "url": "https://github.com/ConsenSys/teku/pull/1773", "merged": true, "mergeCommit": {"oid": "1f45f9af53996b58c313bf7238013d9f35ca3cd0"}, "closed": true, "closedAt": "2020-05-14T15:59:32Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgsUepgH2gAyNDE3MDE1NTIyOjQ0OWVhMzIwYjE1NzRlYWQzMWU4YzA5MTgzZTJjYjliMTQ0OTc4MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchPbxzABqjMzMzcyMzkxMzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "449ea320b1574ead31e8c09183e2cb9b14497834", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/449ea320b1574ead31e8c09183e2cb9b14497834", "committedDate": "2020-05-12T22:49:51Z", "message": "Add periodic peer status updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTA0MjAx", "url": "https://github.com/ConsenSys/teku/pull/1773#pullrequestreview-410504201", "createdAt": "2020-05-13T00:06:51Z", "commit": {"oid": "449ea320b1574ead31e8c09183e2cb9b14497834"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMDowNjo1MVrOGUdH4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMDoxMTozNVrOGUdMgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMTg1Nw==", "bodyText": "Suggest combining these into one call to subscribeDisconnect:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                peer.subscribeDisconnect(() -> periodicStatusUpdateTask.cancel(false));\n          \n          \n            \n                peer.subscribeDisconnect(() -> periodicPingTask.cancel(false));\n          \n          \n            \n                peer.subscribeDisconnect(() -> {\n          \n          \n            \n                    periodicStatusUpdateTask.cancel(false);\n          \n          \n            \n                    periodicPingTask.cancel(false);\n          \n          \n            \n                 });", "url": "https://github.com/ConsenSys/teku/pull/1773#discussion_r424101857", "createdAt": "2020-05-13T00:06:51Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -105,7 +111,49 @@ public static Eth2PeerManager create(\n         peerValidatorFactory,\n         attestationSubnetService,\n         rpcEncoding,\n-        eth2RpcPingInterval);\n+        eth2RpcPingInterval,\n+        eth2StatusUpdateInterval);\n+  }\n+\n+  private void setUpPeriodicTasksForPeer(Eth2Peer peer) {\n+    SafeFuture<Void> periodicStatusUpdateTask = periodicallyUpdatePeerStatus(peer);\n+    SafeFuture<Void> periodicPingTask = periodicallyPingPeer(peer);\n+    peer.subscribeDisconnect(() -> periodicStatusUpdateTask.cancel(false));\n+    peer.subscribeDisconnect(() -> periodicPingTask.cancel(false));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "449ea320b1574ead31e8c09183e2cb9b14497834"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMzA0Mw==", "bodyText": "I misunderstood this when I read the ping PR, but we shouldn't be ignoring futures here.  If the peer:sendStatus call fails (ie we don't get a response from them or it's invalid) - what should we do?  Feels like we should disconnect if we get too many of those but definitely should at least report it at debug level.", "url": "https://github.com/ConsenSys/teku/pull/1773#discussion_r424103043", "createdAt": "2020-05-13T00:11:35Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -105,7 +111,49 @@ public static Eth2PeerManager create(\n         peerValidatorFactory,\n         attestationSubnetService,\n         rpcEncoding,\n-        eth2RpcPingInterval);\n+        eth2RpcPingInterval,\n+        eth2StatusUpdateInterval);\n+  }\n+\n+  private void setUpPeriodicTasksForPeer(Eth2Peer peer) {\n+    SafeFuture<Void> periodicStatusUpdateTask = periodicallyUpdatePeerStatus(peer);\n+    SafeFuture<Void> periodicPingTask = periodicallyPingPeer(peer);\n+    peer.subscribeDisconnect(() -> periodicStatusUpdateTask.cancel(false));\n+    peer.subscribeDisconnect(() -> periodicPingTask.cancel(false));\n+  }\n+\n+  @SuppressWarnings(\"FutureReturnValueIgnored\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "449ea320b1574ead31e8c09183e2cb9b14497834"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDQzMzk3", "url": "https://github.com/ConsenSys/teku/pull/1773#pullrequestreview-411043397", "createdAt": "2020-05-13T15:28:28Z", "commit": {"oid": "449ea320b1574ead31e8c09183e2cb9b14497834"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNToyODoyOFrOGU3MyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNToyODoyOFrOGU3MyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUyOTA5Ng==", "bodyText": "This variant of runWithFixedDelay returns Future which is actually never completes (until cancel() call). So the only method which makes sense here is Future.cancel(). Any exception happened in the periodic task is reported via exceptionHandler ((err) -> LOG.debug(\"Exception updating peer status.\", err)))\nThat's probably my fault and the runWithFixedDelay method should return something like Cancellable instead of SafeFuture<Void>", "url": "https://github.com/ConsenSys/teku/pull/1773#discussion_r424529096", "createdAt": "2020-05-13T15:28:28Z", "author": {"login": "Nashatyrev"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java", "diffHunk": "@@ -105,7 +111,49 @@ public static Eth2PeerManager create(\n         peerValidatorFactory,\n         attestationSubnetService,\n         rpcEncoding,\n-        eth2RpcPingInterval);\n+        eth2RpcPingInterval,\n+        eth2StatusUpdateInterval);\n+  }\n+\n+  private void setUpPeriodicTasksForPeer(Eth2Peer peer) {\n+    SafeFuture<Void> periodicStatusUpdateTask = periodicallyUpdatePeerStatus(peer);\n+    SafeFuture<Void> periodicPingTask = periodicallyPingPeer(peer);\n+    peer.subscribeDisconnect(() -> periodicStatusUpdateTask.cancel(false));\n+    peer.subscribeDisconnect(() -> periodicPingTask.cancel(false));\n+  }\n+\n+  @SuppressWarnings(\"FutureReturnValueIgnored\")\n+  SafeFuture<Void> periodicallyUpdatePeerStatus(Eth2Peer peer) {\n+    return asyncRunner\n+        .runWithFixedDelay(\n+            peer::sendStatus,\n+            eth2StatusUpdateInterval.getSeconds(),\n+            TimeUnit.SECONDS,\n+            (err) -> LOG.debug(\"Exception updating peer status.\", err))\n+        .exceptionallyCompose(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "449ea320b1574ead31e8c09183e2cb9b14497834"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "339c0ee7f760bc2188ceb788b098d1ce5ec13597", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/339c0ee7f760bc2188ceb788b098d1ce5ec13597", "committedDate": "2020-05-13T17:32:08Z", "message": "."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57f749798201ba02f3f5585e0a7f781f0aa8916b", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/57f749798201ba02f3f5585e0a7f781f0aa8916b", "committedDate": "2020-05-13T17:32:33Z", "message": "Log when individual calls fail"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a3e7f19b3ed9347158a815f191884d063601d9", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/d5a3e7f19b3ed9347158a815f191884d063601d9", "committedDate": "2020-05-13T17:35:07Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02f7ff9092b9fdf36abcc3338edc169866ba4032", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/02f7ff9092b9fdf36abcc3338edc169866ba4032", "committedDate": "2020-05-13T17:35:57Z", "message": "Make AsyncRunner.runWithFixedDelay interface clearer with returning simple Cancellable and removing one unused variant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e670aafb6601ba0334dd97927652d05c98153cdc", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/e670aafb6601ba0334dd97927652d05c98153cdc", "committedDate": "2020-05-13T17:44:26Z", "message": "Update periodic functions to work with new cancellable object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd3e4366c62fd8e0b8c07ee97dcb034f73c840f6", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/dd3e4366c62fd8e0b8c07ee97dcb034f73c840f6", "committedDate": "2020-05-13T17:47:44Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ebe00b0fd9e079b8447f37005373fcb63910fd1", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/6ebe00b0fd9e079b8447f37005373fcb63910fd1", "committedDate": "2020-05-14T15:35:25Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into addPeriodicStatusUpdates\n\n# Conflicts:\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManagerTest.java\n#\tnetworking/eth2/src/testFixtures/java/tech/pegasys/teku/networking/eth2/Eth2NetworkFactory.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa32feca14199be259408ecd4c8d444d79c5ebeb", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/aa32feca14199be259408ecd4c8d444d79c5ebeb", "committedDate": "2020-05-13T23:08:15Z", "message": "Merge branch 'master' into addPeriodicStatusUpdates"}, "afterCommit": {"oid": "6ebe00b0fd9e079b8447f37005373fcb63910fd1", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/6ebe00b0fd9e079b8447f37005373fcb63910fd1", "committedDate": "2020-05-14T15:35:25Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into addPeriodicStatusUpdates\n\n# Conflicts:\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java\n#\tnetworking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManager.java\n#\tnetworking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/peers/Eth2PeerManagerTest.java\n#\tnetworking/eth2/src/testFixtures/java/tech/pegasys/teku/networking/eth2/Eth2NetworkFactory.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4194, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}