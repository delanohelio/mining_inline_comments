{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MTg1MjY5", "number": 2883, "title": "follow symlinks in order to better support k8s secrets", "bodyText": "PR Description\nWhen k8s secrets are mounted as files into a pod the resulting directory structure contains symlinks to timestamped directories - presumably to better support the update lifecycle.\nWhen looking for keys using --validator-keys the code uses Files.walk() to find key files.\nFixed Issue(s)\nFiles.walk wasn't following symlinks so was not finding key files mounted as secrets.\nDocumentation\nn/a", "createdAt": "2020-10-06T00:10:55Z", "url": "https://github.com/ConsenSys/teku/pull/2883", "merged": true, "mergeCommit": {"oid": "db979c9771c8f301d8ad812ff0ae6677636e46ba"}, "closed": true, "closedAt": "2020-10-06T01:38:01Z", "author": {"login": "mread"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPtMo9AFqTUwMjUwNjM0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPuOe0gFqTUwMjUyNzgzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNTA2MzQw", "url": "https://github.com/ConsenSys/teku/pull/2883#pullrequestreview-502506340", "createdAt": "2020-10-06T00:24:33Z", "commit": {"oid": "c69898d76707a28f417c1f308e6a360b4845a20b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwMDoyNDozNFrOHcyAkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwMDoyNDozNFrOHcyAkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk0MTUyMw==", "bodyText": "createSymbolicLink isn't supported on all file systems so we probably should catch the UnsupportedOperationException it may throw and just skip the test in that case.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Files.createSymbolicLink(tempDir.resolve(\"key\"), realKeyDir);\n          \n          \n            \n                Files.createSymbolicLink(tempDir.resolve(\"pass\"), realPassDir);\n          \n          \n            \n                try {\n          \n          \n            \n                    Files.createSymbolicLink(tempDir.resolve(\"key\"), realKeyDir);\n          \n          \n            \n                    Files.createSymbolicLink(tempDir.resolve(\"pass\"), realPassDir);\n          \n          \n            \n                } catch (UnsupportedOperationException e) {\n          \n          \n            \n                    throw new AssumptionViolatedException(\"Symbolic links not supported on this file system\");\n          \n          \n            \n                }", "url": "https://github.com/ConsenSys/teku/pull/2883#discussion_r499941523", "createdAt": "2020-10-06T00:24:34Z", "author": {"login": "ajsutton"}, "path": "util/src/test/java/tech/pegasys/teku/util/config/KeyStoreFilesLocatorTest.java", "diffHunk": "@@ -189,6 +191,27 @@ public void shouldHandleOldArgs(@TempDir final Path tempDir) throws IOException\n         .containsExactly(tuple(tempDir, List.of(\"key\", \"a\"), List.of(\"pass\", \"a.txt\")));\n   }\n \n+  @Test\n+  public void shouldHandleSymlinkedDirectories(@TempDir final Path tempDir) throws IOException {\n+    Path realKeyDir = Path.of(\"actualKey\");\n+    Path realPassDir = Path.of(\"actualPass\");\n+    createFolders(tempDir, realKeyDir, realPassDir);\n+    createFiles(tempDir, realKeyDir.resolve(\"a.json\"), realPassDir.resolve(\"a.txt\"));\n+\n+    Files.createSymbolicLink(tempDir.resolve(\"key\"), realKeyDir);\n+    Files.createSymbolicLink(tempDir.resolve(\"pass\"), realPassDir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c69898d76707a28f417c1f308e6a360b4845a20b"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a630737752ab6e3791bf57660cdc586cf27fbdbe", "author": {"user": {"login": "mread", "name": "Matt Read"}}, "url": "https://github.com/ConsenSys/teku/commit/a630737752ab6e3791bf57660cdc586cf27fbdbe", "committedDate": "2020-10-06T00:52:35Z", "message": "follow symlinks in order to better support k8s secrets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca2c857fa37eaf7685b1823616a3d6680144e7d9", "author": {"user": {"login": "mread", "name": "Matt Read"}}, "url": "https://github.com/ConsenSys/teku/commit/ca2c857fa37eaf7685b1823616a3d6680144e7d9", "committedDate": "2020-10-06T00:53:01Z", "message": "wrap UOE if symlinks aren't supported, also let spotless do its thing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10d4820e114c4acf7cacc292ada6f044efdcb37f", "author": {"user": {"login": "mread", "name": "Matt Read"}}, "url": "https://github.com/ConsenSys/teku/commit/10d4820e114c4acf7cacc292ada6f044efdcb37f", "committedDate": "2020-10-06T00:48:36Z", "message": "wrap UOE if symlinks aren't supported, also let spotless do its thing"}, "afterCommit": {"oid": "ca2c857fa37eaf7685b1823616a3d6680144e7d9", "author": {"user": {"login": "mread", "name": "Matt Read"}}, "url": "https://github.com/ConsenSys/teku/commit/ca2c857fa37eaf7685b1823616a3d6680144e7d9", "committedDate": "2020-10-06T00:53:01Z", "message": "wrap UOE if symlinks aren't supported, also let spotless do its thing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac8a30bf872c3cf34265ab08ab8c57ca0d2642b9", "author": {"user": {"login": "mread", "name": "Matt Read"}}, "url": "https://github.com/ConsenSys/teku/commit/ac8a30bf872c3cf34265ab08ab8c57ca0d2642b9", "committedDate": "2020-10-06T00:56:38Z", "message": "not having much luck with spotless, last attempt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNTI3ODMw", "url": "https://github.com/ConsenSys/teku/pull/2883#pullrequestreview-502527830", "createdAt": "2020-10-06T01:37:33Z", "commit": {"oid": "ac8a30bf872c3cf34265ab08ab8c57ca0d2642b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3486, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}