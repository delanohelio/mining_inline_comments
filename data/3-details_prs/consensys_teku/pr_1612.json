{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0OTI3MzEz", "number": 1612, "title": "Publish events when the chain reorgs", "bodyText": "PR Description\nUpdate RecentChainData.updateBestBlock so that it publishes an event when the chain switches between forks.  Events are not published when the initial best block is set or when the chain head advances on the same fork.", "createdAt": "2020-04-17T05:19:45Z", "url": "https://github.com/ConsenSys/teku/pull/1612", "merged": true, "mergeCommit": {"oid": "b76a4f0f3011f8bb766b70c8f8bcca4488970f21"}, "closed": true, "closedAt": "2020-04-17T22:25:29Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYaObEgH2gAyNDA0OTI3MzEzOjRmNjZkOGI3MzQ0MTFmMTlkN2E1ZTk3ZWRiNDYzODRlZTY4ODU5ODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYo0L0AH2gAyNDA0OTI3MzEzOmUxNTM3MDc1NjMxMDg2MGJlNDAxN2FiYmQzMzlkOTFhNjZjM2E0NWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f66d8b734411f19d7a5e97edb46384ee6885980", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4f66d8b734411f19d7a5e97edb46384ee6885980", "committedDate": "2020-04-17T05:13:33Z", "message": "Publish events when the chain reorgs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d2d81671f7d636fdebdc3d7a1ffc24eb12ebc54", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4d2d81671f7d636fdebdc3d7a1ffc24eb12ebc54", "committedDate": "2020-04-17T05:19:11Z", "message": "Add comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee34502fd078bef632078d4395bd7f2871ed9d25", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ee34502fd078bef632078d4395bd7f2871ed9d25", "committedDate": "2020-04-17T05:38:22Z", "message": "Spotless."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "392caf7c31b39f82e3b1994ddd3356d691c0a33c", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/392caf7c31b39f82e3b1994ddd3356d691c0a33c", "committedDate": "2020-04-17T05:38:48Z", "message": "Fix compilation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTczODQ3", "url": "https://github.com/ConsenSys/teku/pull/1612#pullrequestreview-395573847", "createdAt": "2020-04-17T15:52:53Z", "commit": {"oid": "392caf7c31b39f82e3b1994ddd3356d691c0a33c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTo1Mjo1M1rOGHTjig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTo1Mjo1M1rOGHTjig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMxMzYxMA==", "bodyText": "nit: A bit of explanation on how getBlockRootBySlot might return a different root at that slot would be nice, since the updating of the canonical chain with the switch to a new bestBlockRoot is a bit implicit.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Get the block root in effect at the old best slot on the new chain\n          \n          \n            \n                // Get the block root in effect at the old best slot on the new chain, which might be different from originalBestRoot due to getBlockRootBySlot potentially using a new chain as the correct fork", "url": "https://github.com/ConsenSys/teku/pull/1612#discussion_r410313610", "createdAt": "2020-04-17T15:52:53Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/client/RecentChainData.java", "diffHunk": "@@ -130,9 +134,22 @@ public Store getStore() {\n    * @param slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {\n+    final Optional<Bytes32> originalBestRoot = bestBlockRoot;\n+    final UnsignedLong originalBestSlot = bestSlot;\n     this.bestBlockRoot = Optional.of(root);\n     this.bestSlot = slot;\n     bestBlockInitialized.complete(null);\n+\n+    if (originalBestRoot.map(original -> isReorg(original, originalBestSlot)).orElse(false)) {\n+      reorgEventChannel.reorgOccurred();\n+    }\n+  }\n+\n+  private boolean isReorg(final Bytes32 originalBestRoot, final UnsignedLong originalBestSlot) {\n+    // Get the block root in effect at the old best slot on the new chain", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "392caf7c31b39f82e3b1994ddd3356d691c0a33c"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTc4MzAx", "url": "https://github.com/ConsenSys/teku/pull/1612#pullrequestreview-395578301", "createdAt": "2020-04-17T15:58:24Z", "commit": {"oid": "392caf7c31b39f82e3b1994ddd3356d691c0a33c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fcb66059760e105ac8f24a16d5b07602fbe7f48", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/5fcb66059760e105ac8f24a16d5b07602fbe7f48", "committedDate": "2020-04-17T22:13:19Z", "message": "Improve comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e15370756310860be4017abbd339d91a66c3a45b", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e15370756310860be4017abbd339d91a66c3a45b", "committedDate": "2020-04-17T22:13:28Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into detect-reorg"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4307, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}