{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzNjQ1MTI1", "number": 2514, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMDowMTowNFrOEVnjuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMDowMToxMFrOEVnjyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTAzNjc1OnYy", "diffSide": "RIGHT", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMDowMTowNFrOG8emNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMDowMTowNFrOG8emNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2OTA0NA==", "bodyText": "The attestation winds up being added to a set so it deduplicates - we'd need to have the add call return a flag to indicate if the attestation was actually added or not.", "url": "https://github.com/ConsenSys/teku/pull/2514#discussion_r466069044", "createdAt": "2020-08-06T00:01:04Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java", "diffHunk": "@@ -59,6 +62,7 @@ public AggregatingAttestationPool(\n   public synchronized void add(final ValidateableAttestation attestation) {\n     final AttestationData attestationData = attestation.getAttestation().getData();\n     final Bytes32 dataRoot = attestationData.hash_tree_root();\n+    size.getAndIncrement();\n     attestationGroupByDataHash\n         .computeIfAbsent(dataRoot, key -> new MatchingDataAttestationGroup(attestationData))\n         .add(attestation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd0228ad56b563b61faaeb7f2b3cb58070a29b00"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMTAzNjkxOnYy", "diffSide": "RIGHT", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwMDowMToxMFrOG8emUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMTozNDowM1rOG9WdMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2OTA3Mw==", "bodyText": "Discussed offline but this will need to be a little smarter - attestations.remove will need to return the number of attestations it actually removed because it intelligently handles aggregates.\nSo if I remove an aggregate that includes validators 1,2,3,4,5 it will remove any single attestations for the same data from those validators or any combination thereof.  But it won\u2019t remove an aggregate with 1,2,3,4,5,6 because 6 is still new info.", "url": "https://github.com/ConsenSys/teku/pull/2514#discussion_r466069073", "createdAt": "2020-08-06T00:01:10Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java", "diffHunk": "@@ -90,6 +94,7 @@ public synchronized void remove(final Attestation attestation) {\n       return;\n     }\n     attestations.remove(attestation);\n+    size.decrementAndGet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd0228ad56b563b61faaeb7f2b3cb58070a29b00"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk4NDI0Mw==", "bodyText": "I've pushed up the changes which should address this as discussed.  I'm not confident that this is quite right yet, and need to write a couple more tests and talk through this.", "url": "https://github.com/ConsenSys/teku/pull/2514#discussion_r466984243", "createdAt": "2020-08-07T11:34:03Z", "author": {"login": "rojotek"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPool.java", "diffHunk": "@@ -90,6 +94,7 @@ public synchronized void remove(final Attestation attestation) {\n       return;\n     }\n     attestations.remove(attestation);\n+    size.decrementAndGet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2OTA3Mw=="}, "originalCommit": {"oid": "fd0228ad56b563b61faaeb7f2b3cb58070a29b00"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3461, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}