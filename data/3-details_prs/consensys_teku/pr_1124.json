{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4ODk5OTg1", "number": 1124, "title": "Use EventChannels for deposits", "bodyText": "PR Description\nAdds EventChannel as an alternative to EventBus with a simpler threading model and to ensure that when subscribers are unable to process events fast enough, back pressure is applied to slow down the producer.  With EventBus the producer would just keep going full speed, creating a new thread with every event published until eventually resource limits were hit and everything failed.\nSo far only deposit events are delivered via EventChannel.", "createdAt": "2020-01-30T05:54:34Z", "url": "https://github.com/ConsenSys/teku/pull/1124", "merged": true, "mergeCommit": {"oid": "40a41c171e901f17c0d1740c778dd3cd6b053298"}, "closed": true, "closedAt": "2020-01-30T21:12:42Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8u3odgH2gAyMzY4ODk5OTg1OmI1OGI1Njg1YmQ1YmJkN2U4NDMzZGZkYTVjZDRlMTBjYjg3OWUxOGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_hMKzgFqTM1MTE0NDgyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b58b5685bd5bbd7e8433dfda5cd4e10cb879e18b", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b58b5685bd5bbd7e8433dfda5cd4e10cb879e18b", "committedDate": "2020-01-22T05:26:47Z", "message": "Implement EventChannel as an alternative to EventBus."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "068054c7de7130f6d763ac1a8d8d072d8b3eedd9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/068054c7de7130f6d763ac1a8d8d072d8b3eedd9", "committedDate": "2020-01-22T05:36:58Z", "message": "Simple demonstration of using EventChannel by switching time events over to it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f4f17f7cba665517246dce6af3895af48d48c91", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/9f4f17f7cba665517246dce6af3895af48d48c91", "committedDate": "2020-01-22T21:30:28Z", "message": "Switch order."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f58c94958a769d3ce0f5db30572bc2e9c2c691bd", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/f58c94958a769d3ce0f5db30572bc2e9c2c691bd", "committedDate": "2020-01-29T22:56:13Z", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into typed-events"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ec32f42386cdad62afb09d7c3ff9c63bbbe7cce", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/9ec32f42386cdad62afb09d7c3ff9c63bbbe7cce", "committedDate": "2020-01-29T23:42:37Z", "message": "Add EventChannels class to manage a group of channels."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f87a5317e547a452d715986593f3e8776250301", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/5f87a5317e547a452d715986593f3e8776250301", "committedDate": "2020-01-30T00:16:49Z", "message": "Support custom exception handlers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de54574f8487ca51a40579c80ce9b5e641821f20", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/de54574f8487ca51a40579c80ce9b5e641821f20", "committedDate": "2020-01-30T04:24:52Z", "message": "Set stopped correctly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac7ecf912137d9408ece588eb07ab009b7092029", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ac7ecf912137d9408ece588eb07ab009b7092029", "committedDate": "2020-01-30T04:25:06Z", "message": "Remove unused variables."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ad7804eb26ce3fcf73391ecac6e289c65299551", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0ad7804eb26ce3fcf73391ecac6e289c65299551", "committedDate": "2020-01-30T04:26:49Z", "message": "Back to event bus for time events, but use EventChannel for deposit events."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cf8fa91c958854f7f227856ce3e3e753a22bde2", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7cf8fa91c958854f7f227856ce3e3e753a22bde2", "committedDate": "2020-01-30T04:46:27Z", "message": "Use this prefix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "216fe143a3978daf9ee8c339cefabe455c943364", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/216fe143a3978daf9ee8c339cefabe455c943364", "committedDate": "2020-01-30T04:59:13Z", "message": "Use same exception handler as for event bus."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a01c79c5975f2d287d57a93b82ae853347606d6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2a01c79c5975f2d287d57a93b82ae853347606d6", "committedDate": "2020-01-30T06:00:42Z", "message": "Fix failures."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fb3891ef238d77668e10a33e5d9e01aa1b4e0af", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1fb3891ef238d77668e10a33e5d9e01aa1b4e0af", "committedDate": "2020-01-30T06:05:07Z", "message": "Fix test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMDk5NzI1", "url": "https://github.com/ConsenSys/teku/pull/1124#pullrequestreview-351099725", "createdAt": "2020-01-30T19:53:56Z", "commit": {"oid": "1fb3891ef238d77668e10a33e5d9e01aa1b4e0af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxOTo1Mzo1NlrOFj38NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxOTo1Mzo1NlrOFj38NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE2MTAxMg==", "bodyText": "Why do you do this call? It seems a bit unnecessary, to make sure the number of arguments is correct?", "url": "https://github.com/ConsenSys/teku/pull/1124#discussion_r373161012", "createdAt": "2020-01-30T19:53:56Z", "author": {"login": "cemozerr"}, "path": "events/src/main/java/tech/pegasys/artemis/events/EventDeliverer.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.events;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import tech.pegasys.artemis.util.events.Subscribers;\n+\n+abstract class EventDeliverer<T> implements InvocationHandler {\n+  private final Subscribers<T> subscribers = Subscribers.create(true);\n+\n+  void subscribe(T subscriber) {\n+    subscribers.subscribe(subscriber);\n+  }\n+\n+  @Override\n+  public Object invoke(final Object proxy, final Method method, final Object[] args) {\n+    if (method.getDeclaringClass().equals(Object.class)) {\n+      try {\n+        return method.invoke(this, args);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fb3891ef238d77668e10a33e5d9e01aa1b4e0af"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMTA3NDgx", "url": "https://github.com/ConsenSys/teku/pull/1124#pullrequestreview-351107481", "createdAt": "2020-01-30T20:06:56Z", "commit": {"oid": "1fb3891ef238d77668e10a33e5d9e01aa1b4e0af"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMDowNjo1NlrOFj4Tug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMDowNjo1NlrOFj4Tug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE2NzAzNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void shouldGetPublisherBeforeSubscriber() {\n          \n          \n            \n              public void shouldBeAbleToGetPublisherBeforeSubscriber() {", "url": "https://github.com/ConsenSys/teku/pull/1124#discussion_r373167034", "createdAt": "2020-01-30T20:06:56Z", "author": {"login": "mbaxter"}, "path": "events/src/test/java/tech/pegasys/artemis/events/EventChannelsTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.events;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.verifyNoInteractions;\n+import static org.mockito.Mockito.verifyNoMoreInteractions;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class EventChannelsTest {\n+  private final EventChannels channels = new EventChannels(EventChannel::create);\n+\n+  @Test\n+  public void shouldGetPublisherBeforeSubscriber() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fb3891ef238d77668e10a33e5d9e01aa1b4e0af"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce418a53ea8579b14b1c1678e068dd430eaefc83", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ce418a53ea8579b14b1c1678e068dd430eaefc83", "committedDate": "2020-01-30T20:58:27Z", "message": "Rename test.\n\nCo-Authored-By: mbaxter <meredith.baxter@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1560c79c36ea42964da5d7cd1d3f89a3a3ad17a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/c1560c79c36ea42964da5d7cd1d3f89a3a3ad17a", "committedDate": "2020-01-30T20:58:35Z", "message": "Merge branch 'master' into typed-events"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMTQ0ODIw", "url": "https://github.com/ConsenSys/teku/pull/1124#pullrequestreview-351144820", "createdAt": "2020-01-30T21:12:19Z", "commit": {"oid": "c1560c79c36ea42964da5d7cd1d3f89a3a3ad17a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4254, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}