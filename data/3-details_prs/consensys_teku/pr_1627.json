{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MzYxNDM1", "number": 1627, "title": "Save protoarray votes on disk", "bodyText": "PR Description\nSaves proto array votes to disk so that we have a somewhat recent state of fork choice at restart.\nAlso removes anything related to MapDB, DBv1, and DBv2.", "createdAt": "2020-04-20T23:49:26Z", "url": "https://github.com/ConsenSys/teku/pull/1627", "merged": true, "mergeCommit": {"oid": "1f7eec7b8c3035b8a3ec0a5d0bf04d5dc32c18e2"}, "closed": true, "closedAt": "2020-04-22T23:08:59Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZn-SJgH2gAyNDA2MzYxNDM1OmIzYzZmZTlmNmY4M2RhNTJmODE5MzczMzg2YTQ3MWY0ZmIzMDBmYzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaQOtwAH2gAyNDA2MzYxNDM1OjI1Y2UyM2UyMjZlZTdkNTkzNzQyZGNlNzA0MDcyYTY1YTMxMjI0ZGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b3c6fe9f6f83da52f819373386a471f4fb300fc0", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/b3c6fe9f6f83da52f819373386a471f4fb300fc0", "committedDate": "2020-04-20T23:48:31Z", "message": "Start move to save votes on disk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2ODk5NDgy", "url": "https://github.com/ConsenSys/teku/pull/1627#pullrequestreview-396899482", "createdAt": "2020-04-21T00:00:09Z", "commit": {"oid": "b3c6fe9f6f83da52f819373386a471f4fb300fc0"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMDowMDowOVrOGIsmig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMDowMjo1OFrOGIsqHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3MjU1NA==", "bodyText": "I would only add these to MutableStore.  Seems weird but VoteTracker is mutable so you can't be allowed to get one from an immutable store.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r411772554", "createdAt": "2020-04-21T00:00:09Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/forkchoice/ReadOnlyStore.java", "diffHunk": "@@ -48,4 +52,8 @@\n   BeaconState getCheckpointState(Checkpoint checkpoint);\n \n   boolean containsCheckpointState(Checkpoint checkpoint);\n+\n+  VoteTracker getVote(int validatorIndex);\n+\n+  Collection<VoteTracker> getVotes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c6fe9f6f83da52f819373386a471f4fb300fc0"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3Mjg4MQ==", "bodyText": "This copy should be done inside Store.  There should be no way to modify things in the Store without going via the transaction.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r411772881", "createdAt": "2020-04-21T00:01:08Z", "author": {"login": "ajsutton"}, "path": "protoarray/src/main/java/tech/pegasys/artemis/protoarray/ProtoArrayForkChoiceStrategy.java", "diffHunk": "@@ -139,13 +139,15 @@ private static void processBlockAtStartup(\n         store.getBlockState(block.hash_tree_root()).getFinalized_checkpoint().getEpoch());\n   }\n \n-  void processAttestation(int validatorIndex, Bytes32 blockRoot, UnsignedLong targetEpoch) {\n-    VoteTracker vote = votes.get(validatorIndex);\n+  void processAttestation(MutableStore store, int validatorIndex, Bytes32 blockRoot, UnsignedLong targetEpoch) {\n+    VoteTracker vote = store.getVote(validatorIndex).copy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c6fe9f6f83da52f819373386a471f4fb300fc0"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3MzA3OA==", "bodyText": "If you move getVote into Transaction then you won't need to do this - just get the mutable vote and edit it as needed.  When the transaction commits those changes can all be committed as well.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r411773078", "createdAt": "2020-04-21T00:01:45Z", "author": {"login": "ajsutton"}, "path": "protoarray/src/main/java/tech/pegasys/artemis/protoarray/ProtoArrayForkChoiceStrategy.java", "diffHunk": "@@ -139,13 +139,15 @@ private static void processBlockAtStartup(\n         store.getBlockState(block.hash_tree_root()).getFinalized_checkpoint().getEpoch());\n   }\n \n-  void processAttestation(int validatorIndex, Bytes32 blockRoot, UnsignedLong targetEpoch) {\n-    VoteTracker vote = votes.get(validatorIndex);\n+  void processAttestation(MutableStore store, int validatorIndex, Bytes32 blockRoot, UnsignedLong targetEpoch) {\n+    VoteTracker vote = store.getVote(validatorIndex).copy();\n \n     if (targetEpoch.compareTo(vote.getNextEpoch()) > 0 || vote.equals(VoteTracker.Default())) {\n       vote.setNextRoot(blockRoot);\n       vote.setNextEpoch(targetEpoch);\n     }\n+\n+    store.setVote(validatorIndex, vote);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c6fe9f6f83da52f819373386a471f4fb300fc0"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3MzE4MQ==", "bodyText": "This will need to be a mutable store because votes are being updated.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r411773181", "createdAt": "2020-04-21T00:02:03Z", "author": {"login": "ajsutton"}, "path": "protoarray/src/main/java/tech/pegasys/artemis/protoarray/ProtoArrayForkChoiceStrategy.java", "diffHunk": "@@ -278,11 +280,12 @@ public boolean containsBlock(Bytes32 blockRoot) {\n    */\n   static List<Long> computeDeltas(\n       Map<Bytes32, Integer> indices,\n-      ElasticList<VoteTracker> votes,\n+      ReadOnlyStore store,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3c6fe9f6f83da52f819373386a471f4fb300fc0"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3MzQ3MA==", "bodyText": "Probably don't actually need getVotes either - just getVote and maybe a getVoteCount but not sure even that will be required.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r411773470", "createdAt": "2020-04-21T00:02:58Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/forkchoice/ReadOnlyStore.java", "diffHunk": "@@ -48,4 +52,8 @@\n   BeaconState getCheckpointState(Checkpoint checkpoint);\n \n   boolean containsCheckpointState(Checkpoint checkpoint);\n+\n+  VoteTracker getVote(int validatorIndex);\n+\n+  Collection<VoteTracker> getVotes();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3MjU1NA=="}, "originalCommit": {"oid": "b3c6fe9f6f83da52f819373386a471f4fb300fc0"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58dd1c5690dfac2bd432e2ee0daca6feb31fd354", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/58dd1c5690dfac2bd432e2ee0daca6feb31fd354", "committedDate": "2020-04-21T17:56:39Z", "message": "Finish integration & start fixing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/35e0ef5fee8c5873bde7344e2011d9777d131224", "committedDate": "2020-04-21T17:58:33Z", "message": "Update error message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjQ0MDgy", "url": "https://github.com/ConsenSys/teku/pull/1627#pullrequestreview-397644082", "createdAt": "2020-04-21T20:18:45Z", "commit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMDoxODo0NVrOGJWvuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMDoxODo0NVrOGJWvuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ2MzAzMw==", "bodyText": "This is only for now, I will uncomment in the future.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r412463033", "createdAt": "2020-04-21T20:18:45Z", "author": {"login": "cemozerr"}, "path": "protoarray/src/main/java/tech/pegasys/artemis/protoarray/ProtoArrayForkChoiceStrategy.java", "diffHunk": "@@ -237,23 +238,23 @@ public boolean containsBlock(Bytes32 blockRoot) {\n     }\n   }\n \n-  public Optional<Checkpoint> latestMessage(int validatorIndex) {\n-    votesLock.readLock().lock();\n-    try {\n-      if (validatorIndex >= votes.size()) {\n-        return Optional.empty();\n-      } else {\n-        VoteTracker vote = votes.get(validatorIndex);\n-        if (vote.equals(VoteTracker.Default())) {\n-          return Optional.empty();\n-        } else {\n-          return Optional.of(new Checkpoint(vote.getNextEpoch(), vote.getNextRoot()));\n-        }\n-      }\n-    } finally {\n-      votesLock.readLock().unlock();\n-    }\n-  }\n+  //  public Optional<Checkpoint> latestMessage(int validatorIndex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "originalPosition": 116}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjQ1MDA2", "url": "https://github.com/ConsenSys/teku/pull/1627#pullrequestreview-397645006", "createdAt": "2020-04-21T20:20:09Z", "commit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMDoyMDoxMFrOGJWy7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMDoyMDoxMFrOGJWy7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ2Mzg1Mg==", "bodyText": "Instead of continuing whenever the validator has never voted, we simply don't iterate through those validators now, which is also more efficient.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r412463852", "createdAt": "2020-04-21T20:20:10Z", "author": {"login": "cemozerr"}, "path": "protoarray/src/main/java/tech/pegasys/artemis/protoarray/ProtoArrayForkChoiceStrategy.java", "diffHunk": "@@ -271,26 +272,20 @@ public boolean containsBlock(Bytes32 blockRoot) {\n    * </ul>\n    *\n    * @param indices\n-   * @param votes\n+   * @param store\n    * @param oldBalances\n    * @param newBalances\n    * @return\n    */\n   static List<Long> computeDeltas(\n+      MutableStore store,\n       Map<Bytes32, Integer> indices,\n-      ElasticList<VoteTracker> votes,\n       List<UnsignedLong> oldBalances,\n       List<UnsignedLong> newBalances) {\n     List<Long> deltas = new ArrayList<>(Collections.nCopies(indices.size(), 0L));\n \n-    for (int validatorIndex = 0; validatorIndex < votes.size(); validatorIndex++) {\n-      VoteTracker vote = votes.get(validatorIndex);\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "originalPosition": 156}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjY3NTEy", "url": "https://github.com/ConsenSys/teku/pull/1627#pullrequestreview-397667512", "createdAt": "2020-04-21T20:54:02Z", "commit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMDo1NDowMlrOGJYCRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMDo1Njo0OVrOGJYIQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ4NDE2NQ==", "bodyText": "Does it matter that we will no longer iterate through votes in order of validator index? I don't think it will but worth being sure.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r412484165", "createdAt": "2020-04-21T20:54:02Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/Store.java", "diffHunk": "@@ -235,6 +238,16 @@ public boolean containsCheckpointState(Checkpoint checkpoint) {\n     }\n   }\n \n+  @Override\n+  public Set<Integer> getVotedValidatorIndices() {\n+    readLock.lock();\n+    try {\n+      return votes.keySet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ4NDk3OQ==", "bodyText": "You'd be better off just iterating through the value set or entry set of the votes map since you need both the key and value here.\nAlso, getVotedValidatorIndices will return entries for every validator that we've ever retrieved - they may still have a current and next root of zero depending on whether anything was changed after it was retrieved.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r412484979", "createdAt": "2020-04-21T20:55:36Z", "author": {"login": "ajsutton"}, "path": "protoarray/src/main/java/tech/pegasys/artemis/protoarray/ProtoArrayForkChoiceStrategy.java", "diffHunk": "@@ -271,26 +272,20 @@ public boolean containsBlock(Bytes32 blockRoot) {\n    * </ul>\n    *\n    * @param indices\n-   * @param votes\n+   * @param store\n    * @param oldBalances\n    * @param newBalances\n    * @return\n    */\n   static List<Long> computeDeltas(\n+      MutableStore store,\n       Map<Bytes32, Integer> indices,\n-      ElasticList<VoteTracker> votes,\n       List<UnsignedLong> oldBalances,\n       List<UnsignedLong> newBalances) {\n     List<Long> deltas = new ArrayList<>(Collections.nCopies(indices.size(), 0L));\n \n-    for (int validatorIndex = 0; validatorIndex < votes.size(); validatorIndex++) {\n-      VoteTracker vote = votes.get(validatorIndex);\n-\n-      // There is no need to create a score change if the validator has never voted\n-      // or both their votes are for the zero hash (alias to the genesis block).\n-      if (vote.getCurrentRoot().equals(Bytes32.ZERO) && vote.getNextRoot().equals(Bytes32.ZERO)) {\n-        continue;\n-      }\n+    for (int validatorIndex : store.getVotedValidatorIndices()) {\n+      VoteTracker vote = store.getVote(validatorIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ4NTY5Nw==", "bodyText": "We should only copy the vote when we retrieve it from the underlying Store.  If we already have it in our modified votes we can just return the value as-is.  So probably don't want to use the either method in this case.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r412485697", "createdAt": "2020-04-21T20:56:49Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/Store.java", "diffHunk": "@@ -294,6 +308,18 @@ public void setBestJustifiedCheckpoint(Checkpoint best_justified_checkpoint) {\n       this.best_justified_checkpoint = Optional.of(best_justified_checkpoint);\n     }\n \n+    @Override\n+    public VoteTracker getVote(int validatorIndex) {\n+      VoteTracker vote = either(validatorIndex, votes::get, Store.this.votes::get);\n+      if (vote == null) {\n+        vote = VoteTracker.Default();\n+      } else {\n+        vote = vote.copy();\n+      }\n+      votes.put(validatorIndex, vote);\n+      return vote;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90a831c6e0ad4372e1dc7eaa59881e0bff68b538", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/90a831c6e0ad4372e1dc7eaa59881e0bff68b538", "committedDate": "2020-04-21T22:46:05Z", "message": "Write & read from disk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzI5NjY0", "url": "https://github.com/ConsenSys/teku/pull/1627#pullrequestreview-397729664", "createdAt": "2020-04-21T22:50:05Z", "commit": {"oid": "90a831c6e0ad4372e1dc7eaa59881e0bff68b538"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo1MDowNlrOGJbuOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo1MzozN1rOGJbz9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0NDU2OA==", "bodyText": "Nice!", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r412544568", "createdAt": "2020-04-21T22:50:06Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/SimpleOffsetSerializer.java", "diffHunk": "@@ -73,47 +74,39 @@\n   public static HashMap<Class, ReflectionInformation> classReflectionInfo = new HashMap<>();\n \n   public static void setConstants() {\n-    classReflectionInfo.put(\n-        SignedBeaconBlock.class, new ReflectionInformation(SignedBeaconBlock.class));\n-    classReflectionInfo.put(BeaconBlock.class, new ReflectionInformation(BeaconBlock.class));\n-    classReflectionInfo.put(\n-        BeaconBlockBody.class, new ReflectionInformation(BeaconBlockBody.class));\n-    classReflectionInfo.put(\n-        BeaconBlockHeader.class, new ReflectionInformation(BeaconBlockHeader.class));\n-    classReflectionInfo.put(\n-        SignedBeaconBlockHeader.class, new ReflectionInformation(SignedBeaconBlockHeader.class));\n-    classReflectionInfo.put(Eth1Data.class, new ReflectionInformation(Eth1Data.class));\n-    classReflectionInfo.put(Attestation.class, new ReflectionInformation(Attestation.class));\n-    classReflectionInfo.put(\n-        AttestationData.class, new ReflectionInformation(AttestationData.class));\n-    classReflectionInfo.put(\n-        AttesterSlashing.class, new ReflectionInformation(AttesterSlashing.class));\n-    classReflectionInfo.put(Deposit.class, new ReflectionInformation(Deposit.class));\n-    classReflectionInfo.put(DepositData.class, new ReflectionInformation(DepositData.class));\n-    classReflectionInfo.put(DepositMessage.class, new ReflectionInformation(DepositMessage.class));\n-    classReflectionInfo.put(\n-        IndexedAttestation.class, new ReflectionInformation(IndexedAttestation.class));\n-    classReflectionInfo.put(\n-        ProposerSlashing.class, new ReflectionInformation(ProposerSlashing.class));\n-    classReflectionInfo.put(\n-        SignedVoluntaryExit.class, new ReflectionInformation(SignedVoluntaryExit.class));\n-    classReflectionInfo.put(VoluntaryExit.class, new ReflectionInformation(VoluntaryExit.class));\n-    classReflectionInfo.put(\n-        BeaconStateImpl.class, new ReflectionInformation(BeaconStateImpl.class));\n-    classReflectionInfo.put(Checkpoint.class, new ReflectionInformation(Checkpoint.class));\n-    classReflectionInfo.put(Fork.class, new ReflectionInformation(Fork.class));\n-    classReflectionInfo.put(\n-        HistoricalBatch.class, new ReflectionInformation(HistoricalBatch.class));\n-    classReflectionInfo.put(\n-        PendingAttestation.class, new ReflectionInformation(PendingAttestation.class));\n-    classReflectionInfo.put(Validator.class, new ReflectionInformation(Validator.class));\n-    classReflectionInfo.put(StatusMessage.class, new ReflectionInformation(StatusMessage.class));\n-    classReflectionInfo.put(GoodbyeMessage.class, new ReflectionInformation(GoodbyeMessage.class));\n-    classReflectionInfo.put(\n-        BeaconBlocksByRangeRequestMessage.class,\n-        new ReflectionInformation(BeaconBlocksByRangeRequestMessage.class));\n-    classReflectionInfo.put(\n-        AggregateAndProof.class, new ReflectionInformation(AggregateAndProof.class));\n+    List<Class> classes =\n+        List.of(\n+            SignedBeaconBlock.class,\n+            BeaconBlock.class,\n+            BeaconBlockBody.class,\n+            BeaconBlockHeader.class,\n+            SignedBeaconBlockHeader.class,\n+            Eth1Data.class,\n+            Attestation.class,\n+            AttestationData.class,\n+            AttesterSlashing.class,\n+            Deposit.class,\n+            DepositData.class,\n+            DepositMessage.class,\n+            IndexedAttestation.class,\n+            ProposerSlashing.class,\n+            SignedVoluntaryExit.class,\n+            VoluntaryExit.class,\n+            BeaconStateImpl.class,\n+            Checkpoint.class,\n+            Fork.class,\n+            HistoricalBatch.class,\n+            PendingAttestation.class,\n+            Validator.class,\n+            StatusMessage.class,\n+            GoodbyeMessage.class,\n+            BeaconBlocksByRangeRequestMessage.class,\n+            AggregateAndProof.class,\n+            VoteTracker.class);\n+\n+    for (Class classItem : classes) {\n+      classReflectionInfo.put(classItem, new ReflectionInformation(classItem));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90a831c6e0ad4372e1dc7eaa59881e0bff68b538"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0NjAzNg==", "bodyText": "Do we actually need to add a single vote or is addVotes all we'll actually use?", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r412546036", "createdAt": "2020-04-21T22:53:37Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/server/rocksdb/dataaccess/V3RocksDbDao.java", "diffHunk": "@@ -324,6 +330,16 @@ public void addHotStates(final Map<Bytes32, BeaconState> states) {\n       states.forEach(this::addHotState);\n     }\n \n+    @Override\n+    public void addVote(final UnsignedLong validatorIndex, final VoteTracker vote) {\n+      transaction.put(V3Schema.VOTES, validatorIndex, vote);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90a831c6e0ad4372e1dc7eaa59881e0bff68b538"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b45040494015b450bd8894ff2ab90f2bbe4fb92e", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/b45040494015b450bd8894ff2ab90f2bbe4fb92e", "committedDate": "2020-04-21T23:03:14Z", "message": "Revert processAttesation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22523ca59d8d6c519747c465ac17f6bd7f06e188", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/22523ca59d8d6c519747c465ac17f6bd7f06e188", "committedDate": "2020-04-22T16:52:03Z", "message": "Merge branch 'master' into saveProtoarrayVotesToDisk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MzkxODI1", "url": "https://github.com/ConsenSys/teku/pull/1627#pullrequestreview-398391825", "createdAt": "2020-04-22T16:58:51Z", "commit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjo1ODo1MVrOGKA8xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzowMzowNVrOGKBItA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE1NDUwMg==", "bodyText": "So get, and then put again? Maybe just only put when it's not in there already? Not sure if really worth it though, small things.", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r413154502", "createdAt": "2020-04-22T16:58:51Z", "author": {"login": "protolambda"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/Store.java", "diffHunk": "@@ -294,6 +308,18 @@ public void setBestJustifiedCheckpoint(Checkpoint best_justified_checkpoint) {\n       this.best_justified_checkpoint = Optional.of(best_justified_checkpoint);\n     }\n \n+    @Override\n+    public VoteTracker getVote(int validatorIndex) {\n+      VoteTracker vote = either(validatorIndex, votes::get, Store.this.votes::get);\n+      if (vote == null) {\n+        vote = VoteTracker.Default();\n+      } else {\n+        vote = vote.copy();\n+      }\n+      votes.put(validatorIndex, vote);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE1NzU1Ng==", "bodyText": "I don't think it actually matters too much, but an entry set would technically be better. Both for performance, as understanding the code (get all votes is easier to get right with consistency etc. than it is to get votes one by one). Small details though, good to see this all come together in teku \ud83d\udc4d", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r413157556", "createdAt": "2020-04-22T17:03:05Z", "author": {"login": "protolambda"}, "path": "protoarray/src/main/java/tech/pegasys/artemis/protoarray/ProtoArrayForkChoiceStrategy.java", "diffHunk": "@@ -271,26 +272,20 @@ public boolean containsBlock(Bytes32 blockRoot) {\n    * </ul>\n    *\n    * @param indices\n-   * @param votes\n+   * @param store\n    * @param oldBalances\n    * @param newBalances\n    * @return\n    */\n   static List<Long> computeDeltas(\n+      MutableStore store,\n       Map<Bytes32, Integer> indices,\n-      ElasticList<VoteTracker> votes,\n       List<UnsignedLong> oldBalances,\n       List<UnsignedLong> newBalances) {\n     List<Long> deltas = new ArrayList<>(Collections.nCopies(indices.size(), 0L));\n \n-    for (int validatorIndex = 0; validatorIndex < votes.size(); validatorIndex++) {\n-      VoteTracker vote = votes.get(validatorIndex);\n-\n-      // There is no need to create a score change if the validator has never voted\n-      // or both their votes are for the zero hash (alias to the genesis block).\n-      if (vote.getCurrentRoot().equals(Bytes32.ZERO) && vote.getNextRoot().equals(Bytes32.ZERO)) {\n-        continue;\n-      }\n+    for (int validatorIndex : store.getVotedValidatorIndices()) {\n+      VoteTracker vote = store.getVote(validatorIndex);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ4NDk3OQ=="}, "originalCommit": {"oid": "35e0ef5fee8c5873bde7344e2011d9777d131224"}, "originalPosition": 163}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bcc3504832074addaccbdffcd82d827b630ced9", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/8bcc3504832074addaccbdffcd82d827b630ced9", "committedDate": "2020-04-22T17:44:54Z", "message": "Remove addVote"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad9973a59665ce27aa0229a4dc4c7319eaa77402", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/ad9973a59665ce27aa0229a4dc4c7319eaa77402", "committedDate": "2020-04-22T18:24:31Z", "message": "Fix tests & resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f561c7f1f88675b32bd4d4429b7832587d0f0a69", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/f561c7f1f88675b32bd4d4429b7832587d0f0a69", "committedDate": "2020-04-22T18:27:31Z", "message": "Merge branch 'master' into saveProtoarrayVotesToDisk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NjIxNzEz", "url": "https://github.com/ConsenSys/teku/pull/1627#pullrequestreview-398621713", "createdAt": "2020-04-22T22:01:59Z", "commit": {"oid": "f561c7f1f88675b32bd4d4429b7832587d0f0a69"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMjowMTo1OVrOGKNsZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMjowMTo1OVrOGKNsZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM2MzMwMg==", "bodyText": "Should we be using toIntExact here?", "url": "https://github.com/ConsenSys/teku/pull/1627#discussion_r413363302", "createdAt": "2020-04-22T22:01:59Z", "author": {"login": "ajsutton"}, "path": "protoarray/src/main/java/tech/pegasys/artemis/protoarray/ProtoArrayForkChoiceStrategy.java", "diffHunk": "@@ -271,39 +261,44 @@ public boolean containsBlock(Bytes32 blockRoot) {\n    * </ul>\n    *\n    * @param indices\n-   * @param votes\n+   * @param store\n    * @param oldBalances\n    * @param newBalances\n    * @return\n    */\n   static List<Long> computeDeltas(\n+      MutableStore store,\n       Map<Bytes32, Integer> indices,\n-      ElasticList<VoteTracker> votes,\n       List<UnsignedLong> oldBalances,\n       List<UnsignedLong> newBalances) {\n     List<Long> deltas = new ArrayList<>(Collections.nCopies(indices.size(), 0L));\n \n-    for (int validatorIndex = 0; validatorIndex < votes.size(); validatorIndex++) {\n-      VoteTracker vote = votes.get(validatorIndex);\n+    for (UnsignedLong validatorIndex : store.getVotedValidatorIndices()) {\n+      VoteTracker vote = store.getVote(validatorIndex);\n \n       // There is no need to create a score change if the validator has never voted\n       // or both their votes are for the zero hash (alias to the genesis block).\n       if (vote.getCurrentRoot().equals(Bytes32.ZERO) && vote.getNextRoot().equals(Bytes32.ZERO)) {\n+        LOG.warn(\"ProtoArrayForkChoiceStrategy: Unexpected zero hashes in voted validator votes\");\n         continue;\n       }\n \n       // If the validator was not included in the oldBalances (i.e. it did not exist yet)\n       // then say its balance was zero.\n       UnsignedLong oldBalance =\n-          oldBalances.size() > validatorIndex ? oldBalances.get(validatorIndex) : UnsignedLong.ZERO;\n+          oldBalances.size() > validatorIndex.intValue()\n+              ? oldBalances.get(validatorIndex.intValue())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f561c7f1f88675b32bd4d4429b7832587d0f0a69"}, "originalPosition": 168}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7affba13b56b00f258987d78b2daaa5133b18388", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/7affba13b56b00f258987d78b2daaa5133b18388", "committedDate": "2020-04-22T22:39:01Z", "message": "Safely convert UnsignedLong to int"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a86666a0707e47e5cc68e59ce758dd60fd7a3be1", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/a86666a0707e47e5cc68e59ce758dd60fd7a3be1", "committedDate": "2020-04-22T22:41:00Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into saveProtoarrayVotesToDisk\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/SimpleOffsetSerializer.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25ce23e226ee7d593742dce704072a65a31224df", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/25ce23e226ee7d593742dce704072a65a31224df", "committedDate": "2020-04-22T22:42:40Z", "message": "Merge branch 'master' into saveProtoarrayVotesToDisk"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4327, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}