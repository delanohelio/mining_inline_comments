{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0ODg5NDg2", "number": 1734, "title": "[BC-415] Rework CombinedChainDataClient.getStateAtSlot()", "bodyText": "PR Description\nRework CombinedChainDataClient.getStateAtSlot().\nTo avoid race conditions, don't query based on head block root.  First try to query from recent data, and then query from historical state to control for case where blocks are being rapidly imported, and the slot being queried is finalized during processing.\nAlso, added some test utilities to make it easier to write integration tests:\n\nAdded MockRocksDbInstance, which allows us to create an in-memory version of RocksDbDatabase\nAdded InMemoryStorageSystem which sets up and wires together an in-memory database with a RecentChainData instance, and makes the RecentChainData instance as well as a CombinedChainData instance available.\nAdded a ChainUpdater that generates chain data with ChainGenerator and immediately adds the data to a RecentChainData instance.\n\nFixes #1713", "createdAt": "2020-05-07T19:57:11Z", "url": "https://github.com/ConsenSys/teku/pull/1734", "merged": true, "mergeCommit": {"oid": "e02dcfc1f54b09a6a482090521ef4ba2afb7f0ec"}, "closed": true, "closedAt": "2020-05-12T15:44:45Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfC5XOAFqTQwNzc5MzI4OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgmAxvAH2gAyNDE0ODg5NDg2OjlmYTE5MzQwNTE0MTYzNGY4YjhkNDg2Y2NjY2VkNThlNWIwZmExMTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NzkzMjg5", "url": "https://github.com/ConsenSys/teku/pull/1734#pullrequestreview-407793289", "createdAt": "2020-05-07T20:00:12Z", "commit": {"oid": "518e985375492373d2a2073b1d0dc12cca1d151f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMDowMDoxMlrOGSOJvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QyMDowMDoxMlrOGSOJvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1OTQyMA==", "bodyText": "I don't see why we need a special case for the first epoch / genesis block, so I cut this.  But if there's a valid reason, I can add this back in.", "url": "https://github.com/ConsenSys/teku/pull/1734#discussion_r421759420", "createdAt": "2020-05-07T20:00:12Z", "author": {"login": "mbaxter"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java", "diffHunk": "@@ -149,11 +147,6 @@ public CombinedChainDataClient(\n     return getBlockByBlockRoot(get_block_root_at_slot(state, slot));\n   }\n \n-  private boolean isHistoricalData(final UnsignedLong slot) {\n-    final boolean finalizedPastFirstEpoch = !recentChainData.getFinalizedEpoch().equals(ZERO);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "518e985375492373d2a2073b1d0dc12cca1d151f"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36c4a0dbf342275d25bff8bb624dbbf6582125d9", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/36c4a0dbf342275d25bff8bb624dbbf6582125d9", "committedDate": "2020-05-11T21:23:36Z", "message": "Rework CombinedChainDataClient.getStateAtSlot()\n\nDon't query based on head block root.  First try to query from recent\ndata, and then query from historical state to control for case where\nblocks are being rapidly imported, and the slot being queried is\nfinalized during processing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d231373a6a0495e480b0c2d37f3d9f397542ac4a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d231373a6a0495e480b0c2d37f3d9f397542ac4a", "committedDate": "2020-05-11T21:23:36Z", "message": "Revert store check change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa41141fe55cbd368555dd0c20ca794531fd8a8a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/aa41141fe55cbd368555dd0c20ca794531fd8a8a", "committedDate": "2020-05-11T21:23:36Z", "message": "Rework historical data check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54230c305655690043978c82399255c3377b18c3", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/54230c305655690043978c82399255c3377b18c3", "committedDate": "2020-05-11T21:23:36Z", "message": "Break up ChainBuilder logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc5d5abfaa504602850edf7cf55c54c044804a4b", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/bc5d5abfaa504602850edf7cf55c54c044804a4b", "committedDate": "2020-05-11T21:23:36Z", "message": "Create in-memory RocksDbDatabase system"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7103bf6cbf6d363c2820c4b9dc6e0542a48c7aad", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/7103bf6cbf6d363c2820c4b9dc6e0542a48c7aad", "committedDate": "2020-05-11T21:23:36Z", "message": "Fix datastructures ssz dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2b4f7801a69bdf4cd525433b81a6451e48fbae9", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d2b4f7801a69bdf4cd525433b81a6451e48fbae9", "committedDate": "2020-05-11T21:23:36Z", "message": "Add InMemoryStorageSySystem utility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90ec46afef55aeafe14c1ea6587f7701fd1a5e78", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/90ec46afef55aeafe14c1ea6587f7701fd1a5e78", "committedDate": "2020-05-11T21:23:36Z", "message": "Add CombinedChainData integration tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1845f98aede49cde12667caba2758006e0f8a093", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/1845f98aede49cde12667caba2758006e0f8a093", "committedDate": "2020-05-08T16:17:25Z", "message": "Rework historical data check"}, "afterCommit": {"oid": "90ec46afef55aeafe14c1ea6587f7701fd1a5e78", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/90ec46afef55aeafe14c1ea6587f7701fd1a5e78", "committedDate": "2020-05-11T21:23:36Z", "message": "Add CombinedChainData integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c490c5684361d864811f46aa38556dcc4d72fb72", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c490c5684361d864811f46aa38556dcc4d72fb72", "committedDate": "2020-05-11T21:28:41Z", "message": "Revert \"Break up ChainBuilder logic\"\n\nThis reverts commit 54230c305655690043978c82399255c3377b18c3."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c71a002b40d0ec0fba634ece24f2c7dc2adf4cc", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/3c71a002b40d0ec0fba634ece24f2c7dc2adf4cc", "committedDate": "2020-05-11T22:03:03Z", "message": "Fix spotless errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3ab1f4f47ad4d4c8814fb98f41e0d66a07ebf05", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c3ab1f4f47ad4d4c8814fb98f41e0d66a07ebf05", "committedDate": "2020-05-11T22:04:19Z", "message": "Remove unit tests duplicated by integration tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTY1OTYz", "url": "https://github.com/ConsenSys/teku/pull/1734#pullrequestreview-409565963", "createdAt": "2020-05-11T22:08:15Z", "commit": {"oid": "c3ab1f4f47ad4d4c8814fb98f41e0d66a07ebf05"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjowOToxN1rOGTvJNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjowOToxN1rOGTvJNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0ODUzMg==", "bodyText": "Created this RocksDbAccessor interface so that we could have a mock in-memory replacement for the core RocksDB access logic.  Not super happy with the current implementation, but leaving a larger refactor for the future since we have active development in this area.", "url": "https://github.com/ConsenSys/teku/pull/1734#discussion_r423348532", "createdAt": "2020-05-11T22:09:17Z", "author": {"login": "mbaxter"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java", "diffHunk": "@@ -53,7 +53,11 @@\n \n   public static Database createV3(\n       final RocksDbConfiguration configuration, final StateStorageMode stateStorageMode) {\n-    final RocksDbInstance db = RocksDbInstanceFactory.create(configuration, V3Schema.class);\n+    final RocksDbAccessor db = RocksDbInstanceFactory.create(configuration, V3Schema.class);\n+    return createV3(db, stateStorageMode);\n+  }\n+\n+  static Database createV3(final RocksDbAccessor db, final StateStorageMode stateStorageMode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3ab1f4f47ad4d4c8814fb98f41e0d66a07ebf05"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca5968a7e94eb866c2528baa5e5c98d3fdd404c1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/ca5968a7e94eb866c2528baa5e5c98d3fdd404c1", "committedDate": "2020-05-11T23:10:56Z", "message": "Add more tests, fix bug\n\nConsistently return the latest state in effect when querying from\nrecent or historical chain data"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzY1NjQx", "url": "https://github.com/ConsenSys/teku/pull/1734#pullrequestreview-409765641", "createdAt": "2020-05-12T07:24:02Z", "commit": {"oid": "ca5968a7e94eb866c2528baa5e5c98d3fdd404c1"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzoyNDowMlrOGT5aJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzoyODoxMVrOGT5jAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUxNjcwOQ==", "bodyText": "Aren't we at risk of race conditions here?  ie we check if the slot is recent and it is, but then before we actually get the block the store is changed and the slot we're interested in is dropped.  Seems like we should try to get it from the Store and if it's not there, then fall back to getting it from disk.  That would be a reasonable way to handle the case where we need to request a block that's more than SLOTS_PER_HISTORICAL_ROOT behind the current state as well - we'd fail to get it from the store and fallback to getting it from disk.", "url": "https://github.com/ConsenSys/teku/pull/1734#discussion_r423516709", "createdAt": "2020-05-12T07:24:02Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java", "diffHunk": "@@ -107,7 +106,7 @@ public CombinedChainDataClient(\n       LOG.trace(\"Block root at slot {} is the specified head block root\", slot);\n       return getBlockByBlockRoot(headBlockRoot);\n     }\n-    if (isHistoricalData(slot)) {\n+    if (!isRecentData(slot)) {\n       LOG.trace(\"Block at slot {} is in a finalized epoch. Retrieving from historical data\", slot);\n       return historicalChainData.getLatestFinalizedBlockAtSlot(slot);\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca5968a7e94eb866c2528baa5e5c98d3fdd404c1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUxODk3Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .filter(f -> (f.getModifiers() & Modifier.STATIC) > 0)\n          \n          \n            \n                    .filter(f -> Modifiers.isState(f.getModifiers()))\n          \n      \n    \n    \n  \n\nand could apply the same change above in streamColumns because apparently you should use the java.lang.reflect.Modifiers class to decode modifiers...", "url": "https://github.com/ConsenSys/teku/pull/1734#discussion_r423518976", "createdAt": "2020-05-12T07:28:11Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/schema/Schema.java", "diffHunk": "@@ -35,4 +35,18 @@\n               }\n             });\n   }\n+\n+  static Stream<RocksDbVariable<?>> streamVariables(Class<? extends Schema> schema) {\n+    return Arrays.stream(schema.getDeclaredFields())\n+        .filter(f -> (f.getModifiers() & Modifier.STATIC) > 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca5968a7e94eb866c2528baa5e5c98d3fdd404c1"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f22040423dcfed44ce7bfc24a4048dad8278f7b9", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f22040423dcfed44ce7bfc24a4048dad8278f7b9", "committedDate": "2020-05-12T15:17:52Z", "message": "Merge branch 'master' into bc-415/rework-get-state-at-slot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fa193405141634f8b8d486cccced58e5b0fa117", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/9fa193405141634f8b8d486cccced58e5b0fa117", "committedDate": "2020-05-12T15:28:54Z", "message": "Fix static field check"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4175, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}