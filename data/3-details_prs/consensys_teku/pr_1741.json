{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MTM3OTkw", "number": 1741, "title": "Prune attestations from the aggregating pool", "bodyText": "PR Description\nPrune old attestations from the AggregatingAttestationPool to resolve a memory leak.\nFire slot events even while syncing so pruning actions are applied (applies to a number of pending pools and other systems).  The only major work that happens on onSlot is the validator client loading duties, but during sync the request for duties is immediately rejected.", "createdAt": "2020-05-08T09:20:45Z", "url": "https://github.com/ConsenSys/teku/pull/1741", "merged": true, "mergeCommit": {"oid": "3949f7e248a257e234fe6aebfb4e2b3d2d59b9c7"}, "closed": true, "closedAt": "2020-05-09T00:28:37Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfOUePAH2gAyNDE1MTM3OTkwOjA5ODZiMzgwNmVhMDEwYzUxOWMzMWQwMDg0NjQ3ODVhZTQ2MTk2ODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfa9_zgH2gAyNDE1MTM3OTkwOjc5NzdjN2ZiYTUwYjJkNTNiY2EyOTNjOGQyZGY2MTBmMDllODI4NTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0986b3806ea010c519c31d008464785ae4619685", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0986b3806ea010c519c31d008464785ae4619685", "committedDate": "2020-05-08T09:18:46Z", "message": "Prune attestations from the aggregating pool.\nFire slot events even while syncing so pruning actions are applied."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MjczMTY0", "url": "https://github.com/ConsenSys/teku/pull/1741#pullrequestreview-408273164", "createdAt": "2020-05-08T14:20:14Z", "commit": {"oid": "0986b3806ea010c519c31d008464785ae4619685"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNDoyMDoxNFrOGSnQZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNDoyMDoxNFrOGSnQZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE3MDcyNA==", "bodyText": "nit: I was almost writing:\n\nIt would be nice to explicitly set the slot of the pruneAttestationData here. Otherwise, what if randomly it has a higher slot than the preserveAttestationData? AggregatingPool would clean both of them.\n\nThen noticed the randomAttestationDataToIncludeInBlock method actually sets the slot to SLOT - 1. It's a bit hard to see especially when looking at git diffs.", "url": "https://github.com/ConsenSys/teku/pull/1741#discussion_r422170724", "createdAt": "2020-05-08T14:20:14Z", "author": {"login": "cemozerr"}, "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPoolTest.java", "diffHunk": "@@ -121,12 +123,33 @@ public void getAttestationsForBlock_shouldNotAddMoreAttestationsThanAllowedInBlo\n     final Attestation attestation1 = addAttestationFromValidators(attestationData, 1, 2, 3, 4);\n     final Attestation attestation2 = addAttestationFromValidators(attestationData, 2, 5);\n     // Won't be included because of the 2 attestation limit.\n-    addAttestationFromValidators(attestationData, 2, 6);\n+    addAttestationFromValidators(attestationData, 2);\n \n     assertThat(aggregatingPool.getAttestationsForBlock(SLOT))\n         .containsExactly(attestation1, attestation2);\n   }\n \n+  @Test\n+  public void onSlot_shouldPruneAttestationsMoreThanTwoEpochsBehindCurrentSlot() {\n+    final AttestationData pruneAttestationData = randomAttestationDataToIncludeInBlock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0986b3806ea010c519c31d008464785ae4619685"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MjczMzA1", "url": "https://github.com/ConsenSys/teku/pull/1741#pullrequestreview-408273305", "createdAt": "2020-05-08T14:20:25Z", "commit": {"oid": "0986b3806ea010c519c31d008464785ae4619685"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47809ed4d20b0452ffe5ebd78fa04006c70b3ea0", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/47809ed4d20b0452ffe5ebd78fa04006c70b3ea0", "committedDate": "2020-05-09T00:00:14Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into prune-attestation-aggregate-pool"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc15be3ad448a15de776fe0e2e3a2f0b84841aa1", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/dc15be3ad448a15de776fe0e2e3a2f0b84841aa1", "committedDate": "2020-05-09T00:02:18Z", "message": "Clarify and simplify the slot used for the attestation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7977c7fba50b2d53bca293c8d2df610f09e82857", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7977c7fba50b2d53bca293c8d2df610f09e82857", "committedDate": "2020-05-09T00:02:59Z", "message": "Fix."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4185, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}