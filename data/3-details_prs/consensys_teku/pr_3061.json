{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4Njc5NDcz", "number": 3061, "title": "add status query parameter to `/eth/v1/beacon/states/:state_id/validators`", "bodyText": "make id not being passed in the query string be interpreted as 'all validators', rather than result in an empty list.\n\nSigned-off-by: Paul Harris paul.harris@consensys.net\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-23T03:53:11Z", "url": "https://github.com/ConsenSys/teku/pull/3061", "merged": true, "mergeCommit": {"oid": "f56f853509670ca81fb8e749c06777bf89d361a8"}, "closed": true, "closedAt": "2020-10-28T05:51:27Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVOVxnAH2gAyNTA4Njc5NDczOjU3NDMyYTE0MTU1NzhjNDFmYjA1NGZiMzM3NWU5NGFmZmUzNzQ3YWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW24JNAH2gAyNTA4Njc5NDczOjhlZTdhMzRkYTVlOWNlZTg1YjJiYzA0NDQ3NGFkOTRkZGEyYThjOTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "57432a1415578c41fb054fb3375e94affe3747af", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/57432a1415578c41fb054fb3375e94affe3747af", "committedDate": "2020-10-23T03:52:06Z", "message": "add status query parameter to `/eth/v1/beacon/states/:state_id/validators`\n\n - make id not being passed in the query string be interpreted as 'all validators', rather than result in an empty list.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjYxOTgy", "url": "https://github.com/ConsenSys/teku/pull/3061#pullrequestreview-515261982", "createdAt": "2020-10-23T04:06:52Z", "commit": {"oid": "57432a1415578c41fb054fb3375e94affe3747af"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNDowNjo1MlrOHm7ciQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNTowNzo0MFrOHm8RIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4MTg5Nw==", "bodyText": "I feel like something called statusFilter should actually be a Predicate<ValidatorStatus> or maybe just Predicate<Validator> rather than a list.  That would also smoothly handle the case where the param is specified but with no options which currently counts as not being specified but probably should exclude everything.\nIn any case we want to use a HashSet instead of List so that we can check if the status is present in O(1) instead of O(n) - when iterating every validator the difference will add up even for small lists.", "url": "https://github.com/ConsenSys/teku/pull/3061#discussion_r510581897", "createdAt": "2020-10-23T04:06:52Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -565,15 +562,40 @@ public void requireStoreAvailable() {\n \n   private List<ValidatorResponse> getValidators(\n       final List<Integer> validatorIndices,\n+      final List<ValidatorStatus> statusFilter,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57432a1415578c41fb054fb3375e94affe3747af"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4NDY2Mg==", "bodyText": "Validator indices could be empty because none of the supplied validator public keys were known. In that case we should return empty list not all validators.", "url": "https://github.com/ConsenSys/teku/pull/3061#discussion_r510584662", "createdAt": "2020-10-23T04:20:13Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -565,15 +562,40 @@ public void requireStoreAvailable() {\n \n   private List<ValidatorResponse> getValidators(\n       final List<Integer> validatorIndices,\n+      final List<ValidatorStatus> statusFilter,\n       final tech.pegasys.teku.datastructures.state.BeaconState state) {\n-    return validatorIndices.stream()\n-        .map(index -> ValidatorResponse.fromState(state, index))\n-        .collect(toList());\n+    final List<ValidatorResponse> result;\n+\n+    if (validatorIndices.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57432a1415578c41fb054fb3375e94affe3747af"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU5MTg5OQ==", "bodyText": "Also I can't add a comment on it because it's not a change but getValidatorsBalancesByStateRoot is returning empty when there are no validator indices.", "url": "https://github.com/ConsenSys/teku/pull/3061#discussion_r510591899", "createdAt": "2020-10-23T04:52:26Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -565,15 +562,40 @@ public void requireStoreAvailable() {\n \n   private List<ValidatorResponse> getValidators(\n       final List<Integer> validatorIndices,\n+      final List<ValidatorStatus> statusFilter,\n       final tech.pegasys.teku.datastructures.state.BeaconState state) {\n-    return validatorIndices.stream()\n-        .map(index -> ValidatorResponse.fromState(state, index))\n-        .collect(toList());\n+    final List<ValidatorResponse> result;\n+\n+    if (validatorIndices.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4NDY2Mg=="}, "originalCommit": {"oid": "57432a1415578c41fb054fb3375e94affe3747af"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU5NTM2Mw==", "bodyText": "There's  a weird mix of iteration and streaming here that's winding up converting to list multiple times.  It seems like this would be a lot cleaner if we passed in functions to select and filter the validators instead of lists.  I've done a rough spike of this (commenting out a bunch of tests to avoid flowing the changes round everywhere): efd37ca\nThe key thing is it introduces a ValidatorSelector interface which is essentially a function that takes a BeaconState and returns an IntStream of validator indices to use from that state.  So when no validator IDs are provided, the validator selector is state -> IntStream.range(0, state.getValidators.size()) - ie all validators.  Otherwise it just maps the list of validator selectors to an index.  An IntStream is returned rather than List<Integer> so each entry is processed in turn without having to load them all in memory (100k Integer instances isn't particularly friendly to the GC).", "url": "https://github.com/ConsenSys/teku/pull/3061#discussion_r510595363", "createdAt": "2020-10-23T05:07:40Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -565,15 +562,40 @@ public void requireStoreAvailable() {\n \n   private List<ValidatorResponse> getValidators(\n       final List<Integer> validatorIndices,\n+      final List<ValidatorStatus> statusFilter,\n       final tech.pegasys.teku.datastructures.state.BeaconState state) {\n-    return validatorIndices.stream()\n-        .map(index -> ValidatorResponse.fromState(state, index))\n-        .collect(toList());\n+    final List<ValidatorResponse> result;\n+\n+    if (validatorIndices.isEmpty()) {\n+      final int validatorCount = state.getValidators().size();\n+      result = new ArrayList<>();\n+      for (int i = 0; i < validatorCount; i++) {\n+        result.add(ValidatorResponse.fromState(state, i));\n+      }\n+    } else {\n+      result =\n+          validatorIndices.stream()\n+              .map(index -> ValidatorResponse.fromState(state, index))\n+              .collect(toList());\n+    }\n+\n+    if (statusFilter.isEmpty()) {\n+      return result;\n+    }\n+    return result.stream().filter(v -> statusFilter.contains(v.status)).collect(toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57432a1415578c41fb054fb3375e94affe3747af"}, "originalPosition": 125}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6925983555a0e40c9f62d2bae3a1592a7cbfa83", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/a6925983555a0e40c9f62d2bae3a1592a7cbfa83", "committedDate": "2020-10-26T23:58:22Z", "message": "Merge remote-tracking branch 'upstream/master' into validators-optional-indexes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3f0ec3675feaf569492ff00fa9ddcb2223465bf", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/b3f0ec3675feaf569492ff00fa9ddcb2223465bf", "committedDate": "2020-10-27T00:09:54Z", "message": "Merge remote-tracking branch 'upstream/master' into validators-optional-indexes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c4acebb5fb07ccd04bfbd3d22d4225d10a49833", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/1c4acebb5fb07ccd04bfbd3d22d4225d10a49833", "committedDate": "2020-10-27T00:23:01Z", "message": "Merge remote-tracking branch 'upstream/master' into validators-optional-indexes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c68805b7374443bfce62c43c89c1fdc781797e8", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/8c68805b7374443bfce62c43c89c1fdc781797e8", "committedDate": "2020-10-27T23:33:59Z", "message": "started refactoring to use a StateSelector, still have some tests to write around the ChainDataProvider changes.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1241d62d7857a41298f50e679d5a148d13c5505", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/d1241d62d7857a41298f50e679d5a148d13c5505", "committedDate": "2020-10-28T01:56:20Z", "message": "more refactoring, tests added to show filters are behaving correctly\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da59bc71368a64fe9869760e048db38df0bffb29", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/da59bc71368a64fe9869760e048db38df0bffb29", "committedDate": "2020-10-28T02:00:12Z", "message": "Merge remote-tracking branch 'upstream/master' into validators-optional-indexes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25d9a7e58218218648c9e564d60dae0cffb9b67d", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/25d9a7e58218218648c9e564d60dae0cffb9b67d", "committedDate": "2020-10-28T04:33:56Z", "message": "Merge remote-tracking branch 'upstream/master' into validators-optional-indexes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MjM0MDky", "url": "https://github.com/ConsenSys/teku/pull/3061#pullrequestreview-518234092", "createdAt": "2020-10-27T23:57:23Z", "commit": {"oid": "8c68805b7374443bfce62c43c89c1fdc781797e8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMzo1OTowMFrOHpVM0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNDo0NToxNlrOHpZ46g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMTAxMA==", "bodyText": "Is not found really the right result? It's not listed as one of the possible response codes in the OpenAPI doc.  I'd have thought an empty list would be more appropriate but bit unsure if the state can't be found...", "url": "https://github.com/ConsenSys/teku/pull/3061#discussion_r513101010", "createdAt": "2020-10-27T23:59:00Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/v1/beacon/GetStateValidators.java", "diffHunk": "@@ -85,16 +102,21 @@ public GetStateValidators(final DataProvider dataProvider, final JsonProvider js\n       })\n   @Override\n   public void handle(@NotNull final Context ctx) throws Exception {\n-    final List<Integer> validatorIndices =\n-        stateValidatorsUtil.parseValidatorsParam(chainDataProvider, ctx);\n+    final Map<String, List<String>> queryParamMap = ctx.queryParamMap();\n+    final Map<String, String> pathParamMap = ctx.pathParamMap();\n+\n+    final List<String> validators =\n+        queryParamMap.containsKey(PARAM_ID)\n+            ? ListQueryParameterUtils.getParameterAsStringList(ctx.queryParamMap(), PARAM_ID)\n+            : Collections.emptyList();\n+\n+    final List<ValidatorStatus> statusFilter = stateValidatorsUtil.parseStatusFilter(queryParamMap);\n \n-    final Function<Bytes32, SafeFuture<Optional<List<ValidatorResponse>>>> rootHandler =\n-        (root) -> chainDataProvider.getValidatorsDetailsByStateRoot(root, validatorIndices);\n-    final Function<UInt64, SafeFuture<Optional<List<ValidatorResponse>>>> slotHandler =\n-        (slot) -> chainDataProvider.getValidatorsDetailsBySlot(slot, validatorIndices);\n+    SafeFuture<Optional<List<ValidatorResponse>>> future =\n+        chainDataProvider.getStateValidators(\n+            pathParamMap.getOrDefault(PARAM_STATE_ID, \"head\"), validators, statusFilter);\n \n-    processStateEndpointRequest(\n-        chainDataProvider, ctx, rootHandler, slotHandler, this::handleResult);\n+    handleOptionalResult(ctx, future, this::handleResult, SC_NOT_FOUND);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c68805b7374443bfce62c43c89c1fdc781797e8"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE3NzM3NQ==", "bodyText": "Are there any cases where we need to get multiple states?  Following the pattern isn't bad but I suspect its very unlikely that we'd ever need a List here and could just have the Optional version as the only method for states (whereas blocks we do wind up selecting multiple sometimes).", "url": "https://github.com/ConsenSys/teku/pull/3061#discussion_r513177375", "createdAt": "2020-10-28T04:43:46Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/stateselector/StateSelector.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.api.stateselector;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+\n+public interface StateSelector {\n+  SafeFuture<List<BeaconState>> getState();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d9a7e58218218648c9e564d60dae0cffb9b67d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE3NzgzNA==", "bodyText": "nit: I think this should just be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return Optional.ofNullable(getStore().getLatestFinalizedBlockAndState().getState());\n          \n          \n            \n                return Optional.of(getStore().getLatestFinalizedBlockAndState().getState());\n          \n      \n    \n    \n  \n\nbecause if we have a store it should have a finalized state.", "url": "https://github.com/ConsenSys/teku/pull/3061#discussion_r513177834", "createdAt": "2020-10-28T04:45:16Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java", "diffHunk": "@@ -421,6 +421,21 @@ private boolean isRecentData(final UInt64 slot) {\n     return Optional.ofNullable(getStore().getLatestFinalizedBlockAndState().getBlock());\n   }\n \n+  public Optional<BeaconState> getFinalizedState() {\n+    if (recentChainData.isPreGenesis()) {\n+      return Optional.empty();\n+    }\n+\n+    return Optional.ofNullable(getStore().getLatestFinalizedBlockAndState().getState());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25d9a7e58218218648c9e564d60dae0cffb9b67d"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "342e1ce8b03c6c57176d83098bc3bbc46f66dc22", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/342e1ce8b03c6c57176d83098bc3bbc46f66dc22", "committedDate": "2020-10-28T05:16:27Z", "message": "cleanup\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MzMwNTIy", "url": "https://github.com/ConsenSys/teku/pull/3061#pullrequestreview-518330522", "createdAt": "2020-10-28T05:18:05Z", "commit": {"oid": "342e1ce8b03c6c57176d83098bc3bbc46f66dc22"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26e019c97f7125fde2e9ed11e2c553694bd019a9", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/26e019c97f7125fde2e9ed11e2c553694bd019a9", "committedDate": "2020-10-28T05:34:22Z", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ee7a34da5e9cee85b2bc044474ad94dda2a8c95", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/8ee7a34da5e9cee85b2bc044474ad94dda2a8c95", "committedDate": "2020-10-28T05:39:46Z", "message": "revert some changes from an earlier commit.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3255, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}