{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMTc0MDYx", "number": 2225, "title": "Limit RocksDB write buffer", "bodyText": "PR Description\nRocksDB memTable (aka write buffer) size grows with time. I observed ~500M size after a couple of hours running\nhttps://github.com/facebook/rocksdb/wiki/MemTable\nLimit this size with the same value as blockCache size for now. If required later we may add a separate option\nWas observing memTable size with this tweak: Nashatyrev@81d6149#diff-c9a5225b916a8eb579008f07e0d1784dR65-L142\nDidn't found any drastic write performance degradation. Though not 100% sure about this\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-06-25T17:59:15Z", "url": "https://github.com/ConsenSys/teku/pull/2225", "merged": true, "mergeCommit": {"oid": "3b13adee12cedee462a11736e07f31089d6412dd"}, "closed": true, "closedAt": "2020-06-26T22:10:41Z", "author": {"login": "Nashatyrev"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuybU7AH2gAyNDQwMTc0MDYxOmYwNmM1NGIwZjVlY2VlODU3N2NkYjI1ODYyYWVhYzU0MmJlOTQ5NzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvKm26gH2gAyNDQwMTc0MDYxOjg4YTkzZTJkM2UyM2QxOGJhMDFlMDNhNDc0YmUyMjIwZWUwZDgzMjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f06c54b0f5ecee8577cdb25862aeac542be94974", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/f06c54b0f5ecee8577cdb25862aeac542be94974", "committedDate": "2020-06-25T17:51:42Z", "message": "Limit RocksDB write buffer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7212db90d12242461edb2ee9b5b10e2c8eed0fe5", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/7212db90d12242461edb2ee9b5b10e2c8eed0fe5", "committedDate": "2020-06-25T17:53:54Z", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-mem-limit-rocksdb-write\n\n# Conflicts:\n#\tstorage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/core/RocksDbInstanceFactory.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTM4NDI1", "url": "https://github.com/ConsenSys/teku/pull/2225#pullrequestreview-437938425", "createdAt": "2020-06-26T00:10:53Z", "commit": {"oid": "7212db90d12242461edb2ee9b5b10e2c8eed0fe5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDoxMDo1M1rOGpPzRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwMDoxMDo1M1rOGpPzRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMzY4Nw==", "bodyText": "I did some playing just to see what happens if we make it higher. I think around 256MB has a good mix of the disk being used, might be a better starting point than 8MB...\nI tried with 128MB and there were constant disk flushes happening, 256MB means the WAL buffers fit inside the db write buffer size, and its happier by the looks.\nI could definitely see this being a configurable option for tweaking, i think sync will be when you'd potentially want more buffers so the sync can progress faster...\ngive .setDbWriteBufferSize(268435456L) a go...", "url": "https://github.com/ConsenSys/teku/pull/2225#discussion_r445903687", "createdAt": "2020-06-26T00:10:53Z", "author": {"login": "rolfyone"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/core/RocksDbInstanceFactory.java", "diffHunk": "@@ -112,6 +112,7 @@ private static DBOptions createDBOptions(final RocksDbConfiguration configuratio\n         .setBytesPerSync(1048576L)\n         .setWalBytesPerSync(1048576L)\n         .setMaxBackgroundFlushes(2)\n+        .setDbWriteBufferSize(configuration.getCacheCapacity())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7212db90d12242461edb2ee9b5b10e2c8eed0fe5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7224ecc6c397e2a100ac03e1340bf15b79a6bea", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d7224ecc6c397e2a100ac03e1340bf15b79a6bea", "committedDate": "2020-06-26T09:03:18Z", "message": "Separate writeBufferCapacity DB option. Set it to 256M by default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "753b76556d04203a67dbda424b023460fde01271", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/753b76556d04203a67dbda424b023460fde01271", "committedDate": "2020-06-26T09:03:28Z", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-mem-limit-rocksdb-write"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjExMDM4", "url": "https://github.com/ConsenSys/teku/pull/2225#pullrequestreview-438611038", "createdAt": "2020-06-26T21:40:17Z", "commit": {"oid": "753b76556d04203a67dbda424b023460fde01271"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "807e8b0404ecc7f87c281926a8e020fd7dac5471", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/807e8b0404ecc7f87c281926a8e020fd7dac5471", "committedDate": "2020-06-26T21:40:51Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into optimize-mem-limit-rocksdb-write"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88a93e2d3e23d18ba01e03a474be2220ee0d8324", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/88a93e2d3e23d18ba01e03a474be2220ee0d8324", "committedDate": "2020-06-26T22:02:01Z", "message": "Merge branch 'master' into optimize-mem-limit-rocksdb-write"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3739, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}