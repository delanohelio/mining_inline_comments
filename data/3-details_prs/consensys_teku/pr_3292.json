{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MTIzMTc3", "number": 3292, "title": "Ensure the epoch is known prior to attempting to perform duties.", "bodyText": "If the current epoch is not known, then it is possible to sign something that is invalid, for example too far in the future.\nfixes #3154\nSigned-off-by: Paul Harris paul.harris@consensys.net\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-24T02:07:02Z", "url": "https://github.com/ConsenSys/teku/pull/3292", "merged": true, "mergeCommit": {"oid": "42b679253375ecb924101c7a60f3e347f21b4b6d"}, "closed": true, "closedAt": "2020-11-24T04:00:17Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfNlkGgH2gAyNTI2MTIzMTc3OjM0YmM5MzBmZDJhYzAxYjk3ZDhlNmY4NDFhMDFiMWNkNWQ0MzBlZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfhOGEgH2gAyNTI2MTIzMTc3OmEwYTgzMTY1OTNiMDU4ZWQ5YjI2NjIwZGE1NmJjMDJkZWY3NTk0MDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "34bc930fd2ac01b97d8e6f841a01b1cd5d430ee2", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/34bc930fd2ac01b97d8e6f841a01b1cd5d430ee2", "committedDate": "2020-11-23T04:38:41Z", "message": "verify the unsigned data returned for signing is for the expected slot\n\npartially addresses #3154\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e89a6d1ff3540d2022f29f8df0edcb47cb8a67f0", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/e89a6d1ff3540d2022f29f8df0edcb47cb8a67f0", "committedDate": "2020-11-23T04:39:44Z", "message": "Merge remote-tracking branch 'upstream/master' into 3154"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f3727b2a7057a9d5da70a423f315e49eafbf079", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/4f3727b2a7057a9d5da70a423f315e49eafbf079", "committedDate": "2020-11-23T05:16:31Z", "message": "review comments\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c257c6f219de7018583f4150f3d63e8997a73dd4", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/c257c6f219de7018583f4150f3d63e8997a73dd4", "committedDate": "2020-11-23T05:20:13Z", "message": "Merge remote-tracking branch 'upstream/master' into 3154"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "224e113caae2752cd925b3d906ee30a43077dd65", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/224e113caae2752cd925b3d906ee30a43077dd65", "committedDate": "2020-11-23T21:20:35Z", "message": "Merge remote-tracking branch 'upstream/master' into 3154"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb1a14d06129f1e680ceb858d464efd6a27be272", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/fb1a14d06129f1e680ceb858d464efd6a27be272", "committedDate": "2020-11-24T02:05:19Z", "message": "Ensure the epoch is known prior to attempting to perform duties.\n\nIf the current epoch is not known, then it is possible to sign something that is invalid, for example too far in the future.\n\nfixes #3154\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34e9d512fca8750655c5df04d96259a3c5cf69f7", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/34e9d512fca8750655c5df04d96259a3c5cf69f7", "committedDate": "2020-11-24T02:30:03Z", "message": "Merge remote-tracking branch 'upstream/master' into 3154"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0d89d9ae522423bd60161aa0c37ae353b358f4d", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/f0d89d9ae522423bd60161aa0c37ae353b358f4d", "committedDate": "2020-11-24T03:07:11Z", "message": "Merge remote-tracking branch 'upstream/master' into 3154"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MDQ2ODE4", "url": "https://github.com/ConsenSys/teku/pull/3292#pullrequestreview-537046818", "createdAt": "2020-11-24T03:15:46Z", "commit": {"oid": "f0d89d9ae522423bd60161aa0c37ae353b358f4d"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMzoxNTo0NlrOH4qQAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMzoxNjoxN1rOH4qQlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE3NDUyOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOG.info(\n          \n          \n            \n                      \"current epoch {} could not be verified against the current slot {}, not processing attestation duty\",\n          \n          \n            \n                      getCurrentEpoch().map(UInt64::toString).orElse(\"UNDEFINED\"),\n          \n          \n            \n                      slot);\n          \n          \n            \n                  LOG.info(\n          \n          \n            \n                      \"Not performing attestation duties for slot {} because it is too far ahead of the current slot {}\",\n          \n          \n            \n                      slot,\n          \n          \n            \n                      getCurrentEpoch().map(UInt64::toString).orElse(\"UNDEFINED\"));", "url": "https://github.com/ConsenSys/teku/pull/3292#discussion_r529174529", "createdAt": "2020-11-24T03:15:46Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/AttestationDutyScheduler.java", "diffHunk": "@@ -35,14 +39,35 @@ public AttestationDutyScheduler(\n   public void onAttestationCreationDue(final UInt64 slot) {\n     // Check slot being null for the edge case of genesis slot (i.e. slot 0)\n     if (lastAttestationCreationSlot != null && slot.compareTo(lastAttestationCreationSlot) <= 0) {\n+      LOG.debug(\n+          \"lastAttestationCreationSlot {} is ahead of current slot {}, not processing attestation duty.\",\n+          lastAttestationCreationSlot,\n+          slot);\n       return;\n     }\n+\n+    if (!isAbleToVerifyEpoch(slot)) {\n+      LOG.info(\n+          \"current epoch {} could not be verified against the current slot {}, not processing attestation duty\",\n+          getCurrentEpoch().map(UInt64::toString).orElse(\"UNDEFINED\"),\n+          slot);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0d89d9ae522423bd60161aa0c37ae353b358f4d"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE3NDYwNQ==", "bodyText": "As above. :)", "url": "https://github.com/ConsenSys/teku/pull/3292#discussion_r529174605", "createdAt": "2020-11-24T03:16:05Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/AttestationDutyScheduler.java", "diffHunk": "@@ -35,14 +39,35 @@ public AttestationDutyScheduler(\n   public void onAttestationCreationDue(final UInt64 slot) {\n     // Check slot being null for the edge case of genesis slot (i.e. slot 0)\n     if (lastAttestationCreationSlot != null && slot.compareTo(lastAttestationCreationSlot) <= 0) {\n+      LOG.debug(\n+          \"lastAttestationCreationSlot {} is ahead of current slot {}, not processing attestation duty.\",\n+          lastAttestationCreationSlot,\n+          slot);\n       return;\n     }\n+\n+    if (!isAbleToVerifyEpoch(slot)) {\n+      LOG.info(\n+          \"current epoch {} could not be verified against the current slot {}, not processing attestation duty\",\n+          getCurrentEpoch().map(UInt64::toString).orElse(\"UNDEFINED\"),\n+          slot);\n+      return;\n+    }\n+\n     lastAttestationCreationSlot = slot;\n     notifyDutyQueue(DutyQueue::onAttestationCreationDue, slot);\n   }\n \n   @Override\n   public void onAttestationAggregationDue(final UInt64 slot) {\n+    if (!isAbleToVerifyEpoch(slot)) {\n+      LOG.info(\n+          \"current epoch {} could not be verified against the current slot {}, not processing aggregation duty\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0d89d9ae522423bd60161aa0c37ae353b358f4d"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE3NDY3OQ==", "bodyText": "Wording tweak again. :)", "url": "https://github.com/ConsenSys/teku/pull/3292#discussion_r529174679", "createdAt": "2020-11-24T03:16:17Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/BlockDutyScheduler.java", "diffHunk": "@@ -32,6 +36,14 @@ public BlockDutyScheduler(\n \n   @Override\n   public void onBlockProductionDue(final UInt64 slot) {\n+    if (!isAbleToVerifyEpoch(slot)) {\n+      LOG.info(\n+          \"current epoch {} could not be verified against the current slot {}, not processing block duty\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0d89d9ae522423bd60161aa0c37ae353b358f4d"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0a8316593b058ed9b26620da56bc02def759400", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/a0a8316593b058ed9b26620da56bc02def759400", "committedDate": "2020-11-24T03:31:09Z", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4306, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}