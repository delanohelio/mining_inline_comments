{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzNzI4Njg4", "number": 2390, "title": "[Issue 2291] Remove RecentChainData.getBlockState()", "bodyText": "PR Description\nReplace remaining calls to RecentChainData.getBlockState() with the async version RecentChainData.retrieveBlockState().\nFixed Issue(s)\nPart of #2291\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-07-20T18:45:56Z", "url": "https://github.com/ConsenSys/teku/pull/2390", "merged": true, "mergeCommit": {"oid": "858f0db2b5a94ae5293af960ea4aa52b48f33df6"}, "closed": true, "closedAt": "2020-07-20T22:52:05Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc21zjKAH2gAyNDUzNzI4Njg4OjcxNDk0NGI2NDU1MjU1YzdiZWU0MmMzZjIzZmU4NTVmNzJlNzY0YTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc25eI1AH2gAyNDUzNzI4Njg4OmI3NmUxMjBkMTcwNmNmZTNmZGJiN2VlYzFiNDBlN2Q2OGZlNjdmYzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "714944b6455255c7bee42c3f23fe855f72e764a1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/714944b6455255c7bee42c3f23fe855f72e764a1", "committedDate": "2020-07-20T18:19:16Z", "message": "Update DepositProvider to use new async state retrieval method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c15056f6764608088d0020812ff4ba120bee1476", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c15056f6764608088d0020812ff4ba120bee1476", "committedDate": "2020-07-20T18:23:58Z", "message": "Remove unused method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feb905943a8b60629ff69df94f13331f38e117e3", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/feb905943a8b60629ff69df94f13331f38e117e3", "committedDate": "2020-07-20T18:24:50Z", "message": "Update tests to use async state retrieval method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24ca5afde7f5589e6cef577d73362ce45fbff586", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/24ca5afde7f5589e6cef577d73362ce45fbff586", "committedDate": "2020-07-20T18:29:39Z", "message": "Remove RecentChainData.getBlockState()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTU2NTQ4", "url": "https://github.com/ConsenSys/teku/pull/2390#pullrequestreview-451956548", "createdAt": "2020-07-20T21:01:35Z", "commit": {"oid": "24ca5afde7f5589e6cef577d73362ce45fbff586"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMTowMTozNVrOG0fJhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMTowMTozNVrOG0fJhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4OTQ3Ng==", "bodyText": "Probably should just log an error here and exit rather than throwing.  It should never happen so probably doesn't matter but if the checkpoint state isn't available it's not actually that big a deal - we just won't prune deposits so don't want to be too noisy about it.", "url": "https://github.com/ConsenSys/teku/pull/2390#discussion_r457689476", "createdAt": "2020-07-20T21:01:35Z", "author": {"login": "ajsutton"}, "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/DepositProvider.java", "diffHunk": "@@ -80,14 +80,22 @@ public synchronized void onDepositsFromBlock(DepositsFromBlockEvent event) {\n   }\n \n   @Override\n-  public synchronized void onNewFinalizedCheckpoint(final Checkpoint checkpoint) {\n-    BeaconState finalizedState =\n-        recentChainData\n-            .getBlockState(checkpoint.getRoot())\n-            .orElseThrow(\n-                () -> new IllegalArgumentException(\"Finalized Checkpoint state can not be found.\"));\n-\n-    depositNavigableMap.headMap(finalizedState.getEth1_deposit_index(), false).clear();\n+  public void onNewFinalizedCheckpoint(final Checkpoint checkpoint) {\n+    recentChainData\n+        .retrieveBlockState(checkpoint.getRoot())\n+        .thenAccept(\n+            finalizedState -> {\n+              if (finalizedState.isEmpty()) {\n+                throw new IllegalStateException(\"Finalized Checkpoint state cannot be found.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24ca5afde7f5589e6cef577d73362ce45fbff586"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b76e120d1706cfe3fdbb7eec1b40e7d68fe67fc3", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/b76e120d1706cfe3fdbb7eec1b40e7d68fe67fc3", "committedDate": "2020-07-20T22:35:30Z", "message": "Log error and return rather than throwing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3659, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}