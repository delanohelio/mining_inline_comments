{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwOTA2MzQ2", "number": 2736, "title": "[Issue 2722] Add standard api endpoint for node syncing", "bodyText": "After verifying the description of the 'head_slot' field, it became apparent there was an issue with the standard api doc, which is an outstanding ticket (#77).\n\nthe head_slot field was supposed to be 'Beacon node's head slot'\n\n\ndeprecated existing syncing api\ntried to add values to the tests to clearly display the behaviour.\n\npartially addresses #2722\nSigned-off-by: Paul Harris paul.harris@consensys.net\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-09-06T21:56:05Z", "url": "https://github.com/ConsenSys/teku/pull/2736", "merged": true, "mergeCommit": {"oid": "79c740c4025c03b8cbf2698da689563e2c81c65a"}, "closed": true, "closedAt": "2020-09-06T23:54:01Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGVkevAH2gAyNDgwOTA2MzQ2OjkxN2JjMmUzNWQxYWY0M2QzMTNmZWVjYWVkYjQ4NWY3ZWM5NDY5YWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGW0MTAFqTQ4MzE4MDE1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "917bc2e35d1af43d313feecaedb485f7ec9469af", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/917bc2e35d1af43d313feecaedb485f7ec9469af", "committedDate": "2020-09-06T21:48:38Z", "message": "Add standard api endpoint for node syncing.\n\n - After verifying the description of the 'head_slot' field, it became apparent there was an issue with the standard api doc, which is an outstanding ticket (#77).\n - the head_slot field was supposed to be 'Beacon node's head slot'\n - deprecated existing syncing api\n - tried to add values to the tests to clearly display the behavior.\n\n partially addresses #2722\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70480892b76214f05d681f4208313b718463c2f7", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/70480892b76214f05d681f4208313b718463c2f7", "committedDate": "2020-09-06T21:49:02Z", "message": "Merge remote-tracking branch 'upstream/master' into 2722-node-syncing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fef39f6118699975d0c696cfc54402a27cbb95b", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/6fef39f6118699975d0c696cfc54402a27cbb95b", "committedDate": "2020-09-06T23:04:12Z", "message": "Merge remote-tracking branch 'upstream/master' into 2722-node-syncing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMTgwMTUw", "url": "https://github.com/ConsenSys/teku/pull/2736#pullrequestreview-483180150", "createdAt": "2020-09-06T23:13:34Z", "commit": {"oid": "6fef39f6118699975d0c696cfc54402a27cbb95b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQyMzoxMzozNFrOHNsqXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQyMzoxMzozNFrOHNsqXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEyNTI3OQ==", "bodyText": "Since we're going to write a bunch of tests like this, I wonder if we should extract a helper library that can manage the mock context for us.  So instead of having to manually create the stringArgs.capture etc, we can have something like:\nfinal ContextTestHelper contextHelper = new ContextTestHelper();\n\nhandler.handle(contextHelper.getContext());\n\nassertThat(contextHelper.getResult(SyncingResponse.class)).isEqualTo(expected);\ncontextHelper.assertNotCacheable();\n\nIt would just create a mock Context internally and do basically the same thing you are, but we'd get much more readable tests with less duplicate boilerplate.", "url": "https://github.com/ConsenSys/teku/pull/2736#discussion_r484125279", "createdAt": "2020-09-06T23:13:34Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/teku/beaconrestapi/handlers/v1/node/GetSyncingTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.v1.node;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+import static tech.pegasys.teku.beaconrestapi.CacheControlUtils.CACHE_NONE;\n+\n+import io.javalin.core.util.Header;\n+import io.javalin.http.Context;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.ArgumentCaptor;\n+import tech.pegasys.teku.api.SyncDataProvider;\n+import tech.pegasys.teku.api.response.v1.node.SyncingResponse;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.provider.JsonProvider;\n+import tech.pegasys.teku.sync.SyncService;\n+\n+public class GetSyncingTest {\n+  private final JsonProvider jsonProvider = new JsonProvider();\n+  private final SyncService syncService = mock(SyncService.class);\n+  private final SyncDataProvider syncDataProvider = new SyncDataProvider(syncService);\n+  private final Context context = mock(Context.class);\n+\n+  private final ArgumentCaptor<String> stringArgs = ArgumentCaptor.forClass(String.class);\n+\n+  @Test\n+  public void shouldGetSyncingStatusSyncing() throws Exception {\n+    GetSyncing handler = new GetSyncing(syncDataProvider, jsonProvider);\n+    when(syncService.getSyncStatus()).thenReturn(getSyncStatus(true, 1, 7, 10));\n+    handler.handle(context);\n+    verify(context).result(stringArgs.capture());\n+    verify(context).header(Header.CACHE_CONTROL, CACHE_NONE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fef39f6118699975d0c696cfc54402a27cbb95b"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3580, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}