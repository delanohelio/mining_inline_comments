{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMTUzMDA0", "number": 1565, "title": "Get the latest available state prior to the requested slot when calculating duties", "bodyText": "PR Description\nWhen calculating Validator Duties for an epoch, if the slot at the start of the epoch before was empty, no duties were calculated because the Store did not contain a state for exactly that slot.\nNow we find the most recent state available at or before the slot and then process slots to bring it up to the required slot.  This ensures duties are available even when slots are skipped.", "createdAt": "2020-04-09T01:02:00Z", "url": "https://github.com/ConsenSys/teku/pull/1565", "merged": true, "mergeCommit": {"oid": "e291fffe4301a156d9d527f73045a585fda7124c"}, "closed": true, "closedAt": "2020-04-10T20:11:55Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVxyi9gH2gAyNDAxMTUzMDA0OmUwNjIwMDZhOTQ0OGIxZmZjNjM3NDdlODA0MWRkZTdhYWM4MmEzYzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWWq5dgH2gAyNDAxMTUzMDA0OmE1NThjOWM5YjY4NDc2OWQ3YjE1NGE3NjZmNWUwZjNjMTY1YmI1NTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e062006a9448b1ffc63747e8041dde7aac82a3c0", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e062006a9448b1ffc63747e8041dde7aac82a3c0", "committedDate": "2020-04-09T00:59:03Z", "message": "Get the latest available state prior to the requested slot when calculating duties and process slots until the required slot.\nAvoids issue where duties could not be calculated when the slot was empty."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "657849ac7ffd32de781c80bec062a6088abe412d", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/657849ac7ffd32de781c80bec062a6088abe412d", "committedDate": "2020-04-09T18:05:11Z", "message": "Merge branch 'master' into duties-and-skipped-slots"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDU5NzQy", "url": "https://github.com/ConsenSys/teku/pull/1565#pullrequestreview-391059742", "createdAt": "2020-04-09T19:09:22Z", "commit": {"oid": "657849ac7ffd32de781c80bec062a6088abe412d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOTowOToyMlrOGDlzkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOTowOToyMlrOGDlzkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQxODMyMA==", "bodyText": "It's unclear to me what's the difference between the two tests here and specifically what they are testing. I've removed both of their bestState and newState lines, kept only a random beacon state generation instead, and that resulted in both tests passing as well.", "url": "https://github.com/ConsenSys/teku/pull/1565#discussion_r406418320", "createdAt": "2020-04-09T19:09:22Z", "author": {"login": "cemozerr"}, "path": "storage/src/test/java/tech/pegasys/artemis/storage/client/RecentChainDataTest.java", "diffHunk": "@@ -189,7 +189,33 @@ public void getStateBySlot_returnGenesisBlockWhenItIsTheBestState() {\n     when(store.getBlockState(GENESIS_BLOCK_ROOT)).thenReturn(newState);\n     when(store.getBlock(GENESIS_BLOCK_ROOT)).thenReturn(GENESIS_BLOCK);\n \n-    assertThat(storageClient.getBlockBySlot(UnsignedLong.ZERO)).contains(GENESIS_BLOCK);\n+    assertThat(storageClient.getStateInEffectAtSlot(UnsignedLong.ZERO)).contains(newState);\n+  }\n+\n+  @Test\n+  public void getStateInEffectAtSlot_returnStateFromLastBlockWhenSlotsAreEmpty() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657849ac7ffd32de781c80bec062a6088abe412d"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMDYwMDky", "url": "https://github.com/ConsenSys/teku/pull/1565#pullrequestreview-391060092", "createdAt": "2020-04-09T19:09:54Z", "commit": {"oid": "657849ac7ffd32de781c80bec062a6088abe412d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTAwOTUx", "url": "https://github.com/ConsenSys/teku/pull/1565#pullrequestreview-391100951", "createdAt": "2020-04-09T20:14:55Z", "commit": {"oid": "657849ac7ffd32de781c80bec062a6088abe412d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDoxNDo1NlrOGDn2OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDoxNDo1NlrOGDn2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1MTc2OQ==", "bodyText": "It might make more sense to move slot processing into combinedChainDataClient.", "url": "https://github.com/ConsenSys/teku/pull/1565#discussion_r406451769", "createdAt": "2020-04-09T20:14:56Z", "author": {"login": "mbaxter"}, "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/ValidatorApiHandler.java", "diffHunk": "@@ -101,7 +107,20 @@ public ValidatorApiHandler(\n         .getStateAtSlot(slot)\n         .thenApply(\n             optionalState ->\n-                optionalState.map(state -> getValidatorDutiesFromState(state, epoch, publicKeys)));\n+                optionalState\n+                    .map(state -> processSlots(state, slot))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "657849ac7ffd32de781c80bec062a6088abe412d"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a558c9c9b684769d7b154a766f5e0f3c165bb555", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/a558c9c9b684769d7b154a766f5e0f3c165bb555", "committedDate": "2020-04-10T19:57:11Z", "message": "Merge branch 'master' into duties-and-skipped-slots"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4255, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}