{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxNzgwNDcz", "number": 2750, "title": "Start new sync by tracking available chains", "bodyText": "PR Description\nStarts to build a MultipeerSyncService which will be the new sync algorithm. At this point it only tracks peer statuses to build a set of target chains that we might want to sync to.\nSince there are a lot of events coming from different sources and reasonably complex data structures will be required to track sync status, this also introduces the EventThread class which enables delegating tasks to a single thread for execution so code can be written without worrying about concurrent access except to ensure that any events coming from other threads are dispatched to the event thread.  This is very similar to the thread model used by ForkChoice and EventChannel but EventThread is a bit more formalised and includes the ability to assert that the current thread is the event thread to detect violations.\nIf this thread model does prove useful, we should be able to apply it to ForkChoice and should consider using it in more places.  One big advantage is that its lock free so has no risk of deadlocking because the thread pool is full of threads waiting to acquire a lock, preventing the task which would release the lock from acquiring a thread to execute which we've seen in other situations in the past.\nFixed Issue(s)\nPart of #1844\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-09-08T05:16:03Z", "url": "https://github.com/ConsenSys/teku/pull/2750", "merged": true, "mergeCommit": {"oid": "ce53ecb195c2eb2edcb09290476f9d78d2a55198"}, "closed": true, "closedAt": "2020-09-10T05:42:44Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGbem7gH2gAyNDgxNzgwNDczOmQwNDA3NzhkYmY3MDFjNTA4MWUxNjlmODlmM2YyMmU5OGJlZjdlZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHZ7GUgH2gAyNDgxNzgwNDczOjFiMWVkMDUxMTA5ZjEyMTAxODQzNmMzMzRjYjJjZTg3ZTYwMzhkMzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d040778dbf701c5081e169f89f3f22e98bef7ef0", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d040778dbf701c5081e169f89f3f22e98bef7ef0", "committedDate": "2020-09-07T04:41:39Z", "message": "Add classes to track available chains."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eef0ecc44a5511b523c2f570012f0f5ea7696429", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/eef0ecc44a5511b523c2f570012f0f5ea7696429", "committedDate": "2020-09-07T20:26:31Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into new-finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d21846317ac3ac30cb482c79bb8714e4f9f5e68a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d21846317ac3ac30cb482c79bb8714e4f9f5e68a", "committedDate": "2020-09-07T20:26:44Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into new-finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1640dfbd838fcedaae9ba17074c838973e7b9aac", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1640dfbd838fcedaae9ba17074c838973e7b9aac", "committedDate": "2020-09-07T23:43:19Z", "message": "Introduce SyncSource to narrow the required interface for Eth2Peer to just what sync actually needs.\nMakes testing easier."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f9e44a0fe703e6ff6d8b8862dbd51c256b99481", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7f9e44a0fe703e6ff6d8b8862dbd51c256b99481", "committedDate": "2020-09-08T04:54:07Z", "message": "Add PeerTracker and wiring to keep track of target chains."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bed064a189fabc5ed975d5f2bc32eea071ab260", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1bed064a189fabc5ed975d5f2bc32eea071ab260", "committedDate": "2020-09-08T04:59:04Z", "message": "Add test for subscribing to peer updates and comment to explain SyncSource."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23aff84df0d7ddf610f868599a0121949122c1d8", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/23aff84df0d7ddf610f868599a0121949122c1d8", "committedDate": "2020-09-08T05:09:50Z", "message": "Add a test for ExecutorEventThread."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1daa1545092f488d18b21b844c53d5ac8983e80", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/f1daa1545092f488d18b21b844c53d5ac8983e80", "committedDate": "2020-09-08T05:16:25Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into track-chains"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddf720450942314f2b432470634e60228d094a43", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ddf720450942314f2b432470634e60228d094a43", "committedDate": "2020-09-08T06:04:29Z", "message": "Don't use getters for equals."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "209e9b3dcce97e1bc77cc1fa1088668ac31d04c9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/209e9b3dcce97e1bc77cc1fa1088668ac31d04c9", "committedDate": "2020-09-08T06:34:42Z", "message": "Remove annoying IntelliJ annotation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MzE3Mjkx", "url": "https://github.com/ConsenSys/teku/pull/2750#pullrequestreview-484317291", "createdAt": "2020-09-08T16:41:20Z", "commit": {"oid": "209e9b3dcce97e1bc77cc1fa1088668ac31d04c9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNjo0MToyMFrOHOlhig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNjo0MToyMFrOHOlhig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA1NjkwNg==", "bodyText": "Don't we want to stick here to AsyncRunner interface as our primary scheduler?\nThat can be useful when/if we would like to implement 'time machine'", "url": "https://github.com/ConsenSys/teku/pull/2750#discussion_r485056906", "createdAt": "2020-09-08T16:41:20Z", "author": {"login": "Nashatyrev"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/eventthread/ExecutorEventThread.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync.multipeer.eventthread;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+public class ExecutorEventThread implements EventThread {\n+  private final AtomicBoolean started = new AtomicBoolean(false);\n+  private final String name;\n+  private ExecutorService thread;\n+\n+  /** The ID of the event thread. The first task executed by the executor sets this ID. */\n+  private volatile long eventThreadId = -1;\n+\n+  public ExecutorEventThread(final String name) {\n+    this.name = name;\n+  }\n+\n+  @Override\n+  public void checkOnEventThread() {\n+    checkState(isEventThread(), \"Attempting to access \" + name + \" resource from non-event thread\");\n+  }\n+\n+  private boolean isEventThread() {\n+    return Thread.currentThread().getId() == eventThreadId;\n+  }\n+\n+  @Override\n+  public synchronized void start() {\n+    if (started.get()) {\n+      return;\n+    }\n+    thread =\n+        Executors.newSingleThreadExecutor(\n+            new ThreadFactoryBuilder().setNameFormat(name).setDaemon(true).build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "209e9b3dcce97e1bc77cc1fa1088668ac31d04c9"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cdad498fb347f9e005c45dc7539ca3876ddf825", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1cdad498fb347f9e005c45dc7539ca3876ddf825", "committedDate": "2020-09-09T00:31:52Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into track-chains"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b3f4cd2cc3c6434458e8873fca5a16a2641cc89", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/5b3f4cd2cc3c6434458e8873fca5a16a2641cc89", "committedDate": "2020-09-09T00:48:28Z", "message": "Move EventThread to infrastructure:async module and convert it to use an AsyncRunner."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e938e855f3b41dd244e7a647a5407c2b2c050ca4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e938e855f3b41dd244e7a647a5407c2b2c050ca4", "committedDate": "2020-09-09T01:21:08Z", "message": "Merge branch 'master' into track-chains"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b1ed051109f121018436c334cb2ce87e6038d35", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1b1ed051109f121018436c334cb2ce87e6038d35", "committedDate": "2020-09-10T05:26:53Z", "message": "Merge branch 'master' into track-chains"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3401, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}