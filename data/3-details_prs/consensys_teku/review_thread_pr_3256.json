{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNTg5NjAw", "number": 3256, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo0Njo0NFrOE605oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjoyNTo0NlrOE7RUzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTE5NTg1OnYy", "diffSide": "RIGHT", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo0Njo0NFrOH2IInQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo0Njo0NFrOH2IInQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxODQyOQ==", "bodyText": "nit: Either need to make the name camel case or make this static constant at the top of the file.", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r526518429", "createdAt": "2020-11-19T00:46:44Z", "author": {"login": "ajsutton"}, "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.test.acceptance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.test.acceptance.dsl.AcceptanceTestBase;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuNode;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuValidatorNode;\n+\n+public class RemoteValidatorAcceptanceTest extends AcceptanceTestBase {\n+  @Test\n+  void shouldCreateAttestationsWithRemoteValidator() throws Exception {\n+    final int VALIDATOR_COUNT = 8;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b8069edf4b1e38080460b9425ae54701cedc9d7"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTE5OTI3OnYy", "diffSide": "RIGHT", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo0ODoxOFrOH2IKqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo0ODoxOFrOH2IKqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxODk1Mg==", "bodyText": "nit: I'd probably call this beaconNode and validatorNode1  validatorClient since that's the typical terms we'd use for this kind of setup.", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r526518952", "createdAt": "2020-11-19T00:48:18Z", "author": {"login": "ajsutton"}, "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.test.acceptance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.test.acceptance.dsl.AcceptanceTestBase;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuNode;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuValidatorNode;\n+\n+public class RemoteValidatorAcceptanceTest extends AcceptanceTestBase {\n+  @Test\n+  void shouldCreateAttestationsWithRemoteValidator() throws Exception {\n+    final int VALIDATOR_COUNT = 8;\n+    final TekuNode node1 =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b8069edf4b1e38080460b9425ae54701cedc9d7"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTIwODU1OnYy", "diffSide": "RIGHT", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo1MjoyN1rOH2IQFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDo1MjoyN1rOH2IQFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMDM0Mw==", "bodyText": "Rather than waiting for 3 slots then checking logs, we should just have a waiter that looks for these logs and retries for some period of time.  It's possible the beacon node can startup faster than the validator node and process 3 slots before the validator even gets started and if we find the log messages earlier we can bail out.\nI'd also just look for one of them - if we can successfully publish we're ok.", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r526520343", "createdAt": "2020-11-19T00:52:27Z", "author": {"login": "ajsutton"}, "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.test.acceptance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.test.acceptance.dsl.AcceptanceTestBase;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuNode;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuValidatorNode;\n+\n+public class RemoteValidatorAcceptanceTest extends AcceptanceTestBase {\n+  @Test\n+  void shouldCreateAttestationsWithRemoteValidator() throws Exception {\n+    final int VALIDATOR_COUNT = 8;\n+    final TekuNode node1 =\n+        createTekuNode(\n+            config ->\n+                config\n+                    .withNetwork(\"minimal\")\n+                    .withInteropNumberOfValidators(VALIDATOR_COUNT)\n+                    .withInteropValidators(0, 0)\n+                    .withRestHostsAllowed(\"*\"));\n+\n+    final TekuValidatorNode validatorNode1 =\n+        createValidatorNode(\n+            config ->\n+                config\n+                    .withNetwork(\"minimal\")\n+                    .withInteropValidators(0, VALIDATOR_COUNT)\n+                    .withBeaconNodeEndpoint(node1.getBeaconRestApiUrl()));\n+\n+    node1.start();\n+    validatorNode1.start();\n+    node1.waitForSlot(3);\n+\n+    assertThat(validatorNode1.getLoggedErrors()).isEmpty();\n+    assertThat(validatorNode1.getFilteredOutput(\"Published aggregate\").size())\n+        .isGreaterThanOrEqualTo(2);\n+    assertThat(validatorNode1.getFilteredOutput(\"Published attestation\").size())\n+        .isGreaterThanOrEqualTo(2);\n+    assertThat(validatorNode1.getFilteredOutput(\"Published block\").size())\n+        .isGreaterThanOrEqualTo(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b8069edf4b1e38080460b9425ae54701cedc9d7"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTUyNjYwOnYy", "diffSide": "RIGHT", "path": "acceptance-tests/src/testFixtures/java/tech/pegasys/teku/test/acceptance/dsl/TekuNode.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMzoxODoxOFrOH2LJRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMzoxODoxOFrOH2LJRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2Nzc1MQ==", "bodyText": "We probably should query the API for this rather than looking for log messages.  Log messages are basically a last resort when we can't find the info by another means (or if we're really specifically after a log message).\nI don't think this method is being used anymore anyway.", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r526567751", "createdAt": "2020-11-19T03:18:18Z", "author": {"login": "ajsutton"}, "path": "acceptance-tests/src/testFixtures/java/tech/pegasys/teku/test/acceptance/dsl/TekuNode.java", "diffHunk": "@@ -158,6 +145,10 @@ public void waitForNewBlock() {\n     waitFor(() -> assertThat(fetchBeaconHead().get()).isNotEqualTo(startingBlockRoot));\n   }\n \n+  public void waitForSlot(final long slot) {\n+    waitFor(() -> assertThat(getFilteredOutput(\"Slot: \" + slot + \",\")).isNotEmpty(), 1, MINUTES);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d1a12742593c69420067a32b788580ef75101c3"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTUzNTE4OnYy", "diffSide": "RIGHT", "path": "acceptance-tests/src/testFixtures/java/tech/pegasys/teku/test/acceptance/dsl/TekuNode.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMzoyMTo1MlrOH2LNvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMzoyMTo1MlrOH2LNvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2ODg5NA==", "bodyText": "I suspect we should just default this to * in ATs so we don't have to worry about it.", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r526568894", "createdAt": "2020-11-19T03:21:52Z", "author": {"login": "ajsutton"}, "path": "acceptance-tests/src/testFixtures/java/tech/pegasys/teku/test/acceptance/dsl/TekuNode.java", "diffHunk": "@@ -417,8 +414,9 @@ public Config withDepositsFrom(final BesuNode eth1Node) {\n       return this;\n     }\n \n-    public Config withValidatorKeys(final String validatorKeys) {\n-      this.validatorKeys = Optional.of(validatorKeys);\n+    public Config withRestHostsAllowed(final String allowList) {\n+      LOG.debug(\"rest-api-host-allowlist:\" + allowList);\n+      configMap.put(\"rest-api-host-allowlist\", allowList);\n       return this;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d1a12742593c69420067a32b788580ef75101c3"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNTg1MjkyOnYy", "diffSide": "RIGHT", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjoyNTo0NlrOH20f9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjoyNTo0NlrOH20f9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI0NTMwMA==", "bodyText": "Probably better to do this in a @BeforeEach method and make beaconNode and validatorClient fields.", "url": "https://github.com/ConsenSys/teku/pull/3256#discussion_r527245300", "createdAt": "2020-11-19T22:25:46Z", "author": {"login": "ajsutton"}, "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/RemoteValidatorAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.test.acceptance;\n+\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.teku.test.acceptance.dsl.AcceptanceTestBase;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuNode;\n+import tech.pegasys.teku.test.acceptance.dsl.TekuValidatorNode;\n+\n+public class RemoteValidatorAcceptanceTest extends AcceptanceTestBase {\n+  static final int VALIDATOR_COUNT = 8;\n+\n+  @Test\n+  void shouldCreateAttestationsWithRemoteValidator() throws Exception {\n+    final TekuNode beaconNode = getBeaconNode();\n+    final TekuValidatorNode validatorClient = getValidatorClient(beaconNode.getBeaconRestApiUrl());\n+\n+    beaconNode.start();\n+    validatorClient.start();\n+\n+    validatorClient.waitForLogMessageContaining(\"Published block\");\n+    validatorClient.waitForLogMessageContaining(\"Published attestation\");\n+    validatorClient.waitForLogMessageContaining(\"Published aggregate\");\n+  }\n+\n+  @Test\n+  void shouldCreateAttestationsWithRemoteValidatorStartingFirst() throws Exception {\n+\n+    final TekuNode beaconNode = getBeaconNode();\n+    final TekuValidatorNode validatorClient = getValidatorClient(beaconNode.getBeaconRestApiUrl());\n+\n+    validatorClient.start();\n+    validatorClient.waitForLogMessageContaining(\n+        \"Error while connecting to beacon node event stream\");\n+\n+    beaconNode.start();\n+\n+    validatorClient.waitForLogMessageContaining(\"Connected to EventSource stream\");\n+    validatorClient.waitForLogMessageContaining(\"Published block\");\n+    validatorClient.waitForLogMessageContaining(\"Published attestation\");\n+    validatorClient.waitForLogMessageContaining(\"Published aggregate\");\n+  }\n+\n+  private TekuNode getBeaconNode() {\n+    return createTekuNode(\n+        config ->\n+            config\n+                .withNetwork(\"minimal\")\n+                .withInteropNumberOfValidators(VALIDATOR_COUNT)\n+                .withInteropValidators(0, 0)\n+                .withRestHostsAllowed(\"*\"));\n+  }\n+\n+  private TekuValidatorNode getValidatorClient(final String beaconRestUrl) {\n+    return createValidatorNode(\n+        config ->\n+            config\n+                .withNetwork(\"minimal\")\n+                .withInteropValidators(0, VALIDATOR_COUNT)\n+                .withBeaconNodeEndpoint(beaconRestUrl));\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1da4948427989dd8ff1b761d300b44c67b22ede7"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3047, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}