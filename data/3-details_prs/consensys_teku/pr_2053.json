{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NjI4NjUw", "number": 2053, "title": "Fix rollback failure when commit fails", "bodyText": "PR Description\nWhen the RocksDB transaction fails to commit, Teku attempted to roll it back, but RocksDB doesn't allow that as the transaction has already failed.  Just need to close the transaction instead.\nOtherwise we get:\n:32:48.072+00:00 | StorageUpdateChannel-0 | ERROR | Store | Failed to persist validator vote changes.\njava.util.concurrent.CompletionException: tech.pegasys.teku.storage.server.DatabaseStorageException: Failed to rollback transaction\n        at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:331) ~[?:?]\n        at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:346) ~[?:?]\n        at java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:704) ~[?:?]\n        at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\n        at java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2088) ~[?:?]\n        at tech.pegasys.teku.util.async.SafeFuture.lambda$propagateResult$2(SafeFuture.java:95) ~[teku-util-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\n        at java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837) ~[?:?]\n        at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]\n        at java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2088) ~[?:?]\n        at tech.pegasys.teku.util.async.SafeFuture.lambda$propagateResult$2(SafeFuture.java:95) ~[teku-util-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]\n        at java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:883) ~[?:?]\n        at java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2251) ~[?:?]\n        at tech.pegasys.teku.util.async.SafeFuture.whenComplete(SafeFuture.java:328) ~[teku-util-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.util.async.SafeFuture.whenComplete(SafeFuture.java:26) ~[teku-util-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.util.async.SafeFuture.propagateResult(SafeFuture.java:92) ~[teku-util-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.util.async.SafeFuture.propagateTo(SafeFuture.java:181) ~[teku-util-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.events.AsyncEventDeliverer.lambda$deliverToWithResponse$1(AsyncEventDeliverer.java:70) ~[teku-events-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.events.AsyncEventDeliverer$QueueReader.deliverNextEvent(AsyncEventDeliverer.java:111) [teku-events-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.events.AsyncEventDeliverer$QueueReader.run(AsyncEventDeliverer.java:103) [teku-events-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\n        at java.lang.Thread.run(Thread.java:834) [?:?]\nCaused by: tech.pegasys.teku.storage.server.DatabaseStorageException: Failed to rollback transaction\n        at tech.pegasys.teku.storage.server.rocksdb.core.RocksDbInstance$Transaction.rollback(RocksDbInstance.java:232) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.rocksdb.core.RocksDbInstance$Transaction.commit(RocksDbInstance.java:220) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.rocksdb.dataaccess.V3RocksDbDao$V3Updater.commit(V3RocksDbDao.java:445) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.rocksdb.RocksDbDatabase.doUpdate(RocksDbDatabase.java:226) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.rocksdb.RocksDbDatabase.update(RocksDbDatabase.java:111) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.ChainStorage.lambda$onStorageUpdate$0(ChainStorage.java:80) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.util.async.SafeFuture.of(SafeFuture.java:75) ~[teku-util-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.ChainStorage.onStorageUpdate(ChainStorage.java:78) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at jdk.internal.reflect.GeneratedMethodAccessor41.invoke(Unknown Source) ~[?:?]\n        at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:?]\n        at java.lang.reflect.Method.invoke(Method.java:566) ~[?:?]\n        at tech.pegasys.teku.events.DirectEventDeliverer.executeMethod(DirectEventDeliverer.java:70) ~[teku-events-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.events.DirectEventDeliverer.deliverToWithResponse(DirectEventDeliverer.java:63) ~[teku-events-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        ... 6 more\nCaused by: org.rocksdb.RocksDBException: Two phase transaction is not in state for rollback.\n        at org.rocksdb.Transaction.rollback(Native Method) ~[rocksdbjni-6.4.6.jar:?]\n        at org.rocksdb.Transaction.rollback(Transaction.java:216) ~[rocksdbjni-6.4.6.jar:?]\n        at tech.pegasys.teku.storage.server.rocksdb.core.RocksDbInstance$Transaction.rollback(RocksDbInstance.java:229) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.rocksdb.core.RocksDbInstance$Transaction.commit(RocksDbInstance.java:220) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.rocksdb.dataaccess.V3RocksDbDao$V3Updater.commit(V3RocksDbDao.java:445) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.rocksdb.RocksDbDatabase.doUpdate(RocksDbDatabase.java:226) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.rocksdb.RocksDbDatabase.update(RocksDbDatabase.java:111) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.ChainStorage.lambda$onStorageUpdate$0(ChainStorage.java:80) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.util.async.SafeFuture.of(SafeFuture.java:75) ~[teku-util-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.storage.server.ChainStorage.onStorageUpdate(ChainStorage.java:78) ~[teku-storage-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at jdk.internal.reflect.GeneratedMethodAccessor41.invoke(Unknown Source) ~[?:?]\n        at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:?]\n        at java.lang.reflect.Method.invoke(Method.java:566) ~[?:?]\n        at tech.pegasys.teku.events.DirectEventDeliverer.executeMethod(DirectEventDeliverer.java:70) ~[teku-events-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        at tech.pegasys.teku.events.DirectEventDeliverer.deliverToWithResponse(DirectEventDeliverer.java:63) ~[teku-events-0.11.3-SNAPSHOT.jar:0.11.3-dev-ecd183dd]\n        ... 6 more", "createdAt": "2020-06-04T06:56:32Z", "url": "https://github.com/ConsenSys/teku/pull/2053", "merged": true, "mergeCommit": {"oid": "c9dfa4df00ea8285c94bb67b44958c7a8349409a"}, "closed": true, "closedAt": "2020-06-04T21:01:53Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcn4BOYgH2gAyNDI3NjI4NjUwOjkyMzk4NDI4ZTc2YTIzYWYxMmI2YjA5YTdkMjRhZjI0OGNhZmE0M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoEaf6gH2gAyNDI3NjI4NjUwOmRhMTk5YWNmM2JlNjJjNTAzMzhiMzk2OGJjMzE2NmU0MGI4ZDgzNjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "92398428e76a23af12b6b09a7d24af248cafa43d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/92398428e76a23af12b6b09a7d24af248cafa43d", "committedDate": "2020-06-04T06:25:09Z", "message": "Remove old, incorrect, unused epoch metrics."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aafa05f0e0ba4ae3e3dc109a14fd865c0bf595c9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/aafa05f0e0ba4ae3e3dc109a14fd865c0bf595c9", "committedDate": "2020-06-04T06:53:11Z", "message": "Don't attempt to rollback when commit fails."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9045150306e42cd6a8383040d8d13430071b4df", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/c9045150306e42cd6a8383040d8d13430071b4df", "committedDate": "2020-06-04T06:56:25Z", "message": "Revert \"Remove old, incorrect, unused epoch metrics.\"\n\nThis reverts commit 92398428e76a23af12b6b09a7d24af248cafa43d."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NTMxMzM2", "url": "https://github.com/ConsenSys/teku/pull/2053#pullrequestreview-424531336", "createdAt": "2020-06-04T14:51:03Z", "commit": {"oid": "c9045150306e42cd6a8383040d8d13430071b4df"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNDo1MTowNFrOGfJzoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNDo1MTowNFrOGfJzoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMxOTcxMw==", "bodyText": "We're sure there's no way the commit could partially succeed and need to be rolled back?  Should we have a private tryRollback method that doesn't throw?", "url": "https://github.com/ConsenSys/teku/pull/2053#discussion_r435319713", "createdAt": "2020-06-04T14:51:04Z", "author": {"login": "mbaxter"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/core/RocksDbInstance.java", "diffHunk": "@@ -215,10 +215,10 @@ public void commit() {\n       assertOpen();\n       try {\n         this.rocksDbTx.commit();\n-        close();\n       } catch (RocksDBException e) {\n-        rollback();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9045150306e42cd6a8383040d8d13430071b4df"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da199acf3be62c50338b3968bc3166e40b8d8360", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/da199acf3be62c50338b3968bc3166e40b8d8360", "committedDate": "2020-06-04T20:51:37Z", "message": "Merge branch 'master' into rocksdb-rollback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4098, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}