{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1OTIwNTQ3", "number": 1179, "title": "#1158 add openApi documentation to beacon head handler", "bodyText": "Add an object level abstraction for the response object, so that openApi can render what the response will be similar to. Not sure if the builder pattern is overkill, but having private member variables and getters didn't output in openApi.\nSigned-off-by: Paul Harris paul.harris@consensys.net", "createdAt": "2020-02-17T03:22:37Z", "url": "https://github.com/ConsenSys/teku/pull/1179", "merged": true, "mergeCommit": {"oid": "ed2e1897e80340db8e18e0febb4b41354b28f492"}, "closed": true, "closedAt": "2020-02-20T04:34:57Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFEpTJAH2gAyMzc1OTIwNTQ3OmI5NGY2OTI3NzM4YWFlNWYzYzRhZWVjNjc2YmM2NjBlMjljNzFjMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGDYCgAH2gAyMzc1OTIwNTQ3OmE1NWU4ZWRhNjBjMzlhN2JmNjhiZTQzNDljNmUxYTYwNjE4MjZmNzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b94f6927738aae5f3c4aeec676bc660e29c71c26", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/b94f6927738aae5f3c4aeec676bc660e29c71c26", "committedDate": "2020-02-17T03:20:26Z", "message": "#1158 add openApi documentation to beacon head handler\n\nAdd an object level abstraction for the response object, so that openApi can render what the response will be similar to. Not sure if the builder pattern is overkill, but having private member variables and getters didnt output in openApi.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDgzOTYy", "url": "https://github.com/ConsenSys/teku/pull/1179#pullrequestreview-359483962", "createdAt": "2020-02-17T04:31:55Z", "commit": {"oid": "b94f6927738aae5f3c4aeec676bc660e29c71c26"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNDozMTo1NVrOFqYQAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNDozMzoyM1rOFqYQzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk4MTgyNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  summary = \"Get the head of the beacon chain from the nodes perspective.\",\n          \n          \n            \n                  summary = \"Get the head of the beacon chain from the node's perspective.\",", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r379981825", "createdAt": "2020-02-17T04:31:55Z", "author": {"login": "macfarla"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconHeadHandler.java", "diffHunk": "@@ -13,38 +13,64 @@\n \n package tech.pegasys.artemis.beaconrestapi.beaconhandlers;\n \n-import com.google.common.primitives.UnsignedLong;\n-import java.util.HashMap;\n-import java.util.Map;\n+import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;\n+\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes32;\n-import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n+import tech.pegasys.artemis.beaconrestapi.schema.BeaconHeadResponse;\n+import tech.pegasys.artemis.provider.JsonProvider;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n \n-public class BeaconHeadHandler implements BeaconRestApiHandler {\n+public class BeaconHeadHandler implements Handler {\n+  private final Logger LOG = LogManager.getLogger();\n+  public static final String ROUTE = \"/beacon/head\";\n \n   private final ChainStorageClient client;\n \n   public BeaconHeadHandler(ChainStorageClient client) {\n     this.client = client;\n   }\n \n-  @Override\n-  public String getPath() {\n-    return \"/beacon/head\";\n+  private BeaconHeadResponse getBeaconHead() {\n+    Bytes32 headBlockRoot = client.getBestBlockRoot();\n+    if (headBlockRoot == null) {\n+      return null;\n+    }\n+    Bytes32 headStateRoot = client.getBestBlockRootState().hash_tree_root();\n+    return BeaconHeadResponse.builder()\n+        .best_slot(client.getBestSlot().longValue())\n+        .block_root(headBlockRoot.toHexString())\n+        .state_root(headStateRoot.toHexString())\n+        .build();\n   }\n \n+  @OpenApi(\n+      path = BeaconHeadHandler.ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Get the head of the beacon chain from the nodes perspective.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94f6927738aae5f3c4aeec676bc660e29c71c26"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk4MTk4MA==", "bodyText": "slot here but best_slot on the builder", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r379981980", "createdAt": "2020-02-17T04:32:58Z", "author": {"login": "macfarla"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/schema/BeaconHeadResponse.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.beaconrestapi.schema;\n+\n+public class BeaconHeadResponse {\n+  public final long slot;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94f6927738aae5f3c4aeec676bc660e29c71c26"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk4MjAyOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void RestApiShouldHaveBeaconHeadEndpoint() throws Exception {\n          \n          \n            \n              public void restApiShouldHaveBeaconHeadEndpoint() throws Exception {", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r379982029", "createdAt": "2020-02-17T04:33:23Z", "author": {"login": "macfarla"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApiTest.java", "diffHunk": "@@ -57,4 +58,12 @@ public void RestApiShouldHaveVersionEndpoint() throws Exception {\n \n     verify(mockApp).get(eq(VersionHandler.ROUTE), any(VersionHandler.class));\n   }\n+\n+  @Test\n+  public void RestApiShouldHaveBeaconHeadEndpoint() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b94f6927738aae5f3c4aeec676bc660e29c71c26"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0530d2e95e41d3cfa299b289d22efce012a39924", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/0530d2e95e41d3cfa299b289d22efce012a39924", "committedDate": "2020-02-17T05:03:51Z", "message": "Update data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApiTest.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d491c335cf7eb7416d8ec46bb84da3e2e16bd0ee", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/d491c335cf7eb7416d8ec46bb84da3e2e16bd0ee", "committedDate": "2020-02-17T05:03:58Z", "message": "Update data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconHeadHandler.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c80b9bab671f22abbcc817884e87d0fdcc34b09d", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/c80b9bab671f22abbcc817884e87d0fdcc34b09d", "committedDate": "2020-02-17T20:30:22Z", "message": "#1158 changes per review comments.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTY0NDgz", "url": "https://github.com/ConsenSys/teku/pull/1179#pullrequestreview-359964483", "createdAt": "2020-02-17T21:03:56Z", "commit": {"oid": "c80b9bab671f22abbcc817884e87d0fdcc34b09d"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QyMTowMzo1NlrOFqvpdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwMTozMzowMFrOFqy0hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM2NTE3Mw==", "bodyText": "I thought we were going to separate the logic for getting the answer from the Javalin HTTP handling?", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r380365173", "createdAt": "2020-02-17T21:03:56Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconHeadHandler.java", "diffHunk": "@@ -13,38 +13,64 @@\n \n package tech.pegasys.artemis.beaconrestapi.beaconhandlers;\n \n-import com.google.common.primitives.UnsignedLong;\n-import java.util.HashMap;\n-import java.util.Map;\n+import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;\n+\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes32;\n-import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n+import tech.pegasys.artemis.beaconrestapi.schema.BeaconHeadResponse;\n+import tech.pegasys.artemis.provider.JsonProvider;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n \n-public class BeaconHeadHandler implements BeaconRestApiHandler {\n+public class BeaconHeadHandler implements Handler {\n+  private final Logger LOG = LogManager.getLogger();\n+  public static final String ROUTE = \"/beacon/head\";\n \n   private final ChainStorageClient client;\n \n   public BeaconHeadHandler(ChainStorageClient client) {\n     this.client = client;\n   }\n \n-  @Override\n-  public String getPath() {\n-    return \"/beacon/head\";\n+  private BeaconHeadResponse getBeaconHead() {\n+    Bytes32 headBlockRoot = client.getBestBlockRoot();\n+    if (headBlockRoot == null) {\n+      return null;\n+    }\n+    Bytes32 headStateRoot = client.getBestBlockRootState().hash_tree_root();\n+    return BeaconHeadResponse.builder()\n+        .slot(client.getBestSlot().longValue())\n+        .block_root(headBlockRoot.toHexString())\n+        .state_root(headStateRoot.toHexString())\n+        .build();\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80b9bab671f22abbcc817884e87d0fdcc34b09d"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQxMDM0Mw==", "bodyText": "Are we able to provide a message to explain what this status means? It won't be obvious to people that you'd get no content pre-genesis.", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r380410343", "createdAt": "2020-02-18T00:54:23Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconHeadHandler.java", "diffHunk": "@@ -13,38 +13,64 @@\n \n package tech.pegasys.artemis.beaconrestapi.beaconhandlers;\n \n-import com.google.common.primitives.UnsignedLong;\n-import java.util.HashMap;\n-import java.util.Map;\n+import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;\n+\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes32;\n-import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n+import tech.pegasys.artemis.beaconrestapi.schema.BeaconHeadResponse;\n+import tech.pegasys.artemis.provider.JsonProvider;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n \n-public class BeaconHeadHandler implements BeaconRestApiHandler {\n+public class BeaconHeadHandler implements Handler {\n+  private final Logger LOG = LogManager.getLogger();\n+  public static final String ROUTE = \"/beacon/head\";\n \n   private final ChainStorageClient client;\n \n   public BeaconHeadHandler(ChainStorageClient client) {\n     this.client = client;\n   }\n \n-  @Override\n-  public String getPath() {\n-    return \"/beacon/head\";\n+  private BeaconHeadResponse getBeaconHead() {\n+    Bytes32 headBlockRoot = client.getBestBlockRoot();\n+    if (headBlockRoot == null) {\n+      return null;\n+    }\n+    Bytes32 headStateRoot = client.getBestBlockRootState().hash_tree_root();\n+    return BeaconHeadResponse.builder()\n+        .slot(client.getBestSlot().longValue())\n+        .block_root(headBlockRoot.toHexString())\n+        .state_root(headStateRoot.toHexString())\n+        .build();\n   }\n \n+  @OpenApi(\n+      path = BeaconHeadHandler.ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Get the head of the beacon chain from the node's perspective.\",\n+      tags = {\"Beacon\"},\n+      description = \"Requests the context of the best slot and head block from the beacon node.\",\n+      responses = {\n+        @OpenApiResponse(\n+            status = \"200\",\n+            content = @OpenApiContent(from = BeaconHeadResponse.class)),\n+        @OpenApiResponse(status = \"204\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80b9bab671f22abbcc817884e87d0fdcc34b09d"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQxMTMxNQ==", "bodyText": "Suspect this should be trace level.  It's going to happen on every call pre-genesis and is pretty easy to detect as you get a no content response back.", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r380411315", "createdAt": "2020-02-18T01:00:03Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconHeadHandler.java", "diffHunk": "@@ -13,38 +13,64 @@\n \n package tech.pegasys.artemis.beaconrestapi.beaconhandlers;\n \n-import com.google.common.primitives.UnsignedLong;\n-import java.util.HashMap;\n-import java.util.Map;\n+import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;\n+\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes32;\n-import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n+import tech.pegasys.artemis.beaconrestapi.schema.BeaconHeadResponse;\n+import tech.pegasys.artemis.provider.JsonProvider;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n \n-public class BeaconHeadHandler implements BeaconRestApiHandler {\n+public class BeaconHeadHandler implements Handler {\n+  private final Logger LOG = LogManager.getLogger();\n+  public static final String ROUTE = \"/beacon/head\";\n \n   private final ChainStorageClient client;\n \n   public BeaconHeadHandler(ChainStorageClient client) {\n     this.client = client;\n   }\n \n-  @Override\n-  public String getPath() {\n-    return \"/beacon/head\";\n+  private BeaconHeadResponse getBeaconHead() {\n+    Bytes32 headBlockRoot = client.getBestBlockRoot();\n+    if (headBlockRoot == null) {\n+      return null;\n+    }\n+    Bytes32 headStateRoot = client.getBestBlockRootState().hash_tree_root();\n+    return BeaconHeadResponse.builder()\n+        .slot(client.getBestSlot().longValue())\n+        .block_root(headBlockRoot.toHexString())\n+        .state_root(headStateRoot.toHexString())\n+        .build();\n   }\n \n+  @OpenApi(\n+      path = BeaconHeadHandler.ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Get the head of the beacon chain from the node's perspective.\",\n+      tags = {\"Beacon\"},\n+      description = \"Requests the context of the best slot and head block from the beacon node.\",\n+      responses = {\n+        @OpenApiResponse(\n+            status = \"200\",\n+            content = @OpenApiContent(from = BeaconHeadResponse.class)),\n+        @OpenApiResponse(status = \"204\")\n+      })\n   @Override\n-  public Object handleRequest(RequestParams params) {\n-    Bytes32 head_block_root = client.getBestBlockRoot();\n-    if (head_block_root == null) {\n-      return null;\n+  public void handle(Context ctx) throws Exception {\n+    BeaconHeadResponse result = getBeaconHead();\n+    if (result == null) {\n+      LOG.debug(\"Failed to get beacon head\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80b9bab671f22abbcc817884e87d0fdcc34b09d"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQxNTY1Mg==", "bodyText": "I'm not sure I'd bother with a builder in this case.  It's a lot of extra boiler plate code for not a lot of value.  Just using the constructor directly is just as clear.  It also means that the compiler won't detect cases where fields are not being set which makes adding new fields in the future more error prone.", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r380415652", "createdAt": "2020-02-18T01:24:48Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/schema/BeaconHeadResponse.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.beaconrestapi.schema;\n+\n+public class BeaconHeadResponse {\n+  public final long slot;\n+  public final String block_root;\n+  public final String state_root;\n+\n+  public static Builder builder() {\n+    return new Builder();\n+  }\n+\n+  public static class Builder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80b9bab671f22abbcc817884e87d0fdcc34b09d"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQxNjI1Ng==", "bodyText": "I'm not sure these tests are providing any real value.  They aren't checking it's actually wired up correctly and are essentially just duplicating the internal logic of the class being tested.\nIf you can get a list of registered routes from the server and compare to the expected set that could be useful and lower maintenance but the risk of not registering the API at all seems fairly low.", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r380416256", "createdAt": "2020-02-18T01:28:13Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApiTest.java", "diffHunk": "@@ -57,4 +58,12 @@ public void RestApiShouldHaveVersionEndpoint() throws Exception {\n \n     verify(mockApp).get(eq(VersionHandler.ROUTE), any(VersionHandler.class));\n   }\n+\n+  @Test\n+  public void restApiShouldHaveBeaconHeadEndpoint() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80b9bab671f22abbcc817884e87d0fdcc34b09d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQxNjU3MQ==", "bodyText": "I'd use DataStructureUtils.randomBeaconState rather than a mock.  It's generally better to use real instances of data structure classes rather than mocks since there's no functionality to be stubbed out.", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r380416571", "createdAt": "2020-02-18T01:29:56Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconHeadHandlerTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.beaconrestapi.beaconhandlers;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import io.javalin.http.Context;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.beaconrestapi.schema.BeaconHeadResponse;\n+import tech.pegasys.artemis.datastructures.state.BeaconState;\n+import tech.pegasys.artemis.provider.JsonProvider;\n+import tech.pegasys.artemis.storage.ChainStorageClient;\n+\n+public class BeaconHeadHandlerTest {\n+  private Context mockContext = mock(Context.class);\n+  private BeaconState mockRootState = mock(BeaconState.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80b9bab671f22abbcc817884e87d0fdcc34b09d"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQxNzE1Ng==", "bodyText": "It's kind of weird that we're mixing patterns for adding handlers.", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r380417156", "createdAt": "2020-02-18T01:33:00Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApi.java", "diffHunk": "@@ -132,11 +132,11 @@ private void addNodeHandlers(ChainStorageClient chainStorageClient) {\n \n   private void addBeaconHandlers(\n       ChainStorageClient chainStorageClient, HistoricalChainData historicalChainData) {\n+    app.get(BeaconHeadHandler.ROUTE, new BeaconHeadHandler(chainStorageClient));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80b9bab671f22abbcc817884e87d0fdcc34b09d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0c6f035b690df15bb6d046197bacfcf6bf3c250", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/d0c6f035b690df15bb6d046197bacfcf6bf3c250", "committedDate": "2020-02-18T19:37:03Z", "message": "remove prefix from mock objects\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6b03b70626ea4ad28e8dde055fae070509641dd", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/e6b03b70626ea4ad28e8dde055fae070509641dd", "committedDate": "2020-02-19T01:12:04Z", "message": "Merge remote-tracking branch 'upstream/master' into artemis-1158"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "609bf8091979229276b3999259a32389e96c54d5", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/609bf8091979229276b3999259a32389e96c54d5", "committedDate": "2020-02-19T04:27:37Z", "message": "changes per review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0193ba538e1f2d1bc6132867f2069a61c4653aaf", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/0193ba538e1f2d1bc6132867f2069a61c4653aaf", "committedDate": "2020-02-19T04:34:26Z", "message": "changes per review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTgxMzQw", "url": "https://github.com/ConsenSys/teku/pull/1179#pullrequestreview-360981340", "createdAt": "2020-02-19T10:04:08Z", "commit": {"oid": "0193ba538e1f2d1bc6132867f2069a61c4653aaf"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDowNDowOFrOFriChQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMDoxMzo1M1rOFriYQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5MDc4OQ==", "bodyText": "can this just be ROUTE ?", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r381190789", "createdAt": "2020-02-19T10:04:08Z", "author": {"login": "macfarla"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconHeadHandler.java", "diffHunk": "@@ -13,38 +13,63 @@\n \n package tech.pegasys.artemis.beaconrestapi.beaconhandlers;\n \n-import com.google.common.primitives.UnsignedLong;\n-import java.util.HashMap;\n-import java.util.Map;\n+import static javax.servlet.http.HttpServletResponse.SC_NO_CONTENT;\n+\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes32;\n-import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n+import tech.pegasys.artemis.beaconrestapi.schema.BeaconHeadResponse;\n+import tech.pegasys.artemis.provider.JsonProvider;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n \n-public class BeaconHeadHandler implements BeaconRestApiHandler {\n+public class BeaconHeadHandler implements Handler {\n+  private final Logger LOG = LogManager.getLogger();\n+  public static final String ROUTE = \"/beacon/head\";\n \n   private final ChainStorageClient client;\n \n   public BeaconHeadHandler(ChainStorageClient client) {\n     this.client = client;\n   }\n \n-  @Override\n-  public String getPath() {\n-    return \"/beacon/head\";\n+  private BeaconHeadResponse getBeaconHead() {\n+    Bytes32 headBlockRoot = client.getBestBlockRoot();\n+    if (headBlockRoot == null) {\n+      return null;\n+    }\n+    Bytes32 headStateRoot = client.getBestBlockRootState().hash_tree_root();\n+    return new BeaconHeadResponse(client.getBestSlot(), headBlockRoot, headStateRoot);\n   }\n \n+  @OpenApi(\n+      path = BeaconHeadHandler.ROUTE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0193ba538e1f2d1bc6132867f2069a61c4653aaf"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5NjM1NA==", "bodyText": "if this was not wired in right, and this test fails, would ALL the tests fail?", "url": "https://github.com/ConsenSys/teku/pull/1179#discussion_r381196354", "createdAt": "2020-02-19T10:13:53Z", "author": {"login": "macfarla"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApiTest.java", "diffHunk": "@@ -57,4 +58,12 @@ public void RestApiShouldHaveVersionEndpoint() throws Exception {\n \n     verify(mockApp).get(eq(VersionHandler.ROUTE), any(VersionHandler.class));\n   }\n+\n+  @Test\n+  public void restApiShouldHaveBeaconHeadEndpoint() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQxNjI1Ng=="}, "originalCommit": {"oid": "c80b9bab671f22abbcc817884e87d0fdcc34b09d"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f8a94c5539667e3dfcc24c70e079987d979d674", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/5f8a94c5539667e3dfcc24c70e079987d979d674", "committedDate": "2020-02-19T19:06:06Z", "message": "changes per review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0ec7e8fcf87a4ae8dfe6e2a168b765777828454", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/e0ec7e8fcf87a4ae8dfe6e2a168b765777828454", "committedDate": "2020-02-19T19:16:21Z", "message": "changes per review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e57ad6a49f31e5921c0f362440ebc5c743f46d7", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/5e57ad6a49f31e5921c0f362440ebc5c743f46d7", "committedDate": "2020-02-19T22:14:25Z", "message": "fix spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc1ce25cf974dac56c0c547c645f6848d6131802", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/fc1ce25cf974dac56c0c547c645f6848d6131802", "committedDate": "2020-02-19T22:57:38Z", "message": "Merge remote-tracking branch 'upstream/master' into artemis-1158"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "770205d2b3045427380ec0a130c9a791bdde56ae", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/770205d2b3045427380ec0a130c9a791bdde56ae", "committedDate": "2020-02-19T23:12:09Z", "message": "Merge remote-tracking branch 'upstream/master' into artemis-1158"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fdf008f6c046ca28a1d4328e3dc5c3f94f6a834", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/4fdf008f6c046ca28a1d4328e3dc5c3f94f6a834", "committedDate": "2020-02-20T03:45:16Z", "message": "Merge remote-tracking branch 'upstream/master' into artemis-1158\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "852b7cbf284e0743a3e5b0beba54c0c98ff66a49", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/852b7cbf284e0743a3e5b0beba54c0c98ff66a49", "committedDate": "2020-02-20T04:04:05Z", "message": "Merge remote-tracking branch 'upstream/master' into artemis-1158"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a55e8eda60c39a7bf68be4349c6e1a6061826f76", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/a55e8eda60c39a7bf68be4349c6e1a6061826f76", "committedDate": "2020-02-20T04:25:36Z", "message": "Merge remote-tracking branch 'upstream/master' into artemis-1158\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4053, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}