{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0OTkzMjQ4", "number": 1098, "title": "[BC-221] Disconnect peers advertising an invalid finalized epoch", "bodyText": "PR Description\nUpdate peer validation to check that remote finalized epoch is \"reasonable\":\n\nFinalized epoch must not be from the future\nFinalized epoch must not be from the current epoch unless we're in the genesis epoch", "createdAt": "2020-01-20T20:33:14Z", "url": "https://github.com/ConsenSys/teku/pull/1098", "merged": true, "mergeCommit": {"oid": "4ebe4218476a462aa4bfc62232b1721ad04b5200"}, "closed": true, "closedAt": "2020-01-21T20:34:41Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8SmADgH2gAyMzY0OTkzMjQ4OmI5MjcwOTQ3ODU2YzE0NjJkNjI3NWRkZjcwZDc0ZDU0MTkwMWY4M2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8nEUaAFqTM0NjE2NTQxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b9270947856c1462d6275ddf70d74d541901f83e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/b9270947856c1462d6275ddf70d74d541901f83e", "committedDate": "2020-01-20T20:30:11Z", "message": "Disconnect peers advertising an invalid finalized epoch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTM5NDQ1", "url": "https://github.com/ConsenSys/teku/pull/1098#pullrequestreview-345539445", "createdAt": "2020-01-20T21:28:59Z", "commit": {"oid": "b9270947856c1462d6275ddf70d74d541901f83e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMToyODo1OVrOFfplhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMjozNzo0NVrOFfqi7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODczMTUyNQ==", "bodyText": "I think this will give us the slot of the best bock, not the current slot.  So if we haven't completed sync this would be a slot from the distant past and we'd disconnect most peers.  I think we want to use get_current_slot(store) which will give us the slot based on the time, not what blocks have been imported.", "url": "https://github.com/ConsenSys/teku/pull/1098#discussion_r368731525", "createdAt": "2020-01-20T21:28:59Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidator.java", "diffHunk": "@@ -112,11 +114,22 @@ public static PeerChainValidator create(\n       return SafeFuture.completedFuture(true);\n     }\n \n-    // Check whether finalized checkpoints are compatible\n     final Checkpoint finalizedCheckpoint = storageClient.getStore().getFinalizedCheckpoint();\n     final UnsignedLong finalizedEpoch = finalizedCheckpoint.getEpoch();\n     final UnsignedLong remoteFinalizedEpoch = status.getFinalizedEpoch();\n+    final UnsignedLong currentEpoch = compute_epoch_at_slot(storageClient.getBestSlot());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9270947856c1462d6275ddf70d74d541901f83e"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc0NzI0Ng==", "bodyText": "nit: It's probably simpler to say:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        && remoteFinalizedEpoch.compareTo(UnsignedLong.valueOf(Constants.GENESIS_EPOCH)) > 0);\n          \n          \n            \n                        && !remoteFinalizedEpoch.equals(UnsignedLong.valueOf(Constants.GENESIS_EPOCH)));\n          \n      \n    \n    \n  \n\nPossibly slightly more accurate too if GENESIS_BLOCK isn't actually 0.", "url": "https://github.com/ConsenSys/teku/pull/1098#discussion_r368747246", "createdAt": "2020-01-20T22:37:45Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/main/java/tech/pegasys/artemis/networking/eth2/peers/PeerChainValidator.java", "diffHunk": "@@ -128,6 +141,15 @@ public static PeerChainValidator create(\n     }\n   }\n \n+  private boolean remoteEpochIsInvalid(\n+      final UnsignedLong currentEpoch, final UnsignedLong remoteFinalizedEpoch) {\n+    // Remote finalized epoch is invalid if it is from the future\n+    return remoteFinalizedEpoch.compareTo(currentEpoch) > 0\n+        // Remote finalized epoch is invalid if is from the current epoch (unless we're at genesis)\n+        || (remoteFinalizedEpoch.compareTo(currentEpoch) == 0\n+            && remoteFinalizedEpoch.compareTo(UnsignedLong.valueOf(Constants.GENESIS_EPOCH)) > 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9270947856c1462d6275ddf70d74d541901f83e"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5d36fb13f45cd3491aa6ba324e69f95395f9259", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a5d36fb13f45cd3491aa6ba324e69f95395f9259", "committedDate": "2020-01-21T15:43:16Z", "message": "Simplify genesis epoch check\n\nCo-Authored-By: Adrian Sutton <adrian@symphonious.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49230180431e7c6c9c7b80062c5f31571b23f9d4", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/49230180431e7c6c9c7b80062c5f31571b23f9d4", "committedDate": "2020-01-21T16:06:37Z", "message": "Fix current epoch calculation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04cc66cd87e16bde5b8272c9f83aa2603384adbb", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/04cc66cd87e16bde5b8272c9f83aa2603384adbb", "committedDate": "2020-01-21T16:14:11Z", "message": "Merge branch 'master' into bc-221/reject-peers-w-invalid-finalized-epoch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTY1NDEz", "url": "https://github.com/ConsenSys/teku/pull/1098#pullrequestreview-346165413", "createdAt": "2020-01-21T20:21:24Z", "commit": {"oid": "04cc66cd87e16bde5b8272c9f83aa2603384adbb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4206, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}