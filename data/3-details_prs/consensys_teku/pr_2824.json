{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NTIwNzkx", "number": 2824, "title": "[Issue 2273] Use the wsCheckpoint during finalized checkpoint validation", "bodyText": "PR Description\nUse weakSubjectivityCheckpoint when validating the latest finalized checkpoint:\n\nIf the latest finalized checkpoint is prior to the ws checkpoint, defer validation\nIf the latest finalized checkpoint is at the ws checkpoint, make sure that the roots match\n\nFixed Issue(s)\nPart of #2273\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-09-18T20:16:00Z", "url": "https://github.com/ConsenSys/teku/pull/2824", "merged": true, "mergeCommit": {"oid": "c00839a209e6236e454dc95c8f5bd9e91630a236"}, "closed": true, "closedAt": "2020-09-21T19:14:25Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKLiHlABqjM3ODQxMTc5ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLINTBAH2gAyNDg5NTIwNzkxOjJiNmZiNTI1ZGUxYjI4NjA5NDIwNDc5MzljZmYwOGNkNzBjMjk3ZDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e1461a1e6b7c8dca9d34789957ab184b2b20e50", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/5e1461a1e6b7c8dca9d34789957ab184b2b20e50", "committedDate": "2020-09-18T20:06:48Z", "message": "Add extra check if latest finalized checkpoint is at wsCheckpoint epoch"}, "afterCommit": {"oid": "4f45bcb2bc06cb95cf1d30afd10e863b44f83a31", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/4f45bcb2bc06cb95cf1d30afd10e863b44f83a31", "committedDate": "2020-09-18T20:22:21Z", "message": "Add extra check if latest finalized checkpoint is at wsCheckpoint epoch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODE0NTY3", "url": "https://github.com/ConsenSys/teku/pull/2824#pullrequestreview-492814567", "createdAt": "2020-09-21T17:05:09Z", "commit": {"oid": "4f45bcb2bc06cb95cf1d30afd10e863b44f83a31"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNzowNTowOVrOHVaZjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNzowNTowOVrOHVaZjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNDY2OQ==", "bodyText": "nit: stale comment \"different root\"", "url": "https://github.com/ConsenSys/teku/pull/2824#discussion_r492214669", "createdAt": "2020-09-21T17:05:09Z", "author": {"login": "cemozerr"}, "path": "ethereum/weaksubjectivity/src/test/java/tech/pegasys/teku/weaksubjectivity/WeakSubjectivityValidatorTest.java", "diffHunk": "@@ -69,22 +127,73 @@ public void validateLatestFinalizedCheckpoint_validationShouldFail() {\n   }\n \n   @Test\n-  public void validateLatestFinalizedCheckpoint_validationShouldPass() {\n+  public void\n+      validateLatestFinalizedCheckpoint_withWSCheckpoint_shouldRunChecksWhenFinalizeAfterCheckpoint_shouldPass() {\n+    final Checkpoint wsCheckpoint =\n+        new Checkpoint(UInt64.valueOf(100), Bytes32.fromHexStringLenient(\"0x01\"));\n+    final WeakSubjectivityValidator validator =\n+        new WeakSubjectivityValidator(calculator, policies, Optional.of(wsCheckpoint));\n+    when(checkpointState.getEpoch()).thenReturn(wsCheckpoint.getEpoch().plus(1));\n     when(calculator.isWithinWeakSubjectivityPeriod(checkpointState, currentSlot)).thenReturn(true);\n \n     validator.validateLatestFinalizedCheckpoint(checkpointState, currentSlot);\n \n-    for (WeakSubjectivityViolationPolicy policy : policies) {\n-      orderedPolicyMocks\n-          .verify(policy, never())\n-          .onFinalizedCheckpointOutsideOfWeakSubjectivityPeriod(any(), anyInt(), any());\n-    }\n+    verify(calculator).isWithinWeakSubjectivityPeriod(checkpointState, currentSlot);\n+    orderedPolicyMocks.verifyNoMoreInteractions();\n+  }\n+\n+  @Test\n+  public void\n+      validateLatestFinalizedCheckpoint_withWSCheckpoint_shouldRunChecksWhenFinalizeAtCheckpoint_shouldFail() {\n+    final Checkpoint wsCheckpoint =\n+        new Checkpoint(UInt64.valueOf(100), Bytes32.fromHexStringLenient(\"0x01\"));\n+    final WeakSubjectivityValidator validator =\n+        new WeakSubjectivityValidator(calculator, policies, Optional.of(wsCheckpoint));\n \n+    final int validatorCount = 101;\n+    // Checkpoint is at the ws epoch, but has a different root\n+    when(checkpointState.getEpoch()).thenReturn(wsCheckpoint.getEpoch());\n+    when(checkpointState.getRoot()).thenReturn(Bytes32.fromHexStringLenient(\"0x02\"));\n+    when(calculator.isWithinWeakSubjectivityPeriod(checkpointState, currentSlot)).thenReturn(true);\n+    when(calculator.getActiveValidators(checkpointState.getState())).thenReturn(validatorCount);\n+\n+    validator.validateLatestFinalizedCheckpoint(checkpointState, currentSlot);\n+\n+    orderedPolicyMocks\n+        .verify(policies.get(0))\n+        .onFinalizedCheckpointOutsideOfWeakSubjectivityPeriod(\n+            checkpointState, validatorCount, currentSlot);\n+    orderedPolicyMocks\n+        .verify(policies.get(1))\n+        .onFinalizedCheckpointOutsideOfWeakSubjectivityPeriod(\n+            checkpointState, validatorCount, currentSlot);\n+\n+    orderedPolicyMocks.verifyNoMoreInteractions();\n+  }\n+\n+  @Test\n+  public void\n+      validateLatestFinalizedCheckpoint_withWSCheckpoint_shouldRunChecksWhenFinalizeAtCheckpoint_shouldPass() {\n+    final Checkpoint wsCheckpoint =\n+        new Checkpoint(UInt64.valueOf(100), Bytes32.fromHexStringLenient(\"0x01\"));\n+    final WeakSubjectivityValidator validator =\n+        new WeakSubjectivityValidator(calculator, policies, Optional.of(wsCheckpoint));\n+    // Checkpoint is at the ws epoch, with the same root different root", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f45bcb2bc06cb95cf1d30afd10e863b44f83a31"}, "originalPosition": 160}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODE0NjQ3", "url": "https://github.com/ConsenSys/teku/pull/2824#pullrequestreview-492814647", "createdAt": "2020-09-21T17:05:17Z", "commit": {"oid": "4f45bcb2bc06cb95cf1d30afd10e863b44f83a31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f397e02a176f8a98842bc68039f29ea9a4dda107", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f397e02a176f8a98842bc68039f29ea9a4dda107", "committedDate": "2020-09-21T19:00:12Z", "message": "Skip validation if checkpoint is older than weakSubjectivity checkpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eecabc12b9f6c36e9186b4800dcce09ce6ef45b8", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/eecabc12b9f6c36e9186b4800dcce09ce6ef45b8", "committedDate": "2020-09-21T19:00:12Z", "message": "Add extra check if latest finalized checkpoint is at wsCheckpoint epoch"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f45bcb2bc06cb95cf1d30afd10e863b44f83a31", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/4f45bcb2bc06cb95cf1d30afd10e863b44f83a31", "committedDate": "2020-09-18T20:22:21Z", "message": "Add extra check if latest finalized checkpoint is at wsCheckpoint epoch"}, "afterCommit": {"oid": "eecabc12b9f6c36e9186b4800dcce09ce6ef45b8", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/eecabc12b9f6c36e9186b4800dcce09ce6ef45b8", "committedDate": "2020-09-21T19:00:12Z", "message": "Add extra check if latest finalized checkpoint is at wsCheckpoint epoch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b6fb525de1b2860942047939cff08cd70c297d7", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/2b6fb525de1b2860942047939cff08cd70c297d7", "committedDate": "2020-09-21T19:04:10Z", "message": "Fix comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3445, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}