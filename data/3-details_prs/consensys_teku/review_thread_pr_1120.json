{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MzE0NDQ0", "number": 1120, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOToxMjo1NFrODbsD6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOTozMDo0NVrODbsZWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMzYwMDQzOnYy", "diffSide": "RIGHT", "path": "pow/src/main/java/tech/pegasys/artemis/pow/BatchByBlockDepositHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOToxMjo1NFrOFjUVJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMDoyMzoxNVrOFjWYEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU3NzU3Mw==", "bodyText": "I think this name is a bit confusing when paired with the very similar publishPendingBlock.  Not sure what would be better though.  Maybe:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private void publishCompletedBlocks(final EthBlock.Block newBlock) {\n          \n          \n            \n              private void handleNewBlock(final EthBlock.Block newBlock) {", "url": "https://github.com/ConsenSys/teku/pull/1120#discussion_r372577573", "createdAt": "2020-01-29T19:12:54Z", "author": {"login": "mbaxter"}, "path": "pow/src/main/java/tech/pegasys/artemis/pow/BatchByBlockDepositHandler.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.pow;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.web3j.protocol.core.methods.response.EthBlock;\n+import org.web3j.protocol.core.methods.response.EthBlock.Block;\n+import tech.pegasys.artemis.pow.event.Deposit;\n+import tech.pegasys.artemis.pow.event.DepositsFromBlockEvent;\n+\n+class BatchByBlockDepositHandler {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final Consumer<DepositsFromBlockEvent> eventConsumer;\n+  private Optional<Block> currentBlock = Optional.empty();\n+  private List<Deposit> deposits = new ArrayList<>();\n+\n+  BatchByBlockDepositHandler(final Consumer<DepositsFromBlockEvent> eventConsumer) {\n+    this.eventConsumer = eventConsumer;\n+  }\n+\n+  public synchronized void onDepositEvent(final EthBlock.Block block, final Deposit event) {\n+    LOG.trace(\n+        \"Received deposit from block {} with index {}\",\n+        block.getNumber(),\n+        event.getMerkle_tree_index());\n+    publishCompletedBlocks(block);\n+    deposits.add(event);\n+  }\n+\n+  public synchronized void publishPendingBlock() {\n+    currentBlock.ifPresent(\n+        block -> {\n+          publishPendingBlock(block);\n+          currentBlock = Optional.empty();\n+        });\n+  }\n+\n+  private void publishCompletedBlocks(final EthBlock.Block newBlock) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "426967ebecd8f43d324a1f0015ecf721a02de5ee"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYxMTA4OQ==", "bodyText": "Good point, I've renamed it to checkForCompletedBlocks since most of what it does is actually checking and tracking the current block.", "url": "https://github.com/ConsenSys/teku/pull/1120#discussion_r372611089", "createdAt": "2020-01-29T20:23:15Z", "author": {"login": "ajsutton"}, "path": "pow/src/main/java/tech/pegasys/artemis/pow/BatchByBlockDepositHandler.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.pow;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.web3j.protocol.core.methods.response.EthBlock;\n+import org.web3j.protocol.core.methods.response.EthBlock.Block;\n+import tech.pegasys.artemis.pow.event.Deposit;\n+import tech.pegasys.artemis.pow.event.DepositsFromBlockEvent;\n+\n+class BatchByBlockDepositHandler {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final Consumer<DepositsFromBlockEvent> eventConsumer;\n+  private Optional<Block> currentBlock = Optional.empty();\n+  private List<Deposit> deposits = new ArrayList<>();\n+\n+  BatchByBlockDepositHandler(final Consumer<DepositsFromBlockEvent> eventConsumer) {\n+    this.eventConsumer = eventConsumer;\n+  }\n+\n+  public synchronized void onDepositEvent(final EthBlock.Block block, final Deposit event) {\n+    LOG.trace(\n+        \"Received deposit from block {} with index {}\",\n+        block.getNumber(),\n+        event.getMerkle_tree_index());\n+    publishCompletedBlocks(block);\n+    deposits.add(event);\n+  }\n+\n+  public synchronized void publishPendingBlock() {\n+    currentBlock.ifPresent(\n+        block -> {\n+          publishPendingBlock(block);\n+          currentBlock = Optional.empty();\n+        });\n+  }\n+\n+  private void publishCompletedBlocks(final EthBlock.Block newBlock) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU3NzU3Mw=="}, "originalCommit": {"oid": "426967ebecd8f43d324a1f0015ecf721a02de5ee"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMzYxMDcwOnYy", "diffSide": "RIGHT", "path": "pow/src/main/java/tech/pegasys/artemis/pow/BatchByBlockDepositHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOToxNjoxNVrOFjUbbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMDoyMzoyMFrOFjWYMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU3OTE4Mg==", "bodyText": "(optional) Might be safer to move this line into publishPendingBlock", "url": "https://github.com/ConsenSys/teku/pull/1120#discussion_r372579182", "createdAt": "2020-01-29T19:16:15Z", "author": {"login": "mbaxter"}, "path": "pow/src/main/java/tech/pegasys/artemis/pow/BatchByBlockDepositHandler.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.pow;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.web3j.protocol.core.methods.response.EthBlock;\n+import org.web3j.protocol.core.methods.response.EthBlock.Block;\n+import tech.pegasys.artemis.pow.event.Deposit;\n+import tech.pegasys.artemis.pow.event.DepositsFromBlockEvent;\n+\n+class BatchByBlockDepositHandler {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final Consumer<DepositsFromBlockEvent> eventConsumer;\n+  private Optional<Block> currentBlock = Optional.empty();\n+  private List<Deposit> deposits = new ArrayList<>();\n+\n+  BatchByBlockDepositHandler(final Consumer<DepositsFromBlockEvent> eventConsumer) {\n+    this.eventConsumer = eventConsumer;\n+  }\n+\n+  public synchronized void onDepositEvent(final EthBlock.Block block, final Deposit event) {\n+    LOG.trace(\n+        \"Received deposit from block {} with index {}\",\n+        block.getNumber(),\n+        event.getMerkle_tree_index());\n+    publishCompletedBlocks(block);\n+    deposits.add(event);\n+  }\n+\n+  public synchronized void publishPendingBlock() {\n+    currentBlock.ifPresent(\n+        block -> {\n+          publishPendingBlock(block);\n+          currentBlock = Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "426967ebecd8f43d324a1f0015ecf721a02de5ee"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYxMTEyMQ==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/1120#discussion_r372611121", "createdAt": "2020-01-29T20:23:20Z", "author": {"login": "ajsutton"}, "path": "pow/src/main/java/tech/pegasys/artemis/pow/BatchByBlockDepositHandler.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.pow;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.web3j.protocol.core.methods.response.EthBlock;\n+import org.web3j.protocol.core.methods.response.EthBlock.Block;\n+import tech.pegasys.artemis.pow.event.Deposit;\n+import tech.pegasys.artemis.pow.event.DepositsFromBlockEvent;\n+\n+class BatchByBlockDepositHandler {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final Consumer<DepositsFromBlockEvent> eventConsumer;\n+  private Optional<Block> currentBlock = Optional.empty();\n+  private List<Deposit> deposits = new ArrayList<>();\n+\n+  BatchByBlockDepositHandler(final Consumer<DepositsFromBlockEvent> eventConsumer) {\n+    this.eventConsumer = eventConsumer;\n+  }\n+\n+  public synchronized void onDepositEvent(final EthBlock.Block block, final Deposit event) {\n+    LOG.trace(\n+        \"Received deposit from block {} with index {}\",\n+        block.getNumber(),\n+        event.getMerkle_tree_index());\n+    publishCompletedBlocks(block);\n+    deposits.add(event);\n+  }\n+\n+  public synchronized void publishPendingBlock() {\n+    currentBlock.ifPresent(\n+        block -> {\n+          publishPendingBlock(block);\n+          currentBlock = Optional.empty();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU3OTE4Mg=="}, "originalCommit": {"oid": "426967ebecd8f43d324a1f0015ecf721a02de5ee"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMzY1NTI5OnYy", "diffSide": "RIGHT", "path": "pow/src/main/java/tech/pegasys/artemis/pow/DepositContractListener.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxOTozMDo0NVrOFjU32g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMDoyMjoyNFrOFjWWsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU4NjQ1OA==", "bodyText": "Doesn't look like we're handling reorgs where events might be removed, but I guess that's covered in the follow-up ticket we have to respect the follow distance?", "url": "https://github.com/ConsenSys/teku/pull/1120#discussion_r372586458", "createdAt": "2020-01-29T19:30:45Z", "author": {"login": "mbaxter"}, "path": "pow/src/main/java/tech/pegasys/artemis/pow/DepositContractListener.java", "diffHunk": "@@ -61,13 +65,11 @@ public DepositContractListener(Web3j web3j, EventBus eventBus, DepositContract c\n     subscriptionNewDeposit =\n         contract\n             .depositEventEventFlowable(depositEventFilter)\n-            .flatMap(this::convertToDeposit)\n-            .subscribe(eventBus::post);\n-  }\n-\n-  private Flowable<Deposit> convertToDeposit(final DepositEventEventResponse event) {\n-    return getBlockByHash(event.log.getBlockHash())\n-        .map(block -> new Deposit(event, UnsignedLong.valueOf(block.getTimestamp())));\n+            .flatMap(\n+                event ->\n+                    getBlockByHash(event.log.getBlockHash())\n+                        .map(block -> Pair.of(block, new Deposit(event))))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "426967ebecd8f43d324a1f0015ecf721a02de5ee"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU5MTUxMA==", "bodyText": "If we're ultimately going to have to buffer eth1 event sets based on the follow distance, is PublishOnInactivityDepositHandler going to eventually go away?", "url": "https://github.com/ConsenSys/teku/pull/1120#discussion_r372591510", "createdAt": "2020-01-29T19:40:56Z", "author": {"login": "mbaxter"}, "path": "pow/src/main/java/tech/pegasys/artemis/pow/DepositContractListener.java", "diffHunk": "@@ -61,13 +65,11 @@ public DepositContractListener(Web3j web3j, EventBus eventBus, DepositContract c\n     subscriptionNewDeposit =\n         contract\n             .depositEventEventFlowable(depositEventFilter)\n-            .flatMap(this::convertToDeposit)\n-            .subscribe(eventBus::post);\n-  }\n-\n-  private Flowable<Deposit> convertToDeposit(final DepositEventEventResponse event) {\n-    return getBlockByHash(event.log.getBlockHash())\n-        .map(block -> new Deposit(event, UnsignedLong.valueOf(block.getTimestamp())));\n+            .flatMap(\n+                event ->\n+                    getBlockByHash(event.log.getBlockHash())\n+                        .map(block -> Pair.of(block, new Deposit(event))))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU4NjQ1OA=="}, "originalCommit": {"oid": "426967ebecd8f43d324a1f0015ecf721a02de5ee"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjYxMDczNg==", "bodyText": "Yeah, deliberately ignoring forks for now - I'm not sure how it will all play out yet but dealing with forks and the follow distance feel like they need to be sorted out together.\nWe will still need PublishOnInactivityDepositHandler though because it's possible, and maybe even likely, that we'd go at least 1024 blocks without a new deposit.", "url": "https://github.com/ConsenSys/teku/pull/1120#discussion_r372610736", "createdAt": "2020-01-29T20:22:24Z", "author": {"login": "ajsutton"}, "path": "pow/src/main/java/tech/pegasys/artemis/pow/DepositContractListener.java", "diffHunk": "@@ -61,13 +65,11 @@ public DepositContractListener(Web3j web3j, EventBus eventBus, DepositContract c\n     subscriptionNewDeposit =\n         contract\n             .depositEventEventFlowable(depositEventFilter)\n-            .flatMap(this::convertToDeposit)\n-            .subscribe(eventBus::post);\n-  }\n-\n-  private Flowable<Deposit> convertToDeposit(final DepositEventEventResponse event) {\n-    return getBlockByHash(event.log.getBlockHash())\n-        .map(block -> new Deposit(event, UnsignedLong.valueOf(block.getTimestamp())));\n+            .flatMap(\n+                event ->\n+                    getBlockByHash(event.log.getBlockHash())\n+                        .map(block -> Pair.of(block, new Deposit(event))))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU4NjQ1OA=="}, "originalCommit": {"oid": "426967ebecd8f43d324a1f0015ecf721a02de5ee"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2818, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}