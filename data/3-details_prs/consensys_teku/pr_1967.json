{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMDAwMjE5", "number": 1967, "title": "added rest-api-host-whitelist", "bodyText": "Signed-off-by: Sally MacFarlane sally.macfarlane@consensys.net\nadded option for rest api host whitelist", "createdAt": "2020-05-26T05:56:18Z", "url": "https://github.com/ConsenSys/teku/pull/1967", "merged": true, "mergeCommit": {"oid": "95162ac959052d3fac6d6dc35b1c99796209a89b"}, "closed": true, "closedAt": "2020-05-27T19:37:07Z", "author": {"login": "macfarla"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABck9qKWgH2gAyNDIzMDAwMjE5Ojg4YzhlMjA0MjIxNzkxYzJhMTkwMTkwNDZkYzVkOGFhYjZiODk2ZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcleQxUgH2gAyNDIzMDAwMjE5OmE5N2I0YTI0N2RmZWVhZGZmNDUzNTAyYjQ4MzZkZGM5MjE5NzRmNjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "88c8e204221791c2a19019046dc5d8aab6b896f0", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/ConsenSys/teku/commit/88c8e204221791c2a19019046dc5d8aab6b896f0", "committedDate": "2020-05-26T05:17:37Z", "message": "added rest-api-host-whitelist\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8272a0fcf9d885e23303bc9829d50ba117d1a234", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/ConsenSys/teku/commit/8272a0fcf9d885e23303bc9829d50ba117d1a234", "committedDate": "2020-05-26T05:57:24Z", "message": "removed debug\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/ConsenSys/teku/commit/6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b", "committedDate": "2020-05-26T06:21:01Z", "message": "integration test setup\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Njg4NTI2", "url": "https://github.com/ConsenSys/teku/pull/1967#pullrequestreview-418688526", "createdAt": "2020-05-26T21:21:48Z", "commit": {"oid": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToyMTo0OVrOGaww9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToyMTo0OVrOGaww9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxNTEyNw==", "bodyText": "whitelisting is more of a 'business as usual', i'd leave the log statement as debug.\nAlso, i can't see any test cases exercising any of this logic...\n\ndoes substring get me around the logic (my.host allowing my.)\ndoes it actually block me if i'm not in the list\ndoes star let me in\ndoes my ip / hostname let me in\n\nThis may have to be slightly restructured to allow testing to happen cleanly... but it shouldn't be huge, just let me know if you need a hand.", "url": "https://github.com/ConsenSys/teku/pull/1967#discussion_r430715127", "createdAt": "2020-05-26T21:21:49Z", "author": {"login": "rolfyone"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/BeaconRestApi.java", "diffHunk": "@@ -82,6 +89,38 @@ private void initialize(final DataProvider dataProvider, final TekuConfiguration\n     addCustomErrorPages(configuration);\n   }\n \n+  private void addHostWhitelistHandler(final TekuConfiguration configuration) {\n+    app.before(\n+        (ctx) -> {\n+          String header = ctx.header(\"host\");\n+          Optional<String> optionalHost = getAndValidateHostHeader(header);\n+          if (!configuration.getRestApiHostWhitelist().contains(\"*\")\n+              && (!optionalHost.isPresent()\n+                  || !hostIsInWhitelist(configuration, optionalHost.get()))) {\n+            ctx.status(SC_FORBIDDEN);\n+            LOG.info(\"Host not authorized \" + optionalHost);\n+          }\n+        });\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Njg5MTg1", "url": "https://github.com/ConsenSys/teku/pull/1967#pullrequestreview-418689185", "createdAt": "2020-05-26T21:22:54Z", "commit": {"oid": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToyMjo1NVrOGawzEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMToyMjo1NVrOGawzEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxNTY2NA==", "bodyText": "these should be defaults, did the tests not work without it? that would be a concern...", "url": "https://github.com/ConsenSys/teku/pull/1967#discussion_r430715664", "createdAt": "2020-05-26T21:22:55Z", "author": {"login": "rolfyone"}, "path": "teku/src/test/java/tech/pegasys/teku/cli/BeaconNodeCommandTest.java", "diffHunk": "@@ -306,7 +306,8 @@ private TekuConfigurationBuilder expectedConfigurationBuilder() {\n         .setRestApiPort(5051)\n         .setRestApiDocsEnabled(false)\n         .setRestApiEnabled(false)\n-        .setRestApiInterface(\"127.0.0.1\");\n+        .setRestApiInterface(\"127.0.0.1\")\n+        .setRestApiHostWhitelist(List.of(\"127.0.0.1\", \"localhost\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Njk3NzQy", "url": "https://github.com/ConsenSys/teku/pull/1967#pullrequestreview-418697742", "createdAt": "2020-05-26T21:37:59Z", "commit": {"oid": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMTozNzo1OVrOGaxNTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMTozNzo1OVrOGaxNTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyMjM4Mw==", "bodyText": "we could actually have another test alongside these that creates a config with different elements int he whitelist to show it working for real if we wanted to...", "url": "https://github.com/ConsenSys/teku/pull/1967#discussion_r430722383", "createdAt": "2020-05-26T21:37:59Z", "author": {"login": "rolfyone"}, "path": "data/beaconrestapi/src/integration-test/java/tech/pegasys/teku/beaconrestapi/AbstractBeaconRestAPIIntegrationTest.java", "diffHunk": "@@ -46,7 +47,11 @@\n public abstract class AbstractBeaconRestAPIIntegrationTest {\n   static final okhttp3.MediaType JSON = okhttp3.MediaType.parse(\"application/json; charset=utf-8\");\n   static final TekuConfiguration config =\n-      TekuConfiguration.builder().setRestApiPort(0).setRestApiDocsEnabled(false).build();\n+      TekuConfiguration.builder()\n+          .setRestApiPort(0)\n+          .setRestApiDocsEnabled(false)\n+          .setRestApiHostWhitelist(List.of(\"127.0.0.1\", \"localhost\"))\n+          .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33503c9dfdc9f6bbdab57ad4f86353076af9c82b", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/ConsenSys/teku/commit/33503c9dfdc9f6bbdab57ad4f86353076af9c82b", "committedDate": "2020-05-26T23:19:49Z", "message": "logging\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97e42177b895118d5a05088796488018286fdba4", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/ConsenSys/teku/commit/97e42177b895118d5a05088796488018286fdba4", "committedDate": "2020-05-27T01:24:40Z", "message": "refactoring and tests\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3398983e984a8bb791843bd65f91ce6e06cf7a7", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/ConsenSys/teku/commit/e3398983e984a8bb791843bd65f91ce6e06cf7a7", "committedDate": "2020-05-27T01:24:51Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into rest-api-host-whitelist"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODI0OTEy", "url": "https://github.com/ConsenSys/teku/pull/1967#pullrequestreview-418824912", "createdAt": "2020-05-27T03:00:02Z", "commit": {"oid": "e3398983e984a8bb791843bd65f91ce6e06cf7a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d74ef2c7af6551c80e29f3fa7d29c4fc49cf9075", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/ConsenSys/teku/commit/d74ef2c7af6551c80e29f3fa7d29c4fc49cf9075", "committedDate": "2020-05-27T05:23:20Z", "message": "Merge branch 'master' into rest-api-host-whitelist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a97b4a247dfeeadff453502b4836ddc921974f65", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/ConsenSys/teku/commit/a97b4a247dfeeadff453502b4836ddc921974f65", "committedDate": "2020-05-27T19:16:45Z", "message": "Merge branch 'master' into rest-api-host-whitelist"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4036, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}