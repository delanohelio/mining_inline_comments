{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NzU5NTg3", "number": 1793, "title": "Initialize hotRootsBySlotCache on startup", "bodyText": "PR Description\nInitialize hotRootsBySlotCache on startup so that we don't miss blocks to prune.", "createdAt": "2020-05-15T19:14:48Z", "url": "https://github.com/ConsenSys/teku/pull/1793", "merged": true, "mergeCommit": {"oid": "b27f1c778f8ff91519977aeaca8f8cbe51699e43"}, "closed": true, "closedAt": "2020-05-16T17:09:39Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchm3HzgH2gAyNDE4NzU5NTg3OjkxYmVlZDhlNGE3NzY4OTk0ZmU0NThiYjlmNGM5ODcwNWE3NzIyNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcht9ycAH2gAyNDE4NzU5NTg3OmE3ZjZkZjcxNzM5MDcxNDU1NjRmNTdmYjQ3NjIzOGQ4ZjA0Yjk0ZDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "91beed8e4a7768994fe458bb9f4c98705a772260", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/91beed8e4a7768994fe458bb9f4c98705a772260", "committedDate": "2020-05-15T19:02:11Z", "message": "Initialize hotRootsBySlotCache on startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/6df092128dded96890614f9f672ac4268cbfadfd", "committedDate": "2020-05-15T20:40:34Z", "message": "Merge branch 'master' into fixDBHotRootsBySlotCacheInitialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMDEyMDQ4", "url": "https://github.com/ConsenSys/teku/pull/1793#pullrequestreview-413012048", "createdAt": "2020-05-15T23:06:55Z", "commit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzowNjo1NVrOGWWB1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzoxNjozMlrOGWWJrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4Mjc3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(\n          \n          \n            \n              public void shouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426082774", "createdAt": "2020-05-15T23:06:55Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -51,6 +55,18 @@ public void shouldHandleRestartWithUnrecoverableForkBlocks_prune(@TempDir final\n     testShouldHandleRestartWithUnrecoverableForkBlocks(tempDir, StateStorageMode.PRUNE);\n   }\n \n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4MjgxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(\n          \n          \n            \n              public void shouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426082814", "createdAt": "2020-05-15T23:07:05Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -51,6 +55,18 @@ public void shouldHandleRestartWithUnrecoverableForkBlocks_prune(@TempDir final\n     testShouldHandleRestartWithUnrecoverableForkBlocks(tempDir, StateStorageMode.PRUNE);\n   }\n \n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(\n+      @TempDir final Path tempDir) throws Exception {\n+    testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(tempDir, StateStorageMode.ARCHIVE);\n+  }\n+\n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4Mzc4NQ==", "bodyText": "This doesn't take a lot of time, so I don't think it's really worth logging the start / end of the cache initialization.", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426083785", "createdAt": "2020-05-15T23:11:54Z", "author": {"login": "mbaxter"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V3RocksDbDao.java", "diffHunk": "@@ -173,11 +174,33 @@ private void initialize() {\n     }\n \n     LOG.info(\"Initializing hot states from hot blocks\");\n-    initializeHotStates(finalizedRoot.get(), finalizedState.get(), hotBlocksByRoot);\n+    final Map<Bytes32, SignedBeaconBlock> prunedHotBlocks =\n+        initializeHotStatesAndBlocks(finalizedRoot.get(), finalizedState.get(), hotBlocksByRoot);\n     LOG.info(\"Finished initializing hot states from hot blocks\");\n+\n+    LOG.info(\"Adding hot roots to cache ordered by slots\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDIzMg==", "bodyText": "Stale comment\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Primary chain's next block is at 7", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426084232", "createdAt": "2020-05-15T23:13:57Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDM1MQ==", "bodyText": "Stale comment\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Finalize at slot 15, so all the blocks before 15 would need to be pruned.", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426084351", "createdAt": "2020-05-15T23:14:34Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7\n+    chain.generateBlocksUpToSlot(10);\n+\n+    // Setup database\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+    store = Store.getForkChoiceStore(genesis.getState());\n+    database.storeGenesis(store);\n+\n+    // Finalize at slot 15, so all the blocks before 15 would need to be pruned.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDc4MA==", "bodyText": "Stale comment\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Old states should be unavailable", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426084780", "createdAt": "2020-05-15T23:16:32Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7\n+    chain.generateBlocksUpToSlot(10);\n+\n+    // Setup database\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+    store = Store.getForkChoiceStore(genesis.getState());\n+    database.storeGenesis(store);\n+\n+    // Finalize at slot 15, so all the blocks before 15 would need to be pruned.\n+    add(chain.streamBlocksAndStates().collect(Collectors.toSet()));\n+\n+    // Close database and rebuild from disk\n+    database.close();\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+\n+    final Checkpoint finalizedCheckpoint = getCheckpointForBlock(chain.getBlockAtSlot(7));\n+    finalizeCheckpoint(finalizedCheckpoint);\n+\n+    // We should be able to access hot blocks and state\n+    final List<SignedBlockAndState> expectedHotBlocksAndStates =\n+        chain.streamBlocksAndStates(7, 10).collect(toList());\n+    assertHotBlocksAndStatesInclude(expectedHotBlocksAndStates);\n+\n+    // Old states should be unavailable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4ef6d33bb12af282d52967f4a34388f55b71d34", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/f4ef6d33bb12af282d52967f4a34388f55b71d34", "committedDate": "2020-05-16T03:04:51Z", "message": "Rename test methods & remove stale comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7f6df7173907145564f57fb476238d8f04b94d0", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/a7f6df7173907145564f57fb476238d8f04b94d0", "committedDate": "2020-05-16T03:18:48Z", "message": "Merge branch 'master' into fixDBHotRootsBySlotCacheInitialization"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4201, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}