{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3OTU5MTk5", "number": 3047, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMjowNzo1MFrOEwkVAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMjoxMTo0MlrOEwkX7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MzYyMzA1OnYy", "diffSide": "RIGHT", "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/v1/beacon/GetBlockHeaders.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMjowNzo1MFrOHmN9lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMzowNjo1OVrOHmO7gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgzNjY5NA==", "bodyText": "While not particularly useful, it's probably more typical to accept both params and treat it as an AND condition - so return only blocks at the specified slot with the specified parent root.", "url": "https://github.com/ConsenSys/teku/pull/3047#discussion_r509836694", "createdAt": "2020-10-22T02:07:50Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/v1/beacon/GetBlockHeaders.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.v1.beacon;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.PARENT_ROOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.SLOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.TAG_V1_BEACON;\n+\n+import com.google.common.base.Throwables;\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiParam;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.teku.api.ChainDataProvider;\n+import tech.pegasys.teku.api.DataProvider;\n+import tech.pegasys.teku.api.response.v1.beacon.GetBlockHeadersResponse;\n+import tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils;\n+import tech.pegasys.teku.beaconrestapi.handlers.AbstractHandler;\n+import tech.pegasys.teku.beaconrestapi.schema.BadRequest;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.provider.JsonProvider;\n+\n+public class GetBlockHeaders extends AbstractHandler implements Handler {\n+  public static final String ROUTE = \"/eth/v1/beacon/headers\";\n+  private final ChainDataProvider chainDataProvider;\n+\n+  public GetBlockHeaders(final DataProvider dataProvider, final JsonProvider jsonProvider) {\n+    this(dataProvider.getChainDataProvider(), jsonProvider);\n+  }\n+\n+  public GetBlockHeaders(\n+      final ChainDataProvider chainDataProvider, final JsonProvider jsonProvider) {\n+    super(jsonProvider);\n+    this.chainDataProvider = chainDataProvider;\n+  }\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Get block headers\",\n+      tags = {TAG_V1_BEACON},\n+      description =\n+          \"Retrieves block headers matching given query. By default it will fetch current head slot blocks.\",\n+      queryParams = {\n+        @OpenApiParam(name = SLOT),\n+        @OpenApiParam(name = PARENT_ROOT, description = \"Not currently supported.\")\n+      },\n+      responses = {\n+        @OpenApiResponse(\n+            status = RES_OK,\n+            content = @OpenApiContent(from = GetBlockHeadersResponse.class)),\n+        @OpenApiResponse(status = RES_BAD_REQUEST),\n+        @OpenApiResponse(status = RES_INTERNAL_ERROR)\n+      })\n+  @Override\n+  public void handle(@NotNull final Context ctx) throws Exception {\n+    final Map<String, List<String>> queryParameters = ctx.queryParamMap();\n+\n+    final Optional<Bytes32> parentRoot =\n+        SingleQueryParameterUtils.getParameterValueAsBytes32IfPresent(queryParameters, PARENT_ROOT);\n+    final Optional<UInt64> slot =\n+        SingleQueryParameterUtils.getParameterValueAsUInt64IfPresent(queryParameters, SLOT);\n+\n+    if (parentRoot.isPresent() && slot.isPresent()) {\n+      ctx.status(SC_BAD_REQUEST);\n+      ctx.result(\n+          BadRequest.badRequest(\n+              jsonProvider, \"Either supply parent_root, slot, or neither, but not both.\"));\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e09e1ab1c01336d8866bd48684682ef28f2980ae"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg0MTc3Mg==", "bodyText": "the spec was super poorly defined... though we could do that, i'd probably just search on slot given our data structures?", "url": "https://github.com/ConsenSys/teku/pull/3047#discussion_r509841772", "createdAt": "2020-10-22T02:26:39Z", "author": {"login": "rolfyone"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/v1/beacon/GetBlockHeaders.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.v1.beacon;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.PARENT_ROOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.SLOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.TAG_V1_BEACON;\n+\n+import com.google.common.base.Throwables;\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiParam;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.teku.api.ChainDataProvider;\n+import tech.pegasys.teku.api.DataProvider;\n+import tech.pegasys.teku.api.response.v1.beacon.GetBlockHeadersResponse;\n+import tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils;\n+import tech.pegasys.teku.beaconrestapi.handlers.AbstractHandler;\n+import tech.pegasys.teku.beaconrestapi.schema.BadRequest;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.provider.JsonProvider;\n+\n+public class GetBlockHeaders extends AbstractHandler implements Handler {\n+  public static final String ROUTE = \"/eth/v1/beacon/headers\";\n+  private final ChainDataProvider chainDataProvider;\n+\n+  public GetBlockHeaders(final DataProvider dataProvider, final JsonProvider jsonProvider) {\n+    this(dataProvider.getChainDataProvider(), jsonProvider);\n+  }\n+\n+  public GetBlockHeaders(\n+      final ChainDataProvider chainDataProvider, final JsonProvider jsonProvider) {\n+    super(jsonProvider);\n+    this.chainDataProvider = chainDataProvider;\n+  }\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Get block headers\",\n+      tags = {TAG_V1_BEACON},\n+      description =\n+          \"Retrieves block headers matching given query. By default it will fetch current head slot blocks.\",\n+      queryParams = {\n+        @OpenApiParam(name = SLOT),\n+        @OpenApiParam(name = PARENT_ROOT, description = \"Not currently supported.\")\n+      },\n+      responses = {\n+        @OpenApiResponse(\n+            status = RES_OK,\n+            content = @OpenApiContent(from = GetBlockHeadersResponse.class)),\n+        @OpenApiResponse(status = RES_BAD_REQUEST),\n+        @OpenApiResponse(status = RES_INTERNAL_ERROR)\n+      })\n+  @Override\n+  public void handle(@NotNull final Context ctx) throws Exception {\n+    final Map<String, List<String>> queryParameters = ctx.queryParamMap();\n+\n+    final Optional<Bytes32> parentRoot =\n+        SingleQueryParameterUtils.getParameterValueAsBytes32IfPresent(queryParameters, PARENT_ROOT);\n+    final Optional<UInt64> slot =\n+        SingleQueryParameterUtils.getParameterValueAsUInt64IfPresent(queryParameters, SLOT);\n+\n+    if (parentRoot.isPresent() && slot.isPresent()) {\n+      ctx.status(SC_BAD_REQUEST);\n+      ctx.result(\n+          BadRequest.badRequest(\n+              jsonProvider, \"Either supply parent_root, slot, or neither, but not both.\"));\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgzNjY5NA=="}, "originalCommit": {"oid": "e09e1ab1c01336d8866bd48684682ef28f2980ae"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg0MjkyNQ==", "bodyText": "Yeah, search on slot then filter to check it matches the parentRoot supplied.", "url": "https://github.com/ConsenSys/teku/pull/3047#discussion_r509842925", "createdAt": "2020-10-22T02:30:54Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/v1/beacon/GetBlockHeaders.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.v1.beacon;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.PARENT_ROOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.SLOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.TAG_V1_BEACON;\n+\n+import com.google.common.base.Throwables;\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiParam;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.teku.api.ChainDataProvider;\n+import tech.pegasys.teku.api.DataProvider;\n+import tech.pegasys.teku.api.response.v1.beacon.GetBlockHeadersResponse;\n+import tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils;\n+import tech.pegasys.teku.beaconrestapi.handlers.AbstractHandler;\n+import tech.pegasys.teku.beaconrestapi.schema.BadRequest;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.provider.JsonProvider;\n+\n+public class GetBlockHeaders extends AbstractHandler implements Handler {\n+  public static final String ROUTE = \"/eth/v1/beacon/headers\";\n+  private final ChainDataProvider chainDataProvider;\n+\n+  public GetBlockHeaders(final DataProvider dataProvider, final JsonProvider jsonProvider) {\n+    this(dataProvider.getChainDataProvider(), jsonProvider);\n+  }\n+\n+  public GetBlockHeaders(\n+      final ChainDataProvider chainDataProvider, final JsonProvider jsonProvider) {\n+    super(jsonProvider);\n+    this.chainDataProvider = chainDataProvider;\n+  }\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Get block headers\",\n+      tags = {TAG_V1_BEACON},\n+      description =\n+          \"Retrieves block headers matching given query. By default it will fetch current head slot blocks.\",\n+      queryParams = {\n+        @OpenApiParam(name = SLOT),\n+        @OpenApiParam(name = PARENT_ROOT, description = \"Not currently supported.\")\n+      },\n+      responses = {\n+        @OpenApiResponse(\n+            status = RES_OK,\n+            content = @OpenApiContent(from = GetBlockHeadersResponse.class)),\n+        @OpenApiResponse(status = RES_BAD_REQUEST),\n+        @OpenApiResponse(status = RES_INTERNAL_ERROR)\n+      })\n+  @Override\n+  public void handle(@NotNull final Context ctx) throws Exception {\n+    final Map<String, List<String>> queryParameters = ctx.queryParamMap();\n+\n+    final Optional<Bytes32> parentRoot =\n+        SingleQueryParameterUtils.getParameterValueAsBytes32IfPresent(queryParameters, PARENT_ROOT);\n+    final Optional<UInt64> slot =\n+        SingleQueryParameterUtils.getParameterValueAsUInt64IfPresent(queryParameters, SLOT);\n+\n+    if (parentRoot.isPresent() && slot.isPresent()) {\n+      ctx.status(SC_BAD_REQUEST);\n+      ctx.result(\n+          BadRequest.badRequest(\n+              jsonProvider, \"Either supply parent_root, slot, or neither, but not both.\"));\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgzNjY5NA=="}, "originalCommit": {"oid": "e09e1ab1c01336d8866bd48684682ef28f2980ae"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg0MzE4NQ==", "bodyText": "Interesting question if the API is supposed to always default a head slot actually.  Maybe if you specify just parentRoot it should return blocks for the head slot that have the specified parent root which would be an awful lot easier to implement.  Not sure it means that but worth logging and issue to get it clarified and the docs updated.", "url": "https://github.com/ConsenSys/teku/pull/3047#discussion_r509843185", "createdAt": "2020-10-22T02:31:52Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/v1/beacon/GetBlockHeaders.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.v1.beacon;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.PARENT_ROOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.SLOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.TAG_V1_BEACON;\n+\n+import com.google.common.base.Throwables;\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiParam;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.teku.api.ChainDataProvider;\n+import tech.pegasys.teku.api.DataProvider;\n+import tech.pegasys.teku.api.response.v1.beacon.GetBlockHeadersResponse;\n+import tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils;\n+import tech.pegasys.teku.beaconrestapi.handlers.AbstractHandler;\n+import tech.pegasys.teku.beaconrestapi.schema.BadRequest;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.provider.JsonProvider;\n+\n+public class GetBlockHeaders extends AbstractHandler implements Handler {\n+  public static final String ROUTE = \"/eth/v1/beacon/headers\";\n+  private final ChainDataProvider chainDataProvider;\n+\n+  public GetBlockHeaders(final DataProvider dataProvider, final JsonProvider jsonProvider) {\n+    this(dataProvider.getChainDataProvider(), jsonProvider);\n+  }\n+\n+  public GetBlockHeaders(\n+      final ChainDataProvider chainDataProvider, final JsonProvider jsonProvider) {\n+    super(jsonProvider);\n+    this.chainDataProvider = chainDataProvider;\n+  }\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Get block headers\",\n+      tags = {TAG_V1_BEACON},\n+      description =\n+          \"Retrieves block headers matching given query. By default it will fetch current head slot blocks.\",\n+      queryParams = {\n+        @OpenApiParam(name = SLOT),\n+        @OpenApiParam(name = PARENT_ROOT, description = \"Not currently supported.\")\n+      },\n+      responses = {\n+        @OpenApiResponse(\n+            status = RES_OK,\n+            content = @OpenApiContent(from = GetBlockHeadersResponse.class)),\n+        @OpenApiResponse(status = RES_BAD_REQUEST),\n+        @OpenApiResponse(status = RES_INTERNAL_ERROR)\n+      })\n+  @Override\n+  public void handle(@NotNull final Context ctx) throws Exception {\n+    final Map<String, List<String>> queryParameters = ctx.queryParamMap();\n+\n+    final Optional<Bytes32> parentRoot =\n+        SingleQueryParameterUtils.getParameterValueAsBytes32IfPresent(queryParameters, PARENT_ROOT);\n+    final Optional<UInt64> slot =\n+        SingleQueryParameterUtils.getParameterValueAsUInt64IfPresent(queryParameters, SLOT);\n+\n+    if (parentRoot.isPresent() && slot.isPresent()) {\n+      ctx.status(SC_BAD_REQUEST);\n+      ctx.result(\n+          BadRequest.badRequest(\n+              jsonProvider, \"Either supply parent_root, slot, or neither, but not both.\"));\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgzNjY5NA=="}, "originalCommit": {"oid": "e09e1ab1c01336d8866bd48684682ef28f2980ae"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg1MjU0Nw==", "bodyText": "raised on the API ethereum/beacon-APIs#103", "url": "https://github.com/ConsenSys/teku/pull/3047#discussion_r509852547", "createdAt": "2020-10-22T03:06:59Z", "author": {"login": "rolfyone"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/v1/beacon/GetBlockHeaders.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.v1.beacon;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.PARENT_ROOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.SLOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.TAG_V1_BEACON;\n+\n+import com.google.common.base.Throwables;\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiParam;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.teku.api.ChainDataProvider;\n+import tech.pegasys.teku.api.DataProvider;\n+import tech.pegasys.teku.api.response.v1.beacon.GetBlockHeadersResponse;\n+import tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils;\n+import tech.pegasys.teku.beaconrestapi.handlers.AbstractHandler;\n+import tech.pegasys.teku.beaconrestapi.schema.BadRequest;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.provider.JsonProvider;\n+\n+public class GetBlockHeaders extends AbstractHandler implements Handler {\n+  public static final String ROUTE = \"/eth/v1/beacon/headers\";\n+  private final ChainDataProvider chainDataProvider;\n+\n+  public GetBlockHeaders(final DataProvider dataProvider, final JsonProvider jsonProvider) {\n+    this(dataProvider.getChainDataProvider(), jsonProvider);\n+  }\n+\n+  public GetBlockHeaders(\n+      final ChainDataProvider chainDataProvider, final JsonProvider jsonProvider) {\n+    super(jsonProvider);\n+    this.chainDataProvider = chainDataProvider;\n+  }\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Get block headers\",\n+      tags = {TAG_V1_BEACON},\n+      description =\n+          \"Retrieves block headers matching given query. By default it will fetch current head slot blocks.\",\n+      queryParams = {\n+        @OpenApiParam(name = SLOT),\n+        @OpenApiParam(name = PARENT_ROOT, description = \"Not currently supported.\")\n+      },\n+      responses = {\n+        @OpenApiResponse(\n+            status = RES_OK,\n+            content = @OpenApiContent(from = GetBlockHeadersResponse.class)),\n+        @OpenApiResponse(status = RES_BAD_REQUEST),\n+        @OpenApiResponse(status = RES_INTERNAL_ERROR)\n+      })\n+  @Override\n+  public void handle(@NotNull final Context ctx) throws Exception {\n+    final Map<String, List<String>> queryParameters = ctx.queryParamMap();\n+\n+    final Optional<Bytes32> parentRoot =\n+        SingleQueryParameterUtils.getParameterValueAsBytes32IfPresent(queryParameters, PARENT_ROOT);\n+    final Optional<UInt64> slot =\n+        SingleQueryParameterUtils.getParameterValueAsUInt64IfPresent(queryParameters, SLOT);\n+\n+    if (parentRoot.isPresent() && slot.isPresent()) {\n+      ctx.status(SC_BAD_REQUEST);\n+      ctx.result(\n+          BadRequest.badRequest(\n+              jsonProvider, \"Either supply parent_root, slot, or neither, but not both.\"));\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgzNjY5NA=="}, "originalCommit": {"oid": "e09e1ab1c01336d8866bd48684682ef28f2980ae"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MzYzMDUyOnYy", "diffSide": "RIGHT", "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMjoxMTo0MlrOHmOB4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMjoxMTo0MlrOHmOB4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgzNzc5NQ==", "bodyText": "nit: Maybe extract this to a local slotToLoad variable as the chaining gets a bit confusing otherwise.  And maybe:\nslot.or(recentChainData::getCurrentSlot).orElseThrow()?", "url": "https://github.com/ConsenSys/teku/pull/3047#discussion_r509837795", "createdAt": "2020-10-22T02:11:42Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -585,4 +585,20 @@ public void requireStoreAvailable() {\n         .join()\n         .map(Merkleizable::hash_tree_root);\n   }\n+\n+  public SafeFuture<List<BlockHeader>> getBlockHeaders(\n+      final Optional<Bytes32> parentRoot, final Optional<UInt64> slot) {\n+    if (!isStoreAvailable()) {\n+      throw new ChainDataUnavailableException();\n+    }\n+    if (parentRoot.isPresent()) {\n+      return SafeFuture.completedFuture(List.of());\n+    }\n+\n+    return combinedChainDataClient\n+        .getBlockAtSlotExact(slot.orElse(recentChainData.getCurrentSlot().orElseThrow()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e09e1ab1c01336d8866bd48684682ef28f2980ae"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3069, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}