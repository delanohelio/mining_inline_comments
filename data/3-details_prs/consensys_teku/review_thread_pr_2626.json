{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNTM2MzM3", "number": 2626, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMTowOTo0NlrOEaQCFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMjoxNjo0NFrOEauZcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1OTYxMTA5OnYy", "diffSide": "RIGHT", "path": "util/src/main/java/tech/pegasys/teku/util/config/PortAvailability.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMTowOTo0NlrOHDkDzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMzoxNDo1N1rOHDn94w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ5ODU3Mg==", "bodyText": "Can we use try with resources for this?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                DatagramSocket datagramSocket = null;\n          \n          \n            \n                try {\n          \n          \n            \n                  datagramSocket = new DatagramSocket(port);\n          \n          \n            \n                DatagramSocket datagramSocket = null;\n          \n          \n            \n                try (DatagramSocket datagramSocket = new DatagramSocket(port)) {\n          \n          \n            \n                  datagramSocket = new DatagramSocket(port);", "url": "https://github.com/ConsenSys/teku/pull/2626#discussion_r473498572", "createdAt": "2020-08-20T01:09:46Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/PortAvailability.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import java.io.IOException;\n+import java.net.DatagramSocket;\n+import java.net.ServerSocket;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class PortAvailability {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  public static boolean isPortAvailableForTcp(final int port) {\n+    if (!isPortValid(port)) {\n+      return false;\n+    }\n+    ServerSocket serverSocket = null;\n+    try {\n+      serverSocket = new ServerSocket(port);\n+      serverSocket.setReuseAddress(true);\n+      return true;\n+    } catch (IOException ex) {\n+      LOG.trace(\"failed to open port for TCP\", ex);\n+    } finally {\n+      if (serverSocket != null) {\n+        try {\n+          serverSocket.close();\n+        } catch (IOException ex) {\n+          LOG.trace(\"failed to close port\", ex);\n+        }\n+      }\n+    }\n+    return false;\n+  }\n+\n+  public static boolean isPortAvailableForUdp(final int port) {\n+    if (!isPortValid(port)) {\n+      return false;\n+    }\n+    DatagramSocket datagramSocket = null;\n+    try {\n+      datagramSocket = new DatagramSocket(port);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4111f3cadd091ea5ae5cc1ed94bd67d346665601"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2MjU5NQ==", "bodyText": "fair point, i'll give that a go.", "url": "https://github.com/ConsenSys/teku/pull/2626#discussion_r473562595", "createdAt": "2020-08-20T03:14:57Z", "author": {"login": "rolfyone"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/PortAvailability.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import java.io.IOException;\n+import java.net.DatagramSocket;\n+import java.net.ServerSocket;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class PortAvailability {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  public static boolean isPortAvailableForTcp(final int port) {\n+    if (!isPortValid(port)) {\n+      return false;\n+    }\n+    ServerSocket serverSocket = null;\n+    try {\n+      serverSocket = new ServerSocket(port);\n+      serverSocket.setReuseAddress(true);\n+      return true;\n+    } catch (IOException ex) {\n+      LOG.trace(\"failed to open port for TCP\", ex);\n+    } finally {\n+      if (serverSocket != null) {\n+        try {\n+          serverSocket.close();\n+        } catch (IOException ex) {\n+          LOG.trace(\"failed to close port\", ex);\n+        }\n+      }\n+    }\n+    return false;\n+  }\n+\n+  public static boolean isPortAvailableForUdp(final int port) {\n+    if (!isPortValid(port)) {\n+      return false;\n+    }\n+    DatagramSocket datagramSocket = null;\n+    try {\n+      datagramSocket = new DatagramSocket(port);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ5ODU3Mg=="}, "originalCommit": {"oid": "4111f3cadd091ea5ae5cc1ed94bd67d346665601"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1OTk0MjU3OnYy", "diffSide": "RIGHT", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/network/NetworkConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjo0ODowMFrOHDnjNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMzowNDowOVrOHDnziA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU1NTc2Nw==", "bodyText": "We shouldn't be doing this check in the constructor.  Actually opening sockets is something that should be deliberately done, not just a side effect of creation. Probably better as a validate method that's specifically called as part of the startup sequence (or possibly just use the getters and keep the logic out of the config class).", "url": "https://github.com/ConsenSys/teku/pull/2626#discussion_r473555767", "createdAt": "2020-08-20T02:48:00Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/network/NetworkConfig.java", "diffHunk": "@@ -87,10 +89,24 @@ public NetworkConfig(\n     this.advertisedIp = advertisedIp.filter(ip -> !ip.isBlank());\n     this.targetSubnetSubscriberCount = targetSubnetSubscriberCount;\n     if (this.advertisedIp.map(ip -> !isInetAddress(ip)).orElse(false)) {\n-      throw new IllegalArgumentException(\"Advertised ip is set incorrectly.\");\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Advertised ip (%s) is set incorrectly.\", this.advertisedIp.orElse(\"EMPTY\")));\n     }\n \n-    this.listenPort = listenPort;\n+    if (listenPort == 0) {\n+      this.listenPort = listenPort;\n+    } else {\n+      if (PortAvailability.isPortAvailable(listenPort)) {\n+        this.listenPort = listenPort;\n+      } else {\n+        throw new InvalidConfigurationException(\n+            String.format(\n+                \"P2P Port %d (TCP/UDP) is already in use. \"\n+                    + \"Check for other processes using this port.\",\n+                listenPort));\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4111f3cadd091ea5ae5cc1ed94bd67d346665601"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU1OTk0NA==", "bodyText": "Also this will check if the port is in use at startup, but we need to also specifically handle when the port was free at startup and became in use before we actually opened the socket.  This would happen if you were tracking a chain prior to the genesis event being known and running either two Teku's or a Teku and a Lighthouse - both would use port 9000 for p2p by default and only start listening when genesis becomes known (after startup).", "url": "https://github.com/ConsenSys/teku/pull/2626#discussion_r473559944", "createdAt": "2020-08-20T03:04:09Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/network/NetworkConfig.java", "diffHunk": "@@ -87,10 +89,24 @@ public NetworkConfig(\n     this.advertisedIp = advertisedIp.filter(ip -> !ip.isBlank());\n     this.targetSubnetSubscriberCount = targetSubnetSubscriberCount;\n     if (this.advertisedIp.map(ip -> !isInetAddress(ip)).orElse(false)) {\n-      throw new IllegalArgumentException(\"Advertised ip is set incorrectly.\");\n+      throw new InvalidConfigurationException(\n+          String.format(\n+              \"Advertised ip (%s) is set incorrectly.\", this.advertisedIp.orElse(\"EMPTY\")));\n     }\n \n-    this.listenPort = listenPort;\n+    if (listenPort == 0) {\n+      this.listenPort = listenPort;\n+    } else {\n+      if (PortAvailability.isPortAvailable(listenPort)) {\n+        this.listenPort = listenPort;\n+      } else {\n+        throw new InvalidConfigurationException(\n+            String.format(\n+                \"P2P Port %d (TCP/UDP) is already in use. \"\n+                    + \"Check for other processes using this port.\",\n+                listenPort));\n+      }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU1NTc2Nw=="}, "originalCommit": {"oid": "4111f3cadd091ea5ae5cc1ed94bd67d346665601"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2NDU4NjA4OnYy", "diffSide": "RIGHT", "path": "util/src/main/java/tech/pegasys/teku/util/config/PortAvailability.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMjoxNjo0NFrOHEVIew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMjoxNjo0NFrOHEVIew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMwMjU4Nw==", "bodyText": "Looking at the docs for setReuseAddress it looks like it needs to be set before the socket is bound to guarantee it works.  So we'd have to do something like:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                try (final DatagramSocket datagramSocket = new DatagramSocket(port)) {\n          \n          \n            \n                  datagramSocket.setReuseAddress(true);\n          \n          \n            \n                try (final DatagramSocket datagramSocket = new DatagramSocket()) {\n          \n          \n            \n                  datagramSocket.setReuseAddress(true);\n          \n          \n            \n                  datagramSocket.bind(new InetSocketAddress(port));\n          \n      \n    \n    \n  \n\nand the same above for TCP.", "url": "https://github.com/ConsenSys/teku/pull/2626#discussion_r474302587", "createdAt": "2020-08-20T22:16:44Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/PortAvailability.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import java.io.IOException;\n+import java.net.DatagramSocket;\n+import java.net.ServerSocket;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class PortAvailability {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  public static boolean isPortAvailableForTcp(final int port) {\n+    if (!isPortValid(port)) {\n+      return false;\n+    }\n+    try (final ServerSocket serverSocket = new ServerSocket(port)) {\n+      serverSocket.setReuseAddress(true);\n+      return true;\n+    } catch (IOException ex) {\n+      LOG.trace(\"failed to open port for TCP\", ex);\n+    }\n+    return false;\n+  }\n+\n+  public static boolean isPortAvailableForUdp(final int port) {\n+    if (!isPortValid(port)) {\n+      return false;\n+    }\n+    try (final DatagramSocket datagramSocket = new DatagramSocket(port)) {\n+      datagramSocket.setReuseAddress(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "166aa7f9ac6d0833547e04fe945bb47518499853"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3325, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}