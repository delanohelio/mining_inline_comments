{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1Mzg4NTI5", "number": 1501, "title": "Introduce Signer as a richer API for signing domain objects", "bodyText": "PR Description\nThe MessageSignerService interface works purely on the signing root value leaving the caller to calculate the signing root for the specific object.  To avoid duplicating that logic and provide a richer domain-object based API for signing, introduce the Signer object which takes a domain object, calculates the signing root then uses the MessageSignerService to sign it.\nLoading of validators is also adjusted to move it in the direction required for loading into the validator client service which won't know the validator index.", "createdAt": "2020-03-30T03:48:47Z", "url": "https://github.com/ConsenSys/teku/pull/1501", "merged": true, "mergeCommit": {"oid": "0a9720c3bd7059290aa8172a425cfb0c5e5448e7"}, "closed": true, "closedAt": "2020-03-30T21:29:20Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSlRFYAH2gAyMzk1Mzg4NTI5OjEwM2ZkOTllYzRhM2MzMjgzMzljMGJlNjQ1MjMxODJjYTk2NDlhZjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS1Pi4AH2gAyMzk1Mzg4NTI5OjQyMGU1NWIxNjIwYWJiMWEwMzFlMmE0NzE5OGU3YWNhYWZjYjc5ODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "103fd99ec4a3c328339c0be64523182ca9649af7", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/103fd99ec4a3c328339c0be64523182ca9649af7", "committedDate": "2020-03-30T02:41:52Z", "message": "Load validators into ValidatorClientService."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a53a42ef4978f842d4219b65a7a65bfeaa857890", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a53a42ef4978f842d4219b65a7a65bfeaa857890", "committedDate": "2020-03-30T02:41:54Z", "message": "Move test resources."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28aa2a0af8394ca8ce32e209ef23b78f8e7c748f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/28aa2a0af8394ca8ce32e209ef23b78f8e7c748f", "committedDate": "2020-03-30T03:37:12Z", "message": "Move all production signing root calculation and signing to Signer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e97e0eaeed6f27e96604c1a31ed20c29c46ac530", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e97e0eaeed6f27e96604c1a31ed20c29c46ac530", "committedDate": "2020-03-30T03:45:35Z", "message": "Move test signing to Signer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bb32a55ca31d259d813102bc453dcc6460e0f36", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3bb32a55ca31d259d813102bc453dcc6460e0f36", "committedDate": "2020-03-30T03:48:56Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into introducer-signer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a722547aa7fe5cba14b733d77ccecfc28ee54f9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4a722547aa7fe5cba14b733d77ccecfc28ee54f9", "committedDate": "2020-03-30T03:50:17Z", "message": "Add an integration test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc1a30f6571046af70ce5f7ca4fa512ec250d2ea", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/bc1a30f6571046af70ce5f7ca4fa512ec250d2ea", "committedDate": "2020-03-30T03:54:23Z", "message": "Spotless."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18024ab10ed399c1fe26f9807a06b73ed22aef2b", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/18024ab10ed399c1fe26f9807a06b73ed22aef2b", "committedDate": "2020-03-30T04:06:04Z", "message": "Go back to loading a map of validators."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d4552a3be9f2d090aa55a7cef9376d8775dbb53", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4d4552a3be9f2d090aa55a7cef9376d8775dbb53", "committedDate": "2020-03-30T04:22:33Z", "message": "Move signing classes to a signer package."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d04258139ebdc8d2c2c5258dafa5cef053c1aefe", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d04258139ebdc8d2c2c5258dafa5cef053c1aefe", "committedDate": "2020-03-30T04:25:45Z", "message": "Spotless."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDQ5MjQ2", "url": "https://github.com/ConsenSys/teku/pull/1501#pullrequestreview-384049246", "createdAt": "2020-03-30T16:54:47Z", "commit": {"oid": "d04258139ebdc8d2c2c5258dafa5cef053c1aefe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjo1NDo0N1rOF9zJzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNjo1NDo0N1rOF9zJzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NTU0OQ==", "bodyText": "Really nice and clean that all the signing is now contained in one object.", "url": "https://github.com/ConsenSys/teku/pull/1501#discussion_r400345549", "createdAt": "2020-03-30T16:54:47Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/signer/Signer.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client.signer;\n+\n+import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_epoch_at_slot;\n+import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_signing_root;\n+import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.get_domain;\n+import static tech.pegasys.artemis.util.config.Constants.DOMAIN_BEACON_ATTESTER;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.operations.AttestationData;\n+import tech.pegasys.artemis.datastructures.state.Fork;\n+import tech.pegasys.artemis.datastructures.validator.MessageSignerService;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+import tech.pegasys.artemis.util.config.Constants;\n+\n+public class Signer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d04258139ebdc8d2c2c5258dafa5cef053c1aefe"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDU1NzAy", "url": "https://github.com/ConsenSys/teku/pull/1501#pullrequestreview-384055702", "createdAt": "2020-03-30T17:02:47Z", "commit": {"oid": "d04258139ebdc8d2c2c5258dafa5cef053c1aefe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNzowMjo0OFrOF9zd9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNzowMjo0OFrOF9zd9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1MDcwOQ==", "bodyText": "I don't have a suggestion, however, it took me a good amount of time to infer (still not sure) that passing the epoch number 7 and the given fork value results in the expectedSigningRoot that you declare above. I wish there was a more clear way of showing that.", "url": "https://github.com/ConsenSys/teku/pull/1501#discussion_r400350709", "createdAt": "2020-03-30T17:02:48Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/test/java/tech/pegasys/artemis/validator/client/signer/SignerTest.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client.signer;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.operations.AttestationData;\n+import tech.pegasys.artemis.datastructures.state.Fork;\n+import tech.pegasys.artemis.datastructures.util.DataStructureUtil;\n+import tech.pegasys.artemis.datastructures.validator.MessageSignerService;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+\n+class SignerTest {\n+\n+  private final MessageSignerService signerService = mock(MessageSignerService.class);\n+  private final DataStructureUtil dataStructureUtil = new DataStructureUtil();\n+  private final Fork fork = dataStructureUtil.randomFork();\n+\n+  private final Signer signer = new Signer(signerService);\n+\n+  @Test\n+  public void shouldCreateRandaoReveal() {\n+    final BLSSignature signature = dataStructureUtil.randomSignature();\n+    final Bytes expectedSigningRoot =\n+        Bytes.fromHexString(\"0x84c8825ccb169a0d1109ff2b96185ea2bd6f66ed198f2e322473773fff3ed91b\");\n+    when(signerService.signRandaoReveal(expectedSigningRoot))\n+        .thenReturn(SafeFuture.completedFuture(signature));\n+    final SafeFuture<BLSSignature> reveal =\n+        signer.createRandaoReveal(UnsignedLong.valueOf(7), fork);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d04258139ebdc8d2c2c5258dafa5cef053c1aefe"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MDU3MDE2", "url": "https://github.com/ConsenSys/teku/pull/1501#pullrequestreview-384057016", "createdAt": "2020-03-30T17:04:28Z", "commit": {"oid": "d04258139ebdc8d2c2c5258dafa5cef053c1aefe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "420e55b1620abb1a031e2a47198e7acaafcb7986", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/420e55b1620abb1a031e2a47198e7acaafcb7986", "committedDate": "2020-03-30T21:18:40Z", "message": "Merge branch 'master' into introducer-signer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4412, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}