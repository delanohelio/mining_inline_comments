{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1NzYwODA2", "number": 1621, "title": "Use binary search to find the min genesis block", "bodyText": "PR Description\nImprove the performance of calculating the genesis state from an eth1 chain when the minimum genesis time is somewhere in the middle of the chain by using binary search to find the first block that meets the time criteria.", "createdAt": "2020-04-19T23:59:09Z", "url": "https://github.com/ConsenSys/teku/pull/1621", "merged": true, "mergeCommit": {"oid": "7f6998ebafaf534c7c7933514199afe20ec35e8e"}, "closed": true, "closedAt": "2020-04-20T21:12:23Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZTfGIgH2gAyNDA1NzYwODA2OjdkNDZmOGVkNjhhNTQ4ODcyNDFiOTdkOWMzN2JmODk4MzZjNGQ5NGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZlUf8AH2gAyNDA1NzYwODA2OmQwZDUzM2YxM2U1YmRjMjM2MWM5ZGQ3MDRhZDQwMzRmMzg2NzYxNmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7d46f8ed68a54887241b97d9c37bf89836c4d94c", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7d46f8ed68a54887241b97d9c37bf89836c4d94c", "committedDate": "2020-04-19T23:56:21Z", "message": "Use binary search to find the min genesis block."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa178c97d75fa413b1d38fcc5993be034c395645", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/fa178c97d75fa413b1d38fcc5993be034c395645", "committedDate": "2020-04-19T23:59:23Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into min-genesis-binary"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MTA3MTQ0", "url": "https://github.com/ConsenSys/teku/pull/1621#pullrequestreview-396107144", "createdAt": "2020-04-20T02:40:28Z", "commit": {"oid": "fa178c97d75fa413b1d38fcc5993be034c395645"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMjo0MDoyOFrOGIA6mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwMjo0MjoyM1rOGIA8WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA1Njc5NA==", "bodyText": "this test is the same as shouldAddGenesisDelayToBlockTimestampWhenConsideringIfItIsTheMinGenesisBlock", "url": "https://github.com/ConsenSys/teku/pull/1621#discussion_r411056794", "createdAt": "2020-04-20T02:40:28Z", "author": {"login": "macfarla"}, "path": "pow/src/test/java/tech/pegasys/artemis/pow/MinimumGenesisTimeBlockFinderTest.java", "diffHunk": "@@ -49,115 +46,69 @@ static void tearDown() {\n   }\n \n   @Test\n-  void minGenesisBlock_belowEstimatedBlock() {\n-    Constants.SECONDS_PER_ETH1_BLOCK = UnsignedLong.valueOf(5);\n-\n-    EthBlock.Block estimationBlock = mockBlockForEth1Provider(\"0xbf\", 1000, 1000);\n-\n-    setMinGenesisTime(500);\n-\n-    // 1002 - 502 = 500, 500 / 5 = 100, the estimated genesis block number should be:\n-    // 1000 - 100 = 900\n-\n-    mockBlockForEth1Provider(\"0x11\", 900, 600);\n-\n-    // since the estimated block still had higher timestamp than min genesis, we should explore\n-    // downwards\n-\n-    mockBlockForEth1Provider(\"0x08\", 899, 510);\n-\n-    // since the second requested block still had higher timestamp than min genesis, we should\n-    // explore downwards\n-\n-    mockBlockForEth1Provider(\"0x00\", 898, 490);\n-\n-    // since the last requested block now had lower timestamp than min genesis, we should publish\n-    // the block\n-    // right before this as the first valid block\n-\n-    EthBlock.Block minGenesisTimeBlock =\n-        minimumGenesisTimeBlockFinder.findMinGenesisTimeBlockInHistory(estimationBlock).join();\n-\n-    assertThatIsBlock(minGenesisTimeBlock, \"0x08\", 899, 510);\n+  public void shouldFindMinGenesisTime() {\n+    final long[] timestamps = {0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000};\n+    final Block[] blocks = withBlockTimestamps(timestamps);\n+    final int minGenesisTime = 3500;\n+    final Block expectedMinGenesisTimeBlock = blocks[4];\n+    assertMinGenesisBlock(blocks, minGenesisTime, expectedMinGenesisTimeBlock);\n   }\n \n   @Test\n-  void minGenesisBlock_AboveEstimatedBlock() {\n-    Constants.SECONDS_PER_ETH1_BLOCK = UnsignedLong.valueOf(5);\n-\n-    //    mockLatestCanonicalBlock(1000);\n-    EthBlock.Block estimationBlock = mockBlockForEth1Provider(\"0xbf\", 1000, 1000);\n-\n-    setMinGenesisTime(500);\n-\n-    // 1002 - 502 = 500, 500 / 5 = 100, the estimated genesis block number should be:\n-    // 1000 - 100 = 900\n-\n-    mockBlockForEth1Provider(\"0x08\", 900, 400);\n-\n-    // since the estimated block still had lower timestamp than min genesis, we should explore\n-    // upwards\n-\n-    mockBlockForEth1Provider(\"0x08\", 901, 450);\n-\n-    // since the second requested block still had lower timestamp than min genesis, we should\n-    // explore upwards\n-\n-    mockBlockForEth1Provider(\"0x08\", 902, 510);\n-\n-    // since the last requested block now had higher timestamp than min genesis, we should publish\n-    // the block\n-\n-    EthBlock.Block minGenesisTimeBlock =\n-        minimumGenesisTimeBlockFinder.findMinGenesisTimeBlockInHistory(estimationBlock).join();\n-\n-    assertThatIsBlock(minGenesisTimeBlock, \"0x08\", 902, 510);\n+  public void shouldAddGenesisDelayToBlockTimestampWhenConsideringIfItIsTheMinGenesisBlock() {\n+    final Block[] blocks = withBlockTimestamps(1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000);\n+    final int minGenesisTime = 3002;\n+    final Block expectedMinGenesisTimeBlock = blocks[2];\n+    assertMinGenesisBlock(blocks, minGenesisTime, expectedMinGenesisTimeBlock);\n   }\n \n   @Test\n-  void minGenesisBlock_EstimatedBlockIsTheValidBlock() {\n-    Constants.SECONDS_PER_ETH1_BLOCK = UnsignedLong.valueOf(5);\n-\n-    //    mockLatestCanonicalBlock(1000);\n-    EthBlock.Block estimationBlock = mockBlockForEth1Provider(\"0xbf\", 1000, 1000);\n-\n-    setMinGenesisTime(502);\n-\n-    // 1002 - 502 = 500, 500 / 5 = 100, the estimated genesis block number should be:\n-    // 1000 - 100 = 900\n+  public void shouldFindMinGenesisTimeBlockAtVeryStartOfChain() {\n+    final Block[] blocks = withBlockTimestamps(4000, 5000, 6000, 7000, 8000);\n+    final int minGenesisTime = 3000;\n+    final Block expectedMinGenesisTimeBlock = blocks[0];\n+    assertMinGenesisBlock(blocks, minGenesisTime, expectedMinGenesisTimeBlock);\n+  }\n \n-    mockBlockForEth1Provider(\"0x08\", 900, 500);\n+  @Test\n+  public void shouldFindMinGenesisTimeBlockAtHeadOfChain() {\n+    final Block[] blocks = withBlockTimestamps(4000, 5000, 6000, 7000, 8000);\n+    final int minGenesisTime = 8000;\n+    final Block expectedMinGenesisTimeBlock = blocks[blocks.length - 1];\n+    assertMinGenesisBlock(blocks, minGenesisTime, expectedMinGenesisTimeBlock);\n+  }\n \n-    // since the genesis time calculated from the , we should publish the block\n+  @Test\n+  public void shouldFindMinGenesisTimeWithExactMatch() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa178c97d75fa413b1d38fcc5993be034c395645"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA1NzI0MQ==", "bodyText": "I don't know if this comment is useful here?", "url": "https://github.com/ConsenSys/teku/pull/1621#discussion_r411057241", "createdAt": "2020-04-20T02:42:23Z", "author": {"login": "macfarla"}, "path": "pow/src/test/java/tech/pegasys/artemis/pow/MinimumGenesisTimeBlockFinderTest.java", "diffHunk": "@@ -20,27 +20,24 @@\n import com.google.common.primitives.UnsignedLong;\n import java.math.BigInteger;\n import org.junit.jupiter.api.AfterAll;\n-import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.BeforeAll;\n import org.junit.jupiter.api.Test;\n import org.web3j.protocol.core.methods.response.EthBlock;\n+import org.web3j.protocol.core.methods.response.EthBlock.Block;\n import tech.pegasys.artemis.util.async.SafeFuture;\n import tech.pegasys.artemis.util.config.Constants;\n \n public class MinimumGenesisTimeBlockFinderTest {\n \n-  private Eth1Provider eth1Provider;\n+  private Eth1Provider eth1Provider = mock(Eth1Provider.class);\n \n-  private MinimumGenesisTimeBlockFinder minimumGenesisTimeBlockFinder;\n-\n-  @BeforeEach\n-  void setUp() {\n-    eth1Provider = mock(Eth1Provider.class);\n-\n-    minimumGenesisTimeBlockFinder = new MinimumGenesisTimeBlockFinder(eth1Provider);\n+  private MinimumGenesisTimeBlockFinder minimumGenesisTimeBlockFinder =\n+      new MinimumGenesisTimeBlockFinder(eth1Provider);\n \n+  @BeforeAll\n+  static void setUp() {\n+    // calculateCandidateGenesisTimestamp will return blockTime + 2", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa178c97d75fa413b1d38fcc5993be034c395645"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90fea217dedf83b789cd69679724af792a7d0331", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/90fea217dedf83b789cd69679724af792a7d0331", "committedDate": "2020-04-20T05:05:10Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into min-genesis-binary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca1e2c51f35d011b2fe681ddfe0b6869c0f3174e", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ca1e2c51f35d011b2fe681ddfe0b6869c0f3174e", "committedDate": "2020-04-20T05:08:20Z", "message": "Review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjMyMTM1", "url": "https://github.com/ConsenSys/teku/pull/1621#pullrequestreview-396632135", "createdAt": "2020-04-20T16:46:47Z", "commit": {"oid": "ca1e2c51f35d011b2fe681ddfe0b6869c0f3174e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjo0Njo0N1rOGId5lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjo0Njo0N1rOGId5lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzMTY3MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                // The very first block is after min genesis so just use it\n          \n          \n            \n                                // The very first block of eth1 is after eth 2 min genesis so just use it", "url": "https://github.com/ConsenSys/teku/pull/1621#discussion_r411531670", "createdAt": "2020-04-20T16:46:47Z", "author": {"login": "cemozerr"}, "path": "pow/src/main/java/tech/pegasys/artemis/pow/MinimumGenesisTimeBlockFinder.java", "diffHunk": "@@ -37,75 +42,40 @@ public MinimumGenesisTimeBlockFinder(Eth1Provider eth1Provider) {\n   /**\n    * Find first block in history that has timestamp greater than MIN_GENESIS_TIME\n    *\n-   * @param estimationBlock estimationBlock that will be used for estimation\n+   * @param headBlock block at current chain head\n    * @return min genesis time block\n    */\n-  public SafeFuture<EthBlock.Block> findMinGenesisTimeBlockInHistory(\n-      EthBlock.Block estimationBlock) {\n-    UnsignedLong estimatedBlockNumber =\n-        getEstimatedMinGenesisTimeBlockNumber(estimationBlock, Constants.SECONDS_PER_ETH1_BLOCK);\n-    return eth1Provider\n-        .getEth1BlockFuture(estimatedBlockNumber)\n-        .thenCompose(\n-            block -> {\n-              int comparison = compareBlockTimestampToMinGenesisTime(block);\n-              if (comparison > 0) {\n-                // If block timestamp is greater than min genesis time\n-                // explore blocks downwards\n-                return exploreBlocksDownwards(block);\n-              } else if (comparison < 0) {\n-                // If block timestamp is less than min genesis time\n-                // explore blocks upwards\n-                return exploreBlocksUpwards(block);\n-              } else {\n-                return SafeFuture.completedFuture(block);\n-              }\n-            });\n+  public SafeFuture<EthBlock.Block> findMinGenesisTimeBlockInHistory(EthBlock.Block headBlock) {\n+    return binarySearchLoop(new SearchContext(headBlock));\n   }\n \n-  private SafeFuture<EthBlock.Block> exploreBlocksDownwards(EthBlock.Block previousBlock) {\n-    if (previousBlock.getNumber().equals(BigInteger.ZERO)) {\n-      // We reached genesis and thus should be returning genesis as the min genesis block.\n-      return SafeFuture.completedFuture(previousBlock);\n+  private SafeFuture<EthBlock.Block> binarySearchLoop(final SearchContext searchContext) {\n+    if (searchContext.low.compareTo(searchContext.high) <= 0) {\n+      final UnsignedLong mid = searchContext.low.plus(searchContext.high).dividedBy(TWO);\n+      return eth1Provider\n+          .getEth1BlockFuture(mid)\n+          .thenCompose(\n+              midBlock -> {\n+                final int cmp = compareBlockTimestampToMinGenesisTime(midBlock);\n+                if (cmp < 0) {\n+                  searchContext.low = mid.plus(ONE);\n+                  return binarySearchLoop(searchContext);\n+                } else if (cmp > 0) {\n+                  if (mid.equals(ZERO)) {\n+                    // The very first block is after min genesis so just use it", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca1e2c51f35d011b2fe681ddfe0b6869c0f3174e"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjQ1MjY5", "url": "https://github.com/ConsenSys/teku/pull/1621#pullrequestreview-396645269", "createdAt": "2020-04-20T17:04:03Z", "commit": {"oid": "ca1e2c51f35d011b2fe681ddfe0b6869c0f3174e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c5f714d6fb12d41df9d8c58cb34d85e37be4637", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3c5f714d6fb12d41df9d8c58cb34d85e37be4637", "committedDate": "2020-04-20T20:42:55Z", "message": "Improve comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0d533f13e5bdc2361c9dd704ad4034f3867616a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d0d533f13e5bdc2361c9dd704ad4034f3867616a", "committedDate": "2020-04-20T20:43:04Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into min-genesis-binary"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4320, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}