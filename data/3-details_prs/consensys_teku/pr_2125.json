{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyODMwMTE0", "number": 2125, "title": "Reduce log level when the stream is closed while sending block by range responses", "bodyText": "PR Description\nWhen the stream is closed while sending block by range responses, log at trace level, not error.\nAvoid the risk of a stack overflow exception when sending a range of hot blocks by iterating if the block is immediately available rather than always chaining via thenCompose.\nFixed Issue(s)\nfixes #2018\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-06-11T04:25:09Z", "url": "https://github.com/ConsenSys/teku/pull/2125", "merged": true, "mergeCommit": {"oid": "b3262903aff865c978bab276a772d121c1bfa15b"}, "closed": true, "closedAt": "2020-06-12T06:57:50Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqGZPVAH2gAyNDMyODMwMTE0OjlkNzlkZDU4ZGE0OTIzYTdlYjhkMGI3MzM2NDFjZDY5OWVmMThkYjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqc2xSAH2gAyNDMyODMwMTE0OmQwNzJkOTRhMmRiYzMyNDU2Y2I1ZDdhMmJlMmRjMjMyOGNkODYzNzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d79dd58da4923a7eb8d0b733641cd699ef18db3", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/9d79dd58da4923a7eb8d0b733641cd699ef18db3", "committedDate": "2020-06-11T04:17:54Z", "message": "Reduce log level when the stream is closed while sending block by range responses.\nIterate when possible to avoid risk of stack overflow exceptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be01ce858e50dee8cf10891b03b77a196a2d0d14", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/be01ce858e50dee8cf10891b03b77a196a2d0d14", "committedDate": "2020-06-11T04:26:03Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into block-by-range-loop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTc1NTMx", "url": "https://github.com/ConsenSys/teku/pull/2125#pullrequestreview-428975531", "createdAt": "2020-06-11T14:35:39Z", "commit": {"oid": "be01ce858e50dee8cf10891b03b77a196a2d0d14"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDozNTozOVrOGigQ8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDozNTozOVrOGigQ8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzMzM5NA==", "bodyText": "nit: completing the comment here would be nice since its a pretty complex piece of code", "url": "https://github.com/ConsenSys/teku/pull/2125#discussion_r438833394", "createdAt": "2020-06-11T14:35:39Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/beaconchain/methods/BeaconBlocksByRangeMessageHandler.java", "diffHunk": "@@ -92,17 +97,37 @@ public void onIncomingMessage(\n   }\n \n   private SafeFuture<RequestState> sendNextBlock(final RequestState requestState) {\n-    return combinedChainDataClient\n-        .getBlockAtSlotExact(requestState.currentSlot, requestState.headBlockRoot)\n-        .thenCompose(\n-            maybeBlock -> {\n-              maybeBlock.ifPresent(requestState::sendBlock);\n-              if (requestState.isComplete()) {\n-                return completedFuture(requestState);\n-              }\n-              requestState.incrementCurrentSlot();\n-              return sendNextBlock(requestState);\n-            });\n+    SafeFuture<Optional<SignedBeaconBlock>> blockFuture = loadNextBlock(requestState);\n+    // Avoid risk of", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be01ce858e50dee8cf10891b03b77a196a2d0d14"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTc5ODM1", "url": "https://github.com/ConsenSys/teku/pull/2125#pullrequestreview-428979835", "createdAt": "2020-06-11T14:40:10Z", "commit": {"oid": "be01ce858e50dee8cf10891b03b77a196a2d0d14"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDo0MDoxMFrOGigdMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDo0MDoxMFrOGigdMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzNjUzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Avoid risk of\n          \n          \n            \n                // Avoid the risk of a stack overflow exception when sending a range of \n          \n          \n            \n                // hot blocks by iterating if the block is immediately available rather than \n          \n          \n            \n                // always chaining via thenCompose.", "url": "https://github.com/ConsenSys/teku/pull/2125#discussion_r438836531", "createdAt": "2020-06-11T14:40:10Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/beaconchain/methods/BeaconBlocksByRangeMessageHandler.java", "diffHunk": "@@ -92,17 +97,37 @@ public void onIncomingMessage(\n   }\n \n   private SafeFuture<RequestState> sendNextBlock(final RequestState requestState) {\n-    return combinedChainDataClient\n-        .getBlockAtSlotExact(requestState.currentSlot, requestState.headBlockRoot)\n-        .thenCompose(\n-            maybeBlock -> {\n-              maybeBlock.ifPresent(requestState::sendBlock);\n-              if (requestState.isComplete()) {\n-                return completedFuture(requestState);\n-              }\n-              requestState.incrementCurrentSlot();\n-              return sendNextBlock(requestState);\n-            });\n+    SafeFuture<Optional<SignedBeaconBlock>> blockFuture = loadNextBlock(requestState);\n+    // Avoid risk of", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be01ce858e50dee8cf10891b03b77a196a2d0d14"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTg4NjMw", "url": "https://github.com/ConsenSys/teku/pull/2125#pullrequestreview-428988630", "createdAt": "2020-06-11T14:49:31Z", "commit": {"oid": "be01ce858e50dee8cf10891b03b77a196a2d0d14"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDo0OTozMVrOGig2zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNDo0OTozMVrOGig2zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg0MzA4NQ==", "bodyText": "I don't understand how this method fixes the stack overflow exception. It seems to me that you synchronously send the block if the block is available at the time (at line 103 with handleLoadedBlock) but otherwise you just keep chaining SafeFutures via thenCompose.", "url": "https://github.com/ConsenSys/teku/pull/2125#discussion_r438843085", "createdAt": "2020-06-11T14:49:31Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/rpc/beaconchain/methods/BeaconBlocksByRangeMessageHandler.java", "diffHunk": "@@ -92,17 +97,37 @@ public void onIncomingMessage(\n   }\n \n   private SafeFuture<RequestState> sendNextBlock(final RequestState requestState) {\n-    return combinedChainDataClient\n-        .getBlockAtSlotExact(requestState.currentSlot, requestState.headBlockRoot)\n-        .thenCompose(\n-            maybeBlock -> {\n-              maybeBlock.ifPresent(requestState::sendBlock);\n-              if (requestState.isComplete()) {\n-                return completedFuture(requestState);\n-              }\n-              requestState.incrementCurrentSlot();\n-              return sendNextBlock(requestState);\n-            });\n+    SafeFuture<Optional<SignedBeaconBlock>> blockFuture = loadNextBlock(requestState);\n+    // Avoid risk of\n+    while (blockFuture.isDone() && !blockFuture.isCompletedExceptionally()) {\n+      final boolean complete = handleLoadedBlock(requestState, blockFuture.join());\n+      if (complete) {\n+        return completedFuture(requestState);\n+      }\n+      blockFuture = loadNextBlock(requestState);\n+    }\n+    return blockFuture.thenCompose(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be01ce858e50dee8cf10891b03b77a196a2d0d14"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8878b0c8df8f9275eb30f3d4d364086eea5b3cd4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8878b0c8df8f9275eb30f3d4d364086eea5b3cd4", "committedDate": "2020-06-11T19:56:22Z", "message": "Finish comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de2413743065553bada0e8541547d5d4573e1b1c", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/de2413743065553bada0e8541547d5d4573e1b1c", "committedDate": "2020-06-11T19:56:33Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into block-by-range-loop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDE1NTg2", "url": "https://github.com/ConsenSys/teku/pull/2125#pullrequestreview-429415586", "createdAt": "2020-06-12T02:05:15Z", "commit": {"oid": "de2413743065553bada0e8541547d5d4573e1b1c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b834702d56a72e21101e66a00c1d4871991d22bc", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b834702d56a72e21101e66a00c1d4871991d22bc", "committedDate": "2020-06-12T03:06:05Z", "message": "Merge branch 'master' into block-by-range-loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d072d94a2dbc32456cb5d7a2be2dc2328cd86371", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d072d94a2dbc32456cb5d7a2be2dc2328cd86371", "committedDate": "2020-06-12T06:28:04Z", "message": "Merge branch 'master' into block-by-range-loop"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3899, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}