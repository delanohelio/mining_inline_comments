{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MjQ4Mjk3", "number": 2887, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNDoyNTozM1rOEqj5mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNDozMjoxNVrOEqj9pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDYzODMzOnYy", "diffSide": "RIGHT", "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/BeaconStateUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNDoyNTozM1rOHc1ekQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNDozNToxNVrOHc1nYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk5ODM1Mw==", "bodyText": "This doesn't appear to be used?", "url": "https://github.com/ConsenSys/teku/pull/2887#discussion_r499998353", "createdAt": "2020-10-06T04:25:33Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/BeaconStateUtil.java", "diffHunk": "@@ -464,6 +464,10 @@ public static UInt64 compute_start_slot_at_epoch(UInt64 epoch) {\n     return epoch.times(SLOTS_PER_EPOCH);\n   }\n \n+  public static boolean is_start_slot_of_epoch(final UInt64 slot) {\n+    return slot.mod(SLOTS_PER_EPOCH).equals(UInt64.ZERO);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3aff1c630fd2951b819cd61089403e34ddf0530b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAwMDYwOA==", "bodyText": "at the moment its only in test code but the RecentChainData.updateChainHead will call it so i dont have to code the decision into that...", "url": "https://github.com/ConsenSys/teku/pull/2887#discussion_r500000608", "createdAt": "2020-10-06T04:35:15Z", "author": {"login": "rolfyone"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/BeaconStateUtil.java", "diffHunk": "@@ -464,6 +464,10 @@ public static UInt64 compute_start_slot_at_epoch(UInt64 epoch) {\n     return epoch.times(SLOTS_PER_EPOCH);\n   }\n \n+  public static boolean is_start_slot_of_epoch(final UInt64 slot) {\n+    return slot.mod(SLOTS_PER_EPOCH).equals(UInt64.ZERO);\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk5ODM1Mw=="}, "originalCommit": {"oid": "3aff1c630fd2951b819cd61089403e34ddf0530b"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDY0ODY5OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNDozMjoxNVrOHc1kpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNDozODoxNlrOHc1p6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk5OTkwOQ==", "bodyText": "I don't think this is right.  We might wind up skipping multiple slots and so miss the first slot of the epoch.  I think it should check if the forkChoiceSlot from previousChainHead is from an earlier epoch than the forkChoiceSlot from newChainHead.", "url": "https://github.com/ConsenSys/teku/pull/2887#discussion_r499999909", "createdAt": "2020-10-06T04:32:15Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "diffHunk": "@@ -260,14 +262,18 @@ private void updateChainHead(\n               commonAncestorSlot);\n         }\n \n+        final UInt64 epoch = compute_epoch_at_slot(newChainHead.getSlot());\n+        final boolean epochTransition =\n+            newChainHead.getSlot().equals(compute_start_slot_at_epoch(epoch));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3aff1c630fd2951b819cd61089403e34ddf0530b"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAwMTI1OQ==", "bodyText": "The point is that you're not looking for the first slot in the epoch.  You might be going from slot 30 to 50 in one update and that's an epoch transition even though you never got to slot 32.", "url": "https://github.com/ConsenSys/teku/pull/2887#discussion_r500001259", "createdAt": "2020-10-06T04:38:16Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "diffHunk": "@@ -260,14 +262,18 @@ private void updateChainHead(\n               commonAncestorSlot);\n         }\n \n+        final UInt64 epoch = compute_epoch_at_slot(newChainHead.getSlot());\n+        final boolean epochTransition =\n+            newChainHead.getSlot().equals(compute_start_slot_at_epoch(epoch));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk5OTkwOQ=="}, "originalCommit": {"oid": "3aff1c630fd2951b819cd61089403e34ddf0530b"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3307, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}