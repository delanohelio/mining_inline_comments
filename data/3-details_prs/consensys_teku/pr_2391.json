{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzODQ1MzYw", "number": 2391, "title": "[Issue-2291] Migrate more calls to get state", "bodyText": "PR Description\nMigrate more calls from Store.getBlockState to Store.retrieveBlockState.\nFixed Issue(s)\nPart of #2291\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-07-20T21:15:56Z", "url": "https://github.com/ConsenSys/teku/pull/2391", "merged": true, "mergeCommit": {"oid": "322687c858ba78991102c4f11ce8aac799c50451"}, "closed": true, "closedAt": "2020-07-22T15:41:38Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc22ba6gH2gAyNDUzODQ1MzYwOjBmZDcwMGE0ZWQ1OWRjMzhiYmU2OTE3NzE1MWNhOGEzNDUwMGY0MmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3camngH2gAyNDUzODQ1MzYwOjg1MGE2MWNlZDFiZjliYmViNjM5OTE5ODE1NDI5NGEyNWJjOTA0OWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0fd700a4ed59dc38bbe69177151ca8a34500f42d", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/0fd700a4ed59dc38bbe69177151ca8a34500f42d", "committedDate": "2020-07-20T19:02:49Z", "message": "Replace calls to getBlockState"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37a076ce4643346fe1370ad86046d545c999a0d4", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/37a076ce4643346fe1370ad86046d545c999a0d4", "committedDate": "2020-07-20T19:19:55Z", "message": "Modify updateBestBlock to use async block / state retrieval"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ee36b64f007f36cb7b880552164350256ce0f75", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/1ee36b64f007f36cb7b880552164350256ce0f75", "committedDate": "2020-07-20T19:28:27Z", "message": "Start migrating RecentChainData.getStateInEffectAtSlot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0687a3b373b768531b6779e39f3557066b910869", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/0687a3b373b768531b6779e39f3557066b910869", "committedDate": "2020-07-20T19:39:14Z", "message": "Update subnet calculation to use async retrieveStateInEffectAtSlot()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "492cd65f833dcb26fe75bf1393dcb4f7fc6f496f", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/492cd65f833dcb26fe75bf1393dcb4f7fc6f496f", "committedDate": "2020-07-20T19:41:48Z", "message": "Remove method getStateInEffectAtSlot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd54c67470aeadf9dd73683c55aa2e47fc35cce7", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/bd54c67470aeadf9dd73683c55aa2e47fc35cce7", "committedDate": "2020-07-20T22:31:12Z", "message": "Rework bestBlock update to prevent rollbacks of the chainhead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMDQ2MDg5", "url": "https://github.com/ConsenSys/teku/pull/2391#pullrequestreview-452046089", "createdAt": "2020-07-21T00:28:34Z", "commit": {"oid": "bd54c67470aeadf9dd73683c55aa2e47fc35cce7"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMDoyODozNVrOG0jywA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMToyMDoxNVrOG0kqLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2NTU2OA==", "bodyText": "These join calls are spreading through tests a lot.  It's not the end of the world but if for some reason the future wasn't completed they'd hang forever which would make it very hard to know which test was failing.\nWe already have SafeFutureAssert to add some utilities for asserting stuff about futures so I think we could add:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThat(subnetSubscriptions.getChannel(attestation).join()).isNotEqualTo(Optional.empty());\n          \n          \n            \n                assertThat(subnetSubscriptions.getChannel(attestation2).join()).isEqualTo(Optional.empty());\n          \n          \n            \n                  public void isCompletedWithEmptyOptional() {\n          \n          \n            \n                isCompleted();\n          \n          \n            \n                Assertions.assertThat(actual.join()).isEqualTo(Optional.empty());\n          \n          \n            \n              }\n          \n          \n            \n              \n          \n          \n            \n              public void isCompletedWithNonEmptyOptional() {\n          \n          \n            \n                isCompleted();\n          \n          \n            \n                Assertions.assertThat(actual.join()).isNotEqualTo(Optional.empty());  \n          \n          \n            \n              }", "url": "https://github.com/ConsenSys/teku/pull/2391#discussion_r457765568", "createdAt": "2020-07-21T00:28:35Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/subnets/AttestationSubnetSubscriptionsTest.java", "diffHunk": "@@ -73,16 +73,16 @@ void getChannelReturnsEmptyIfNotSubscribedToSubnet() {\n     int subnetId = computeSubnetId(attestation);\n     assertThat(computeSubnetId(attestation2)).isNotEqualTo(subnetId); // Sanity check\n     subnetSubscriptions.subscribeToSubnetId(subnetId);\n-    assertThat(subnetSubscriptions.getChannel(attestation)).isNotEqualTo(Optional.empty());\n-    assertThat(subnetSubscriptions.getChannel(attestation2)).isEqualTo(Optional.empty());\n+    assertThat(subnetSubscriptions.getChannel(attestation).join()).isNotEqualTo(Optional.empty());\n+    assertThat(subnetSubscriptions.getChannel(attestation2).join()).isEqualTo(Optional.empty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54c67470aeadf9dd73683c55aa2e47fc35cce7"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2NTcwNQ==", "bodyText": "These can just be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThat(subnetSubscriptions.getChannel(attestation1).join())\n          \n          \n            \n                    .isEqualTo(Optional.of(topicChannel1));\n          \n          \n            \n                assertThat(subnetSubscriptions.getChannel(attestation2).join())\n          \n          \n            \n                    .isEqualTo(Optional.of(topicChannel2));\n          \n          \n            \n                assertThat(subnetSubscriptions.getChannel(attestation1))\n          \n          \n            \n                    .isCompletedWith(Optional.of(topicChannel1));\n          \n          \n            \n                assertThat(subnetSubscriptions.getChannel(attestation2))\n          \n          \n            \n                    .isCompletedWith(Optional.of(topicChannel2));", "url": "https://github.com/ConsenSys/teku/pull/2391#discussion_r457765705", "createdAt": "2020-07-21T00:29:07Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/subnets/AttestationSubnetSubscriptionsTest.java", "diffHunk": "@@ -110,8 +110,10 @@ void shouldSubscribeToCommitteesOnDifferentSubnets() {\n     verify(gossipNetwork)\n         .subscribe(argThat(i -> i.contains(\"beacon_attestation_\" + subnetId2)), any());\n \n-    assertThat(subnetSubscriptions.getChannel(attestation1)).isEqualTo(Optional.of(topicChannel1));\n-    assertThat(subnetSubscriptions.getChannel(attestation2)).isEqualTo(Optional.of(topicChannel2));\n+    assertThat(subnetSubscriptions.getChannel(attestation1).join())\n+        .isEqualTo(Optional.of(topicChannel1));\n+    assertThat(subnetSubscriptions.getChannel(attestation2).join())\n+        .isEqualTo(Optional.of(topicChannel2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54c67470aeadf9dd73683c55aa2e47fc35cce7"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2NTc4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThat(subnetSubscriptions.getChannel(attestation).join())\n          \n          \n            \n                    .isEqualTo(Optional.of(topicChannel));\n          \n          \n            \n                assertThat(subnetSubscriptions.getChannel(attestation))\n          \n          \n            \n                    .isCompletedWith(Optional.of(topicChannel));", "url": "https://github.com/ConsenSys/teku/pull/2391#discussion_r457765789", "createdAt": "2020-07-21T00:29:23Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/subnets/AttestationSubnetSubscriptionsTest.java", "diffHunk": "@@ -126,7 +128,8 @@ void shouldUnsubscribeFromOnlyCommitteeOnSubnet() {\n \n     verify(gossipNetwork).subscribe(any(), any());\n \n-    assertThat(subnetSubscriptions.getChannel(attestation)).isEqualTo(Optional.of(topicChannel));\n+    assertThat(subnetSubscriptions.getChannel(attestation).join())\n+        .isEqualTo(Optional.of(topicChannel));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54c67470aeadf9dd73683c55aa2e47fc35cce7"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2NjAwNQ==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            // during\n          \n          \n            \n                            // processing\n          \n          \n            \n                            // during processing", "url": "https://github.com/ConsenSys/teku/pull/2391#discussion_r457766005", "createdAt": "2020-07-21T00:30:11Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/CombinedChainDataClient.java", "diffHunk": "@@ -160,16 +160,20 @@ public boolean isFinalizedEpoch(final UnsignedLong epoch) {\n     }\n \n     if (isRecentData(slot)) {\n-      final Optional<BeaconState> recentState = recentChainData.getStateInEffectAtSlot(slot);\n-      if (recentState.isPresent()) {\n-        LOG.trace(\"State at slot {} was from recent chain data\", slot);\n-        return completedFuture(recentState);\n-      }\n+      return recentChainData\n+          .retrieveStateInEffectAtSlot(slot)\n+          .thenCompose(\n+              recentState -> {\n+                if (recentState.isPresent()) {\n+                  return completedFuture(recentState);\n+                }\n+                // Fall-through to historical query in case state has moved into historical range\n+                // during\n+                // processing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54c67470aeadf9dd73683c55aa2e47fc35cce7"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc3OTc1OQ==", "bodyText": "I don't think this works.  Say we have:\n\nUpdate 1 starts, grabs original head as slot 1, trying to set slot to 2.\nUpdate 2 starts, grabs original head as slot 1, trying to set slot to 3.\nUpdate 1 completes and sets head to 2\nUpdate 2 will now be skipped because it expects head to be 1 but it's changed. We then wind up with an outdated head (but at least we don't go backwards).\n\nI wonder if in RecentChainData we should just return the SafeFuture.  ForkChoiceHead is the key place it gets called from and it probably needs to call join so it all happens in the synchronized block.  Kind of just pushing the problem down the road unfortunately but I'm struggling to see how else to do it.  Ultimately we need to ensure there is only one thing updating head at a time.", "url": "https://github.com/ConsenSys/teku/pull/2391#discussion_r457779759", "createdAt": "2020-07-21T01:20:15Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/client/RecentChainData.java", "diffHunk": "@@ -186,30 +186,43 @@ public StoreTransaction startStoreTransaction() {\n    * @param slot the new best slot\n    */\n   public void updateBestBlock(Bytes32 root, UnsignedLong slot) {\n+    final Optional<SignedBlockAndStateAndSlot> originalChainHead = chainHead;\n+    store\n+        .retrieveBlockAndState(root)\n+        .thenApply(\n+            headBlockAndState ->\n+                headBlockAndState\n+                    .map(head -> SignedBlockAndStateAndSlot.create(head, slot))\n+                    .orElseThrow(\n+                        () ->\n+                            new IllegalStateException(\n+                                String.format(\n+                                    \"Unable to update best block as of slot %s.  Block is unavailable: %s.\",\n+                                    slot, root))))\n+        .thenAccept(headBlock -> updateChainHead(originalChainHead, headBlock))\n+        .reportExceptions();\n+  }\n+\n+  private void updateChainHead(\n+      final Optional<SignedBlockAndStateAndSlot> originalHead,\n+      final SignedBlockAndStateAndSlot newChainHead) {\n     synchronized (this) {\n-      final SignedBeaconBlock newBestBlock = store.getSignedBlock(root);\n-      final BeaconState newBestState = store.getBlockState(root);\n-      if (newBestBlock == null || newBestState == null) {\n-        LOG.warn(\n-            \"Unable to update best block (slot={}, root={}). Corresponding {} unavailable\",\n-            slot,\n-            root,\n-            newBestBlock == null ? \"block\" : \"state\");\n+      if (!chainHead.equals(originalHead)) {\n+        // The chain head has been updated while we were waiting for the newChainHead\n+        // Skip this update to avoid accidentally regressing the chain head\n+        LOG.debug(\"Skipping best block update to avoid potential rollback of the best block.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54c67470aeadf9dd73683c55aa2e47fc35cce7"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49b178861ecde60038757f34716d4fe6fa0b9164", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/49b178861ecde60038757f34716d4fe6fa0b9164", "committedDate": "2020-07-21T15:21:08Z", "message": "Simplify new test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7f9c58c6bd63c6a929b0ef8b6dbd2aea1f2ca48", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c7f9c58c6bd63c6a929b0ef8b6dbd2aea1f2ca48", "committedDate": "2020-07-21T15:50:34Z", "message": "Clean up future test assertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cce9d9cc175c325a646c53588f31783aeb39edf", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/6cce9d9cc175c325a646c53588f31783aeb39edf", "committedDate": "2020-07-21T15:52:46Z", "message": "Add some tests for SafeFutureAssert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81bc6818b21cc2c5f04eb9f731b812b6a7697e64", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/81bc6818b21cc2c5f04eb9f731b812b6a7697e64", "committedDate": "2020-07-21T15:53:19Z", "message": "Merge branch 'master' into issue-2291/migrate-more-calls-to-get-state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b8c11002a981b3327ef66e32e9ff324ecd33590", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/7b8c11002a981b3327ef66e32e9ff324ecd33590", "committedDate": "2020-07-21T15:57:34Z", "message": "Run spotless, fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f6bd09e9ec86b9800fa076f0d7fb751d67bf1c9", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/0f6bd09e9ec86b9800fa076f0d7fb751d67bf1c9", "committedDate": "2020-07-21T17:36:50Z", "message": "Make RecentChainData the source-of-truth for chain head data"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTA4Nzk3", "url": "https://github.com/ConsenSys/teku/pull/2391#pullrequestreview-452908797", "createdAt": "2020-07-22T00:03:10Z", "commit": {"oid": "0f6bd09e9ec86b9800fa076f0d7fb751d67bf1c9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9db2a214b91dda56f805369b7a72ae248d7b3c21", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/9db2a214b91dda56f805369b7a72ae248d7b3c21", "committedDate": "2020-07-22T14:46:01Z", "message": "Merge branch 'master' into issue-2291/migrate-more-calls-to-get-state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a310ac242e12442ee593520c50b1ab4fbb68daa0", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a310ac242e12442ee593520c50b1ab4fbb68daa0", "committedDate": "2020-07-22T14:52:27Z", "message": "Log at info level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f698791a8ec6d1fdde4ec57efacce147fd274d3", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/0f698791a8ec6d1fdde4ec57efacce147fd274d3", "committedDate": "2020-07-22T15:08:47Z", "message": "Merge branch 'master' into issue-2291/migrate-more-calls-to-get-state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "850a61ced1bf9bbeb6399198154294a25bc9049b", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/850a61ced1bf9bbeb6399198154294a25bc9049b", "committedDate": "2020-07-22T15:18:19Z", "message": "Merge branch 'master' into issue-2291/migrate-more-calls-to-get-state"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3662, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}