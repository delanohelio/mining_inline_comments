{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NDQ1MDY4", "number": 3025, "title": "Replace batches from old chains with no remaining peers", "bodyText": "PR Description\nIn the multipeer sync, when batches from previous target chains are still in the queue (on the assumption the new chain is just an extension of the old) and the old chain no longer has any available sync sources, replace the batches with ones from the new target chain.\nFor simplicity, this approach avoids having a mix of old and new batches, so finds the first incomplete batch from an old chain with no remaining sync sources and then replaces it and all following batches from old chains, regardless of whether they were complete.\nFixed Issue(s)\n#1844\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-20T03:57:51Z", "url": "https://github.com/ConsenSys/teku/pull/3025", "merged": true, "mergeCommit": {"oid": "972d6d9d8934bf5f8aa19a4dedb2d2acccf42777"}, "closed": true, "closedAt": "2020-10-20T20:56:57Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUQc0ogH2gAyNTA2NDQ1MDY4OjQ0N2Q5NjBiNGEyNGQyOWQ5MmUyNWFlZDk5MzczMjJmMDQ1NzI3MWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUeZ-vgH2gAyNTA2NDQ1MDY4OmMyMmM3ZmJiMmRmZDNkN2U5MzNkZmI2NjE0MThhM2FkNzY4ZTYxYTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "447d960b4a24d29d92e25aed9937322f0457271b", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/447d960b4a24d29d92e25aed9937322f0457271b", "committedDate": "2020-10-20T03:45:41Z", "message": "Replace batches from old chains with no remaining peers with batches from the new chain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18e8d906373ebc19e6a92ee3966d0b00c85f22ab", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/18e8d906373ebc19e6a92ee3966d0b00c85f22ab", "committedDate": "2020-10-20T03:53:02Z", "message": "Don't replace complete batches."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a44936f89b029168edad9a6b908c526172818f18", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a44936f89b029168edad9a6b908c526172818f18", "committedDate": "2020-10-20T03:57:28Z", "message": "Add another test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9f17f94359b53d4f8d56235d5597ae25408a0f4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b9f17f94359b53d4f8d56235d5597ae25408a0f4", "committedDate": "2020-10-20T04:01:45Z", "message": "Spotless."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyODA5NDEx", "url": "https://github.com/ConsenSys/teku/pull/3025#pullrequestreview-512809411", "createdAt": "2020-10-20T14:53:20Z", "commit": {"oid": "b9f17f94359b53d4f8d56235d5597ae25408a0f4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDo1MzoyMFrOHlBMCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDo1MzoyMFrOHlBMCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3ODgyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      // request data from. Remove all batch from that one to where the new chain starts and\n          \n          \n            \n                      // request data from. Remove all batches from that one to where the new chain starts and", "url": "https://github.com/ConsenSys/teku/pull/3025#discussion_r508578826", "createdAt": "2020-10-20T14:53:20Z", "author": {"login": "mbaxter"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/BatchDataRequester.java", "diffHunk": "@@ -78,6 +84,42 @@ public void fillRetrievingQueue(\n     }\n   }\n \n+  /**\n+   * All the sync sources on a given target chain may have moved to a new chain or disconnected. To\n+   * avoid getting stuck attempting and failing to request data when there are no sync sources, find\n+   * the first batch from an old chain with no sources, and replace all batches after it that are\n+   * from old chains with batches from our new chain.\n+   */\n+  private void replaceBatchesFromOldChainsWithNoSources(final TargetChain targetChain) {\n+    final Optional<Batch> firstStrandedBatch =\n+        activeBatches.stream()\n+            .filter(batch -> incompleteBatchFromOldChainWithNoPeers(targetChain, batch))\n+            .findFirst();\n+    firstStrandedBatch.ifPresent(\n+        strandedBatch -> {\n+          // We have at least one batch from an old chain which no longer has any target peers to\n+          // request data from. Remove all batch from that one to where the new chain starts and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9f17f94359b53d4f8d56235d5597ae25408a0f4"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a43c7d91346bd4b9fba2c957ee569f7698c0345", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8a43c7d91346bd4b9fba2c957ee569f7698c0345", "committedDate": "2020-10-20T20:01:10Z", "message": "Fix comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c22c7fbb2dfd3d7e933dfb661418a3ad768e61a8", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/c22c7fbb2dfd3d7e933dfb661418a3ad768e61a8", "committedDate": "2020-10-20T20:01:15Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into replace-old-batches"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3395, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}