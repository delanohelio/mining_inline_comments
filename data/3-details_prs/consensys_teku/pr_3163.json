{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2MzE2NTcw", "number": 3163, "title": "[Issue 3063] Sync from state alone", "bodyText": "PR Description\nDrop initial block argument, and accept initial weak subjectivity state alone.\nUpdate logic that currently assumes the latest finalized block will be available:\n\nRocksDbDatabase\n\nWhen building the Store:\n\nDon't require the latest finalized block to be present\nIf the initial block is missing, pull block metadata from the initial state\n\n\nUpdate finalization logic to tolerate missing finalized block if it is the initial block\n\n\nWeakSubjectivityInitializer\n\nWhen validating the initial state CLI argument against an existing database:\n\nIf the corresponding block is unavailable, try to look up the corresponding state for verification\nIf both the corresponding state and block are missing, just log a warning indicating the initial state argument couldn't be verified against the local chain data\n\n\n\n\nForkChoice\n\nWhen initializing at startup, process all available states without requiring the associated block to be available\n\n\nState regeneration\n\nLook up base states available from the Store even if the corresponding block is unavailable\n\n\nPeerChainValidator\n\nValidate peers against local finalized AnchorPoint which is kept in memory, avoiding a look up of the latest finalized block\n\n\n\nFixed Issue(s)\nPart of #3063\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-05T20:21:12Z", "url": "https://github.com/ConsenSys/teku/pull/3163", "merged": true, "mergeCommit": {"oid": "ce0169f925a54dfde8bcef01f2a6b73d5948c751"}, "closed": true, "closedAt": "2020-11-09T15:33:07Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZpOSFgH2gAyNTE2MzE2NTcwOjZkY2EzNzVlNmMyYmZmYmM4MzM0ODJkZjNhYmU5MGVjNjczNDc4ZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda2LtoAH2gAyNTE2MzE2NTcwOjlmZjRlMzI4YWRkODE4NmRmNjNlMWMyOGI1ZTAxYmI3NWQ4MGZiYWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6dca375e6c2bffbc833482df3abe90ec673478fd", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/6dca375e6c2bffbc833482df3abe90ec673478fd", "committedDate": "2020-11-05T21:27:03Z", "message": "Start up from state alone without a supplied block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fa43acb463ee6b9b78294baa2c23ea8e8a4dc5b", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8fa43acb463ee6b9b78294baa2c23ea8e8a4dc5b", "committedDate": "2020-11-05T21:27:03Z", "message": "Update PeerChainValidator to avoid looking up finalized block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3950de2a74884062777bf674c7b1e85f45359b37", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/3950de2a74884062777bf674c7b1e85f45359b37", "committedDate": "2020-11-05T21:27:03Z", "message": "Don't require latest finalized block to create Store from database"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a28fe85173b26160ed54b5c9eb510614abd89d79", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a28fe85173b26160ed54b5c9eb510614abd89d79", "committedDate": "2020-11-05T21:27:03Z", "message": "Don't require full blocks when initializing ProtoArray"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d71f0e7157871692bf2e28d4ae38a553efa808a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/4d71f0e7157871692bf2e28d4ae38a553efa808a", "committedDate": "2020-11-05T21:27:03Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a456f9b1b3df8d0591c6f42b8128e9ad602d35", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c1a456f9b1b3df8d0591c6f42b8128e9ad602d35", "committedDate": "2020-11-05T21:27:03Z", "message": "Don't require original anchor block when storing finalized chain data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b445c72a88c7ada465df10c75548bf22a850253", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/3b445c72a88c7ada465df10c75548bf22a850253", "committedDate": "2020-11-05T21:27:03Z", "message": "Validate supplied anchor state against stored state, not block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe17721c0303c18b32268772ac07eff10c4b8e0c", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/fe17721c0303c18b32268772ac07eff10c4b8e0c", "committedDate": "2020-11-05T21:27:03Z", "message": "Validate supplied anchor against state only if block unavailable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84c3166d41adfcbcbc1d4fde47150bf0cb7cebff", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/84c3166d41adfcbcbc1d4fde47150bf0cb7cebff", "committedDate": "2020-11-05T21:27:03Z", "message": "Always store anchor state so we can validate supplied anchor on restart"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "159d730499fa59c1a782075ccefba97be185fe32", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/159d730499fa59c1a782075ccefba97be185fe32", "committedDate": "2020-11-05T21:27:03Z", "message": "Update tests to account for storage of the initial state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "129576793f06296c0f3bddbabc09f8484c96f63b", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/129576793f06296c0f3bddbabc09f8484c96f63b", "committedDate": "2020-11-05T21:27:03Z", "message": "Add additional database tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91505cbbffcb610a4296b97caa26da733c4c2a47", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/91505cbbffcb610a4296b97caa26da733c4c2a47", "committedDate": "2020-11-05T21:27:03Z", "message": "Include anchor block metadata when creating Store"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62ebc910c26c8bf3b380a17df229ff5654135ece", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/62ebc910c26c8bf3b380a17df229ff5654135ece", "committedDate": "2020-11-05T21:27:03Z", "message": "Update BaseSelector to return result from Store even if block is unavailable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a9abe187f548bb07d6e7139574bebbd673afbc1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/4a9abe187f548bb07d6e7139574bebbd673afbc1", "committedDate": "2020-11-05T21:27:03Z", "message": "Don't require --Xws-initial-state argument"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf737a47cdcb63780b5fcd31c3a89b09759007fd", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/bf737a47cdcb63780b5fcd31c3a89b09759007fd", "committedDate": "2020-11-05T21:27:03Z", "message": "Remove stale comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2323def85e5429707364603949058c1d93846e98", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/2323def85e5429707364603949058c1d93846e98", "committedDate": "2020-11-05T23:13:31Z", "message": "Update PeerChainValidatorTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8543d03c79f71f1087bf889b7f828d06fc4dc3f1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8543d03c79f71f1087bf889b7f828d06fc4dc3f1", "committedDate": "2020-11-05T23:13:31Z", "message": "Revert \"Update tests to account for storage of the initial state\"\n\nThis reverts commit 159d730499fa59c1a782075ccefba97be185fe32."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a80346352b645e54f3d793c0be8cf16b40d5a7a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/0a80346352b645e54f3d793c0be8cf16b40d5a7a", "committedDate": "2020-11-05T23:13:31Z", "message": "Revert \"Always store anchor state so we can validate supplied anchor on restart\"\n\nThis reverts commit 84c3166d41adfcbcbc1d4fde47150bf0cb7cebff."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc6dee2ef3914180bdb868305f1917a347ff2cc6", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/bc6dee2ef3914180bdb868305f1917a347ff2cc6", "committedDate": "2020-11-05T23:13:31Z", "message": "Skip validation of initial state if data is unavailable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80d3a8a83e3da63dfbc66569397f54cc03881d83", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/80d3a8a83e3da63dfbc66569397f54cc03881d83", "committedDate": "2020-11-05T23:13:31Z", "message": "Set anchor block information using latest finalized state"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6b6c91db75a7be67c63d1467f7e4ee142815cc0", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a6b6c91db75a7be67c63d1467f7e4ee142815cc0", "committedDate": "2020-11-05T20:29:49Z", "message": "Remove stale comment"}, "afterCommit": {"oid": "80d3a8a83e3da63dfbc66569397f54cc03881d83", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/80d3a8a83e3da63dfbc66569397f54cc03881d83", "committedDate": "2020-11-05T23:13:31Z", "message": "Set anchor block information using latest finalized state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33ff6032c2c5daa2eec7d5746c9a6da00c6b4caa", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/33ff6032c2c5daa2eec7d5746c9a6da00c6b4caa", "committedDate": "2020-11-06T21:52:22Z", "message": "Fix DataStructureUtil - don't allow publicly supplied states"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a1395efae0d80d36dc63d437d87cb7117ec4ddb", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8a1395efae0d80d36dc63d437d87cb7117ec4ddb", "committedDate": "2020-11-06T22:07:28Z", "message": "Use safer casting approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "198f97b4ad14ae117741d3fa729b623042cffaad", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/198f97b4ad14ae117741d3fa729b623042cffaad", "committedDate": "2020-11-06T22:07:49Z", "message": "Merge branch 'master' into issue-3063/sync-from-state-alone"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODQyOTU4", "url": "https://github.com/ConsenSys/teku/pull/3163#pullrequestreview-525842958", "createdAt": "2020-11-08T20:38:49Z", "commit": {"oid": "198f97b4ad14ae117741d3fa729b623042cffaad"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMDozODo0OVrOHvaMAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMDozODo0OVrOHvaMAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NDE3OQ==", "bodyText": "If we don't actually need the block, would it be better to always create the summary purely off of the state and avoid looking up via blockProvider entirely?  I worry that if the block is sometimes available and sometimes not, it creates more corner cases that could be hard to test.  Whereas if it's never present we know the downstream code has to be able to handle it.", "url": "https://github.com/ConsenSys/teku/pull/3163#discussion_r519474179", "createdAt": "2020-11-08T20:38:49Z", "author": {"login": "ajsutton"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/stategenerator/StateRegenerationBaseSelector.java", "diffHunk": "@@ -121,13 +121,20 @@ private boolean isBetterThanCurrentRebasedStartingPoint(\n             .isGreaterThan(closestAvailableFromStore.getSlot())) {\n       return SafeFuture.completedFuture(rebasedStartingPoint);\n     }\n+\n     return blockProvider\n         .getBlock(closestAvailableFromStore.getBlockRoot())\n         .thenApply(\n-            maybeBlock ->\n-                maybeBlock.map(\n+            maybeBlock -> {\n+              if (maybeBlock.isPresent()) {\n+                return maybeBlock.map(\n                     block ->\n-                        StateAndBlockSummary.create(block, closestAvailableFromStore.getState())));\n+                        StateAndBlockSummary.create(block, closestAvailableFromStore.getState()));\n+              } else {\n+                return Optional.of(\n+                    StateAndBlockSummary.create(closestAvailableFromStore.getState()));\n+              }\n+            });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "198f97b4ad14ae117741d3fa729b623042cffaad"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ff4e328add8186df63e1c28b5e01bb75d80fbac", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/9ff4e328add8186df63e1c28b5e01bb75d80fbac", "committedDate": "2020-11-09T15:06:56Z", "message": "Merge branch 'master' into issue-3063/sync-from-state-alone"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4402, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}