{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzNDE1MzM5", "number": 3370, "title": "External signer upcheck", "bodyText": "PR Description\nRecurring external signer upcheck status log.\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-12-07T06:31:22Z", "url": "https://github.com/ConsenSys/teku/pull/3370", "merged": true, "mergeCommit": {"oid": "9392008911434c094ec8f39f4c1c48b98447fc39"}, "closed": true, "closedAt": "2020-12-07T23:26:58Z", "author": {"login": "usmansaleem"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddld6eAH2gAyNTMzNDE1MzM5OjRiZTI5YzU2OWY0ZGIxZmMyMmFhNjQxZGI3NTc1YTkxODQ2NDg4NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj91ywgH2gAyNTMzNDE1MzM5OjE0NjJjZGNiNWVlZDJhYTcxZjI3ZTc4MzljMDk4OWQ4NjNlMWE5NDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4be29c569f4db1fc22aa641db7575a9184648858", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/4be29c569f4db1fc22aa641db7575a9184648858", "committedDate": "2020-11-18T03:20:12Z", "message": "TLS configuration for external signer\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7af3e0d70367506a85dd0656d7a3bb464eebc09d", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/7af3e0d70367506a85dd0656d7a3bb464eebc09d", "committedDate": "2020-11-18T03:29:26Z", "message": "Use SecureRandomProvider\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45c27e4a4fbde7cf48f5fbf22108d85e348b2e5c", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/45c27e4a4fbde7cf48f5fbf22108d85e348b2e5c", "committedDate": "2020-11-19T01:25:55Z", "message": "modified validation condition and added unit test cases\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db8817bcf2d57a202989ff540da2e0abb41f4a06", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/db8817bcf2d57a202989ff540da2e0abb41f4a06", "committedDate": "2020-11-19T01:38:18Z", "message": "more unit tests\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc96d80e75d779003f6ca33391b2d8be8ee780b", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/dcc96d80e75d779003f6ca33391b2d8be8ee780b", "committedDate": "2020-11-19T04:12:07Z", "message": "refactor external signer httpclient factory to initialize validators\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8ee76ce89c3b8b96cf32c00d357b2ce00cc74b0", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/e8ee76ce89c3b8b96cf32c00d357b2ce00cc74b0", "committedDate": "2020-11-19T23:33:10Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50b442ab29bb1642799f24fe829c49aa950161e2", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/50b442ab29bb1642799f24fe829c49aa950161e2", "committedDate": "2020-11-23T05:11:28Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcfa97c8e90f8c19c1b3abe92c60f6c0626dde24", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/fcfa97c8e90f8c19c1b3abe92c60f6c0626dde24", "committedDate": "2020-11-24T23:24:40Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed5cc7e5dcff9d9995e9e529546ff868c54d9145", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/ed5cc7e5dcff9d9995e9e529546ff868c54d9145", "committedDate": "2020-11-25T10:49:42Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2a30ae131b80e812acc29078da8751e49216f69", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/e2a30ae131b80e812acc29078da8751e49216f69", "committedDate": "2020-11-25T12:20:55Z", "message": "Add external signer upcheck at start up\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a887ad8c7d10031f1a185c1f909a533b1204e63", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/3a887ad8c7d10031f1a185c1f909a533b1204e63", "committedDate": "2020-11-25T12:59:29Z", "message": "fixing validator unit test case\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cb79d029f5d38e4143c3ae58d70d5b3c18c680d", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/9cb79d029f5d38e4143c3ae58d70d5b3c18c680d", "committedDate": "2020-11-25T20:49:54Z", "message": "simplifying comparison\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "326b72dcb311346fc18da0edf4a732297ea0fcea", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/326b72dcb311346fc18da0edf4a732297ea0fcea", "committedDate": "2020-11-30T00:18:07Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3be45779314a75bbf94278ba40bd17e25e3fc5e", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/f3be45779314a75bbf94278ba40bd17e25e3fc5e", "committedDate": "2020-12-06T23:39:16Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_tls\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b99d0f75ddd1ebc7c77cf749013b7f701d2bee2", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/4b99d0f75ddd1ebc7c77cf749013b7f701d2bee2", "committedDate": "2020-12-07T04:49:11Z", "message": "reverting tls, keeping upcheck changes\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d68ca800e24ebe30a1fac545b00dc57936de46e9", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/d68ca800e24ebe30a1fac545b00dc57936de46e9", "committedDate": "2020-12-07T06:23:05Z", "message": "External signer status logger\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c5f98019c10b27b846c4ce5c904c46847100970", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/6c5f98019c10b27b846c4ce5c904c46847100970", "committedDate": "2020-12-07T08:38:02Z", "message": "unit test\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39d1b8fd0332a0143d7940986ad6e1c3a90e218c", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/39d1b8fd0332a0143d7940986ad6e1c3a90e218c", "committedDate": "2020-12-07T08:40:23Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_upcheck\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTAzMjQ3", "url": "https://github.com/ConsenSys/teku/pull/3370#pullrequestreview-546503247", "createdAt": "2020-12-07T20:19:20Z", "commit": {"oid": "39d1b8fd0332a0143d7940986ad6e1c3a90e218c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDoxOToyMFrOIA49FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMDoxOToyMFrOIA49FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwNDA1Mw==", "bodyText": "this is happening every 30 seconds, I can understand logging when it wasn't available and now it is back, but if it's been available I'd prefer this is a debug level... Most of the time this will equate to log noise...", "url": "https://github.com/ConsenSys/teku/pull/3370#discussion_r537804053", "createdAt": "2020-12-07T20:19:20Z", "author": {"login": "rolfyone"}, "path": "infrastructure/logging/src/main/java/tech/pegasys/teku/infrastructure/logging/StatusLogger.java", "diffHunk": "@@ -236,6 +237,17 @@ public void eth1DepositChainIdMismatch(int expectedChainId, int eth1ChainId) {\n         eth1ChainId);\n   }\n \n+  public void externalSignerStatus(final URL externalSignerUrl, boolean isReachable) {\n+    if (isReachable) {\n+      log.info(\"External signer is reachable at {}\", externalSignerUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d1b8fd0332a0143d7940986ad6e1c3a90e218c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTQwNjgz", "url": "https://github.com/ConsenSys/teku/pull/3370#pullrequestreview-546540683", "createdAt": "2020-12-07T21:13:02Z", "commit": {"oid": "39d1b8fd0332a0143d7940986ad6e1c3a90e218c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMToxMzowMlrOIA68Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMToxMzowMlrOIA68Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNjY0Ng==", "bodyText": "Can we log the exception at debug level so we have a better idea why its failing if needed?", "url": "https://github.com/ConsenSys/teku/pull/3370#discussion_r537836646", "createdAt": "2020-12-07T21:13:02Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/signer/ExternalSignerUpcheck.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.validator.client.signer;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.net.URL;\n+import java.net.http.HttpClient;\n+import java.net.http.HttpRequest;\n+import java.net.http.HttpResponse;\n+import java.time.Duration;\n+\n+public class ExternalSignerUpcheck {\n+  private final URL signingServiceUrl;\n+  private final Duration timeout;\n+  private final HttpClient httpClient;\n+\n+  public static final String UPCHECK_ENDPOINT = \"/upcheck\";\n+\n+  public ExternalSignerUpcheck(\n+      final HttpClient httpClient, final URL signingServiceUrl, final Duration timeout) {\n+    this.httpClient = httpClient;\n+    this.signingServiceUrl = signingServiceUrl;\n+    this.timeout = timeout;\n+  }\n+\n+  public boolean upcheck() {\n+    try {\n+      final HttpRequest request =\n+          HttpRequest.newBuilder()\n+              .uri(signingServiceUrl.toURI().resolve(UPCHECK_ENDPOINT))\n+              .timeout(timeout)\n+              .GET()\n+              .build();\n+      final HttpResponse<Void> response =\n+          httpClient.send(request, HttpResponse.BodyHandlers.discarding());\n+      return response.statusCode() == 200;\n+    } catch (final URISyntaxException | IOException | InterruptedException e) {\n+      return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d1b8fd0332a0143d7940986ad6e1c3a90e218c"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b1bd2b0aad20df130787f2282d9c956aabefb50", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/9b1bd2b0aad20df130787f2282d9c956aabefb50", "committedDate": "2020-12-07T23:01:01Z", "message": "Merge remote-tracking branch 'upstream/master' into external_signer_upcheck\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1462cdcb5eed2aa71f27e7839c0989d863e1a945", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/1462cdcb5eed2aa71f27e7839c0989d863e1a945", "committedDate": "2020-12-07T23:07:33Z", "message": "review suggestion - debug log in upcheck exception handler\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4352, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}