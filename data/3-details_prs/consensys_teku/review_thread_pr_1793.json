{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NzU5NTg3", "number": 1793, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzowNjo1NVrOD9CaAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzoxNjozMlrOD9CfCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MzI5MTU1OnYy", "diffSide": "RIGHT", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzowNjo1NVrOGWWB1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwMzowMDoyOFrOGWXxEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4Mjc3NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(\n          \n          \n            \n              public void shouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426082774", "createdAt": "2020-05-15T23:06:55Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -51,6 +55,18 @@ public void shouldHandleRestartWithUnrecoverableForkBlocks_prune(@TempDir final\n     testShouldHandleRestartWithUnrecoverableForkBlocks(tempDir, StateStorageMode.PRUNE);\n   }\n \n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTI0OQ==", "bodyText": "done.", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111249", "createdAt": "2020-05-16T03:00:28Z", "author": {"login": "cemozerr"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -51,6 +55,18 @@ public void shouldHandleRestartWithUnrecoverableForkBlocks_prune(@TempDir final\n     testShouldHandleRestartWithUnrecoverableForkBlocks(tempDir, StateStorageMode.PRUNE);\n   }\n \n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4Mjc3NA=="}, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MzI5MTg0OnYy", "diffSide": "RIGHT", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzowNzowNVrOGWWB_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwMzowMDo0MVrOGWXxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4MjgxNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(\n          \n          \n            \n              public void shouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426082814", "createdAt": "2020-05-15T23:07:05Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -51,6 +55,18 @@ public void shouldHandleRestartWithUnrecoverableForkBlocks_prune(@TempDir final\n     testShouldHandleRestartWithUnrecoverableForkBlocks(tempDir, StateStorageMode.PRUNE);\n   }\n \n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(\n+      @TempDir final Path tempDir) throws Exception {\n+    testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(tempDir, StateStorageMode.ARCHIVE);\n+  }\n+\n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTI4MA==", "bodyText": "done.", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111280", "createdAt": "2020-05-16T03:00:41Z", "author": {"login": "cemozerr"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -51,6 +55,18 @@ public void shouldHandleRestartWithUnrecoverableForkBlocks_prune(@TempDir final\n     testShouldHandleRestartWithUnrecoverableForkBlocks(tempDir, StateStorageMode.PRUNE);\n   }\n \n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(\n+      @TempDir final Path tempDir) throws Exception {\n+    testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(tempDir, StateStorageMode.ARCHIVE);\n+  }\n+\n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4MjgxNA=="}, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MzI5Nzg4OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V3RocksDbDao.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzoxMTo1NFrOGWWFyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwMzowMDo1MFrOGWXxPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4Mzc4NQ==", "bodyText": "This doesn't take a lot of time, so I don't think it's really worth logging the start / end of the cache initialization.", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426083785", "createdAt": "2020-05-15T23:11:54Z", "author": {"login": "mbaxter"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V3RocksDbDao.java", "diffHunk": "@@ -173,11 +174,33 @@ private void initialize() {\n     }\n \n     LOG.info(\"Initializing hot states from hot blocks\");\n-    initializeHotStates(finalizedRoot.get(), finalizedState.get(), hotBlocksByRoot);\n+    final Map<Bytes32, SignedBeaconBlock> prunedHotBlocks =\n+        initializeHotStatesAndBlocks(finalizedRoot.get(), finalizedState.get(), hotBlocksByRoot);\n     LOG.info(\"Finished initializing hot states from hot blocks\");\n+\n+    LOG.info(\"Adding hot roots to cache ordered by slots\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTI5NA==", "bodyText": "makes sense.", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111294", "createdAt": "2020-05-16T03:00:50Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V3RocksDbDao.java", "diffHunk": "@@ -173,11 +174,33 @@ private void initialize() {\n     }\n \n     LOG.info(\"Initializing hot states from hot blocks\");\n-    initializeHotStates(finalizedRoot.get(), finalizedState.get(), hotBlocksByRoot);\n+    final Map<Bytes32, SignedBeaconBlock> prunedHotBlocks =\n+        initializeHotStatesAndBlocks(finalizedRoot.get(), finalizedState.get(), hotBlocksByRoot);\n     LOG.info(\"Finished initializing hot states from hot blocks\");\n+\n+    LOG.info(\"Adding hot roots to cache ordered by slots\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4Mzc4NQ=="}, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MzMwMDg0OnYy", "diffSide": "RIGHT", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzoxMzo1N1rOGWWHiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwMzowMjoxNVrOGWXxig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDIzMg==", "bodyText": "Stale comment\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Primary chain's next block is at 7", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426084232", "createdAt": "2020-05-15T23:13:57Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTM3MA==", "bodyText": "Thanks good spot.", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111370", "createdAt": "2020-05-16T03:02:15Z", "author": {"login": "cemozerr"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDIzMg=="}, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MzMwMTUzOnYy", "diffSide": "RIGHT", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzoxNDozNFrOGWWH_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwMzowNToyNFrOGWXydA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDM1MQ==", "bodyText": "Stale comment\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Finalize at slot 15, so all the blocks before 15 would need to be pruned.", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426084351", "createdAt": "2020-05-15T23:14:34Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7\n+    chain.generateBlocksUpToSlot(10);\n+\n+    // Setup database\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+    store = Store.getForkChoiceStore(genesis.getState());\n+    database.storeGenesis(store);\n+\n+    // Finalize at slot 15, so all the blocks before 15 would need to be pruned.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTYwNA==", "bodyText": "removed.", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111604", "createdAt": "2020-05-16T03:05:24Z", "author": {"login": "cemozerr"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7\n+    chain.generateBlocksUpToSlot(10);\n+\n+    // Setup database\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+    store = Store.getForkChoiceStore(genesis.getState());\n+    database.storeGenesis(store);\n+\n+    // Finalize at slot 15, so all the blocks before 15 would need to be pruned.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDM1MQ=="}, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MzMwNDQyOnYy", "diffSide": "RIGHT", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMzoxNjozMlrOGWWJrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQwMzowNTozMFrOGWXyeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDc4MA==", "bodyText": "Stale comment\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Old states should be unavailable", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426084780", "createdAt": "2020-05-15T23:16:32Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7\n+    chain.generateBlocksUpToSlot(10);\n+\n+    // Setup database\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+    store = Store.getForkChoiceStore(genesis.getState());\n+    database.storeGenesis(store);\n+\n+    // Finalize at slot 15, so all the blocks before 15 would need to be pruned.\n+    add(chain.streamBlocksAndStates().collect(Collectors.toSet()));\n+\n+    // Close database and rebuild from disk\n+    database.close();\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+\n+    final Checkpoint finalizedCheckpoint = getCheckpointForBlock(chain.getBlockAtSlot(7));\n+    finalizeCheckpoint(finalizedCheckpoint);\n+\n+    // We should be able to access hot blocks and state\n+    final List<SignedBlockAndState> expectedHotBlocksAndStates =\n+        chain.streamBlocksAndStates(7, 10).collect(toList());\n+    assertHotBlocksAndStatesInclude(expectedHotBlocksAndStates);\n+\n+    // Old states should be unavailable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTYxMA==", "bodyText": "removed.", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111610", "createdAt": "2020-05-16T03:05:30Z", "author": {"login": "cemozerr"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7\n+    chain.generateBlocksUpToSlot(10);\n+\n+    // Setup database\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+    store = Store.getForkChoiceStore(genesis.getState());\n+    database.storeGenesis(store);\n+\n+    // Finalize at slot 15, so all the blocks before 15 would need to be pruned.\n+    add(chain.streamBlocksAndStates().collect(Collectors.toSet()));\n+\n+    // Close database and rebuild from disk\n+    database.close();\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+\n+    final Checkpoint finalizedCheckpoint = getCheckpointForBlock(chain.getBlockAtSlot(7));\n+    finalizeCheckpoint(finalizedCheckpoint);\n+\n+    // We should be able to access hot blocks and state\n+    final List<SignedBlockAndState> expectedHotBlocksAndStates =\n+        chain.streamBlocksAndStates(7, 10).collect(toList());\n+    assertHotBlocksAndStatesInclude(expectedHotBlocksAndStates);\n+\n+    // Old states should be unavailable", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDc4MA=="}, "originalCommit": {"oid": "6df092128dded96890614f9f672ac4268cbfadfd"}, "originalPosition": 77}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3803, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}