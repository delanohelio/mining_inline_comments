{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExMDA4Mjc4", "number": 3092, "title": "Avoid regenerating all finalized states", "bodyText": "PR Description\nAfter a long period of non-finalization, instead of regenerating states to store the finalized state snapshots, select from the ones that are already available either from in-memory or stored every couple of epochs in the hot db.\nFixed Issue(s)\nfixes #2616\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-27T19:37:08Z", "url": "https://github.com/ConsenSys/teku/pull/3092", "merged": true, "mergeCommit": {"oid": "05b8ecaefec0c39d4d2840df069be5c49c4435b6"}, "closed": true, "closedAt": "2020-10-27T20:20:35Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWuODSgH2gAyNTExMDA4Mjc4OjI2YzVlYTQxYjQyY2U2YjZjNTNiYTdmZWQyN2FhNDNhMTg2YzI0YTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWunJvAH2gAyNTExMDA4Mjc4OjU2ODY1ZGIxYjBjZWMzZjQzMzYxM2I3NGMxYjY1NzlmNmMzMDVkYWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "26c5ea41b42ce6b6c53ba7fed27aa43a186c24a7", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/26c5ea41b42ce6b6c53ba7fed27aa43a186c24a7", "committedDate": "2020-10-27T19:34:33Z", "message": "Avoid regenerating all finalized states"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a51f39130e82960e771e167b671d198673e813d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1a51f39130e82960e771e167b671d198673e813d", "committedDate": "2020-10-27T19:37:17Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into fix-finalization-pause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f99ef5200f076f9aabb79c945ed0e6cb502c1be0", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/f99ef5200f076f9aabb79c945ed0e6cb502c1be0", "committedDate": "2020-10-27T19:47:24Z", "message": "Spotless."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDkzMzIy", "url": "https://github.com/ConsenSys/teku/pull/3092#pullrequestreview-518093322", "createdAt": "2020-10-27T19:58:18Z", "commit": {"oid": "f99ef5200f076f9aabb79c945ed0e6cb502c1be0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTo1ODoxOFrOHpOj7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTo1ODoxOFrOHpOj7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk5MjIzNw==", "bodyText": "Why are we filtering for epoch boundary states?  Is this because we're storing hot states at every epoch boundary?", "url": "https://github.com/ConsenSys/teku/pull/3092#discussion_r512992237", "createdAt": "2020-10-27T19:58:18Z", "author": {"login": "mbaxter"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/server/AbstractDatabaseTest.java", "diffHunk": "@@ -495,7 +495,19 @@ public void handleFinalizationWhenCacheLimitsExceeded() {\n     assertThat(tx.commit()).isCompleted();\n \n     // All finalized blocks and states should be available\n-    assertFinalizedBlocksAndStatesAvailable(newBlocks);\n+    final List<SignedBeaconBlock> expectedFinalizedBlocks =\n+        newBlocks.stream().map(SignedBlockAndState::getBlock).collect(toList());\n+    final Map<Bytes32, BeaconState> expectedFinalizedStates =\n+        newBlocks.stream()\n+            .filter(\n+                blockAndState ->\n+                    blockAndState\n+                        .getSlot()\n+                        .equals(compute_start_slot_at_epoch(blockAndState.getSlot())))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f99ef5200f076f9aabb79c945ed0e6cb502c1be0"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56865db1b0cec3f433613b74c1b6579f6c305dad", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/56865db1b0cec3f433613b74c1b6579f6c305dad", "committedDate": "2020-10-27T20:01:58Z", "message": "Add comment explaining why not all states are available."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3269, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}