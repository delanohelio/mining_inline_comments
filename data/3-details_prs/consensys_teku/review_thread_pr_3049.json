{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3OTk4MTI5", "number": 3049, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0MjoxMlrOEwl-Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0Njo1NVrOEwmBfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5Mzg5MjM1OnYy", "diffSide": "RIGHT", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/reputation/ReputationManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0MjoxMlrOHmQWsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNjowOTo0N1rOHmR6oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NTg5MA==", "bodyText": "this peer is then unsuitable until restart, is that a bit harsh? should it just have a 'naughty corner' timeout?", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509875890", "createdAt": "2020-10-22T04:42:12Z", "author": {"login": "rolfyone"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/reputation/ReputationManager.java", "diffHunk": "@@ -121,5 +141,17 @@ private boolean isLocallyConsideredUnsuitable(\n       return locallyInitiated\n           && reason.map(r -> !LOCAL_TEMPORARY_DISCONNECT_REASONS.contains(r)).orElse(false);\n     }\n+\n+    public boolean adjustReputation(final ReputationAdjustment effect) {\n+      final int newScore =\n+          score.updateAndGet(\n+              current -> Math.min(MAX_REPUTATION_SCORE, current + effect.getScoreChange()));\n+      final boolean shouldDisconnect = newScore <= DISCONNECT_THRESHOLD;\n+      if (shouldDisconnect) {\n+        // Prevent our node from connecting out to the remote peer.\n+        unsuitable = true;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkwMTQ3Mw==", "bodyText": "The peer can still connect to it, we just won't initiate a connection to the peer anymore.  Given they just tried to feed us bad info that seems wise. At some point we will likely need to go further and completely ban them, though that likely would be an even lower score (ie first time you just get disconnected, second time you get banned kind of policy).", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509901473", "createdAt": "2020-10-22T06:09:47Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/reputation/ReputationManager.java", "diffHunk": "@@ -121,5 +141,17 @@ private boolean isLocallyConsideredUnsuitable(\n       return locallyInitiated\n           && reason.map(r -> !LOCAL_TEMPORARY_DISCONNECT_REASONS.contains(r)).orElse(false);\n     }\n+\n+    public boolean adjustReputation(final ReputationAdjustment effect) {\n+      final int newScore =\n+          score.updateAndGet(\n+              current -> Math.min(MAX_REPUTATION_SCORE, current + effect.getScoreChange()));\n+      final boolean shouldDisconnect = newScore <= DISCONNECT_THRESHOLD;\n+      if (shouldDisconnect) {\n+        // Prevent our node from connecting out to the remote peer.\n+        unsuitable = true;\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NTg5MA=="}, "originalCommit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5Mzg5ODAxOnYy", "diffSide": "RIGHT", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/reputation/ReputationManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0NToyNlrOHmQZ3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNjoxMDoxOVrOHmR7bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NjcwMw==", "bodyText": "we create 'shouldDisconnect, set unsuitable to the value of disconnect, return disconnect - maybe just store the value in unsuitable and return that?", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509876703", "createdAt": "2020-10-22T04:45:26Z", "author": {"login": "rolfyone"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/reputation/ReputationManager.java", "diffHunk": "@@ -121,5 +141,17 @@ private boolean isLocallyConsideredUnsuitable(\n       return locallyInitiated\n           && reason.map(r -> !LOCAL_TEMPORARY_DISCONNECT_REASONS.contains(r)).orElse(false);\n     }\n+\n+    public boolean adjustReputation(final ReputationAdjustment effect) {\n+      final int newScore =\n+          score.updateAndGet(\n+              current -> Math.min(MAX_REPUTATION_SCORE, current + effect.getScoreChange()));\n+      final boolean shouldDisconnect = newScore <= DISCONNECT_THRESHOLD;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkwMTY3OA==", "bodyText": "The peer may have already been marked unsuitable because of repeated failures to connect (e.g if the node is behind a firewall so can connect out but can't accept incoming connections).", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509901678", "createdAt": "2020-10-22T06:10:19Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/reputation/ReputationManager.java", "diffHunk": "@@ -121,5 +141,17 @@ private boolean isLocallyConsideredUnsuitable(\n       return locallyInitiated\n           && reason.map(r -> !LOCAL_TEMPORARY_DISCONNECT_REASONS.contains(r)).orElse(false);\n     }\n+\n+    public boolean adjustReputation(final ReputationAdjustment effect) {\n+      final int newScore =\n+          score.updateAndGet(\n+              current -> Math.min(MAX_REPUTATION_SCORE, current + effect.getScoreChange()));\n+      final boolean shouldDisconnect = newScore <= DISCONNECT_THRESHOLD;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NjcwMw=="}, "originalCommit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MzkwMDc5OnYy", "diffSide": "RIGHT", "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/batches/PeerScoringConflictResolutionStrategy.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNDo0Njo1NVrOHmQbYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNjoxMToyN1rOHmR9Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NzA4OQ==", "bodyText": "unless we're at 0 reputation, we wont be disconnecting here...", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509877089", "createdAt": "2020-10-22T04:46:55Z", "author": {"login": "rolfyone"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/batches/PeerScoringConflictResolutionStrategy.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync.multipeer.batches;\n+\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.LARGE_PENALTY;\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.SMALL_PENALTY;\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.SMALL_REWARD;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.networking.eth2.peers.SyncSource;\n+\n+public class PeerScoringConflictResolutionStrategy implements ConflictResolutionStrategy {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  @Override\n+  public void verifyBatch(final Batch batch, final SyncSource originalSource) {\n+    LOG.debug(\"Invalidating batch {}\", batch);\n+    // We aren't sure if this peer is providing bad blocks or some other peer, so apply a small\n+    // penalty to the peer and re-download the data for the batch. If the peer is honest, it should\n+    // have more confirmed batches than contested and the small penalty to reputation won't matter.\n+    // If it's dishonest the penalties will add up until it is disconnected.\n+    originalSource.adjustReputation(SMALL_PENALTY);\n+    batch.markAsInvalid();\n+  }\n+\n+  @Override\n+  public void reportInvalidBatch(final Batch batch, final SyncSource source) {\n+    LOG.debug(\"Disconnecting peer {} for providing invalid batch data {}\", source, batch);\n+    source.adjustReputation(LARGE_PENALTY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkwMjExOQ==", "bodyText": "Fixed log messages to match what we wound up doing.", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509902119", "createdAt": "2020-10-22T06:11:27Z", "author": {"login": "ajsutton"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/batches/PeerScoringConflictResolutionStrategy.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync.multipeer.batches;\n+\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.LARGE_PENALTY;\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.SMALL_PENALTY;\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.SMALL_REWARD;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.networking.eth2.peers.SyncSource;\n+\n+public class PeerScoringConflictResolutionStrategy implements ConflictResolutionStrategy {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  @Override\n+  public void verifyBatch(final Batch batch, final SyncSource originalSource) {\n+    LOG.debug(\"Invalidating batch {}\", batch);\n+    // We aren't sure if this peer is providing bad blocks or some other peer, so apply a small\n+    // penalty to the peer and re-download the data for the batch. If the peer is honest, it should\n+    // have more confirmed batches than contested and the small penalty to reputation won't matter.\n+    // If it's dishonest the penalties will add up until it is disconnected.\n+    originalSource.adjustReputation(SMALL_PENALTY);\n+    batch.markAsInvalid();\n+  }\n+\n+  @Override\n+  public void reportInvalidBatch(final Batch batch, final SyncSource source) {\n+    LOG.debug(\"Disconnecting peer {} for providing invalid batch data {}\", source, batch);\n+    source.adjustReputation(LARGE_PENALTY);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NzA4OQ=="}, "originalCommit": {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3072, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}