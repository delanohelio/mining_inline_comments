{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NDE1MDQy", "number": 3315, "title": "Optimize ValidatorsUtil.getValidatorIndex", "bodyText": "PR Description\nThis PR is on top of #3314.\nEagerly pre-cache pubKey => validatorIndex mapping when caching the opposite validatorIndex => pubKey mapping in ValidatorsUtil.getValidatorPubKey() .\nThis eliminates 'quadratic' complexity of ValidatorsUtil.getValidatorIndex\nTwo PRs (this + #3314) drastically improves the performance of the case described in #3294 (roughly 100ms instead of minutes)\nFixed Issue(s)\nFix #3294\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-25T12:37:10Z", "url": "https://github.com/ConsenSys/teku/pull/3315", "merged": true, "mergeCommit": {"oid": "02f5443f760987c96a693a1a42070025c5e0f7d7"}, "closed": true, "closedAt": "2020-11-26T09:37:34Z", "author": {"login": "Nashatyrev"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf7lpAAH2gAyNTI3NDE1MDQyOmZkN2VmOTFlMTFiNmU2YmI4OTkyYmM1YjgzNTRiMzQwNjYwOTE0N2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgPcUPgH2gAyNTI3NDE1MDQyOmUyNDE4YjFlNTI3NjhiY2E4ZDhiNTIxOWM3MTcwZDNiZGE0ZWQ0YTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fd7ef91e11b6e6bb8992bc5b8354b3406609147c", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/fd7ef91e11b6e6bb8992bc5b8354b3406609147c", "committedDate": "2020-11-25T10:14:24Z", "message": "Make Validator.getPubkey() to return Bytes48 instead of construction-expensive BLSPublicKey\nUse ValidatorsUtil.getValidatorPubKey where possible to make use of BLSPublicKey instance cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "803cfeb706d74352860a966e1383b59cc2e4a2d1", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/803cfeb706d74352860a966e1383b59cc2e4a2d1", "committedDate": "2020-11-25T10:34:25Z", "message": "Add javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d88b16c422c517e3388e0afe28cacad0df637ab6", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d88b16c422c517e3388e0afe28cacad0df637ab6", "committedDate": "2020-11-25T11:12:47Z", "message": "Fix Validator SSZ"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9fc54ab10669681a35c1b2620f96584690c1cc7", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e9fc54ab10669681a35c1b2620f96584690c1cc7", "committedDate": "2020-11-25T11:54:18Z", "message": "Fix ValidatorApiHandler.createAttesterDuties handling of invalid validatorIndex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ebac5eb2ad425009742347ec27d40b2fd51550d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/0ebac5eb2ad425009742347ec27d40b2fd51550d", "committedDate": "2020-11-25T12:17:23Z", "message": "Eagerly pre-cache pubKey => validatorIndex mapping in ValidatorsUtil.getValidatorPubKey"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aebecd684752f5c3f67fa4421d38e3181de5523", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/0aebecd684752f5c3f67fa4421d38e3181de5523", "committedDate": "2020-11-25T12:29:18Z", "message": "Add opposite pubkey => index caching only on index => pubkey cache miss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18d4c4e4212548a378a24f9a7ef0adea87645514", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/18d4c4e4212548a378a24f9a7ef0adea87645514", "committedDate": "2020-11-25T12:39:13Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3bcd471cd515f9601767b60df51fdea0b49e2eb", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d3bcd471cd515f9601767b60df51fdea0b49e2eb", "committedDate": "2020-11-25T22:21:27Z", "message": "Merge branch 'master' into optimize/get-validator-index-by-pubkey"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODkwMzIy", "url": "https://github.com/ConsenSys/teku/pull/3315#pullrequestreview-538890322", "createdAt": "2020-11-25T22:47:18Z", "commit": {"oid": "18d4c4e4212548a378a24f9a7ef0adea87645514"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMjo0NzoxOVrOH6GK7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMjo0NzoxOVrOH6GK7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY4MDU1Nw==", "bodyText": "I like this - nice and simple but very effective.", "url": "https://github.com/ConsenSys/teku/pull/3315#discussion_r530680557", "createdAt": "2020-11-25T22:47:19Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/ValidatorsUtil.java", "diffHunk": "@@ -77,7 +77,19 @@ public static boolean is_eligible_for_activation(BeaconState state, Validator va\n     return Optional.of(\n         BeaconStateCache.getTransitionCaches(state)\n             .getValidatorsPubKeys()\n-            .get(validatorIndex, i -> state.getValidators().get(i.intValue()).getPubkey()));\n+            .get(\n+                validatorIndex,\n+                i -> {\n+                  BLSPublicKey pubKey =\n+                      BLSPublicKey.fromBytesCompressed(\n+                          state.getValidators().get(i.intValue()).getPubkey());\n+\n+                  // eagerly pre-cache pubKey => validatorIndex mapping\n+                  BeaconStateCache.getTransitionCaches(state)\n+                      .getValidatorIndex()\n+                      .invalidateWithNewValue(pubKey, i.intValue());\n+                  return pubKey;\n+                }));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18d4c4e4212548a378a24f9a7ef0adea87645514"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8596af11603f587a622c3e039ecc8678255c22e8", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8596af11603f587a622c3e039ecc8678255c22e8", "committedDate": "2020-11-26T08:09:43Z", "message": "Throw BlocksProcessingException instead of NoSuchelementException\n\nCo-authored-by: Adrian Sutton <adrian@symphonious.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7679f337aa64f39129226adc56653b863fe5aff0", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/7679f337aa64f39129226adc56653b863fe5aff0", "committedDate": "2020-11-26T08:26:11Z", "message": "Just return false from verifySignature() when slashing proposer index is invalid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3042c92e86b6a509f420ffc2d5e0987d3c9c0df", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d3042c92e86b6a509f420ffc2d5e0987d3c9c0df", "committedDate": "2020-11-26T08:40:07Z", "message": "Shorten the code\n\nCo-authored-by: Adrian Sutton <adrian@symphonious.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0b0c699878bce301426294320dd58107072651", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/ed0b0c699878bce301426294320dd58107072651", "committedDate": "2020-11-26T08:46:59Z", "message": "Just return false from verifySignature() when voluntary exit validator index is invalid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dabded072f40eaaed51b5b611935321e2c1e8e25", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/dabded072f40eaaed51b5b611935321e2c1e8e25", "committedDate": "2020-11-26T08:48:44Z", "message": "Merge branch 'fix/use-validator-pubkey-cache' of https://github.com/Nashatyrev/artemis into fix/use-validator-pubkey-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ab78ffbbd6fad063a9d702734e298cc288e9d20", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9ab78ffbbd6fad063a9d702734e298cc288e9d20", "committedDate": "2020-11-26T08:49:37Z", "message": "Merge branch 'master' into fix/use-validator-pubkey-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f2e03da07c7a088082563f0efee708fd4a798fe", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/0f2e03da07c7a088082563f0efee708fd4a798fe", "committedDate": "2020-11-26T09:06:04Z", "message": "Sptoless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14f7c8763b17d0e838983d220a8419bbca85b641", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/14f7c8763b17d0e838983d220a8419bbca85b641", "committedDate": "2020-11-26T09:21:12Z", "message": "Merge remote-tracking branch 'ConsenSys/master' into fix/use-validator-pubkey-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2418b1e52768bca8d8b5219c7170d3bda4ed4a8", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e2418b1e52768bca8d8b5219c7170d3bda4ed4a8", "committedDate": "2020-11-26T09:22:19Z", "message": "Merge branch 'fix/use-validator-pubkey-cache' into optimize/get-validator-index-by-pubkey"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4316, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}