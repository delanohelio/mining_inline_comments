{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0OTY5MjY5", "number": 3139, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMzo0MjowNlrOE1D6aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowMToxNlrOE1ZVFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MDc0MDg5OnYy", "diffSide": "RIGHT", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMzo0MjowNlrOHtIImQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDozMDoyMVrOHtonPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA4MTI0MQ==", "bodyText": "I don't think this should be two different options.  Ultimately I think we want ``--validators-performance-tracking-modewhich can be one ofNONE`, `LOGGING`, `METRICS` or `ALL`.  We don't want to break backwards compatibility though so I'd keep `--validators-perforamance-tracking-enabled` but hide it, make it a `Boolean` with default `null` and then when it's set false makes the mode `NONE` and true makes it `ALL`.\nAnd I'd keep the default mode as ALL so this is enabled by default.  If people don't want the logs they can silence them but otherwise they don't tend to discover them.", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517081241", "createdAt": "2020-11-04T03:42:06Z", "author": {"login": "ajsutton"}, "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java", "diffHunk": "@@ -93,11 +94,19 @@\n   @Option(\n       names = {\"--validators-performance-tracking-enabled\"},\n       paramLabel = \"<BOOLEAN>\",\n-      description = \"Enable validator performance tracking and logging\",\n+      description = \"Enable validator performance tracking\",\n       fallbackValue = \"true\",\n       arity = \"0..1\")\n   private boolean validatorPerformanceTrackingEnabled = false;\n \n+  @Option(\n+      names = {\"--validators-performance-tracking-mode\"},\n+      paramLabel = \"<TRACKING_MODE>\",\n+      description = \"Set strategy for handling performance tracking\",\n+      arity = \"1\")\n+  private ValidatorPerformanceTrackingMode validatorPerformanceTrackingMode =\n+      ValidatorPerformanceTrackingMode.ALL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a604f83de3b08b8a24181abd3400376eb237aa33"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxMzM3NQ==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517613375", "createdAt": "2020-11-04T20:30:21Z", "author": {"login": "cemozerr"}, "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java", "diffHunk": "@@ -93,11 +94,19 @@\n   @Option(\n       names = {\"--validators-performance-tracking-enabled\"},\n       paramLabel = \"<BOOLEAN>\",\n-      description = \"Enable validator performance tracking and logging\",\n+      description = \"Enable validator performance tracking\",\n       fallbackValue = \"true\",\n       arity = \"0..1\")\n   private boolean validatorPerformanceTrackingEnabled = false;\n \n+  @Option(\n+      names = {\"--validators-performance-tracking-mode\"},\n+      paramLabel = \"<TRACKING_MODE>\",\n+      description = \"Set strategy for handling performance tracking\",\n+      arity = \"1\")\n+  private ValidatorPerformanceTrackingMode validatorPerformanceTrackingMode =\n+      ValidatorPerformanceTrackingMode.ALL;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA4MTI0MQ=="}, "originalCommit": {"oid": "a604f83de3b08b8a24181abd3400376eb237aa33"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIzMDM1OnYy", "diffSide": "RIGHT", "path": "util/src/main/java/tech/pegasys/teku/util/config/ValidatorPerformanceTrackingMode.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1NTowNlrOHtpXig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMjoxMDozOVrOHtrgVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNTczOA==", "bodyText": "Does this get used anywhere?", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517625738", "createdAt": "2020-11-04T20:55:06Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/ValidatorPerformanceTrackingMode.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import java.util.Objects;\n+\n+public enum ValidatorPerformanceTrackingMode {\n+  LOGGING,\n+  METRICS,\n+  ALL,\n+  NONE;\n+\n+  static ValidatorPerformanceTrackingMode fromString(final String value) {\n+    final String normalizedValue = value.trim().toUpperCase();\n+    for (ValidatorPerformanceTrackingMode mode : ValidatorPerformanceTrackingMode.values()) {\n+      if (Objects.equals(mode.name(), normalizedValue)) {\n+        return mode;\n+      }\n+    }\n+    throw new IllegalArgumentException(\"Unknown value supplied: \" + value);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY2MDc1Ng==", "bodyText": "Removed.", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517660756", "createdAt": "2020-11-04T22:10:39Z", "author": {"login": "cemozerr"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/ValidatorPerformanceTrackingMode.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import java.util.Objects;\n+\n+public enum ValidatorPerformanceTrackingMode {\n+  LOGGING,\n+  METRICS,\n+  ALL,\n+  NONE;\n+\n+  static ValidatorPerformanceTrackingMode fromString(final String value) {\n+    final String normalizedValue = value.trim().toUpperCase();\n+    for (ValidatorPerformanceTrackingMode mode : ValidatorPerformanceTrackingMode.values()) {\n+      if (Objects.equals(mode.name(), normalizedValue)) {\n+        return mode;\n+      }\n+    }\n+    throw new IllegalArgumentException(\"Unknown value supplied: \" + value);\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNTczOA=="}, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDIzODU1OnYy", "diffSide": "RIGHT", "path": "services/beaconchain/src/main/java/tech/pegasys/teku/services/beaconchain/BeaconChainController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1NzozN1rOHtpclw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMjoxNzoyOFrOHtrr6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNzAzMQ==", "bodyText": "nit: I'd suggest having a ValidatorPerformanceTrackingMode.isEnabled() method (it would do this != NONE check but just makes things more readable).", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517627031", "createdAt": "2020-11-04T20:57:37Z", "author": {"login": "ajsutton"}, "path": "services/beaconchain/src/main/java/tech/pegasys/teku/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -344,10 +345,15 @@ private void initRecentBlockFetcher() {\n \n   private void initPerformanceTracker() {\n     LOG.debug(\"BeaconChainController.initPerformanceTracker()\");\n-    if (beaconConfig.validatorConfig().isValidatorPerformanceTrackingEnabled()) {\n+    ValidatorPerformanceTrackingMode mode =\n+        beaconConfig.validatorConfig().getValidatorPerformanceTrackingMode();\n+    if (mode != ValidatorPerformanceTrackingMode.NONE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY2MzcyMg==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517663722", "createdAt": "2020-11-04T22:17:28Z", "author": {"login": "cemozerr"}, "path": "services/beaconchain/src/main/java/tech/pegasys/teku/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -344,10 +345,15 @@ private void initRecentBlockFetcher() {\n \n   private void initPerformanceTracker() {\n     LOG.debug(\"BeaconChainController.initPerformanceTracker()\");\n-    if (beaconConfig.validatorConfig().isValidatorPerformanceTrackingEnabled()) {\n+    ValidatorPerformanceTrackingMode mode =\n+        beaconConfig.validatorConfig().getValidatorPerformanceTrackingMode();\n+    if (mode != ValidatorPerformanceTrackingMode.NONE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNzAzMQ=="}, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI0NjI0OnYy", "diffSide": "RIGHT", "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowMDowNFrOHtphag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMjoyMDozMVrOHtrxAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyODI2Ng==", "bodyText": "I think this should probably just be done in ValidatorOptions.configure and this class would only take a ValidatorPerformanceTrackingMode so the backwards compatibility is isolated.", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517628266", "createdAt": "2020-11-04T21:00:04Z", "author": {"login": "ajsutton"}, "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java", "diffHunk": "@@ -58,17 +60,23 @@ private ValidatorConfig(\n     this.validatorExternalSignerUrl = validatorExternalSignerUrl;\n     this.validatorExternalSignerTimeout = validatorExternalSignerTimeout;\n     this.graffiti = graffiti;\n-    this.validatorPerformanceTrackingEnabled = validatorPerformanceTrackingEnabled;\n     this.validatorKeystoreLockingEnabled = validatorKeystoreLockingEnabled;\n     this.beaconNodeApiEndpoint = beaconNodeApiEndpoint;\n+    if (validatorPerformanceTrackingEnabled == null) {\n+      this.validatorPerformanceTrackingMode = validatorPerformanceTrackingMode;\n+    } else if (validatorPerformanceTrackingEnabled) {\n+      this.validatorPerformanceTrackingMode = ValidatorPerformanceTrackingMode.ALL;\n+    } else {\n+      this.validatorPerformanceTrackingMode = ValidatorPerformanceTrackingMode.NONE;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY2NTAyNA==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517665024", "createdAt": "2020-11-04T22:20:31Z", "author": {"login": "cemozerr"}, "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java", "diffHunk": "@@ -58,17 +60,23 @@ private ValidatorConfig(\n     this.validatorExternalSignerUrl = validatorExternalSignerUrl;\n     this.validatorExternalSignerTimeout = validatorExternalSignerTimeout;\n     this.graffiti = graffiti;\n-    this.validatorPerformanceTrackingEnabled = validatorPerformanceTrackingEnabled;\n     this.validatorKeystoreLockingEnabled = validatorKeystoreLockingEnabled;\n     this.beaconNodeApiEndpoint = beaconNodeApiEndpoint;\n+    if (validatorPerformanceTrackingEnabled == null) {\n+      this.validatorPerformanceTrackingMode = validatorPerformanceTrackingMode;\n+    } else if (validatorPerformanceTrackingEnabled) {\n+      this.validatorPerformanceTrackingMode = ValidatorPerformanceTrackingMode.ALL;\n+    } else {\n+      this.validatorPerformanceTrackingMode = ValidatorPerformanceTrackingMode.NONE;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyODI2Ng=="}, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NDI0OTgxOnYy", "diffSide": "RIGHT", "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/performance/DefaultPerformanceTracker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowMToxNlrOHtpjrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMjoxNzoyMFrOHtrrsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyODg0Ng==", "bodyText": "nit: Possibly simpler as:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  switch (mode) {\n          \n          \n            \n                    case LOGGING:\n          \n          \n            \n                      statusLogger.performance(attestationPerformance.toString());\n          \n          \n            \n                      break;\n          \n          \n            \n                    case METRICS:\n          \n          \n            \n                      validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n          \n          \n            \n                      break;\n          \n          \n            \n                    case ALL:\n          \n          \n            \n                      statusLogger.performance(attestationPerformance.toString());\n          \n          \n            \n                      validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n          \n          \n            \n                      break;\n          \n          \n            \n                    case NONE:\n          \n          \n            \n                      throw new IllegalStateException(\n          \n          \n            \n                          \"Performance Tracker should not be running in NONE mode.\");\n          \n          \n            \n                  if (mode.isLoggingEnabled()) {\n          \n          \n            \n                      statusLogger.performance(attestationPerformance.toString());\n          \n          \n            \n                 }\n          \n          \n            \n                 if (mode.isMetricsEnabled()) {\n          \n          \n            \n                    validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n          \n          \n            \n                 }", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517628846", "createdAt": "2020-11-04T21:01:16Z", "author": {"login": "ajsutton"}, "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/performance/DefaultPerformanceTracker.java", "diffHunk": "@@ -104,10 +108,23 @@ public void onSlot(UInt64 slot) {\n       UInt64 analyzedEpoch = currentEpoch.minus(ATTESTATION_INCLUSION_RANGE);\n       AttestationPerformance attestationPerformance =\n           getAttestationPerformanceForEpoch(currentEpoch, analyzedEpoch);\n-      statusLogger.performance(attestationPerformance.toString());\n+      switch (mode) {\n+        case LOGGING:\n+          statusLogger.performance(attestationPerformance.toString());\n+          break;\n+        case METRICS:\n+          validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n+          break;\n+        case ALL:\n+          statusLogger.performance(attestationPerformance.toString());\n+          validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n+          break;\n+        case NONE:\n+          throw new IllegalStateException(\n+              \"Performance Tracker should not be running in NONE mode.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY2MzY2Nw==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517663667", "createdAt": "2020-11-04T22:17:20Z", "author": {"login": "cemozerr"}, "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/performance/DefaultPerformanceTracker.java", "diffHunk": "@@ -104,10 +108,23 @@ public void onSlot(UInt64 slot) {\n       UInt64 analyzedEpoch = currentEpoch.minus(ATTESTATION_INCLUSION_RANGE);\n       AttestationPerformance attestationPerformance =\n           getAttestationPerformanceForEpoch(currentEpoch, analyzedEpoch);\n-      statusLogger.performance(attestationPerformance.toString());\n+      switch (mode) {\n+        case LOGGING:\n+          statusLogger.performance(attestationPerformance.toString());\n+          break;\n+        case METRICS:\n+          validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n+          break;\n+        case ALL:\n+          statusLogger.performance(attestationPerformance.toString());\n+          validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n+          break;\n+        case NONE:\n+          throw new IllegalStateException(\n+              \"Performance Tracker should not be running in NONE mode.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyODg0Ng=="}, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3137, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}