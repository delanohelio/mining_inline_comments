{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5MzI2MDQ1", "number": 1531, "title": "Use BitSet as backing for Bitlist rather than byte[]", "bodyText": "PR Description\nThe Bitlist implementation was allocating a byte[] as backing data, storing one byte per bit in the bitlist.  Instead, use a BitSet as backing which combines bits into long values reducing the memory required.\nThe BitSet backing version is also faster than the byte[] version. The benchmarks are definitely not polished and the error margin is high but they are providing quite stable results on multiple runs.\nOld implementation:\nBenchmark                                        Mode  Cnt         Score        Error  Units\nSSZTypes.BitlistBenchmark.countSetBits          thrpt   50   21490939.125 \u00b1  114301.740  ops/s\nSSZTypes.BitlistBenchmark.getAttestingIndicies  thrpt   50    5192560.185 \u00b1   38629.721  ops/s\nSSZTypes.BitlistBenchmark.intersects            thrpt   50   24193985.018 \u00b1  122543.575  ops/s\nSSZTypes.BitlistBenchmark.setAllBits            thrpt   50   14888628.761 \u00b1   68087.381  ops/s\n\nNew implementation:\nBenchmark                                        Mode  Cnt          Score         Error  Units\nSSZTypes.BitlistBenchmark.countSetBits          thrpt   50  248619832.534 \u00b1  798031.959  ops/s\nSSZTypes.BitlistBenchmark.getAttestingIndicies  thrpt   50    8242911.743 \u00b1   44240.344  ops/s\nSSZTypes.BitlistBenchmark.intersects            thrpt   50  332067959.309 \u00b1 1628059.852  ops/s\nSSZTypes.BitlistBenchmark.setAllBits            thrpt   50   37762009.852 \u00b1 1689423.217  ops/s", "createdAt": "2020-04-06T00:42:51Z", "url": "https://github.com/ConsenSys/teku/pull/1531", "merged": true, "mergeCommit": {"oid": "9b4fa56713762c7c146aa961dd0af72f81b2658d"}, "closed": true, "closedAt": "2020-04-06T20:55:38Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUywRmgH2gAyMzk5MzI2MDQ1OmE0ZGM2MzBlODU4MzlhOThmODc4YWNkOGYzYTUxODg2Mzg4MDAyNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVE9GbgH2gAyMzk5MzI2MDQ1OjRmNWY5YTBjMDE2MjA4MDQ1M2RlMjNlOGMyY2M3OWI1NTU5YmJhZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a4dc630e85839a98f878acd8f3a5188638800273", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a4dc630e85839a98f878acd8f3a5188638800273", "committedDate": "2020-04-05T23:32:33Z", "message": "Switch Bitlist to use BitSet as a backing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a84e9e36079634f3e9aacb1180fe7f8811e379e6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a84e9e36079634f3e9aacb1180fe7f8811e379e6", "committedDate": "2020-04-06T00:27:21Z", "message": "Add more tests for bitlist and a benchmark."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f6e569090c7dd4cbd87a948e4ea7f0c4aec96e6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/5f6e569090c7dd4cbd87a948e4ea7f0c4aec96e6", "committedDate": "2020-04-06T00:36:13Z", "message": "Undo changes to Attestation and AttestationData."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7a6ab573fe3614b2a53a8e9841d3d5e7f4d8624", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/c7a6ab573fe3614b2a53a8e9841d3d5e7f4d8624", "committedDate": "2020-04-06T00:38:29Z", "message": "Undo new method in AttestationUtil."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc96c4df2a6d84c1cd6af0bdff5fe65b3fa3f2a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4fc96c4df2a6d84c1cd6af0bdff5fe65b3fa3f2a", "committedDate": "2020-04-06T00:42:14Z", "message": "More fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6645498064bee459abbbbe0d354e29212f78219", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d6645498064bee459abbbbe0d354e29212f78219", "committedDate": "2020-04-06T09:51:18Z", "message": "Merge branch 'master' into bitlist"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjAwODYy", "url": "https://github.com/ConsenSys/teku/pull/1531#pullrequestreview-388600862", "createdAt": "2020-04-06T20:41:41Z", "commit": {"oid": "d6645498064bee459abbbbe0d354e29212f78219"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDo0MTo0MVrOGBpF5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDo0MTo0MVrOGBpF5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3NTAxNA==", "bodyText": "Are you accounting for the 0 index being set here?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                for (int i = data.nextSetBit(0); i > 0; i = data.nextSetBit(i + 1)) {\n          \n          \n            \n                for (int i = data.nextSetBit(0); i >= 0; i = data.nextSetBit(i + 1)) {", "url": "https://github.com/ConsenSys/teku/pull/1531#discussion_r404375014", "createdAt": "2020-04-06T20:41:41Z", "author": {"login": "cemozerr"}, "path": "ssz/src/main/java/tech/pegasys/artemis/util/SSZTypes/Bitlist.java", "diffHunk": "@@ -13,41 +13,63 @@\n \n package tech.pegasys.artemis.util.SSZTypes;\n \n-import static java.util.Objects.isNull;\n+import static com.google.common.base.Preconditions.checkElementIndex;\n \n-import java.util.Arrays;\n+import java.util.ArrayList;\n+import java.util.BitSet;\n+import java.util.List;\n+import java.util.Objects;\n import java.util.stream.IntStream;\n import org.apache.tuweni.bytes.Bytes;\n \n public class Bitlist {\n \n-  private byte[] byteArray;\n-  private long maxSize;\n+  private final BitSet data;\n+  private final int size;\n+  private final long maxSize;\n \n   public Bitlist(int arraySize, long maxSize) {\n-    this.byteArray = new byte[arraySize];\n+    this.size = arraySize;\n+    this.data = new BitSet(arraySize);\n     this.maxSize = maxSize;\n   }\n \n   public Bitlist(Bitlist bitlist) {\n-    this.byteArray = new byte[bitlist.getByteArray().length];\n-    for (int i = 0; i < bitlist.getByteArray().length; i++) {\n-      this.byteArray[i] = bitlist.getByteArray()[i];\n-    }\n+    this.size = bitlist.size;\n+    this.data = (BitSet) bitlist.data.clone();\n     this.maxSize = bitlist.getMaxSize();\n   }\n \n-  public Bitlist(byte[] bitlist, long maxSize) {\n-    this.byteArray = bitlist;\n+  private Bitlist(int size, BitSet data, long maxSize) {\n+    this.size = size;\n+    this.data = data;\n     this.maxSize = maxSize;\n   }\n \n   public void setBit(int i) {\n-    this.byteArray[i] = 1;\n+    checkElementIndex(i, size);\n+    data.set(i);\n+  }\n+\n+  public boolean getBit(int i) {\n+    checkElementIndex(i, size);\n+    return data.get(i);\n+  }\n+\n+  public boolean intersects(Bitlist other) {\n+    return data.intersects(other.data);\n   }\n \n-  public int getBit(int i) {\n-    return byteArray[i];\n+  public List<Integer> getAllSetBits() {\n+    final List<Integer> setBits = new ArrayList<>();\n+    for (int i = data.nextSetBit(0); i > 0; i = data.nextSetBit(i + 1)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6645498064bee459abbbbe0d354e29212f78219"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjAxNzk3", "url": "https://github.com/ConsenSys/teku/pull/1531#pullrequestreview-388601797", "createdAt": "2020-04-06T20:43:11Z", "commit": {"oid": "d6645498064bee459abbbbe0d354e29212f78219"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ca1faf2af874fa0c8aae9052ce2030dea3b2943", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2ca1faf2af874fa0c8aae9052ce2030dea3b2943", "committedDate": "2020-04-06T20:44:33Z", "message": "Handle 0 being set."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f5f9a0c0162080453de23e8c2cc79b5559bbaf2", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4f5f9a0c0162080453de23e8c2cc79b5559bbaf2", "committedDate": "2020-04-06T20:44:51Z", "message": "Merge branch 'bitlist' of github.com:ajsutton/teku into bitlist"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4211, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}