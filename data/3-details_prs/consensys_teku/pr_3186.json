{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MDE5NTc2", "number": 3186, "title": "Add acceptance test for partial deposits", "bodyText": "PR Description\nAdd acceptance test for partial deposits.\nFixed Issue(s)\n\n\nFixes #3038\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-09T20:26:03Z", "url": "https://github.com/ConsenSys/teku/pull/3186", "merged": true, "mergeCommit": {"oid": "79b0a1d7014a2a3b3274932dc4c53ff62fbd1a6f"}, "closed": true, "closedAt": "2020-11-16T18:02:36Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda6qUZgH2gAyNTE4MDE5NTc2OjliODA1NzFlYmM1MDNlNWUxMDc5MzY4ZWVhYzhlMTMyZDMyMWM4ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddIhWBAH2gAyNTE4MDE5NTc2OmU1ZWNlMDI5MDI4ZjU1NGU3Njk5YThhNGVlZWMwNGFiODcxOTZkYzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9b80571ebc503e5e1079368eeac8e132d321c888", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/9b80571ebc503e5e1079368eeac8e132d321c888", "committedDate": "2020-11-09T20:19:59Z", "message": "Add acceptance test for partial deposits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b7b83b6ae36ed326efb66f9d5cabf5729b4f619", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/2b7b83b6ae36ed326efb66f9d5cabf5729b4f619", "committedDate": "2020-11-09T20:28:36Z", "message": "Clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b78963be30c483cf09526bc51a4214c4fe8461b4", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/b78963be30c483cf09526bc51a4214c4fe8461b4", "committedDate": "2020-11-09T20:28:47Z", "message": "Merge branch 'master' into acceptanceTestForPartialDeposits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NjUxNTg1", "url": "https://github.com/ConsenSys/teku/pull/3186#pullrequestreview-528651585", "createdAt": "2020-11-12T00:31:06Z", "commit": {"oid": "b78963be30c483cf09526bc51a4214c4fe8461b4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMDozMTowNlrOHxkDtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMDozMjoyM1rOHxkGhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzA0Ng==", "bodyText": "Why would we get genesis if we only sent partial deposits? Shouldn't it send a second batch of deposits to reach the required amount?", "url": "https://github.com/ConsenSys/teku/pull/3186#discussion_r521733046", "createdAt": "2020-11-12T00:31:06Z", "author": {"login": "ajsutton"}, "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/GenesisStateAcceptanceTest.java", "diffHunk": "@@ -39,4 +39,18 @@ public void shouldCreateTheSameGenesisState() throws Exception {\n     // state because they processed the same deposits from the same ETH1 chain.\n     lateJoinTeku.waitUntilInSyncWith(firstTeku);\n   }\n+\n+  @Test\n+  public void shouldCreateGenesisFromPartialDeposits() throws Exception {\n+    final BesuNode eth1Node = createBesuNode();\n+    eth1Node.start();\n+\n+    createTekuDepositSender().partiallySendValidatorDeposits(eth1Node, 4);\n+\n+    final TekuNode firstTeku = createTekuNode(config -> config.withDepositsFrom(eth1Node));\n+    firstTeku.start();\n+    firstTeku.waitForGenesis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b78963be30c483cf09526bc51a4214c4fe8461b4"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzc2NA==", "bodyText": "Oh I see, we bundled it all into one method.  It would make the test a lot easier to understand if there were actually two calls to the deposit sender here in the test.  We want the AT to read like a script showing each step that's being taken.", "url": "https://github.com/ConsenSys/teku/pull/3186#discussion_r521733764", "createdAt": "2020-11-12T00:32:23Z", "author": {"login": "ajsutton"}, "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/GenesisStateAcceptanceTest.java", "diffHunk": "@@ -39,4 +39,18 @@ public void shouldCreateTheSameGenesisState() throws Exception {\n     // state because they processed the same deposits from the same ETH1 chain.\n     lateJoinTeku.waitUntilInSyncWith(firstTeku);\n   }\n+\n+  @Test\n+  public void shouldCreateGenesisFromPartialDeposits() throws Exception {\n+    final BesuNode eth1Node = createBesuNode();\n+    eth1Node.start();\n+\n+    createTekuDepositSender().partiallySendValidatorDeposits(eth1Node, 4);\n+\n+    final TekuNode firstTeku = createTekuNode(config -> config.withDepositsFrom(eth1Node));\n+    firstTeku.start();\n+    firstTeku.waitForGenesis();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzA0Ng=="}, "originalCommit": {"oid": "b78963be30c483cf09526bc51a4214c4fe8461b4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "321f267cd46235e1d085dc5a88c5bb98bcf0c5f4", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/321f267cd46235e1d085dc5a88c5bb98bcf0c5f4", "committedDate": "2020-11-12T18:37:10Z", "message": "Make acceptance test more readable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NzMzMDAx", "url": "https://github.com/ConsenSys/teku/pull/3186#pullrequestreview-529733001", "createdAt": "2020-11-13T04:41:30Z", "commit": {"oid": "321f267cd46235e1d085dc5a88c5bb98bcf0c5f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwNDo0MTozMFrOHyag4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwNDo0MTozMFrOHyag4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYyNTI0OA==", "bodyText": "Yeah as you've commented this isn't the right approach.  We want the AT to be simple and clear, but still show what steps its actually taking.  So we want the AT to come out something like:\n@Test\n  public void shouldCreateGenesisFromPartialDeposits() throws Exception {\n    final BesuNode eth1Node = createBesuNode();\n    eth1Node.start();\n    int numberOfValidators = 4;\n\n    final TekuDepositSender depositSender = createTekuDepositSender();\n    final List<ValidatorKeyGenerator.ValidatorKeys> validatorKeys =\n        depositSender.generateValidatorKeys(numberOfValidators);\n    depositSender.sendValidatorDeposits(eth1Node, validatorKeys, MIN_DEPOSIT_AMOUNT);\n    depositSender.sendValidatorDeposits(\n        eth1Node, validatorKeys, MAX_EFFECTIVE_BALANCE - MIN_DEPOSIT_AMOUNT);\n\n    final TekuNode teku = createTekuNode(config -> config.withDepositsFrom(eth1Node));\n    teku.start();\n    teku.waitForGenesis();\n\n    teku.waitForValidators(numberOfValidators);\n  }", "url": "https://github.com/ConsenSys/teku/pull/3186#discussion_r522625248", "createdAt": "2020-11-13T04:41:30Z", "author": {"login": "ajsutton"}, "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/GenesisStateAcceptanceTest.java", "diffHunk": "@@ -39,4 +45,36 @@ public void shouldCreateTheSameGenesisState() throws Exception {\n     // state because they processed the same deposits from the same ETH1 chain.\n     lateJoinTeku.waitUntilInSyncWith(firstTeku);\n   }\n+\n+  @Test\n+  public void shouldCreateGenesisFromPartialDeposits() throws Exception {\n+    final BesuNode eth1Node = createBesuNode();\n+    eth1Node.start();\n+    int numberOfValidators = 4;\n+\n+    final Eth1Address eth1Address = Eth1Address.fromHexString(eth1Node.getDepositContractAddress());\n+    final Credentials eth1Credentials = Credentials.create(eth1Node.getRichBenefactorKey());\n+    DepositGenerator depositGenerator =\n+        new DepositGenerator(\n+            eth1Node.getExternalJsonRpcUrl(),\n+            eth1Address,\n+            eth1Credentials,\n+            numberOfValidators,\n+            UInt64.valueOf(MAX_EFFECTIVE_BALANCE / 2));\n+\n+    depositGenerator\n+        .generateKeysStream()\n+        .forEach(\n+            key -> {\n+              // For each key send deposit twice, since these are partial deposits\n+              depositGenerator.sendDeposit(key).join();\n+              depositGenerator.sendDeposit(key).join();\n+            });\n+\n+    final TekuNode teku = createTekuNode(config -> config.withDepositsFrom(eth1Node));\n+    teku.start();\n+    teku.waitForGenesis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "321f267cd46235e1d085dc5a88c5bb98bcf0c5f4"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e428db0f0bfc2560b5be747e320b943480d74cb3", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/e428db0f0bfc2560b5be747e320b943480d74cb3", "committedDate": "2020-11-13T18:30:14Z", "message": "Make AT simple and clear"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "608acdb6f9a4ab7289296980af134bf118aaec25", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/608acdb6f9a4ab7289296980af134bf118aaec25", "committedDate": "2020-11-13T18:38:21Z", "message": "Add acceptance test build requirements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwODUyMzQ5", "url": "https://github.com/ConsenSys/teku/pull/3186#pullrequestreview-530852349", "createdAt": "2020-11-16T00:10:38Z", "commit": {"oid": "608acdb6f9a4ab7289296980af134bf118aaec25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5ece029028f554e7699a8a4eeec04ab87196dc4", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/e5ece029028f554e7699a8a4eeec04ab87196dc4", "committedDate": "2020-11-16T17:36:42Z", "message": "Merge branch 'master' into acceptanceTestForPartialDeposits"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4416, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}