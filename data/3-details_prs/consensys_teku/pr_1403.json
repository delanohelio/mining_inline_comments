{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMjAwMTg2", "number": 1403, "title": "Fix exception when Eth1DataCache prunes all the data it contains", "bodyText": "PR Description\nFix a NoSuchElementException when Eth1DataCache pruning removes the entire cache contents.  While this doesn't normally happen, it can during startup where the cache isn't yet fully populated.", "createdAt": "2020-03-18T03:53:11Z", "url": "https://github.com/ConsenSys/teku/pull/1403", "merged": true, "mergeCommit": {"oid": "f06749d5e0b3c66500d1e9d44af41848274f8fdf"}, "closed": true, "closedAt": "2020-03-18T21:26:08Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOvEZpAH2gAyMzkwMjAwMTg2Ojg3Mjk3ZjJjMTU0MDIyMWIxZThhZGY2OTFiMzBhMTBiOTI3ZDU4YjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO9_mdAH2gAyMzkwMjAwMTg2OjI0NGFiOGYwNDFmMmQ0YWVmZTIyMzM2ZWQ0OTAxNTY4Yzk2MzYzMTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "87297f2c1540221b1e8adf691b30a10b927d58b5", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/87297f2c1540221b1e8adf691b30a10b927d58b5", "committedDate": "2020-03-18T03:51:22Z", "message": "Fix exception when Eth1DataCache prunes all the data it contains."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa08c115ed8506aae3104ba4e50a4353528ad503", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/aa08c115ed8506aae3104ba4e50a4353528ad503", "committedDate": "2020-03-18T04:22:46Z", "message": "Use orElseThrow instead of separate check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODMyMzY3", "url": "https://github.com/ConsenSys/teku/pull/1403#pullrequestreview-376832367", "createdAt": "2020-03-18T12:52:29Z", "commit": {"oid": "aa08c115ed8506aae3104ba4e50a4353528ad503"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMjo1MjoyOVrOF4Dhyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMjo1MjoyOVrOF4Dhyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyMjM3OA==", "bodyText": "neat", "url": "https://github.com/ConsenSys/teku/pull/1403#discussion_r394322378", "createdAt": "2020-03-18T12:52:29Z", "author": {"login": "cemozerr"}, "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/Eth1DataCache.java", "diffHunk": "@@ -153,9 +151,10 @@ private UnsignedLong secondsBeforeCurrentVotingPeriodStartTime(\n   }\n \n   private UnsignedLong computeTimeAtSlot(UnsignedLong slot) {\n-    if (genesisTime.isEmpty())\n-      throw new RuntimeException(\"computeTimeAtSlot called without genesisTime being set\");\n-    return genesisTime.get().plus(slot.times(UnsignedLong.valueOf(Constants.SECONDS_PER_SLOT)));\n+    return genesisTime\n+        .orElseThrow(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa08c115ed8506aae3104ba4e50a4353528ad503"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODM1Mjk4", "url": "https://github.com/ConsenSys/teku/pull/1403#pullrequestreview-376835298", "createdAt": "2020-03-18T12:56:24Z", "commit": {"oid": "aa08c115ed8506aae3104ba4e50a4353528ad503"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMjo1NjoyNFrOF4Dq9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMjo1NjoyNFrOF4Dq9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyNDcyNg==", "bodyText": "The comment here is misleading. This cacheEth1BlockEvent3 is still inside the current voting period, and that's why it gets cleaned up.", "url": "https://github.com/ConsenSys/teku/pull/1403#discussion_r394324726", "createdAt": "2020-03-18T12:56:24Z", "author": {"login": "cemozerr"}, "path": "validator/coordinator/src/test/java/tech/pegasys/artemis/validator/coordinator/Eth1DataCacheTest.java", "diffHunk": "@@ -288,6 +288,30 @@ void pruneAfterGenesis() {\n     assertThat(eth1DataCache.getMapForTesting().values()).containsExactly(eth1Data3);\n   }\n \n+  @Test\n+  void pruneAllBlockData() {\n+    eth1DataCache.startBeaconChainMode(genesisState);\n+    eth1DataCache.onSlot(new SlotEvent(START_SLOT));\n+\n+    // First two Eth1Data timestamps inside the spec range for this voting period\n+    CacheEth1BlockEvent cacheEth1BlockEvent1 =\n+        createRandomCacheEth1BlockEvent(UnsignedLong.valueOf(359));\n+    CacheEth1BlockEvent cacheEth1BlockEvent2 =\n+        createRandomCacheEth1BlockEvent(UnsignedLong.valueOf(360));\n+\n+    // This Eth1Data timestamp inside the spec range for the next voting period", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa08c115ed8506aae3104ba4e50a4353528ad503"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODM1NjYx", "url": "https://github.com/ConsenSys/teku/pull/1403#pullrequestreview-376835661", "createdAt": "2020-03-18T12:56:51Z", "commit": {"oid": "aa08c115ed8506aae3104ba4e50a4353528ad503"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf2d2643b51538306215824772d7e70665806e3f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/bf2d2643b51538306215824772d7e70665806e3f", "committedDate": "2020-03-18T21:13:57Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into handle-removing-all-eth1-data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "244ab8f041f2d4aefe22336ed4901568c9636317", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/244ab8f041f2d4aefe22336ed4901568c9636317", "committedDate": "2020-03-18T21:14:42Z", "message": "Fix comment."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4004, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}