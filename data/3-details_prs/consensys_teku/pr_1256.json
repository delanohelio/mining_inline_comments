{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNDQ3MjUy", "number": 1256, "title": "#1161: Refactoring BeaconBlockHandler to use CombinedChainDataClient.", "bodyText": "PR Description\nRefactoring BeaconBlockHandler to use CombinedChainDataClient.\nFixed Issue(s)\nPart of #1161.  Work following on from PR comments on #1217.", "createdAt": "2020-03-02T15:26:31Z", "url": "https://github.com/ConsenSys/teku/pull/1256", "merged": true, "mergeCommit": {"oid": "88e848f77bd07591f7ca6595bc1594aede6ec613"}, "closed": true, "closedAt": "2020-03-03T06:17:00Z", "author": {"login": "mark-terry"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJvZ0CAH2gAyMzgyNDQ3MjUyOmM0ZjYxNTUxZDM5MTQ0ZGJiOTI0MzAwNzc0ZGIwN2ZiY2U1NGRiOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJ714RgH2gAyMzgyNDQ3MjUyOjFmNGI5MTBmYjI2ZjJjOWYyYTI1MTgxMzI4MWZiY2VlYmUxZjRlZTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c4f61551d39144dbb924300774db07fbce54db98", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c4f61551d39144dbb924300774db07fbce54db98", "committedDate": "2020-03-02T15:25:08Z", "message": "#1161: Refactoring BeaconBlockHandler to use CombinedChainDataClient."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NTc1NzMx", "url": "https://github.com/ConsenSys/teku/pull/1256#pullrequestreview-367575731", "createdAt": "2020-03-02T22:27:01Z", "commit": {"oid": "c4f61551d39144dbb924300774db07fbce54db98"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMjoyNzowMVrOFwxodA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMjoyNzowMVrOFwxodA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY4OTE0MA==", "bodyText": "is doReturn better than the other way?", "url": "https://github.com/ConsenSys/teku/pull/1256#discussion_r386689140", "createdAt": "2020-03-02T22:27:01Z", "author": {"login": "macfarla"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandlerTest.java", "diffHunk": "@@ -174,75 +186,91 @@ public void shouldReturnBlockWhenEpochQuery() throws Exception {\n     final String epochNum = \"1\";\n     final Map<String, List<String>> params = Map.of(EPOCH, List.of(epochNum));\n \n-    when(context.queryParamMap()).thenReturn(params);\n-    when(context.queryParam(any())).thenReturn(epochNum);\n-    when(storageClient.getBlockRootBySlot(any())).thenReturn(Optional.of(blockRoot));\n-    when(storageClient.getStore()).thenReturn(store);\n-    when(store.getSignedBlock(any())).thenReturn(signedBeaconBlock);\n-    when(historicalChainData.getFinalizedBlockAtSlot(any()))\n-        .thenReturn(SafeFuture.completedFuture(empty()));\n+    doReturn(params).when(context).queryParamMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4f61551d39144dbb924300774db07fbce54db98"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NTAxNzk5", "url": "https://github.com/ConsenSys/teku/pull/1256#pullrequestreview-367501799", "createdAt": "2020-03-02T20:25:11Z", "commit": {"oid": "c4f61551d39144dbb924300774db07fbce54db98"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDoyNToxMVrOFwuBxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDoyODowMlrOFwuHug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzMDA4NQ==", "bodyText": "i just added the same thing in my PR :) well, very similar - isStoreAvailable, I figured we'd mostly only be wanting to access it to check if its set, rather than to use directly... just an observation, no change required.", "url": "https://github.com/ConsenSys/teku/pull/1256#discussion_r386630085", "createdAt": "2020-03-02T20:25:11Z", "author": {"login": "rolfyone"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/CombinedChainDataClient.java", "diffHunk": "@@ -171,11 +171,32 @@ private boolean isFinalized(final UnsignedLong slot) {\n   }\n \n   public Optional<Bytes32> getBestBlockRoot() {\n-    final Store store = recentChainData.getStore();\n-    if (store == null) {\n+    if (getStore() == null) {\n       LOG.trace(\"No block found because the store is not set\");\n       return Optional.empty();\n     }\n     return Optional.ofNullable(recentChainData.getBestBlockRoot());\n   }\n+\n+  public Store getStore() {\n+    return recentChainData.getStore();\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4f61551d39144dbb924300774db07fbce54db98"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzMTYxMA==", "bodyText": "should probably add Unit Test to CombinedChainDataClientTest", "url": "https://github.com/ConsenSys/teku/pull/1256#discussion_r386631610", "createdAt": "2020-03-02T20:28:02Z", "author": {"login": "rolfyone"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/CombinedChainDataClient.java", "diffHunk": "@@ -171,11 +171,32 @@ private boolean isFinalized(final UnsignedLong slot) {\n   }\n \n   public Optional<Bytes32> getBestBlockRoot() {\n-    final Store store = recentChainData.getStore();\n-    if (store == null) {\n+    if (getStore() == null) {\n       LOG.trace(\"No block found because the store is not set\");\n       return Optional.empty();\n     }\n     return Optional.ofNullable(recentChainData.getBestBlockRoot());\n   }\n+\n+  public Store getStore() {\n+    return recentChainData.getStore();\n+  }\n+\n+  public Optional<Bytes32> getBlockRootBySlot(final UnsignedLong slot) {\n+    return recentChainData.getBlockRootBySlot(slot);\n+  }\n+\n+  public SafeFuture<Optional<SignedBeaconBlock>> getBlockBySlot(final UnsignedLong slot) {\n+    final Optional<Bytes32> blockRootBySlot = getBlockRootBySlot(slot);\n+    final Optional<Bytes32> bestBlockRoot = getBestBlockRoot();\n+\n+    if (blockRootBySlot.isPresent()) {\n+      return SafeFuture.completedFuture(\n+          Optional.ofNullable(getStore().getSignedBlock(blockRootBySlot.get())));\n+    } else if (bestBlockRoot.isPresent()) {\n+      return getBlockAtSlotExact(slot, bestBlockRoot.get());\n+    } else {\n+      return SafeFuture.completedFuture(Optional.empty());\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4f61551d39144dbb924300774db07fbce54db98"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77380189ea0e0c1ea8e5ade16fb23218b945c838", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/77380189ea0e0c1ea8e5ade16fb23218b945c838", "committedDate": "2020-03-03T02:12:37Z", "message": "Merge branch 'master' into 1161-combinedchainclient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2ed9d8704b18be2a414f33c0adf4b29e3ddc60a", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a2ed9d8704b18be2a414f33c0adf4b29e3ddc60a", "committedDate": "2020-03-03T02:48:11Z", "message": "Merge branch 'master' into 1161-combinedchainclient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20642928206838c4679774485ff83da0c3852c62", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/20642928206838c4679774485ff83da0c3852c62", "committedDate": "2020-03-03T05:38:11Z", "message": "#1161: PR fixes and test refactoring."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69173d058ef85900168d11364d6ed968133ad16f", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/69173d058ef85900168d11364d6ed968133ad16f", "committedDate": "2020-03-03T05:44:00Z", "message": "Merge branch 'master' into 1161-combinedchainclient"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NzE2MDEw", "url": "https://github.com/ConsenSys/teku/pull/1256#pullrequestreview-367716010", "createdAt": "2020-03-03T05:48:11Z", "commit": {"oid": "69173d058ef85900168d11364d6ed968133ad16f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f4b910fb26f2c9f2a251813281fbceebe1f4ee5", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/1f4b910fb26f2c9f2a251813281fbceebe1f4ee5", "committedDate": "2020-03-03T05:54:39Z", "message": "Merge branch 'master' into 1161-combinedchainclient"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4147, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}