{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0Mjc5NDA1", "number": 3263, "title": "Duty scheduling needs to wait until validator indices are known.", "bodyText": "Retries shouldn't back off too far, once per slot to attempt to connect seems to be a fair compromise.\n\nSigned-off-by: Paul Harris paul.harris@consensys.net\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-19T22:40:02Z", "url": "https://github.com/ConsenSys/teku/pull/3263", "merged": true, "mergeCommit": {"oid": "fbf1c941199eb4b067434c05a55158125d5c02fe"}, "closed": true, "closedAt": "2020-11-19T23:14:57Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeKXj-gH2gAyNTI0Mjc5NDA1OjBhNTkwMjBhZDM0ZWY0NTU5N2M0NTQ5NTVlYTAzMmE2OGY4MjkwN2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeK_PCgH2gAyNTI0Mjc5NDA1OjhkOGExN2E3NWYwOGJjMWZmZmFmOWY5NWM0MDQzMjg2YTgzNzgyODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a59020ad34ef45597c454955ea032a68f82907a", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/0a59020ad34ef45597c454955ea032a68f82907a", "committedDate": "2020-11-19T22:19:45Z", "message": "initial fix for remote validator starting first, and the trouble that can occur.\n\nbefore the fix there are no attestations in the `shouldCreateAttestationsWithRemoteValidatorStartingFirst` test, and after, attestations are created from slot 1.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7f274411de714e894f8d66cc2b4c4dd704866e8", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/e7f274411de714e894f8d66cc2b4c4dd704866e8", "committedDate": "2020-11-19T22:38:07Z", "message": "Duty scheduling needs to wait until validator indices are known.\n\n - Retries shouldn't back off too far, once per slot to attempt to connect seems to be a fair compromise.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTIzNTA5", "url": "https://github.com/ConsenSys/teku/pull/3263#pullrequestreview-534923509", "createdAt": "2020-11-19T22:53:04Z", "commit": {"oid": "e7f274411de714e894f8d66cc2b4c4dd704866e8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo1MzowNVrOH21Rwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo1MzowNVrOH21Rwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1ODA1MA==", "bodyText": "nit: you can reduce the level of nesting here slightly with:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .thenCompose(\n          \n          \n            \n                        validatorIndices ->\n          \n          \n            \n                            requestDuties(epoch, validatorIndices)\n          \n          \n            \n                                .thenApply(\n          \n          \n            \n                    .thenCompose(validatorIndices -> requestDuties(epoch, validatorIndices))\n          \n          \n            \n                    .thenApply(\n          \n      \n    \n    \n  \n\nie requestDuties is in its own thenCompose", "url": "https://github.com/ConsenSys/teku/pull/3263#discussion_r527258050", "createdAt": "2020-11-19T22:53:05Z", "author": {"login": "ajsutton"}, "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/AbstractDutyLoader.java", "diffHunk": "@@ -45,15 +45,19 @@ protected AbstractDutyLoader(\n   public SafeFuture<ScheduledDuties> loadDutiesForEpoch(final UInt64 epoch) {\n     LOG.trace(\"Requesting attestation duties for epoch {}\", epoch);\n     final ScheduledDuties scheduledDuties = scheduledDutiesFactory.get();\n-    return requestDuties(epoch, validatorIndexProvider.getValidatorIndices(validators.keySet()))\n-        .thenApply(\n-            maybeDuties ->\n-                maybeDuties.orElseThrow(\n-                    () ->\n-                        new NodeDataUnavailableException(\n-                            \"Duties could not be calculated because chain data was not yet available\")))\n-        .thenCompose(duties -> scheduleAllDuties(scheduledDuties, duties))\n-        .thenApply(__ -> scheduledDuties);\n+    return validatorIndexProvider\n+        .getValidatorIndices(validators.keySet())\n+        .thenCompose(\n+            validatorIndices ->\n+                requestDuties(epoch, validatorIndices)\n+                    .thenApply(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7f274411de714e894f8d66cc2b4c4dd704866e8"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d8a17a75f08bc1fffaf9f95c4043286a8378289", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/8d8a17a75f08bc1fffaf9f95c4043286a8378289", "committedDate": "2020-11-19T23:03:05Z", "message": "review comments.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3217, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}