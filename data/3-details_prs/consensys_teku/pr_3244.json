{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNjQzOTY3", "number": 3244, "title": "[Issue 3216] Clean up async processing", "bodyText": "PR Description\nClean up async processing from #3199.  Add SafeFuture.asyncDoWhile() helper for constructing looping futures.\nFixed Issue(s)\nFixes #3216\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-17T19:13:48Z", "url": "https://github.com/ConsenSys/teku/pull/3244", "merged": true, "mergeCommit": {"oid": "324de70177d97938a2abd9c4af71c22eddd85e2c"}, "closed": true, "closedAt": "2020-11-18T18:47:04Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddLvECAH2gAyNTIyNjQzOTY3Ojc3YjgyNzYwZjc4YjdiMDE0MTQ1OTgzYTlkZTFjNjA3MzVjN2IzNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddyhWPgH2gAyNTIyNjQzOTY3OjRhZjJhNzYzNmI4ODUzZGFiYTRkNWFmZDkxZTY0OWU1MWY3MTg2ODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "77b82760f78b7b014145983a9de1c60735c7b35f", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/77b82760f78b7b014145983a9de1c60735c7b35f", "committedDate": "2020-11-16T21:21:24Z", "message": "Add asyncDoWhile() utility and use it to clean up HistoricalBlockFetcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f72581b5120b741a518db6954b560ec09e675ce8", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f72581b5120b741a518db6954b560ec09e675ce8", "committedDate": "2020-11-17T19:05:18Z", "message": "Update HistoricalBlockSyncService to use async looping util"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f04780b934675c1bb0e3983f8b5dd16be0e1d569", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f04780b934675c1bb0e3983f8b5dd16be0e1d569", "committedDate": "2020-11-17T19:11:23Z", "message": "Consolidate asyncDoWhile helpers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTEyMjk0", "url": "https://github.com/ConsenSys/teku/pull/3244#pullrequestreview-532912294", "createdAt": "2020-11-18T00:03:18Z", "commit": {"oid": "f04780b934675c1bb0e3983f8b5dd16be0e1d569"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDowMzoxOVrOH1Qdeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDowMzoxOVrOH1Qdeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwNjI2Ng==", "bodyText": "This works well with the current use cases but at some point we probably should update it to avoid recursion if the returned future is already complete - otherwise we risk getting StackOverflowException.  Will be quite nice to hide that complexity in here.", "url": "https://github.com/ConsenSys/teku/pull/3244#discussion_r525606266", "createdAt": "2020-11-18T00:03:19Z", "author": {"login": "ajsutton"}, "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/SafeFuture.java", "diffHunk": "@@ -122,6 +122,17 @@ public static Interruptor createInterruptor(\n     return new Interruptor(interruptFuture, exceptionSupplier);\n   }\n \n+  /**\n+   * Repeatedly run the loop until it returns false or completes exceptionally\n+   *\n+   * @param loopBody A supplier for generating futures to be run in succession\n+   * @return A future that will complete when looping terminates\n+   */\n+  public static SafeFuture<Void> asyncDoWhile(ExceptionThrowingFutureSupplier<Boolean> loopBody) {\n+    return SafeFuture.of(loopBody::get)\n+        .thenCompose(res -> res ? asyncDoWhile(loopBody) : SafeFuture.COMPLETE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f04780b934675c1bb0e3983f8b5dd16be0e1d569"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTc1OTc5", "url": "https://github.com/ConsenSys/teku/pull/3244#pullrequestreview-533175979", "createdAt": "2020-11-18T07:51:13Z", "commit": {"oid": "f04780b934675c1bb0e3983f8b5dd16be0e1d569"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4af2a7636b8853daba4d5afd91e649e51f718687", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/4af2a7636b8853daba4d5afd91e649e51f718687", "committedDate": "2020-11-18T18:32:43Z", "message": "Merge branch 'master' into issue-3216/clean-up-async-processing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3201, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}