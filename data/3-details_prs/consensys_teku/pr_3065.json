{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5MTkxMTAz", "number": 3065, "title": "[Issue 3063] Accept weak-subjectivity state and block", "bodyText": "PR Description\nAdd experimental (hidden) flags to accept a weak-subjectivity state and block (--Xws-initial-state=<path-to-ssz-encoded-state> --Xws-initial-block=<path-to-ssz-encoded-block>).  Teku will initialize the database and sync forwards from this point.\nSupporting changes include:\n\nModify ProtoArray logic to accept blocks from the anchorpoint epoch as valid\nStore some anchor information so that we can properly initialize ProtoArray\nUpdate PeerChainValidator to handle missing historical blocks\nFix issue in PeerChainValidator where we were pulling the latest finalized checkpoint from our chainHead's state\nAdd BeaconStateBuilder test utility for configurable state creation\n\nAdditional work to follow-up on in subsequent PR's includes:\n\nAllow users to supply only a state (no block required)\nSync historical blocks prior to the provided anchorpoint\nInvestigate areas of the codebase where we assume historical blocks are present and add any additional handling as necessary\n\nFixed Issue(s)\nPart of #3063\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-23T20:02:32Z", "url": "https://github.com/ConsenSys/teku/pull/3065", "merged": true, "mergeCommit": {"oid": "fdaaedd2cbc502881456fdb859c0047f4805e02e"}, "closed": true, "closedAt": "2020-10-27T15:37:51Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVbjcqAH2gAyNTA5MTkxMTAzOmVlYjI1NDQ4ZGRmYjJjODNlZjExOTE5Y2Q0ODgwOTVhYmQ0ZTdjNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWqeXcgH2gAyNTA5MTkxMTAzOjA3ZWNjMzUwMjdkZWJjMTRhZDI4ZmZmNzE0NmJjYmMzOGU1MGUwZjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eeb25448ddfb2c83ef11919cd488095abd4e7c46", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/eeb25448ddfb2c83ef11919cd488095abd4e7c46", "committedDate": "2020-10-23T19:15:48Z", "message": "Rename --initial-state option to --genesis-state\n\nKeep --initial-state as a valid option for backwards-compatibility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd97c182cd3671371b1def6701e622ea0c6a9dbd", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/cd97c182cd3671371b1def6701e622ea0c6a9dbd", "committedDate": "2020-10-23T19:15:48Z", "message": "Add new option to supply weak subjectivity state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89deb1a55a6fb52e7ecdbf9d88f3f1866d0ec7d6", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/89deb1a55a6fb52e7ecdbf9d88f3f1866d0ec7d6", "committedDate": "2020-10-23T19:15:48Z", "message": "Rename StartupUtil to StateLoader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9e318338b52becfd3a7a7a50e775cc0c99dca38", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a9e318338b52becfd3a7a7a50e775cc0c99dca38", "committedDate": "2020-10-23T19:15:48Z", "message": "For now, accept initial block with weak subjectivity state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0286d9f6c52018c553c928a2322d56ecf68aa378", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/0286d9f6c52018c553c928a2322d56ecf68aa378", "committedDate": "2020-10-23T19:15:48Z", "message": "Use ws state and block to initialize storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "947f0a85f6cc9819ef9b31565ede9240ca0503a2", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/947f0a85f6cc9819ef9b31565ede9240ca0503a2", "committedDate": "2020-10-23T19:15:49Z", "message": "Store anchorPoint data to enable proper protoArray initialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1237299d4fa49ebc1ece1733b0bd62ab886e5b7e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/1237299d4fa49ebc1ece1733b0bd62ab886e5b7e", "committedDate": "2020-10-23T19:41:25Z", "message": "Fix StatusLogger dependencies after rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8452adf01a1939efbcbb3061f1566bff088ccd2", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d8452adf01a1939efbcbb3061f1566bff088ccd2", "committedDate": "2020-10-23T19:54:02Z", "message": "Update peer validator to be tolerant of missing historical blocks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NDI0NjM2", "url": "https://github.com/ConsenSys/teku/pull/3065#pullrequestreview-516424636", "createdAt": "2020-10-26T01:32:31Z", "commit": {"oid": "d8452adf01a1939efbcbb3061f1566bff088ccd2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwMTozMjozMlrOHn-g4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwMzowNjozN1rOHn_m6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY4MDczNg==", "bodyText": "Would it make sense to have this return genesis if no anchor was specified?", "url": "https://github.com/ConsenSys/teku/pull/3065#discussion_r511680736", "createdAt": "2020-10-26T01:32:32Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/forkchoice/ReadOnlyStore.java", "diffHunk": "@@ -32,6 +32,14 @@\n \n   UInt64 getGenesisTime();\n \n+  /**\n+   * Returns the anchor checkpoint from which the chain was started, if such an anchor exists. If\n+   * the anchor is missing, the node was started up from genesis.\n+   *\n+   * @return The anchor if it exists.\n+   */\n+  Optional<Checkpoint> getAnchor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8452adf01a1939efbcbb3061f1566bff088ccd2"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY5NDY1Mg==", "bodyText": "nit: stray semicolon", "url": "https://github.com/ConsenSys/teku/pull/3065#discussion_r511694652", "createdAt": "2020-10-26T02:46:43Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/testFixtures/java/tech/pegasys/teku/datastructures/util/BeaconStateBuilder.java", "diffHunk": "@@ -0,0 +1,311 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.datastructures.util;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+import static tech.pegasys.teku.datastructures.util.BeaconStateUtil.compute_start_slot_at_epoch;\n+import static tech.pegasys.teku.util.config.Constants.EPOCHS_PER_ETH1_VOTING_PERIOD;\n+import static tech.pegasys.teku.util.config.Constants.SLOTS_PER_EPOCH;\n+\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.datastructures.blocks.BeaconBlockHeader;\n+import tech.pegasys.teku.datastructures.blocks.Eth1Data;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.datastructures.state.Checkpoint;\n+import tech.pegasys.teku.datastructures.state.Fork;\n+import tech.pegasys.teku.datastructures.state.PendingAttestation;\n+import tech.pegasys.teku.datastructures.state.Validator;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.ssz.SSZTypes.Bitvector;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZList;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZVector;\n+import tech.pegasys.teku.util.config.Constants;\n+\n+public class BeaconStateBuilder {\n+  private final DataStructureUtil dataStructureUtil;\n+  private final int defaultValidatorCount;\n+  private final int defaultItemsInSSZLists;\n+\n+  private UInt64 genesisTime;\n+  private Bytes32 genesisValidatorsRoot;\n+  private UInt64 slot;\n+  private Fork fork;\n+  private BeaconBlockHeader latestBlockHeader;\n+  private SSZVector<Bytes32> blockRoots;\n+  private SSZVector<Bytes32> stateRoots;\n+  private SSZList<Bytes32> historicalRoots;\n+  private Eth1Data eth1Data;\n+  private SSZList<Eth1Data> eth1DataVotes;\n+  private UInt64 eth1DepositIndex;\n+  private SSZList<? extends Validator> validators;\n+  private SSZList<UInt64> balances;\n+  private SSZVector<Bytes32> randaoMixes;\n+  private SSZVector<UInt64> slashings;\n+  private SSZList<PendingAttestation> previousEpochAttestations;\n+  private SSZList<PendingAttestation> currentEpochAttestations;\n+  private Bitvector justificationBits;\n+  private Checkpoint previousJustifiedCheckpoint;\n+  private Checkpoint currentJustifiedCheckpoint;\n+  private Checkpoint finalizedCheckpoint;\n+\n+  private BeaconStateBuilder(\n+      final DataStructureUtil dataStructureUtil,\n+      final int defaultValidatorCount,\n+      final int defaultItemsInSSZLists) {\n+    this.dataStructureUtil = dataStructureUtil;\n+    this.defaultValidatorCount = defaultValidatorCount;\n+    this.defaultItemsInSSZLists = defaultItemsInSSZLists;\n+    initDefaults();\n+  }\n+\n+  public static BeaconStateBuilder create(\n+      final DataStructureUtil dataStructureUtil,\n+      final int defaultValidatorCount,\n+      final int defaultItemsInSSZLists) {\n+    return new BeaconStateBuilder(dataStructureUtil, defaultValidatorCount, defaultItemsInSSZLists);\n+  }\n+\n+  public BeaconState build() {\n+    return BeaconState.create(\n+        genesisTime,\n+        genesisValidatorsRoot,\n+        slot,\n+        fork,\n+        latestBlockHeader,\n+        blockRoots,\n+        stateRoots,\n+        historicalRoots,\n+        eth1Data,\n+        eth1DataVotes,\n+        eth1DepositIndex,\n+        validators,\n+        balances,\n+        randaoMixes,\n+        slashings,\n+        previousEpochAttestations,\n+        currentEpochAttestations,\n+        justificationBits,\n+        previousJustifiedCheckpoint,\n+        currentJustifiedCheckpoint,\n+        finalizedCheckpoint);\n+  }\n+\n+  private void initDefaults() {\n+    genesisTime = dataStructureUtil.randomUInt64();\n+    genesisValidatorsRoot = dataStructureUtil.randomBytes32();\n+    slot = dataStructureUtil.randomUInt64();\n+    fork = dataStructureUtil.randomFork();\n+    latestBlockHeader = dataStructureUtil.randomBeaconBlockHeader();\n+    blockRoots =\n+        dataStructureUtil.randomSSZVector(\n+            Bytes32.ZERO, Constants.SLOTS_PER_HISTORICAL_ROOT, dataStructureUtil::randomBytes32);\n+    stateRoots =\n+        dataStructureUtil.randomSSZVector(\n+            Bytes32.ZERO, Constants.SLOTS_PER_HISTORICAL_ROOT, dataStructureUtil::randomBytes32);\n+    ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8452adf01a1939efbcbb3061f1566bff088ccd2"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY5ODY2Ng==", "bodyText": "I wonder if we should leave this as --initial-state because ultimately we want to be able to sync just from a state and so would wind up being able to just specify that state here.\nEven now if the slot of the initial state was 0 we can generate the block and if it's not, we require the block to be passed in via the extra arg.\nHowever it winds up, I think I'd avoid making changes to the stable CLI options before we know exactly where it's going to land.", "url": "https://github.com/ConsenSys/teku/pull/3065#discussion_r511698666", "createdAt": "2020-10-26T03:06:37Z", "author": {"login": "ajsutton"}, "path": "teku/src/main/java/tech/pegasys/teku/cli/options/NetworkOptions.java", "diffHunk": "@@ -25,11 +25,11 @@\n   private String network = \"medalla\";\n \n   @Option(\n-      names = {\"--initial-state\"},\n+      names = {\"--genesis-state\", \"--initial-state\"},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8452adf01a1939efbcbb3061f1566bff088ccd2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33ae85d653ea337900fa8f4d736505712fa54b39", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/33ae85d653ea337900fa8f4d736505712fa54b39", "committedDate": "2020-10-26T18:33:32Z", "message": "Revert \"Rename --initial-state option to --genesis-state\"\n\nThis reverts commit eeb25448ddfb2c83ef11919cd488095abd4e7c46."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1c0ddee9f9c8a204d2e9f5a4c73f9f6698686ba", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d1c0ddee9f9c8a204d2e9f5a4c73f9f6698686ba", "committedDate": "2020-10-26T18:47:07Z", "message": "Fix genesis handler setup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cce1f08599df2aee2aa4cbadb0afc70e16b34a42", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/cce1f08599df2aee2aa4cbadb0afc70e16b34a42", "committedDate": "2020-10-26T19:04:00Z", "message": "Cut stray semicolon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e19f3245d7578cf949f94563ece5312482e2f02", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/5e19f3245d7578cf949f94563ece5312482e2f02", "committedDate": "2020-10-26T19:04:34Z", "message": "Merge branch 'master' into issue-3063/accept-ws-state-and-block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "450921ab227d29d8787fdf52b4d67d72558ef603", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/450921ab227d29d8787fdf52b4d67d72558ef603", "committedDate": "2020-10-26T20:45:12Z", "message": "Update test names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzQ3MjEw", "url": "https://github.com/ConsenSys/teku/pull/3065#pullrequestreview-517347210", "createdAt": "2020-10-27T04:52:56Z", "commit": {"oid": "450921ab227d29d8787fdf52b4d67d72558ef603"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3072f47f5c4f613de0f580ad1d1ce6e87bb3be5", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/b3072f47f5c4f613de0f580ad1d1ce6e87bb3be5", "committedDate": "2020-10-27T14:41:17Z", "message": "Merge branch 'master' into issue-3063/accept-ws-state-and-block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07ecc35027debc14ad28fff7146bcbc38e50e0f5", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/07ecc35027debc14ad28fff7146bcbc38e50e0f5", "committedDate": "2020-10-27T15:12:45Z", "message": "Fix merge conflict"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3259, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}