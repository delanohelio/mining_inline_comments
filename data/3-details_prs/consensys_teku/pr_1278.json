{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzNjcyMzgz", "number": 1278, "title": "Optimize: faster shuffling with a single per-epoch cached committee shuffle ", "bodyText": "PR Description\nShuffling indexes per epoch in a single list pass is much faster than computing their permutations individually.\nBenchmarks:\nBefore\nBenchmark                              (validatorsCount)  Mode  Cnt  Score   Error  Units\nTransitionBenchmark.Block.importBlock              16384    ss   50  0,266 \u00b1 0,005   s/op\nTransitionBenchmark.Block.importBlock              32768    ss   50  0,387 \u00b1 0,004   s/op\nTransitionBenchmark.Epoch.importBlock              16384    ss   10  0,897 \u00b1 0,042   s/op\nTransitionBenchmark.Epoch.importBlock              32768    ss   10  1,638 \u00b1 0,018   s/op\n\nAfter\nBenchmark                              (validatorsCount)  Mode  Cnt  Score   Error  Units\nTransitionBenchmark.Block.importBlock              16384    ss   50  0,183 \u00b1 0,004   s/op\nTransitionBenchmark.Block.importBlock              32768    ss   50  0,219 \u00b1 0,006   s/op\nTransitionBenchmark.Epoch.importBlock              16384    ss   10  0,805 \u00b1 0,018   s/op\nTransitionBenchmark.Epoch.importBlock              32768    ss   10  1,493 \u00b1 0,033   s/op", "createdAt": "2020-03-04T16:06:52Z", "url": "https://github.com/ConsenSys/teku/pull/1278", "merged": true, "mergeCommit": {"oid": "c2483e3aa121917fe42029efc24e4b3630a6249c"}, "closed": true, "closedAt": "2020-03-05T10:43:21Z", "author": {"login": "Nashatyrev"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKZCOfgH2gAyMzgzNjcyMzgzOmU4ODc2MWUyNTc5ZjNhMDYzMDA3NzFmMmJlODEzMWViMmNjYjkxOGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKo0X6AH2gAyMzgzNjcyMzgzOmE4NDM2NzkyY2E0MmVkYWM0MWVjZDU2MTk4MzA0MzFkZGQxN2E5OTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e88761e2579f3a06300771f2be8131eb2ccb918a", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e88761e2579f3a06300771f2be8131eb2ccb918a", "committedDate": "2020-03-04T15:55:23Z", "message": "Implement shuffling the whole active validator indexes list in a single pass. Add committee shuffle cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTM1MTQz", "url": "https://github.com/ConsenSys/teku/pull/1278#pullrequestreview-369135143", "createdAt": "2020-03-04T21:27:01Z", "commit": {"oid": "e88761e2579f3a06300771f2be8131eb2ccb918a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToyNzowMlrOFx-PBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjoyOTo0M1rOFyABuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0NDE5OQ==", "bodyText": "Out of interest, do you have any idea on how our Sha256 performance compares to other implementations (particularly native ones)?", "url": "https://github.com/ConsenSys/teku/pull/1278#discussion_r387944199", "createdAt": "2020-03-04T21:27:02Z", "author": {"login": "ajsutton"}, "path": "eth-benchmark-tests/src/jmh/java/tech/pegasys/artemis/benchmarks/Sha256Benchmark.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2019 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.benchmarks;\n+\n+import java.util.concurrent.TimeUnit;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.bytes.MutableBytes;\n+import org.apache.tuweni.crypto.Hash;\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.Warmup;\n+import org.openjdk.jmh.infra.Blackhole;\n+\n+@State(Scope.Thread)\n+public class Sha256Benchmark {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e88761e2579f3a06300771f2be8131eb2ccb918a"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzU2Mw==", "bodyText": "Given how comprehensive the reference tests are for shuffling, we can probably delete the original implementation and ditch this test.  Maybe hard code one expected shuffle result here just as a quick sanity check as part of unit tests and leave the details to the reference tests.", "url": "https://github.com/ConsenSys/teku/pull/1278#discussion_r387973563", "createdAt": "2020-03-04T22:29:43Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/test/java/tech/pegasys/artemis/datastructures/util/CommitteeUtilTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.datastructures.util;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.util.stream.IntStream;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.jupiter.api.Test;\n+\n+public class CommitteeUtilTest {\n+\n+  @Test\n+  void testListShuffleAndShuffledIndexCompatibility() {\n+    Bytes32 seed = Bytes32.ZERO;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e88761e2579f3a06300771f2be8131eb2ccb918a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5165a8dc8804e31a3296108076a1d92dffe6cd00", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/5165a8dc8804e31a3296108076a1d92dffe6cd00", "committedDate": "2020-03-05T10:13:07Z", "message": "Fix empty shuffle list case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8436792ca42edac41ecd5619830431ddd17a997", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/a8436792ca42edac41ecd5619830431ddd17a997", "committedDate": "2020-03-05T10:18:44Z", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-shuffle-list"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4164, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}