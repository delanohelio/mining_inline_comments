{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NDMzNzU2", "number": 1488, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDozMTozMFrODr4gQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDo1MDowOVrODr4tCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzQxMTIzOnYy", "diffSide": "RIGHT", "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApiWithSwaggerTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDozMTozMFrOF8fPRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODo1Mzo1N1rOF8-EFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MDY5Mg==", "bodyText": "I wonder if we should create a text fixture class that creates a memory only ChainStorageClient and then it can automatically create the mock DiskUpdateChannel.  We never use the memory only version in production so it's weird that we've polluted our production code with test setup constructors.  Might be a separate PR though.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398970692", "createdAt": "2020-03-27T00:31:30Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApiWithSwaggerTest.java", "diffHunk": "@@ -28,12 +28,13 @@\n import tech.pegasys.artemis.api.DataProvider;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n import tech.pegasys.artemis.storage.CombinedChainDataClient;\n+import tech.pegasys.artemis.storage.api.DiskUpdateChannel;\n import tech.pegasys.artemis.sync.SyncService;\n import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n \n public class BeaconRestApiWithSwaggerTest {\n   private final ChainStorageClient storageClient =\n-      ChainStorageClient.memoryOnlyClient(new EventBus());\n+      ChainStorageClient.memoryOnlyClient(new EventBus(), mock(DiskUpdateChannel.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxOTAzOA==", "bodyText": "I highly agree. I actually want to do it in this PR. ChainStorageClient would be way more legible if cleaned from the non-production code.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399019038", "createdAt": "2020-03-27T03:43:51Z", "author": {"login": "cemozerr"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApiWithSwaggerTest.java", "diffHunk": "@@ -28,12 +28,13 @@\n import tech.pegasys.artemis.api.DataProvider;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n import tech.pegasys.artemis.storage.CombinedChainDataClient;\n+import tech.pegasys.artemis.storage.api.DiskUpdateChannel;\n import tech.pegasys.artemis.sync.SyncService;\n import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n \n public class BeaconRestApiWithSwaggerTest {\n   private final ChainStorageClient storageClient =\n-      ChainStorageClient.memoryOnlyClient(new EventBus());\n+      ChainStorageClient.memoryOnlyClient(new EventBus(), mock(DiskUpdateChannel.class));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MDY5Mg=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ3NTczMg==", "bodyText": "Actually, I will merge this in and quickly do a follow-up PR. I have a feeling that, that PR might get a lot of comments \ud83d\ude02", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399475732", "createdAt": "2020-03-27T18:53:57Z", "author": {"login": "cemozerr"}, "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/BeaconRestApiWithSwaggerTest.java", "diffHunk": "@@ -28,12 +28,13 @@\n import tech.pegasys.artemis.api.DataProvider;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n import tech.pegasys.artemis.storage.CombinedChainDataClient;\n+import tech.pegasys.artemis.storage.api.DiskUpdateChannel;\n import tech.pegasys.artemis.sync.SyncService;\n import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n \n public class BeaconRestApiWithSwaggerTest {\n   private final ChainStorageClient storageClient =\n-      ChainStorageClient.memoryOnlyClient(new EventBus());\n+      ChainStorageClient.memoryOnlyClient(new EventBus(), mock(DiskUpdateChannel.class));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MDY5Mg=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzQxNDA5OnYy", "diffSide": "RIGHT", "path": "data/recorder/src/main/java/tech/pegasys/artemis/data/recorder/SSZTransitionRecorder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDozMzoxNlrOF8fQ8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNzo1ODo0MlrOF88OFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MTEyMw==", "bodyText": "Not sure DiskGenesisUpdate is the right name for this event.  It's probably just GenesisEvent", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398971123", "createdAt": "2020-03-27T00:33:16Z", "author": {"login": "ajsutton"}, "path": "data/recorder/src/main/java/tech/pegasys/artemis/data/recorder/SSZTransitionRecorder.java", "diffHunk": "@@ -42,7 +42,7 @@ public SSZTransitionRecorder(final Path outputDirectory) {\n   }\n \n   @Subscribe\n-  public void onGenesisEvent(final StoreGenesisDiskUpdateEvent genesisEvent) {\n+  public void onDiskGenesisUpdate(final DiskGenesisUpdate genesisEvent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0NTUyNw==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399445527", "createdAt": "2020-03-27T17:58:42Z", "author": {"login": "cemozerr"}, "path": "data/recorder/src/main/java/tech/pegasys/artemis/data/recorder/SSZTransitionRecorder.java", "diffHunk": "@@ -42,7 +42,7 @@ public SSZTransitionRecorder(final Path outputDirectory) {\n   }\n \n   @Subscribe\n-  public void onGenesisEvent(final StoreGenesisDiskUpdateEvent genesisEvent) {\n+  public void onDiskGenesisUpdate(final DiskGenesisUpdate genesisEvent) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MTEyMw=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzQyNDc0OnYy", "diffSide": "RIGHT", "path": "networking/eth2/src/testFixtures/java/tech/pegasys/artemis/networking/eth2/Eth2NetworkFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDozOTozNVrOF8fXJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODo0NzoxNVrOF891_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MjcxMA==", "bodyText": "This seems like a complicated way of creating a mock that will always return new SafeFuture() that doesn't complete.  Since there's no subscriber, nothing will reply so the future never completes.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398972710", "createdAt": "2020-03-27T00:39:35Z", "author": {"login": "ajsutton"}, "path": "networking/eth2/src/testFixtures/java/tech/pegasys/artemis/networking/eth2/Eth2NetworkFactory.java", "diffHunk": "@@ -152,11 +156,16 @@ private NetworkConfig generateConfig() {\n     }\n \n     private void setDefaults() {\n+      if (diskUpdateChannel == null) {\n+        final EventChannels eventChannels =\n+            EventChannels.createSyncChannels(TEST_EXCEPTION_HANDLER, new NoOpMetricsSystem());\n+        diskUpdateChannel = eventChannels.getPublisher(DiskUpdateChannel.class);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ3MjEyNg==", "bodyText": "Agreed. Thanks for catching. Changed.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399472126", "createdAt": "2020-03-27T18:47:15Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/testFixtures/java/tech/pegasys/artemis/networking/eth2/Eth2NetworkFactory.java", "diffHunk": "@@ -152,11 +156,16 @@ private NetworkConfig generateConfig() {\n     }\n \n     private void setDefaults() {\n+      if (diskUpdateChannel == null) {\n+        final EventChannels eventChannels =\n+            EventChannels.createSyncChannels(TEST_EXCEPTION_HANDLER, new NoOpMetricsSystem());\n+        diskUpdateChannel = eventChannels.getPublisher(DiskUpdateChannel.class);\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MjcxMA=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzQyOTQ1OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDo0MjoyNFrOF8fZ4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDo0MjoyNFrOF8fZ4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MzQxMA==", "bodyText": "Given this was just creating a TransactionPrecommit.memoryOnly() maybe it should just create a stub DiskUpdateChannel implementation that returns the same DatabaseUpdateResult.successfulWithNothingPruned() as the result of onDiskUpdate calls.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398973410", "createdAt": "2020-03-27T00:42:24Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageClient.java", "diffHunk": "@@ -59,32 +60,33 @@\n   // Time\n   private volatile UnsignedLong genesisTime;\n \n-  public static ChainStorageClient memoryOnlyClient(final EventBus eventBus) {\n-    final ChainStorageClient client =\n-        new ChainStorageClient(eventBus, TransactionPrecommit.memoryOnly());\n+  public static ChainStorageClient memoryOnlyClient(\n+      final EventBus eventBus, final DiskUpdateChannel diskUpdateChannel) {\n+    final ChainStorageClient client = new ChainStorageClient(diskUpdateChannel, eventBus);\n     eventBus.register(client);\n     return client;\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzQzMDc4OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDo0MzowMVrOF8famA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODowMzoxOFrOF88YcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MzU5Mg==", "bodyText": "We don't need the wrapper DiskGenesisUpdate event here - just pass store as the argument.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398973592", "createdAt": "2020-03-27T00:43:01Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageClient.java", "diffHunk": "@@ -103,7 +105,8 @@ public void initializeFromGenesis(final BeaconState genesisState) {\n           \"Failed to set genesis state: store has already been initialized\");\n     }\n \n-    eventBus.post(new StoreGenesisDiskUpdateEvent(store));\n+    diskUpdateChannel.onDiskGenesisUpdate(new DiskGenesisUpdate(store));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0ODE3Nw==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399448177", "createdAt": "2020-03-27T18:03:18Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageClient.java", "diffHunk": "@@ -103,7 +105,8 @@ public void initializeFromGenesis(final BeaconState genesisState) {\n           \"Failed to set genesis state: store has already been initialized\");\n     }\n \n-    eventBus.post(new StoreGenesisDiskUpdateEvent(store));\n+    diskUpdateChannel.onDiskGenesisUpdate(new DiskGenesisUpdate(store));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MzU5Mg=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzQzMzQzOnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDo0NDozMFrOF8fcFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODoxMjowM1rOF88ryw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3Mzk3Mg==", "bodyText": "We shouldn't use supplyAsync here or events will be recorded in parallel and potentially out of order.  Just SafeFuture.of.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398973972", "createdAt": "2020-03-27T00:44:30Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -81,15 +83,18 @@ public void onStoreRequest(final GetStoreRequest request) {\n     eventBus.post(new GetStoreResponse(request.getId(), getStore()));\n   }\n \n-  @Subscribe\n-  public void onStoreDiskUpdate(final StoreDiskUpdateEvent event) {\n-    final DatabaseUpdateResult result = database.update(event);\n-    handleStoreUpdate(result);\n-    eventBus.post(new StoreDiskUpdateCompleteEvent(event.getTransactionId(), result));\n+  @Override\n+  public SafeFuture<DiskUpdateResult> onDiskUpdate(final DiskUpdate event) {\n+    return SafeFuture.supplyAsync(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NDM0Ng==", "bodyText": "Actually now I think about it, as a follow up to this we should be able to remove the .join() calls after each commit() because we know each change will be applied in order.\nThough there is still a question of what to do if the returned future throws an Exception. Will need some thought, but would be really nice if we can let our processing run ahead of storage.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398974346", "createdAt": "2020-03-27T00:46:04Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -81,15 +83,18 @@ public void onStoreRequest(final GetStoreRequest request) {\n     eventBus.post(new GetStoreResponse(request.getId(), getStore()));\n   }\n \n-  @Subscribe\n-  public void onStoreDiskUpdate(final StoreDiskUpdateEvent event) {\n-    final DatabaseUpdateResult result = database.update(event);\n-    handleStoreUpdate(result);\n-    eventBus.post(new StoreDiskUpdateCompleteEvent(event.getTransactionId(), result));\n+  @Override\n+  public SafeFuture<DiskUpdateResult> onDiskUpdate(final DiskUpdate event) {\n+    return SafeFuture.supplyAsync(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3Mzk3Mg=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0ODgwOQ==", "bodyText": "Makes sense. Done.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399448809", "createdAt": "2020-03-27T18:04:23Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -81,15 +83,18 @@ public void onStoreRequest(final GetStoreRequest request) {\n     eventBus.post(new GetStoreResponse(request.getId(), getStore()));\n   }\n \n-  @Subscribe\n-  public void onStoreDiskUpdate(final StoreDiskUpdateEvent event) {\n-    final DatabaseUpdateResult result = database.update(event);\n-    handleStoreUpdate(result);\n-    eventBus.post(new StoreDiskUpdateCompleteEvent(event.getTransactionId(), result));\n+  @Override\n+  public SafeFuture<DiskUpdateResult> onDiskUpdate(final DiskUpdate event) {\n+    return SafeFuture.supplyAsync(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3Mzk3Mg=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1MDM1NQ==", "bodyText": "Thinking out loud, maybe, in a scenario where the disk is throwing exceptions, we can start logging warning level messages, but keep executing since being able to validate is more important than writing to disk. Through the messages, the user would know something needs fixing, but still not lose their stake in the meanwhile.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399450355", "createdAt": "2020-03-27T18:07:19Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -81,15 +83,18 @@ public void onStoreRequest(final GetStoreRequest request) {\n     eventBus.post(new GetStoreResponse(request.getId(), getStore()));\n   }\n \n-  @Subscribe\n-  public void onStoreDiskUpdate(final StoreDiskUpdateEvent event) {\n-    final DatabaseUpdateResult result = database.update(event);\n-    handleStoreUpdate(result);\n-    eventBus.post(new StoreDiskUpdateCompleteEvent(event.getTransactionId(), result));\n+  @Override\n+  public SafeFuture<DiskUpdateResult> onDiskUpdate(final DiskUpdate event) {\n+    return SafeFuture.supplyAsync(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3Mzk3Mg=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1MzEzMQ==", "bodyText": "https://pegasys1.atlassian.net/secure/RapidBoard.jspa?rapidView=67&modal=detail&selectedIssue=BC-319", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399453131", "createdAt": "2020-03-27T18:12:03Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -81,15 +83,18 @@ public void onStoreRequest(final GetStoreRequest request) {\n     eventBus.post(new GetStoreResponse(request.getId(), getStore()));\n   }\n \n-  @Subscribe\n-  public void onStoreDiskUpdate(final StoreDiskUpdateEvent event) {\n-    final DatabaseUpdateResult result = database.update(event);\n-    handleStoreUpdate(result);\n-    eventBus.post(new StoreDiskUpdateCompleteEvent(event.getTransactionId(), result));\n+  @Override\n+  public SafeFuture<DiskUpdateResult> onDiskUpdate(final DiskUpdate event) {\n+    return SafeFuture.supplyAsync(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3Mzk3Mg=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzQ0MjA4OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/api/DiskUpdateChannel.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDo0OToxNFrOF8fg7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODoxNDozNlrOF88xPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NTIxNA==", "bodyText": "I wonder if we should be using Storage instead of Disk for these classes.  The storage system doesn't necessarily have to store to disk (it could be S3StorageServer etc).", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398975214", "createdAt": "2020-03-27T00:49:14Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/api/DiskUpdateChannel.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.storage.api;\n+\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskGenesisUpdate;\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskUpdate;\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskUpdateResult;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+\n+public interface DiskUpdateChannel {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1MzY3Ng==", "bodyText": "Interesting point. I did not think of that. I'll make the change.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399453676", "createdAt": "2020-03-27T18:13:01Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/api/DiskUpdateChannel.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.storage.api;\n+\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskGenesisUpdate;\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskUpdate;\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskUpdateResult;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+\n+public interface DiskUpdateChannel {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NTIxNA=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NDUyNg==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399454526", "createdAt": "2020-03-27T18:14:36Z", "author": {"login": "cemozerr"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/api/DiskUpdateChannel.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.storage.api;\n+\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskGenesisUpdate;\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskUpdate;\n+import tech.pegasys.artemis.storage.events.diskupdates.DiskUpdateResult;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+\n+public interface DiskUpdateChannel {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NTIxNA=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MzQ0MzkyOnYy", "diffSide": "RIGHT", "path": "storage/src/test/java/tech/pegasys/artemis/storage/MapDbDatabaseTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDo1MDowOVrOF8fh9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxODozMDoxN1rOF89S3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NTQ3OA==", "bodyText": "Slightly odd that we're using StubDiskUpdateChannel here but a mock in a lot of other places.  Seems like we could just be using the stub.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r398975478", "createdAt": "2020-03-27T00:50:09Z", "author": {"login": "ajsutton"}, "path": "storage/src/test/java/tech/pegasys/artemis/storage/MapDbDatabaseTest.java", "diffHunk": "@@ -118,7 +116,7 @@ public void shouldRecreateOriginalGenesisStore() {\n \n   @Test\n   public void shouldGetHotBlockByRoot() {\n-    final Transaction transaction = store.startTransaction(databaseTransactionPrecommit);\n+    final Transaction transaction = store.startTransaction(new StubDiskUpdateChannel());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NzQwMg==", "bodyText": "It's because this is not actually a stub (I named it incorrectly) but an interface that handles writing to actual disk without requiring ChainStorageServer class in the process. I'll change the naming and make this more visible.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399457402", "createdAt": "2020-03-27T18:19:48Z", "author": {"login": "cemozerr"}, "path": "storage/src/test/java/tech/pegasys/artemis/storage/MapDbDatabaseTest.java", "diffHunk": "@@ -118,7 +116,7 @@ public void shouldRecreateOriginalGenesisStore() {\n \n   @Test\n   public void shouldGetHotBlockByRoot() {\n-    final Transaction transaction = store.startTransaction(databaseTransactionPrecommit);\n+    final Transaction transaction = store.startTransaction(new StubDiskUpdateChannel());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NTQ3OA=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ1NzgyMg==", "bodyText": "It also writes to the updateResults list in the process, which is a requirement for some of the tests.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399457822", "createdAt": "2020-03-27T18:20:36Z", "author": {"login": "cemozerr"}, "path": "storage/src/test/java/tech/pegasys/artemis/storage/MapDbDatabaseTest.java", "diffHunk": "@@ -118,7 +116,7 @@ public void shouldRecreateOriginalGenesisStore() {\n \n   @Test\n   public void shouldGetHotBlockByRoot() {\n-    final Transaction transaction = store.startTransaction(databaseTransactionPrecommit);\n+    final Transaction transaction = store.startTransaction(new StubDiskUpdateChannel());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NTQ3OA=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ2MzEzNA==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/1488#discussion_r399463134", "createdAt": "2020-03-27T18:30:17Z", "author": {"login": "cemozerr"}, "path": "storage/src/test/java/tech/pegasys/artemis/storage/MapDbDatabaseTest.java", "diffHunk": "@@ -118,7 +116,7 @@ public void shouldRecreateOriginalGenesisStore() {\n \n   @Test\n   public void shouldGetHotBlockByRoot() {\n-    final Transaction transaction = store.startTransaction(databaseTransactionPrecommit);\n+    final Transaction transaction = store.startTransaction(new StubDiskUpdateChannel());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3NTQ3OA=="}, "originalCommit": {"oid": "d234cc4db0b252efc60eac32db617ff44a2a03b3"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1752, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}