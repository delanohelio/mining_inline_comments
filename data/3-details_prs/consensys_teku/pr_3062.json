{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5MDQ0NjIw", "number": 3062, "title": "Optimize BeaconState SSZ serialization performance", "bodyText": "PR Description\nOptimize roughly x20 BeaconState SSZ serialization performance\n\nSSZ serialize based solely on backing tree and ViewTypes\nSerialize to a bytes 'stream' i.e. with appending bytes only (via Consumer<Bytes>)\nAbility to effectively calculate SSZ size beforehand and pre-allocate the array\nAdd LeafNode.data  notion (alongside with hashTreeRoot) (the continuation of idea from #3032)\nRelying on the fact that a List/Vector of fixed type elements (that is validators and balances) flattened with LeafNode.data is equal to SSZ serialization. (see 9ad32fd commit)\n\nFixed Issue(s)\nRelates #3031\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-23T15:29:46Z", "url": "https://github.com/ConsenSys/teku/pull/3062", "merged": true, "mergeCommit": {"oid": "e662f14682932ea0f5c51d15b3904eefd3488e92"}, "closed": true, "closedAt": "2020-10-28T11:16:47Z", "author": {"login": "Nashatyrev"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUxrZOAH2gAyNTA5MDQ0NjIwOmFhYTExZTYzMjFjZmZhZjc5MjkyYmY3NDNkYzAwNWU5MmMyODgxN2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW7fMBAH2gAyNTA5MDQ0NjIwOjE2MmMwMTViNTg4MjczNzk2Y2YwZjU2ZTVjMzg5NmNlZjk0ZDBhYzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aaa11e6321cffaf79292bf743dc005e92c28817f", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/aaa11e6321cffaf79292bf743dc005e92c28817f", "committedDate": "2020-10-21T18:28:28Z", "message": "Add ViewType.isFixedSize()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ef27174394f6d58b9ed6a48c560d4039cda2af2", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/5ef27174394f6d58b9ed6a48c560d4039cda2af2", "committedDate": "2020-10-22T14:04:20Z", "message": "Add ViewType.getFixedPartSize()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bd5b4ce992bf1c7999daf9c900f84c9f9e0a304", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/7bd5b4ce992bf1c7999daf9c900f84c9f9e0a304", "committedDate": "2020-10-22T14:04:58Z", "message": "Draft ViewRead.getSSZ() method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5de604598a01a7b50a40380c0a5fcc17cbbe324", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d5de604598a01a7b50a40380c0a5fcc17cbbe324", "committedDate": "2020-10-22T17:44:26Z", "message": "Merge remote-tracking branch 'pegasys/master' into feature/new-ssz"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4453f5dd12a8bdd43f11a1e00b19270bb5f7e213", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/4453f5dd12a8bdd43f11a1e00b19270bb5f7e213", "committedDate": "2020-10-23T11:06:55Z", "message": "Initial SSZ serialization version based on backing tree"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d772ff644c74cb1183373237e3d2ab6b1d678751", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/d772ff644c74cb1183373237e3d2ab6b1d678751", "committedDate": "2020-10-23T13:06:45Z", "message": "Add iterateLeaves() util"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b95d53da15485a32444d6d389ffdd628c6deb95", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8b95d53da15485a32444d6d389ffdd628c6deb95", "committedDate": "2020-10-23T14:46:18Z", "message": "Create compressed leaf node for nodes with more that 1 element (at index 0)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ad32fd194fff75711919fef4bbe3c1a36e9483b", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/9ad32fd194fff75711919fef4bbe3c1a36e9483b", "committedDate": "2020-10-23T14:49:48Z", "message": "Optimize ssz serialization for collections of fixed type elements (for them the flattened backing tree with compressed leaf nodes is equal to ssz serialization)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16a7fc779bd3e3c580f16a2e68ee4afd72b0d192", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/16a7fc779bd3e3c580f16a2e68ee4afd72b0d192", "committedDate": "2020-10-23T15:06:46Z", "message": "Refactor LeafNode and make the 'compressed' LeafNode a single one"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a43c1c772868167f3019106dfb2100d87d5f1d85", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/a43c1c772868167f3019106dfb2100d87d5f1d85", "committedDate": "2020-10-23T15:08:09Z", "message": "SimpleOffsetSerializer.serialize() uses new backing tree based serialization when available"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45231ef6cb1f7a2b208d60bfaaab1789915a0638", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/45231ef6cb1f7a2b208d60bfaaab1789915a0638", "committedDate": "2020-10-23T15:14:04Z", "message": "Apply spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7bc12c0453cd54fb452749725cded861e33d19a", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/f7bc12c0453cd54fb452749725cded861e33d19a", "committedDate": "2020-10-23T15:22:18Z", "message": "Fix warnings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1f279494f015d0b944e91db4fee18081f1cd822", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/a1f279494f015d0b944e91db4fee18081f1cd822", "committedDate": "2020-10-23T15:40:54Z", "message": "Remove experiments code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d1cceddc481890ce35279f2292f773d5b072340", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/8d1cceddc481890ce35279f2292f773d5b072340", "committedDate": "2020-10-23T16:01:16Z", "message": "Merge remote-tracking branch 'pegasys/master' into feature/new-ssz"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fecca78075675ccb34d2d5290aa2126866e725d7", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/fecca78075675ccb34d2d5290aa2126866e725d7", "committedDate": "2020-10-23T16:39:13Z", "message": "Fix accidentally removed methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813d6a255146474c779a050ec4909e92a580df53", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/813d6a255146474c779a050ec4909e92a580df53", "committedDate": "2020-10-23T16:57:17Z", "message": "Add some javadocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NDE1MDYw", "url": "https://github.com/ConsenSys/teku/pull/3062#pullrequestreview-516415060", "createdAt": "2020-10-26T00:30:55Z", "commit": {"oid": "813d6a255146474c779a050ec4909e92a580df53"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwMDozMDo1NVrOHn98dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwMDozODowNlrOHn9_8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3MTQxNQ==", "bodyText": "nit: I'd just omit the else here since the if block returns anyway. Saves indenting the rest of the method.", "url": "https://github.com/ConsenSys/teku/pull/3062#discussion_r511671415", "createdAt": "2020-10-26T00:30:55Z", "author": {"login": "ajsutton"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/util/SimpleOffsetSerializer.java", "diffHunk": "@@ -136,40 +137,44 @@ public static void setConstants() {\n   }\n \n   public static Bytes serialize(SimpleOffsetSerializable value) {\n-    List<UInt64> variable_offsets = new ArrayList<>();\n-    List<Bytes> interleaved_values = new ArrayList<>();\n-    UInt64 fixedLengthSum = UInt64.ZERO;\n-    UInt64 varLengthSum = UInt64.ZERO;\n-\n-    for (Bytes fixedPart : value.get_fixed_parts()) {\n-      UInt64 fixedPartSize = UInt64.valueOf(fixedPart.size());\n-      if (fixedPartSize.equals(UInt64.ZERO)) {\n-        fixedPartSize = UInt64.valueOf(4L);\n+    if (value instanceof ViewRead) {\n+      return ((ViewRead) value).sszSerialize();\n+    } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813d6a255146474c779a050ec4909e92a580df53"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3MjEzNg==", "bodyText": "Might be worth leaving a comment to explain why we do nothing in the !fromLeft && toLeft case.", "url": "https://github.com/ConsenSys/teku/pull/3062#discussion_r511672136", "createdAt": "2020-10-26T00:36:34Z", "author": {"login": "ajsutton"}, "path": "ssz/src/main/java/tech/pegasys/teku/ssz/backing/tree/TreeUtil.java", "diffHunk": "@@ -119,6 +119,42 @@ public static int estimateNonDefaultNodes(TreeNode node) {\n     }\n   }\n \n+  public static void iterateLeaves(\n+      TreeNode node, long fromGeneralIndex, long toGeneralIndex, Consumer<LeafNode> visitor) {\n+    long leftmostFromIndex = fromGeneralIndex << (63 - treeDepth(fromGeneralIndex));\n+    int shiftN = 63 - treeDepth(toGeneralIndex);\n+    long rightmostToIndex = (toGeneralIndex << shiftN) | ((1L << shiftN) - 1);\n+    iterateLeavesPriv(node, leftmostFromIndex, rightmostToIndex, visitor);\n+  }\n+\n+  private static void iterateLeavesPriv(\n+      TreeNode node, long fromGeneralIndex, long toGeneralIndex, Consumer<LeafNode> visitor) {\n+    if (node instanceof LeafNode) {\n+      visitor.accept((LeafNode) node);\n+    } else {\n+\n+      BranchNode bNode = (BranchNode) node;\n+      long anchorF = Long.highestOneBit(fromGeneralIndex);\n+      long pivotF = anchorF >>> 1;\n+      boolean fromLeft = fromGeneralIndex < (fromGeneralIndex | pivotF);\n+      long fromChildIdx = (fromGeneralIndex ^ anchorF) | pivotF;\n+\n+      long anchorT = Long.highestOneBit(toGeneralIndex);\n+      long pivotT = anchorT >>> 1;\n+      boolean toLeft = toGeneralIndex < (toGeneralIndex | pivotT);\n+      long toChildIdx = (toGeneralIndex ^ anchorT) | pivotT;\n+\n+      if (fromLeft && !toLeft) {\n+        iterateLeavesPriv(bNode.left(), fromChildIdx, -1, visitor);\n+        iterateLeavesPriv(bNode.right(), 1L << 63, toChildIdx, visitor);\n+      } else if (fromLeft && toLeft) {\n+        iterateLeavesPriv(bNode.left(), fromChildIdx, toChildIdx, visitor);\n+      } else if (!fromLeft && !toLeft) {\n+        iterateLeavesPriv(bNode.right(), fromChildIdx, toChildIdx, visitor);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813d6a255146474c779a050ec4909e92a580df53"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY3MjMwNQ==", "bodyText": "Should we just omit the sszDeserialize method for now until we actually implement it?", "url": "https://github.com/ConsenSys/teku/pull/3062#discussion_r511672305", "createdAt": "2020-10-26T00:38:06Z", "author": {"login": "ajsutton"}, "path": "ssz/src/main/java/tech/pegasys/teku/ssz/backing/type/BasicViewType.java", "diffHunk": "@@ -59,4 +61,35 @@ public TreeNode createBackingNode(C newValue) {\n   @Override\n   public abstract TreeNode updateBackingNode(\n       TreeNode srcNode, int internalIndex, ViewRead newValue);\n+\n+  private int getSSZBytesSize() {\n+    return (getBitsSize() + 7) / 8;\n+  }\n+\n+  @Override\n+  public boolean isFixedSize() {\n+    return true;\n+  }\n+\n+  @Override\n+  public int getFixedPartSize() {\n+    return getSSZBytesSize();\n+  }\n+\n+  @Override\n+  public int getVariablePartSize(TreeNode node) {\n+    return 0;\n+  }\n+\n+  @Override\n+  public int sszSerialize(TreeNode node, Consumer<Bytes> writer) {\n+    Bytes ret = node.hashTreeRoot().slice(0, getSSZBytesSize());\n+    writer.accept(ret);\n+    return ret.size();\n+  }\n+\n+  @Override\n+  public TreeNode sszDeserialize(Bytes ssz) {\n+    throw new UnsupportedOperationException(\"TODO\");\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813d6a255146474c779a050ec4909e92a580df53"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26626f8ceb08d77650f9724f33eeffadb391368d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/26626f8ceb08d77650f9724f33eeffadb391368d", "committedDate": "2020-10-26T16:37:45Z", "message": "Fix generating default backing tree for packed vectors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59f1eafdd6dfe772a94e6f3e075c048f67b20ca0", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/59f1eafdd6dfe772a94e6f3e075c048f67b20ca0", "committedDate": "2020-10-26T16:42:02Z", "message": "Apply spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e901d4ef6d0ac09401892c6572fa3ffae2fb1ea", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/0e901d4ef6d0ac09401892c6572fa3ffae2fb1ea", "committedDate": "2020-10-26T16:50:16Z", "message": "Remove unused method for now. A couple of minor updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cc7fc7156a39f252b837afd6e64757fd4c604ae", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/6cc7fc7156a39f252b837afd6e64757fd4c604ae", "committedDate": "2020-10-26T18:03:04Z", "message": "Add a couple of asserts for easier ssz problem localization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e181584c4c22a6a406669371193d27301762ea88", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/e181584c4c22a6a406669371193d27301762ea88", "committedDate": "2020-10-26T18:06:30Z", "message": "Fix packed basic collection update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe8335edbde43888e9bcdde9a361d3b1e17a63d2", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/fe8335edbde43888e9bcdde9a361d3b1e17a63d2", "committedDate": "2020-10-26T18:46:28Z", "message": "Fix packed bit collection update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2d44ed9aafa2c0f2e69a0542cf91068e7a93ffb", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/a2d44ed9aafa2c0f2e69a0542cf91068e7a93ffb", "committedDate": "2020-10-26T19:22:53Z", "message": "Fix the test add null constructor check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fe0f88ea192bebb740927abc01b41977199a81d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/4fe0f88ea192bebb740927abc01b41977199a81d", "committedDate": "2020-10-26T19:40:43Z", "message": "Merge branch 'master' into feature/new-ssz"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "228a3b2bd9d95025090930ac77a8a1979224a2ba", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/228a3b2bd9d95025090930ac77a8a1979224a2ba", "committedDate": "2020-10-26T20:09:15Z", "message": "Add some docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3e71d2cb262d286b3c96546b158a57d3e1a53f4", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/c3e71d2cb262d286b3c96546b158a57d3e1a53f4", "committedDate": "2020-10-26T20:11:57Z", "message": "No need for special serialization of bitvector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dc7274b852ad6f3dd66033dc964b7392bcf2818", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/7dc7274b852ad6f3dd66033dc964b7392bcf2818", "committedDate": "2020-10-26T20:17:41Z", "message": "A bit more javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77feaec82f20bbd315a6149d6a839901b532066d", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/77feaec82f20bbd315a6149d6a839901b532066d", "committedDate": "2020-10-27T10:09:32Z", "message": "Fix serialization of empty Bitlist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9432c637b706143789aeb43cd54ca3052fe9ba6", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/b9432c637b706143789aeb43cd54ca3052fe9ba6", "committedDate": "2020-10-27T10:24:29Z", "message": "Merge branch 'master' into feature/new-ssz"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MjUxMzUz", "url": "https://github.com/ConsenSys/teku/pull/3062#pullrequestreview-518251353", "createdAt": "2020-10-28T00:51:28Z", "commit": {"oid": "b9432c637b706143789aeb43cd54ca3052fe9ba6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "162c015b588273796cf0f56e5c3896cef94d0ac0", "author": {"user": {"login": "Nashatyrev", "name": "Anton Nashatyrev"}}, "url": "https://github.com/ConsenSys/teku/commit/162c015b588273796cf0f56e5c3896cef94d0ac0", "committedDate": "2020-10-28T11:02:02Z", "message": "Merge branch 'master' into feature/new-ssz"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3257, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}