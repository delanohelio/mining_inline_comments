{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0OTY5MjY5", "number": 3139, "title": "Enable different modes for performance tracking", "bodyText": "PR Description\nAllows Teku to track metrics by only metrics, or only by logging, or by both as it used to be.\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-03T20:17:09Z", "url": "https://github.com/ConsenSys/teku/pull/3139", "merged": true, "mergeCommit": {"oid": "b893b14e65ae69223cada1e54cedb057d828750a"}, "closed": true, "closedAt": "2020-11-05T13:27:25Z", "author": {"login": "cemozerr"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY_AsuAH2gAyNTE0OTY5MjY5OmM5MDlkZGM4YzhjOWFhNDMzZWQ3ZjY2NGU3OWY2ODVlYjhkOGQzODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZiLKBAH2gAyNTE0OTY5MjY5OjFjZjg0ZmQxNThkNjk5NTNjNjIzNDA4OTc1ZTVlM2EzZTJkNWI1MzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c909ddc8c8c9aa433ed7f664e79f685eb8d8d384", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/c909ddc8c8c9aa433ed7f664e79f685eb8d8d384", "committedDate": "2020-11-03T20:16:12Z", "message": "Enable different modes for performance tracking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f979096b698acb738bd40f523b7226c57431c8c5", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/f979096b698acb738bd40f523b7226c57431c8c5", "committedDate": "2020-11-03T20:17:24Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdd9527277e8f5674d90eb5a2ea1ed4b0e586a98", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/cdd9527277e8f5674d90eb5a2ea1ed4b0e586a98", "committedDate": "2020-11-03T20:31:53Z", "message": "Explicitly pass mode to tracker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a604f83de3b08b8a24181abd3400376eb237aa33", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/a604f83de3b08b8a24181abd3400376eb237aa33", "committedDate": "2020-11-03T20:48:57Z", "message": "Fix unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDI0NTEz", "url": "https://github.com/ConsenSys/teku/pull/3139#pullrequestreview-523024513", "createdAt": "2020-11-04T03:42:06Z", "commit": {"oid": "a604f83de3b08b8a24181abd3400376eb237aa33"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMzo0MjowNlrOHtIImQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwMzo0MjowNlrOHtIImQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA4MTI0MQ==", "bodyText": "I don't think this should be two different options.  Ultimately I think we want ``--validators-performance-tracking-modewhich can be one ofNONE`, `LOGGING`, `METRICS` or `ALL`.  We don't want to break backwards compatibility though so I'd keep `--validators-perforamance-tracking-enabled` but hide it, make it a `Boolean` with default `null` and then when it's set false makes the mode `NONE` and true makes it `ALL`.\nAnd I'd keep the default mode as ALL so this is enabled by default.  If people don't want the logs they can silence them but otherwise they don't tend to discover them.", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517081241", "createdAt": "2020-11-04T03:42:06Z", "author": {"login": "ajsutton"}, "path": "teku/src/main/java/tech/pegasys/teku/cli/options/ValidatorOptions.java", "diffHunk": "@@ -93,11 +94,19 @@\n   @Option(\n       names = {\"--validators-performance-tracking-enabled\"},\n       paramLabel = \"<BOOLEAN>\",\n-      description = \"Enable validator performance tracking and logging\",\n+      description = \"Enable validator performance tracking\",\n       fallbackValue = \"true\",\n       arity = \"0..1\")\n   private boolean validatorPerformanceTrackingEnabled = false;\n \n+  @Option(\n+      names = {\"--validators-performance-tracking-mode\"},\n+      paramLabel = \"<TRACKING_MODE>\",\n+      description = \"Set strategy for handling performance tracking\",\n+      arity = \"1\")\n+  private ValidatorPerformanceTrackingMode validatorPerformanceTrackingMode =\n+      ValidatorPerformanceTrackingMode.ALL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a604f83de3b08b8a24181abd3400376eb237aa33"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a04ce0ffd695030f2f6a278df1ffa7857e1a719", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/7a04ce0ffd695030f2f6a278df1ffa7857e1a719", "committedDate": "2020-11-04T19:49:25Z", "message": "Hide 'enabled' option and make it override 'mode' option if it exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13c3a7e283d7d797853224149364995fae70af50", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/13c3a7e283d7d797853224149364995fae70af50", "committedDate": "2020-11-04T20:30:26Z", "message": "Merge branch 'master' into enablePerformanceTrackingDifferentModes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNzI3NzM4", "url": "https://github.com/ConsenSys/teku/pull/3139#pullrequestreview-523727738", "createdAt": "2020-11-04T20:55:06Z", "commit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMDo1NTowNlrOHtpXig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMTowMToxNlrOHtpjrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNTczOA==", "bodyText": "Does this get used anywhere?", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517625738", "createdAt": "2020-11-04T20:55:06Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/teku/util/config/ValidatorPerformanceTrackingMode.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.config;\n+\n+import java.util.Objects;\n+\n+public enum ValidatorPerformanceTrackingMode {\n+  LOGGING,\n+  METRICS,\n+  ALL,\n+  NONE;\n+\n+  static ValidatorPerformanceTrackingMode fromString(final String value) {\n+    final String normalizedValue = value.trim().toUpperCase();\n+    for (ValidatorPerformanceTrackingMode mode : ValidatorPerformanceTrackingMode.values()) {\n+      if (Objects.equals(mode.name(), normalizedValue)) {\n+        return mode;\n+      }\n+    }\n+    throw new IllegalArgumentException(\"Unknown value supplied: \" + value);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNzAzMQ==", "bodyText": "nit: I'd suggest having a ValidatorPerformanceTrackingMode.isEnabled() method (it would do this != NONE check but just makes things more readable).", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517627031", "createdAt": "2020-11-04T20:57:37Z", "author": {"login": "ajsutton"}, "path": "services/beaconchain/src/main/java/tech/pegasys/teku/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -344,10 +345,15 @@ private void initRecentBlockFetcher() {\n \n   private void initPerformanceTracker() {\n     LOG.debug(\"BeaconChainController.initPerformanceTracker()\");\n-    if (beaconConfig.validatorConfig().isValidatorPerformanceTrackingEnabled()) {\n+    ValidatorPerformanceTrackingMode mode =\n+        beaconConfig.validatorConfig().getValidatorPerformanceTrackingMode();\n+    if (mode != ValidatorPerformanceTrackingMode.NONE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyODI2Ng==", "bodyText": "I think this should probably just be done in ValidatorOptions.configure and this class would only take a ValidatorPerformanceTrackingMode so the backwards compatibility is isolated.", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517628266", "createdAt": "2020-11-04T21:00:04Z", "author": {"login": "ajsutton"}, "path": "validator/api/src/main/java/tech/pegasys/teku/validator/api/ValidatorConfig.java", "diffHunk": "@@ -58,17 +60,23 @@ private ValidatorConfig(\n     this.validatorExternalSignerUrl = validatorExternalSignerUrl;\n     this.validatorExternalSignerTimeout = validatorExternalSignerTimeout;\n     this.graffiti = graffiti;\n-    this.validatorPerformanceTrackingEnabled = validatorPerformanceTrackingEnabled;\n     this.validatorKeystoreLockingEnabled = validatorKeystoreLockingEnabled;\n     this.beaconNodeApiEndpoint = beaconNodeApiEndpoint;\n+    if (validatorPerformanceTrackingEnabled == null) {\n+      this.validatorPerformanceTrackingMode = validatorPerformanceTrackingMode;\n+    } else if (validatorPerformanceTrackingEnabled) {\n+      this.validatorPerformanceTrackingMode = ValidatorPerformanceTrackingMode.ALL;\n+    } else {\n+      this.validatorPerformanceTrackingMode = ValidatorPerformanceTrackingMode.NONE;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyODg0Ng==", "bodyText": "nit: Possibly simpler as:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  switch (mode) {\n          \n          \n            \n                    case LOGGING:\n          \n          \n            \n                      statusLogger.performance(attestationPerformance.toString());\n          \n          \n            \n                      break;\n          \n          \n            \n                    case METRICS:\n          \n          \n            \n                      validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n          \n          \n            \n                      break;\n          \n          \n            \n                    case ALL:\n          \n          \n            \n                      statusLogger.performance(attestationPerformance.toString());\n          \n          \n            \n                      validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n          \n          \n            \n                      break;\n          \n          \n            \n                    case NONE:\n          \n          \n            \n                      throw new IllegalStateException(\n          \n          \n            \n                          \"Performance Tracker should not be running in NONE mode.\");\n          \n          \n            \n                  if (mode.isLoggingEnabled()) {\n          \n          \n            \n                      statusLogger.performance(attestationPerformance.toString());\n          \n          \n            \n                 }\n          \n          \n            \n                 if (mode.isMetricsEnabled()) {\n          \n          \n            \n                    validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n          \n          \n            \n                 }", "url": "https://github.com/ConsenSys/teku/pull/3139#discussion_r517628846", "createdAt": "2020-11-04T21:01:16Z", "author": {"login": "ajsutton"}, "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/performance/DefaultPerformanceTracker.java", "diffHunk": "@@ -104,10 +108,23 @@ public void onSlot(UInt64 slot) {\n       UInt64 analyzedEpoch = currentEpoch.minus(ATTESTATION_INCLUSION_RANGE);\n       AttestationPerformance attestationPerformance =\n           getAttestationPerformanceForEpoch(currentEpoch, analyzedEpoch);\n-      statusLogger.performance(attestationPerformance.toString());\n+      switch (mode) {\n+        case LOGGING:\n+          statusLogger.performance(attestationPerformance.toString());\n+          break;\n+        case METRICS:\n+          validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n+          break;\n+        case ALL:\n+          statusLogger.performance(attestationPerformance.toString());\n+          validatorPerformanceMetrics.updateAttestationPerformanceMetrics(attestationPerformance);\n+          break;\n+        case NONE:\n+          throw new IllegalStateException(\n+              \"Performance Tracker should not be running in NONE mode.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13c3a7e283d7d797853224149364995fae70af50"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eea9502e766f7ee3dd85c88af4ab51f76006d1d1", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/eea9502e766f7ee3dd85c88af4ab51f76006d1d1", "committedDate": "2020-11-04T22:27:37Z", "message": "Remove redundant method and make mode more readable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f231432170285be381d1392ff1125df295443737", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/f231432170285be381d1392ff1125df295443737", "committedDate": "2020-11-04T22:27:37Z", "message": "Isolate backwards compability effort"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b26cb1fb9f01e71ef6fe27ae8d086d638ead721f", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/b26cb1fb9f01e71ef6fe27ae8d086d638ead721f", "committedDate": "2020-11-04T22:27:38Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55c2ba194c151f987c0c7fbd253640133ba79543", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/55c2ba194c151f987c0c7fbd253640133ba79543", "committedDate": "2020-11-04T22:31:17Z", "message": "Merge branch 'master' into enablePerformanceTrackingDifferentModes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cf84fd158d69953c623408975e5e3a3e2d5b531", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/1cf84fd158d69953c623408975e5e3a3e2d5b531", "committedDate": "2020-11-05T13:14:18Z", "message": "Merge branch 'master' into enablePerformanceTrackingDifferentModes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3298, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}