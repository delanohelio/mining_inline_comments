{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyNjc3MDcx", "number": 2843, "title": "[Issue 2273] Validate peers against weakSubjectivity checkpoint", "bodyText": "PR Description\nPass weak subjectivity checkpoint into PeerChainValidator and check that peers' chains are consistent with this checkpoint.\nFixed Issue(s)\nPart of #2273\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-09-24T20:17:08Z", "url": "https://github.com/ConsenSys/teku/pull/2843", "merged": true, "mergeCommit": {"oid": "8f390ed1abf86f3d77fe62e75c71b0cd31ff2bf2"}, "closed": true, "closedAt": "2020-09-25T17:47:59Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMG1edAH2gAyNDkyNjc3MDcxOmE2OWNmZTM3NzU2YjYyNzBlNDExYzY3MmQ4ZTA4Yjk1ZjA0ZGI3MTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMYCcXgH2gAyNDkyNjc3MDcxOjFkMzM0YzJjZjYwMWU3N2I5NGZmY2EyMGYyNjUxMmNhM2Y4NDBkMDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a69cfe37756b6270e411c672d8e08b95f04db710", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a69cfe37756b6270e411c672d8e08b95f04db710", "committedDate": "2020-09-24T20:02:10Z", "message": "Pass ws checkpoint through to PeerChainValidator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6f062e8e5b639f5a10680e39f7c666daa83b337", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f6f062e8e5b639f5a10680e39f7c666daa83b337", "committedDate": "2020-09-24T20:02:10Z", "message": "Update test factory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "786056b0b3279f2a6b301a9c92029316768ddca0", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/786056b0b3279f2a6b301a9c92029316768ddca0", "committedDate": "2020-09-24T20:02:10Z", "message": "Add required checkpoint validation logic to PeerChainValidator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTAwOTk0", "url": "https://github.com/ConsenSys/teku/pull/2843#pullrequestreview-496500994", "createdAt": "2020-09-25T14:57:48Z", "commit": {"oid": "786056b0b3279f2a6b301a9c92029316768ddca0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNDo1Nzo0OFrOHYHODw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNDo1Nzo0OFrOHYHODw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA0NjE1OQ==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private boolean validateFork(final Eth2Peer peer, final PeerStatus status) {\n          \n          \n            \n              private boolean isForkValid(final Eth2Peer peer, final PeerStatus status) {", "url": "https://github.com/ConsenSys/teku/pull/2843#discussion_r495046159", "createdAt": "2020-09-25T14:57:48Z", "author": {"login": "cemozerr"}, "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/PeerChainValidator.java", "diffHunk": "@@ -87,24 +96,85 @@ public static PeerChainValidator create(\n             });\n   }\n \n-  private SafeFuture<Boolean> checkRemoteChain(final Eth2Peer peer, final PeerStatus status) {\n-    // Check fork compatibility\n+  private SafeFuture<Boolean> isRemoteChainValid(final Eth2Peer peer, final PeerStatus status) {\n+    if (!validateFork(peer, status)) {\n+      return SafeFuture.completedFuture(false);\n+    }\n+\n+    // Skip remaining checks if only genesis is finalized\n+    if (status.getFinalizedEpoch().equals(UInt64.ZERO)) {\n+      return SafeFuture.completedFuture(true);\n+    }\n+\n+    return validateRequiredCheckpoint(peer, status)\n+        .thenCompose(\n+            isValid -> {\n+              if (!isValid) {\n+                // Short-circuit if we know the chain is invalid\n+                LOG.trace(\n+                    \"Failed to validate peer against required checkpoint {}\", requiredCheckpoint);\n+                return SafeFuture.completedFuture(isValid);\n+              }\n+\n+              return validateFinalizedCheckpoint(peer, status);\n+            });\n+  }\n+\n+  private boolean validateFork(final Eth2Peer peer, final PeerStatus status) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "786056b0b3279f2a6b301a9c92029316768ddca0"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTAyNzgx", "url": "https://github.com/ConsenSys/teku/pull/2843#pullrequestreview-496502781", "createdAt": "2020-09-25T14:59:47Z", "commit": {"oid": "786056b0b3279f2a6b301a9c92029316768ddca0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTEwNTE2", "url": "https://github.com/ConsenSys/teku/pull/2843#pullrequestreview-496510516", "createdAt": "2020-09-25T15:08:59Z", "commit": {"oid": "786056b0b3279f2a6b301a9c92029316768ddca0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "309cf02c1d5de5a1dd988949e51c346780692fc3", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/309cf02c1d5de5a1dd988949e51c346780692fc3", "committedDate": "2020-09-25T15:22:15Z", "message": "Merge branch 'master' into issue-2273/validate-peers-against-ws-checkpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caade081834b82dc72aa19a0dcddf0a381bbe5c0", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/caade081834b82dc72aa19a0dcddf0a381bbe5c0", "committedDate": "2020-09-25T15:30:21Z", "message": "Rework method names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d334c2cf601e77b94ffca20f26512ca3f840d03", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/1d334c2cf601e77b94ffca20f26512ca3f840d03", "committedDate": "2020-09-25T16:04:43Z", "message": "Add more logging"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3460, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}