{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MzU4MTk0", "number": 1100, "title": "V0.10.1", "bodyText": "Brings us up to the v0.10.0 core beacon chain spec. It includes a big BLS refactor to make the interfaces more uniform with the BLS signature standard.\nNote: does not include other v0.10.0/1 changes, such as fork choice\nWaiting for a couple of external things before we can merge\n\n Fixes to the BLS reference tests: ethereum/consensus-specs#1575\n Fixes to the reference test deposit handling: ethereum/consensus-specs#1582\n Fixes to the BLS reference tests: ethereum/consensus-specs#1597\n\nAlso\n\n need to update the MockStartDepositGeneratorTest input test data. I've disabled it for now.\n Fix the new benchmark code. I seem to have broken it.\n Make sure no other changes sneaked in in v0.10.1\n\nWe probably want to stay at 0.9.4 until a number of other clients are ready with 0.10.0", "createdAt": "2020-01-21T15:16:01Z", "url": "https://github.com/ConsenSys/teku/pull/1100", "merged": true, "mergeCommit": {"oid": "65ad73f9244b6a9664fd6a6fb5b7b528abe913d3"}, "closed": true, "closedAt": "2020-03-16T13:18:24Z", "author": {"login": "benjaminion"}, "timelineItems": {"totalCount": 52, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8rCNbgFqTM0NjI4NTUwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcONkEVgH2gAyMzY1MzU4MTk0OmI4M2VlMjkwNzQ4ZWY0MzA2OWNlMjM0ZGFkOWYyZDBhZTlhYWZmY2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2Mjg1NTAz", "url": "https://github.com/ConsenSys/teku/pull/1100#pullrequestreview-346285503", "createdAt": "2020-01-22T00:40:26Z", "commit": {"oid": "30f12a83d44975d14b1f5262f0858b810a00e7b7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDo0MDoyNlrOFgNcww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMDo0Mzo0OFrOFgNgGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxOTEwNw==", "bodyText": "It's generally better to avoid getters having to create the object they're returning.  Was there a reason we're now deferring the creation of these BLSPublicKey and BLSSecretKey objects?\nAdmittedly I normally don't like constructors creating new objects but given these are just wrappers the benefit of caching them seems to outweigh the slight unpleasantness of constructors doing \"work\".", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r369319107", "createdAt": "2020-01-22T00:40:26Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/artemis/util/bls/BLSKeyPair.java", "diffHunk": "@@ -28,20 +27,15 @@ public static BLSKeyPair random(int entropy) {\n     return new BLSKeyPair(KeyPair.random(entropy));\n   }\n \n-  public BLSKeyPair(BLSPublicKey publicKey, BLSSecretKey secretKey) {\n-    this.publicKey = publicKey;\n-    this.secretKey = secretKey;\n-  }\n-\n   public BLSKeyPair(KeyPair keyPair) {\n-    this(new BLSPublicKey(keyPair.publicKey()), new BLSSecretKey(keyPair.secretKey()));\n+    this.keyPair = keyPair;\n   }\n \n   public BLSPublicKey getPublicKey() {\n-    return publicKey;\n+    return new BLSPublicKey(keyPair.publicKey());\n   }\n \n   public BLSSecretKey getSecretKey() {\n-    return secretKey;\n+    return new BLSSecretKey(keyPair.secretKey());\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30f12a83d44975d14b1f5262f0858b810a00e7b7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMxOTk2MA==", "bodyText": "Yay! Sanity!", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r369319960", "createdAt": "2020-01-22T00:43:48Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/artemis/util/config/Constants.java", "diffHunk": "@@ -210,21 +211,21 @@ public static void setConstants(String Constants) {\n       EFFECTIVE_BALANCE_INCREMENT = 1000000000L;\n \n       // Initial values\n-      GENESIS_SLOT = 0;\n-      GENESIS_EPOCH = 0;\n+      GENESIS_FORK_VERSION = new Bytes4(Bytes.fromHexString(\"0x00000001\"));\n       BLS_WITHDRAWAL_PREFIX = Bytes.wrap(new byte[1]);\n \n       // Time parameters\n+      MIN_GENESIS_DELAY = 300;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30f12a83d44975d14b1f5262f0858b810a00e7b7"}, "originalPosition": 74}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30f12a83d44975d14b1f5262f0858b810a00e7b7", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/30f12a83d44975d14b1f5262f0858b810a00e7b7", "committedDate": "2020-01-21T19:13:24Z", "message": "Passing Artemis unit tests"}, "afterCommit": {"oid": "1150bb078a54f4dab702a7be615db6039b0ed2be", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/1150bb078a54f4dab702a7be615db6039b0ed2be", "committedDate": "2020-01-22T11:54:46Z", "message": "Tidy up\n\nIn particular, be more assertive about encapsulating the Mikuli library."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f2ebe60185bafdc76cb1ca10019e029db5ed209", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/8f2ebe60185bafdc76cb1ca10019e029db5ed209", "committedDate": "2020-01-26T21:43:00Z", "message": "Spotless"}, "afterCommit": {"oid": "26f1fe0129d68fdd9d7b081874ef0c0877c3d4d3", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/26f1fe0129d68fdd9d7b081874ef0c0877c3d4d3", "committedDate": "2020-01-26T22:01:14Z", "message": "Spotless"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26f1fe0129d68fdd9d7b081874ef0c0877c3d4d3", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/26f1fe0129d68fdd9d7b081874ef0c0877c3d4d3", "committedDate": "2020-01-26T22:01:14Z", "message": "Spotless"}, "afterCommit": {"oid": "e2051788d8d745edcdb304d53f0140e198c8f817", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/e2051788d8d745edcdb304d53f0140e198c8f817", "committedDate": "2020-01-28T09:50:40Z", "message": "Remove G2Point from reference test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db46f80a0e2b3702b1bfcb121adcb027c41af9cf", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/db46f80a0e2b3702b1bfcb121adcb027c41af9cf", "committedDate": "2020-01-29T09:07:34Z", "message": "Big BLS refactor\n\nIn preparation for spec 0.10.0.\nWIP - temporarily breaks many things."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e431e2f8d5470d709d538443d4f881f202c07355", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/e431e2f8d5470d709d538443d4f881f202c07355", "committedDate": "2020-01-29T09:07:34Z", "message": "Continued refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c42904b3519124eb15bb1c241dc3a866e0cee950", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/c42904b3519124eb15bb1c241dc3a866e0cee950", "committedDate": "2020-01-29T09:07:34Z", "message": "Move aggregation over to the new BLS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b88755e449f5fc9c009594c0e6fd8df6eca909ac", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/b88755e449f5fc9c009594c0e6fd8df6eca909ac", "committedDate": "2020-01-29T09:07:34Z", "message": "Implements (and passes) v0.10.0 BLS reference tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11575a7a5862d432e82379d38c45e1235cf3a5db", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/11575a7a5862d432e82379d38c45e1235cf3a5db", "committedDate": "2020-01-29T09:07:34Z", "message": "Up to v0.10.0 except for some tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25600a67bbcfe613f6a5db13455755c7dbf4bf5e", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/25600a67bbcfe613f6a5db13455755c7dbf4bf5e", "committedDate": "2020-01-29T09:07:34Z", "message": "Passing Artemis unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1986b6cf5bfb10fdd60924bf4f8e7a983bc0f9c", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/b1986b6cf5bfb10fdd60924bf4f8e7a983bc0f9c", "committedDate": "2020-01-29T09:07:34Z", "message": "Tidy up\n\nIn particular, be more assertive about encapsulating the Mikuli library."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fafc38a6c38ffa95e9d9a2e902134463382ebd5", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/9fafc38a6c38ffa95e9d9a2e902134463382ebd5", "committedDate": "2020-01-29T09:07:34Z", "message": "Add toString methods to keep benchmarks happy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "859553739d9745a3908e32a25229c12c9d239489", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/859553739d9745a3908e32a25229c12c9d239489", "committedDate": "2020-01-29T09:07:34Z", "message": "Update BLS tests to v0.10.1\n\nUnfortunately, there remains a bug in the fastAggregateVerify reference test data,\nso those will fail until the test suite is fixed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "557c29bd150c4d2c9b39838a37fd5d93fedbaf57", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/557c29bd150c4d2c9b39838a37fd5d93fedbaf57", "committedDate": "2020-01-29T09:07:34Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5753d9484ef0746a8aef885d6e66082a03d41bfc", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/5753d9484ef0746a8aef885d6e66082a03d41bfc", "committedDate": "2020-01-29T09:07:34Z", "message": "Remove G2Point from reference test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b0b63bca452069fb4fb5e7ff9d05a9510060855", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/5b0b63bca452069fb4fb5e7ff9d05a9510060855", "committedDate": "2020-01-29T09:07:34Z", "message": "Modify build.gradle to get CircleCI to update reftest cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2051788d8d745edcdb304d53f0140e198c8f817", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/e2051788d8d745edcdb304d53f0140e198c8f817", "committedDate": "2020-01-28T09:50:40Z", "message": "Remove G2Point from reference test code"}, "afterCommit": {"oid": "5b0b63bca452069fb4fb5e7ff9d05a9510060855", "author": {"user": {"login": "benjaminion", "name": "Ben Edgington"}}, "url": "https://github.com/ConsenSys/teku/commit/5b0b63bca452069fb4fb5e7ff9d05a9510060855", "committedDate": "2020-01-29T09:07:34Z", "message": "Modify build.gradle to get CircleCI to update reftest cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e696e7c1f22c8a602c5780b8372bba0dc392e809", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e696e7c1f22c8a602c5780b8372bba0dc392e809", "committedDate": "2020-02-02T21:09:32Z", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into v0.10.0\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/BeaconStateUtil.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14e5a3bda391f0735d3da3fb582e93cc73c581b6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/14e5a3bda391f0735d3da3fb582e93cc73c581b6", "committedDate": "2020-02-03T21:02:22Z", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into v0.10.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d29739884389af79e84ddeff2477a5f2d7ec550", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3d29739884389af79e84ddeff2477a5f2d7ec550", "committedDate": "2020-02-19T23:42:11Z", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into v0.10.0\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/BeaconStateUtil.java\n#\tethereum/statetransition/src/test-support/java/tech/pegasys/artemis/statetransition/BeaconChainUtil.java\n#\tvalidator/client/src/main/java/tech/pegasys/artemis/validator/client/ValidatorClient.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf8f09e3c8e9cfb65269f8351333382c928d8305", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/cf8f09e3c8e9cfb65269f8351333382c928d8305", "committedDate": "2020-02-25T04:39:40Z", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into v0.10.0\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/blocks/BeaconBlockHeader.java\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/Fork.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce1d281b035c6c216c293e633dc220457a42f4b9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ce1d281b035c6c216c293e633dc220457a42f4b9", "committedDate": "2020-02-25T05:13:20Z", "message": "Spotless."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bee4bf765cef89c11fde52b796fa0f766cae3602", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/bee4bf765cef89c11fde52b796fa0f766cae3602", "committedDate": "2020-02-25T05:37:50Z", "message": "Adjust random seeds to ensure we actually get different blocks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b30aedf3bc8f18bfa7c12061ed1bce05b81ed92f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b30aedf3bc8f18bfa7c12061ed1bce05b81ed92f", "committedDate": "2020-02-27T23:23:32Z", "message": "Merge branch 'master' into v0.10.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a3a11d4fe1456aafde07186fa016bd22f491fa6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2a3a11d4fe1456aafde07186fa016bd22f491fa6", "committedDate": "2020-02-27T23:43:32Z", "message": "Use new constant name."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5f39a63ce89c63307ccbc00056f6fb1debd6433", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a5f39a63ce89c63307ccbc00056f6fb1debd6433", "committedDate": "2020-02-27T23:46:24Z", "message": "Fix one more reference."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc9a0eb8bdcd82cbf6c59714839ff449ca63d0ef", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/dc9a0eb8bdcd82cbf6c59714839ff449ca63d0ef", "committedDate": "2020-03-08T22:24:38Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into v0.10.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3a0b0d728439876790867dd33c33b06abee2a06", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/f3a0b0d728439876790867dd33c33b06abee2a06", "committedDate": "2020-03-11T13:47:16Z", "message": "Merge branch 'master' into v0.10.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8f54d20f74edc8470c936056d3efb3c14c6348e", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/b8f54d20f74edc8470c936056d3efb3c14c6348e", "committedDate": "2020-03-11T14:00:03Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5603110be382a62305456b70bc1563e02f8c535c", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/5603110be382a62305456b70bc1563e02f8c535c", "committedDate": "2020-03-11T15:05:16Z", "message": "Upgrade to fork choice spec v0.10.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9a1375d75e4e21185d53d4b7ecf1d2859707f29", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/c9a1375d75e4e21185d53d4b7ecf1d2859707f29", "committedDate": "2020-03-11T15:07:23Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e19fea34fd65a87de7d672108663001bb63d53e", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/6e19fea34fd65a87de7d672108663001bb63d53e", "committedDate": "2020-03-11T16:10:50Z", "message": "Fix block condition checking order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d862e7c870c8c6bdeb584eb0a62c252e8e09ecd", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/3d862e7c870c8c6bdeb584eb0a62c252e8e09ecd", "committedDate": "2020-03-11T16:31:17Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6d0f838baed4f2ea5863d3f804b64e10f314892", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/d6d0f838baed4f2ea5863d3f804b64e10f314892", "committedDate": "2020-03-11T17:17:19Z", "message": "compute_signing_root changes for Validator spec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a01dd352ad1bbb022cc406ed2fe7c1ea89e7edc8", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/a01dd352ad1bbb022cc406ed2fe7c1ea89e7edc8", "committedDate": "2020-03-11T17:46:09Z", "message": "Fix signer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ec1a58e1ffc28de14962b0dafabcb4a8608b054", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/0ec1a58e1ffc28de14962b0dafabcb4a8608b054", "committedDate": "2020-03-11T18:04:37Z", "message": "Run spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d", "committedDate": "2020-03-11T18:09:54Z", "message": "BroadcastAttestation event when correct block arrives"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTgzOTU3", "url": "https://github.com/ConsenSys/teku/pull/1100#pullrequestreview-373183957", "createdAt": "2020-03-11T23:03:44Z", "commit": {"oid": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMzowODoyNFrOF1MTfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMzozODo0NVrOF1M3QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMDQ0Ng==", "bodyText": "The aim of these checks is to bail out before any processing is done if we don't have the block ancestor or other prerequisites.  We don't commit the transaction so any changes made to the store are discarded if we fail either of these checks.  So we should just combine them into one again.", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391320446", "createdAt": "2020-03-11T23:08:24Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/ForkChoiceUtil.java", "diffHunk": "@@ -290,15 +285,21 @@ public static BlockImportResult on_block(\n     final BeaconState preState = store.getBlockState(block.getParent_root());\n \n     // Return early if precondition checks fail;\n-    final Optional<BlockImportResult> maybeFailure =\n-        checkOnBlockPreconditions(block, preState, store);\n-    if (maybeFailure.isPresent()) {\n-      return maybeFailure.get();\n+    final Optional<BlockImportResult> maybeFailureOnPreStorageConditions =\n+        checkOnBlockPreStorageConditions(block, preState, store);\n+    if (maybeFailureOnPreStorageConditions.isPresent()) {\n+      return maybeFailureOnPreStorageConditions.get();\n     }\n \n     // Add new block to the store\n     store.putBlock(block.hash_tree_root(), signed_block);\n \n+    final Optional<BlockImportResult> maybeFailureOnPostStorageConditions =\n+        checkOnBlockPostStorageConditions(block, store);\n+    if (maybeFailureOnPostStorageConditions.isPresent()) {\n+      return maybeFailureOnPostStorageConditions.get();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyNjQ4Mw==", "bodyText": "We expect that any justified checkpoint has a checkpoint state stored for it. Otherwise we'll throw NullPointerException when later processing attestations in get_latest_attesting_balance:\nBeaconState state = store.getCheckpointState(store.getJustifiedCheckpoint());\nThe fork choice spec actually does this store because it says to run on_attestation on every received attestation whether by gossip included in a block.  Apart from the validation checks for attestations, that ensures that the target state is in store.checkpoint_states and that store.latest_messages gets updates based on the attestation.\nSo storing these checkpoint states is part of the on_attestation processing.  The other half is updating latest messages which a ticket is open for (but unclear on how important it is to do when we're syncing such old blocks).\nTechnically, we're storing fewer checkpoint states that the spec implementation.  on_attestation would store the checkpoint state for the target of any attestation, we only store it when there are enough attestations to make it the best justified or justified state.", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391326483", "createdAt": "2020-03-11T23:28:02Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/ForkChoiceUtil.java", "diffHunk": "@@ -318,11 +319,13 @@ public static BlockImportResult on_block(\n       try {\n         if (justifiedCheckpoint.getEpoch().compareTo(store.getBestJustifiedCheckpoint().getEpoch())\n             > 0) {\n+          // TODO: Fork Choice Spec does not necessarily ask us to store this checkpoint state\n           storeCheckpointState(\n               store, st, justifiedCheckpoint, store.getBlockState(justifiedCheckpoint.getRoot()));\n           store.setBestJustifiedCheckpoint(justifiedCheckpoint);\n         }\n         if (should_update_justified_checkpoint(store, justifiedCheckpoint)) {\n+          // TODO: Fork Choice Spec does not necessarily ask us to store this checkpoint state", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyNzA4NQ==", "bodyText": "The only case where this actually fails is if we're asking process_slots to go backwards (ie get to a slot prior to the starting state slot) - since we're definitely not doing that, the exception handling is just annoying boilerplate.\nPer the spec we should be applying all of on_attestation to all attestations in the block which would trigger this same processing anyway.", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391327085", "createdAt": "2020-03-11T23:30:03Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/ForkChoiceUtil.java", "diffHunk": "@@ -335,27 +338,46 @@ public static BlockImportResult on_block(\n     // Update finalized checkpoint\n     final Checkpoint finalizedCheckpoint = state.getFinalized_checkpoint();\n     if (finalizedCheckpoint.getEpoch().compareTo(store.getFinalizedCheckpoint().getEpoch()) > 0) {\n+      // TODO: Fork Choice Spec does not necessarily ask us to store this checkpoint state, so if we\n+      // do error here and exit, we will possibly have acted differently than other nodes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyNzMzMA==", "bodyText": "We need to ensure the checkpoint state for this new justified checkpoint is stored.", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391327330", "createdAt": "2020-03-11T23:30:56Z", "author": {"login": "ajsutton"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/ForkChoiceUtil.java", "diffHunk": "@@ -335,27 +338,46 @@ public static BlockImportResult on_block(\n     // Update finalized checkpoint\n     final Checkpoint finalizedCheckpoint = state.getFinalized_checkpoint();\n     if (finalizedCheckpoint.getEpoch().compareTo(store.getFinalizedCheckpoint().getEpoch()) > 0) {\n+      // TODO: Fork Choice Spec does not necessarily ask us to store this checkpoint state, so if we\n+      // do error here and exit, we will possibly have acted differently than other nodes.\n       try {\n         storeCheckpointState(\n             store, st, finalizedCheckpoint, store.getBlockState(finalizedCheckpoint.getRoot()));\n       } catch (SlotProcessingException | EpochProcessingException e) {\n         return BlockImportResult.failedStateTransition(e);\n       }\n       store.setFinalizedCheckpoint(finalizedCheckpoint);\n+      UnsignedLong finalized_slot = store.getFinalizedCheckpoint().getEpochStartSlot();\n+      // Update justified if new justified is later than store justified\n+      // or if store justified is not in chain with finalized checkpoint\n+      if (state\n+                  .getCurrent_justified_checkpoint()\n+                  .getEpoch()\n+                  .compareTo(store.getJustifiedCheckpoint().getEpoch())\n+              > 0\n+          || !get_ancestor(store, store.getJustifiedCheckpoint().getRoot(), finalized_slot)\n+              .equals(store.getFinalizedCheckpoint().getRoot())) {\n+        store.setJustifiedCheckpoint(state.getCurrent_justified_checkpoint());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyODQ0MA==", "bodyText": "This seems wrong.  We might import two blocks for the same slot and then this would cause us to produce two conflicting attestations and get slashed. We may also do that because this event is fired both here and in process_slot - if the process_slot fired first and then this block was imported we'd potentially wind up with two different targets for the produced attestations.\nedit: I can see this is aiming to meet the first paragraph under https://github.com/ethereum/eth2.0-specs/blob/v0.10.1/specs/phase0/validator.md#attesting  which says we can publish attestations \"early\" if we already have the block for that slot.  I suspect we should have nice centralised logic for doing that coordination and not split it across multiple classes to be really sure we have it right.  Strongly suspect we should do it as a separate PR (and since it's not a consensus affecting change it can go straight to master).", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391328440", "createdAt": "2020-03-11T23:35:00Z", "author": {"login": "ajsutton"}, "path": "services/beaconchain/src/main/java/tech/pegasys/artemis/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -381,6 +382,14 @@ public void setNodeSlotAccordingToDBStore(Store store) {\n     LOG.info(\"Node being started from database.\");\n   }\n \n+  @Subscribe\n+  public void onImportedBlock(ImportedBlockEvent event) {\n+    if (event.getBlock().getSlot().equals(nodeSlot)) {\n+      Bytes32 headBlockRoot = this.stateProcessor.processHead();\n+      this.eventBus.post(new BroadcastAttestationEvent(headBlockRoot, nodeSlot));\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyOTAwNg==", "bodyText": "I guess that resolves my concerns about getting slashed above, but this still feels very weird to me.", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391329006", "createdAt": "2020-03-11T23:36:34Z", "author": {"login": "ajsutton"}, "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/ValidatorCoordinator.java", "diffHunk": "@@ -182,10 +185,15 @@ public void onBlockImported(ImportedBlockEvent event) {\n   @Subscribe\n   public void onAttestationEvent(BroadcastAttestationEvent event) throws IllegalArgumentException {\n     try {\n+\n+      UnsignedLong slot = event.getNodeSlot();\n+      if (slot.compareTo(latestBroadcastAttestationEventSlot) <= 0) {\n+        return;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyOTYwMA==", "bodyText": "I suspect we should do this in the opposite order.  Otherwise we risk publishing attestations and then failing unexpectedly before we update the latestBroadcastAttestationEventSlot which opens us to being slashed.\nAs mentioned above (sorry for scattering this across multiple comments) - let's pull this out of this PR and do it separately.", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r391329600", "createdAt": "2020-03-11T23:38:45Z", "author": {"login": "ajsutton"}, "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/ValidatorCoordinator.java", "diffHunk": "@@ -212,6 +220,7 @@ public void onAttestationEvent(BroadcastAttestationEvent event) throws IllegalAr\n       asyncProduceAttestations(\n           attesterInformations, headState, getGenericAttestationData(headState, headBlock));\n \n+      latestBroadcastAttestationEventSlot = slot;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cab85c6fcceec6ed67bb4f6abe41e9c9ee843d"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6ed6fa1329d5630c074adbde0f33fb09e2b17c0", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/d6ed6fa1329d5630c074adbde0f33fb09e2b17c0", "committedDate": "2020-03-12T15:50:58Z", "message": "Resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e71cad79e8a256fddc8e89aa748689857f600426", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/e71cad79e8a256fddc8e89aa748689857f600426", "committedDate": "2020-03-12T15:54:44Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into benjaminion-v0.10.0\n\n# Conflicts:\n#\tartemis/src/main/java/tech/pegasys/artemis/DepositCommand.java\n#\tdata/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconChainHeadHandler.java\n#\tdata/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconChainHeadHandlerTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d911bffc8642702b219bbaaa0c68b690d63f2d62", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/d911bffc8642702b219bbaaa0c68b690d63f2d62", "committedDate": "2020-03-12T16:00:10Z", "message": "Fix issues relating to merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeda537fb7d4d6930f06915334c9f95791fd3cc2", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/aeda537fb7d4d6930f06915334c9f95791fd3cc2", "committedDate": "2020-03-12T19:10:07Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76c570c5bb3f60c54bc77b59bb55090414339319", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/76c570c5bb3f60c54bc77b59bb55090414339319", "committedDate": "2020-03-12T19:48:06Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into benjaminion-v0.10.0\n\n# Conflicts:\n#\tservices/beaconchain/src/main/java/tech/pegasys/artemis/services/beaconchain/BeaconChainController.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e37badd800d700a4cdff0b77fa96590c6f4327c", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/4e37badd800d700a4cdff0b77fa96590c6f4327c", "committedDate": "2020-03-12T19:57:35Z", "message": "Fix merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89cd93a5236f75d05d960c18bd6ffd5ea589fbe4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/89cd93a5236f75d05d960c18bd6ffd5ea589fbe4", "committedDate": "2020-03-12T23:05:10Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into v0.10.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2ae27891476addc7067cdaa8f8571d22e4f5a13", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/f2ae27891476addc7067cdaa8f8571d22e4f5a13", "committedDate": "2020-03-13T13:42:51Z", "message": "Revert block check changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62fe7770d2ebc384a63965a582062aae7f6cf06e", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/62fe7770d2ebc384a63965a582062aae7f6cf06e", "committedDate": "2020-03-13T13:47:04Z", "message": "Revert changes on broadcasting attestations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "569d4c1e0e6381eb9d9294c954fd375b120c0c00", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/569d4c1e0e6381eb9d9294c954fd375b120c0c00", "committedDate": "2020-03-13T13:47:47Z", "message": "Merge branch 'master' into v0.10.0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Njg1NzYx", "url": "https://github.com/ConsenSys/teku/pull/1100#pullrequestreview-374685761", "createdAt": "2020-03-14T01:20:26Z", "commit": {"oid": "569d4c1e0e6381eb9d9294c954fd375b120c0c00"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMToyMDoyNlrOF2W-Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMToyMDoyNlrOF2W-Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0Mzc3MQ==", "bodyText": "We should probably remove that comment now. :)", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r392543771", "createdAt": "2020-03-14T01:20:26Z", "author": {"login": "ajsutton"}, "path": "build.gradle", "diffHunk": "@@ -209,7 +209,7 @@ allprojects {\n   }\n }\n \n-def refTestVersion = 'v0.9.4'\n+def refTestVersion = 'v0.10.1' // TODO: Remove this comment (just kicking the CircleCI cache)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569d4c1e0e6381eb9d9294c954fd375b120c0c00"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55041fd2cfaa0f4d56e62af41f1190e43535ae7f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/55041fd2cfaa0f4d56e62af41f1190e43535ae7f", "committedDate": "2020-03-16T03:59:16Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into v0.10.0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTgyMDYx", "url": "https://github.com/ConsenSys/teku/pull/1100#pullrequestreview-375182061", "createdAt": "2020-03-16T12:48:46Z", "commit": {"oid": "55041fd2cfaa0f4d56e62af41f1190e43535ae7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjo0ODo0N1rOF2yxTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMjo0ODo0N1rOF2yxTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk5OTI0NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            def refTestVersion = 'v0.10.1' // TODO: Remove this comment (just kicking the CircleCI cache)\n          \n          \n            \n            def refTestVersion = 'v0.10.1'", "url": "https://github.com/ConsenSys/teku/pull/1100#discussion_r392999244", "createdAt": "2020-03-16T12:48:47Z", "author": {"login": "cemozerr"}, "path": "build.gradle", "diffHunk": "@@ -209,7 +209,7 @@ allprojects {\n   }\n }\n \n-def refTestVersion = 'v0.9.4'\n+def refTestVersion = 'v0.10.1' // TODO: Remove this comment (just kicking the CircleCI cache)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55041fd2cfaa0f4d56e62af41f1190e43535ae7f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b83ee290748ef43069ce234dad9f2d0ae9aaffcb", "author": {"user": {"login": "cemozerr", "name": "Cem Ozer"}}, "url": "https://github.com/ConsenSys/teku/commit/b83ee290748ef43069ce234dad9f2d0ae9aaffcb", "committedDate": "2020-03-16T12:49:11Z", "message": "Remove unnecessary comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4212, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}