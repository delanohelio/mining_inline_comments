{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MjAzMjQ1", "number": 2314, "title": "Report unknown block instead of throwing NullPointerException", "bodyText": "PR Description\nIt's possible that the block targeted by an attestation is dropped from the store while we're processing the attestation. We could wind up passing the initial check that the block is known because it hasn't been pruned from protoarray when we do that check and then later fail to create the checkpoint state for that target because the block isn't available in the store resulting in a NullPointerException.\nIf the checkpoint state is unavailable, the target block must be unknown so defer the attestation. Worst case the block is invalid and the attestation gets dropped once it is too old.\nTo reduce the risk of this in future, getCheckpointState now returns an Optional.\nFixed Issue(s)\nfixes #2313\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-07-03T22:06:52Z", "url": "https://github.com/ConsenSys/teku/pull/2314", "merged": true, "mergeCommit": {"oid": "a26c45ac76f82b3e54da6b2133a9fe0c47e17259"}, "closed": true, "closedAt": "2020-07-06T21:49:42Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxarbIAH2gAyNDQ0MjAzMjQ1Ojk2NjAyY2YyM2RmNmIxY2IxOGQ1MWZiZmVlZTM5ZmQyYmZlZTI4MGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyYIcBAH2gAyNDQ0MjAzMjQ1Ojk5NmE1OTNlOWRiMzRjM2ZmODY1ZjIyNGVmMzRkN2ZjYzUxNTM0MWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "96602cf23df6b1cb18d51fbfeee39fd2bfee280a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/96602cf23df6b1cb18d51fbfeee39fd2bfee280a", "committedDate": "2020-07-03T21:53:20Z", "message": "Report unknown block instead of throwing NullPointerException."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9946f34a89ddcb4f39b99bbdc494c28744879867", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/9946f34a89ddcb4f39b99bbdc494c28744879867", "committedDate": "2020-07-03T22:04:07Z", "message": "Return Optional<BeaconState> from getCheckpointState."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9a00a9adbc2d61b7b6c778bd839e34bb25272f5", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d9a00a9adbc2d61b7b6c778bd839e34bb25272f5", "committedDate": "2020-07-03T22:26:12Z", "message": "Use Optional properly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f59a4b259e44a1b2295e04bdef42cb2a6676af6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6f59a4b259e44a1b2295e04bdef42cb2a6676af6", "committedDate": "2020-07-03T22:30:30Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into handle-unknown-block"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMDY3NDE2", "url": "https://github.com/ConsenSys/teku/pull/2314#pullrequestreview-443067416", "createdAt": "2020-07-06T13:20:00Z", "commit": {"oid": "6f59a4b259e44a1b2295e04bdef42cb2a6676af6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzoyMDowMFrOGtW6wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzoyMDowMFrOGtW6wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIxNDU5NA==", "bodyText": "nit: We might as well remove this stale \"get state at the target\" comment, or move it up to where it's appropriate.", "url": "https://github.com/ConsenSys/teku/pull/2314#discussion_r450214594", "createdAt": "2020-07-06T13:20:00Z", "author": {"login": "cemozerr"}, "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/ForkChoiceUtil.java", "diffHunk": "@@ -370,26 +370,30 @@ public static AttestationProcessingResult on_attestation(\n    */\n   private static AttestationProcessingResult indexAndValidateAttestation(\n       MutableStore store, ValidateableAttestation attestation, Checkpoint target) {\n-    BeaconState target_state;\n+    BeaconState targetState;\n     try {\n-      target_state = store.getCheckpointState(target);\n+      Optional<BeaconState> maybeTargetState = store.getCheckpointState(target);\n+      if (maybeTargetState.isEmpty()) {\n+        return AttestationProcessingResult.UNKNOWN_BLOCK;\n+      }\n+      targetState = maybeTargetState.get();\n     } catch (final InvalidCheckpointException e) {\n       LOG.debug(\"on_attestation: Attestation target checkpoint is invalid\", e);\n       return AttestationProcessingResult.invalid(\"Invalid target checkpoint: \" + e.getMessage());\n     }\n \n     // Get state at the `target` to validate attestation and calculate the committees", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f59a4b259e44a1b2295e04bdef42cb2a6676af6"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMDY4Mzgx", "url": "https://github.com/ConsenSys/teku/pull/2314#pullrequestreview-443068381", "createdAt": "2020-07-06T13:21:11Z", "commit": {"oid": "6f59a4b259e44a1b2295e04bdef42cb2a6676af6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caba8d1ce31cade699c9c32e37fe03c07e6dc12b", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/caba8d1ce31cade699c9c32e37fe03c07e6dc12b", "committedDate": "2020-07-06T21:24:37Z", "message": "Remove comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52ee3ce8dd5105405fba2c8d6271a74c1f318ce4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/52ee3ce8dd5105405fba2c8d6271a74c1f318ce4", "committedDate": "2020-07-06T21:24:43Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into handle-unknown-block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "996a593e9db34c3ff865f224ef34d7fcc515341f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/996a593e9db34c3ff865f224ef34d7fcc515341f", "committedDate": "2020-07-06T21:29:14Z", "message": "Spotless."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3801, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}