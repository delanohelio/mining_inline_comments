{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1ODE2Mjkx", "number": 1332, "title": "[BC-291] Complete rpc stream future on peer disconnect", "bodyText": "PR Description\nThis PR adds some error-handling around stream creation.  We will now complete rpc stream futures exceptionally if:\n\nThe remote peer disconnects\nWe fail to establish a stream before timing out", "createdAt": "2020-03-09T21:00:22Z", "url": "https://github.com/ConsenSys/teku/pull/1332", "merged": true, "mergeCommit": {"oid": "ef46825e92063f7f0f4c354e72ad3380ad275042"}, "closed": true, "closedAt": "2020-03-10T15:47:27Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMECpUgH2gAyMzg1ODE2MjkxOmM5MzQyNDZiNTY5NjI5NmMxZmFlZjMyYWE4Njg4MjAzNzU5YmJlMmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMUZRsgFqTM3MjA3Mjc1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c934246b5696296c1faef32aa8688203759bbe2c", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c934246b5696296c1faef32aa8688203759bbe2c", "committedDate": "2020-03-09T20:35:41Z", "message": "Add timeout and disconnenct handling to RpcHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6692c1a671c5dc87966346e1132fa4b63a05183", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d6692c1a671c5dc87966346e1132fa4b63a05183", "committedDate": "2020-03-09T20:39:39Z", "message": "Add integration tests that query a disconnected peer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6baef004f07835e4adc94425b51aa08d8e2f147", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a6baef004f07835e4adc94425b51aa08d8e2f147", "committedDate": "2020-03-09T20:48:57Z", "message": "Cleanup - cut unused code, name exceptions consistently"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b21b7361e1cf68672b718fee2658090ebb35f25", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/4b21b7361e1cf68672b718fee2658090ebb35f25", "committedDate": "2020-03-09T20:55:46Z", "message": "Cut untested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9c7a52a944a8c8c53be8c76da9d9bcf6d0904bf", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f9c7a52a944a8c8c53be8c76da9d9bcf6d0904bf", "committedDate": "2020-03-09T21:22:58Z", "message": "Merge branch 'master' into bc-291/complete-stream-on-peer-disconnect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fde1a2e6a455c9da96ef68f564fbb0ed59cdb57c", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/fde1a2e6a455c9da96ef68f564fbb0ed59cdb57c", "committedDate": "2020-03-09T21:45:13Z", "message": "Merge branch 'master' into bc-291/complete-stream-on-peer-disconnect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c0e1981bb68674dac510afe48ff775da79d942a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/2c0e1981bb68674dac510afe48ff775da79d942a", "committedDate": "2020-03-09T21:45:45Z", "message": "Merge branch 'master' into bc-291/complete-stream-on-peer-disconnect"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjAxNjM5", "url": "https://github.com/ConsenSys/teku/pull/1332#pullrequestreview-371601639", "createdAt": "2020-03-09T23:55:07Z", "commit": {"oid": "2c0e1981bb68674dac510afe48ff775da79d942a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMzo1NTowOFrOFz9KPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMzo1NTowOFrOFz9KPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyMzc0MQ==", "bodyText": "Where are you completing succesfully?", "url": "https://github.com/ConsenSys/teku/pull/1332#discussion_r390023741", "createdAt": "2020-03-09T23:55:08Z", "author": {"login": "cemozerr"}, "path": "networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/rpc/RpcHandler.java", "diffHunk": "@@ -22,45 +22,92 @@\n import io.netty.buffer.ByteBuf;\n import io.netty.channel.ChannelHandlerContext;\n import io.netty.channel.SimpleChannelInboundHandler;\n+import java.time.Duration;\n import java.util.ArrayList;\n import java.util.List;\n+import java.util.concurrent.TimeUnit;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n import org.apache.tuweni.bytes.Bytes;\n import org.jetbrains.annotations.NotNull;\n import tech.pegasys.artemis.networking.p2p.libp2p.LibP2PNodeId;\n import tech.pegasys.artemis.networking.p2p.libp2p.rpc.RpcHandler.Controller;\n import tech.pegasys.artemis.networking.p2p.peer.NodeId;\n+import tech.pegasys.artemis.networking.p2p.peer.PeerDisconnectedException;\n import tech.pegasys.artemis.networking.p2p.rpc.RpcMethod;\n import tech.pegasys.artemis.networking.p2p.rpc.RpcRequestHandler;\n import tech.pegasys.artemis.networking.p2p.rpc.RpcStream;\n+import tech.pegasys.artemis.networking.p2p.rpc.StreamClosedException;\n+import tech.pegasys.artemis.networking.p2p.rpc.StreamTimeoutException;\n+import tech.pegasys.artemis.util.async.AsyncRunner;\n import tech.pegasys.artemis.util.async.SafeFuture;\n \n public class RpcHandler implements ProtocolBinding<Controller> {\n+  private static final Duration TIMEOUT = Duration.ofSeconds(5);\n   private static final Logger LOG = LogManager.getLogger();\n \n   private final RpcMethod rpcMethod;\n+  private final AsyncRunner asyncRunner;\n \n-  public RpcHandler(RpcMethod rpcMethod) {\n+  public RpcHandler(final AsyncRunner asyncRunner, RpcMethod rpcMethod) {\n+    this.asyncRunner = asyncRunner;\n     this.rpcMethod = rpcMethod;\n   }\n \n   @SuppressWarnings(\"unchecked\")\n   public SafeFuture<RpcStream> sendRequest(\n       Connection connection, Bytes initialPayload, RpcRequestHandler handler) {\n-    return SafeFuture.of(\n-            connection\n-                .muxerSession()\n-                .createStream(\n-                    Multistream.create(this.toInitiator(rpcMethod.getId())).toStreamHandler())\n-                .getController())\n-        .thenCompose(\n+    if (connection.closeFuture().isDone()) {\n+      return SafeFuture.failedFuture(new PeerDisconnectedException());\n+    }\n+\n+    SafeFuture<RpcStream> streamFuture = new SafeFuture<>();\n+\n+    // Complete future if peer disconnects\n+    SafeFuture.of(connection.closeFuture())\n+        .always(() -> streamFuture.completeExceptionally(new PeerDisconnectedException()));\n+    // Complete future if we fail to initialize\n+    asyncRunner\n+        .getDelayedFuture(TIMEOUT.toMillis(), TimeUnit.MILLISECONDS)\n+        .thenAccept(\n+            __ ->\n+                streamFuture.completeExceptionally(\n+                    new StreamTimeoutException(\"Timed out waiting to initialize stream\")))\n+        .reportExceptions();\n+\n+    // Try to initiate stream\n+    connection\n+        .muxerSession()\n+        .createStream(Multistream.create(this.toInitiator(rpcMethod.getId())).toStreamHandler())\n+        .getController()\n+        .thenAccept(\n             ctr -> {\n               ctr.setRequestHandler(handler);\n-              return ctr.getRpcStream()\n+              ctr.getRpcStream()\n                   .writeBytes(initialPayload)\n-                  .thenApply(f -> ctr.getRpcStream());\n+                  .thenApply(f -> ctr.getRpcStream())\n+                  .thenAccept(\n+                      rpcStream -> {\n+                        if (!streamFuture.complete(rpcStream)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c0e1981bb68674dac510afe48ff775da79d942a"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afeb495e8660c613cccadd0fbc3789f349a59693", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/afeb495e8660c613cccadd0fbc3789f349a59693", "committedDate": "2020-03-10T15:18:09Z", "message": "Merge branch 'master' into bc-291/complete-stream-on-peer-disconnect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "147c2bc02940ba8ef1cd865b72fae4eb3020a963", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/147c2bc02940ba8ef1cd865b72fae4eb3020a963", "committedDate": "2020-03-10T15:31:05Z", "message": "Consolidate exception handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMDcyNzU4", "url": "https://github.com/ConsenSys/teku/pull/1332#pullrequestreview-372072758", "createdAt": "2020-03-10T15:38:53Z", "commit": {"oid": "147c2bc02940ba8ef1cd865b72fae4eb3020a963"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3945, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}