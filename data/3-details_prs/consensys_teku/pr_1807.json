{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NzEwNDgy", "number": 1807, "title": "[BC-415] Rework getBlockInEffectAtSlot", "bodyText": "PR Description\nRework CombinedChainDataClient methods that rely on querying a block at a particular slot.  To prevent race conditions, avoid constraining these queries by a particular head block root where possible.\nAlso:\n\nRework InMemoryStorageSystem to run on StorageBackedRecentChainData, allowing us to more easily simulate restarts from tests\nRework some REST API tests to use AbstractDataBackedRestAPIIntegrationTest and deprecate  AbstractBeaconRestAPIIntegrationTest which relies on mocking the data to be queried", "createdAt": "2020-05-18T19:56:25Z", "url": "https://github.com/ConsenSys/teku/pull/1807", "merged": true, "mergeCommit": {"oid": "0dc3429662f2c8d4aba1798d075154d748a3059b"}, "closed": true, "closedAt": "2020-05-20T16:10:28Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciiDTKgH2gAyNDE5NzEwNDgyOjVlMDUzZDViOTNlOTU2YmEyMTZhMWEzOTJhMDI0ZjAyMGViMTFlMGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjLIgsgH2gAyNDE5NzEwNDgyOmM1NTQ5MWRjOWNkMmM3MDZhMThjMzYxN2ExMGZiMjM4YjE2NzNmZTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5e053d5b93e956ba216a1a392a024f020eb11e0f", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/5e053d5b93e956ba216a1a392a024f020eb11e0f", "committedDate": "2020-05-18T15:59:53Z", "message": "Add ability to contrain blockRootBySlot query by head root"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3c0a1a6512a32f66d286907b4672e3686993f7a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a3c0a1a6512a32f66d286907b4672e3686993f7a", "committedDate": "2020-05-18T15:59:53Z", "message": "Rework CombinedChainDataClient query block by slot methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f6103e79640003c176f0061d3b63f6c42e20f43", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/0f6103e79640003c176f0061d3b63f6c42e20f43", "committedDate": "2020-05-18T19:38:35Z", "message": "Add ability to \"restart\" InMemoryStorageSystem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a109b95760397e65e5de4954982386fa233084d9", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a109b95760397e65e5de4954982386fa233084d9", "committedDate": "2020-05-18T19:38:46Z", "message": "Add / fix / migrate tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9a9b7f3131d373d9ee2a4e1561cf88cb9c0487a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/b9a9b7f3131d373d9ee2a4e1561cf88cb9c0487a", "committedDate": "2020-05-19T15:18:50Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9bf9315168493ba309c6543eaf46a9214b1a8c3", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c9bf9315168493ba309c6543eaf46a9214b1a8c3", "committedDate": "2020-05-19T17:16:52Z", "message": "Fix getBlockBySlot query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e3510d2ab79b161eb8cf000c37cb2086c3174cb", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/3e3510d2ab79b161eb8cf000c37cb2086c3174cb", "committedDate": "2020-05-19T17:39:22Z", "message": "Fix / rework REST API integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd95f83f980446198cc3be0e7b35aa4cbb771834", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/cd95f83f980446198cc3be0e7b35aa4cbb771834", "committedDate": "2020-05-19T17:41:00Z", "message": "Merge branch 'master' into bc-415/rework-get-block-in-effect-at-slot"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ec95ebcfd1fe622e5dee77fe4a2aabf013fda86", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/4ec95ebcfd1fe622e5dee77fe4a2aabf013fda86", "committedDate": "2020-05-18T20:15:13Z", "message": "Merge branch 'master' into bc-415/rework-get-block-in-effect-at-slot"}, "afterCommit": {"oid": "cd95f83f980446198cc3be0e7b35aa4cbb771834", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/cd95f83f980446198cc3be0e7b35aa4cbb771834", "committedDate": "2020-05-19T17:41:00Z", "message": "Merge branch 'master' into bc-415/rework-get-block-in-effect-at-slot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff7e64f118df27dd7517917d4f35bd021bf20cd0", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/ff7e64f118df27dd7517917d4f35bd021bf20cd0", "committedDate": "2020-05-19T18:03:39Z", "message": "Clean up comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTQ0MTM0", "url": "https://github.com/ConsenSys/teku/pull/1807#pullrequestreview-414944134", "createdAt": "2020-05-20T02:08:26Z", "commit": {"oid": "ff7e64f118df27dd7517917d4f35bd021bf20cd0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMjowODoyNlrOGX40sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMjowODoyNlrOGX40sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcwMTQyNA==", "bodyText": "nit: Probably don't need the empty comment.", "url": "https://github.com/ConsenSys/teku/pull/1807#discussion_r427701424", "createdAt": "2020-05-20T02:08:26Z", "author": {"login": "ajsutton"}, "path": "storage/src/test/java/tech/pegasys/teku/storage/client/RecentChainDataTest.java", "diffHunk": "@@ -631,6 +631,55 @@ public void getBlockRootBySlot_queryEntireChain() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void getBlockRootBySlotWithHeadRoot_forSlotAfterHeadRoot() throws Exception {\n+    final SignedBlockAndState targetBlock = advanceBestBlock(storageClient);\n+    final SignedBlockAndState bestBlock = advanceBestBlock(storageClient);\n+\n+    assertThat(storageClient.getBlockRootBySlot(bestBlock.getSlot(), targetBlock.getRoot()))\n+        .contains(targetBlock.getRoot());\n+  }\n+\n+  @Test\n+  public void getBlockRootBySlotWithHeadRoot_forUnknownHeadRoot() throws Exception {\n+    final Bytes32 headRoot = dataStructureUtil.randomBytes32();\n+    final SignedBlockAndState bestBlock = advanceBestBlock(storageClient);\n+\n+    assertThat(storageClient.getBlockRootBySlot(bestBlock.getSlot(), headRoot)).isEmpty();\n+  }\n+\n+  @Test\n+  public void getBlockRootBySlotWithHeadRoot_withForkRoot() throws Exception {\n+    // Build small chain\n+    for (int i = 0; i < 5; i++) {\n+      advanceChain(storageClient);\n+    }\n+\n+    // Split the chain\n+    final ChainBuilder fork = chainBuilder.fork();\n+    final UnsignedLong chainSplitSlot = chainBuilder.getLatestSlot();\n+    for (int i = 0; i < 5; i++) {\n+      final UnsignedLong canonicalBlockSlot = chainSplitSlot.plus(UnsignedLong.valueOf(i * 2 + 2));\n+      final UnsignedLong forkSlot = chainSplitSlot.plus(UnsignedLong.valueOf(i * 2 + 1));\n+      updateBestBlock(storageClient, chainBuilder.generateBlockAtSlot(canonicalBlockSlot));\n+      saveBlock(storageClient, fork.generateBlockAtSlot(forkSlot));\n+    }\n+\n+    final Bytes32 headRoot = fork.getLatestBlockAndState().getRoot();\n+    for (int i = 0; i < fork.getLatestSlot().intValue(); i++) {\n+      //", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff7e64f118df27dd7517917d4f35bd021bf20cd0"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "473fa918d44ed0d128f28d1eea36c8758765ee30", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/473fa918d44ed0d128f28d1eea36c8758765ee30", "committedDate": "2020-05-20T15:50:28Z", "message": "Merge branch 'master' into bc-415/rework-get-block-in-effect-at-slot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c55491dc9cd2c706a18c3617a10fb238b1673fe9", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c55491dc9cd2c706a18c3617a10fb238b1673fe9", "committedDate": "2020-05-20T15:51:41Z", "message": "Cut empty comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3984, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}