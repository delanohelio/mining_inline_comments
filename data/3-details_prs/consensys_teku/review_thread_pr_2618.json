{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5ODk3MTQ2", "number": 2618, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzozMjo0NVrOEZwF-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDowMTo1M1rOEZwurw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDM3ODE4OnYy", "diffSide": "RIGHT", "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzozMjo0NVrOHCv3BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzozMjo0NVrOHCv3BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0MzMzMw==", "bodyText": "10,000 slots seems like it's too many.  I wonder if we should just make this the same as optimistic history length. We only make one extra request if we trigger this logic so it's very cheap compared to downloading all the blocks since finalisation.", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472643333", "createdAt": "2020-08-19T03:32:45Z", "author": {"login": "ajsutton"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDM5ODM1OnYy", "diffSide": "RIGHT", "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzozODo0N1rOHCwEXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzozODo0N1rOHCwEXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0Njc0OA==", "bodyText": "I think we want localHead.min(status.getHeadSlot()) because in rare cases it's possible that the peer has a lower head slot but a higher finalised epoch which would cause us to sync to it.  This would be the case if 2/3rds of the Medalla validators all attested that there had been no blocks since finalisation stopped - head block would be back in epoch 2289 but the finalised epoch would be 3287.", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472646748", "createdAt": "2020-08-19T03:38:47Z", "author": {"login": "ajsutton"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;\n+  private static final int OPTIMISTIC_HISTORY_LENGTH = 3000;\n+  private final RecentChainData storageClient;\n+\n+  public CommonAncestor(final RecentChainData storageClient) {\n+    this.storageClient = storageClient;\n+  }\n+\n+  public SafeFuture<UInt64> getCommonAncestor(\n+      final Eth2Peer peer, final PeerStatus status, final UInt64 firstNonFinalSlot) {\n+    final UInt64 localHead = storageClient.getHeadSlot();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDQwNDI5OnYy", "diffSide": "RIGHT", "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzo0MDoyN1rOHCwIYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDowMjo1MlrOHCw-TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0Nzc3Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n          \n          \n            \n                    && firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS).isLessThan(status.getHeadSlot())) {\n          \n          \n            \n                if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n          \n          \n            \n                    && status.getHeadSlot().isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))) {\n          \n      \n    \n    \n  \n\nfor consistency", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472647776", "createdAt": "2020-08-19T03:40:27Z", "author": {"login": "ajsutton"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;\n+  private static final int OPTIMISTIC_HISTORY_LENGTH = 3000;\n+  private final RecentChainData storageClient;\n+\n+  public CommonAncestor(final RecentChainData storageClient) {\n+    this.storageClient = storageClient;\n+  }\n+\n+  public SafeFuture<UInt64> getCommonAncestor(\n+      final Eth2Peer peer, final PeerStatus status, final UInt64 firstNonFinalSlot) {\n+    final UInt64 localHead = storageClient.getHeadSlot();\n+    // more than 10000 blocks behind, try to find a better starting slot if we have non finalized\n+    // data\n+    if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n+        && firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS).isLessThan(status.getHeadSlot())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2MTU4MQ==", "bodyText": "And probably invert the if condition so that we return early instead of having the whole method inside the if.", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472661581", "createdAt": "2020-08-19T04:02:52Z", "author": {"login": "ajsutton"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;\n+  private static final int OPTIMISTIC_HISTORY_LENGTH = 3000;\n+  private final RecentChainData storageClient;\n+\n+  public CommonAncestor(final RecentChainData storageClient) {\n+    this.storageClient = storageClient;\n+  }\n+\n+  public SafeFuture<UInt64> getCommonAncestor(\n+      final Eth2Peer peer, final PeerStatus status, final UInt64 firstNonFinalSlot) {\n+    final UInt64 localHead = storageClient.getHeadSlot();\n+    // more than 10000 blocks behind, try to find a better starting slot if we have non finalized\n+    // data\n+    if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n+        && firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS).isLessThan(status.getHeadSlot())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0Nzc3Ng=="}, "originalCommit": {"oid": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDQ3MjUyOnYy", "diffSide": "RIGHT", "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzo1OTowOVrOHCw1Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzo1OTowOVrOHCw1Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1OTIxOA==", "bodyText": "Probably make these constants and show the calculation - ie that it's important they total just 1000 slots, and with a comment about Prysm's limitations.", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472659218", "createdAt": "2020-08-19T03:59:09Z", "author": {"login": "ajsutton"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;\n+  private static final int OPTIMISTIC_HISTORY_LENGTH = 3000;\n+  private final RecentChainData storageClient;\n+\n+  public CommonAncestor(final RecentChainData storageClient) {\n+    this.storageClient = storageClient;\n+  }\n+\n+  public SafeFuture<UInt64> getCommonAncestor(\n+      final Eth2Peer peer, final PeerStatus status, final UInt64 firstNonFinalSlot) {\n+    final UInt64 localHead = storageClient.getHeadSlot();\n+    // more than 10000 blocks behind, try to find a better starting slot if we have non finalized\n+    // data\n+    if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n+        && firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS).isLessThan(status.getHeadSlot())) {\n+      final UInt64 localNonFinalisedSlotCount = localHead.minus(firstNonFinalSlot);\n+      final UInt64 count = UInt64.valueOf(20);\n+      final UInt64 freq = UInt64.valueOf(50);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDQ4MjM5OnYy", "diffSide": "RIGHT", "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDowMTo1M1rOHCw77w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDowMTo1M1rOHCw77w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2MDk3NQ==", "bodyText": "nit: Make MINIMUM_VIABLE_SLOTS a UInt in the constant to make this more readable.", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472660975", "createdAt": "2020-08-19T04:01:53Z", "author": {"login": "ajsutton"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;\n+  private static final int OPTIMISTIC_HISTORY_LENGTH = 3000;\n+  private final RecentChainData storageClient;\n+\n+  public CommonAncestor(final RecentChainData storageClient) {\n+    this.storageClient = storageClient;\n+  }\n+\n+  public SafeFuture<UInt64> getCommonAncestor(\n+      final Eth2Peer peer, final PeerStatus status, final UInt64 firstNonFinalSlot) {\n+    final UInt64 localHead = storageClient.getHeadSlot();\n+    // more than 10000 blocks behind, try to find a better starting slot if we have non finalized\n+    // data\n+    if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n+        && firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS).isLessThan(status.getHeadSlot())) {\n+      final UInt64 localNonFinalisedSlotCount = localHead.minus(firstNonFinalSlot);\n+      final UInt64 count = UInt64.valueOf(20);\n+      final UInt64 freq = UInt64.valueOf(50);\n+      final UInt64 firstRequestedSlot =\n+          localNonFinalisedSlotCount.isGreaterThanOrEqualTo(UInt64.valueOf(MINIMUM_VIABLE_SLOTS))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3320, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}