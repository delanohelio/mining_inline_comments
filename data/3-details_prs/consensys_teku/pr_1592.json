{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNTIyOTg0", "number": 1592, "title": "Delay performing duties until the epoch has been scheduled", "bodyText": "PR Description\nDelay performing duties for slots until the duties for that epoch have completed loading.\nAlso fix a bug in calculating duties so that we don't have a validator attempt to produce block 0.", "createdAt": "2020-04-15T03:40:26Z", "url": "https://github.com/ConsenSys/teku/pull/1592", "merged": true, "mergeCommit": {"oid": "6c8017e59bc86054ed81af7a1d3f0ef07bc6b222"}, "closed": true, "closedAt": "2020-04-15T20:07:07Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXuOUmgH2gAyNDAzNTIyOTg0OmQyYTEyYzY3NzlmMTc3MjkzZmNmZjNhMjAzODI0N2E3MmU5NmE5NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcX9pbaAH2gAyNDAzNTIyOTg0OmI1MjMwZGYxYmVhOWYzMTgzMzE1ODVlNWVhOTJiYzU2ZGM0YTVkOGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d2a12c6779f177293fcff3a2038247a72e96a946", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d2a12c6779f177293fcff3a2038247a72e96a946", "committedDate": "2020-04-15T01:57:37Z", "message": "Delay performing duties until the epoch has been scheduled."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4623f808ddfee4f82f8e43df29d9b476e2f9bed", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e4623f808ddfee4f82f8e43df29d9b476e2f9bed", "committedDate": "2020-04-15T03:29:34Z", "message": "Ensure duties are still performed in the correct order.\nDon't schedule block production for the genesis slot."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "887d38099bb5e40d9c5172a70a7dcafdab2991d1", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/887d38099bb5e40d9c5172a70a7dcafdab2991d1", "committedDate": "2020-04-15T03:55:09Z", "message": "Add comments and ensure the pending tasks are only removed once they have all completed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4ee3cb8c37a7c5a18065cf6e89c1c8a4b887b6a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b4ee3cb8c37a7c5a18065cf6e89c1c8a4b887b6a", "committedDate": "2020-04-15T03:58:09Z", "message": "More comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84d2137460e33f834c5f1c7da5daf00ca00c55be", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/84d2137460e33f834c5f1c7da5daf00ca00c55be", "committedDate": "2020-04-15T03:58:39Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into delay-duties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzODU2OTEw", "url": "https://github.com/ConsenSys/teku/pull/1592#pullrequestreview-393856910", "createdAt": "2020-04-15T14:56:06Z", "commit": {"oid": "84d2137460e33f834c5f1c7da5daf00ca00c55be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDo1NjowNlrOGF9wZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDo1NjowNlrOGF9wZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkwNzg3OA==", "bodyText": "This line assumes that this validator won't have any duties for this epoch, so it will need to remove the future above, right?", "url": "https://github.com/ConsenSys/teku/pull/1592#discussion_r408907878", "createdAt": "2020-04-15T14:56:06Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/DutyScheduler.java", "diffHunk": "@@ -69,13 +86,19 @@ public void onSlot(final UnsignedLong slotNumber) {\n           for (UnsignedLong currentEpoch = startEpoch;\n               currentEpoch.compareTo(endEpoch) <= 0;\n               currentEpoch = currentEpoch.plus(ONE)) {\n-            scheduleDutiesForEpoch(currentEpoch).reportExceptions();\n+            scheduleDutiesForEpoch(currentEpoch);\n           }\n           return startEpoch.compareTo(endEpoch) > 0 ? lastRequestedEpoch : endEpoch;\n         });\n   }\n \n-  private SafeFuture<Void> scheduleDutiesForEpoch(final UnsignedLong epoch) {\n+  private void scheduleDutiesForEpoch(final UnsignedLong epoch) {\n+    final SafeFuture<Void> future = requestAndScheduleDutiesForEpoch(epoch);\n+    pendingTasksByEpoch.put(epoch, future);\n+    removeWhenAllTasksComplete(epoch, future);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84d2137460e33f834c5f1c7da5daf00ca00c55be"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzODU4Mjkz", "url": "https://github.com/ConsenSys/teku/pull/1592#pullrequestreview-393858293", "createdAt": "2020-04-15T14:57:30Z", "commit": {"oid": "84d2137460e33f834c5f1c7da5daf00ca00c55be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDo1NzozMFrOGF90rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDo1NzozMFrOGF90rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkwODk3NA==", "bodyText": "Isn't there any side effect of chaining multiple .always() to the same Future chain? So they don't get overwritten or anything?", "url": "https://github.com/ConsenSys/teku/pull/1592#discussion_r408908974", "createdAt": "2020-04-15T14:57:30Z", "author": {"login": "cemozerr"}, "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/DutyScheduler.java", "diffHunk": "@@ -182,16 +205,43 @@ private void scheduleAggregation(\n \n   @Override\n   public void onBlockProductionDue(final UnsignedLong slot) {\n-    scheduledDuties.produceBlock(slot);\n+    whenDutiesScheduled(slot, scheduledDuties::produceBlock);\n   }\n \n   @Override\n   public void onAttestationCreationDue(final UnsignedLong slot) {\n-    scheduledDuties.produceAttestations(slot);\n+    whenDutiesScheduled(slot, scheduledDuties::produceAttestations);\n   }\n \n   @Override\n   public void onAttestationAggregationDue(final UnsignedLong slot) {\n-    scheduledDuties.performAggregation(slot);\n+    whenDutiesScheduled(slot, scheduledDuties::performAggregation);\n+  }\n+\n+  private void whenDutiesScheduled(final UnsignedLong slot, final Consumer<UnsignedLong> action) {\n+    // We chain the futures to ensure all actions always happen in their original order.\n+    final UnsignedLong epoch = compute_epoch_at_slot(slot);\n+    final SafeFuture<Void> delayedAction =\n+        pendingTasksByEpoch.computeIfPresent(\n+            epoch, (key, previousTask) -> previousTask.thenRun(() -> action.accept(slot)));\n+    if (delayedAction == null) {\n+      // There was no pending tasks so execute immediately.\n+      action.accept(slot);\n+    } else {\n+      removeWhenAllTasksComplete(epoch, delayedAction);\n+    }\n+  }\n+\n+  /**\n+   * Once each new task has been added to {@link #pendingTasksByEpoch}, this function ensures that\n+   * the task queue is removed when that tasks completes, if and only if it is still the last task\n+   * in the queue.\n+   *\n+   * @param epoch the epoch the task was queued for\n+   * @param enqueuedTask the task that was queued\n+   */\n+  private void removeWhenAllTasksComplete(\n+      final UnsignedLong epoch, final SafeFuture<Void> enqueuedTask) {\n+    enqueuedTask.always(() -> pendingTasksByEpoch.remove(epoch, enqueuedTask));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84d2137460e33f834c5f1c7da5daf00ca00c55be"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzODU4NDA1", "url": "https://github.com/ConsenSys/teku/pull/1592#pullrequestreview-393858405", "createdAt": "2020-04-15T14:57:37Z", "commit": {"oid": "84d2137460e33f834c5f1c7da5daf00ca00c55be"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5230df1bea9f318331585e5ea92bc56dc4a5d8d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b5230df1bea9f318331585e5ea92bc56dc4a5d8d", "committedDate": "2020-04-15T19:55:48Z", "message": "Merge branch 'master' into delay-duties"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4274, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}