{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3NjkzMjEw", "number": 2804, "title": "Add BatchImporter", "bodyText": "PR Description\nAdd a class that imports a batch of blocks and provides an aggregate result.\nFixed Issue(s)\n#1844\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-09-16T03:09:58Z", "url": "https://github.com/ConsenSys/teku/pull/2804", "merged": true, "mergeCommit": {"oid": "817de1132fcf4cd9bb996a1d004ebfa0f98ce7c0"}, "closed": true, "closedAt": "2020-09-16T21:18:17Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 41, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHaKjlAH2gAyNDg3NjkzMjEwOjZiMjAwNGZjNjQxODdkNWZmNjJkMTVmYTBkMDg1ZTIzOTA4MGZmMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJZF7FgFqTQ4OTQ0ODMzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6b2004fc64187d5ff62d15fa0d085e239080ff22", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6b2004fc64187d5ff62d15fa0d085e239080ff22", "committedDate": "2020-09-10T05:43:46Z", "message": "Start of finalized sync."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "568a8432302d0ae988ea075e55f7fa6e9584db6d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/568a8432302d0ae988ea075e55f7fa6e9584db6d", "committedDate": "2020-09-10T06:25:30Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc317649970c286af7e91e0419118704135e4f9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/5fc317649970c286af7e91e0419118704135e4f9", "committedDate": "2020-09-10T23:22:53Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dd7b4f0dced3a33ec5036e7556528aa192bdf01", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7dd7b4f0dced3a33ec5036e7556528aa192bdf01", "committedDate": "2020-09-11T03:09:05Z", "message": "Implement more tests, deal with more cases."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8d942abd4f448a7fca8f791c5cb1981356ad581", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e8d942abd4f448a7fca8f791c5cb1981356ad581", "committedDate": "2020-09-11T03:16:19Z", "message": "Only import one batch at a time."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aa096105c7537f9da3da7b976df87345bf77acc", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1aa096105c7537f9da3da7b976df87345bf77acc", "committedDate": "2020-09-11T04:45:39Z", "message": "Extract NavigableSet logic to BatchChain."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cc9d52b0903dda28408477a87025f575590fe62", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1cc9d52b0903dda28408477a87025f575590fe62", "committedDate": "2020-09-11T04:45:47Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d32b018e502c4f78a2f216fdaa7ca25f712315a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/5d32b018e502c4f78a2f216fdaa7ca25f712315a", "committedDate": "2020-09-11T05:56:48Z", "message": "Handle changing which chain we sync to."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dcad90452c9dba02c6b66c9ea3b6bdb6ec29470", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6dcad90452c9dba02c6b66c9ea3b6bdb6ec29470", "committedDate": "2020-09-11T06:24:54Z", "message": "Add missing dependency."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45d5f73a04f26f4249508c64648a61f2bbf0d48c", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/45d5f73a04f26f4249508c64648a61f2bbf0d48c", "committedDate": "2020-09-11T21:16:58Z", "message": "Implement BatchImporter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "097b2fb86801fc8d2545f07a7088dde51d0a2206", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/097b2fb86801fc8d2545f07a7088dde51d0a2206", "committedDate": "2020-09-11T21:17:02Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65e5bc0e83647d8f607fb84de08deceee83b5930", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/65e5bc0e83647d8f607fb84de08deceee83b5930", "committedDate": "2020-09-13T21:28:03Z", "message": "Implement the happy path for a real batch implementation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef6da95951bb068cfe31b55d22bc6c02acd5ea95", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ef6da95951bb068cfe31b55d22bc6c02acd5ea95", "committedDate": "2020-09-13T21:36:28Z", "message": "Report exceptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cef1ff7f9ce1429788f9dad33681553236de11d3", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/cef1ff7f9ce1429788f9dad33681553236de11d3", "committedDate": "2020-09-13T21:48:50Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bfe8c8295e2907ddac64b349f88822e33f1f342", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/9bfe8c8295e2907ddac64b349f88822e33f1f342", "committedDate": "2020-09-13T22:07:25Z", "message": "Errorprone."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2517c362f8e7c6f953827301e688feb17d5d237a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2517c362f8e7c6f953827301e688feb17d5d237a", "committedDate": "2020-09-13T22:23:53Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0655190758b60d2aed9b66513b099b736da7f926", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0655190758b60d2aed9b66513b099b736da7f926", "committedDate": "2020-09-13T22:26:24Z", "message": "Reduce batch size."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0599450254201c540df193e15094f6a40068f0b8", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0599450254201c540df193e15094f6a40068f0b8", "committedDate": "2020-09-14T02:01:49Z", "message": "Limit the number of non-empty batches in progress at any time, not just the number of requests for more blocks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff191d92a92a8876ab22bc3aaf7f778ffa50bd08", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ff191d92a92a8876ab22bc3aaf7f778ffa50bd08", "committedDate": "2020-09-14T05:56:02Z", "message": "Fix last slot calculations.\nHandle disconnected peers and errors when requesting blocks.\nVery basic support for handling contested blocks.\nMore debug level output."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42cace7c802944a707ed80db9cb716f135cd52f8", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/42cace7c802944a707ed80db9cb716f135cd52f8", "committedDate": "2020-09-15T00:49:46Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync\nReturn sync result."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c029be02d4640ba92f770b4c88baf263b4d57281", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/c029be02d4640ba92f770b4c88baf263b4d57281", "committedDate": "2020-09-15T00:59:59Z", "message": "Mark future complete when there are no more batches to process."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bba02a0ce70866a73d732f1be8ea515e32e8b2ef", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/bba02a0ce70866a73d732f1be8ea515e32e8b2ef", "committedDate": "2020-09-15T01:10:49Z", "message": "Fix SyncSourceBatchTest."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2f0736b5beab1664951ab977ca8fe8b0448af34", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b2f0736b5beab1664951ab977ca8fe8b0448af34", "committedDate": "2020-09-15T01:26:56Z", "message": "Split requesting of batches into a separate class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9264ba62a69c2ee8400588bed3d362ac817ae8f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d9264ba62a69c2ee8400588bed3d362ac817ae8f", "committedDate": "2020-09-15T01:33:26Z", "message": "Apply event thread checks to batches in production code too."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "436ae359b93ea1a6cd97412a6eefbf3041a2f82b", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/436ae359b93ea1a6cd97412a6eefbf3041a2f82b", "committedDate": "2020-09-15T03:17:22Z", "message": "Implement markInvalid."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38ddae967fe3f0cb5a0aaae4f86bdffe04265d9c", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/38ddae967fe3f0cb5a0aaae4f86bdffe04265d9c", "committedDate": "2020-09-15T04:05:28Z", "message": "Introduce ConflictResolutionStrategy with a single pessimistic strategy that marks every contested batch as invalid and re-downloads.\nFix issue where incomplete batches were marked as contested because they appeared empty."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56ac8b28270d503fe38b9c3334d727e38c3e60bd", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/56ac8b28270d503fe38b9c3334d727e38c3e60bd", "committedDate": "2020-09-15T04:10:18Z", "message": "Fix assertions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb5d39ab481784867bdceed839a1c5886960a9ea", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/bb5d39ab481784867bdceed839a1c5886960a9ea", "committedDate": "2020-09-15T04:20:30Z", "message": "Log when multipeer sync is in use."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63e0f53b217c1e8143eb217ba67418c7371233b0", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/63e0f53b217c1e8143eb217ba67418c7371233b0", "committedDate": "2020-09-15T04:58:25Z", "message": "Handle errors raised when requesting blocks because the response is internally inconsistent."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f400d9e09d78271133bb89ed6c185751b5a8e775", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/f400d9e09d78271133bb89ed6c185751b5a8e775", "committedDate": "2020-09-15T05:09:30Z", "message": "Verify blocks received from separate requests within the same batch form a chain."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ac5a214123687c90f587950c7c0ab32d7942762", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7ac5a214123687c90f587950c7c0ab32d7942762", "committedDate": "2020-09-15T06:11:44Z", "message": "Fail sync when there are no peers left on the target chain.\nHandle not having any peers when attempting to make requests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc3c6017c679a29c2efb87a4c19ce31527f02a91", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/bc3c6017c679a29c2efb87a4c19ce31527f02a91", "committedDate": "2020-09-15T06:13:39Z", "message": "Spotless."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1345a163a1350c7a770b77656b8fb8f5caa48730", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1345a163a1350c7a770b77656b8fb8f5caa48730", "committedDate": "2020-09-16T00:33:21Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c503e6c500e95863938af0af661c9331ab14c908", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/c503e6c500e95863938af0af661c9331ab14c908", "committedDate": "2020-09-16T01:39:28Z", "message": "Add debug logging when conflict resolution occurs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bcb92d398a39878361b40182d93902c82389802", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1bcb92d398a39878361b40182d93902c82389802", "committedDate": "2020-09-16T01:48:49Z", "message": "More debugging progressSync when target chain switches instead of just filling queue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "725caf2c284b4381b038043966c933800ed18be6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/725caf2c284b4381b038043966c933800ed18be6", "committedDate": "2020-09-16T02:15:03Z", "message": "Avoid stalling when a batch completes importing after it has been dropped from the active batches."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "109001a47dff4a1856f9e2c0936807aaca02604f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/109001a47dff4a1856f9e2c0936807aaca02604f", "committedDate": "2020-09-16T02:15:20Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbe8b807bd3ab80a823af02d58a21b59a8bce043", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/fbe8b807bd3ab80a823af02d58a21b59a8bce043", "committedDate": "2020-09-16T02:59:19Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into finalized-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37a06f18e53a69a06748180cdb03c858df34e0a9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/37a06f18e53a69a06748180cdb03c858df34e0a9", "committedDate": "2020-09-16T03:03:56Z", "message": "Remove todo."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0becd6ed7bbb48548e0f4da7f88ee05e5e8fe205", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0becd6ed7bbb48548e0f4da7f88ee05e5e8fe205", "committedDate": "2020-09-16T03:09:05Z", "message": "Add BatchImporter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDQ4MzM3", "url": "https://github.com/ConsenSys/teku/pull/2804#pullrequestreview-489448337", "createdAt": "2020-09-16T09:35:45Z", "commit": {"oid": "0becd6ed7bbb48548e0f4da7f88ee05e5e8fe205"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTozNTo0NVrOHSonLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTozNTo0NVrOHSonLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwMTgwNw==", "bodyText": "Why do we need runAsync here if the importBlock is async itself?", "url": "https://github.com/ConsenSys/teku/pull/2804#discussion_r489301807", "createdAt": "2020-09-16T09:35:45Z", "author": {"login": "Nashatyrev"}, "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/BatchImporter.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync.multipeer;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import tech.pegasys.teku.core.results.BlockImportResult;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.AsyncRunner;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.statetransition.blockimport.BlockImporter;\n+import tech.pegasys.teku.sync.multipeer.batches.Batch;\n+\n+public class BatchImporter {\n+\n+  private final BlockImporter blockImporter;\n+  private final AsyncRunner asyncRunner;\n+\n+  public BatchImporter(final BlockImporter blockImporter, final AsyncRunner asyncRunner) {\n+    this.blockImporter = blockImporter;\n+    this.asyncRunner = asyncRunner;\n+  }\n+\n+  /**\n+   * Import the blocks in the specified batch.\n+   *\n+   * <p>Guaranteed to return immediately and perform the import on worker threads.\n+   *\n+   * @param batch the batch to import\n+   * @return a future reporting the result of the import\n+   */\n+  public SafeFuture<BatchImportResult> importBatch(final Batch batch) {\n+    // Copy the blocks as we're going to use them from off the event thread.\n+    final List<SignedBeaconBlock> blocks = new ArrayList<>(batch.getBlocks());\n+    checkState(!blocks.isEmpty(), \"Batch has no blocks to import\");\n+    return asyncRunner.runAsync(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0becd6ed7bbb48548e0f4da7f88ee05e5e8fe205"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3442, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}