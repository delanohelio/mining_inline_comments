{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNjUzOTUz", "number": 1143, "title": "Make Sync Work", "bodyText": "PR Description\nThis PR contains a collection of changes that get teku syncing with prysm's saphire testnet as well as some other tweaks:\n\nUpdate peer validation logic to be compatible with Prysm\nUpdate PeerSync to use the new style of BlocksByRange (#1131)\nUpdate PeerSync to wait before firing repeated requests at a peer in order to avoid rate limit errors\nRework logic to close rpc streams (invoke close on the top-level P2PChannel when fully closing a stream)\nUpdate SyncManager to automatically retry if no valid peers are available or we encounter an error while syncing\nMake node private key optional, so that we'll generate a key if none is provided\nReduce peer connection retry rate\nTweak logging", "createdAt": "2020-02-08T00:21:03Z", "url": "https://github.com/ConsenSys/teku/pull/1143", "merged": true, "mergeCommit": {"oid": "f3625a5f539f8983bbe85d356d599105a33fdc2a"}, "closed": true, "closedAt": "2020-02-11T15:27:48Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCIlA4AH2gAyMzcyNjUzOTUzOmUwM2Y0YzMyYzliODAzOGFlYzMxNmYwYzRlMWU3ZmRiZTVjMjkyMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDTQS5gH2gAyMzcyNjUzOTUzOjM0YjgxODM3MjU0Njk1MmZjNzg0NGUwYTQ5ZDNlMGE4NWU5ODk2NTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e03f4c32c9b8038aec316f0c4e1e7fdbe5c29232", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/e03f4c32c9b8038aec316f0c4e1e7fdbe5c29232", "committedDate": "2020-02-08T00:13:36Z", "message": "Update PeerSync to work with BlocksByRange changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c09ae70af58e722df75ff5d6353c4f75edf8f6eb", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c09ae70af58e722df75ff5d6353c4f75edf8f6eb", "committedDate": "2020-02-08T00:13:36Z", "message": "Clean up peer reconnect logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50035d4f12b4b9148853d2922b439c7a079ec143", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/50035d4f12b4b9148853d2922b439c7a079ec143", "committedDate": "2020-02-08T00:13:36Z", "message": "Add more logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c645bb915b0de1a401407bbea23c21eb7b26e485", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c645bb915b0de1a401407bbea23c21eb7b26e485", "committedDate": "2020-02-08T00:13:36Z", "message": "Add more logging, tweak retry logic in SyncManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e05003deca574491bb0fb335640da781e5d76ced", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/e05003deca574491bb0fb335640da781e5d76ced", "committedDate": "2020-02-08T00:13:36Z", "message": "Update PeerManagerTest to use AsyncRunner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24833388d783644b9b724a8c76569acd6f3185a2", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/24833388d783644b9b724a8c76569acd6f3185a2", "committedDate": "2020-02-08T00:13:37Z", "message": "Add explicit handling for status send to make logs quieter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb30e277e4cdb9dc973adb508f4cfc85d9c04f6e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/fb30e277e4cdb9dc973adb508f4cfc85d9c04f6e", "committedDate": "2020-02-08T00:13:37Z", "message": "Make private key optional"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad81c3bad7ee247b013bcf5a433aec15ae1123ee", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/ad81c3bad7ee247b013bcf5a433aec15ae1123ee", "committedDate": "2020-02-08T00:13:37Z", "message": "Fully close rpc stream when we're done receiving responses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65918c15b722c513afec01fc78e5c3016b882bb7", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/65918c15b722c513afec01fc78e5c3016b882bb7", "committedDate": "2020-02-08T00:13:37Z", "message": "Catch and log unexpected errors during block import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5217e6739697a3454087f56e4c7ae81bc9977984", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/5217e6739697a3454087f56e4c7ae81bc9977984", "committedDate": "2020-02-08T00:13:37Z", "message": "To avoid rate limiting, pause before issuing follow-up request to peer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "062dea981264c7d9eaf45e0d3713b57c79711c75", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/062dea981264c7d9eaf45e0d3713b57c79711c75", "committedDate": "2020-02-08T00:13:37Z", "message": "Account for prysm's special handling of genesis blocks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d5b86166956006c4195d7e31cd538e8b27561b3", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/6d5b86166956006c4195d7e31cd538e8b27561b3", "committedDate": "2020-02-10T15:32:30Z", "message": "Merge branch 'master' into sync/rework-peer-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0d6468e8de993f1d0b8936ebedb6d8e102de13e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/e0d6468e8de993f1d0b8936ebedb6d8e102de13e", "committedDate": "2020-02-10T15:46:33Z", "message": "Return initial connection future from connect()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca56949601e2341e64a45d4c0c13ff222ee6375f", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/ca56949601e2341e64a45d4c0c13ff222ee6375f", "committedDate": "2020-02-10T15:51:21Z", "message": "Ignore retry future"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzQ0MDM1", "url": "https://github.com/ConsenSys/teku/pull/1143#pullrequestreview-356344035", "createdAt": "2020-02-10T23:40:22Z", "commit": {"oid": "ca56949601e2341e64a45d4c0c13ff222ee6375f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzo0MDoyMlrOFn5lhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzo0MDoyMlrOFn5lhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM4MjI3Ng==", "bodyText": "Given that this shouldn't ever complete exceptionally, could we use reportExceptions() on the end instead of ignoreFuture?  That way if for some reason an exception does bubble up because of a bug somewhere it will get logged instead of silently ignored.", "url": "https://github.com/ConsenSys/teku/pull/1143#discussion_r377382276", "createdAt": "2020-02-10T23:40:22Z", "author": {"login": "ajsutton"}, "path": "networking/p2p/src/main/java/tech/pegasys/artemis/networking/p2p/libp2p/PeerManager.java", "diffHunk": "@@ -83,36 +84,34 @@ public void unsubscribeConnect(final long subscriptionId) {\n \n   public SafeFuture<?> connect(final Multiaddr peer, final Network network) {\n     STDOUT.log(Level.DEBUG, \"Connecting to \" + peer);\n-    return SafeFuture.of(network.connect(peer))\n-        .whenComplete(\n-            (conn, throwable) -> {\n-              if (throwable != null) {\n-                STDOUT.log(\n-                    Level.DEBUG,\n-                    \"Connection to \" + peer + \" failed. Will retry shortly: \" + throwable);\n-                ignoreFuture(\n-                    scheduler.schedule(\n-                        () -> connect(peer, network).reportExceptions(),\n-                        RECONNECT_TIMEOUT,\n-                        TimeUnit.MILLISECONDS));\n-              } else {\n-                STDOUT.log(\n-                    Level.DEBUG,\n-                    \"Connection to peer: \"\n-                        + conn.secureSession().getRemoteId()\n-                        + \" was successful\");\n-                SafeFuture.of(conn.closeFuture())\n-                    .finish(\n-                        () -> {\n-                          LOG.debug(\"Connection to {} closed. Will retry shortly\", peer);\n-                          ignoreFuture(\n-                              scheduler.schedule(\n-                                  () -> connect(peer, network).reportExceptions(),\n-                                  RECONNECT_TIMEOUT,\n-                                  TimeUnit.MILLISECONDS));\n-                        });\n-              }\n-            });\n+    final SafeFuture<Connection> initialConnectionFuture = SafeFuture.of(network.connect(peer));\n+    final SafeFuture<?> retryLoop =\n+        initialConnectionFuture\n+            .thenCompose(\n+                conn -> {\n+                  LOG.debug(\n+                      \"Connection to peer {} was successful\", conn.secureSession().getRemoteId());\n+                  return SafeFuture.of(conn.closeFuture());\n+                })\n+            .exceptionally(\n+                (err) -> {\n+                  LOG.debug(\"Connection to {} failed: {}\", peer, err);\n+                  return null;\n+                })\n+            .thenCompose(\n+                (res) -> {\n+                  LOG.debug(\n+                      \"Connection to {} was closed. Will retry in {} sec\",\n+                      peer,\n+                      RECONNECT_TIMEOUT.toSeconds());\n+\n+                  return asynRunner.runAfterDelay(\n+                      () -> connect(peer, network),\n+                      RECONNECT_TIMEOUT.toMillis(),\n+                      TimeUnit.MILLISECONDS);\n+                });\n+    ignoreFuture(retryLoop);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca56949601e2341e64a45d4c0c13ff222ee6375f"}, "originalPosition": 105}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "966ebcfef795a5dac256e319c8608cdb6cd3b9e8", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/966ebcfef795a5dac256e319c8608cdb6cd3b9e8", "committedDate": "2020-02-11T00:17:52Z", "message": "Merge branch 'master' into sync/rework-peer-sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d395399da45c123ec3d6054f51c8ad0694cbdf09", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/d395399da45c123ec3d6054f51c8ad0694cbdf09", "committedDate": "2020-02-11T15:00:28Z", "message": "Report async scheduling exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34b818372546952fc7844e0a49d3e0a85e989656", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/34b818372546952fc7844e0a49d3e0a85e989656", "committedDate": "2020-02-11T15:13:51Z", "message": "Increase connectionn retry rate for more stable integration tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4284, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}