{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NjE4OTM2", "number": 3058, "title": "Add simple handling for rate limiting responses", "bodyText": "PR Description\nAdd simple handling for 429 responses from the beacon node API by retrying the request after 2 seconds.  Normally Teku doesn't give 429 responses but Infura might and a short back-off is enough to keep it working.\nWe may need to do more advanced handling in the future but there's some other clean up for the rest api client that needs to happen first.\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-22T23:53:53Z", "url": "https://github.com/ConsenSys/teku/pull/3058", "merged": true, "mergeCommit": {"oid": "d907598a2880e658307ecf0b7938c1a46f68ed49"}, "closed": true, "closedAt": "2020-10-23T02:12:33Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVK5_NAH2gAyNTA4NjE4OTM2OjVlNzFmYzA5OGQ5MjdmYjRkMDU0NjNiYTdlMTA1MTFiYjk0ODk1OWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVL6IrAH2gAyNTA4NjE4OTM2OmI3ZDNkMGI0NTc0ODEwOTVjNDU2OWNiM2FhNzgwYjc5Yzg4NDdkNTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5e71fc098d927fb4d05463ba7e10511bb948959a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/5e71fc098d927fb4d05463ba7e10511bb948959a", "committedDate": "2020-10-22T23:52:02Z", "message": "Add simple handling for rate limiting responses by retrying after a 2 second delay."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7247ea3cd3fbbdb93f456bfeedfaea5e8856c530", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7247ea3cd3fbbdb93f456bfeedfaea5e8856c530", "committedDate": "2020-10-23T00:18:10Z", "message": "Limit the number of retries because of 429 responses."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3acd5de72bb9562c5181ca0c38ae48adf23c7a9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d3acd5de72bb9562c5181ca0c38ae48adf23c7a9", "committedDate": "2020-10-23T00:20:37Z", "message": "Fix test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "399321d0d74cd184371dc78fa57bc66f873e7e04", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/399321d0d74cd184371dc78fa57bc66f873e7e04", "committedDate": "2020-10-23T00:21:08Z", "message": "Sportless."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjEwNjk3", "url": "https://github.com/ConsenSys/teku/pull/3058#pullrequestreview-515210697", "createdAt": "2020-10-23T00:46:23Z", "commit": {"oid": "399321d0d74cd184371dc78fa57bc66f873e7e04"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMDo0NjoyM1rOHm4qFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMDo0NjoyM1rOHm4qFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzNjIxNQ==", "bodyText": "nit Beacon node has warned that we're making too many requests. Retrying after delay.", "url": "https://github.com/ConsenSys/teku/pull/3058#discussion_r510536215", "createdAt": "2020-10-23T00:46:23Z", "author": {"login": "rolfyone"}, "path": "validator/remote/src/main/java/tech/pegasys/teku/validator/remote/RemoteValidatorApiHandler.java", "diffHunk": "@@ -299,8 +304,36 @@ public void subscribeToPersistentSubnets(final Set<SubnetSubscription> subnetSub\n                         s.getSubnetId(), s.getUnsubscriptionSlot()))\n             .collect(Collectors.toSet());\n \n-    asyncRunner\n-        .runAsync(() -> apiClient.subscribeToPersistentSubnets(schemaSubscriptions))\n+    sendRequest(() -> apiClient.subscribeToPersistentSubnets(schemaSubscriptions))\n         .finish(error -> LOG.error(\"Failed to subscribe to persistent subnets\", error));\n   }\n+\n+  private SafeFuture<Void> sendRequest(final ExceptionThrowingRunnable requestExecutor) {\n+    return sendRequest(\n+        () -> {\n+          requestExecutor.run();\n+          return null;\n+        });\n+  }\n+\n+  private <T> SafeFuture<T> sendRequest(final ExceptionThrowingSupplier<T> requestExecutor) {\n+    return asyncRunner.runAsync(() -> sendRequest(requestExecutor, 0));\n+  }\n+\n+  private <T> SafeFuture<T> sendRequest(\n+      final ExceptionThrowingSupplier<T> requestExecutor, final int attempt) {\n+    return SafeFuture.of(requestExecutor)\n+        .exceptionallyCompose(\n+            error -> {\n+              if (Throwables.getRootCause(error) instanceof RateLimitedException\n+                  && attempt < MAX_RATE_LIMITING_RETRIES) {\n+                LOG.warn(\n+                    \"Received Too Many Requests response from beacon node. Retrying after a delay.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "399321d0d74cd184371dc78fa57bc66f873e7e04"}, "originalPosition": 202}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjEwODM0", "url": "https://github.com/ConsenSys/teku/pull/3058#pullrequestreview-515210834", "createdAt": "2020-10-23T00:46:57Z", "commit": {"oid": "399321d0d74cd184371dc78fa57bc66f873e7e04"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7d3d0b457481095c4569cb3aa780b79c8847d57", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b7d3d0b457481095c4569cb3aa780b79c8847d57", "committedDate": "2020-10-23T01:02:06Z", "message": "Improve wording."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3250, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}