{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMDk5Mjcy", "number": 1268, "title": "[BC-299] Clean up service initialization", "bodyText": "PR Description\nSimplify service startup:\n\nMove ServiceController into top-level artemis package, so we can instantiate services without using reflection\nMigrate services to use simple Service interface, cut now unused service utilities\nDon't create unnecessary executors - if a service needs to run something via an executor, it should control the executor lifecycle\n\nAnd some tangential changes:\n\nMake sure startup and shutdown errors are propagated up\n\nMake sure network.connect() errors propagate via the SafeFuture chain and are not thrown directly\n\n\nUse either final or volatile vars in BeaconChainController\nCut unused NodeEvent", "createdAt": "2020-03-03T18:10:25Z", "url": "https://github.com/ConsenSys/teku/pull/1268", "merged": true, "mergeCommit": {"oid": "9cd23ae4a876ca08b416349164d1c07b4412022f"}, "closed": true, "closedAt": "2020-03-14T06:25:57Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKF-zhgH2gAyMzgzMDk5MjcyOjc2ZDAwZmIzMDY1MzIwN2Q1ODkxN2E3MTdhOTNmMjBjYTBjNTk5ODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNaq6VAFqTM3NDY4NjcyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "76d00fb30653207d58917a717a93f20ca0c59982", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/76d00fb30653207d58917a717a93f20ca0c59982", "committedDate": "2020-03-03T17:43:27Z", "message": "Simplify service startup, remove unnecessary executors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "839bb70b11afe45b97d5a3ee36ba30094cfd28df", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/839bb70b11afe45b97d5a3ee36ba30094cfd28df", "committedDate": "2020-03-03T18:03:54Z", "message": "Cut unnecessary null check, add log back in for consistency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f073d5a8cb0412bab34e5b448e494bfe13c8fac", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8f073d5a8cb0412bab34e5b448e494bfe13c8fac", "committedDate": "2020-03-03T18:08:32Z", "message": "Cut unused classes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4Mzk2ODc1", "url": "https://github.com/ConsenSys/teku/pull/1268#pullrequestreview-368396875", "createdAt": "2020-03-03T23:17:51Z", "commit": {"oid": "8f073d5a8cb0412bab34e5b448e494bfe13c8fac"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMzoxNzo1MVrOFxaJ8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMzoyMTo0OVrOFxaOpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM1MzA3NQ==", "bodyText": "Should we be doing a join here? Then if any component fails to start we throw an exception back up to BeaconNodeCommand (we should remove the try/catch in this class).  That in turn lets PicoCLI be notified of the failure properly.", "url": "https://github.com/ConsenSys/teku/pull/1268#discussion_r387353075", "createdAt": "2020-03-03T23:17:51Z", "author": {"login": "ajsutton"}, "path": "artemis/src/main/java/tech/pegasys/artemis/BeaconNode.java", "diffHunk": "@@ -88,18 +88,8 @@\n   public void start() {\n \n     try {\n-      this.serviceConfig.getConfig().validateConfig();\n       metricsEndpoint.start();\n-      // Initialize services\n-      serviceController.initAll(\n-          serviceConfig,\n-          BeaconChainService.class,\n-          PowchainService.class,\n-          ChainStorageService.class);\n-\n-      // Start services\n-      serviceController.startAll();\n-\n+      serviceController.start().reportExceptions();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f073d5a8cb0412bab34e5b448e494bfe13c8fac"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM1NDI3OA==", "bodyText": "Yay! Love seeing these move out of constructors.  Could easily be the source of your failing AT though as it will now miss events from the storage service at startup.", "url": "https://github.com/ConsenSys/teku/pull/1268#discussion_r387354278", "createdAt": "2020-03-03T23:21:49Z", "author": {"login": "ajsutton"}, "path": "services/beaconchain/src/main/java/tech/pegasys/artemis/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -107,10 +101,10 @@ public BeaconChainController(\n     this.config = config;\n     this.metricsSystem = metricsSystem;\n     this.testMode = config.getDepositMode().equals(DEPOSIT_TEST);\n-    this.eventBus.register(this);\n   }\n \n   public void initAll() {\n+    this.eventBus.register(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f073d5a8cb0412bab34e5b448e494bfe13c8fac"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "415325fed0b653e97f407b7e49c381057d6c212d", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/415325fed0b653e97f407b7e49c381057d6c212d", "committedDate": "2020-03-12T17:57:52Z", "message": "Merge branch 'master' into bc-277/clean-up-service-initialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d7dc71d9db7da57923896ef2cc6f2fbbd9c09ca", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8d7dc71d9db7da57923896ef2cc6f2fbbd9c09ca", "committedDate": "2020-03-12T17:59:59Z", "message": "Merge branch 'master' into bc-277/clean-up-service-initialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f261faa40bb227a108e74697ce14f7b5c999a908", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f261faa40bb227a108e74697ce14f7b5c999a908", "committedDate": "2020-03-12T18:16:05Z", "message": "Start up BeaconChainController asynchronously"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cceeb558e66f3b89d3d0b5a5349b34d440ac837", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/5cceeb558e66f3b89d3d0b5a5349b34d440ac837", "committedDate": "2020-03-12T18:20:00Z", "message": "Use final or volatile instance variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76218536a895d1dcceb6d03b0215fdb97ca72c5a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/76218536a895d1dcceb6d03b0215fdb97ca72c5a", "committedDate": "2020-03-12T18:24:18Z", "message": "Propagate startup exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd4dbac24bbca78e92863479fbaf9f8605e2c8f2", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/dd4dbac24bbca78e92863479fbaf9f8605e2c8f2", "committedDate": "2020-03-13T15:42:56Z", "message": "Make sure startup failures propagate up, all services are stopped"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f40463d4c804afb245c9da81a9edcfc826ebb70", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/5f40463d4c804afb245c9da81a9edcfc826ebb70", "committedDate": "2020-03-13T15:44:59Z", "message": "Merge branch 'master' into bc-277/clean-up-service-initialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4bac61ace9838b3e9ad41f653502a326ba838e8", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a4bac61ace9838b3e9ad41f653502a326ba838e8", "committedDate": "2020-03-13T16:15:38Z", "message": "Propagate more startup / shutdown failures to returned futures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c89124948d39d20ff724072d17f2159aa0719593", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c89124948d39d20ff724072d17f2159aa0719593", "committedDate": "2020-03-13T16:29:24Z", "message": "Cut unused logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5e02e65fba825c514fb5835fdb7d96849c189ea", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f5e02e65fba825c514fb5835fdb7d96849c189ea", "committedDate": "2020-03-13T17:01:26Z", "message": "Propagate exceptions from network.connect()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Njg2NzI1", "url": "https://github.com/ConsenSys/teku/pull/1268#pullrequestreview-374686725", "createdAt": "2020-03-14T01:31:30Z", "commit": {"oid": "f5e02e65fba825c514fb5835fdb7d96849c189ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4157, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}