{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyODg3OTU2", "number": 1144, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMDowMDozMlrODeTpbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMDoxMTowMFrODeTr7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTA1NzcyOnYy", "diffSide": "RIGHT", "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMDowMDozMlrOFnX0uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMTo0OTozOVrOFnYhUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgyOTExMg==", "bodyText": "We should be passing in the HistoricalChainData client, not creating it in the constructor here.  Possibly should even be passing HistoricalChainData into BeaconRestApi rather than event bus.", "url": "https://github.com/ConsenSys/teku/pull/1144#discussion_r376829112", "createdAt": "2020-02-10T00:00:32Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandler.java", "diffHunk": "@@ -15,60 +15,79 @@\n \n import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_start_slot_at_epoch;\n \n+import com.google.common.eventbus.EventBus;\n import com.google.common.primitives.UnsignedLong;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n import org.apache.tuweni.bytes.Bytes32;\n import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.blocks.SignedBeaconBlock;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n+import tech.pegasys.artemis.storage.HistoricalChainData;\n \n public class BeaconBlockHandler implements BeaconRestApiHandler {\n \n   private final ChainStorageClient client;\n+  private final HistoricalChainData historicalChainData;\n \n-  public BeaconBlockHandler(ChainStorageClient client) {\n+  public BeaconBlockHandler(ChainStorageClient client, EventBus eventBus) {\n     this.client = client;\n+    this.historicalChainData = new HistoricalChainData(eventBus);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28214045ae9d3c7240c10c0def7793adaf3b8b7d"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg0MDUzMA==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/1144#discussion_r376840530", "createdAt": "2020-02-10T01:49:39Z", "author": {"login": "cemozerr"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandler.java", "diffHunk": "@@ -15,60 +15,79 @@\n \n import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_start_slot_at_epoch;\n \n+import com.google.common.eventbus.EventBus;\n import com.google.common.primitives.UnsignedLong;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n import org.apache.tuweni.bytes.Bytes32;\n import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.blocks.SignedBeaconBlock;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n+import tech.pegasys.artemis.storage.HistoricalChainData;\n \n public class BeaconBlockHandler implements BeaconRestApiHandler {\n \n   private final ChainStorageClient client;\n+  private final HistoricalChainData historicalChainData;\n \n-  public BeaconBlockHandler(ChainStorageClient client) {\n+  public BeaconBlockHandler(ChainStorageClient client, EventBus eventBus) {\n     this.client = client;\n+    this.historicalChainData = new HistoricalChainData(eventBus);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgyOTExMg=="}, "originalCommit": {"oid": "28214045ae9d3c7240c10c0def7793adaf3b8b7d"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTA2MzUyOnYy", "diffSide": "RIGHT", "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMDoxMDoyMFrOFnX4CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMTo1ODo1MVrOFnYm9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgyOTk2MA==", "bodyText": "return getBlockBySlot(slot)\n  .map(block -> ImmutableMap.of(\"block\", block, \"blockRoot\", block.hash_tree_root()))\n  .orElse(null);", "url": "https://github.com/ConsenSys/teku/pull/1144#discussion_r376829960", "createdAt": "2020-02-10T00:10:20Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandler.java", "diffHunk": "@@ -15,60 +15,79 @@\n \n import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_start_slot_at_epoch;\n \n+import com.google.common.eventbus.EventBus;\n import com.google.common.primitives.UnsignedLong;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n import org.apache.tuweni.bytes.Bytes32;\n import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.blocks.SignedBeaconBlock;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n+import tech.pegasys.artemis.storage.HistoricalChainData;\n \n public class BeaconBlockHandler implements BeaconRestApiHandler {\n \n   private final ChainStorageClient client;\n+  private final HistoricalChainData historicalChainData;\n \n-  public BeaconBlockHandler(ChainStorageClient client) {\n+  public BeaconBlockHandler(ChainStorageClient client, EventBus eventBus) {\n     this.client = client;\n+    this.historicalChainData = new HistoricalChainData(eventBus);\n   }\n \n   @Override\n   public String getPath() {\n-    return \"/beacon/block/\";\n+    return \"/beacon/block\";\n   }\n \n   @Override\n   public Object handleRequest(RequestParams param) {\n     Map<String, List<String>> queryParamMap = param.getQueryParamMap();\n-    Map<String, Object> jsonObject = new HashMap<>();\n-    BeaconBlock block;\n-    Bytes32 blockRoot;\n     if (queryParamMap.containsKey(\"root\")) {\n       Bytes32 root = Bytes32.fromHexString(param.getQueryParam(\"root\"));\n       return client.getStore() != null ? client.getStore().getBlock(root) : null;\n-    } else if (queryParamMap.containsKey(\"epoch\")) {\n-      UnsignedLong epoch = UnsignedLong.valueOf(param.getQueryParam(\"epoch\"));\n-      Optional<Bytes32> blockRootAtSlot =\n-          client.getBlockRootBySlot(compute_start_slot_at_epoch(epoch));\n-      blockRoot = blockRootAtSlot.orElse(null);\n-      block =\n-          client.getStore() != null && blockRootAtSlot.isPresent()\n-              ? client.getStore().getBlock(blockRootAtSlot.get())\n-              : null;\n+    }\n+\n+    UnsignedLong slot;\n+    if (queryParamMap.containsKey(\"epoch\")) {\n+      slot = compute_start_slot_at_epoch(UnsignedLong.valueOf(param.getQueryParam(\"epoch\")));\n     } else if (queryParamMap.containsKey(\"slot\")) {\n-      UnsignedLong slot = UnsignedLong.valueOf(param.getQueryParam(\"slot\"));\n-      Optional<Bytes32> blockRootAtSlot = client.getBlockRootBySlot(slot);\n-      blockRoot = blockRootAtSlot.orElse(null);\n-      block =\n-          client.getStore() != null && blockRootAtSlot.isPresent()\n-              ? client.getStore().getBlock(blockRootAtSlot.get())\n-              : null;\n+      slot = UnsignedLong.valueOf(param.getQueryParam(\"slot\"));\n     } else {\n       return null;\n     }\n-    jsonObject.put(\"block\", block);\n-    jsonObject.put(\"blockRoot\", blockRoot.toHexString());\n+\n+    Optional<Pair<BeaconBlock, Bytes32>> blockAndRoot = getBlockBySlot(slot);\n+    if (blockAndRoot.isEmpty()) {\n+      return null;\n+    }\n+\n+    Map<String, Object> jsonObject = new HashMap<>();\n+    jsonObject.put(\"blockRoot\", blockAndRoot.get().getRight().toHexString());\n+    jsonObject.put(\"block\", blockAndRoot.get().getLeft());\n+\n     return jsonObject;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28214045ae9d3c7240c10c0def7793adaf3b8b7d"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg0MTk3Mw==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/1144#discussion_r376841973", "createdAt": "2020-02-10T01:58:51Z", "author": {"login": "cemozerr"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandler.java", "diffHunk": "@@ -15,60 +15,79 @@\n \n import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_start_slot_at_epoch;\n \n+import com.google.common.eventbus.EventBus;\n import com.google.common.primitives.UnsignedLong;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n import org.apache.tuweni.bytes.Bytes32;\n import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.blocks.SignedBeaconBlock;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n+import tech.pegasys.artemis.storage.HistoricalChainData;\n \n public class BeaconBlockHandler implements BeaconRestApiHandler {\n \n   private final ChainStorageClient client;\n+  private final HistoricalChainData historicalChainData;\n \n-  public BeaconBlockHandler(ChainStorageClient client) {\n+  public BeaconBlockHandler(ChainStorageClient client, EventBus eventBus) {\n     this.client = client;\n+    this.historicalChainData = new HistoricalChainData(eventBus);\n   }\n \n   @Override\n   public String getPath() {\n-    return \"/beacon/block/\";\n+    return \"/beacon/block\";\n   }\n \n   @Override\n   public Object handleRequest(RequestParams param) {\n     Map<String, List<String>> queryParamMap = param.getQueryParamMap();\n-    Map<String, Object> jsonObject = new HashMap<>();\n-    BeaconBlock block;\n-    Bytes32 blockRoot;\n     if (queryParamMap.containsKey(\"root\")) {\n       Bytes32 root = Bytes32.fromHexString(param.getQueryParam(\"root\"));\n       return client.getStore() != null ? client.getStore().getBlock(root) : null;\n-    } else if (queryParamMap.containsKey(\"epoch\")) {\n-      UnsignedLong epoch = UnsignedLong.valueOf(param.getQueryParam(\"epoch\"));\n-      Optional<Bytes32> blockRootAtSlot =\n-          client.getBlockRootBySlot(compute_start_slot_at_epoch(epoch));\n-      blockRoot = blockRootAtSlot.orElse(null);\n-      block =\n-          client.getStore() != null && blockRootAtSlot.isPresent()\n-              ? client.getStore().getBlock(blockRootAtSlot.get())\n-              : null;\n+    }\n+\n+    UnsignedLong slot;\n+    if (queryParamMap.containsKey(\"epoch\")) {\n+      slot = compute_start_slot_at_epoch(UnsignedLong.valueOf(param.getQueryParam(\"epoch\")));\n     } else if (queryParamMap.containsKey(\"slot\")) {\n-      UnsignedLong slot = UnsignedLong.valueOf(param.getQueryParam(\"slot\"));\n-      Optional<Bytes32> blockRootAtSlot = client.getBlockRootBySlot(slot);\n-      blockRoot = blockRootAtSlot.orElse(null);\n-      block =\n-          client.getStore() != null && blockRootAtSlot.isPresent()\n-              ? client.getStore().getBlock(blockRootAtSlot.get())\n-              : null;\n+      slot = UnsignedLong.valueOf(param.getQueryParam(\"slot\"));\n     } else {\n       return null;\n     }\n-    jsonObject.put(\"block\", block);\n-    jsonObject.put(\"blockRoot\", blockRoot.toHexString());\n+\n+    Optional<Pair<BeaconBlock, Bytes32>> blockAndRoot = getBlockBySlot(slot);\n+    if (blockAndRoot.isEmpty()) {\n+      return null;\n+    }\n+\n+    Map<String, Object> jsonObject = new HashMap<>();\n+    jsonObject.put(\"blockRoot\", blockAndRoot.get().getRight().toHexString());\n+    jsonObject.put(\"block\", blockAndRoot.get().getLeft());\n+\n     return jsonObject;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgyOTk2MA=="}, "originalCommit": {"oid": "28214045ae9d3c7240c10c0def7793adaf3b8b7d"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTA2NDEzOnYy", "diffSide": "RIGHT", "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandler.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMDoxMTowMFrOFnX4YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwMTo1Nzo0OVrOFnYmTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzMDA0OA==", "bodyText": "This can just return Optional<BeaconBlock> since the root is just calculated by calling block.hash_tree_root() anyway.", "url": "https://github.com/ConsenSys/teku/pull/1144#discussion_r376830048", "createdAt": "2020-02-10T00:11:00Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandler.java", "diffHunk": "@@ -15,60 +15,79 @@\n \n import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_start_slot_at_epoch;\n \n+import com.google.common.eventbus.EventBus;\n import com.google.common.primitives.UnsignedLong;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n import org.apache.tuweni.bytes.Bytes32;\n import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.blocks.SignedBeaconBlock;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n+import tech.pegasys.artemis.storage.HistoricalChainData;\n \n public class BeaconBlockHandler implements BeaconRestApiHandler {\n \n   private final ChainStorageClient client;\n+  private final HistoricalChainData historicalChainData;\n \n-  public BeaconBlockHandler(ChainStorageClient client) {\n+  public BeaconBlockHandler(ChainStorageClient client, EventBus eventBus) {\n     this.client = client;\n+    this.historicalChainData = new HistoricalChainData(eventBus);\n   }\n \n   @Override\n   public String getPath() {\n-    return \"/beacon/block/\";\n+    return \"/beacon/block\";\n   }\n \n   @Override\n   public Object handleRequest(RequestParams param) {\n     Map<String, List<String>> queryParamMap = param.getQueryParamMap();\n-    Map<String, Object> jsonObject = new HashMap<>();\n-    BeaconBlock block;\n-    Bytes32 blockRoot;\n     if (queryParamMap.containsKey(\"root\")) {\n       Bytes32 root = Bytes32.fromHexString(param.getQueryParam(\"root\"));\n       return client.getStore() != null ? client.getStore().getBlock(root) : null;\n-    } else if (queryParamMap.containsKey(\"epoch\")) {\n-      UnsignedLong epoch = UnsignedLong.valueOf(param.getQueryParam(\"epoch\"));\n-      Optional<Bytes32> blockRootAtSlot =\n-          client.getBlockRootBySlot(compute_start_slot_at_epoch(epoch));\n-      blockRoot = blockRootAtSlot.orElse(null);\n-      block =\n-          client.getStore() != null && blockRootAtSlot.isPresent()\n-              ? client.getStore().getBlock(blockRootAtSlot.get())\n-              : null;\n+    }\n+\n+    UnsignedLong slot;\n+    if (queryParamMap.containsKey(\"epoch\")) {\n+      slot = compute_start_slot_at_epoch(UnsignedLong.valueOf(param.getQueryParam(\"epoch\")));\n     } else if (queryParamMap.containsKey(\"slot\")) {\n-      UnsignedLong slot = UnsignedLong.valueOf(param.getQueryParam(\"slot\"));\n-      Optional<Bytes32> blockRootAtSlot = client.getBlockRootBySlot(slot);\n-      blockRoot = blockRootAtSlot.orElse(null);\n-      block =\n-          client.getStore() != null && blockRootAtSlot.isPresent()\n-              ? client.getStore().getBlock(blockRootAtSlot.get())\n-              : null;\n+      slot = UnsignedLong.valueOf(param.getQueryParam(\"slot\"));\n     } else {\n       return null;\n     }\n-    jsonObject.put(\"block\", block);\n-    jsonObject.put(\"blockRoot\", blockRoot.toHexString());\n+\n+    Optional<Pair<BeaconBlock, Bytes32>> blockAndRoot = getBlockBySlot(slot);\n+    if (blockAndRoot.isEmpty()) {\n+      return null;\n+    }\n+\n+    Map<String, Object> jsonObject = new HashMap<>();\n+    jsonObject.put(\"blockRoot\", blockAndRoot.get().getRight().toHexString());\n+    jsonObject.put(\"block\", blockAndRoot.get().getLeft());\n+\n     return jsonObject;\n   }\n+\n+  private Optional<Pair<BeaconBlock, Bytes32>> getBlockBySlot(UnsignedLong slot) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28214045ae9d3c7240c10c0def7793adaf3b8b7d"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg0MTEzNQ==", "bodyText": "I only did that because if we're able to find the block in memory, we already access it using its root. I guess assuming that the hash tree roots will be cached going forward, this is unnecessary.", "url": "https://github.com/ConsenSys/teku/pull/1144#discussion_r376841135", "createdAt": "2020-02-10T01:53:12Z", "author": {"login": "cemozerr"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandler.java", "diffHunk": "@@ -15,60 +15,79 @@\n \n import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_start_slot_at_epoch;\n \n+import com.google.common.eventbus.EventBus;\n import com.google.common.primitives.UnsignedLong;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n import org.apache.tuweni.bytes.Bytes32;\n import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.blocks.SignedBeaconBlock;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n+import tech.pegasys.artemis.storage.HistoricalChainData;\n \n public class BeaconBlockHandler implements BeaconRestApiHandler {\n \n   private final ChainStorageClient client;\n+  private final HistoricalChainData historicalChainData;\n \n-  public BeaconBlockHandler(ChainStorageClient client) {\n+  public BeaconBlockHandler(ChainStorageClient client, EventBus eventBus) {\n     this.client = client;\n+    this.historicalChainData = new HistoricalChainData(eventBus);\n   }\n \n   @Override\n   public String getPath() {\n-    return \"/beacon/block/\";\n+    return \"/beacon/block\";\n   }\n \n   @Override\n   public Object handleRequest(RequestParams param) {\n     Map<String, List<String>> queryParamMap = param.getQueryParamMap();\n-    Map<String, Object> jsonObject = new HashMap<>();\n-    BeaconBlock block;\n-    Bytes32 blockRoot;\n     if (queryParamMap.containsKey(\"root\")) {\n       Bytes32 root = Bytes32.fromHexString(param.getQueryParam(\"root\"));\n       return client.getStore() != null ? client.getStore().getBlock(root) : null;\n-    } else if (queryParamMap.containsKey(\"epoch\")) {\n-      UnsignedLong epoch = UnsignedLong.valueOf(param.getQueryParam(\"epoch\"));\n-      Optional<Bytes32> blockRootAtSlot =\n-          client.getBlockRootBySlot(compute_start_slot_at_epoch(epoch));\n-      blockRoot = blockRootAtSlot.orElse(null);\n-      block =\n-          client.getStore() != null && blockRootAtSlot.isPresent()\n-              ? client.getStore().getBlock(blockRootAtSlot.get())\n-              : null;\n+    }\n+\n+    UnsignedLong slot;\n+    if (queryParamMap.containsKey(\"epoch\")) {\n+      slot = compute_start_slot_at_epoch(UnsignedLong.valueOf(param.getQueryParam(\"epoch\")));\n     } else if (queryParamMap.containsKey(\"slot\")) {\n-      UnsignedLong slot = UnsignedLong.valueOf(param.getQueryParam(\"slot\"));\n-      Optional<Bytes32> blockRootAtSlot = client.getBlockRootBySlot(slot);\n-      blockRoot = blockRootAtSlot.orElse(null);\n-      block =\n-          client.getStore() != null && blockRootAtSlot.isPresent()\n-              ? client.getStore().getBlock(blockRootAtSlot.get())\n-              : null;\n+      slot = UnsignedLong.valueOf(param.getQueryParam(\"slot\"));\n     } else {\n       return null;\n     }\n-    jsonObject.put(\"block\", block);\n-    jsonObject.put(\"blockRoot\", blockRoot.toHexString());\n+\n+    Optional<Pair<BeaconBlock, Bytes32>> blockAndRoot = getBlockBySlot(slot);\n+    if (blockAndRoot.isEmpty()) {\n+      return null;\n+    }\n+\n+    Map<String, Object> jsonObject = new HashMap<>();\n+    jsonObject.put(\"blockRoot\", blockAndRoot.get().getRight().toHexString());\n+    jsonObject.put(\"block\", blockAndRoot.get().getLeft());\n+\n     return jsonObject;\n   }\n+\n+  private Optional<Pair<BeaconBlock, Bytes32>> getBlockBySlot(UnsignedLong slot) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzMDA0OA=="}, "originalCommit": {"oid": "28214045ae9d3c7240c10c0def7793adaf3b8b7d"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg0MTgwNg==", "bodyText": "Done.", "url": "https://github.com/ConsenSys/teku/pull/1144#discussion_r376841806", "createdAt": "2020-02-10T01:57:49Z", "author": {"login": "cemozerr"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconBlockHandler.java", "diffHunk": "@@ -15,60 +15,79 @@\n \n import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_start_slot_at_epoch;\n \n+import com.google.common.eventbus.EventBus;\n import com.google.common.primitives.UnsignedLong;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Optional;\n+import org.apache.commons.lang3.tuple.Pair;\n import org.apache.tuweni.bytes.Bytes32;\n import tech.pegasys.artemis.beaconrestapi.handlerinterfaces.BeaconRestApiHandler;\n import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.blocks.SignedBeaconBlock;\n import tech.pegasys.artemis.storage.ChainStorageClient;\n+import tech.pegasys.artemis.storage.HistoricalChainData;\n \n public class BeaconBlockHandler implements BeaconRestApiHandler {\n \n   private final ChainStorageClient client;\n+  private final HistoricalChainData historicalChainData;\n \n-  public BeaconBlockHandler(ChainStorageClient client) {\n+  public BeaconBlockHandler(ChainStorageClient client, EventBus eventBus) {\n     this.client = client;\n+    this.historicalChainData = new HistoricalChainData(eventBus);\n   }\n \n   @Override\n   public String getPath() {\n-    return \"/beacon/block/\";\n+    return \"/beacon/block\";\n   }\n \n   @Override\n   public Object handleRequest(RequestParams param) {\n     Map<String, List<String>> queryParamMap = param.getQueryParamMap();\n-    Map<String, Object> jsonObject = new HashMap<>();\n-    BeaconBlock block;\n-    Bytes32 blockRoot;\n     if (queryParamMap.containsKey(\"root\")) {\n       Bytes32 root = Bytes32.fromHexString(param.getQueryParam(\"root\"));\n       return client.getStore() != null ? client.getStore().getBlock(root) : null;\n-    } else if (queryParamMap.containsKey(\"epoch\")) {\n-      UnsignedLong epoch = UnsignedLong.valueOf(param.getQueryParam(\"epoch\"));\n-      Optional<Bytes32> blockRootAtSlot =\n-          client.getBlockRootBySlot(compute_start_slot_at_epoch(epoch));\n-      blockRoot = blockRootAtSlot.orElse(null);\n-      block =\n-          client.getStore() != null && blockRootAtSlot.isPresent()\n-              ? client.getStore().getBlock(blockRootAtSlot.get())\n-              : null;\n+    }\n+\n+    UnsignedLong slot;\n+    if (queryParamMap.containsKey(\"epoch\")) {\n+      slot = compute_start_slot_at_epoch(UnsignedLong.valueOf(param.getQueryParam(\"epoch\")));\n     } else if (queryParamMap.containsKey(\"slot\")) {\n-      UnsignedLong slot = UnsignedLong.valueOf(param.getQueryParam(\"slot\"));\n-      Optional<Bytes32> blockRootAtSlot = client.getBlockRootBySlot(slot);\n-      blockRoot = blockRootAtSlot.orElse(null);\n-      block =\n-          client.getStore() != null && blockRootAtSlot.isPresent()\n-              ? client.getStore().getBlock(blockRootAtSlot.get())\n-              : null;\n+      slot = UnsignedLong.valueOf(param.getQueryParam(\"slot\"));\n     } else {\n       return null;\n     }\n-    jsonObject.put(\"block\", block);\n-    jsonObject.put(\"blockRoot\", blockRoot.toHexString());\n+\n+    Optional<Pair<BeaconBlock, Bytes32>> blockAndRoot = getBlockBySlot(slot);\n+    if (blockAndRoot.isEmpty()) {\n+      return null;\n+    }\n+\n+    Map<String, Object> jsonObject = new HashMap<>();\n+    jsonObject.put(\"blockRoot\", blockAndRoot.get().getRight().toHexString());\n+    jsonObject.put(\"block\", blockAndRoot.get().getLeft());\n+\n     return jsonObject;\n   }\n+\n+  private Optional<Pair<BeaconBlock, Bytes32>> getBlockBySlot(UnsignedLong slot) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgzMDA0OA=="}, "originalCommit": {"oid": "28214045ae9d3c7240c10c0def7793adaf3b8b7d"}, "originalPosition": 85}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2852, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}