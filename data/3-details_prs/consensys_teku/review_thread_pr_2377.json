{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMjQ1NjEy", "number": 2377, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODozODo1MVrOEPoz7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODozOTozM1rOEPo0ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0ODMyNzQ4OnYy", "diffSide": "RIGHT", "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/util/BlockProcessorUtilTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODozODo1MVrOGzdX3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwNzozMjowM1rOGzmgJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxMTgwNg==", "bodyText": "(optional) Might be worth trying to dedupe some of this logic with a helper method that sets up and processes the state & deposits and returns the resulting state.", "url": "https://github.com/ConsenSys/teku/pull/2377#discussion_r456611806", "createdAt": "2020-07-17T18:38:51Z", "author": {"login": "mbaxter"}, "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/util/BlockProcessorUtilTest.java", "diffHunk": "@@ -42,18 +46,31 @@\n   private final DataStructureUtil dataStructureUtil = new DataStructureUtil();\n \n   @Test\n-  @Disabled\n   void processDepositAddsNewValidatorWhenPubkeyIsNotFoundInRegistry()\n       throws BlockProcessingException {\n-    // Data Setup\n-    SSZList<DepositWithIndex> deposits = dataStructureUtil.newDeposits(1);\n-    Deposit deposit = deposits.get(0);\n-    DepositData depositInput = deposit.getData();\n+    // Create a deposit\n+    DepositData depositInput = dataStructureUtil.randomDepositData();\n     BLSPublicKey pubkey = depositInput.getPubkey();\n     Bytes32 withdrawalCredentials = depositInput.getWithdrawal_credentials();\n-    UnsignedLong amount = deposit.getData().getAmount();\n-\n-    BeaconState beaconState = createBeaconState();\n+    UnsignedLong amount = depositInput.getAmount();\n+\n+    // Add the deposit to a Merkle tree so that we can get the root to put into the state\n+    MerkleTree depositMerkleTree = new OptimizedMerkleTree(Constants.DEPOSIT_CONTRACT_TREE_DEPTH);\n+    depositMerkleTree.add(depositInput.hash_tree_root());\n+\n+    // Create the state and insert the Merkle root of the deposit data\n+    BeaconState beaconState =\n+        createBeaconState()\n+            .updated(\n+                state ->\n+                    state.setEth1_data(\n+                        new Eth1Data(\n+                            depositMerkleTree.getRoot(), UnsignedLong.valueOf(1), Bytes32.ZERO)));\n+\n+    SSZMutableList<DepositWithIndex> deposits =\n+        SSZList.createMutable(DepositWithIndex.class, Constants.MAX_DEPOSITS);\n+    deposits.add(\n+        new DepositWithIndex(depositMerkleTree.getProof(0), depositInput, UnsignedLong.valueOf(0)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02198a5bfd334d5edf3c9f74ebfc4001ddd664e4"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc2MTM4Mw==", "bodyText": "Heh, busted. Yes, I was too lazy to do this. Now done.", "url": "https://github.com/ConsenSys/teku/pull/2377#discussion_r456761383", "createdAt": "2020-07-18T07:32:03Z", "author": {"login": "benjaminion"}, "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/util/BlockProcessorUtilTest.java", "diffHunk": "@@ -42,18 +46,31 @@\n   private final DataStructureUtil dataStructureUtil = new DataStructureUtil();\n \n   @Test\n-  @Disabled\n   void processDepositAddsNewValidatorWhenPubkeyIsNotFoundInRegistry()\n       throws BlockProcessingException {\n-    // Data Setup\n-    SSZList<DepositWithIndex> deposits = dataStructureUtil.newDeposits(1);\n-    Deposit deposit = deposits.get(0);\n-    DepositData depositInput = deposit.getData();\n+    // Create a deposit\n+    DepositData depositInput = dataStructureUtil.randomDepositData();\n     BLSPublicKey pubkey = depositInput.getPubkey();\n     Bytes32 withdrawalCredentials = depositInput.getWithdrawal_credentials();\n-    UnsignedLong amount = deposit.getData().getAmount();\n-\n-    BeaconState beaconState = createBeaconState();\n+    UnsignedLong amount = depositInput.getAmount();\n+\n+    // Add the deposit to a Merkle tree so that we can get the root to put into the state\n+    MerkleTree depositMerkleTree = new OptimizedMerkleTree(Constants.DEPOSIT_CONTRACT_TREE_DEPTH);\n+    depositMerkleTree.add(depositInput.hash_tree_root());\n+\n+    // Create the state and insert the Merkle root of the deposit data\n+    BeaconState beaconState =\n+        createBeaconState()\n+            .updated(\n+                state ->\n+                    state.setEth1_data(\n+                        new Eth1Data(\n+                            depositMerkleTree.getRoot(), UnsignedLong.valueOf(1), Bytes32.ZERO)));\n+\n+    SSZMutableList<DepositWithIndex> deposits =\n+        SSZList.createMutable(DepositWithIndex.class, Constants.MAX_DEPOSITS);\n+    deposits.add(\n+        new DepositWithIndex(depositMerkleTree.getProof(0), depositInput, UnsignedLong.valueOf(0)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxMTgwNg=="}, "originalCommit": {"oid": "02198a5bfd334d5edf3c9f74ebfc4001ddd664e4"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0ODMyOTMxOnYy", "diffSide": "RIGHT", "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/util/BlockProcessorUtilTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODozOTozM1rOGzdZDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwNzozMToxMlrOGzmf8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxMjExMQ==", "bodyText": "(optional) Maybe we should verify that all of the balances are unchanged.", "url": "https://github.com/ConsenSys/teku/pull/2377#discussion_r456612111", "createdAt": "2020-07-17T18:39:33Z", "author": {"login": "mbaxter"}, "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/util/BlockProcessorUtilTest.java", "diffHunk": "@@ -127,6 +156,56 @@ void processDepositTopsUpValidatorBalanceWhenPubkeyIsFoundInRegistry()\n         beaconState.getBalances().get(originalValidatorBalancesSize - 1));\n   }\n \n+  @Test\n+  void processDepositHandlesDepositWithInvalidPublicKey() throws BlockProcessingException {\n+    // The following deposit uses a \"rogue\" public key that is not in the G1 group\n+    BLSPublicKey pubkey =\n+        BLSPublicKey.fromBytesCompressed(\n+            Bytes.fromHexString(\n+                \"0x9378a6e3984e96d2cd50450c76ca14732f1300efa04aecdb805b22e6d6926a85ef409e8f3acf494a1481090bf32ce3bd\"));\n+    Bytes32 withdrawalCredentials =\n+        Bytes32.fromHexString(\"0x79e43d39ee55749c55994a7ab2a3cb91460cec544fdbf27eb5717c43f970c1b6\");\n+    UnsignedLong amount = UnsignedLong.valueOf(1000000000L);\n+    BLSSignature signature =\n+        BLSSignature.fromBytes(\n+            Bytes.fromHexString(\n+                \"0xddc1ca509e29c6452441069f26da6e073589b3bd1cace50e3427426af5bfdd566d077d4bdf618e249061b9770471e3d515779aa758b8ccb4b06226a8d5ebc99e19d4c3278e5006b837985bec4e0ce39df92c1f88d1afd0f98dbae360024a390d\"));\n+    DepositData depositInput =\n+        new DepositData(new DepositMessage(pubkey, withdrawalCredentials, amount), signature);\n+\n+    // Add the deposit to a Merkle tree so that we can get the root to put into the state\n+    MerkleTree depositMerkleTree = new OptimizedMerkleTree(Constants.DEPOSIT_CONTRACT_TREE_DEPTH);\n+    depositMerkleTree.add(depositInput.hash_tree_root());\n+\n+    // Create the state and insert the Merkle root of the deposit data\n+    BeaconState beaconState =\n+        createBeaconState()\n+            .updated(\n+                state ->\n+                    state.setEth1_data(\n+                        new Eth1Data(\n+                            depositMerkleTree.getRoot(), UnsignedLong.valueOf(1), Bytes32.ZERO)));\n+\n+    SSZMutableList<DepositWithIndex> deposits =\n+        SSZList.createMutable(DepositWithIndex.class, Constants.MAX_DEPOSITS);\n+    deposits.add(\n+        new DepositWithIndex(depositMerkleTree.getProof(0), depositInput, UnsignedLong.valueOf(0)));\n+\n+    int originalValidatorRegistrySize = beaconState.getValidators().size();\n+    int originalValidatorBalancesSize = beaconState.getBalances().size();\n+\n+    // Attempt to process deposit with above data. We expect to fail, but not throw an exception.\n+    beaconState =\n+        beaconState.updated(state -> BlockProcessorUtil.process_deposits(state, deposits));\n+\n+    assertTrue(\n+        beaconState.getValidators().size() == originalValidatorRegistrySize,\n+        \"The validator was added to the validator registry.\");\n+    assertTrue(\n+        beaconState.getBalances().size() == originalValidatorBalancesSize,\n+        \"The balance was added to the validator balances.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02198a5bfd334d5edf3c9f74ebfc4001ddd664e4"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njc2MTMyOA==", "bodyText": "Good idea. Done.", "url": "https://github.com/ConsenSys/teku/pull/2377#discussion_r456761328", "createdAt": "2020-07-18T07:31:12Z", "author": {"login": "benjaminion"}, "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/util/BlockProcessorUtilTest.java", "diffHunk": "@@ -127,6 +156,56 @@ void processDepositTopsUpValidatorBalanceWhenPubkeyIsFoundInRegistry()\n         beaconState.getBalances().get(originalValidatorBalancesSize - 1));\n   }\n \n+  @Test\n+  void processDepositHandlesDepositWithInvalidPublicKey() throws BlockProcessingException {\n+    // The following deposit uses a \"rogue\" public key that is not in the G1 group\n+    BLSPublicKey pubkey =\n+        BLSPublicKey.fromBytesCompressed(\n+            Bytes.fromHexString(\n+                \"0x9378a6e3984e96d2cd50450c76ca14732f1300efa04aecdb805b22e6d6926a85ef409e8f3acf494a1481090bf32ce3bd\"));\n+    Bytes32 withdrawalCredentials =\n+        Bytes32.fromHexString(\"0x79e43d39ee55749c55994a7ab2a3cb91460cec544fdbf27eb5717c43f970c1b6\");\n+    UnsignedLong amount = UnsignedLong.valueOf(1000000000L);\n+    BLSSignature signature =\n+        BLSSignature.fromBytes(\n+            Bytes.fromHexString(\n+                \"0xddc1ca509e29c6452441069f26da6e073589b3bd1cace50e3427426af5bfdd566d077d4bdf618e249061b9770471e3d515779aa758b8ccb4b06226a8d5ebc99e19d4c3278e5006b837985bec4e0ce39df92c1f88d1afd0f98dbae360024a390d\"));\n+    DepositData depositInput =\n+        new DepositData(new DepositMessage(pubkey, withdrawalCredentials, amount), signature);\n+\n+    // Add the deposit to a Merkle tree so that we can get the root to put into the state\n+    MerkleTree depositMerkleTree = new OptimizedMerkleTree(Constants.DEPOSIT_CONTRACT_TREE_DEPTH);\n+    depositMerkleTree.add(depositInput.hash_tree_root());\n+\n+    // Create the state and insert the Merkle root of the deposit data\n+    BeaconState beaconState =\n+        createBeaconState()\n+            .updated(\n+                state ->\n+                    state.setEth1_data(\n+                        new Eth1Data(\n+                            depositMerkleTree.getRoot(), UnsignedLong.valueOf(1), Bytes32.ZERO)));\n+\n+    SSZMutableList<DepositWithIndex> deposits =\n+        SSZList.createMutable(DepositWithIndex.class, Constants.MAX_DEPOSITS);\n+    deposits.add(\n+        new DepositWithIndex(depositMerkleTree.getProof(0), depositInput, UnsignedLong.valueOf(0)));\n+\n+    int originalValidatorRegistrySize = beaconState.getValidators().size();\n+    int originalValidatorBalancesSize = beaconState.getBalances().size();\n+\n+    // Attempt to process deposit with above data. We expect to fail, but not throw an exception.\n+    beaconState =\n+        beaconState.updated(state -> BlockProcessorUtil.process_deposits(state, deposits));\n+\n+    assertTrue(\n+        beaconState.getValidators().size() == originalValidatorRegistrySize,\n+        \"The validator was added to the validator registry.\");\n+    assertTrue(\n+        beaconState.getBalances().size() == originalValidatorBalancesSize,\n+        \"The balance was added to the validator balances.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxMjExMQ=="}, "originalCommit": {"oid": "02198a5bfd334d5edf3c9f74ebfc4001ddd664e4"}, "originalPosition": 167}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3407, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}