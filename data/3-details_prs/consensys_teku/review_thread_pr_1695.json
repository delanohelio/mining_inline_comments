{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNzU0NjYz", "number": 1695, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMTowNDoxNFrOD3zQGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNTo1OTowOVrOD7gC8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5ODM3OTc3OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMTowNDoxNFrOGOQ7PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwOTo0MToxOVrOGP5P9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxMDU1Nw==", "bodyText": "Isn't there a race condition here? We'd need to wait until the rest api service has actually started listening.", "url": "https://github.com/ConsenSys/teku/pull/1695#discussion_r417610557", "createdAt": "2020-04-29T21:04:14Z", "author": {"login": "ajsutton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -266,57 +268,101 @@ jobs:\n             docker login --username \"${DOCKER_USER}\" --password \"${DOCKER_PASSWORD}\"\n             ./gradlew --no-daemon --parallel \"-Pbranch=${CIRCLE_BRANCH}\" dockerUpload\n \n+  publishAPIDoc:\n+    executor: medium_executor\n+    steps:\n+      - prepare\n+      - add_ssh_keys:\n+          fingerprints:\n+            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+      - run:\n+          name: Build runnable Teku binaries\n+          command: |\n+            ./gradlew --no-daemon --parallel installDist\n+      - run:\n+          name: Extract OpenAPI JSON\n+          command: |\n+            build/install/teku/bin/teku --rest-api-docs-enabled=true &\n+            TEKU_PID=$!\n+            wget -O api.json http://localhost:5051/swagger-docs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab23f03c0f28ee47c6dcbf42ac0547d632bd710a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMxOTc5OQ==", "bodyText": "wget does some retries.", "url": "https://github.com/ConsenSys/teku/pull/1695#discussion_r419319799", "createdAt": "2020-05-04T09:41:19Z", "author": {"login": "NicolasMassart"}, "path": ".circleci/config.yml", "diffHunk": "@@ -266,57 +268,101 @@ jobs:\n             docker login --username \"${DOCKER_USER}\" --password \"${DOCKER_PASSWORD}\"\n             ./gradlew --no-daemon --parallel \"-Pbranch=${CIRCLE_BRANCH}\" dockerUpload\n \n+  publishAPIDoc:\n+    executor: medium_executor\n+    steps:\n+      - prepare\n+      - add_ssh_keys:\n+          fingerprints:\n+            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+      - run:\n+          name: Build runnable Teku binaries\n+          command: |\n+            ./gradlew --no-daemon --parallel installDist\n+      - run:\n+          name: Extract OpenAPI JSON\n+          command: |\n+            build/install/teku/bin/teku --rest-api-docs-enabled=true &\n+            TEKU_PID=$!\n+            wget -O api.json http://localhost:5051/swagger-docs", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxMDU1Nw=="}, "originalCommit": {"oid": "ab23f03c0f28ee47c6dcbf42ac0547d632bd710a"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzE3MzkwOnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNTo1ODoxMFrOGT3HXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMToyNzoxM1rOGVu2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3OTEzMw==", "bodyText": "This has a race condition because Teku won't be listening the instant it's started.  We need something to retry for a period until the API is actually listening.  I would suggest splitting the script to do that into it's own file so that the circleci config stays as focussed on circleci specific stuff as possible.", "url": "https://github.com/ConsenSys/teku/pull/1695#discussion_r423479133", "createdAt": "2020-05-12T05:58:10Z", "author": {"login": "ajsutton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -266,6 +272,76 @@ jobs:\n             docker login --username \"${DOCKER_USER}\" --password \"${DOCKER_PASSWORD}\"\n             ./gradlew --no-daemon --parallel \"-Pbranch=${CIRCLE_BRANCH}\" dockerUpload\n \n+  extractAPISpec:\n+    executor: medium_executor\n+    steps:\n+      - prepare\n+      - attach_workspace:\n+          at: ~/project\n+      - run:\n+          name: Build runnable Teku binaries\n+          command: |\n+            ./gradlew --no-daemon --parallel installDist\n+      - run:\n+          name: Extract OpenAPI JSON\n+          command: |\n+            build/install/teku/bin/teku --network=schlesi --rest-api-docs-enabled=true &\n+            TEKU_PID=$!\n+            wget -O openapi.json http://localhost:5051/swagger-docs\n+            kill $TEKU_PID", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cbc8f630052b7274e4d5676007ef7f1a36ace36"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkxNzUxOA==", "bodyText": "As I already explained in a previous comment, there's no race condition here. Wget is retrying 20 times until it has a 200 code.", "url": "https://github.com/ConsenSys/teku/pull/1695#discussion_r424917518", "createdAt": "2020-05-14T07:12:40Z", "author": {"login": "NicolasMassart"}, "path": ".circleci/config.yml", "diffHunk": "@@ -266,6 +272,76 @@ jobs:\n             docker login --username \"${DOCKER_USER}\" --password \"${DOCKER_PASSWORD}\"\n             ./gradlew --no-daemon --parallel \"-Pbranch=${CIRCLE_BRANCH}\" dockerUpload\n \n+  extractAPISpec:\n+    executor: medium_executor\n+    steps:\n+      - prepare\n+      - attach_workspace:\n+          at: ~/project\n+      - run:\n+          name: Build runnable Teku binaries\n+          command: |\n+            ./gradlew --no-daemon --parallel installDist\n+      - run:\n+          name: Extract OpenAPI JSON\n+          command: |\n+            build/install/teku/bin/teku --network=schlesi --rest-api-docs-enabled=true &\n+            TEKU_PID=$!\n+            wget -O openapi.json http://localhost:5051/swagger-docs\n+            kill $TEKU_PID", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3OTEzMw=="}, "originalCommit": {"oid": "5cbc8f630052b7274e4d5676007ef7f1a36ace36"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0MDgxOQ==", "bodyText": "Ah right, I didn't see that response because it got resolved before I had a chance to see it.", "url": "https://github.com/ConsenSys/teku/pull/1695#discussion_r425440819", "createdAt": "2020-05-14T21:27:13Z", "author": {"login": "ajsutton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -266,6 +272,76 @@ jobs:\n             docker login --username \"${DOCKER_USER}\" --password \"${DOCKER_PASSWORD}\"\n             ./gradlew --no-daemon --parallel \"-Pbranch=${CIRCLE_BRANCH}\" dockerUpload\n \n+  extractAPISpec:\n+    executor: medium_executor\n+    steps:\n+      - prepare\n+      - attach_workspace:\n+          at: ~/project\n+      - run:\n+          name: Build runnable Teku binaries\n+          command: |\n+            ./gradlew --no-daemon --parallel installDist\n+      - run:\n+          name: Extract OpenAPI JSON\n+          command: |\n+            build/install/teku/bin/teku --network=schlesi --rest-api-docs-enabled=true &\n+            TEKU_PID=$!\n+            wget -O openapi.json http://localhost:5051/swagger-docs\n+            kill $TEKU_PID", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3OTEzMw=="}, "originalCommit": {"oid": "5cbc8f630052b7274e4d5676007ef7f1a36ace36"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzE3NjE5OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNTo1OTowOVrOGT3Iqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOTowNDoyNVrOGVqVUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3OTQ2Nw==", "bodyText": "Would this be:\ngit checkout \"$BRANCH\" && git pull || git checkout -b \"$BRANCH\"\nie only pull the branch if it already existed.", "url": "https://github.com/ConsenSys/teku/pull/1695#discussion_r423479467", "createdAt": "2020-05-12T05:59:09Z", "author": {"login": "ajsutton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -266,6 +272,76 @@ jobs:\n             docker login --username \"${DOCKER_USER}\" --password \"${DOCKER_PASSWORD}\"\n             ./gradlew --no-daemon --parallel \"-Pbranch=${CIRCLE_BRANCH}\" dockerUpload\n \n+  extractAPISpec:\n+    executor: medium_executor\n+    steps:\n+      - prepare\n+      - attach_workspace:\n+          at: ~/project\n+      - run:\n+          name: Build runnable Teku binaries\n+          command: |\n+            ./gradlew --no-daemon --parallel installDist\n+      - run:\n+          name: Extract OpenAPI JSON\n+          command: |\n+            build/install/teku/bin/teku --network=schlesi --rest-api-docs-enabled=true &\n+            TEKU_PID=$!\n+            wget -O openapi.json http://localhost:5051/swagger-docs\n+            kill $TEKU_PID\n+      - persist_to_workspace:\n+          root: ~/project\n+          paths:\n+            - ./\n+\n+  publishAPIDoc:\n+    executor: node_executor\n+    steps:\n+      - checkout\n+      - attach_workspace:\n+          at: /tmp/project\n+      - add_ssh_keys:\n+          fingerprints:\n+            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+      - run:\n+          name: Set Git user params\n+          command: |\n+            git config --global user.name $CIRCLE_USERNAME\n+            git config --global user.email \"${CIRCLE_USERNAME}@users.noreply.github.com\"\n+      - run:\n+          name: Chechout GitHub Pages branch\n+          command: |\n+            readonly BRANCH='gh-pages'\n+            git checkout \"$BRANCH\" || git checkout -b \"$BRANCH\"\n+            # pull might fail if the branch was just created\n+            git pull || true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cbc8f630052b7274e4d5676007ef7f1a36ace36"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkxNzkzOA==", "bodyText": "@benjamincburns you wrote these lines, do you have any comments on this please?", "url": "https://github.com/ConsenSys/teku/pull/1695#discussion_r424917938", "createdAt": "2020-05-14T07:13:31Z", "author": {"login": "NicolasMassart"}, "path": ".circleci/config.yml", "diffHunk": "@@ -266,6 +272,76 @@ jobs:\n             docker login --username \"${DOCKER_USER}\" --password \"${DOCKER_PASSWORD}\"\n             ./gradlew --no-daemon --parallel \"-Pbranch=${CIRCLE_BRANCH}\" dockerUpload\n \n+  extractAPISpec:\n+    executor: medium_executor\n+    steps:\n+      - prepare\n+      - attach_workspace:\n+          at: ~/project\n+      - run:\n+          name: Build runnable Teku binaries\n+          command: |\n+            ./gradlew --no-daemon --parallel installDist\n+      - run:\n+          name: Extract OpenAPI JSON\n+          command: |\n+            build/install/teku/bin/teku --network=schlesi --rest-api-docs-enabled=true &\n+            TEKU_PID=$!\n+            wget -O openapi.json http://localhost:5051/swagger-docs\n+            kill $TEKU_PID\n+      - persist_to_workspace:\n+          root: ~/project\n+          paths:\n+            - ./\n+\n+  publishAPIDoc:\n+    executor: node_executor\n+    steps:\n+      - checkout\n+      - attach_workspace:\n+          at: /tmp/project\n+      - add_ssh_keys:\n+          fingerprints:\n+            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+      - run:\n+          name: Set Git user params\n+          command: |\n+            git config --global user.name $CIRCLE_USERNAME\n+            git config --global user.email \"${CIRCLE_USERNAME}@users.noreply.github.com\"\n+      - run:\n+          name: Chechout GitHub Pages branch\n+          command: |\n+            readonly BRANCH='gh-pages'\n+            git checkout \"$BRANCH\" || git checkout -b \"$BRANCH\"\n+            # pull might fail if the branch was just created\n+            git pull || true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3OTQ2Nw=="}, "originalCommit": {"oid": "5cbc8f630052b7274e4d5676007ef7f1a36ace36"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM2Njg2Nw==", "bodyText": "Ignore my last (deleted) comment - I had my wires crossed.\nI think @ajsutton's suggestion is functionally equivalent to the code that we already have, but it'll save some noise in the build log if you change line 315 to what he has, and delete lines 316 and 317.\nAlso if the git pull fails in the one-liner that he suggested, it'll cause the git checkout -b \"$BRANCH\" statement to execute, which will also fail, causing the entire build to fail, however the build log might make the reason for the failure a little obscure. A better approach overall would be replace lines 315:317 with something like\nif [ git branch | grep -q \"$BRANCH\" ]; then\n  git checkout \"$BRANCH\"\n  git pull\nelse\n  git checkout -b \"$BRANCH\"\nfi\nBut this is likely overkill and I think any of the suggestions will work fine.", "url": "https://github.com/ConsenSys/teku/pull/1695#discussion_r425366867", "createdAt": "2020-05-14T19:04:25Z", "author": {"login": "benjamincburns"}, "path": ".circleci/config.yml", "diffHunk": "@@ -266,6 +272,76 @@ jobs:\n             docker login --username \"${DOCKER_USER}\" --password \"${DOCKER_PASSWORD}\"\n             ./gradlew --no-daemon --parallel \"-Pbranch=${CIRCLE_BRANCH}\" dockerUpload\n \n+  extractAPISpec:\n+    executor: medium_executor\n+    steps:\n+      - prepare\n+      - attach_workspace:\n+          at: ~/project\n+      - run:\n+          name: Build runnable Teku binaries\n+          command: |\n+            ./gradlew --no-daemon --parallel installDist\n+      - run:\n+          name: Extract OpenAPI JSON\n+          command: |\n+            build/install/teku/bin/teku --network=schlesi --rest-api-docs-enabled=true &\n+            TEKU_PID=$!\n+            wget -O openapi.json http://localhost:5051/swagger-docs\n+            kill $TEKU_PID\n+      - persist_to_workspace:\n+          root: ~/project\n+          paths:\n+            - ./\n+\n+  publishAPIDoc:\n+    executor: node_executor\n+    steps:\n+      - checkout\n+      - attach_workspace:\n+          at: /tmp/project\n+      - add_ssh_keys:\n+          fingerprints:\n+            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+      - run:\n+          name: Set Git user params\n+          command: |\n+            git config --global user.name $CIRCLE_USERNAME\n+            git config --global user.email \"${CIRCLE_USERNAME}@users.noreply.github.com\"\n+      - run:\n+          name: Chechout GitHub Pages branch\n+          command: |\n+            readonly BRANCH='gh-pages'\n+            git checkout \"$BRANCH\" || git checkout -b \"$BRANCH\"\n+            # pull might fail if the branch was just created\n+            git pull || true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3OTQ2Nw=="}, "originalCommit": {"oid": "5cbc8f630052b7274e4d5676007ef7f1a36ace36"}, "originalPosition": 64}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3739, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}