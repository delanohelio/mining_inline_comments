{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzODQzOTU5", "number": 3124, "title": "Migrate away from protoarray snapshots", "bodyText": "PR Description\nAs a first step towards moving the protoarray into Store rather than maintaining a separate BlockTree, rebuild the protoarray entirely based off of the stored hot blocks.  The justified epoch and finalized epoch information is now stored for each block, along with the block itself.  This information was already available as part of importing the block.\nOne first run, the protoarray is loaded from snapshot as usual, regenerating states for any blocks in the store but not the snapshot.  The checkpoint epochs are then stored for each hot block.  As blocks are added the checkpoint epochs are stored along with the new block.\nOn subsequent loads, the database iterates through hot blocks and loads the block metadata that is required for each protoarray node (slot, root, parentRoot, stateRoot, justifiedEpoch, finalizedEpoch) instead of just (slot, root, parentRoot) which was required to create the store.  Maps.transformValues is used to provide a view of the block metadata map in the form the current store creation requires (root->parentRoot and root->slot) without having to copy the entire map.\nFixed Issue(s)\n#2832\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-11-02T07:06:28Z", "url": "https://github.com/ConsenSys/teku/pull/3124", "merged": true, "mergeCommit": {"oid": "81244a903ef04f8d3b0d5c6e61fb3ec55826da85"}, "closed": true, "closedAt": "2020-11-05T04:27:46Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYd_fmgH2gAyNTEzODQzOTU5OjIyZGFiYjA2N2JiOTVlZWUxMzRmNjYzNDNkMWVlNTFlNzNkN2Y4ZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZZhM5AH2gAyNTEzODQzOTU5OmUyNjBiYzllNWY1MzFmMzBjZmQ2ZmVjMDIzODYzYzM0Nzk1NWYxMGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "22dabb067bb95eee134f66343d1ee51e73d7f8f2", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/22dabb067bb95eee134f66343d1ee51e73d7f8f2", "committedDate": "2020-11-02T05:48:01Z", "message": "Store checkpoint epochs with new blocks.\nLoad full block information when creating store. Currently still loading protoarray from snapshot and no migration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22b95878d483eedf7d8b611d763a933a9489a18a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/22b95878d483eedf7d8b611d763a933a9489a18a", "committedDate": "2020-11-02T06:55:49Z", "message": "Load protoarray from same block information used for store.\nAdd migration to store checkpoint epochs when not already present."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d449e30ea4210318a1303258ffeb7e7b7e7e45df", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d449e30ea4210318a1303258ffeb7e7b7e7e45df", "committedDate": "2020-11-02T07:01:32Z", "message": "Delete protoarray snapshot after migration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f872514e00d0d8eb32e4faf04f1300283169e982", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/f872514e00d0d8eb32e4faf04f1300283169e982", "committedDate": "2020-11-02T07:24:57Z", "message": "Update tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "227af7ff8392a8bb78057d58f833395e48a21704", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/227af7ff8392a8bb78057d58f833395e48a21704", "committedDate": "2020-11-02T07:25:04Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b863ef19023f1b1e30bf1eab8d11df5c728f701", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8b863ef19023f1b1e30bf1eab8d11df5c728f701", "committedDate": "2020-11-02T20:17:13Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c4e7f68c1117021d9a351a11558603da0e67bb7", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6c4e7f68c1117021d9a351a11558603da0e67bb7", "committedDate": "2020-11-02T20:20:22Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e388758d187eeded56f6bdf16d28b2d637686ca", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7e388758d187eeded56f6bdf16d28b2d637686ca", "committedDate": "2020-11-03T00:36:26Z", "message": "Add more tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4efe624f6c0da7c6a250e5e949b2e849b4dac433", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4efe624f6c0da7c6a250e5e949b2e849b4dac433", "committedDate": "2020-11-03T00:50:31Z", "message": "Errorprone."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d970957358c47a20ae4aea13973bb6628aa6e7", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a3d970957358c47a20ae4aea13973bb6628aa6e7", "committedDate": "2020-11-03T01:10:55Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots\n\n# Conflicts:\n#\tstorage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java\n#\tstorage/src/main/java/tech/pegasys/teku/storage/store/StoreBuilder.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17f0484f9ad1d03f09d6d1d9437651265ea09c4e", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/17f0484f9ad1d03f09d6d1d9437651265ea09c4e", "committedDate": "2020-11-03T20:52:06Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b6832b795a29d71493de05f257c436e9cf5396d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0b6832b795a29d71493de05f257c436e9cf5396d", "committedDate": "2020-11-04T00:47:47Z", "message": "Merge branch 'master' into no-proto-snapshots"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDA1MDc0", "url": "https://github.com/ConsenSys/teku/pull/3124#pullrequestreview-523005074", "createdAt": "2020-11-04T02:32:21Z", "commit": {"oid": "0b6832b795a29d71493de05f257c436e9cf5396d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNjE3ODE2", "url": "https://github.com/ConsenSys/teku/pull/3124#pullrequestreview-523617816", "createdAt": "2020-11-04T18:14:19Z", "commit": {"oid": "0b6832b795a29d71493de05f257c436e9cf5396d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxODoxNDoyMFrOHtkFsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxODoxNDoyMFrOHtkFsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzOTI0OQ==", "bodyText": "I think this should be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          new CheckpointEpochs(anchorCheckpoint.getEpoch(), anchorCheckpoint.getEpoch())));\n          \n          \n            \n                          new CheckpointEpochs(anchorState.getCurrent_justified_checkpoint().getEpoch(), anchorState.getFinalized_checkpoint().getEpoch())));", "url": "https://github.com/ConsenSys/teku/pull/3124#discussion_r517539249", "createdAt": "2020-11-04T18:14:20Z", "author": {"login": "mbaxter"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java", "diffHunk": "@@ -207,7 +210,10 @@ public void storeInitialAnchor(final AnchorPoint anchor) {\n       // We need to store the anchor block in both hot and cold storage so that on restart\n       // we're guaranteed to have at least one block / state to load into RecentChainData.\n       // Save to hot storage\n-      hotUpdater.addHotBlock(anchorBlock);\n+      hotUpdater.addHotBlock(\n+          new BlockAndCheckpointEpochs(\n+              anchorBlock,\n+              new CheckpointEpochs(anchorCheckpoint.getEpoch(), anchorCheckpoint.getEpoch())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b6832b795a29d71493de05f257c436e9cf5396d"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a70710c0eae3dc06d34f9844c22a3d1d4a1165a4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a70710c0eae3dc06d34f9844c22a3d1d4a1165a4", "committedDate": "2020-11-04T21:04:46Z", "message": "Fix checkpoint epochs from anchor state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ab40848a47802d5cb1f92ac9e3901406da4e786", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/8ab40848a47802d5cb1f92ac9e3901406da4e786", "committedDate": "2020-11-04T21:05:13Z", "message": "Merge branch 'master' of github.com:ConsenSys/teku into no-proto-snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c07c9044cbf7e29241e5bf4e04d0d82da9d1b6c", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/1c07c9044cbf7e29241e5bf4e04d0d82da9d1b6c", "committedDate": "2020-11-04T21:05:27Z", "message": "Spotless."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ec60663ff2c6ec2e06c4f9487a5c848b8c46569", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4ec60663ff2c6ec2e06c4f9487a5c848b8c46569", "committedDate": "2020-11-04T21:07:42Z", "message": "Merge branch 'no-proto-snapshots' of github.com:ajsutton/teku into no-proto-snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c9ada95a6418f73faa877aad163435a01003897", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4c9ada95a6418f73faa877aad163435a01003897", "committedDate": "2020-11-05T00:43:59Z", "message": "Merge branch 'master' into no-proto-snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e260bc9e5f531f30cfd6fec023863c347955f10a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e260bc9e5f531f30cfd6fec023863c347955f10a", "committedDate": "2020-11-05T03:09:14Z", "message": "Merge branch 'master' into no-proto-snapshots"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3288, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}