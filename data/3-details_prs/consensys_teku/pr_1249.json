{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyMTMwMjI4", "number": 1249, "title": "Load BLS Keys from encrypted keystore", "bodyText": "PR Description\n\nModify Teku configuration to load BLS keys from encrypted keystores (in addition of unencrypted keys from yaml configuration file).\nIntroduce following configuration options:\n\nvalidator.keystoreFiles=[\"/path/to/keystore1.json\", \"/path/to/keystore2.json\"]\nvalidator.keystorePasswordFiles=[\"/path/to/ks1pass.txt\", \"/path/to/ks2pass.txt\"]\n\nFixed Issue(s)\n\n#1176", "createdAt": "2020-03-02T01:18:47Z", "url": "https://github.com/ConsenSys/teku/pull/1249", "merged": true, "mergeCommit": {"oid": "c8d7bf98e488b891d6a54b4b8b179c2747d11b1a"}, "closed": true, "closedAt": "2020-03-03T01:28:46Z", "author": {"login": "usmansaleem"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJhwSwgH2gAyMzgyMTMwMjI4OmI0ODNhMjMwNDY5YWZhNDRiYjI1MzBlN2Y4YTE3ZGQ3ZWQxZjVjOGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJ4F9yAFqTM2NzY0NjA2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b483a230469afa44bb2530e7f8a17dd7ed1f5c8d", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/b483a230469afa44bb2530e7f8a17dd7ed1f5c8d", "committedDate": "2020-03-01T23:31:01Z", "message": "Adding validator.validatorsKeystoreConfFile in artimis configuration class\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8e8b9421d498dff5dc3efa980cd2fb50e3132fe", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/a8e8b9421d498dff5dc3efa980cd2fb50e3132fe", "committedDate": "2020-03-02T01:14:56Z", "message": "Updating ValidatorLoader to load both from encrypted keystore and unencrypted yaml key provider\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dcdadeec4d614a8e09806f3b96cca8d858bc175", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/3dcdadeec4d614a8e09806f3b96cca8d858bc175", "committedDate": "2020-03-02T01:19:14Z", "message": "Merge remote-tracking branch 'upstream/master' into keystore_config_1176\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ad711146e01fab2cfbc7b70606114fa27cdf307", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/6ad711146e01fab2cfbc7b70606114fa27cdf307", "committedDate": "2020-03-02T01:21:31Z", "message": "removing unnecessary trim method\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2OTEwNTcy", "url": "https://github.com/ConsenSys/teku/pull/1249#pullrequestreview-366910572", "createdAt": "2020-03-02T01:27:20Z", "commit": {"oid": "6ad711146e01fab2cfbc7b70606114fa27cdf307"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwMToyNzoyMFrOFwRmOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwMToyNzoyMFrOFwRmOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE2NDI4Mg==", "bodyText": "Why do we need a config entry that points to another config file that lists the keystores?", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386164282", "createdAt": "2020-03-02T01:27:20Z", "author": {"login": "ajsutton"}, "path": "util/src/main/java/tech/pegasys/artemis/util/config/ArtemisConfiguration.java", "diffHunk": "@@ -54,6 +54,12 @@ static final Schema createSchema() {\n     builder.addString(\"node.bootnodes\", \"\", \"ENR of the bootnode\", null);\n     builder.addString(\n         \"validator.validatorsKeyFile\", \"\", \"The file to load validator keys from\", null);\n+    builder.addString(\n+        \"validator.validatorsKeystoreConfFile\",\n+        \"\",\n+        \"The file containing paths to encrypted keystore files and password files to decrypt them\",\n+        null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ad711146e01fab2cfbc7b70606114fa27cdf307"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "916a3b39816703e83b6fd29bac3dc09e1be50d96", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/916a3b39816703e83b6fd29bac3dc09e1be50d96", "committedDate": "2020-03-02T02:30:21Z", "message": "keystore files and keystore password files directly from artemis configuration instead of redirection to an intermediate configuration file\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10d1e89a88f737181ce4f6fda179e709f15b26c7", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/10d1e89a88f737181ce4f6fda179e709f15b26c7", "committedDate": "2020-03-02T03:12:17Z", "message": "Merge remote-tracking branch 'upstream/master' into keystore_config_1176\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96750d85e012e0ec850196d5b91e9b425d72f0eb", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/96750d85e012e0ec850196d5b91e9b425d72f0eb", "committedDate": "2020-03-02T03:16:39Z", "message": "Adding mock call to ValidatorCoordinatorTest\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "696b6aee9f5bd6e0a59475b78c5cf8348ec19484", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/696b6aee9f5bd6e0a59475b78c5cf8348ec19484", "committedDate": "2020-03-02T04:16:30Z", "message": "Merge remote-tracking branch 'upstream/master' into keystore_config_1176\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "752162514afaa3347f926d72f875bfaf85233fd7", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/752162514afaa3347f926d72f875bfaf85233fd7", "committedDate": "2020-03-02T04:53:22Z", "message": "Adding unit test cases for validator configurations\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f77e7b33f2cef47e3555ba18592d66283e2611ec", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/f77e7b33f2cef47e3555ba18592d66283e2611ec", "committedDate": "2020-03-02T05:20:30Z", "message": "Modify option names\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c3004cbe62ebbb432660ef9b2171756c2709861", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/8c3004cbe62ebbb432660ef9b2171756c2709861", "committedDate": "2020-03-02T05:59:11Z", "message": "keystore validator key provider logic\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "822a765eb50ee8cea8b7bbc31dd9b483b96039a5", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/822a765eb50ee8cea8b7bbc31dd9b483b96039a5", "committedDate": "2020-03-02T07:15:20Z", "message": "unit test cases for Keystore validator key provider\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e53948e8563833fceac2a966f28948192c818c6", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/4e53948e8563833fceac2a966f28948192c818c6", "committedDate": "2020-03-02T12:38:41Z", "message": "wrapping key store validation exception to illegalargumentexception to allow reporting error during initialization\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjEzODA5", "url": "https://github.com/ConsenSys/teku/pull/1249#pullrequestreview-367613809", "createdAt": "2020-03-02T23:51:44Z", "commit": {"oid": "4e53948e8563833fceac2a966f28948192c818c6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMDoxNDo0MlrOFw0C3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMDoxNDo0MlrOFw0C3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjcyODY3MA==", "bodyText": "You can just use:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return new ArrayList<>(\n          \n          \n            \n                    keystorePasswordFilePairs.stream()\n          \n          \n            \n                        .map(\n          \n          \n            \n                            pair -> {\n          \n          \n            \n                              final String password = loadPassword(pair.getRight());\n          \n          \n            \n                              final Bytes privKey = loadBLSPrivateKey(pair.getLeft(), password);\n          \n          \n            \n                              return new BLSKeyPair(new KeyPair(SecretKey.fromBytes(padLeft(privKey))));\n          \n          \n            \n                            })\n          \n          \n            \n                        .collect(\n          \n          \n            \n                            toMap(\n          \n          \n            \n                                blsKeyPair -> blsKeyPair.getPublicKey().toString(),\n          \n          \n            \n                                Function.identity(),\n          \n          \n            \n                                (dupKey1, dupKey2) -> dupKey2))\n          \n          \n            \n                        .values());\n          \n          \n            \n                 return keystorePasswordFilePairs.stream()\n          \n          \n            \n                    .map(pair -> padLeft(loadBLSPrivateKey(pair.getLeft(), loadPassword(pair.getRight()))))\n          \n          \n            \n                    .distinct()\n          \n          \n            \n                    .map(privKey -> new BLSKeyPair(new KeyPair(SecretKey.fromBytes(privKey))))\n          \n          \n            \n                    .collect(toList());", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386728670", "createdAt": "2020-03-03T00:14:42Z", "author": {"login": "ajsutton"}, "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/KeystoresValidatorKeyProvider.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.coordinator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+import static java.lang.String.format;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.stream.Collectors.toMap;\n+import static org.apache.commons.lang3.StringUtils.isEmpty;\n+import static tech.pegasys.artemis.util.alogger.ALogger.STDOUT;\n+\n+import com.google.common.io.Files;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Path;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Function;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.Level;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.bls.keystore.KeyStore;\n+import tech.pegasys.artemis.bls.keystore.KeyStoreLoader;\n+import tech.pegasys.artemis.bls.keystore.KeyStoreValidationException;\n+import tech.pegasys.artemis.bls.keystore.model.KeyStoreData;\n+import tech.pegasys.artemis.util.bls.BLSKeyPair;\n+import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n+import tech.pegasys.artemis.util.mikuli.KeyPair;\n+import tech.pegasys.artemis.util.mikuli.SecretKey;\n+\n+public class KeystoresValidatorKeyProvider implements ValidatorKeyProvider {\n+  static final int KEY_LENGTH = 48;\n+\n+  @Override\n+  public List<BLSKeyPair> loadValidatorKeys(final ArtemisConfiguration config) {\n+    final List<Pair<Path, Path>> keystorePasswordFilePairs =\n+        config.getValidatorKeystorePasswordFilePairs();\n+    checkNotNull(keystorePasswordFilePairs, \"validator keystore and password pairs cannot be null\");\n+\n+    // return distinct loaded key pairs\n+\n+    return new ArrayList<>(\n+        keystorePasswordFilePairs.stream()\n+            .map(\n+                pair -> {\n+                  final String password = loadPassword(pair.getRight());\n+                  final Bytes privKey = loadBLSPrivateKey(pair.getLeft(), password);\n+                  return new BLSKeyPair(new KeyPair(SecretKey.fromBytes(padLeft(privKey))));\n+                })\n+            .collect(\n+                toMap(\n+                    blsKeyPair -> blsKeyPair.getPublicKey().toString(),\n+                    Function.identity(),\n+                    (dupKey1, dupKey2) -> dupKey2))\n+            .values());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e53948e8563833fceac2a966f28948192c818c6"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e80f940a77d75375b254bc5f80fc99125f2f5e7", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/2e80f940a77d75375b254bc5f80fc99125f2f5e7", "committedDate": "2020-03-03T00:33:09Z", "message": "review suggestion - simplifying loadValidatorKeys\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a5db6b07f37bb93a1c046daa3c6ef6994ad3c9b", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/ConsenSys/teku/commit/9a5db6b07f37bb93a1c046daa3c6ef6994ad3c9b", "committedDate": "2020-03-03T00:59:09Z", "message": "Merge remote-tracking branch 'upstream/master' into keystore_config_1176\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NjQ2MDY2", "url": "https://github.com/ConsenSys/teku/pull/1249#pullrequestreview-367646066", "createdAt": "2020-03-03T01:24:52Z", "commit": {"oid": "9a5db6b07f37bb93a1c046daa3c6ef6994ad3c9b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToyNDo1MlrOFw1UXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMToyNzowOVrOFw1W9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc0OTUzNA==", "bodyText": "Be nice to pass in the values you are validating", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386749534", "createdAt": "2020-03-03T01:24:52Z", "author": {"login": "jframe"}, "path": "util/src/main/java/tech/pegasys/artemis/util/config/ArtemisConfiguration.java", "diffHunk": "@@ -313,6 +360,20 @@ public void validateConfig() throws IllegalArgumentException {\n     if (getNumValidators() < Constants.SLOTS_PER_EPOCH) {\n       throw new IllegalArgumentException(\"Invalid config.toml\");\n     }\n+    validateKeyStoreFilesAndPasswordFilesSize();\n+  }\n+\n+  private void validateKeyStoreFilesAndPasswordFilesSize() {\n+    final List<String> validatorKeystoreFiles = getValidatorKeystoreFiles();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a5db6b07f37bb93a1c046daa3c6ef6994ad3c9b"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1MDE5OA==", "bodyText": "Why does this need to be distinct? Is it an error if a user has duplicate validator keys?", "url": "https://github.com/ConsenSys/teku/pull/1249#discussion_r386750198", "createdAt": "2020-03-03T01:27:09Z", "author": {"login": "jframe"}, "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/KeystoresValidatorKeyProvider.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.coordinator;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+import static java.lang.String.format;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.stream.Collectors.toList;\n+import static org.apache.commons.lang3.StringUtils.isEmpty;\n+import static tech.pegasys.artemis.util.alogger.ALogger.STDOUT;\n+\n+import com.google.common.io.Files;\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.apache.logging.log4j.Level;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.bls.keystore.KeyStore;\n+import tech.pegasys.artemis.bls.keystore.KeyStoreLoader;\n+import tech.pegasys.artemis.bls.keystore.KeyStoreValidationException;\n+import tech.pegasys.artemis.bls.keystore.model.KeyStoreData;\n+import tech.pegasys.artemis.util.bls.BLSKeyPair;\n+import tech.pegasys.artemis.util.config.ArtemisConfiguration;\n+import tech.pegasys.artemis.util.mikuli.KeyPair;\n+import tech.pegasys.artemis.util.mikuli.SecretKey;\n+\n+public class KeystoresValidatorKeyProvider implements ValidatorKeyProvider {\n+  static final int KEY_LENGTH = 48;\n+\n+  @Override\n+  public List<BLSKeyPair> loadValidatorKeys(final ArtemisConfiguration config) {\n+    final List<Pair<Path, Path>> keystorePasswordFilePairs =\n+        config.getValidatorKeystorePasswordFilePairs();\n+    checkNotNull(keystorePasswordFilePairs, \"validator keystore and password pairs cannot be null\");\n+\n+    // return distinct loaded key pairs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a5db6b07f37bb93a1c046daa3c6ef6994ad3c9b"}, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4141, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}