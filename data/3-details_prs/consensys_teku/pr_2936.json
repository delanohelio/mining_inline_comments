{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwODI5MDUw", "number": 2936, "title": "[Issue-2273] Enable weak subjectivity validation", "bodyText": "PR Description\nEnable weak subjectivity validation:\n\nUse moderately strict validator\nMake ws commands and CLI arguments visible\n\nAdditionally do some clean up:\n\nThrottle potentially noisy warning logs\nLog ws errors to the console\nRework some ws error messages\nBetter handle the case where a peer doesn't have the ws checkpoint we request.  Log a warning in this case\n\nFixed Issue(s)\nPart of #2273\nDocumentation\nThis PR exposes CLI arguments:\n\n--ws-checkpoint: \"A recent checkpoint within the weak subjectivity period.\"\n\nAnd new CLI commands:\n\nteku admin weak-subjectivity display-state: \"Display the stored weak subjectivity configuration\"\nteku admin weak-subjectivity clear-state: \"Clears stored weak subjectivity configuration\"", "createdAt": "2020-10-09T21:28:15Z", "url": "https://github.com/ConsenSys/teku/pull/2936", "merged": true, "mergeCommit": {"oid": "b963982feac9c88a00cb0bc9a37c7e4e8dd8a0c3"}, "closed": true, "closedAt": "2020-10-13T17:43:50Z", "author": {"login": "mbaxter"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ8-YiAH2gAyNTAwODI5MDUwOjFjMjBhNzM2MDU2ZjkzNTcyODhiZTZjNzgyZjQ0MjQ2M2ExOWRlOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSMEScgH2gAyNTAwODI5MDUwOjQwYjI0ZGZlNTY1OTEyZjgxYjViNTExYmE5MDJjYTkyOTI5YmFlMTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c20a736056f9357288be6c782f442463a19de95", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/1c20a736056f9357288be6c782f442463a19de95", "committedDate": "2020-10-09T21:22:28Z", "message": "Throttle various weak subjectivity warnings and send them to console"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a7208dc381353948a4ddc8b398bb567ef3d10b1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/3a7208dc381353948a4ddc8b398bb567ef3d10b1", "committedDate": "2020-10-09T21:24:23Z", "message": "Fully enable weak-subjectivity validation\n\nMake ws validation strict, make ws options and commands visible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d08286a358d56cd799503e72970fc88851eb30e", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8d08286a358d56cd799503e72970fc88851eb30e", "committedDate": "2020-10-09T21:24:34Z", "message": "Add additional unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06e6cf838c52e7d788a12e520fa60ed9c8903595", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/06e6cf838c52e7d788a12e520fa60ed9c8903595", "committedDate": "2020-10-09T21:24:34Z", "message": "Log weak subjectivity errors to the console"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f42bdab74e49132557a8a111054af49be8c90958", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f42bdab74e49132557a8a111054af49be8c90958", "committedDate": "2020-10-09T21:24:34Z", "message": "Warn when a peer fails a required checkpoint validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b97f8560eb5db1c06b8dbf2da8b14706a48584bf", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/b97f8560eb5db1c06b8dbf2da8b14706a48584bf", "committedDate": "2020-10-09T21:32:05Z", "message": "Fix test name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59fa2535f1c65f88de82befa45085d1550c91ebf", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/59fa2535f1c65f88de82befa45085d1550c91ebf", "committedDate": "2020-10-09T21:53:53Z", "message": "Better handling when peer is missing the required checkpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8df6ccaec9bb1f8ff1042148f89a1367abc6bdee", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/8df6ccaec9bb1f8ff1042148f89a1367abc6bdee", "committedDate": "2020-10-09T21:56:58Z", "message": "Update BeaconChainControllerTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjE5ODky", "url": "https://github.com/ConsenSys/teku/pull/2936#pullrequestreview-506219892", "createdAt": "2020-10-11T21:54:08Z", "commit": {"oid": "8df6ccaec9bb1f8ff1042148f89a1367abc6bdee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQyMTo1NDowOFrOHfq48g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQyMTo1NDowOFrOHfq48g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3MDYxMA==", "bodyText": "Unfortunately I don't think this works reliably.  The update function has to be side effect free as it may be applied multiple times when there are race conditions.  I think you could use getAndUpdate though:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final AtomicBoolean updated = new AtomicBoolean(false);\n          \n          \n            \n                lastInvoked.updateAndGet(\n          \n          \n            \n                    last -> {\n          \n          \n            \n                      if (last == null || last.plus(throttlingPeriod).isLessThanOrEqualTo(currentTime)) {\n          \n          \n            \n                        updated.set(true);\n          \n          \n            \n                        return currentTime;\n          \n          \n            \n                      }\n          \n          \n            \n                      return last;\n          \n          \n            \n                    });\n          \n          \n            \n                return updated.get();\n          \n          \n            \n                final UInt64 previousValue = lastInvoked.getAndUpdate(\n          \n          \n            \n                    last -> {\n          \n          \n            \n                      if (last == null || last.plus(throttlingPeriod).isLessThanOrEqualTo(currentTime)) {\n          \n          \n            \n                        return currentTime;\n          \n          \n            \n                      }\n          \n          \n            \n                      return last;\n          \n          \n            \n                    });\n          \n          \n            \n                return previousValue == null || previousValue(throttlingPeriod).isLessThanOrEqualTo(currentTime);\n          \n      \n    \n    \n  \n\nBecause it's returning the value immediately prior to the update, we can re-evaluate to see if an update was required without having to have side-effects in the invoked method.", "url": "https://github.com/ConsenSys/teku/pull/2936#discussion_r502970610", "createdAt": "2020-10-11T21:54:08Z", "author": {"login": "ajsutton"}, "path": "infrastructure/time/src/main/java/tech/pegasys/teku/infrastructure/time/Throttler.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.infrastructure.time;\n+\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.function.Consumer;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+\n+public class Throttler<TResource> {\n+  // The wrapped resouce can be invoked at most once every throttling period\n+  private final TResource resource;\n+  private final UInt64 throttlingPeriod;\n+  private final AtomicReference<UInt64> lastInvoked = new AtomicReference<>(null);\n+\n+  public Throttler(final TResource resource, final UInt64 throttlingPeriod) {\n+    this.resource = resource;\n+    this.throttlingPeriod = throttlingPeriod;\n+  }\n+\n+  public void invoke(final UInt64 currentTime, Consumer<TResource> invocation) {\n+    if (updateLastInvoked(currentTime)) {\n+      invocation.accept(resource);\n+    }\n+  }\n+\n+  private boolean updateLastInvoked(final UInt64 currentTime) {\n+    final AtomicBoolean updated = new AtomicBoolean(false);\n+    lastInvoked.updateAndGet(\n+        last -> {\n+          if (last == null || last.plus(throttlingPeriod).isLessThanOrEqualTo(currentTime)) {\n+            updated.set(true);\n+            return currentTime;\n+          }\n+          return last;\n+        });\n+    return updated.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8df6ccaec9bb1f8ff1042148f89a1367abc6bdee"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f15fd861a1e218e0358dd30dbbff76e11b6b092b", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f15fd861a1e218e0358dd30dbbff76e11b6b092b", "committedDate": "2020-10-12T15:15:54Z", "message": "Remove side-effects from atomic update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "510d4b07601fb273662363a6f4f9bf511c37003a", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/510d4b07601fb273662363a6f4f9bf511c37003a", "committedDate": "2020-10-12T16:06:06Z", "message": "Improve logging around weak subjectivity period errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "330dc4af513b43d1d2518411af4c7689306caca1", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/330dc4af513b43d1d2518411af4c7689306caca1", "committedDate": "2020-10-12T18:01:47Z", "message": "Reorganize violationPolicy logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c98ee04356f818ab61ce484c6aeb28345b33093d", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c98ee04356f818ab61ce484c6aeb28345b33093d", "committedDate": "2020-10-12T18:23:13Z", "message": "Add a \"moderate\" ws policy and enable it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bacbcd07299f6a06b001b4760dec305809eb7e02", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/bacbcd07299f6a06b001b4760dec305809eb7e02", "committedDate": "2020-10-12T18:28:22Z", "message": "Remove unused methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce108e3f7f0616998d0e8a326e8cc28fef32f823", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/ce108e3f7f0616998d0e8a326e8cc28fef32f823", "committedDate": "2020-10-12T19:09:50Z", "message": "Make ws error handling less aggressive during block import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cce8c712cb01b91e5adb4f8bdd5c72679f6276a2", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/cce8c712cb01b91e5adb4f8bdd5c72679f6276a2", "committedDate": "2020-10-12T19:14:42Z", "message": "Merge branch 'master' into issue-2273/fully-enable-ws-validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "432ae247eec592ab51f3712ca0df85244d207a5c", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/432ae247eec592ab51f3712ca0df85244d207a5c", "committedDate": "2020-10-12T19:23:34Z", "message": "Cut equals() method overrides"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDY1MzYy", "url": "https://github.com/ConsenSys/teku/pull/2936#pullrequestreview-507065362", "createdAt": "2020-10-13T04:44:50Z", "commit": {"oid": "432ae247eec592ab51f3712ca0df85244d207a5c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNDo0NDo1MFrOHgVNgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNDo0NDo1MFrOHgVNgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY2NDAwMg==", "bodyText": "I'd suggest using ColorConsolePrinter.print to make this coloured (I think it should be red at error level and yellow at warn but tempted to just always make it red).", "url": "https://github.com/ConsenSys/teku/pull/2936#discussion_r503664002", "createdAt": "2020-10-13T04:44:50Z", "author": {"login": "ajsutton"}, "path": "infrastructure/logging/src/main/java/tech/pegasys/teku/infrastructure/logging/StatusLogger.java", "diffHunk": "@@ -195,4 +197,40 @@ public void performance(final String performance) {\n   public void warnWeakSubjectivityChecksSuppressed(final UInt64 untilEpoch) {\n     log.warn(\"Suppressing weak subjectivity errors until epoch {}\", untilEpoch);\n   }\n+\n+  public void warnWeakSubjectivityFinalizedCheckpointValidationDeferred(\n+      final UInt64 finalizedEpoch, final UInt64 wsCheckpointEpoch) {\n+    log.warn(\n+        \"Deferring weak subjectivity checks for finalized checkpoint at epoch {}.  Checks will resume once weak subjectivity checkpoint at epoch {} is reached.\",\n+        finalizedEpoch,\n+        wsCheckpointEpoch);\n+  }\n+\n+  public void finalizedCheckpointOutsideOfWeakSubjectivityPeriod(\n+      Level level, final UInt64 latestFinalizedCheckpointEpoch) {\n+    log.log(\n+        level,\n+        \"The latest finalized checkpoint at epoch {} is outside of the weak subjectivity period.  Please supply a recent weak subjectivity checkpoint using --ws-checkpoint=<BLOCK_ROOT>:<EPOCH>.\",\n+        latestFinalizedCheckpointEpoch);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "432ae247eec592ab51f3712ca0df85244d207a5c"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8b657c201419dff31e15ce3bf6f3ca7bb9004f6", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/c8b657c201419dff31e15ce3bf6f3ca7bb9004f6", "committedDate": "2020-10-13T17:06:01Z", "message": "Log ws period error in red"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ba3f2c0de9401ca51e11f5a50e49a9e6123099", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/22ba3f2c0de9401ca51e11f5a50e49a9e6123099", "committedDate": "2020-10-13T17:14:30Z", "message": "Only use color if log level is greater than info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a82f2f14fe34cca51e4e5522e227438c8f603dd4", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/a82f2f14fe34cca51e4e5522e227438c8f603dd4", "committedDate": "2020-10-13T17:21:46Z", "message": "Log ws checkpoint error in red"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f36732982a317df5aa18d6ea31789d945e1b7c3f", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/f36732982a317df5aa18d6ea31789d945e1b7c3f", "committedDate": "2020-10-13T17:30:59Z", "message": "Log ws warnings in yellow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40b24dfe565912f81b5b511ba902ca92929bae16", "author": {"user": {"login": "mbaxter", "name": null}}, "url": "https://github.com/ConsenSys/teku/commit/40b24dfe565912f81b5b511ba902ca92929bae16", "committedDate": "2020-10-13T17:31:25Z", "message": "Merge branch 'master' into issue-2273/fully-enable-ws-validation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3338, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}