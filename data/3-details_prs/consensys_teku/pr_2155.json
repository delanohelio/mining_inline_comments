{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0OTY1NjA5", "number": 2155, "title": "allow the beaconChainController to skip forward slots if it falls behind", "bodyText": "added a getSlotStartTime function to calculate the time that a slot should start\n\n\nadded regression tests for getSlotStartTime\n\n\nadded a event log event for when the nodeSlot drifts, so that we can see it in the log, as it will likely mean that errors occur slightly after, especially if it is multiple epochs between them.\n\n\nremoved Thread.sleep() logic previously used for slot processing logic.\n\n\nSigned-off-by: Paul Harris paul.harris@consensys.net\nAddresses #1942\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-06-16T04:27:15Z", "url": "https://github.com/ConsenSys/teku/pull/2155", "merged": true, "mergeCommit": {"oid": "16e2a47bf5fd9ef2457b28bdf475f0096ecde1b2"}, "closed": true, "closedAt": "2020-06-17T05:19:10Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqY_OggH2gAyNDM0OTY1NjA5OjRiMzRjOGNmNzNiN2RlNTUxYjFmNmJiNGI2M2QzNDJhNzU1Yjk0ZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsChLcAH2gAyNDM0OTY1NjA5OjY5MzZjZmUxYjdhMzFmMTEyNjZjZDA4ZTAzNzkxYzU4ZTY3MWExZGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4b34c8cf73b7de551b1f6bb4b63d342a755b94e3", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/4b34c8cf73b7de551b1f6bb4b63d342a755b94e3", "committedDate": "2020-06-12T01:57:41Z", "message": "make sure post /beacon/validators handles the optional epoch\n\n - added integration test for this use case also.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "378ac18985e60b605a51a2966b4e0ac1b910db1b", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/378ac18985e60b605a51a2966b4e0ac1b910db1b", "committedDate": "2020-06-12T02:08:35Z", "message": "fix test issue.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a025daa7c641cd13a472e01fb9f3dc665cbec173", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/a025daa7c641cd13a472e01fb9f3dc665cbec173", "committedDate": "2020-06-12T02:21:36Z", "message": "Merge remote-tracking branch 'upstream/master' into 2114"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc00e487d5bf4d0e72cec488374ed47073e2ba14", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/bc00e487d5bf4d0e72cec488374ed47073e2ba14", "committedDate": "2020-06-12T02:56:48Z", "message": "make internal local variables final as they're not updated.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3923a09d8697e66273812251bb166285d376f46", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/c3923a09d8697e66273812251bb166285d376f46", "committedDate": "2020-06-16T04:05:03Z", "message": "allow the beaconChainController to skip forward slots if it falls behind\n\n - added a getSlotStartTime function to calculate the time that a slot should start\n\n - added regression tests for getSlotStartTime\n\n - added a event log event for when the nodeSlot drifts, so that we can see it in the log, as it will likely mean that errors occur slightly after, especially if it is multiple epochs between them.\n\n - removed Thread.sleep() logic previously used for slot processing logic.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "671110ad8107d1f8d147cd6ff47432066256f908", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/671110ad8107d1f8d147cd6ff47432066256f908", "committedDate": "2020-06-16T04:33:24Z", "message": "Merge remote-tracking branch 'upstream/master' into 2114"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjIyOTU2", "url": "https://github.com/ConsenSys/teku/pull/2155#pullrequestreview-431222956", "createdAt": "2020-06-16T07:18:20Z", "commit": {"oid": "671110ad8107d1f8d147cd6ff47432066256f908"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzoxODoyMFrOGkOTQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzozNDo1MlrOGkO1Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDYzNjIyNw==", "bodyText": "Drift Event probably isn't the right wording here.  Probably just \"Skipped Slots\"?  I don't think we always need Event in there and possibly should just remove them all as redundant.", "url": "https://github.com/ConsenSys/teku/pull/2155#discussion_r440636227", "createdAt": "2020-06-16T07:18:20Z", "author": {"login": "ajsutton"}, "path": "logging/src/main/java/tech/pegasys/teku/logging/EventLogger.java", "diffHunk": "@@ -56,6 +56,14 @@ public void epochEvent(\n     info(epochEventLog, Color.GREEN);\n   }\n \n+  public void nodeSlotDriftEvent(final UnsignedLong oldSlot, final UnsignedLong newSlot) {\n+    final String driftEventLog =\n+        String.format(\n+            \"Drift Event *** Current slot: %s, previous slot: %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "671110ad8107d1f8d147cd6ff47432066256f908"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDYzODkyMQ==", "bodyText": "We bail out if we're prior to geneesis time so can just do that check before the calculatedSlot calculation.", "url": "https://github.com/ConsenSys/teku/pull/2155#discussion_r440638921", "createdAt": "2020-06-16T07:23:51Z", "author": {"login": "ajsutton"}, "path": "services/beaconchain/src/main/java/tech/pegasys/teku/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -513,12 +520,46 @@ public void onTick(Date date) {\n     on_tick(transaction, currentTime);\n     transaction.commit().join();\n \n-    if (nextSlotDue) {\n-      if (syncService.isSyncActive()) {\n-        processSlotWhileSyncing();\n-      } else {\n-        processSlot();\n-      }\n+    if (nextSlotDue && syncService.isSyncActive()) {\n+      processSlotWhileSyncing();\n+      return;\n+    }\n+\n+    final UnsignedLong genesisTime = recentChainData.getGenesisTime();\n+    final UnsignedLong calculatedSlot =\n+        currentTime.compareTo(genesisTime) < 0\n+            ? ZERO\n+            : ForkChoiceUtil.getCurrentSlot(currentTime, genesisTime);\n+    if (currentTime.compareTo(genesisTime) < 0) {\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "671110ad8107d1f8d147cd6ff47432066256f908"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY0NDkxMA==", "bodyText": "I think I'm following how this all works but it's not easy. Will  take another look in the morning - I suspect that extracting some private methods would help a lot to give names to the various comparisons being done.", "url": "https://github.com/ConsenSys/teku/pull/2155#discussion_r440644910", "createdAt": "2020-06-16T07:34:52Z", "author": {"login": "ajsutton"}, "path": "services/beaconchain/src/main/java/tech/pegasys/teku/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -513,12 +520,46 @@ public void onTick(Date date) {\n     on_tick(transaction, currentTime);\n     transaction.commit().join();\n \n-    if (nextSlotDue) {\n-      if (syncService.isSyncActive()) {\n-        processSlotWhileSyncing();\n-      } else {\n-        processSlot();\n-      }\n+    if (nextSlotDue && syncService.isSyncActive()) {\n+      processSlotWhileSyncing();\n+      return;\n+    }\n+\n+    final UnsignedLong genesisTime = recentChainData.getGenesisTime();\n+    final UnsignedLong calculatedSlot =\n+        currentTime.compareTo(genesisTime) < 0\n+            ? ZERO\n+            : ForkChoiceUtil.getCurrentSlot(currentTime, genesisTime);\n+    if (currentTime.compareTo(genesisTime) < 0) {\n+      return;\n+    }\n+\n+    // tolerate 1 slot difference, not more\n+    if (calculatedSlot.compareTo(nodeSlot.getValue().plus(ONE)) > 0) {\n+      EVENT_LOG.nodeSlotDriftEvent(nodeSlot.getValue(), calculatedSlot);\n+      nodeSlot.setValue(calculatedSlot);\n+    }\n+\n+    final UnsignedLong epoch = compute_epoch_at_slot(nodeSlot.getValue());\n+    final UnsignedLong nodeSlotStartTime =\n+        ForkChoiceUtil.getSlotStartTime(nodeSlot.getValue(), genesisTime);\n+    if (onTickSlotStart == null || calculatedSlot.compareTo(onTickSlotStart) > 0) {\n+      onTickSlotStart = nodeSlot.getValue();\n+      processSlotStart(epoch);\n+    }\n+\n+    if ((onTickSlotAttestation == null || calculatedSlot.compareTo(onTickSlotAttestation) > 0)\n+        && currentTime.compareTo(nodeSlotStartTime.plus(UnsignedLong.valueOf(oneThirdSlotSeconds)))\n+            >= 0) {\n+      onTickSlotAttestation = nodeSlot.getValue();\n+      processSlotAttestation(epoch);\n+    }\n+    if ((onTickSlotAggregate == null || calculatedSlot.compareTo(onTickSlotAggregate) > 0)\n+        && currentTime.compareTo(\n+                nodeSlotStartTime.plus(UnsignedLong.valueOf(oneThirdSlotSeconds * 2)))\n+            >= 0) {\n+      onTickSlotAggregate = nodeSlot.getValue();\n+      processSlotAggregate();\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "671110ad8107d1f8d147cd6ff47432066256f908"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7256589b4a4820e86cd5cf50266df8f2ccb4b877", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/7256589b4a4820e86cd5cf50266df8f2ccb4b877", "committedDate": "2020-06-16T08:57:21Z", "message": "review comments partially addressed\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32d77d44de1936823f284d629e8eabb8b0aeb0de", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/32d77d44de1936823f284d629e8eabb8b0aeb0de", "committedDate": "2020-06-16T09:14:13Z", "message": "Merge remote-tracking branch 'upstream/master' into 2114"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDQ1MTU5", "url": "https://github.com/ConsenSys/teku/pull/2155#pullrequestreview-432045159", "createdAt": "2020-06-17T04:11:28Z", "commit": {"oid": "32d77d44de1936823f284d629e8eabb8b0aeb0de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f554e178c4af88ad1dc244cd88a56edf13d6938", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/9f554e178c4af88ad1dc244cd88a56edf13d6938", "committedDate": "2020-06-17T04:42:39Z", "message": "split out some of the checks to make the flow in the timer easier to understand.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6936cfe1b7a31f11266cd08e03791c58e671a1de", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/6936cfe1b7a31f11266cd08e03791c58e671a1de", "committedDate": "2020-06-17T04:54:48Z", "message": "Merge remote-tracking branch 'upstream/master' into 2114"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3936, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}