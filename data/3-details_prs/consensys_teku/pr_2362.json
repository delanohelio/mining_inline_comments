{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5OTM2MjMw", "number": 2362, "title": "Deliver EventChannel responses on a publisher owned thread", "bodyText": "PR Description\nWhen an EventChannel returns a future, previously it was completed on the channel's subscriber thread, which meant that any chained actions also happened on the subscriber thread and had to complete before the subscriber could move on to the next event.\nInstead, for any EventChannel that can return a future, creating a publisher now requires specifying an AsyncRunner which is used to complete the returned future.  This way the chained actions are all completed on a thread owned by the publisher's service, not the subscribers.  As a specific example, when the validator service makes a call to ValidatorApiChannel, the call is handled in the beacon chain on a thread dedicated to ValidatorApiChannel, but the returned future is completed by the AsyncRunner the validator service provided when creating its publisher.  So execution correctly moves from validator service to beacon service and then back.\nIf the channel doesn't return values (all methods return void), a publisher can be created without specifying an AsyncRunner, otherwise one is required.  This is achieved by introducing two marker interfaces - ChannelInterface and NonReturningChannelInterface which extends it.  All event channels must extend one of those and that's enforced by the compiler.  A runtime check is performed to reject creating an EventChannel for an interface that extends NonReturningEventChannel if it has any methods that return something other than void.\nThe additional benefit of the marker interfaces is that it's simple to find all interfaces which are used with event channels which was slightly challenging previously.\nFixed Issue(s)\nfixes #2347\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-07-16T06:44:49Z", "url": "https://github.com/ConsenSys/teku/pull/2362", "merged": true, "mergeCommit": {"oid": "2c3dbb6e1e81e2fffff25282afacaefabd50058e"}, "closed": true, "closedAt": "2020-07-17T03:23:26Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1XLLvAH2gAyNDQ5OTM2MjMwOjJlNGZkOTU0YzU5NzE0OWI1M2ZmYjVjMzdlMDVhZmM4ODNkODM5ZDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1phl2AH2gAyNDQ5OTM2MjMwOjZkNGFhNjI5MjFjYzBjMWM0MjRiNTljNmQyMDYxZGJjZDY1ZjA3YjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2e4fd954c597149b53ffb5c37e05afc883d839d2", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/2e4fd954c597149b53ffb5c37e05afc883d839d2", "committedDate": "2020-07-16T04:04:06Z", "message": "Unbounded response threads."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42481c51c5a78b5232e6eaf9317fc93640a0b5a4", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/42481c51c5a78b5232e6eaf9317fc93640a0b5a4", "committedDate": "2020-07-16T04:43:39Z", "message": "Limit the number of threads that can be created to deliver responses."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1de33a3607981ae0ac98df09e74d471e2210e28", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/b1de33a3607981ae0ac98df09e74d471e2210e28", "committedDate": "2020-07-16T05:18:10Z", "message": "Require specifying an async runner for callbacks when creating a publisher to an event channel that provides return values."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be3aad1662bdd730b2c9603dc2d8793e758edf44", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/be3aad1662bdd730b2c9603dc2d8793e758edf44", "committedDate": "2020-07-16T06:24:24Z", "message": "Deliver responses via an AsyncRunner provided when the publisher is created so responses are handled on a thread owned by the calling service, not the subscribing one."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6256a8ecef972a1b8ed8554d68aa8549f5272631", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6256a8ecef972a1b8ed8554d68aa8549f5272631", "committedDate": "2020-07-16T06:42:35Z", "message": "Rename and add comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3070c710c4102aaddabd86fe96529bd0cba9b5b0", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3070c710c4102aaddabd86fe96529bd0cba9b5b0", "committedDate": "2020-07-16T06:46:13Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into deliver-response-async"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba415f8d15d0f9d7125d9cc65b361917e645e6c8", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ba415f8d15d0f9d7125d9cc65b361917e645e6c8", "committedDate": "2020-07-16T06:56:52Z", "message": "No requirement that publishers be the same now."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9794087e9db0e633246c6c049e91a4380293b992", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/9794087e9db0e633246c6c049e91a4380293b992", "committedDate": "2020-07-16T09:04:09Z", "message": "Allow queuing in ScheduledExecutorAsyncRunner."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5OTIyNDQ5", "url": "https://github.com/ConsenSys/teku/pull/2362#pullrequestreview-449922449", "createdAt": "2020-07-16T14:46:45Z", "commit": {"oid": "9794087e9db0e633246c6c049e91a4380293b992"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNDo0Njo0NVrOGyufdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNDo0Njo0NVrOGyufdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg0MzcwMw==", "bodyText": "Should this class and its methods be package-private?  It seems that we always go through EventChannels from outside this package.", "url": "https://github.com/ConsenSys/teku/pull/2362#discussion_r455843703", "createdAt": "2020-07-16T14:46:45Z", "author": {"login": "mbaxter"}, "path": "events/src/main/java/tech/pegasys/teku/events/EventChannel.java", "diffHunk": "@@ -130,7 +129,14 @@ private static boolean hasAllowedAsyncReturnValue(final Class<?> returnType) {\n         && returnType.isAssignableFrom(SafeFuture.class);\n   }\n \n-  public T getPublisher() {\n+  public T getPublisher(final Optional<AsyncRunner> responseRunner) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9794087e9db0e633246c6c049e91a4380293b992"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5OTc0MTkz", "url": "https://github.com/ConsenSys/teku/pull/2362#pullrequestreview-449974193", "createdAt": "2020-07-16T15:40:42Z", "commit": {"oid": "9794087e9db0e633246c6c049e91a4380293b992"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87e748c1b467af2c314b988e22b04a8b652415b3", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/87e748c1b467af2c314b988e22b04a8b652415b3", "committedDate": "2020-07-16T19:56:14Z", "message": "Increase minimum thread count."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9acab2fd0082aeb042c8bd01bf945eb7641695d3", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/9acab2fd0082aeb042c8bd01bf945eb7641695d3", "committedDate": "2020-07-16T21:09:08Z", "message": "Make EventChannel package private."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e19685ca666471120e2e7bc5db31bc6e05047eee", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e19685ca666471120e2e7bc5db31bc6e05047eee", "committedDate": "2020-07-16T23:31:38Z", "message": "Create ThreadPoolExecutor that creates additional threads when needed up to a limit and queues tasks beyond that limit in a bounded queue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72eb39dbd57ef5636ee8e8c1958ffb1092b99753", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/72eb39dbd57ef5636ee8e8c1958ffb1092b99753", "committedDate": "2020-07-16T23:43:26Z", "message": "Reduce minimum thread limit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc1d38cda7722c8e31aea2227d5d0c62941790b7", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/cc1d38cda7722c8e31aea2227d5d0c62941790b7", "committedDate": "2020-07-17T00:40:47Z", "message": "Merge branch 'master' into deliver-response-async"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d4aa62921cc0c1c424b59c6d2061dbcd65f07b0", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6d4aa62921cc0c1c424b59c6d2061dbcd65f07b0", "committedDate": "2020-07-17T01:26:52Z", "message": "Merge branch 'master' into deliver-response-async"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3845, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}