{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MDE5Njkz", "number": 2434, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNDowNDowM1rOERsIWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNDowOTo1OVrOERsLUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2OTg0MjgzOnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V3RocksDbDao.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNDowNDowM1rOG2iikw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNDowNDowM1rOG2iikw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0MjE5NQ==", "bodyText": "Probably better to do this with a .flatMap rather than the if style. I think it becomes:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (maybeSlot.isPresent()) {\n          \n          \n            \n                  Optional<SignedBeaconBlock> maybeRoot = getFinalizedBlockAtSlot(maybeSlot.get());\n          \n          \n            \n                  if (maybeRoot.isPresent()) {\n          \n          \n            \n                    return Optional.of(\n          \n          \n            \n                        new SlotAndBlockRoot(maybeSlot.get(), maybeRoot.get().getMessage().hash_tree_root()));\n          \n          \n            \n                  }\n          \n          \n            \n                }\n          \n          \n            \n                return Optional.empty();\n          \n          \n            \n                return maybeSlot.flatMap(slot -> \n          \n          \n            \n                    getFinalizedBlockAtSlot(slot).map(block -> new SlotAndBlockRoot(slot, block.getRoot())));", "url": "https://github.com/ConsenSys/teku/pull/2434#discussion_r459842195", "createdAt": "2020-07-24T04:04:03Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V3RocksDbDao.java", "diffHunk": "@@ -96,6 +96,25 @@ public V3RocksDbDao(final RocksDbAccessor db) {\n     return getFinalizedBlock(blockRoot).map(SignedBeaconBlock::getSlot);\n   }\n \n+  @Override\n+  public Optional<UnsignedLong> getSlotForFinalizedStateRoot(final Bytes32 stateRoot) {\n+    return db.get(V3Schema.SLOTS_BY_FINALIZED_STATE_ROOT, stateRoot);\n+  }\n+\n+  @Override\n+  public Optional<SlotAndBlockRoot> getSlotAndBlockRootForFinalizedStateRoot(\n+      final Bytes32 stateRoot) {\n+    Optional<UnsignedLong> maybeSlot = db.get(V3Schema.SLOTS_BY_FINALIZED_STATE_ROOT, stateRoot);\n+    if (maybeSlot.isPresent()) {\n+      Optional<SignedBeaconBlock> maybeRoot = getFinalizedBlockAtSlot(maybeSlot.get());\n+      if (maybeRoot.isPresent()) {\n+        return Optional.of(\n+            new SlotAndBlockRoot(maybeSlot.get(), maybeRoot.get().getMessage().hash_tree_root()));\n+      }\n+    }\n+    return Optional.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc3ea4bb4cd6f8e91c7a93ed1dba4808704929ce"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2OTg1MDQwOnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V4FinalizedRocksDbDao.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNDowOTo1OVrOG2imlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNDowOTo1OVrOG2imlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg0MzIyMQ==", "bodyText": "Should be able to do the same as for the V3 db.", "url": "https://github.com/ConsenSys/teku/pull/2434#discussion_r459843221", "createdAt": "2020-07-24T04:09:59Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V4FinalizedRocksDbDao.java", "diffHunk": "@@ -68,6 +69,27 @@ public void close() throws Exception {\n     return db.get(V4SchemaFinalized.SLOTS_BY_FINALIZED_ROOT, blockRoot);\n   }\n \n+  @Override\n+  public Optional<UnsignedLong> getSlotForFinalizedStateRoot(final Bytes32 stateRoot) {\n+    return db.get(V4SchemaFinalized.SLOTS_BY_FINALIZED_STATE_ROOT, stateRoot);\n+  }\n+\n+  @Override\n+  public Optional<SlotAndBlockRoot> getSlotAndBlockRootForFinalizedStateRoot(\n+      final Bytes32 stateRoot) {\n+    Optional<UnsignedLong> maybeSlot =\n+        db.get(V4SchemaFinalized.SLOTS_BY_FINALIZED_STATE_ROOT, stateRoot);\n+    if (maybeSlot.isPresent()) {\n+      Optional<SignedBeaconBlock> maybeRoot =\n+          db.get(V4SchemaFinalized.FINALIZED_BLOCKS_BY_SLOT, maybeSlot.get());\n+      if (maybeRoot.isPresent()) {\n+        return Optional.of(\n+            new SlotAndBlockRoot(maybeSlot.get(), maybeRoot.get().getMessage().hash_tree_root()));\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc3ea4bb4cd6f8e91c7a93ed1dba4808704929ce"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3433, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}