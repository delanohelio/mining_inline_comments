{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MzMzODM3", "number": 1318, "title": "Do not drop static peers when connection limit is reached", "bodyText": "PR Description\nEnsure ConnectionManager does not disconnect static peers when the peer connection limit is reached.\nAs a result:\n\nStatic peers still count towards the connection limit\nIf the connection limit is reached, discovery peers will be disconnected and static ones preserved\nIf the static peers exceed the connection limit by themselves, they will all remain connected but all discovery peers will be disconnected.\n\nThis differs from Besu where static peers are not included in the peer limit at all, but should simplify things. You can set the connection limit based on the capacity for number of peers that can be serviced, and independently manage the list of peers you always want to be connected to. With Besu, you have to adjust the peer limit each time you adjust the static peers to maintain the same resource usage.", "createdAt": "2020-03-09T00:28:06Z", "url": "https://github.com/ConsenSys/teku/pull/1318", "merged": true, "mergeCommit": {"oid": "9b074ba12e7a67688e67f915167426cfacbe24e5"}, "closed": true, "closedAt": "2020-03-09T21:31:31Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLys1AAH2gAyMzg1MzMzODM3OjRhMWU0NWNjMGI5Mzc2MzQwMzFmM2VlNWVhYmYxMDdiY2E4YjNmMWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMELySAH2gAyMzg1MzMzODM3OmJkMWZkNzkzNmE3NWNkYmIyOGM1ZmRhYmJkYTdiZDcyZWM1YjA1MjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4a1e45cc0b937634031f3ee5eabf107bca8b3f1d", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4a1e45cc0b937634031f3ee5eabf107bca8b3f1d", "committedDate": "2020-03-09T00:23:28Z", "message": "Do not drop static peers when connection limit is reached."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f601e72f1febf53966045cccecc242b9b6546f8b", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/f601e72f1febf53966045cccecc242b9b6546f8b", "committedDate": "2020-03-09T02:16:11Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into do-not-drop-static-peers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMjc4Njg0", "url": "https://github.com/ConsenSys/teku/pull/1318#pullrequestreview-371278684", "createdAt": "2020-03-09T15:22:25Z", "commit": {"oid": "f601e72f1febf53966045cccecc242b9b6546f8b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNToyMjoyNVrOFztOtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNToyMjoyNVrOFztOtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc2Mjc0MA==", "bodyText": "Stale comment:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Should disconnect one peer to get back down to our target of max 1 peer.\n          \n          \n            \n                // Should not disconnect static peers", "url": "https://github.com/ConsenSys/teku/pull/1318#discussion_r389762740", "createdAt": "2020-03-09T15:22:25Z", "author": {"login": "mbaxter"}, "path": "networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java", "diffHunk": "@@ -362,6 +362,26 @@ public void shouldDisconnectPeersWhenPeerCountExceedsLimit() {\n     assertThat(peer1.isConnected()).isTrue();\n   }\n \n+  @Test\n+  public void shouldNotDisconnectStaticPeersWhenPeerCountExceedsLimit() {\n+    final StubPeer peer1 = new StubPeer(new MockNodeId(1));\n+    final StubPeer peer2 = new StubPeer(new MockNodeId(2));\n+    final ConnectionManager manager = createManager(new TargetPeerRange(1, 1), PEER1, PEER2);\n+    when(network.connect(PEER1)).thenReturn(SafeFuture.completedFuture(peer1));\n+    when(network.connect(PEER2)).thenReturn(SafeFuture.completedFuture(peer2));\n+    manager.start().join();\n+\n+    final PeerConnectedSubscriber<Peer> peerConnectedSubscriber = getPeerConnectedSubscriber();\n+\n+    when(network.streamPeers()).thenReturn(Stream.of(peer2, peer1));\n+    when(network.getPeerCount()).thenReturn(2);\n+    peerConnectedSubscriber.onConnected(peer1);\n+\n+    // Should disconnect one peer to get back down to our target of max 1 peer.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f601e72f1febf53966045cccecc242b9b6546f8b"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3747771e6ba234da2614144792a38a86e88df54e", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3747771e6ba234da2614144792a38a86e88df54e", "committedDate": "2020-03-09T20:45:32Z", "message": "Update networking/p2p/src/test/java/tech/pegasys/artemis/networking/p2p/discovery/ConnectionManagerTest.java\n\nCo-Authored-By: mbaxter <meredith.baxter@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd1fd7936a75cdbb28c5fdabbda7bd72ec5b0520", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/bd1fd7936a75cdbb28c5fdabbda7bd72ec5b0520", "committedDate": "2020-03-09T20:45:40Z", "message": "Merge branch 'master' into do-not-drop-static-peers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3925, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}