{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MTcxMjQy", "number": 2354, "title": "[2184] Add hot storage for StateRoot to SlotAndBlockRoot", "bodyText": "added serialiser\n\n\nadded tests for serialiser and database functions\n\n\nthis is not currently populated, though tests show the behaviour of adding and pruning the list, as well as object retrieval.\n\n\npartially addresses #2184\nSigned-off-by: Paul Harris paul.harris@consensys.net\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-07-15T00:03:15Z", "url": "https://github.com/ConsenSys/teku/pull/2354", "merged": true, "mergeCommit": {"oid": "a1814c7b97f75cfcf9c80826630ccebf024e45c7"}, "closed": true, "closedAt": "2020-07-15T03:17:38Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0_AO2gH2gAyNDQ5MTcxMjQyOjMxNTYwZjg1YWNlYjA1NTcyNmU5YzYxMTM5YTNjYTkwODM0MWM4MDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1BJ3cgH2gAyNDQ5MTcxMjQyOmFkNzQzMjNmZmVjM2E3MGMwNWUwZTAwZThiZjk3NDY0MWExYTNmNzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "31560f85aceb055726e9c61139a3ca908341c806", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/31560f85aceb055726e9c61139a3ca908341c806", "committedDate": "2020-07-14T23:54:25Z", "message": "Add hot storage for StateRoot to SlotAndBlockRoot\n\n - added serializer\n\n - added tests for serializer and database functions\n\n - this is not currently populated, though tests show the behavior of adding and pruning the list, as well as object retrieval.\n\npartially addresses #2184\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47b810083826a33ffa4b8ac5733e92a814072d91", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/47b810083826a33ffa4b8ac5733e92a814072d91", "committedDate": "2020-07-15T00:42:04Z", "message": "Merge remote-tracking branch 'upstream/master' into 2184-stateroot-storage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTY5MTIz", "url": "https://github.com/ConsenSys/teku/pull/2354#pullrequestreview-448569123", "createdAt": "2020-07-15T01:27:28Z", "commit": {"oid": "47b810083826a33ffa4b8ac5733e92a814072d91"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMToyNzoyOFrOGxq5Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMTozMjowOFrOGxq-HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNjE0Mg==", "bodyText": "This doesn't feel right - I'd have expected new hot state roots to be added as part of aStorageUpdate event since they'll only be added as part of importing a block and thus should be stored in the same transaction as the rest of the updates.\nIn any case, we definitely wouldn't want to store them one at a time - it's much more efficient to store them in a batch.\nUltimately though this doesn't affect the disk layout so we could start with this to make these tests work then move to something else in later PRs when we're actually capturing the data during state transition.", "url": "https://github.com/ConsenSys/teku/pull/2354#discussion_r454736142", "createdAt": "2020-07-15T01:27:28Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java", "diffHunk": "@@ -252,6 +254,32 @@ public void update(final StorageUpdate event) {\n     return finalizedDao.streamFinalizedBlocks(startSlot, endSlot);\n   }\n \n+  @Override\n+  public List<Bytes32> getStateRootsBeforeSlot(final UnsignedLong slot) {\n+    return hotDao.getStateRootsBeforeSlot(slot);\n+  }\n+\n+  @Override\n+  public void addHotStateRoot(final Bytes32 stateRoot, final SlotAndBlockRoot slotAndBlockRoot) {\n+    try (final HotUpdater updater = hotDao.hotUpdater()) {\n+      updater.addHotStateRoot(stateRoot, slotAndBlockRoot);\n+      updater.commit();\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47b810083826a33ffa4b8ac5733e92a814072d91"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDczNzQzNw==", "bodyText": "If it becomes time consuming or difficult to support state roots on v3 databases we can skip it and only do it for v4/5.  Nothing critical depends on the lookup so it's reasonable for new features to only be available in the most recent database format.", "url": "https://github.com/ConsenSys/teku/pull/2354#discussion_r454737437", "createdAt": "2020-07-15T01:32:08Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V3RocksDbDao.java", "diffHunk": "@@ -113,6 +116,22 @@ public V3RocksDbDao(final RocksDbAccessor db) {\n     return db.getAll(V3Schema.HOT_BLOCKS_BY_ROOT);\n   }\n \n+  @Override\n+  public List<Bytes32> getStateRootsBeforeSlot(final UnsignedLong slot) {\n+    try (Stream<ColumnEntry<Bytes32, SlotAndBlockRoot>> stream =\n+        db.stream(V3Schema.STATE_ROOT_TO_SLOT_AND_BLOCK_ROOT)) {\n+      return stream\n+          .filter((column) -> column.getValue().getSlot().compareTo(slot) < 0)\n+          .map(ColumnEntry::getKey)\n+          .collect(Collectors.toList());\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47b810083826a33ffa4b8ac5733e92a814072d91"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8ec45e7f8611350830f8eee4e7afebbb6fa553b", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/c8ec45e7f8611350830f8eee4e7afebbb6fa553b", "committedDate": "2020-07-15T01:58:24Z", "message": "Merge remote-tracking branch 'upstream/master' into 2184-stateroot-storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad74323ffec3a70c05e0e00e8bf974641a1a3f75", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/ad74323ffec3a70c05e0e00e8bf974641a1a3f75", "committedDate": "2020-07-15T02:24:45Z", "message": "Merge remote-tracking branch 'upstream/master' into 2184-stateroot-storage"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3838, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}