{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5Mzc5MzMy", "number": 1532, "title": "Aggregate and include all available attestations in blocks", "bodyText": "PR Description\nReplace BlockAttestationPool which only stored aggregates with AggregatingAttestationPool.  All attestations are tracked in this pool and are aggregated on demand when producing blocks or when a validator is assigned as the aggregator for a committee.\nThe aggregation approach is semi-intelligent.  Currently it uses an arbitrary order for selecting one of the available AttestationData. For a single AttestationData it will create the aggregate by attempting to include attestations in order of the number of validators they include.  This has a reasonable chance of fitting the most validators into each aggregate while minimising the amount we have to aggregate.\nIn future work, when creating blocks we should create an aggregate based on the AttestationData which has the greatest number of unique validators attesting for it first.", "createdAt": "2020-04-06T04:54:12Z", "url": "https://github.com/ConsenSys/teku/pull/1532", "merged": true, "mergeCommit": {"oid": "f6acf05487b0862417f5af7d35cbea51ad390db0"}, "closed": true, "closedAt": "2020-04-07T01:00:12Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 42, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUhg3cAH2gAyMzk5Mzc5MzMyOjBmMTdjN2ViYjA0MDIwZDFiNjkwODRlZjEzNDNhZjRkOWU3OWIyNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVIabeAH2gAyMzk5Mzc5MzMyOjc2NmI3OWFmZWQ1NTg2ZDljNGE5ZTJkYzYxZGQ3ODcyMmVmYmM0OTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f17c7ebb04020d1b69084ef1343af4d9e79b273", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0f17c7ebb04020d1b69084ef1343af4d9e79b273", "committedDate": "2020-04-05T03:27:20Z", "message": "Switch Bitlist to use BitSet as a backing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18e013c41241690d92152773d2843423d4381f4c", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/18e013c41241690d92152773d2843423d4381f4c", "committedDate": "2020-04-05T03:36:15Z", "message": "Removal based aggregation pool."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e44f471a5e799a84b0ef112bddcae3fabfeb40e0", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e44f471a5e799a84b0ef112bddcae3fabfeb40e0", "committedDate": "2020-04-05T20:41:20Z", "message": "Add AggregatingAttestationPool."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "298e675e235a84bdc7316b6bfdae546823d9c779", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/298e675e235a84bdc7316b6bfdae546823d9c779", "committedDate": "2020-04-05T20:53:00Z", "message": "Combine all signatures at once once attestations to include have been selected."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a28dd9cc4f802994677ffb6cafd0d346764425bc", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a28dd9cc4f802994677ffb6cafd0d346764425bc", "committedDate": "2020-04-05T21:05:46Z", "message": "Streams are simpler than iterators in AggregatingAttestationPool."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f040988c840042da26d8d8d282e24a183214de8", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3f040988c840042da26d8d8d282e24a183214de8", "committedDate": "2020-04-05T21:31:50Z", "message": "Handle all requirements for including attestations in blocks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2468c20e1e07dd4c2c19d94986f8e2aa6a65e33", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/f2468c20e1e07dd4c2c19d94986f8e2aa6a65e33", "committedDate": "2020-04-05T23:05:32Z", "message": "Integrate attestation pool."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4d071506a5e925297341d99766db5211afc870f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e4d071506a5e925297341d99766db5211afc870f", "committedDate": "2020-04-05T23:13:54Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into aggregator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4dc630e85839a98f878acd8f3a5188638800273", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a4dc630e85839a98f878acd8f3a5188638800273", "committedDate": "2020-04-05T23:32:33Z", "message": "Switch Bitlist to use BitSet as a backing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a84e9e36079634f3e9aacb1180fe7f8811e379e6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/a84e9e36079634f3e9aacb1180fe7f8811e379e6", "committedDate": "2020-04-06T00:27:21Z", "message": "Add more tests for bitlist and a benchmark."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f6e569090c7dd4cbd87a948e4ea7f0c4aec96e6", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/5f6e569090c7dd4cbd87a948e4ea7f0c4aec96e6", "committedDate": "2020-04-06T00:36:13Z", "message": "Undo changes to Attestation and AttestationData."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7a6ab573fe3614b2a53a8e9841d3d5e7f4d8624", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/c7a6ab573fe3614b2a53a8e9841d3d5e7f4d8624", "committedDate": "2020-04-06T00:38:29Z", "message": "Undo new method in AttestationUtil."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc96c4df2a6d84c1cd6af0bdff5fe65b3fa3f2a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/4fc96c4df2a6d84c1cd6af0bdff5fe65b3fa3f2a", "committedDate": "2020-04-06T00:42:14Z", "message": "More fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baf9bd7739940feb0930f76fc967d4720d3a9a33", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/baf9bd7739940feb0930f76fc967d4720d3a9a33", "committedDate": "2020-04-06T01:15:49Z", "message": "Send attestations to AttestationAggregator when not using separate validator client.\nCopy bitlist of first attestation in AggregateAttestationBuilder to avoid corrupting the attestation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41344aede8a1792b9185555ecc6118904b6626bb", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/41344aede8a1792b9185555ecc6118904b6626bb", "committedDate": "2020-04-06T03:03:22Z", "message": "Add tests for AggregateAttestationBuilder."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69607e1d01eead37ac8ce89668c8fddf36879177", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/69607e1d01eead37ac8ce89668c8fddf36879177", "committedDate": "2020-04-06T03:34:23Z", "message": "Fix Signature.hashCode to match equals."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cab6e452a5925aa6983a12f0c291687e94b5c2c1", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/cab6e452a5925aa6983a12f0c291687e94b5c2c1", "committedDate": "2020-04-06T03:52:38Z", "message": "Merge branch 'bitlist' into aggregator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c538a945d254483b532e4a3afeaed93cf4c78d7a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/c538a945d254483b532e4a3afeaed93cf4c78d7a", "committedDate": "2020-04-06T04:07:09Z", "message": "Add tests for MatchingDataAttestationGroup and omit attestations that have already had all their validators included."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95ec31a1d071a16daf19d9fb16cb68846c880a27", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/95ec31a1d071a16daf19d9fb16cb68846c880a27", "committedDate": "2020-04-06T04:32:45Z", "message": "Add tests for AggregatingAttestationPool."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d068a86266af2507d084d984e6f3d9c61a57d344", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/d068a86266af2507d084d984e6f3d9c61a57d344", "committedDate": "2020-04-06T04:34:05Z", "message": "Remove todos."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "995aae8d0719c7d05ab99ca8fe468e328683154e", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/995aae8d0719c7d05ab99ca8fe468e328683154e", "committedDate": "2020-04-06T04:34:32Z", "message": "Remove unimplemented method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "025b957c3dd394592c40acced36414f4afafaa40", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/025b957c3dd394592c40acced36414f4afafaa40", "committedDate": "2020-04-06T04:34:55Z", "message": "Remove unused parameters."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73bb0e503b2f3473271889a7a1cc34562e3297be", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/73bb0e503b2f3473271889a7a1cc34562e3297be", "committedDate": "2020-04-06T04:37:26Z", "message": "Add test for ValidatorApiHandler.createAggregate."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8aa68220f3204ec56da900d99de1210a7d9beb7", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e8aa68220f3204ec56da900d99de1210a7d9beb7", "committedDate": "2020-04-06T04:38:16Z", "message": "Delete BlockAttestationsPool."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d935c6b54ae98451bc1e71d7494c1d7fcf9a0f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/98d935c6b54ae98451bc1e71d7494c1d7fcf9a0f", "committedDate": "2020-04-06T04:55:37Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into aggregator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c54ddef22bba01fae5b2c1801ad0d36389f6aa1", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/9c54ddef22bba01fae5b2c1801ad0d36389f6aa1", "committedDate": "2020-04-06T04:59:31Z", "message": "Spotless."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61e2ba91f0f7e99fd4805ce9489f296a5c85c473", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/61e2ba91f0f7e99fd4805ce9489f296a5c85c473", "committedDate": "2020-04-06T05:21:29Z", "message": "Remove attestations which are a subset of any attestation being removed.\nFix Signature equals and hashCode to work with invalid signatures."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "899678c16310d9ee8ad779ad4e8c618aa1898777", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/899678c16310d9ee8ad779ad4e8c618aa1898777", "committedDate": "2020-04-06T05:25:07Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fdcb71146f77791f0cf33feb79d94a77bee7e79", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0fdcb71146f77791f0cf33feb79d94a77bee7e79", "committedDate": "2020-04-06T05:25:45Z", "message": "Remove placeholder test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e0dcee5a455a542fcc71fd865539171149d24e9", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/3e0dcee5a455a542fcc71fd865539171149d24e9", "committedDate": "2020-04-06T21:00:40Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into aggregator\n\n# Conflicts:\n#\tethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/BlockAttestationsPool.java\n#\tethereum/statetransition/src/test/java/tech/pegasys/artemis/statetransition/BlockAttestationsPoolTest.java\n#\tssz/src/main/java/tech/pegasys/artemis/util/SSZTypes/Bitlist.java\n#\tssz/src/test/java/tech/pegasys/artemis/util/ssztypes/BitlistTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed429a54269bd7c32feee1c187584ec9f3a9f617", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ed429a54269bd7c32feee1c187584ec9f3a9f617", "committedDate": "2020-04-06T21:28:18Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into aggregator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0929324881e5efceff4c6c60c69092ecf19b767b", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/0929324881e5efceff4c6c60c69092ecf19b767b", "committedDate": "2020-04-06T22:11:18Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into aggregator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjcxNjMz", "url": "https://github.com/ConsenSys/teku/pull/1532#pullrequestreview-388671633", "createdAt": "2020-04-06T22:49:25Z", "commit": {"oid": "0929324881e5efceff4c6c60c69092ecf19b767b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMjo0OToyNVrOGBsueA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMjo0OToyNVrOGBsueA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzNDU1Mg==", "bodyText": "Is there no need to copy the signature here? If two attestations refer to the same signature and one is aggregated whilst the other is not, this might cause issues.", "url": "https://github.com/ConsenSys/teku/pull/1532#discussion_r404434552", "createdAt": "2020-04-06T22:49:25Z", "author": {"login": "cemozerr"}, "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/operations/Attestation.java", "diffHunk": "@@ -51,7 +52,7 @@ public Attestation(Bitlist aggregation_bits, AttestationData data, BLSSignature\n   public Attestation(Attestation attestation) {\n     this.aggregation_bits = attestation.getAggregation_bits().copy();\n     this.data = attestation.getData();\n-    this.signature = BLSSignature.fromBytes(attestation.getAggregate_signature().toBytes());\n+    this.signature = attestation.getAggregate_signature();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0929324881e5efceff4c6c60c69092ecf19b767b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bc15d41eb00904a42f88296104df4fd3b170562", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/7bc15d41eb00904a42f88296104df4fd3b170562", "committedDate": "2020-04-06T22:50:47Z", "message": "Merge branch 'master' into aggregator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e896dd79d0e21e0ff9d6eaf621bc25cdca5b86a8", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/e896dd79d0e21e0ff9d6eaf621bc25cdca5b86a8", "committedDate": "2020-04-06T22:53:56Z", "message": "Merge branch 'master' into aggregator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Njk1NDQ0", "url": "https://github.com/ConsenSys/teku/pull/1532#pullrequestreview-388695444", "createdAt": "2020-04-06T23:51:15Z", "commit": {"oid": "e896dd79d0e21e0ff9d6eaf621bc25cdca5b86a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzo1MToxNVrOGBuB1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzo1MToxNVrOGBuB1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1NTg5Mg==", "bodyText": "It might be just me but I think this class deserves an explanation through comments. Although written so well, its purpose is pretty complex so an explanation in comments would be really nice. Something would be like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            class MatchingDataAttestationGroup implements Iterable<Attestation> {\n          \n          \n            \n            class MatchingDataAttestationGroup implements Iterable<Attestation> {\n          \n          \n            \n            /*   This object keeps attestations for a single attestation data sorted in descending order by the number of set aggregation bits. Its iterator goes through these attestations with the given order and aggregates them. Aggregating by starting with attestations with the highest number of bits potentially allows us to create aggregates with highest number of bits set. */", "url": "https://github.com/ConsenSys/teku/pull/1532#discussion_r404455892", "createdAt": "2020-04-06T23:51:15Z", "author": {"login": "cemozerr"}, "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/attestation/MatchingDataAttestationGroup.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.statetransition.attestation;\n+\n+import java.util.Collection;\n+import java.util.Comparator;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.LinkedHashSet;\n+import java.util.NavigableMap;\n+import java.util.Set;\n+import java.util.TreeMap;\n+import java.util.stream.Stream;\n+import java.util.stream.StreamSupport;\n+import tech.pegasys.artemis.datastructures.operations.Attestation;\n+import tech.pegasys.artemis.datastructures.operations.AttestationData;\n+\n+class MatchingDataAttestationGroup implements Iterable<Attestation> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e896dd79d0e21e0ff9d6eaf621bc25cdca5b86a8"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzA5MzUy", "url": "https://github.com/ConsenSys/teku/pull/1532#pullrequestreview-388709352", "createdAt": "2020-04-07T00:32:30Z", "commit": {"oid": "e896dd79d0e21e0ff9d6eaf621bc25cdca5b86a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMDozMjozMVrOGBuyXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwMDozMjozMVrOGBuyXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2ODMxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void iterator_shouldNotAggregateAttestaionsWhenValidatorsOverlap() {\n          \n          \n            \n              public void iterator_shouldNotAggregateAttestationsWhenValidatorsOverlap() {", "url": "https://github.com/ConsenSys/teku/pull/1532#discussion_r404468318", "createdAt": "2020-04-07T00:32:31Z", "author": {"login": "cemozerr"}, "path": "ethereum/statetransition/src/test/java/tech/pegasys/artemis/statetransition/attestation/MatchingDataAttestationGroupTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.statetransition.attestation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static tech.pegasys.artemis.statetransition.attestation.AggregatorUtil.aggregateAttestations;\n+import static tech.pegasys.artemis.util.config.Constants.MAX_VALIDATORS_PER_COMMITTEE;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.stream.IntStream;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.datastructures.operations.Attestation;\n+import tech.pegasys.artemis.datastructures.operations.AttestationData;\n+import tech.pegasys.artemis.datastructures.util.DataStructureUtil;\n+import tech.pegasys.artemis.datastructures.util.SimpleOffsetSerializer;\n+import tech.pegasys.artemis.util.SSZTypes.Bitlist;\n+\n+class MatchingDataAttestationGroupTest {\n+  private static final UnsignedLong SLOT = UnsignedLong.valueOf(1234);\n+  private final DataStructureUtil dataStructureUtil = new DataStructureUtil();\n+  private final AttestationData attestationData = dataStructureUtil.randomAttestationData(SLOT);\n+\n+  private final MatchingDataAttestationGroup group =\n+      new MatchingDataAttestationGroup(attestationData);\n+\n+  @Test\n+  public void isEmpty_shouldBeEmptyInitially() {\n+    assertThat(group.isEmpty()).isTrue();\n+  }\n+\n+  @Test\n+  public void isEmpty_shouldNotBeEmptyWhenAnAttestationIsAdded() {\n+    addAttestation(1);\n+    assertThat(group.isEmpty()).isFalse();\n+  }\n+\n+  @Test\n+  public void isEmpty_shouldBeEmptyAfterAttestationRemoved() {\n+    final Attestation attestation = addAttestation(1);\n+    group.remove(attestation);\n+\n+    assertThat(group.isEmpty()).isTrue();\n+  }\n+\n+  @Test\n+  public void remove_shouldRemoveAttestationEvenWhenInstanceIsDifferent() {\n+    final Attestation attestation = addAttestation(1);\n+    final Attestation copy =\n+        SimpleOffsetSerializer.deserialize(\n+            SimpleOffsetSerializer.serialize(attestation), Attestation.class);\n+    group.remove(copy);\n+\n+    assertThat(group.stream()).isEmpty();\n+    assertThat(group.isEmpty()).isTrue();\n+  }\n+\n+  @Test\n+  public void remove_shouldRemoveAttestationsThatAreAggregatedIntoRemovedAttestation() {\n+    final Attestation attestation1 = addAttestation(1);\n+    final Attestation attestation2 = addAttestation(2);\n+    final Attestation attestation3 = addAttestation(3);\n+\n+    group.remove(aggregateAttestations(attestation1, attestation2));\n+\n+    assertThat(group.stream()).containsExactly(attestation3);\n+  }\n+\n+  @Test\n+  public void iterator_shouldAggregateAttestationsWhereValidatorsDoNotOverlap() {\n+    final Attestation attestation1 = addAttestation(1);\n+    final Attestation attestation2 = addAttestation(2);\n+\n+    final Attestation expected = aggregateAttestations(attestation1, attestation2);\n+    assertThat(group).containsExactlyInAnyOrder(expected);\n+  }\n+\n+  @Test\n+  public void iterator_shouldAggregateAttestationsWithMoreValidatorsFirst() {\n+    final Attestation bigAttestation = addAttestation(1, 3, 5, 7);\n+    final Attestation mediumAttestation = addAttestation(3, 5, 9);\n+    final Attestation littleAttestation = addAttestation(2);\n+\n+    assertThat(group)\n+        .containsExactly(\n+            aggregateAttestations(bigAttestation, littleAttestation), mediumAttestation);\n+  }\n+\n+  @Test\n+  public void iterator_shouldNotAggregateAttestaionsWhenValidatorsOverlap() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e896dd79d0e21e0ff9d6eaf621bc25cdca5b86a8"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NzExMTM1", "url": "https://github.com/ConsenSys/teku/pull/1532#pullrequestreview-388711135", "createdAt": "2020-04-07T00:38:14Z", "commit": {"oid": "e896dd79d0e21e0ff9d6eaf621bc25cdca5b86a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceab9c77e3c098d06c8a27a7c548a64ade52da67", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/ceab9c77e3c098d06c8a27a7c548a64ade52da67", "committedDate": "2020-04-07T00:45:14Z", "message": "Add comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daef996f20b277eeb7d06a9b5d433bd65ba600f2", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/daef996f20b277eeb7d06a9b5d433bd65ba600f2", "committedDate": "2020-04-07T00:45:41Z", "message": "Fix spelling error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57c64cffc6cb7057bcbdbfbd12f6dcc2fc79eb85", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/57c64cffc6cb7057bcbdbfbd12f6dcc2fc79eb85", "committedDate": "2020-04-07T00:46:30Z", "message": "Merge branch 'aggregator' of github.com:ajsutton/teku into aggregator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "766b79afed5586d9c4a9e2dc61dd78722efbc496", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/766b79afed5586d9c4a9e2dc61dd78722efbc496", "committedDate": "2020-04-07T00:46:36Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into aggregator"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4216, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}