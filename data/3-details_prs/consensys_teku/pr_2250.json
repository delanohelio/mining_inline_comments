{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMTc3MjIy", "number": 2250, "title": "Avoid reprocessing the last stored deposit block on startup", "bodyText": "PR Description\nWhen Teku is restarted it replays deposits from it's local database and then resumes importing blocks from the ETH1 chain from there.  Previously it was incorrectly starting from the block the last stored deposit was from instead of the block after, resulting in the deposit being processed twice.\n\nTidied up the block number processing so it's easier to understand and fix the off by one errors.\nAdded tests for Eth1DepositManager.\nAdded a couple of debug utilities to be able to get finalised states in SSZ format.\n\nFixed Issue(s)\nfixes #2243\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-06-29T03:40:41Z", "url": "https://github.com/ConsenSys/teku/pull/2250", "merged": true, "mergeCommit": {"oid": "f1609d9b14b5dce4c2c1c68514d5c178c4994776"}, "closed": true, "closedAt": "2020-06-29T08:10:13Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv4jbNAH2gAyNDQxMTc3MjIyOmYyZDQzNGExNGIyOTFjMDliZGIzYTU2N2FmOWYwYjZmNzQzOTE2OWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcv8CVzgH2gAyNDQxMTc3MjIyOjZhMTc4YTdjZjhjMjMwNjBlY2I1YmY2ZDVhNjA3NzQ5Y2U3NWJkZmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f2d434a14b291c09bdb3a567af9f0b6f7439169a", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/f2d434a14b291c09bdb3a567af9f0b6f7439169a", "committedDate": "2020-06-29T03:33:54Z", "message": "Avoid reprocessing the last stored deposit block on startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb32f03a777e4caac92346e9ae897c6bf8823d89", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/eb32f03a777e4caac92346e9ae897c6bf8823d89", "committedDate": "2020-06-29T03:48:41Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into fix-duplicate-deposits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTIzMDUz", "url": "https://github.com/ConsenSys/teku/pull/2250#pullrequestreview-438923053", "createdAt": "2020-06-29T06:42:43Z", "commit": {"oid": "eb32f03a777e4caac92346e9ae897c6bf8823d89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNjo0Mjo0M1rOGqGwqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNjo0Mjo0M1rOGqGwqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwNDEzNw==", "bodyText": "nit: should use constant since its defined", "url": "https://github.com/ConsenSys/teku/pull/2250#discussion_r446804137", "createdAt": "2020-06-29T06:42:43Z", "author": {"login": "rolfyone"}, "path": "storage/src/main/java/tech/pegasys/teku/storage/server/DepositStorage.java", "diffHunk": "@@ -104,14 +98,14 @@ public void onMinGenesisTimeBlock(final MinGenesisTimeBlockEvent event) {\n     private final Eth1EventsChannel eth1EventsChannel;\n     private final Optional<MinGenesisTimeBlockEvent> genesis;\n     private boolean isGenesisDone;\n-    private UnsignedLong lastDeposit;\n+    private BigInteger lastDeposit;\n \n     public DepositSequencer(\n         final Eth1EventsChannel eventChannel, final Optional<MinGenesisTimeBlockEvent> genesis) {\n       this.eth1EventsChannel = eventChannel;\n       this.genesis = genesis;\n       this.isGenesisDone = false;\n-      this.lastDeposit = UnsignedLong.ZERO;\n+      this.lastDeposit = BigInteger.valueOf(-1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb32f03a777e4caac92346e9ae897c6bf8823d89"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTI0Njkz", "url": "https://github.com/ConsenSys/teku/pull/2250#pullrequestreview-438924693", "createdAt": "2020-06-29T06:46:01Z", "commit": {"oid": "eb32f03a777e4caac92346e9ae897c6bf8823d89"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf70922a95ace5c458c2b70789c2404bdb45f737", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/cf70922a95ace5c458c2b70789c2404bdb45f737", "committedDate": "2020-06-29T07:37:16Z", "message": "Use constant."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a178a7cf8c23060ecb5bf6d5a607749ce75bdfb", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/ConsenSys/teku/commit/6a178a7cf8c23060ecb5bf6d5a607749ce75bdfb", "committedDate": "2020-06-29T07:37:23Z", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into fix-duplicate-deposits"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3750, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}