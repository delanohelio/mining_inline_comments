{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3OTU5MTk5", "number": 3047, "title": "implement `/eth/v1/beacon/headers` headers with slot query", "bodyText": "the parent block root parameter is present, but doesn't perform a search currently.\n\nDocumentation\n\n I thought about documentation and added the documentation label to this PR if updates are required.", "createdAt": "2020-10-22T01:50:23Z", "url": "https://github.com/ConsenSys/teku/pull/3047", "merged": true, "mergeCommit": {"oid": "8620a654a9746691404ddf4e14b69043462282c8"}, "closed": true, "closedAt": "2020-10-22T03:08:05Z", "author": {"login": "rolfyone"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdT73n2gH2gAyNTA3OTU5MTk5OjhmN2NiNmM1OGMxYWNjMmIwODgwMjNkNjMzN2Q0MTc3NGVmZTA2YzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdU41DQgH2gAyNTA3OTU5MTk5OjY2ZTNjNWU2MjdmMzJkZDUzZDAxMmFmMTlhNzYwNThlZjY2NDQwYjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f7cb6c58c1acc2b088023d6337d41774efe06c6", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/8f7cb6c58c1acc2b088023d6337d41774efe06c6", "committedDate": "2020-10-19T03:46:57Z", "message": "implement `/eth/v1/beacon/headers/:block_id` endpoint\n\n - this is not similar to other pre-existing endpoints, so nothing was deprecated with this change.\n\n partially addresses #2760\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af949e331ceb9b13656d62e8cd55b1d030fef321", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/af949e331ceb9b13656d62e8cd55b1d030fef321", "committedDate": "2020-10-19T03:51:55Z", "message": "Revert \"implement `/eth/v1/beacon/headers/:block_id` endpoint\"\n\nThis reverts commit 8f7cb6c58c1acc2b088023d6337d41774efe06c6."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a350e73d7c98d6aa3a0d4bc888396c7f0a754e72", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/a350e73d7c98d6aa3a0d4bc888396c7f0a754e72", "committedDate": "2020-10-19T21:06:52Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c6d1ffb207eac8680d88b993ca805dad3c10a2e", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/0c6d1ffb207eac8680d88b993ca805dad3c10a2e", "committedDate": "2020-10-20T00:23:01Z", "message": "Merge remote-tracking branch 'upstream/master' into 2760-headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e95c8b86e7991bd5912169961d12ba3adbab05ca", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/e95c8b86e7991bd5912169961d12ba3adbab05ca", "committedDate": "2020-10-22T01:23:12Z", "message": "implement `/eth/v1/beacon/headers` query parameter slot\n\n - search by parent root will be treated separately.\n\n partially addresses #2760\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69338546864106d8e60c4874d69a81e000df22eb", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/69338546864106d8e60c4874d69a81e000df22eb", "committedDate": "2020-10-22T01:50:43Z", "message": "Merge remote-tracking branch 'upstream/master' into 2760-headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e09e1ab1c01336d8866bd48684682ef28f2980ae", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/e09e1ab1c01336d8866bd48684682ef28f2980ae", "committedDate": "2020-10-22T01:53:39Z", "message": "spotless\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MzA5ODU0", "url": "https://github.com/ConsenSys/teku/pull/3047#pullrequestreview-514309854", "createdAt": "2020-10-22T02:07:49Z", "commit": {"oid": "e09e1ab1c01336d8866bd48684682ef28f2980ae"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMjowNzo1MFrOHmN9lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwMjoxMTo0MlrOHmOB4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgzNjY5NA==", "bodyText": "While not particularly useful, it's probably more typical to accept both params and treat it as an AND condition - so return only blocks at the specified slot with the specified parent root.", "url": "https://github.com/ConsenSys/teku/pull/3047#discussion_r509836694", "createdAt": "2020-10-22T02:07:50Z", "author": {"login": "ajsutton"}, "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/handlers/v1/beacon/GetBlockHeaders.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.beaconrestapi.handlers.v1.beacon;\n+\n+import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.PARENT_ROOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_BAD_REQUEST;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_INTERNAL_ERROR;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.RES_OK;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.SLOT;\n+import static tech.pegasys.teku.beaconrestapi.RestApiConstants.TAG_V1_BEACON;\n+\n+import com.google.common.base.Throwables;\n+import io.javalin.http.Context;\n+import io.javalin.http.Handler;\n+import io.javalin.plugin.openapi.annotations.HttpMethod;\n+import io.javalin.plugin.openapi.annotations.OpenApi;\n+import io.javalin.plugin.openapi.annotations.OpenApiContent;\n+import io.javalin.plugin.openapi.annotations.OpenApiParam;\n+import io.javalin.plugin.openapi.annotations.OpenApiResponse;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.teku.api.ChainDataProvider;\n+import tech.pegasys.teku.api.DataProvider;\n+import tech.pegasys.teku.api.response.v1.beacon.GetBlockHeadersResponse;\n+import tech.pegasys.teku.beaconrestapi.SingleQueryParameterUtils;\n+import tech.pegasys.teku.beaconrestapi.handlers.AbstractHandler;\n+import tech.pegasys.teku.beaconrestapi.schema.BadRequest;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.provider.JsonProvider;\n+\n+public class GetBlockHeaders extends AbstractHandler implements Handler {\n+  public static final String ROUTE = \"/eth/v1/beacon/headers\";\n+  private final ChainDataProvider chainDataProvider;\n+\n+  public GetBlockHeaders(final DataProvider dataProvider, final JsonProvider jsonProvider) {\n+    this(dataProvider.getChainDataProvider(), jsonProvider);\n+  }\n+\n+  public GetBlockHeaders(\n+      final ChainDataProvider chainDataProvider, final JsonProvider jsonProvider) {\n+    super(jsonProvider);\n+    this.chainDataProvider = chainDataProvider;\n+  }\n+\n+  @OpenApi(\n+      path = ROUTE,\n+      method = HttpMethod.GET,\n+      summary = \"Get block headers\",\n+      tags = {TAG_V1_BEACON},\n+      description =\n+          \"Retrieves block headers matching given query. By default it will fetch current head slot blocks.\",\n+      queryParams = {\n+        @OpenApiParam(name = SLOT),\n+        @OpenApiParam(name = PARENT_ROOT, description = \"Not currently supported.\")\n+      },\n+      responses = {\n+        @OpenApiResponse(\n+            status = RES_OK,\n+            content = @OpenApiContent(from = GetBlockHeadersResponse.class)),\n+        @OpenApiResponse(status = RES_BAD_REQUEST),\n+        @OpenApiResponse(status = RES_INTERNAL_ERROR)\n+      })\n+  @Override\n+  public void handle(@NotNull final Context ctx) throws Exception {\n+    final Map<String, List<String>> queryParameters = ctx.queryParamMap();\n+\n+    final Optional<Bytes32> parentRoot =\n+        SingleQueryParameterUtils.getParameterValueAsBytes32IfPresent(queryParameters, PARENT_ROOT);\n+    final Optional<UInt64> slot =\n+        SingleQueryParameterUtils.getParameterValueAsUInt64IfPresent(queryParameters, SLOT);\n+\n+    if (parentRoot.isPresent() && slot.isPresent()) {\n+      ctx.status(SC_BAD_REQUEST);\n+      ctx.result(\n+          BadRequest.badRequest(\n+              jsonProvider, \"Either supply parent_root, slot, or neither, but not both.\"));\n+      return;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e09e1ab1c01336d8866bd48684682ef28f2980ae"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgzNzc5NQ==", "bodyText": "nit: Maybe extract this to a local slotToLoad variable as the chaining gets a bit confusing otherwise.  And maybe:\nslot.or(recentChainData::getCurrentSlot).orElseThrow()?", "url": "https://github.com/ConsenSys/teku/pull/3047#discussion_r509837795", "createdAt": "2020-10-22T02:11:42Z", "author": {"login": "ajsutton"}, "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -585,4 +585,20 @@ public void requireStoreAvailable() {\n         .join()\n         .map(Merkleizable::hash_tree_root);\n   }\n+\n+  public SafeFuture<List<BlockHeader>> getBlockHeaders(\n+      final Optional<Bytes32> parentRoot, final Optional<UInt64> slot) {\n+    if (!isStoreAvailable()) {\n+      throw new ChainDataUnavailableException();\n+    }\n+    if (parentRoot.isPresent()) {\n+      return SafeFuture.completedFuture(List.of());\n+    }\n+\n+    return combinedChainDataClient\n+        .getBlockAtSlotExact(slot.orElse(recentChainData.getCurrentSlot().orElseThrow()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e09e1ab1c01336d8866bd48684682ef28f2980ae"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1864e096a7f247fb1d7cddaaad0d616a8128af13", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/1864e096a7f247fb1d7cddaaad0d616a8128af13", "committedDate": "2020-10-22T02:29:16Z", "message": "Merge remote-tracking branch 'upstream/master' into 2760-headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdaff2efbf9d432281e175832804b33d385b52ab", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/fdaff2efbf9d432281e175832804b33d385b52ab", "committedDate": "2020-10-22T02:29:51Z", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66e3c5e627f32dd53d012af19a76058ef66440b9", "author": {"user": {"login": "rolfyone", "name": "Paul Harris"}}, "url": "https://github.com/ConsenSys/teku/commit/66e3c5e627f32dd53d012af19a76058ef66440b9", "committedDate": "2020-10-22T02:48:21Z", "message": "Merge remote-tracking branch 'upstream/master' into 2760-headers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3236, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}