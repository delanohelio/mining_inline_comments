{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNTA5MjMx", "number": 1233, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMTo1NDowMVrODjQZeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyNTowNVrODjQ-dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4Mjk1NDE3OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMTo1NDowMVrOFu9uTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMTo1NDowMVrOFu9uTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MDA5Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                File databaseStorage = new File(config.getDataPath() + \"/db\");\n          \n          \n            \n                File databaseStoragePath = new File(config.getDataPath() + \"/db\");", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384790092", "createdAt": "2020-02-26T21:54:01Z", "author": {"login": "macfarla"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -36,8 +36,9 @@\n   private final EventBus eventBus;\n \n   public ChainStorageServer(EventBus eventBus, ArtemisConfiguration config) {\n+    File databaseStorage = new File(config.getDataPath() + \"/db\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f840c267b89703e279aef3e4b105942ad448d2a"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4Mjk1NjE1OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMTo1NDo0NlrOFu9vlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMTo1NDo0NlrOFu9vlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MDQyMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                              \"The database version found (%s) does not meet the expected version(%s).\\n\"\n          \n          \n            \n                              \"The database version found (%s) does not match the expected version(%s).\\n\"", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384790422", "createdAt": "2020-02-26T21:54:46Z", "author": {"login": "macfarla"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {\n+          throw new DatabaseStorageException(\n+              String.format(\n+                  \"The database version found (%s) does not meet the expected version(%s).\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f840c267b89703e279aef3e4b105942ad448d2a"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4Mjk2MDY3OnYy", "diffSide": "RIGHT", "path": "util/src/test/java/tech/pegasys/artemis/util/config/ArtemisConfigurationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMTo1NjowOVrOFu9yUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoxMzoyNFrOFu-S6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MTEyMw==", "bodyText": "should we test a different value to \".\"", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384791123", "createdAt": "2020-02-26T21:56:09Z", "author": {"login": "macfarla"}, "path": "util/src/test/java/tech/pegasys/artemis/util/config/ArtemisConfigurationTest.java", "diffHunk": "@@ -74,4 +74,16 @@ void invalidMainnetArtemisConfig() {\n     ArtemisConfiguration config = ArtemisConfiguration.fromString(\"deposit.numValidators=31\");\n     assertThrows(IllegalArgumentException.class, () -> config.validateConfig());\n   }\n+\n+  @Test\n+  void dataPathCanBeSet() {\n+    final ArtemisConfiguration config = ArtemisConfiguration.fromString(\"output.dataPath=\\\".\\\"\");\n+    assertThat(config.getDataPath()).isEqualTo(\".\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f840c267b89703e279aef3e4b105942ad448d2a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5OTQ2NQ==", "bodyText": "apparently its all changing, so i just copied the pattern... there'd be value if we were reading a file, but this test is a bit naff, i nearly didn't bother.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384799465", "createdAt": "2020-02-26T22:13:24Z", "author": {"login": "rolfyone"}, "path": "util/src/test/java/tech/pegasys/artemis/util/config/ArtemisConfigurationTest.java", "diffHunk": "@@ -74,4 +74,16 @@ void invalidMainnetArtemisConfig() {\n     ArtemisConfiguration config = ArtemisConfiguration.fromString(\"deposit.numValidators=31\");\n     assertThrows(IllegalArgumentException.class, () -> config.validateConfig());\n   }\n+\n+  @Test\n+  void dataPathCanBeSet() {\n+    final ArtemisConfiguration config = ArtemisConfiguration.fromString(\"output.dataPath=\\\".\\\"\");\n+    assertThat(config.getDataPath()).isEqualTo(\".\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MTEyMw=="}, "originalCommit": {"oid": "0f840c267b89703e279aef3e4b105942ad448d2a"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MzAzMTc3OnYy", "diffSide": "RIGHT", "path": "artemis/src/main/java/tech/pegasys/artemis/BeaconNodeCommand.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoxOToyM1rOFu-d9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyODo1NVrOFu-vEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMjI5NQ==", "bodyText": "This should just return 1 not call System.exit.  PicoCLI treats the returned value as the exit code.\nBut I'm somewhat afraid you're going to tell me it doesn't actually exit...", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384802295", "createdAt": "2020-02-26T22:19:23Z", "author": {"login": "ajsutton"}, "path": "artemis/src/main/java/tech/pegasys/artemis/BeaconNodeCommand.java", "diffHunk": "@@ -78,10 +79,14 @@ public Integer call() {\n                     node.stop();\n                   }));\n       return 0;\n+    } catch (DatabaseStorageException ex) {\n+      System.err.println(ex.getMessage());\n+      System.exit(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNjY3NQ==", "bodyText": "return 1 hangs and doesnt exit :)", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384806675", "createdAt": "2020-02-26T22:28:55Z", "author": {"login": "rolfyone"}, "path": "artemis/src/main/java/tech/pegasys/artemis/BeaconNodeCommand.java", "diffHunk": "@@ -78,10 +79,14 @@ public Integer call() {\n                     node.stop();\n                   }));\n       return 0;\n+    } catch (DatabaseStorageException ex) {\n+      System.err.println(ex.getMessage());\n+      System.exit(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMjI5NQ=="}, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MzAzNzI0OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyMToxOFrOFu-hPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMDo1NToxOVrOFvBySA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMzEzMw==", "bodyText": "I was expecting that the version number would be in dataPath and then MapDB's stuff would be under /db. I guess that means ChainStorageServer would be responsible for checking the version rather than MapDbDatabase.  That would also fit with the idea that we might migrate from MapDb to some other storage system in the future.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384803133", "createdAt": "2020-02-26T22:21:18Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -36,8 +36,9 @@\n   private final EventBus eventBus;\n \n   public ChainStorageServer(EventBus eventBus, ArtemisConfiguration config) {\n+    File databaseStoragePath = new File(config.getDataPath() + \"/db\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1NjY0OA==", "bodyText": "will be committing this shortly, after our discussion i think this bit is resolved.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384856648", "createdAt": "2020-02-27T00:55:19Z", "author": {"login": "rolfyone"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -36,8 +36,9 @@\n   private final EventBus eventBus;\n \n   public ChainStorageServer(EventBus eventBus, ArtemisConfiguration config) {\n+    File databaseStoragePath = new File(config.getDataPath() + \"/db\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMzEzMw=="}, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MzAzOTMyOnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyMjowNVrOFu-ing==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyMjowNVrOFu-ing==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMzQ4Ng==", "bodyText": "Seems weird to explicitly check for empty.  If this is just avoiding nulls you could just use !VERSION.equals(ver).", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384803486", "createdAt": "2020-02-26T22:22:05Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MzA0Mzc3OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyMzoyMVrOFu-lMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjozNjoxN1rOFu-7qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDE0NQ==", "bodyText": "Would Files.readString(databaseVersionFile.toPath()).trim() be simpler?  Would also be slightly stricter by requiring no other content in the file rather than accepting anything that happens to have 1 on the first line.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384804145", "createdAt": "2020-02-26T22:23:21Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwOTg5OQ==", "bodyText": "sounds good.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384809899", "createdAt": "2020-02-26T22:36:17Z", "author": {"login": "rolfyone"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDE0NQ=="}, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MzA0NzQ2OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyNDozNVrOFu-nUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyNDozNVrOFu-nUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDY5MA==", "bodyText": "Files.writeString would be better here.  Otherwise you need to ensure the close is done in a finally block or use try-with-resources to ensure it gets closed even if an exception is thrown.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384804690", "createdAt": "2020-02-26T22:24:35Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {\n+          throw new DatabaseStorageException(\n+              String.format(\n+                  \"The database version found (%s) does not meet the expected version(%s).\\n\"\n+                      + \"Aborting startup to prevent corruption of the database.\\n\",\n+                  ver, VERSION));\n+        }\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"The existing database is version %s, from file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+      } else {\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"Recording database version %s to file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+        FileWriter fileWriter = new FileWriter(databaseVersionFile.getPath(), UTF_8);\n+        fileWriter.write(VERSION);\n+        fileWriter.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MzA0ODg0OnYy", "diffSide": "RIGHT", "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjoyNTowNVrOFu-oOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjozMToyMlrOFu-zVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDkyMw==", "bodyText": "We should indicate which file is not found in the error message.", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384804923", "createdAt": "2020-02-26T22:25:05Z", "author": {"login": "ajsutton"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {\n+          throw new DatabaseStorageException(\n+              String.format(\n+                  \"The database version found (%s) does not meet the expected version(%s).\\n\"\n+                      + \"Aborting startup to prevent corruption of the database.\\n\",\n+                  ver, VERSION));\n+        }\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"The existing database is version %s, from file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+      } else {\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"Recording database version %s to file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+        FileWriter fileWriter = new FileWriter(databaseVersionFile.getPath(), UTF_8);\n+        fileWriter.write(VERSION);\n+        fileWriter.close();\n+      }\n+    } catch (FileNotFoundException ex) {\n+      STDOUT.log(Level.ERROR, \"File not found\", ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNzc2Ng==", "bodyText": "we check it exists first, it shouldn't even be possible but the code required catching the exception :/", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384807766", "createdAt": "2020-02-26T22:31:22Z", "author": {"login": "rolfyone"}, "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {\n+          throw new DatabaseStorageException(\n+              String.format(\n+                  \"The database version found (%s) does not meet the expected version(%s).\\n\"\n+                      + \"Aborting startup to prevent corruption of the database.\\n\",\n+                  ver, VERSION));\n+        }\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"The existing database is version %s, from file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+      } else {\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"Recording database version %s to file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+        FileWriter fileWriter = new FileWriter(databaseVersionFile.getPath(), UTF_8);\n+        fileWriter.write(VERSION);\n+        fileWriter.close();\n+      }\n+    } catch (FileNotFoundException ex) {\n+      STDOUT.log(Level.ERROR, \"File not found\", ex);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDkyMw=="}, "originalCommit": {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2679, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}